<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.1">
<meta name="author" content="Miguel Angel Lozano">
<title>Componentes Web</title>
<style>/*! normalize.css v2.1.2 | MIT License | git.io/normalize */
/* ========================================================================== HTML5 display definitions ========================================================================== */
/** Correct `block` display not defined in IE 8/9. */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }

/** Correct `inline-block` display not defined in IE 8/9. */
audio, canvas, video { display: inline-block; }

/** Prevent modern browsers from displaying `audio` without controls. Remove excess height in iOS 5 devices. */
audio:not([controls]) { display: none; height: 0; }

/** Address `[hidden]` styling not present in IE 8/9. Hide the `template` element in IE, Safari, and Firefox < 22. */
[hidden], template { display: none; }

script { display: none !important; }

/* ========================================================================== Base ========================================================================== */
/** 1. Set default font family to sans-serif. 2. Prevent iOS text size adjust after orientation change, without disabling user zoom. */
html { font-family: sans-serif; /* 1 */ -ms-text-size-adjust: 100%; /* 2 */ -webkit-text-size-adjust: 100%; /* 2 */ }

/** Remove default margin. */
body { margin: 0; }

/* ========================================================================== Links ========================================================================== */
/** Remove the gray background color from active links in IE 10. */
a { background: transparent; }

/** Address `outline` inconsistency between Chrome and other browsers. */
a:focus { outline: thin dotted; }

/** Improve readability when focused and also mouse hovered in all browsers. */
a:active, a:hover { outline: 0; }

/* ========================================================================== Typography ========================================================================== */
/** Address variable `h1` font-size and margin within `section` and `article` contexts in Firefox 4+, Safari 5, and Chrome. */
h1 { font-size: 2em; margin: 0.67em 0; }

/** Address styling not present in IE 8/9, Safari 5, and Chrome. */
abbr[title] { border-bottom: 1px dotted; }

/** Address style set to `bolder` in Firefox 4+, Safari 5, and Chrome. */
b, strong { font-weight: bold; }

/** Address styling not present in Safari 5 and Chrome. */
dfn { font-style: italic; }

/** Address differences between Firefox and other browsers. */
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }

/** Address styling not present in IE 8/9. */
mark { background: #ff0; color: #000; }

/** Correct font family set oddly in Safari 5 and Chrome. */
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }

/** Improve readability of pre-formatted text in all browsers. */
pre { white-space: pre-wrap; }

/** Set consistent quote types. */
q { quotes: "\201C" "\201D" "\2018" "\2019"; }

/** Address inconsistent and variable font size in all browsers. */
small { font-size: 80%; }

/** Prevent `sub` and `sup` affecting `line-height` in all browsers. */
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }

sup { top: -0.5em; }

sub { bottom: -0.25em; }

/* ========================================================================== Embedded content ========================================================================== */
/** Remove border when inside `a` element in IE 8/9. */
img { border: 0; }

/** Correct overflow displayed oddly in IE 9. */
svg:not(:root) { overflow: hidden; }

/* ========================================================================== Figures ========================================================================== */
/** Address margin not present in IE 8/9 and Safari 5. */
figure { margin: 0; }

/* ========================================================================== Forms ========================================================================== */
/** Define consistent border, margin, and padding. */
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }

/** 1. Correct `color` not being inherited in IE 8/9. 2. Remove padding so people aren't caught out if they zero out fieldsets. */
legend { border: 0; /* 1 */ padding: 0; /* 2 */ }

/** 1. Correct font family not being inherited in all browsers. 2. Correct font size not being inherited in all browsers. 3. Address margins set differently in Firefox 4+, Safari 5, and Chrome. */
button, input, select, textarea { font-family: inherit; /* 1 */ font-size: 100%; /* 2 */ margin: 0; /* 3 */ }

/** Address Firefox 4+ setting `line-height` on `input` using `!important` in the UA stylesheet. */
button, input { line-height: normal; }

/** Address inconsistent `text-transform` inheritance for `button` and `select`. All other form control elements do not inherit `text-transform` values. Correct `button` style inheritance in Chrome, Safari 5+, and IE 8+. Correct `select` style inheritance in Firefox 4+ and Opera. */
button, select { text-transform: none; }

/** 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio` and `video` controls. 2. Correct inability to style clickable `input` types in iOS. 3. Improve usability and consistency of cursor style between image-type `input` and others. */
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; /* 2 */ cursor: pointer; /* 3 */ }

/** Re-set default cursor for disabled elements. */
button[disabled], html input[disabled] { cursor: default; }

/** 1. Address box sizing set to `content-box` in IE 8/9. 2. Remove excess padding in IE 8/9. */
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; /* 1 */ padding: 0; /* 2 */ }

/** 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome. 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome (include `-moz` to future-proof). */
input[type="search"] { -webkit-appearance: textfield; /* 1 */ -moz-box-sizing: content-box; -webkit-box-sizing: content-box; /* 2 */ box-sizing: content-box; }

/** Remove inner padding and search cancel button in Safari 5 and Chrome on OS X. */
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }

/** Remove inner padding and border in Firefox 4+. */
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }

/** 1. Remove default vertical scrollbar in IE 8/9. 2. Improve readability and alignment in all browsers. */
textarea { overflow: auto; /* 1 */ vertical-align: top; /* 2 */ }

/* ========================================================================== Tables ========================================================================== */
/** Remove most spacing between table cells. */
table { border-collapse: collapse; border-spacing: 0; }

meta.foundation-mq-small { font-family: "only screen and (min-width: 768px)"; width: 768px; }

meta.foundation-mq-medium { font-family: "only screen and (min-width:1280px)"; width: 1280px; }

meta.foundation-mq-large { font-family: "only screen and (min-width:1440px)"; width: 1440px; }

*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }

html, body { font-size: 97%; }

body { background: white; color: #222222; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }

a:hover { cursor: pointer; }

img, object, embed { max-width: 100%; height: auto; }

object, embed { height: 100%; }

img { -ms-interpolation-mode: bicubic; }

#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }

.left { float: left !important; }

.right { float: right !important; }

.text-left { text-align: left !important; }

.text-right { text-align: right !important; }

.text-center { text-align: center !important; }

.text-justify { text-align: justify !important; }

.hide { display: none; }

.antialiased, body { -webkit-font-smoothing: antialiased; }

img { display: inline-block; vertical-align: middle; }

textarea { height: auto; min-height: 50px; }

select { width: 100%; }

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }

.subheader, .admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { line-height: 1.4; color: #6f6f6f; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }

/* Typography resets */
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }

/* Default Link Styles */
a { color: #1164be; text-decoration: none; line-height: inherit; }
a img { border: none; }

/* Default paragraph styles */
p { font-family: inherit; font-weight: normal; font-size: 1em; line-height: 1.4; margin-bottom: 1em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }

/* Default header styles */
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: bold; font-style: normal; color: #222222; text-rendering: optimizeLegibility; margin-top: 1em; margin-bottom: 0.5em; line-height: 1.2125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #6f6f6f; line-height: 0; }

h1 { font-size: 2.125em; }

h2 { font-size: 1.6875em; }

h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }

h4 { font-size: 1.125em; }

h5 { font-size: 1.125em; }

h6 { font-size: 1em; }

hr { border: solid #dddddd; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }

/* Helpful Typography Defaults */
em, i { font-style: italic; line-height: inherit; }

strong, b { font-weight: bold; line-height: inherit; }

small { font-size: 60%; line-height: inherit; }

code { font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: bold; }

/* Lists */
ul, ol, dl { font-size: 1em; line-height: 1.4; margin-bottom: 1.25em; list-style-position: outside; font-family: inherit; }

ul, ol { margin-left: 2.5em; }
ul.no-bullet, ol.no-bullet { margin-left: 1.5em; }

/* Unordered Lists */
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; /* Override nested font-size change */ }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }

/* Ordered Lists */
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }

/* Definition Lists */
dl dt { margin-bottom: 0.3125em; font-weight: bold; }
dl dd { margin-bottom: 1.25em; }

/* Abbreviations */
abbr, acronym { text-transform: uppercase; font-size: 90%; color: #222222; border-bottom: 1px dotted #dddddd; cursor: help; }

abbr { text-transform: none; }

/* Blockquotes */
blockquote { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
blockquote cite { display: block; font-size: 0.8125em; color: #555555; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #555555; }

blockquote, blockquote p { line-height: 1.6; color: #6f6f6f; }

/* Microformats */
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #dddddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }

.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }

@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.6875em; }
  h4 { font-size: 1.4375em; } }
/* Tables */
table { background: white; margin-bottom: 1.25em; border: solid 1px #dddddd; }
table thead, table tfoot { background: whitesmoke; font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: #222222; text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: #222222; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #f9f9f9; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.4; }

h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; border-bottom: 1px solid #dddddd }

.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }

*:not(pre) > code { font-size: inherit; font-style: normal !important; letter-spacing: 0; padding: 3px 2px 1px 2px; background-color: #eeeeee; border: 1px solid #dddddd; -webkit-border-radius: 0; border-radius: 0; line-height: inherit; font-weight: normal; }

pre, pre > code { line-height: 1.4; color: black; font-family: monospace, serif; font-weight: normal; }

.keyseq { color: #555555; }

kbd { display: inline-block; color: #222222; font-size: 0.75em; line-height: 1.4; background-color: #f7f7f7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; margin: -0.15em 0.15em 0 0.15em; padding: 0.2em 0.6em 0.2em 0.5em; vertical-align: middle; white-space: nowrap; }

.keyseq kbd:first-child { margin-left: 0; }

.keyseq kbd:last-child { margin-right: 0; }

.menuseq, .menu { color: #090909; }

b.button:before, b.button:after { position: relative; top: -1px; font-weight: normal; }

b.button:before { content: "["; padding: 0 3px 0 2px; }

b.button:after { content: "]"; padding: 0 2px 0 3px; }

#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 0.9375em; padding-right: 0.9375em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }

#content { margin-top: 1.25em; }

#content:before { content: none; }

#header > h1:first-child { color: black; margin-top: 2.25rem; margin-bottom: 0; }
#header > h1:first-child + #toc { margin-top: 8px; border-top: 1px solid #dddddd; }
#header > h1:only-child, body.toc2 #header > h1:nth-last-child(2) { border-bottom: 1px solid #dddddd; padding-bottom: 8px; }
#header .details { border-bottom: 1px solid #dddddd; line-height: 1.45; padding-top: 0.25em; padding-bottom: 0.25em; padding-left: 0.25em; color: #555555; display: -ms-flexbox; display: -webkit-flex; display: flex; -ms-flex-flow: row wrap; -webkit-flex-flow: row wrap; flex-flow: row wrap; }
#header .details span:first-child { margin-left: -0.125em; }
#header .details span.email a { color: #6f6f6f; }
#header .details br { display: none; }
#header .details br + span:before { content: "\00a0\2013\00a0"; }
#header .details br + span.author:before { content: "\00a0\22c5\00a0"; color: #6f6f6f; }
#header .details br + span#revremark:before { content: "\00a0|\00a0"; }
#header #revnumber { text-transform: capitalize; }
#header #revnumber:after { content: "\00a0"; }

#content > h1:first-child:not([class]) { color: black; border-bottom: 1px solid #dddddd; padding-bottom: 8px; margin-top: 0; padding-top: 1rem; margin-bottom: 1.25rem; }

#floating {
  position: fixed;
  z-index: 1000;
  padding: 0.5em;
  right: 0;
  top: 0;
  background: white;
  box-shadow: 0 0 1em #777777;
  -webkit-box-shadow: 0 0 1em #777777;
  -moz-box-shadow: 0 0 1em #777777;
  -webkit-border-bottom-left-radius: 5px;
  -moz-border-radius-bottomleft: 5px;
  max-height: 80%;
  overflow: auto;
}

#floating #full { display: none; } /* Hide the full TOC by default */

#floating:hover #full{
  display: block; /* Show it on hover */
}


#toc { border-bottom: 1px solid #dddddd; padding-bottom: 0.5em; }
#toc > ul { margin-left: 0.125em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin: 0.5em 0; }
#toc ul { font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; list-style-type: none; }
#toc a { text-decoration: none; }
#toc a:active { text-decoration: underline; }

#toctitle { color: #6f6f6f; font-size: 1.2em; }

@media only screen and (min-width: 768px) { #toctitle { font-size: 1.375em; }
  body.toc2 { padding-left: 15em; padding-right: 0; }
  #toc.toc2 { margin-top: 0 !important; background-color: #f2f2f2; position: fixed; width: 15em; left: 0; top: 0; border-right: 1px solid #dddddd; border-top-width: 0 !important; border-bottom-width: 0 !important; z-index: 1000; padding: 1.25em 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; font-size: 1.2em; }
  #toc.toc2 > ul { font-size: 0.9em; margin-bottom: 0; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 15em; }
  body.toc2.toc-right #toc.toc2 { border-right-width: 0; border-left: 1px solid #dddddd; left: auto; right: 0; } }
@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; padding-right: 0; }
  #toc.toc2 { width: 20em; }
  #toc.toc2 #toctitle { font-size: 1.375em; }
  #toc.toc2 > ul { font-size: 0.95em; }
  #toc.toc2 ul ul { padding-left: 1.25em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; } }
#content #toc { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 0; border-radius: 0; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }

#footer { max-width: 100%; background-color: #222222; padding: 1.25em; }

#footer-text { color: #dddddd; line-height: 1.44; }

.sect1 { padding-bottom: 0.625em; }

@media only screen and (min-width: 768px) { .sect1 { padding-bottom: 1.25em; } }
.sect1 + .sect1 { border-top: 1px solid #dddddd; }

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; z-index: 1001; width: 1.5ex; margin-left: -1.5ex; display: block; text-decoration: none !important; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: "\00A7"; font-size: 0.85em; display: block; padding-top: 0.1em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #222222; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #151515; }

.audioblock, .imageblock, .literalblock, .listingblock, .stemblock, .videoblock { margin-bottom: 1.25em; }

.admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-rendering: optimizeLegibility; text-align: left; }

table.tableblock > caption.title { white-space: nowrap; overflow: visible; max-width: 0; }

.paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { color: black; }

table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }

.admonitionblock > table { border-collapse: separate; border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #dddddd; color: #555555; }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }

.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 0; border-radius: 0; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }

.sidebarblock { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 0; border-radius: 0; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock > .content > .title { color: #6f6f6f; margin-top: 0; }

.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }

.literalblock pre, .listingblock pre:not(.highlight), .listingblock pre[class="highlight"], .listingblock pre[class^="highlight "], .listingblock pre.CodeRay, .listingblock pre.prettyprint { background: #eeeeee; }
.sidebarblock .literalblock pre, .sidebarblock .listingblock pre:not(.highlight), .sidebarblock .listingblock pre[class="highlight"], .sidebarblock .listingblock pre[class^="highlight "], .sidebarblock .listingblock pre.CodeRay, .sidebarblock .listingblock pre.prettyprint { background: #f2f1f1; }

.literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { border: 1px solid #cccccc; -webkit-border-radius: 0; border-radius: 0; word-wrap: break-word; padding: 0.8em 0.8em 0.65em 0.8em; font-size: 0.8125em; }
.literalblock pre.nowrap, .literalblock pre[class].nowrap, .listingblock pre.nowrap, .listingblock pre[class].nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
@media only screen and (min-width: 768px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 0.90625em; } }
@media only screen and (min-width: 1280px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 1em; } }

.literalblock.output pre { color: #eeeeee; background-color: black; }

.listingblock pre.highlightjs { padding: 0; }
.listingblock pre.highlightjs > code { padding: 0.8em 0.8em 0.65em 0.8em; -webkit-border-radius: 0; border-radius: 0; }

.listingblock > .content { position: relative; }

.listingblock code[data-lang]:before { display: none; content: attr(data-lang); position: absolute; font-size: 0.75em; top: 0.425rem; right: 0.5rem; line-height: 1; text-transform: uppercase; color: #999; }

.listingblock:hover code[data-lang]:before { display: block; }

.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }

.listingblock.terminal pre .command:not([data-prompt]):before { content: "$"; }

table.pyhltable { border-collapse: separate; border: 0; margin-bottom: 0; background: none; }

table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; }

table.pyhltable td.code { padding-left: .75em; padding-right: 0; }

pre.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #dddddd; }

pre.pygments .lineno { display: inline-block; margin-right: .25em; }

table.pyhltable .linenodiv { background: none !important; padding-right: 0 !important; }

.quoteblock { margin: 0 1em 1.25em 1.5em; display: table; }
.quoteblock > .title { margin-left: -1.5em; margin-bottom: 0.75em; }
.quoteblock blockquote, .quoteblock blockquote p { color: #6f6f6f; font-size: 1.15rem; line-height: 1.75; word-spacing: 0.1em; letter-spacing: 0; font-style: italic; text-align: justify; }
.quoteblock blockquote { margin: 0; padding: 0; border: 0; }
.quoteblock blockquote:before { content: "\201c"; float: left; font-size: 2.75em; font-weight: bold; line-height: 0.6em; margin-left: -0.6em; color: #6f6f6f; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: 0.5em; margin-right: 0.5ex; text-align: right; }
.quoteblock .quoteblock { margin-left: 0; margin-right: 0; padding: 0.5em 0; border-left: 3px solid #555555; }
.quoteblock .quoteblock blockquote { padding: 0 0 0 0.75em; }
.quoteblock .quoteblock blockquote:before { display: none; }

.verseblock { margin: 0 1em 1.25em 1em; }
.verseblock pre { font-family: "Open Sans", "DejaVu Sans", sans; font-size: 1.15rem; color: #6f6f6f; font-weight: 300; text-rendering: optimizeLegibility; }
.verseblock pre strong { font-weight: 400; }
.verseblock .attribution { margin-top: 1.25rem; margin-left: 0.5ex; }

.quoteblock .attribution, .verseblock .attribution { font-size: 0.8125em; line-height: 1.45; font-style: italic; }
.quoteblock .attribution br, .verseblock .attribution br { display: none; }
.quoteblock .attribution cite, .verseblock .attribution cite { display: block; letter-spacing: -0.05em; color: #555555; }

.quoteblock.abstract { margin: 0 0 1.25em 0; display: block; }
.quoteblock.abstract blockquote, .quoteblock.abstract blockquote p { text-align: left; word-spacing: 0; }
.quoteblock.abstract blockquote:before, .quoteblock.abstract blockquote p:first-of-type:before { display: none; }

table.tableblock { max-width: 100%; border-collapse: separate; }
table.tableblock td > .paragraph:last-child p > p:last-child, table.tableblock th > p:last-child, table.tableblock td > p:last-child { margin-bottom: 0; }

table.spread { width: 100%; }

table.tableblock, th.tableblock, td.tableblock { border: 0 solid #dddddd; }

table.grid-all th.tableblock, table.grid-all td.tableblock { border-width: 0 1px 1px 0; }

table.grid-all tfoot > tr > th.tableblock, table.grid-all tfoot > tr > td.tableblock { border-width: 1px 1px 0 0; }

table.grid-cols th.tableblock, table.grid-cols td.tableblock { border-width: 0 1px 0 0; }

table.grid-all * > tr > .tableblock:last-child, table.grid-cols * > tr > .tableblock:last-child { border-right-width: 0; }

table.grid-rows th.tableblock, table.grid-rows td.tableblock { border-width: 0 0 1px 0; }

table.grid-all tbody > tr:last-child > th.tableblock, table.grid-all tbody > tr:last-child > td.tableblock, table.grid-all thead:last-child > tr > th.tableblock, table.grid-rows tbody > tr:last-child > th.tableblock, table.grid-rows tbody > tr:last-child > td.tableblock, table.grid-rows thead:last-child > tr > th.tableblock { border-bottom-width: 0; }

table.grid-rows tfoot > tr > th.tableblock, table.grid-rows tfoot > tr > td.tableblock { border-width: 1px 0 0 0; }

table.frame-all { border-width: 1px; }

table.frame-sides { border-width: 0 1px; }

table.frame-topbot { border-width: 1px 0; }

th.halign-left, td.halign-left { text-align: left; }

th.halign-right, td.halign-right { text-align: right; }

th.halign-center, td.halign-center { text-align: center; }

th.valign-top, td.valign-top { vertical-align: top; }

th.valign-bottom, td.valign-bottom { vertical-align: bottom; }

th.valign-middle, td.valign-middle { vertical-align: middle; }

table thead th, table tfoot th { font-weight: bold; }

tbody tr th { display: table-cell; line-height: 1.4; background: whitesmoke; }

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p { color: #222222; font-weight: bold; }

p.tableblock > code:only-child { background: none; padding: 0; }

p.tableblock { font-size: 1em; }

td > div.verse { white-space: pre; }

ol { margin-left: 2.5em; }

ul li ol { margin-left: 1.5em; }

dl dd { margin-left: 1.125em; }

dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }

ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.625em; }

ul.unstyled, ol.unnumbered, ul.checklist, ul.none { list-style-type: none; }

ul.unstyled, ol.unnumbered, ul.checklist { margin-left: 0.625em; }

ul.checklist li > p:first-child > .fa-check-square-o:first-child, ul.checklist li > p:first-child > input[type="checkbox"]:first-child { margin-right: 0.25em; }

ul.checklist li > p:first-child > input[type="checkbox"]:first-child { position: relative; top: 1px; }

ul.inline { margin: 0 auto 0.625em auto; margin-left: -1.375em; margin-right: 0; padding: 0; list-style: none; overflow: hidden; }
ul.inline > li { list-style: none; float: left; margin-left: 1.375em; display: block; }
ul.inline > li > * { display: block; }

.unstyled dl dt { font-weight: normal; font-style: normal; }

ol.arabic { list-style-type: decimal; }

ol.decimal { list-style-type: decimal-leading-zero; }

ol.loweralpha { list-style-type: lower-alpha; }

ol.upperalpha { list-style-type: upper-alpha; }

ol.lowerroman { list-style-type: lower-roman; }

ol.upperroman { list-style-type: upper-roman; }

ol.lowergreek { list-style-type: lower-greek; }

.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }

td.hdlist1 { padding-right: .75em; font-weight: bold; }

td.hdlist1, td.hdlist2 { vertical-align: top; }

.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }

.colist > table tr > td:first-of-type { padding: 0 0.75em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.25em 0; }

.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: 0 0 0 1px #dddddd; box-shadow: 0 0 0 1px #dddddd; }

.imageblock.left, .imageblock[style*="float: left"] { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }

.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }

a.image { text-decoration: none; }

span.footnote, span.footnoteref { vertical-align: super; font-size: 0.875em; }
span.footnote a, span.footnoteref a { text-decoration: none; }
span.footnote a:active, span.footnoteref a:active { text-decoration: underline; }

#footnotes { padding-top: 0.75em; padding-bottom: 0.75em; margin-bottom: 0.625em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -.25em 0 .75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.375em; line-height: 1.3; font-size: 0.875em; margin-left: 1.2em; text-indent: -1.2em; margin-bottom: .2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }

#content #footnotes { margin-top: -0.625em; margin-bottom: 0; padding: 0.75em 0; }

.gist .file-data > table { border: 0; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }

div.unbreakable { page-break-inside: avoid; }

.big { font-size: larger; }

.small { font-size: smaller; }

.underline { text-decoration: underline; }

.overline { text-decoration: overline; }

.line-through { text-decoration: line-through; }

.aqua { color: #00bfbf; }

.aqua-background { background-color: #00fafa; }

.black { color: black; }

.black-background { background-color: black; }

.blue { color: #0000bf; }

.blue-background { background-color: #0000fa; }

.fuchsia { color: #bf00bf; }

.fuchsia-background { background-color: #fa00fa; }

.gray { color: #606060; }

.gray-background { background-color: #7d7d7d; }

.green { color: #006000; }

.green-background { background-color: #007d00; }

.lime { color: #00bf00; }

.lime-background { background-color: #00fa00; }

.maroon { color: #600000; }

.maroon-background { background-color: #7d0000; }

.navy { color: #000060; }

.navy-background { background-color: #00007d; }

.olive { color: #606000; }

.olive-background { background-color: #7d7d00; }

.purple { color: #600060; }

.purple-background { background-color: #7d007d; }

.red { color: #bf0000; }

.red-background { background-color: #fa0000; }

.silver { color: #909090; }

.silver-background { background-color: #bcbcbc; }

.teal { color: #006060; }

.teal-background { background-color: #007d7d; }

.white { color: #bfbfbf; }

.white-background { background-color: #fafafa; }

.yellow { color: #bfbf00; }

.yellow-background { background-color: #fafa00; }

span.icon > .fa { cursor: default; }

.admonitionblock td.icon [class^="fa icon-"] { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #207c98; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }

.conum[data-value] { display: inline-block; color: #fff !important; background-color: #222222; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; font-size: 0.75em; width: 1.67em; height: 1.67em; line-height: 1.67em; font-family: "Open Sans", "DejaVu Sans", sans-serif; font-style: normal; font-weight: bold; }
.conum[data-value] * { color: #fff !important; }
.conum[data-value] + b { display: none; }
.conum[data-value]:after { content: attr(data-value); }
pre .conum[data-value] { position: relative; top: -0.125em; }

b.conum * { color: inherit !important; }

.conum:not([data-value]):empty { display: none; }

.literalblock pre, .listingblock pre { background: #eeeeee; }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.1.0/css/font-awesome.min.css">
<style>.listingblock .pygments .hll { background-color: #ffffcc }
.listingblock .pygments  { background: #f8f8f8; }
.listingblock .pygments .tok-c { color: #408080; font-style: italic } /* Comment */
.listingblock .pygments .tok-err { border: 1px solid #FF0000 } /* Error */
.listingblock .pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
.listingblock .pygments .tok-o { color: #666666 } /* Operator */
.listingblock .pygments .tok-cm { color: #408080; font-style: italic } /* Comment.Multiline */
.listingblock .pygments .tok-cp { color: #BC7A00 } /* Comment.Preproc */
.listingblock .pygments .tok-c1 { color: #408080; font-style: italic } /* Comment.Single */
.listingblock .pygments .tok-cs { color: #408080; font-style: italic } /* Comment.Special */
.listingblock .pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
.listingblock .pygments .tok-ge { font-style: italic } /* Generic.Emph */
.listingblock .pygments .tok-gr { color: #FF0000 } /* Generic.Error */
.listingblock .pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
.listingblock .pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
.listingblock .pygments .tok-go { color: #888888 } /* Generic.Output */
.listingblock .pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.listingblock .pygments .tok-gs { font-weight: bold } /* Generic.Strong */
.listingblock .pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.listingblock .pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
.listingblock .pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.listingblock .pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.listingblock .pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.listingblock .pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
.listingblock .pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.listingblock .pygments .tok-kt { color: #B00040 } /* Keyword.Type */
.listingblock .pygments .tok-m { color: #666666 } /* Literal.Number */
.listingblock .pygments .tok-s { color: #BA2121 } /* Literal.String */
.listingblock .pygments .tok-na { color: #7D9029 } /* Name.Attribute */
.listingblock .pygments .tok-nb { color: #008000 } /* Name.Builtin */
.listingblock .pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
.listingblock .pygments .tok-no { color: #880000 } /* Name.Constant */
.listingblock .pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
.listingblock .pygments .tok-ni { color: #999999; font-weight: bold } /* Name.Entity */
.listingblock .pygments .tok-ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.listingblock .pygments .tok-nf { color: #0000FF } /* Name.Function */
.listingblock .pygments .tok-nl { color: #A0A000 } /* Name.Label */
.listingblock .pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.listingblock .pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
.listingblock .pygments .tok-nv { color: #19177C } /* Name.Variable */
.listingblock .pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.listingblock .pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
.listingblock .pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
.listingblock .pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
.listingblock .pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
.listingblock .pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
.listingblock .pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
.listingblock .pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
.listingblock .pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
.listingblock .pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.listingblock .pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
.listingblock .pygments .tok-se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.listingblock .pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
.listingblock .pygments .tok-si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.listingblock .pygments .tok-sx { color: #008000 } /* Literal.String.Other */
.listingblock .pygments .tok-sr { color: #BB6688 } /* Literal.String.Regex */
.listingblock .pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
.listingblock .pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
.listingblock .pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
.listingblock .pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
.listingblock .pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
.listingblock .pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
.listingblock .pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Componentes Web</h1>
<div class="details">
<span id="author" class="author">Miguel Angel Lozano</span><br>
<span id="email" class="email">&lt;<a href="mailto:malozano@ua.es">malozano@ua.es</a>&gt;</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Índice de contenidos</div>
<ul class="sectlevel1">
<li><a href="#sesion01">1. Introducción a las aplicaciones web</a>
<ul class="sectlevel2">
<li><a href="#__qu%C3%A9_es_una_aplicaci%C3%B3n_web">1.1. ¿Qué es una aplicación web?</a></li>
<li><a href="#_aplicaciones_web_java_ee">1.2. Aplicaciones web Java EE</a></li>
<li><a href="#_creaci%C3%B3n_y_despliegue_de_aplicaciones_web_con_intellij_y_wildfly">1.3. Creación y despliegue de aplicaciones web con IntelliJ y WildFly</a></li>
<li><a href="#_componentes_de_la_aplicaci%C3%B3n_java_ee">1.4. Componentes de la aplicación Java EE</a></li>
<li><a href="#_ejercicios">1.5. Ejercicios</a></li>
</ul>
</li>
<li><a href="#sesion02">2. Procesamiento de peticiones</a>
<ul class="sectlevel2">
<li><a href="#_petici%C3%B3n_y_respuesta_http">2.1. Petición y respuesta HTTP</a></li>
<li><a href="#_procesamiento_de_peticiones_get_y_post">2.2. Procesamiento de peticiones GET y POST</a></li>
<li><a href="#_cabeceras_y_c%C3%B3digos">2.3. Cabeceras y códigos</a></li>
<li><a href="#_procesamiento_as%C3%ADncrono">2.4. Procesamiento asíncrono</a></li>
<li><a href="#_ejemplos">2.5. Ejemplos</a></li>
<li><a href="#_ejercicios_2">2.6. Ejercicios</a></li>
</ul>
</li>
<li><a href="#sesion03">3. Manejo de Cookies y Sesiones</a>
<ul class="sectlevel2">
<li><a href="#_cookies">3.1. Cookies</a></li>
<li><a href="#_seguimiento_de_sesiones">3.2. Seguimiento de sesiones</a></li>
<li><a href="#_ejercicios_3">3.3. Ejercicios</a></li>
</ul>
</li>
<li><a href="#sesion04">4. Contexto global de la aplicación web</a>
<ul class="sectlevel2">
<li><a href="#_contexto_de_los_servlets">4.1. Contexto de los servlets</a></li>
<li><a href="#_inyecci%C3%B3n_de_dependencias">4.2. Inyección de dependencias</a></li>
<li><a href="#_ejercicios_4">4.3. Ejercicios</a></li>
</ul>
</li>
<li><a href="#sesion05">5. WebSocket</a>
<ul class="sectlevel2">
<li><a href="#_websocket_en_java_ee">5.1. WebSocket en Java EE</a></li>
<li><a href="#_intercambio_de_mensajes">5.2. Intercambio de mensajes</a></li>
<li><a href="#_conversi%C3%B3n_entre_java_y_mensajes_websocket">5.3. Conversión entre Java y mensajes WebSocket</a></li>
<li><a href="#_par%C3%A1metros_del_em_path_em_y_de_la_em_query_em">5.4. Parámetros del <em>path</em> y de la <em>query</em></a></li>
<li><a href="#_cliente_javascript">5.5. Cliente JavaScript</a></li>
<li><a href="#_ejercicios_5">5.6. Ejercicios</a></li>
</ul>
</li>
<li><a href="#sesion06">6. Seguridad en aplicaciones web</a>
<ul class="sectlevel2">
<li><a href="#_mecanismos_de_autentificaci%C3%B3n">6.1. Mecanismos de autentificación</a></li>
<li><a href="#_usuarios_y_roles">6.2. Usuarios y roles</a></li>
<li><a href="#_autentificaci%C3%B3n_en_aplicaciones_web_java_ee">6.3. Autentificación en aplicaciones web Java EE</a></li>
<li><a href="#_anotaciones_relacionadas_con_la_seguridad">6.4. Anotaciones relacionadas con la seguridad</a></li>
<li><a href="#_acceso_a_la_informaci%C3%B3n_de_seguridad">6.5. Acceso a la información de seguridad</a></li>
<li><a href="#_ejercicios_6">6.6. Ejercicios</a></li>
</ul>
</li>
<li><a href="#sesion07">7. Filtros y Wrappers</a>
<ul class="sectlevel2">
<li><a href="#_filtros">7.1. Filtros</a></li>
<li><a href="#_wrappers">7.2. Wrappers</a></li>
<li><a href="#_ejemplos_3">7.3. Ejemplos</a></li>
<li><a href="#_ejercicios_7">7.4. Ejercicios</a></li>
</ul>
</li>
<li><a href="#sesion08">8. Facelets, JSTL y lenguajes de expresiones</a>
<ul class="sectlevel2">
<li><a href="#_javaserver_faces_y_facelets">8.1. JavaServer Faces y Facelets</a></li>
<li><a href="#_introducci%C3%B3n_a_los_facelets">8.2. Introducción a los Facelets</a></li>
<li><a href="#_lenguaje_de_expresiones">8.3. Lenguaje de expresiones</a></li>
<li><a href="#_librer%C3%ADas_de_etiquetas">8.4. Librerías de etiquetas</a></li>
<li><a href="#_ejercicios_8">8.5. Ejercicios</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="sesion01">1. Introducción a las aplicaciones web</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="__qué_es_una_aplicación_web">1.1. ¿Qué es una aplicación web?</h3>
<div class="paragraph">
<p>Una aplicación web es una aplicación a la que accedemos mediante protocolo HTTP utilizando un navegador web. El protocolo HTTP especifica el modo de comunicación entre una máquina cliente y una máquina servidor, de modo que el cliente solicita un documento del espacio de direcciones del servidor, y éste se lo sirve.</p>
</div>
<div class="sect3">
<h4 id="_aplicaciones_en_el_lado_del_servidor">1.1.1. Aplicaciones en el lado del servidor</h4>
<div class="paragraph">
<p>En el lado del servidor, tenemos que conseguir que nuestro servidor HTTP sea capaz de ejecutar programas de aplicación que recojan los parámetros de peticiones del cliente, los procesen y devuelvan al servidor un documento que éste pasará a su vez al cliente.</p>
</div>
<div class="paragraph">
<p>Así, para el cliente el servidor no habrá hecho nada distinto a lo estipulado en el protocolo HTTP, pero el servidor podrá valerse de herramientas externas para procesar y servir la petición solicitada, pudiendo así no limitarse a servir páginas estáticas, sino utilizar otras aplicaciones (servlets, JSP, PHP, etc) para servir documentos con contenido dinámico.</p>
</div>
<div class="paragraph">
<p>Los programas de aplicación son típicamente programas que realizan consultas a bases de datos, procesan la información resultante y devuelven la salida al servidor, entre otras tareas.</p>
</div>
</div>
<div class="sect3">
<h4 id="_aplicaciones_en_el_lado_del_cliente">1.1.2. Aplicaciones en el lado del cliente</h4>
<div class="paragraph">
<p>Se tienen muchas tecnologías relacionadas con extensiones del lado del cliente (entendiendo cliente como un navegador que interpreta código HTML). El código HTML es un código estático que sólo permite formatear la apariencia de una página y definir enlaces a otras páginas o URLs. Esto no es suficiente si queremos que el navegador realice funciones más complicadas: validar entradas de formularios, mostrar la evolución del precio de unas acciones, etc.</p>
</div>
<div class="paragraph">
<p>Para ampliar las funcionalidades del navegador (respetando el protocolo HTTP), se utilizan tecnologías como JavaScript, Applets, Flash, etc. Estas se basan en hacer que el navegador ejecute código que le pasa el servidor, bien embebido en documentos HTML (como es el caso de JavaScript), o bien mediante ficheros compilados multiplataforma (como es el caso de los Applets Java o los ficheros Flash).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_aplicaciones_web_java_ee">1.2. Aplicaciones web Java EE</h3>
<div class="paragraph">
<p>Vamos a centrarnos en las aplicaciones web Java EE, en las que los componentes dinámicos que recibirán las peticiones HTTP en el servidor serán los servlets y JSPs. Estos componentes podrán analizar esta petición y utilizar otros componentes Java para realizar las acciones necesarias (beans, EJBs, etc).</p>
</div>
<div class="sect3">
<h4 id="_estructura_de_la_aplicación">1.2.1. Estructura de la aplicación</h4>
<div class="paragraph">
<p>Una aplicación web JavaEE que utilice servlets o páginas JSP debe tener una estructura de ficheros y directorios determinada:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>En el directorio raíz de la aplicación se colocan los <strong>documentos web</strong> HTML o JSP, junto a los recursos que necesiten, como por ejemplo imágenes, hojas de estilo, ficheros de código JavaScript u otros ficheros referenciados desde los documentos web (podemos dividirlas también en directorios si queremos)</p>
</li>
<li>
<p>Colgando del directorio inicial de la aplicación, se tiene un directorio <code>WEB-INF</code>, que contiene la información Web relevante para la aplicación. Esta información se divide en:</p>
<div class="ulist">
<ul>
<li>
<p>Fichero <strong>descriptor de despliegue</strong> de la aplicación: es el fichero descriptor de la aplicación web. Es un fichero XML (llamado <code>web.xml</code>) que contiene información genérica sobre la aplicación. Lo veremos con más detalle más adelante.</p>
</li>
<li>
<p>Subdirectorio <code>classes</code>: en él irán todas las clases Java utilizadas en la aplicación (ficheros <code>.class</code>), es decir, clases externas a la API de Java que se utilicen en las páginas JSP, servlets, etc. Las clases deberán mantener la estructura de paquetes, es decir, si queremos colocar la clase <code>paquete1.subpaquete1.MiClase</code> dentro de <code>classes</code>, se quedará almacenada en el directorio <code>classes/paquete1/subpaquete1/MiClase</code>.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Es recomendable utilizar como nombre de paquete nuestra URL al revés, por ejemplo si tenemos la dirección <code>expertojava.org</code> podríamos utilizar para nuestros proyectos paquetes como <code>org.expertojava.web.servlets</code>.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Subdirectorio <code>lib</code>: aquí colocaremos las clases Java que estén empaquetadas en ficheros JAR (es decir, colocaremos los ficheros JAR de nuestra aplicación Web, y las librerías ajenas a la API de JDK o de servlets y JSP que se necesiten)</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Los ficheros <code>.class</code> se separan de los ficheros JAR, colocando los primeros en el directorio <code>classes</code> y los segundos en <code>lib</code>.
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Esta estructura estará contenida dentro de algún directorio, que será el directorio correspondiente a la aplicación Web, y que podremos, si lo hacemos convenientemente, copiar en el servidor que nos convenga. Es decir, cualquier servidor Web JavaEE soporta esta estructura en una aplicación Web, sólo tendremos que copiarla en el directorio adecuado de cada servidor.</p>
</div>
<div class="paragraph">
<p>Cada aplicación web JavaEE es un <strong>contexto</strong>, una unidad que comprende un conjunto de recursos, clases Java y su configuración. Cuando hablemos de contexto, nos estaremos refiriendo a la aplicación web en conjunto. Por ello utilizaremos indistintamente los términos aplicación web y contexto.</p>
</div>
</div>
<div class="sect3">
<h4 id="_rutas_relativas_al_contexto">1.2.2. Rutas relativas al contexto</h4>
<div class="paragraph">
<p>Cada contexto (aplicación web) instalado en el servidor tendrá asociado una ruta para acceder a él desde la web. Por ejemplo, podemos asociar nuestro contexto la ruta <code>/aplic</code>, de forma que accediendo a la siguiente URL:</p>
</div>
<div class="paragraph">
<p><a href="http://localhost:8080/aplic/index.htm" class="bare">http://localhost:8080/aplic/index.htm</a></p>
</div>
<div class="paragraph">
<p>Estaremos leyendo el recurso <code>/index.htm</code> de nuestro contexto.</p>
</div>
<div class="paragraph">
<p>Supongamos que tenemos alguna imagen o recurso al que queremos acceder desde otro, en nuestra aplicación Web. Por ejemplo, supongamos que colgando del directorio raíz de la aplicación tenemos la imagen <code>miImagen.jpg</code> dentro de la carpeta <code>imagenes</code> (es decir, <code>imagenes/miImagen.jpg</code>).</p>
</div>
<div class="paragraph">
<p>Podemos acceder a esta imagen de varias formas, aunque a veces podemos tener problemas con alguna, porque luego el contenedor Web tome la ruta relativa al lugar desde donde queremos cargar la imagen (o recurso, en general). Este problema lo podemos tener accediendo a elementos desde servlets, sobre todo.</p>
</div>
<div class="paragraph">
<p>Una solución para evitar esto es acceder a todos los elementos de la aplicación a partir de la ruta del contexto. Por ejemplo, si nuestro contexto tiene la ruta <code>/aplic</code> asociada, para acceder a la imagen desde una página HTML, pondríamos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;img</span> <span class="tok-na">src=</span><span class="tok-s">&quot;/aplic/imagenes/miImagen.jpg&quot;</span><span class="tok-nt">&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_empaquetamiento_de_aplicaciones_web_en_ficheros_war">1.2.3. Empaquetamiento de aplicaciones web en ficheros WAR</h4>
<div class="paragraph">
<p>Una forma de distribuir aplicaciones Web Java EE es empaquetar toda la aplicación (a partir de su directorio inicial) dentro de un fichero WAR (de forma parecida a como se hace con un TAR o un JAR), y distribuir dicho fichero. Podemos crear un fichero WAR de la misma forma que creamos un JAR, utilizando la herramienta JAR.</p>
</div>
<div class="paragraph">
<p>Estos ficheros WAR son un estándar de Java EE, por lo que podremos utilizarlos en los diferentes servidores de aplicaciones Java EE existentes.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, si tenemos en el directorio <code>web/ejemplo</code> los siguientes ficheros:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>web/ejemplo/
    index.html
        WEB-INF/
            web.xml
            classes/
                ClaseServlet.class</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para crear la aplicación WAR se siguen los pasos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Crear el WAR colocándonos en dicho directorio <code>web/ejemplo</code> y escribiendo:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>jar cMvf ejemplo.war *</code></pre>
</div>
</div>
<div class="paragraph">
<p>Las opciones <code>c</code>, <code>v</code> y <code>f</code> son para crear el WAR como un JAR comprimido normal. La opción <code>M</code> (mayúscula) es para que no se añada el fichero <code>MANIFEST</code>.</p>
</div>
<div class="paragraph">
<p>También es IMPORTANTE destacar que no debe haber subdirectorios desde la raíz de la aplicación, es decir, la estructura del fichero WAR debe ser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>index.html
WEB-INF/
    web.xml
    classes/
        ClaseServlet.class</code></pre>
</div>
</div>
<div class="paragraph">
<p>sin ningún subdirectorio previo (ni <code>ejemplo/</code> ni <code>web/ejemplo/</code> ni nada por el estilo).</p>
</div>
</li>
<li>
<p>Copiar el fichero WAR al servidor web para poner en marcha la aplicación. Veremos esto con detalle para un servidor de aplicaciones concreto en el siguiente apartado.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
El empaquetamiento en archivos WAR es algo estándar, pero no así el proceso de despliegue, que es dependiente del servidor. No obstante, la mayoría de servidores Java EE funcionan en este aspecto de modo similar: permiten desplegar las aplicaciones desde una consola de administración y también "dejando caer" el fichero en determinado directorio.
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_creación_y_despliegue_de_aplicaciones_web_con_intellij_y_wildfly">1.3. Creación y despliegue de aplicaciones web con IntelliJ y WildFly</h3>
<div class="paragraph">
<p>Vamos a pasar ahora a ver la forma de crear y desplegar aplicaciones web Java EE con un IDE y un servidor de aplicaciones concreto. Vamos a utilizar el IDE IntelliJ IDEA y el servidor de aplicaciones WildFly (JBoss 8.1).</p>
</div>
<div class="sect3">
<h4 id="_creación_de_un_proyecto_web_con_intellij">1.3.1. Creación de un proyecto web con IntelliJ</h4>
<div class="paragraph">
<p>Empezaremos creando un nuevo proyecto web Java EE desde el IDE IntelliJ. Encontramos dos formas de hacer esto:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Crearlo como proyecto web IntelliJ, con <em>New Project</em> &gt; <em>Java Enterprise</em> &gt; <em>Web Application</em>. El proyecto web tendrá ficheros de configuración propios de este IDE.</p>
</li>
<li>
<p>Crearlo como proyecto Maven dentro de IntelliJ, con <em>New Project</em> &gt; <em>Maven</em>, y seleccionando un arquetipo que genere un proyecto web Java EE 7. De esta forma tendremos un proyecto que se podrá construir con Maven fuera del entorno IntelliJ y podrá ser importado por otros IDEs, y que además contará con los ficheros de configuración propios de IntelliJ para poder trabajar con él dentro de este entorno. Cuando se produzcan cambios en la configuración de Maven del proyecto, podremos importar dichos cambios a la configuración del proyecto IntelliJ.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Vamos a utilizar la segunda opción, dada la flexibilidad que nos proporciona Maven para poder construir el proyecto de forma independiente al IDE utilizado. En la pantalla de creación del proyecto deberemos marcar la casilla <em>Create from archetype</em>, y pulsar sobre el botón <em>Add archetype &#8230;&#8203;</em>, ya que el arquetipo que vamos a necesitar (aplicación web Java EE 7) no está en la lista por defecto:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="Images/new-project-1.png" alt="Creación de un nuevo proyecto web" width="66%">
</div>
</div>
<div class="paragraph">
<p>Del arquetipo introduciremos los siguientes datos:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="Images/new-project-2-add-archetype.png" alt="Añadir un nuevo arquetipo Maven" width="33%">
</div>
</div>
<div class="paragraph">
<p>Una vez seleccionado el arquetipo deberemos introducir la configuración del módulo Maven (<code>artifactId</code>, <code>groupId</code>, y <code>version</code>):</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="Images/new-project-3-maven-conf.png" alt="Configuración del módulo Maven" width="66%">
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;groupId&gt;</span>org.codehaus.mojo.archetypes<span class="tok-nt">&lt;/groupId&gt;</span>
<span class="tok-nt">&lt;artifactId&gt;</span>webapp-javaee7<span class="tok-nt">&lt;/artifactId&gt;</span>
<span class="tok-nt">&lt;version&gt;</span>1.1<span class="tok-nt">&lt;/version&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Tras esto, introduciremos el nombre que va a tener el proyecto dentro de IntelliJ. Esto ya no es configuración de Maven, sino del propio IDE:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="Images/new-project-4-name.png" alt="Nombre del proyecto IntelliJ" width="50%">
</div>
</div>
<div class="paragraph">
<p>Con esto habremos finalizado, y veremos nuestro nuevo proyecto con la siguiente organización:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="Images/new-project-5-layout-proyecto-web.png" alt="Layout del proyecto web en IntelliJ" width="33%">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Es posible que durante la creación del proyecto IntelliJ nos pregunte repetidas veces si queremos recargar la información de Maven en el proyecto. Responderemos siempre que si y podemos indicar que esta información se importe de forma automática cuando haya cambios (<em>Enable Auto-Import</em>).
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_despliegue_del_proyecto_en_wildfly_desde_línea_de_comando">1.3.2. Despliegue del proyecto en WildFly desde línea de comando</h4>
<div class="paragraph">
<p>Podemos desplegar nuestro proyecto en el servidor de aplicaciones WildFly directamente desde línea de comando, al igual que ocurre con la mayoría de servidores de aplicaciones Java EE.</p>
</div>
<div class="paragraph">
<p>En primer lugar deberemos poner el servidor WildFly en marcha. Por el momento será suficiente con poner el servidor <em>standalone</em>, que contiene una única instancia del servidor de aplicaciones. Para poner en marcha el servidor ejecutaremos el siguiente comando desde el directorio <code>$WILDFLY_HOME/bin</code>, siendo <code>$WILDFLY_HOME</code> el directorio de instalación de este servidor de aplicaciones:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span class="tok-nv">$ </span>./standalone.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>Con el servidor WilfFly en marcha podremos desplegar una aplicación simplemente "dejando caer" el fichero <em>war</em> en el directorio <code>$WILDFLY_HOME/standalone/desployments</code>. Pasados unos segundos desde la copia del fichero la aplicación se habrá desplegado y podremos acceder a ella mediante un navegador. Por ejemplo, si copiamos un fichero <code>miaplicacion.war</code>, por defecto podremos acceder a ella mediante:</p>
</div>
<div class="paragraph">
<p><a href="http://localhost:8080/miaplicacion/" class="bare">http://localhost:8080/miaplicacion/</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_despliegue_del_proyecto_en_wildfly_con_intellij">1.3.3. Despliegue del proyecto en WildFly con IntelliJ</h4>
<div class="paragraph">
<p>Una vez tenemos un proyecto web creado podemos desplegarlo en un servidor de aplicaciones. Para ello deberemos en primer lugar configurar en IntelliJ el servidor donde queramos desplegar la aplicación, y en segundo lugar crear un perfil de ejecución que le indique a WildFly cómo debe hacer el despliegue de nuestra aplicación web.</p>
</div>
<div class="sect4">
<h5 id="_configuración_de_wildfly_en_intellij">Configuración de WildFly en IntelliJ</h5>
<div class="paragraph">
<p>En primer lugar deberemos configurar el servidor de aplicaciones a utilizar. Para ello entraremos en <em>File</em> &gt; <em>Settings &#8230;&#8203;</em> &gt; <em>Application Servers</em>. En dicha sección pulsaremos sobre el botón para añadir un nuevo servidor de tipo JBoss:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="Images/conf-jboss-1.png" alt="Añadir un nuevo servidor JBoss" width="25%">
</div>
</div>
<div class="paragraph">
<p>Nos pedirá el directorio donde está instalado WildFly:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="Images/conf-jboss-2.png" alt="Directorio de instalación de JBoss" width="33%">
</div>
</div>
<div class="paragraph">
<p>Tras introducirlo veremos el servidor JBoss configurado y ya podremos desplegar el proyecto en él:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="Images/conf-jboss-3.png" alt="Servidor JBoss configurado" width="66%">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
También se podría configurar el servidor en el momento de la creación del perfil de ejecución.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_creación_de_un_perfil_de_ejecución">Creación de un perfil de ejecución</h5>
<div class="paragraph">
<p>Para poder desplegar nuestra aplicación web deberemos crear un perfil de ejecución para ella dentro de IntelliJ.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Necesitaremos un perfil de ejecución por cada aplicación web que queramos poder desplegar.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En primer lugar seleccionaremos <em>Run</em> &gt; <em>Edit configurations &#8230;&#8203;</em>. Dentro de esta pantalla pulsaremos el botón <code>+</code> y añadiremos un nuevo perfil de tipo <em>JBoss Server</em> &gt; <em>Local</em>. Veremos un formulario como el siguiente:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="Images/run-1-profile.png" alt="Creación de un perfil de ejecución" width="66%">
</div>
</div>
<div class="paragraph">
<p>En el campo <em>Name</em> podemos darle un nombre al nuevo perfil de ejecución. Si ya hemos configurado el servidor JBoss, veremos que ya aparece seleccionado como servidor en el que desplegar. En caso contrario, podríamos configurarlo desde esta pantalla.</p>
</div>
<div class="paragraph">
<p>Veremos también que en la parte inferior aparece un <em>Warning</em> indicando que no hay seleccionados artefactos para ser desplegados. Deberemos indicar qué artefacto va a ser desplegado en el servidor cuando ejecutemos este perfil. Podemos indicarlo pulsando sobre el botón <em>Fix</em> o pasando de forma manual a la pestaña <em>Deployment</em>. Desde esta pestaña podemos añadir un nuevo artefacto a desplegar pulsando sobre el botón <code>+</code>:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="Images/run-2-artifacts.png" alt="Selección de artefactos" width="50%">
</div>
</div>
<div class="paragraph">
<p>Tenemos dos artefactos configurados por defecto:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>war</em>: Despliega la aplicación web empaquetada en un fichero WAR</p>
</li>
<li>
<p><em>war exploded</em>: Despliega la aplicación web publicando el directorio sin empaquetar.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Seleccionaremos uno de ellos y nos aparecerá como artefacto a desplegar:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="Images/run-3-deployment.png" alt="Artefactos a desplegar" width="66%">
</div>
</div>
<div class="paragraph">
<p>Ahora ya podremos guardar el perfil de ejecución y pulsar el botón <em>Run</em> para realizar el despliegue. A partir de este momento podremos lanzar este perfil en cualquier momento para volver a realizar el despliegue de la aplicación.</p>
</div>
</div>
<div class="sect4">
<h5 id="_configuración_de_artefactos">Configuración de artefactos</h5>
<div class="paragraph">
<p>Podemos configurar los artefactos generados por el proyecto en la pantalla <em>File</em> &gt; <em>Project Structure &#8230;&#8203;</em> &gt; <em>Artifacts</em>. Aquí veremos los dos artefactos que se crear por defecto para las aplicaciones web, y podremos editarlos o crear nuevos:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="Images/project-structure-1-artifacts.png" alt="Configuración de artefactos" width="100%">
</div>
</div>
<div class="paragraph">
<p>Por ejemplo, podríamos modificar el nombre del fichero WAR para así cambiar el nombre del contexto donde se desplegará la aplicación.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Si queremos cambiar el nombre del contexto en el que se despliega la aplicación es mejor hacerlo introduciendo en el fichero <code>pom-xml</code> el elemento <code>&lt;finalName&gt;</code> dentro de la etiqueta <code>&lt;build&gt;</code>.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;project&gt;</span>
    ...
    <span class="tok-nt">&lt;build&gt;</span>
        <span class="tok-nt">&lt;finalName&gt;</span>MiAplicacionWeb<span class="tok-nt">&lt;/finalName&gt;</span>
        ...
    <span class="tok-nt">&lt;/build&gt;</span>
<span class="tok-nt">&lt;/project&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_depuración_y_cambios_en_caliente">Depuración y cambios en caliente</h5>
<div class="paragraph">
<p>El entorno IntelliJ nos permite realizar cambios en caliente dentro de nuestra aplicación web, es decir, conforme modificamos el código de la aplicación se aplicarán los cambios a la aplicación en ejecución sin necesidad de volver a desplegar. Para poder realizar cambios en caliente deberemos desplegar de la siguiente forma:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Seleccionaremos como artefacto a generar la aplicación web descomprimida (<em>war exploded</em>).</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Deberemos renombrar el artefacto de tipo <em>war exploded</em> de forma que acabe con <code>.war</code>, ya que de no ser así obtendremos un error en IntelliJ.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Desplegaremos la aplicación en modo <em>debug</em>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Con esto, cada vez que realicemos un cambio se aplicará a la aplicación ya desplegada en el servidor. Además, la ejecución en modo <em>debug</em> nos permitirá añadir puntos de parada y realizar la ejecución paso a paso inspeccionando el valor de cada variable.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_componentes_de_la_aplicación_java_ee">1.4. Componentes de la aplicación Java EE</h3>
<div class="sect3">
<h4 id="_el_descriptor_de_despliegue">1.4.1. El descriptor de despliegue</h4>
<div class="paragraph">
<p>Como hemos dicho anteriormente, el directorio <code>WEB-INF</code> de una aplicación web con servlets y/o páginas JSP, debe haber un fichero descriptor de despliegue (llamado <code>web.xml</code>) que contenga la información relativa a la aplicación. Este descriptor de despliegue es el mecanismo estándar para configurar aplicaciones web JavaEE.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A partir de la API de servlets 3.0 (Java EE 7) el descriptor de despliegue es opcional, pero es recomendable contar con él ya que será necesario para configurar determinados elementos.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El <code>web.xml</code> es estándar en JavaEE y por tanto todo lo visto en esta sección es igualmente aplicable a cualquier servidor compatible JavaEE, aunque no sea WildFly.</p>
</div>
<div class="sect4">
<h5 id="_estructura_del_descriptor_de_despliegue">Estructura del descriptor de despliegue</h5>
<div class="paragraph">
<p>Es un fichero XML, que comienza con una cabecera XML que indica la versión y la codificación de caracteres, y un <code>DOCTYPE</code> que indica el tipo de documento, y la especificación de servlets que se sigue. La etiqueta raíz del documento XML es <code>web-app</code>. Así, un ejemplo de fichero podría ser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tok-nt">&lt;web-app</span> <span class="tok-na">xmlns:xsi=</span><span class="tok-s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
  <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://java.sun.com/xml/ns/javaee&quot;</span>
  <span class="tok-na">xmlns:web=</span><span class="tok-s">&quot;http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;</span>
  <span class="tok-na">xsi:schemaLocation=</span><span class="tok-s">&quot;http://java.sun.com/xml/ns/javaee</span>
<span class="tok-s">                      http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;</span>
  <span class="tok-na">id=</span><span class="tok-s">&quot;WebApp_ID&quot;</span> <span class="tok-na">version=</span><span class="tok-s">&quot;3.0&quot;</span><span class="tok-nt">&gt;</span>

	<span class="tok-nt">&lt;display-name&gt;</span>
		Mi Aplicacion Web
	<span class="tok-nt">&lt;/display-name&gt;</span>
	<span class="tok-nt">&lt;description&gt;</span>
		Esta es una aplicacion web sencilla a modo de ejemplo
	<span class="tok-nt">&lt;/description&gt;</span>
<span class="tok-nt">&lt;/web-app&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En este caso se está utilizando la especificación 3.0 de servlets. Algunos servidores permiten omitir la cabecera <code>xml</code> y el <code>DOCTYPE</code>, pero sí es una buena costumbre el ponerlas.</p>
</div>
<div class="paragraph">
<p>Dentro de la etiqueta raíz <code>&lt;web-app&gt;</code> podemos colocar otros elementos que ayuden a establecer la configuración de nuestra aplicación web. Veremos a continuación los elementos de configuración general de la aplicación. Conforme veamos cada característica de la API de servlets, repasaremos los elementos del descriptor del despliegue que hagan referencia a ella.</p>
</div>
</div>
<div class="sect4">
<h5 id="_información_general_de_la_aplicación">Información general de la aplicación</h5>
<div class="paragraph">
<p>Tenemos dos etiquetas que nos permiten especificar información sobre la aplicación que se mostrará cuando se presente en una interfaz gráfica, y nos servirán para identificarla:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong><code>&lt;display-name&gt;</code></strong>: nombre con que deben utilizar las aplicaciones
gráficas para referenciar a la aplicación</p>
</li>
<li>
<p><strong><code>&lt;description&gt;</code></strong>: texto descriptivo de la aplicación</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_páginas_de_inicio">Páginas de inicio</h5>
<div class="paragraph">
<p>Podemos también indicar la página (o posibles páginas) que se devolverán por defecto si no se especifica ninguna concreta en la URL:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong><code>&lt;welcome-file-list&gt;</code></strong>: para indicar qué páginas debe buscar el servidor como páginas de inicio en el caso de que en la URL se indique el directorio, pero no la página, como por ejemplo:</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="http://localhost:8080/unadireccion/dir/" class="bare">http://localhost:8080/unadireccion/dir/</a></p>
</div>
<div class="paragraph">
<p>Para ello, esta etiqueta tiene una o varias subetiquetas <strong><code>&lt;welcome-file&gt;</code></strong> para indicar cada una de las posibles páginas</p>
</div>
<div class="paragraph">
<p>Por ejemplo, podemos indicar que las páginas por defecto sean <code>index.html</code> o <code>index.jsp</code> con:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;welcome-file-list&gt;</span>
	<span class="tok-nt">&lt;welcome-file&gt;</span>index.html<span class="tok-nt">&lt;/welcome-file&gt;</span>
	<span class="tok-nt">&lt;welcome-file&gt;</span>index.jsp<span class="tok-nt">&lt;/welcome-file&gt;</span>
<span class="tok-nt">&lt;/welcome-file-list&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Las páginas se buscan en el orden en que se especifican en esta etiqueta.</p>
</div>
</div>
<div class="sect4">
<h5 id="_creación_del_descriptor_de_despliegue_con_intellij">Creación del descriptor de despliegue con IntelliJ</h5>
<div class="paragraph">
<p>Al crear un proyecto Java EE 7 (o superior) con IntelliJ nos da la opción de crear o no el descriptor de despliegue. Esto es debido a que, como se ha comentado anteriormente, en esta versión de la plataforma es opcional contar con este fichero. Cuando el proyecto es creado con el arquetipo <code>webapp-javaee7</code> de Maven el descriptor de despliegue no se crea. A pesar de ser un fichero opcional, si no se ha creado de forma automática al crear el proyecto es recomendable crearlo posteriormente.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
En algunas versiones de IntelliJ no funciona correctamente la creación de servlets si no se cuenta con un descriptor de despliegue. Se trata de un <em>bug</em>, ya que no es necesario contar con un descriptor de despligue para crear servlets en Java EE 7.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para crear el descriptor de despliegue con IntelliJ en un proyecto que todavía no cuenta con él, podemos entrar en <em>File</em> &gt; Project Structure &#8230;&#8203;_ &gt; <em>Facets</em>, y seleccionar el <em>facet Web</em>. Dentro de esta pantalla pulsaremos el botón <code>+</code> para crear un nuevo descriptor de despliegue en la aplicación. Deberemos indicar el directorio donde crearlo, que al ser un proyecto de Maven deberá ser el siguiente:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="Images/project-structure-2-add-deployment-descriptor.png" alt="Añadir el descriptor de despligue" width="66%">
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
En el proyecto Maven IntelliJ no detecta correctamente el directorio donde crear el fichero <code>web.xml</code>. Es importante que esté en <code>src/main/webapp/WEB-INF</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Una vez creado, veremos que la aplicación ya cuenta con un <em>Web Module Deployment Description</em>:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="Images/project-structure-3-facets-web.png" alt="Descriptor de despliegue en _facet_ web" width="100%">
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_servlets">1.4.2. Servlets</h4>
<div class="paragraph">
<p>Un <strong>servlet</strong> es un programa Java que se ejecuta en un servidor Web y construye o sirve
páginas web. De esta forma se pueden construir páginas dinámicas, basadas en diferentes fuentes variables:
datos proporcionados por el usuario, fuentes de información variable (páginas de noticias, por ejemplo),
o programas que extraigan información de bases de datos.</p>
</div>
<div class="paragraph">
<p>Comparado con un CGI, un servlet es más sencillo de utilizar, más eficiente (se arranca un hilo por
cada petición y no un proceso entero), más potente y portable. Con los servlets podremos, entre otras
cosas, procesar, sincronizar y coordinar múltiples peticiones de clientes, reenviar peticiones a otros
servlets o a otros servidores, etc.</p>
</div>
<div class="sect4">
<h5 id="_recursos_de_servlets_y_jsp">Recursos de servlets y JSP</h5>
<div class="paragraph">
<p>Normalmente al hablar de servlets se habla de JSP y viceversa, puesto que ambos conceptos están
muy interrelacionados. Para trabajar con ellos se necesitan tener presentes algunos recursos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Un <strong>servidor web</strong> que dé soporte a servlets / JSP (contenedor de servlets y páginas JSP). Ejemplos de estos servidores son Apache Tomcat, Resin, JRun, Java Web Server, BEA WebLogic, etc.</p>
</li>
<li>
<p>Las <strong>librerías</strong> (clases) necesarias para trabajar con servlets / JSP. Normalmente vienen en ficheros JAR en un directorio <code>lib</code> del servidor. Al desarrollar nuestra aplicación, deberemos tener las librerías necesarias en el <em>classpath</em> para que compilen los ficheros (sólo necesitaremos compilar los servlets, no los JSP).</p>
</li>
<li>
<p>La <strong>documentación</strong> sobre la API de servlets / JSP (no necesaria, pero sí recomendable)</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Cuando trabajemos con un entorno como IntelliJ, al crear un proyecto de aplicación web se añadirán de forma automática referencias a las librerías de componentes web del servidor.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_arquitectura_del_paquete_servlet">Arquitectura del paquete servlet</h5>
<div class="paragraph">
<p>Dentro del paquete <strong><code>javax.servlet</code></strong> tenemos toda la infraestructura para poder trabajar con servlets. El elemento central es la interfaz <strong><code>Servlet</code></strong>, que define los métodos para cualquier servlet. La clase <strong><code>GenericServlet</code></strong> es una clase abstracta que implementa dicha interfaz para un servlet genérico, independiente del protocolo. Para definir un servlet que se utilice vía web, se tiene la clase <strong><code>HttpServlet</code></strong> dentro del subpaquete <strong><code>javax.servlet.http</code></strong>. Esta clase hereda de <code>GenericServlet</code>, y también es una clase abstracta, de la que heredaremos para construir los servlets para nuestras aplicaciones web.
Cuando un servlet acepta una petición de un cliente, se reciben dos objetos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Un objeto de tipo <strong><code>ServletRequest</code></strong> que contiene los datos de la petición del usuario (toda la información entrante). Con esto se accede a los parámetros pasados por el cliente, el protocolo empleado, etc. Se puede obtener también un objeto <strong><code>ServletInputStream</code></strong> para obtener datos del cliente que realiza la petición. La subclase <strong><code>HttpServletRequest</code></strong> procesa peticiones de tipo HTTP.</p>
</li>
<li>
<p>Un objeto de tipo <strong><code>ServletResponse</code></strong> que contiene (o contendrá) la respuesta del servlet ante la petición (toda la información saliente). Se puede obtener un objeto <strong><code>ServletOutputStream</code></strong>, y un <code>Writer</code>, para poder escribir la respuesta. La clase <strong><code>HttpServletResponse</code></strong> se emplea para respuestas a peticiones HTTP.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_ciclo_de_vida_de_un_servlet">Ciclo de vida de un servlet</h5>
<div class="paragraph">
<p>Todos los servlets tienen el mismo ciclo de vida:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Un servidor <strong>carga e inicializa</strong> el servlet.</p>
</li>
<li>
<p>El servlet <strong>procesa</strong> cero o más peticiones de clientes. Por cada petición se lanza un hilo, ejecutándose estos hilos de forma concurrente en sobre un mismo objeto <em>servlet</em>.</p>
</li>
<li>
<p>El servidor <strong>destruye</strong> el servlet, normalmente en momentos en los que no tiene peticiones o cuando se apaga el servidor.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>1. Inicialización</strong></p>
</div>
<div class="paragraph">
<p>En cuanto a la inicialización de un servlet, se tiene una por defecto en el método <strong><code>init()</code></strong>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">init</span><span class="tok-o">()</span> <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span>
<span class="tok-o">{</span>
  <span class="tok-o">...</span>
<span class="tok-o">}</span>

<span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">init</span><span class="tok-o">(</span><span class="tok-n">ServletConfig</span> <span class="tok-n">conf</span><span class="tok-o">)</span> <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span>
<span class="tok-o">{</span>
  <span class="tok-kd">super</span><span class="tok-o">.</span><span class="tok-na">init</span><span class="tok-o">(</span><span class="tok-n">conf</span><span class="tok-o">);</span>
  <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El primer método se utiliza si el servlet no necesita parámetros de configuración externos. El segundo se emplea para tomar dichos parámetros del objeto <code>ServletConfig</code> que se le pasa. La llamada a <code>super.init(&#8230;&#8203;)</code> al principio del método es MUY importante, porque el servlet utiliza esta configuración en otras zonas.
Si queremos definir nuestra propia inicialización, deberemos sobreescribir alguno de estos métodos. Si ocurre algún error al inicializar y el servlet no es capaz de atender peticiones, debemos lanzar una excepción de tipo <code>UnavailableException</code>.
Podemos utilizar la inicialización para establecer una conexión con una base de datos (si trabajamos con base de datos), abrir ficheros, o cualquier tarea que se necesite hacer una sola vez antes de que el servlet comience a funcionar.</p>
</div>
<div class="paragraph">
<p><strong>2. Procesamiento de peticiones</strong></p>
</div>
<div class="paragraph">
<p>Una vez inicializado, cada petición de usuario lanza un hilo que llama al método <strong><code>service()</code></strong> del servlet.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">service</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
        <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
<span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Este método obtiene el tipo de petición que se ha realizado (GET, POST, PUT, DELETE). Dependiendo del tipo de petición que se tenga, se llama luego a uno de los métodos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>doGet()</code>:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
      <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
<span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para peticiones de tipo GET (aquellas realizadas al escribir una dirección en un navegador, pinchar un enlace o rellenar un formulario que no tenga METHOD=POST)</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>doPost()</code>:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">doPost</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
       <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
<span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para peticiones POST (aquellas realizadas al rellenar un formulario que tenga METHOD=POST)</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>doXXX()</code>: normalmente sólo se emplean los dos métodos anteriores, pero se tienen otros métodos para peticiones de tipo DELETE (<code>doDelete()</code>), PUT (<code>doPut()</code>), OPTIONS (<code>doOptions()</code>) y TRACE (<code>doTrace()</code>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>3. Destrucción</strong></p>
</div>
<div class="paragraph">
<p>El método <code>destroy()</code> de los servlets se emplea para eliminar un servlet y sus recursos asociados.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">destroy</span><span class="tok-o">()</span> <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Aquí debe deshacerse cualquier elemento que se construyó en la inicialización (cerrar conexiones con bases de datos, cerrar ficheros, etc).
El servidor llama a <code>destroy()</code> cuando todas las llamadas de servicios del servlet han concluido, o cuando haya pasado un determinado número de segundos (lo que ocurra primero). Si esperamos que el servlet haga tareas que requieran mucho tiempo, tenemos que asegurarnos de que dichas tareas se completarán. Podemos hacer lo siguiente:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Definir un contador de tareas activas, que se incremente cada vez que una tarea comienza (entendemos por <em>tarea</em> cada petición que se realice al servlet), y se decremente cada vez que una termina. Podemos utilizar bloques de código <code>synchronized</code> para evitar problemas de concurrencia.</p>
</li>
<li>
<p>Hacer que el método <code>destroy()</code> no termine hasta que lo hagan todas las tareas pendientes (comprobando el contador de tareas pendientes)</p>
</li>
<li>
<p>Hacer que las tareas pendientes terminen su trabajo si se quiere cerrar el servlet (comprobando algún flag que indique si el servlet se va a cerrar o no).</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_estructura_básica_de_un_servlet">Estructura básica de un servlet</h5>
<div class="paragraph">
<p>La plantilla común para implementar un servlet es:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.http.*</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">ClaseServlet</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span> <span class="tok-o">{</span>

  <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                    <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
               <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
    <span class="tok-c1">// ... codigo para una peticion GET</span>
  <span class="tok-o">}</span>

  <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">doPost</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                     <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
               <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
    <span class="tok-c1">// ... codigo para una peticion POST</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El servlet hereda de la clase <code>HttpServlet</code>. Normalmente se deben sobreescribir los métodos <code>doGet()</code>, <code>doPost()</code> o ambos, colocando el código que queremos que se ejecute cuando se reciba una petición GET o POST, respectivamente. Conviene definir los dos para distinguir ambas peticiones. En caso de que queramos hacer lo mismo para GET o POST, definimos el código en uno de ellos, y hacemos que el otro lo llame.
Aparte de estos métodos, podemos utilizar otros de los que hemos visto: <code>init()</code> (para inicializaciones), <code>doXXX()</code> (para tratar otros tipos de peticiones (PUT, DELETE, etc)), <code>destroy()</code> (para finalizar el servlet), etc, así como nuestros propios métodos internos de la clase.</p>
</div>
</div>
<div class="sect4">
<h5 id="_configuración_de_servlets_en_aplicaciones_web">Configuración de servlets en aplicaciones web</h5>
<div class="paragraph">
<p>Para instalar un servlet en una aplicación web, se coloca la clase compilada del servlet dentro del directorio <code>WEB-INF/classes</code> de la aplicación (respetando también la estructura de paquetes, creando tantos subdirectorios como sea necesario).</p>
</div>
<div class="paragraph">
<p>De forma alternativa, también podríamos empaquetar nuestros servlets en un JAR y poner esta librería de clases dentro del directorio <code>WEB-INF/lib</code>. De cualquiera de las dos formas la clase del servlet estará localizable para la aplicación. Veremos ahora las formas que tenemos de invocar a ese servlet.</p>
</div>
<div class="sect5">
<h6 id="_mapeo_de_servlets_en_el_fichero_descriptor">Mapeo de servlets en el fichero descriptor</h6>
<div class="paragraph">
<p>Los servlets se invocarán cuando desde un cliente hagamos una
petición a una URL determinada. Para especificar la URL a la que
está asociada cada servlet, deberemos configurar dicho servlet
en el fichero descriptor de despliegue (<code>web.xml</code>).</p>
</div>
<div class="paragraph">
<p>En primer lugar deberemos introducir una marca <code>&lt;servlet&gt;</code> para declarar cada servlet de la siguiente forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;servlet&gt;</span>
  <span class="tok-nt">&lt;servlet-name&gt;</span>nombre<span class="tok-nt">&lt;/servlet-name&gt;</span>
  <span class="tok-nt">&lt;servlet-class&gt;</span>unpaquete.ClaseServlet<span class="tok-nt">&lt;/servlet-class&gt;</span>
<span class="tok-nt">&lt;/servlet&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Donde <code>&lt;servlet-name&gt;</code> es un nombre identificativo y arbitrario del servlet, y <code>&lt;servlet-class&gt;</code> es la clase del servlet.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Al declarar un servlet, debe indicarse el nombre
completo de la clase en la que está implementado, incluyendo paquetes
y subpaquetes. Esto es así porque en el <code>web.xml</code> no tenemos
ningún "import" que nos permita desambiguar entre posibles diferentes
clases con el mismo nombre.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Una vez declarado nuestro servlet, deberemos mapearlo a una URL.
Esto se consigue mediante las etiquetas <code>&lt;servlet-mapping&gt;</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;servlet-mapping&gt;</span>
  <span class="tok-nt">&lt;servlet-name&gt;</span>nombre<span class="tok-nt">&lt;/servlet-name&gt;</span>
  <span class="tok-nt">&lt;url-pattern&gt;</span>/ejemploservlet<span class="tok-nt">&lt;/url-pattern&gt;</span>
<span class="tok-nt">&lt;/servlet-mapping&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En la subetiqueta <code>&lt;servlet-name&gt;</code>
se pone el nombre del servlet al que se quiere asignar la URL
(será uno de los nombres dados en alguna etiqueta
<code>&lt;servlet&gt;</code> previa), y en
<code>&lt;url-pattern&gt;</code> colocamos la URL
que le asignamos al servlet, que debe comenzar con '/'.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Destacamos que primero se colocan todas las etiquetas
<code>&lt;servlet&gt;</code>, y luego las <code>&lt;servlet-mapping&gt;</code>
que se requieran. En las actuales versiones de los servidores web el
orden es indiferente, pero si queremos garantizar la compatibilidad
con versiones anteriores, deberemos respetarlo.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Así, con lo anterior, podremos llamar al servlet identificado
con <code>nombre</code> accediendo a la URL a la que se encuentra
mapeado:</p>
</div>
<div class="paragraph">
<p><a href="http://localhost:8080/%3Cdir%3E/ejemploservlet" class="bare">http://localhost:8080/&lt;dir&gt;/ejemploservlet</a></p>
</div>
<div class="paragraph">
<p>siendo <code>&lt;dir&gt;</code> el directorio en el que se encuentra el contexto de nuestra aplicación Web.</p>
</div>
<div class="paragraph">
<p>También podemos asignar en <code>&lt;url-pattern&gt;</code> expresiones como:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;servlet-mapping&gt;</span>
  <span class="tok-nt">&lt;servlet-name&gt;</span>nombre<span class="tok-nt">&lt;/servlet-name&gt;</span>
  <span class="tok-nt">&lt;url-pattern&gt;</span>/ejemploservlet/*<span class="tok-nt">&lt;/url-pattern&gt;</span>
<span class="tok-nt">&lt;/servlet-mapping&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>o como:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;servlet-mapping&gt;</span>
  <span class="tok-nt">&lt;servlet-name&gt;</span>nombre<span class="tok-nt">&lt;/servlet-name&gt;</span>
  <span class="tok-nt">&lt;url-pattern&gt;</span>/ejemploservlet/*.do<span class="tok-nt">&lt;/url-pattern&gt;</span>
<span class="tok-nt">&lt;/servlet-mapping&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Con el primero, cualquier URL del directorio de nuestra
aplicación Web que comience con <code>/ejemploservlet/</code>
se redirigirá y llamará al servlet identificado con
<code>nombre</code>. Por ejemplo, las direcciones:</p>
</div>
<div class="paragraph">
<p><a href="http://localhost:8080/%3Cdir%3E/ejemploservlet/unapagina.html" class="bare">http://localhost:8080/&lt;dir&gt;/ejemploservlet/unapagina.html</a></p>
</div>
<div class="paragraph">
<p><a href="http://localhost:8080/%3Cdir%3E/ejemploservlet/login.do" class="bare">http://localhost:8080/&lt;dir&gt;/ejemploservlet/login.do</a></p>
</div>
<div class="paragraph">
<p>acabarían llamando al servlet <code>nombre</code>.</p>
</div>
<div class="paragraph">
<p>Con el segundo, cualquier llamada a un recurso acabado en
<code>.do</code> del directorio <code>/ejemploservlet/</code>
de nuestra aplicación se redirigiría al servlet
<code>nombre</code>. Podemos hacer que distintas URLs llamen
a un mismo servlet, sin más que añadir varios grupos
<code>&lt;servlet-mapping&gt;</code>, uno por cada patrón de
URL diferente, y todos con el mismo <code>&lt;servlet-name&gt;</code>.</p>
</div>
<div class="paragraph">
<p>Este mismo procedimiento se puede aplicar también si
en lugar de un servlet queremos tratar una página JSP. Para
declarar una página <strong>JSP</strong>, sustituiremos la
etiqueta <code>&lt;servlet-class&gt;</code> por la etiqueta
<strong><code>&lt;jsp-file&gt;</code></strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;servlet&gt;</span>
  <span class="tok-nt">&lt;servlet-name&gt;</span>nombre2<span class="tok-nt">&lt;/servlet-name&gt;</span>
  <span class="tok-nt">&lt;jsp-file&gt;</span>/mipagina.jsp<span class="tok-nt">&lt;/jsp-file&gt;</span>
<span class="tok-nt">&lt;/servlet&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Esta página se podrá mapear a diferentes URLs de la misma
forma en la que lo hacemos para un servlet.</p>
</div>
</div>
<div class="sect5">
<h6 id="_mapeo_de_servlets_mediante_anotaciones">Mapeo de servlets mediante anotaciones</h6>
<div class="paragraph">
<p>En la API de Servlets 3.0 se incluyen una serie de importantes novedades dirigidas
principalmente a facilitar el desarrollo de los componentes web. Esto se consigue mediante el uso
de anotaciones para configurar los servlets, en lugar de tener que declararlos
en el fichero <code>web.xml</code>. Esto supone un cambio importante en la forma
de trabajar con servlets. Ahora bastará con anotar la clase en la que implementamos
el servlet de la siguiente forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@WebServlet</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;miServlet&quot;</span><span class="tok-o">,</span> <span class="tok-n">urlPatterns</span><span class="tok-o">=</span><span class="tok-s">&quot;/UrlServlet&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">ClaseServlet</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span> <span class="tok-o">{</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                      <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-o">...</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">doPost</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                       <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-o">...</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En la anotación <code>@WebServlet</code> se debe especificar obligatoriamente el
atributo <code>urlPatterns</code>, con el que se especifica la URL a la que queremos
mapear el servlet. Si no necesitamos más parámetros que la URL, podemos especificarla como valor
por defecto de la anotación:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@WebServlet</span><span class="tok-o">(</span><span class="tok-s">&quot;/UrlServlet&quot;</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Con esto ya no se necesitará declarar el servlet en el fichero <code>web.xml</code>.</p>
</div>
</div>
<div class="sect5">
<h6 id="_asignar_parámetros_de_inicio_a_un_servlet_o_página_jsp">Asignar parámetros de inicio a un servlet o página JSP</h6>
<div class="paragraph">
<p>El hecho de asignar un nombre a un servlet o página JSP mediante la etiqueta <code>&lt;servlet&gt;</code> y sus subetiquetas nos permite identificarlo con ese nombre, y también poderle asignar parámetros de inicio. Para asignar parámetros se colocan etiquetas <strong><code>&lt;init-param&gt;</code></strong> dentro de la etiqueta <code>&lt;servlet&gt;</code> del servlet o página JSP al que le queremos asignar parámetros. Dichas etiquetas tienen como subetiquetas un <strong><code>&lt;param-name&gt;</code></strong> (con el nombre del parámetro) y un <strong><code>&lt;param-value&gt;</code></strong> (con el valor del parámetro). Por ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;servlet&gt;</span>
  <span class="tok-nt">&lt;servlet-name&gt;</span>nombre<span class="tok-nt">&lt;/servlet-name&gt;</span>
  <span class="tok-nt">&lt;servlet-class&gt;</span>ClaseServlet<span class="tok-nt">&lt;/servlet-class&gt;</span>
  <span class="tok-nt">&lt;init-param&gt;</span>
    <span class="tok-nt">&lt;param-name&gt;</span>param1<span class="tok-nt">&lt;/param-name&gt;</span>
    <span class="tok-nt">&lt;param-value&gt;</span>valor1<span class="tok-nt">&lt;/param-value&gt;</span>
  <span class="tok-nt">&lt;/init-param&gt;</span>
  <span class="tok-nt">&lt;init-param&gt;</span>
    <span class="tok-nt">&lt;param-name&gt;</span>param2<span class="tok-nt">&lt;/param-name&gt;</span>
    <span class="tok-nt">&lt;param-value&gt;</span>valor2<span class="tok-nt">&lt;/param-value&gt;</span>
  <span class="tok-nt">&lt;/init-param&gt;</span>
<span class="tok-nt">&lt;/servlet&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si estamos utilizando Servlet 3.0, podemos también utilizar la anotación <code>@WebServlet</code> para configurar los
parámetros de inicio:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@WebServlet</span><span class="tok-o">(</span><span class="tok-n">urlPatterns</span><span class="tok-o">=</span><span class="tok-s">&quot;/UrlServlet&quot;</span><span class="tok-o">,</span>
         <span class="tok-n">initParams</span> <span class="tok-o">={</span>
             <span class="tok-nd">@InitParam</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;param1&quot;</span><span class="tok-o">,</span> <span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-s">&quot;valor1&quot;</span><span class="tok-o">),</span>
             <span class="tok-nd">@InitParam</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;param2&quot;</span><span class="tok-o">,</span> <span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-s">&quot;valor2&quot;</span><span class="tok-o">)</span> <span class="tok-o">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Estos parámetros también pueden ser declarados por separado con la anotación
<code>@WebInitParam</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@WebInitParam</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;param1&quot;</span><span class="tok-o">,</span> <span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-s">&quot;valor1&quot;</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para obtener luego los parámetros desde el servlet se utiliza <strong><code>getServletConfig().getInitParameter(nombre)</code></strong> donde <code>nombre</code> es el valor <code>&lt;param-name&gt;</code> del parámetro que se busca, y devuelve el valor (elemento <code>&lt;param-value&gt;</code> asociado), que es de tipo <code>String</code> siempre. Para obtener estos valores desde páginas JSP se emplean otros métodos.
Los parámetros de inicio sólo se aplican cuando accedemos al servlet o página JSP a través del nombre asignado en <code>&lt;servlet-name&gt;</code>, o a través de la URL asociada en un <code>&lt;servlet-mapping&gt;</code>.</p>
</div>
</div>
<div class="sect5">
<h6 id="_cargar_servlets_al_inicio">Cargar servlets al inicio</h6>
<div class="paragraph">
<p>A veces nos puede interesar que un servlet se cargue al arrancar el servidor, y no con la primera petición de un cliente. Para hacer eso, incluimos una etiqueta <strong><code>&lt;load-on-startup&gt;</code></strong> dentro de la etiqueta <code>&lt;servlet&gt;</code>. Dicha etiqueta puede estar vacía:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;servlet&gt;</span>
  <span class="tok-nt">&lt;servlet-name&gt;</span>nombre<span class="tok-nt">&lt;/servlet-name&gt;</span>
  <span class="tok-nt">&lt;servlet-class&gt;</span>ClaseServlet<span class="tok-nt">&lt;/servlet-class&gt;</span>
  <span class="tok-nt">&lt;load-on-startup/&gt;</span>
<span class="tok-nt">&lt;/servlet&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>o contener un número:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;servlet&gt;</span>
  <span class="tok-nt">&lt;servlet-name&gt;</span>nombre<span class="tok-nt">&lt;/servlet-name&gt;</span>
  <span class="tok-nt">&lt;servlet-class&gt;</span>ClaseServlet<span class="tok-nt">&lt;/servlet-class&gt;</span>
  <span class="tok-nt">&lt;load-on-startup&gt;</span>2<span class="tok-nt">&lt;/load-on-startup&gt;</span>
<span class="tok-nt">&lt;/servlet&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>que indica el orden en que el servidor irá cargando los servlets (de menor a mayor valor).</p>
</div>
<div class="paragraph">
<p>Como en los casos anteriores, esto también puede ser indicado mediante la anotación <code>@WebServlet</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@WebServlet</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;miServlet&quot;</span><span class="tok-o">,</span> <span class="tok-n">urlPatterns</span><span class="tok-o">=</span><span class="tok-s">&quot;/UrlServlet&quot;</span><span class="tok-o">,</span> <span class="tok-n">loadOnStartup</span><span class="tok-o">=</span><span class="tok-s">&quot;2&quot;</span><span class="tok-o">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_logging_en_aplicaciones_java_ee_con_servlets">Logging en aplicaciones Java EE con servlets</h5>
<div class="paragraph">
<p>Utilizaremos Log4J como librería de <em>logging</em>, pero encapsulada dentro de la librería <em>commons-logging</em> de Jakarta. Para poder imprimir mensajes de log en una aplicación que contenga servlets se deben seguir estos pasos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Añadir los ficheros JAR de las librerías (<code>commons-logging-X.X.jar</code> y <code>log4j-X.X.X.jar</code>) en la carpeta <code>WEB-INF/lib</code> de nuestra aplicación (o añadirlas como dependencias de Maven).</p>
</li>
<li>
<p>Colocar dos ficheros <code>.properties</code> en el CLASSPATH de la aplicación (carpeta <code>WEB-INF/classes</code>):</p>
<div class="ulist">
<ul>
<li>
<p>Un fichero <code>commons-logging.properties</code> indicando que vamos a utilizar Log4J como librería subyacente.</p>
</li>
<li>
<p>Un fichero <code>log4j.properties</code> con la configuración de logging para Log4J.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Estos ficheros los colocaremos en una carpeta fuente llamada <code>resources</code>, para que al compilarse la aplicación se vuelquen a <code>/WEB-INF/classes</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Finalmente, sólo queda en cada servlet o clase Java colocar los mensajes de log donde queramos. Veremos cómo hacerlo en servlets y páginas JSP en el siguiente módulo. Aquí vemos un ejemplo de cómo ponerlos en cada servlet:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-o">...</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.apache.commons.logging.*</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">ServletLog4J1</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span> <span class="tok-o">{</span>

  <span class="tok-kd">static</span> <span class="tok-n">Log</span> <span class="tok-n">logger</span> <span class="tok-o">=</span> <span class="tok-n">LogFactory</span><span class="tok-o">.</span><span class="tok-na">getLog</span><span class="tok-o">(</span><span class="tok-n">ServletLog4J1</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>

  <span class="tok-c1">// Metodo para procesar una peticion GET</span>

  <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                    <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
                        <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
    <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-na">info</span><span class="tok-o">(</span><span class="tok-s">&quot;Atendiendo peticion Servlet Log4J&quot;</span><span class="tok-o">);</span>
    <span class="tok-n">PrintWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>
    <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;Servlet sencillo de prueba para logging&quot;</span><span class="tok-o">);</span>
    <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-na">debug</span><span class="tok-o">(</span><span class="tok-s">&quot;Fin de procesamiento de petición&quot;</span><span class="tok-o">);</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_ejemplos_básicos_de_servlets">Ejemplos básicos de servlets</h5>
<div class="sect5">
<h6 id="_servlet_que_genera_texto_plano">Servlet que genera texto plano</h6>
<div class="paragraph">
<p>El siguiente ejemplo de servlet muestra una página con un mensaje de saludo: "Este es un servlet de prueba". Lo cargamos mediante petición GET.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">ejemplos</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">java.io.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.http.*</span><span class="tok-o">;</span>

<span class="tok-nd">@WebServlet</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;ejemplo1_1&quot;</span><span class="tok-o">,</span> <span class="tok-n">urlPatterns</span><span class="tok-o">=</span><span class="tok-s">&quot;/ejemploservlet&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">ClaseServlet</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span> <span class="tok-o">{</span>

  <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                    <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
                 <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
    <span class="tok-n">PrintWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>
    <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;Este es un servlet de prueba&quot;</span><span class="tok-o">);</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Se obtiene un <code>Writer</code> para poder enviar datos al usuario. Simplemente se le envía la cadena que se mostrará en la página generada.</p>
</div>
</div>
<div class="sect5">
<h6 id="_servlet_que_genera_una_página_html">Servlet que genera una página HTML</h6>
<div class="paragraph">
<p>Este otro ejemplo escribe código HTML para mostrar una página web.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">ejemplos</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">java.io.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.http.*</span><span class="tok-o">;</span>

<span class="tok-nd">@WebServlet</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;ejemplo1_2&quot;</span><span class="tok-o">,</span> <span class="tok-n">urlPatterns</span><span class="tok-o">=</span><span class="tok-s">&quot;/ejemploservletHTML&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">ClaseServletHTML</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span> <span class="tok-o">{</span>

  <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                    <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
                 <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
    <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setContentType</span><span class="tok-o">(</span><span class="tok-s">&quot;text/html&quot;</span><span class="tok-o">);</span>
    <span class="tok-n">PrintWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>
    <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;!DOCTYPE HTML PUBLIC \&quot;&quot;</span><span class="tok-o">+</span>
                 <span class="tok-s">&quot;-//W3C//DTD HTML 4.0 &quot;</span> <span class="tok-o">+</span>
                 <span class="tok-s">&quot;Transitional//EN\&quot;&gt;&quot;</span><span class="tok-o">);</span>
    <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;HTML&gt;&quot;</span><span class="tok-o">);</span>
    <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;BODY&gt;&quot;</span><span class="tok-o">);</span>
    <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;h1&gt;Titulo&lt;/h1&gt;&quot;</span><span class="tok-o">);</span>
    <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;br&gt;Servlet que genera HTML&quot;</span><span class="tok-o">);</span>
    <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;/BODY&gt;&quot;</span><span class="tok-o">);</span>
    <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;/HTML&gt;&quot;</span><span class="tok-o">);</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para generar una página HTML con un servlet debemos seguir dos pasos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Indicar que el contenido que se va a enviar es HTML (mediante el método <code>setContentType()</code> de <code>HttpServletResponse</code>):</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setContentType</span><span class="tok-o">(</span><span class="tok-s">&quot;text/html&quot;</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Esta línea es una cabecera de respuesta, que veremos más adelante cómo utilizar. Hay que ponerla antes de obtener el <code>Writer</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Escribir en el flujo de salida el texto necesario para generar la página HTML. La línea que genera el DOCTYPE no es necesaria, aunque sí muy recomendada para que se sepa qué versión de HTML se está empleando.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_servlet_que_utiliza_parámetros_de_inicialización">Servlet que utiliza parámetros de inicialización</h6>
<div class="paragraph">
<p>Este otro ejemplo utiliza dos parámetros de inicialización externos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">ejemplos</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">java.io.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.http.*</span><span class="tok-o">;</span>

<span class="tok-nd">@WebServlet</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;ejemplo1_3&quot;</span><span class="tok-o">,</span> <span class="tok-n">urlPatterns</span><span class="tok-o">=</span><span class="tok-s">&quot;/ejemploservletInit&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">ClaseServletInit</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span> <span class="tok-o">{</span>

  <span class="tok-c1">// Mensaje que se va a mostrar en la pagina</span>
  <span class="tok-n">String</span> <span class="tok-n">mensaje</span> <span class="tok-o">=</span> <span class="tok-s">&quot;&quot;</span><span class="tok-o">;</span>
  <span class="tok-c1">// Numero de veces que se va a repetir el mensaje</span>
  <span class="tok-kt">int</span> <span class="tok-n">contador</span> <span class="tok-o">=</span> <span class="tok-mi">1</span><span class="tok-o">;</span>

  <span class="tok-c1">// Metodo de inicializacion</span>

  <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">init</span><span class="tok-o">(</span><span class="tok-n">ServletConfig</span> <span class="tok-n">conf</span><span class="tok-o">)</span>
                           <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span> <span class="tok-o">{</span>
    <span class="tok-kd">super</span><span class="tok-o">.</span><span class="tok-na">init</span><span class="tok-o">(</span><span class="tok-n">conf</span><span class="tok-o">);</span>	<span class="tok-c1">// MUY IMPORTANTE</span>

    <span class="tok-n">mensaje</span> <span class="tok-o">=</span> <span class="tok-n">conf</span><span class="tok-o">.</span><span class="tok-na">getInitParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;mensaje&quot;</span><span class="tok-o">);</span>
    <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">mensaje</span> <span class="tok-o">==</span> <span class="tok-kc">null</span><span class="tok-o">)</span>
      <span class="tok-n">mensaje</span> <span class="tok-o">=</span> <span class="tok-s">&quot;Hola&quot;</span><span class="tok-o">;</span>

    <span class="tok-k">try</span>
    <span class="tok-o">{</span>
      <span class="tok-n">contador</span> <span class="tok-o">=</span> <span class="tok-n">Integer</span><span class="tok-o">.</span><span class="tok-na">parseInt</span><span class="tok-o">(</span>
         <span class="tok-n">conf</span><span class="tok-o">.</span><span class="tok-na">getInitParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;contador&quot;</span><span class="tok-o">));</span>
    <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">NumberFormatException</span> <span class="tok-n">e</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-n">contador</span> <span class="tok-o">=</span> <span class="tok-mi">1</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
  <span class="tok-o">}</span>

  <span class="tok-c1">// Metodo para procesar una peticion GET</span>

  <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                    <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
               <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
    <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setContentType</span><span class="tok-o">(</span><span class="tok-s">&quot;text/html&quot;</span><span class="tok-o">);</span>
    <span class="tok-n">PrintWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>
    <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;!DOCTYPE HTML PUBLIC \&quot;&quot;</span><span class="tok-o">+</span>
                 <span class="tok-s">&quot;-//W3C//DTD HTML 4.0 &quot;</span> <span class="tok-o">+</span>
                 <span class="tok-s">&quot;Transitional//EN\&quot;&gt;&quot;</span><span class="tok-o">);</span>
    <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;HTML&gt;&quot;</span><span class="tok-o">);</span>
    <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;BODY&gt;&quot;</span><span class="tok-o">);</span>

    <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-kt">int</span> <span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-o">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-n">contador</span><span class="tok-o">;</span> <span class="tok-n">i</span><span class="tok-o">++)</span>
    <span class="tok-o">{</span>
      <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-n">mensaje</span><span class="tok-o">);</span>
      <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;BR&gt;&quot;</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;/BODY&gt;&quot;</span><span class="tok-o">);</span>
    <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;/HTML&gt;&quot;</span><span class="tok-o">);</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Se utiliza el método <code>init()</code> con un parámetro <code>ServletConfig</code> para poder tomar los parámetros externos. Es importante la llamada a <code>super</code> al principio del método.</p>
</li>
<li>
<p>Mediante el método <code>getInitParameter()</code> de <code>ServletConfig</code> obtenemos dos parámetros: <code>mensaje</code> y <code>contador</code>, que asignamos a las variables del mismo nombre. El primero indica el mensaje que se va a mostrar en la página, y el segundo el número de veces que se va a mostrar.</p>
</li>
<li>
<p>En <code>doGet()</code> hacemos uso de esos parámetros obtenidos, para mostrar el mensaje las veces indicadas.</p>
</li>
<li>
<p>Necesitaremos definir en el fichero <code>web.xml</code> los parámetros de inicio que el servlet va a leer.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_jsp">1.4.3. JSP</h4>
<div class="paragraph">
<p>JSP (<strong>JavaServer Pages</strong>) es una tecnología que permite
incluir código Java en páginas web. El denominado <em>contenedor
JSP</em> (que sería un componente del servidor web) es el
encargado de tomar la página, sustituir el código Java
que contiene por el resultado de su ejecución, y enviarla al
cliente. Así, se pueden dise&ntilde;ar fácilmente
páginas con partes fijas y partes variables. El siguiente es un
ejemplo muy sencillo de página JSP:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="jsp"><span class="tok-cp">&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.0 Transitional//EN&quot;&gt;</span>
<span class="tok-nt">&lt;html&gt;</span>
<span class="tok-nt">&lt;head&gt;</span>
<span class="tok-nt">&lt;title&gt;</span>Mi primera página JSP
<span class="tok-nt">&lt;/head&gt;</span>
<span class="tok-nt">&lt;body&gt;</span>
<span class="tok-nt">&lt;h1&gt;</span> Hoy es:
<span class="tok-k">&lt;%=</span> <span class="tok-k">new</span> <span class="tok-n">java</span><span class="tok-o">.</span><span class="tok-na">util</span><span class="tok-o">.</span><span class="tok-na">Date</span><span class="tok-o">()</span> <span class="tok-k">%&gt;</span>
<span class="tok-nt">&lt;/h1&gt;</span>
<span class="tok-nt">&lt;/body&gt;</span>
<span class="tok-nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para ejecutar la página basta con colocarla en una
aplicación web (por ejemplo, en WildFly, dentro de <code>webapps/ROOT</code>).
No es necesario que sea en un directorio específico como ocurre
con los servlets, sino que puede ir en cualquier directorio en el que
se colocaría normalmente un HTML.</p>
</div>
<div class="paragraph">
<p>Aunque JSP y servlets parecen a primera vista tecnologías
distintas, en realidad el servidor web traduce internamente el JSP a un
servlet, lo compila y finalmente lo ejecuta cada vez que el cliente
solicita la página JSP. Por ello, en principio, JSPs y servlets
ofrecen la misma funcionalidad, aunque sus características los
hacen apropiados para distinto tipo de tareas. Los JSP son mejores para
generar páginas con gran parte de contenido estático. Un
servlet que realice la misma función debe incluir gran cantidad
de sentencias del tipo <code>out.println()</code> para producir el
HTML. Por el contrario, los servlets son mejores en tareas que generen
poca salida, datos binarios o páginas con gran parte de
contenido variable. En proyectos más complejos, lo recomendable
es combinar ambas tecnologías: los servlets para el
procesamiento de información y los JSP para presentar los datos
al cliente.</p>
</div>
<div class="sect4">
<h5 id="_traducción_de_los_jsp_a_servlets">Traducción de los JSP a servlets</h5>
<div class="paragraph">
<p>Como se ha comentado, la primera vez que se solicita una
página JSP, el servidor genera el servlet equivalente, lo
compila y lo ejecuta. Para las siguientes solicitudes, solo es
necesario ejecutar el código compilado. El servlet generado de
manera automática tiene un método <code>_jspService</code>
que es el equivalente al <code>service</code> de los servlets
"generados manualmente". En este método es donde se genera el
código HTML, mediante instrucciones <code>println</code> y
donde se ejecuta el código Java insertado en la página.
Por ejemplo, la página <code>primera.jsp</code> podría generar
un servlet con estructura similar al siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">_jspService</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                        <span class="tok-n">HttpServletResponse</span>  <span class="tok-n">response</span><span class="tok-o">)</span>
                        <span class="tok-kd">throws</span> <span class="tok-n">java</span><span class="tok-o">.</span><span class="tok-na">io</span><span class="tok-o">.</span><span class="tok-na">IOException</span><span class="tok-o">,</span> <span class="tok-n">ServletException</span> <span class="tok-o">{</span>
  <span class="tok-n">JspWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-kc">null</span><span class="tok-o">;</span>
  <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setContentType</span><span class="tok-o">(</span><span class="tok-s">&quot;text/html;ISO-8859-1&quot;</span><span class="tok-o">);</span>
  <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;!DOCTYPE HTML PUBLIC \&quot;-//W3C//DTD HTML 4.0</span>
<span class="tok-s">                Transitional//EN\&quot;&gt;&quot;</span><span class="tok-o">);</span>
  <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;html&gt;&quot;</span><span class="tok-o">);</span>
  <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;head&gt;&quot;</span><span class="tok-o">);</span>
  <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;title&gt;Mi primera pagina JSP&quot;</span><span class="tok-o">);</span>
  <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/head&gt;&quot;</span><span class="tok-o">);</span>
  <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;body&gt;&quot;</span><span class="tok-o">);</span>
  <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">print</span><span class="tok-o">(</span><span class="tok-s">&quot;Hoy es &quot;</span><span class="tok-o">);</span>
  <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-n">java</span><span class="tok-o">.</span><span class="tok-na">util</span><span class="tok-o">.</span><span class="tok-na">Date</span><span class="tok-o">());</span>
  <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/body&gt;&quot;</span><span class="tok-o">);</span>
  <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/html&gt;&quot;</span><span class="tok-o">);</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El directorio donde se coloca el servlet generado, así como su
nombre, dependen del servidor de aplicaciones.</p>
</div>
</div>
<div class="sect4">
<h5 id="_inserción_de_código_en_páginas_jsp">Inserción de código en páginas JSP</h5>
<div class="paragraph">
<p>Hay tres formas de insertar código Java en una página
JSP:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Expresiones</strong> de la forma <code>&lt;%= expresión %&gt;</code>: en este caso, la expresión se evalúa, su
resultado se convierte a <code>String</code> y se inserta en la
salida.</p>
</li>
<li>
<p><strong>Scriptlets</strong> de la forma <code>&lt;% código %&gt;</code> : el código se ejecuta dentro del método <code>_jspService</code>
del servlet generado.</p>
</li>
<li>
<p><strong>Declaraciones</strong> de la forma <code>&lt;%! código %&gt;</code>: se insertan en el cuerpo del servlet generado, fuera de
sus métodos.</p>
</li>
</ul>
</div>
<div class="sect5">
<h6 id="_expresiones">Expresiones</h6>
<div class="paragraph">
<p>Como se ha visto, se evalúan, su resultado se convierte a un <code>String</code>
y se escriben en la salida (el objeto predefinido <code>out</code>).
La forma de traducir una expresión a código de servlet es
imprimiéndola en <code>out</code> (mediante una sentencia <code>out.write(<em>expresion</em>)</code>)
o similar.</p>
</div>
</div>
<div class="sect5">
<h6 id="__em_scriptlets_em"><em>Scriptlets</em></h6>
<div class="paragraph">
<p>Permiten ejecutar código arbitrario, cuyo resultado no es
necesario enviar a la salida. Si desde un <em>scriptlet</em> se desea
escribir algo en ésta, bastará con utilizar el objeto
predefinido <code>out</code>. Un uso común de los <em>scriptlets</em>
es hacer que ciertas partes de código HTML aparezcan o no en
función de una condición. Por ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="jsp"><span class="tok-k">&lt;%</span>
  <span class="tok-n">java</span><span class="tok-o">.</span><span class="tok-na">util</span><span class="tok-o">.</span><span class="tok-na">Calendar</span> <span class="tok-n">ahora</span> <span class="tok-o">=</span> <span class="tok-n">java</span><span class="tok-o">.</span><span class="tok-na">util</span><span class="tok-o">.</span><span class="tok-na">Calendar</span><span class="tok-o">.</span><span class="tok-na">getInstance</span><span class="tok-o">();</span>
  <span class="tok-kt">int</span> <span class="tok-n">hora</span> <span class="tok-o">=</span> <span class="tok-n">ahora</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-n">java</span><span class="tok-o">.</span><span class="tok-na">util</span><span class="tok-o">.</span><span class="tok-na">Calendar</span><span class="tok-o">.</span><span class="tok-na">HOUR_OF_DAY</span><span class="tok-o">);</span>
<span class="tok-k">%&gt;</span>
<span class="tok-nt">&lt;b&gt;</span> Hola mundo, <span class="tok-nt">&lt;i&gt;</span>
<span class="tok-k">&lt;%</span> <span class="tok-k">if</span> <span class="tok-o">((</span><span class="tok-n">hora</span><span class="tok-o">&gt;</span><span class="tok-mi">20</span><span class="tok-o">)||(</span><span class="tok-n">hora</span><span class="tok-o">&lt;</span><span class="tok-mi">6</span><span class="tok-o">))</span> <span class="tok-o">{</span> <span class="tok-k">%&gt;</span>
     buenas noches
<span class="tok-k">&lt;%</span> <span class="tok-o">}</span>
   <span class="tok-k">else</span> <span class="tok-nf">if</span> <span class="tok-o">((</span><span class="tok-n">hora</span><span class="tok-o">&gt;=</span><span class="tok-mi">6</span><span class="tok-o">)&amp;&amp;(</span><span class="tok-n">hora</span><span class="tok-o">&lt;=</span><span class="tok-mi">12</span><span class="tok-o">))</span> <span class="tok-o">{</span> <span class="tok-k">%&gt;</span>
          buenos días
<span class="tok-k">&lt;%</span>      <span class="tok-o">}</span>
	<span class="tok-k">else</span> <span class="tok-o">{</span> <span class="tok-k">%&gt;</span>
          buenas tardes
<span class="tok-k">&lt;%</span>      <span class="tok-o">}</span> <span class="tok-k">%&gt;</span>
<span class="tok-nt">&lt;/i&gt;</span> <span class="tok-nt">&lt;/b&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_declaraciones">Declaraciones</h6>
<div class="paragraph">
<p>Permiten definir variables o métodos que se insertarán
dentro del cuerpo del servlet generado. Esto da la posibilidad de
sobreescribir los métodos <code>jspInit</code> y <code>jspDestroy</code>
que son el equivalente en JSP del <code>init</code> y <code>destroy</code>
de los servlets. Las variables declaradas conservarán su valor
entre sucesivas llamadas a la página, ya que son variables
miembro del servlet y no locales al método <code>jspService</code>.
Esto nos permite, por ejemplo, crear un contador de accesos a la
página:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="jsp"><span class="tok-k">&lt;%!</span> <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">accesos</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-o">;</span> <span class="tok-k">%&gt;</span>
<span class="tok-nt">&lt;h1&gt;</span> Visitas: <span class="tok-k">&lt;%=</span> <span class="tok-o">++</span><span class="tok-n">accesos</span> <span class="tok-k">%&gt;</span> <span class="tok-nt">&lt;/h1&gt;</span></code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios">1.5. Ejercicios</h3>
<div class="paragraph">
<p>Antes de empezar a crear los proyectos, debes descargarte el repositorio git <code>java_ua/cweb-expertojava</code>
en el que vas a crear los proyectos del módulo. El repositorio remoto contiene las plantillas que vamos a usar a lo largo del módulo.</p>
</div>
<div class="paragraph">
<p>En primer lugar deberemos acceder a dicho repositorio en <em>bitbucket</em> y realizar un <em>Fork</em> en nuestra cuenta personal.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="Images/bitbucket-fork.png" alt="Realizar un Fork en bitbucket" width="33%">
</div>
</div>
<div class="paragraph">
<p>De esta forma tendremos una copia propia con permisos de escritura. Una vez contamos con nuestra copia podremos realizar un <em>Clone</em> en nuestra máquina. En primer lugar consultamos en <em>bitbucket</em> el comando necesario para hacer el <em>Clone</em>:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="Images/bitbucket-clone.png" alt="Dirección para clonar el repositorio de bitbucket" width="33%">
</div>
</div>
<div class="paragraph">
<p>Podemos copiar el comando y pegarlo en un terminal para clonar el repositorio en nuestra máquina:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span class="tok-nv">$ </span>git clone https://bitbucket.org/&lt;alumno&gt;/cweb-expertojava</code></pre>
</div>
</div>
<div class="paragraph">
<p>De esta forma se crea en nuestro ordenador el directorio <code>cweb-expertojava</code> y se descarga en él una plantilla inicial de los proyectos del módulo y un fichero <code>.gitignore</code>. A partir de este momento se puede trabajar con dichos proyectos y realizar <em>Commit</em> y <em>Push</em> cuando sea oportuno:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span class="tok-nv">$ </span><span class="tok-nb">cd </span>cweb-expertojava
<span class="tok-nv">$ </span>git add .
<span class="tok-nv">$ </span>git commit -a -m <span class="tok-s2">&quot;Mensaje de commit&quot;</span>
<span class="tok-nv">$ </span>git push origin master</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_aplicación_web_en_wildfly_0_5_puntos">1.5.1. Aplicación web en WildFly (0.5 puntos)</h4>
<div class="paragraph">
<p>Vamos a probar el servidor de aplicaciones WildFly y a subir recursos estáticos a él para comprobar que funciona.</p>
</div>
<div class="paragraph">
<p><em>a)</em> Comenzaremos poniendo en marcha el servidor entrando en el directorio <code>$WILDFLY_HOME/bin</code> y ejecutando el comando:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span class="tok-nv">$ </span>./standalone.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>Comprobar que WildFly ha arrancado accediendo a <code><a href="http://localhost:8080/" class="bare">http://localhost:8080/</a></code> desde cualquier navegador. Debería aparecer la página principal del servidor.</p>
</div>
<div class="paragraph">
<p><em>b)</em> Vamos a crear nuestra propia aplicación web y desplegarla en WildFly. En el directorio <code>cweb-comentarios</code> de las plantillas de la sesión hay una sencilla aplicación web que permite mantener una página y que los visitantes puedan añadir comentarios. Vamos a empaquetar y desplegar la aplicación en un fichero <em>war</em> y desplegarla.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Empaquetamiento en .war</strong>. Observad la estructura de directorios que cuelga del directorio
<code>comentarios</code>. Podemos empaquetar la aplicación mediante la herramienta <code>jar</code> incluída
en el JDK, como se especifica en los apuntes:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">jar cMvf cweb-comentarios.war *</code></pre>
</div>
</div>
<div class="paragraph">
<p>La operación anterior hay que hacerla <strong>desde dentro del directorio <code>cweb-comentarios</code></strong>, es decir, el <code>.war</code> creado no debe contener la carpeta "cweb-comentarios" propiamente dicha, sino lo que contiene ésta.</p>
</div>
</li>
<li>
<p><strong>Despliegue manual en WildFly</strong>. Para desplegar el .war manualmente basta con dejarlo en la carpeta <code>$WILDFLY_HOME/standalone/deployments</code>. Observad que transcurridos unos segundos el <code>.war</code> se desplegará de forma automática. Para probar la aplicación abre un navegador y accede a la URL:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>http://localhost:8080/cweb-comentarios/comentarios.jsp</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_hola_mundo_con_intellij_0_5_puntos">1.5.2. Hola mundo con IntelliJ (0.5 puntos)</h4>
<div class="paragraph">
<p>Vamos a crear y desplegar una aplicación <em>Hola mundo</em> mediante IntelliJ.</p>
</div>
<div class="paragraph">
<p><em>a)</em> Configuramos el servidor WildFly en IntelliJ.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Crear una instancia del servidor WildFly:</strong> Con la opción <em>File &gt; Settings … &gt; Application Servers</em> crearemos una nueva instancia de WildFly dentro de IntelliJ. En el cuadro deplegable para añadir un servidor simplemente tenemos que asegurarnos de elegir <em>JBoss 8.1.0 Final &gt; Local</em>, e indicar la ruta donde está instalado (<code>/usr/local/wildfly</code>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>b)</em> <strong>Crearemos un proyecto Maven</strong> de tipo <em>webapp-javaee7</em> desde IntelliJ.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Creamos el proyecto con el arquetipo <code>webapp-javaee7</code> (deberemos añadir el arquetipo a la lista si es la primera vez que lo utilizamos).</p>
</li>
<li>
<p>Como <em>GroupId</em> utilizaremos <code>org.expertojava.cweb</code>.</p>
</li>
<li>
<p>Como <em>ArtifactId</em> introduciremos: <code>cweb-hola</code>. Utilizaremos este mismo nombre posteriormente como nombre del proyecto IntelliJ.</p>
</li>
<li>
<p>Dejamos la versión como <code>1.0-SNAPSHOT</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>c)</em> <strong>Desplegamos el proyecto</strong> que acabamos de crear en WildFly.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Introducimos el elemento <code>finalName</code> en el fichero <code>pom.xml</code> para que la aplicación se despliegue en un contexto <code>cweb-hola</code>.</p>
</li>
<li>
<p>Creamos un perfil de ejecución que utilice el servidor configurado en el primer paso (<em>Run &gt; Edit Configurations &#8230;&#8203;</em>).</p>
</li>
<li>
<p>Añadimos al perfil de ejecución el artefacto de tipo <code>war</code> que tenemos creado por defecto (pestaña <em>Deployments</em>).</p>
</li>
<li>
<p>Lanzamos el despliegue. Veremos la página de prueba que ha creado como plantilla.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>d)</em> <strong>Añadimos</strong> desde IntelliJ un fichero <code>web.xml</code> al proyecto.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Entramos en <em>File &gt; Project Structure &#8230;&#8203; &gt; Facets</em>.</p>
</li>
<li>
<p>Seleccionamos el <em>facet</em> <em>Web</em> y añadimos un descriptor de despliegue.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>e)</em> <strong>Crear un nuevo servlet</strong> dentro del proyecto, en un
  paquete <code>org.expertojava.cweb.hola</code>, con nombre
  <code>HolaMundoServlet</code>. Mapearemos el servlet a la dirección
  <code>/HolaMundoServlet</code> utilizando anotaciones.</p>
</div>
<div class="paragraph">
<p><em>f)</em> <strong>Introducir</strong> en el método <code>doGet</code> del servlet
  el código para que muestre como salida el texto <code>"Hola Mundo"</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">PrintWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>
<span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;Hola Mundo&quot;</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>g)</em> <strong>Ejecutar la aplicación web</strong> en WildFly y comprobar que el servlet funciona correctamente, accediendo a la dirección a la que está mapeado.</p>
</div>
<div class="paragraph">
<p><em>h)</em> Vamos a hacer que el <em>servlet</em> que hemos añadido se muestre de forma automática como <strong>página principal</strong> de nuestra aplicación web. En el <code>web.xml</code> hay una sección llamada <code>welcome-file-list</code> que lista las páginas que el servidor debe buscar cuando se llame a la aplicación sin especificar la página a mostrar. Indicar únicamente <code>/HolaMundoServlet</code> en esta lista y comprobar que funciona adecuadamente, es decir que al llamar a <code><a href="http://localhost:8080/cweb-hola" class="bare">http://localhost:8080/cweb-hola</a></code> aparece dicho <em>servlet</em>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_servlet_que_muestra_la_fecha_y_hora_actuales_0_5_puntos">1.5.3. Servlet que muestra la fecha y hora actuales (0.5 puntos)</h4>
<div class="paragraph">
<p>Completar el servlet <code>org.expertojava.cweb.ejercicios.FechaServlet</code> de la aplicación <code>cweb-servlets</code> para que, tanto por GET como por POST, muestre una página HTML con la fecha y hora actuales en una cabecera <code>&lt;h3&gt;</code>, y en el <code>&lt;title&gt;</code> de la página. Para ello podéis utilizar la clase <code>java.util.Date</code>, y sacar por la salida del servlet la hora en formato cadena:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span><span class="tok-o">(...)</span> <span class="tok-kd">throws</span> <span class="tok-o">...</span>
<span class="tok-o">{</span>
  <span class="tok-n">String</span> <span class="tok-n">fecha</span> <span class="tok-o">=</span> <span class="tok-s">&quot;&quot;</span> <span class="tok-o">+</span> <span class="tok-k">new</span> <span class="tok-n">java</span><span class="tok-o">.</span><span class="tok-na">util</span><span class="tok-o">.</span><span class="tok-na">Date</span><span class="tok-o">();</span>
  <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setContentType</span><span class="tok-o">(...);</span>
  <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>
  <span class="tok-o">...</span> <span class="tok-c1">// sacar la fecha tanto en el TITLE como en una cabecera H3</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Una vez hecho, configurad el descriptor de la aplicación para que el servlet se mapee a la dirección <code>/FechaHora</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_servlet_que_muestra_parámetros_de_inicio_0_5_puntos">1.5.4. Servlet que muestra parámetros de inicio (0.5 puntos)</h4>
<div class="paragraph">
<p>Crear un servlet <code>org.expertojava.cweb.ejercicios.ParamIniServlet</code> en la aplicación <code>cweb-servlets</code> que muestre en una tabla el nombre y el valor de todos los parámetros de inicio que se tengan configurados para ese servlet en el fichero descriptor (<code>web.xml</code>). La tabla tendrá dos columnas: una con el nombre del parámetro y otra con el valor.</p>
</div>
<div class="paragraph">
<p>Una vez hecho, probadlo añadiéndole en el fichero <code>web.xml</code> 3 parámetros de inicio con nombres <code>param1</code>, <code>param2</code>
  y <code>param3</code> y valores <code>val1</code>, <code>val2</code> y <code>val3</code>. Para ello deberéis dar un nombre al servlet (el nombre es arbitrario).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span><span class="tok-o">(...)</span> <span class="tok-kd">throws</span><span class="tok-o">...</span>
<span class="tok-o">{</span>
    <span class="tok-n">Enumeration</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-o">&gt;</span> <span class="tok-n">nombres</span> <span class="tok-o">=</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">getInitParameterNames</span><span class="tok-o">();</span>
    <span class="tok-k">while</span> <span class="tok-o">(</span><span class="tok-n">nombres</span><span class="tok-o">.</span><span class="tok-na">hasMoreElements</span><span class="tok-o">())</span> <span class="tok-o">{</span>
        <span class="tok-n">String</span> <span class="tok-n">nombre</span> <span class="tok-o">=</span> <span class="tok-n">nombres</span><span class="tok-o">.</span><span class="tok-na">nextElement</span><span class="tok-o">();</span>
        <span class="tok-n">String</span> <span class="tok-n">valor</span> <span class="tok-o">=</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">getInitParameter</span><span class="tok-o">(</span><span class="tok-n">nombre</span><span class="tok-o">);</span>
        <span class="tok-o">...</span> <span class="tok-c1">// Mostrar nombre y valor en una tabla</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configurar_em_logging_em_en_servlets_0_5_puntos">1.5.5. Configurar <em>logging</em> en servlets (0.5 puntos)</h4>
<div class="paragraph">
<p>En la aplicación <code>cweb-servlets</code> tenemos dos servlets, <code>ServletLog4J1</code> y <code>ServletLog4J2</code> en el paquete
  <code>org.expertojava.cweb.ejercicios</code>. Queremos configurar las librerías de logging para poder ver los mensajes que emiten. Se pide:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Comprobar que las librerías de logging de <em>commons-logging</em> y <em>log4j</em> están correctamente configuradas como dependencias en el <code>pom.xml</code>.</p>
</li>
<li>
<p>Comprobar que los ficheros de configuración <code>commons-logging.properties</code> y
<code>log4j.properties</code> están en la carpeta de fuentes llamada <code>resources</code>. Estos ficheros están configurados para que volcar los mensajes de ambos servlets (de tipo INFO o superior) a un fichero <code>/home/expertojava/errores.log</code>, con el formato:</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>dd/MM/aaaa hh:mm:ss - prioridad - texto del mensaje - salto de línea</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p>El servlet <code>ServletLog4J2</code> no saca mensajes de <em>log</em>. Añadid las líneas de código necesarias para que saque un mensaje de tipo INFO
cuando empiece a procesar la petición (al inicio del <code>doGet</code>) y otro cuando la termine, anotando el tiempo transcurrido entre ambos
mensajes (puede serte de utilidad el método <code>System.currentTimeMillis()</code> de Java).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Probad a llamar a los servlets <code>ServletLog4J1</code> o <code>ServletLog4J2</code> alguna vez, y que generen logs en el fichero <code>errores.log</code>
  que viene por defecto en el fichero de configuración.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion02">2. Procesamiento de peticiones</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Un servlet maneja peticiones de los clientes a través de su método <strong><code>service</code></strong>. Con él se pueden manejar peticiones HTTP (entre otras), reenviando las peticiones a los métodos apropiados que las manejan. Por ejemplo, una petición GET puede redirigirse a un método <code>doGet</code>. Veremos ahora los elementos principales que intervienen en una interacción vía HTTP.</p>
</div>
<div class="sect2">
<h3 id="_petición_y_respuesta_http">2.1. Petición y respuesta HTTP</h3>
<div class="sect3">
<h4 id="_peticiones_del_cliente">2.1.1. Peticiones del cliente</h4>
<div class="paragraph">
<p>En el protocolo HTTP el cliente realiza una <strong>petición</strong> que se descompone en:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Un comando HTTP, seguido de una dirección de documento o URI (<em>Uniform Resource Identifier</em>), y un número de versión HTTP, de forma que se tiene una línea con el formato:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>Comando    URI    Protocolo</code></pre>
</div>
</div>
<div class="paragraph">
<p>Por ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>GET   /index.html  HTTP/1.1</code></pre>
</div>
</div>
</li>
<li>
<p>Tras la petición, el cliente puede enviar información adicional de <strong>cabeceras</strong> (<em>headers</em>) con las que se da al servidor más información sobre la petición (tipo de software que ejecuta el cliente, tipo de contenido (<code>content-type</code>) que entiende el cliente, etc). Esta información puede utilizarla el servidor para generar la respuesta apropiada. Las cabeceras se envían una por línea, donde cada una tiene el formato:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>Clave: Valor</code></pre>
</div>
</div>
<div class="paragraph">
<p>Por ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="http"><span class="tok-err">Accept-Encoding: gzip, deflate</span>
<span class="tok-err">User-Agent: Mozilla/4.0 (compatible;MSIE5.0;Windows 98)</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Tras las cabeceras, el cliente envía una línea en blanco (<code>\r\n\r\n</code>) para indicar el final de la sección de cabeceras.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Finalmente, de forma opcional, se pueden enviar <strong>datos adicionales</strong> si el comando HTTP solicitado lo requiere (por ejemplo, el método POST que veremos a continuación).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>METODO GET</strong></p>
</div>
<div class="paragraph">
<p>El comando <code>GET</code> permitía al principio solicitar al servidor un documento estático, existente en su espacio de direcciones. Luego se vio que esto no era suficiente, y se introdujo la posibilidad de solicitar búsquedas al servidor, de forma que el documento no tuviera que ser necesariamente estático, sino que la búsqueda estuviera condicionada por unos determinados parámetros. Así, el comando <code>GET</code> tiene la forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>GET   direccion ? parametros   version HTTP</code></pre>
</div>
</div>
<div class="paragraph">
<p>Por ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>GET   /cgi-bin/pagina.cgi?IDIOMA=C&amp;MODELO=a+b  HTTP/1.1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Los parámetros se indican con pares <em>nombre=valor</em>, separados por <code>'&amp;'</code>, y reciben el nombre de <strong>datos de formulario</strong>. El URI no puede contener espacios ni algunos caracteres, por lo que se utilizan códigos especiales, como el <code>+</code> para indicar espacio en blanco, u otros códigos <code>%XX</code> para representar otros caracteres. Uno de los trabajos más duros de los programas CGI es procesar esta cadena de parámetros para extraer la información necesaria.</p>
</div>
<div class="paragraph">
<p><strong>OTROS METODOS</strong></p>
</div>
<div class="paragraph">
<p>En la versión 1.1 de HTTP se definen otros métodos además de <code>GET</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>OPTIONS</code>: para consultar al servidor acerca de las funcionalidades que proporciona</p>
</li>
<li>
<p><code>HEAD</code>: el servidor responde de forma idéntica a un comando <code>GET</code>, pero no devuelve el cuerpo del documento respuesta, sólo las cabeceras. Suele emplearse para comprobar características del documento.</p>
</li>
<li>
<p><code>POST</code>: se emplea para enviar al servidor un bloque de datos en el cuerpo de la petición</p>
</li>
<li>
<p><code>PUT</code>: solicita que el cuerpo de la petición que envía se almacene en el espacio de direcciones del servidor, con el identificador URI solicitado (guarda un documento en el servidor)</p>
</li>
<li>
<p><code>DELETE</code>: solicita borrar un documento específico del servidor</p>
</li>
<li>
<p><code>TRACE</code>: se utiliza para seguir el camino de la petición por múltiples servidores y proxies (útil para depurar problemas de red).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>GET Y POST</strong></p>
</div>
<div class="paragraph">
<p>Los dos métodos más comúnmente usados son <code>GET</code> y <code>POST</code>. Veremos las diferencias entre uno y otro con un ejemplo:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Un ejemplo de petición <code>GET</code> es:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>GET  /dir/cargaPagina.php?id=21&amp;nombre=Pepe  HTTP/1.1
&lt;cabeceras&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Este ejemplo, convertido a petición <code>POST</code> es:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>POST  /dir/cargaPagina.php  HTTP/1.1
&lt;cabeceras&gt;

id=21&amp;nombre=Pepe</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Vemos que los parámetros se pasan en el cuerpo de la petición, fuera de la línea del comando.</p>
</div>
<div class="paragraph">
<p>Comúnmente existen 3 formas de enviar una petición <code>GET</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Teclear la petición directamente en la barra del navegador:</p>
<div class="paragraph">
<p><a href="http://www.xx.com/pag.html?id=123&amp;nombre=pepe" class="bare">http://www.xx.com/pag.html?id=123&amp;nombre=pepe</a></p>
</div>
</li>
<li>
<p>Colocar la petición en un enlace y pinchar el enlace para realizarla:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;a</span> <span class="tok-na">href=</span><span class="tok-s">&quot;http://www.xx.com/pag.html?id=123&amp;nombre=pepe&quot;</span><span class="tok-nt">&gt;</span>Pulsa Aqui<span class="tok-nt">&lt;/a&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Enviar la petición tras rellenar un formulario con <code>method="get"</code> (o sin <code>method</code>) con los dos parámetros a enviar:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;html&gt;</span>
<span class="tok-nt">&lt;body&gt;</span>
  <span class="tok-nt">&lt;form</span> <span class="tok-na">action=</span><span class="tok-s">&quot;http://www.xx.com/pag.html&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;id&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;123&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;nombre&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;pepe&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;submit&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;Enviar&quot;</span><span class="tok-nt">&gt;</span>
  <span class="tok-nt">&lt;/form&gt;</span>
<span class="tok-nt">&lt;/body&gt;</span>
<span class="tok-nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para enviar una petición POST, normalmente se utiliza un formulario con <code>method="post"</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;html&gt;</span>
<span class="tok-nt">&lt;body&gt;</span>
  <span class="tok-nt">&lt;form</span> <span class="tok-na">action=</span><span class="tok-s">&quot;http://www.xx.com/pag.html&quot;</span> <span class="tok-na">METHOD=</span><span class="tok-s">POST</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;id&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;123&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;nombre&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;pepe&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;submit&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;Enviar&quot;</span><span class="tok-nt">&gt;</span>
  <span class="tok-nt">&lt;/form&gt;</span>
<span class="tok-nt">&lt;/body&gt;</span>
<span class="tok-nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_respuestas_del_servidor">2.1.2. Respuestas del servidor</h4>
<div class="paragraph">
<p>Las respuestas del servidor también tienen tres partes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Una <strong>línea de estado</strong> con la versión del protocolo HTTP utilizado en el servidor, un código de estado y una breve descripción del mismo:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>HTTP/1.0  200  OK</code></pre>
</div>
</div>
</li>
<li>
<p>Información de <strong>cabeceras</strong>, donde se envía al cliente información sobre el servidor y sobre el documento solicitado. El formato de estas cabeceras es el mismo que el visto para las peticiones del cliente, terminando en una línea en blanco.</p>
</li>
<li>
<p>Finalmente, se envía el <strong>documento solicitado</strong>. Para marcar el final del mismo se envía también otra línea en blanco.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_cabeceras">2.1.3. Cabeceras</h4>
<div class="paragraph">
<p>Vamos a poder implementar programas que lean las cabeceras que envía un cliente (un navegador, por ejemplo) y que modifiquen el documento servido en función de dichas cabeceras (por ejemplo, enviar una página en función del idioma que se especifique). Por otra parte, podremos utilizar las cabeceras que envíe el servidor como respuesta para obligar al navegador a hacer determinadas acciones, como saltar a otra URL.
Veremos a continuación las cabeceras más comunes tanto en las peticiones de los clientes como en las respuestas de los servidores. La RFC donde se especifican estas cabeceras es la 2616.</p>
</div>
<div class="paragraph">
<p><strong>CABECERAS DE PETICION (HTTP/1.1)</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Accept</strong>: Tipos MIME que puede manejar el cliente</p>
</li>
<li>
<p><strong>Accept-Charset</strong>: Conjunto de caracteres que el cliente puede manejar</p>
</li>
<li>
<p><strong>Accept-Encoding</strong>: Define si el navegador puede aceptar datos codificados</p>
</li>
<li>
<p><strong>Accept-Language</strong>: Idiomas aceptados</p>
</li>
<li>
<p><strong>Authorization</strong>: Para identificarse cuando se accede a páginas protegidas</p>
</li>
<li>
<p><strong>Cache-Control</strong>: Opciones relacionadas con el servidor proxy. Esta cabecera se llamaba <em>Pragma</em> en HTTP 1.0</p>
</li>
<li>
<p><strong>Connection</strong>: Define si el cliente es capaz de realizar conexiones persistentes (<em>keep-alive</em>, valor por defecto), o no (<em>close</em>). Nueva en HTTP 1.1</p>
</li>
<li>
<p><strong>Content-Length</strong>: Longitud de los datos enviados. Aplicable a peticiones <code>POST</code></p>
</li>
<li>
<p><strong>Content-Type</strong>: Tipo MIME de los datos enviados. Aplicable a peticiones <code>POST</code></p>
</li>
<li>
<p><strong>Cookie</strong>: Para las cookies que se manejen</p>
</li>
<li>
<p><strong>From</strong>: Dirección de correo electrónico responsable de la petición</p>
</li>
<li>
<p><strong>Host</strong>: Unica cabecera requerida por HTTP 1.1. Indica el host y el puerto tal y como se especifica en la URL original.</p>
</li>
<li>
<p><strong>If-Modified-Since</strong>: El cliente sólo desea el documento si ha sido modificado después de la fecha indicada en esta cabecera.</p>
</li>
<li>
<p><strong>Referer</strong>: URL origen de la petición. Si estamos en la página 1 y pinchamos en un enlace a la página 2, la URL de la página 1 se incluye en esta cabecera cuando se realiza la petición de la página 2.</p>
</li>
<li>
<p><strong>User-Agent</strong>: Cliente que está realizando la petición (normalmente muestra datos del navegador, como nombre, etc).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>CABECERAS DE RESPUESTA</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Allow</strong>: Métodos disponibles (<code>GET</code>, <code>POST</code>, etc) a los que puede responder el recurso que se está solicitando</p>
</li>
<li>
<p><strong>Cache-Control</strong>: Dice al cliente en qué circunstancias puede hacer una caché del documento que está sirviendo:</p>
<div class="ulist">
<ul>
<li>
<p><code>public</code>: el documento puede almacenarse en una caché</p>
</li>
<li>
<p><code>private</code>: el documento es para un solo usuario y sólo puede almacenarse en una caché privada (no compartida)</p>
</li>
<li>
<p><code>no-cache</code>: el documento nunca debe ser almacenado en caché</p>
</li>
<li>
<p><code>no-store</code>: el documento no debe almacenarse en caché ni almacenarse localmente de forma temporal en el disco duro</p>
</li>
<li>
<p><code>must-revalidate</code>: el cliente debe revalidar la copia del documento con el servidor original, no con servidores proxy intermedios, cada vez que se use</p>
</li>
<li>
<p><code>max-age=xxx</code>: el documento debe considerarse caducado después de <em>xxx</em> segundos.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Esta cabecera se llamaba <code>Pragma</code> en HTTP 1.0</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Content-Encoding</strong>: Tipo de compresión (<em>gzip</em>, etc) en que se devuelve el documento solicitado</p>
</li>
<li>
<p><strong>Content-Language</strong>: Idioma en que está escrito el documento. En la RFC 1766 están los idiomas disponibles</p>
</li>
<li>
<p><strong>Content-Length</strong>: Número de bytes de la respuesta</p>
</li>
<li>
<p><strong>Content-MD5</strong>: Una forma de fijar el <em>checksum</em> (verificación de integridad) del documento enviado</p>
</li>
<li>
<p><strong>Content-Type</strong>: Tipo MIME de la respuesta</p>
</li>
<li>
<p><strong>Date</strong>: Hora y fecha, en formato GMT, en que la respuesta ha sido generada</p>
</li>
<li>
<p><strong>Expires</strong>: Hora y fecha, en formato GMT, en que la respuesta debe considerarse caducada</p>
</li>
<li>
<p><strong>Last-Modified</strong>: Fecha en que el documento servido se modificó por última vez. Con esto, el documento se sirve sólo si su <code>Last-Modified</code> es mayor que la fecha indicada en el <code>If-Modified-Since</code> de la cabecera del cliente.</p>
</li>
<li>
<p><strong>Location</strong>: Indica la nueva URL donde encontrar el documento. Debe usarse con un código de estado de tipo 300. El navegador se redirigirá automáticamente a la dirección indicada en esta cabecera.</p>
</li>
<li>
<p><strong>Refresh</strong>: Indica al cliente que debe recargar la página después de los segundos especificados. También puede indicarse la dirección de la página a cargar después de los segundos indicados:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>Refresh: 5; URL=http://www.unapagina.com</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Set-Cookie</strong>: Especifica una cookie asociada a la página</p>
</li>
<li>
<p><strong>WWW-Authenticate</strong>: Tipo de autorización y dominio que debería indicar el cliente en su cabecera <code>Authorization</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Para colocar estas cabeceras en un documento se tienen varios métodos, dependiendo de cómo estemos tratando las páginas (mediante servlets, HTML, etc). Por ejemplo, con HTML podemos enviar cabeceras mediante etiquetas <code>META</code> en la cabecera (<code>&lt;HEAD&gt;</code>) de la página HTML:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;META</span> <span class="tok-na">HTTP-EQUIV=</span><span class="tok-s">&quot;Cabecera&quot;</span> <span class="tok-na">CONTENT=</span><span class="tok-s">&quot;Valor&quot;</span><span class="tok-nt">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;META</span> <span class="tok-na">HTTP-EQUIV=</span><span class="tok-s">&quot;Location&quot;</span> <span class="tok-na">CONTENT=</span><span class="tok-s">&quot;http://www.unapagina.com&quot;</span><span class="tok-nt">&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_códigos_de_estado">2.1.4. Códigos de estado</h4>
<div class="paragraph">
<p>El código de estado que un servidor devuelve a un cliente en una petición indica el resultado de dicha petición. Se tiene una descripción completa de los mismos en el RFC 2616. Están agrupados en 5 categorías:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>100 - 199</strong>: códigos de información, indicando que el cliente debe responder con alguna otra acción.</p>
</li>
<li>
<p><strong>200 - 299</strong>: códigos de aceptación de petición. Por ejemplo:</p>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 16%;">
<col style="width: 33%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>200</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OK</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Todo está bien</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>204</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>No Content</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No hay documento nuevo</p></td>
</tr>
</tbody>
</table>
</li>
<li>
<p><strong>300 - 399</strong>: códigos de redirección. Indican que el documento solicitado ha sido movido a otra URL. Por ejemplo:</p>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 16%;">
<col style="width: 33%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>301</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Moved Permanently</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">El documento está en otro lugar, indicado en la cabecera <em>Location</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>302</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Found</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Como el anterior, pero la nueva URL es temporal, no permanente.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>304</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Not Modified</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">El documento pedido no ha sufrido cambios con respecto al actual (para cabeceras <code>If-Modified-Since</code>)</p></td>
</tr>
</tbody>
</table>
</li>
<li>
<p><strong>400 - 499</strong>: códigos de error del cliente. Por ejemplo:</p>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 16%;">
<col style="width: 33%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>400</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Bad Request</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mala sintaxis en la petición</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>401</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Unauthorized</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">El cliente no tiene permiso para acceder a la página. Se debería devolver una cabecera <code>WWW-Authenticate</code> para que el usuario introduzca login y password</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>403</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Forbidden</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">El recurso no está disponible</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>404</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Not Found</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No se pudo encontrar el recurso</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>408</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Request Timeout</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">El cliente tarda demasiado en enviar la petición</p></td>
</tr>
</tbody>
</table>
</li>
<li>
<p><strong>500 - 599</strong>: códigos de error del servidor. Por ejemplo:</p>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 16%;">
<col style="width: 33%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>500</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Internal Server Error</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Error en el servidor</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>501</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Not Implemented</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">El servidor no soporta la petición realizada</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>504</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Gateway Timeout</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Usado por servidores que actúan como proxies o gateways, indica que el servidor no obtuvo una respuesta a tiempo de un servidor remoto</p></td>
</tr>
</tbody>
</table>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_peticiones_httpservletrequest">2.1.5. Peticiones: HttpServletRequest</h4>
<div class="paragraph">
<p>Como hemos visto anteriormente, los objetos <strong><code>ServletRequest</code></strong> se emplean para obtener información sobre la petición de los clientes. Más en concreto, el subtipo <code>HttpServletRequest</code> se utiliza en las peticiones HTTP. Proporciona acceso a los datos de las cabeceras HTTP, cookies, parámetros pasados por el usuario, etc, sin tener que parsear nosotros a mano los datos de formulario de la petición.
La clase dispone de muchos métodos, pero destacamos los siguientes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Para <strong>obtener los valores de los parámetros</strong> pasados por el cliente, se tienen los métodos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">Enumeration</span> <span class="tok-nf">getParameterNames</span><span class="tok-o">()</span>
<span class="tok-n">String</span>      <span class="tok-nf">getParameter</span> <span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">)</span>
<span class="tok-n">String</span><span class="tok-o">[]</span>    <span class="tok-nf">getParameterValues</span> <span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Con <strong><code>getParameterNames()</code></strong> se obtiene una lista con los nombres de los parámetros enviados por el cliente. Con <strong><code>getParameter()</code></strong> se obtiene el valor del parámetro de nombre <code>nombre</code>. Si un parámetro tiene varios valores (por ejemplo, si tenemos un array de cuadros de texto con el mismo nombre en un formulario), se pueden obtener todos separados con <strong><code>getParameterValues()</code></strong>. Los nombres de los parámetros normalmente sí distinguen mayúsculas de minúsculas, deberemos tener cuidado al indicarlos.</p>
</div>
</li>
<li>
<p>Para <strong>obtener la cadena de una petición GET</strong>, se tiene el método:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">String</span> <span class="tok-nf">getQueryString</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>que devuelve todos los parámetros de la petición en una cadena, que deberemos parsear nosotros como nos convenga.</p>
</div>
</li>
<li>
<p>Para <strong>obtener datos de peticiones POST, PUT o DELETE</strong>, se tienen los métodos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">BufferedReader</span>     <span class="tok-nf">getReader</span><span class="tok-o">()</span>
<span class="tok-n">ServletInputStream</span> <span class="tok-nf">getInputStream</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Con <strong><code>getReader()</code></strong> se obtiene un <code>BufferedReader</code> para peticiones donde esperemos recibir texto. Si esperamos recibir datos binarios, se debe emplear <strong><code>getInputStream()</code></strong>. Si lo que esperamos recibir son parámetros por POST igual que se haría por GET, es mejor utilizar los métodos <code>getParameterXXXX(&#8230;&#8203;)</code> vistos antes.</p>
</div>
</li>
<li>
<p>Para <strong>obtener información sobre la línea de petición</strong>, se tienen los métodos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">String</span> <span class="tok-nf">getMethod</span><span class="tok-o">()</span>
<span class="tok-n">String</span> <span class="tok-nf">getRequestURI</span><span class="tok-o">()</span>
<span class="tok-n">String</span> <span class="tok-nf">getProtocol</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Con <strong><code>getMethod()</code></strong> obtenemos el comando HTTP solicitado (GET, POST, PUT, etc), con <strong><code>getRequestURI()</code></strong> obtenemos la parte de la URL de petición que está detrás del <code>host</code> y el puerto, pero antes de los datos del formulario. Con <strong><code>getProtocol()</code></strong> obtenemos el protocolo empleado (<code>HTTP/1.1</code>, <code>HTTP/1.0</code>, etc).</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_respuestas_httpservletresponse">2.1.6. Respuestas: HttpServletResponse</h4>
<div class="paragraph">
<p>Los objetos <code>ServletResponse</code> se emplean para enviar el resultado de procesar una petición a un cliente. El subtipo <code>HttpServletResponse</code> se utiliza en las peticiones HTTP. Proporciona acceso al canal de salida por donde enviar la respuesta al cliente.</p>
</div>
<div class="paragraph">
<p>La clase dispone de muchos métodos, pero destacamos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">Writer</span>              <span class="tok-nf">getWriter</span><span class="tok-o">()</span>
<span class="tok-n">ServletOutputStream</span> <span class="tok-nf">getOutputStream</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Con <strong><code>getWriter()</code></strong> se obtiene un <code>Writer</code> para enviar texto al cliente. Si queremos enviar datos binarios, se debe emplear <strong><code>getOutputStream()</code></strong>.
Si queremos especificar información de cabecera, debemos establecerla ANTES de obtener el <code>Writer</code> o el <code>ServletOutputStream</code>. Hemos visto en algún ejemplo el método <strong><code>setContentType()</code></strong> para indicar el tipo de contenido. Veremos las cabeceras con más detenimiento más adelante.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_procesamiento_de_peticiones_get_y_post">2.2. Procesamiento de peticiones GET y POST</h3>
<div class="paragraph">
<p>Como se ha visto anteriormente, el método <strong><code>doGet()</code></strong> se emplea para procesar peticiones GET. Para realizar nuestro propio procesamiento de petición, simplemente sobreescribimos este método en el servlet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                  <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
               <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
  <span class="tok-c1">// ... codigo para una peticion GET</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos utilizar los métodos del objeto <code>HttpServletRequest</code> vistos antes. Así podremos, entre otras cosas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Acceder a elementos de la petición, como valores de parámetros:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">String</span> <span class="tok-n">nombreUsuario</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;nombre&quot;</span><span class="tok-o">);</span></code></pre>
</div>
</div>
</li>
<li>
<p>Acceder a los parámetros en la cadena de la petición y procesarlos como queramos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">String</span> <span class="tok-n">query</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getQueryString</span><span class="tok-o">();</span>
<span class="tok-o">...</span></code></pre>
</div>
</div>
</li>
<li>
<p>Obtener un canal de entrada (<code>Reader</code> o <code>InputStream</code>) con que leer los datos de la petición:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">BufferedReader</span> <span class="tok-n">r</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getReader</span><span class="tok-o">();</span>
<span class="tok-o">...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Esta, sin embargo, no es una buena idea para tomar parámetros de peticiones u otras cosas. Se suele emplear sobre todo para transferencias de ficheros, pero hay que tener en cuenta que si obtenemos un canal de entrada, luego no podremos obtener parámetros u otros valores con métodos <code>getParameter()</code> y similares.</p>
</div>
</li>
<li>
<p>etc.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>También podemos utilizar los métodos del objeto <code>HttpServletResponse</code> para, entre otras cosas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Establecer valores de la cabecera (antes que cualquier otra acción sobre la respuesta):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setContentType</span><span class="tok-o">(</span><span class="tok-s">&quot;text/html&quot;</span><span class="tok-o">);</span></code></pre>
</div>
</div>
</li>
<li>
<p>Obtener el canal de salida por el que enviar la respuesta:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">PrintWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>
<span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;Enviando al cliente&quot;</span><span class="tok-o">);</span></code></pre>
</div>
</div>
</li>
<li>
<p>Redirigir a otra página:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">sendRedirect</span><span class="tok-o">(</span><span class="tok-s">&quot;http://localhost:8080/pag.html&quot;</span><span class="tok-o">);</span></code></pre>
</div>
</div>
</li>
<li>
<p>etc.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>De forma similar, el método <strong><code>doPost()</code></strong>, se emplea para procesar peticiones POST. Igual que antes, debemos sobreescribir este método para definir nuestro propio procesamiento de la petición:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">doPost</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                   <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
               <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
  <span class="tok-c1">// ... codigo para una peticion POST</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Las posibilidades de los parámetros <code>HttpServletRequest</code> y <code>HttpServletResponse</code> son las mismas que para GET. Normalmente muchos servlets definen el mismo código para uno y otro método (hacen que <code>doPost()</code> llame a <code>doGet()</code> y definen allí el código, o al revés), pero conviene tenerlos separados para poder tratar independientemente uno y otro tipo de peticiones si se quiere.</p>
</div>
<div class="sect3">
<h4 id="_procesamiento_secuencial_de_peticiones">2.2.1. Procesamiento secuencial de peticiones</h4>
<div class="paragraph">
<p>Los servlets pueden gestionar múltiples peticiones de clientes concurrentemente. <strong>Por cada petición se crea un hilo</strong> que se ejecuta sobre el código del servlet al que se ha accedido. Si existen varias peticiones concurrentes tendremos varios hilos ejecutándose sobre un mismo objeto servlet. Esto podría ocasionar problemas de concurrencia por ejemplo si estuviésemos utilizando variables de instancia de la clase del servlet. Por este motivo deberemos evitar esta práctica cuando implementemos servlets.</p>
</div>
<div class="paragraph">
<p>Pero puede suceder que en determinado momento necesitemos acceder a cierto recurso compartido, y no nos interese que varios clientes accedan a dicho recurso simultáneamente. Para solucionar este problema, podemos definir bloques de código <code>synchronized</code>, o bien hacer que el servlet sólo atienda una petición cada vez.</p>
</div>
<div class="paragraph">
<p>Para esto último lo único que hay que hacer es que el servlet, además de heredar de <code>HttpServlet</code>, implemente la interfaz <code>SingleThreadModel</code>. Esto no supone definir más métodos, simplemente añadimos el <code>implements</code> necesario al definir la clase Servlet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">MiServlet</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span>
                       <span class="tok-kd">implements</span> <span class="tok-n">SingleThreadModel</span> <span class="tok-o">{</span>
  <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Esta es una práctica que deberemos evitar siempre que sea posible, ya que genera un cuello de botella en nuestra aplicación y no siempre evita los problemas de concurrencia (por ejemplo si accedemos a recursos compartidos por varios servlets). Por este motivo este mecanismo ha quedado <em>desaprobado</em> y en su lugar se recomienda evitar el uso de variables de instancia en servlets, y sincronizar los bloques concretos de código que pudiesen provocar problemas de concurrencia.</p>
</div>
<div class="paragraph">
<p>Lo más importante es ser consciente de que varios hilos ejecutarán de forma concurrente el código de nuestros servlets y tomar las precauciones oportunas.</p>
</div>
</div>
<div class="sect3">
<h4 id="_manejo_de_formularios">2.2.2. Manejo de formularios</h4>
<div class="paragraph">
<p>Los datos que se envían como parámetros en una petición (tras el interrogante si es una petición GET, o por otro lado si es POST) se llaman <strong>datos de formulario</strong>. Una vez enviados estos datos como petición, ¿cómo se extraen en el servidor?</p>
</div>
<div class="paragraph">
<p>Si trabajáramos con CGI, los datos se tomarían de forma distinta si fuese una petición GET o una POST. Para una GET, por ejemplo, tendríamos que tomar la cadena tras la interrogación, y parsearla convenientemente, separando los bloques entre <code>&amp;</code>, y luego separando el nombre del parámetro de su valor a partir del <code>=</code>. También hay que descodificar los valores: los alfanuméricos no cambian, pero los espacios se han convertido previamente en <code>+</code>, y otros caracteres se convierten en <code>%XX%</code>.</p>
</div>
<div class="paragraph">
<p>Con servlets todo este análisis se realiza de forma automática. La clase <code>HttpServletRequest</code> dispone de métodos que devuelven la información que nos interesa ya procesada, e independientemente de si es una petición GET o POST. Hemos visto antes los métodos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">Enumeration</span> <span class="tok-nf">getParameterNames</span><span class="tok-o">()</span>
<span class="tok-n">String</span>      <span class="tok-nf">getParameter</span> <span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">)</span>
<span class="tok-n">String</span><span class="tok-o">[]</span>    <span class="tok-nf">getParameterValues</span> <span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">)</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ejemplo">2.2.3. Ejemplo</h4>
<div class="paragraph">
<p>Veamos un ejemplo, supongamos que tenemos este formulario:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;html&gt;</span>
<span class="tok-nt">&lt;body&gt;</span>
<span class="tok-nt">&lt;form</span> <span class="tok-na">action=</span><span class="tok-s">&quot;/appforms/servlet/ejemplos.ServletForm&quot;</span><span class="tok-nt">&gt;</span>
  Valor 1: <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;texto1&quot;</span><span class="tok-nt">&gt;</span>
  <span class="tok-nt">&lt;br&gt;</span>
  Valor2:
  <span class="tok-nt">&lt;select</span> <span class="tok-na">name=</span><span class="tok-s">&quot;lista&quot;</span><span class="tok-nt">&gt;</span>
  <span class="tok-nt">&lt;option</span> <span class="tok-na">name=</span><span class="tok-s">&quot;lista&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;Opcion 1&quot;</span><span class="tok-nt">&gt;</span>Opcion 1<span class="tok-nt">&lt;/option&gt;</span>
  <span class="tok-nt">&lt;option</span> <span class="tok-na">name=</span><span class="tok-s">&quot;lista&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;Opcion 2&quot;</span><span class="tok-nt">&gt;</span>Opcion 2<span class="tok-nt">&lt;/option&gt;</span>
  <span class="tok-nt">&lt;option</span> <span class="tok-na">name=</span><span class="tok-s">&quot;lista&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;Opcion 3&quot;</span><span class="tok-nt">&gt;</span>Opcion 3<span class="tok-nt">&lt;/option&gt;</span>
  <span class="tok-nt">&lt;/select&gt;</span>
  <span class="tok-nt">&lt;br&gt;</span>
  Valores 3:
  <span class="tok-nt">&lt;br&gt;</span>
  <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;texto2&quot;</span><span class="tok-nt">&gt;</span>
  <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;texto2&quot;</span><span class="tok-nt">&gt;</span>
  <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;texto2&quot;</span><span class="tok-nt">&gt;</span>

  <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;submit&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;Enviar&quot;</span><span class="tok-nt">&gt;</span>
<span class="tok-nt">&lt;/form&gt;</span>
<span class="tok-nt">&lt;/body&gt;</span>
<span class="tok-nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Al validarlo se llama al servlet <code>ServletForm</code>, que muestra una página HTML con los valores introducidos en los parámetros del formulario:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">ejemplos</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">java.io.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.http.*</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">ServletForm</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span>
<span class="tok-o">{</span>
  <span class="tok-c1">// Metodo para GET</span>

  <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                    <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
                 <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
    <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setContentType</span><span class="tok-o">(</span><span class="tok-s">&quot;text/html&quot;</span><span class="tok-o">);</span>

    <span class="tok-n">PrintWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>

    <span class="tok-c1">// Mostramos los datos del formulario</span>

    <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;HTML&gt;&quot;</span><span class="tok-o">);</span>
    <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;BODY&gt;&quot;</span><span class="tok-o">);</span>
    <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;H1&gt;Datos del formulario&lt;/H1&gt;&quot;</span><span class="tok-o">);</span>
    <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;BR&gt;&quot;</span><span class="tok-o">);</span>

    <span class="tok-n">String</span> <span class="tok-n">valor1</span> <span class="tok-o">=</span>
      <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;texto1&quot;</span><span class="tok-o">);</span>
    <span class="tok-n">String</span> <span class="tok-n">valor2</span> <span class="tok-o">=</span>
      <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;lista&quot;</span><span class="tok-o">);</span>
    <span class="tok-n">String</span><span class="tok-o">[]</span> <span class="tok-n">valor3</span> <span class="tok-o">=</span>
      <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getParameterValues</span><span class="tok-o">(</span><span class="tok-s">&quot;texto2&quot;</span><span class="tok-o">);</span>

    <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;Valor 1:&quot;</span> <span class="tok-o">+</span> <span class="tok-n">valor1</span><span class="tok-o">);</span>
    <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;BR&gt;&quot;</span><span class="tok-o">);</span>
    <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;Valor 2:&quot;</span> <span class="tok-o">+</span> <span class="tok-n">valor2</span><span class="tok-o">);</span>
    <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;BR&gt;&quot;</span><span class="tok-o">);</span>
    <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;Valor 3:&quot;</span><span class="tok-o">);</span>
    <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;BR&gt;&quot;</span><span class="tok-o">);</span>
    <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">valor3</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">)</span>
      <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-kt">int</span> <span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-o">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-n">valor3</span><span class="tok-o">.</span><span class="tok-na">length</span><span class="tok-o">;</span> <span class="tok-n">i</span><span class="tok-o">++)</span>
      <span class="tok-o">{</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-n">valor3</span><span class="tok-o">[</span><span class="tok-n">i</span><span class="tok-o">]);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;BR&gt;&quot;</span><span class="tok-o">);</span>
      <span class="tok-o">}</span>

    <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;/BODY&gt;&quot;</span><span class="tok-o">);</span>
    <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;/HTML&gt;&quot;</span><span class="tok-o">);</span>
  <span class="tok-o">}</span>

  <span class="tok-c1">// Metodo para POST</span>

  <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">doPost</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                     <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
                  <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
    <span class="tok-n">doGet</span><span class="tok-o">(</span><span class="tok-n">request</span><span class="tok-o">,</span> <span class="tok-n">response</span><span class="tok-o">);</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para probar el ejemplo que viene en las plantillas, cargamos la URL:</p>
</div>
<div class="paragraph">
<p><a href="http://localhost:8080/appforms/index_form.html" class="bare">http://localhost:8080/appforms/index_form.html</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_cabeceras_y_códigos">2.3. Cabeceras y códigos</h3>
<div class="paragraph">
<p>Veremos a continuación cómo tratar las cabeceras HTTP de una petición y de una respuesta, así como los códigos de estado que emite un servidor Web ante una petición, y las variables CGI a las que podemos acceder.</p>
</div>
<div class="sect3">
<h4 id="_cabeceras_de_petición">2.3.1. Cabeceras de petición</h4>
<div class="paragraph">
<p>Cuando se envía una petición HTTP, se pueden enviar, entre otras cosas, unas cabeceras con información sobre el navegador. Para leer estas cabeceras de una petición desde un servlet, se utiliza el método <strong><code>getHeader()</code></strong> del objeto <strong><code>HttpServletRequest</code></strong>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">String</span> <span class="tok-nf">getHeader</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El parámetro indica el nombre de la cabecera cuyo valor se quiere obtener. Devuelve el valor de la cabecera, o <code>null</code> si la cabecera no ha sido enviada en la petición.
Se tienen otros métodos, como:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">Enumeration</span> <span class="tok-nf">getHeaderNames</span><span class="tok-o">()</span>
<span class="tok-n">Enumeration</span> <span class="tok-nf">getHeaders</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">)</span>
<span class="tok-kt">int</span> <span class="tok-nf">getIntHeader</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">)</span>
<span class="tok-o">...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Con <strong><code>getHeaderNames()</code></strong> obtendremos todos los nombres de las cabeceras enviadas. Con <strong><code>getHeaders()</code></strong> obtendremos todos los valores de la cabecera de nombre dado. También hay métodos como <strong><code>getIntHeader()</code></strong> que devuelve el valor de una cabecera con un tipo de dato específico (entero, en este caso). Los nombres de las cabeceras normalmente no distinguen mayúsculas de minúsculas.
Algunas cabeceras son de uso común, y tienen métodos específicos para obtener sus valores, como:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">Cookie</span><span class="tok-o">[]</span> <span class="tok-nf">getCookies</span><span class="tok-o">()</span>
<span class="tok-n">String</span> <span class="tok-nf">getContentLength</span><span class="tok-o">()</span>
<span class="tok-n">String</span> <span class="tok-nf">getContentType</span><span class="tok-o">()</span>
<span class="tok-o">...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Con <code>getCookies()</code> obtendremos todas las cookies de la petición (veremos las cookies con más detalle en otro tema). Con <code>getContentLength()</code> obtenemos el valor de la cabecera <code>Content-Length</code>, y con <code>getContentType()</code> el de la cabecera <code>Content-Type</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_cabeceras_de_respuesta">2.3.2. Cabeceras de respuesta</h4>
<div class="paragraph">
<p>En la respuesta de un servidor web a una petición también pueden aparecer cabeceras que informan sobre el documento servido o sobre el propio servidor. Podemos definir cabeceras de respuesta para enviar cookies, indicar la fecha de modificación, etc. Estas cabeceras deben establecerse ANTES de enviar cualquier documento, o antes de obtener el <code>PrintWriter</code> si es el caso.
Para enviar cabeceras, el método más general es <strong><code>setHeader()</code></strong> del objeto <strong><code>HttpServletResponse</code></strong>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kt">void</span> <span class="tok-nf">setHeader</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">,</span> <span class="tok-n">String</span> <span class="tok-n">valor</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Al que se le pasan el nombre de la cabecera y el valor. Hay otros métodos útiles:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kt">void</span> <span class="tok-nf">setIntHeader</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">,</span> <span class="tok-kt">int</span> <span class="tok-n">valor</span><span class="tok-o">)</span>
<span class="tok-kt">void</span> <span class="tok-nf">addHeader</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">,</span> <span class="tok-n">String</span> <span class="tok-n">valor</span><span class="tok-o">)</span>
<span class="tok-kt">void</span> <span class="tok-nf">addIntHeader</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">,</span> <span class="tok-kt">int</span> <span class="tok-n">valor</span><span class="tok-o">)</span>
<span class="tok-o">...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong><code>setIntHeader()</code></strong> o <strong><code>setDateHeader()</code></strong> se utilizan para enviar cabeceras de tipo entero o fecha. Los métodos <strong><code>add&#8230;&#8203;()</code></strong> se emplean para añadir múltiples valores a una cabecera con el mismo nombre.</p>
</div>
<div class="paragraph">
<p>Algunas cabeceras tienen métodos específicos de envío, como:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kt">void</span> <span class="tok-nf">setContentType</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">tipo</span><span class="tok-o">)</span>
<span class="tok-kt">void</span> <span class="tok-nf">setContentLength</span><span class="tok-o">(</span><span class="tok-kt">int</span> <span class="tok-n">tamaño</span><span class="tok-o">)</span>
<span class="tok-kt">void</span> <span class="tok-nf">sendRedirect</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">url</span><span class="tok-o">)</span>
<span class="tok-kt">void</span> <span class="tok-nf">addCookie</span><span class="tok-o">(</span><span class="tok-n">Cookie</span> <span class="tok-n">cookie</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Con <strong><code>setContentType()</code></strong> se establece la cabecera <code>Content-Type</code> con el tipo MIME del documento. Con <strong><code>setContentLength()</code></strong> se indican los bytes enviados. Con <strong><code>sendRedirect()</code></strong> se selecciona la cabecera <code>Location</code>, y con ella se redirige a la página que le digamos. Finalmente, con <strong><code>addCookie()</code></strong> se establecen cookies (esto último ya lo veremos con más detalle en otro tema). Es recomendable utilizar estos métodos en lugar del método <code>setHeader()</code> para la cabecera en cuestión.</p>
</div>
</div>
<div class="sect3">
<h4 id="_variables_cgi">2.3.3. Variables CGI</h4>
<div class="paragraph">
<p>Las variables CGI son una forma de recoger información sobre una petición. Algunas se derivan de la línea de petición HTTP y de las cabeceras, otras del propio socket (como el nombre o la IP de quien solicita la petición), y otras de los parámetros de instalación del servidor (como el mapeo de URLs a los paths actuales).
Mostramos a continuación una tabla con las variables CGI, y cómo acceder a ellas desde servlets:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33%;">
<col style="width: 33%;">
<col style="width: 33%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">VARIABLE CGI</th>
<th class="tableblock halign-left valign-top">SIGNIFICADO</th>
<th class="tableblock halign-left valign-top">ACCESO DESDE SERVLETS</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AUTH_TYPE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tipo de cabecera Authorization (basic o digest)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>request. getAuthType()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CONTENT_LENGTH</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Número de bytes enviados en peticiones POST</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>request. getContentLength()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CONTENT_TYPE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tipo MIME de los datos adjuntos</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>request. getContentType()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DOCUMENT_ROOT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Path del directorio raíz del servidor web</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>getServletContext(). getRealPath("/")</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTP_XXX_YYY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Acceso a cabeceras arbitrarias HTTP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>request. getHeader("Xxx-Yyy")</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PATH_INFO</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Información de path adjunto a la URL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>request. getPathInfo()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PATH_TRANSLATED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Path mapeado al path real del servidor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>request. getPathTranslated()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">QUERY_STRING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Datos adjuntos para peticiones GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>request. getQueryString()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">REMOTE_ADDR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IP del cliente que hizo la petición</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>request. getRemoteAddr()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">REMOTE_HOST</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nombre del dominio del cliente que hizo la petición (o IP si no se puede determinar)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>request. getRemoteHost()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">REMOTE_USER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Parte del usuario en la cabecera Authorization (si se suministró)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>request. getRemoteUser()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">REQUEST_METHOD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tipo de petición (GET, POST, PUT, DELETE, HEAD, OPTIONS, TRACE)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>request. getMethod()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SCRIPT_NAME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Path del servlet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>request. getServletPath()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SERVER_NAME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nombre del servidor web</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>request. getServerName()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SERVER_PORT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Puerto por el que escucha el servidor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>request. getServerPort()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SERVER_PROTOCOL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nombre y versión usada en la línea de petición (HTTP/1.0, HTTP/1.1 &#8230;&#8203;)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>request. getServerProtocol()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SERVER_SOFTWARE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Información del servidor web</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>getServletContext(). getServerInfo()</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><code>request</code> se asume que es un objeto de tipo <code>HttpServletRequest</code>. Para obtener cualquiera de las variables antes mencionadas, sólo hay que llamar al método apropiado desde <code>doGet()</code> o <code>doPost()</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_códigos_de_estado_http">2.3.4. Códigos de estado HTTP</h4>
<div class="paragraph">
<p>Cuando un servidor web responde a una petición, en la respuesta aparece, entre otras cosas, un código de estado que indica el resultado de la petición, y un mensaje corto descriptivo de dicho código.
El envío de cabeceras de respuesta normalmente se planifica junto con el envío de códigos de estado, ya que muchos de los códigos de estado necesitan tener una cabecera definida. Podemos hacer varias cosas con los servlets manipulando las líneas de estado y las cabeceras de respuesta, como por ejemplo reenviar al usuario a otros lugares, indicar que se requiere un password para acceder a un determinado sitio web, etc.
Para enviar códigos de estado se emplea el método <strong><code>setStatus()</code></strong> de <strong><code>HttpServletResponse</code></strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kt">void</span> <span class="tok-nf">setStatus</span><span class="tok-o">(</span><span class="tok-kt">int</span> <span class="tok-n">estado</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Donde se le pasa como parámetro el código del estado. En la clase <code>HttpServletResponse</code> tenemos una serie de constantes para referenciar a cada código de estado. Por ejemplo, la constante:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">HttpServletResponse</span><span class="tok-o">.</span><span class="tok-na">SC_NOT_FOUND</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>se corresponde con el código 404, e indica que el documento solicitado no se ha encontrado.
Existen otros métodos para gestión de mensajes de error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kt">void</span> <span class="tok-nf">sendError</span><span class="tok-o">(</span><span class="tok-kt">int</span> <span class="tok-n">codigo</span><span class="tok-o">,</span> <span class="tok-n">String</span> <span class="tok-n">mensaje</span><span class="tok-o">)</span>
<span class="tok-kt">void</span> <span class="tok-nf">sendRedirect</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">url</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong><code>sendError()</code></strong> genera una página de error, con código de error igual a <code>codigo</code>, y con mensaje de error igual a <code>mensaje</code>. Se suele utilizar este método para códigos de error, y <code>setStatus()</code> para códigos normales.
<strong><code>sendRedirect()</code></strong> genera un error de tipo 302, envía una cabecera <code>Location</code> y redirige a la página indicada en <code>url</code>. Es mejor que enviar directamente el código, o hacer un <code>response.setHeader("Location", "http&#8230;&#8203;")</code>, porque es más cómodo, y porque el servlet genera así una página con el enlace a la nueva dirección, para navegadores que no soporten redirección automática
Si queremos enviar un código en la respuesta, se tiene que especificar antes de obtener el objeto <code>PrintWriter</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_procesamiento_asíncrono">2.4. Procesamiento asíncrono</h3>
<div class="paragraph">
<p>Hemos visto anteriormente que por cada petición que se realiza a un servlet se crea un hilo de ejecución. Dado que los recursos del servidor son limitados, normalmente tenemos un número máximo de hilos que pueden atender a los clientes (tenemos un <em>pool</em> de hilos). Cuando los hilos se agoten no se podrán atender más peticiones.</p>
</div>
<div class="paragraph">
<p>Si realizamos operaciones de larga duración estos hilos quedarán ocupados durante más tiempo y será más fácil agotar los recursos disponibles. Podemos mejorar la escalabilidad del sistema utilizando procesamiento asíncrono. Este tipo de procesamiento nos permite liberar el hilo de la petición mientras se realiza una operación larga en segundo plano, de forma que otro cliente pueda utilizarlo mientras tanto. Estas operaciones podrían ser por ejemplo:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Consultas a base de datos</p>
</li>
<li>
<p>Acceso a servicios web remotos</p>
</li>
<li>
<p>Operaciones que dependan del suceso de algún evento o de la interacción del usuario</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Para habilitar el procesamiento asíncrono en un servlet debemos añadir el atributo <code>asyncSupported</code> a la anotación <code>WebServlet</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@WebServlet</span><span class="tok-o">(</span><span class="tok-n">urlPatterns</span><span class="tok-o">={</span><span class="tok-s">&quot;/ServletAsincrono&quot;</span><span class="tok-o">},</span> <span class="tok-n">asyncSupported</span><span class="tok-o">=</span><span class="tok-kc">true</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">AsincronoServlet</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span> <span class="tok-o">{</span>
    <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A continuación veremos como liberar el hilo de la petición del procesamiento de operaciones largas o del bloqueo de la entrada/salida utilizando el procesamiento asíncrono.</p>
</div>
<div class="sect3">
<h4 id="_procesamiento_de_operaciones_de_larga_duración">2.4.1. Procesamiento de operaciones de larga duración</h4>
<div class="paragraph">
<p>Una vez habilitado el soporte para procesamiento asíncrono, podremos poner la petición en modo de procesamiento asíncrono mediante el método <code>startAsync</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span> <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span> <span class="tok-o">{</span>
  <span class="tok-o">...</span>
  <span class="tok-kd">final</span> <span class="tok-n">AsyncContext</span> <span class="tok-n">ac</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">startAsync</span><span class="tok-o">();</span>
  <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Al llamar a este método obtenemos un objeto <code>AsyncContext</code> que representa el contexto de ejecución asíncrono y que será necesario para procesar la petición una vez hemos pasado a este modo. Esto nos permitirá pasar el procesamiento de la operación a otro hilo, liberando así al hilo de la petición para que pueda atender a otro cliente.</p>
</div>
<div class="paragraph">
<p>El procesamiento asíncrono de la operación se realizará como se muestra a continuación:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">ac</span><span class="tok-o">.</span><span class="tok-na">start</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">Runnable</span><span class="tok-o">()</span> <span class="tok-o">{</span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">run</span><span class="tok-o">()</span> <span class="tok-o">{</span>
      <span class="tok-n">HttpServletRequest</span> <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-n">ac</span><span class="tok-o">.</span><span class="tok-na">getRequest</span><span class="tok-o">();</span> <i class="conum" data-value="2"></i><b>(2)</b>
      <span class="tok-c1">// Procesa la petición</span>
      <span class="tok-o">...</span>
      <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-n">ac</span><span class="tok-o">.</span><span class="tok-na">getResponse</span><span class="tok-o">();</span> <i class="conum" data-value="3"></i><b>(3)</b>
      <span class="tok-c1">// Escribe la respuesta</span>
      <span class="tok-o">...</span>
      <span class="tok-n">ac</span><span class="tok-o">.</span><span class="tok-na">complete</span><span class="tok-o">();</span> <i class="conum" data-value="4"></i><b>(4)</b>
  <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Con <code>start</code> se crea un nuevo hilo dentro del cual realizaremos el procesamiento, liberando así el hilo de la petición.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Podemos obtener el objeto de la petición a partir del <code>AsyncContext</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>También podemos obtener el objeto de la respuesta a partir del <code>AsyncContext</code>, con el cual podremos devolver el resultado al cliente una vez finalizado el procesamiento.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Es importante llamar a <code>complete</code> para que termine la operación asíncrona, cierre la respuesta y se la envíe el cliente. Siempre deberemos llamar a este método tras escribir la respuesta.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_entrada_y_salida_no_bloqueante">2.4.2. Entrada y salida no bloqueante</h4>
<div class="paragraph">
<p>En el apartado anterior hemos visto cómo realizar una operación de larga duración de forma asíncrona. Sin embargo, a veces gran parte del tiempo que se mantiene ocupado el hilo de la petición es debido a la entrada y salida, normalmente debido a mensajes de petición extensos.</p>
</div>
<div class="paragraph">
<p>Podemos utilizar el soporte asíncrono también para leer la petición fuera del hilo de la petición, y así evitar que quede bloqueado más tiempo del necesario. Para hacer esto definiremos un <code>ReadListener</code> sobre el <code>InputStream</code> de la petición, al que le irá llegando el mensaje conforme se reciba:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">final</span> <span class="tok-n">AsyncContext</span> <span class="tok-n">ac</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">startAsync</span><span class="tok-o">();</span>
<span class="tok-kd">final</span> <span class="tok-n">ServletInputStream</span> <span class="tok-n">sis</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getInputStream</span><span class="tok-o">();</span>

<span class="tok-n">sis</span><span class="tok-o">.</span><span class="tok-na">setReadListener</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">ReadListener</span><span class="tok-o">()</span> <span class="tok-o">{</span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="tok-kt">byte</span> <span class="tok-n">buffer</span><span class="tok-o">[]</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-kt">byte</span><span class="tok-o">[</span><span class="tok-mi">4</span><span class="tok-o">*</span><span class="tok-mi">1024</span><span class="tok-o">];</span>
  <span class="tok-n">StringBuilder</span> <span class="tok-n">sb</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">StringBuilder</span><span class="tok-o">();</span>

  <span class="tok-nd">@Override</span>
  <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">onDataAvailable</span><span class="tok-o">()</span> <span class="tok-o">{</span> <i class="conum" data-value="2"></i><b>(2)</b>
      <span class="tok-k">try</span> <span class="tok-o">{</span>
        <span class="tok-k">do</span> <span class="tok-o">{</span>
            <span class="tok-kt">int</span> <span class="tok-n">length</span> <span class="tok-o">=</span> <span class="tok-n">sis</span><span class="tok-o">.</span><span class="tok-na">read</span><span class="tok-o">(</span><span class="tok-n">buffer</span><span class="tok-o">);</span>
            <span class="tok-n">sb</span><span class="tok-o">.</span><span class="tok-na">append</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">String</span><span class="tok-o">(</span><span class="tok-n">buffer</span><span class="tok-o">,</span> <span class="tok-mi">0</span><span class="tok-o">,</span> <span class="tok-n">length</span><span class="tok-o">));</span>
        <span class="tok-o">}</span> <span class="tok-k">while</span><span class="tok-o">(</span><span class="tok-n">sis</span><span class="tok-o">.</span><span class="tok-na">isReady</span><span class="tok-o">());</span>
      <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">IOException</span> <span class="tok-n">ex</span><span class="tok-o">)</span> <span class="tok-o">{</span>  <span class="tok-o">}</span>
  <span class="tok-o">}</span>

  <span class="tok-nd">@Override</span>
  <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">onAllDataRead</span><span class="tok-o">()</span> <span class="tok-o">{</span> <i class="conum" data-value="3"></i><b>(3)</b>
      <span class="tok-k">try</span> <span class="tok-o">{</span>
        <span class="tok-c1">// Procesar peticion</span>
        <span class="tok-o">...</span>
        <span class="tok-n">PrintWriter</span> <span class="tok-n">pw</span> <span class="tok-o">=</span> <span class="tok-n">ac</span><span class="tok-o">.</span><span class="tok-na">getResponse</span><span class="tok-o">().</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>
        <span class="tok-c1">// Escribir respuesta</span>
        <span class="tok-o">...</span>
      <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">IOException</span> <span class="tok-n">ex</span><span class="tok-o">)</span> <span class="tok-o">{</span>  <span class="tok-o">}</span>
      <span class="tok-n">ac</span><span class="tok-o">.</span><span class="tok-na">complete</span><span class="tok-o">();</span>
  <span class="tok-o">}</span>

  <span class="tok-nd">@Override</span>
  <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">onError</span><span class="tok-o">(</span><span class="tok-n">Throwable</span> <span class="tok-n">t</span><span class="tok-o">)</span> <span class="tok-o">{</span>  <span class="tok-o">}</span>
<span class="tok-o">});</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Definimos un objeto <code>ReadListener</code> y se lo asignamos al <code>InputStream</code> de la petición.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Cada vez que se reciba un fragmento del mensaje se llamará a <code>onDataAvailable</code>. Deberemos leer todos los datos disponibles hasta el momento, y cuando no hayan llegado más saldremos del método para evitar bloquear el hilo. Este método se volverá a llamar cuando haya un nuevo fragmento disponible.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Cuando todo el mensaje haya llegado se llama a <code>onAllDataRead</code>. Aquí podemos ya ver todo el contenido que hemos recibido con la petición, y podemos procesarlo y devolver una respuesta.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ejemplos">2.5. Ejemplos</h3>
<div class="sect3">
<h4 id="_ejemplo_de_cabeceras_de_petición">2.5.1. Ejemplo de cabeceras de petición</h4>
<div class="paragraph">
<p>El siguiente servlet muestra los valores de todas las cabeceras HTTP enviadas en la petición. Recorre las cabeceras enviadas y muestra su nombre y valor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">ejemplos</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">java.io.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.http.*</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">ServletCabecerasPeticion</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span> <span class="tok-o">{</span>

    <span class="tok-c1">// Metodo para GET</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                     <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
                   <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
        <span class="tok-n">PrintWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>

        <span class="tok-c1">// Mostramos las cabeceras enviadas</span>
        <span class="tok-c1">// en la peticion</span>

        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;HTML&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;BODY&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;H1&gt;Cabeceras&lt;/H1&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;BR&gt;&quot;</span><span class="tok-o">);</span>

        <span class="tok-n">Enumeration</span> <span class="tok-n">cabeceras</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getHeaderNames</span><span class="tok-o">();</span>

        <span class="tok-k">while</span> <span class="tok-o">(</span><span class="tok-n">cabeceras</span><span class="tok-o">.</span><span class="tok-na">hasMoreElements</span><span class="tok-o">())</span>
        <span class="tok-o">{</span>
            <span class="tok-n">String</span> <span class="tok-n">nombre</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-n">String</span><span class="tok-o">)(</span><span class="tok-n">cabeceras</span><span class="tok-o">.</span><span class="tok-na">nextElement</span><span class="tok-o">());</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;Nombre: &quot;</span> <span class="tok-o">+</span> <span class="tok-n">nombre</span> <span class="tok-o">+</span>
               <span class="tok-s">&quot;, Valor: &quot;</span> <span class="tok-o">+</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getHeader</span><span class="tok-o">(</span><span class="tok-n">nombre</span><span class="tok-o">));</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;BR&gt;&lt;BR&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-o">}</span>

        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;/BODY&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;/HTML&gt;&quot;</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-c1">// Metodo para POST</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">doPost</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                      <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
                   <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
        <span class="tok-n">doGet</span><span class="tok-o">(</span><span class="tok-n">request</span><span class="tok-o">,</span> <span class="tok-n">response</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Se puede probar con este formulario, pinchando el botón:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;html&gt;</span>
<span class="tok-nt">&lt;body&gt;</span>
<span class="tok-nt">&lt;form</span> <span class="tok-na">action=</span>
 <span class="tok-s">&quot;/appcab/servlet/ejemplos.ServletCabecerasPeticion&quot;</span><span class="tok-nt">&gt;</span>
  <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;submit&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;Pulsa aqui&quot;</span><span class="tok-nt">&gt;</span>
<span class="tok-nt">&lt;/form&gt;</span>
<span class="tok-nt">&lt;/body&gt;</span>
<span class="tok-nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ejemplo_de_cabeceras_de_respuesta">2.5.2. Ejemplo de cabeceras de respuesta</h4>
<div class="paragraph">
<p>El siguiente servlet espera un parámetro <code>accion</code> que puede tomar 4 valores:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>primos</strong>: El servlet tiene un hilo que está constantemente calculando números primos. Al elegir esta opción se envía una cabecera <code>Refresh</code> y recarga el servlet cada 10 segundos, mostrando el último número primo que ha encontrado.</p>
</li>
<li>
<p><strong>redirect</strong>: Utiliza un <code>sendRedirect()</code> para cargar la página que se indique como parámetro</p>
</li>
<li>
<p><strong>error</strong>: Utiliza un <code>sendError()</code> para mostrar una página de error, con un mensaje de error definido por el usuario, y un código de error a elegir de una lista.</p>
</li>
<li>
<p><strong>codigo</strong>: Envía un código de estado HTTP (con <code>setStatus()</code>), a elegir de entre una lista.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">ejemplos</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">java.io.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.http.*</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">ServletCabecerasRespuesta</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span>
                                       <span class="tok-kd">implements</span> <span class="tok-n">Runnable</span> <span class="tok-o">{</span>
    <span class="tok-c1">// Ultimo numero primo descubierto</span>
    <span class="tok-kt">long</span> <span class="tok-n">primo</span> <span class="tok-o">=</span> <span class="tok-mi">1</span><span class="tok-o">;</span>

    <span class="tok-c1">// Hilo para calcular numeros primos</span>
    <span class="tok-n">Thread</span> <span class="tok-n">t</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Thread</span><span class="tok-o">(</span><span class="tok-k">this</span><span class="tok-o">);</span>

    <span class="tok-c1">// Metodo de inicializacion</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">init</span><span class="tok-o">()</span>
    <span class="tok-o">{</span>
        <span class="tok-n">t</span><span class="tok-o">.</span><span class="tok-na">start</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>

    <span class="tok-c1">// Metodo para GET</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                      <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
                    <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
        <span class="tok-n">String</span> <span class="tok-n">accion</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;accion&quot;</span><span class="tok-o">);</span>

        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">accion</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-s">&quot;primo&quot;</span><span class="tok-o">))</span>
        <span class="tok-o">{</span>
            <span class="tok-c1">// Buscar el ultimo numero</span>
            <span class="tok-c1">// primo y enviarlo</span>

            <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setContentType</span><span class="tok-o">(</span><span class="tok-s">&quot;text/html&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setHeader</span><span class="tok-o">(</span><span class="tok-s">&quot;Refresh&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;10&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">PrintWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;HTML&gt;&lt;BODY&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;Primo: &quot;</span> <span class="tok-o">+</span> <span class="tok-n">primo</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;/BODY&gt;&lt;/HTML&gt;&quot;</span><span class="tok-o">);</span>

        <span class="tok-o">}</span> <span class="tok-k">else</span> <span class="tok-nf">if</span> <span class="tok-o">(</span><span class="tok-n">accion</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-s">&quot;redirect&quot;</span><span class="tok-o">))</span> <span class="tok-o">{</span>

            <span class="tok-c1">// Redirigir a otra pagina</span>

            <span class="tok-n">String</span> <span class="tok-n">url</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;url&quot;</span><span class="tok-o">);</span>
            <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">url</span> <span class="tok-o">==</span> <span class="tok-kc">null</span><span class="tok-o">)</span>
                <span class="tok-n">url</span> <span class="tok-o">=</span> <span class="tok-s">&quot;http://www.ua.es&quot;</span><span class="tok-o">;</span>
            <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">sendRedirect</span><span class="tok-o">(</span><span class="tok-n">url</span><span class="tok-o">);</span>

        <span class="tok-o">}</span> <span class="tok-k">else</span> <span class="tok-nf">if</span> <span class="tok-o">(</span><span class="tok-n">accion</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-s">&quot;error&quot;</span><span class="tok-o">))</span> <span class="tok-o">{</span>

            <span class="tok-c1">// Enviar error con sendError()</span>

            <span class="tok-kt">int</span> <span class="tok-n">codigo</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">SC_NOT_FOUND</span><span class="tok-o">;</span>
            <span class="tok-k">try</span> <span class="tok-o">{</span>
                <span class="tok-n">codigo</span> <span class="tok-o">=</span> <span class="tok-n">Integer</span><span class="tok-o">.</span><span class="tok-na">parseInt</span>
               <span class="tok-o">(</span><span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;codigoMensaje&quot;</span><span class="tok-o">));</span>
            <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">Exception</span> <span class="tok-n">ex</span><span class="tok-o">)</span> <span class="tok-o">{</span>
                <span class="tok-n">codigo</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">SC_NOT_FOUND</span><span class="tok-o">;</span>
            <span class="tok-o">}</span>

            <span class="tok-n">String</span> <span class="tok-n">mensaje</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;mensaje&quot;</span><span class="tok-o">);</span>
            <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">mensaje</span> <span class="tok-o">==</span> <span class="tok-kc">null</span><span class="tok-o">)</span>
                <span class="tok-n">mensaje</span> <span class="tok-o">=</span> <span class="tok-s">&quot;Error generado&quot;</span><span class="tok-o">;</span>
            <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">sendError</span><span class="tok-o">(</span><span class="tok-n">codigo</span><span class="tok-o">,</span> <span class="tok-n">mensaje</span><span class="tok-o">);</span>

        <span class="tok-o">}</span> <span class="tok-k">else</span> <span class="tok-nf">if</span> <span class="tok-o">(</span><span class="tok-n">accion</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-s">&quot;codigo&quot;</span><span class="tok-o">))</span> <span class="tok-o">{</span>

            <span class="tok-c1">// Enviar un codigo de error</span>

            <span class="tok-kt">int</span> <span class="tok-n">codigo</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">SC_NOT_FOUND</span><span class="tok-o">;</span>
            <span class="tok-k">try</span> <span class="tok-o">{</span>
                <span class="tok-n">codigo</span> <span class="tok-o">=</span> <span class="tok-n">Integer</span><span class="tok-o">.</span><span class="tok-na">parseInt</span>
                  <span class="tok-o">(</span><span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;codigo&quot;</span><span class="tok-o">));</span>
            <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">Exception</span> <span class="tok-n">ex</span><span class="tok-o">)</span> <span class="tok-o">{</span>
                <span class="tok-n">codigo</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">SC_NOT_FOUND</span><span class="tok-o">;</span>
            <span class="tok-o">}</span>

            <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setStatus</span><span class="tok-o">(</span><span class="tok-n">codigo</span><span class="tok-o">);</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>

    <span class="tok-c1">// Metodo para POST</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">doPost</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                       <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
                    <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
        <span class="tok-n">doGet</span><span class="tok-o">(</span><span class="tok-n">request</span><span class="tok-o">,</span> <span class="tok-n">response</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-o">...</span> <span class="tok-n">el</span> <span class="tok-n">resto</span> <span class="tok-n">del</span> <span class="tok-n">codigo</span> <span class="tok-n">es</span> <span class="tok-n">para</span> <span class="tok-n">el</span> <span class="tok-n">hilo</span><span class="tok-o">,</span>
    <span class="tok-n">para</span> <span class="tok-n">calcular</span> <span class="tok-n">numeros</span> <span class="tok-n">primos</span>
    <span class="tok-n">Puede</span> <span class="tok-n">consultarse</span> <span class="tok-n">en</span> <span class="tok-n">el</span> <span class="tok-n">fichero</span> <span class="tok-n">fuente</span><span class="tok-o">,</span>
    <span class="tok-n">aqui</span> <span class="tok-n">se</span> <span class="tok-n">quita</span> <span class="tok-n">por</span> <span class="tok-n">simplificar</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Se puede probar con este formulario, eligiendo la acción a realizar, introduciendo los parámetros necesarios en el formulario y pinchando el botón de Enviar Datos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;html&gt;</span>
<span class="tok-nt">&lt;body&gt;</span>
<span class="tok-nt">&lt;form</span> <span class="tok-na">action=</span>
<span class="tok-s">&quot;/appcab/servlet/ejemplos.ServletCabecerasRespuesta&quot;</span><span class="tok-nt">&gt;</span>

<span class="tok-nt">&lt;table</span> <span class="tok-na">border=</span><span class="tok-s">&quot;0&quot;</span><span class="tok-nt">&gt;</span>

<span class="tok-nt">&lt;tr&gt;</span>
<span class="tok-nt">&lt;td&gt;</span>
<span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;radio&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;accion&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;primo&quot;</span> <span class="tok-err">selected</span><span class="tok-nt">&gt;</span>
Obtener ultimo numero primo
<span class="tok-nt">&lt;/td&gt;</span>
<span class="tok-nt">&lt;td&gt;&lt;/td&gt;</span>
<span class="tok-nt">&lt;td&gt;&lt;/td&gt;</span>
<span class="tok-nt">&lt;/tr&gt;</span>

<span class="tok-nt">&lt;tr&gt;</span>
<span class="tok-nt">&lt;td&gt;</span>
<span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;radio&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;accion&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;redirect&quot;</span><span class="tok-nt">&gt;</span>
Redirigir a una pagina
<span class="tok-nt">&lt;/td&gt;</span>
<span class="tok-nt">&lt;td&gt;</span>
URL:
<span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;url&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;http://www.ua.es&quot;</span><span class="tok-nt">&gt;</span>
<span class="tok-nt">&lt;/td&gt;</span>
<span class="tok-nt">&lt;td&gt;&lt;/td&gt;</span>
<span class="tok-nt">&lt;/tr&gt;</span>

<span class="tok-nt">&lt;tr&gt;</span>
<span class="tok-nt">&lt;td&gt;</span>
<span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;radio&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;accion&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;error&quot;</span><span class="tok-nt">&gt;</span>
Mostrar pagina de error
<span class="tok-nt">&lt;/td&gt;</span>
<span class="tok-nt">&lt;td&gt;</span>
Mensaje:
<span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;mensaje&quot;</span>
<span class="tok-na">value=</span><span class="tok-s">&quot;Error generado por el usuario&quot;</span><span class="tok-nt">&gt;</span>
<span class="tok-nt">&lt;/td&gt;</span>
<span class="tok-nt">&lt;td&gt;</span>
Codigo:
<span class="tok-nt">&lt;select</span> <span class="tok-na">name=</span><span class="tok-s">&quot;codigoMensaje&quot;</span><span class="tok-nt">&gt;</span>
<span class="tok-nt">&lt;option</span> <span class="tok-na">name=</span><span class="tok-s">&quot;codigoMensaje&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;400&quot;</span><span class="tok-nt">&gt;</span>400<span class="tok-nt">&lt;/option&gt;</span>
<span class="tok-nt">&lt;option</span> <span class="tok-na">name=</span><span class="tok-s">&quot;codigoMensaje&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;401&quot;</span><span class="tok-nt">&gt;</span>401<span class="tok-nt">&lt;/option&gt;</span>
<span class="tok-nt">&lt;option</span> <span class="tok-na">name=</span><span class="tok-s">&quot;codigoMensaje&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;403&quot;</span><span class="tok-nt">&gt;</span>403<span class="tok-nt">&lt;/option&gt;</span>
<span class="tok-nt">&lt;option</span> <span class="tok-na">name=</span><span class="tok-s">&quot;codigoMensaje&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;404&quot;</span> <span class="tok-err">selected</span><span class="tok-nt">&gt;</span>404
<span class="tok-nt">&lt;/option&gt;</span>
<span class="tok-nt">&lt;/select&gt;</span>
<span class="tok-nt">&lt;/td&gt;</span>
<span class="tok-nt">&lt;/tr&gt;</span>

<span class="tok-nt">&lt;tr&gt;</span>
<span class="tok-nt">&lt;td&gt;</span>
<span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;radio&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;accion&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;codigo&quot;</span><span class="tok-nt">&gt;</span>
Enviar codigo de error
<span class="tok-nt">&lt;/td&gt;</span>
<span class="tok-nt">&lt;td&gt;</span>
Codigo:
<span class="tok-nt">&lt;select</span> <span class="tok-na">name=</span><span class="tok-s">&quot;codigo&quot;</span><span class="tok-nt">&gt;</span>
<span class="tok-nt">&lt;option</span> <span class="tok-na">name=</span><span class="tok-s">&quot;codigo&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;200&quot;</span><span class="tok-nt">&gt;</span>200<span class="tok-nt">&lt;/option&gt;</span>
<span class="tok-nt">&lt;option</span> <span class="tok-na">name=</span><span class="tok-s">&quot;codigo&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;204&quot;</span><span class="tok-nt">&gt;</span>204<span class="tok-nt">&lt;/option&gt;</span>
<span class="tok-nt">&lt;option</span> <span class="tok-na">name=</span><span class="tok-s">&quot;codigo&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;404&quot;</span> <span class="tok-err">selected</span><span class="tok-nt">&gt;</span>404<span class="tok-nt">&lt;/option&gt;</span>
<span class="tok-nt">&lt;/select&gt;</span>
<span class="tok-nt">&lt;/td&gt;</span>
<span class="tok-nt">&lt;td&gt;&lt;/td&gt;</span>
<span class="tok-nt">&lt;/tr&gt;</span>

<span class="tok-nt">&lt;/table&gt;</span>

<span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;submit&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;Enviar Datos&quot;</span><span class="tok-nt">&gt;</span>

<span class="tok-nt">&lt;/form&gt;</span>
<span class="tok-nt">&lt;/body&gt;</span>
<span class="tok-nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ejemplo_de_autentificación">2.5.3. Ejemplo de autentificación</h4>
<div class="paragraph">
<p>El siguiente servlet emplea las cabeceras de autentificación: envía una cabecera de autentificación si no ha recibido ninguna, o si la que ha recibido no está dentro de un conjunto de <code>Properties</code> predefinido, con logins y passwords válidos. En el caso de introducir un login o password válidos, muestra un mensaje de bienvenida.
Los logins y passwords están en un objeto <code>Properties</code>, definido en el método <code>init()</code>. Podríamos leer estos datos de un fichero, aunque por simplicidad aquí se definen como constantes de cadena.
Los datos de autentificación se envían codificados, y se emplea un objeto <code>sun.misc.BASE64Decoder</code> para descodificarlos y sacar el login y password.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">ejemplos</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">java.io.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">sun.misc.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.http.*</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">ServletPassword</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span>
<span class="tok-o">{</span>
    <span class="tok-c1">// Conjunto de logins y passwords permitidos</span>
    <span class="tok-n">Properties</span> <span class="tok-n">datos</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Properties</span><span class="tok-o">();</span>

    <span class="tok-c1">// Metodo de inicializacion</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">init</span><span class="tok-o">()</span>
    <span class="tok-o">{</span>
        <span class="tok-n">datos</span><span class="tok-o">.</span><span class="tok-na">setProperty</span><span class="tok-o">(</span><span class="tok-s">&quot;usuario1&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;password1&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">datos</span><span class="tok-o">.</span><span class="tok-na">setProperty</span><span class="tok-o">(</span><span class="tok-s">&quot;usuario2&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;password2&quot;</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-c1">// Metodo para GET</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                      <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
                    <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
        <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setContentType</span><span class="tok-o">(</span><span class="tok-s">&quot;text/html&quot;</span><span class="tok-o">);</span>

        <span class="tok-c1">// Comprobamos si hay cabecera</span>
        <span class="tok-c1">// de autorizacion</span>

        <span class="tok-n">String</span> <span class="tok-n">autorizacion</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getHeader</span><span class="tok-o">(</span><span class="tok-s">&quot;Authorization&quot;</span><span class="tok-o">);</span>

        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">autorizacion</span> <span class="tok-o">==</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-c1">// Enviamos el codigo 401 y</span>
            <span class="tok-c1">// la cabecera para autentificacion</span>

            <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setStatus</span><span class="tok-o">(</span><span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">SC_UNAUTHORIZED</span><span class="tok-o">);</span>
            <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setHeader</span><span class="tok-o">(</span><span class="tok-s">&quot;WWW-Authenticate&quot;</span><span class="tok-o">,</span>
                               <span class="tok-s">&quot;BASIC realm=\&quot;privileged-few\&quot;&quot;</span><span class="tok-o">);</span>
        <span class="tok-o">}</span> <span class="tok-k">else</span> <span class="tok-o">{</span>
            <span class="tok-c1">// Obtenemos los datos del usuario</span>
            <span class="tok-c1">// y comparamos con los almacenados</span>

            <span class="tok-c1">// Quitamos los 6 primeros caracteres</span>
            <span class="tok-c1">// que indican tipo de autentificación</span>
            <span class="tok-c1">// (BASIC)</span>

            <span class="tok-n">String</span> <span class="tok-n">datosUsuario</span> <span class="tok-o">=</span>
                <span class="tok-n">autorizacion</span><span class="tok-o">.</span><span class="tok-na">substring</span><span class="tok-o">(</span><span class="tok-mi">6</span><span class="tok-o">).</span><span class="tok-na">trim</span><span class="tok-o">();</span>

            <span class="tok-n">BASE64Decoder</span> <span class="tok-n">dec</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">BASE64Decoder</span><span class="tok-o">();</span>

            <span class="tok-n">String</span> <span class="tok-n">usuarioPassword</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">String</span>
                <span class="tok-o">(</span><span class="tok-n">dec</span><span class="tok-o">.</span><span class="tok-na">decodeBuffer</span><span class="tok-o">(</span><span class="tok-n">datosUsuario</span><span class="tok-o">));</span>

            <span class="tok-kt">int</span> <span class="tok-n">indice</span> <span class="tok-o">=</span> <span class="tok-n">usuarioPassword</span><span class="tok-o">.</span><span class="tok-na">indexOf</span><span class="tok-o">(</span><span class="tok-s">&quot;:&quot;</span><span class="tok-o">);</span>

            <span class="tok-n">String</span> <span class="tok-n">usuario</span> <span class="tok-o">=</span>
                <span class="tok-n">usuarioPassword</span><span class="tok-o">.</span><span class="tok-na">substring</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">,</span> <span class="tok-n">indice</span><span class="tok-o">);</span>

            <span class="tok-n">String</span> <span class="tok-n">password</span> <span class="tok-o">=</span>
                <span class="tok-n">usuarioPassword</span><span class="tok-o">.</span><span class="tok-na">substring</span><span class="tok-o">(</span><span class="tok-n">indice</span> <span class="tok-o">+</span> <span class="tok-mi">1</span><span class="tok-o">);</span>

            <span class="tok-n">String</span> <span class="tok-n">passwordReal</span> <span class="tok-o">=</span>
                <span class="tok-n">datos</span><span class="tok-o">.</span><span class="tok-na">getProperty</span><span class="tok-o">(</span><span class="tok-n">usuario</span><span class="tok-o">);</span>

            <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">passwordReal</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span> <span class="tok-o">&amp;&amp;</span>
                <span class="tok-n">passwordReal</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">password</span><span class="tok-o">))</span> <span class="tok-o">{</span>

                <span class="tok-c1">// Mensaje de bienvenida</span>

                <span class="tok-n">PrintWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>
                <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;HTML&gt;&lt;BODY&gt;&quot;</span><span class="tok-o">);</span>
                <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;OK&quot;</span><span class="tok-o">);</span>
                <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;/BODY&gt;&lt;/HTML&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-o">}</span> <span class="tok-k">else</span> <span class="tok-o">{</span>

                <span class="tok-c1">// Pedir autentificacion</span>

                <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setStatus</span><span class="tok-o">(</span><span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">SC_UNAUTHORIZED</span><span class="tok-o">);</span>
                <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setHeader</span><span class="tok-o">(</span><span class="tok-s">&quot;WWW-Authenticate&quot;</span><span class="tok-o">,</span>
                           <span class="tok-s">&quot;BASIC realm=\&quot;privileged-few\&quot;&quot;</span><span class="tok-o">);</span>
            <span class="tok-o">}</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>

    <span class="tok-c1">// Metodo para POST</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">doPost</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                       <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
                     <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
        <span class="tok-n">doGet</span><span class="tok-o">(</span><span class="tok-n">request</span><span class="tok-o">,</span> <span class="tok-n">response</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Se puede probar cada ejemplo, respectivamente, con:</p>
</div>
<div class="paragraph">
<p><a href="http://localhost:8080/appcab/inicioCabecerasPeticion.html" class="bare">http://localhost:8080/appcab/inicioCabecerasPeticion.html</a></p>
</div>
<div class="paragraph">
<p><a href="http://localhost:8080/appcab/inicioCabecerasRespuesta.html" class="bare">http://localhost:8080/appcab/inicioCabecerasRespuesta.html</a></p>
</div>
<div class="paragraph">
<p><a href="http://localhost:8080/appcab/servlet/ejemplos.ServletPassword" class="bare">http://localhost:8080/appcab/servlet/ejemplos.ServletPassword</a></p>
</div>
<div class="paragraph">
<p>Un ejemplo de login y password válidos para el tercer ejemplo es: login=<code>usuario1</code>, password=<code>password1</code>.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios_2">2.6. Ejercicios</h3>
<div class="sect3">
<h4 id="_recogida_de_parámetros_del_usuario_0_3_puntos">2.6.1. Recogida de parámetros del usuario (0,3 puntos)</h4>
<div class="paragraph">
<p>La aplicación <code>cweb-peticiones</code> contiene un formulario <code>form_datos.html</code> con una serie de campos (tipo texto, listas, checkboxes&#8230;&#8203;). Se pide que dicho formulario, en su <em>action</em>, llame al servlet <code>org.expertojava.cweb.ejercicios.DatosServlet</code> que deberéis crear e implementar. El servlet recogerá todos los parámetros del formulario y los mostrará en una tabla de dos columnas (una con el nombre del parámetro y otra con el valor).</p>
</div>
</div>
<div class="sect3">
<h4 id="_trabajando_con_redirecciones_0_4_puntos">2.6.2. Trabajando con redirecciones (0,4 puntos)</h4>
<div class="paragraph">
<p>Sobre la aplicación anterior, tenemos otro formulario <code>form_datos2.html</code> idéntico al del ejercicio anterior, que deberá llamar al servlet <code>org.expertojava.cweb.ejercicios.DatosServlet2</code>. Crear este servlet y hacer que redirija a la página <code>bienvenida.html</code> con un mensaje de bienvenida, si los datos introducidos en el formulario son correctos, y a la misma página <code>form_datos2.html</code> si hay algún dato incorrecto. Entenderemos por dato incorrecto que alguno de los campos de texto se quede vacío. Utilizad el método <code>sendRedirect</code> de la respuesta para las redirecciones.</p>
</div>
</div>
<div class="sect3">
<h4 id="_un_buscador_sencillo_0_4_puntos">2.6.3. Un buscador sencillo (0,4 puntos)</h4>
<div class="paragraph">
<p>En el fichero <code>libros.txt</code> hay un listado de libros, indicando su ISBN, título y autor. Cread e implementad un servlet <code>org.expertojava.cweb.ejercicios.LibroServlet</code> que lea dicho fichero, guarde los libros en un <code>ArrayList</code>, y reciba un parámetro <code>cadena</code>. Como resultado, sacará todos los libros de la lista que contengan dicha cadena (en el título, en el autor, o en cualquier parte de la cadena). Podéis hacer también una página HTML <code>libros.html</code> con el formulario de búsqueda que llame al servlet, para poderlo probar.</p>
</div>
<div class="paragraph">
<p>Para leer los libros, en la inicialización del servlet podemos utilizar un código como el siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">ArrayList</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-o">&gt;</span> <span class="tok-n">libros</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">ArrayList</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-o">&gt;();</span>
<span class="tok-o">...</span>
<span class="tok-n">InputStream</span> <span class="tok-n">is</span> <span class="tok-o">=</span> <span class="tok-n">getClass</span><span class="tok-o">().</span><span class="tok-na">getResourceAsStream</span><span class="tok-o">(</span><span class="tok-s">&quot;/libros.txt&quot;</span><span class="tok-o">);</span>
<span class="tok-n">BufferedReader</span> <span class="tok-n">br</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">BufferedReader</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">InputStreamReader</span><span class="tok-o">(</span><span class="tok-n">is</span><span class="tok-o">));</span>
<span class="tok-n">String</span> <span class="tok-n">libro</span><span class="tok-o">;</span>
<span class="tok-k">try</span> <span class="tok-o">{</span>
  <span class="tok-k">while</span><span class="tok-o">(</span> <span class="tok-o">(</span><span class="tok-n">libro</span><span class="tok-o">=</span><span class="tok-n">br</span><span class="tok-o">.</span><span class="tok-na">readLine</span><span class="tok-o">())!=</span><span class="tok-kc">null</span> <span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-n">libros</span><span class="tok-o">.</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-n">libro</span><span class="tok-o">);</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">IOException</span> <span class="tok-n">e</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_distinguir_el_navegador_0_3_puntos">2.6.4. Distinguir el navegador (0,3 puntos)</h4>
<div class="paragraph">
<p>Muchas veces, cuando escribamos una aplicación Web, nos va a interesar poder distinguir el tipo de navegador que está utilizando el cliente, porque en función
  del mismo se podrán hacer o no determinadas acciones. Por ejemplo, el código Javascript que se emplea en un navegador Internet Explorer es diferente a veces del
  que se emplea en uno Mozilla. Para probar a distinguir entre navegadores, vamos a crear el servlet <code>org.expertojava.cweb.ejercicios.NavServlet</code> para
  que identifique si el cliente accede desde un tipo de navegador u otro. Para ello leemos la cabecera <code>User-Agent</code> con el método <code>getHeader(&#8230;&#8203;)</code>
  de la petición, y comprobamos su valor. Mostrad la cadena en una página, y cargad dicha página desde dos o tres navegadores diferentes. Cada uno mostrará algún rasgo
  distintivo en dicha cadena, que lo identifique de los demás. Una vez tengáis una parte de texto que los diferencia (por ejemplo, en Firefox el
  <code>User-Agent</code> tiene la cadena "Firefox", y en el otro navegador (Mozilla, por ejemplo), no la tiene) haríamos con algo como:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">req</span><span class="tok-o">,</span> <span class="tok-o">...)</span> <span class="tok-kd">throws</span> <span class="tok-o">...</span>
<span class="tok-o">{</span>
  <span class="tok-n">String</span> <span class="tok-n">nav</span> <span class="tok-o">=</span> <span class="tok-n">req</span><span class="tok-o">.</span><span class="tok-na">getHeader</span><span class="tok-o">(</span><span class="tok-s">&quot;User-Agent&quot;</span><span class="tok-o">);</span>
  <span class="tok-c1">// Cambiar &quot;Firefox&quot; por el texto que sea</span>
  <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">nav</span><span class="tok-o">.</span><span class="tok-na">indexOf</span><span class="tok-o">(</span><span class="tok-s">&quot;Firefox&quot;</span><span class="tok-o">)</span> <span class="tok-o">!=</span> <span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-o">)</span>
    <span class="tok-o">...</span> <span class="tok-c1">// Firefox</span>
  <span class="tok-k">else</span>
    <span class="tok-o">...</span> <span class="tok-c1">// Otro navegador (Mozilla)</span>
  <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Una vez distinguido el navegador, ya se podría hacer algo que sólo sirviera para ese navegador. En este caso, por simplificar, vamos a cargar como imagen el logo
  del navegador que hayamos detectado. Tenéis en la plantilla las imágenes correspondientes diferentes navegadores (directorio <code>webapp/logos</code>). Colocad
  como imagen de la página la del navegador que hayáis detectado (con una etiqueta <code>&lt;img&gt;</code> de HTML).</p>
</div>
</div>
<div class="sect3">
<h4 id="_redirecciones_con_retardo_0_3_puntos">2.6.5. Redirecciones con retardo (0,3 puntos)</h4>
<div class="paragraph">
<p>El formulario <code>form_datos3.html</code> se envía al servlet <code>org.expertojava.cweb.ejercicios.CompruebaServlet</code>. Se pide crear e implementar dicho servlet para comprobar que los datos sean correctos (que no haya ningún campo de texto vacío). En el caso de que no haya errores el servlet simplemente mostrará un mensaje indicando que todo ha ido bien. Si hay algún error, el servlet debe redirigir al servlet <code>org.expertojava.cweb.ejercicios.ErrorCompruebaServlet</code>, que deberéis crear para que muestre un mensaje con el error producido (indicando qué campo está incompleto), y a los 5 segundos redirija al formulario anterior</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Se puede utilizar la cabecera de respuesta <code>Refresh</code> con valor <code>5; url=form_datos3.html</code>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_loggear_variables_cgi_0_3_puntos">2.6.6. Loggear variables CGI (0,3 puntos)</h4>
<div class="paragraph">
<p>Sobre el servlet <code>org.expertojava.cweb.ejercicios.CompruebaServlet</code> anterior vamos a añadir mensajes de log de tipo INFO, para que:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Tras cada petición (por <code>doGet</code> o <code>doPost</code>), genere un mensaje de tipo INFO que indique la IP del cliente que solicitó la petición (variable CGI <code>REMOTE_ADDR</code>), el tipo de petición (variable CGI REQUEST_METHOD), y el tipo de navegador (cabecera <code>User-Agent</code>).</p>
</li>
<li>
<p>El mensaje en conjunto deberá tener el formato siguiente (se incluyen en las plantillas los ficheros de configuración para obtener este formato):</p>
<div class="paragraph">
<p><code>día/mes/año hora:minuto:segundo - texto del mensaje - nueva línea</code></p>
</div>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion03">3. Manejo de Cookies y Sesiones</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Veremos en este tema aspectos sobre el seguimiento de las acciones de los usuarios sobre un sitio web. Para ello veremos cómo trabajar con cookies en los servlets, y cómo manejar información sobre las sesiones de los usuarios.</p>
</div>
<div class="sect2">
<h3 id="_cookies">3.1. Cookies</h3>
<div class="sect3">
<h4 id="_cookies_en_http">3.1.1. Cookies en HTTP</h4>
<div class="paragraph">
<p>Las <strong>cookies</strong> son un mecanismo general mediante el que los programas de un servidor web pueden almacenar información en la parte del cliente de la conexión. Es una forma de añadir estado a las conexiones HTTP, aunque el manejo de cookies no es parte del protocolo HTTP, pero es soportado por la mayoría de los clientes.</p>
</div>
<div class="paragraph">
<p>Las cookies son objetos de tipo: <em>nombre = valor</em>, donde se asigna un <em>valor</em> determinado (una cadena de texto) a una variable del <em>nombre</em> indicado. Dicho objeto es almacenado y recordado por el servidor web y el navegador durante un período de tiempo (indicado como un parámetro interno de la propia <em>cookie</em>). Así, se puede tener una lista de <em>cookies</em> con distintas variables y distintos valores, para almacenar información relevante para cada usuario (se tienen listas de cookies independientes para cada usuario).</p>
</div>
<div class="paragraph">
<p>El funcionamiento es: el servidor, con la cabecera <code>Set-Cookie</code>, envía al cliente información de estado que éste almacenará. Entre la información se encuentra la descripción de los rangos de URLs para los que este estado es válido, de forma que para cualquier petición HTTP a alguna de esas URLs el cliente incluirá esa información de estado, utilizando la cabecera <code>Cookie</code>.</p>
</div>
<div class="paragraph">
<p>La sintaxis de la cabecera <code>Set-Cookie</code> es:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>Set-Cookie: CLAVE1=VALOR1;...;CLAVEN=VALORN [OPCIONES]</code></pre>
</div>
</div>
<div class="paragraph">
<p>donde OPCIONES es una lista opcional con cualquiera de estos atributos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>expires=FECHA;path=PATH;domain=DOMINIO;secure</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Las parejas de <em>CLAVE</em> y <em>VALOR</em> representan la información almacenada en la cookie</p>
</li>
<li>
<p>Los atributos <code>domain</code> y <code>path</code> definen las URL en las que el navegador mostrará la cookie. <code>domain</code> es por defecto el <em>hostname</em> del servidor. El navegador mostrará la cookie cuando acceda a una URL que se empareje correctamente con ambos atributos. Por ejemplo, un atributo <code>domain="eps.ua.es"</code> hará que el navegador muestra la cookie cuando acceda a cualquier URL terminada en <code>"eps.ua.es"</code>. <code>path</code> funciona de forma similar, pero con la parte del path de la URL. Por ejemplo, el path <code>"/foo"</code> hará que el navegador muestre la cookie en todas las URLs que comiencen por <code>"/foo"</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>expires</code> define la fecha a partir de la cual la cookie caduca. La fecha se indica en formato GMT, separando los elementos de la fecha por guiones. Por ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>expires=Wed, 09-Nov-1999 23:12:40 GMT</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>secure</code> hará que la cookie sólo se transmita si el canal de comunicación es seguro (tipo de conexión HTTPS).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Por otra parte, cuando el cliente solicita una URL que empareja con el dominio y path de alguna cookie, envía la cabecera:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>Cookie: CLAVE1=VALOR1;CLAVE2=VALOR2;...;CLAVEN=VALORN</code></pre>
</div>
</div>
<div class="paragraph">
<p>El número máximo de cookies que está garantizado que acepte cualquier navegador es de 300, con un máximo de 20 por cada servidor o dominio (los servlets que se ejecutan en un mismo servidor comparten las cookies). El tamaño máximo de una cookie es de 4096 bytes.</p>
</div>
<div class="paragraph">
<p>En Javascript, por ejemplo, el objeto <code>document.cookie</code> contiene como valor una lista de la forma:</p>
</div>
<div class="paragraph">
<p><code>nombre1=valor1;nombre2=valor2;&#8230;&#8203;;nombreN=valorN</code></p>
</div>
<div class="paragraph">
<p>donde se almacenan así los valores de las cookies que se tengan definidas.</p>
</div>
<div class="paragraph">
<p>Se pueden emplear <code>cookies</code>, entre otras cosas, para:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Identificar a un usuario durante una o varias sesiones</strong>. Por ejemplo, a la hora de realizar compras a través de una tienda web, se almacena su identidad (login y password) como una cookie y se recuerda a lo largo de diferentes visitas qué es lo que lleva almacenado en su cesta de la compra cada usuario.</p>
</li>
<li>
<p><strong>Personalizar un sitio web de acuerdo a las preferencias de cada usuario</strong>: definir el contenido, apariencia, etc, que queremos que tenga una determinada página en función de las preferencias del usuario que la esté visitando.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A la hora de trabajar con cookies, debemos tener en cuenta que nuestro sitio web no debe depender de ellas, puesto que muchos navegadores y usuarios las deshabilitan para evitar problemas de privacidad y otras cuestiones.</p>
</div>
<div class="paragraph">
<p>Veremos ahora cómo trabajar con cookies desde servlets.</p>
</div>
</div>
<div class="sect3">
<h4 id="_enviar_una_cookie">3.1.2. Enviar una cookie</h4>
<div class="paragraph">
<p>Para crear una nueva cookie y enviarla, se siguen los pasos:</p>
</div>
<div class="paragraph">
<p><strong>1. Crear la cookie</strong></p>
</div>
<div class="paragraph">
<p>Las cookies se manejan con la clase <strong><code>Cookie</code></strong>. Se tiene el constructor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-nf">Cookie</span> <span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">,</span> <span class="tok-n">String</span> <span class="tok-n">valor</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>que crea una cookie de nombre <code>nombre</code>, dándole el valor <code>valor</code>.</p>
</div>
<div class="paragraph">
<p><strong>2. Establecer los atributos de la cookie</strong></p>
</div>
<div class="paragraph">
<p>Una vez creada la cookie, podemos establecer los atributos que queramos, con los métodos de la clase <code>Cookie</code>. Por ejemplo, se tienen:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setComment</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">comentario</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setMaxAge</span><span class="tok-o">(</span><span class="tok-kt">int</span> <span class="tok-n">edad</span><span class="tok-o">)</span>
<span class="tok-o">...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El primero asigna una cadena descriptiva sobre la cookie. El segundo indica cuántos segundos de vida tiene. Si es un valor negativo, se borrará la cookie cuando se cierre el navegador. Si el valor es 0, se borra la cookie instantáneamente, y si es positivo, se borrará la cookie cuando pasen los segundos indicados (si cerramos y volvemos a abrir el navegador dentro de ese tiempo, la cookie todavía persistirá). Se tienen otros métodos para establecer atributos de la cookie.</p>
</div>
<div class="paragraph">
<p><strong>3. Enviar la cookie</strong></p>
</div>
<div class="paragraph">
<p>Las cookies se añaden a la cabecera de la respuesta, y se envían así al cliente, mediante el método de <code>HttpServletResponse</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">addCookie</span> <span class="tok-o">(</span><span class="tok-n">Cookie</span> <span class="tok-n">cookie</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Ejemplo</strong></p>
</div>
<div class="paragraph">
<p>Vemos un ejemplo completo de envío de cookie:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">MiServlet</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span>
<span class="tok-o">{</span>
	<span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span> <span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
	                   <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
	                <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
		<span class="tok-n">Cookie</span> <span class="tok-n">miCookie</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Cookie</span> <span class="tok-o">(</span><span class="tok-s">&quot;nombre&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Pepe&quot;</span><span class="tok-o">);</span>
		<span class="tok-n">miCookie</span><span class="tok-o">.</span><span class="tok-na">setMaxAge</span><span class="tok-o">(</span><span class="tok-mi">120</span><span class="tok-o">);</span>
		<span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">addCookie</span><span class="tok-o">(</span><span class="tok-n">miCookie</span><span class="tok-o">);</span>
		<span class="tok-n">PrintWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>
		<span class="tok-o">...</span>
	<span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Hay que tener en cuenta que las cookies son parte de la cabecera HTTP, con lo cual hay que enviarlas ANTES de escribir la respuesta (o antes de obtener el objeto <code>Writer</code> si lo queremos utilizar).</p>
</div>
</div>
<div class="sect3">
<h4 id="_obtener_una_cookie">3.1.3. Obtener una cookie</h4>
<div class="paragraph">
<p>Para obtener una cookie que envía el cliente se trabaja sobre la petición del cliente (<code>HttpServletRequest</code>), siguiendo los pasos:</p>
</div>
<div class="paragraph">
<p><strong>1. Obtener todas las cookies</strong></p>
</div>
<div class="paragraph">
<p>Obtenemos todas las cookies con el método <strong>getCookies()</strong> de la clase <code>HttpServletRequest</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-n">Cookie</span><span class="tok-o">[]</span> <span class="tok-nf">getCookies</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Con esto se tiene un array con todas las cookies actuales para el usuario. Si no hay cookies el método devuelve <code>null</code>.</p>
</div>
<div class="paragraph">
<p><strong>2. Obtener el valor de una cookie</strong></p>
</div>
<div class="paragraph">
<p>Con lo anterior, para obtener el valor de una cookie simplemente recorremos el array de cookies buscando la que concuerde con el nombre que queramos. Pueden	ser útiles los métodos de <code>Cookie</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getName</span><span class="tok-o">()</span>
<span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getValue</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El primero obtiene el nombre de la cookie, y el segundo el valor.</p>
</div>
<div class="paragraph">
<p><strong>Ejemplo</strong></p>
</div>
<div class="paragraph">
<p>Un ejemplo de uso, para obtener el nombre del usuario, guardado en la cookie <code>"nombre"</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span> <span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                   <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
                <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
	<span class="tok-n">Cookie</span><span class="tok-o">[]</span> <span class="tok-n">cookies</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getCookies</span><span class="tok-o">();</span>
	<span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
	<span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-kt">int</span> <span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-o">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-n">cookies</span><span class="tok-o">.</span><span class="tok-na">length</span><span class="tok-o">;</span> <span class="tok-n">i</span><span class="tok-o">++)</span>
		<span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">cookies</span><span class="tok-o">[</span><span class="tok-n">i</span><span class="tok-o">].</span><span class="tok-na">getName</span><span class="tok-o">().</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-s">&quot;nombre&quot;</span><span class="tok-o">))</span>
			<span class="tok-n">nombre</span> <span class="tok-o">=</span> <span class="tok-n">cookies</span><span class="tok-o">[</span><span class="tok-n">i</span><span class="tok-o">].</span><span class="tok-na">getValue</span><span class="tok-o">();</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ejemplo_2">3.1.4. Ejemplo</h4>
<div class="paragraph">
<p>Aquí tenéis un ejemplo de uso de cookies. El servlet <code>ServletCookies</code> cuenta el número de visitas a una página con una cookie que dura 3 minutos.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">ejemplos</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">java.io.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.http.*</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">ServletCookies</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span>
<span class="tok-o">{</span>
   <span class="tok-c1">// Metodo para GET</span>

   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                     <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
                  <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
	<span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setContentType</span><span class="tok-o">(</span><span class="tok-s">&quot;text/html&quot;</span><span class="tok-o">);</span>
	<span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setHeader</span><span class="tok-o">(</span><span class="tok-s">&quot;Cache-Control&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;no-cache&quot;</span><span class="tok-o">);</span>

	<span class="tok-n">Cookie</span><span class="tok-o">[]</span> <span class="tok-n">cookies</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getCookies</span><span class="tok-o">();</span>
	<span class="tok-n">Cookie</span> <span class="tok-n">contador</span> <span class="tok-o">=</span> <span class="tok-n">buscaCookie</span><span class="tok-o">(</span><span class="tok-s">&quot;contador&quot;</span><span class="tok-o">,</span> <span class="tok-n">cookies</span><span class="tok-o">);</span>

	<span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">contador</span> <span class="tok-o">==</span> <span class="tok-kc">null</span><span class="tok-o">)</span>
	<span class="tok-o">{</span>
	   <span class="tok-c1">// Creamos la cookie con el contador</span>

	   <span class="tok-n">Cookie</span> <span class="tok-n">cookie</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Cookie</span> <span class="tok-o">(</span><span class="tok-s">&quot;contador&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;1&quot;</span><span class="tok-o">);</span>
	   <span class="tok-n">cookie</span><span class="tok-o">.</span><span class="tok-na">setMaxAge</span><span class="tok-o">(</span><span class="tok-mi">180</span><span class="tok-o">);</span>
	   <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">addCookie</span><span class="tok-o">(</span><span class="tok-n">cookie</span><span class="tok-o">);</span>

	   <span class="tok-c1">// Mostramos el mensaje de primera visita</span>

	   <span class="tok-n">PrintWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>
	   <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;HTML&gt;&quot;</span><span class="tok-o">);</span>
	   <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;BODY&gt;&quot;</span><span class="tok-o">);</span>
	   <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;Primera visita&quot;</span><span class="tok-o">);</span>
	   <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;BR&gt;&quot;</span><span class="tok-o">);</span>
	   <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;/BODY&gt;&quot;</span><span class="tok-o">);</span>
	   <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;/HTML&gt;&quot;</span><span class="tok-o">);</span>

	<span class="tok-o">}</span> <span class="tok-k">else</span> <span class="tok-o">{</span>

	   <span class="tok-c1">// Obtenemos el valor actual del contador</span>

	   <span class="tok-kt">int</span> <span class="tok-n">cont</span> <span class="tok-o">=</span> <span class="tok-n">Integer</span><span class="tok-o">.</span><span class="tok-na">parseInt</span><span class="tok-o">(</span><span class="tok-n">contador</span><span class="tok-o">.</span><span class="tok-na">getValue</span><span class="tok-o">());</span>
	   <span class="tok-n">cont</span><span class="tok-o">++;</span>

	   <span class="tok-c1">// Modificamos el valor de la cookie</span>
	   <span class="tok-c1">// incrementando el contador</span>

	   <span class="tok-n">Cookie</span> <span class="tok-n">cookie</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Cookie</span> <span class="tok-o">(</span><span class="tok-s">&quot;contador&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;&quot;</span> <span class="tok-o">+</span> <span class="tok-n">cont</span><span class="tok-o">);</span>
	   <span class="tok-n">cookie</span><span class="tok-o">.</span><span class="tok-na">setMaxAge</span><span class="tok-o">(</span><span class="tok-mi">180</span><span class="tok-o">);</span>
	   <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">addCookie</span><span class="tok-o">(</span><span class="tok-n">cookie</span><span class="tok-o">);</span>

	   <span class="tok-c1">// Mostramos el numero de visitas</span>

	   <span class="tok-n">PrintWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>
	   <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;HTML&gt;&quot;</span><span class="tok-o">);</span>
	   <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;BODY&gt;&quot;</span><span class="tok-o">);</span>
	   <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;Visita numero &quot;</span> <span class="tok-o">+</span> <span class="tok-n">cont</span><span class="tok-o">);</span>
	   <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;BR&gt;&quot;</span><span class="tok-o">);</span>
	   <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;/BODY&gt;&quot;</span><span class="tok-o">);</span>
	   <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;/HTML&gt;&quot;</span><span class="tok-o">);</span>
	<span class="tok-o">}</span>
   <span class="tok-o">}</span>

   <span class="tok-c1">// Busca la cookie &#39;nombre&#39;</span>
   <span class="tok-c1">// en el array de cookies indicado.</span>
   <span class="tok-c1">// Devuelve null si no esta</span>

   <span class="tok-kd">private</span> <span class="tok-n">Cookie</span> <span class="tok-nf">buscaCookie</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">,</span>
                              <span class="tok-n">Cookie</span><span class="tok-o">[]</span> <span class="tok-n">cookies</span><span class="tok-o">)</span>
   <span class="tok-o">{</span>
	<span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">cookies</span> <span class="tok-o">==</span> <span class="tok-kc">null</span><span class="tok-o">)</span>
	   <span class="tok-k">return</span> <span class="tok-kc">null</span><span class="tok-o">;</span>

	<span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-kt">int</span> <span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-o">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-n">cookies</span><span class="tok-o">.</span><span class="tok-na">length</span><span class="tok-o">;</span> <span class="tok-n">i</span><span class="tok-o">++)</span>
	   <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">cookies</span><span class="tok-o">[</span><span class="tok-n">i</span><span class="tok-o">].</span><span class="tok-na">getName</span><span class="tok-o">().</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">nombre</span><span class="tok-o">))</span>
		<span class="tok-k">return</span> <span class="tok-n">cookies</span><span class="tok-o">[</span><span class="tok-n">i</span><span class="tok-o">];</span>

	<span class="tok-k">return</span> <span class="tok-kc">null</span><span class="tok-o">;</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_seguimiento_de_sesiones">3.2. Seguimiento de sesiones</h3>
<div class="paragraph">
<p>El seguimiento de sesiones es un mecanismo empleado por los servlets para gestionar un estado sobre las peticiones realizadas desde un mismo cliente (un mismo navegador) a lo largo de un período de tiempo determinado. Las sesiones se comparten por los servlets a los que accede un cliente (algo útil si queremos construir una aplicación basada en múltiples servlets).</p>
</div>
<div class="paragraph">
<p>Para utilizar el seguimiento de sesiones se tienen los pasos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Utilizar una sesión (objeto <code>HttpSession</code>) para un usuario</p>
</li>
<li>
<p>Almacenar u obtener datos del objeto <code>HttpSession</code></p>
</li>
<li>
<p>Opcionalmente, invalidar la sesión</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_obtener_una_sesión">3.2.1. Obtener una sesión</h4>
<div class="paragraph">
<p>El método <strong><code>getSession()</code></strong> del objeto <strong><code>HttpServletRequest</code></strong> obtiene una sesión de usuario.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-n">HttpSession</span> <span class="tok-nf">getSession</span><span class="tok-o">()</span>
<span class="tok-kd">public</span> <span class="tok-n">HttpSession</span> <span class="tok-nf">getSession</span><span class="tok-o">(</span><span class="tok-kt">boolean</span> <span class="tok-n">crear</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El primer método obtiene la sesión actual, o crea una si no existe. Con el segundo método podemos establecer, mediante el flag booleano, si queremos crear una nueva si no existe (<code>true</code>) o no (<code>false</code>). Si la sesión es nueva, el método <code>isNew()</code> del <code>HttpSession</code> devuelve <code>true</code>, y la sesión no tiene ningún dato asociado. Deberemos ir añadiéndole datos tras crearla.</p>
</div>
<div class="paragraph">
<p>Para mantener la sesión de forma adecuada, debemos llamar a <code>getSession()</code> antes de que se escriba nada en la respuesta <code>HttpServletResponse</code> (y si utilizamos un <code>Writer</code>, debemos obtenerla antes de obtener el <code>Writer</code>, no antes de escribir datos).</p>
</div>
<div class="paragraph">
<p>Por ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">MiServlet</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span>
<span class="tok-o">{</span>
	<span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span> <span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
	                   <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
	                <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
		<span class="tok-n">HttpSession</span> <span class="tok-n">sesion</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getSession</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">);</span>
		<span class="tok-o">...</span>
		<span class="tok-n">PrintWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>
		<span class="tok-o">...</span>
	<span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_guardar_y_obtener_datos_de_la_sesión">3.2.2. Guardar y obtener datos de la sesión</h4>
<div class="paragraph">
<p>La interfaz <strong><code>HttpSession</code></strong> proporciona métodos que permiten almacenar y obtener:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Propiedades de la sesión, como por ejemplo su identificador:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getId</span><span class="tok-o">()</span></code></pre>
</div>
</div>
</li>
<li>
<p>Datos de la aplicación, que se almacenan y obtienen como pares nombre-valor, donde el nombre es un <code>String</code> que identifica al dato, y el valor es un <code>Object</code> con el valor asociado. Tendremos que tener cuidado de no sobreescribir datos de un servlet desde otro accidentalmente. Se tienen los métodos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-n">Object</span> <span class="tok-nf">getAttribute</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kt">void</span>   <span class="tok-nf">setAttribute</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">,</span> <span class="tok-n">Object</span> <span class="tok-n">valor</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kt">void</span>   <span class="tok-nf">removeAttribute</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>que obtienen / establecen / eliminan, respectivamente, valores de atributos. Estos métodos eran <code>getValue()</code>, <code>putValue()</code>  y <code>removeValue()</code> hasta la versión 2.2 de servlets. Se tienen además métodos como <code>getAttributeNames()</code> para obtener los nombres de los atributos que se tienen almacenados para la sesión, y otros métodos de utilidad en la clase <code>HttpSession</code>.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Por ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">MiServlet</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span>
<span class="tok-o">{</span>
	<span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span> <span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
	                   <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
	                <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
		<span class="tok-n">HttpSession</span> <span class="tok-n">sesion</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getSession</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">);</span>
		<span class="tok-n">String</span> <span class="tok-n">nombreUsuario</span> <span class="tok-o">=</span>
		   <span class="tok-o">(</span><span class="tok-n">String</span><span class="tok-o">)(</span><span class="tok-n">sesion</span><span class="tok-o">.</span><span class="tok-na">getAttribute</span><span class="tok-o">(</span><span class="tok-s">&quot;nombre&quot;</span><span class="tok-o">));</span>
		<span class="tok-n">sesion</span><span class="tok-o">.</span><span class="tok-na">setAttribute</span><span class="tok-o">(</span><span class="tok-s">&quot;password&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;secreto&quot;</span><span class="tok-o">);</span>
	<span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El ejemplo lee el atributo "nombre" de la sesión, y establece el atributo "password" al valor "secreto".</p>
</div>
</div>
<div class="sect3">
<h4 id="_invalidar_la_sesión">3.2.3. Invalidar la sesión</h4>
<div class="paragraph">
<p>Una sesión de usuario puede invalidarse manualmente, o automáticamente (dependiendo de dónde esté ejecutando el servlet). Esto implica eliminar el objeto <code>HttpSession</code> y sus valores de la memoria. Se tienen los métodos de <code>HttpSession</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kt">int</span> <span class="tok-nf">getMaxInactiveInterval</span><span class="tok-o">()</span>
<span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setMaxInactiveInterval</span><span class="tok-o">(</span><span class="tok-kt">int</span> <span class="tok-n">intervalo</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">invalidate</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para invalidarla automáticamente, la sesión expira cuando transcurre el tiempo indicado por el método <strong><code>getMaxInactiveInterval()</code></strong> entre dos accesos del cliente (en segundos). Se puede establecer dicho valor con <strong><code>setMaxInactiveInterval(&#8230;&#8203;)</code></strong>.</p>
</div>
<div class="paragraph">
<p>Para invalidar manualmente una sesión, se emplea el método <strong><code>invalidate()</code></strong> de la misma. Esto puede ser interesante por ejemplo en comercio electrónico: podemos mantener una sesión donde se vayan acumulando los productos que un usuario quiera comprar, e invalidar la sesión (borrarla) cuando el usuario compre los productos.</p>
</div>
<div class="paragraph">
<p>Por ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">MiServlet</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span>
<span class="tok-o">{</span>
	<span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span> <span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
	                   <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
	                <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
		<span class="tok-n">HttpSession</span> <span class="tok-n">sesion</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getSession</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">);</span>
		<span class="tok-o">...</span>
		<span class="tok-n">sesion</span><span class="tok-o">.</span><span class="tok-na">invalidate</span><span class="tok-o">();</span>
		<span class="tok-o">...</span>
	<span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compatibilidad_con_los_navegadores">3.2.4. Compatibilidad con los navegadores</h4>
<div class="paragraph">
<p>Una alternativa para el seguimiento de sesiones consiste en la <strong>reescritura de URLs</strong>. Con esta técnica, se añaden como parámetros de la URL los datos relativos a la sesión actual, de forma que se van conservando entre las páginas.</p>
</div>
<div class="paragraph">
<p>El seguimiento de sesiones por defecto emplea cookies para almacenar el identificador de una sesión. Para poder utilizar seguimiento de sesiones con usuarios que accedan desde navegadores que no utilicen cookies, los servlets aplican automáticamente la reescritura de URLs cuando no se utilizan cookies.</p>
</div>
<div class="paragraph">
<p>Para poder utilizar esto, debemos codificar todas las URLs que referenciemos. Para esto se emplean los métodos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">encodeURL</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">url</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">encodeRedirectURL</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">url</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El primero se emplea para asociar identificadores con URLs, se utilizará cuando pongamos urls en el contenido de la página que generamos. El segundo se utiliza para asociar identificadores con redirecciones. Lo emplearemos cuando utilicemos métodos <code>sendRedirect()</code>, para codificar la URL que se le pasa. Ambos devuelven la URL sobreescrita si la sobreescritura ha sido necesaria, o la misma URL si no ha sido necesario sobreescribir.</p>
</div>
<div class="paragraph">
<p>Por ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">MiServlet</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span>
<span class="tok-o">{</span>
	<span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span> <span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
	                   <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
	                <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
		<span class="tok-o">...</span>
		<span class="tok-n">String</span> <span class="tok-n">url</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">encodeURL</span><span class="tok-o">(</span>
		   <span class="tok-s">&quot;http://localhost:8080/mipagina.html&quot;</span><span class="tok-o">);</span>
		<span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;a href=\&quot;&quot;</span> <span class="tok-o">+</span> <span class="tok-n">url</span> <span class="tok-o">+</span> <span class="tok-s">&quot;\&quot;&gt;...&lt;/a&gt;&quot;</span><span class="tok-o">);</span>
		<span class="tok-o">...</span>
		<span class="tok-n">String</span> <span class="tok-n">url2</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">encodeRedirectURL</span><span class="tok-o">(</span>
		   <span class="tok-s">&quot;http://otrapagina.com&quot;</span><span class="tok-o">);</span>
		<span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">sendRedirect</span><span class="tok-o">(</span><span class="tok-n">url2</span><span class="tok-o">);</span>
	<span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_oyentes">3.2.5. Oyentes</h4>
<div class="paragraph">
<p>Existen tres tipos de oyentes (<code>listeners</code>) que podemos utilizar en sesiones, para dar respuesta a eventos que produzcan las propias sesiones, o que desde fuera se provoquen sobre las mismas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>HttpSessionListener</code> se emplea para eventos de crear la sesión y terminarla. Tiene los métodos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">sessionCreated</span><span class="tok-o">(</span><span class="tok-n">HttpSessionEvent</span> <span class="tok-n">e</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">sessionDestroyed</span><span class="tok-o">(</span><span class="tok-n">HttpSessionEvent</span> <span class="tok-n">e</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El objeto que implemente esta interfaz ejecutará el código de <code>sessionCreated()</code> cuando se inicie la sesión, y el de <code>sessionDestroyed()</code> cuando se termine. Las clases que implementen este oyente deben llevar la anotación <code>@WebListener</code> en caso de estar utilizando la API de Servlet 3.0, o bien configurarse en el fichero descriptor de la aplicación, mediante etiquetas <strong>&lt;listener&gt;</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;listener&gt;</span>
	<span class="tok-nt">&lt;listener-class&gt;</span>clase<span class="tok-nt">&lt;/listener-class&gt;</span>
<span class="tok-nt">&lt;/listener&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>donde en <strong>&lt;listener-class&gt;</strong> se pone el nombre (completo) de la clase que implementa el listener. Así, el listener se registra, y el servidor ya sabe que tiene que notificarle en los momentos oportunos.</p>
</div>
</li>
<li>
<p><code>HttpSessionBindingListener</code>: si un objeto asociado a una sesión implementa esta interfaz, la sesión se encarga de notificarle de cuándo son añadidos y eliminados de la sesión. Para ello la interfaz tiene los métodos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">valueBound</span><span class="tok-o">(</span><span class="tok-n">HttpSessionBindingEvent</span> <span class="tok-n">e</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">valueUnbound</span><span class="tok-o">(</span><span class="tok-n">HttpSessionBindingEvent</span> <span class="tok-n">e</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El objeto que implemente esta interfaz ejecutará el código de <code>valueBound()</code> cuando la sesión lo añada, y el método <code>valueUnbound()</code> cuando la sesión lo elimine.</p>
</div>
</li>
<li>
<p><code>HttpSessionActivationListener</code>: si un objeto asociado a una sesión implementa esta interfaz, la sesión se encarga de notificarles de cuándo el contenedor cambia la sesión entre máquinas virtuales distintas, para un sistema distribuido. Para ello tiene los métodos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">sessionDidActivate</span><span class="tok-o">(</span><span class="tok-n">HttpSessionEvent</span> <span class="tok-n">e</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">sessionWillPassivate</span><span class="tok-o">(</span><span class="tok-n">HttpSessionEvent</span> <span class="tok-n">e</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El objeto que implemente esta interfaz ejecutará el código de <code>sessionDidActivate()</code> cuando la sesión se active, y <code>sessionWillPassivate()</code> cuando se vuelva pasiva.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_ejemplos_2">3.2.6. Ejemplos</h4>
<div class="paragraph">
<p>Aquí tenéis un ejemplo de uso de sesiones. El servlet <code>ServletSesiones</code> cuenta el número de visitas a una página en una sola sesión (en una sola ventana de navegador).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">ejemplos</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">java.io.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.http.*</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">ServletSesiones</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span> <span class="tok-o">{</span>

    <span class="tok-c1">// Metodo para GET</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                      <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
                   <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
        <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setContentType</span><span class="tok-o">(</span><span class="tok-s">&quot;text/html&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setHeader</span><span class="tok-o">(</span><span class="tok-s">&quot;Cache-Control&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;no-cache&quot;</span><span class="tok-o">);</span>

        <span class="tok-n">HttpSession</span> <span class="tok-n">sesion</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getSession</span><span class="tok-o">();</span>
        <span class="tok-n">PrintWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>

        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">sesion</span><span class="tok-o">.</span><span class="tok-na">isNew</span><span class="tok-o">())</span> <span class="tok-o">{</span>
            <span class="tok-c1">// Mostramos un mensaje de primera visita</span>

            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;HTML&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;BODY&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;Primera visita a la pagina&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;BR&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;/BODY&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;/HTML&gt;&quot;</span><span class="tok-o">);</span>

            <span class="tok-n">sesion</span><span class="tok-o">.</span><span class="tok-na">setAttribute</span><span class="tok-o">(</span><span class="tok-s">&quot;contador&quot;</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-nf">Integer</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">));</span>

        <span class="tok-o">}</span> <span class="tok-k">else</span> <span class="tok-o">{</span>

            <span class="tok-c1">// Mostramos el numero de visitas</span>
            <span class="tok-c1">// y actualizamos el contador</span>

            <span class="tok-kt">int</span> <span class="tok-n">contador</span> <span class="tok-o">=</span> <span class="tok-o">((</span><span class="tok-n">Integer</span><span class="tok-o">)</span>
                <span class="tok-o">(</span><span class="tok-n">sesion</span><span class="tok-o">.</span><span class="tok-na">getAttribute</span><span class="tok-o">(</span><span class="tok-s">&quot;contador&quot;</span><span class="tok-o">))).</span><span class="tok-na">intValue</span><span class="tok-o">();</span>
            <span class="tok-n">contador</span><span class="tok-o">++;</span>

            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;HTML&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;BODY&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;Visita numero &quot;</span> <span class="tok-o">+</span>
                         <span class="tok-n">contador</span> <span class="tok-o">+</span>
                         <span class="tok-s">&quot; a la pagina en esta sesion&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;BR&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;/BODY&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;/HTML&gt;&quot;</span><span class="tok-o">);</span>

            <span class="tok-n">sesion</span><span class="tok-o">.</span><span class="tok-na">setAttribute</span><span class="tok-o">(</span><span class="tok-s">&quot;contador&quot;</span><span class="tok-o">,</span>
                                <span class="tok-k">new</span> <span class="tok-nf">Integer</span><span class="tok-o">(</span><span class="tok-n">contador</span><span class="tok-o">));</span>
	<span class="tok-o">}</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El siguiente servlet utiliza como atributo de sesión una clase interna <code>ObjetoSesion</code>, que implementa la interfaz <code>HttpSessionBindingListener</code>. Dicho objeto tiene dentro un valor entero, y una cadena. Cada vez que el objeto se añade a la sesión se modifica un mensaje de texto, mostrando el valor entero actual del objeto:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">ejemplos</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">java.io.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.http.*</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">EjemploServletListener</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span> <span class="tok-o">{</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                      <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
                   <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
        <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setContentType</span><span class="tok-o">(</span><span class="tok-s">&quot;text/html&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setHeader</span><span class="tok-o">(</span><span class="tok-s">&quot;Cache-Control&quot;</span><span class="tok-o">,</span>
                           <span class="tok-s">&quot;no-cache&quot;</span><span class="tok-o">);</span>

        <span class="tok-n">HttpSession</span> <span class="tok-n">sesion</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getSession</span><span class="tok-o">();</span>
        <span class="tok-n">PrintWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>

        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">sesion</span><span class="tok-o">.</span><span class="tok-na">isNew</span><span class="tok-o">())</span> <span class="tok-o">{</span>
            <span class="tok-c1">// Mostramos mensaje de inicio</span>

            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;HTML&gt;&lt;BODY&gt;&quot;</span> <span class="tok-o">+</span>
                         <span class="tok-s">&quot;Mensaje de inicio&quot;</span> <span class="tok-o">+</span>
                         <span class="tok-s">&quot;&lt;/BODY&gt;&lt;/HTML&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">sesion</span><span class="tok-o">.</span><span class="tok-na">setAttribute</span><span class="tok-o">(</span><span class="tok-s">&quot;contador&quot;</span><span class="tok-o">,</span>
                                <span class="tok-k">new</span> <span class="tok-nf">ObjetoSesion</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">));</span>

        <span class="tok-o">}</span> <span class="tok-k">else</span> <span class="tok-o">{</span>

            <span class="tok-c1">// Mostramos el valor actual del</span>
            <span class="tok-c1">// objeto &quot;contador&quot;</span>

            <span class="tok-kt">int</span> <span class="tok-n">contador</span> <span class="tok-o">=</span> <span class="tok-o">((</span><span class="tok-n">ObjetoSesion</span><span class="tok-o">)</span>
                <span class="tok-o">(</span><span class="tok-n">sesion</span><span class="tok-o">.</span><span class="tok-na">getAttribute</span><span class="tok-o">(</span><span class="tok-s">&quot;contador&quot;</span><span class="tok-o">))).</span><span class="tok-na">getValor</span><span class="tok-o">();</span>
            <span class="tok-n">String</span> <span class="tok-n">mensaje</span> <span class="tok-o">=</span> <span class="tok-o">((</span><span class="tok-n">ObjetoSesion</span><span class="tok-o">)</span>
                <span class="tok-o">(</span><span class="tok-n">sesion</span><span class="tok-o">.</span><span class="tok-na">getAttribute</span><span class="tok-o">(</span><span class="tok-s">&quot;contador&quot;</span><span class="tok-o">))).</span><span class="tok-na">getEnlazado</span><span class="tok-o">();</span>

            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;HTML&gt;&lt;BODY&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;Valor: &quot;</span> <span class="tok-o">+</span> <span class="tok-n">contador</span> <span class="tok-o">+</span>
                         <span class="tok-s">&quot;&lt;br&gt;Enlazado: &quot;</span> <span class="tok-o">+</span> <span class="tok-n">mensaje</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span> <span class="tok-o">(</span><span class="tok-s">&quot;&lt;/BODY&gt;&lt;/HTML&gt;&quot;</span><span class="tok-o">);</span>

            <span class="tok-n">sesion</span><span class="tok-o">.</span><span class="tok-na">setAttribute</span><span class="tok-o">(</span><span class="tok-s">&quot;contador&quot;</span><span class="tok-o">,</span>
                                <span class="tok-k">new</span> <span class="tok-nf">ObjetoSesion</span><span class="tok-o">(</span><span class="tok-n">contador</span><span class="tok-o">+</span><span class="tok-mi">1</span><span class="tok-o">));</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span>

<span class="tok-kd">class</span> <span class="tok-nc">ObjetoSesion</span> <span class="tok-kd">implements</span> <span class="tok-n">HttpSessionBindingListener</span>
<span class="tok-o">{</span>
    <span class="tok-kt">int</span> <span class="tok-n">valor</span><span class="tok-o">;</span>
    <span class="tok-n">String</span> <span class="tok-n">enlazado</span> <span class="tok-o">=</span> <span class="tok-s">&quot;NO&quot;</span><span class="tok-o">;</span>

    <span class="tok-kd">public</span> <span class="tok-nf">ObjetoSesion</span><span class="tok-o">(</span><span class="tok-kt">int</span> <span class="tok-n">valor</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">valor</span> <span class="tok-o">=</span> <span class="tok-n">valor</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">valueBound</span><span class="tok-o">(</span><span class="tok-n">HttpSessionBindingEvent</span> <span class="tok-n">e</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">enlazado</span> <span class="tok-o">=</span> <span class="tok-s">&quot;Objeto enlazado a la sesion &quot;</span> <span class="tok-o">+</span>
                   <span class="tok-n">valor</span> <span class="tok-o">+</span> <span class="tok-s">&quot; veces&quot;</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">valueUnbound</span><span class="tok-o">(</span><span class="tok-n">HttpSessionBindingEvent</span> <span class="tok-n">e</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getEnlazado</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">enlazado</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">int</span> <span class="tok-nf">getValor</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">valor</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si cargamos el servlet por primera vez en la sesión, muestra el mensaje:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>Mensaje de bienvenida</code></pre>
</div>
</div>
<div class="paragraph">
<p>Luego, cada vez que recarguemos el servlet se entrará en el bloque <code>else</code>, y al llamar al método <code>setAttribute()</code> se disparará el método <code>valueBound()</code>, actualizando la cadena. Con esto, con cada recarga se mostrará el mensaje:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>Valor: i
Enlazado: Objeto enlazado a la sesion i veces</code></pre>
</div>
</div>
<div class="paragraph">
<p>siendo <code>i</code> el número de veces que se ha enlazado (que coincide con el número de veces que se ha cargado el servlet, en este caso). Lo esencial aquí es que esta variable <code>enlazado</code> se modifica sólo desde el método <code>valueBound</code>, y éste es llamado sólo cuando el objeto se añade a la sesión.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios_3">3.3. Ejercicios</h3>
<div class="sect3">
<h4 id="_personalizar_un_sitio_web_0_3_puntos">3.3.1. Personalizar un sitio web (0.3 puntos)</h4>
<div class="paragraph">
<p>Una de las utilidades que se le dan a las cookies es la de personalizar sitios Web. La aplicación <code>cweb-sesiones</code> contiene un formulario <code>form_pers.html</code> que le indica al usuario que introduzca su nombre, y elija un color de fondo. Dicho formulario llama después al servlet <code>org.expertojava.cweb.ejercicios.PersonalizaServlet</code>. El formulario también tiene un enlace <em>Ir a página principal</em>, que internamente llama al servlet <code>org.expertojava.cweb.ejercicios.PrincipalServlet</code>. Se pide:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Que en el servlet <code>org.expertojava.cweb.ejercicios.PersonalizaServlet</code> se guarde en dos cookies el nombre del usuario y el valor del color seleccionado. Después, redirigirá a <code>form_pers.html</code> de nuevo.</p>
</li>
<li>
<p>Que el servlet <code>org.expertojava.cweb.ejercicios.PrincipalServlet</code>  (llamado desde el formulario anterior) tome las cookies que le envíe el usuario, y genere una página de bienvenida con el color de fondo que haya en la cookie con el color, y con un mensaje de saludo al nombre que haya en la cookie con el nombre. Para establecer el color de fondo, en el <em>body</em> podemos tener un atributo <em>bgcolor</em>, y ahí le colocaremos el valor que tenga la cookie.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;body</span> <span class="tok-na">bgcolor=</span><span class="tok-s">&quot;red&quot;</span><span class="tok-nt">&gt;</span>
...</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_carro_de_la_compra_0_5_puntos">3.3.2. Carro de la compra (0.5 puntos)</h4>
<div class="paragraph">
<p>La aplicación <code>cweb-sesiones</code> contiene también una página <code>form_carro.html</code> que tiene una lista de artículos para comprar. Para comprarlos, basta con pulsar el botón de "Añadir al carro" correspondiente. Dicho formulario llama al servlet <code>org.expertojava.cweb.ejercicios.CarroServlet</code>. Se pide que dicho servlet almacene como objetos de sesión los objetos que se vayan comprando, y genere una página dinámica con:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Cada uno de los objetos que se llevan comprados hasta ahora en la sesión.</p>
</li>
<li>
<p>Precio total de la compra</p>
</li>
<li>
<p>Un enlace al formulario <code>form_carro.html</code> para seguir comprando.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Para almacenar los objetos podemos utilizar cualquier estructura de datos que queramos
	(<code>ArrayList</code>, etc), y la guardaremos como un atributo de la sesión (es decir, dicha estructura ENTERA
	la guardaremos como UN UNICO atributo de sesión). Guardaremos, para cada artículo, su nombre y su precio
	unitario, para luego mostrar estos dos datos en la página que se genere. Para tomar el nombre del artículo
	y el precio, notar que cada artículo tiene asociado en la página un formulario con dos campos ocultos
	<em>articulo</em> y <em>precio</em>, con estos elementos.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Crear una clase interna en el propio <em>CarroServlet</em> (llamadla <em>ObjetoCarro</em>,
	por ejemplo), que tenga como campos los valores que hay que guardar de cada artículo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">class</span> <span class="tok-nc">ObjetoCarro</span>
<span class="tok-o">{</span>
	<span class="tok-n">String</span> <span class="tok-n">articulo</span><span class="tok-o">;</span>
	<span class="tok-kt">int</span> <span class="tok-n">precio</span><span class="tok-o">;</span>

	<span class="tok-kd">public</span> <span class="tok-nf">ObjetoCarro</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">articulo</span><span class="tok-o">,</span> <span class="tok-kt">int</span> <span class="tok-n">precio</span><span class="tok-o">)</span>
	<span class="tok-o">{</span>
		<span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">articulo</span> <span class="tok-o">=</span> <span class="tok-n">articulo</span><span class="tok-o">;</span>
		<span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">precio</span> <span class="tok-o">=</span> <span class="tok-n">precio</span><span class="tok-o">;</span>
	<span class="tok-o">}</span>

	<span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getArticulo</span><span class="tok-o">()</span>
	<span class="tok-o">{</span>
		<span class="tok-k">return</span> <span class="tok-n">articulo</span><span class="tok-o">;</span>
	<span class="tok-o">}</span>

	<span class="tok-kd">public</span> <span class="tok-kt">int</span> <span class="tok-nf">getPrecio</span><span class="tok-o">()</span>
	<span class="tok-o">{</span>
		<span class="tok-k">return</span> <span class="tok-n">precio</span><span class="tok-o">;</span>
	<span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Después, en el servlet <em>CarroServlet</em>, cada vez que el usuario compre un artículo, creáis un objeto de este tipo con los valores del artículo que haya enviado. Y lo añadís a la sesión, almacenando todos los objetos de tipo <em>ObjetoCarro</em> en una lista.</p>
</div>
</div>
<div class="sect3">
<h4 id="_mejoras_para_el_carro_de_la_compra_0_2_puntos">3.3.3. Mejoras para el carro de la compra (0.2 puntos)</h4>
<div class="paragraph">
<p>Sobre el ejercicio anterior:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Añadid un enlace u opción para invalidar la sesión al llamar a <code>org.expertojava.cweb.ejercicios.CarroServlet</code>. Comprobad que al pincharlo, y luego comprar un artículo, el carro aparecerá sólo con ese artículo.</p>
</li>
<li>
<p>Si quisiéramos aplicar reescritura de URLs en el ejercicio anterior para prevenir que las cookies estén deshabilitadas, ¿qué cambios tendríamos que hacer? Dejadlos reflejados en el código.</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion04">4. Contexto global de la aplicación web</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Vamos a estudiar los elementos que podemos utilizar para establecer
  una comunicación entre los distintos componentes de una aplicación
  web, tanto entre distintos servlets como entre servlets y otros
  elementos de la aplicación.</p>
</div>
<div class="sect2">
<h3 id="_contexto_de_los_servlets">4.1. Contexto de los servlets</h3>
<div class="paragraph">
<p>Comenzaremos estudiando el contexto de los servlets (<em>Servlet Context</em>).
Este objeto de contexto es propio de cada aplicación web, es
decir,   tendremos    un objeto <code>ServletContext</code> por aplicación
web, por  lo que nos servirá    para comunicar los servlets de dicha
aplicación.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">init</span><span class="tok-o">(</span><span class="tok-n">ServletConfig</span> <span class="tok-n">config</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En la inicialización del servlet (método <code>init</code>), se
  nos    proporcionará un objeto <code>ServletConfig</code> como parámetro.
  Mediante    este objeto podemos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Obtener el nombre del servlet, que figurará en el descriptor
de despliegue      de la aplicación web (<code>web.xml</code> en Tomcat).</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">String</span> <span class="tok-n">nombre</span> <span class="tok-o">=</span> <span class="tok-n">config</span><span class="tok-o">.</span><span class="tok-na">getServletName</span><span class="tok-o">();</span></code></pre>
</div>
</div>
</li>
<li>
<p>Obtener los valores de los parámetros de inicialización del
servlet, que se hayan establecido en el descriptor de despliegue. Tanto los
nombres como los valores de los parámetros son cadenas de texto (<code>String</code>).</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">String</span> <span class="tok-n">valor_param</span> <span class="tok-o">=</span> <span class="tok-n">config</span><span class="tok-o">.</span><span class="tok-na">getInitParameter</span><span class="tok-o">(</span><span class="tok-n">nombre_param</span><span class="tok-o">);</span>
<span class="tok-n">Enumeration</span> <span class="tok-n">nombres_params</span> <span class="tok-o">=</span> <span class="tok-n">config</span><span class="tok-o">.</span><span class="tok-na">getInitParameterNames</span><span class="tok-o">();</span></code></pre>
</div>
</div>
</li>
<li>
<p>Acceder al objeto de contexto de la aplicación a la que
pertenece       el servlet.</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">ServletContext</span> <span class="tok-n">context</span> <span class="tok-o">=</span> <span class="tok-n">config</span><span class="tok-o">.</span><span class="tok-na">getServletContext</span><span class="tok-o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Esta última función es la más importante, ya que
nos permite    acceder al objeto de contexto global de la aplicación,
con el que podremos    realizar una serie de operaciones que veremos a continuación.</p>
</div>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="Images/context.gif" alt="Contexto global de los servlets" width="33%">
</div>
</div>
<div class="paragraph">
<p>Tanto el objeto <code>ServletConfig</code> como <code>ServletContext</code>
     pueden ser obtenidos directamente desde dentro de nuestro servlet llamando
  a    los métodos <code>getServletConfig</code> y <code>getServletContext</code> respectivamente, definidos en <code>GenericServlet</code>,
  y por    lo tanto disponibles en cualquier servlet.</p>
</div>
<div class="sect3">
<h4 id="_atributos_de_contexto">4.1.1. Atributos de contexto</h4>
<div class="paragraph">
<p>Dentro del objeto de contexto de nuestra aplicación podremos establecer
     una serie de atributos, que serán globales dentro de ella. Estos
  atributos    son un conjunto de pares <em>&lt;nombre, valor&gt;</em> que
podemos   establecer    y consultar desde los distintos servlets de nuestra
aplicación   web. El    nombre del atributo será una cadena
de texto (<code>String</code>),   mientras    que el valor podrá ser cualquier
objeto java (<code>Object</code>).</p>
</div>
<div class="paragraph">
<p>Para consultar el valor de un atributo utilizaremos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">Object</span> <span class="tok-n">valor</span> <span class="tok-o">=</span> <span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-na">getAttribute</span><span class="tok-o">(</span><span class="tok-n">nombre</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Daremos valor a un atributo con:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-na">setAttribute</span><span class="tok-o">(</span><span class="tok-n">nombre</span><span class="tok-o">,</span> <span class="tok-n">valor</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos también eliminar un atributo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-na">removeAttribute</span><span class="tok-o">(</span><span class="tok-n">nombre</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lo cual dejará el atributo a <code>null</code>, igual que si nunca le
  hubiesemos    asignado un valor. Por último, con</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">Enumeration</span> <span class="tok-kd">enum</span> <span class="tok-o">=</span> <span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-na">getAttributeNames</span><span class="tok-o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Obtenemos la lista de nombres de atributos definidos en el contexto.</p>
</div>
<div class="paragraph">
<p>Hay que hacer notar en este punto, que el objeto de contexto a parte de
  ser    propio de cada aplicación web, es propio de cada máquina
  virtual    Java. Cuando trabajemos en un contexto distribuido, cada máquina
  ejecutará    una VM distinta, por lo que tendrán también
  objetos de contexto    diferentes. Esto hará que si los servlets
de  una aplicación se    alojan en máquinas distintas, tendrán
  contextos distintos y este    objeto ya no nos servirá para comunicarnos
  entre ellos. Veremos más    adelante formas alternativas de comunicación
  para estos casos.</p>
</div>
</div>
<div class="sect3">
<h4 id="_parámetros_de_inicialización">4.1.2. Parámetros de inicialización</h4>
<div class="paragraph">
<p>El objeto <code>ServletConfig</code> nos proporcionaba acceso a los parámetros
     de inicialización del servlet en el que nos encontramos. Con
<code>ServletContext</code>,      tendremos acceso a los parámetros de inicialización
globales   de    nuestra aplicación web. Los métodos para obtener
dichos   parámetros    son análogos a los que usabamos en <code>ServletConfig</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">String</span> <span class="tok-n">valor_param</span> <span class="tok-o">=</span> <span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-na">getInitParameter</span><span class="tok-o">(</span><span class="tok-n">nombre_param</span><span class="tok-o">);</span>
<span class="tok-n">Enumeration</span> <span class="tok-n">nombres_params</span> <span class="tok-o">=</span> <span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-na">getInitParameterNames</span><span class="tok-o">();</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_acceso_a_recursos_estáticos">4.1.3. Acceso a recursos estáticos</h4>
<div class="paragraph">
<p>Este objeto nos permite además acceder a recursos estáticos
  alojados    en nuestro sitio web. Utilizaremos los métodos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">URL</span> <span class="tok-n">url</span> <span class="tok-o">=</span> <span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-na">getResource</span><span class="tok-o">(</span><span class="tok-n">nombre_recurso</span><span class="tok-o">);</span>
<span class="tok-n">InputStream</span> <span class="tok-n">in</span> <span class="tok-o">=</span> <span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-na">getResourceAsStream</span><span class="tok-o">(</span><span class="tok-n">nombre_recurso</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El nombre del recurso que proporcionamos será una cadena que comience
     por <code>"/"</code>, lo cual indica el directorio raiz dentro del contexto
    de nuestra aplicación, por lo tanto serán direcciones relativas
     a la ruta de nuestra aplicación web.</p>
</div>
<div class="paragraph">
<p>El primer método nos devuelve la URL de dicho recurso, mientras
  que    el segundo nos devuelve directamente un flujo de entrada para leer
  dicho recurso.</p>
</div>
<div class="paragraph">
<p>Hay que se&ntilde;alar que esto nos permitirá leer cualquier recurso
     de nuestra aplicación como estático. Es decir, si proporcionamos
     como recurso <code>"/index.jsp"</code>, lo que hará será leer
    el código fuente del JSP, no se obtendrá la salida procesada
  que    genera dicho JSP.</p>
</div>
<div class="paragraph">
<p>Podemos también obtener una lista de recursos de nuestra aplicación
     web, con:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">Set</span> <span class="tok-n">recursos</span> <span class="tok-o">=</span> <span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-na">getResourcePaths</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">ruta</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nos devolverá el conjunto de todos los recursos que haya en la
ruta    indicada (relativa al contexto de la aplicación), o en cualquier
  subdirectorio    de ella.</p>
</div>
</div>
<div class="sect3">
<h4 id="_redirecciones">4.1.4. Redirecciones</h4>
<div class="paragraph">
<p>Si lo que queremos es acceder a recursos dinámicos, el método
     anterior no nos sirve. Para ello utilizaremos estas redirecciones. Utilizaremos
 el objeto <code>RequestDispatcher</code> que nos proporciona  <code>ServletContext</code>.</p>
</div>
<div class="paragraph">
<p>Hemos de distinguir estas redirecciones de la que se producen cuando ejecutamos</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">sendRedirect</span><span class="tok-o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Con <code>sendRedirect</code> lo que estamos haciendo es devolver al cliente
  una    respuesta de redirección. Es decir, será el cliente,
  quien tras    recibir esta respuesta solicite la página a la que
debe  redirigirse.</p>
</div>
<div class="paragraph">
<p>Con <code>RequestDispatcher</code> es el servidor internamente quien solicita
  el    recurso al que nos redirigimos, y devuelve la salida generada por
éste     al cliente, pero todo ello de forma transparente al cliente.
En cliente  no sabrá    en ningún momento que se ha producido
una redirección.</p>
</div>
<div class="paragraph">
<p>Para obtener un objeto <code>RequestDispatcher</code> podemos usar los siguientes
     métodos de <code>ServletContext</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">RequestDispatcher</span> <span class="tok-n">rd</span> <span class="tok-o">=</span> <span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-na">getRequestDispatcher</span><span class="tok-o">(</span><span class="tok-n">ruta</span><span class="tok-o">);</span>
<span class="tok-n">RequestDispatcher</span> <span class="tok-n">rd</span> <span class="tok-o">=</span> <span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-na">getNamedDispatcher</span><span class="tok-o">(</span><span class="tok-n">ruta</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Como ruta proporcionaremos la ruta relativa al contexto de nuestra aplicación,
     comenzando por el carácter <code>"/"</code>, del recurso al que nos
   queramos redirigir. También podemos obtener este objeto proporcionando
     una ruta relativa respecto al recurso actual, utilizando para ello el
 método <code>getRequestDispatcher</code> del objeto <code>ServletRequest</code>,
 en lugar de <code>ServletContext</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">RequestDispatcher</span> <span class="tok-n">rd</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getRequestDispatcher</span><span class="tok-o">(</span><span class="tok-n">ruta</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos utilizar el <code>RequestDispatcher</code> de dos formas distintas:
llamando    a su método <code>include</code> o a <code>forward</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">rd</span><span class="tok-o">.</span><span class="tok-na">include</span><span class="tok-o">(</span><span class="tok-n">request</span><span class="tok-o">,</span> <span class="tok-n">response</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El método <code>include</code> incluirá el contenido generado
por el    recurso al que redireccionamos en la respuesta, permitiendo que
se escriba este    contenido en el objeto <code>ServletResponse</code> a continuación
  de lo que    se haya escrito ya por parte de nuestro servlet. Se podrá
  llamar a este    método en cualquier momento. Lo que no podrá
  hacer el recurso    al que redireccionamos es cambiar las cabeceras de
la   respuesta, ya que lo único    que estamos haciendo es incluir
contenido   en ella. Cualquier intento de cambiar    cabeceras en la llamada
a include   será ignorado.</p>
</div>
<div class="paragraph">
<p>Si hemos realizado la redirección utilizando un método <code>getRequestDispatcher</code>
     (no mediante <code>getNamedDispatcher</code>), en la petición del servlet
  al    que redireccionamos podremos acceder a los siguientes atributos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">javax</span><span class="tok-o">.</span><span class="tok-na">servlet</span><span class="tok-o">.</span><span class="tok-na">include</span><span class="tok-o">.</span><span class="tok-na">request_uri</span>
<span class="tok-n">javax</span><span class="tok-o">.</span><span class="tok-na">servlet</span><span class="tok-o">.</span><span class="tok-na">include</span><span class="tok-o">.</span><span class="tok-na">context_path</span>
<span class="tok-n">javax</span><span class="tok-o">.</span><span class="tok-na">servlet</span><span class="tok-o">.</span><span class="tok-na">include</span><span class="tok-o">.</span><span class="tok-na">servlet_path</span>
<span class="tok-n">javax</span><span class="tok-o">.</span><span class="tok-na">servlet</span><span class="tok-o">.</span><span class="tok-na">include</span><span class="tok-o">.</span><span class="tok-na">path_info</span>
<span class="tok-n">javax</span><span class="tok-o">.</span><span class="tok-na">servlet</span><span class="tok-o">.</span><span class="tok-na">include</span><span class="tok-o">.</span><span class="tok-na">query_string</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Con los que podrá consultar la ruta desde donde fué invocado.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">rd</span><span class="tok-o">.</span><span class="tok-na">forward</span><span class="tok-o">(</span><span class="tok-n">request</span><span class="tok-o">,</span> <span class="tok-n">response</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El método <code>forward</code> sólo podrá ser invocado
cuando    todavía no se ha escrito nada en la respuesta del servlet.
Esto es así    porque esta llamada devolverá únicamente
la salida del objeto    al que nos redirigimos. Si esto no fuese así,
  se produciría una    excepción <code>IllegalStateException</code>.
  Una vez el método <code>forward</code>    haya devuelto el control, la
salida  ya habrá sido escrita completamente    en la respuesta.</p>
</div>
<div class="paragraph">
<p>Si el recurso al que redireccionamos utiliza direcciones relativas, estás
     direcciones se considerarán relativas al servlet que ha hecho
la  redirección,    por lo que si se encuentran en rutas distintas
se producirá un error.    Tenemos que hacer que las direcciones sean
relativas a la raiz del servidor    para que funcione correctamente (direcciones
que comiencen por <code>"/"</code>).</p>
</div>
</div>
<div class="sect3">
<h4 id="_otros_métodos">4.1.5. Otros métodos</h4>
<div class="paragraph">
<p>La clase <code>ServletContext</code> nos proporciona otros métodos de
  utilidad,    que podremos consultar accediendo a su documentación
 JavaDoc.</p>
</div>
<div class="paragraph">
<p>Un método de interés es <code>log</code>, que nos permite escribir
     texto en el fichero de log del servlet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-na">log</span><span class="tok-o">(</span><span class="tok-n">mensaje</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Esto será util para tener un registro de eventos que ocurren en nuestra
  web, o bien para depurar errores.</p>
</div>
</div>
<div class="sect3">
<h4 id="_listeners_de_contexto">4.1.6. Listeners de contexto</h4>
<div class="paragraph">
<p>Existen objetos que permanecen a la escucha de los distintos eventos que pueden
  ocurrir en el objeto de contexto de servlets, <code>ServletContext</code>.</p>
</div>
<div class="paragraph">
<p>Un primer listener, es el <code>ServletContextListener</code>, que nos permitirá
  dar respuesta a los eventos de creación y destrucción del contexto
  del servlet. El código para este listener será como sigue a continuación:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.*</span><span class="tok-o">;</span>

<span class="tok-nd">@WebListener</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">MiContextListener</span> <span class="tok-kd">implements</span> <span class="tok-n">ServletContextListener</span> <span class="tok-o">{</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">contextDestroyed</span><span class="tok-o">(</span><span class="tok-n">ServletContextEvent</span> <span class="tok-n">sce</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-c1">// Destruccion del contexto</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">contextInitialized</span><span class="tok-o">(</span><span class="tok-n">ServletContextEvent</span> <span class="tok-n">sce</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-c1">// Inicialización del contexto</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Esto nos será de gran utilidad si necesitamos inicializar ciertas
estructuras de datos que van a utilizar varios servlets. De esta forma el
contexto se habrá inicializado antes de que los servlets puedan ejecutarse.</p>
</div>
<div class="paragraph">
<p>Si lo que queremos es saber cuando se ha a&ntilde;adido, eliminado, o modificado
alguno de los atributos del contexto global, podemos utilizar un listener
<code>ServletContextAttributeListener</code>. Los métodos que deberemos
definir en este caso son los siguientes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.*</span><span class="tok-o">;</span>

<span class="tok-nd">@WebListener</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">MiContextAttributeListener</span>
                    <span class="tok-kd">implements</span> <span class="tok-n">ServletContextAttributeListener</span> <span class="tok-o">{</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">attributeAdded</span><span class="tok-o">(</span><span class="tok-n">ServletContextAttributeEvent</span> <span class="tok-n">scae</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-c1">// Se ha a&amp;ntilde;adido un nuevo atributo</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">attributeRemoved</span><span class="tok-o">(</span><span class="tok-n">ServletContextAttributeEvent</span> <span class="tok-n">scae</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-c1">// Se ha eliminado un atributo</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">attributeReplaced</span><span class="tok-o">(</span><span class="tok-n">ServletContextAttributeEvent</span> <span class="tok-n">scae</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-c1">// Un atributo ha cambiado de valor</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Hemos visto que podemos declarar <em>listeners</em> mediante la anotación
<code>@WebListener</code>. Con esto el servidor de aplicaciones reconocerá estas clases
como <em>listeners</em> del contenedor web y los registrará de forma automática sin necesidad de hacerlo
nosotros. Los <em>listeners</em> que podremos declarar de esta forma son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ServletContextListener</code></p>
</li>
<li>
<p><code>ServletContextAttributeListener</code></p>
</li>
<li>
<p><code>ServletRequestListener</code></p>
</li>
<li>
<p><code>ServletRequestAttributeListener</code></p>
</li>
<li>
<p><code>HttpSessionListener</code></p>
</li>
<li>
<p><code>HttpSessionAttributeListener</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Sin embargo, esta anotación sólo está disponible a partir de la API de Servlets 3.0. En versiones anteriores
para hacer que estos objetos se registren como listeners y permanezcan
a la escucha, deberemos registrarlos como tales en el descriptor de despliegue
de la aplicación (<code>web.xml</code>.). Para ello deberemos a&ntilde;adir un elemento <em>&lt;listener&gt;</em>
para cada objeto listener que queramos registrar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;listener&gt;</span>
    <span class="tok-nt">&lt;listener-class&gt;</span>MiContextListener<span class="tok-nt">&lt;/listener-class&gt;</span>
<span class="tok-nt">&lt;/listener&gt;</span>

<span class="tok-nt">&lt;listener&gt;</span>
    <span class="tok-nt">&lt;listener-class&gt;</span>MiContextAttributeListener<span class="tok-nt">&lt;/listener-class&gt;</span>
<span class="tok-nt">&lt;/listener&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Esta declaración no es necesaria si estamos utilizando la anotación <code>@WebListener</code> en
Servlet 3.0.</p>
</div>
</div>
<div class="sect3">
<h4 id="_declaración_dinámica_de_servlets">4.1.7. Declaración dinámica de servlets</h4>
<div class="paragraph">
<p>En Servlet 3.0 también tenemos la opción de configurar nuestros servlets de forma
programática durante la inicialización del contexto, e incluso declarar
servlets que no habían sido declarados previamente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@WebListener</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">MiListener</span> <span class="tok-kd">implements</span> <span class="tok-n">ServletContextListener</span> <span class="tok-o">{</span>
  <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">contextInitialized</span> <span class="tok-o">(</span><span class="tok-n">ServletContextEvent</span> <span class="tok-n">sce</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-n">ServletContext</span> <span class="tok-n">sc</span> <span class="tok-o">=</span> <span class="tok-n">sce</span><span class="tok-o">.</span><span class="tok-na">getServletContext</span><span class="tok-o">();</span>

    <span class="tok-c1">// Declara un nuevo servlet y lo configura</span>
    <span class="tok-n">ServletRegistration</span> <span class="tok-n">servletNuevo</span> <span class="tok-o">=</span> <span class="tok-n">sc</span><span class="tok-o">.</span><span class="tok-na">addServlet</span><span class="tok-o">(</span><span class="tok-s">&quot;miServlet&quot;</span><span class="tok-o">,</span>
      <span class="tok-s">&quot;es.ua.jtech.servlet.MiServlet&quot;</span><span class="tok-o">);</span>
    <span class="tok-n">servletNuevo</span><span class="tok-o">.</span><span class="tok-na">addMapping</span><span class="tok-o">(</span><span class="tok-s">&quot;/UrlServlet&quot;</span><span class="tok-o">);</span>

    <span class="tok-c1">// Obtiene un servlet ya declarado para configurarlo</span>
    <span class="tok-n">ServletRegistration</span> <span class="tok-n">sr</span> <span class="tok-o">=</span> <span class="tok-n">sc</span><span class="tok-o">.</span><span class="tok-na">addServlet</span><span class="tok-o">(</span><span class="tok-s">&quot;otroServlet&quot;</span><span class="tok-o">);</span>
    <span class="tok-n">sr</span><span class="tok-o">.</span><span class="tok-na">addMapping</span><span class="tok-o">(</span><span class="tok-s">&quot;/UrlOtroServlet&quot;</span><span class="tok-o">);</span>
    <span class="tok-n">sr</span><span class="tok-o">.</span><span class="tok-na">setInitParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;param1&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;valor1&quot;</span><span class="tok-o">);</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por lo tanto, en Servlet 3.0 podemos declarar los servlets de tres
formas distintas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>En el descriptor de despliegue <code>web.xml</code>.</p>
</li>
<li>
<p>Mediante anotaciones en la propia clase del servlet.</p>
</li>
<li>
<p>De forma programática en la inicialización del contexto.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_inyección_de_dependencias">4.2. Inyección de dependencias</h3>
<div class="paragraph">
<p>Los objetos de una aplicación normalmente necesitan otros objetos para realizar su tarea. Por ejemplo, un servlet
puede necesitar una fuente de datos de la que obtener la información a mostrar al cliente web. Tradicionalmente,
este servlet deberá obtener el objeto del que depende, por ejemplo buscando la fuente de datos en JNDI. El
patrón de inyección de dependencias (DI) consiste en invertir este comportamiento: no será el servlet quién busque
la fuende de datos, sino que la fuente de datos le será inyectada al servlet de forma externa. Las ventajas de este
patrón son el bajo acoplamiento existente entre el servlet y los objetos de los que depende, y la facilidad
para cambiar la implementación de la dependencia sin tener que modificar el código del servlet. Por ejemplo, esto
facilitará las pruebas, ya que podremos sustituir la fuente de datos original por un <em>mock</em> sin tener
que hacer ningún cambio en el código del servlet.</p>
</div>
<div class="paragraph">
<p>En Java SE 6 se integra la inyección de dependencias mediante la especificación <em>Contexts and Dependency
Injection</em> (CDI, JSR-299). La implementación de referencia de CDI se denomina Weld
(<a href="http://seamframework.org/Weld" class="bare">http://seamframework.org/Weld</a>).</p>
</div>
<div class="sect3">
<h4 id="_configuración_de_weld">4.2.1. Configuración de Weld</h4>
<div class="paragraph">
<p>Weld ya se encuentra integrado en la API de Java EE 7, por lo que no es necesario añadir esta librería como dependencia de forma explícita, a no ser que estuviésemos utilizando un contenedor web que no soporte la especificación completa de Java EE.</p>
</div>
<div class="paragraph">
<p>Para poder utilizar objetos CDI deberemos añadir un fichero <code>beans.xml</code> al directorio
<code>WEB-INF</code> de nuestra aplicación web. Dicho fichero puede estar vacío, pero al menos debe existir. Si no
queremos dejarlo vacío, podemos utilizar la siguiente plantilla inicial:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tok-nt">&lt;beans</span> <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://java.sun.com/xml/ns/javaee&quot;</span>
       <span class="tok-na">xmlns:xsi=</span><span class="tok-s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
       <span class="tok-na">xsi:schemaLocation=</span><span class="tok-s">&quot;http://java.sun.com/xml/ns/javaee</span>
<span class="tok-s">       http://java.sun.com/xml/ns/javaee/beans_1_0.xsd&quot;</span><span class="tok-nt">&gt;</span>
<span class="tok-nt">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Podemos crear este fichero desde IntelliJ pulsando con el botón derecho sobre el directorio <code>WEB-INF</code> y seleccionando <em>New &gt; XML Configuration File &gt; CDI beans.xml</em>.
</td>
</tr>
</table>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="Images/faces-config.png" alt="Creación del fichero beans.xml con IntelliJ" width="100%">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_managed_beans">4.2.2. Managed beans</h4>
<div class="paragraph">
<p>Podemos inyectar distintos tipos de objetos, como fuentes de datos, contextos
de persistencia JPA, o casi cualquier objeto Java plano (POJOs). Nos referiremos a los objetos que inyectamos como
<em>managed beans</em>.</p>
</div>
<div class="paragraph">
<p>Casi cualquier clase Java puede ser un <em>managed bean</em>, sin ser necesario anotarla de ninguna forma.
Para que una clase pueda comportarse como <em>managed bean</em> debe cumplir lo siguiente:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>No puede ser una clase interna, a no ser que sea de tipo <code>static</code>.</p>
</li>
<li>
<p>Tiene un constructor sin parámetros.</p>
</li>
<li>
<p>No tiene constructor sin parámetros, pero tiene un constructor anotado con <code>@Inject</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Por ejemplo, el siguiente POJO podría ser inyectado como <em>managed bean</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">HolaMundo</span> <span class="tok-o">{</span>
    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">saluda</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-s">&quot;Hola &quot;</span> <span class="tok-o">+</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_inyección_de_objetos">4.2.3. Inyección de objetos</h4>
<div class="paragraph">
<p>Para inyectar un <em>bean</em> utilizamos la etiqueta <code>@Inject</code>. Vamos a ver el caso en el que se inyecta
en un servlet, aunque podría inyectarse en cualquier otra clase (incluso dentro de otro <em>managed bean</em>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@WebServlet</span><span class="tok-o">(</span><span class="tok-n">urlPatterns</span> <span class="tok-o">=</span> <span class="tok-s">&quot;/miServlet&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">MiServlet</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span> <span class="tok-o">{</span>
    <span class="tok-nd">@Inject</span>
    <span class="tok-kd">private</span> <span class="tok-n">HolaMundo</span> <span class="tok-n">holaMundo</span><span class="tok-o">;</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El tiempo de vida del objeto inyectado dependerá del ámbito en el que se defina.</p>
</div>
</div>
<div class="sect3">
<h4 id="_Ámbito_de_los_beans">4.2.4. Ámbito de los beans</h4>
<div class="paragraph">
<p>Los <em>managed beans</em> pueden existir en distintos ámbitos. Según el ámbito especificado mantendrá su estado
durante un tiempo diferente:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33%;">
<col style="width: 66%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Ámbito</th>
<th class="tableblock halign-left valign-top">Descripción</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@RequestScoped</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Se mantiene durante el tiempo que dure la petición (<code>request</code>) actual. Sólo será accesible por
la petición actual.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@SessionScoped</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Se mantiene durante el tiempo que dure la sesión (<code>session</code>) actual. Será accesible por todas
las peticiones que se hagan dentro de la sesión actual.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@ApplicationScoped</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Se mantiene durante toda la vida de la aplicación web (contexto). Será accesible por todas las peticiones de
todas las sesiones.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Dependent</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Es el valor por defecto. Se mantiene con vida mientras exista el objeto en el que se ha inyectado.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Por ejemplo, podemos etiquetar el <em>bean</em> anterior para que sólo se mantenga con vida durante el tiempo
que dure la petición de la siguiente forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@RequestScoped</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">HolaMundo</span> <span class="tok-o">{</span>
    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">saluda</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-s">&quot;Hola &quot;</span> <span class="tok-o">+</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Para que un <em>managed bean</em> anotado con <code>@SessionScoped</code> funcione correctamente
deberemos hacer que sea <code>Serializable</code>. De no ser así, obtendremos el mensaje de error
<em>Managed bean declaring a passivating scope must be passivation capable</em>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_clasificadores">4.2.5. Clasificadores</h4>
<div class="paragraph">
<p>Podemos crear varias versiones de un <em>bean</em>, y distinguirlas mediante lo que se conoce como clasificadores (<code>qualifiers</code>).
Podemos definir clasificadores de la siguiente forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Qualifier</span>
<span class="tok-nd">@Retention</span><span class="tok-o">(</span><span class="tok-n">RUNTIME</span><span class="tok-o">)</span>
<span class="tok-nd">@Target</span><span class="tok-o">({</span><span class="tok-n">TYPE</span><span class="tok-o">,</span> <span class="tok-n">METHOD</span><span class="tok-o">,</span> <span class="tok-n">FIELD</span><span class="tok-o">,</span> <span class="tok-n">PARAMETER</span><span class="tok-o">})</span>
<span class="tok-kd">public</span> <span class="tok-nd">@interface</span> <span class="tok-n">Dia</span> <span class="tok-o">{}</span>

<span class="tok-nd">@Qualifier</span>
<span class="tok-nd">@Retention</span><span class="tok-o">(</span><span class="tok-n">RUNTIME</span><span class="tok-o">)</span>
<span class="tok-nd">@Target</span><span class="tok-o">({</span><span class="tok-n">TYPE</span><span class="tok-o">,</span> <span class="tok-n">METHOD</span><span class="tok-o">,</span> <span class="tok-n">FIELD</span><span class="tok-o">,</span> <span class="tok-n">PARAMETER</span><span class="tok-o">})</span>
<span class="tok-kd">public</span> <span class="tok-nd">@interface</span> <span class="tok-n">Tarde</span> <span class="tok-o">{}</span>

<span class="tok-nd">@Qualifier</span>
<span class="tok-nd">@Retention</span><span class="tok-o">(</span><span class="tok-n">RUNTIME</span><span class="tok-o">)</span>
<span class="tok-nd">@Target</span><span class="tok-o">({</span><span class="tok-n">TYPE</span><span class="tok-o">,</span> <span class="tok-n">METHOD</span><span class="tok-o">,</span> <span class="tok-n">FIELD</span><span class="tok-o">,</span> <span class="tok-n">PARAMETER</span><span class="tok-o">})</span>
<span class="tok-kd">public</span> <span class="tok-nd">@interface</span> <span class="tok-n">Noche</span> <span class="tok-o">{}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Podríamos crear distintas versiones del <em>bean</em> <code>HolaMundo</code>, y etiquetar cada una de ellas con
un clasificador distinto:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Dia</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">HolaMundoDia</span> <span class="tok-kd">extends</span> <span class="tok-n">HolaMundo</span> <span class="tok-o">{</span>
    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">saluda</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-s">&quot;Buenos días &quot;</span> <span class="tok-o">+</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span>

<span class="tok-nd">@Tarde</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">HolaMundoTarde</span> <span class="tok-kd">extends</span> <span class="tok-n">HolaMundo</span> <span class="tok-o">{</span>
    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">saluda</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-s">&quot;Buenas tardes &quot;</span> <span class="tok-o">+</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span>

<span class="tok-nd">@Noche</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">HolaMundoNoche</span> <span class="tok-kd">extends</span> <span class="tok-n">HolaMundo</span> <span class="tok-o">{</span>
    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">saluda</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-s">&quot;Buenas noches &quot;</span> <span class="tok-o">+</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si un <em>bean</em> no lleva clasificador, se entiende que por defecto tiene el clasificador <code>@Default</code>.
También podemos etiquetar alguna de las versiones de forma explícita con este clasificador por defecto.</p>
</div>
<div class="paragraph">
<p>Cuando inyectamos el <em>bean</em>, podemos indicar qué versión queremos inyectar mediante el clasificador:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@WebServlet</span><span class="tok-o">(</span><span class="tok-n">urlPatterns</span> <span class="tok-o">=</span> <span class="tok-s">&quot;/miServlet&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">ItemServlet</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span> <span class="tok-o">{</span>
    <span class="tok-nd">@Inject</span> <span class="tok-nd">@Tarde</span>
    <span class="tok-kd">private</span> <span class="tok-n">HolaMundo</span> <span class="tok-n">holaMundo</span><span class="tok-o">;</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si no indicamos clasificador, se buscará la versión <code>@Default</code>, de la misma forma que si hiciésemos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@WebServlet</span><span class="tok-o">(</span><span class="tok-n">urlPatterns</span> <span class="tok-o">=</span> <span class="tok-s">&quot;/miServlet&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">ItemServlet</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span> <span class="tok-o">{</span>
    <span class="tok-nd">@Inject</span> <span class="tok-nd">@Default</span>
    <span class="tok-kd">private</span> <span class="tok-n">HolaMundo</span> <span class="tok-n">holaMundo</span><span class="tok-o">;</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_productores">4.2.6. Productores</h4>
<div class="paragraph">
<p>Podemos definir métodos que produzcan objetos para ser inyectados. De esta forma podemos definir la forma de
obtener los objetos a inyectar. Hasta ahora, al inyectar un objeto lo que se hacía era construir una nueva instancia
del objeto utilizando alguno de sus constructores, e inyectar dicha instancia. Utilizando un método productor
podremos construir los objetos de otras formas.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, nos puede ser útil para definir una fuente de datos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-nd">@interface</span> <span class="tok-n">FuenteDatos</span> <span class="tok-o">{}</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">ProductorConexiones</span> <span class="tok-o">{</span>
    <span class="tok-nd">@Produces</span> <span class="tok-nd">@FuenteDatos</span>
    <span class="tok-kd">public</span> <span class="tok-n">Connection</span> <span class="tok-nf">getConnection</span><span class="tok-o">()</span> <span class="tok-kd">throws</span> <span class="tok-n">Exception</span> <span class="tok-o">{</span>
        <span class="tok-n">Context</span> <span class="tok-n">ctx</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">InitialContext</span><span class="tok-o">();</span>
        <span class="tok-n">DataSource</span> <span class="tok-n">ds</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-n">DataSource</span><span class="tok-o">)</span> <span class="tok-n">ctx</span><span class="tok-o">.</span><span class="tok-na">lookup</span><span class="tok-o">(</span><span class="tok-s">&quot;jdbc/miBD&quot;</span><span class="tok-o">);</span>
        <span class="tok-k">return</span> <span class="tok-n">ds</span><span class="tok-o">.</span><span class="tok-na">getConnection</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos inyectar las conexiones producidas por la anterior fuente de datos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Inject</span> <span class="tok-nd">@FuenteDatos</span> <span class="tok-n">Connection</span> <span class="tok-n">conexion</span><span class="tok-o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>De esta forma inyectamos objetos <code>Connection</code> generados por una fuente de datos, que no son
instanciados utilizando un constructor, sino una factoría, y que por lo tanto no podían ser inyectados
como se ha visto anteriormente.</p>
</div>
</div>
<div class="sect3">
<h4 id="_definición_de_alternativas">4.2.7. Definición de alternativas</h4>
<div class="paragraph">
<p>Podemos definir distintas implementaciones alternativas para los <em>beans</em> a inyectar, de forma que en tiempo
de despliegue podamos cambiar la implementación que se va a utilizar. Esto es especialmente útil para la implementación
de pruebas. Por ejemplo, si tenemos el siguiente <em>bean</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">FuenteDatos</span> <span class="tok-kd">implements</span> <span class="tok-n">IFuenteDatos</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos definir una implementación alternativa que contenga un <code>mock</code> para realizar pruebas:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Alternative</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">MockFuenteDatos</span> <span class="tok-kd">implements</span> <span class="tok-n">IFuenteDatos</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por defecto siempre se utilizará la implementación original, a no ser que en el fichero <code>beans.xml</code>
indiquemos el nombre de la implementación alternativa:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-o">&lt;</span><span class="tok-n">beans</span> <span class="tok-n">xmlns</span><span class="tok-o">=</span><span class="tok-s">&quot;http://java.sun.com/xml/ns/javaee&quot;</span>
       <span class="tok-nl">xmlns:</span><span class="tok-n">xsi</span><span class="tok-o">=</span><span class="tok-s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
       <span class="tok-nl">xsi:</span><span class="tok-n">schemaLocation</span><span class="tok-o">=</span><span class="tok-s">&quot;</span>
<span class="tok-s">                 http://java.sun.com/xml/ns/javaee</span>
<span class="tok-s">                 http://java.sun.com/xml/ns/javaee/beans_1_0.xsd&quot;</span><span class="tok-o">&gt;</span>
    <span class="tok-o">&lt;</span><span class="tok-n">alternatives</span><span class="tok-o">&gt;</span>
        <span class="tok-o">&lt;</span><span class="tok-n">class</span><span class="tok-o">&gt;</span><span class="tok-n">es</span><span class="tok-o">.</span><span class="tok-na">ua</span><span class="tok-o">.</span><span class="tok-na">jtech</span><span class="tok-o">.</span><span class="tok-na">MockFuenteDatos</span><span class="tok-o">&lt;/</span><span class="tok-n">class</span><span class="tok-o">&gt;</span>
    <span class="tok-o">&lt;/</span><span class="tok-n">alternatives</span><span class="tok-o">&gt;</span>
<span class="tok-o">&lt;/</span><span class="tok-n">beans</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En este caso, para usar el <em>mock</em> deberemos incluir el fichero <code>beans.xml</code> que así lo indique.
También podemos crear la clase alternativa como una especialización:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Specializes</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">MockFuenteDatos</span> <span class="tok-kd">extends</span> <span class="tok-n">FuenteDatos</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En este caso la especialización siempre sustituirá a la original. De esta forma, si incluimos la especialización
en el carpeta de fuente de prueba (<em>test</em>), cuando incluyamos dichas clases en la aplicación siempre se usará
el <em>mock</em>, mientras que en el caso de compilar únicamente las clases de la carpeta <em>main</em> para
poner la aplicación en producción, se utilizará la implementación original. Esta es una forma sencilla de sustituir
clases por <em>mock</em> en nuestras pruebas.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios_4">4.3. Ejercicios</h3>
<div class="sect3">
<h4 id="_ejemplo_de_contexto_0_puntos">4.3.1. Ejemplo de contexto (0 puntos)</h4>
<div class="paragraph">
<p>Vamos a probar la aplicación <code>cweb-contexto</code>
  incluida en los ejercicios de la sesión.</p>
</div>
<div class="paragraph">
<p><em>a)</em> Desplegar la aplicación web en Tomcat, y acceder a la dirección:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>http://localhost:8080/cweb-contexto</code></pre>
</div>
</div>
<div class="paragraph">
<p>Veremos la aplicación web ya en marcha.</p>
</div>
<div class="paragraph">
<p><em>b)</em> La aplicación web nos permite visualizar los atributos de contexto
    definidos y sus valores, y a&ntilde;adir nuevos atributos. A parte de los
    atributos que nosotros a&ntilde;adimos manualmente, &iquest;hay más
    atributos de contexto definidos?</p>
</div>
<div class="paragraph">
<p><em>c)</em> Podemos a&ntilde;adir nuevos atributos de contexto. Daremos un nombre
    del atributo, y un texto que contendrá como valor. Además como
    valor también se introducirá el identificador de sesión
    del navegador que haya creado dicho atributo. Abrir distintos navegadores
    y a&ntilde;adir atributos de contexto desde cada
    uno. Comprobar que en cada navegador vemos tanto los atributos creados en
    su sesión, como lo atributos creados creados en las sesiones de otros
    navegadores (el identificador de sesión será distinto).</p>
</div>
<div class="paragraph">
<p><em>d)</em> Si nos fijamos en el paquete <code>org.expertojava.cweb.contexto.listener</code>, veremos
    que se ha a&ntilde;adido un listener sobre los atributos del contexto. Este
    listener imprime mensajes en el <em>log</em> indicando cuando se a&ntilde;ade,
    elimina o reemplaza un atributo de contexto. Comprobar en el fichero de logs
    correspondiente que se han registrado los cambios en los atributos que hayamos hecho.</p>
</div>
</div>
<div class="sect3">
<h4 id="_chat_con_servlets_0_7_punto">4.3.2. Chat con servlets (0.7 punto)</h4>
<div class="paragraph">
<p>Vamos a realizar una aplicación de chat utilizando
   servlets. En el directorio <code>cweb-chat</code> de los fuentes de la
sesión    podrás encontrar la base sobre la que construiremos
el chat. Cada mensaje    de chat estará encapsulado en la clase <code>Mensaje</code>,
y la    lista de mensajes actual del chat se encontrará en la clase
<code>ColaMensajes</code>.</p>
</div>
<div class="paragraph">
<p>Además se proporcionan los ficheros HTML necesarios
   para la aplicación. El fichero <code>index.html</code> contiene
el    formulario de login para que un usuario introduzca el <em>nick</em>
con el que    entrará en el chat (no se solicita ningún password
para validar).    El login se hará efectivo por el servlet <code>LoginUsuarioServlet</code>
   también proporcionado, que introducirá el <em>nick</em>
del usuario    en la información de sesión y nos redirigirá
al chat. En    el subdirectorio <code>chat</code> tendremos los ficheros estáticos del chat:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>chatFrames.html</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Página principal de los frames de la aplicación chat. Mostrará un frame con el formulario para enviar mensajes, y otro con la lista de mensajes enviados.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>enviaMensaje.html</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Formulario para enviar mensajes al chat.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>error.html</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Página que nos muestra un mensaje de error cuando se intenta enviar un mensaje sin haber hecho <em>login</em>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cabecera.htmlf</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cabecera de la tabla de mensajes, a incluir al comienzo de la página de lista de mensajes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pie.htmlf</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pie de la tabla de mensajes, a incluir al final de la página de lista de mensajes.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Ahora deberemos implementar los servlets para el envio de mensajes y
para    la consulta de la lista de mensajes enviados. Se pide:</p>
</div>
<div class="paragraph">
<p><em>a)</em> La cola de mensajes será el objeto común al que acceden
     los servlets para el envio y la consulta de estos mensajes. Por lo tanto
el      objeto deberá a&ntilde;adirse como atributo del contexto.
Esto lo tendremos      que hacer antes de que cualquier servlet se haya ejecutado.
Para ello debemos      crear un objeto <code>ServletContextListener</code>
que en la creación      del contexto inicialice la cola de mensajes
(<code>ColaMensajes</code>)      y la introduzca como atributo en el
contexto global (atributo <code>org.expertojava.cweb.chat.mensajes</code>).</p>
</div>
<div class="paragraph">
<p><em>b)</em> Una vez tenemos creada la cola de mensajes, deberemos implementar el servlet
    <code>EnviaMensajeServlet</code>, que tome un mensaje como parámetro (el nombre
    del parámetro es <code>texto</code>), y lo a&ntilde;ada a la lista de mensajes
    con el nick del usuario actual (obtenido del atributo <code>org.expertojava.cweb.chat.nick</code> de la
    sesión). Una vez enviado el mensaje, mostraremos en la salida el contenido
    de <code>enviaMensaje.html</code>, mediante un objeto <code>RequestDispatcher</code>. Si
    no hubiese ningún usuario en la sesión, no se registrará el mensaje y se deberá
    redirigir la salida a <code>error.html</code></p>
</div>
<div class="paragraph">
<p><em>c)</em> Por último, deberemos implementar el servlet <code>ListaMensajesServlet</code>
    que mostrará todos los mensajes del chat. Este servlet debe:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Para que la lista de mensajes se actualice periodicamente en el cliente, haremos que se recargue cada 5 segundos. Añadir la cabecera HTTP correspondiente a la respuesta para que esto ocurra (cabecera <code>Refresh</code>, indicando como valor el número de segundos que tardará en recargar).</p>
</li>
<li>
<p>Incluir el contenido del fichero estático <code>cabecera.htmlf</code> al comienzo del documento generado, y <code>pie.htmlf</code> al final, para enmarcar la zona donde aparecen los mensajes del chat.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Se debe obtener el <code>PrintWriter</code> para escribir la respuesta antes de hacer el
primer <code>include</code>, ya que de lo contrario se obtendría una excepción de tipo <code>IllegalStateException</code>.
Esto de debido a que el <code>include</code> ya habría obtenido previamente el flujo de salida de la respuesta.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Obtener el <em>nick</em> del usuario actual de la sesión. Los mensajes enviados con este <em>nick</em> se mostrarán en negrita, el resto se mostrarán de forma normal.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>d)</em> Comprobar que el chat funciona correctamente. Conectar desde varios
clientes      a un mismo servidor.</p>
</div>
</div>
<div class="sect3">
<h4 id="_inyección_de_dependencias_0_3_puntos">4.3.3. Inyección de dependencias (0.3 puntos)</h4>
<div class="paragraph">
<p>Utiliza inyección de dependencias para gestionar la cola de mensajes del chat anterior. En este caso:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Deberás configurar correctamente los ficheros <code>web.xml</code> y <code>beans.xml</code>.</p>
</li>
<li>
<p>Deberás crear un <em>bean</em> que gestione la cola de mensajes del chat.</p>
</li>
<li>
<p>Deberás especificar el ámbito adecuado en el <em>bean</em> anterior.</p>
</li>
<li>
<p>Ya no será necesario utilizar un <em>listener</em> del contexto para inicializarla, se inicializará la
primera vez que se inyecte.</p>
</li>
<li>
<p>Ya no será necesario acceder al atributo de contexto con la cola de mensajes. La cola será inyectada en los servlets.</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion05">5. WebSocket</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hasta el momento hemos visto los servlets como un componente web que encapsula el mecanismo petición/respuesta definido en el protocolo HTTP. Sin embargo, en muchas ocasiones nos interesa mantener un canal de comunicación abierto con el servidor, para así poder recibir información del mismo sin tener que interrogarlo mediante peticiones continuamete.</p>
</div>
<div class="paragraph">
<p>Pongamos por ejemplo el caso de una aplicación de chat, en la que el cliente debe estar pendiente de actualizar el listado de mensajes cuando otros usuarios realicen una publicación. Con protocolo HTTP tendríamos que estar continuamente realizando peticiones (por ejemplo mediante AJAX) para comprobar si hay nuevos mensajes, y en tal caso actualizar la lista. Si la frecuencia de peticiones es alta estaremos malgastando ancho de banda, pero si es baja tendremos un mayor retraso en la actualización de los mensajes. Este es un escenario donde es conveniente utilizar WebSocket en lugar de HTTP.</p>
</div>
<div class="sect2">
<h3 id="_websocket_en_java_ee">5.1. WebSocket en Java EE</h3>
<div class="paragraph">
<p>La API JSR 356 (Java API for WebSocket) nos permite crear <em>endpoints</em> WebSocket dentro de una aplicación web Java EE. Esta API se define dentro del paquete <code>javax.websocket</code>, cuya clase principal es <code>Endpoint</code>, la cual nos permitirá crear un <em>endpoint</em> de tipo WebSocket, aunque también podremos crear <em>endpoints</em> añadiendo anotaciones a cualquier clase Java.</p>
</div>
<div class="sect3">
<h4 id="_endpoints_programados">5.1.1. Endpoints programados</h4>
<div class="paragraph">
<p>Se crean mediante una subclase de <code>Endpoint</code>, en la que tendremos que sobrescribir los métodos de su ciclo de vida:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>onOpen</code>: Es el <strong>único método obligatorio</strong> de implementar. Indica que se ha abierto el canal de comunicación.</p>
</li>
<li>
<p><code>onClose</code>: Indica que se ha cerrado el canal de comunicación.</p>
</li>
<li>
<p><code>onError</code>: Indica un error en la conexión</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">MiEndpoint</span> <span class="tok-kd">extends</span> <span class="tok-n">Endpoint</span> <span class="tok-o">{</span> <i class="conum" data-value="1"></i><b>(1)</b>
   <span class="tok-nd">@Override</span>
   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">onOpen</span><span class="tok-o">(</span><span class="tok-kd">final</span> <span class="tok-n">Session</span> <span class="tok-n">session</span><span class="tok-o">,</span> <span class="tok-n">EndpointConfig</span> <span class="tok-n">config</span><span class="tok-o">)</span> <span class="tok-o">{</span> <i class="conum" data-value="2"></i><b>(2)</b>
      <span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-na">addMessageHandler</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-n">MessageHandler</span><span class="tok-o">.</span><span class="tok-na">Whole</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-o">&gt;()</span> <span class="tok-o">{</span> <i class="conum" data-value="3"></i><b>(3)</b>
         <span class="tok-nd">@Override</span>
         <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">onMessage</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">msg</span><span class="tok-o">)</span> <span class="tok-o">{</span> <i class="conum" data-value="4"></i><b>(4)</b>
            <span class="tok-c1">// Interactuar con el objeto session para intercambiar datos</span>
            <span class="tok-o">...</span>
         <span class="tok-o">}</span>
      <span class="tok-o">});</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>La clase debe heredar de <code>Endpoint</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Debemos sobrescribir de forma obligatoria al menos el método <code>onOpen</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Normalmente definiremos un manejador de mensajes sobre la sesión (<code>MessageHandler</code>)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>En el manejador de mensajes debemos definir el método <code>onMessage</code> que nos notifica la llegada de un mensaje</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Todos los métodos anteriores reciben como parámetro un objeto <code>Session</code> que representa la conversación con el cliente. Normalmente definiremos un <code>MessageHandler</code> sobre la sesión para gestionar el intercambio de mensajes. Este manejador nos permite definir un método <code>onMessage</code> que nos notificará la llegada de un mensaje desde el cliente.</p>
</div>
<div class="paragraph">
<p>El despliegue de este tipo de <em>endpoints</em> se hace también de forma programada. Para ello deberemos introducir el siguiente código:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">ServerEndpointConfig</span><span class="tok-o">.</span><span class="tok-na">Builder</span><span class="tok-o">.</span><span class="tok-na">create</span><span class="tok-o">(</span><span class="tok-n">MiEndpoint</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-s">&quot;/socket&quot;</span><span class="tok-o">).</span><span class="tok-na">build</span><span class="tok-o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Con esto el <em>endpoint</em> quedará publicado en la siguiente dirección:</p>
</div>
<div class="paragraph">
<p>ws://localhost:8080/miaplicacion/socket</p>
</div>
</div>
<div class="sect3">
<h4 id="_endpoints_mediante_anotaciones">5.1.2. Endpoints mediante anotaciones</h4>
<div class="paragraph">
<p>Una forma más sencilla de crear <em>endpoints</em> consiste en hacerlo mediante anotaciones. Podemos crear un <em>endpoint</em> equivalente al anterior mediante anotaciones con el siguiente código:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@ServerEndpoint</span><span class="tok-o">(</span><span class="tok-s">&quot;/socket&quot;</span><span class="tok-o">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">EchoEndpoint</span> <span class="tok-o">{</span>
   <span class="tok-nd">@OnMessage</span> <i class="conum" data-value="2"></i><b>(2)</b>
   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">onMessage</span><span class="tok-o">(</span><span class="tok-n">Session</span> <span class="tok-n">session</span><span class="tok-o">,</span> <span class="tok-n">String</span> <span class="tok-n">msg</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-c1">// Interactuar con el objeto session para intercambiar datos</span>
      <span class="tok-o">...</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Un <em>endpoint</em> se declara con la anotación <code>ServerEndpoint</code>, que además nos permite especificar la dirección de despliegue</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>El método <code>onMessage</code> se puede definir mediante una anotación directamente. No es necesario crear un manejador de mensajes.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Lo más destacable es que ya no es necesario realizar el despliegue de forma programada. Con añadir la anotación <code>ServetEndpoint</code> y como atributo suyo la dirección de despliegue el <em>endpoint</em> quedará desplegado en el servidor.</p>
</div>
<div class="paragraph">
<p>También es importante destacar que disponemos de las siguientes anotaciones para los métodos:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Anotación</th>
<th class="tableblock halign-left valign-top">Descripción</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@OnOpen</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Se llama al abrirse el canal de datos</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@OnClose</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Se llama al cerrarse el canal de datos</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@OnError</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Se llama al producirse un error en la comunicación</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@OnMessage</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Se llama al recibirse un mensaje</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>A continuación se muestra un ejemplo de <em>endpoint</em> con los 4 tipos de métodos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@ServerEndpoint</span><span class="tok-o">(</span><span class="tok-s">&quot;/socket&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">EchoEndpoint</span> <span class="tok-o">{</span>

   <span class="tok-nd">@OnOpen</span>
   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">open</span><span class="tok-o">(</span><span class="tok-n">Session</span> <span class="tok-n">session</span><span class="tok-o">,</span>
                    <span class="tok-n">EndpointConfig</span> <span class="tok-n">conf</span><span class="tok-o">)</span> <span class="tok-o">{</span>
   <span class="tok-o">}</span>

   <span class="tok-nd">@OnClose</span>
   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">close</span><span class="tok-o">(</span><span class="tok-n">Session</span> <span class="tok-n">session</span><span class="tok-o">,</span>
                     <span class="tok-n">CloseReason</span> <span class="tok-n">reason</span><span class="tok-o">)</span> <span class="tok-o">{</span>
   <span class="tok-o">}</span>

   <span class="tok-nd">@OnError</span>
   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">error</span><span class="tok-o">(</span><span class="tok-n">Session</span> <span class="tok-n">session</span><span class="tok-o">,</span>
                     <span class="tok-n">Throwable</span> <span class="tok-n">error</span><span class="tok-o">)</span> <span class="tok-o">{</span>
   <span class="tok-o">}</span>

   <span class="tok-nd">@OnMessage</span>
   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">onMessage</span><span class="tok-o">(</span><span class="tok-n">Session</span> <span class="tok-n">session</span><span class="tok-o">,</span>
                         <span class="tok-n">String</span> <span class="tok-n">msg</span><span class="tok-o">)</span> <span class="tok-o">{</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos observar que en todos ellos siempre se proporciona como primer parámetro el objeto <code>Session</code>. El segundo parámetro dependerá del método.</p>
</div>
</div>
<div class="sect3">
<h4 id="_mantenimiento_del_estado">5.1.3. Mantenimiento del estado</h4>
<div class="paragraph">
<p>Al contrario que los <em>servlets</em>, los <em>endpoints</em> WebSocket se instancian una vez por cada cliente conectado. De esta forma podemos utilizar la misma clase del <em>endpoint</em> para mantener el estado del cliente. Tenemos dos formas de guardar datos de estado:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Utilizar variables de instancia de la clase que implementa el <em>endpoint</em>.</p>
</li>
<li>
<p>Utilizar el mapa <code>session.getUserProperties()</code> para guardar la información en forma de parejas <em>&lt;clave, valor&gt;</em>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_intercambio_de_mensajes">5.2. Intercambio de mensajes</h3>
<div class="paragraph">
<p>Vamos a pasar a estudiar la forma de intercambiar información mediante WebSocket. Las operaciones básicas de intercambio de datos que encontramos en WebSocket son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Envío de datos (de texto o binarios)</p>
</li>
<li>
<p><em>Ping</em>: Mensaje de control, puede contener datos</p>
</li>
<li>
<p><em>Pong</em>: Respuesta al <em>ping</em>, puede contener datos</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_envío_de_mensajes">5.2.1. Envío de mensajes</h4>
<div class="paragraph">
<p>Para enviar un mensaje necesitaremos siempre un objeto <code>Session</code>. Todos los métodos anotados nos proporcionan este objeto como parámetro, por lo que al recibir un mensaje de entrada en <code>onMessage</code> podremos responder utilizando el objeto <code>Session</code> que proporciona como parámetro. En caso de que necesitemos enviar mensajes que no sean respuesta a un mensaje de entrada deberemos guardar el objeto <code>Session</code> en una variable de instancia de nuestra clase en <code>onOpen</code> para así tenerlo disponible en cualquier momento.</p>
</div>
<div class="paragraph">
<p>A partir del objeto <code>Session</code> deberemos obtener un objeto <code>RemoteEndpoint</code> para enviar el mensaje al <em>endpoint</em> remoto. Encontramos dos tipos de <code>RemoteEndpoint</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Básico</strong>: Se define mediante la clase <code>RemoteEndpoint.Basic</code>, y se obtiene con <code>session.getRemoteBasic()</code>.</p>
</li>
<li>
<p><strong>Asíncrono</strong>: Se define mediante la clase <code>RemoteEndpoint.Async</code>, y se obtiene con <code>session.getRemoteAsync()</code>. Permite realizar las operaciones de forma no bloqueante.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Contamos con las siguientes operaciones para intercambiar datos:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Operación</th>
<th class="tableblock halign-left valign-top">Descripción</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sendText(String)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Envia un mensaje de texto al <em>endpoint</em> remoto de forma bloqueante o no bloqueante (según el tipo de <code>RemoteEndpoint</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sendBinary(ByteBuffer)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Envia un mensaje binario al <em>endpoint</em> remoto de forma bloqueante o no bloqueante (según el tipo de <code>RemoteEndpoint</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sendPing(ByteBuffer)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Envía un <em>ping</em> al <em>endpoint</em> remoto</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sendPong(ByteBuffer)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contesta con un <em>pong</em> al <em>endpoint</em> remoto</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Por ejemplo, podremos enviar un mensaje de texto de la siguiente forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@ServerEndpoint</span><span class="tok-o">(</span><span class="tok-s">&quot;/socket&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">MiEndpoint</span> <span class="tok-o">{</span>
   <span class="tok-nd">@OnMessage</span>
   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">onMessage</span><span class="tok-o">(</span><span class="tok-n">Session</span> <span class="tok-n">session</span><span class="tok-o">,</span> <span class="tok-n">String</span> <span class="tok-n">msg</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-na">getBasicRemote</span><span class="tok-o">().</span><span class="tok-na">sendText</span><span class="tok-o">(</span><span class="tok-s">&quot;Recibido &quot;</span> <span class="tok-o">+</span> <span class="tok-n">msg</span><span class="tok-o">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Envía un mensaje de texto al <em>endpoint</em> remoto.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Podemos también enviar un mensaje a todos los <em>endpoints</em> remotos conectados actualmente a nuestro <em>endpoint</em>. Para ello podemos utilizar el método <code>getOpenSessions</code> del objeto <code>Session</code>, que nos proporciona la lista de todas las sesiones abiertas. Esto será útil por ejemplo en una aplicación de chat, en la que al recibir un mensaje de un cliente deberemos difundirlo a todos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@ServerEndpoint</span><span class="tok-o">(</span><span class="tok-s">&quot;/chat&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">ChatEndpoint</span> <span class="tok-o">{</span>
   <span class="tok-nd">@OnMessage</span>
   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">onMessage</span><span class="tok-o">(</span><span class="tok-n">Session</span> <span class="tok-n">session</span><span class="tok-o">,</span> <span class="tok-n">String</span> <span class="tok-n">msg</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-k">try</span> <span class="tok-o">{</span>
         <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">Session</span> <span class="tok-n">s</span> <span class="tok-o">:</span> <span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-na">getOpenSessions</span><span class="tok-o">())</span> <span class="tok-o">{</span>
            <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">s</span><span class="tok-o">.</span><span class="tok-na">isOpen</span><span class="tok-o">())</span>
               <span class="tok-n">s</span><span class="tok-o">.</span><span class="tok-na">getBasicRemote</span><span class="tok-o">().</span><span class="tok-na">sendText</span><span class="tok-o">(</span><span class="tok-n">msg</span><span class="tok-o">);</span>
         <span class="tok-o">}</span>
      <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">IOException</span> <span class="tok-n">e</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-o">}</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_recepción_de_mensajes">5.2.2. Recepción de mensajes</h4>
<div class="paragraph">
<p>Podemos recibir tres tipos de mensajes, según el tipo de parámetros del método etiquetado como <code>@OnMessage</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Mensajes de texto (<code>String</code>, <code>Reader</code>)</p>
</li>
<li>
<p>Mensajes binarios (<code>byte[]</code>, <code>ByteBuffer</code>, <code>InputStream</code>)</p>
</li>
<li>
<p>Mensajes <em>pong</em> (<code>PongMessage</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A continuación se muestra un ejemplo de <em>endpoint</em> que puede recibir los tres tipos de mensajes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@ServerEndpoint</span><span class="tok-o">(</span><span class="tok-s">&quot;/socket&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">ReceiveEndpoint</span> <span class="tok-o">{</span>
   <span class="tok-nd">@OnMessage</span>
   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">texto</span><span class="tok-o">(</span><span class="tok-n">Session</span> <span class="tok-n">session</span><span class="tok-o">,</span> <span class="tok-n">String</span> <span class="tok-n">msg</span><span class="tok-o">)</span> <span class="tok-o">{</span> <i class="conum" data-value="1"></i><b>(1)</b>
   <span class="tok-o">}</span>

   <span class="tok-nd">@OnMessage</span>
   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">binario</span><span class="tok-o">(</span><span class="tok-n">Session</span> <span class="tok-n">session</span><span class="tok-o">,</span> <span class="tok-n">ByteBuffer</span> <span class="tok-n">msg</span><span class="tok-o">)</span> <span class="tok-o">{</span> <i class="conum" data-value="2"></i><b>(2)</b>
   <span class="tok-o">}</span>

   <span class="tok-nd">@OnMessage</span>
   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">pong</span><span class="tok-o">(</span><span class="tok-n">Session</span> <span class="tok-n">session</span><span class="tok-o">,</span> <span class="tok-n">PongMessage</span> <span class="tok-n">msg</span><span class="tok-o">)</span> <span class="tok-o">{</span> <i class="conum" data-value="3"></i><b>(3)</b>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Recepción de un mensaje de texto</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Recepción de un mensaje binario</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Recepción de una respuesta <em>pong</em></td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_conversión_entre_java_y_mensajes_websocket">5.3. Conversión entre Java y mensajes WebSocket</h3>
<div class="paragraph">
<p>Aunque los mensajes que se intercambian se limitan a ser de tipo texto o tipo binario, podemos definir un mapeo entre nuestros objetos Java y una determinada codificación (JSON, XML, etc) de forma que se realice una conversión automática entre el mensaje WebSocket y una clase Java. Esto lo haremos definiendo objetos <code>Encoder</code> que definan la forma de realizar la conversión de Java a WebSocket, y objetos <code>Decoder</code> que realicen la conversión en el sentido inverso.</p>
</div>
<div class="paragraph">
<p>Imaginemos que tenemos una aplicación que trabaja con películas, que constan de título, director y duración. Podemos tener una clase Java como la siguiente para encapsular los datos de cada película:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Pelicula</span> <span class="tok-o">{</span>
   <span class="tok-n">String</span> <span class="tok-n">titulo</span><span class="tok-o">;</span>
   <span class="tok-n">String</span> <span class="tok-n">director</span><span class="tok-o">;</span>
   <span class="tok-kt">int</span> <span class="tok-n">duracion</span><span class="tok-o">;</span>

   <span class="tok-c1">// Getters y setters</span>
   <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_encoders">5.3.1. Encoders</h4>
<div class="paragraph">
<p>Podríamos definir un <code>Encoder</code> que transforme un objeto de nuestra clase <code>Pelicula</code> en texto (<code>Encoder.Text</code>) o en binario (<code>Encoder.Binary</code>). Vamos a ver un ejemplo en el que transformamos la película a texto con formato <em>&lt;titulo&gt;;&lt;director&gt;;&lt;duracion&gt;</em>, por lo que utilizaremos un objeto de tipo <code>Encoder.Text</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">PeliculaAJsonEncoder</span> <span class="tok-kd">implements</span> <span class="tok-n">Encoder</span><span class="tok-o">.</span><span class="tok-na">Text</span><span class="tok-o">&lt;</span><span class="tok-n">Pelicula</span><span class="tok-o">&gt;</span> <span class="tok-o">{</span>
   <span class="tok-nd">@Override</span>
   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">init</span><span class="tok-o">(</span><span class="tok-n">EndpointConfig</span> <span class="tok-n">ec</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-o">}</span>

   <span class="tok-nd">@Override</span>
   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">destroy</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-o">}</span>

   <span class="tok-nd">@Override</span>
   <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">encode</span><span class="tok-o">(</span><span class="tok-n">Pelicula</span> <span class="tok-n">p</span><span class="tok-o">)</span> <span class="tok-kd">throws</span> <span class="tok-n">EncodeException</span> <span class="tok-o">{</span>
      <span class="tok-n">String</span> <span class="tok-n">msg</span> <span class="tok-o">=</span> <span class="tok-n">p</span><span class="tok-o">.</span><span class="tok-na">getTitulo</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-s">&quot;;&quot;</span> <span class="tok-o">+</span>
                   <span class="tok-n">p</span><span class="tok-o">.</span><span class="tok-na">getDirector</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-s">&quot;;&quot;</span> <span class="tok-o">+</span>
                   <span class="tok-n">p</span><span class="tok-o">.</span><span class="tok-na">getDuracion</span><span class="tok-o">();</span>
      <span class="tok-k">return</span> <span class="tok-n">msg</span><span class="tok-o">;</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_decoders">5.3.2. Decoders</h4>
<div class="paragraph">
<p>Con un <code>Decoder</code> realizaremos la operación inversa: transformamos un mensaje WebSocket en un objeto Java. Siguiendo con el ejemplo anterior, podríamos transformar un mensaje JSON son los datos de un libro en un objeto <code>Libro</code> definiendo el siguiente <code>Decoder</code>, también de tipo <code>Decoder.Text</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">JsonAPeliculaDecoder</span> <span class="tok-kd">implements</span> <span class="tok-n">Decoder</span><span class="tok-o">.</span><span class="tok-na">Text</span><span class="tok-o">&lt;</span><span class="tok-n">Pelicula</span><span class="tok-o">&gt;</span> <span class="tok-o">{</span>
   <span class="tok-nd">@Override</span>
   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">init</span><span class="tok-o">(</span><span class="tok-n">EndpointConfig</span> <span class="tok-n">ec</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-o">}</span>

   <span class="tok-nd">@Override</span>
   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">destroy</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-o">}</span>

   <span class="tok-nd">@Override</span>
   <span class="tok-kd">public</span> <span class="tok-n">Pelicula</span> <span class="tok-nf">decode</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">string</span><span class="tok-o">)</span> <span class="tok-kd">throws</span> <span class="tok-n">DecodeException</span> <span class="tok-o">{</span> <i class="conum" data-value="1"></i><b>(1)</b>
      <span class="tok-n">String</span> <span class="tok-o">[]</span> <span class="tok-n">items</span> <span class="tok-o">=</span> <span class="tok-n">string</span><span class="tok-o">.</span><span class="tok-na">split</span><span class="tok-o">(</span><span class="tok-s">&quot;;&quot;</span><span class="tok-o">);</span>
      <span class="tok-n">Pelicula</span> <span class="tok-n">p</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Pelicula</span><span class="tok-o">();</span>
      <span class="tok-n">p</span><span class="tok-o">.</span><span class="tok-na">setTitulo</span><span class="tok-o">(</span><span class="tok-n">items</span><span class="tok-o">[</span><span class="tok-mi">0</span><span class="tok-o">]);</span>
      <span class="tok-n">p</span><span class="tok-o">.</span><span class="tok-na">setDirector</span><span class="tok-o">(</span><span class="tok-n">items</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">]);</span>
      <span class="tok-n">p</span><span class="tok-o">.</span><span class="tok-na">setDuracion</span><span class="tok-o">(</span><span class="tok-n">Integer</span><span class="tok-o">.</span><span class="tok-na">parseInt</span><span class="tok-o">(</span><span class="tok-n">items</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">]);</span>

      <span class="tok-k">return</span> <span class="tok-n">p</span><span class="tok-o">;</span>
   <span class="tok-o">}</span>

   <span class="tok-nd">@Override</span>
   <span class="tok-kd">public</span> <span class="tok-kt">boolean</span> <span class="tok-nf">willDecode</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">string</span><span class="tok-o">)</span> <span class="tok-o">{</span> <i class="conum" data-value="2"></i><b>(2)</b>
      <span class="tok-kt">boolean</span> <span class="tok-n">mensajeValido</span> <span class="tok-o">=</span> <span class="tok-n">string</span><span class="tok-o">.</span><span class="tok-na">matches</span><span class="tok-o">(</span><span class="tok-s">&quot;[A-Za-z0-9]+;[A-Za-z0-9]+;[0-9]+&quot;</span><span class="tok-o">);</span>
      <span class="tok-k">return</span> <span class="tok-n">mensajeValido</span><span class="tok-o">;</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Debemos transformar la cadena de texto en nuestro objeto Java</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Debemos comprobar si la cadena de texto tiene el formato correcto</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Sólo podemos definir un único <code>Decoder</code> para todos los mensajes de texto. Si fuese posible recibir más de un tipo de objeto deberemos crear una superclase para todos los tipos de mensaje, y crearemos el <code>Decoder</code> para el tipo de la superclase. Dentro del <code>Decoder</code> deberemos distinguir de qué tipo es el mensaje y devolver la instancia adecuada. Por ejemplo, si además de <code>Pelicula</code> tuviesemos <code>Libro</code> y <code>Disco</code>, tendríamos que hacer que todas ellas heredasen de una misma clase, por ejemplo <code>Articulo</code> (<code>Pelicula extends Articulo</code>). El <em>decoder</em> tendría que definirse en este caso del tipo <code>Decoder.Text&lt;Articulo&gt;</code>, y dentro del método <code>decode</code> en función del tipo de mensaje detectado instanciaríamos y devolveríamos la subclase correcta.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_uso_de_em_encoders_em_y_em_decoders_em">5.3.3. Uso de <em>encoders</em> y <em>decoders</em></h4>
<div class="paragraph">
<p>Una vez definidos el <code>Encoder</code> y el <code>Decoder</code>, deberemos añadirlos a la anotación <code>ServerEndpoint</code> para que la operación de conversión se realice de forma automática:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@ServerEndpoint</span><span class="tok-o">(</span>
   <span class="tok-n">value</span> <span class="tok-o">=</span> <span class="tok-s">&quot;/socket&quot;</span><span class="tok-o">,</span>
   <span class="tok-n">encoders</span> <span class="tok-o">=</span> <span class="tok-o">{</span> <span class="tok-n">PeliculaAJsonEncoder</span><span class="tok-o">.</span><span class="tok-na">class</span> <span class="tok-o">}</span> <i class="conum" data-value="1"></i><b>(1)</b>
   <span class="tok-n">decoders</span> <span class="tok-o">=</span> <span class="tok-o">{</span> <span class="tok-n">JsonAPeliculaDecoder</span><span class="tok-o">.</span><span class="tok-na">class</span> <span class="tok-o">}</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">MiEndpoint</span> <span class="tok-o">{</span>
   <span class="tok-nd">@OnMessage</span>
   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">libro</span><span class="tok-o">(</span><span class="tok-n">Session</span> <span class="tok-n">session</span><span class="tok-o">,</span> <span class="tok-n">Pelicula</span> <span class="tok-n">p</span><span class="tok-o">)</span> <span class="tok-o">{</span> <i class="conum" data-value="3"></i><b>(3)</b>
      <span class="tok-n">Pelicula</span> <span class="tok-n">nuevaPelicula</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Pelicula</span><span class="tok-o">();</span>
      <span class="tok-n">nuevaPelicula</span><span class="tok-o">.</span><span class="tok-na">setTitulo</span><span class="tok-o">(</span><span class="tok-s">&quot;Copia de &quot;</span> <span class="tok-o">+</span> <span class="tok-n">p</span><span class="tok-o">.</span><span class="tok-na">getTitulo</span><span class="tok-o">());</span>
      <span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-na">getBasicRemote</span><span class="tok-o">.</span><span class="tok-na">sendObject</span><span class="tok-o">(</span><span class="tok-n">nuevaPelicula</span><span class="tok-o">);</span> <i class="conum" data-value="4"></i><b>(4)</b>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declaramos el <code>Encoder</code> en la anotación <code>ServerEndpoint</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Declaramos el <code>Decoder</code> en la anotación <code>ServerEndpoint</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Podemos utilizar <code>Libro</code> como tipo de datos del mensaje recibido en <code>@OnMessage</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Podemos enviar directamente objetos <code>Libro</code> con <code>sendObject</code></td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_parámetros_del_em_path_em_y_de_la_em_query_em">5.4. Parámetros del <em>path</em> y de la <em>query</em></h3>
<div class="paragraph">
<p>Al mapear el <em>endpoint</em> a una URL podemos especificar segmentos variables del <em>path</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@ServerEndpoint</span><span class="tok-o">(</span><span class="tok-s">&quot;/tiempo/{cp}&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">TiempoEndpoint</span> <span class="tok-o">{</span>
   <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>De esta forma podremos acceder al <em>endpoint</em> con diferentes URLs, siempre que cumplan el patrón anterior (el segmento <code>{cp}</code> puede tomar cualquier valor):</p>
</div>
<div class="paragraph">
<p><a href="http://localhost:8080/miaplicacion/tiempo/03001" class="bare">http://localhost:8080/miaplicacion/tiempo/03001</a></p>
</div>
<div class="paragraph">
<p><a href="http://localhost:8080/miaplicacion/tiempo/03004" class="bare">http://localhost:8080/miaplicacion/tiempo/03004</a></p>
</div>
<div class="paragraph">
<p><a href="http://localhost:8080/miaplicacion/tiempo/03690" class="bare">http://localhost:8080/miaplicacion/tiempo/03690</a></p>
</div>
<div class="paragraph">
<p>El valor introducido podrá ser inyectado como parámetro de los métodos de nuestro <em>endpoint</em> añadiendo la anotación <code>@PathParam(&lt;nombre_segmento&gt;)</code>. Podrá inyectarse en los métodos de tipo <code>onOpen</code>, <code>onClose</code> y <code>onMessage</code>. A continuación se muestra un ejemplo de inyección en <code>onOpen</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@ServerEndpoint</span><span class="tok-o">(</span><span class="tok-s">&quot;/tiempo/{cp}&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">ChatEndpoint</span> <span class="tok-o">{</span>
   <span class="tok-n">String</span> <span class="tok-n">cp</span><span class="tok-o">;</span>
   <span class="tok-n">Session</span> <span class="tok-n">session</span><span class="tok-o">;</span>

   <span class="tok-nd">@OnOpen</span>
   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">open</span><span class="tok-o">(</span><span class="tok-n">Session</span> <span class="tok-n">session</span><span class="tok-o">,</span>
                    <span class="tok-n">EndpointConfig</span> <span class="tok-n">c</span><span class="tok-o">,</span>
                    <span class="tok-nd">@PathParam</span><span class="tok-o">(</span><span class="tok-s">&quot;cp&quot;</span><span class="tok-o">)</span> <span class="tok-n">String</span> <span class="tok-n">cp</span><span class="tok-o">)</span> <span class="tok-o">{</span> <i class="conum" data-value="1"></i><b>(1)</b>
      <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">cp</span> <span class="tok-o">=</span> <span class="tok-n">cp</span><span class="tok-o">;</span> <i class="conum" data-value="2"></i><b>(2)</b>
      <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">session</span> <span class="tok-o">=</span> <span class="tok-n">session</span><span class="tok-o">;</span> <i class="conum" data-value="3"></i><b>(3)</b>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Inyección del valor introducido en el segmento variable <code>{cp}</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Almacenamos el valor del código postal para recordarlo cuando vayamos a enviar una actualización de los datos del tiempo al cliente</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Almacenamos la sesión para poder enviar mensajes al cliente sin la necesidad de que exista un mensaje de entrada</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Este tipo de parámetros se conoce como parámetros del <em>path</em>. Podríamos también añadir parámetros en la <em>query</em> con el siguiente formato:</p>
</div>
<div class="paragraph">
<p><a href="http://localhost:8080/miaplicacion/tiempo?" class="bare">http://localhost:8080/miaplicacion/tiempo?</a><strong>hora=18</strong></p>
</div>
<div class="paragraph">
<p>En este caso la forma de obtenerlos en el <em>endpoint</em> es distinta. Podremos acceder a estos parámetros a través del objeto <code>Session</code> con <code>getRequestParameterMap</code>. Esta función nos devuelve un <code>Map</code> con todos los parámetros recibidos, que podrían ser multivaluados. El parámetro <code>cp</code> anterior se obtendría de la siguiente forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">String</span> <span class="tok-n">hora</span> <span class="tok-o">=</span> <span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-na">getRequestParameterMap</span><span class="tok-o">().</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-s">&quot;hora&quot;</span><span class="tok-o">).</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Tenemos que poner <code>.get(0)</code> debido a que para cada parámetro nos da una lista de objetos <code>String</code>, para así permitir los parámetros con múltiples valores. En conveniente que nos aseguremos de que el parámetro es distinto de <code>null</code> y que la lista no está vacía.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-k">if</span><span class="tok-o">(</span><span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-na">getRequestParameterMap</span><span class="tok-o">().</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-s">&quot;cp&quot;</span><span class="tok-o">)!=</span><span class="tok-kc">null</span> <span class="tok-o">&amp;&amp;</span>
   <span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-na">getRequestParameterMap</span><span class="tok-o">().</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-s">&quot;cp&quot;</span><span class="tok-o">).</span><span class="tok-na">size</span><span class="tok-o">()</span> <span class="tok-o">&gt;</span> <span class="tok-mi">0</span><span class="tok-o">)</span> <span class="tok-o">{</span>
     <span class="tok-n">String</span> <span class="tok-n">cp</span> <span class="tok-o">=</span> <span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-na">getRequestParameterMap</span><span class="tok-o">().</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-s">&quot;cp&quot;</span><span class="tok-o">).</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">);</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Podríamos combinar los dos tipos de parámetros en una misma URL, por ejemplo:</p>
</div>
<div class="paragraph">
<p><a href="http://localhost:8080/miaplicacion/tiempo/03001?hora=18" class="bare">http://localhost:8080/miaplicacion/tiempo/03001?hora=18</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_cliente_javascript">5.5. Cliente JavaScript</h3>
<div class="paragraph">
<p>La gran mayoría de navegadores actuales soportan WebSocket. Encontramos una API JavaScript que nos permite conectar a este tipo de componentes. Deberemos crear un objecto JavaScript de tipo <code>WebSocket</code> a partir de la URL de nuestro <em>endpoint</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">websocket</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">WebSocket</span><span class="tok-p">(</span><span class="tok-s2">&quot;ws://localhost:8080/miaplicacion/socket&quot;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Una vez creado el objeto, deberemos especificar un <em>callback</em> en su atributo <code>onmessage</code> para recibir una notificación cuando recibamos un nuevo mensaje:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">websocket</span><span class="tok-p">.</span><span class="tok-nx">onmessage</span> <span class="tok-o">=</span> <span class="tok-nx">onMessage</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A continuación se muestra un ejemplo completo, en el que suponemos que se reciben datos de una película con el formato <em>&lt;titulo&gt;;&lt;director&gt;;&lt;duracion&gt;</em> de los ejemplos anteriores. Se trocea la cadena y se muestra cada elemento en el documento web:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">websocket</span><span class="tok-p">;</span>

<span class="tok-kd">function</span> <span class="tok-nx">connect</span><span class="tok-p">()</span> <span class="tok-p">{</span>
   <span class="tok-nx">websocket</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">WebSocket</span><span class="tok-p">(</span><span class="tok-s2">&quot;ws://localhost:8080/miaplicacion/socket&quot;</span><span class="tok-p">);</span>
   <span class="tok-nx">websocket</span><span class="tok-p">.</span><span class="tok-nx">onmessage</span> <span class="tok-o">=</span> <span class="tok-nx">onMessage</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-kd">function</span> <span class="tok-nx">onMessage</span><span class="tok-p">(</span><span class="tok-nx">event</span><span class="tok-p">)</span> <span class="tok-p">{</span>
   <span class="tok-kd">var</span> <span class="tok-nx">items</span> <span class="tok-o">=</span> <span class="tok-nx">event</span><span class="tok-p">.</span><span class="tok-nx">data</span><span class="tok-p">.</span><span class="tok-nx">split</span><span class="tok-p">(</span><span class="tok-s2">&quot;;&quot;</span><span class="tok-p">);</span>
   <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s2">&quot;titulo&quot;</span><span class="tok-p">).</span><span class="tok-nx">innerHTML</span> <span class="tok-o">=</span> <span class="tok-nx">items</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">];</span>
   <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s2">&quot;director&quot;</span><span class="tok-p">).</span><span class="tok-nx">innerHTML</span> <span class="tok-o">=</span> <span class="tok-nx">items</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">];</span>
<span class="tok-p">}</span>

<span class="tok-nb">window</span><span class="tok-p">.</span><span class="tok-nx">addEventListener</span><span class="tok-p">(</span><span class="tok-s2">&quot;load&quot;</span><span class="tok-p">,</span> <span class="tok-nx">connect</span><span class="tok-p">,</span> <span class="tok-kc">false</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A través del objeto <code>WebSocket</code> podemos también enviar mensajes con <code>send</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">websocket</span><span class="tok-p">.</span><span class="tok-nx">send</span><span class="tok-p">(</span><span class="tok-s2">&quot;Mensaje&quot;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="_ejercicios_5">5.6. Ejercicios</h3>
<div class="sect3">
<h4 id="_chat_básico_con_websocket_0_5_puntos">5.6.1. Chat básico con WebSocket (0.5 puntos)</h4>
<div class="paragraph">
<p>Vamos a crear una versión alternativa del chat utilizando WebSocket. Para empezar simplemente implementaremos un chat que nos permita intercambiar mensajes con el resto de clientes conectados al servidor sin incluir información del emisor de cada mensaje.</p>
</div>
<div class="paragraph">
<p>Tenemos en la aplicación <code>cweb-chat</code> una página <code>chatws.html</code> que contiene el código JavaScript que implementa el chat. Deberemos crear el <em>endpoint</em> en el lado del servidor:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Creamos un <em>endpoint</em> mapeado a la dirección <code>/ChatWS</code>.</p>
</li>
<li>
<p>En el <em>endpoint</em> definimos un método <code>OnMessage</code> que difunda el mismo mensaje que reciba a todas las sesiones abiertas actualmente.</p>
</li>
<li>
<p>El mensaje a difundir debe tener el siguiente formato:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>&lt;nick&gt;;&lt;mensaje-rebido&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>De momento utilizaremos como <em>nick</em> la cadena fija <code>"Anonimo"</code>. En el próximo ejercicio implementaremos <em>nicks</em> y salas de chat.</p>
</div>
</li>
<li>
<p>Prueba el chat y comprueba que funciona correctamente desde diferentes navegadores.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_chat_con_nombres_de_usuario_y_salas_0_5_puntos">5.6.2. Chat con nombres de usuario y salas (0.5 puntos)</h4>
<div class="paragraph">
<p>En este ejercicio vamos a mejorar el chat anterior añandiendo distintas salas de chat y asignando a cada cliente un <em>nickname</em>. La sala se especificará mediante un segmento de la URL (<em>path param</em>), mientras que el <em>nickname</em> llegará como parámetro de la <em>query</em>:</p>
</div>
<div class="paragraph">
<p><a href="http://localhost:8080/cweb-chat/ChatWS/SalaA?nick=Pepe" class="bare">http://localhost:8080/cweb-chat/ChatWS/SalaA?nick=Pepe</a></p>
</div>
<div class="paragraph">
<p>Deberemos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>En primer lugar en el fichero <code>chatws.html</code> comentaremos la siguiente línea del código JavaScript:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nb">window</span><span class="tok-p">.</span><span class="tok-nx">addEventListener</span><span class="tok-p">(</span><span class="tok-s2">&quot;load&quot;</span><span class="tok-p">,</span> <span class="tok-nx">connect</span><span class="tok-p">,</span> <span class="tok-kc">false</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Con esto la conexión con el <em>endpoint</em> dejará de funcionar al hacerse la petición a una ruta distinta a la que está mapeado (no está preparado para recibir el segmento con el nombre de la sala).</p>
</div>
</li>
<li>
<p>Ahora deberemos mapear correctamente el <em>endpoint</em> a una dirección que acepte el <em>path param</em> con el nombre de la sala como segmento de ruta. Comprueba que la conexión funciona correctamente tras establecer este mapeo.</p>
</li>
<li>
<p>Implementa soporte para establecer el <em>nick</em>. Define para ello en el <em>endpoint</em> un método <code>OnOpen</code> que lea el parámetro de la <em>query</em> <code>nick</code> y guarde el <em>nick</em> en una variable de instancia. Cuando difunda los mensajes en <code>OnMessage</code> incluiremos el <em>nick</em> correcto en lugar de <code>"Anonimo"</code>.</p>
</li>
<li>
<p>Por último, implementaremos la posibilidad de tener múltiples salas de chat, cada una de ellas identificadas por un nombre. Sólo veremos los mensajes de los usuario que estén en nuestra misma sala. Para ello:</p>
<div class="ulist">
<ul>
<li>
<p>En primer lugar en <code>OnOpen</code> inyectaremos el <em>path param</em> como parámetro.</p>
</li>
<li>
<p>Guardaremos el nombre de la sala en el mapa <code>session.getUserProperties()</code>.</p>
</li>
<li>
<p>Al difundir los mensajes comprobaremos si en nuestra la propiedad <em>sala</em> coincide con cada una de las otras sesiones abiertas. Sólo enviaremos mensajes a las sesiones en las que coincida.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion06">6. Seguridad en aplicaciones web</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Podemos tener básicamente dos motivos para proteger una aplicación web:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Evitar que usuarios no autorizados accedan a determinados recursos.</p>
</li>
<li>
<p>Prevenir que se acceda a los datos que se intercambian en una transferencia a lo largo de la red.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Para cubrir estos agujeros, un sistema de seguridad se apoya en tres aspectos importantes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Autentificación</strong> y <strong>autorización</strong>: La autentificación se refiere a identificar a los actores que se conectan, lo cual se hará normalmente aportando unas credenciales (<em>login</em> y <em>password</em>), mientras que la autorización se refiere a distinguir las operaciones que cada actor puede realizar.</p>
</li>
<li>
<p><strong>Confidencialidad</strong>: Asegurar que sólo los elementos que intervienen entienden el proceso de comunicación establecido.</p>
</li>
<li>
<p><strong>Integridad</strong>: Verificar que el contenido de la comunicación no se modifica durante la transmisión.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Desde el punto de vista de quién controla la seguridad en una aplicación web, existen dos formas de
		implantación:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Seguridad declarativa</strong>: Aquella estructura de seguridad sobre una aplicación que es externa a dicha aplicación. Con ella, no tendremos que preocuparnos de gestionar la seguridad en ningún servlet, página JSP, etc, de nuestra aplicación, sino que el propio servidor Web se encarga de todo. Así, ante cada petición, comprueba si el usuario se ha autentificado ya, y si no le pide login y password para ver si puede acceder al recurso solicitado. Todo esto se realiza de forma transparente al usuario. Mediante el descriptor de la aplicación principalmente (fichero <em>web.xml</em>), comprueba la configuración de seguridad que queremos dar.</p>
</li>
<li>
<p><strong>Seguridad programada</strong>: Mediante la seguridad programada, son los servlets y páginas JSP quienes, al menos parcialmente, controlan la seguridad de la aplicación.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Vamos a centrarnos en el estudio de la <strong>autentificación</strong> y <strong>autorización</strong> mediante <strong>seguridad declarativa</strong> en servidores de aplicaciones Java EE.</p>
</div>
<div class="sect2">
<h3 id="_mecanismos_de_autentificación">6.1. Mecanismos de autentificación</h3>
<div class="paragraph">
<p>Veremos ahora algunos mecanismos que pueden emplearse con HTTP para autentificar (validar) al usuario que intenta acceder a un determinado recurso.</p>
</div>
<div class="paragraph">
<p><strong>Autentificaciones elementales</strong></p>
</div>
<div class="paragraph">
<p>El protocolo HTTP incorpora un mecanismo de autentificación básico (<strong>basic</strong>) basado en cabeceras de autentificación para solicitar datos del usuario (el servidor) y para enviar los datos del usuario (el cliente), de forma que comprobando la exactitud de los datos se permitirá o no al usuario acceder a los recursos. Esta autentificación no proporciona confidencialidad ni integridad, sólo se emplea una codificación Base64.</p>
</div>
<div class="paragraph">
<p>Una variante de esto es la autentificación <strong>digest</strong>, donde, en lugar de transmitir el password por la red, se emplea un password codificado. Dicha codificación se realiza tomando el login, password, URI, método HTTP y un valor generado aleatoriamente, y todo ello se combina utilizando el método de encriptado MD5, muy seguro. De este modo, ambas partes de la comunicación conocen el password, y a partir de él pueden comprobar si los datos enviados son correctos. Sin embargo, algunos servidores no soportan este tipo de autentificación.</p>
</div>
<div class="paragraph">
<p><strong>Certificados digitales y SSL</strong></p>
</div>
<div class="paragraph">
<p>Las aplicaciones reales pueden requerir un nivel de seguridad mayor que el proporcionado por las autentificaciones <em>basic</em> o <em>digest</em>. También pueden requerir confidencialidad e integridad aseguradas. Todo esto se consigue mediante los <strong>certificados digitales</strong>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Criptografía de clave pública</strong>:La clave de los certificados digitales reside en la <strong>criptografía de clave pública</strong>, mediante la cual cada participante en el proceso tiene dos claves, que le permiten encriptar y desencriptar la información. Una es la clave pública, que se distribuye libremente. La otra es la clave privada, que se mantiene secreta. Este par de claves es asimétrico, es decir, una clave sirve para desencriptar algo codificado con la otra. Por ejemplo, supongamos que A quiere enviar datos encriptados a B. Para ello, hay dos posibilidades:</p>
</li>
<li>
<p>A toma la clave pública de B, codifica con ella los datos y se los envía. Luego B utiliza su clave privada (que sólo él conoce) para desencriptar los datos.</p>
</li>
<li>
<p>A toma su clave privada, codifica los datos y se los envía a B, que toma la clave pública de A para descodificarlos. Con esto, B sabe que A es el remitente de los datos.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>El encriptado con clave pública se basa normalmente en el algoritmo RSA, que emplea números primos grandes para obtener un par de claves asimétricas. Las claves pueden darse con varias longitudes; así, son comunes claves de 1024 o 2048 bits.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Certificados digitales</strong>: Lógicamente, no es práctico teclear las claves del sistema de clave pública, pues son muy largas. Lo que se hace en su lugar es almacenar estas claves en disco en forma de <strong>certificados digitales</strong>. Estos certificados pueden cargarse por muchas aplicaciones (servidores web, navegadores, gestores de correo, etc).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Notar que con este sistema se garantiza la <strong>confidencialidad</strong> (porque los datos van encriptados), y la <strong>integridad</strong> (porque si los datos se desencriptan bien, indica que son correctos). Sin embargo, no proporciona <strong>autentificación</strong> (B no sabe que los datos se los ha enviado A), a menos que A utilice su clave privada para encriptar los datos, y luego B utilice la clave pública de A para desencriptarlos. Así, B descodifica primero el mensaje con su clave privada, y luego con la pública de A. Si el proceso tiene éxito, los datos se sabe que han sido enviados por A, porque sólo A conoce su clave privada.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>SSL</strong>: SSL (<em>Secure Socket Layer</em>) es una capa situada entre el protocolo a nivel de aplicación (HTTP, en este caso) y el protocolo a nivel de transporte (TCP/IP). Se encarga de gestionar la seguridad mediante criptografía de clave pública que encripta la comunicación entre cliente y servidor. La versión 2.0 de SSL (la primera mundialmente aceptada), proporciona autentificación en la parte del servidor, confidencialidad e integridad. Funciona como sigue:</p>
</li>
<li>
<p>Un cliente se conecta a un lugar seguro utilizando el protocolo HTTPS (HTTP + SSL). Podemos detectar estos sitios porque las URLs comienzan con <code>https://</code></p>
</li>
<li>
<p>El servidor envía su clave pública al cliente.</p>
</li>
<li>
<p>El navegador comprueba si la clave está firmada por un certificado de confianza. Si no es así, pregunta al cliente si quiere confiar en la clave proporcionada.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>SSL 3.0 proporciona también soporte para certificados y autentificación del cliente. Funcionan de la misma forma que los explicados para el servidor, pero residiendo en el cliente.</p>
</div>
</div>
<div class="sect2">
<h3 id="_usuarios_y_roles">6.2. Usuarios y roles</h3>
<div class="paragraph">
<p>Cualquier aplicación medianamente compleja tendrá que autentificar a los usuarios que acceden a ella, y en función de quiénes son, permitirles o no la ejecución de ciertas operaciones.</p>
</div>
<div class="paragraph">
<p>Los mecanismos de autentificación en WildFly se basan en el concepto de <em>realm</em>. Un <em>realm</em> es un conjunto de usuarios, cada uno con un <em>login</em> y <em>password</em> y uno o más <em>roles</em>. Los roles determinan qué permisos tiene el usuario en una aplicación web (esto es configurable en cada aplicación a través del descriptor de despliegue, <code>web.xml</code>). El <em>login</em> y el <em>password</em> se utilizará para la autentificación de los usuarios, y los roles para su autorización.</p>
</div>
<div class="paragraph">
<p>Podemos encontrar distintos tipos de <em>realms</em>, que básicamente se diferencian en dónde están almacenados los datos de <em>logins</em>, <em>passwords</em> y <em>roles</em>. Por defecto en WildFly tenemos dos realms que almacenan estos datos en ficheros de texto de tipo <code>.properties</code>. Existen otros <em>realms</em> que leer los datos de bases de datos con JDBC, de un directorio LDAP o mediante JAAS, el API estándar de Java para autentificación.</p>
</div>
<div class="paragraph">
<p>Los dos <em>realms</em> que tenemos por defecto en WildFly son <code>ManagementRealm</code> y <code>ApplicationRealm</code>. <code>ManagementRealm</code> se utiliza para la aplicación de administración del servidor, por lo que sólo nos permite controlar la autentificación (no se indican roles porque el único rol que tienen los usuarios de este conjunto es el de administrar el servidor). Por otro lado, <code>ApplicationRealm</code> nos permite además controlar la autorización, mediante la asignación de roles a usuarios.</p>
</div>
<div class="paragraph">
<p>No será necesario editar manualmente los ficheros de usuarios de estos <em>realms</em> por defecto, ya que se proporciona una herramienta para añadir nuevos usuarios a ellos. Este herramienta se encuentra en el directorio <code>$WILDFLY_HOME/bin</code>, y se ejecuta de la siguiente forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span class="tok-nv">$ </span>./addUser.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nos preguntará en primer lugar en cuál de los dos <em>realms</em> por defecto queremos introducir el usuario, y a continuación nos irá pidiendo los datos del nuevo usuario. En las aplicaciones que incorporen seguridad declarativa se nos permitirá entrar con cualquiera de los usuarios del <code>ApplicationRealm</code>. Las operaciones que nos permita hacer dependerán de los roles asignados.</p>
</div>
</div>
<div class="sect2">
<h3 id="_autentificación_en_aplicaciones_web_java_ee">6.3. Autentificación en aplicaciones web Java EE</h3>
<div class="paragraph">
<p>En las aplicaciones web Java EE tenemos distintos tipos de autentificación que podemos emplear:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Autentificación <em>basic</em></strong>: Con HTTP se proporciona un mecanismo de autentificación básico, basado en cabeceras de autentificación para solicitar datos del usuario (el servidor) y para enviar los datos del usuario (el cliente). Esta autentificación no proporciona confidencialidad ni integridad, sólo se emplea una codificación Base64.</p>
</li>
<li>
<p><strong>Autentificación <em>digest</em></strong>: Existe una variante de lo anterior, la autentificación <strong>digest</strong>, donde, en lugar de transmitir el password por la red, se emplea un password codificado utilizando el método de encriptado MD5. Sin embargo, algunos servidores no soportan este tipo de autentificación.</p>
</li>
<li>
<p><strong>Autentificación basada en formularios</strong>: Con este tipo de autentificación, el usuario introduce su login y password mediante un formulario HTML (y no con un cuadro de diálogo, como las anteriores). El fichero descriptor contiene para ello entradas que indican la página con el formulario de autentificación y una página de error. Tiene el mismo inconveniente que la autentificación <em>basic</em>: el password se codifica con un mecanismo muy pobre.</p>
</li>
<li>
<p><strong>Certificados digitales y SSL</strong>: Con HTTP también se permite el uso de SSL y los certificados digitales, apoyados en los sistemas de criptografía de clave pública. Así, la capa SSL, trabajando entre TCP/IP y HTTP, asegura, mediante criptografía de clave pública, la integridad, confidencialidad y autentificación.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_autentificación_basada_en_formularios">6.3.1. Autentificación basada en formularios</h4>
<div class="paragraph">
<p>Veremos ahora con más profundidad la autentificación basada en formularios comentada anteriormente. Esta es la forma más comúnmente usada para imponer seguridad en una aplicación, puesto que se emplean <strong>formularios HTML</strong>.</p>
</div>
<div class="paragraph">
<p>El programador emplea el descriptor de despliegue para identificar los recursos a proteger, e indicar la página con el formulario a mostrar, y la página con el error a mostrar en caso de autentificación incorrecta. Así, un usuario que intente acceder a la parte restringida es redirigido automáticamente a la página del formulario, si no ha sido autentificado previamente. Si se autentifica correctamente accede al recurso, y si no se le muestra la página de error. Todo este proceso lo controla el servidor automáticamente.</p>
</div>
<div class="paragraph">
<p>Este tipo de autentificación no se garantiza que funcione cuando se emplea reescritura de URLs en el seguimiento de sesiones. También podemos incorporar SSL a este proceso, de forma que no se vea modificado el funcionamiento aparente del mismo.</p>
</div>
<div class="paragraph">
<p>Para utilizar la autentificación basada en formularios, se siguen los pasos que veremos a continuación. Sólo el primero es dependiente del servidor que se utilice.</p>
</div>
<div class="paragraph">
<p><strong>1. Establecer los logins, passwords y roles</strong></p>
</div>
<div class="paragraph">
<p>En este paso definiríamos un <em>realm</em> del modo que se ha explicado en apartados anteriores.</p>
</div>
<div class="paragraph">
<p><strong>2. Indicar al servlet que se empleará autentificación basada en formularios, e indicar las páginas de formulario y error.</strong></p>
</div>
<div class="paragraph">
<p>Se coloca para ello una etiqueta <code>&lt;login-config&gt;</code> en el descriptor de despliegue. Dentro, se emplean las subetiquetas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>&lt;auth-method&gt;</code> que en general puede valer:</p>
<div class="ulist">
<ul>
<li>
<p><code>FORM</code>: para autentificación basada en formularios (como es el caso)</p>
</li>
<li>
<p><code>BASIC</code>: para autentificación BASIC</p>
</li>
<li>
<p><code>DIGEST</code>: para autentificación DIGEST</p>
</li>
<li>
<p><code>CLIENT-CERT</code>: para SSL</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>&lt;form-login-config&gt;</code> que indica las dos páginas HTML (la del formulario y la de error) con las etiquetas:</p>
<div class="ulist">
<ul>
<li>
<p><code>&lt;form-login-page&gt;</code> (para la de autentificación)</p>
</li>
<li>
<p><code>&lt;form-error-page&gt;</code> (para la página de error).</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Por ejemplo, podemos tener las siguientes líneas en el descriptor de despliegue:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;web-app&gt;</span>
	...
	<span class="tok-nt">&lt;login-config&gt;</span>
		<span class="tok-nt">&lt;auth-method&gt;</span>FORM<span class="tok-nt">&lt;/auth-method&gt;</span>
		<span class="tok-nt">&lt;form-login-config&gt;</span>
			<span class="tok-nt">&lt;form-login-page&gt;</span>
				/login.jsp
			<span class="tok-nt">&lt;/form-login-page&gt;</span>
			<span class="tok-nt">&lt;form-error-page&gt;</span>
				/error.html
			<span class="tok-nt">&lt;/form-error-page&gt;</span>
		<span class="tok-nt">&lt;/form-login-config&gt;</span>
	<span class="tok-nt">&lt;/login-config&gt;</span>
	...
<span class="tok-nt">&lt;/web-app&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>3. Crear la página de login</strong></p>
</div>
<div class="paragraph">
<p>El formulario de esta página debe contener campos para introducir el login y el password, que deben llamarse <em>j_username</em> y <em>j_password</em>. La acción del formulario debe ser <em>j_security_check</em>, y el METHOD = POST (para no mostrar los datos de identificación en la barra del explorador). Por ejemplo, podríamos tener la página:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;!DOCTYPE HTML PUBLIC</span>
<span class="tok-cp">&quot;-//W3C//DTD HTML 4.0 Transitional//EN&quot;&gt;</span>
<span class="tok-nt">&lt;html&gt;</span>
<span class="tok-nt">&lt;body&gt;</span>
	<span class="tok-nt">&lt;form</span> <span class="tok-na">action=</span><span class="tok-s">&quot;j_security_check&quot;</span> <span class="tok-na">METHOD=</span><span class="tok-s">&quot;POST&quot;</span><span class="tok-nt">&gt;</span>
	<span class="tok-nt">&lt;table&gt;</span>
	<span class="tok-nt">&lt;tr&gt;</span>
		<span class="tok-nt">&lt;td&gt;</span>
			Login:<span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;j_username&quot;</span><span class="tok-nt">/&gt;</span>
		<span class="tok-nt">&lt;/td&gt;</span>
	<span class="tok-nt">&lt;/tr&gt;</span>
	<span class="tok-nt">&lt;tr&gt;</span>
		<span class="tok-nt">&lt;td&gt;</span>
			Password:<span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;j_password&quot;</span><span class="tok-nt">/&gt;</span>
		<span class="tok-nt">&lt;/td&gt;</span>
	<span class="tok-nt">&lt;/tr&gt;</span>
	<span class="tok-nt">&lt;tr&gt;</span>
		<span class="tok-nt">&lt;td&gt;</span>
			<span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;submit&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;Enviar&quot;</span><span class="tok-nt">/&gt;</span>
		<span class="tok-nt">&lt;/td&gt;</span>
	<span class="tok-nt">&lt;/tr&gt;</span>
	<span class="tok-nt">&lt;/table&gt;</span>
	<span class="tok-nt">&lt;/form&gt;</span>
<span class="tok-nt">&lt;/body&gt;</span>
<span class="tok-nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>4. Crear la página de error</strong></p>
</div>
<div class="paragraph">
<p>La página puede tener el mensaje de error que se quiera. Ante fallos de autentificación, se redirigirá a esta página con un código 401. Un ejemplo de página sería:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;!DOCTYPE HTML PUBLIC</span>
<span class="tok-cp">&quot;-//W3C//DTD HTML 4.0 Transitional//EN&quot;&gt;</span>
<span class="tok-nt">&lt;html&gt;</span>
<span class="tok-nt">&lt;body&gt;</span>
	<span class="tok-nt">&lt;h1&gt;</span>ERROR AL AUTENTIFICAR USUARIO<span class="tok-nt">&lt;/h1&gt;</span>
<span class="tok-nt">&lt;/body&gt;</span>
<span class="tok-nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>5. Indicar qué direcciones deben protegerse con autentificación</strong></p>
</div>
<div class="paragraph">
<p>Para ello utilizamos etiquetas <code>&lt;security-constraint&gt;</code> en el descriptor de despliegue. Dichos elementos debe ir inmediatamente antes de <code>&lt;login-config&gt;</code>, y utilizan las subetiquetas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>&lt;display-name&gt;</code> para dar un nombre identificativo a emplear (opcional)</p>
</li>
<li>
<p><code>&lt;web-resource-collection&gt;</code> para especificar los patrones de URL que se protegen (requerido). Se permiten varias entradas de este tipo para especificar recursos de varios lugares. Cada uno contiene:</p>
<div class="ulist">
<ul>
<li>
<p>Una etiqueta <code>&lt;web-resource-name&gt;</code> que da un nombre identificativo arbitrario al recurso o recursos</p>
</li>
<li>
<p>Una etiqueta <code>&lt;url-pattern&gt;</code> que indica las URLs que deben protegerse</p>
</li>
<li>
<p>Una etiqueta <code>&lt;http-method&gt;</code> que indica el método o métodos HTTP a los que se aplicará la restricción (opcional)</p>
</li>
<li>
<p>Una etiqueta <code>&lt;description&gt;</code> con documentación sobre el conjunto de recursos a proteger (opcional)</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
este modo de restricción se aplica sólo cuando se accede al recurso directamente, no a través de arquitecturas MVC (Modelo-Vista-Controlador), con un <em>RequestDispatcher</em>. Es decir, si por ejemplo un servlet accede a una página JSP protegida, este mecanismo no tiene efecto, pero sí cuando se intenta a acceder a la página JSP directamente.
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><code>&lt;auth-constraint&gt;</code> indica los roles de usuario que pueden acceder a los recursos indicados (opcional) Contiene:</p>
<div class="ulist">
<ul>
<li>
<p>Uno o varios subelementos <code>&lt;role-name&gt;</code> indicando cada rol que tiene permiso de acceso. Si queremos dar permiso a todos los roles, utilizamos una etiqueta <code>&lt;role-name&gt;*&lt;/role-name&gt;</code>.</p>
</li>
<li>
<p>Una etiqueta <code>&lt;description&gt;</code> indicando la descripción de los mismos.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>En teoría esta etiqueta es opcional, pero omitiéndola indicamos que ningún rol tiene permiso de acceso. Aunque esto puede parecer absurdo, recordar que este sistema sólo se aplica al acceso directo a las URLs (no a través de un modelo MVC), con lo que puede tener su utilidad.</p>
</div>
<div class="paragraph">
<p>Añadimos alguna dirección protegida al fichero que vamos construyendo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;web-app&gt;</span>
	<span class="tok-nt">&lt;security-constraint&gt;</span>
		<span class="tok-nt">&lt;web-resource-collection&gt;</span>
			<span class="tok-nt">&lt;web-resource-name&gt;</span>
				Prueba
			<span class="tok-nt">&lt;/web-resource-name&gt;</span>
			<span class="tok-nt">&lt;url-pattern&gt;</span>
				/prueba/*
			<span class="tok-nt">&lt;/url-pattern&gt;</span>
		<span class="tok-nt">&lt;/web-resource-collection&gt;</span>
		<span class="tok-nt">&lt;auth-constraint&gt;</span>
			<span class="tok-nt">&lt;role-name&gt;</span>admin<span class="tok-nt">&lt;/role-name&gt;</span>
			<span class="tok-nt">&lt;role-name&gt;</span>subadmin<span class="tok-nt">&lt;/role-name&gt;</span>
		<span class="tok-nt">&lt;/auth-constraint&gt;</span>
	<span class="tok-nt">&lt;/security-constraint&gt;</span>

	<span class="tok-nt">&lt;login-config&gt;</span>
		...
<span class="tok-nt">&lt;/web-app&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En este caso protegemos todas las URLs de la forma <code>http//host/ruta_aplicacion/prueba/*</code>, de forma que sólo los usuarios que tengan roles de <em>admin</em> o de <em>subadmin</em> podrán acceder a ellas.</p>
</div>
</div>
<div class="sect3">
<h4 id="_autentificación_em_basic_em">6.3.2. Autentificación <em>basic</em></h4>
<div class="paragraph">
<p>El método de autentificación basada en formularios tiene algunos inconvenientes: si el navegador no soporta cookies, el proceso tiene que hacerse mediante reescritura de URLs, con lo que no se garantiza el funcionamiento.</p>
</div>
<div class="paragraph">
<p>Por ello, una alternativa es utilizar el modelo de autentificación <em>basic</em> de HTTP, donde se emplea un cuadro de diálogo para que el usuario introduzca su login y password, y se emplea la cabecera <em>Authorization</em> de petición para recordar qué usuarios han sido autorizados y cuáles no. Una diferencia con respecto al método anterior es que es difícil entrar como un usuario distinto una vez que hemos entrado como un determinado usuario (habría que cerrar el navegador y volverlo a abrir).</p>
</div>
<div class="paragraph">
<p>Al igual que en el caso anterior, podemos utilizar SSL sin ver modificado el resto del esquema del proceso.</p>
</div>
<div class="paragraph">
<p>El método de autentificación <em>basic</em> consta de los siguientes pasos:</p>
</div>
<div class="paragraph">
<p><strong>1. Establecer los logins, passwords y roles</strong></p>
</div>
<div class="paragraph">
<p>Este paso es exactamente igual que el visto para la autentificación basada en formularios.</p>
</div>
<div class="paragraph">
<p><strong>2. Indicar al servlet que se empleará autentificación BASIC, y designar los dominios</strong></p>
</div>
<div class="paragraph">
<p>Se utiliza la misma etiqueta <code>&lt;login-config&gt;</code> vista antes, pero ahora una etiqueta <code>&lt;auth-method&gt;</code> con valor BASIC. Se emplea una subetiqueta <code>&lt;realm-name&gt;</code> para indicar qué dominio se empleará en la autorización. Por ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;web-app&gt;</span>
	...
	<span class="tok-nt">&lt;login-config&gt;</span>
		<span class="tok-nt">&lt;auth-method&gt;</span>BASIC<span class="tok-nt">&lt;/auth-method&gt;</span>
		<span class="tok-nt">&lt;realm-name&gt;</span>dominio<span class="tok-nt">&lt;/realm-name&gt;</span>
	<span class="tok-nt">&lt;/login-config&gt;</span>
	...
<span class="tok-nt">&lt;/web-app&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>3. Indicar qué direcciones deben protegerse con autentificación</strong></p>
</div>
<div class="paragraph">
<p>Este paso también es idéntico al visto en la autentificación basada en formularios.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_anotaciones_relacionadas_con_la_seguridad">6.4. Anotaciones relacionadas con la seguridad</h3>
<div class="paragraph">
<p>Con la especificación 3.0 de servlets se introduce la posibilidad de configurar los permisos de acceso mediante
		anotaciones en lugar de en el <code>web.xml</code>, lo que hace la configuración menos farragosa y más clara. La
		anotación principal que utilizaremos es <code>@ServletSecurity</code>, que toma dos parámetros:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>value</code>: Define la restricción de seguridad, mediante una anotación de tipo <code>@HttpConstraint</code>.</p>
</li>
<li>
<p><code>httpMethodConstraints</code>: Permite definir una lista de restrincciones sobre los métodos HTTP que pueden
acceder al servlet. Se definen mediante una anotación de tipo <code>@HttpMethodConstraint</code>. De esta manera no damos
una restricción general para todos los métodos, sino que podemos personalizar las restricciones que se aplicarán
para cada uno de ellos.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La anotación <code>@HttpConstraint</code> acepta los siguientes parámetros:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>rolesAllowed</code>: Nos permite definir la lista de roles que pueden acceder al servlet.</p>
</li>
<li>
<p><code>transportGuarantee</code>: Puede tomar los valores <code>TransportGuarantee.NONE</code> o <code>TransportGuarantee.CONFIDENTIAL</code>.
Con el segundo de ellos sólo estaremos permitiendo acceder al servlet si la conexión se realiza mediante SSL.</p>
</li>
<li>
<p><code>value</code>: Nos permite establecer la política de acceso a llevar a cabo independientemente del rol del usuario. Las opciones son
admitir todas las peticiones (<code>EmptyRoleSemantic.PERMIT</code>) o denegarlas (<code>EmptyRoleSemantic.DENY</code>). Definiremos estas
políticas cuando no se especifique una lista de roles.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Un caso común es aquel en el que queremos permitir acceso al servlet a unos roles determinados:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@WebServlet</span><span class="tok-o">(</span><span class="tok-s">&quot;/MiServlet&quot;</span><span class="tok-o">)</span>
<span class="tok-nd">@ServletSecurity</span><span class="tok-o">(</span><span class="tok-nd">@HttpConstraint</span><span class="tok-o">(</span><span class="tok-n">rolesAllowed</span><span class="tok-o">={</span><span class="tok-s">&quot;rol1&quot;</span><span class="tok-o">,</span><span class="tok-s">&quot;rol2&quot;</span><span class="tok-o">}))</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">MiServlet</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span> <span class="tok-o">{</span> <span class="tok-o">...</span> <span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si queremos permitir el acceso a cualquier usuario (aunque no esté autentificado), pero siempre mediante SSL, podemos indicarlo
		de la siguiente forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@WebServlet</span><span class="tok-o">(</span><span class="tok-s">&quot;/MiServlet&quot;</span><span class="tok-o">)</span>
<span class="tok-nd">@ServletSecurity</span><span class="tok-o">(</span><span class="tok-nd">@HttpConstraint</span><span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-n">EmptyRoleSemantic</span><span class="tok-o">.</span><span class="tok-na">PERMIT</span><span class="tok-o">,</span>
              <span class="tok-n">transportGuarantee</span><span class="tok-o">=</span><span class="tok-n">TransportGuarantee</span><span class="tok-o">.</span><span class="tok-na">CONFIDENTIAL</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">MiServlet</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span> <span class="tok-o">{</span> <span class="tok-o">...</span> <span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Como alternativa, podemos definir diferentes restricciones para cada método HTTP. Para ello utilizaremos la anotación <code>@HttpMethodConstraint</code>,
		que podrá tomar los siguientes parámetros:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>value</code>: Indica el método para el que vamos a definir las restricciones de acceso. Por ejemplo <code>"GET"</code>, <code>"POST"</code>, etc.</p>
</li>
<li>
<p><code>rolesAllowed</code>: Define la lista de roles que pueden acceder al servlet mediante el método indicado.</p>
</li>
<li>
<p><code>transportGuarantee</code>: Indica si sólo se permite acceder al método indicado mediante SSL. Se define de la misma forma que
en el caso de <code>@HttpConstraint</code>.</p>
</li>
<li>
<p><code>emptyRoleSemantic</code>: Nos permite establecer la política de acceso a llevar a cabo independientemente del rol del usuario para el método
especificado. Se define de la misma forma que en el caso de <code>@HttpConstraint</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Si sólo se especifica el método (sin añadir más parámetros), se considera que siempre se permite el acceso mediante dicho método. Por ejemplo, podemos
		definir políticas diferentes para los métodos <code>GET</code>, <code>POST</code> y <code>PUT</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@WebServlet</span><span class="tok-o">(</span><span class="tok-s">&quot;/MiServlet&quot;</span><span class="tok-o">)</span>
<span class="tok-nd">@ServletSecurity</span><span class="tok-o">(</span><span class="tok-n">httpMethodConstraints</span><span class="tok-o">={</span>
   <span class="tok-nd">@HttpMethodConstraint</span><span class="tok-o">(</span><span class="tok-s">&quot;GET&quot;</span><span class="tok-o">),</span>
   <span class="tok-nd">@HttpMethodConstraint</span><span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-s">&quot;POST&quot;</span><span class="tok-o">,</span><span class="tok-n">rolesAllowed</span><span class="tok-o">=</span><span class="tok-s">&quot;admin&quot;</span><span class="tok-o">),</span>
   <span class="tok-nd">@HttpMethodConstraint</span><span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-s">&quot;PUT&quot;</span><span class="tok-o">,</span>
                         <span class="tok-n">emptyRoleSemantic</span><span class="tok-o">=</span><span class="tok-n">EmptyRoleSemantic</span><span class="tok-o">.</span><span class="tok-na">DENY</span><span class="tok-o">)})</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">MiServlet</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span> <span class="tok-o">{</span> <span class="tok-o">...</span> <span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En este ejemplo, se permite acceder a todos los usuarios con <code>GET</code>, pero con <code>POST</code> sólo podrán acceder los que tengan rol
		<code>admin</code>, y con <code>PUT</code> no podrá acceder nadie.</p>
</div>
<div class="paragraph">
<p>También podemos combinar una política particular para una serie de métodos, y una política general para el resto:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@ServletSecurity</span><span class="tok-o">(</span>
   <span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-nd">@HttpConstraint</span><span class="tok-o">(</span><span class="tok-n">EmptyRoleSemantic</span><span class="tok-o">.</span><span class="tok-na">PERMIT</span><span class="tok-o">),</span>
   <span class="tok-n">httpMethodConstraints</span><span class="tok-o">={</span>
     <span class="tok-nd">@HttpMethodConstraint</span><span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-s">&quot;POST&quot;</span><span class="tok-o">,</span><span class="tok-n">rolesAllowed</span><span class="tok-o">=</span><span class="tok-s">&quot;admin&quot;</span><span class="tok-o">)</span>
     <span class="tok-nd">@HttpMethodConstraint</span><span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-s">&quot;PUT&quot;</span><span class="tok-o">,</span>
         <span class="tok-n">transportGuarantee</span><span class="tok-o">=</span><span class="tok-n">TransportGuarantee</span><span class="tok-o">.</span><span class="tok-na">CONFIDENTIAL</span><span class="tok-o">)})</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">MiServlet</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span> <span class="tok-o">{</span> <span class="tok-o">...</span> <span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En este caso sólo los usuarios con rol <code>admin</code> podrán acceder mediante <code>POST</code>, y sólo se podrán establecer conexiones <code>PUT</code>
		mediante SSL, pero para el resto de métodos se permitirá acceder a cualquier usuario sin necesidad de utilizar SSL.</p>
</div>
</div>
<div class="sect2">
<h3 id="_acceso_a_la_información_de_seguridad">6.5. Acceso a la información de seguridad</h3>
<div class="paragraph">
<p>Es muy probable que necesitemos acceder desde el código de la aplicación a información del contexto de seguridad del servidor, como
		puede ser el nombre del usuario autentificado actualmente, o sus roles. Podemos acceder a esta información a través del objeto
		<code>HttpServletRequest</code>.</p>
</div>
<div class="paragraph">
<p>En primer lugar, podemos obtener los datos del usuario autentificado actualmente con el método <code>getUserPrincipal()</code> de
		la petición. Esto nos devolverá un objeto de tipo <code>Principal</code>, del que podremos sacar el nombre del usuario. De forma alternativa,
		este nombre también se puede obtener mediante el método <code>getRemoteUser()</code> del mismo objeto.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">Principal</span> <span class="tok-n">p</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getUserPrincipal</span><span class="tok-o">();</span>
<span class="tok-k">if</span><span class="tok-o">(</span><span class="tok-n">p</span><span class="tok-o">!=</span><span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;El usuario autentificado es &quot;</span> <span class="tok-o">+</span> <span class="tok-n">p</span><span class="tok-o">.</span><span class="tok-na">getName</span><span class="tok-o">());</span>
<span class="tok-o">}</span> <span class="tok-k">else</span> <span class="tok-o">{</span>
    <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;No hay ningun usuario autentificado&quot;</span><span class="tok-o">);</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>También puede interesarnos comprobar si el usuario actual pertenece a un determinado rol, para así saber si debemos darle permiso o
		no para realizar una operación dada. Esto lo podemos realizar con el método <code>isUserInRole(rol)</code> del objeto petición.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-k">if</span><span class="tok-o">(</span><span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">isUserInRole</span><span class="tok-o">(</span><span class="tok-s">&quot;admin&quot;</span><span class="tok-o">))</span> <span class="tok-o">{</span>
    <span class="tok-n">usuarioDao</span><span class="tok-o">.</span><span class="tok-na">altaUsuario</span><span class="tok-o">(</span><span class="tok-n">usuario</span><span class="tok-o">);</span>
<span class="tok-o">}</span> <span class="tok-k">else</span> <span class="tok-o">{</span>
    <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;Solo los administradores pueden realizar altas&quot;</span><span class="tok-o">);</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Otros métodos que nos aportan información sobre el contexto de seguridad son <code>getAuthType()</code>, que nos dice el tipo de autentificación
		que estamos utilizando (<code>BASIC</code>, <code>DIGEST</code>, <code>FORM</code>, <code>CLIENT-CERT</code>), y <code>isSecure()</code> que
		nos indica si estamos realizando una conexión segura (SSL) o no.</p>
</div>
<div class="paragraph">
<p>Para finalizar, si estamos utilizando seguridad basada en formulario podremos cerrar la sesión de forma sencilla llamando al método
		<code>invalidate()</code> del objeto <code>HttpSession</code>.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="_ejercicios_6">6.6. Ejercicios</h3>
<div class="sect3">
<h4 id="_seguridad_básica_0_3_puntos">6.6.1. Seguridad básica (0.3 puntos)</h4>
<div class="paragraph">
<p>En las plantillas de la sesión tenemos un proyecto llamado <code>cweb-seguridad</code>, en el que hay un directorio
	<code>restringido</code> que deberemos proteger para que sólo los usuarios autentificados puedan acceder a su
	contenido. Se pide:</p>
</div>
<div class="paragraph">
<p><em>a)</em> Crear en el <em>realm</em> <code>ApplicationRealm</code> los roles <code>admin</code> y <code>registrado</code>,
	y un usuario que tenga esos roles.</p>
</div>
<div class="paragraph">
<p><em>b)</em> Añadir al fichero <code>web.xml</code> la configuración necesaria para proteger el directorio
	<code>restringido</code> y todo su contenido mediante autentificación de tipo <code>BASIC</code> para que
	sólo los dos roles que hemos creado puedan acceder.</p>
</div>
<div class="paragraph">
<p><em>c)</em> Entrar en <code>restringido/index.jsp</code> para comprobar que
	está protegido, y que introduciendo el usuario que hemos creado nos deja acceder correctamente. Podemos encontrar
	una enlace a dicho recurso protegido desde la página principal <code>index.html</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_seguridad_basada_en_formularios_0_4_puntos">6.6.2. Seguridad basada en formularios (0.4 puntos)</h4>
<div class="paragraph">
<p>Vamos a cambiar el tipo de seguridad por autentificación basada en formularios. Se pide:</p>
</div>
<div class="paragraph">
<p><em>a)</em> Crear los ficheros <code>login.jsp</code> y <code>error.jsp</code> (puedes utilizar el código de los
	apuntes).</p>
</div>
<div class="paragraph">
<p><em>b)</em> Modificar <code>web.xml</code> para cambiar el tipo de seguridad por autentificación basada en formularios,
	que utilice las páginas creadas en el apartado anterior.</p>
</div>
<div class="paragraph">
<p><em>c)</em> Probar a acceder ahora al área restringida y comprobar que los formularios funcionan correctamente.
	Ahora podemos aprovechar la página <code>logout.jsp</code> de la plantilla para cerrar la sesión y así poder
	probar otro usuario.</p>
</div>
</div>
<div class="sect3">
<h4 id="_seguridad_mediante_anotaciones_0_3_puntos">6.6.3. Seguridad mediante anotaciones (0.3 puntos)</h4>
<div class="paragraph">
<p>En el proyecto tenemos un servlet de nombre <code>SeguridadServlet</code>. Vamos a añadir anotaciones de seguridad
	para protegerlo. Se pide:</p>
</div>
<div class="paragraph">
<p><em>a)</em> Añadir la anotación necesaria para que sólo los roles <code>registrado</code> y <code>admin</code> puedan
	acceder al servlet. Comprobar que las anotaciones funcionan correctamente.</p>
</div>
<div class="paragraph">
<p><em>b)</em> Comprobar dentro del servlet si el usuario es administrador, y en tal caso mostrar un mensaje en la
	página que lo indique.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion07">7. Filtros y Wrappers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hasta ahora hemos visto la forma en la que los servlets nos permiten encapsular
el mecanismo de petición/respuesta. Se identifica al servlet como un
recurso dentro del sitio web, y cuando desde el cliente solicitamos dicho
 recurso, se ejecutará el código que hayamos definido dentro
del método de servicio del servlet.</p>
</div>
<div class="paragraph">
<p>La limitación de los servlets es justamente esa, que un servlet
se invocará sólo cuando solicitemos dicho servlet desde el cliente.
Pero, &iquest;y si queremos procesar cualquier petición que se haga
a cierta parte o toda nuestra aplicación web?</p>
</div>
<div class="paragraph">
<p>Si sólo contamos con servlets, para solucionar esto podríamos
optar por alguna de las siguientes opciones por ejemplo:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Crear un servlet central que invocaremos siempre desde el cliente
    pasándole como parámetro el recurso que deseamos obtener.
Tiene el     inconveniente de que no es transparente para desarrollador del
contenido de     nuestra aplicación web, ya que deberá definir
todos los enlaces del sitio     para que vayan al servlet.</p>
</li>
<li>
<p>Introducir al comienzo de todos los servlets de nuestra aplicación
una     llamada a cierta función que haga el procesamiento que queremos
realizar.     Esto no nos serviría para el contenido estático
de la aplicación web.     Además tampoco es transparente ya
que el desarrollador de los servlets     deberá realizar una llamada
a este código. Otro inconveniente es que     estaremos repitiendo código
común en varios elementos, lo cual va en     contra de la modularidad.</p>
</li>
<li>
<p>Configurar el servidor web (si nos lo permite) para que cualquier
    petición de recurso sea redirigida a un servlet que la procese.
Esta sería     la solución más apropiada, pero tendremos
el problema de que si el servlet     internamente quiere hacer la petición
del recurso al servidor, volverá a     redireccionarlo a si mismo,
por lo que podemos entrar en un bucle infinito.     Por lo tanto, surgirán
problemas con la identificación de los recursos.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Como vemos, por ahora este problema no tiene ninguna solución totalmente
 satisfactoria. Para ello, a partir de la versión 2.3 de servlets,
aparecen los denominados filtros.</p>
</div>
<div class="sect2">
<h3 id="_filtros">7.1. Filtros</h3>
<div class="sect3">
<h4 id="__qué_es_un_filtro">7.1.1. ¿Qué es un filtro?</h4>
<div class="paragraph">
<p>Un filtro es un componente que intercepta cualquier petición que
se realice a un determinado grupo de recursos de nuestra aplicación
web, y la respuesta que se vaya a devolver al cliente por parte del servidor.</p>
</div>
<div class="paragraph">
<p>Normalmente los filtros no generarán por si mismos la respuesta,
como es el caso de los servlets, sino que simplemente la modificarán
si es necesario. Podrán modificar tanto la petición HTTP, como
la respuesta o las cabeceras de la misma.</p>
</div>
<div class="paragraph">
<p>Una ventaja importante de los filtros es que nos ayudarán a modularizar
la aplicación, ya que son componentes independientes que actuarán
sobre cualquier grupo de recursos, no teniendo dichos recursos porque conocer
la existencia de estos filtros. De esta forma este filtrado de las peticiones
y respuestas a nuestro servidor se realiza de un forma totalmente transparente
en todos los niveles, tanto para el cliente como para los desarrolladores
del contenido del sitio web (servlets, JSPs, páginas estática,
y cualquier otro recurso).</p>
</div>
<div class="paragraph">
<p>Esta independencia implica por lo tanto que los filtros podrán ser
reutilizados    para cualquier elemento del sitio web, sin necesidad de incluir
código común    en todos los elementos que queramos que realicen
dicha funcionalidad.</p>
</div>
</div>
<div class="sect3">
<h4 id="_funcionalidades_de_los_filtros">7.1.2. Funcionalidades de los filtros</h4>
<div class="paragraph">
<p>Un filtro podrá acceder a la petición de un determinado recurso
antes de que dicho recurso sea invocado, momento en el que podremos procesar
o modificar dicha petición.</p>
</div>
<div class="paragraph">
<p>Una vez se ha invocado la petición, podremos procesar o modificar
la respuesta que nos ha devuelto el servidor.</p>
</div>
<div class="paragraph">
<p>Además, podremos tener múltiples filtros actuando sobre determinados
grupos de recursos. De esta forma un recurso podrá no ser filtrado,
o ser filtrado por uno o más filtros. Cuando tenemos varios filtros,
se organizarán en forma de cadena en el orden que nosotros especifiquemos,
y cada uno procesará el resultado del anterior.</p>
</div>
</div>
<div class="sect3">
<h4 id="_aplicaciones_de_los_filtros">7.1.3. Aplicaciones de los filtros</h4>
<div class="paragraph">
<p>Hemos descrito lo que es un filtro, pero entenderemos más claramente
los filtros si vemos una serie de posibles aplicaciones que les podemos dar:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Autentificación de usuarios: Podemos definir un filtro que
actúe sobre     cierta zona restringida de nuestra aplicación
web. Si el usuario está     registrado el filtro dejará ver
el contenido tal cual, si no le redirigirá     a la página con
el formulario de registro de usuarios.</p>
</li>
<li>
<p>Transformación con hojas XSL-T: Si tenemos una serie de páginas
escritas     en XML, y una serie de hojas de transformación XSL-T para
generar código     para distintos navegadores, podremos definir un
filtro que actúe sobre el     conjunto de documentos XML, y aplique
una transformación según el tipo de     navegador que hizo la
petición. Devolverá al cliente la respuesta     transformada,
adaptada al navegador adecuado.</p>
</li>
<li>
<p>Transformación de imágenes: Igual que transformamos
documentos XML,     también podemos aplicar los filtros a determinados
formatos de imágenes, y     transformar dichas imágenes dinámicamente
a un formato más adecuado.</p>
</li>
<li>
<p>Encriptación de datos: Podemos utilizar un filtro para que
encripte la     salida de cualquier recurso al que se acceda. El cliente deberá
ser capaz     de desencriptarlo para poder visualizar dicho contenido.</p>
</li>
<li>
<p>Compresión de datos: De forma similar al punto anterior, podemos
comprimir los datos que genera el servidor.</p>
</li>
<li>
<p>Registro de acceso a recursos: Se puede contabilizar mediante un
filtro la     cantidad de accesos a cada recurso de nuestra web. Como todas
las peticiones     pasan a través de él, simplemente tendrá
que incrementar la cantidad de     visitas al recurso que se solicite en cada
momento.</p>
</li>
<li>
<p>Log de accesos: Podemos también elaborar un fichero de log
de accesos a     la web, para conocer los datos de todos los accesos que se
han realizado.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_configuración_de_un_filtro">7.1.4. Configuración de un filtro</h4>
<div class="paragraph">
<p>Para que un filtro intercepte las peticiones a determinados recursos, deberemos
   configurar la aplicación web para que esto sea así. La forma
de    configurar los filtros es similar a la configuración de los
servlets.</p>
</div>
<div class="paragraph">
<p>Los filtros, al igual que los servlets, serán clases Java que definamos,
   y que tendremos normalmente en el directorio <code>WEB-INF/classes</code> de
nuestra    aplicación web, o subdirectorios de este si está
en algún    subpaquete. La configuración de los filtros deberá
establecerse    en el fichero de configuración de nuestra aplicación
web, <code>WEB-INF/web.xml</code>.</p>
</div>
<div class="paragraph">
<p>Primero deberemos declarar los filtros incluidos en nuestra aplicación
   web. Para ello se utilizará la anotación <code>@WebFilter</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@WebFilter</span><span class="tok-o">(</span><span class="tok-s">&quot;/ruta/*&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">FiltroEjemplo</span> <span class="tok-kd">implements</span> <span class="tok-n">Filter</span> <span class="tok-o">{</span>
    <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Esto siempre que estemos utilizando la API de Servlet 3.0. Si trabajásemos
con una versión anterior, debereos utilizar el elemento <code>filter</code> que se define
de en el descriptor de despliegue <code>web.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;filter&gt;</span>
  <span class="tok-nt">&lt;filter-name&gt;</span>Filtro de ejemplo<span class="tok-nt">&lt;/filter-name&gt;</span>
  <span class="tok-nt">&lt;filter-class&gt;</span>FiltroEjemplo<span class="tok-nt">&lt;/filter-class&gt;</span>
  <span class="tok-nt">&lt;init-param&gt;</span>
    <span class="tok-nt">&lt;param-name&gt;</span>fichero_log<span class="tok-nt">&lt;/param-name&gt;</span>
    <span class="tok-nt">&lt;param-value&gt;</span>log.txt<span class="tok-nt">&lt;/param-name&gt;</span>
  <span class="tok-nt">&lt;/init-param&gt;</span>
<span class="tok-nt">&lt;/filter&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Es muy similar a la forma de declarar un servlet. Asignamos un nombre al
filtro, que será asociado a la clase en la que está implementado
dicho    filtro. En este caso la clase es <code>FiltroEjemplo</code>, por lo que
tendremos    que tener el fichero <code>FiltroEjemplo.class</code> en el directorio
<code>WEB-INF/classes</code>    de nuestra aplicación.</p>
</div>
<div class="paragraph">
<p>A continuación podemos declarar una serie de parámetros de
entrada    para el filtro, de forma que para variar estos datos no tengamos
que modificar    y recompilar la clase del filtro, sino que simplemente deberemos
modificar el    valor del parámetro en este fichero de configuración.
Podremos    no tener ningún parámetro, tener uno, o tantos como
queramos.</p>
</div>
<div class="paragraph">
<p>Una vez declarados los filtros deberemos mapearlos a los recursos. Las
peticiones    que se hagan al servidor a estos recursos, serán interceptadas
por nuestro    filtro. Podemos mapear filtros a recursos de distintas formas,
con la etiqueta <code>filter-mapping</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;filter-mapping&gt;</span>
  <span class="tok-nt">&lt;filter-name&gt;</span>Filtro de ejemplo<span class="tok-nt">&lt;/filter-name&gt;</span>
  <span class="tok-nt">&lt;servlet-name&gt;</span>Servlet interceptado<span class="tok-nt">&lt;/servlet-name&gt;</span>
<span class="tok-nt">&lt;/filter-mapping&gt;</span>

<span class="tok-nt">&lt;filter-mapping&gt;</span>
  <span class="tok-nt">&lt;filter-name&gt;</span>Filtro de ejemplo<span class="tok-nt">&lt;/filter-name&gt;</span>
  <span class="tok-nt">&lt;url-pattern&gt;</span>/*<span class="tok-nt">&lt;/url-pattern&gt;</span>
<span class="tok-nt">&lt;/filter-mapping&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La primera forma nos sirve para mapearlo a un servlet, dado el nombre del
servlet    al que lo vamos a asociar. La segunda forma asocia el filtro a
todos los elementos    cuya URL cumpla el patrón dado:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>/*                  Se asocia con todos los elementos
                    de nuestra aplicación web.

/zona_restringida/* Se asocia con todos los elementos
                    en el directorio de nombre
                    zona_restringida, y con los de sus
                    subdirectorios.
/web/*              Se asocia con todos los elementos
                    en el directorio de nombre
                    web, y con los de sus subdirectorios.
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>El valor por defecto de la anotación <code>@WebFilter</code> (<code>value</code>) se refiere a los
patrones de las URLs sobre las que se mapea el filtro (es equivalente a su parámetro <code>urlPatterns</code>).
Si queremos mapear servlets tenemos el parámetro <code>servletNames</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@WebFilter</span><span class="tok-o">(</span><span class="tok-n">servletName</span><span class="tok-o">={</span> <span class="tok-s">&quot;MiServlet1&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;MiServlet2&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;MiServlet3&quot;</span> <span class="tok-o">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos asociar varios filtros a un mismo recurso, si dicho recurso aparece
   mapeado para varios filtros. En este caso tendremos una cadena de varios
filtros    cuando se produzca una petición a este recurso.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="Images/chain.gif" alt="Encadenamiento de filtros" width="50%">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_implementación_básica_de_un_filtro">7.1.5. Implementación básica de un filtro</h4>
<div class="paragraph">
<p>Los filtros se definen mediante la interfaz <code>Filter</code>, contenida en
el    paquete <code>javax.servlet</code>. Por lo tanto, para crear un filtro deberemos
crear    una clase que implemente dicha interfaz:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.http.*</span><span class="tok-o">;</span>

<span class="tok-kd">class</span> <span class="tok-nc">MiFiltro</span> <span class="tok-kd">implements</span> <span class="tok-n">Filter</span> <span class="tok-o">{</span>
  <span class="tok-n">FilterConfig</span> <span class="tok-n">config</span><span class="tok-o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Dentro de este clase, el método básico que deberemos implementar
será el método    <code>doFilter</code>, al que se llamará
cada vez que dicho filtro intercepte una    petición a recursos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">  <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">doFilter</span><span class="tok-o">(</span><span class="tok-n">ServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
      <span class="tok-n">ServletResponse</span> <span class="tok-n">response</span><span class="tok-o">,</span> <span class="tok-n">FilterChain</span> <span class="tok-n">chain</span><span class="tok-o">)</span>
      <span class="tok-kd">throws</span> <span class="tok-n">IOException</span><span class="tok-o">,</span> <span class="tok-n">ServletException</span> <span class="tok-o">{</span>
    <span class="tok-o">...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Vemos que a este método se le pasa como parámetro la petición
y la respuesta, de forma que podamos procesarlas o modificarlas según
la funcionalidad que queramos que implemente el filtro. Hemos de fijarnos
que toma una petición y respuesta genérica, no se limita únicamente
a peticiones y respuestas HTTP.</p>
</div>
<div class="paragraph">
<p>Además también se nos proporciona un objeto que representa
la cadena de filtros. Con él podremos pasar la petición y la
respuesta interceptadas al siguiente filtro de la cadena, o bien al recurso
destino en caso de que ya no hubiese más filtros. Esto lo haremos con
una llamada a:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">    <span class="tok-o">...</span>
    <span class="tok-n">chain</span><span class="tok-o">.</span><span class="tok-na">doFilter</span><span class="tok-o">(</span><span class="tok-n">request</span><span class="tok-o">,</span> <span class="tok-n">response</span><span class="tok-o">);</span>
    <span class="tok-o">...</span> <span class="tok-c1">// En este punto el servidor ya habrá producido</span>
        <span class="tok-c1">//la respuesta en response</span>

  <span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Justo después de haber llamado a este método, ya se habrá
producido la respuesta, ya que con él estamos indicando que se ejecuten
todos los filtros que siguen al nuestro en la cadena, y en último lugar
el recurso solicitado.</p>
</div>
<div class="paragraph">
<p>Por lo tanto, todas las modificaciones que queramos hacer en la petición
que va a llegar al recurso las deberemos hacer antes de la llamada a este
método, mientras que todo procesamiento que queramos hacer de la respuesta
se hará después de esta llamada, que será cuando se haya
generado.</p>
</div>
<div class="paragraph">
<p>También podemos hacer que no se llegue a llamar, si queremos que
nuestro filtro de la respuesta por si solo, sin acceder al recurso que se
había pedido. Esto lo haremos por ejemplo cuando queramos prohibir
el acceso a un recurso.</p>
</div>
<div class="paragraph">
<p>Otros métodos que debemos definir en un filtro son:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">  <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">init</span><span class="tok-o">(</span><span class="tok-n">FilterConfig</span> <span class="tok-n">config</span><span class="tok-o">)</span> <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span> <span class="tok-o">{</span>
    <span class="tok-c1">// Código de inicialización del filtro</span>
    <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">config</span> <span class="tok-o">=</span> <span class="tok-n">config</span><span class="tok-o">;</span>
    <span class="tok-o">...</span>

  <span class="tok-o">}</span>

  <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">destroy</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-c1">// Libera recursos del filtro</span>
    <span class="tok-n">config</span> <span class="tok-o">=</span> <span class="tok-kc">null</span><span class="tok-o">;</span>
    <span class="tok-o">...</span>
  <span class="tok-o">}</span>

  <span class="tok-o">...</span>

<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Que serán llamados en la inicialización y en la destrucción de este componente  respectivamente.</p>
</div>
</div>
<div class="sect3">
<h4 id="_acceso_al_contexto">7.1.6. Acceso al contexto</h4>
<div class="paragraph">
<p>Acabamos de ver que cuando se inicializa el filtro se llama a su método <code>init</code>. En esta llamada se proporciona un objeto <code>FilterConfig</code>
que contiene    información sobre los parámetros del filtro,
que vimos en el apartado de configuración,    y además nos permite
acceder a la información global de contexto.</p>
</div>
<div class="paragraph">
<p>Para leer los parámetros del filtro especificados en el descriptor
de    despliegue de la aplicación web (fichero <code>web.xml</code> en Tomcat
como    hemos visto), este objeto proporciona el siguiente método:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">String</span> <span class="tok-n">valor</span> <span class="tok-o">=</span> <span class="tok-n">config</span><span class="tok-o">.</span><span class="tok-na">getInitParameter</span><span class="tok-o">(</span><span class="tok-n">nombre_param</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Esta llamada nos devolverá una cadena con el valor del parámetro,
   o null en el caso de que el parámetro indicado no existiese. Si
queremos    obtener la lista de parámetros definidos en el descriptor
de despliegue,    podemos usar el siguiente método:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">Enumeration</span> <span class="tok-n">parametros</span> <span class="tok-o">=</span> <span class="tok-n">config</span><span class="tok-o">.</span><span class="tok-na">getInitParameterNames</span><span class="tok-o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Con esto obtendremos una enumeración de todos los nombres de parámetros
   definidos.</p>
</div>
<div class="paragraph">
<p>Este objeto también nos permite obtener el nombre del filtro, que
se    habrá definido en el descriptor de despliegue, con el método:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">String</span> <span class="tok-n">nombre</span> <span class="tok-o">=</span> <span class="tok-n">config</span><span class="tok-o">.</span><span class="tok-na">getFilterName</span><span class="tok-o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Este objeto además nos permitirá acceder al objeto de contexto
   global del contenedor de servlets, mediante el método:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">ServletContext</span> <span class="tok-n">context</span> <span class="tok-o">=</span> <span class="tok-n">config</span><span class="tok-o">.</span><span class="tok-na">getServletContext</span><span class="tok-o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Obtenemos este objeto con el cual podremos acceder a los atributos globales
   definidos en nuestra aplicación web, y además nos proporciona
   una serie de métodos que nos permitirán realizar en filtros
las    mismas operaciones que podíamos hacer en los servlets.</p>
</div>
<div class="paragraph">
<p>Será importante acceder a este objeto desde los filtros, ya que
si queremos    realizar redirecciones, o acceso a recursos estáticos
por ejemplo, necesitaremos    contar con dicho objeto.</p>
</div>
</div>
<div class="sect3">
<h4 id="_ciclo_de_vida_de_un_filtro">7.1.7. Ciclo de vida de un filtro</h4>
<div class="paragraph">
<p>Justo después del despliegue de la aplicación web, y antes
de    que se produzca cualquier petición a un recurso, el contenedor
localizará    los filtros que deben ser aplicados a cada recurso. Instanciará
los filtros    que hayamos declarado, y tras ello llamará al método <code>init</code>    de cada filtro para inicializarlo.</p>
</div>
<div class="paragraph">
<p>Si hacemos que este método <code>init</code> lance una excepción
<code>UnavailableException</code> estaremos indicando que el filtro no puede funcionar
correctamente. Esta    excepción tiene un método <code>isPermament</code> que indicará    si el fallo es permanente o puede recuperarse
pasado un tiempo. De no ser permanente    el contenedor intentará volver
a instanciar el filtro más adelante.    Podemos establecer en la excepción
un tiempo estimado que puede tardar    en estar disponible, para informar
al contenedor de cuando puede volver a intentar    instanciarlo.</p>
</div>
<div class="paragraph">
<p>Al método <code>init</code> se le proporcionará el objeto <code>FilterConfig</code>,
   con la información de los parámetros y nombre del filtro
obtenidos    del descriptor de despliegue, además de una referencia
al objeto <code>ServletContext</code>    de la aplicación web, como hemos
visto en el apartado anterior.</p>
</div>
<div class="paragraph">
<p>Una vez terminada la fase de inicialización, el servidor ya podrá
   empezar a recibir peticiones. Cuando se produzca una petición, el
contenedor    localizará el primer filtro asociado a dicho recurso,
y llamará    a su método <code>doFilter</code> proporcionando los
objetos <code>ServletRequest</code>,    <code>ServletResponse</code>, y <code>FilterChain</code>.
Una vez hecho esto será    responsabilidad de nuestro filtro tratar
estos objetos, y decidir si pasar el    procesamiento al siguiente filtro
de la cadena.</p>
</div>
<div class="paragraph">
<p>Cuando lleguemos al ultimo filtro de la cadena, al llamar a <code>doChain</code>
   se invocará directamente el recurso que se solicitaba en la petición.</p>
</div>
<div class="paragraph">
<p>Si durante <code>doFilter</code> lanzamos una excepción <code>UnavailableException</code>,
  el contenedor no intentará seguir procesando la cadena de filtros. Si
  hemos indicado que es no permanente, tras un rato reintentará procesar
  la cadena entera.</p>
</div>
<div class="paragraph">
<p>Antes de poder hacer que el filtro deje de estar en servicio, llamará
  a su método <code>destroy</code> para que libere los recursos que sea necesario.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_wrappers">7.2. Wrappers</h3>
<div class="paragraph">
<p>Hasta ahora hemos visto como interceptar la petición que se realiza
   a un determinado recurso de nuestra web mediante filtros, pero, &iquest;y
si    queremos interceptar la respuesta que nos devuelve el servidor para
analizarla    o modificarla?</p>
</div>
<div class="paragraph">
<p>Cuando desde nuestro filtro pasemos el procesamiento de la petición
   al siguiente elemento de la cadena (<code>doFilter</code>), delegaremos en este
siguiente    elemento el procesamiento de la petición y la generación
de la    respuesta. Supongamos que este elemento es el recurso final que
se había    solicitado. En este caso el contenido de este recurso
será escrito en    el objeto respuesta, lo cual producirá que
dicho contenido sea devuelto    al cliente.</p>
</div>
<div class="paragraph">
<p>Sin embargo, nosotros no queremos que sea devuelto directamente al cliente,
   sino que queremos procesarla previamente en nuestro filtro antes de devolverla.
   Con este objeto <code>ServletResponse</code> (<code>HttpServletResponse</code>) no
podremos hacer esto,    ya que cuando se escribe en él lo que se hace
es devolver la respuesta    al cliente, y una vez escrita no podemos acceder
nuevamente a ella ni modificarla.</p>
</div>
<div class="paragraph">
<p>La solución a nuestro problema es sustituir el objeto respuesta
que    proporcionamos al siguiente elemento de la cadena por un objeto de
respuesta    creado por nosotros.</p>
</div>
<div class="sect3">
<h4 id="__qué_es_un_wrapper">7.2.1. ¿Qué es un wrapper?</h4>
<div class="paragraph">
<p>Un <em>wrapper</em> es un objeto que envuelve al objeto original, de forma
que no se    acceda directamente al objeto original sino al <em>wrapper</em>.
El <em>wrapper</em> implementará    la misma interfaz del objeto al
que envuelve, de forma que externamente se trabajará    con él
de la misma forma, por lo que podemos sustituir el original por    el <em>wrapper</em>
siendo esto transparente a los sucesivos elementos que vayan a manipular
   este objeto.</p>
</div>
<div class="paragraph">
<p>Cuando se llame a un método del <em>wrapper</em> podrá, o
bien redirigir    la llamada al correspondiente método del objeto
original al que envuelve,    o bien tratar por si mismo la llamada a dicho
método. De esta forma,    podremos redefinir el comportamiento que
tendrán determinadas operaciones.</p>
</div>
<div class="paragraph">
<p>Encontramos para nuestro fin <em>wrappers</em> para la petición y la respuesta:
  <code>ServletRequestWrapper</code> (<code>HttpServletRequestWrapper</code>) y <code>ServletResponseWrapper</code>
  (<code>HttpServletResponseWrapper</code>). Con ellos podremos crear implementaciones
  propias del objeto petición y respuesta que envuelvan a los originales,
  pudiendo de esta forma redefinir el comportamiento de determinadas operaciones.</p>
</div>
<div class="paragraph">
<p>Nos centraremos en el <em>wrapper</em> de la respuesta. Con él podemos
evitar    que la respuesta se envie directamente al cliente. En lugar de
esto, cuando    se escriba la salida en este objeto <em>wrapper</em> de la
respuesta podemos hacer que    guarde dicha salida en un buffer interno.
Una vez procesados todos los elementos    de la cadena que están después
de nuestro filtro (tras llamar    a <code>doFilter</code>), se habrá escrito
la salida generada en el <em>buffer</em> del <em>wrapper</em>.    En este momento
podemos analizar esta salida, modificarla si es necesario, y    enviarla
a través del objeto respuesta original.</p>
</div>
</div>
<div class="sect3">
<h4 id="_implementación_de_un_wrapper">7.2.2. Implementación de un wrapper</h4>
<div class="paragraph">
<p>Para implementar un wrapper deberemos crearnos una subclase de la clase del
  <em>wrapper</em> adecuado para nuestro caso (petición o respuesta), y redefinir
  en esta subclase las operaciones cuyo comportamiento queramos cambiar. El funcionamiento
  por defecto de las operaciones que no redefinamos será redirigir la petición
  al método correspondiente del objeto (petición o respuesta) original.</p>
</div>
<div class="paragraph">
<p>Vamos a ver esto con un ejemplo de implementación de un wrapper
de la    respuesta que guarda en un buffer la respuesta generada por el servidor,
para    poder ser procesada por nuestro filtro.</p>
</div>
<div class="paragraph">
<p>Puesto que queremos envolver la respuesta, tendremos que crearnos una
subclase    de <code>ServletResponseWrapper</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">GenericResponseWrapper</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServletResponseWrapper</span> <span class="tok-o">{</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Dentro de esta clase deberemos tener el buffer donde vayamos a escribir
la    salida. Dado que en la salida se puede escribir tanto como flujo de
bytes como    de caractéres, para que sea más genérico
convendrá    crear el buffer como array de bytes, de forma que se
pueda escribir en él    de las dos formas:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">  <span class="tok-kd">private</span> <span class="tok-n">ByteArrayOutputStream</span> <span class="tok-n">output</span><span class="tok-o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En el constructor de la clase simplemente deberemos proporcionar el objeto
respuesta  original (al cual estaremos envolviendo). Lo que hacemos aquí
es utilizar  el constructor de la superclase proporcionándole la respuesta
original,  de forma que se encargue de redirigir a él las operaciones
predeterminadas.  Además deberemos crear nuestro buffer de bytes donde
se escribirá  la respuesta:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">  <span class="tok-kd">public</span> <span class="tok-nf">GenericResponseWrapper</span><span class="tok-o">(</span><span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-kd">super</span><span class="tok-o">(</span><span class="tok-n">response</span><span class="tok-o">);</span>
    <span class="tok-n">output</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">ByteArrayOutputStream</span><span class="tok-o">();</span>
  <span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Proporcionaremos además un método para obtener los datos escritos
   en el buffer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">  <span class="tok-kd">public</span> <span class="tok-kt">byte</span><span class="tok-o">[]</span> <span class="tok-nf">getData</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-k">return</span> <span class="tok-n">output</span><span class="tok-o">.</span><span class="tok-na">toByteArray</span><span class="tok-o">();</span>
  <span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cuando alguien quiera devolver una respuesta al cliente lo que hará
   será obtener el flujo de salida del objeto respuesta y escribir
en él.    Por defecto este flujo envia los datos al cliente. Sin embargo
podemos evitar    que esto ocurra haciendo que los flujos que devuelva sirvan
para escribir en    el buffer, y no para enviar la respuesta al cliente.
Se puede enviar la respuesta    de dos formas: mediante un flujo de bytes
(<code>getOutputStream</code>), o mediante un flujo    de carácteres (<code>getWriter</code>),
por lo que deberemos redefinir ambos métodos.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">  <span class="tok-kd">public</span> <span class="tok-n">ServletOutputStream</span> <span class="tok-nf">getOutputStream</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-k">return</span> <span class="tok-k">new</span> <span class="tok-nf">FilterServletOutputStream</span><span class="tok-o">(</span><span class="tok-n">output</span><span class="tok-o">);</span>
  <span class="tok-o">}</span>

  <span class="tok-kd">public</span> <span class="tok-n">PrintWriter</span> <span class="tok-nf">getWriter</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-k">return</span> <span class="tok-k">new</span> <span class="tok-nf">PrintWriter</span><span class="tok-o">(</span><span class="tok-n">getOutputStream</span><span class="tok-o">(),</span> <span class="tok-kc">true</span><span class="tok-o">);</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En el caso del flujo de bytes, deberemos devolverlo como un <code>ServletOutputStream</code>.
   Por lo tanto tendremos que crearnos un tipo propio de <code>ServletOutputStream</code>
que    escriba en nuestro buffer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">FilterServletOutputStream</span> <span class="tok-kd">extends</span> <span class="tok-n">ServletOutputStream</span> <span class="tok-o">{</span>
    <span class="tok-kd">private</span> <span class="tok-n">DataOutputStream</span> <span class="tok-n">stream</span><span class="tok-o">;</span>

    <span class="tok-kd">public</span> <span class="tok-nf">FilterServletOutputStream</span><span class="tok-o">(</span><span class="tok-n">OutputStream</span> <span class="tok-n">output</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">stream</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">DataOutputStream</span><span class="tok-o">(</span><span class="tok-n">output</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">write</span><span class="tok-o">(</span><span class="tok-kt">int</span> <span class="tok-n">b</span><span class="tok-o">)</span> <span class="tok-kd">throws</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
        <span class="tok-n">stream</span><span class="tok-o">.</span><span class="tok-na">write</span><span class="tok-o">(</span><span class="tok-n">b</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">write</span><span class="tok-o">(</span><span class="tok-kt">byte</span><span class="tok-o">[]</span> <span class="tok-n">b</span><span class="tok-o">)</span> <span class="tok-kd">throws</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
        <span class="tok-n">stream</span><span class="tok-o">.</span><span class="tok-na">write</span><span class="tok-o">(</span><span class="tok-n">b</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">write</span><span class="tok-o">(</span><span class="tok-kt">byte</span><span class="tok-o">[]</span> <span class="tok-n">b</span><span class="tok-o">,</span> <span class="tok-kt">int</span> <span class="tok-n">off</span><span class="tok-o">,</span> <span class="tok-kt">int</span> <span class="tok-n">len</span><span class="tok-o">)</span> <span class="tok-kd">throws</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
        <span class="tok-n">stream</span><span class="tok-o">.</span><span class="tok-na">write</span><span class="tok-o">(</span><span class="tok-n">b</span><span class="tok-o">,</span> <span class="tok-n">off</span><span class="tok-o">,</span> <span class="tok-n">len</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Este será el flujo que utilicemos para escribir la respuesta en
forma    de bytes en nuestro buffer interno.</p>
</div>
<div class="paragraph">
<p>Aunque a primera vista parezca compleja la creación de dicho <em>wrapper</em>,
   tiene la ventaja de ser reutilizable para cualquier aplicación
en la    que necesitemos interceptar la respuesta generada por el servidor.</p>
</div>
</div>
<div class="sect3">
<h4 id="_utilización_de_un_wrapper">7.2.3. Utilización de un wrapper</h4>
<div class="paragraph">
<p>Para utilizar el <em>wrapper</em> que hemos creado, deberemos instanciarlo
a partir    del objeto de respuesta original que le ha sido proporcionado
a nuestro filtro.    Esto lo haremos antes de que se haya generado el contenido
del recurso solicitado,    es decir, antes de llamar a <code>doFilter</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">doFilter</span><span class="tok-o">(</span><span class="tok-n">ServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
      <span class="tok-n">ServletResponse</span> <span class="tok-n">response</span><span class="tok-o">,</span> <span class="tok-n">FilterChain</span> <span class="tok-n">chain</span><span class="tok-o">)</span>
<span class="tok-o">{</span>
  <span class="tok-o">...</span>
  <span class="tok-n">GenericResponseWrapper</span> <span class="tok-n">wrapper</span> <span class="tok-o">=</span>
      <span class="tok-k">new</span> <span class="tok-nf">GenericReponseWrapper</span><span class="tok-o">(</span><span class="tok-n">response</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Una vez hemos creado nuestro propio objeto respuesta que envuelve a la
respuesta    original, podemos utilizarlo para que el servidor escriba el
contenido del recurso    solicitado en él. Para esto realizaremos
la llamada a <code>doFilter</code> proporcionando    como respuesta este <em>wrapper</em>
que hemos creado:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">  <span class="tok-n">chain</span><span class="tok-o">.</span><span class="tok-na">doFilter</span><span class="tok-o">(</span><span class="tok-n">request</span><span class="tok-o">,</span> <span class="tok-n">wrapper</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Una vez ejecutado este método se habrá generado la respuesta
   en el objeto de respuesta proporcionado, en este caso habrá sido
en nuestro    <em>wrapper</em>. Por lo tanto podemos obtener y procesar la
respuesta según la    función de nuestro filtro:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">  <span class="tok-kt">byte</span> <span class="tok-o">[]</span> <span class="tok-n">datos</span> <span class="tok-o">=</span> <span class="tok-n">wrapper</span><span class="tok-o">.</span><span class="tok-na">getData</span><span class="tok-o">();</span>

  <span class="tok-o">...</span> <span class="tok-c1">// Procesar datos segun la funcion del filtro</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por último, para que el cliente pueda ver esta respuesta, deberemos
   escribirla en el objeto respuesta original:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">  <span class="tok-n">OutputStream</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getOutputStream</span><span class="tok-o">();</span>
  <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">write</span><span class="tok-o">(</span><span class="tok-n">datos</span><span class="tok-o">);</span>
  <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Con esto vemos que habremos podido procesar la salida generada en nuestro
filtro,    y enviarla al cliente para que pueda ser visualizada correctamente.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ejemplos_3">7.3. Ejemplos</h3>
<div class="paragraph">
<p>Vamos a ver a continuación una serie de ejemplos de usos comunes
de    los filtros, y cómo implementaríamos dichos filtros,
utilizando    distintos elementos que hemos visto durante el curso.</p>
</div>
<div class="sect3">
<h4 id="_acceso_restringido">7.3.1. Acceso restringido</h4>
<div class="paragraph">
<p>Una primera aplicación sencilla de los filtros es prohibir el acceso
   a cierta parte de nuestra web. Cuando un usuario intente acceder a dicha
parte,    se comprobará si este usuario está registrado. Si
lo está    se le dejará pasar normalmente, pero si no se prohibirá
el acceso,    redireccionando a la página de login de usuarios.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">RestringirAcceso</span> <span class="tok-kd">implements</span> <span class="tok-n">Filter</span> <span class="tok-o">{</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cuando se invoca el filtro querrá decir que un usuario intenta
acceder    a la zona restringida.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">doFilter</span><span class="tok-o">(</span><span class="tok-n">ServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
      <span class="tok-n">ServletResponse</span> <span class="tok-n">response</span><span class="tok-o">,</span> <span class="tok-n">FilterChain</span> <span class="tok-n">chain</span><span class="tok-o">)</span>
    <span class="tok-o">{</span>
        <span class="tok-c1">// Se intenta acceder a la zona restringida</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Comprobamos si el usuario está registrado en el servidor. Para
ello    utilizamos la información de sesión, donde almacenaremos
el login    del usuario en caso de estar registrado.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">        <span class="tok-c1">// Solo podemos comprobar la sesión</span>
        <span class="tok-c1">// en el caso de tener una petición HTTP</span>

        <span class="tok-k">if</span><span class="tok-o">(</span><span class="tok-n">request</span> <span class="tok-k">instanceof</span> <span class="tok-n">HttpServletRequest</span> <span class="tok-o">&amp;&amp;</span>
            <span class="tok-n">response</span> <span class="tok-k">instanceof</span> <span class="tok-n">HttpServletResponse</span><span class="tok-o">)</span>
        <span class="tok-o">{</span>

            <span class="tok-n">HttpServletRequest</span> <span class="tok-n">http_request</span> <span class="tok-o">=</span>
                       <span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span><span class="tok-o">)</span><span class="tok-n">request</span><span class="tok-o">;</span>
            <span class="tok-n">HttpServletResponse</span> <span class="tok-n">http_response</span> <span class="tok-o">=</span>
                       <span class="tok-o">(</span><span class="tok-n">HttpServletResponse</span><span class="tok-o">)</span><span class="tok-n">response</span><span class="tok-o">;</span>

            <span class="tok-c1">// * Comprobamos si el usuario se ha registrado *</span>
            <span class="tok-c1">// En nuestra aplicación si el usuario</span>
            <span class="tok-c1">// se ha registrado habremos establecido</span>
            <span class="tok-c1">// el atributo usuario de la sesion al</span>
            <span class="tok-c1">// nombre del usuario, si no será null.</span>

            <span class="tok-k">if</span><span class="tok-o">(</span><span class="tok-n">http_request</span><span class="tok-o">.</span><span class="tok-na">getSession</span><span class="tok-o">().</span><span class="tok-na">getAttribute</span><span class="tok-o">(</span><span class="tok-s">&quot;usuario&quot;</span><span class="tok-o">)!=</span><span class="tok-kc">null</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si hay un login almacenado, procesamos la petición de forma normal.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">            <span class="tok-o">{</span>
                <span class="tok-c1">// Continuamos de forma normal con la petición</span>
                <span class="tok-n">chain</span><span class="tok-o">.</span><span class="tok-na">doFilter</span><span class="tok-o">(</span><span class="tok-n">request</span><span class="tok-o">,</span> <span class="tok-n">response</span><span class="tok-o">);</span>
            <span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si no, redireccionamos a la página de login, para que el usuario
se    registre.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">            <span class="tok-k">else</span>
            <span class="tok-o">{</span>
                <span class="tok-c1">// Redireccionamos a la página de login</span>
                <span class="tok-n">http_response</span><span class="tok-o">.</span><span class="tok-na">sendRedirect</span><span class="tok-o">(</span><span class="tok-s">&quot;/ejemplo/login.jsp&quot;</span><span class="tok-o">);</span>
            <span class="tok-o">}</span>
        <span class="tok-o">}</span> <span class="tok-k">else</span> <span class="tok-o">{</span>
            <span class="tok-c1">// Si no es una petición HTTP</span>
            <span class="tok-c1">// simplemente procesamos la petición</span>

            <span class="tok-n">chain</span><span class="tok-o">.</span><span class="tok-na">doFilter</span><span class="tok-o">(</span><span class="tok-n">request</span><span class="tok-o">,</span> <span class="tok-n">response</span><span class="tok-o">);</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ranking_de_páginas_más_visitadas">7.3.2. Ranking de páginas más visitadas</h4>
<div class="paragraph">
<p>Otra posible aplicación es registrar el número de visitas
que    se hacen a cada página, de forma que podremos obtener un listado
de las    páginas favoritas de los usuarios dentro de nuestro sitio
web. Para ello    instalaremos un filtro que intercepte las peticiones a
cualquier página.    Cada vez que el filtro se invoque, querrá
decir que se ha visitado una    página. Lo que deberemos hacer en
este momento es:</p>
</div>
<div class="paragraph">
<p>Determinar la dirección de la página que se ha solicitado</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Ranking</span> <span class="tok-kd">implements</span> <span class="tok-n">Filter</span> <span class="tok-o">{</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">doFilter</span><span class="tok-o">(</span><span class="tok-n">ServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
      <span class="tok-n">ServletResponse</span> <span class="tok-n">response</span><span class="tok-o">,</span> <span class="tok-n">FilterChain</span> <span class="tok-n">chain</span><span class="tok-o">)</span>
    <span class="tok-o">{</span>
        <span class="tok-c1">// Solo podemos ver el recurso solititado en el</span>
        <span class="tok-c1">// caso de tener una petición HTTP</span>

        <span class="tok-k">if</span><span class="tok-o">(</span><span class="tok-n">request</span> <span class="tok-k">instanceof</span> <span class="tok-n">HttpServletRequest</span><span class="tok-o">)</span>
        <span class="tok-o">{</span>
            <span class="tok-n">HttpServletRequest</span> <span class="tok-n">http_request</span> <span class="tok-o">=</span>
                            <span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span><span class="tok-o">)</span><span class="tok-n">request</span><span class="tok-o">;</span>

            <span class="tok-c1">// Miramos que recurso está siendo solicitado</span>
            <span class="tok-n">String</span> <span class="tok-n">uri</span> <span class="tok-o">=</span> <span class="tok-n">http_request</span><span class="tok-o">.</span><span class="tok-na">getRequestURI</span><span class="tok-o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Tendremos una base de datos con una entrada para cada página, donde
   se contabilizan el número de visitas. Si no existe entrada para
la página    visitada, la crearemos con una visita.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">            <span class="tok-n">PaginasDAO</span> <span class="tok-n">dao</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">PaginasDAO</span><span class="tok-o">();</span>

            <span class="tok-k">if</span><span class="tok-o">(</span><span class="tok-n">dao</span><span class="tok-o">.</span><span class="tok-na">existePagina</span><span class="tok-o">(</span><span class="tok-n">uri</span><span class="tok-o">)</span>
            <span class="tok-o">{</span>
                <span class="tok-c1">// La página ya esta registrada en la BD</span>
                <span class="tok-c1">// y solo tenemos que incrementar su contador</span>
                <span class="tok-n">dao</span><span class="tok-o">.</span><span class="tok-na">incrementaContador</span><span class="tok-o">(</span><span class="tok-n">uri</span><span class="tok-o">);</span>
            <span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si ya existe entrada para esta página en la BD, incrementaremos
el número    de visitas.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">            <span class="tok-k">else</span>
            <span class="tok-o">{</span>
                <span class="tok-c1">// La página se está visitando por primera vez</span>
                <span class="tok-c1">// Debemos registrarla en la BD</span>
                <span class="tok-c1">// con contador a 1 (1 visita)</span>

                <span class="tok-n">dao</span><span class="tok-o">.</span><span class="tok-na">insertaPagina</span><span class="tok-o">(</span><span class="tok-n">uri</span><span class="tok-o">);</span>
            <span class="tok-o">}</span>
        <span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Procesamos la petición de forma normal.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">        <span class="tok-n">chain</span><span class="tok-o">.</span><span class="tok-na">doFilter</span><span class="tok-o">(</span><span class="tok-n">request</span><span class="tok-o">,</span> <span class="tok-n">response</span><span class="tok-o">);</span>
    <span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_extracción_automática_de_información">7.3.3. Extracción automática de información</h4>
<div class="paragraph">
<p>Imaginemos que en el ranking queremos, además de la dirección,
   registrar el título de la página. A partir de la información
   de la petición y la respuesta ordinaria no podemos obtener dicha
información,    ya que se refiere al contenido de la página.
Para ello tendremos que    utilizar un wrapper, que obtenga la respuesta
generada por el servidor, de manera    que podamos analizarla y extraer de
ella el título de la página.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">RankingTitulo</span> <span class="tok-kd">implements</span> <span class="tok-n">Filter</span> <span class="tok-o">{</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">doFilter</span><span class="tok-o">(</span><span class="tok-n">ServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
      <span class="tok-n">ServletResponse</span> <span class="tok-n">response</span><span class="tok-o">,</span> <span class="tok-n">FilterChain</span> <span class="tok-n">chain</span><span class="tok-o">)</span>
    <span class="tok-o">{</span>
        <span class="tok-c1">// Solo podemos ver el recurso solititado en el caso</span>
        <span class="tok-c1">// de tener una petición HTTP</span>

        <span class="tok-k">if</span><span class="tok-o">(</span><span class="tok-n">request</span> <span class="tok-k">instanceof</span> <span class="tok-n">HttpServletRequest</span> <span class="tok-o">&amp;&amp;</span>
            <span class="tok-n">response</span> <span class="tok-k">instanceof</span> <span class="tok-n">HttpServletResponse</span><span class="tok-o">)</span>
        <span class="tok-o">{</span>

            <span class="tok-n">HttpServletRequest</span> <span class="tok-n">http_request</span> <span class="tok-o">=</span>
                       <span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span><span class="tok-o">)</span><span class="tok-n">request</span><span class="tok-o">;</span>
            <span class="tok-n">HttpServletResponse</span> <span class="tok-n">http_response</span> <span class="tok-o">=</span>
                       <span class="tok-o">(</span><span class="tok-n">HttpServletResponse</span><span class="tok-o">)</span><span class="tok-n">response</span><span class="tok-o">;</span>

            <span class="tok-c1">// Miramos que recurso está siendo solicitado</span>
            <span class="tok-n">String</span> <span class="tok-n">uri</span> <span class="tok-o">=</span> <span class="tok-n">http_request</span><span class="tok-o">.</span><span class="tok-na">getRequestURI</span><span class="tok-o">();</span>

            <span class="tok-n">PaginasDAO</span> <span class="tok-n">dao</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">PaginasDAO</span><span class="tok-o">();</span>

            <span class="tok-k">if</span><span class="tok-o">(</span><span class="tok-n">dao</span><span class="tok-o">.</span><span class="tok-na">existePagina</span><span class="tok-o">(</span><span class="tok-n">uri</span><span class="tok-o">)</span>
            <span class="tok-o">{</span>
                <span class="tok-c1">// La página ya esta registrada en la BD</span>
                <span class="tok-c1">// y solo tenemos que incrementar su contador</span>
                <span class="tok-n">dao</span><span class="tok-o">.</span><span class="tok-na">incrementaContador</span><span class="tok-o">(</span><span class="tok-n">uri</span><span class="tok-o">);</span>
            <span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cuando se visite una página por primera vez, para registrarla en
la    base de datos tendremos que obtener la información del título.
Creamos un wrapper, y procesamos la petición utilizando dicho wrapper
   como objeto respuesta.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">            <span class="tok-k">else</span>
            <span class="tok-o">{</span>
                <span class="tok-c1">// La página se está visitando por primera vez</span>
                <span class="tok-c1">// Debemos obtener su titulo para registrarla en la BD</span>

                <span class="tok-c1">// Envolvemos la respuesta con nuestro wrapper generico</span>
                <span class="tok-n">GenericResponseWrapper</span> <span class="tok-n">wrapper</span> <span class="tok-o">=</span>
                       <span class="tok-k">new</span> <span class="tok-nf">GenericResponseWrapper</span><span class="tok-o">(</span><span class="tok-n">http_response</span><span class="tok-o">);</span>

                <span class="tok-c1">// Procesamos la petición</span>
                <span class="tok-n">chain</span><span class="tok-o">.</span><span class="tok-na">doFilter</span><span class="tok-o">(</span><span class="tok-n">http_request</span><span class="tok-o">,</span> <span class="tok-n">wrapper</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Una vez hecho esto, tendremos en el wrapper el contenido de la página
  generado. Podemos obtenerlo y analizarlo, buscando en él la etiqueta
  <code>&lt;title&gt;</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">                <span class="tok-c1">// En este momento ya diponemos</span>
                <span class="tok-c1">// de la respuesta en el wrapper</span>

                <span class="tok-c1">// La analizamos para obtener el</span>
                <span class="tok-c1">// valor de su etiqueta &lt;title&gt;</span>

                <span class="tok-kt">byte</span> <span class="tok-o">[]</span> <span class="tok-n">datos</span> <span class="tok-o">=</span> <span class="tok-n">wrapper</span><span class="tok-o">.</span><span class="tok-na">getData</span><span class="tok-o">();</span>
                <span class="tok-n">HtmlParser</span> <span class="tok-n">parser</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">HtmlParser</span><span class="tok-o">(</span><span class="tok-n">datos</span><span class="tok-o">);</span>
                <span class="tok-n">String</span> <span class="tok-n">titulo</span> <span class="tok-o">=</span> <span class="tok-n">parser</span><span class="tok-o">.</span><span class="tok-na">getTitle</span><span class="tok-o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Una vez obtenido el título, podremos registrar en la base de datos
la    entrada de la página.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">                <span class="tok-c1">// Ahora podemos registrar ya la página con sus datos</span>
                <span class="tok-n">dao</span><span class="tok-o">.</span><span class="tok-na">insertaPagina</span><span class="tok-o">(</span><span class="tok-n">uri</span><span class="tok-o">,</span> <span class="tok-n">titulo</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por último, tendremos que hacer que la respuesta del wrapper pase
al    cliente, enviándola al objeto respuesta original.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">                <span class="tok-c1">// Por último, debemos devolver</span>
                <span class="tok-c1">// la respuesta al cliente de forma</span>
                <span class="tok-c1">// que pueda visualizar el recurso solicitado</span>
                <span class="tok-n">OutputStream</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getOutputStream</span><span class="tok-o">();</span>
                <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">write</span><span class="tok-o">(</span><span class="tok-n">datos</span><span class="tok-o">);</span>
                <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
            <span class="tok-o">}</span>
        <span class="tok-o">}</span> <span class="tok-k">else</span> <span class="tok-o">{</span>
            <span class="tok-c1">// Si no es HTTP procesamos la petición de forma ordinaria</span>
            <span class="tok-n">chain</span><span class="tok-o">.</span><span class="tok-na">doFilter</span><span class="tok-o">(</span><span class="tok-n">request</span><span class="tok-o">,</span> <span class="tok-n">response</span><span class="tok-o">);</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>

<span class="tok-o">}</span></code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios_7">7.4. Ejercicios</h3>
<div class="sect3">
<h4 id="_filtro_de_acceso_restringido_0_puntos">7.4.1. Filtro de acceso restringido (0 puntos)</h4>
<div class="paragraph">
<p>Vamos a probar la aplicación <code>cweb-filtros</code> en la que tenemos
  un filtro <code>RestringirAcceso</code> que prohibe el acceso de los usuarios
  no registrados al contenido del directorio <code>restringido</code>. Se pide:</p>
</div>
<div class="paragraph">
<p><em>a)</em> Desplegar la aplicación en Tomcat. Una vez instalada
    comprobamos que la aplicación
    se ha instalado correctamente. Tras esto intentamos acceder a uno de los recursos
    del directorio <code>restringido</code>:</p>
</div>
<div class="paragraph">
<p><a href="http://localhost:8080/cweb-filtros/restringido/index.html" class="bare">http://localhost:8080/cweb-filtros/restringido/index.html</a></p>
</div>
<div class="paragraph">
<p><a href="http://localhost:8080/cweb-filtros/restringido/index.jsp" class="bare">http://localhost:8080/cweb-filtros/restringido/index.jsp</a></p>
</div>
<div class="paragraph">
<p>¿Qué ocurre? ¿Por qué?</p>
</div>
<div class="paragraph">
<p><em>b)</em> Validarse como usuario y volver a intentar acceder al directorio <code>restringido</code>.
    &iquest;Ahora que ocurre? &iquest;Qué ventajas tiene implementar esta
    restricción de acceso mediante un filtro?</p>
</div>
</div>
<div class="sect3">
<h4 id="_restringir_el_acceso_al_chat_0_5_puntos">7.4.2. Restringir el acceso al chat (0.5 puntos)</h4>
<div class="paragraph">
<p>Recordemos que en sesiones anteriores realizamos
  un chat mediante servlets, en el que había que registrarse como usuario
  antes de entrar a hablar. Sin embargo, si se introduce directamente la dirección:</p>
</div>
<div class="paragraph">
<p><a href="http://localhost:8080/cweb-chat/chat/chatFrames.html" class="bare">http://localhost:8080/cweb-chat/chat/chatFrames.html</a></p>
</div>
<div class="paragraph">
<p>Podemos acceder directamente al chat sin estar registrados. Se pide:</p>
</div>
<div class="paragraph">
<p><em>a)</em> Implementar un filtro en el chat que restrinja el acceso al chat si no
    se ha registrado un <em>nick</em> en la sesión.</p>
</div>
<div class="paragraph">
<p><em>b)</em> ¿A qué recursos deberá afectar este filtro? Introducir
    la configuración
    necesaria para que el filtro intercepte los intentos de acceso a los recursos
    restringidos.</p>
</div>
</div>
<div class="sect3">
<h4 id="_wrapper_de_ejemplo_0_puntos">7.4.3. Wrapper de ejemplo (0 puntos)</h4>
<div class="paragraph">
<p>La aplicación <code>cweb-wrapper</code> incorpora
  un filtro que utiliza un <em>wrapper</em> para analizar la respuesta generada.
  Toma esta respuesta del <em>wrapper</em> (asumimos que es contenido HTML), y
  la analiza utilizando la librería <em>htmlparser</em>, para extraer su título.
  Una vez tiene el título registra que se ha accedido a dicha página
  en el <em>log</em> y devuelve la respuesta al cliente. Se pide:</p>
</div>
<div class="paragraph">
<p><em>a)</em> Desplegar la aplicación en Tomcat.
    Probar a acceder a varios ficheros HTML estáticos de los incluidos
    dentro de la aplicación. Comprobar que en el <em>log</em> se ha registrado
    el acceso indicando el título de las páginas.</p>
</div>
<div class="paragraph">
<p><em>b)</em> Si tuviesemos recursos que no fuesen HTML (como por ejemplo imágenes)
   dentro de la ruta a la que afecta el filtro, &iquest;que ocurriría?.
   Intentar acceder a una imagen dentro de la aplicación y ver el
error    que se produce. &iquest;A qué se debe esto? &iquest;Como
podríamos    solucionarlo?</p>
</div>
</div>
<div class="sect3">
<h4 id="_registro_de_accesos_0_5_puntos">7.4.4. Registro de accesos (0.5 puntos)</h4>
<div class="paragraph">
<p>Vamos a realizar una aplicación que contabilice
  el número de accesos a las páginas mediante un filtro. Esta aplicación
  tiene el nombre <code>cweb-ranking</code>. Para ello tendremos una lista de páginas en memoria en la que figurará:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ruta</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ruta de la página visitada</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>titulo</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Título de la página</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>accesos</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Número de accesos realizados</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>El servlet <code>RankingPaginasServlet</code> nos genera un listado de las páginas junto al número de visitas que han recibido.</p>
</div>
<div class="paragraph">
<p>Se pide:</p>
</div>
<div class="paragraph">
<p><em>a)</em> Desarrollar el filtro <code>AccesoPaginaFilter</code> que actue sobre
todos    los recursos estáticos, y que contabilice el número
de visitas    que se realiza a ellos almacenando esta información en la lista de páginas.
Deberá cumplir    las siguientes características:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Cuando una página sea visitada por primera vez, se deberá
registrar una nueva en el <code>Map</code> de páginas en memoria, con la URL de la página visitada como clave y el
contador de visitas inicializado a <code>1</code>. Por el momento no
obtendremos el título de la página, ya que para esto se requiere utilizar un
<em>wrapper</em>, así que en este campo introduciremos
siempre el valor <em>(Título desconocido)</em>.</p>
</li>
<li>
<p>Cuando la página ya estuviese registrada en la lista lo que haremos
será incrementar el número de visitas en 1.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>b)</em> Actualizar el filtro <code>AccesoPaginaFilter</code> para que obtenga el título
de la página a la que se ha accedido, utilizando para ello el <em>wrapper</em> genérico
que se proporciona. Deberá cumplir    las siguientes características:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Sólo registrará los recursos cuyo contenido sea html
(tipo      de contenido <code>text/html</code>).</p>
</li>
<li>
<p>Cuando una página sea visitada por primera vez, se deberá
     extraer su título de la etiqueta <code>&lt;title&gt;</code>, para
lo cual      deberá usarse un <em>wrapper</em>. En este caso insertaremos los
datos de la      página en la lista anotando una visita.</p>
</li>
<li>
<p>Cuando la página ya estuviese registrada en la lista, lo que haremos
será incrementar el número de visitas en 1.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>c)</em> Si la página HTML está almacenada en la caché
del navegador,    el acceso no se contabilizará correctamente. &iquest;Qué
cabecera    HTTP podriamos utilizar para solucionar este problema? &iquest;Donde
podriamos    establecer esta cabecera? Establecer las cabeceras necesarias
para evitar el    uso de la caché y comprobar el correcto funcionamiento
de la aplicación.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Para asegurarnos de que funciona correctamente con los diferentes navegadores, podemos
incluir una serie de cabeceras destinadas a evitar que la página se almacene en la caché:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>Cache-control: no-cache
Cache-control: no-store
Pragma: no-cache
Expires: 0</code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion08">8. Facelets, JSTL y lenguajes de expresiones</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_javaserver_faces_y_facelets">8.1. JavaServer Faces y Facelets</h3>
<div class="paragraph">
<p>JavaServer Faces (JSF) es un <em>framework</em> para la creación de aplicaciones web en el lado del servidor. Dentro de este <em>framework</em> encontramos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Una API que nos proporciona <strong>componentes</strong> que podemos utilizar en la interfaz de nuestra aplicación y nos permite gestionar sus eventos y su validación en el lado del servidor. Ejemplos de componentes son los botones, cuadros de texto, imágenes, mensajes de texto, etc.</p>
</li>
<li>
<p>Librerías de <strong>etiquetas</strong> con las que podemos añadir los componentes anteriores a una página web sin necesidad de introducir código Java. Por ejemplo, encontramos etiquetas como <code>&lt;h:form&gt;</code>, <code>&lt;h:inputText&gt;</code>, <code>&lt;h:graphicImage&gt;</code>, <code>&lt;h:selectOneMenu&gt;</code>, etc.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Una página JSF se representa mediante un árbol de componentes, al que se llama <strong>vista</strong>.</p>
</div>
<div class="paragraph">
<p>Los <strong>componentes</strong> que constituyen la vista son elementos reutilizables y configurables como por ejemplo botones, campos de texto, tablas, etc. Todos los componentes se implementan en clases que heredan de <code>UIComponentBase</code>. Estas clases implementan la funcionalidad del componente, pero no la forma de mostrarlo. Esta separación permite crear de forma sencilla varias formas de mostrar un componente reutilizando su funcionalidad. La forma de mostrar un componente se implementa mediante un objeto de tipo <code>Renderer</code>.</p>
</div>
<div class="paragraph">
<p>Podemos tener diferentes <strong>etiquetas</strong> para un mismo componente, de manera que cada una de ellas lo muestre de forma distinta. Por ejemplo, el componente <code>UISelectOne</code> tiene la funcionalidad de permitir seleccionar un único elemento de una lista, pero puede presentarse mediante tres <em>renderers</em> alternativos, por lo que tenemos disponibles tres etiquetas para este mismo componente:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>&lt;h:selectOneListbox&gt;</code>: Se muestra como un cuadro de lista donde aparecen todas las opciones.</p>
</li>
<li>
<p><code>&lt;h:selectOneMenu&gt;</code>: Se muestra como un menú desplegable.</p>
</li>
<li>
<p><code>&lt;h:selectOneRadio&gt;</code>: Se muestra como botones de radio.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Cada etiqueta de la librería HTML de JSF relaciona un componente con un <em>renderer</em> determinado para mostrarlo.</p>
</div>
<div class="paragraph">
<p>Una ventaja de JSF es que separa claramente la presentación de la lógica. Existen diferentes opciones para crear la vista en JSF. Se podría utilizar cualquier tipo de componente en el que podamos incluir las etiquetas que proporciona, como son por ejemplo los JSPs, pero la opción recomendada es la tecnología de <em>Facelets</em>. Vamos a centrarnos en estudiar los <em>Facelets</em> y los distintos elementos que podemos incluir en ellos.</p>
</div>
</div>
<div class="sect2">
<h3 id="_introducción_a_los_facelets">8.2. Introducción a los Facelets</h3>
<div class="paragraph">
<p>Los <em>Facelets</em> consisten en páginas creadas en XHTML, dentro de las cuales podemos utilizar los siguientes elementos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Librerías de <em>tags</em> de Facelets, JSF y JSTL</strong>: Se utilizan fundamentalmente para crear los diferentes componentes de la interfaz de la página, además de especificar la forma de validarlos o de presentar los datos.</p>
</li>
<li>
<p><strong>Lenguaje de expresiones (EL)</strong>: Nos permite relacionar los componentes anteriores con datos de nuestra aplicación, como por ejemplo aquellos contenidos en <em>managed beans</em>, o aquellos que recibimos como parámetros de la petición. Podremos utilizar este lenguaje en el cuerpo de la página o en los atributos de las etiquetas anteriores para consultar o guardar datos en <em>managed beans</em>, realizar operaciones con ellos, etc.</p>
</li>
<li>
<p><strong>Plantillas de componentes y páginas</strong>: Podemos definir la estructura de contenido de nuestras páginas mediante una plantilla, y aplicar esta plantilla a todas ellas. Por ejemplo podremos definir en la plantilla bloques para la cabecera, pie, menú lateral, etc.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>En los siguientes apartados estudiaremos con detalle cada uno de los componentes anteriores.</p>
</div>
<div class="paragraph">
<p>Para crear una aplicación que utilice <em>Facelets</em> deberemos realizar lo siguiente:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Mapear el servet de JSF (<code>FacesServlet</code>) a un determinado patrón de URL (por ejemplo <code>*.xhtml</code>).</p>
</li>
<li>
<p>Crear <em>managed beans</em>. Desde los <em>Facelets</em> accederemos a los datos de nuestra aplicación a través de ellos.</p>
</li>
<li>
<p>Crear páginas utilizando las etiquetas de componentes. Los <em>Facelets</em> serán estas página XHTML que utilizarán dichas etiquetas y accederán a los datos mediante <em>managed beans</em>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_mapeo_del_em_servlet_em_de_jsf">8.2.1. Mapeo del <em>servlet</em> de JSF</h4>
<div class="paragraph">
<p>Para poder usar <em>Facelets</em> deberemos mapear el <em>servlet</em> de JSF a un determinado patrón de URL para que se encargue de procesar todas las páginas que se ajusten a dicho patrón. Normalmente quedará mapeado al patrón <code>*.xhtml</code>, para que todas las páginas que tengan dicha extensión sean procesadas como <em>Facelets</em>. De no añadir este mapeo se tratarían como páginas estáticas.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;servlet&gt;</span>
    <span class="tok-nt">&lt;servlet-name&gt;</span>Faces Servlet<span class="tok-nt">&lt;/servlet-name&gt;</span>
    <span class="tok-nt">&lt;servlet-class&gt;</span>javax.faces.webapp.FacesServlet<span class="tok-nt">&lt;/servlet-class&gt;</span>
    <span class="tok-nt">&lt;load-on-startup&gt;</span>1<span class="tok-nt">&lt;/load-on-startup&gt;</span>
<span class="tok-nt">&lt;/servlet&gt;</span>
<span class="tok-nt">&lt;servlet-mapping&gt;</span>
    <span class="tok-nt">&lt;servlet-name&gt;</span>Faces Servlet<span class="tok-nt">&lt;/servlet-name&gt;</span>
    <span class="tok-nt">&lt;url-pattern&gt;</span>*.xhtml<span class="tok-nt">&lt;/url-pattern&gt;</span>
<span class="tok-nt">&lt;/servlet-mapping&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Esto puede hacerse de forma automática desde IntelliJ. Bastará con situarse sobre el directorio <code>WEB-INF</code>, pulsar con el botón derecho y seleccionar <em>New &gt; XML Configuration File &gt; Faces Config</em>. Con esto se creará en <code>WEB-INF</code> en fichero de configuración de JSF (<code>faces-config.xml</code>), y añadirá al descriptor de despliegue la configuración del <em>Faces Servlet</em> que se encargará de procesar los <em>Facelets</em>.
</td>
</tr>
</table>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="Images/faces-config.png" alt="Creación de la configuración de JSF" width="66%">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_estructura_básica_de_un_em_facelet_em">8.2.2. Estructura básica de un <em>Facelet</em></h4>
<div class="paragraph">
<p>A continuación mostramos la estructura básica que tiene un <em>Facelet</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot;</span>
<span class="tok-cp">    &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;</span>

<span class="tok-nt">&lt;html</span> <span class="tok-na">lang=</span><span class="tok-s">&quot;en&quot;</span>
      <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://www.w3.org/1999/xhtml&quot;</span>
      <span class="tok-na">xmlns:h=</span><span class="tok-s">&quot;http://xmlns.jcp.org/jsf/html&quot;</span><span class="tok-nt">&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="tok-nt">&lt;h:head&gt;</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-nt">&lt;title&gt;</span>Mi primer Facelet<span class="tok-nt">&lt;/title&gt;</span>
    <span class="tok-nt">&lt;/h:head&gt;</span>
    <span class="tok-nt">&lt;h:body&gt;</span> <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-c">&lt;!-- Contenido de la página --&gt;</span>
    <span class="tok-nt">&lt;/h:body&gt;</span>
<span class="tok-nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declaración de las librerías de etiquetas a utilizar. En este caso declaramos únicamente la librería HTML de JSF asignándole el prefijo <code>h</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>En lugar de <code>&lt;head&gt;</code> se suele utilizar una etiqueta equivalente de la librería HTML de JSP. Al haber sido declarada con prefijo <code>h</code>, dicha etiqueta será <code>&lt;h:head&gt;</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Al igual que <code>&lt;head&gt;</code>, para la etiqueta <code>&lt;body&gt;</code> también utilizamos la etiqueta equivalente de JSF.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Podemos crear un <em>Facelet</em> desde IntelliJ pulsando con el botón derecho sobre el directorio donde lo queramos añadir (por ejemplo <code>webapp</code>) y seleccionando <em>New &gt; JSF/Facelets</em>.
</td>
</tr>
</table>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="Images/create-facelet.png" alt="Creación de un Facelet con IntelliJ" width="50%">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_declaración_de_librerías_de_etiquetas">8.2.3. Declaración de librerías de etiquetas</h4>
<div class="paragraph">
<p>En el ejemplo anterior hemos declarado únicamente la librería HTML de JSF. Podríamos añadir a la declaración otras librerías de etiquetas como por ejemplo las que se muestran a continución:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Librería</th>
<th class="tableblock halign-left valign-top">URI</th>
<th class="tableblock halign-left valign-top">Prefijo</th>
<th class="tableblock halign-left valign-top">Descripción</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JSF HTML Tag Library</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://xmlns.jcp.org/jsf/html" class="bare">http://xmlns.jcp.org/jsf/html</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">h</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Componentes de la UI de la página</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JSF Core Tag Library</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://xmlns.jcp.org/jsf/core" class="bare">http://xmlns.jcp.org/jsf/core</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Funciones y acciones</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JSTL Core Tag Library</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://xmlns.jcp.org/jsp/jstl/core" class="bare">http://xmlns.jcp.org/jsp/jstl/core</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">c</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Etiquetas de propósito general de JSTL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JSTL Functions Tag Library</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://xmlns.jcp.org/jsp/jstl/functions" class="bare">http://xmlns.jcp.org/jsp/jstl/functions</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fn</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Funciones de JSTL</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Cada librería tiene un prefijo definido por convención que utilizaremos normalmente al declararla, pero podríamos cambiarlo. Por ejemplo</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;html</span> <span class="tok-na">lang=</span><span class="tok-s">&quot;en&quot;</span>
      <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://www.w3.org/1999/xhtml&quot;</span>
      <span class="tok-na">xmlns:h=</span><span class="tok-s">&quot;http://xmlns.jcp.org/jsf/html&quot;</span>
      <span class="tok-na">xmlns:c=</span><span class="tok-s">&quot;http://xmlns.jcp.org/jsp/jstl/core&quot;</span><span class="tok-nt">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En este caso hemos declarado la librería HTML de JSF con prefijo <code>h</code> y la librería Core de JSTL con prefijo <code>c</code>. Podríamos también declararlas de la siguiente forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;html</span> <span class="tok-na">lang=</span><span class="tok-s">&quot;en&quot;</span>
      <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://www.w3.org/1999/xhtml&quot;</span>
      <span class="tok-na">xmlns:html=</span><span class="tok-s">&quot;http://xmlns.jcp.org/jsf/html&quot;</span>
      <span class="tok-na">xmlns:core=</span><span class="tok-s">&quot;http://xmlns.jcp.org/jsp/jstl/core&quot;</span><span class="tok-nt">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En este último caso las etiquetas de la librería HTML de JSF se escribirían con prefijo <code>html</code>, como por ejemplo <code>&lt;html:head&gt;</code> y <code>&lt;html:body&gt;</code>. De la misma forma, las etiquetas de la librería Core de JSTL se escribirían con prefijo <code>core</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_lenguaje_de_expresiones">8.3. Lenguaje de expresiones</h3>
<div class="paragraph">
<p>Para poder conectar las etiquetas de un <em>Facelet</em> con los datos de nuestra aplicación necesitaremos introducir en ellas expresiones que hagan referencia a los <em>managed beans</em> que hayamos definido. Estas expresiones se definen mediante el llamado lenguaje de expresiones (EL).</p>
</div>
<div class="sect3">
<h4 id="_introducción_al_lenguaje_de_expresiones">8.3.1. Introducción al lenguaje de expresiones</h4>
<div class="paragraph">
<p>A partir de la versión 2.0 de JSP se introdujo en las páginas un lenguaje de expresiones que permite hacer referencia a objetos de la aplicación sin necesidad de introducir código Java. En realidad, dicho lenguaje se implantó con las primeras versiones de JSTL, una librería de etiquetas JSP que se considera estándar, y que permitía utilizar este lenguaje de expresiones en los atributos de dichas etiquetas, constituyendo una característica muy importante de JSTL.</p>
</div>
<div class="paragraph">
<p>Cualquier elemento que pertenezca al lenguaje de expresiones irá englobado dentro de la marca <code>${&#8230;&#8203;}</code>. En ella podremos colocar nombres de <em>managed beans</em>, parámetros de petición HTTP, elementos de una sesión&#8230;&#8203; etc.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, si previamente hemos creado un <em>managed bean</em> <code>miBean</code>, podríamos acceder a él desde la página (JSP o <em>Facelet</em>) con algo como:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;h3&gt;</span>El valor del bean es ${miBean}<span class="tok-nt">&lt;/h3&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si lo que queremos es mostrar el parámetro <code>password</code> que hemos tomado de un formulario, para sacarlo por pantalla o guardarlo en alguna base de datos, podríamos acceder a él con algo como:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>Accediendo al parámetro ${param.password}</code></pre>
</div>
</div>
<div class="paragraph">
<p>También se pueden utilizar, como veremos, expresiones más complejas, que se evalúan desde el contenedor de <em>Facelets</em> o JSP. Por ejemplo, si tenemos un <em>bean</em> <code>edad</code> para una persona y queremos comprobar si dicha persona es mayor de edad, podríamos poner:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>${edad &gt; 18}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Y luego utilizar el resultado de esta expresión en otras zonas (por ejemplo, etiquetas condicionales de JSTL) para realizar la acción correspondiente.</p>
</div>
<div class="paragraph">
<p>Se describe a continuación, y a grandes rasgos, el lenguaje de expresiones incluido en JSTL 1.0, y en general a partir de JSP 2.0. El lenguaje está inspirado en los lenguajes ECMAScript y XPath, y está basado en espacios de nombres (atributos <em>PageContext</em>), propiedades de elementos, operadores relacionales, lógicos y aritméticos, y un conjunto de objetos implícitos.</p>
</div>
</div>
<div class="sect3">
<h4 id="_atributos_y_expresiones">8.3.2. Atributos y expresiones</h4>
<div class="paragraph">
<p>Como hemos comentado anteriormente, podremos invocar a este lenguaje desde cualquier lugar de nuestra página (en JSP 2.0 o <em>Facelets</em>), o dentro de un atributo de una etiqueta, mediante el elemento <code>${&#8230;&#8203;}</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>${expresion}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Esta expresión podrá estar:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Por sí sola dentro de un atributo de una etiqueta (por ejemplo de JSTL):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;c:set</span> <span class="tok-na">var=</span><span class="tok-s">&quot;miVariable&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;${expresion}&quot;</span><span class="tok-nt">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En este caso, se evalúa la expresión y el resultado se convierte al tipo de dato del atributo, siguiendo las reglas de conversión internas del lenguaje.</p>
</div>
</li>
<li>
<p>Combinada con texto dentro de un atributo de una etiqueta (por ejemplo de JSTL):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;c:set</span> <span class="tok-na">var=</span><span class="tok-s">&quot;miVariable&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;texto${e1} y ${e2}texto&quot;</span><span class="tok-nt">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Aquí, las expresiones se evalúan de izquierda a derecha, y se intercalan entre el texto, convirtiéndolas a <em>String</em> (siguiendo reglas de conversión internas). Luego, la cadena resultante se convierte al tipo del atributo en el que esté (si está dentro de algún atributo).</p>
</div>
</li>
<li>
<p>Fuera de atributos, dentro del contenido HTML de la página JSP:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;h3&gt;</span>Hola, esto es una página<span class="tok-nt">&lt;/h3&gt;</span>
<span class="tok-nt">&lt;p&gt;</span>Y aquí ponemos una expresión ${expresion}, para mostrar su valor<span class="tok-nt">&lt;/p&gt;</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Para cadenas que contengan la secuencia '${' sin que sea propiamente una expresión, se encapsula esa secuencia así: <code>${'${'}</code>. Por ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>Cadena con ${'${'}expr}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Mostraría: "<em>Cadena con ${expr}</em>"</p>
</div>
</div>
<div class="sect3">
<h4 id="_operadores">8.3.3. Operadores</h4>
<div class="ulist">
<ul>
<li>
<p><strong>Operadores <code>[ ]</code> y <code>.</code></strong>: se unifican los operadores <code>[ ]</code> y <code>.</code> de forma que son equivalentes:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>${expr.campo}
${expr["campo"]}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Operadores aritméticos</strong>:</p>
</li>
<li>
<p><code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>: suma, resta, multiplicación y división</p>
</li>
<li>
<p><code>div</code>: división entera</p>
</li>
<li>
<p><code>%</code>, <code>mod</code>: resto (se mantienen los dos por compatibilidad con XPath y ECMAScript)</p>
</li>
<li>
<p><code>-</code>: cambio de signo</p>
</li>
<li>
<p><strong>Operadores relacionales</strong>:</p>
</li>
<li>
<p><code>&gt;</code>, <code>gt</code>: mayor que</p>
</li>
<li>
<p><code>&lt;</code>, <code>lt</code>: menor que</p>
</li>
<li>
<p><code>&gt;=</code>, <code>ge</code>: mayor o igual que</p>
</li>
<li>
<p><code>&#8656;</code>, <code>le</code>: menor o igual que</p>
</li>
<li>
<p><code>==</code>, <code>eq</code>: igual que</p>
</li>
<li>
<p><code>!=</code>, <code>ne</code>: distinto que</p>
</li>
<li>
<p><strong>Operadores lógicos</strong>:</p>
</li>
<li>
<p><code>&amp;&amp;</code>, <code>and</code>: Y lógica</p>
</li>
<li>
<p><code>||</code>, <code>or</code>: O lógica</p>
</li>
<li>
<p><code>!</code>, <code>not</code>: NO lógica</p>
</li>
<li>
<p><strong>Operador <code>empty</code></strong>: utilizado delante de un elemento, para indicar si el elemento es nulo o vacío (devolvería <code>true</code>) o no (devolvería <code>false</code>). Por ejemplo:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>${empty A}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>PRECEDENCIA</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>[ ]</code>, <code>.</code></p>
</li>
<li>
<p><code>( )</code></p>
</li>
<li>
<p><code>-</code> (cambio de signo), <code>not</code>, <code>!</code>, <code>empty</code></p>
</li>
<li>
<p><code>*</code>, <code>/</code>, <code>div</code>, <code>%</code>, <code>mod</code></p>
</li>
<li>
<p><code>+</code>, <code>-</code></p>
</li>
<li>
<p><code>&lt;</code>, <code>&gt;</code>, <code>&#8656;</code>, <code>&gt;=</code>, <code>lt</code>, <code>gt</code>, <code>le</code>, <code>ge</code></p>
</li>
<li>
<p><code>==</code>, <code>!=</code>, <code>eq</code>, <code>ne</code></p>
</li>
<li>
<p><code>&amp;&amp;</code>, <code>and</code></p>
</li>
<li>
<p><code>||</code>, <code>or</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>EJEMPLOS</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>// Daría true si el parametro nombre no se ha enviado
${empty param.nombre}

// Devolvería el resultado de la suma de ambas variables
${num1 + num2}

// Devolvería true si valor1 es mayor o igual que valor2
${valor1 &gt;= valor2}

// Daría true si v1 fuese distinto a v2, y v3 menor que v4
${v1 ne v2 and v3 &lt; v4}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_nombres_de_variables">8.3.4. Nombres de variables</h4>
<div class="paragraph">
<p>El lenguaje de expresiones evalúa un identificador o nombre de elemento mirando su valor como un atributo, según el comportamiento del método <code>PageContext.findAttribute(String)</code>. Por ejemplo, si ponemos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>${valor}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Se buscará el atributo <em>valor</em> en los ámbitos de página (<code>page</code>), petición (<code>request</code>), sesión (<code>session</code>) y aplicación (<code>application</code>), y si lo encuentra devuelve su valor. Si no, se devuelve <code>null</code>.</p>
</div>
<div class="paragraph">
<p><strong>Objetos implícitos</strong></p>
</div>
<div class="paragraph">
<p>Cuando como nombre de atributo se utiliza alguno de los que el lenguaje de expresiones considera como implícitos, se devolverá el objeto asociado. Dichos objetos implícitos son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>pageContext</code>: el objeto <code>PageContext</code> actual</p>
</li>
<li>
<p><code>pageScope</code>, <code>requestScope</code>, <code>sessionScope</code>, <code>applicationScope</code>: para obtener valores de atributos de página / petición / sesión / aplicación, respectivamente.</p>
</li>
<li>
<p><code>param</code>: para obtener el valor de un parámetro de petición. Se obtiene un tipo <code>String</code> (utilizando el método <code>ServletRequest.getParameter(String)</code>)</p>
</li>
<li>
<p><code>paramValues</code>: para obtener los valores de un parámetro de petición. Se obtiene un tipo <code>String[]</code> (utilizando el método <code>ServletRequest.getParameterValues(String)</code>).</p>
</li>
<li>
<p><code>header</code>: para obtener el valor de un parámetro de cabecera. Se obtiene un tipo <code>String</code> (utilizando el método <code>ServletRequest.getHeader(String)</code>)</p>
</li>
<li>
<p><code>headerValues</code>: para obtener los valores de un parámetro de cabecera. Se obtiene un tipo <code>String[]</code> (utilizando el método <code>ServletRequest.getHeaderValues(String)</code>).</p>
</li>
<li>
<p><code>cookie</code>: para obtener el valor de una <em>cookie</em>. Se obtiene un objeto <code>Cookie</code>. Las cookies se buscan con <code>HttpServletRequest.getCookies()</code></p>
</li>
<li>
<p><code>initParam</code>: para obtener el valor de un parámetro de inicialización. Se obtiene un tipo <code>String</code> (utilizando el método <code>ServletContext.getInitParameter(String)</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>EJEMPLOS</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>${sessionScope.profile}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Se obtiene el atributo <code>profile</code> de la sesión</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>${param.id}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Se obtiene el valor del parámetro <code>id</code> de la petición, o <code>null</code> si no se encuentra.</p>
</div>
<div class="paragraph">
<p><strong>Palabras reservadas</strong></p>
</div>
<div class="paragraph">
<p>Se tienen algunos identificadores que no podemos utilizar como nombres de atributos, como son <code>and</code>, <code>eq</code>, <code>gt</code>, <code>true</code>, <code>instanceof</code>, <code>or</code>, <code>ne</code>, <code>le</code>, <code>false</code>, <code>empty</code>, <code>not</code>, <code>lt</code>, <code>ge</code>, <code>null</code>, <code>div</code> y <code>mod</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_lenguaje_de_expresiones_y_cdi">8.3.5. Lenguaje de expresiones y CDI</h4>
<div class="paragraph">
<p>Podemos hacer que los <em>beans</em> CDI sean accesibles desde el lenguaje de expresiones. Por defecto no serán accesibles, para poder acceder a ellos deberemos darles un nombre. Esto lo haremos anotando el <em>bean</em> con la etiqueta <code>@Named</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Named</span><span class="tok-o">(</span><span class="tok-s">&quot;hola&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">HolaMundo</span> <span class="tok-o">{</span>
    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getSaludo</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-s">&quot;Hola mundo!&quot;</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Podremos utilizar este <em>bean</em> desde EL de la siguiente forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>${hola.saludo}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_librerías_de_etiquetas">8.4. Librerías de etiquetas</h3>
<div class="paragraph">
<p>Las <strong>librerías de etiquetas</strong> (<em>tag libs</em>) son conjuntos de etiquetas HTML personalizadas que permiten encapsular determinadas acciones, mediante un código Java subyacente. Es decir, se define lo que va a ejecutar la etiqueta mediante código Java, y luego se le da un nombre a la etiqueta para llamarla desde los <em>Facelets</em> o páginas JSP, estableciendo la relación entre el nombre de la etiqueta y el código Java que la implementa.
Por ejemplo, una página JSP que hace uso de librerías de tags podría tener este aspecto:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="jsp"><span class="tok-k">&lt;%@</span> <span class="tok-n">taglib</span> <span class="tok-n">uri</span><span class="tok-o">=</span><span class="tok-s">&quot;ejemplo&quot;</span> <span class="tok-n">prefix</span><span class="tok-o">=</span><span class="tok-s">&quot;ej&quot;</span> <span class="tok-k">%&gt;</span>
<span class="tok-nt">&lt;html&gt;</span>
<span class="tok-nt">&lt;body&gt;</span>
<span class="tok-nt">&lt;h1&gt;</span>Ejemplo de librerias de tags<span class="tok-nt">&lt;/h1&gt;</span>
<span class="tok-nt">&lt;ej:mitag&gt;</span>Hola a todos<span class="tok-nt">&lt;/ej:mitag&gt;</span>
<span class="tok-nt">&lt;br&gt;</span>
<span class="tok-nt">&lt;ej:otrotag/&gt;</span>
<span class="tok-nt">&lt;/body&gt;</span>
<span class="tok-nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>donde se utiliza una librería llamada <code>ejemplo</code>, que se simplifica con el prefijo <code>ej</code>, de forma que todos los tags de dicha librería se referencian con dicho prefijo y dos puntos, teniendo la forma <code>ej:tag</code>. Se utilizan así los tags <code>mitag</code> y <code>otrotag</code>.</p>
</div>
<div class="paragraph">
<p>Podríamos incluir dicha librería en un <em>Facelet</em> de la siguiente forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot;</span>
<span class="tok-cp">    &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;</span>

<span class="tok-nt">&lt;html</span> <span class="tok-na">lang=</span><span class="tok-s">&quot;en&quot;</span>
      <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://www.w3.org/1999/xhtml&quot;</span>
      <span class="tok-na">xmlns:ej=</span><span class="tok-s">&quot;ejemplo&quot;</span><span class="tok-nt">&gt;</span>

    <span class="tok-nt">&lt;h:body&gt;</span>
      <span class="tok-nt">&lt;h1&gt;</span>Ejemplo de librerias de tags<span class="tok-nt">&lt;/h1&gt;</span>
      <span class="tok-nt">&lt;ej:mitag&gt;</span>Hola a todos<span class="tok-nt">&lt;/ej:mitag&gt;</span>
      <span class="tok-nt">&lt;br/&gt;</span>
      <span class="tok-nt">&lt;ej:otrotag/&gt;</span>
    <span class="tok-nt">&lt;/h:body&gt;</span>
<span class="tok-nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>JSTL</strong> (<em>JavaServer Pages Standard Tag Library</em>) es una librería de tags estándar que encapsula, en forma de <em>tags</em>, muchas funcionalidades comunes en aplicaciones JSP, de forma que, en lugar que tener que recurrir a varias librerías de <em>tags</em> de distintos distribuidores, sólo necesitaremos tener presente esta librería que, además, por el hecho de ser estándar, funciona de la misma forma en cualquier parte, y los contenedores pueden reconocerla y optimizar sus implementaciones.</p>
</div>
<div class="paragraph">
<p>JSTL permite realizar tareas como iteraciones, estructuras condicionales, tags de manipulación de documentos XML, tags SQL, etc. También introduce un lenguaje de expresiones que simplifica el desarrollo de las páginas, y proporciona un API para simplificar la configuración de los tags JSTL y el desarrollo de tags personalizados que sean conformes a las convenciones de JSTL.</p>
</div>
<div class="sect3">
<h4 id="_librería_de_etiquetas_jstl">8.4.1. Librería de etiquetas JSTL</h4>
<div class="paragraph">
<p>JSTL contiene una gran variedad de <em>tags</em> que permiten hacer distintos tipos de tareas, subdivididas en áreas. Así, JSTL proporciona varias <em>sublibrerías</em>, para describir cada una de las áreas que abarca, y dar así a cada área su propio espacio de nombres.</p>
</div>
<div class="paragraph">
<p>En la siguientes tablas se muestran las áreas cubiertas por JSTL (cada una con una librería):</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33%;">
<col style="width: 33%;">
<col style="width: 33%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">AREA</th>
<th class="tableblock halign-left valign-top">URI</th>
<th class="tableblock halign-left valign-top">PREFIJO</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Core</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><a href="http://java.sun.com/jstl/ea/core" class="bare">http://java.sun.com/jstl/ea/core</a></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">c</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>XML</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><a href="http://java.sun.com/jstl/ea/xml" class="bare">http://java.sun.com/jstl/ea/xml</a></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">x</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Internacionalización (I18N)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><a href="http://java.sun.com/jstl/ea/fmt" class="bare">http://java.sun.com/jstl/ea/fmt</a></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fmt</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>SQL</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><a href="http://java.sun.com/jstl/ea/sql" class="bare">http://java.sun.com/jstl/ea/sql</a></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">sql</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Functions</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><a href="http://java.sun.com/jstl/ea/functions" class="bare">http://java.sun.com/jstl/ea/functions</a></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fn</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Las URIs mostradas en esta tabla pueden ser utilizadas en páginas JSP. En <em>Facelets</em>/JSF sólo se han incorporado las librerías <em>Core</em> y <em>Functions</em>, siendo sus URIs las siguientes:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33%;">
<col style="width: 33%;">
<col style="width: 33%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">AREA</th>
<th class="tableblock halign-left valign-top">URI</th>
<th class="tableblock halign-left valign-top">PREFIJO</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Core</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><a href="http://java.sun.com/jstl/ea/core" class="bare">http://java.sun.com/jstl/ea/core</a></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">c</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Functions</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><a href="http://xmlns.jcp.org/jsp/jstl/functions" class="bare">http://xmlns.jcp.org/jsp/jstl/functions</a></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fn</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Cada una de estar librerías se encarga de las siguientes funcionalidades:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Core</strong> se utiliza para funciones de propósito general (manejo de expresiones, sentencias de control de flujo, etc).</p>
</li>
<li>
<p><strong>XML</strong> se emplea para procesamiento de ficheros XML.</p>
</li>
<li>
<p>La librería de <strong>internationalización</strong> se usa para dar soporte a páginas multilenguaje, y a multiformatos de números, monedas, etc, en función de la región en que se tenga la aplicación.</p>
</li>
<li>
<p><strong>SQL</strong> sirve para acceder y manipular bases de datos relacionales.</p>
</li>
<li>
<p><strong>Functions</strong> contiene una serie de funciones de propósito general, como por ejemplo funciones para la manipulación de cadenas.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Las URIs y prefijos que se indican en la tabla pueden emplearse (aunque no es obligatorio) para utilizar las librerías en nuestros <em>Facelets</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot;</span>
<span class="tok-cp">    &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;</span>

<span class="tok-nt">&lt;html</span> <span class="tok-na">lang=</span><span class="tok-s">&quot;en&quot;</span>
      <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://www.w3.org/1999/xhtml&quot;</span>
      <span class="tok-na">xmlns:c=</span><span class="tok-s">&quot;http://java.sun.com/jstl/ea/core&quot;</span>
      <span class="tok-na">xmlns:fn=</span><span class="tok-s">&quot;http://xmlns.jcp.org/jsp/jstl/functions&quot;</span><span class="tok-nt">&gt;</span>

    <span class="tok-nt">&lt;h:body&gt;</span>
        ...
    <span class="tok-nt">&lt;/h:body&gt;</span>
<span class="tok-nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_la_librería_core">La librería Core</h5>
<div class="paragraph">
<p>Los tags <code>core</code> incluyen tags de propósito general. En esta librería se tienen etiquetas para:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Funciones de propósito general: evaluar expresiones, establecer valores de parámetros, etc.</p>
</li>
<li>
<p>Funciones de control de flujo: condiciones para ejecutar unos bloques de código u otro, iteradores, etc.</p>
</li>
<li>
<p>Funciones de acceso a URLs: para importar URLS en la página actual, etc.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Los tags de esta librería se presentan con el prefijo "<strong>c</strong>".</p>
</div>
<div class="sect5">
<h6 id="_tags_de_propósito_general">Tags de propósito general</h6>
<div class="paragraph">
<p><strong>out</strong></p>
</div>
<div class="paragraph">
<p>El tag <strong>out</strong> evalúa el resultado de una expresión y lo pone en el objeto <code>JspWriter</code> actual. Es equivalente a la sintaxis <code>&lt;%= &#8230;&#8203; %&gt;</code> de JSP, y también a poner directamente una expresión <code>${&#8230;&#8203;}</code> en su lugar, aunque admite algunos atributos adicionales.</p>
</div>
<div class="paragraph">
<p>SINTAXIS:</p>
</div>
<div class="paragraph">
<p>Dar el valor por defecto mediante un atributo <code>default</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;c:out</span> <span class="tok-na">value=</span><span class="tok-s">&quot;valor&quot;</span>
 <span class="tok-err">[</span><span class="tok-na">escapeXML=</span><span class="tok-s">&quot;true|false&quot;</span><span class="tok-err">]</span>
 <span class="tok-err">[</span><span class="tok-na">default=</span><span class="tok-s">&quot;valor&quot;</span><span class="tok-err">]</span><span class="tok-nt">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Dar el valor por defecto mediante el cuerpo del tag:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;c:out</span> <span class="tok-na">value=</span><span class="tok-s">&quot;valor&quot;</span>
 <span class="tok-err">[</span><span class="tok-na">escapeXML=</span><span class="tok-s">&quot;true|false&quot;</span><span class="tok-err">]</span><span class="tok-nt">&gt;</span>
  Valor por defecto
<span class="tok-nt">&lt;/c:out&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>ATRIBUTOS:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>value</code>: expresión que se tiene que evaluar.</p>
</li>
<li>
<p><code>escapeXML</code>: a <code>true</code> (valor por defecto) indica que los caracteres &lt;, &gt;, &amp;, ', " que haya en la cadena resultado se deben convertir a sus códigos correspondientes (&lt;, &gt;, &amp;, &#039;, &#034;, respectivamente).</p>
</li>
<li>
<p><code>default</code>: valor por defecto si el resultado es <code>null</code>. Se puede indicar por el atributo o por el cuerpo del tag.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>EJEMPLO:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;c:out</span> <span class="tok-na">value=</span><span class="tok-s">&quot;${datos.ciudad}&quot;</span>
 <span class="tok-na">default=</span><span class="tok-s">&quot;desconocida&quot;</span><span class="tok-nt">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Sacaría el valor del campo <code>ciudad</code> del objeto <code>datos</code>, o mostraría &#8220;desconocida&#8221; si dicho valor es nulo.</p>
</div>
<div class="paragraph">
<p><strong>set</strong></p>
</div>
<div class="paragraph">
<p>El tag <strong>set</strong> establece el valor de un atributo en cualquier ámbito (<code>page</code>, <code>request</code>, <code>session</code>, <code>application</code>). Si el atributo no existe, se crea.</p>
</div>
<div class="paragraph">
<p>SINTAXIS:</p>
</div>
<div class="paragraph">
<p>Dar valor a una variable utilizando el atributo <code>value</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;c:set</span> <span class="tok-na">value=</span><span class="tok-s">&quot;valor&quot;</span> <span class="tok-na">var=</span><span class="tok-s">&quot;variable&quot;</span>
 <span class="tok-err">[</span><span class="tok-na">scope=</span><span class="tok-s">&quot;page|request|session|application&quot;</span><span class="tok-err">]</span><span class="tok-nt">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Dar valor a una variable utilizando el cuerpo del tag:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;c:set</span> <span class="tok-na">var=</span><span class="tok-s">&quot;variable&quot;</span>
 <span class="tok-err">[</span><span class="tok-na">scope=</span><span class="tok-s">&quot;page|request|session|application&quot;</span><span class="tok-err">]</span><span class="tok-nt">&gt;</span>
  Valor
<span class="tok-nt">&lt;/c:set&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Dar valor a una propiedad de un objeto utilizando el atributo <code>value</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;c:set</span> <span class="tok-na">value=</span><span class="tok-s">&quot;valor&quot;</span> <span class="tok-na">target=</span><span class="tok-s">&quot;objeto&quot;</span>
 <span class="tok-na">property=</span><span class="tok-s">&quot;propiedad&quot;</span><span class="tok-nt">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Dar valor a una propiedad de un objeto utilizando el cuerpo del tag:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;c:set</span> <span class="tok-na">target=</span><span class="tok-s">&quot;objeto&quot;</span> <span class="tok-na">property=</span><span class="tok-s">&quot;propiedad&quot;</span><span class="tok-nt">&gt;</span>
  Valor
<span class="tok-nt">&lt;/c:set&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>ATRIBUTOS:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>value</code>: valor que se asigna. Podemos dar el valor con este atributo o con el cuerpo del tag.</p>
</li>
<li>
<p><code>var</code>: variable a la que se asigna el valor.</p>
</li>
<li>
<p><code>scope</code>: ámbito de la variable a la que se asigna el valor.</p>
</li>
<li>
<p><code>target</code>: objeto al que se le modifica una propiedad. Debe ser un objeto JavaBeans con una propiedad <code>propiedad</code> que pueda establecerse, o un objeto <code>java.util.Map</code>.</p>
</li>
<li>
<p><code>property</code>: propiedad a la que se le asigna valor en el objeto <code>target</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>EJEMPLO:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;c:set</span> <span class="tok-na">var=</span><span class="tok-s">&quot;foo&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;2&quot;</span><span class="tok-nt">/&gt;</span>
...
<span class="tok-nt">&lt;c:out</span> <span class="tok-na">value=</span><span class="tok-s">&quot;${foo}&quot;</span><span class="tok-nt">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Asignaría a la variable <code>foo</code> el valor "2", y luego mostraría el valor por pantalla.</p>
</div>
<div class="paragraph">
<p><strong>Otras Etiquetas</strong></p>
</div>
<div class="paragraph">
<p>Existen otras etiquetas, como <code>remove</code> o <code>catch</code>, que no se comentan aquí.</p>
</div>
</div>
<div class="sect5">
<h6 id="_tags_de_control_de_flujo">Tags de control de flujo</h6>
<div class="paragraph">
<p><strong>if</strong></p>
</div>
<div class="paragraph">
<p>El tag <strong>if</strong> permite ejecutar su código si se cumple la condición que contiene su atributo <code>test</code>.</p>
</div>
<div class="paragraph">
<p>SINTAXIS:</p>
</div>
<div class="paragraph">
<p>Sin cuerpo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;c:if</span> <span class="tok-na">test=</span><span class="tok-s">&quot;condicion&quot;</span> <span class="tok-na">var=</span><span class="tok-s">&quot;variable&quot;</span>
 <span class="tok-err">[</span><span class="tok-na">scope=</span><span class="tok-s">&quot;page|request|session|application&quot;</span><span class="tok-err">]</span><span class="tok-nt">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Con cuerpo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;c:if</span> <span class="tok-na">test=</span><span class="tok-s">&quot;condicion&quot;</span> <span class="tok-err">[</span><span class="tok-na">var=</span><span class="tok-s">&quot;variable&quot;</span><span class="tok-err">]</span>
 <span class="tok-err">[</span><span class="tok-na">scope=</span><span class="tok-s">&quot;page|request|session|application&quot;</span><span class="tok-err">]</span><span class="tok-nt">&gt;</span>
  Cuerpo
<span class="tok-nt">&lt;/c:if&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>ATRIBUTOS:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>test</code>: condicion que debe cumplirse para ejecutar el <code>if</code>.</p>
</li>
<li>
<p><code>var</code>: variable donde se guarda el resultado de evaluar la expresión. El tipo de esta variable debe ser <code>Boolean</code>.</p>
</li>
<li>
<p><code>scope</code>: ámbito de la variable a la que se asigna el valor de la condición.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>EJEMPLO:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;c:if</span> <span class="tok-na">test=</span><span class="tok-s">&quot;${visitas &gt; 1000}&quot;</span><span class="tok-nt">&gt;</span>
<span class="tok-nt">&lt;h1&gt;</span>¡Mas de 1000 visitas!<span class="tok-nt">&lt;/h1&gt;</span>
<span class="tok-nt">&lt;/c:if&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Sacaría el mensaje &#8220;¡Mas de 1000 visitas!&#8221; si el contador <code>visitas</code> fuese mayor que 1000.</p>
</div>
<div class="paragraph">
<p><strong>choose</strong></p>
</div>
<div class="paragraph">
<p>El tag <strong>choose</strong> permite definir varios bloques de código y ejecutar uno de ellos en función de una condición. Dentro del <code>choose</code> puede haber espacios en blanco, una o varias etiquetas <strong>when</strong> y cero o una etiquetas <strong>otherwise</strong>.</p>
</div>
<div class="paragraph">
<p>El funcionamiento es el siguiente: se ejecutará el código de la primera etiqueta <strong>when</strong> que cumpla la condición de su atributo <strong>test</strong>. Si ninguna etiqueta <code>when</code> cumple su condición, se ejecutará el código de la etiqueta <strong>otherwise</strong> (esta etiqueta, si aparece, debe ser la última hija de <code>choose</code>).</p>
</div>
<div class="paragraph">
<p>SINTAXIS:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;c:choose&gt;</span>
  <span class="tok-nt">&lt;c:when</span> <span class="tok-na">test=</span><span class="tok-s">&quot;condicion1&quot;</span><span class="tok-nt">&gt;</span>
    codigo1
  <span class="tok-nt">&lt;/c:when&gt;</span>
  <span class="tok-nt">&lt;c:when</span> <span class="tok-na">test=</span><span class="tok-s">&quot;condicion2&quot;</span><span class="tok-nt">&gt;</span>
    codigo2
  <span class="tok-nt">&lt;/c:when&gt;</span>
  ...
  <span class="tok-nt">&lt;c:when</span> <span class="tok-na">test=</span><span class="tok-s">&quot;condicionN&quot;</span><span class="tok-nt">&gt;</span>
    codigoN
  <span class="tok-nt">&lt;/c:when&gt;</span>
  <span class="tok-nt">&lt;c:otherwise&gt;</span>
    codigo
  <span class="tok-nt">&lt;/c:otherwhise&gt;</span>
<span class="tok-nt">&lt;/c:choose&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>EJEMPLO:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;c:choose&gt;</span>
  <span class="tok-nt">&lt;c:when</span> <span class="tok-na">test=</span><span class="tok-s">&quot;${a &lt; 0}&quot;</span><span class="tok-nt">&gt;</span>
  <span class="tok-nt">&lt;h1&gt;</span>a menor que 0<span class="tok-nt">&lt;/h1&gt;</span>
  <span class="tok-nt">&lt;/c:when&gt;</span>
  <span class="tok-nt">&lt;c:when</span> <span class="tok-na">test=</span><span class="tok-s">&quot;${a &gt; 10}&quot;</span><span class="tok-nt">&gt;</span>
  <span class="tok-nt">&lt;h1&gt;</span>a mayor que 10<span class="tok-nt">&lt;/h1&gt;</span>
  <span class="tok-nt">&lt;/c:when&gt;</span>
  <span class="tok-nt">&lt;c:otherwise&gt;</span>
  <span class="tok-nt">&lt;h1&gt;</span>a entre 1 y 10<span class="tok-nt">&lt;/h1&gt;</span>
  <span class="tok-nt">&lt;/c:otherwhise&gt;</span>
<span class="tok-nt">&lt;/c:choose&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Sacaría el mensaje &#8220;a es menor que 0&#8221; si la variable a es menor que 0, el mensaje &#8220;a es mayor que 10&#8221; si es mayor que 10, y el mensaje &#8220;a esta entre 1 y 10&#8221; si no se cumple ninguna de las dos anteriores.</p>
</div>
<div class="paragraph">
<p><strong>forEach</strong></p>
</div>
<div class="paragraph">
<p>El tag <strong>forEach</strong> permite repetir su código recorriendo un conjunto de objetos, o durante un número determinado de iteraciones.</p>
</div>
<div class="paragraph">
<p>SINTAXIS:</p>
</div>
<div class="paragraph">
<p>Para iterar sobre un conjunto de objetos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;c:forEach</span> <span class="tok-err">[</span><span class="tok-na">var=</span><span class="tok-s">&quot;variable&quot;</span><span class="tok-err">]</span> <span class="tok-na">items=</span><span class="tok-s">&quot;conjunto&quot;</span>
<span class="tok-err">[</span><span class="tok-na">varStatus=</span><span class="tok-s">&quot;variableEstado&quot;</span><span class="tok-err">]</span> <span class="tok-err">[</span><span class="tok-na">begin=</span><span class="tok-s">&quot;comienzo&quot;</span><span class="tok-err">]</span>
<span class="tok-err">[</span><span class="tok-na">end=</span><span class="tok-s">&quot;final&quot;</span><span class="tok-err">]</span> <span class="tok-err">[</span><span class="tok-na">step=</span><span class="tok-s">&quot;incremento&quot;</span><span class="tok-err">]</span><span class="tok-nt">&gt;</span>
  codigo
<span class="tok-nt">&lt;/c:forEach&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para iterar un determinado número de veces:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;c:forEach</span> <span class="tok-err">[</span><span class="tok-na">var=</span><span class="tok-s">&quot;variable&quot;</span><span class="tok-err">]</span>
 <span class="tok-err">[</span><span class="tok-na">varStatus=</span><span class="tok-s">&quot;variableEstado&quot;</span><span class="tok-err">]</span> <span class="tok-na">begin=</span><span class="tok-s">&quot;comienzo&quot;</span>
 <span class="tok-na">end=</span><span class="tok-s">&quot;final&quot;</span> <span class="tok-err">[</span><span class="tok-na">step=</span><span class="tok-s">&quot;incremento&quot;</span><span class="tok-err">]</span><span class="tok-nt">&gt;</span>
  codigo
<span class="tok-nt">&lt;/c:forEach&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>ATRIBUTOS:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>var</code>: variable donde guardar el elemento actual que se está explorando en la iteración. El tipo de este objeto depende del tipo de conjunto que se esté recorriendo.</p>
</li>
<li>
<p><code>items</code>: conjunto de elementos que recorre la iteración. Pueden recorrerse varios tipos:</p>
<div class="ulist">
<ul>
<li>
<p><code>Array</code>: tanto de tipos primitivos como de tipos complejos. Para los tipos primitivos, cada dato se convierte en su correspondiente <code>wrapper</code> (<code>Integer</code> para <code>int</code>, <code>Float</code> para <code>float</code>, etc)</p>
</li>
<li>
<p><code>java.util.Collection</code>: mediante el método <code>iterator()</code> se obtiene el conjunto, que se procesa en el orden que devuelve dicho método.</p>
</li>
<li>
<p><code>java.util.Iterator</code></p>
</li>
<li>
<p><code>java.util.Enumeration</code></p>
</li>
<li>
<p><code>java.util.Map</code>:el objeto del atributo <code>var</code> es entonces de tipo <code>Map.Entry</code>, y se obtiene un <code>Set</code> con los mapeos. Llamando al método <code>iterator()</code> del mismo se obtiene el conjunto a recorrer.</p>
</li>
<li>
<p><code>String</code>: la cadena representa un conjunto de valores separados por comas, que se van recorriendo en el orden en que están.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>varStatus</code>: variable donde guardar el estado actual de la iteración. Es del tipo <code>javax.servlet.jsp.jstl.core.LoopTagStatus</code>.</p>
</li>
<li>
<p><code>begin</code>: indica el valor a partir del cual comenzar la iteración. Si se está recorriendo un conjunto de objetos, indica el índice del primer objeto a explorar (el primero es el 0), y si no, indica el valor inicial del contador. Si se indica este atributo, debe ser mayor o igual que 0.</p>
</li>
<li>
<p><code>end</code>: indica el valor donde terminar la iteración. Si se está recorriendo un conjunto de objetos, indica el índice del último objeto a explorar (inclusive), y si no, indica el valor final del contador. Si se indica este atributo, debe ser mayor o igual que <code>begin</code>.</p>
</li>
<li>
<p><code>step</code>: indica cuántas unidades incrementar el contador cada iteración, para ir de <code>begin</code> a <code>end</code>. Por defecto es 1 unidad. Si se indica este atributo, debe ser mayor o igual que 1.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>EJEMPLO:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;c:forEach</span> <span class="tok-na">var=</span><span class="tok-s">&quot;item&quot;</span>
 <span class="tok-na">items=</span><span class="tok-s">&quot;${cart.items}&quot;</span><span class="tok-nt">&gt;</span>
  <span class="tok-nt">&lt;tr&gt;</span>
    <span class="tok-nt">&lt;td&gt;</span>
    <span class="tok-nt">&lt;c:out</span> <span class="tok-na">value=</span><span class="tok-s">&quot;${item.valor}&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;/td&gt;</span>
  <span class="tok-nt">&lt;/tr&gt;</span>
<span class="tok-nt">&lt;/c:forEach&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Muestra el valor de todos los <code>items</code>.</p>
</div>
<div class="paragraph">
<p><strong>forTokens</strong></p>
</div>
<div class="paragraph">
<p>El tag <strong>forTokens</strong> es similar al tag <strong>foreach</strong>, pero permite recorrer una serie de <code>tokens</code> (cadenas de caracteres), separadas por el/los delimitador(es) que se indique(n).</p>
</div>
<div class="paragraph">
<p>SINTAXIS:</p>
</div>
<div class="paragraph">
<p>La sintaxis es la misma que <code>foreach</code>, salvo que se tiene un atributo <code>delims</code>, obligatorio.</p>
</div>
<div class="paragraph">
<p>ATRIBUTOS:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>var</code>: igual que para <code>foreach</code></p>
</li>
<li>
<p><code>items</code>: cadena que contiene los tokens a recorrer</p>
</li>
<li>
<p><code>delims</code>:conjunto de delimitadores que se utilizan para separar los tokens de la cadena de entrada (colocados igual que los utiliza un <code>StringTokenizer</code>).</p>
</li>
<li>
<p><code>varStatus</code>: igual que para <code>foreach</code></p>
</li>
<li>
<p><code>begin</code>: indica el índice del token a partir del cual comenzar la iteración.</p>
</li>
<li>
<p><code>end</code>: indica el índice del token donde terminar la iteración.</p>
</li>
<li>
<p><code>step</code>: igual que para <code>foreach</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>EJEMPLO:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;c:forTokens</span> <span class="tok-na">var=</span><span class="tok-s">&quot;item&quot;</span>
 <span class="tok-na">items=</span><span class="tok-s">&quot;un#token otro#otromas&quot;</span> <span class="tok-na">delims=</span><span class="tok-s">&quot;# &quot;</span><span class="tok-nt">&gt;</span>
  <span class="tok-nt">&lt;tr&gt;</span>
    <span class="tok-nt">&lt;td&gt;</span>
    <span class="tok-nt">&lt;c:out</span> <span class="tok-na">value=</span><span class="tok-s">&quot;${item}&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;/td&gt;</span>
  <span class="tok-nt">&lt;/tr&gt;</span>
<span class="tok-nt">&lt;/c:forEach&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Definimos dos separadores: el <code>'#'</code> y el espacio <code>' '</code>. Así habrá 4 iteraciones, recorriendo los tokens <code>"un"</code>, <code>"token"</code>, <code>"otro"</code> y <code>"otromas"</code>.</p>
</div>
</div>
<div class="sect5">
<h6 id="_tags_de_manejo_de_urls">Tags de manejo de URLs</h6>
<div class="paragraph">
<p><strong>import</strong></p>
</div>
<div class="paragraph">
<p>El tag <strong>import</strong> permite importar el contenido de una URL.</p>
</div>
<div class="paragraph">
<p>SINTAXIS:</p>
</div>
<div class="paragraph">
<p>Para copiar el contenido de la URL en una cadena:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;c:import</span> <span class="tok-na">url=</span><span class="tok-s">&quot;url&quot;</span> <span class="tok-err">[</span><span class="tok-na">context=</span><span class="tok-s">&quot;contexto&quot;</span><span class="tok-err">]</span>
 <span class="tok-err">[</span><span class="tok-na">var=</span><span class="tok-s">&quot;variable&quot;</span><span class="tok-err">]</span>
 <span class="tok-err">[</span><span class="tok-na">scope=</span><span class="tok-s">&quot;page|request|session|application&quot;</span><span class="tok-err">]</span>
 <span class="tok-err">[</span><span class="tok-na">charEncoding=</span><span class="tok-s">&quot;codificacion&quot;</span><span class="tok-err">]</span><span class="tok-nt">&gt;</span>
  cuerpo para tags &quot;param&quot; opcionales
<span class="tok-nt">&lt;/c:import&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para copiar el contenido de la URL en un <code>Reader</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;c:import</span> <span class="tok-na">url=</span><span class="tok-s">&quot;url&quot;</span> <span class="tok-err">[</span><span class="tok-na">context=</span><span class="tok-s">&quot;contexto&quot;</span><span class="tok-err">]</span>
 <span class="tok-na">varReader=</span><span class="tok-s">&quot;variableReader&quot;</span>
 <span class="tok-err">[</span><span class="tok-na">charEncoding=</span><span class="tok-s">&quot;codificacion&quot;</span><span class="tok-err">]</span><span class="tok-nt">&gt;</span>
  codigo para leer del Reader
<span class="tok-nt">&lt;/c:import&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>ATRIBUTOS:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>url</code>: URL de la que importar datos</p>
</li>
<li>
<p><code>context</code>: contexto para URLs que pertenecen a contextos distintos al actual.</p>
</li>
<li>
<p><code>var</code>: variable (<code>String</code>) donde guardar el contenido de la URL</p>
</li>
<li>
<p><code>varReader</code>: variable (<code>Reader</code>) donde guardar el contenido de la URL</p>
</li>
<li>
<p><code>scope</code>: ámbito para la variable <code>var</code></p>
</li>
<li>
<p><code>charEncoding</code>: codificación de caracteres de la URL</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>EJEMPLO:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;c:import</span> <span class="tok-na">url=</span><span class="tok-s">&quot;http://www.ua.es&quot;</span>
 <span class="tok-na">var=</span><span class="tok-s">&quot;universidad&quot;</span><span class="tok-nt">&gt;</span>
  <span class="tok-nt">&lt;c:out</span> <span class="tok-na">value=</span><span class="tok-s">&quot;${universidad}&quot;</span><span class="tok-nt">/&gt;</span>
<span class="tok-nt">&lt;/c:import&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Obtiene y muestra el contenido de la URL indicada.</p>
</div>
<div class="paragraph">
<p><strong>param</strong></p>
</div>
<div class="paragraph">
<p>El tag <code>param</code> se utiliza dentro del tag <code>import</code> y de otros tags (<code>redirect</code>, <code>url</code>) para indicar parámetros de la URL solicitada. Dentro del tag <code>import</code> sólo se utiliza si la URL se guarda en una cadena. Para los <code>Readers</code> no se emplean parámetros.</p>
</div>
<div class="paragraph">
<p>SINTAXIS:</p>
</div>
<div class="paragraph">
<p>Sin cuerpo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;c:param</span> <span class="tok-na">name=</span><span class="tok-s">&quot;nombre&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;valor&quot;</span><span class="tok-nt">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Con cuerpo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;c:param</span> <span class="tok-na">name=</span><span class="tok-s">&quot;nombre&quot;</span><span class="tok-nt">&gt;</span>
  Valor
<span class="tok-nt">&lt;/c:param&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>ATRIBUTOS:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>name</code>: nombre del parámetro</p>
</li>
<li>
<p><code>value</code>: valor del parámetro. Puede indicarse bien mediante este atributo, bien en el cuerpo del tag.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>EJEMPLO:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;c:import</span> <span class="tok-na">url=</span><span class="tok-s">&quot;http://localhost/mipagina.jsp&quot;</span>
 <span class="tok-na">var=</span><span class="tok-s">&quot;universidad&quot;</span><span class="tok-nt">&gt;</span>
  <span class="tok-nt">&lt;c:param</span> <span class="tok-na">name=</span><span class="tok-s">&quot;id&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;12&quot;</span><span class="tok-nt">/&gt;</span>
<span class="tok-nt">&lt;/c:import&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Obtiene la página <code>mipagina.jsp?id=12</code> (le pasa como parámetro <code>id</code> el valor 12).</p>
</div>
<div class="paragraph">
<p><strong>Otras Etiquetas</strong></p>
</div>
<div class="paragraph">
<p>Existen otras etiquetas, como <code>url</code> o <code>redirect</code>, que no se comentan aquí.</p>
</div>
</div>
<div class="sect5">
<h6 id="_ejemplo_3">Ejemplo</h6>
<div class="paragraph">
<p>Vemos cómo quedaría el ejemplo visto en la sesión anterior para la librería <code>request</code> adaptado a la librería <code>core</code>. Partiendo del mismo formulario inicial:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;html&gt;</span>
<span class="tok-nt">&lt;body&gt;</span>
  <span class="tok-nt">&lt;form</span> <span class="tok-na">action=</span><span class="tok-s">&quot;request.jsp&quot;</span><span class="tok-nt">&gt;</span>
    Nombre:
    <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;nombre&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;br&gt;</span>
    Descripcion:
    <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;descripcion&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;br&gt;</span>
    <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;submit&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;Enviar&quot;</span><span class="tok-nt">&gt;</span>
  <span class="tok-nt">&lt;/form&gt;</span>
<span class="tok-nt">&lt;/body&gt;</span>
<span class="tok-nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para obtener los parámetros podríamos tener una página como esta:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-err">&lt;</span>%@ taglib uri=&quot;http://java.sun.com/jstl/ea/core&quot; prefix=&quot;c&quot; %&gt;

<span class="tok-nt">&lt;html&gt;</span>
<span class="tok-nt">&lt;body&gt;</span>
  Nombre: <span class="tok-nt">&lt;c:out</span> <span class="tok-na">value=</span><span class="tok-s">&quot;${param.nombre}&quot;</span><span class="tok-nt">/&gt;</span>
  <span class="tok-nt">&lt;br&gt;</span>
  <span class="tok-nt">&lt;c:if</span> <span class="tok-na">test=</span><span class="tok-s">&quot;${not empty param.descripcion}&quot;</span><span class="tok-nt">&gt;</span>
    Descripcion: <span class="tok-nt">&lt;c:out</span> <span class="tok-na">value=</span><span class="tok-s">&quot;${param.descripcion}&quot;</span><span class="tok-nt">/&gt;</span>
  <span class="tok-nt">&lt;/c:if&gt;</span>
<span class="tok-nt">&lt;/body&gt;</span>
<span class="tok-nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Hemos utilizado en este caso, como ejemplo, los tags <code>out</code> e <code>if</code> (para comprobar si hay parámetro <code>descripcion</code>). En este último caso, utilizamos el operador <code>empty</code> en el lenguaje de expresiones, para ver si hay o no valor.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_la_librería_de_funciones">La librería de funciones</h5>
<div class="paragraph">
<p>JSTL dispone también de un conjunto de <strong>funciones</strong> que pueden emplearse desde dentro del lenguaje de expresiones, y permiten sobre todo manipular cadenas, para sustituir caracteres, concatenar, etc.</p>
</div>
<div class="paragraph">
<p>Para utilizar estas funciones, cargaríamos la directiva <code>taglib</code> correspondiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-err">&lt;</span>%@ taglib uri=&quot;http://java.sun.com/jstl/ea/functions&quot; prefix=&quot;fn&quot; %&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Y luego utilizaríamos las funciones que haya disponibles, dentro de una expresión del lenguaje:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html">La cadena tiene <span class="tok-nt">&lt;c:out</span> <span class="tok-na">value=</span><span class="tok-s">&quot;${fn:length(miCadena)}&quot;</span><span class="tok-nt">/&gt;</span> caracteres</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_librerías_de_jsf_em_facelets_em">8.4.2. Librerías de JSF/<em>Facelets</em></h4>
<div class="paragraph">
<p>Hemos visto hasta el momento librerías de JSTL que podemos utilizar dentro de los <em>Facelets</em>, pero que también encontraremos dentro de otros <em>frameworks</em>. Vamos a ver ahora algunas librerías propias de <em>Facelets</em>/JSF, como la librería HTML de JSF y la librería UI de <em>Facelets</em> que nos permitirá crear plantillas para las páginas.</p>
</div>
<div class="sect4">
<h5 id="_librería_html_de_jsf">Librería HTML de JSF</h5>
<div class="paragraph">
<p>Una de las principales librerías de etiquetas utilizada en <em>Facelets</em> es la librería HTML de JSF. Esta librería contiene una serie de componentes de la interfaz que se renderizarán en la página como HTML. Gran parte de los componentes de esta librería son campos de formularios, cuyo valor puede vincularse con <em>managed beans</em> y podemos establecer la forma mediante etiquetas de la librería de funciones de JSF. Por ejemplo podríamos tener un campo de texto como el siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xhtml"><span class="tok-nt">&lt;h:inputText</span> <span class="tok-na">id=</span><span class="tok-s">&quot;precio&quot;</span>
             <span class="tok-na">size=</span><span class="tok-s">&quot;4&quot;</span>
             <span class="tok-na">value=</span><span class="tok-s">&quot;#{articulo.precio}&quot;</span>
             <span class="tok-na">title=</span><span class="tok-s">&quot;Cantidad&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;f:validateLongRange</span> <span class="tok-na">minimum=</span><span class="tok-s">&quot;0&quot;</span><span class="tok-nt">/&gt;</span>
<span class="tok-nt">&lt;/h:inputText&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En el ejemplo anterior se crea un campo de texto que se renderizará como una etiqueta <code>&lt;input&gt;</code> en el HTML resultante, y quedará vinculado en el servidor con el precio del <em>managed bean</em> <code>articulo</code>. Además, se especifica que el campo debe ser validado de forma que nunca tenga un valor inferior a <code>0</code>.</p>
</div>
<div class="paragraph">
<p>Encontramos otras etiquetas como las siguientes dentro de esta librería:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Etiqueta</th>
<th class="tableblock halign-left valign-top">Función</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;h:commandLink&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Representa un enlace a otra página, se renderiza como <code>&lt;a&gt;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;h:dataTable&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tabla que se puede actualizar de forma dinámica, se renderiza como <code>&lt;table&gt;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;h:column&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Representa una columna en una tabla</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;h:panelGroup&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Representa una fila en una tabla, se renderiza como <code>&lt;div&gt;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;h:graphicImage&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Muestra una imagen, se renderiza como <code>&lt;img&gt;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;h:outputText&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Muestra texto plano</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;h:outputStylesheet&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Permite especificar una hoja de estilo</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;h:head&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Equivalente a <code>&lt;head&gt;</code>, permite reubicar bloques de <em>script</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;h:body&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Equivalente a <code>&lt;body&gt;</code>, permite reubicar bloques de <em>script</em></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>En todas estas etiquetas encontramos una serie de atributos comunes:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Atributo</th>
<th class="tableblock halign-left valign-top">Función</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Identifica al componente de forma única.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rendered</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Podemos especificar una condición mediante EL que indica si el componente se debe mostrar o no.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>style</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Especifica el estilo CSS.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>styleClass</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Especifica una clase de estilo.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_recursos">Recursos</h5>
<div class="paragraph">
<p>Hablamos de recursos para referirnos a cualquier artefacto que una página web necesita para mostrarse correctamente, como son las imágenes, ficheros JavaScript, hojas de estilo, etc. En los <em>Facelets</em> podremos hacer referencia a estos recursos simplemente indicando el nombre del recurso, siempre que éstos se encuentren en determinadas ubicaciones estándar. Estas ubicaciones son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Directorio <code>resources</code> en la raíz del contexto.</p>
</li>
<li>
<p>Dentro del <em>classpath</em>, en <code>META-INF/resources</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Si el recurso se encuentra en una de las localizaciones anteriores podemos hacer referencia a él únicamente mediante su nombre en los atributos de las etiquetas de JSF/<em>Facelets</em>, como por ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xhtml"><span class="tok-nt">&lt;h:outputStylesheet</span> <span class="tok-na">library=</span><span class="tok-s">&quot;css&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;estilo.css&quot;</span><span class="tok-nt">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En este caso podríamos tener la hoja de estilo en <code>/resources/css/estilo.css</code>.</p>
</div>
<div class="paragraph">
<p>Podemos también hacer referencia a la ubicación mediante lenguaje de expresiones:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xhtml"><span class="tok-nt">&lt;h:graphicImage</span> <span class="tok-na">value=</span><span class="tok-s">&quot;#{resource[&#39;imagenes:logo.gif&#39;]}&quot;</span><span class="tok-nt">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En el caso anterior buscará la imagen en <code>/resources/imagenes/logo.gif</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_plantillas">Plantillas</h5>
<div class="paragraph">
<p>La tecnología de <em>Facelets</em> nos permite crear plantillas para las páginas. Estas plantillas definen una determinada disposición de los elementos en el documento, y podrán ser aplicadas a diferentes páginas para así tener una estructura homogénea en todo el sitio web. En estas plantillas por ejemplo podríamos definir un bloque de cabecera, menú lateral, cuerpo de la página, pie de página, etc.</p>
</div>
<div class="paragraph">
<p>Para la creación de plantillas utilizaremos la librería de Interfaz de Usuario (UI) de <em>Facelets</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot;</span>
<span class="tok-cp">      &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;</span>
<span class="tok-nt">&lt;html</span> <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://www.w3.org/1999/xhtml&quot;</span>
      <span class="tok-na">xmlns:ui=</span><span class="tok-s">&quot;http://xmlns.jcp.org/jsf/facelets&quot;</span> <i class="conum" data-value="1"></i><b>(1)</b>
      <span class="tok-na">xmlns:h=</span><span class="tok-s">&quot;http://xmlns.jcp.org/jsf/html&quot;</span><span class="tok-nt">&gt;</span>

    <span class="tok-nt">&lt;h:head&gt;</span>
        <span class="tok-nt">&lt;meta</span> <span class="tok-na">http-equiv=</span><span class="tok-s">&quot;Content-Type&quot;</span>
              <span class="tok-na">content=</span><span class="tok-s">&quot;text/html; charset=UTF-8&quot;</span> <span class="tok-nt">/&gt;</span>
        <span class="tok-nt">&lt;h:outputStylesheet</span> <span class="tok-na">library=</span><span class="tok-s">&quot;css&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;estilo.css&quot;</span><span class="tok-nt">/&gt;</span>
        <span class="tok-nt">&lt;title&gt;</span>Plantilla con Facelets<span class="tok-nt">&lt;/title&gt;</span>
    <span class="tok-nt">&lt;/h:head&gt;</span>

    <span class="tok-nt">&lt;h:body&gt;</span>
        <span class="tok-nt">&lt;div</span> <span class="tok-na">id=</span><span class="tok-s">&quot;top&quot;</span> <span class="tok-na">class=</span><span class="tok-s">&quot;top&quot;</span><span class="tok-nt">&gt;</span>
            <span class="tok-nt">&lt;ui:insert</span> <span class="tok-na">name=</span><span class="tok-s">&quot;cabecera&quot;</span><span class="tok-nt">&gt;</span>Cabecera<span class="tok-nt">&lt;/ui:insert&gt;</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-nt">&lt;/div&gt;</span>
        <span class="tok-nt">&lt;div&gt;</span>
        <span class="tok-nt">&lt;div</span> <span class="tok-na">id=</span><span class="tok-s">&quot;left&quot;</span><span class="tok-nt">&gt;</span>
             <span class="tok-nt">&lt;ui:insert</span> <span class="tok-na">name=</span><span class="tok-s">&quot;menu&quot;</span><span class="tok-nt">&gt;</span>Menú lateral<span class="tok-nt">&lt;/ui:insert&gt;</span>
        <span class="tok-nt">&lt;/div&gt;</span>
        <span class="tok-nt">&lt;div</span> <span class="tok-na">id=</span><span class="tok-s">&quot;content&quot;</span> <span class="tok-na">class=</span><span class="tok-s">&quot;content&quot;</span><span class="tok-nt">&gt;</span>
             <span class="tok-nt">&lt;ui:insert</span> <span class="tok-na">name=</span><span class="tok-s">&quot;cuerpo&quot;</span><span class="tok-nt">&gt;</span>Cuerpo de la página<span class="tok-nt">&lt;/ui:insert&gt;</span>
        <span class="tok-nt">&lt;/div&gt;</span>
        <span class="tok-nt">&lt;/div&gt;</span>
    <span class="tok-nt">&lt;/h:body&gt;</span>
<span class="tok-nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declaramos la librería UI de <em>Facelets</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Utilizamos <code>&lt;ui:insert&gt;</code> para crear un lugar donde insertar contenido dentro de la plantilla general.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En el ejemplo anterior hemos creado una plantilla de página web donde se definen tres lugares donde vamos a poner insertar contenido: <code>cabecera</code>, <code>menu</code> y <code>cuerpo</code>. Vamos a crear a continuación una página que se ajuste a dicha plantilla e inserte contenido en cada una de las secciones.</p>
</div>
<div class="paragraph">
<p>Consideremos que el fichero anterior con la plantilla ha sido guardado con el nombre <code>plantilla.xhtml</code>. Una página que utilice dicha plantilla podría definirse de la siguiente forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot;</span>
<span class="tok-cp">  &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;</span>
<span class="tok-nt">&lt;html</span> <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://www.w3.org/1999/xhtml&quot;</span>
      <span class="tok-na">xmlns:ui=</span><span class="tok-s">&quot;http://xmlns.jcp.org/jsf/facelets&quot;</span>
      <span class="tok-na">xmlns:h=</span><span class="tok-s">&quot;http://xmlns.jcp.org/jsf/html&quot;</span><span class="tok-nt">&gt;</span>

    <span class="tok-nt">&lt;h:body&gt;</span>
        <span class="tok-nt">&lt;ui:composition</span> <span class="tok-na">template=</span><span class="tok-s">&quot;./plantilla.xhtml&quot;</span><span class="tok-nt">&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="tok-nt">&lt;ui:define</span> <span class="tok-na">name=</span><span class="tok-s">&quot;cabecera&quot;</span><span class="tok-nt">&gt;</span> <i class="conum" data-value="2"></i><b>(2)</b>
                Título de la página
            <span class="tok-nt">&lt;/ui:define&gt;</span>

            <span class="tok-nt">&lt;ui:define</span> <span class="tok-na">name=</span><span class="tok-s">&quot;menu&quot;</span><span class="tok-nt">&gt;</span>
                <span class="tok-nt">&lt;h:outputLabel</span> <span class="tok-na">value=</span><span class="tok-s">&quot;Menú&quot;</span><span class="tok-nt">/&gt;</span>
            <span class="tok-nt">&lt;/ui:define&gt;</span>

            <span class="tok-nt">&lt;ui:define</span> <span class="tok-na">name=</span><span class="tok-s">&quot;cuerpo&quot;</span><span class="tok-nt">&gt;</span>
                <span class="tok-nt">&lt;h:graphicImage</span> <span class="tok-na">value=</span><span class="tok-s">&quot;#{resource[&#39;images:logo.gif&#39;]}&quot;</span><span class="tok-nt">/&gt;</span>
                <span class="tok-nt">&lt;h:outputText</span> <span class="tok-na">value=</span><span class="tok-s">&quot;2014 (c) DCCIA&quot;</span><span class="tok-nt">/&gt;</span>
            <span class="tok-nt">&lt;/ui:define&gt;</span>
        <span class="tok-nt">&lt;/ui:composition&gt;</span>
    <span class="tok-nt">&lt;/h:body&gt;</span>
<span class="tok-nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Con la etiqueta <code>&lt;ui:composition&gt;</code> indicamos la plantilla que vamos a utilizar.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Con la etiqueta <code>&lt;ui:define&gt;</code> indicamos el contenido que vamos a insertar en cada una de las secciones de la plantilla utilizada.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Vemos en el ejemplo anterior que podremos poner una etiqueta <code>&lt;ui:define&gt;</code> por cada elemento definido mediante <code>&lt;ui:insert&gt;</code> en la plantilla que estamos utilizando.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios_8">8.5. Ejercicios</h3>
<div class="sect3">
<h4 id="_página_de_chat_con_em_facelets_em_1_punto">8.5.1. Página de chat con <em>Facelets</em> (1 punto)</h4>
<div class="paragraph">
<p>Vamos a crear una implementación alternativa del listado de mensajes del chat mediante un <em>Facelet</em> que utilice la librería JSTL y el lenguaje de expresiones. Los <em>Facelets</em> son más apropiados que los <em>Servlets</em> para crear la vista de la aplicación, por lo que será conveniente pasar la presentación que actualmente está realizando <code>ListaMensajesServlet</code> a un <em>Facelet</em>.</p>
</div>
<div class="paragraph">
<p>Seguiremos los siguientes pasos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Añade la <strong>configuración de JSF</strong> al proyecto desde IntelliJ. Se deberá crear el fichero <code>faces-config.xml</code> en <code>WEB-INF</code> y mapear el <em>Faces Servlet</em> a las direcciones de tipo <code>*.xhtml</code>.</p>
</li>
<li>
<p>Crea desde IntelliJ un nuevo <em>Facelet</em> llamado <code>listaMensajes.xhtml</code> en el directorio <code>webapp/chat</code>.</p>
</li>
<li>
<p>Importa en el <em>Facelet</em> la <strong>librería JSTL Core</strong>.</p>
</li>
<li>
<p>Crearemos un recuadro para el chat siguiendo el mismo estilo de las páginas utilizadas en sesiones anteriores. Esta vez podemos <strong>importar la hoja de estilo</strong> <code>estilo.css</code> como un recurso.</p>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Deberemos copiar el fichero <code>estilo.css</code> a un directorio donde pueda ser importado como recurso (<code>webapp/resources</code>).
</td>
</tr>
</table>
</div>
</li>
<li>
<p>En la cabecera del cuadro del chat <strong>indicaremos el nombre del usuario</strong> que hay actualmente conectado. Podemos poner un mensaje como "Conectado al chat como &lt;nombre&gt;".</p>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
El nombre del atributo donde se guarda el <em>nick</em> es <code>org.expertojava.cweb.chat.nick</code>, lo cual puede causar problemas al utilizarlo dentro del lenguaje de expresiones. Para evitar estos problemas podríamos utilizar una sintaxis como <code>${sessionScope["nombre_atributo"]}</code>.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Utilizaremos un <em>managed bean</em> para <strong>mostrar los mensajes</strong> en la página. Deberemos:</p>
<div class="ulist">
<ul>
<li>
<p>Si la cola está vacía, mostraremos el mensaje "Todavía no se ha enviado ningún mensaje al chat".</p>
</li>
<li>
<p>Si la cola tiene mensajes, iteraremos por la cola para mostrar todos los mensajes junto al nombre del usuario que los envió.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
No podemos utilizar directamente el objeto <code>ColaMensajes</code> dentro del lenguaje de expresiones al tratarse de un objeto de tipo <code>LinkedList</code>. Podemos crearnos un nuevo <em>managed bean</em> que nos dé acceso a dicha lista mediante uno de sus atributos. Por ejemplo, podríamos crear un objeto <code>Chat</code> dentro del ámbito de la aplicación con un atributo <code>cola</code> en el que inyectaremos el objeto <code>ColaMensajes</code>. De esta forma podríamos acceder a ella desde lenguaje de expresiones con <code>${chat.cola}</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Todo lo anterior debe realizarse utilizando <strong>únicamente JSTL y lenguaje de expresiones</strong>.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2014-10-15 13:02:46 CEST
</div>
</div>
</body>
</html>