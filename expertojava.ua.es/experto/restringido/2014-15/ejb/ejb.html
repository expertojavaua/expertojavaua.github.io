<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.1">
<meta name="author" content="Domingo Gallardo">
<title>Componentes enterprise</title>
<style>/*! normalize.css v2.1.2 | MIT License | git.io/normalize */
/* ========================================================================== HTML5 display definitions ========================================================================== */
/** Correct `block` display not defined in IE 8/9. */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }

/** Correct `inline-block` display not defined in IE 8/9. */
audio, canvas, video { display: inline-block; }

/** Prevent modern browsers from displaying `audio` without controls. Remove excess height in iOS 5 devices. */
audio:not([controls]) { display: none; height: 0; }

/** Address `[hidden]` styling not present in IE 8/9. Hide the `template` element in IE, Safari, and Firefox < 22. */
[hidden], template { display: none; }

script { display: none !important; }

/* ========================================================================== Base ========================================================================== */
/** 1. Set default font family to sans-serif. 2. Prevent iOS text size adjust after orientation change, without disabling user zoom. */
html { font-family: sans-serif; /* 1 */ -ms-text-size-adjust: 100%; /* 2 */ -webkit-text-size-adjust: 100%; /* 2 */ }

/** Remove default margin. */
body { margin: 0; }

/* ========================================================================== Links ========================================================================== */
/** Remove the gray background color from active links in IE 10. */
a { background: transparent; }

/** Address `outline` inconsistency between Chrome and other browsers. */
a:focus { outline: thin dotted; }

/** Improve readability when focused and also mouse hovered in all browsers. */
a:active, a:hover { outline: 0; }

/* ========================================================================== Typography ========================================================================== */
/** Address variable `h1` font-size and margin within `section` and `article` contexts in Firefox 4+, Safari 5, and Chrome. */
h1 { font-size: 2em; margin: 0.67em 0; }

/** Address styling not present in IE 8/9, Safari 5, and Chrome. */
abbr[title] { border-bottom: 1px dotted; }

/** Address style set to `bolder` in Firefox 4+, Safari 5, and Chrome. */
b, strong { font-weight: bold; }

/** Address styling not present in Safari 5 and Chrome. */
dfn { font-style: italic; }

/** Address differences between Firefox and other browsers. */
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }

/** Address styling not present in IE 8/9. */
mark { background: #ff0; color: #000; }

/** Correct font family set oddly in Safari 5 and Chrome. */
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }

/** Improve readability of pre-formatted text in all browsers. */
pre { white-space: pre-wrap; }

/** Set consistent quote types. */
q { quotes: "\201C" "\201D" "\2018" "\2019"; }

/** Address inconsistent and variable font size in all browsers. */
small { font-size: 80%; }

/** Prevent `sub` and `sup` affecting `line-height` in all browsers. */
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }

sup { top: -0.5em; }

sub { bottom: -0.25em; }

/* ========================================================================== Embedded content ========================================================================== */
/** Remove border when inside `a` element in IE 8/9. */
img { border: 0; }

/** Correct overflow displayed oddly in IE 9. */
svg:not(:root) { overflow: hidden; }

/* ========================================================================== Figures ========================================================================== */
/** Address margin not present in IE 8/9 and Safari 5. */
figure { margin: 0; }

/* ========================================================================== Forms ========================================================================== */
/** Define consistent border, margin, and padding. */
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }

/** 1. Correct `color` not being inherited in IE 8/9. 2. Remove padding so people aren't caught out if they zero out fieldsets. */
legend { border: 0; /* 1 */ padding: 0; /* 2 */ }

/** 1. Correct font family not being inherited in all browsers. 2. Correct font size not being inherited in all browsers. 3. Address margins set differently in Firefox 4+, Safari 5, and Chrome. */
button, input, select, textarea { font-family: inherit; /* 1 */ font-size: 100%; /* 2 */ margin: 0; /* 3 */ }

/** Address Firefox 4+ setting `line-height` on `input` using `!important` in the UA stylesheet. */
button, input { line-height: normal; }

/** Address inconsistent `text-transform` inheritance for `button` and `select`. All other form control elements do not inherit `text-transform` values. Correct `button` style inheritance in Chrome, Safari 5+, and IE 8+. Correct `select` style inheritance in Firefox 4+ and Opera. */
button, select { text-transform: none; }

/** 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio` and `video` controls. 2. Correct inability to style clickable `input` types in iOS. 3. Improve usability and consistency of cursor style between image-type `input` and others. */
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; /* 2 */ cursor: pointer; /* 3 */ }

/** Re-set default cursor for disabled elements. */
button[disabled], html input[disabled] { cursor: default; }

/** 1. Address box sizing set to `content-box` in IE 8/9. 2. Remove excess padding in IE 8/9. */
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; /* 1 */ padding: 0; /* 2 */ }

/** 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome. 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome (include `-moz` to future-proof). */
input[type="search"] { -webkit-appearance: textfield; /* 1 */ -moz-box-sizing: content-box; -webkit-box-sizing: content-box; /* 2 */ box-sizing: content-box; }

/** Remove inner padding and search cancel button in Safari 5 and Chrome on OS X. */
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }

/** Remove inner padding and border in Firefox 4+. */
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }

/** 1. Remove default vertical scrollbar in IE 8/9. 2. Improve readability and alignment in all browsers. */
textarea { overflow: auto; /* 1 */ vertical-align: top; /* 2 */ }

/* ========================================================================== Tables ========================================================================== */
/** Remove most spacing between table cells. */
table { border-collapse: collapse; border-spacing: 0; }

meta.foundation-mq-small { font-family: "only screen and (min-width: 768px)"; width: 768px; }

meta.foundation-mq-medium { font-family: "only screen and (min-width:1280px)"; width: 1280px; }

meta.foundation-mq-large { font-family: "only screen and (min-width:1440px)"; width: 1440px; }

*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }

html, body { font-size: 97%; }

body { background: white; color: #222222; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }

a:hover { cursor: pointer; }

img, object, embed { max-width: 100%; height: auto; }

object, embed { height: 100%; }

img { -ms-interpolation-mode: bicubic; }

#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }

.left { float: left !important; }

.right { float: right !important; }

.text-left { text-align: left !important; }

.text-right { text-align: right !important; }

.text-center { text-align: center !important; }

.text-justify { text-align: justify !important; }

.hide { display: none; }

.antialiased, body { -webkit-font-smoothing: antialiased; }

img { display: inline-block; vertical-align: middle; }

textarea { height: auto; min-height: 50px; }

select { width: 100%; }

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }

.subheader, .admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { line-height: 1.4; color: #6f6f6f; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }

/* Typography resets */
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }

/* Default Link Styles */
a { color: #1164be; text-decoration: none; line-height: inherit; }
a img { border: none; }

/* Default paragraph styles */
p { font-family: inherit; font-weight: normal; font-size: 1em; line-height: 1.4; margin-bottom: 1em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }

/* Default header styles */
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: bold; font-style: normal; color: #222222; text-rendering: optimizeLegibility; margin-top: 1em; margin-bottom: 0.5em; line-height: 1.2125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #6f6f6f; line-height: 0; }

h1 { font-size: 2.125em; }

h2 { font-size: 1.6875em; }

h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }

h4 { font-size: 1.125em; }

h5 { font-size: 1.125em; }

h6 { font-size: 1em; }

hr { border: solid #dddddd; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }

/* Helpful Typography Defaults */
em, i { font-style: italic; line-height: inherit; }

strong, b { font-weight: bold; line-height: inherit; }

small { font-size: 60%; line-height: inherit; }

code { font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: bold; }

/* Lists */
ul, ol, dl { font-size: 1em; line-height: 1.4; margin-bottom: 1.25em; list-style-position: outside; font-family: inherit; }

ul, ol { margin-left: 2.5em; }
ul.no-bullet, ol.no-bullet { margin-left: 1.5em; }

/* Unordered Lists */
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; /* Override nested font-size change */ }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }

/* Ordered Lists */
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }

/* Definition Lists */
dl dt { margin-bottom: 0.3125em; font-weight: bold; }
dl dd { margin-bottom: 1.25em; }

/* Abbreviations */
abbr, acronym { text-transform: uppercase; font-size: 90%; color: #222222; border-bottom: 1px dotted #dddddd; cursor: help; }

abbr { text-transform: none; }

/* Blockquotes */
blockquote { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
blockquote cite { display: block; font-size: 0.8125em; color: #555555; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #555555; }

blockquote, blockquote p { line-height: 1.6; color: #6f6f6f; }

/* Microformats */
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #dddddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }

.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }

@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.6875em; }
  h4 { font-size: 1.4375em; } }
/* Tables */
table { background: white; margin-bottom: 1.25em; border: solid 1px #dddddd; }
table thead, table tfoot { background: whitesmoke; font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: #222222; text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: #222222; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #f9f9f9; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.4; }

h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; border-bottom: 1px solid #dddddd }

.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }

*:not(pre) > code { font-size: inherit; font-style: normal !important; letter-spacing: 0; padding: 3px 2px 1px 2px; background-color: #eeeeee; border: 1px solid #dddddd; -webkit-border-radius: 0; border-radius: 0; line-height: inherit; font-weight: normal; }

pre, pre > code { line-height: 1.4; color: black; font-family: monospace, serif; font-weight: normal; }

.keyseq { color: #555555; }

kbd { display: inline-block; color: #222222; font-size: 0.75em; line-height: 1.4; background-color: #f7f7f7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; margin: -0.15em 0.15em 0 0.15em; padding: 0.2em 0.6em 0.2em 0.5em; vertical-align: middle; white-space: nowrap; }

.keyseq kbd:first-child { margin-left: 0; }

.keyseq kbd:last-child { margin-right: 0; }

.menuseq, .menu { color: #090909; }

b.button:before, b.button:after { position: relative; top: -1px; font-weight: normal; }

b.button:before { content: "["; padding: 0 3px 0 2px; }

b.button:after { content: "]"; padding: 0 2px 0 3px; }

#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 0.9375em; padding-right: 0.9375em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }

#content { margin-top: 1.25em; }

#content:before { content: none; }

#header > h1:first-child { color: black; margin-top: 2.25rem; margin-bottom: 0; }
#header > h1:first-child + #toc { margin-top: 8px; border-top: 1px solid #dddddd; }
#header > h1:only-child, body.toc2 #header > h1:nth-last-child(2) { border-bottom: 1px solid #dddddd; padding-bottom: 8px; }
#header .details { border-bottom: 1px solid #dddddd; line-height: 1.45; padding-top: 0.25em; padding-bottom: 0.25em; padding-left: 0.25em; color: #555555; display: -ms-flexbox; display: -webkit-flex; display: flex; -ms-flex-flow: row wrap; -webkit-flex-flow: row wrap; flex-flow: row wrap; }
#header .details span:first-child { margin-left: -0.125em; }
#header .details span.email a { color: #6f6f6f; }
#header .details br { display: none; }
#header .details br + span:before { content: "\00a0\2013\00a0"; }
#header .details br + span.author:before { content: "\00a0\22c5\00a0"; color: #6f6f6f; }
#header .details br + span#revremark:before { content: "\00a0|\00a0"; }
#header #revnumber { text-transform: capitalize; }
#header #revnumber:after { content: "\00a0"; }

#content > h1:first-child:not([class]) { color: black; border-bottom: 1px solid #dddddd; padding-bottom: 8px; margin-top: 0; padding-top: 1rem; margin-bottom: 1.25rem; }

#floating {
  position: fixed;
  z-index: 1000;
  padding: 0.5em;
  right: 0;
  top: 0;
  background: white;
  box-shadow: 0 0 1em #777777;
  -webkit-box-shadow: 0 0 1em #777777;
  -moz-box-shadow: 0 0 1em #777777;
  -webkit-border-bottom-left-radius: 5px;
  -moz-border-radius-bottomleft: 5px;
  max-height: 80%;
  overflow: auto;
}

#floating #full { display: none; } /* Hide the full TOC by default */

#floating:hover #full{
  display: block; /* Show it on hover */
}


#toc { border-bottom: 1px solid #dddddd; padding-bottom: 0.5em; }
#toc > ul { margin-left: 0.125em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin: 0.5em 0; }
#toc ul { font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; list-style-type: none; }
#toc a { text-decoration: none; }
#toc a:active { text-decoration: underline; }

#toctitle { color: #6f6f6f; font-size: 1.2em; }

@media only screen and (min-width: 768px) { #toctitle { font-size: 1.375em; }
  body.toc2 { padding-left: 15em; padding-right: 0; }
  #toc.toc2 { margin-top: 0 !important; background-color: #f2f2f2; position: fixed; width: 15em; left: 0; top: 0; border-right: 1px solid #dddddd; border-top-width: 0 !important; border-bottom-width: 0 !important; z-index: 1000; padding: 1.25em 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; font-size: 1.2em; }
  #toc.toc2 > ul { font-size: 0.9em; margin-bottom: 0; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 15em; }
  body.toc2.toc-right #toc.toc2 { border-right-width: 0; border-left: 1px solid #dddddd; left: auto; right: 0; } }
@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; padding-right: 0; }
  #toc.toc2 { width: 20em; }
  #toc.toc2 #toctitle { font-size: 1.375em; }
  #toc.toc2 > ul { font-size: 0.95em; }
  #toc.toc2 ul ul { padding-left: 1.25em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; } }
#content #toc { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 0; border-radius: 0; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }

#footer { max-width: 100%; background-color: #222222; padding: 1.25em; }

#footer-text { color: #dddddd; line-height: 1.44; }

.sect1 { padding-bottom: 0.625em; }

@media only screen and (min-width: 768px) { .sect1 { padding-bottom: 1.25em; } }
.sect1 + .sect1 { border-top: 1px solid #dddddd; }

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; z-index: 1001; width: 1.5ex; margin-left: -1.5ex; display: block; text-decoration: none !important; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: "\00A7"; font-size: 0.85em; display: block; padding-top: 0.1em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #222222; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #151515; }

.audioblock, .imageblock, .literalblock, .listingblock, .stemblock, .videoblock { margin-bottom: 1.25em; }

.admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-rendering: optimizeLegibility; text-align: left; }

table.tableblock > caption.title { white-space: nowrap; overflow: visible; max-width: 0; }

.paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { color: black; }

table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }

.admonitionblock > table { border-collapse: separate; border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #dddddd; color: #555555; }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }

.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 0; border-radius: 0; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }

.sidebarblock { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 0; border-radius: 0; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock > .content > .title { color: #6f6f6f; margin-top: 0; }

.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }

.literalblock pre, .listingblock pre:not(.highlight), .listingblock pre[class="highlight"], .listingblock pre[class^="highlight "], .listingblock pre.CodeRay, .listingblock pre.prettyprint { background: #eeeeee; }
.sidebarblock .literalblock pre, .sidebarblock .listingblock pre:not(.highlight), .sidebarblock .listingblock pre[class="highlight"], .sidebarblock .listingblock pre[class^="highlight "], .sidebarblock .listingblock pre.CodeRay, .sidebarblock .listingblock pre.prettyprint { background: #f2f1f1; }

.literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { border: 1px solid #cccccc; -webkit-border-radius: 0; border-radius: 0; word-wrap: break-word; padding: 0.8em 0.8em 0.65em 0.8em; font-size: 0.8125em; }
.literalblock pre.nowrap, .literalblock pre[class].nowrap, .listingblock pre.nowrap, .listingblock pre[class].nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
@media only screen and (min-width: 768px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 0.90625em; } }
@media only screen and (min-width: 1280px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 1em; } }

.literalblock.output pre { color: #eeeeee; background-color: black; }

.listingblock pre.highlightjs { padding: 0; }
.listingblock pre.highlightjs > code { padding: 0.8em 0.8em 0.65em 0.8em; -webkit-border-radius: 0; border-radius: 0; }

.listingblock > .content { position: relative; }

.listingblock code[data-lang]:before { display: none; content: attr(data-lang); position: absolute; font-size: 0.75em; top: 0.425rem; right: 0.5rem; line-height: 1; text-transform: uppercase; color: #999; }

.listingblock:hover code[data-lang]:before { display: block; }

.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }

.listingblock.terminal pre .command:not([data-prompt]):before { content: "$"; }

table.pyhltable { border-collapse: separate; border: 0; margin-bottom: 0; background: none; }

table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; }

table.pyhltable td.code { padding-left: .75em; padding-right: 0; }

pre.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #dddddd; }

pre.pygments .lineno { display: inline-block; margin-right: .25em; }

table.pyhltable .linenodiv { background: none !important; padding-right: 0 !important; }

.quoteblock { margin: 0 1em 1.25em 1.5em; display: table; }
.quoteblock > .title { margin-left: -1.5em; margin-bottom: 0.75em; }
.quoteblock blockquote, .quoteblock blockquote p { color: #6f6f6f; font-size: 1.15rem; line-height: 1.75; word-spacing: 0.1em; letter-spacing: 0; font-style: italic; text-align: justify; }
.quoteblock blockquote { margin: 0; padding: 0; border: 0; }
.quoteblock blockquote:before { content: "\201c"; float: left; font-size: 2.75em; font-weight: bold; line-height: 0.6em; margin-left: -0.6em; color: #6f6f6f; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: 0.5em; margin-right: 0.5ex; text-align: right; }
.quoteblock .quoteblock { margin-left: 0; margin-right: 0; padding: 0.5em 0; border-left: 3px solid #555555; }
.quoteblock .quoteblock blockquote { padding: 0 0 0 0.75em; }
.quoteblock .quoteblock blockquote:before { display: none; }

.verseblock { margin: 0 1em 1.25em 1em; }
.verseblock pre { font-family: "Open Sans", "DejaVu Sans", sans; font-size: 1.15rem; color: #6f6f6f; font-weight: 300; text-rendering: optimizeLegibility; }
.verseblock pre strong { font-weight: 400; }
.verseblock .attribution { margin-top: 1.25rem; margin-left: 0.5ex; }

.quoteblock .attribution, .verseblock .attribution { font-size: 0.8125em; line-height: 1.45; font-style: italic; }
.quoteblock .attribution br, .verseblock .attribution br { display: none; }
.quoteblock .attribution cite, .verseblock .attribution cite { display: block; letter-spacing: -0.05em; color: #555555; }

.quoteblock.abstract { margin: 0 0 1.25em 0; display: block; }
.quoteblock.abstract blockquote, .quoteblock.abstract blockquote p { text-align: left; word-spacing: 0; }
.quoteblock.abstract blockquote:before, .quoteblock.abstract blockquote p:first-of-type:before { display: none; }

table.tableblock { max-width: 100%; border-collapse: separate; }
table.tableblock td > .paragraph:last-child p > p:last-child, table.tableblock th > p:last-child, table.tableblock td > p:last-child { margin-bottom: 0; }

table.spread { width: 100%; }

table.tableblock, th.tableblock, td.tableblock { border: 0 solid #dddddd; }

table.grid-all th.tableblock, table.grid-all td.tableblock { border-width: 0 1px 1px 0; }

table.grid-all tfoot > tr > th.tableblock, table.grid-all tfoot > tr > td.tableblock { border-width: 1px 1px 0 0; }

table.grid-cols th.tableblock, table.grid-cols td.tableblock { border-width: 0 1px 0 0; }

table.grid-all * > tr > .tableblock:last-child, table.grid-cols * > tr > .tableblock:last-child { border-right-width: 0; }

table.grid-rows th.tableblock, table.grid-rows td.tableblock { border-width: 0 0 1px 0; }

table.grid-all tbody > tr:last-child > th.tableblock, table.grid-all tbody > tr:last-child > td.tableblock, table.grid-all thead:last-child > tr > th.tableblock, table.grid-rows tbody > tr:last-child > th.tableblock, table.grid-rows tbody > tr:last-child > td.tableblock, table.grid-rows thead:last-child > tr > th.tableblock { border-bottom-width: 0; }

table.grid-rows tfoot > tr > th.tableblock, table.grid-rows tfoot > tr > td.tableblock { border-width: 1px 0 0 0; }

table.frame-all { border-width: 1px; }

table.frame-sides { border-width: 0 1px; }

table.frame-topbot { border-width: 1px 0; }

th.halign-left, td.halign-left { text-align: left; }

th.halign-right, td.halign-right { text-align: right; }

th.halign-center, td.halign-center { text-align: center; }

th.valign-top, td.valign-top { vertical-align: top; }

th.valign-bottom, td.valign-bottom { vertical-align: bottom; }

th.valign-middle, td.valign-middle { vertical-align: middle; }

table thead th, table tfoot th { font-weight: bold; }

tbody tr th { display: table-cell; line-height: 1.4; background: whitesmoke; }

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p { color: #222222; font-weight: bold; }

p.tableblock > code:only-child { background: none; padding: 0; }

p.tableblock { font-size: 1em; }

td > div.verse { white-space: pre; }

ol { margin-left: 2.5em; }

ul li ol { margin-left: 1.5em; }

dl dd { margin-left: 1.125em; }

dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }

ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.625em; }

ul.unstyled, ol.unnumbered, ul.checklist, ul.none { list-style-type: none; }

ul.unstyled, ol.unnumbered, ul.checklist { margin-left: 0.625em; }

ul.checklist li > p:first-child > .fa-check-square-o:first-child, ul.checklist li > p:first-child > input[type="checkbox"]:first-child { margin-right: 0.25em; }

ul.checklist li > p:first-child > input[type="checkbox"]:first-child { position: relative; top: 1px; }

ul.inline { margin: 0 auto 0.625em auto; margin-left: -1.375em; margin-right: 0; padding: 0; list-style: none; overflow: hidden; }
ul.inline > li { list-style: none; float: left; margin-left: 1.375em; display: block; }
ul.inline > li > * { display: block; }

.unstyled dl dt { font-weight: normal; font-style: normal; }

ol.arabic { list-style-type: decimal; }

ol.decimal { list-style-type: decimal-leading-zero; }

ol.loweralpha { list-style-type: lower-alpha; }

ol.upperalpha { list-style-type: upper-alpha; }

ol.lowerroman { list-style-type: lower-roman; }

ol.upperroman { list-style-type: upper-roman; }

ol.lowergreek { list-style-type: lower-greek; }

.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }

td.hdlist1 { padding-right: .75em; font-weight: bold; }

td.hdlist1, td.hdlist2 { vertical-align: top; }

.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }

.colist > table tr > td:first-of-type { padding: 0 0.75em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.25em 0; }

.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: 0 0 0 1px #dddddd; box-shadow: 0 0 0 1px #dddddd; }

.imageblock.left, .imageblock[style*="float: left"] { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }

.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }

a.image { text-decoration: none; }

span.footnote, span.footnoteref { vertical-align: super; font-size: 0.875em; }
span.footnote a, span.footnoteref a { text-decoration: none; }
span.footnote a:active, span.footnoteref a:active { text-decoration: underline; }

#footnotes { padding-top: 0.75em; padding-bottom: 0.75em; margin-bottom: 0.625em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -.25em 0 .75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.375em; line-height: 1.3; font-size: 0.875em; margin-left: 1.2em; text-indent: -1.2em; margin-bottom: .2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }

#content #footnotes { margin-top: -0.625em; margin-bottom: 0; padding: 0.75em 0; }

.gist .file-data > table { border: 0; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }

div.unbreakable { page-break-inside: avoid; }

.big { font-size: larger; }

.small { font-size: smaller; }

.underline { text-decoration: underline; }

.overline { text-decoration: overline; }

.line-through { text-decoration: line-through; }

.aqua { color: #00bfbf; }

.aqua-background { background-color: #00fafa; }

.black { color: black; }

.black-background { background-color: black; }

.blue { color: #0000bf; }

.blue-background { background-color: #0000fa; }

.fuchsia { color: #bf00bf; }

.fuchsia-background { background-color: #fa00fa; }

.gray { color: #606060; }

.gray-background { background-color: #7d7d7d; }

.green { color: #006000; }

.green-background { background-color: #007d00; }

.lime { color: #00bf00; }

.lime-background { background-color: #00fa00; }

.maroon { color: #600000; }

.maroon-background { background-color: #7d0000; }

.navy { color: #000060; }

.navy-background { background-color: #00007d; }

.olive { color: #606000; }

.olive-background { background-color: #7d7d00; }

.purple { color: #600060; }

.purple-background { background-color: #7d007d; }

.red { color: #bf0000; }

.red-background { background-color: #fa0000; }

.silver { color: #909090; }

.silver-background { background-color: #bcbcbc; }

.teal { color: #006060; }

.teal-background { background-color: #007d7d; }

.white { color: #bfbfbf; }

.white-background { background-color: #fafafa; }

.yellow { color: #bfbf00; }

.yellow-background { background-color: #fafa00; }

span.icon > .fa { cursor: default; }

.admonitionblock td.icon [class^="fa icon-"] { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #207c98; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }

.conum[data-value] { display: inline-block; color: #fff !important; background-color: #222222; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; font-size: 0.75em; width: 1.67em; height: 1.67em; line-height: 1.67em; font-family: "Open Sans", "DejaVu Sans", sans-serif; font-style: normal; font-weight: bold; }
.conum[data-value] * { color: #fff !important; }
.conum[data-value] + b { display: none; }
.conum[data-value]:after { content: attr(data-value); }
pre .conum[data-value] { position: relative; top: -0.125em; }

b.conum * { color: inherit !important; }

.conum:not([data-value]):empty { display: none; }

.literalblock pre, .listingblock pre { background: #eeeeee; }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.1.0/css/font-awesome.min.css">
<style>.listingblock .pygments .hll { background-color: #ffffcc }
.listingblock .pygments  { background: #f8f8f8; }
.listingblock .pygments .tok-c { color: #408080; font-style: italic } /* Comment */
.listingblock .pygments .tok-err { border: 1px solid #FF0000 } /* Error */
.listingblock .pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
.listingblock .pygments .tok-o { color: #666666 } /* Operator */
.listingblock .pygments .tok-cm { color: #408080; font-style: italic } /* Comment.Multiline */
.listingblock .pygments .tok-cp { color: #BC7A00 } /* Comment.Preproc */
.listingblock .pygments .tok-c1 { color: #408080; font-style: italic } /* Comment.Single */
.listingblock .pygments .tok-cs { color: #408080; font-style: italic } /* Comment.Special */
.listingblock .pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
.listingblock .pygments .tok-ge { font-style: italic } /* Generic.Emph */
.listingblock .pygments .tok-gr { color: #FF0000 } /* Generic.Error */
.listingblock .pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
.listingblock .pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
.listingblock .pygments .tok-go { color: #888888 } /* Generic.Output */
.listingblock .pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.listingblock .pygments .tok-gs { font-weight: bold } /* Generic.Strong */
.listingblock .pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.listingblock .pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
.listingblock .pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.listingblock .pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.listingblock .pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.listingblock .pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
.listingblock .pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.listingblock .pygments .tok-kt { color: #B00040 } /* Keyword.Type */
.listingblock .pygments .tok-m { color: #666666 } /* Literal.Number */
.listingblock .pygments .tok-s { color: #BA2121 } /* Literal.String */
.listingblock .pygments .tok-na { color: #7D9029 } /* Name.Attribute */
.listingblock .pygments .tok-nb { color: #008000 } /* Name.Builtin */
.listingblock .pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
.listingblock .pygments .tok-no { color: #880000 } /* Name.Constant */
.listingblock .pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
.listingblock .pygments .tok-ni { color: #999999; font-weight: bold } /* Name.Entity */
.listingblock .pygments .tok-ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.listingblock .pygments .tok-nf { color: #0000FF } /* Name.Function */
.listingblock .pygments .tok-nl { color: #A0A000 } /* Name.Label */
.listingblock .pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.listingblock .pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
.listingblock .pygments .tok-nv { color: #19177C } /* Name.Variable */
.listingblock .pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.listingblock .pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
.listingblock .pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
.listingblock .pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
.listingblock .pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
.listingblock .pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
.listingblock .pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
.listingblock .pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
.listingblock .pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
.listingblock .pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.listingblock .pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
.listingblock .pygments .tok-se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.listingblock .pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
.listingblock .pygments .tok-si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.listingblock .pygments .tok-sx { color: #008000 } /* Literal.String.Other */
.listingblock .pygments .tok-sr { color: #BB6688 } /* Literal.String.Regex */
.listingblock .pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
.listingblock .pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
.listingblock .pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
.listingblock .pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
.listingblock .pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
.listingblock .pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
.listingblock .pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Componentes enterprise</h1>
<div class="details">
<span id="author" class="author">Domingo Gallardo</span><br>
<span id="email" class="email"><a href="mailto:domingo.gallardo@ua.es">domingo.gallardo@ua.es</a></span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Índice de contenidos</div>
<ul class="sectlevel1">
<li><a href="#sesion01">1. Introducción a los Componentes Enterprise JavaBeans</a>
<ul class="sectlevel2">
<li><a href="#_acceso_a_la_capa_de_negocio_gestionado_por_el_servidor_de_aplicaciones">1.1. Acceso a la capa de negocio gestionado por el servidor de aplicaciones</a>
<ul class="sectlevel3">
<li><a href="#_seguridad_en_el_acceso_a_la_capa_de_negocio">1.1.1. Seguridad en el acceso a la capa de negocio</a></li>
<li><a href="#_transacciones_gestionadas_por_el_contenedor">1.1.2. Transacciones gestionadas por el contenedor</a></li>
<li><a href="#_acceso_remoto_a_la_capa_de_negocio">1.1.3. Acceso remoto a la capa de negocio</a></li>
</ul>
</li>
<li><a href="#_un_ejemplo_sencillo">1.2. Un ejemplo sencillo</a>
<ul class="sectlevel3">
<li><a href="#_a%C3%B1adimos_restricci%C3%B3n_de_seguridad_en_el_acceso_al_m%C3%A9todo">1.2.1. Añadimos restricción de seguridad en el acceso al método</a></li>
</ul>
</li>
<li><a href="#_arquitectura_enterprise_javabeans">1.3. Arquitectura Enterprise JavaBeans</a>
<ul class="sectlevel3">
<li><a href="#_el_enterprise_bean_vive_en_un_contenedor">1.3.1. El enterprise bean vive en un contenedor</a></li>
<li><a href="#_servicios_proporcionados_por_el_contenedor_ejb">1.3.2. Servicios proporcionados por el contenedor EJB</a></li>
</ul>
</li>
<li><a href="#_tipos_de_enterprise_beans">1.4. Tipos de enterprise beans</a>
<ul class="sectlevel3">
<li><a href="#_beans_de_sesi%C3%B3n">1.4.1. Beans de sesión</a></li>
<li><a href="#_beans_dirigidos_por_mensajes">1.4.2. Beans dirigidos por mensajes</a></li>
</ul>
</li>
<li><a href="#_acceso_al_enterprise_bean">1.5. Acceso al enterprise bean</a>
<ul class="sectlevel3">
<li><a href="#_acceso_por_inyecci%C3%B3n_de_dependencias">1.5.1. Acceso por inyección de dependencias</a></li>
<li><a href="#_acceso_por_nombre_jndi">1.5.2. Acceso por nombre JNDI</a></li>
</ul>
</li>
<li><a href="#_pruebas_de_enterprise_beans_con_arquillian">1.6. Pruebas de enterprise beans con Arquillian</a></li>
<li><a href="#_ejercicios">1.7. Ejercicios</a>
<ul class="sectlevel3">
<li><a href="#__2_puntos_construir_el_m%C3%B3dulo_code_saludo_code">1.7.1. (2 puntos) Construir el módulo <code>saludo</code></a></li>
<li><a href="#__1_5_puntos_construir_el_m%C3%B3dulo_code_calculadora_code">1.7.2. (1,5 puntos) Construir el módulo <code>calculadora</code></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sesion02">2. Ciclo de vida de los enterprise beans y seguridad de acceso</a>
<ul class="sectlevel2">
<li><a href="#_ciclo_de_vida">2.1. Ciclo de vida</a>
<ul class="sectlevel3">
<li><a href="#_ciclo_de_vida_de_los_beans_de_sesi%C3%B3n_con_estado">2.1.1. Ciclo de vida de los beans de sesión con estado</a></li>
<li><a href="#_ciclo_de_vida_de_los_beans_de_sesi%C3%B3n_sin_estado">2.1.2. Ciclo de vida de los beans de sesión sin estado</a></li>
</ul>
</li>
<li><a href="#_acceso_concurrente_a_los_beans_singleton">2.2. Acceso concurrente a los beans singleton</a></li>
<li><a href="#_seguridad_en_la_arquitectura_ejb">2.3. Seguridad en la arquitectura EJB</a>
<ul class="sectlevel3">
<li><a href="#_introducci%C3%B3n_a_la_seguridad_en_ejb">2.3.1. Introducción a la seguridad en EJB</a></li>
<li><a href="#_realms_users_groups_y_roles">2.3.2. Realms, Users, Groups y Roles</a></li>
<li><a href="#_jaas_servicio_java_de_autentificaci%C3%B3n_y_autorizaci%C3%B3n">2.3.3. JAAS: Servicio Java de Autentificación y Autorización</a></li>
<li><a href="#_control_de_acceso_basado_en_roles">2.3.4. Control de acceso basado en roles</a></li>
<li><a href="#_la_identidad_de_seguridad_runas">2.3.5. La identidad de seguridad runAs</a></li>
<li><a href="#_gesti%C3%B3n_de_seguridad_programativa_en_el_enterprise_bean">2.3.6. Gestión de seguridad programativa en el enterprise bean</a></li>
</ul>
</li>
<li><a href="#_ejercicios_2">2.4. Ejercicios</a>
<ul class="sectlevel3">
<li><a href="#__0_75_puntos_ciclo_de_vidad_de_bean_con_estado">2.4.1. (0,75 puntos) Ciclo de vidad de bean con estado</a></li>
<li><a href="#__0_75_puntos_acceso_seguro_a_un_m%C3%A9todo">2.4.2. (0,75 puntos) Acceso seguro a un método</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sesion03">3. Enterprise beans y JPA</a>
<ul class="sectlevel2">
<li><a href="#_proyecto_b%C3%A1sico_jpa">3.1. Proyecto básico JPA</a></li>
<li><a href="#_gesti%C3%B3n_de_transacciones_con_beans_de_sesi%C3%B3n">3.2. Gestión de transacciones con beans de sesión</a>
<ul class="sectlevel3">
<li><a href="#_gesti%C3%B3n_de_transacciones_bmt">3.2.1. Gestión de transacciones BMT</a></li>
<li><a href="#_gesti%C3%B3n_de_transacciones_cmt">3.2.2. Gestión de transacciones CMT</a></li>
<li><a href="#_gesti%C3%B3n_de_la_transacci%C3%B3n_con_la_interfaz_usertransaction">3.2.3. Gestión de la transacción con la interfaz UserTransaction</a></li>
<li><a href="#_transacciones_a_trav%C3%A9s_de_m%C3%BAltiples_bases_de_datos">3.2.4. Transacciones a través de múltiples bases de datos</a></li>
</ul>
</li>
<li><a href="#_entity_manager_y_contexto_de_persistencia_en_los_beans">3.3. Entity manager y contexto de persistencia en los beans</a></li>
<li><a href="#_ejemplo_completo">3.4. Ejemplo completo</a></li>
<li><a href="#_ejercicios_3">3.5. Ejercicios</a>
<ul class="sectlevel3">
<li><a href="#__3_5_puntos_aplicaci%C3%B3n_web_filmoteca">3.5.1. (3,5 puntos) Aplicación web filmoteca</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sesion04">4. Beans asíncronos, temporizadores e interceptores</a>
<ul class="sectlevel2">
<li><a href="#_acceso_as%C3%ADncrono_a_los_beans">4.1. Acceso asíncrono a los beans</a></li>
<li><a href="#_temporizadores">4.2. Temporizadores</a>
<ul class="sectlevel3">
<li><a href="#_el_m%C3%A9todo_timeout">4.2.1. El método Timeout</a></li>
<li><a href="#_creando_temporizadores">4.2.2. Creando temporizadores</a></li>
<li><a href="#_cancelando_y_grabando_temporizadores">4.2.3. Cancelando y grabando temporizadores</a></li>
<li><a href="#_obteniendo_informaci%C3%B3n_del_temporizador">4.2.4. Obteniendo información del temporizador</a></li>
<li><a href="#_temporizadores_y_transacciones">4.2.5. Temporizadores y transacciones</a></li>
<li><a href="#_ventajas_y_limitaciones">4.2.6. Ventajas y limitaciones</a></li>
</ul>
</li>
<li><a href="#_interceptores">4.3. Interceptores</a>
<ul class="sectlevel3">
<li><a href="#_la_clase_interceptor">4.3.1. La clase Interceptor</a></li>
<li><a href="#_aplicando_interceptores_con_anotaciones">4.3.2. Aplicando interceptores con anotaciones</a></li>
<li><a href="#_aplicando_interceptores_con_xml">4.3.3. Aplicando interceptores con XML</a></li>
</ul>
</li>
<li><a href="#_ejercicios_4">4.4. Ejercicios</a>
<ul class="sectlevel3">
<li><a href="#__0_75_puntos_bean_temporizador">4.4.1. (0,75 puntos) Bean temporizador</a></li>
<li><a href="#__0_75_puntos_bean_interceptor">4.4.2. (0,75 puntos) Bean interceptor</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="sesion01">1. Introducción a los Componentes Enterprise JavaBeans</h2>
<div class="sectionbody">
<div class="paragraph">
<p>En este módulo vamos a presentar la tecnología Enterprise JavaBeans. Se trata de una tecnología que permite definir componentes (<em>enterprise beans</em>) que implementan lógica de negocio y que son gestionados por un servidor de aplicaciones Java EE. El servidor de aplicaciones, un entorno en tiempo de ejecución, proporciona un conjunto de servicios, como gestión de transacciones y seguridad, a los beans gestionados.</p>
</div>
<div class="paragraph">
<p>En el módulo de Componentes Web ya vimos un ejemplo de <em>componentes gestionados</em> por el servidor de aplicaciones en forma de <em>managed beans</em>. En ese caso, el servidor de aplicaciones se encargaba de la creación de instancias y de la <em>inyección</em> de estas instancias en las variables anotadas. Pero el trabajo del servidor de aplicaciones se limitaba al momento de la creación, una vez creada la instancia e inyectada en la variable que la referencia termina su trabajo. E</p>
</div>
<div class="paragraph">
<p>n el caso de los componentes enterprise el servidor de aplicaciones va a tener un trabajo mucho más intenso, ya que los servicios que proporciona duran todo el ciclo de vida del objeto: creación, invocación de sus métodos y borrado. En concreto, los servicios que proporciona son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Acceso remoto de múltiples clientes</p>
</li>
<li>
<p>Seguridad</p>
</li>
<li>
<p>Transaccionalidad distribuida</p>
</li>
<li>
<p>Acceso a recursos</p>
</li>
<li>
<p>Concurrencia</p>
</li>
<li>
<p>Llamadas asíncronas</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Veremos que el servidor de aplicaciones proporcionará estas funcionalidades en cualquier invocación a métodos de componente enterprise. De forma que, por ejemplo, comprobará que el llamador del método tiene permisos de acceso al método o incorporará la llamada al método en una transacción previamente creada. El llamador al bean nunca tendrá acceso directo a su código, todas las invocaciones de sus métodos se harán a través de los servicios proporcionados por el servidor de aplicaciones.</p>
</div>
<div class="paragraph">
<p>La especificación actual de la tecnología Enterprise JavaBeans es la 3.1, incluida en la plataforma Java EE 6. La JSR de la especificación es la <a href="http://jcp.org/en/jsr/detail?id=318">JSR 318</a>, aprobada en diciembre de 2009.</p>
</div>
<div class="paragraph">
<p>Para más información recomendamos el libro <a href="http://www.manning.com/panda/"><em>EJB 3 in Action</em></a> de la editorial Manning.</p>
</div>
<div class="sect2">
<h3 id="_acceso_a_la_capa_de_negocio_gestionado_por_el_servidor_de_aplicaciones">1.1. Acceso a la capa de negocio gestionado por el servidor de aplicaciones</h3>
<div class="paragraph">
<p>Las aplicaciones y frameworks que hemos venido estudiando y utilizando hasta ahora se basan en el denominado modelo de N-capas que separa claramente la presentación, la lógica de negocio y el acceso a los datos. Este diseño facilita sobremanera el mantenimiento de la aplicación, ya que la separación en capas nos permite modificar una de las partes de la aplicación sin que el resto se vea afectado por el cambio (o, al menos, viéndose afectado de forma muy localizada).</p>
</div>
<div class="paragraph">
<p>Definimos los siguientes elementos en esta arquitectura:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>API REST que recibe peticiones GET, POST, PUT y DELETE sobre recursos y que devuelve objetos JSON. La capa de API REST se encarga de transformar objetos JSON en objetos Java con los que se comunica con las funciones proporcionadas por la capa de servicio que implementa la lógica de negocio</p>
</li>
<li>
<p>Capa de servicios que recibe objetos Java y realiza peticiones transaccionales a la capa de datos, definida por DAOs implementados con JPA</p>
</li>
<li>
<p>Capa de datos que trabaja con JPA y con entidades gestionadas por el <em>entity manager</em> y que implementan actualizaciones y consultas realizadas sobre la base de datos</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Toda la aplicación, exceptuando el servidor de base de datos, está implementada por clases Java que se ejecutan en el servidor de aplicaciones, ejecutado a su vez por una única JVM (Máquina Virtual Java). Además de la gestión de los servlets y el API REST, el servidor de aplicaciones da soporte a una serie de servicios adicionales como la gestión de la seguridad en el acceso a los servlets, definición de recursos JNDI o el pooling de conexiones JDBC.</p>
</div>
<div class="paragraph">
<p>Esta arquitectura puede responder perfectamente a un gran número de peticiones simultáneas de clientes (navegadores que consultan nuestro sistema). El servidor utiliza las características de multiproceso de la JVM para poder responder a todas las peticiones HTTP colocando cada servlet en un hilo de ejecución.</p>
</div>
<div class="paragraph">
<p>La arquitectura EJB permite añadir un elemento más a esta arquitectura: la intermediación automática de los servicios del servidor de aplicaciones en cualquier llamada a los métodos de negocio definidos en los beans. Veamos algunos de los posibles servicios.</p>
</div>
<div class="sect3">
<h4 id="_seguridad_en_el_acceso_a_la_capa_de_negocio">1.1.1. Seguridad en el acceso a la capa de negocio</h4>
<div class="paragraph">
<p>Si diseñamos aplicaciones con requisitos de seguridad estrictos (como banca, telefonía, etc.) es necesario ser muy cuidadoso en el acceso a las operaciones de negocio. Una operación que, por ejemplo, realice una transferencia bancaria de una cuenta a otra sólo podría ser autorizada si quien la solicita tiene un rol determinado. El servidor de aplicaciones puede obligar a que los accesos a los métodos de negocio sólo se puedan realizar si el llamador tiene los permisos adecuados.</p>
</div>
<div class="paragraph">
<p>Con la tecnología vista hasta ahora no es posible garantizar esto. El acceso de seguridad lo hemos visto a nivel de aplicación web (servlet), pero podría pasar que nos equivocáramos en el código del servlet o al añadir nuevas funcionalidades y termináramos permitiendo acceder desde capas externas de la aplicación sin los permisos adecuados a métodos de negocio restringidos. Es muy conveniente establecer una barrera de seguridad en el nivel de los métodos de negocio de la capa de servicios.</p>
</div>
<div class="paragraph">
<p>La definición de restricciones de seguridad en la capa de negocio permite también automatizar su comprobación en tests.</p>
</div>
<div class="paragraph">
<p>La arquitectura EJB permite dar una solución a esta necesidad, definiendo restricciones de acceso en los enterprise beans. Un método de un enterprise bean sólo puede ser llamado si se tiene un rol determinado. Y además, esta configuración de seguridad se define de forma declarativa, simplificándose mucho su mantenimiento.</p>
</div>
</div>
<div class="sect3">
<h4 id="_transacciones_gestionadas_por_el_contenedor">1.1.2. Transacciones gestionadas por el contenedor</h4>
<div class="paragraph">
<p>Otro elemento interesante que nos proporciona la capa de EJB y que no tenemos hasta ahora es la posibilidad de anidar varias operaciones de negocio en una única transacción. En la definición de los métodos de negocio que hemos hecho hasta ahora cada método define una única transacción atómica siguiendo el siguiente patrón:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Creamos un <em>entity manager</em></p>
</li>
<li>
<p>Abrimos una transacción</p>
</li>
<li>
<p>Realizamos operaciones sobre la base de datos a través de los DAO</p>
</li>
<li>
<p>Cerramos la transacción</p>
</li>
<li>
<p>Cerramos el <em>entity manager</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Si queremos agrupar dos o más operaciones no hay otra forma de hacerlo que creando un nuevo método de negocio que realice todas las modificaciones sobre la base de datos.</p>
</div>
<div class="paragraph">
<p>La arquitectura EJB combinada con JPA en el servidor nos va a permitir utilizar transacciones JTA y propagación del contexto de persistencia para poder englobar más de un método de negocio en la misma transacción. Esto nos permitirá crear métodos de negocio mucho más versátiles y combinables entre si.</p>
</div>
<div class="paragraph">
<p>Además, la arquitectura EJB va a permitir la realización de transacciones distribuidas que incorporen a más de una base de datos. Por ejemplo, pensemos en una agencia de viajes que debe añadir una reserva de un hotel, una reserva de un vuelo y una entrada de un espectáculo. Supongamos que estos datos se encuentran distribuidos y son gestionados por tres bases de datos diferentes. Cada base de datos tiene su sistema de gestión de transacciones. Necesitamos entonces coordinar los sistemas de transacción de las tres bases de datos para englobarlos en una transacción global que los incluya. De esta forma, podremos realizar una operación de reserva conjunta de hotel, vuelo y espectáculo. Esta operación deberá definir una transacción global que
fallará si alguna de las bases de datos falla y que hará que todas las bases de datos vuelvan a su estado anterior si esto sucede.</p>
</div>
<div class="paragraph">
<p>Al hacer que los enterprise beans sean recursos transaccionales se abstrae el uso de los recursos de datos y son los propios métodos de negocio los que se convierten en transaccionales. De esta forma, cada método de negocio de un enterprise bean proporciona un servicio transaccional que puede participar en una transacción de mayor alcance. En el ejemplo anterior de la agencia de viajes, los servicios de añadir una reserva o comprar una entrada pueden ser implementados de forma transaccional como métodos de enterprise beans (cada uno situado además en su servidor de aplicaciones correspondiente y con sus restricciones de acceso). Como ya hemos dicho previamente, esto facilita el desarrollo y (sobre todo) las pruebas del sistema.</p>
</div>
</div>
<div class="sect3">
<h4 id="_acceso_remoto_a_la_capa_de_negocio">1.1.3. Acceso remoto a la capa de negocio</h4>
<div class="paragraph">
<p>La última funcionalidad avanzada que nos va a permitir la arquitectura EJB es la posibilidad de exportar los métodos de negocio a clientes remotos, situados en otras aplicaciones desplegadas en el servidor o incluso en otros servidores.</p>
</div>
<div class="paragraph">
<p>En una organización se suele tener un gran número de aplicaciones que proporcionan servicios y que necesitan comunicarse unas con otras. Esta arquitectura se denomina SOA (Service Oriented Arquitecture). Una de las características de SOA es que las aplicaciones de la empresa se ejecutan de forma distribuida en distintos servidores (atendiendo a necesidades de
acceso a ciertos recursos o de políticas de seguridad). Estas aplicaciones necesitan comunicarse entre si, accediendo de forma remota a los servicios definidos por cada una de ellas.</p>
</div>
<div class="paragraph">
<p>Ya veremos que una forma de proporcionar estos servicios remotos es definiendo servicios REST. Pero la arquitectura EJB permite también la posibilidad de convertir en remotas las interfaces de las operaciones de negocio, de forma que desde cualquier servidor de la empresa se puede acceder a los métodos declarados en un componente EJB, utilizando una llamada similar a la de una llamada a un procedimiento remoto, pero de forma totalmente transparente.</p>
</div>
<div class="paragraph">
<p>La utilización de los componentes EJB como componentes remotos está bastante extendida, pero no lo estudiaremos en profundidad en el curso. Sirven para definir la versión más tradicional de la arquitectura SOA, utilizando elementos como los servicios web SOAP y JAX-WS, los componentes EJB de mensajes o los buses de conexiones. Frente a esta versión tradicional de las arquitecturas distribuidas, el enfoque que presentamos en el curso se base en la utilización de servicios REST ligeros que se comunican utilizando formatos de datos abiertos y flexibles como JSON.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_un_ejemplo_sencillo">1.2. Un ejemplo sencillo</h3>
<div class="paragraph">
<p>Vamos a empezar con un sencillo ejemplo en el que comprobaremos cómo definir un componente EJB y cómo usarlo desde otro componente gestionado, un servlet.</p>
</div>
<div class="paragraph">
<p>El código que define el enterprise bean es muy sencillo: una clase java anotada con <code>@Stateless</code>. Con esa anotación estamos definiendo un bean de sesión sin estado. Comentaremos más adelante las distintas características de cada uno de los tipos de enterprise bean.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">import</span> <span class="tok-nn">javax.ejb.Stateless</span><span class="tok-o">;</span>

<span class="tok-nd">@Stateless</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">SaludoServicio</span> <span class="tok-o">{</span>

    <span class="tok-kd">private</span> <span class="tok-n">String</span><span class="tok-o">[]</span> <span class="tok-n">misSaludos</span> <span class="tok-o">=</span> <span class="tok-o">{</span><span class="tok-s">&quot;Hola, que tal?&quot;</span><span class="tok-o">,</span>
            <span class="tok-s">&quot;Cuanto tiempo sin verte&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Que te cuentas?&quot;</span><span class="tok-o">,</span>
            <span class="tok-s">&quot;Me alegro de volver a verte&quot;</span><span class="tok-o">};</span>

    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">saludo</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-kt">int</span> <span class="tok-n">random</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-kt">int</span><span class="tok-o">)</span> <span class="tok-o">(</span><span class="tok-n">Math</span><span class="tok-o">.</span><span class="tok-na">random</span><span class="tok-o">()</span> <span class="tok-o">*</span> <span class="tok-n">misSaludos</span><span class="tok-o">.</span><span class="tok-na">length</span><span class="tok-o">);</span>
        <span class="tok-n">String</span> <span class="tok-n">saludo</span> <span class="tok-o">=</span> <span class="tok-n">nombre</span> <span class="tok-o">+</span> <span class="tok-s">&quot;, &quot;</span> <span class="tok-o">+</span> <span class="tok-n">misSaludos</span><span class="tok-o">[</span><span class="tok-n">random</span><span class="tok-o">];</span>
        <span class="tok-k">return</span> <span class="tok-n">saludo</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En el bean definimos el método <code>saludo</code> que recibe un <code>nombre</code> y devuelve un saludo aleatorio precedido por ese nombre.</p>
</div>
<div class="paragraph">
<p>Un ejemplo de la llamada al bean es el siguiente código, un servlet en el que se obtiene una referencia al bean y se invoca a su método <code>saludo()</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@WebServlet</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;holamundo&quot;</span><span class="tok-o">,</span> <span class="tok-n">urlPatterns</span><span class="tok-o">=</span><span class="tok-s">&quot;/holamundo&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">HolaMundoServlet</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span> <span class="tok-o">{</span>

    <span class="tok-nd">@EJB</span>
    <span class="tok-n">SaludoServicio</span> <span class="tok-n">saludoServicio</span><span class="tok-o">;</span> <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
    	      	   	 <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span> <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
        <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setContentType</span><span class="tok-o">(</span><span class="tok-s">&quot;text/html&quot;</span><span class="tok-o">);</span>

        <span class="tok-kt">int</span> <span class="tok-n">errorStatus</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-o">;</span>
        <span class="tok-n">String</span> <span class="tok-n">errorMsg</span> <span class="tok-o">=</span> <span class="tok-s">&quot;&quot;</span><span class="tok-o">;</span>
        <span class="tok-n">String</span> <span class="tok-n">nombre</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;nombre&quot;</span><span class="tok-o">);</span>

        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">nombre</span> <span class="tok-o">==</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">errorStatus</span> <span class="tok-o">=</span> <span class="tok-n">HttpServletResponse</span><span class="tok-o">.</span><span class="tok-na">SC_BAD_REQUEST</span><span class="tok-o">;</span>
            <span class="tok-n">errorMsg</span> <span class="tok-o">=</span> <span class="tok-s">&quot;Faltan parámetros en la petición&quot;</span><span class="tok-o">;</span>
            <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setStatus</span><span class="tok-o">(</span><span class="tok-n">errorStatus</span><span class="tok-o">);</span>
            <span class="tok-n">PrintWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">errorMsg</span><span class="tok-o">);</span>
        <span class="tok-o">}</span> <span class="tok-k">else</span> <span class="tok-o">{</span>
            <span class="tok-n">PrintWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;!DOCTYPE HTML PUBLIC \&quot;&quot;</span> <span class="tok-o">+</span>
                    <span class="tok-s">&quot;-//W3C//DTD HTML 4.0 &quot;</span> <span class="tok-o">+</span>
                    <span class="tok-s">&quot;Transitional//EN\&quot;&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;HTML&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;BODY&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;h1&gt;Stateless&lt;/h1&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;ul&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;li&gt;&quot;</span> <span class="tok-o">+</span> <span class="tok-n">saludoServicio</span><span class="tok-o">.</span><span class="tok-na">saludo</span><span class="tok-o">(</span><span class="tok-n">nombre</span><span class="tok-o">)</span> <span class="tok-o">+</span> <span class="tok-s">&quot;&lt;/li&gt;&quot;</span><span class="tok-o">);</span> <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/ul&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/BODY&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/HTML&quot;</span><span class="tok-o">);</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Obtención del bean por inyección de dependencias. El servidor de aplicaciones inyecta en la variable <code>saludoServicio</code> una referencia al bean</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Invocación al método <code>saludo</code> del bean</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Por completitud, la página JSP desde la que se invoca al servlet es la siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-cp">&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.0 Transitional//EN&quot;&gt;</span>
<span class="tok-nt">&lt;html&gt;</span>
    <span class="tok-nt">&lt;head&gt;</span>
        <span class="tok-nt">&lt;title&gt;</span>Start Page<span class="tok-nt">&lt;/title&gt;</span>
        <span class="tok-nt">&lt;meta</span> <span class="tok-na">http-equiv=</span><span class="tok-s">&quot;Content-Type&quot;</span> <span class="tok-na">content=</span><span class="tok-s">&quot;text/html; charset=UTF-8&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;/head&gt;</span>
    <span class="tok-nt">&lt;body&gt;</span>
        <span class="tok-nt">&lt;h1&gt;</span>Hello World!<span class="tok-nt">&lt;/h1&gt;</span>
        <span class="tok-nt">&lt;form</span> <span class="tok-na">action=</span><span class="tok-s">&quot;&lt;%=request.getContextPath()%&gt;/holamundo&quot;</span><span class="tok-nt">&gt;</span>
        <span class="tok-nt">&lt;p&gt;</span>Introduce tu nombre (sin estado): <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;nombre&quot;</span><span class="tok-nt">&gt;&lt;/p&gt;</span>
        <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;submit&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;Enviar&quot;</span><span class="tok-nt">&gt;</span>
        <span class="tok-nt">&lt;/form&gt;</span>
    <span class="tok-nt">&lt;/body&gt;</span>
<span class="tok-nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Al ejecutar el servlet veremos que la llamada al método <code>saludo()</code> del bean devuelve una cadena con uno de los saludos. De esta forma podemos comprobar que la inyección ha funcionado bien.</p>
</div>
<div class="paragraph">
<p>Pero hasta aquí el funcionamiento es muy parecido al de un <em>managed bean</em> La diferencia es que en este caso el trabajo del servidor de aplicaciones no termina con la inyección, como pasa en el <em>managed bean</em>. En este caso, al ser <em>saludoServicio</em> un <em>enterprise bean</em> el servidor de aplicaciones debe gestionar <strong>todas las llamadas a sus métodos</strong>, en nuestro caso la invocación al método <code>saludo()</code>.</p>
</div>
<div class="sect3">
<h4 id="_añadimos_restricción_de_seguridad_en_el_acceso_al_método">1.2.1. Añadimos restricción de seguridad en el acceso al método</h4>
<div class="paragraph">
<p>¿Cómo podríamos comprobar que la invocación al método <code>saludo()</code> está gestionada por el servidor de aplicaciones? Podríamos hacerlo de una forma muy sencilla. Hemos dicho que una de las características del servidor de aplicaciones es que permite definir restricciones de seguridad. Vamos a comprobar que añadiendo una sencilla anotación en el método podemos conseguir provocar un error cuando se intenta acceder a él sin tener los permisos necesarios.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">    <span class="tok-nd">@RolesAllowed</span><span class="tok-o">({</span><span class="tok-s">&quot;usuario-saludo&quot;</span><span class="tok-o">})</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">saludo</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-kt">int</span> <span class="tok-n">random</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-kt">int</span><span class="tok-o">)</span> <span class="tok-o">(</span><span class="tok-n">Math</span><span class="tok-o">.</span><span class="tok-na">random</span><span class="tok-o">()</span> <span class="tok-o">*</span> <span class="tok-n">misSaludos</span><span class="tok-o">.</span><span class="tok-na">length</span><span class="tok-o">);</span>
        <span class="tok-n">String</span> <span class="tok-n">saludo</span> <span class="tok-o">=</span> <span class="tok-n">misSaludos</span><span class="tok-o">[</span><span class="tok-n">random</span><span class="tok-o">];</span>
        <span class="tok-k">return</span> <span class="tok-n">nombre</span> <span class="tok-o">+</span> <span class="tok-s">&quot;, &quot;</span> <span class="tok-o">+</span> <span class="tok-n">saludo</span><span class="tok-o">;</span>
    <span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>La anotación <code>@RolesAllowed</code> restringe el acceso al método</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si ejecutamos el ejemplo, comprobaremos que la llamada al método desde el servlet provoca una excepción de tipo <code>javax.ejb.EJBAccessException</code>. Realmente a quien estamos invocando cuando ejecutamos el método <code>saludo()</code> es al servidor de aplicaciones, que se encarga de comprobar las restricciones de seguridad y de invocar al bean sólo si se cumplen.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_arquitectura_enterprise_javabeans">1.3. Arquitectura Enterprise JavaBeans</h3>
<div class="paragraph">
<p>La arquitectura Enterprise JavaBeans hace posible la creación de clases gestionadas (denominados <em>componentes EJB o enterprise beans</em>) que viven en un contenedor (servidor de aplicaciones) y que proporcionan servicios (métodos) que pueden ser invocados de forma segura, transaccional, remota y concurrente. El contenedor es el encargado de proporcionar los servicios comentados en el apartado anterior (acceso remoto, seguridad y transaccionalidad) así como de gestionar su ciclo de vida.</p>
</div>
<div class="sect3">
<h4 id="_el_enterprise_bean_vive_en_un_contenedor">1.3.1. El enterprise bean vive en un contenedor</h4>
<div class="paragraph">
<p>Al desplegar el <em>enterprise bean</em> en el servidor de aplicaciones se construye automáticamente un conjunto de clases que se encargarán de realizar la intercepción de las llamadas de los clientes y que son las que realmente inyecta el servidor de aplicaciones en las variables del cliente. El cliente nunca invocará directamente al código del enterprise bean, sino que todas las llamadas serán siempre a través del servidor de aplicaciones.</p>
</div>
<div class="paragraph">
<p>Cuando programamos un enterprise bean estamos proporcionando su interfaz y su implementación (cuáles son sus métodos de negocio y cómo se implementan), pero dejamos al servidor de aplicaciones la tarea engorrosa de generar las clases de soporte que proporcionan acceso remoto, seguro, concurrente y transaccional.</p>
</div>
<div class="paragraph">
<p>La intermediación del servidor de aplicaciones en las llamadas de los clientes al bean es un ejemplo más del uso de contenedores en Java EE. El uso de contenedores que gestionan objetos y les proporcionan servicios añadidos es una técnica recurrente en la arquitectura Java EE. Los servlets también son componentes que se despliegan y viven en el contenedor web. Este contenedor da soporte a su ciclo de vida y proporciona un entorno con servicios que éstos pueden invocar. Cuando se recibe una petición HTTP que debe ser respondida por un servlet determinado es el contenedor web el que se encarga de instanciar el servlet (o recuperarlo de un <em>pool</em>) en un thread nuevo y de invocarlo para que responda a la petición.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="imagenes/ejb/contenedores.png" alt="" width="50%">
</div>
</div>
<div class="paragraph">
<p>En la figura anterior vemos los contenedores proporcionados por la arquitectura Java EE. Además de los contenedores de servlets y de enterprise beans, podemos utilizar el contenedor de aplicaciones cliente y el contenedor de applets. Las aplicaciones cliente son aplicaciones de escritorio Java que se encuentran en el servidor de aplicaciones pero que se pueden descargar y ejecutar en máquinas clientes remotas, utilizando la tecnología Java Web Start. El contenedor de aplicaciones cliente proporciona una serie de servicios, como el acceso al servicio JNDI del servidor de aplicaciones, que pueden ser utilizados desde las máquinas cliente. Los applets, por último, como es bien conocido, son aplicaciones Java que se ejecutan en los clientes web.</p>
</div>
<div class="paragraph">
<p>Cuando se está trabajando con componentes se tiene que dedicar tanta atención al despliegue (deployment) del componente como a su desarrollo. Entendemos por despliegue la incorporación del componente a nuestro contenedor EJB y a nuestro entorno de trabajo (bases de datos, arquitectura de la aplicación, etc.). El despliegue se define de forma declarativa. En la versión 2.1 de la especificación EJB, el despliegue se definía mediante un fichero XML (descriptor del despliegue, deployment descriptor) en el que se definen todas las características del enterprise bean. Desde la versión 3.0 de la especificación es posible definir la configuración de los componentes EJB mediante anotaciones en las clases Java que los implementan.</p>
</div>
</div>
<div class="sect3">
<h4 id="_servicios_proporcionados_por_el_contenedor_ejb">1.3.2. Servicios proporcionados por el contenedor EJB</h4>
<div class="paragraph">
<p>En el apartado anterior hemos comentado que la diferencia fundamental entre los componentes y los objetos clásicos reside en que los componentes <em>viven</em> en un contenedor EJB que los envuelve proporcionando una capa de servicios añadidos. ¿Cuáles son estos servicios? Los más importantes son los siguientes:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Manejo de transacciones</dt>
<dd>
<p>Apertura y cierre de transacciones asociadas a las llamadas a los métodos del enterprise bean.</p>
</dd>
<dt class="hdlist1">Seguridad</dt>
<dd>
<p>Comprobación de permisos de acceso a los métodos del enterprise bean.</p>
</dd>
<dt class="hdlist1">Concurrencia</dt>
<dd>
<p>Llamada simultánea a un mismo bean desde múltiples clientes.</p>
</dd>
<dt class="hdlist1">Servicios de red</dt>
<dd>
<p>Comunicación entre el cliente y el bean en máquinas distintas.</p>
</dd>
<dt class="hdlist1">Gestión de recursos</dt>
<dd>
<p>Gestión automática de múltiples recursos, como colas de mensajes, bases de datos o fuentes de datos en aplicaciones heredadas que no han sido traducidas a nuevos lenguajes/entornos y siguen usándose en la empresa.</p>
</dd>
<dt class="hdlist1">Persistencia</dt>
<dd>
<p>Sincronización entre los datos del bean y tablas de una base de datos.</p>
</dd>
<dt class="hdlist1">Gestión de mensajes</dt>
<dd>
<p>Manejo de Java Message Service (JMS).</p>
</dd>
<dt class="hdlist1">Escalabilidad</dt>
<dd>
<p>Posibilidad de constituir clusters de servidores de aplicaciones con múltiples hosts para poder dar respuesta a aumentos repentinos de carga de la aplicación con sólo añadir hosts adicionales.</p>
</dd>
<dt class="hdlist1">Adaptación en tiempo de despliegue</dt>
<dd>
<p>posibilidad de modificación de todas estas características en el momento del despliegue del enterprise bean.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Pensemos en lo complicado que sería programar una clase "a mano" que implementara todas estas características. Como se suele decir, la programación de EJB es sencilla si la comparamos con lo que habría que implementar de hacerlo todo por uno mismo.  Evidentemente, si la aplicación que se está desarrollando no necesita estos servicios, se podría utilizar simplemente páginas JSP y JDBC.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tipos_de_enterprise_beans">1.4. Tipos de enterprise beans</h3>
<div class="paragraph">
<p>A partir de la especificación EJB 3.0 se definen principalmente dos tipos de enterprise beans:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Beans de sesión (con estado, sin estado y singleton)</p>
</li>
<li>
<p>Beans dirigidos por mensajes dirigidos por mensajes (<em>message-driven beans</em>, MDBs)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Un <strong>bean de sesión</strong> representa un componente que encapsula un conjunto de métodos o acciones de negocio que pueden ser llamados de forma síncrona. Ejemplos de bean de sesión podrían ser un sistema de peticiones de reserva de libros de una biblioteca o un carrito de la compra. En general, cualquier componente que ofrezca un conjunto de servicios (métodos) a los que se necesite acceder de forma distribuida, segura y transaccional.</p>
</div>
<div class="paragraph">
<p>Los <strong>beans dirigidos por mensajes</strong> se diferencian de los anteriores en que la comunicación con ellos no es por medio de invocaciones, sino por el envío de mensajes que se encolan y se procesan de forma asíncrona. Un ejemplo podría ser un MDB <code>ListenerNuevoCliente</code> que se activara cada vez que se envía un mensaje comunicando que se ha dado de alta a un nuevo cliente.</p>
</div>
<div class="paragraph">
<p>En el curso vamos a ver en profundidad únicamente el primer tipo de beans.</p>
</div>
<div class="sect3">
<h4 id="_beans_de_sesión">1.4.1. Beans de sesión</h4>
<div class="paragraph">
<p>Los beans de sesión ofrecen métodos de negocio que pueden ser utilizados de forma transaccional, remota y segura.</p>
</div>
<div class="paragraph">
<p>Existen tres tipos de beans de sesión: con estado, sin estado y singleton.</p>
</div>
<div class="paragraph">
<p>Los beans de sesión sin estado responden a peticiones de los clientes y no guardan ningún estado entre una petición y la siguiente. Los clientes del bean realizan una petición a uno de sus métodos. El bean responde a cada petición de forma síncrona (la petición no devuelve el control hasta que el bean no termina de procesarla), el cliente obtiene la respuesta y sigue realizando su procesamiento. Cada petición es independiente. No se establece ningún tipo de sesión entre el cliente y el bean que haga necesario guardar un estado.</p>
</div>
<div class="paragraph">
<p>Los beans de sesión con estado contienen variables de instancia, campos, en los que se guarda su estado. Los clientes remotos establecen una sesión con ellos y pueden ir modificando sus datos. El estado se mantiene entre una petición y otra.</p>
</div>
<div class="paragraph">
<p>Los beans de sesión singleton se instancian una vez por aplicación y existen durante el ciclo de vida de la aplicación. Los beans de sesión singleton están pensados para circunstancias en las  que un hay que compartir una única instancia de enterprise bean  entre todos los clientes concurrentes.</p>
</div>
<div class="sect4">
<h5 id="_beans_de_sesión_sin_estado">Beans de sesión sin estado</h5>
<div class="paragraph">
<p>Los beans de sesión sin estado no se modifican con las llamadas de los clientes. Los métodos que ponen a disposición de las aplicaciones clientes son llamadas que reciben datos y devuelven resultados, pero que no modifican internamente el estado del bean.  Esta propiedad permite que el contenedor EJB pueda crear una reserva (<em>pool</em>) de instancias, todas ellas del mismo bean de sesión sin estado y asignar cualquier instancia a cualquier llamada de un cliente.  Incluso un único bean puede estar asignado a múltiples clientes, ya que la asignación sólo dura el tiempo de invocación del método solicitado por el cliente. Y al revés, si hacemos distintas llamadas desde un cliente cada vez puede ser que nos responda una instancia distinta del bean.</p>
</div>
<div class="paragraph">
<p>Cuando un cliente invoca un método de un bean de sesión sin estado, el contenedor EJB obtiene una instancia de la reserva.  Cualquier instancia servirá, ya que el bean no guarda ninguna información referida al cliente. Tan pronto como el método termina su ejecución, la instancia del bean está disponible para otros clientes. Esta propiedad hace que los beans de sesión sin estado sean muy escalables para un gran número de clientes. El contenedor EJB no tiene que mover sesiones de la memoria a un almacenamiento secundario para liberar recursos, simplemente puede obtener recursos y memoria destruyendo las instancias.</p>
</div>
<div class="paragraph">
<p>Podemos comprobar que esto es así realizando una pequeña modificación a nuestro bean de ejemplo. Podemos devolver junto con el saludo una referencia de la instancia real que ejecuta el método:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-o">...</span>
<span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">saludo</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-kt">int</span> <span class="tok-n">random</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-kt">int</span><span class="tok-o">)</span> <span class="tok-o">(</span><span class="tok-n">Math</span><span class="tok-o">.</span><span class="tok-na">random</span><span class="tok-o">()</span> <span class="tok-o">*</span> <span class="tok-n">misSaludos</span><span class="tok-o">.</span><span class="tok-na">length</span><span class="tok-o">);</span>
    <span class="tok-n">String</span> <span class="tok-n">saludo</span> <span class="tok-o">=</span> <span class="tok-n">nombre</span> <span class="tok-o">+</span> <span class="tok-s">&quot;, &quot;</span> <span class="tok-o">+</span> <span class="tok-n">misSaludos</span><span class="tok-o">[</span><span class="tok-n">random</span><span class="tok-o">]</span> <span class="tok-o">+</span> <span class="tok-s">&quot; [&quot;</span> <span class="tok-o">+</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">toString</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-s">&quot;]&quot;</span><span class="tok-o">;</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-k">return</span> <span class="tok-n">saludo</span><span class="tok-o">;</span>
<span class="tok-o">}</span>
<span class="tok-o">...</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Añadimos en el saludo la llamada a <code>this.toString()</code> que devuelve el identificador de la instancia del bean</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Y modificamos el servlet para que realice dos llamadas al método:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html">...
out.println(&quot;<span class="tok-nt">&lt;h1&gt;</span>Stateless<span class="tok-nt">&lt;/h1&gt;</span>&quot;);
out.println(&quot;<span class="tok-nt">&lt;ul&gt;</span>&quot;);
out.println(&quot;<span class="tok-nt">&lt;li&gt;</span>&quot; + saludoServicio.saludo(nombre) + &quot;<span class="tok-nt">&lt;/li&gt;</span>&quot;);
out.println(&quot;<span class="tok-nt">&lt;li&gt;</span>&quot; + saludoServicio.saludo(nombre) + &quot;<span class="tok-nt">&lt;/li&gt;</span>&quot;);
out.println(&quot;<span class="tok-nt">&lt;/ul&gt;</span>&quot;);
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos comprobar en la página devuelta por el servlet que están respondiendo instancias distintas:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="imagenes/ejb/ejecucion-stateless.png" alt="" width="66%">
</div>
</div>
<div class="paragraph">
<p>Los beans de sesión sin estado se usan en general para encapsular procesos de negocio. Estos beans suelen recibir nombres como <code>ServicioBroker</code> o <code>GestorContratos</code> para dejar claro que proporcionan un conjunto de procesos relacionados con un dominio específico del negocio. A veces se les suele denominar <em>Business Objects</em>, y también usar el sufijo BO para su nombre: <code>GestorContratosBO</code>.</p>
</div>
<div class="paragraph">
<p>También puede usarse un bean de sesión sin estado como un puente de acceso a una base de datos o a un conjunto de entidades JPA. En una arquitectura cliente-servidor, el bean de sesión podría proporcionar al interfaz de usuario del cliente los datos necesarios, así como modificar objetos de negocio (base de datos o entidades JPA) a petición de la interfaz. Este uso de los beans de sesión sin estado es muy frecuente y constituye el denominado patrón de diseño <em>session facade</em>.</p>
</div>
<div class="paragraph">
<p>Algunos ejemplos de bean de sesión sin estado podrían ser:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Un componente que comprueba si un símbolo de compañía está disponible en el mercado de valores y devuelve la última cotización registrada.</p>
</li>
<li>
<p>Un componente que calcula la cuota del seguro de un cliente, basándose en los datos que se le pasa del cliente.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_beans_de_sesión_con_estado">Beans de sesión con estado</h5>
<div class="paragraph">
<p>En un bean de sesión con estado, el bean almacenan datos específicos obtenidos durante la conexión con el cliente en sus campos (variables de instancia). Cada bean de sesión con estado, por tanto, almacena el estado conversacional de un cliente que interactúa con el bean. Este estado conversacional se modifica conforme el cliente va realizando llamadas a los métodos de negocio del bean. El estado conversacional no se guarda cuando el cliente termina la sesión.</p>
</div>
<div class="paragraph">
<p>El hecho de que se establezca un estado entre el bean y el cliente obliga a que, una vez establecida la conexión, siempre sea el mismo bean el que atienda al cliente. El servidor de aplicaciones ya no puede hacer lo de utilizar una instancia distinta en cada llamada. Esto hace que los beans con estado sean menos escalables que los beans sin estado, ya que es necesario mantener un bean activo para cada conexión establecida.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="imagenes/ejb/bean-con-estado.png" alt="" width="50%">
</div>
</div>
<div class="paragraph">
<p>Al igual que en los beans sin estado, la interacción del cliente con el bean se realiza mediante llamadas a sus métodos de negocio.</p>
</div>
<div class="paragraph">
<p>Los beans con estado son apropiados para aquellos casos en los que necesitamos guardar en memoria un estado que vamos a ir modificando llamada a llamada. Su uso evita tener que almacenar los estados intermedios en una base de datos.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Un ejemplo típico es un carrito de la compra, en donde el cliente va guardando uno a uno los ítem que va comprando.</p>
</li>
<li>
<p>Un enterprise bean en una biblioteca que tiene métodos para ir reservando libros y realizar un préstamo conjunto de todos los libros reservados.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Para definir un bean con estado basta con utilizar la anotación <code>Stateful</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Stateful</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">SaludoConEstadoServicio</span> <span class="tok-o">{</span>
    <span class="tok-n">ArrayList</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-o">&gt;</span> <span class="tok-n">saludos</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">ArrayList</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-o">&gt;();</span> <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="tok-nd">@EJB</span>
    <span class="tok-n">SaludoServicio</span> <span class="tok-n">saludoServicio</span><span class="tok-o">;</span> <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">saludo</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">String</span> <span class="tok-n">saludo</span> <span class="tok-o">=</span> <span class="tok-n">saludoServicio</span><span class="tok-o">.</span><span class="tok-na">saludo</span><span class="tok-o">(</span><span class="tok-n">nombre</span><span class="tok-o">);</span> <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-n">saludos</span><span class="tok-o">.</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-n">saludo</span><span class="tok-o">);</span>
        <span class="tok-k">return</span> <span class="tok-n">saludo</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">ArrayList</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-o">&gt;</span> <span class="tok-nf">saludos</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">saludos</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Estado local definido por un <code>ArrayList</code> donde se guardan saludos</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Se obtiene una referencia al bean <code>SaludoServicio</code> para obtener el saludo</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Se obtiene un saludo invocando a <code>SaludoServicio</code> y se guarda en el array de saludos</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En el ejemplo definimos el enterprise bean <code>SaludoConEstadoServicio</code> que guarda los saludos en un array local antes de devolverlo. También tiene un método <code>saludos()</code> que devuelve el array de todos los saludos emitidos.</p>
</div>
</div>
<div class="sect4">
<h5 id="_beans_de_sesión_singleton">Beans de sesión singleton</h5>
<div class="paragraph">
<p>Un bean de sesión <em>singleton</em> es instanciado una vez por aplicación y proporciona un acceso fácil a estado compartido. Si el contenedor está distribuido en muchas máquinas, cada aplicación tendrá una única instancia del singleton en cada JVM.</p>
</div>
<div class="paragraph">
<p>Múltiples clientes van a acceder de forma concurrente a la misma instancia del bean:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="imagenes/ejb/bean-singleton.png" alt="" width="50%">
</div>
</div>
<div class="paragraph">
<p>Para definir un bean de sesión singleton se debe utilizar la anotación <code>@Singleton</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Startup</span>
<span class="tok-nd">@Singleton</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">SaludoSingletonServicio</span> <span class="tok-o">{</span>
    <span class="tok-n">ArrayList</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-o">&gt;</span> <span class="tok-n">saludos</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">ArrayList</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-o">&gt;();</span>

    <span class="tok-nd">@EJB</span>
    <span class="tok-n">SaludoServicio</span> <span class="tok-n">saludoServicio</span><span class="tok-o">;</span>

    <span class="tok-nd">@Lock</span><span class="tok-o">(</span><span class="tok-n">LockType</span><span class="tok-o">.</span><span class="tok-na">WRITE</span><span class="tok-o">)</span>
    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">saludo</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">String</span> <span class="tok-n">saludo</span> <span class="tok-o">=</span> <span class="tok-n">saludoServicio</span><span class="tok-o">.</span><span class="tok-na">saludo</span><span class="tok-o">(</span><span class="tok-n">nombre</span><span class="tok-o">);</span>
        <span class="tok-n">saludos</span><span class="tok-o">.</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-n">saludo</span><span class="tok-o">);</span>
        <span class="tok-k">return</span> <span class="tok-n">saludo</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Lock</span><span class="tok-o">(</span><span class="tok-n">LockType</span><span class="tok-o">.</span><span class="tok-na">READ</span><span class="tok-o">)</span>
    <span class="tok-kd">public</span> <span class="tok-n">ArrayList</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-o">&gt;</span> <span class="tok-nf">saludos</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">saludos</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La anotación <code>@Lock(LockType.READ)</code> permite accesos concurrentes a los métodos. La anotación <code>@Lock(LockType.WRITE)</code> obliga a un acceso secuencial al método.</p>
</div>
<div class="paragraph">
<p>El contenedor decide cuándo inicializar la instancia del singleton. Es posible obligar a que la inicialización se realice al arrancar la aplicación usando la anotación <code>@Startup</code>. De esta forma, el contenedor inicializa todos los singleton de arranque y ejecuta sus métodos marcados con <code>@PostConstruct</code> antes de que la  aplicación esté disponible y de servir las peticiones de los clientes.</p>
</div>
<div class="paragraph">
<p>Es posible determinar el orden en el que el contenedor debe inicializar los beans singleton utilizando la anotación <code>@DependsOn</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Singleton</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Foo</span> <span class="tok-o">{</span>
	<span class="tok-c1">//...</span>
<span class="tok-o">}</span>

<span class="tok-nd">@DependsOn</span><span class="tok-o">(</span><span class="tok-s">&quot;Foo&quot;</span><span class="tok-o">)</span>
<span class="tok-nd">@Singleton</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Bar</span> <span class="tok-o">{</span>
	<span class="tok-c1">//...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El contenedor se asegura de que el bean <code>Foo</code> se ha inicializado antes de inicializar el bean <code>Bar</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_beans_dirigidos_por_mensajes">1.4.2. Beans dirigidos por mensajes</h4>
<div class="paragraph">
<p>Son el segundo tipo de beans propuestos por la especificación de la arquitectura EJB. Estos beans permiten que las aplicaciones J2EE reciban mensajes JMS de forma asíncrona. Así, el hilo de ejecución de un cliente no se bloquea cuando está esperando que se complete algún método de negocio de otro enterprise bean. Los mensajes pueden enviarse desde cualquier componente J2EE (una aplicación cliente, otro enterprise bean, o un componente Web) o por una aplicación o sistema JMS que no use la tecnología J2EE.</p>
</div>
<div class="paragraph">
<p>La diferencia más visible con los beans de sesión es que los clientes no acceden a los beans dirigidos por mensajes mediante interfaces (explicaremos esto con más detalle más adelante), sino que un bean dirigido por mensajes sólo tienen una clase de implementación.</p>
</div>
<div class="paragraph">
<p>En muchos aspectos, un bean dirigido por mensajes es parecido a un bean de sesión sin estado.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Las instancias de un bean dirigido por mensajes no almacenan ningún estado conversacional ni datos de clientes.</p>
</li>
<li>
<p>Todas las instancias de los beans dirigidos por mensajes son equivalentes, lo que permite al contenedor EJB asignar un mensaje a cualquier instancia. El contenedor puede almacenar estas instancias para permitir que los streams de mensajes sean procesados de forma concurrente.</p>
</li>
<li>
<p>Un único bean dirigido por mensajes puede procesar mensajes de múltiples clientes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Las variables de instancia de estos beans pueden contener algún estado referido al manejo de los mensajes de los clientes. Por ejemplo, pueden contener una conexión JMS, una conexión de base de datos o una referencia a un objeto enterprise bean.</p>
</div>
<div class="paragraph">
<p>Cuando llega un mensaje, el contenedor llama al método <code>onMessage</code> del bean. El método <code>onMessage</code> suele realizar un casting del mensaje a
uno de los cinco tipos de mensajes de JMS y manejarlo de forma acorde con la lógica de negocio de la aplicación. El método onMessage puede llamar a métodos auxiliares, o puede invocar a un bean de sesión o de entidad para procesar la información del mensaje o para almacenarlo en una base de datos.</p>
</div>
<div class="paragraph">
<p>Un mensaje puede enviarse a un bean dirigido por mensajes dentro de un contexto de transacción, por lo que todas las operaciones dentro del método onMessage son parten de un única transacción.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_acceso_al_enterprise_bean">1.5. Acceso al enterprise bean</h3>
<div class="paragraph">
<p>Existen dos formas de obtener una referencia a un bean: usando inyección de dependencias o nombres JNDI. En ningún caso se puede hacer un <code>new</code> de un enterprise bean, siempre es el servidor de aplicaciones el que realiza su construcción y devuelve el objeto con el que interactúa el cliente.</p>
</div>
<div class="sect3">
<h4 id="_acceso_por_inyección_de_dependencias">1.5.1. Acceso por inyección de dependencias</h4>
<div class="paragraph">
<p>La primera forma de obtener una referencia a un enterprise bean es usando inyección de dependencias. Debemos usar la anotación <code>@EJB</code> en una variable para indicar que el servidor debe inyectar un enterprise bean del tipo definido por el tipo de la variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@EJB</span>
<span class="tok-n">SaludoServicio</span> <span class="tok-n">saludoServicio</span><span class="tok-o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos realizar inyección de dependencias en componentes gestionados desplegados en la misma aplicación en la que se define el enterprise bean: servlets y otros enterprise beans.</p>
</div>
<div class="paragraph">
<p>El servidor inyectará en la variable un bean del tipo definido en el momento de creación del componente, inyectando la referencia en la instancia recién creada. Es importante por ello conocer el ciclo de vida del componente.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, en el caso de un servlet, la creación del servlet sólo se hace una vez, en el momento de la puesta en marcha de la aplicación. Recordemos que las peticiones al servlets se implementan como hilos de ejecución concurrente y que las variables definidas en el servlet son compartidas por todos los hilos.</p>
</div>
<div class="paragraph">
<p>En un servlet podemos inyectar un enterprise bean de sesión sin estado o un bean singleton. No podemos inyectar un bean de sesión con estado, porque el estado sería compartido por todas las peticiones. Si queremos que cada petición utilice un bean de sesión con estado debemos definir la variable que referencia el bean en el método <code>deGet</code> y obtener la referencia al bean accediendo a su nombre JNDI.</p>
</div>
</div>
<div class="sect3">
<h4 id="_acceso_por_nombre_jndi">1.5.2. Acceso por nombre JNDI</h4>
<div class="paragraph">
<p>Se definen tres espacios de nombres JNDI para identificar los componentes enterprise y acceder a ellos utilizando JNDI: <code>java:global</code>, <code>java:module</code> y <code>java:app</code>.</p>
</div>
<div class="paragraph">
<p>El espacio de nombres <code>java:global</code> permite acceder a enterprise beans remotos y su sintaxis es la siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>java:global[/nombre aplicación]/nombre módulo/nombre enterprise bean</code></pre>
</div>
</div>
<div class="paragraph">
<p>El nombre de la aplicación se requiere si el enterprise bean está empaquetado en un EAR. No es nuestro caso, porque estamos empaquetando los beans en WARs.</p>
</div>
<div class="paragraph">
<p>El espacio de nombres <code>java:module</code> se utiliza para acceder a beans local dentro del mismo módulo. Por ejemplo para acceder desde un servlet a un bean desplegado en el mismo WAR. Su sintaxis es la siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>java:module/nombre enterprise bean</code></pre>
</div>
</div>
<div class="paragraph">
<p>El espacio de nombres <code>java:app</code> se utiliza para acceder a enterprise beans en otra aplicación dentro del mismo servidor. Su sintaxis es</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>java:app[/nombre módulo]/nombre enterprise bean</code></pre>
</div>
</div>
<div class="paragraph">
<p>Por ejemplo, si el enterprise bean <code>MiBean</code> se empaqueta dentro del archivo de aplicación web <code>miApp.war</code>, el nombre del módulo es <code>miApp</code>. Sus nombres JNDI son <code>java:module/MiBean</code>, <code>java:app/miApp/MiBean</code> y <code>java:global/miApp/MiBean</code>.</p>
</div>
<div class="paragraph">
<p>Cuando se despliega la aplicación el servidor WildFly muestra por la salida estándar los distintos nombres JNDI de los beans desplegados. Por ejemplo, suponiendo que hayamos definido un enterprise bean <code>SaludoConEstadoServicio</code> en el WAR <code>saludo.war</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>java:global/saludo/SaludoConEstadoServicio
java:app/saludo/SaludoConEstadoServicio
java:module/SaludoConEstadoServicio</code></pre>
</div>
</div>
<div class="paragraph">
<p>Desde cualquier componente gestionado podemos obtener una referencia a un enterprise bean llamando al método <code>lookup</code> de un objeto <code>InitialContext</code>. Hay que pasar el nombre JNDI del bean que queremos obtener. Hay que capturar la excepción checked que puede lanzar el método.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, si queremos acceder al bean <code>SaludoConEstadoServicio</code> desde un servlet podríamos hacerlo de la siguiente forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@WebServlet</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;holamundoestado&quot;</span><span class="tok-o">,</span> <span class="tok-n">urlPatterns</span><span class="tok-o">=</span><span class="tok-s">&quot;/holamundoestado&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">HolaMundoConEstadoServlet</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span> <span class="tok-o">{</span>

    <span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">doPost</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
    	                  <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
                          <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span> <span class="tok-o">}</span>

    <span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
    	      	   	 <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
                         <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>

        <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setContentType</span><span class="tok-o">(</span><span class="tok-s">&quot;text/html&quot;</span><span class="tok-o">);</span>

        <span class="tok-kt">int</span> <span class="tok-n">errorStatus</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-o">;</span>
        <span class="tok-n">String</span> <span class="tok-n">errorMsg</span> <span class="tok-o">=</span> <span class="tok-s">&quot;&quot;</span><span class="tok-o">;</span>
        <span class="tok-n">String</span> <span class="tok-n">nombre</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;nombre&quot;</span><span class="tok-o">);</span>

        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">nombre</span> <span class="tok-o">==</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">errorStatus</span> <span class="tok-o">=</span> <span class="tok-n">HttpServletResponse</span><span class="tok-o">.</span><span class="tok-na">SC_BAD_REQUEST</span><span class="tok-o">;</span>
            <span class="tok-n">errorMsg</span> <span class="tok-o">=</span> <span class="tok-s">&quot;Faltan parámetros en la petición&quot;</span><span class="tok-o">;</span>
            <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setStatus</span><span class="tok-o">(</span><span class="tok-n">errorStatus</span><span class="tok-o">);</span>
            <span class="tok-n">PrintWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">errorMsg</span><span class="tok-o">);</span>
        <span class="tok-o">}</span> <span class="tok-k">else</span> <span class="tok-o">{</span>
            <span class="tok-k">try</span> <span class="tok-o">{</span>
                <span class="tok-n">SaludoConEstadoServicio</span> <span class="tok-n">saludoServicio</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-n">SaludoConEstadoServicio</span><span class="tok-o">)</span>
                        <span class="tok-k">new</span> <span class="tok-nf">InitialContext</span><span class="tok-o">().</span><span class="tok-na">lookup</span><span class="tok-o">(</span><span class="tok-s">&quot;java:module/SaludoConEstadoServicio&quot;</span><span class="tok-o">);</span> <i class="conum" data-value="1"></i><b>(1)</b>

                <span class="tok-n">PrintWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>
                <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;!DOCTYPE HTML PUBLIC \&quot;&quot;</span> <span class="tok-o">+</span>
                        <span class="tok-s">&quot;-//W3C//DTD HTML 4.0 &quot;</span> <span class="tok-o">+</span>
                        <span class="tok-s">&quot;Transitional//EN\&quot;&gt;&quot;</span><span class="tok-o">);</span>
                <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;HTML&gt;&quot;</span><span class="tok-o">);</span>
                <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;BODY&gt;&quot;</span><span class="tok-o">);</span>
                <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;h1&gt;Stateful&lt;/h1&gt;&quot;</span><span class="tok-o">);</span>
                <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;p&gt;Saludos: &lt;/p&gt;&quot;</span><span class="tok-o">);</span>
                <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;ul&gt;&quot;</span><span class="tok-o">);</span>
                <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;li&gt;&quot;</span> <span class="tok-o">+</span> <span class="tok-n">saludoServicio</span><span class="tok-o">.</span><span class="tok-na">saludo</span><span class="tok-o">(</span><span class="tok-n">nombre</span><span class="tok-o">)</span> <span class="tok-o">+</span> <span class="tok-s">&quot;&lt;/li&gt;&quot;</span><span class="tok-o">);</span> <i class="conum" data-value="2"></i><b>(2)</b>
                <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;li&gt;&quot;</span> <span class="tok-o">+</span> <span class="tok-n">saludoServicio</span><span class="tok-o">.</span><span class="tok-na">saludo</span><span class="tok-o">(</span><span class="tok-s">&quot;Juan&quot;</span><span class="tok-o">)</span> <span class="tok-o">+</span> <span class="tok-s">&quot;&lt;/li&gt;&quot;</span><span class="tok-o">);</span>
                <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;li&gt;&quot;</span> <span class="tok-o">+</span> <span class="tok-n">saludoServicio</span><span class="tok-o">.</span><span class="tok-na">saludo</span><span class="tok-o">(</span><span class="tok-s">&quot;Isabel&quot;</span><span class="tok-o">)</span> <span class="tok-o">+</span> <span class="tok-s">&quot;&lt;/li&gt;&quot;</span><span class="tok-o">);</span>
                <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;li&gt;&quot;</span> <span class="tok-o">+</span> <span class="tok-n">saludoServicio</span><span class="tok-o">.</span><span class="tok-na">saludo</span><span class="tok-o">(</span><span class="tok-s">&quot;Antonio&quot;</span><span class="tok-o">)</span> <span class="tok-o">+</span> <span class="tok-s">&quot;&lt;/li&gt;&quot;</span><span class="tok-o">);</span>
                <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/ul&gt;&quot;</span><span class="tok-o">);</span>
                <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;p&gt; Recuperamos la lista de saludos guardada: &lt;/p&gt;&quot;</span><span class="tok-o">);</span>
                <span class="tok-n">ArrayList</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-o">&gt;</span> <span class="tok-n">saludos</span> <span class="tok-o">=</span> <span class="tok-n">saludoServicio</span><span class="tok-o">.</span><span class="tok-na">saludos</span><span class="tok-o">();</span> <i class="conum" data-value="3"></i><b>(3)</b>
                <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;ul&gt;&quot;</span><span class="tok-o">);</span>
                <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">str</span> <span class="tok-o">:</span> <span class="tok-n">saludos</span><span class="tok-o">)</span> <span class="tok-o">{</span>
                    <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;li&gt;&quot;</span> <span class="tok-o">+</span> <span class="tok-n">str</span> <span class="tok-o">+</span> <span class="tok-s">&quot;&lt;/li&gt;&quot;</span><span class="tok-o">);</span>
                <span class="tok-o">}</span>
                <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;ul&gt;&quot;</span><span class="tok-o">);</span>
                <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/BODY&gt;&quot;</span><span class="tok-o">);</span>
                <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/HTML&quot;</span><span class="tok-o">);</span>

            <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">NamingException</span> <span class="tok-n">e</span><span class="tok-o">)</span> <span class="tok-o">{</span>
                <span class="tok-n">e</span><span class="tok-o">.</span><span class="tok-na">printStackTrace</span><span class="tok-o">();</span>
            <span class="tok-o">}</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Obtención de la referencia al bean mediante su nombre JNDI</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Cambiamos el estado del bean, enviándole distintos nombres</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Recuperamos todos los saludos almacenados</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_pruebas_de_enterprise_beans_con_arquillian">1.6. Pruebas de enterprise beans con Arquillian</h3>
<div class="paragraph">
<p>El framework de JBoss <a href="http://arquillian.org">Arquillian</a> permite realizar testing de componentes desplegándolos en el servidor de aplicaciones y lanzando los tests, que se ejecutan como si se invocaran dentro del servidor.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, el siguiente código prueba el método <code>saludo</code> del bean <code>SaludoServicio</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">ejb</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">junit</span><span class="tok-o">.</span><span class="tok-na">Assert</span><span class="tok-o">.</span><span class="tok-na">assertTrue</span><span class="tok-o">;</span>

<span class="tok-nd">@RunWith</span><span class="tok-o">(</span><span class="tok-n">Arquillian</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">SaludoServicioTest</span> <span class="tok-o">{</span>

    <span class="tok-nd">@EJB</span>
    <span class="tok-kd">private</span> <span class="tok-n">SaludoServicio</span> <span class="tok-n">saludoServicio</span><span class="tok-o">;</span>

    <span class="tok-nd">@Deployment</span>
    <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-n">Archive</span><span class="tok-o">&lt;?&gt;</span> <span class="tok-n">deployment</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">ShrinkWrap</span><span class="tok-o">.</span><span class="tok-na">create</span><span class="tok-o">(</span><span class="tok-n">JavaArchive</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">)</span>
                <span class="tok-o">.</span><span class="tok-na">addClass</span><span class="tok-o">(</span><span class="tok-n">SaludoServicio</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">deberiaDevolverUnoDeLosSaludos</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">String</span><span class="tok-o">[]</span> <span class="tok-n">misSaludos</span> <span class="tok-o">=</span> <span class="tok-o">{</span><span class="tok-s">&quot;Hola, que tal?&quot;</span><span class="tok-o">,</span>
                <span class="tok-s">&quot;Cuanto tiempo sin verte&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Que te cuentas?&quot;</span><span class="tok-o">,</span>
                <span class="tok-s">&quot;Me alegro de volver a verte&quot;</span><span class="tok-o">};</span>
        <span class="tok-n">String</span> <span class="tok-n">nombre</span> <span class="tok-o">=</span> <span class="tok-s">&quot;Pepito&quot;</span><span class="tok-o">;</span>
        <span class="tok-n">String</span> <span class="tok-n">saludo</span> <span class="tok-o">=</span> <span class="tok-n">saludoServicio</span><span class="tok-o">.</span><span class="tok-na">saludo</span><span class="tok-o">(</span><span class="tok-n">nombre</span><span class="tok-o">);</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">saludo</span><span class="tok-o">.</span><span class="tok-na">startsWith</span><span class="tok-o">(</span><span class="tok-n">nombre</span> <span class="tok-o">+</span> <span class="tok-s">&quot;, &quot;</span> <span class="tok-o">+</span> <span class="tok-n">misSaludos</span><span class="tok-o">[</span><span class="tok-mi">0</span><span class="tok-o">])</span> <span class="tok-o">||</span>
                   <span class="tok-n">saludo</span><span class="tok-o">.</span><span class="tok-na">startsWith</span><span class="tok-o">(</span><span class="tok-n">nombre</span> <span class="tok-o">+</span> <span class="tok-s">&quot;, &quot;</span> <span class="tok-o">+</span> <span class="tok-n">misSaludos</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">])</span> <span class="tok-o">||</span>
                   <span class="tok-n">saludo</span><span class="tok-o">.</span><span class="tok-na">startsWith</span><span class="tok-o">(</span><span class="tok-n">nombre</span> <span class="tok-o">+</span> <span class="tok-s">&quot;, &quot;</span> <span class="tok-o">+</span> <span class="tok-n">misSaludos</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">])</span> <span class="tok-o">||</span>
                   <span class="tok-n">saludo</span><span class="tok-o">.</span><span class="tok-na">startsWith</span><span class="tok-o">(</span><span class="tok-n">nombre</span> <span class="tok-o">+</span> <span class="tok-s">&quot;, &quot;</span> <span class="tok-o">+</span> <span class="tok-n">misSaludos</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">]));</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos utilizar Arquillian de dos formas: con un servidor de aplicaciones <em>gestionado</em> o remoto. En el primer caso Arquillian se encarga de poner en marcha el servidor de aplicaciones, desplegar los componentes y los tests, lanzarlos y cerrar el servidor de aplicaciones. En el segundo caso debemos tener un servidor de aplicaciones en marcha y Arquillian se comunica con él para desplegar los componentes y los tests. Esta forma es más eficiente.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Asegúrate que WildFly esté funcionando antes de lanzar los tests de Arquillian. La configuración de Arquillian definida en el POM es la de acceso remoto al servidor de aplicaciones.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Se pueden comprobar las dependencias necesarias en el siguiente POM completo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tok-nt">&lt;project</span> <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="tok-na">xmlns:xsi=</span><span class="tok-s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="tok-na">xsi:schemaLocation=</span><span class="tok-s">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;modelVersion&gt;</span>4.0.0<span class="tok-nt">&lt;/modelVersion&gt;</span>

    <span class="tok-nt">&lt;groupId&gt;</span>org.expertojava.ejb<span class="tok-nt">&lt;/groupId&gt;</span>
    <span class="tok-nt">&lt;artifactId&gt;</span>saludo<span class="tok-nt">&lt;/artifactId&gt;</span>
    <span class="tok-nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="tok-nt">&lt;/version&gt;</span>
    <span class="tok-nt">&lt;packaging&gt;</span>war<span class="tok-nt">&lt;/packaging&gt;</span>
    <span class="tok-nt">&lt;name&gt;</span>saludo<span class="tok-nt">&lt;/name&gt;</span>

    <span class="tok-nt">&lt;properties&gt;</span>
        <span class="tok-nt">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span class="tok-nt">&lt;/project.build.sourceEncoding&gt;</span>
    <span class="tok-nt">&lt;/properties&gt;</span>

    <span class="tok-nt">&lt;dependencyManagement&gt;</span>
        <span class="tok-nt">&lt;dependencies&gt;</span>
            <span class="tok-nt">&lt;dependency&gt;</span>
                <span class="tok-nt">&lt;groupId&gt;</span>org.jboss.arquillian<span class="tok-nt">&lt;/groupId&gt;</span>
                <span class="tok-nt">&lt;artifactId&gt;</span>arquillian-bom<span class="tok-nt">&lt;/artifactId&gt;</span>
                <span class="tok-nt">&lt;version&gt;</span>1.1.4.Final<span class="tok-nt">&lt;/version&gt;</span>
                <span class="tok-nt">&lt;scope&gt;</span>import<span class="tok-nt">&lt;/scope&gt;</span>
                <span class="tok-nt">&lt;type&gt;</span>pom<span class="tok-nt">&lt;/type&gt;</span>
            <span class="tok-nt">&lt;/dependency&gt;</span>
        <span class="tok-nt">&lt;/dependencies&gt;</span>
    <span class="tok-nt">&lt;/dependencyManagement&gt;</span>

    <span class="tok-nt">&lt;dependencies&gt;</span>
        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>javax<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>javaee-api<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>7.0<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>provided<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>junit<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>junit<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>4.11<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.jboss.arquillian.junit<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>arquillian-junit-container<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.wildfly<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>wildfly-arquillian-container-remote<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>8.1.0.Final<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

    <span class="tok-nt">&lt;/dependencies&gt;</span>

    <span class="tok-nt">&lt;build&gt;</span>
        <span class="tok-nt">&lt;finalName&gt;</span>${project.name}<span class="tok-nt">&lt;/finalName&gt;</span>

        <span class="tok-nt">&lt;plugins&gt;</span>
            <span class="tok-nt">&lt;plugin&gt;</span>
                <span class="tok-nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="tok-nt">&lt;/groupId&gt;</span>
                <span class="tok-nt">&lt;artifactId&gt;</span>maven-compiler-plugin<span class="tok-nt">&lt;/artifactId&gt;</span>
                <span class="tok-nt">&lt;version&gt;</span>3.1<span class="tok-nt">&lt;/version&gt;</span>
                <span class="tok-nt">&lt;configuration&gt;</span>
                    <span class="tok-nt">&lt;source&gt;</span>1.7<span class="tok-nt">&lt;/source&gt;</span>
                    <span class="tok-nt">&lt;target&gt;</span>1.7<span class="tok-nt">&lt;/target&gt;</span>
                <span class="tok-nt">&lt;/configuration&gt;</span>
            <span class="tok-nt">&lt;/plugin&gt;</span>
            <span class="tok-nt">&lt;plugin&gt;</span>
                <span class="tok-nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="tok-nt">&lt;/groupId&gt;</span>
                <span class="tok-nt">&lt;artifactId&gt;</span>maven-war-plugin<span class="tok-nt">&lt;/artifactId&gt;</span>
                <span class="tok-nt">&lt;version&gt;</span>2.3<span class="tok-nt">&lt;/version&gt;</span>
                <span class="tok-nt">&lt;configuration&gt;</span>
                    <span class="tok-nt">&lt;failOnMissingWebXml&gt;</span>false<span class="tok-nt">&lt;/failOnMissingWebXml&gt;</span>
                <span class="tok-nt">&lt;/configuration&gt;</span>
            <span class="tok-nt">&lt;/plugin&gt;</span>
            <span class="tok-nt">&lt;plugin&gt;</span>
                <span class="tok-nt">&lt;groupId&gt;</span>org.wildfly.plugins<span class="tok-nt">&lt;/groupId&gt;</span>
                <span class="tok-nt">&lt;artifactId&gt;</span>wildfly-maven-plugin<span class="tok-nt">&lt;/artifactId&gt;</span>
                <span class="tok-nt">&lt;version&gt;</span>1.0.2.Final<span class="tok-nt">&lt;/version&gt;</span>
                <span class="tok-nt">&lt;configuration&gt;</span>
                    <span class="tok-nt">&lt;hostname&gt;</span>localhost<span class="tok-nt">&lt;/hostname&gt;</span>
                    <span class="tok-nt">&lt;port&gt;</span>9990<span class="tok-nt">&lt;/port&gt;</span>
                <span class="tok-nt">&lt;/configuration&gt;</span>
            <span class="tok-nt">&lt;/plugin&gt;</span>
        <span class="tok-nt">&lt;/plugins&gt;</span>
    <span class="tok-nt">&lt;/build&gt;</span>
<span class="tok-nt">&lt;/project&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios">1.7. Ejercicios</h3>
<div class="sect3">
<h4 id="__2_puntos_construir_el_módulo_code_saludo_code">1.7.1. (2 puntos) Construir el módulo <code>saludo</code></h4>
<div class="paragraph">
<p>En este ejercicio deberás construir el módulo <code>saludo</code> con los ejemplos vistos en la teoría de todos los tipos de enterprise beans:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>SaludoServicio</code>: bean de sesión sin estado</p>
</li>
<li>
<p><code>SaludoRestringidoServicio</code>: bean de sesión sin estado con autorización</p>
</li>
<li>
<p><code>SaludoConEstadoServicio</code>: bean de sesión con estado</p>
</li>
<li>
<p><code>SaludoSingletonServicio</code>: bean de sesión singleton</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Empezamos por crear el proyecto <code>ejb-expertojava</code>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Haz un fork del proyecto vacío IntelliJ <code>ejb-expertojava</code> en la cuenta de <code>java_ua</code> que contiene un repositorio git inicial en el que iremos añadiendo los módulos IntelliJ que vamos a crear como ejercicios de</p>
</li>
<li>
<p>Descárgalo en tu máquina con el comando <code>git clone</code>. Tendrás un directorio <code>ejb-expertojava</code> que contiene un fichero <code>.idea</code> que podrás abrir con IntelliJ</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> git clone https://&lt;usuario&gt;@bitbucket.org/java_ua/ejb-expertojava.git</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Creamos dentro del proyecto el módulo IntelliJ <code>saludo</code> con un proyecto web inicial en el que vamos a añadir los distintos enterprise beans y los servlets que los usan:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Descarga en el directorio recién creado la plantilla <code>webapp-expertojava</code>, cambia su nombre a <code>saludo</code> y borra los datos de git (va a estar controlado por el proyecto git en el directorio padre):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> <span class="tok-nb">cd </span>ejb-expertojava
<span class="tok-gp">$</span> git clone https://&lt;usuario&gt;@bitbucket.org/java_ua/webapp-expertojava.git
<span class="tok-gp">$</span> mv webapp-expertojava saludo
<span class="tok-gp">$</span> <span class="tok-nb">cd </span>saludo
<span class="tok-gp">$</span> rm -rf .git
<span class="tok-gp">$</span> rm -f .gitignore</code></pre>
</div>
</div>
</li>
<li>
<p>Edita el fichero <code>pom.xml</code> para actualizar las coordenadas del proyecto Maven, modificando los atributos como sigue:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;groupId&gt;</span>org.expertojava.ejb<span class="tok-nt">&lt;/groupId&gt;</span>
<span class="tok-nt">&lt;artifactId&gt;</span>saludo<span class="tok-nt">&lt;artifactId&gt;</span>
<span class="tok-nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="tok-nt">&lt;/version&gt;</span>
<span class="tok-nt">&lt;packaging&gt;</span>war<span class="tok-nt">&lt;/packaging&gt;</span>

<span class="tok-nt">&lt;name&gt;</span>saludo<span class="tok-nt">&lt;/name&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Por último, abre en IntelliJ el proyecto del directorio padre <code>ejb-expertojava</code> y procede a importar el módulo <code>saludo</code> como un módulo Maven. Para ello, escogemos la opción <em>Import Module &gt; Import module from externa model &gt; Maven</em>. Una vez importado el módulo podemos añadir una configuración de despliegue/ejecución y nos aseguramos de que la aplicación funciona correctamente.</p>
</li>
<li>
<p>Añade los cambios al control de versiones, abriendo el panel Changes y pulsando el botón derecho sobre <em>Unversioned Files</em> y seleccionando <em>Add to VCS</em>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Una vez tengas el abierto en Intellij el proyecto con el primer submódulo, y tengas correctamente configurado git, debes añadir todos los distintos tipos de componentes enterprise que hemos visto en el tema, junto con servlets en los que se invocan.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="imagenes/ejb/ejercicio1.png" alt="" width="50%">
</div>
</div>
<div class="paragraph">
<p>El fichero <code>index.jsp</code> contiene una sencilla página HTML para invocar a los distintos servlets:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-cp">&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.0 Transitional//EN&quot;&gt;</span>
<span class="tok-nt">&lt;html&gt;</span>
    <span class="tok-nt">&lt;head&gt;</span>
        <span class="tok-nt">&lt;title&gt;</span>Start Page<span class="tok-nt">&lt;/title&gt;</span>
        <span class="tok-nt">&lt;meta</span> <span class="tok-na">http-equiv=</span><span class="tok-s">&quot;Content-Type&quot;</span> <span class="tok-na">content=</span><span class="tok-s">&quot;text/html; charset=UTF-8&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;/head&gt;</span>
    <span class="tok-nt">&lt;body&gt;</span>
        <span class="tok-nt">&lt;h1&gt;</span>Hello World!<span class="tok-nt">&lt;/h1&gt;</span>
        <span class="tok-nt">&lt;form</span> <span class="tok-na">action=</span><span class="tok-s">&quot;&lt;%=request.getContextPath()%&gt;/holamundo&quot;</span><span class="tok-nt">&gt;</span>
        <span class="tok-nt">&lt;p&gt;</span>Introduce tu nombre (sin estado): <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;nombre&quot;</span><span class="tok-nt">&gt;&lt;/p&gt;</span>
        <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;submit&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;Enviar&quot;</span><span class="tok-nt">&gt;</span>
        <span class="tok-nt">&lt;/form&gt;</span>
        <span class="tok-nt">&lt;form</span> <span class="tok-na">action=</span><span class="tok-s">&quot;&lt;%=request.getContextPath()%&gt;/holamundoestado&quot;</span><span class="tok-nt">&gt;</span>
            <span class="tok-nt">&lt;p&gt;</span>Introduce tu nombre (con estado): <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;nombre&quot;</span><span class="tok-nt">&gt;&lt;/p&gt;</span>
            <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;submit&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;Enviar&quot;</span><span class="tok-nt">&gt;</span>
        <span class="tok-nt">&lt;/form&gt;</span>
        <span class="tok-nt">&lt;form</span> <span class="tok-na">action=</span><span class="tok-s">&quot;&lt;%=request.getContextPath()%&gt;/holamundosingleton&quot;</span><span class="tok-nt">&gt;</span>
            <span class="tok-nt">&lt;p&gt;</span>Introduce tu nombre (singleton): <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;nombre&quot;</span><span class="tok-nt">&gt;&lt;/p&gt;</span>
            <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;submit&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;Enviar&quot;</span><span class="tok-nt">&gt;</span>
        <span class="tok-nt">&lt;/form&gt;</span>
        <span class="tok-nt">&lt;form</span> <span class="tok-na">action=</span><span class="tok-s">&quot;&lt;%=request.getContextPath()%&gt;/holamundorestringido&quot;</span><span class="tok-nt">&gt;</span>
            <span class="tok-nt">&lt;p&gt;</span>Introduce tu nombre (sin estado, restringido): <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;nombre&quot;</span><span class="tok-nt">&gt;&lt;/p&gt;</span>
            <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;submit&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;Enviar&quot;</span><span class="tok-nt">&gt;</span>
        <span class="tok-nt">&lt;/form&gt;</span>
    <span class="tok-nt">&lt;/body&gt;</span>
<span class="tok-nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="imagenes/ejb/paginajsp.png" alt="" width="50%">
</div>
</div>
<div class="paragraph">
<p>Por último, añade la clase de test <code>SaludoServicioTest</code> con la prueba Arquillian que hemos visto en teoría que comprueba el funcionamiento del bean de sesión sin estado. Deberás añadir las dependencias necesarias en el <code>pom.xml</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="__1_5_puntos_construir_el_módulo_code_calculadora_code">1.7.2. (1,5 puntos) Construir el módulo <code>calculadora</code></h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea dentro de <code>ejb-expertojava</code> un nuevo módulo IntelliJ llamado <code>calculadora</code> con las siguientes características</p>
<div class="ulist">
<ul>
<li>
<p>Módulo Maven de tipo WAR con el groupId <code>org.expertojava.ejb</code> y el artifactID <code>calculadora</code></p>
</li>
<li>
<p>Contiene un enterprise bean de sesión sin estado <code>org.expertojava.ejb.Calculadora</code> con los siguientes métodos:</p>
<div class="ulist">
<ul>
<li>
<p><code>public double mult(double num1, double num2)</code></p>
</li>
<li>
<p><code>public double div(double num1, double num2)</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Escribe la página <code>index.jsp</code> y un servlet para comprobar su funcionamiento.</p>
</li>
<li>
<p>Escribe un fichero de test de Arquillian con dos tests que comprueben el funcionamiento de ambos métodos.</p>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion02">2. Ciclo de vida de los enterprise beans y seguridad de acceso</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Vamos a incluir en esta sesión dos apartados que no tiene mucha relación, pero que tienen una extensión adecuada para cubrirlos ambos en una única sesión. Son el ciclo de vida y las restricciones de seguridad en el uso de los enterprise beans.</p>
</div>
<div class="sect2">
<h3 id="_ciclo_de_vida">2.1. Ciclo de vida</h3>
<div class="paragraph">
<p>Hemos visto que los enterprise beans son objetos gestionados por el servidor de aplicaciones. Esto significa que nosotros no vamos a poder llamar a <code>new()</code> para sólo vamos a poder obtener referencias para su uso. Es el servidor de aplicaciones se encarga de crear las instancias de los enterprise beans, de inyectar sus referencias en las variables anotadas y de controlar sus distintas fases del ciclo de vida.</p>
</div>
<div class="paragraph">
<p>Empezamos con el ciclo de vida de los beans de sesión con estado, el más elaborado, y seguimos con el de los beans sin estado.</p>
</div>
<div class="sect3">
<h4 id="_ciclo_de_vida_de_los_beans_de_sesión_con_estado">2.1.1. Ciclo de vida de los beans de sesión con estado</h4>
<div class="paragraph">
<p>Recordemos un ejemplo de enterprise bean con estado:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Stateful</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">SaludoConEstadoServicio</span> <span class="tok-o">{</span>
    <span class="tok-n">ArrayList</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-o">&gt;</span> <span class="tok-n">saludos</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">ArrayList</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-o">&gt;();</span> <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="tok-nd">@EJB</span>
    <span class="tok-n">SaludoServicio</span> <span class="tok-n">saludoServicio</span><span class="tok-o">;</span> <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">saludo</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">String</span> <span class="tok-n">saludo</span> <span class="tok-o">=</span> <span class="tok-n">saludoServicio</span><span class="tok-o">.</span><span class="tok-na">saludo</span><span class="tok-o">(</span><span class="tok-n">nombre</span><span class="tok-o">);</span> <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-n">saludos</span><span class="tok-o">.</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-n">saludo</span><span class="tok-o">);</span>
        <span class="tok-k">return</span> <span class="tok-n">saludo</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">ArrayList</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-o">&gt;</span> <span class="tok-nf">saludos</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">saludos</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Estado local definido por un <code>ArrayList</code> donde se guardan saludos</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Se obtiene una referencia al bean <code>SaludoServicio</code> para obtener el saludo</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Se obtiene un saludo invocando a <code>SaludoServicio</code> y se guarda en el array de saludos</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En los beans con estado el servidor debe garantizar que el cliente se comunica siempre con la misma instancia del bean, ya que el cliente va modificando su estado. Todas las invocaciones a métodos del bean de un mismo cliente deben ser respondidas por la misma instancia, que es la que guarda el estado modificado. Cada cliente se conectará con una instancia distinta.</p>
</div>
<div class="paragraph">
<p>El ciclo de vida de los beans de sesión con estado debe por tanto garantizar esta característica. Se muestra en la siguiente figura:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="imagenes/ejb/ciclo-vida-con-estado.png" alt="" width="50%">
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>El contenedor crea una instancia usando el constructor por defecto cuando comienza una nueva sesión con un cliente.</p>
</li>
<li>
<p>Después de que el constructor se ha completado, el contenedor inyecta los recursos tales como contextos JPA, fuentes de datos y otros beans.</p>
</li>
<li>
<p>La instancia se almacena en memoria, esperando la invocación de alguno de sus métodos.</p>
</li>
<li>
<p>El cliente ejecuta un método de negocio y el contenedor lo invoca en el bean</p>
</li>
<li>
<p>Espera hasta que los siguientes métodos son invocados y los ejecuta.</p>
</li>
<li>
<p>Si el cliente permanece ocioso por un periodo de tiempo, el contenedor <em>pasiva</em> el bean, serializándolo y guardándolo en disco.</p>
</li>
<li>
<p>Si el cliente vuelve a invocar a un bean pasivado, éste se activa (el objeto es leído del disco) y se ejecuta el método</p>
</li>
<li>
<p>Si el cliente no invoca un método sobre el bean durante un cierto periodo de tiempo, el bean es destruido.</p>
</li>
<li>
<p>Si el cliente invoca algún método con el atributo <code>@Remove</code> el bean es destruido.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Es posible definir métodos de callback del ciclo de vida, a los que el contenedor llamará antes o después de cierto momento del ciclo de vida, con las siguientes anotaciones. Son muy útiles para gestionar la apertura y cierre de recursos inyectados y usados por el bean.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@PostConstruct</code>: el método con esta anotación se invoca justo después de que se ha ejecutado el constructor por defecto y de que se han inyectado los recursos.</p>
</li>
<li>
<p><code>@PrePassivate</code>: invocado antes de que un bean sea pasivado.</p>
</li>
<li>
<p><code>@PostActivate</code>: invocado después de que el bean haya sido traído a memoria por el contenedor y antes de que se ejecute cualquier método de negocio invocado por el cliente</p>
</li>
<li>
<p><code>@PreDestroy</code>: invocado después de que haya expirado el tiempo de conexión o el cliente haya invocado a un método anotado con <code>@Remove</code>. Despés de invocar al método, la instancia del bean se elimina y se pasa al recolector de basura.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Las anotaciones <code>@PrePassivate</code> y <code>@PostActivate</code> tienen que ver con la actualización de recursos que no pueden ser serializados. Por ejemplo, un objeto <code>java.sql.Connection</code> no puede ser serializado y debe ser reiniciado cuando el bean se reactiva.</p>
</div>
</div>
<div class="sect3">
<h4 id="_ciclo_de_vida_de_los_beans_de_sesión_sin_estado">2.1.2. Ciclo de vida de los beans de sesión sin estado</h4>
<div class="paragraph">
<p>Los beans de sesión sin estado tienen un ciclo de vida muy sencillo. O existen o no existen. Una vez que el bean es creado, se coloca en un <em>pool</em> para servir las peticiones de los clientes. En algún momento el bean se destruye, o bien cuando se reduce la carga del servidor o cuando la aplicación se cierra. El contenedor hace lo siguiente:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea una instancia del bean usando el constructor por defecto.</p>
</li>
<li>
<p>Inyecta recursos como proveedores de JPA o conexiones de bases de datos y llama a los métoods etiquetados con <code>@PostConstruct</code>.</p>
</li>
<li>
<p>Coloca instancias del bean en un <em>pool</em>.</p>
</li>
<li>
<p>Saca del pool una instancia ociosa cuando recibe una petición de ejecución de un método por el cliente.</p>
</li>
<li>
<p>Ejecuta el método de negocio solicitado por el cliente.</p>
</li>
<li>
<p>Cuando el método se termina de ejecutar, el bean se vuelve a colocar en el <em>pool</em>.</p>
</li>
<li>
<p>Cuando el contenedor lo considera necesario elimina el bean del <em>pool</em> y llama a los métodos <code>@PreDestroy</code> antes de colocarlo en el recolector de basura.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Los beans de sesión sin estado también soportan las anotaciones <code>@PostConstruct</code> y <code>@PreDestroy</code>.</p>
</div>
<div class="paragraph">
<p>La siguiente figura refleja este ciclo de vida:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="imagenes/ejb/ciclo-vida-sin-estado.png" alt="" width="50%">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_acceso_concurrente_a_los_beans_singleton">2.2. Acceso concurrente a los beans singleton</h3>
<div class="paragraph">
<p>Es posible gestionar el acceso concurrente de los clientes usando la <em>concurrencia gestionada por el contenedor</em> o la <em>concurrencia gestionada por el bean</em>. Se definen para ello las anotaciones <code>@ConcurrencyManagement(ConcurrencyManagementType.BEAN)</code> y <code>@ConcurrencyManagement(ConcurrencyManagementType.CONTAINER)</code> que hay que definir a nivel de clase.</p>
</div>
<div class="paragraph">
<p>Esta última es la menos frecuente y deja en manos del desarrollador la gestión de la concurrencia usando construcciones de Java como <code>synchronized</code> o <code>volatile</code>.</p>
</div>
<div class="paragraph">
<p>En la concurrencia gestionada por el contenedor, el contenedor se encarga de gestionar el acceso concurrente de los clientes a los métodos del bean. El contenedor realiza un bloque a nivel de métodos, asignádoles un bloqueo de tipo <code>Read</code> (compartido) o <code>Write</code> (exclusivo). Un bloqueo <code>Read</code> en un método permite las invocaciones concurrentes del método. Un bloqueo <code>Write</code> espera al procesamiento de una invocación antes de comenzar la siguiente. Si no especificamos nada en un método, por defecto tiene el bloque <code>Write</code>.</p>
</div>
<div class="paragraph">
<p>Estos tipos de bloqueos se especifican con las anotaciones <code>@Lock(LockType.READ)</code> y <code>@Lock(LockType.WRITE)</code> que se pueden realizar a nivel de clase o de método de negocio. El valor especificado en un método sobreescribe el de la clase.</p>
</div>
<div class="paragraph">
<p>En el caso del bloqueo exclusivo es posible definir un time-out para que se genere una excepción si el bloqueo dura más de un determinado tiempo usando la anotación <code>AccessTimeout</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Singleton</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Foo</span> <span class="tok-o">{</span>
	<span class="tok-nd">@Lock</span><span class="tok-o">(</span><span class="tok-n">LockType</span><span class="tok-o">.</span><span class="tok-na">WRITE</span><span class="tok-o">)</span>
	<span class="tok-nd">@AccessTimeout</span><span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-n">unit</span><span class="tok-o">=</span><span class="tok-n">TimeUnit</span><span class="tok-o">.</span><span class="tok-na">MINUTES</span><span class="tok-o">)</span>
	<span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">TestMethod</span><span class="tok-o">()</span> <span class="tok-o">{</span>
	   <span class="tok-c1">//...</span>
	<span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Es posible especificar las unidades (por defecto son MILLISECONDS):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>NANOSECONDS</p>
</li>
<li>
<p>MICROSECONDS</p>
</li>
<li>
<p>MILLISECONDS</p>
</li>
<li>
<p>SECONDS</p>
</li>
<li>
<p>MINUTES</p>
</li>
<li>
<p>HOURS</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_seguridad_en_la_arquitectura_ejb">2.3. Seguridad en la arquitectura EJB</h3>
<div class="sect3">
<h4 id="_introducción_a_la_seguridad_en_ejb">2.3.1. Introducción a la seguridad en EJB</h4>
<div class="paragraph">
<p>La seguridad es un aspecto fundamental de las aplicaciones empresariales. Cualquier aplicación interna o accesible via web va a intentar ser hackeada por extraños. Podemos analizar tres elementos fundamentales en la seguridad de una aplicación:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Autentificación</dt>
<dd>
<p>Dicho sencillamente, la autentificación valida la identidad del usuario. La forma más común de autentificación es una simple ventana de login que pide un nombre de usuario y una contraseña.  Una vez que los usuarios han pasado a través del sistema de autentificación, pueden usar el sistema libremente, hasta el nivel que les permita el control de acceso. La autentificación se puede basar también en tarjetas de identificación, certificados y en otros tipos de identificación.</p>
</dd>
<dt class="hdlist1">Control de acceso</dt>
<dd>
<p>El control de acceso (también conocido como autorización) aplica políticas de seguridad que regulan lo que un usuario específico puede y no puede hacer en el sistema. El control de acceso asegura que los usuarios accedan sólo a aquellos recursos y operaciones a los que se les ha dado permiso. El control de acceso puede restringir el acceso de un usuario a subistemas, datos, y objetos de negocio. Por ejemplo, a algunos usuarios se les puede dar permiso de modificar información, mientras que otros sólo tienen permiso de visualizarla.</p>
</dd>
<dt class="hdlist1">Comunicación segura</dt>
<dd>
<p>Los canales de comunicación entre un cliente y un servidor son un elemento muy importante en la seguridad del sistema. Un canal de comunicación puede hacerse seguro mediante aislamiento físico (por ejemplo, via una conexión de red dedicada) o por medio de la encriptación de la comunicación entre el cliente y el servidor. El aislamiento físico es caro, limita las posibilidades del sistema y es casi imposible en Internet, por lo que lo más usual es la encriptación. Cuando la comunicación se asegura mediante la encriptación, los mensajes se codifican de forma que no puedan ser leídos ni manipulados por individuos no autorizados. Esto se suele consigue mediante el intercambio de claves criptográficas entre el cliente y el servidor. Las claves permiten al receptor del mensaje decodificarlo y leerlo.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>La seguridad debe aplicarse tanto a la vista como a la capa de negocio. El hecho de que un usuario no pueda acceder a una página no significa que un la lógica de negocio no pueda invocarse. Un  hacker puede conseguir acceder a los servicios web REST y hacer  peticiones no autorizadas. O un programador de la capa web puede cometer un error y llamar desde una página sin el nivel de autorización necesaria a una operación restringida de la lógica de negocio. La arquitectura EJB proporciona un modelo de seguridad flexible y elegante que permite garantizar la seguridad en el  acceso a los métodos de negocio de la aplicación enterprise.</p>
</div>
<div class="paragraph">
<p>La mayoría de los servidores EJB soportan la comunicación segura a través del protocolo SSL (Secure Socket Layer) y proporcionan algún mecanismo de autentificación, pero la especificación Enterprise JavaBeans sólo especifica el control de acceso a los enterprise beans.</p>
</div>
<div class="paragraph">
<p>En este apartado veremos qué mecanismos define la especificación EJB para el control de acceso a los enterprise beans. Veremos que es posible definir un control de acceso  declarativo y programativo a los métodos de los beans, de forma que sólo aquellos usuarios autorizados puedan ejecutar el código restringido. Antes de eso, revisemos brevemente cómo realizar la autentificación del usuario.</p>
</div>
</div>
<div class="sect3">
<h4 id="_realms_users_groups_y_roles">2.3.2. Realms, Users, Groups y Roles</h4>
<div class="paragraph">
<p>Uuarios, grupos y roles son tres conceptos relacionados que forman la base de la seguridad EJB.</p>
</div>
<div class="paragraph">
<p>El usuario es cualquier persona autentificada en el sistema. Normalmente es un nombre de usuario autentifcado mediante una contraseña.</p>
</div>
<div class="paragraph">
<p>El concepto de grupo es similar al de sistema de ficheros UNIX. Un grupo se define en el servidor de aplicaciones como un conjunto de usuarios. Por  ejemplo, podemos definir el grupo de "administrador" al que pertenecerán todos los usuarios que sean administradores de las aplicaciones desplegadas.</p>
</div>
<div class="paragraph">
<p>Los roles se definen en las aplicaciones y es la base de la autorización del acceso a los métodos de negocio. Sólo aquellos usuarios o grupos que tengan un determinado rol podrán acceder a determinados métodos del EJB. Se deberá mapear usuario y grupos con roles. La separación entre usuarios/grupos y roles permite que la aplicación se codifique de forma indenpendiente al entorno en el que se va a desplegar. Una aplicación puede tener un rol "Administrador" y en la compañía en la que se despliega podemos tener en el directorio LDAP un grupo "Gestor Aplicaciones" que sea equivalente. El mapeo entre grupos/usuarios y roles lo realiza el servidor de aplicaciones.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="imagenes/ejb/roles.png" alt="" width="50%">
</div>
</div>
<div class="paragraph">
<p>Un <em>realm</em> se define en el servidor de aplicaciones como un conjunto de usuarios y grupos definidos mediante un determinado mecanismo.</p>
</div>
<div class="paragraph">
<p>Los dos realms que tenemos por defecto en WildFly son <code>ManagementRealm</code> y <code>ApplicationRealm</code>. <code>ManagementRealm</code> se utiliza para la aplicación de administración del servidor, por lo que sólo nos permite controlar la autentificación (no se indican roles porque el único rol que tienen los usuarios de este conjunto es el de administrar el servidor). Por otro lado, <code>ApplicationRealm</code> nos permite además controlar la autorización, mediante la asignación de roles a usuarios.</p>
</div>
<div class="paragraph">
<p>Como ya vimos en el módulo de Componentes Web, es posible añadir nuevos usuarios en estos realms con el script de WidlFly <code>addUser.sh</code> situado en <code>$WILDFLY_HOME/bin</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> ./addUser.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nos preguntará en primer lugar en cuál de los dos realms por defecto queremos introducir el usuario, y a continuación nos irá pidiendo los datos del nuevo usuario. El último de los datos que pide es la lista de roles permitidos separados por coma. En las aplicaciones que incorporen seguridad declarativa se nos permitirá entrar con cualquiera de los usuarios del <code>ApplicationRealm</code>. Las operaciones que nos permita hacer dependerán de los roles asignados.</p>
</div>
</div>
<div class="sect3">
<h4 id="_jaas_servicio_java_de_autentificación_y_autorización">2.3.3. JAAS: Servicio Java de Autentificación y Autorización</h4>
<div class="paragraph">
<p>La seguridad en Java EE está basada en el Servicio Java de Autentificación y Autorización (JAAS). Esta arquitectura se introdujo en la versión 1.4 de Java EE y desde entonces ha sido adoptado ampliamente por la industria Java comercial y open source. La versión más reciente es la <a href="https://www.jcp.org/en/jsr/detail?id=196">JSR 196</a> (Java Authentication Service Provider Interface for Containers), definida en Java EE 6. Las APIs más importantes son las definidas por los paquetes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.oracle.com/javase/7/docs/api/javax/security/auth/package-summary.html">javax.security.auth</a></p>
</li>
<li>
<p><a href="https://docs.oracle.com/javase/7/docs/api/java/security/package-summary.html">java.security</a></p>
</li>
<li>
<p><a href="https://docs.oracle.com/javaee/7/api/javax/annotation/security/package-summary.html">javax.annotation.security</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>JAAS separa el sistema de autentificación de la aplicación Jaava EE mediante el uso de un API bien definida que es implementada por el servidor de aplicaciones. La aplicación Java EE no se debe preocupar de detalles de bajo nivel como trabajar con los algoritmos de encriptación de contraseñas o comunicarse con servicios externos de autentificación como el Active Directory de Microsoft o el LDAP. El servidor de aplicaciones que contiene la aplicación Java EE se encarga de ello.</p>
</div>
<div class="paragraph">
<p>JAAS está diseñado para que la autentificación y autorización puede realizarse en cualquier capa Java EE, incluyendo la capa web y la capa EJB. En la realidad, sin embargo, la mayoría de aplicaciones Java EE son accesibles via web y  comparten un único sistema de autentificación a lo largo de todas las capas. JAAS permite propagar la autentificación realizada en la capa web a cualquier otra capa de Java EE. Una vez autentificado el usuario, el contexto de autentificación se pasa a todas las capas siempre que sea posible, en lugar de repetir los pasos de autentificación en cada una de ellas. El objeto Java <code>Principal</code> representa este usuario autentificado compartible entre capas. La siguiente figura representa este mecanismo:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="imagenes/ejb/mecanismo-jaas.png" alt="" width="50%">
</div>
</div>
<div class="paragraph">
<p>Como se muestra en la figura, un usuario se logea en la aplicación a través de la capa web. La capa web obtiene la información de autenficiación del usuario (login y password normalmente) y los autentifica usando JAAS contra el <em>realm</em> definido en el servidor de aplicaciones. Si se valida la autentificación se obtiene un <code>Principal</code> que se asocia con uno o más roles de la aplicación. Para cada recurso restringido de la capa web o la capa EJB, el servidor de aplicaciones chequea si el principal/role esta autorizado para acceder al recurso. El <code>Principal</code> se pasa a de la capa web a la capa EJB cuando se realiza una invocación de un método de algún bean.</p>
</div>
<div class="sect4">
<h5 id="_autentificación_en_la_capa_web">Autentificación en la capa web</h5>
<div class="paragraph">
<p>En la asignatura <em>Componentes Web</em> ya estudiamos con detalle la autentificación en la capa web. Recordemos que hay que realizar la configuración de seguridad  en el fichero <code>web.xml</code>, y que podemos escoger entre tres tipos de autentificación: FORM, BASIC y CLIENT-CERT.  Con el método FORM podemos especificar una página HTML en la que se define un formulario que el usuario utilizará para logearse. En el  formulario se utilizarán los nombres estándar de parámetros <code>j_username</code> y <code>j_password</code> para guardar en ellos el usuario y su contraseña y se llamará a la acción estándar <code>j_security_check</code>.</p>
</div>
<div class="paragraph">
<p>El método BASIC proporciona un mecanismo de autentificación básico, basado en cabeceras de autentificación para solicitar datos del usuario (el servidor) y para enviar los datos del usuario (el cliente). Para la comunicación se debería utilizar el protocolo SSL y la contraseña se envía codificada con el método Base64. Será el que utilicemos en los ejemplos por ser el más sencillo.</p>
</div>
<div class="paragraph">
<p>Con el método CLIENT-CERT no es necesario pedir el usuario/contraseña sino que el cliente envía al servidor de aplicaciones un certificado de clave pública almacenado en el navegador utilizando SSL y el servidor autentifica el contenido del certificado. El proveedor JAAS valida a continuación las credenciales.</p>
</div>
<div class="paragraph">
<p>En el mismo fichero <code>web.xml</code> se definen los roles y las restricciones de acceso a recursos (URLs) definidos en los servlets o páginas JSP. Por ejemplo, el siguiente código declara una restricción de acceso a la URL <code>/holamundorestringido</code> a los usuarios con el rol <code>User</code>. Como el método de autentificación es BASIC, el navegador pedirá en una ventana de diálogo el usuario y la contraseña. Si utilizamos una ventana normal del navegador éste guardará la configuración de usuario y contraseña una vez introducida por primera vez. Para probar más de una vez podemos abrir una ventana de incógnito.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tok-nt">&lt;web-app</span> <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span>
         <span class="tok-na">xmlns:xsi=</span><span class="tok-s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
         <span class="tok-na">xsi:schemaLocation=</span><span class="tok-s">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd&quot;</span>
         <span class="tok-na">version=</span><span class="tok-s">&quot;3.1&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;security-constraint&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-nt">&lt;web-resource-collection&gt;</span>
            <span class="tok-nt">&lt;web-resource-name&gt;</span>holamundorestringido<span class="tok-nt">&lt;/web-resource-name&gt;</span>
            <span class="tok-nt">&lt;url-pattern&gt;</span>/holamundorestringido<span class="tok-nt">&lt;/url-pattern&gt;</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-nt">&lt;/web-resource-collection&gt;</span>
        <span class="tok-nt">&lt;auth-constraint&gt;</span>
            <span class="tok-nt">&lt;role-name&gt;</span>usuario-saludo<span class="tok-nt">&lt;/role-name&gt;</span>
        <span class="tok-nt">&lt;/auth-constraint&gt;</span>
    <span class="tok-nt">&lt;/security-constraint&gt;</span>
    <span class="tok-nt">&lt;security-constraint&gt;</span>
        <span class="tok-nt">&lt;web-resource-collection&gt;</span>
            <span class="tok-nt">&lt;web-resource-name&gt;</span>administracion<span class="tok-nt">&lt;/web-resource-name&gt;</span>
            <span class="tok-nt">&lt;url-pattern&gt;</span>/holamundoadmin<span class="tok-nt">&lt;/url-pattern&gt;</span>
        <span class="tok-nt">&lt;/web-resource-collection&gt;</span>
        <span class="tok-nt">&lt;auth-constraint&gt;</span>
            <span class="tok-nt">&lt;role-name&gt;</span>admin-saludo<span class="tok-nt">&lt;/role-name&gt;</span>
        <span class="tok-nt">&lt;/auth-constraint&gt;</span>
    <span class="tok-nt">&lt;/security-constraint&gt;</span>
    <span class="tok-nt">&lt;login-config&gt;</span>
        <span class="tok-nt">&lt;auth-method&gt;</span>BASIC<span class="tok-nt">&lt;/auth-method&gt;</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-nt">&lt;/login-config&gt;</span>
    <span class="tok-nt">&lt;security-role&gt;</span> <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="tok-nt">&lt;role-name&gt;</span>usuario-saludo<span class="tok-nt">&lt;/role-name&gt;</span>
        <span class="tok-nt">&lt;role-name&gt;</span>admin-saludo<span class="tok-nt">&lt;/role-name&gt;</span>
    <span class="tok-nt">&lt;/security-role&gt;</span>
<span class="tok-nt">&lt;/web-app&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declaración de restricción de seguridad</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>URL del recurso que se restringe</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Tipo de autentificación <code>BASIC</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Declaración de todos los roles que se utilizan en las restricciones</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El usuario se valida cuando accede al servlet y ese rol se propaga en todas las llamadas que éste realiza. En este caso, al acceder a la URL <code>/holamundorestringido</code> se lanza la autenficación y se comprueba que el usuario tiene el rol <code>usuario-saludo</code> para permitirle el acceso al servlet.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_control_de_acceso_basado_en_roles">2.3.4. Control de acceso basado en roles</h4>
<div class="paragraph">
<p>En la arquitectura Enterprise JavaBeans, la identidad de seguridad se representa por un objeto <code>java.security.Principal</code>. Este objeto actúa como representante de usuarios, grupos, organizaciones, tarjetas inteligentes, etc. frente a la arquitectura de control de acceso de los enterprise beans.</p>
</div>
<div class="paragraph">
<p>Los descriptores del despliegue y las anotaciones en Java EE 5.0 incluyen elementos que declaran a qué roles lógicos se permite el acceso a los métodos de los enterprise beans. Estos roles se consideran lógicos porque no reflejan directamente usuarios, grupos o cualquier otra identidad de seguridad en un entorno operacional específico. Los roles se hacen corresponder con grupos de usuarios o usuarios del mundo real cuando el bean se despliega. Esto permite que el bean sea portable ya que cada vez que el bean se despliega en un nuevo sistema, los roles se asignan a usuarios y grupos específicos de ese entorno operacional.</p>
</div>
<div class="sect4">
<h5 id="_definición_de_roles_con_anotaciones">Definición de roles con anotaciones</h5>
<div class="paragraph">
<p>Para declarar los roles con permiso de acceso a los métodos de un bean primero se utiliza la anotación <code>@DeclareRoles</code> en la que se declaran todos los roles que accederán a distintos métodos del bean. Después podemos especificar para cada uno de los métodos qué roles están autorizados con la anotación <code>@RolesAllowed</code>. Si ponemos esta anotación a nivel de clase, se aplica a todos los métodos de la clase.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, en el siguiente código se declaran los roles <code>Admin</code>, <code>Bibliotecario</code> y <code>Socio</code> y se definen los permisos de acceso a los métodos.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Stateless</span>
   <span class="tok-nd">@DeclareRoles</span><span class="tok-o">({</span><span class="tok-s">&quot;Admin&quot;</span><span class="tok-o">,</span><span class="tok-s">&quot;Bibliotecario&quot;</span><span class="tok-o">,</span><span class="tok-s">&quot;Socio&quot;</span><span class="tok-o">})</span>
   <span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">OperacionBOBean</span> <span class="tok-kd">implements</span> <span class="tok-n">OperacionBOLocal</span> <span class="tok-o">{</span>
   <span class="tok-c1">// ...</span>

   <span class="tok-nd">@RolesAllowed</span><span class="tok-o">(</span><span class="tok-s">&quot;Admin&quot;</span><span class="tok-o">)</span>
   <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">borraOperacion</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">idOperacion</span><span class="tok-o">)</span> <span class="tok-o">{</span>
   <span class="tok-c1">// ...</span>
   <span class="tok-o">}</span>

   <span class="tok-nd">@RolesAllowed</span><span class="tok-o">({</span><span class="tok-s">&quot;Admin&quot;</span><span class="tok-o">,</span><span class="tok-s">&quot;Bibliotecario&quot;</span><span class="tok-o">})</span>
   <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">realizaReserva</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">idUsuario</span><span class="tok-o">,</span> <span class="tok-n">String</span> <span class="tok-n">idLibro</span><span class="tok-o">)</span> <span class="tok-o">{</span>
   <span class="tok-c1">// ...</span>
   <span class="tok-o">}</span>

   <span class="tok-nd">@RolesAllowed</span><span class="tok-o">({</span><span class="tok-s">&quot;Admin&quot;</span><span class="tok-o">,</span><span class="tok-s">&quot;Bibliotecario&quot;</span><span class="tok-o">})</span>
   <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">realizaPrestamo</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">login</span><span class="tok-o">,</span> <span class="tok-n">String</span> <span class="tok-n">isbn</span><span class="tok-o">)</span> <span class="tok-o">{</span>   <span class="tok-o">}</span>

   <span class="tok-c1">// ...</span>

   <span class="tok-nd">@PermitAll</span>
   <span class="tok-kd">public</span> <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">OperacionTO</span><span class="tok-o">&gt;</span> <span class="tok-nf">listadoTodosLibros</span><span class="tok-o">()</span> <span class="tok-o">{</span>   <span class="tok-o">}</span>

<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La anotación <code>@PermitAll</code> declara que todos los roles tienen acceso al método.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_la_identidad_de_seguridad_runas">2.3.5. La identidad de seguridad runAs</h4>
<div class="paragraph">
<p>Mientras que las anotaciones <code>@RolesAllowed</code> y los elementos <code>method-permission</code> especifican qué roles tienen acceso a qué métodos del bean, la anotación <code>@RunAs</code> y el elemento <code>security-identity</code> especifica bajo qué rol se ejecuta el bean, usando el elemento <code>runAs</code>. En otras palabras, el objeto rol que se define en <code>runAs</code> se usa como la identidad del enterprise bean cuando éste intenta invocar métodos en otros beans. Esta identidad no tiene por qué ser la misma que la identidad que accede al bean por primera vez.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, la siguiente anotación declara que todos los métodos del bean <code>EmployeeService</code> siempre se van a ejecutar con la identidad <code>admin</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@RunAs</span><span class="tok-o">(</span><span class="tok-s">&quot;admin&quot;</span><span class="tok-o">)</span>
<span class="tok-nd">@Stateless</span> <span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">EmployeeServiceBean</span> <span class="tok-kd">implements</span> <span class="tok-n">EmployeeService</span> <span class="tok-o">{</span>
<span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Esta clase de configuración es útil cuando el enterprise bean o los recursos accedidos en el cuerpo del método requieren un rol distinto del que ha sido usado para obtener acceso al método. Por ejemplo, el método <code>create()</code> podría llamar a un método en el enterprise bean X que requiera la identidad de seguridad de <code>Administrador</code>.</p>
</div>
<div class="paragraph">
<p>Podemos entender la secuencia de cambio de identidades de la siguiente forma:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>El cliente invoca un método del bean con una identidad <code>Id1</code>.</p>
</li>
<li>
<p>El bean comprueba si la identidad <code>Id1</code> tiene permiso para ejecutar el método. La tiene.</p>
</li>
<li>
<p>El bean consulta el elemento <code>security-identity</code> y cambia la identidad a la que indica ese elemento. Supongamos que es la identidad <code>Id2</code>.</p>
</li>
<li>
<p>El bean realiza las llamadas dentro del método con la identidad <code>Id2</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Es obligado resaltar que hay que usar con precaución esta funcionalidad, ya que con ella podemos atribuir cualquier rol a cualquier usuario.</p>
</div>
<div class="paragraph">
<p>Una limitación de la funcionalidad es que es obligado definir un único rol para todos los métodos.</p>
</div>
</div>
<div class="sect3">
<h4 id="_gestión_de_seguridad_programativa_en_el_enterprise_bean">2.3.6. Gestión de seguridad programativa en el enterprise bean</h4>
<div class="paragraph">
<p>En el código del enterprise bean es posible comprobar qué usuario o grupo ha realizado la llamada al bean y si tiene un determinado rol asociado. Para ello se usan los siguientes métodos del <code>SessionContext</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Principal getCallerPrincipal()</code>: devuelve el objeto <code>Principal</code> asociado al usuario o grupo que ha llamado al método.</p>
</li>
<li>
<p><code>Boolean isCallerInRole(String rol)</code>: devuelve <code>true</code> o <code>false</code> dependiendo de si el usuario o grupo que ha llamado al método pertenece al rol que se le pasa como parámetro.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>El objeto <code>SessionContext</code> se obtiene declarando el método <code>setSessionContext(SessionContext ctx)</code> del ciclo de vida del bean y guardando el contexto en una variable de instancia del bean. El contenedor EJB llamará a este método en el momento de creación del enterprise bean.</p>
</div>
<div class="paragraph">
<p>Un ejemplo de código en el que se utilizan estos métodos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Stateless</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">MiBean</span> <span class="tok-kd">implements</span> <span class="tok-n">SessionBean</span> <span class="tok-o">{</span>

   <span class="tok-nd">@Resource</span>
   <span class="tok-n">SessionContext</span> <span class="tok-n">ctx</span><span class="tok-o">;</span>

   <span class="tok-o">...</span>

   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">miMetodo</span><span class="tok-o">()</span> <span class="tok-o">{</span>
      <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">ctx</span><span class="tok-o">.</span><span class="tok-na">getCallerPrincipal</span><span class="tok-o">().</span><span class="tok-na">getName</span><span class="tok-o">());</span>
      <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">ctx</span><span class="tok-o">.</span><span class="tok-na">isCallerInRole</span><span class="tok-o">(</span><span class="tok-s">&quot;administrador&quot;</span><span class="tok-o">))</span> <span class="tok-o">{</span>
         <span class="tok-c1">//código ejecutado por administradores</span>
         <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;Me llama un administrador&quot;</span><span class="tok-o">);</span>
      <span class="tok-o">}</span>
      <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">ctx</span><span class="tok-o">.</span><span class="tok-na">isCallerInRole</span><span class="tok-o">(</span><span class="tok-s">&quot;bibliotecario&quot;</span><span class="tok-o">)){</span>
         <span class="tok-c1">//código ejecutado por bibliotecarios</span>
         <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;Me llama un bibliotecario&quot;</span><span class="tok-o">);</span>
      <span class="tok-o">}</span>
   <span class="tok-o">}</span>
   <span class="tok-o">...</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios_2">2.4. Ejercicios</h3>
<div class="sect3">
<h4 id="__0_75_puntos_ciclo_de_vidad_de_bean_con_estado">2.4.1. (0,75 puntos) Ciclo de vidad de bean con estado</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Comprueba el funcionamiento de un bean con estado creando una versión con estado del bean Calculadora llamada <code>CalculadoraConEstado</code>. Escribe un servlet que compruebe su uso accesible desde la página web principal y un test Arquillian.</p>
</li>
<li>
<p>Comprueba el funcionamiento del ciclo de vida del bean con estado añadiendo métodos con las anotaciones del ciclo de vida que escriban algún mensaje por la salida estándar. Comprueba que el funcionamiento del ciclo de vida es el indicado en los apuntes. Escribe la explicación en un fichero <code>respuestas.txt</code> en la raíz del repositorio.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="__0_75_puntos_acceso_seguro_a_un_método">2.4.2. (0,75 puntos) Acceso seguro a un método</h4>
<div class="paragraph">
<p>En esta sesión debes probar el registro de usuarios para que puedan acceder al método seguro <code>SaludaRestringido</code> del enterprise bean <code>SaludoRestringidoServicio</code>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Usando el comando <code>add-user.sh</code> añade en el servidor un usuario con el rol <code>usuario-servicio</code>.</p>
</li>
<li>
<p>Configura correctamente la seguridad en el <code>web.xml</code> y en el bean para que el acceso al servlet <code>HolaMundoRestringidoServlet</code> y al bean esté limitado sólo a un usuario con este rol.</p>
</li>
<li>
<p>Escribe otro bean llamado <code>SaludoRestringidoProgServicio</code> en el que pruebes la seguridad programativa.</p>
</li>
<li>
<p>Comprueba el correcto funcionamiento y escribe los resultados en el fichero <code>respuestas.txt</code>.</p>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion03">3. Enterprise beans y JPA</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Veremos en este apartado cómo se gestionan las transacciones y el contexto de persistencia (entity manager) con beans de sesión.</p>
</div>
<div class="sect2">
<h3 id="_proyecto_básico_jpa">3.1. Proyecto básico JPA</h3>
<div class="paragraph">
<p>Vamos a retomar el ejemplo básico con el que terminamos la sesión de JPA, en el que definimos una aplicación web con las entidades <code>Autor</code> y <code>Mensaje</code> y una relación uno-a-muchos entre ellas. Nos vamos a olvidar por el momento de los DAOs y vamos a trabajar directamente con las entidades.</p>
</div>
<div class="paragraph">
<p>Por simplificar, vamos a colocar todas las clases de entidad en el paquete <code>org.expertojava.ejb</code>:</p>
</div>
<div class="listingblock">
<div class="title">Autor.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">ejb</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.HashSet</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.Set</span><span class="tok-o">;</span>

<span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Autor</span> <span class="tok-o">{</span>
    <span class="tok-nd">@Id</span>
    <span class="tok-nd">@GeneratedValue</span>
    <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s">&quot;autor_id&quot;</span><span class="tok-o">)</span>
    <span class="tok-n">Long</span> <span class="tok-n">id</span><span class="tok-o">;</span>
    <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;email&quot;</span><span class="tok-o">,</span> <span class="tok-n">nullable</span> <span class="tok-o">=</span> <span class="tok-kc">false</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">correo</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
    <span class="tok-nd">@OneToMany</span><span class="tok-o">(</span><span class="tok-n">mappedBy</span> <span class="tok-o">=</span> <span class="tok-s">&quot;autor&quot;</span><span class="tok-o">,</span> <span class="tok-n">cascade</span> <span class="tok-o">=</span> <span class="tok-n">CascadeType</span><span class="tok-o">.</span><span class="tok-na">ALL</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Mensaje</span><span class="tok-o">&gt;</span> <span class="tok-n">mensajes</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">HashSet</span><span class="tok-o">&lt;</span><span class="tok-n">Mensaje</span><span class="tok-o">&gt;();</span>

    <span class="tok-kd">public</span> <span class="tok-n">Long</span> <span class="tok-nf">getId</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">id</span><span class="tok-o">;</span> <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getCorreo</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">correo</span><span class="tok-o">;</span> <span class="tok-o">}</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setCorreo</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">correo</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">correo</span> <span class="tok-o">=</span> <span class="tok-n">correo</span><span class="tok-o">;</span> <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getNombre</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">nombre</span><span class="tok-o">;</span> <span class="tok-o">}</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setNombre</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">nombre</span> <span class="tok-o">=</span> <span class="tok-n">nombre</span><span class="tok-o">;</span> <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Mensaje</span><span class="tok-o">&gt;</span> <span class="tok-nf">getMensajes</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">mensajes</span><span class="tok-o">;</span> <span class="tok-o">}</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setMensajes</span><span class="tok-o">(</span><span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Mensaje</span><span class="tok-o">&gt;</span> <span class="tok-n">mensajes</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">mensajes</span> <span class="tok-o">=</span> <span class="tok-n">mensajes</span><span class="tok-o">;</span> <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-nf">Autor</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-nf">Autor</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">,</span> <span class="tok-n">String</span> <span class="tok-n">correo</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">nombre</span> <span class="tok-o">=</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">correo</span> <span class="tok-o">=</span> <span class="tok-n">correo</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-kt">boolean</span> <span class="tok-nf">equals</span><span class="tok-o">(</span><span class="tok-n">Object</span> <span class="tok-n">o</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-k">this</span> <span class="tok-o">==</span> <span class="tok-n">o</span><span class="tok-o">)</span> <span class="tok-k">return</span> <span class="tok-kc">true</span><span class="tok-o">;</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">o</span> <span class="tok-o">==</span> <span class="tok-kc">null</span> <span class="tok-o">||</span> <span class="tok-n">getClass</span><span class="tok-o">()</span> <span class="tok-o">!=</span> <span class="tok-n">o</span><span class="tok-o">.</span><span class="tok-na">getClass</span><span class="tok-o">())</span> <span class="tok-k">return</span> <span class="tok-kc">false</span><span class="tok-o">;</span>

        <span class="tok-n">Autor</span> <span class="tok-n">autor</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-n">Autor</span><span class="tok-o">)</span> <span class="tok-n">o</span><span class="tok-o">;</span>

        <span class="tok-k">if</span> <span class="tok-o">(!</span><span class="tok-n">correo</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">correo</span><span class="tok-o">))</span> <span class="tok-k">return</span> <span class="tok-kc">false</span><span class="tok-o">;</span>
        <span class="tok-k">if</span> <span class="tok-o">(!</span><span class="tok-n">nombre</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">nombre</span><span class="tok-o">))</span> <span class="tok-k">return</span> <span class="tok-kc">false</span><span class="tok-o">;</span>

        <span class="tok-k">return</span> <span class="tok-kc">true</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-kt">int</span> <span class="tok-nf">hashCode</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-kt">int</span> <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-n">correo</span><span class="tok-o">.</span><span class="tok-na">hashCode</span><span class="tok-o">();</span>
        <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-mi">31</span> <span class="tok-o">*</span> <span class="tok-n">result</span> <span class="tok-o">+</span> <span class="tok-n">nombre</span><span class="tok-o">.</span><span class="tok-na">hashCode</span><span class="tok-o">();</span>
        <span class="tok-k">return</span> <span class="tok-n">result</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">toString</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-s">&quot;Autor{&quot;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;id=&quot;</span> <span class="tok-o">+</span> <span class="tok-n">id</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, correo=&#39;&quot;</span> <span class="tok-o">+</span> <span class="tok-n">correo</span> <span class="tok-o">+</span> <span class="tok-sc">&#39;\&#39;&#39;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, nombre=&#39;&quot;</span> <span class="tok-o">+</span> <span class="tok-n">nombre</span> <span class="tok-o">+</span> <span class="tok-sc">&#39;\&#39;&#39;</span> <span class="tok-o">+</span>
                <span class="tok-sc">&#39;}&#39;</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Mensaje.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">ejb</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.Date</span><span class="tok-o">;</span>

<span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Mensaje</span> <span class="tok-o">{</span>

    <span class="tok-nd">@Id</span>
    <span class="tok-nd">@GeneratedValue</span>
    <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s">&quot;mensaje_id&quot;</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">Long</span> <span class="tok-n">id</span><span class="tok-o">;</span>
    <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">nullable</span> <span class="tok-o">=</span> <span class="tok-kc">false</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">texto</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-n">Date</span> <span class="tok-n">fecha</span><span class="tok-o">;</span>
    <span class="tok-nd">@ManyToOne</span>
    <span class="tok-nd">@JoinColumn</span><span class="tok-o">(</span><span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s">&quot;autor&quot;</span><span class="tok-o">,</span> <span class="tok-n">nullable</span> <span class="tok-o">=</span> <span class="tok-kc">false</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">Autor</span> <span class="tok-n">autor</span><span class="tok-o">;</span>

    <span class="tok-kd">public</span> <span class="tok-n">Long</span> <span class="tok-nf">getId</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">id</span><span class="tok-o">;</span> <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getTexto</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">texto</span><span class="tok-o">;</span> <span class="tok-o">}</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setTexto</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">texto</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">texto</span> <span class="tok-o">=</span> <span class="tok-n">texto</span><span class="tok-o">;</span> <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">Date</span> <span class="tok-nf">getFecha</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">fecha</span><span class="tok-o">;</span> <span class="tok-o">}</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setFecha</span><span class="tok-o">(</span><span class="tok-n">Date</span> <span class="tok-n">fecha</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">fecha</span> <span class="tok-o">=</span> <span class="tok-n">fecha</span><span class="tok-o">;</span> <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">Autor</span> <span class="tok-nf">getAutor</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">autor</span><span class="tok-o">;</span> <span class="tok-o">}</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setAutor</span><span class="tok-o">(</span><span class="tok-n">Autor</span> <span class="tok-n">autor</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">autor</span> <span class="tok-o">=</span> <span class="tok-n">autor</span><span class="tok-o">;</span> <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-nf">Mensaje</span><span class="tok-o">()</span> <span class="tok-o">{}</span>

    <span class="tok-kd">public</span> <span class="tok-nf">Mensaje</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">texto</span><span class="tok-o">,</span> <span class="tok-n">Autor</span> <span class="tok-n">autor</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">texto</span> <span class="tok-o">=</span> <span class="tok-n">texto</span><span class="tok-o">;</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">autor</span> <span class="tok-o">=</span> <span class="tok-n">autor</span><span class="tok-o">;</span>
     <span class="tok-o">}</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-kt">boolean</span> <span class="tok-nf">equals</span><span class="tok-o">(</span><span class="tok-n">Object</span> <span class="tok-n">o</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-k">this</span> <span class="tok-o">==</span> <span class="tok-n">o</span><span class="tok-o">)</span> <span class="tok-k">return</span> <span class="tok-kc">true</span><span class="tok-o">;</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">o</span> <span class="tok-o">==</span> <span class="tok-kc">null</span> <span class="tok-o">||</span> <span class="tok-n">getClass</span><span class="tok-o">()</span> <span class="tok-o">!=</span> <span class="tok-n">o</span><span class="tok-o">.</span><span class="tok-na">getClass</span><span class="tok-o">())</span> <span class="tok-k">return</span> <span class="tok-kc">false</span><span class="tok-o">;</span>

        <span class="tok-n">Mensaje</span> <span class="tok-n">mensaje</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-n">Mensaje</span><span class="tok-o">)</span> <span class="tok-n">o</span><span class="tok-o">;</span>

        <span class="tok-k">if</span> <span class="tok-o">(!</span><span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">mensaje</span><span class="tok-o">.</span><span class="tok-na">autor</span><span class="tok-o">))</span> <span class="tok-k">return</span> <span class="tok-kc">false</span><span class="tok-o">;</span>
        <span class="tok-k">if</span> <span class="tok-o">(!</span><span class="tok-n">texto</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">mensaje</span><span class="tok-o">.</span><span class="tok-na">texto</span><span class="tok-o">))</span> <span class="tok-k">return</span> <span class="tok-kc">false</span><span class="tok-o">;</span>

        <span class="tok-k">return</span> <span class="tok-kc">true</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-kt">int</span> <span class="tok-nf">hashCode</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-kt">int</span> <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-n">texto</span><span class="tok-o">.</span><span class="tok-na">hashCode</span><span class="tok-o">();</span>
        <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-mi">31</span> <span class="tok-o">*</span> <span class="tok-n">result</span> <span class="tok-o">+</span> <span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">hashCode</span><span class="tok-o">();</span>
        <span class="tok-k">return</span> <span class="tok-n">result</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">toString</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-s">&quot;Mensaje{&quot;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;id=&quot;</span> <span class="tok-o">+</span> <span class="tok-n">id</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, texto=&#39;&quot;</span> <span class="tok-o">+</span> <span class="tok-n">texto</span> <span class="tok-o">+</span> <span class="tok-sc">&#39;\&#39;&#39;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, fecha=&quot;</span> <span class="tok-o">+</span> <span class="tok-n">fecha</span> <span class="tok-o">+</span>
                <span class="tok-sc">&#39;}&#39;</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El fichero <code>persistence.xml</code> es el siguiente. suponemos que en el servidor de aplicaciones ya está creada la fuente de datos <code>java:/datasources/MensajesDS</code>.</p>
</div>
<div class="listingblock">
<div class="title">META-INF/persistence.xml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tok-nt">&lt;persistence</span> <span class="tok-na">version=</span><span class="tok-s">&quot;2.0&quot;</span>
             <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://java.sun.com/xml/ns/persistence&quot;</span> <span class="tok-na">xmlns:xsi=</span><span class="tok-s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
             <span class="tok-na">xsi:schemaLocation=</span><span class="tok-s">&quot;</span>
<span class="tok-s">        http://java.sun.com/xml/ns/persistence</span>
<span class="tok-s">        http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;persistence-unit</span> <span class="tok-na">name=</span><span class="tok-s">&quot;mensajes&quot;</span><span class="tok-nt">&gt;</span>
        <span class="tok-nt">&lt;jta-data-source&gt;</span>java:/datasources/MensajesDS<span class="tok-nt">&lt;/jta-data-source&gt;</span>
        <span class="tok-nt">&lt;properties&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.hbm2ddl.auto&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;create&quot;</span> <span class="tok-nt">/&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.show_sql&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;true&quot;</span> <span class="tok-nt">/&gt;</span>
        <span class="tok-nt">&lt;/properties&gt;</span>
    <span class="tok-nt">&lt;/persistence-unit&gt;</span>
<span class="tok-nt">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_gestión_de_transacciones_con_beans_de_sesión">3.2. Gestión de transacciones con beans de sesión</h3>
<div class="paragraph">
<p>Los beans de sesión permiten dos tipos de gestión de transacciones, denominados CMP (<em>Container Managed Persistence</em>) y BMP (<em>Bean Managed Persistence</em>).</p>
</div>
<div class="paragraph">
<p>Cuando se utiliza CMP, los beans gestionan de forma automática las transacciones. Toda llamada a un método del bean es interceptada por el contenedor, que crea un contexto transaccional que dura hasta que el método ha terminado (con éxito o con fracaso, al lanzar una excepción). Si el método 	termina con éxito el contenedor hace un commit de la transacción. Si el método lanza una excepción el contenedor hace un rollback.</p>
</div>
<div class="paragraph">
<p>Cuando se utiliza BMP es el programador el que debe abrir y cerrar las transacciones utilizando JTA de forma explícita el código de los métodos del bean.</p>
</div>
<div class="paragraph">
<p>Ambos enfoques se basan en JTA, que es utilizado por el servidor de aplicaciones para gestionar las transacciones distribuidas utilizando el algoritmo <em>two phase commit</em>. Los recursos que participan en estas transacciones deben ser fuentes de datos XA.</p>
</div>
<div class="paragraph">
<p>Un uso muy común de los beans de sesión es la implementación de	la capa de negocio de la aplicación, definiendo métodos de servicio transaccionales. En cada método de servicio se realizan llamadas a la capa de persistencia definida por los DAO que gestionan las entidades del modelo. Los DAO utilizan entity managers inyectados por el contenedor. El contenedor se encarga automáticamente de inyectar el mismo entity manager en todos los DAO que participan en la misma transacción, de forma que todos los DAO van a compartir el mismo contexto de persistencia. Se libera a los DAO de la gestión de transacciones y su implementación se hace más sencilla y flexible.</p>
</div>
<div class="paragraph">
<p>Al utilizar JTA es posible llamar desde un método de servicio a otros servicios de la capa de negocio y englobar todo ello en una única transacción.</p>
</div>
<div class="sect3">
<h4 id="_gestión_de_transacciones_bmt">3.2.1. Gestión de transacciones BMT</h4>
<div class="paragraph">
<p>En la gestión de transacciones denominada BMT (<em>Bean Managed Transactions</em>) el programador se hace cargo de la gestión de transacciones dentro de los métodos de los beans utilizando JTA. Ya hemos visto anteriormente un ejemplo cuando describimos JTA:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Stateless</span>
<span class="tok-nd">@TransactionManagement</span><span class="tok-o">(</span><span class="tok-n">TransactionManagementType</span><span class="tok-o">.</span><span class="tok-na">BEAN</span><span class="tok-o">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">PedidoService</span> <span class="tok-o">{</span>
   <span class="tok-nd">@Resource</span>
   <span class="tok-kd">private</span> <span class="tok-n">UserTransaction</span> <span class="tok-n">userTransaction</span><span class="tok-o">;</span> <i class="conum" data-value="2"></i><b>(2)</b>

   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">hacerPedido</span><span class="tok-o">(</span><span class="tok-n">Item</span> <span class="tok-n">item</span><span class="tok-o">,</span> <span class="tok-n">Cliente</span> <span class="tok-n">cliente</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-k">try</span> <span class="tok-o">{</span>
         <span class="tok-n">userTransaction</span><span class="tok-o">.</span><span class="tok-na">begin</span><span class="tok-o">();</span> <i class="conum" data-value="3"></i><b>(3)</b>
         <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">itemService</span><span class="tok-o">.</span><span class="tok-na">disponible</span><span class="tok-o">(</span><span class="tok-n">item</span><span class="tok-o">))</span> <span class="tok-o">{</span>
            <span class="tok-n">pedidoService</span><span class="tok-o">.</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-n">cliente</span><span class="tok-o">,</span><span class="tok-n">item</span><span class="tok-o">);</span>
            <span class="tok-n">clienteService</span><span class="tok-o">.</span><span class="tok-na">anotaCargo</span><span class="tok-o">(</span><span class="tok-n">cliente</span><span class="tok-o">,</span><span class="tok-n">item</span><span class="tok-o">);</span>
            <span class="tok-n">itemService</span><span class="tok-o">.</span><span class="tok-na">empaqueta</span><span class="tok-o">(</span><span class="tok-n">cliente</span><span class="tok-o">,</span><span class="tok-n">item</span><span class="tok-o">);</span>
         <span class="tok-o">}</span>
         <span class="tok-n">userTransaction</span><span class="tok-o">.</span><span class="tok-na">commit</span><span class="tok-o">();</span>
      <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">Exception</span> <span class="tok-n">e</span><span class="tok-o">)</span> <span class="tok-o">{</span> <i class="conum" data-value="4"></i><b>(4)</b>
         <span class="tok-n">userTransaction</span><span class="tok-o">.</span><span class="tok-na">rollback</span><span class="tok-o">();</span>
         <span class="tok-n">e</span><span class="tok-o">.</span><span class="tok-na">printStackTrace</span><span class="tok-o">();</span>
      <span class="tok-o">}</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Se declara el tipo de gestión de transacción como BMT, para lo que se define el valor <code>TransactionManagementType.BEAN</code> como tipo de la anotación <code>@TransactionManagement</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Se declara el recurso <code>UserTransaction</code> que vamos a utilizar para controlar la transacción mediante JTA. Se define utilizando inyección de dependencias.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Se inicia la transacción. Las siguientes líneas de código definen las llamadas a los métodos transaccionales de otros beans de sesión. En estos métodos se utilizan conexiones XA que participan en la transacción definida en el bean.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Si alguna de estas llamadas genera una excepción, ésta se recoge y se llama a <code>userTransaction.rollback()</code>, con lo que automáticamente se deshace la transacción y todos los recursos implicados en la transacción vuelven a su estado original.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En el caso en que todas las llamadas terminen correctamente, se realiza la llamada <code>userTransaction.commit();</code> que la transacción y final se propaga a todos los recursos que intervienen en la transacción.</p>
</div>
<div class="paragraph">
<p>Vemos que el funcionamiento es idéntico al que hemos definido cuando hemos hablado de JTA. Todas las llamadas a los beans de sesión se incorporan a la misma transacción, <em>sin modificar el código de los métodos</em>. De esta forma no perdemos flexibilidad en los métodos de negocio, siguen siendo atómicos, se pueden utilizar de forma independiente y, además, pueden incorporarse distintas llamadas a la misma transacción.</p>
</div>
<div class="paragraph">
<p>Un problema de BMT es que no se puede unir una	transacción definida en un método a una transacción ya abierta por el llamador. De esta forma, si el método anterior es llamado desde un cliente que tiene una transacción JTA abierta, esta transacción del llamador se suspende. JTA no permite transacciones anidadas. De la misma forma, los métodos dentro de la transacción definida en el bean (<code>pedidoBean.add()</code> y demás) no pueden a su vez abrir una nueva transacción con BMT, ya que estaríamos en el mismo caso que el que hemos mencionado, abriendo una transacción anidad. En el siguiente apartado veremos que la gestión de transacciones por el contenedor (CMT, <em>Containter Managed Transaction</em>) proporciona más flexibilidad, ya que, por ejemplo, permite que los métodos de los beans se incorporen a transacciones ya abiertas.</p>
</div>
</div>
<div class="sect3">
<h4 id="_gestión_de_transacciones_cmt">3.2.2. Gestión de transacciones CMT</h4>
<div class="paragraph">
<p>Cuando verdaderamente aprovechamos todas las funcionalidades del contenedor EJB es cuando utilizamos el otro enfoque de la gestión de las transacciones en los enterprise beans, el llamado CMT (<em>Container Managed Transactions</em>). Aquí, el programador no tiene que escribir explícitamente ninguna instrucción para definir el alcance de la transacción, sino que es el contenedor EJB el que la maneja automáticamente. En este enfoque, los métodos de negocio de los beans se anotan y podemos configurar con anotaciones cómo se van a comportar. Veamos cómo definiríamos con CMT el mismo ejemplo anterior.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Stateless</span>
<span class="tok-nd">@TransactionManagement</span><span class="tok-o">(</span><span class="tok-n">TransactionManagementType</span><span class="tok-o">.</span><span class="tok-na">CONTAINER</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">PedidoService</span> <span class="tok-o">{</span>

   <span class="tok-nd">@TransactionAttribute</span><span class="tok-o">(</span><span class="tok-n">TransactionAttributeType</span><span class="tok-o">.</span><span class="tok-na">REQUIRED</span><span class="tok-o">)</span>
   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">hacerPedido</span><span class="tok-o">(</span><span class="tok-n">Item</span> <span class="tok-n">item</span><span class="tok-o">,</span> <span class="tok-n">Cliente</span> <span class="tok-n">cliente</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">itemService</span><span class="tok-o">.</span><span class="tok-na">disponible</span><span class="tok-o">(</span><span class="tok-n">item</span><span class="tok-o">))</span> <span class="tok-o">{</span>
         <span class="tok-n">pedidoService</span><span class="tok-o">.</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-n">cliente</span><span class="tok-o">,</span><span class="tok-n">item</span><span class="tok-o">);</span>
         <span class="tok-n">clienteService</span><span class="tok-o">.</span><span class="tok-na">anotaCargo</span><span class="tok-o">(</span><span class="tok-n">cliente</span><span class="tok-o">,</span><span class="tok-n">item</span><span class="tok-o">);</span>
         <span class="tok-n">itemService</span><span class="tok-o">.</span><span class="tok-na">empaqueta</span><span class="tok-o">(</span><span class="tok-n">cliente</span><span class="tok-o">,</span><span class="tok-n">item</span><span class="tok-o">);</span>
      <span class="tok-o">}</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Definimos en la clase el tipo de gestión de transacciones como <code>TransactionManagementType.CONTAINER</code>. El contenedor se encarga de la gestión de las transacciones del bean. Nosotros sólo 	debemos indicar en cada método qué tipo de gestión de transacción se debe hacer. En el método <code>hacerPedido</code> lo hemos definido como <code>REQUIRED</code> usando la anotación	<code>@TransactionAttribute</code>.</p>
</div>
<div class="paragraph">
<p>La anotación <code>@TransactionAttribute</code> se puede realizar a nivel de método o a nivel de clase. En este último caso todos los métodos de la clase se comportan de la forma especificada.</p>
</div>
<div class="paragraph">
<p>El tipo de atributo de transacción REQUIRED obliga a que el método se ejecute dentro de una transacción. En el caso en que el llamador del método haya abierto ya una transacción, el contenedor ejecuta este método en el ámbito de esa transacción. En el caso en que el llamador no haya definido ninguna transacción, el contenedor inicia automáticamente una transacción nueva.</p>
</div>
<div class="paragraph">
<p>El tipo de atributo de transacción REQUIRED es el que tienen por defecto todos los métodos de los componentes EJB. Por eso se dice que son componentes transaccionales.</p>
</div>
<div class="paragraph">
<p>Todas las llamadas a otros métodos desde el bean se ejecutan en una transacción. Estas llamadas pueden ser a la capa de persistencia o a otros métodos de negocio.</p>
</div>
<div class="paragraph">
<p>Si el método no termina normalmente, sino que lanza una excepción de tipo <code>RuntimeException</code> (porque la lanza él mismo o alguna de las llamadas realizadas) se realiza automáticamente un rollback de la transacción. El contenedor captura la excepción provocada por el método y llama a JTA para realizar un rollback.</p>
</div>
<div class="paragraph">
<p>Si se lanza una excepción chequeada que no es de tipo <code>RuntimeException</code> el rollback no se realiza automáticamente. En este caso hay que llamar al método <code>setRollbackOnly</code> del <code>EJBContext</code> que se puede	obtener por inyección de dependencias:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Stateless</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">PeliculaService</span> <span class="tok-o">{</span>
   <span class="tok-nd">@Resource</span>
   <span class="tok-kd">private</span> <span class="tok-n">EJBContext</span> <span class="tok-n">context</span><span class="tok-o">;</span>

   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">metodoTransaccional</span><span class="tok-o">()</span> <span class="tok-kd">throws</span> <span class="tok-n">AlgunaExcepcionChequeada</span> <span class="tok-o">{</span>

      <span class="tok-c1">// Llamadas a otros métodos</span>

      <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">seHaProducidoError</span><span class="tok-o">)</span> <span class="tok-o">{</span>
         <span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-na">setRollbackOnly</span><span class="tok-o">();</span>
         <span class="tok-k">throw</span> <span class="tok-k">new</span> <span class="tok-nf">AlgunaExcepcionChequeada</span><span class="tok-o">(</span><span class="tok-s">&quot;Se ha producido un error&quot;</span><span class="tok-o">);</span>
      <span class="tok-o">}</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si el método del bean termina normalmente, el contenedor hace commit de la transacción.</p>
</div>
<div class="paragraph">
<p>El código resultante es muy sencillo ya toda la gestión de la transacción se realiza de forma implícita. En el código sólo aparece la lógica de negocio.</p>
</div>
<div class="paragraph">
<p>La utilización de las transacciones CMT tiene la ventaja añadida de que los métodos pueden participar en transacciones abiertas en otros métodos.</p>
</div>
<div class="sect4">
<h5 id="_propagación_de_transacciones">Propagación de transacciones</h5>
<div class="paragraph">
<p>Existen seis posibles formas de propagar una transacción, definidas por los posibles tipos de atributos de transacción:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>TransactionAttributeType.REQUIRED</code></p>
</li>
<li>
<p><code>TransactionAttributeType.REQUIRES_NEW</code></p>
</li>
<li>
<p><code>TransactionAttributeType.SUPPPORTS</code></p>
</li>
<li>
<p><code>TransactionAttributeType.MANDATORY</code></p>
</li>
<li>
<p><code>TransactionAttributeType.NOT_SUPPORTED</code></p>
</li>
<li>
<p><code>TransactionAttributeType.NEVER</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>El funcionamiento de cada tipo de gestión depende de si el llamador del método hace la llamada con una transacción ya abierta o no. Vamos a ver un ejemplo. Supongamos que los métodos a los que se llama	en <code>hacerPedido()</code> no son métodos de un DAO (un POJO), sino que se tratan de métodos de negocio de otros EJBs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Stateless</span>
<span class="tok-nd">@TransactionManagement</span><span class="tok-o">(</span><span class="tok-n">TransactionManagementType</span><span class="tok-o">.</span><span class="tok-na">CONTAINER</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">PedidoEJB</span> <span class="tok-kd">implements</span> <span class="tok-n">PedidoLocal</span> <span class="tok-o">{</span>
   <span class="tok-nd">@Resource</span>
   <span class="tok-kd">private</span> <span class="tok-n">SessionContext</span> <span class="tok-n">context</span><span class="tok-o">;</span>

   <span class="tok-nd">@TransactionAttribute</span><span class="tok-o">(</span><span class="tok-n">TransactionAttributeType</span><span class="tok-o">.</span><span class="tok-na">REQUIRED</span><span class="tok-o">)</span>
   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">hacerPedido</span><span class="tok-o">(</span><span class="tok-n">Item</span> <span class="tok-n">item</span><span class="tok-o">,</span> <span class="tok-n">Cliente</span> <span class="tok-n">cliente</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-k">try</span> <span class="tok-o">{</span>
         <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">itemEJB</span><span class="tok-o">.</span><span class="tok-na">disponible</span><span class="tok-o">(</span><span class="tok-n">item</span><span class="tok-o">))</span> <span class="tok-o">{</span>
            <span class="tok-n">pedidoEJB</span><span class="tok-o">.</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-n">cliente</span><span class="tok-o">,</span><span class="tok-n">item</span><span class="tok-o">);</span>
            <span class="tok-n">clienteEJB</span><span class="tok-o">.</span><span class="tok-na">anotaCargo</span><span class="tok-o">(</span><span class="tok-n">cliente</span><span class="tok-o">,</span><span class="tok-n">item</span><span class="tok-o">);</span>
            <span class="tok-n">itemEJB</span><span class="tok-o">.</span><span class="tok-na">empaqueta</span><span class="tok-o">(</span><span class="tok-n">cliente</span><span class="tok-o">,</span><span class="tok-n">item</span><span class="tok-o">);</span>
         <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">Exception</span> <span class="tok-n">e</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-na">setRollbackOnly</span><span class="tok-o">();</span>
         <span class="tok-o">}</span>
      <span class="tok-o">}</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En este caso tenemos una situación como la que se muestra en la	siguiente figura, en la que un método de negocio de un EJB llama a otro método de negocio. ¿Cómo van a gestionar la transacción los métodos llamados? Va a depender de qué tipo de <code>@TransactionAttribute</code> se hayan definido en los métodos.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="imagenes/ejb/transacciones01.png" alt="" width="50%">
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>REQUIRED</code></dt>
<dd>
<p>se trata del tipo de gestión de transacciones por defecto. Si no declaramos el tipo en el método (ni en el bean) éste es el que se aplica. El código del método siempre debe estar en una transacción. Si el llamador realiza la llamada al método dentro de una transacción, el método participa en	ella y se une a la transacción. En el caso de que el llamador no haya definido ninguna transacción, se crea una nueva que finaliza al terminar el método.</p>
<div class="paragraph">
<p>Si la transacción falla en el método y éste participa en una transacción definida en el cliente, el contenedor deshará la transacción en el método y devolverá al cliente la excepción <code>javax.transaction.RollbackException</code>, para que el cliente obre en consecuencia.</p>
</div>
<div class="paragraph">
<p>Si el método termina sin que se genere ninguna excepción y la transacción es nueva (el llamador no había definido ninguna), el contenedor hace un commit de la transacción. En el caso en que el método participe en una transacción abierta en el cliente, será éste el que deberá hacer el commit.</p>
</div>
</dd>
<dt class="hdlist1"><code>REQUIRES_NEW</code></dt>
<dd>
<p>indica que el contenedor debe crear siempre una transacción nueva al comienzo del método, independientemente de si el cliente ha llamado al método con una transacción creada o no. La transacción en el llamador  (si existe) queda suspendida hasta que la llamada termina. Además, el método llamado no participa	en la transacción del llamador. El método llamado tiene su propia transacción y realiza un commit cuando termina. Si la transacción en el cliente falla después, el rollback ya no afecta al método terminado.</p>
<div class="paragraph">
<p>Un ejemplo de uso de este atributo es una llamada a un método para escribir logs. Si hay un error en la escritura del log, no queremos que se propague al llamador. Por otro lado, si el llamador falla queremos que quede constancia de ello.</p>
</div>
</dd>
<dt class="hdlist1"><code>SUPPORTS</code></dt>
<dd>
<p>el método hereda el estado transaccional del llamador. Si el llamador define una transacción, el método participa en ella. Si no, el método no se ejecuta en ninguna transacción. Suele utilizarse cuando el bean realiza operaciones de lectura que no modifican el estado de sus recursos transaccionales.</p>
</dd>
<dt class="hdlist1"><code>MANDATORY</code></dt>
<dd>
<p>el cliente debe	obligatoriamente crear una transacción antes de llamar a este método. Si se llama al método desde un entorno en el que no se ha abierto una transacción, se genera una excepción. Se usa muy raramente.</p>
</dd>
<dt class="hdlist1"><code>NOT_SUPPORTED</code></dt>
<dd>
<p>el método se ejecuta sin crear una transacción. En el caso en que el llamador haya creado una, ésta se suspende, se ejecuta el método y después continua. Para el cliente el comportamiento es igual que <code>REQUIRES_NEW</code>. La diferencia es que en el bean no se ha creado ninguna transacción.</p>
<div class="paragraph">
<p>Se suele usar sólo por MDB soportando un proveedor JMS no transaccional</p>
</div>
</dd>
<dt class="hdlist1"><code>NEVER</code></dt>
<dd>
<p>se genera una excepción si el cliente invoca el método habiendo creado una transacción. No se usa casi nunca.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_gestión_de_la_transacción_con_la_interfaz_usertransaction">3.2.3. Gestión de la transacción con la interfaz UserTransaction</h4>
<div class="paragraph">
<p>Para gestionar una transacción JTA de forma programativa deberemos en primer lugar obtener del servidor de aplicaciones el objeto <code>javax.transacion.UserTransaction</code>. La forma más sencilla de hacerlo es mediante inyección de dependencias, declarándolo con la anotación:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Resource</span>
<span class="tok-n">UserTransaction</span> <span class="tok-n">utx</span><span class="tok-o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Una vez obtenido el <code>UserTransaction</code> podemos llamar a los métodos de la interfaz para demarcar la transacción:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>public void begin()</code></p>
</li>
<li>
<p><code>public void commit()</code></p>
</li>
<li>
<p><code>public void rollback()</code></p>
</li>
<li>
<p><code>public int getStatus()</code></p>
</li>
<li>
<p><code>public void setRollbackOnly()</code></p>
</li>
<li>
<p><code>public void setTransactionTimeout(int segundos)</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Para comenzar una transacción la aplicación se debe llamar a <code>begin()</code>. Para finalizarla, la transacción debe llamar o bien a <code>commit()</code> o bien a <code>rollback()</code>.</p>
</div>
<div class="paragraph">
<p>El método <code>setRollbackOnly()</code> modifica la transacción actual de forma que el único resultado posible de la misma sea de roll back (falllo).</p>
</div>
<div class="paragraph">
<p>El método <code>setTransactionTimeout(int segundos)</code> permite modificar el timeout asociado con la transacción actual. El parámetro 	determina la duración del timeout en segundos. Si se le pasa como valor cero, el timeout de la transacción es el definido por defecto.</p>
</div>
<div class="paragraph">
<p>El siguiente ejemplo simplificado muestra un fragmento de código que utiliza transacciones JTA. En el ejemplo mostramos un fragmento de código en el que un usuario de una biblioteca devuelve tarde un préstamo y se le anota una multa</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">UserTransaction</span> <span class="tok-n">tx</span><span class="tok-o">;</span>

<span class="tok-c1">//...</span>
<span class="tok-c1">// Obtenemos el UserTransaction</span>
<span class="tok-c1">// y lo guardamos en tx</span>
<span class="tok-c1">//...</span>

<span class="tok-n">tx</span><span class="tok-o">.</span><span class="tok-na">begin</span><span class="tok-o">();</span>
<span class="tok-k">try</span> <span class="tok-o">{</span>
   <span class="tok-n">operacionService</span><span class="tok-o">.</span><span class="tok-na">devolverEjemplar</span><span class="tok-o">(</span><span class="tok-n">ejemplar</span><span class="tok-o">);</span>
   <span class="tok-n">usuarioService</span><span class="tok-o">.</span><span class="tok-na">multar</span><span class="tok-o">(</span><span class="tok-n">login</span><span class="tok-o">,</span> <span class="tok-n">fechaDevolucionPrevista</span><span class="tok-o">,</span>
                         <span class="tok-n">fechaDevolucionReal</span><span class="tok-o">);</span>
   <span class="tok-n">tx</span><span class="tok-o">.</span><span class="tok-na">commit</span><span class="tok-o">();</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">Exception</span> <span class="tok-n">e</span><span class="tok-o">)</span> <span class="tok-o">{</span>
   <span class="tok-n">tx</span><span class="tok-o">.</span><span class="tok-na">rollback</span><span class="tok-o">();</span>
   <span class="tok-k">throw</span> <span class="tok-k">new</span> <span class="tok-nf">BusinessException</span><span class="tok-o">(</span><span class="tok-s">&quot;Error al hacer la devolución&quot;</span><span class="tok-o">,</span> <span class="tok-n">e</span><span class="tok-o">);</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Los objetos <code>operacionService</code> y <code>usuarioService</code> son beans de sesión sin estado y los métodos <code>devolverEjemplar</code> y <code>multar</code> son métodos atómicos. Cada uno de ellos crea su  propia transacción. JTA nos permite incorporar ambas llamadas en una única transacción, de forma que si uno de los métodos devuelve algún error se deshace toda la operación.</p>
</div>
<div class="paragraph">
<p>El código anterior puede ejecutarse en cualquier componente gestionado por el contenedor, como por ejemplo un servlet. También puede incluirse en un bean que define un servicio componiendo llamadas a otros servicios.</p>
</div>
<div class="paragraph">
<p>La otra forma de gestionar transacciones es gestionándolas de forma declarativa con anotaciones en los EJBs. Lo veremos más adelante.</p>
</div>
</div>
<div class="sect3">
<h4 id="_transacciones_a_través_de_múltiples_bases_de_datos">3.2.4. Transacciones a través de múltiples bases de datos</h4>
<div class="paragraph">
<p>Una de las características interesantes de JTA es que permite gestionar transacciones distribuidas que afectan a distintas bases de datos. Podemos utilizar distintas unidades de persistencia en los beans y agruparlas en una misma transacción. Las siguientes figuran muestran dos posibles escenarios:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="imagenes/ejb/transacciones02.png" alt="" width="50%">
</div>
</div>
<div class="paragraph">
<p>En la figura anterior, el cliente invoca un método de negocio en el Bean-A. El método de negocio inicia una transacción, actualiza la base de datos X, actualiza la base de datos Y e invoca un método de negocio en el Bean-B. El segundo método de negocio actualiza la base de datos Z y devuelve el control al método de negocio en el Bean-A, que finaliza con éxito la transacción. Las tres actualizaciones de la base de datos ocurren en la misma transacción.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="imagenes/ejb/transacciones03.png" alt="" width="50%">
</div>
</div>
<div class="paragraph">
<p>En la figura anterior, el cliente llama a un método de negocio en el Bean-A, que comienza una transacción y actualiza la base de datos 	X. Luego el Bean-A invoca un segundo método de negocio en el Bean-B, que reside en un servidor de aplicaciones remoto. El método en el Bean-B actualiza la base de datos Y. La gestión de transacciones de ambos servidores de aplicaciones se asegura de que ambas actualizaciones se realizan en la misma transacción. Es un ejemplo de una transacción distribuida a nivel de servidores de aplicaciones.</p>
</div>
<div class="paragraph">
<p>Para este segundo ejemplo necesitamos un servidor de aplicaciones compatible con la especificación completa de Java EE 6. No basta con un servidor compatible con el perfil Web.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_entity_manager_y_contexto_de_persistencia_en_los_beans">3.3. Entity manager y contexto de persistencia en los beans</h3>
<div class="paragraph">
<p>Todas las acciones efectivas sobre las base de datos se realizan a través del <em>entity manager</em>. Es el objeto que se encarga de realizar las consultas y actualizaciones en las tablas y de mantener sincronizados con la base de datos los objetos entidad que residen en su contexto de persistencia.</p>
</div>
<div class="paragraph">
<p>Recordemos que el contexto de persistencia de un <em>entity manager</em> está formado por todos los objetos entidad gestionadas por el <em>entity manager</em> y que representan una caché de primer nivel de los datos.</p>
</div>
<div class="paragraph">
<p>El <em>entity manager</em> se encarga de propagar a la base de datos los cambios realizados en los objetos entidad haciendo un <em>flush</em> de forma automática cuando la transacción termina o antes de ejecutar una query.</p>
</div>
<div class="paragraph">
<p>En JPA gestionado por el contenedor la forma normal de obtener el <em>entity manager</em> es usando la inyección de dependencias:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@PersistenceContext</span><span class="tok-o">(</span><span class="tok-n">unitName</span> <span class="tok-o">=</span> <span class="tok-s">&quot;mensajes-ejbPU&quot;</span><span class="tok-o">)</span>
<span class="tok-n">EntityManager</span> <span class="tok-n">em</span><span class="tok-o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El atributo <code>unitName</code> indica la unidad de persistencia con la que se conecta el <em>entity manager</em>.</p>
</div>
<div class="paragraph">
<p>Esta inyección de dependencias hay que hacerla en un objeto gestionado al que el contenedor tenga acceso. Lo habitual es hacerla en el bean de sesión que define la interfaz de negocio.</p>
</div>
<div class="paragraph">
<p>Vamos a empezar definiendo un método de negocio muy sencillo. El método <code>nuevoAutor</code> que añade un autor a la base de datos.</p>
</div>
<div class="listingblock">
<div class="title">AutorService.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">ejb</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.ejb.Stateless</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManager</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.PersistenceContext</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.Date</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.List</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.Set</span><span class="tok-o">;</span>

<span class="tok-nd">@Stateless</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">AutorServicio</span> <span class="tok-o">{</span>

    <span class="tok-nd">@PersistenceContext</span><span class="tok-o">(</span><span class="tok-n">unitName</span> <span class="tok-o">=</span> <span class="tok-s">&quot;mensajes&quot;</span><span class="tok-o">)</span>
    <span class="tok-n">EntityManager</span> <span class="tok-n">em</span><span class="tok-o">;</span>

    <span class="tok-kd">public</span> <span class="tok-n">Autor</span> <span class="tok-nf">nuevoAutor</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">correo</span><span class="tok-o">,</span> <span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">Autor</span> <span class="tok-n">autor</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Autor</span><span class="tok-o">(</span><span class="tok-n">nombre</span><span class="tok-o">,</span> <span class="tok-n">correo</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">persist</span><span class="tok-o">(</span><span class="tok-n">autor</span><span class="tok-o">);</span>
        <span class="tok-k">return</span> <span class="tok-n">autor</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El contenedor es el encargado de inyectar el <em>entity manager</em>. El contenedor decidirá si debe crear un entity manager nuevo o si debe utilizar uno ya existente dependiendo del atributo <code>type</code> de la anotación <code>@PersistenceContext</code>.</p>
</div>
<div class="paragraph">
<p>El valor por defecto del atributo <code>type</code> es <code>PersistenceContextType.TRANSACTION</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@PersistenceContext</span><span class="tok-o">(</span><span class="tok-n">type</span><span class="tok-o">=</span><span class="tok-n">PersistenceContextType</span><span class="tok-o">.</span><span class="tok-na">TRANSACTION</span><span class="tok-o">)</span>
<span class="tok-n">EntityManager</span> <span class="tok-n">em</span><span class="tok-o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En los entity managers de tipo <code>TRANSACTION</code> se inyecta el mismo <em>entity manager</em> en todos los DAO que comparten la transacción. Esto significa que los distintos DAOs estarán compartiendo también el mismo contexto de persistencia y aprovechando la caché de entidades gestionadas.</p>
</div>
<div class="paragraph">
<p>El otro tipo de gestión de la vida del entity manager se utiliza con los beans de sesión con estado. El contexto de persistencia se mantiene abierto mientras que existe el bean con estado y las entidades permanecen gestionadas a lo largo de múltiples transacciones. Es lo que se denomina contexto de persistencia extendido:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@PersistenceContext</span><span class="tok-o">(</span><span class="tok-n">type</span><span class="tok-o">=</span><span class="tok-n">PersistenceContextType</span><span class="tok-o">.</span><span class="tok-na">EXTENDED</span><span class="tok-o">)</span>
<span class="tok-n">EntityManager</span> <span class="tok-n">em</span><span class="tok-o">;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ejemplo_completo">3.4. Ejemplo completo</h3>
<div class="paragraph">
<p>Los beans de sesión sin estado son, por sus características de transaccionalidad y seguridad, los componentes idóneos para implementar la capa de negocio de una aplicación.</p>
</div>
<div class="paragraph">
<p>Podemos comprobar su funcionamiento en el siguiente ejemplo, en el que completamos la aplicación web <code>mensajes</code> con la que hemos comenzado esta sesión.</p>
</div>
<div class="paragraph">
<p>El bean sin estado <code>AutorServicio</code> define los métodos de negocio. Obtiene un entity manager por inyección de dependencias.</p>
</div>
<div class="listingblock">
<div class="title">AutorServicio.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">ejb</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.ejb.Stateless</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManager</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.PersistenceContext</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.Date</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.List</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.Set</span><span class="tok-o">;</span>

<span class="tok-nd">@Stateless</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">AutorServicio</span> <span class="tok-o">{</span>

    <span class="tok-nd">@PersistenceContext</span><span class="tok-o">(</span><span class="tok-n">unitName</span> <span class="tok-o">=</span> <span class="tok-s">&quot;mensajes&quot;</span><span class="tok-o">)</span>
    <span class="tok-n">EntityManager</span> <span class="tok-n">em</span><span class="tok-o">;</span>

    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-kd">final</span> <span class="tok-n">String</span> <span class="tok-n">all_autores</span> <span class="tok-o">=</span> <span class="tok-s">&quot;SELECT a FROM Autor a&quot;</span><span class="tok-o">;</span>

    <span class="tok-kd">public</span> <span class="tok-n">Autor</span> <span class="tok-nf">nuevoAutor</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">correo</span><span class="tok-o">,</span> <span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">Autor</span> <span class="tok-n">autor</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Autor</span><span class="tok-o">(</span><span class="tok-n">nombre</span><span class="tok-o">,</span> <span class="tok-n">correo</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">persist</span><span class="tok-o">(</span><span class="tok-n">autor</span><span class="tok-o">);</span>
        <span class="tok-k">return</span> <span class="tok-n">autor</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">Mensaje</span> <span class="tok-nf">nuevoMensaje</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">texto</span><span class="tok-o">,</span> <span class="tok-n">Long</span> <span class="tok-n">idAutor</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">Autor</span> <span class="tok-n">autor</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Autor</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-n">idAutor</span><span class="tok-o">);</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">autor</span> <span class="tok-o">==</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
           <span class="tok-k">throw</span> <span class="tok-k">new</span> <span class="tok-nf">RuntimeException</span><span class="tok-o">(</span><span class="tok-s">&quot;No existe autor&quot;</span><span class="tok-o">);</span>
        <span class="tok-o">}</span> <span class="tok-k">else</span> <span class="tok-o">{</span>
            <span class="tok-n">Mensaje</span> <span class="tok-n">mens</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Mensaje</span><span class="tok-o">(</span><span class="tok-n">texto</span><span class="tok-o">,</span> <span class="tok-n">autor</span><span class="tok-o">);</span>
            <span class="tok-n">mens</span><span class="tok-o">.</span><span class="tok-na">setFecha</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">Date</span><span class="tok-o">());</span>
            <span class="tok-n">mens</span><span class="tok-o">.</span><span class="tok-na">setAutor</span><span class="tok-o">(</span><span class="tok-n">autor</span><span class="tok-o">);</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">persist</span><span class="tok-o">(</span><span class="tok-n">mens</span><span class="tok-o">);</span>
            <span class="tok-k">return</span> <span class="tok-n">mens</span><span class="tok-o">;</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Mensaje</span><span class="tok-o">&gt;</span> <span class="tok-nf">listaMensajes</span><span class="tok-o">(</span><span class="tok-n">Long</span> <span class="tok-n">idAutor</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">Autor</span> <span class="tok-n">autor</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Autor</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-n">idAutor</span><span class="tok-o">);</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">autor</span> <span class="tok-o">==</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-k">throw</span> <span class="tok-k">new</span> <span class="tok-nf">RuntimeException</span><span class="tok-o">(</span><span class="tok-s">&quot;No existe autor&quot;</span><span class="tok-o">);</span>
        <span class="tok-o">}</span> <span class="tok-k">else</span> <span class="tok-o">{</span>
            <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Mensaje</span><span class="tok-o">&gt;</span> <span class="tok-n">listaMensajes</span> <span class="tok-o">=</span> <span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">getMensajes</span><span class="tok-o">();</span>
            <span class="tok-n">listaMensajes</span><span class="tok-o">.</span><span class="tok-na">size</span><span class="tok-o">();</span>
            <span class="tok-k">return</span> <span class="tok-n">listaMensajes</span><span class="tok-o">;</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Autor</span><span class="tok-o">&gt;</span> <span class="tok-nf">listaAutores</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">createQuery</span><span class="tok-o">(</span><span class="tok-n">all_autores</span><span class="tok-o">).</span><span class="tok-na">getResultList</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Los siguientes servlets muestran cómo definir la capa de <em>controlador</em>  de la aplicación que recibe peticiones del usuario y las convierte en llamadas a los métodos de negocio. Más adelante veremos que es posible sustituir esta capa por los controladores de un API RESTful.</p>
</div>
<div class="paragraph">
<p>Los servlets son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>NuevoMensajeServlet</code>: añade un nuevo mensaje a un autor</p>
</li>
<li>
<p><code>NuevoAutorMensajeServlet</code>: añade un autor y un mensaje en una única transacción. Es un ejemplo que muestra cómo es posible utilizar la propagación de transacciones en los métodos de negocio.</p>
</li>
<li>
<p><code>ListaMensajesServlet</code>: devuelve los mensajes de un autor</p>
</li>
<li>
<p><code>ListaAutoresServlet</code>: devuelve todos los autores</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">NuevoMensajeServlet.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@WebServlet</span><span class="tok-o">(</span><span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s">&quot;nuevomensaje&quot;</span><span class="tok-o">,</span> <span class="tok-n">urlPatterns</span> <span class="tok-o">=</span> <span class="tok-s">&quot;/nuevomensaje&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">NuevoMensajesServlet</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span> <span class="tok-o">{</span>

    <span class="tok-nd">@EJB</span>
    <span class="tok-n">AutorServicio</span> <span class="tok-n">autorServicio</span><span class="tok-o">;</span>

    <span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">doPost</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                          <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
            <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>

    <span class="tok-o">}</span>

    <span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                         <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
            <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
        <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setContentType</span><span class="tok-o">(</span><span class="tok-s">&quot;text/html&quot;</span><span class="tok-o">);</span>

        <span class="tok-n">String</span> <span class="tok-n">texto</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;texto&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">Integer</span> <span class="tok-n">id</span> <span class="tok-o">=</span> <span class="tok-n">Integer</span><span class="tok-o">.</span><span class="tok-na">parseInt</span><span class="tok-o">(</span><span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;idAutor&quot;</span><span class="tok-o">));</span>

        <span class="tok-n">PrintWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>
        <span class="tok-n">Mensaje</span> <span class="tok-n">mens</span> <span class="tok-o">=</span> <span class="tok-n">autorServicio</span><span class="tok-o">.</span><span class="tok-na">nuevoMensaje</span><span class="tok-o">(</span><span class="tok-n">texto</span><span class="tok-o">,</span> <span class="tok-n">id</span><span class="tok-o">.</span><span class="tok-na">longValue</span><span class="tok-o">());</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;!DOCTYPE HTML PUBLIC \&quot;&quot;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;-//W3C//DTD HTML 4.0 &quot;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;Transitional//EN\&quot;&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;HTML&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;BODY&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;h1&gt;Mensaje&lt;/h1&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;p&gt;&quot;</span> <span class="tok-o">+</span> <span class="tok-n">mens</span><span class="tok-o">.</span><span class="tok-na">toString</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-s">&quot;&lt;/p&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/BODY&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/HTML&quot;</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">NuevoAutorMensaje.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@WebServlet</span><span class="tok-o">(</span><span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s">&quot;nuevoautor&quot;</span><span class="tok-o">,</span> <span class="tok-n">urlPatterns</span> <span class="tok-o">=</span> <span class="tok-s">&quot;/nuevoautor&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">NuevoAutorMensajeServlet</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span> <span class="tok-o">{</span>

    <span class="tok-nd">@EJB</span>
    <span class="tok-n">AutorServicio</span> <span class="tok-n">autorServicio</span><span class="tok-o">;</span>
    <span class="tok-nd">@Resource</span>
    <span class="tok-n">UserTransaction</span> <span class="tok-n">tx</span><span class="tok-o">;</span>

    <span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">doPost</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                          <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
            <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>

    <span class="tok-o">}</span>

    <span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                         <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
            <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>

        <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setContentType</span><span class="tok-o">(</span><span class="tok-s">&quot;text/html&quot;</span><span class="tok-o">);</span>

        <span class="tok-n">String</span> <span class="tok-n">nombre</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;nombre&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">String</span> <span class="tok-n">correo</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;correo&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">String</span> <span class="tok-n">texto</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;texto&quot;</span><span class="tok-o">);</span>

        <span class="tok-n">PrintWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>
        <span class="tok-k">try</span> <span class="tok-o">{</span>
            <span class="tok-n">tx</span><span class="tok-o">.</span><span class="tok-na">begin</span><span class="tok-o">();</span>
            <span class="tok-n">Autor</span> <span class="tok-n">autor</span> <span class="tok-o">=</span> <span class="tok-n">autorServicio</span><span class="tok-o">.</span><span class="tok-na">nuevoAutor</span><span class="tok-o">(</span><span class="tok-n">correo</span><span class="tok-o">,</span> <span class="tok-n">nombre</span><span class="tok-o">);</span>
            <span class="tok-n">autorServicio</span><span class="tok-o">.</span><span class="tok-na">nuevoMensaje</span><span class="tok-o">(</span><span class="tok-n">texto</span><span class="tok-o">,</span> <span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">getId</span><span class="tok-o">());</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;!DOCTYPE HTML PUBLIC \&quot;&quot;</span> <span class="tok-o">+</span>
                    <span class="tok-s">&quot;-//W3C//DTD HTML 4.0 &quot;</span> <span class="tok-o">+</span>
                    <span class="tok-s">&quot;Transitional//EN\&quot;&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;HTML&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;BODY&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;h1&gt;Añadido autor y mensaje&lt;/h1&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;p&gt;&quot;</span> <span class="tok-o">+</span> <span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">toString</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-s">&quot;&lt;p&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/BODY&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/HTML&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">tx</span><span class="tok-o">.</span><span class="tok-na">commit</span><span class="tok-o">();</span>
        <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">Exception</span> <span class="tok-n">e</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-k">try</span> <span class="tok-o">{</span>
                <span class="tok-n">tx</span><span class="tok-o">.</span><span class="tok-na">rollback</span><span class="tok-o">();</span>
            <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">SystemException</span> <span class="tok-n">e1</span><span class="tok-o">)</span> <span class="tok-o">{</span>
                <span class="tok-n">e1</span><span class="tok-o">.</span><span class="tok-na">printStackTrace</span><span class="tok-o">();</span>
                <span class="tok-k">throw</span> <span class="tok-k">new</span> <span class="tok-nf">RuntimeException</span><span class="tok-o">(</span><span class="tok-n">e1</span><span class="tok-o">);</span>
            <span class="tok-o">}</span>
            <span class="tok-k">throw</span> <span class="tok-k">new</span> <span class="tok-nf">RuntimeException</span><span class="tok-o">(</span><span class="tok-n">e</span><span class="tok-o">);</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">ListaMensajesServlet.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@WebServlet</span><span class="tok-o">(</span><span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s">&quot;listamensajes&quot;</span><span class="tok-o">,</span> <span class="tok-n">urlPatterns</span> <span class="tok-o">=</span> <span class="tok-s">&quot;/listamensajes&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">ListaMensajesServlet</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span> <span class="tok-o">{</span>

    <span class="tok-nd">@EJB</span>
    <span class="tok-n">AutorServicio</span> <span class="tok-n">autorServicio</span><span class="tok-o">;</span>

    <span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">doPost</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                          <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
            <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>

    <span class="tok-o">}</span>

    <span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                         <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
            <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
        <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setContentType</span><span class="tok-o">(</span><span class="tok-s">&quot;text/html&quot;</span><span class="tok-o">);</span>

        <span class="tok-n">Integer</span> <span class="tok-n">id</span> <span class="tok-o">=</span> <span class="tok-n">Integer</span><span class="tok-o">.</span><span class="tok-na">parseInt</span><span class="tok-o">(</span><span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;idAutor&quot;</span><span class="tok-o">));</span>

        <span class="tok-n">PrintWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>
        <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Mensaje</span><span class="tok-o">&gt;</span> <span class="tok-n">mensajes</span> <span class="tok-o">=</span>
                <span class="tok-n">autorServicio</span><span class="tok-o">.</span><span class="tok-na">listaMensajes</span><span class="tok-o">(</span><span class="tok-n">id</span><span class="tok-o">.</span><span class="tok-na">longValue</span><span class="tok-o">());</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;!DOCTYPE HTML PUBLIC \&quot;&quot;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;-//W3C//DTD HTML 4.0 &quot;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;Transitional//EN\&quot;&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;HTML&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;BODY&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;h1&gt;Mensajes&lt;/h1&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;ul&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">Mensaje</span> <span class="tok-n">m</span> <span class="tok-o">:</span> <span class="tok-n">mensajes</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;li&gt;&quot;</span> <span class="tok-o">+</span> <span class="tok-n">m</span><span class="tok-o">.</span><span class="tok-na">toString</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-s">&quot;&lt;/li&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-o">}</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/ul&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/BODY&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/HTML&quot;</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">ListaAutoresServlet.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@WebServlet</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;listaautores&quot;</span><span class="tok-o">,</span> <span class="tok-n">urlPatterns</span><span class="tok-o">=</span><span class="tok-s">&quot;/listaautores&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">ListaAutoresServlet</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span> <span class="tok-o">{</span>

    <span class="tok-nd">@EJB</span>
    <span class="tok-n">AutorServicio</span> <span class="tok-n">autorServicio</span><span class="tok-o">;</span>

    <span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">doPost</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                          <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
            <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>

    <span class="tok-o">}</span>

    <span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                         <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
            <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
        <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setContentType</span><span class="tok-o">(</span><span class="tok-s">&quot;text/html&quot;</span><span class="tok-o">);</span>

        <span class="tok-n">PrintWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>
        <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Autor</span><span class="tok-o">&gt;</span> <span class="tok-n">autores</span> <span class="tok-o">=</span> <span class="tok-n">autorServicio</span><span class="tok-o">.</span><span class="tok-na">listaAutores</span><span class="tok-o">();</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;!DOCTYPE HTML PUBLIC \&quot;&quot;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;-//W3C//DTD HTML 4.0 &quot;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;Transitional//EN\&quot;&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;HTML&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;BODY&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;h1&gt;Mensajes&lt;/h1&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;ul&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">Autor</span> <span class="tok-n">a</span> <span class="tok-o">:</span> <span class="tok-n">autores</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;li&gt;&quot;</span> <span class="tok-o">+</span> <span class="tok-n">a</span><span class="tok-o">.</span><span class="tok-na">toString</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-s">&quot;&lt;/li&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-o">}</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/ul&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/BODY&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/HTML&quot;</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por último, el siguiente JSP es el que recoge los datos mediante formularios y realiza las invocaciones a los servlets correspondientes.</p>
</div>
<div class="listingblock">
<div class="title">index.jsp</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-cp">&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.0 Transitional//EN&quot;&gt;</span>
<span class="tok-nt">&lt;html&gt;</span>
<span class="tok-nt">&lt;head&gt;</span>
    <span class="tok-nt">&lt;title&gt;</span>Start Page<span class="tok-nt">&lt;/title&gt;</span>
    <span class="tok-nt">&lt;meta</span> <span class="tok-na">http-equiv=</span><span class="tok-s">&quot;Content-Type&quot;</span> <span class="tok-na">content=</span><span class="tok-s">&quot;text/html; charset=UTF-8&quot;</span><span class="tok-nt">&gt;</span>
<span class="tok-nt">&lt;/head&gt;</span>
<span class="tok-nt">&lt;body&gt;</span>

<span class="tok-nt">&lt;h1&gt;</span>¡Mensajes!<span class="tok-nt">&lt;/h1&gt;</span>

<span class="tok-nt">&lt;h3&gt;</span>Nuevo autor y mensaje<span class="tok-nt">&lt;/h3&gt;</span>

<span class="tok-nt">&lt;form</span> <span class="tok-na">action=</span><span class="tok-s">&quot;&lt;%=request.getContextPath()%&gt;/nuevoautor&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;p&gt;</span>Correo: <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;correo&quot;</span><span class="tok-nt">&gt;&lt;/p&gt;</span>
    <span class="tok-nt">&lt;p&gt;</span>Nombre: <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;nombre&quot;</span><span class="tok-nt">&gt;&lt;/p&gt;</span>
    <span class="tok-nt">&lt;p&gt;</span>Texto: <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;texto&quot;</span><span class="tok-nt">&gt;&lt;/p&gt;</span>
    <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;submit&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;Enviar&quot;</span><span class="tok-nt">&gt;</span>
<span class="tok-nt">&lt;/form&gt;</span>

<span class="tok-nt">&lt;h3&gt;</span>Nuevo mensaje<span class="tok-nt">&lt;/h3&gt;</span>

<span class="tok-nt">&lt;form</span> <span class="tok-na">action=</span><span class="tok-s">&quot;&lt;%=request.getContextPath()%&gt;/nuevomensaje&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;p&gt;</span>Texto: <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;texto&quot;</span><span class="tok-nt">&gt;&lt;/p&gt;</span>
    <span class="tok-nt">&lt;p&gt;</span>Autor id: <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;idAutor&quot;</span><span class="tok-nt">&gt;&lt;/p&gt;</span>
    <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;submit&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;Enviar&quot;</span><span class="tok-nt">&gt;</span>
<span class="tok-nt">&lt;/form&gt;</span>

<span class="tok-nt">&lt;h3&gt;</span>Lista mensajes<span class="tok-nt">&lt;/h3&gt;</span>

<span class="tok-nt">&lt;form</span> <span class="tok-na">action=</span><span class="tok-s">&quot;&lt;%=request.getContextPath()%&gt;/listamensajes&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;p&gt;</span>Autor id: <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;idAutor&quot;</span><span class="tok-nt">&gt;&lt;/p&gt;</span>
    <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;submit&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;Enviar&quot;</span><span class="tok-nt">&gt;</span>
<span class="tok-nt">&lt;/form&gt;</span>

<span class="tok-nt">&lt;h3&gt;</span>Lista autores<span class="tok-nt">&lt;/h3&gt;</span>


<span class="tok-nt">&lt;form</span> <span class="tok-na">action=</span><span class="tok-s">&quot;&lt;%=request.getContextPath()%&gt;/listaautores&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;submit&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;Enviar&quot;</span><span class="tok-nt">&gt;</span>
<span class="tok-nt">&lt;/form&gt;</span>


<span class="tok-nt">&lt;/body&gt;</span>
<span class="tok-nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Un ejemplo de test Arquillian de la operación de negocio que crea un nuevo autor:</p>
</div>
<div class="listingblock">
<div class="title">SaludoServicioTest.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@RunWith</span><span class="tok-o">(</span><span class="tok-n">Arquillian</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">SaludoServicioTest</span> <span class="tok-o">{</span>

    <span class="tok-nd">@EJB</span>
    <span class="tok-kd">private</span> <span class="tok-n">AutorServicio</span> <span class="tok-n">autorServicio</span><span class="tok-o">;</span>

    <span class="tok-nd">@Deployment</span>
    <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-n">Archive</span><span class="tok-o">&lt;?&gt;</span> <span class="tok-n">deployment</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">ShrinkWrap</span><span class="tok-o">.</span><span class="tok-na">create</span><span class="tok-o">(</span><span class="tok-n">WebArchive</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">)</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">Autor</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addAsResource</span><span class="tok-o">(</span><span class="tok-s">&quot;META-INF/persistence.xml&quot;</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">deberiaDevolverNuevoAutor</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">String</span> <span class="tok-n">correo</span> <span class="tok-o">=</span> <span class="tok-s">&quot;pedro.picapiedra@gmail.com&quot;</span><span class="tok-o">;</span>
        <span class="tok-n">String</span> <span class="tok-n">nombre</span> <span class="tok-o">=</span> <span class="tok-s">&quot;Pedro Picapiedra&quot;</span><span class="tok-o">;</span>
        <span class="tok-n">Autor</span> <span class="tok-n">autor</span> <span class="tok-o">=</span> <span class="tok-n">autorServicio</span><span class="tok-o">.</span><span class="tok-na">nuevoAutor</span><span class="tok-o">(</span><span class="tok-n">correo</span><span class="tok-o">,</span> <span class="tok-n">nombre</span><span class="tok-o">);</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">getCorreo</span><span class="tok-o">().</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">correo</span><span class="tok-o">)</span> <span class="tok-o">&amp;&amp;</span>
                   <span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">getNombre</span><span class="tok-o">().</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">nombre</span><span class="tok-o">));</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios_3">3.5. Ejercicios</h3>
<div class="sect3">
<h4 id="__3_5_puntos_aplicación_web_filmoteca">3.5.1. (3,5 puntos) Aplicación web filmoteca</h4>
<div class="paragraph">
<p>Crea la aplicación web <code>filmoteca</code> con todas las entidades y DAOs que hayas definido en los ejercicios de JPA. Convierte las clases <code>PeliculaServicio</code> y <code>ActorServicio</code> en beans de sesión y crea un mínimo de 4 servlets que prueben su funcionamiento. Define también un test Arquilian como mínimo.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion04">4. Beans asíncronos, temporizadores e interceptores</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_acceso_asíncrono_a_los_beans">4.1. Acceso asíncrono a los beans</h3>
<div class="paragraph">
<p>Por defecto, todas las llamadas a los beans son síncronas. El cliente realiza la petición y se queda en espera hasta que el bean le manda la respuesta. La especificación 3.1 de EJB introduce la novedad de permitir llamadas <em>asíncronas</em> a los beans de sesión, en las que el cliente lanza la petición al bean y continua haciendo otros trabajos hasta que el bean tiene disponible la respuesta.</p>
</div>
<div class="paragraph">
<p>Para marcar un método o un bean como asíncrono se utiliza la anotación <code>@Asynchronous</code>. El método tiene que ser <code>void</code> o devolver un objeto del tipo <code>Future&lt;V&gt;</code>.</p>
</div>
<div class="paragraph">
<p>Si el método asíncrono no devuelve nada, se está utilizando un patrón denominado <em>fire and forget</em>, en el que el cliente lanza la llamada al bean y continua su ejecución sin necesitar los resultados.</p>
</div>
<div class="paragraph">
<p>La interfaz <code>Future</code>, parametrizada con el tipo de dato que se devolverá cuando el método asíncrono devuelva un resultado, es una interfaz del API de concurrencia de Java. Define los siguientes métodos:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>boolean cancel(boolean mayInterruptIfRunning)</code></dt>
<dd>
<p>Intenta cancelar la ejecución de la tarea.</p>
</dd>
<dt class="hdlist1"><code>V get()</code></dt>
<dd>
<p>Espera si es necesario a que la computación se complete y luego devuelve el resultado.</p>
</dd>
<dt class="hdlist1"><code>V get(long timeout, TimeUnit unit)</code></dt>
<dd>
<p>Igual que el método anterior, pero con un timeout.</p>
</dd>
<dt class="hdlist1"><code>boolean isCancelled()</code></dt>
<dd>
<p>Devuelve <code>true</code> si la tarea ha sido cancelada antes de ser completada normalmente.</p>
</dd>
<dt class="hdlist1">` boolean isDone()`</dt>
<dd>
<p>Devuelve <code>true</code> si la tarea ha terminado.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>El cliente que llama a un método asíncrono y espera un resultado debe realizar un <em>poolig</em>, preguntando al método <code>isDone</code> si se ha terminado la computación. Cuando se devuelva <code>true</code> el resultado estará disponible en el propio objeto <code>Future</code> y se podrá obtener inmediatamente con el método <code>get</code>.</p>
</div>
<div class="paragraph">
<p>Por su parte, el cliente deberá devolver un objeto en el método creando un nuevo objeto de tipo <code>AsyncResult</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Stateless</span>
<span class="tok-nd">@Asynchronous</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">MyAsyncBean</span> <span class="tok-o">{</span>
	<span class="tok-kd">public</span> <span class="tok-n">Future</span><span class="tok-o">&lt;</span><span class="tok-n">Integer</span><span class="tok-o">&gt;</span> <span class="tok-nf">addNumbers</span><span class="tok-o">(</span><span class="tok-kt">int</span> <span class="tok-n">n1</span><span class="tok-o">,</span> <span class="tok-kt">int</span> <span class="tok-n">n2</span><span class="tok-o">)</span> <span class="tok-o">{</span>
		<span class="tok-n">Integer</span> <span class="tok-n">result</span><span class="tok-o">;</span>
		<span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-n">n1</span> <span class="tok-o">+</span> <span class="tok-n">n2</span><span class="tok-o">;</span>
		<span class="tok-c1">// simulamos una consulta muy larga ...</span>
		<span class="tok-k">return</span> <span class="tok-k">new</span> <span class="tok-nf">AsyncResult</span><span class="tok-o">(</span><span class="tok-n">result</span><span class="tok-o">);</span>
	<span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La clase <code>AsyncResult</code> se introduce en la especificación EJB 3.1 para envolver el resultado del método en un objeto
<code>Future</code>.</p>
</div>
<div class="paragraph">
<p>Como cualquier otro bean enterprise, el bean puede inyectarse en cualquier componente Java EE:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@EJB</span> <span class="tok-n">MyAsyncBean</span> <span class="tok-n">asyncBean</span><span class="tok-o">;</span>
<span class="tok-n">Future</span><span class="tok-o">&lt;</span><span class="tok-n">Integer</span><span class="tok-o">&gt;</span> <span class="tok-n">future</span> <span class="tok-o">=</span> <span class="tok-n">asyncBean</span><span class="tok-o">.</span><span class="tok-na">addNumbers</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">,</span> <span class="tok-mi">20</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Después se usan los métodos del API <code>Future</code> para consultar si está disponible el resultado con <code>isDone</code> o se cancela su ejecución con el método <code>cancel</code>.</p>
</div>
<div class="paragraph">
<p>El contexto de transacción del cliente no se propaga al método de negocio asíncrono. El método se comporta como si tuviera la semántica del <code>REQUIRES_NEW</code>.</p>
</div>
<div class="paragraph">
<p>El rol de seguridad del objeto principal se propaga al método de negocio asíncrono. En este aspecto el método asíncrono se comporta de la misma forma que el síncrono.</p>
</div>
</div>
<div class="sect2">
<h3 id="_temporizadores">4.2. Temporizadores</h3>
<div class="paragraph">
<p>Las aplicaciones que implementan flujos de trabajo de negocio tienen que tratar frecuentemente con notificaciones periódicas. El servicio temporizador del contenedor EJB nos permite planificar notificaciones para todos los tipos de enterprise beans excepto para los beans de sesión con estado. Podemos planificar una notificación para una hora específica, para después de un lapso de tiempo o a intervalos temporales. Por ejemplo, podríamos planificar los temporizadores para que lancen una notificación a las 10:30 AM del 23 de Mayo, en 30 días o cada 12 horas.</p>
</div>
<div class="paragraph">
<p>Los temporizadores van descontando el tiempo definido. Cuando llegan a cero (saltan), el contenedor llama al método anotado con la anotación <code>@Timeout</code> en la clase de implementación del bean. El método <code>@Timeout</code> contiene la lógica de negocio que maneja el evento temporizado.</p>
</div>
<div class="paragraph">
<p>El API está definida por la <a href="https://docs.oracle.com/javaee/7/api/javax/ejb/TimerService.html">interfaz TimerService</a>.</p>
</div>
<div class="sect3">
<h4 id="_el_método_timeout">4.2.1. El método Timeout</h4>
<div class="paragraph">
<p>Los métodos anotados con <code>@Timeout</code> en la clase de implementación del bean deben devolver <code>void</code> y tomar un objeto <code>javax.ejb.Timer</code> como su único parámetro. No pueden lanzar excepciones capturadas por la aplicación.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Timeout</span>
<span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">timeout</span><span class="tok-o">(</span><span class="tok-n">Timer</span> <span class="tok-n">timer</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;TimerBean: timeout occurred&quot;</span><span class="tok-o">);</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_creando_temporizadores">4.2.2. Creando temporizadores</h4>
<div class="paragraph">
<p>Para crear un temporizador, el bean debe invocar uno de los métodos <code>createTimer()</code> de la interfaz <code>TimerService</code>. Cuando el bean invoca el método <code>createTimer()</code>, el servicio temporizador comienza a contar hacia atrás la duración del timer.</p>
</div>
<div class="paragraph">
<p>Como ejemplo veamos el siguiente bean de sesión:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Stateless</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">TimerSessionBean</span> <span class="tok-kd">implements</span> <span class="tok-n">TimerSessionLocal</span> <span class="tok-o">{</span>
    <span class="tok-nd">@Resource</span>
    <span class="tok-n">TimerService</span> <span class="tok-n">timerService</span><span class="tok-o">;</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setTimer</span><span class="tok-o">(</span><span class="tok-kt">long</span> <span class="tok-n">intervalDuration</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">Timer</span> <span class="tok-n">timer</span> <span class="tok-o">=</span> <span class="tok-n">timerService</span><span class="tok-o">.</span><span class="tok-na">createTimer</span><span class="tok-o">(</span>
                    <span class="tok-n">intervalDuration</span><span class="tok-o">,</span>
                    <span class="tok-s">&quot;Creado un nuevo timer&quot;</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Timeout</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">timeout</span><span class="tok-o">(</span><span class="tok-n">Timer</span> <span class="tok-n">timer</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;Se ha lanzado el timeout&quot;</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Vemos que el bean define un método <code>setTimer()</code> en el que se usa el objeto <em>timerService</em> obtenido en línea 3 con la anotación <code>@Resource</code>. En este método definimos un temporizador inicializándolo a los milisegundos determinados por <code>intervalDuration</code>.</p>
</div>
<div class="paragraph">
<p>El temporizador puede ser un temporizador de parada única, en el que podemos indicar el momento de la parada o el tiempo que debe transcurrir antes de la misma, o un temporizador periódico, que se lanza a intervalos regulares. Básicamente son posibles cuatro tipos de temporizadores:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Parada única con tiempo: <code>createTimer(long timeoutDuration,
Serializable info)</code></p>
</li>
<li>
<p>Parada única con fecha: <code>createTimer(Date firstDate,
Serializable info)</code></p>
</li>
<li>
<p>Periódico con intervalos regulares y tiempo
inicial: <code>createTimer(long timeoutDuration, long timeoutInterval,
Serializable info)</code></p>
</li>
<li>
<p>Periódico con intervalos regulares y fecha
inicial: <code>createTimer(Date firstDate, long timeoutInterval,
Serializable info)</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Veamos un ejemplo de utilización de temporizadores periódico con fecha inicial. Supongamos que queremos un temporizador que expire el 1 de Mayo de 2008 a las 12h. y que, a partir de esa fecha, expire cada tres días:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">Calendar</span> <span class="tok-n">unoDeMayo</span> <span class="tok-o">=</span> <span class="tok-n">Calendar</span><span class="tok-o">.</span><span class="tok-na">getInstance</span><span class="tok-o">();</span>
<span class="tok-n">unoDeMayo</span><span class="tok-o">.</span><span class="tok-na">set</span><span class="tok-o">(</span><span class="tok-mi">2008</span><span class="tok-o">,</span> <span class="tok-n">Calendar</span><span class="tok-o">.</span><span class="tok-na">MAY</span><span class="tok-o">,</span> <span class="tok-mi">1</span><span class="tok-o">,</span> <span class="tok-mi">12</span><span class="tok-o">,</span> <span class="tok-mi">0</span><span class="tok-o">);</span>
<span class="tok-kt">long</span> <span class="tok-n">tresDiasEnMilisecs</span> <span class="tok-o">=</span> <span class="tok-mi">1000</span> <span class="tok-o">*</span> <span class="tok-mi">60</span> <span class="tok-o">*</span> <span class="tok-mi">60</span> <span class="tok-o">*</span> <span class="tok-mi">24</span> <span class="tok-o">*</span> <span class="tok-mi">3</span><span class="tok-o">;</span>
<span class="tok-n">timerService</span><span class="tok-o">.</span><span class="tok-na">createTimer</span><span class="tok-o">(</span><span class="tok-n">unoDeMayo</span><span class="tok-o">.</span><span class="tok-na">getTime</span><span class="tok-o">(),</span>
                         <span class="tok-n">tresDiasEnMilisecs</span><span class="tok-o">,</span>
                         <span class="tok-s">&quot;Mi temporizador&quot;</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Los parámetros <code>Date</code> y <code>long</code> representan el tiempo del temporizador con una resolución de milisegundos. Sin embargo, debido a que el servicio de temporización no está orientado hacia aplicaciones de tiempo real, el callback al método <code>@Timeout</code> podría no ocurrir con precisión de milisegundos. El servicio de temporización es para aplicaciones de negocios, que miden el tiempo normalmente en horas, días o incluso duraciones más largas.</p>
</div>
<div class="paragraph">
<p>Los temporizadores son persistentes. Si el servidor se apaga (o incluso se cae), los temporizadores se graban y se activarán de nuevo en el momento en que el servidor vuelve a poner en marcha. Si un temporizador expira en el momento en que el servidor está caído, el contenedor llamará al método <code>@Timeout</code> cuando el servidor se vuelva a comenzar.</p>
</div>
</div>
<div class="sect3">
<h4 id="_cancelando_y_grabando_temporizadores">4.2.3. Cancelando y grabando temporizadores</h4>
<div class="paragraph">
<p>Los temporizadores pueden cancelarse con los siguientes eventos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Cuando un temporizador de tiempo expira, el contenedor EJB llama al método <code>@Timeout</code> y cancela el temporizador.</p>
</li>
<li>
<p>Cuando el bean invoca el método <code>cancel</code> de la interfaz <code>Timer</code>, el contenedor cancela el timer.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Para grabar un objeto <code>Timer</code> para rerferencias futuras, podemos invocar su método <code>getHandle()</code> y almacenar el objeto <code>TimerHandle</code> en una base de datos (un objeto <code>TimerHandle</code> es serializable). Para reinstanciar el objeto <code>Timer</code>, podemos recuperar el <code>TimerHandle</code> de la base de datos e invocar en él el método <code>getTimer()</code>. Un objeto <code>TimerHandle</code> no puede pasarse como argumento de un método definido en un interfaz remoto. Esto es, los clientes remotos no pueden acceder al <code>TimerHandle</code> del bean. Los clientes locales, sin embargo, no sufren esta restricción.</p>
</div>
</div>
<div class="sect3">
<h4 id="_obteniendo_información_del_temporizador">4.2.4. Obteniendo información del temporizador</h4>
<div class="paragraph">
<p>La interfaz <code>Timer</code> define también métodos para obtener información sobre los temporizadores:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kt">long</span> <span class="tok-nf">getTimeRemaining</span><span class="tok-o">();</span>
   <span class="tok-kd">public</span> <span class="tok-n">java</span><span class="tok-o">.</span><span class="tok-na">util</span><span class="tok-o">.</span><span class="tok-na">Date</span> <span class="tok-nf">getNextTimeout</span><span class="tok-o">();</span>
   <span class="tok-kd">public</span> <span class="tok-n">java</span><span class="tok-o">.</span><span class="tok-na">io</span><span class="tok-o">.</span><span class="tok-na">Serializable</span> <span class="tok-nf">getInfo</span><span class="tok-o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El método <code>getInfo()</code> devuelve el objeto que se pasó como último parámetro de la invocación <code>createTimer</code>. Por ejemplo, en el código anterior esta información es la cadena &#8220;Creado un nuevo timer&#8221;.</p>
</div>
<div class="paragraph">
<p>También podemos recuperar todos los temporizadores activos de un bean con el método <code>getTimers()</code>, que devuelve una colección de objetos <code>Timer</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_temporizadores_y_transacciones">4.2.5. Temporizadores y transacciones</h4>
<div class="paragraph">
<p>Los enterprise bean normalmente crean temporizadores dentro de transacciones. Si la transacción es anulada, también se anula automáticamente la creación del temporizador. De forma similar, si un bean cancela un temporizador dentro de una transacción que termina siendo anulada, la cancelación del temporizador también se anula.</p>
</div>
<div class="paragraph">
<p>En los beans que usan transacciones gestionadas por el contenedor, el método <code>@Timeout</code> tiene normalmente el atributo de transacción <code>REQUIRES</code> o <code>REQUIRES_NEW</code> para preservar la integridad de la transacción. Con estos atributos, el contenedor EJB comienza una nueva transacción antes de llamar al método <code>@Timeout</code>. De esta forma, si la transacción se anula, el contenedor volverá a llamar al método <code>@Timeout</code> de nuevo con los valores iniciales del temporizador.</p>
</div>
</div>
<div class="sect3">
<h4 id="_ventajas_y_limitaciones">4.2.6. Ventajas y limitaciones</h4>
<div class="paragraph">
<p>Entre las ventajas de los temporizadores frente a la utilización de algún otro tipo de planficadores podemos destacar:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Los temporizadores son parte del estándar Java EE con lo que la aplicación será portable y no dependerá de APIs propietarias del servidor de aplicaciones.</p>
</li>
<li>
<p>La utilización del servicio de temporización de EJB viene incluido en Java EE y no tiene ningún coste adicional. No hay que realizar ninguna configuración de un planificador externo y el desarrollador no tiene que preocuparse de buscar uno.</p>
</li>
<li>
<p>El temporizador es un servicio gestionado por el contenedor, y no se requiere un thread separado como en un planificador externo.</p>
</li>
<li>
<p>Las transacciones se soportan completamente.</p>
</li>
<li>
<p>Por defecto, los temporizadores son objetos persistentes que sobreviven a caídas del contenedor.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Limitaciones</p>
</div>
<div class="ulist">
<ul>
<li>
<p>La mayoría de planificadores proporcionan la posibilidad de utilizar clases Java estándar; sin embargo los temporizadores requieren el uso de enterprise beans.</p>
</li>
<li>
<p>Los temporizadores EJB adolecen del soporte de temporizadores al estilo cron, fechas de bloqueo, etc. disponibles en muchos planificadores de tareas.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_interceptores">4.3. Interceptores</h3>
<div class="paragraph">
<p>Los <em>interceptores</em> (<em>interceptors</em>) son objetos que son capaces de interponerse en las llamadas a los métodos en los eventos de ciclo de vida de los beans de sesión y de mensaje. Nos permiten encapsular conductas comunes a distintas partes de la aplicación que normalmente no tienen que ver con la lógica de negocio. Los interceptores son una característica avanzada de la especificación EJB que nos permite modularizar la aplicación o incluso extender el funcionamiento del contenedor EJB. En esta sesión veremos una introducción a la definición y al funcionamiento de los interceptores para interponerse en las llamadas a los métodos de negocio.</p>
</div>
<div class="paragraph">
<p>Toda su API está definida en el <a href="https://docs.oracle.com/javaee/7/api/javax/interceptor/package-summary.html">package javax.interceptor</a>.</p>
</div>
<div class="sect3">
<h4 id="_la_clase_interceptor">4.3.1. La clase Interceptor</h4>
<div class="paragraph">
<p>Comencemos con un ejemplo. Supongamos que queremos analizar el tiempo que tarda en ejecutarse un determinado método de negocio de un bean.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">addMensajeAutor</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">,</span> <span class="tok-n">String</span> <span class="tok-n">texto</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-kt">long</span> <span class="tok-n">startTime</span> <span class="tok-o">=</span> <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">currentTimeMillis</span><span class="tok-o">();</span>
      <span class="tok-n">Autor</span> <span class="tok-n">autor</span> <span class="tok-o">=</span> <span class="tok-n">findAutor</span><span class="tok-o">(</span><span class="tok-n">nombre</span><span class="tok-o">);</span>
      <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">autor</span> <span class="tok-o">==</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
         <span class="tok-n">autor</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Autor</span><span class="tok-o">();</span>
         <span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">setNombre</span><span class="tok-o">(</span><span class="tok-n">nombre</span><span class="tok-o">);</span>
         <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">persist</span><span class="tok-o">(</span><span class="tok-n">autor</span><span class="tok-o">);</span>
      <span class="tok-o">}</span>
      <span class="tok-n">mensajeService</span><span class="tok-o">.</span><span class="tok-na">addMensaje</span><span class="tok-o">(</span><span class="tok-n">texto</span><span class="tok-o">,</span> <span class="tok-n">nombre</span><span class="tok-o">);</span>
      <span class="tok-kt">long</span> <span class="tok-n">endTime</span> <span class="tok-o">=</span> <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">currentTimeMillis</span><span class="tok-o">()</span> <span class="tok-o">-</span> <span class="tok-n">startTime</span><span class="tok-o">;</span>
      <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;addMensajeAutor() ha tardado: &quot;</span> <span class="tok-o">+</span>
              <span class="tok-n">endTime</span> <span class="tok-o">+</span> <span class="tok-s">&quot; (ms)&quot;</span><span class="tok-o">);*</span>
   <span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Aunque el método compilará y se ejecutará correctamente, el enfoque tiene serios problemas de diseño:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Se ha añadido en el método <code>addMensajeAutor()</code> código que no tiene nada que ver con la lógica de negocio de la aplicación. El código se ha hecho más complicado de leer y de mantener.</p>
</li>
<li>
<p>El código de análisis no se puede activar y desactivar a conveniencia. Hay que comentarlo y volver a recompilar la aplicación.</p>
</li>
<li>
<p>El código de análisis es una plantilla que podría reutilizarse en muchos métodos de la aplicación. Pero escrito de esta forma habría que escribirlo en todos los métodos en los que queramos aplicarlo.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Los interceptores proporcionan un mecanismo para encapsular este tipo de código de una forma sencilla y aplicarlo a nuestros métodos sin interferir directamente. Los interceptores proporcionan una estructura para este tipo de conducta de forma que puedan ser ampliados y extendidos fácilmente en una clase. Por último, proporcionan un mecanismo simple y configurable para aplicar la conducta en el lugar que deseemos.</p>
</div>
<div class="paragraph">
<p>Este tipo de código que <em>envuelve</em> los métodos de la aplicación se suele denominar también <em>aspecto</em> y es la base de una técnica de programación denominada AOP (<em>Aspect Oriented Programming</em>). Un <em>framework</em> muy popular de programación dirigida por aspectos en Java es AspectJ.</p>
</div>
<div class="paragraph">
<p>Vamos ya a detallar cómo implementar los interceptores. Es muy sencillo. Basta con crear una clase Java con un método precedido por la anotación <code>@javax.interceptor.AroundInvoke</code> y con la siguiente signatura:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@AroundInvoke</span>
<span class="tok-n">Object</span> <span class="tok-o">&lt;</span><span class="tok-n">nombre</span><span class="tok-o">-</span><span class="tok-n">metodo</span><span class="tok-o">&gt;(</span><span class="tok-n">javax</span><span class="tok-o">.</span><span class="tok-na">interceptor</span><span class="tok-o">.</span><span class="tok-na">InvocationContext</span> <span class="tok-n">invocation</span><span class="tok-o">)</span>
   <span class="tok-kd">throws</span> <span class="tok-n">Exception</span><span class="tok-o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El método <code>@AroundInvoke</code> en una clase de intercepción envuelve la llamada al método de negocio y es invocado en la misma pila de llamada, en la misma transacción y en el mismo contexto de seguridad que el método que se está interceptando. El parámetro <code>javax.interceptor.InvocationContext</code> es una representación genérica del método de negocio que el cliente está invocando. A través de él podemos obtener información como el bean al que se está llamando, los parámetros que se están pasando en forma de un array de objetos, y una referencia al objeto <code>java.lang.reflect.Method</code> que contiene la representación del método invocado. <code>InvocationContext</code> también se usa para dirigir realmente la invocación. Veamos cómo utilizar este enfoque para hacer el análisis del tiempo anterior:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">import</span> <span class="tok-nn">javax.interceptor.AroundInvoke</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.interceptor.InvocationContext</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Profiler</span> <span class="tok-o">{</span>

   <span class="tok-nd">@AroundInvoke</span> <i class="conum" data-value="1"></i><b>(1)</b>
   <span class="tok-kd">public</span> <span class="tok-n">Object</span> <span class="tok-nf">profile</span><span class="tok-o">(</span><span class="tok-n">InvocationContext</span> <span class="tok-n">invocation</span><span class="tok-o">)</span>
           <span class="tok-kd">throws</span> <span class="tok-n">Exception</span> <span class="tok-o">{</span>
      <span class="tok-kt">long</span> <span class="tok-n">startTime</span> <span class="tok-o">=</span> <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">currentTimeMillis</span><span class="tok-o">();</span>
      <span class="tok-k">try</span> <span class="tok-o">{</span>
         <span class="tok-k">return</span> <span class="tok-n">invocation</span><span class="tok-o">.</span><span class="tok-na">proceed</span><span class="tok-o">();</span> <i class="conum" data-value="2"></i><b>(2)</b>
      <span class="tok-o">}</span> <span class="tok-k">finally</span> <span class="tok-o">{</span>
         <span class="tok-kt">long</span> <span class="tok-n">endTime</span> <span class="tok-o">=</span> <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">currentTimeMillis</span><span class="tok-o">()</span> <span class="tok-o">-</span> <span class="tok-n">startTime</span><span class="tok-o">;</span> <i class="conum" data-value="3"></i><b>(3)</b>
         <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;El método &quot;</span> <span class="tok-o">+</span> <span class="tok-n">invocation</span><span class="tok-o">.</span><span class="tok-na">getMethod</span><span class="tok-o">()</span> <span class="tok-o">+</span>
                 <span class="tok-s">&quot; ha tardado &quot;</span> <span class="tok-o">+</span> <span class="tok-n">endTime</span> <span class="tok-o">+</span> <span class="tok-s">&quot; (ms)&quot;</span><span class="tok-o">);</span>
      <span class="tok-o">}</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Marcamos el método <code>profile</code> como <code>@AroundInvoke</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Llamada al método que estamos interceptando</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Cálculo final del tiempo de ejecución</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El método anotado con <code>@AroundInvoke</code> en nuestra clase interceptora es el método <code>profile</code>. Tiene un aspecto muy parecido al código que escribimos en el método <code>addMensajeAutor</code>, con la excepción de que no incluimos la lógica de negocio. Se invoca a este método con <code>InvocationContext.proceed()</code>. Si se debe llamar a otro interceptor el método <code>proceed()</code> realiza esa llamada. Si no hay ningún otro interceptor en espera, el contenedor EJB llama entonces al método del bean que está siendo invocado por el cliente.</p>
</div>
<div class="paragraph">
<p>En el <code>finally</code> se calcula el tiempo de ejecución y se imprime en la salida estándar. El método <code>InvocationContext.getMethod()</code> proporciona acceso al objeto <code>java.lang.reflect.Method</code> que representa el método real que se está invocando. Se usa en la línea 14 para imprimir el nombre del método al que se está llamando.</p>
</div>
<div class="paragraph">
<p>La estructura del código permite capturar las posibles excepciones que pudiera generar la invocación del método del bean. Al poner el cálculo del tiempo final en la parte <code>finally</code> nos aseguramos de que siempre se ejecuta.</p>
</div>
<div class="paragraph">
<p>Además del método <code>getMethod()</code>, la interface <code>InvocationContext</code> tiene otros métodos interesantes. En el siguiente enlace se puede consultar su <a href="https://docs.oracle.com/javaee/7/api/javax/interceptor/InvocationContext.html">API en Java EE 7</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">javax</span><span class="tok-o">.</span><span class="tok-na">interceptor</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">interface</span> <span class="tok-nc">InvocationContext</span> <span class="tok-o">{</span>
   <span class="tok-kd">public</span> <span class="tok-n">Object</span> <span class="tok-nf">getTarget</span><span class="tok-o">();</span>
   <span class="tok-kd">public</span> <span class="tok-n">Method</span> <span class="tok-nf">getMethod</span><span class="tok-o">();</span>
   <span class="tok-kd">public</span> <span class="tok-n">Object</span><span class="tok-o">[]</span> <span class="tok-nf">getParameters</span><span class="tok-o">();</span>
   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setParameters</span><span class="tok-o">(</span><span class="tok-n">Object</span><span class="tok-o">[]</span> <span class="tok-n">newArgs</span><span class="tok-o">);</span>
   <span class="tok-kd">public</span> <span class="tok-n">java</span><span class="tok-o">.</span><span class="tok-na">util</span><span class="tok-o">.</span><span class="tok-na">Map</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-o">,</span> <span class="tok-n">Object</span><span class="tok-o">&gt;</span> <span class="tok-nf">getContextData</span><span class="tok-o">();</span>
   <span class="tok-kd">public</span> <span class="tok-n">Object</span> <span class="tok-nf">proceed</span><span class="tok-o">()</span> <span class="tok-kd">throws</span> <span class="tok-n">Exception</span><span class="tok-o">;</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El método <code>getTarget()</code> devuelve una referencia a la instancia del bean objetivo. Podríamos cambiar nuestro método <code>profile</code> para que imprimiera los parámetros del método al que se está invocando utilizando el método <code>getParameters()</code>. El método <code>setParameters()</code> permite modificar los parámetros de la invocación al método del bean, de forma que podemos hacer que el bean ejecute el código con los parámetros proporcionados por el interceptador. El método <code>getContextData()</code> devuelve un objeto <code>Map</code> que está activo durante toda la invocación al método. Los interceptores pueden utilizar este objeto para pasarse datos de contexto entre ellos durante la misma invocación.</p>
</div>
<div class="paragraph">
<p>Una vez que hemos escrito la clase de intercepción, es hora de aplicarlo a la llamada al bean. Podemos hacerlo utilizando anotaciones o utilizando descriptores de despliegue XML. Veremos ambas opciones en los siguientes apartados.</p>
</div>
</div>
<div class="sect3">
<h4 id="_aplicando_interceptores_con_anotaciones">4.3.2. Aplicando interceptores con anotaciones</h4>
<div class="paragraph">
<p>La anotación <code>@javax.interceptor.Interceptors</code> se puede usar para aplicar interceptores a un método particular de un bean o todos los métodos de un bean. Para aplicar el método anterior de profiling basta con aplicar la anotación en su definición:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">  <span class="tok-nd">@Interceptors</span><span class="tok-o">(</span><span class="tok-n">Profiler</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">)</span>
   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">addMensajeAutor</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">,</span> <span class="tok-n">String</span> <span class="tok-n">texto</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-c1">// ...</span>
   <span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La anotación <code>@Interceptors</code> también puede aplicarse a todos los métodos de negocio de un bean realizando la anotación en la clase:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Stateless</span>
<span class="tok-nd">@Interceptors</span><span class="tok-o">(</span><span class="tok-n">Profiler</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">AutorServiceBean</span> <span class="tok-kd">implements</span> <span class="tok-n">AutorServiceLocal</span> <span class="tok-o">{</span>

   <span class="tok-nd">@PersistenceContext</span><span class="tok-o">(</span><span class="tok-n">unitName</span> <span class="tok-o">=</span> <span class="tok-s">&quot;ejb-jpa-ejbPU&quot;</span><span class="tok-o">)</span>
   <span class="tok-n">EntityManager</span> <span class="tok-n">em</span><span class="tok-o">;</span>
   <span class="tok-nd">@EJB</span>
   <span class="tok-n">MensajeServiceDetachedLocal</span> <span class="tok-n">mensajeService</span><span class="tok-o">;</span>

   <span class="tok-kd">public</span> <span class="tok-n">Autor</span> <span class="tok-nf">findAutor</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-k">return</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Autor</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-n">nombre</span><span class="tok-o">);</span>
   <span class="tok-o">}</span>
   <span class="tok-c1">// ...</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_aplicando_interceptores_con_xml">4.3.3. Aplicando interceptores con XML</h4>
<div class="paragraph">
<p>Aunque la anotación <code>@Interceptors</code> nos permite aplicar fácilmente los interceptores, tiene el inconveniente de que nos obliga a modificar y recompilar el código cada vez que queremos añadirlos o deshabilitarlos. Es más interesante definir los interceptores mediante XML, en el fichero descriptor de despliegue <code>ejb-jar.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tok-nt">&lt;ejb-jar</span> <span class="tok-na">xmlns =</span> <span class="tok-s">&quot;http://java.sun.com/xml/ns/javaee&quot;</span>
         <span class="tok-na">version =</span> <span class="tok-s">&quot;3.0&quot;</span>
         <span class="tok-na">xmlns:xsi =</span> <span class="tok-s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
         <span class="tok-na">xsi:schemaLocation =</span> <span class="tok-s">&quot;http://java.sun.com/xml/ns/javaee</span>
<span class="tok-s">         http://java.sun.com/xml/ns/javaee/ejb-jar_3_0.xsd&quot;</span><span class="tok-nt">&gt;</span>
<span class="tok-nt">&lt;assembly-descriptor&gt;</span>
   <span class="tok-nt">&lt;interceptor-binding&gt;</span>
      <span class="tok-nt">&lt;ejb-name&gt;</span>AutorServiceBean<span class="tok-nt">&lt;/ejb-name&gt;</span>
      <span class="tok-nt">&lt;interceptor-class&gt;</span>es.ua.jtech.ejb.interceptor.Profiler<span class="tok-nt">&lt;/interceptor-class&gt;</span>
      <span class="tok-nt">&lt;method&gt;</span>
         <span class="tok-nt">&lt;method-name&gt;</span>addMensajeAutor<span class="tok-nt">&lt;/method-name&gt;</span>
      <span class="tok-nt">&lt;/method&gt;</span>
   <span class="tok-nt">&lt;/interceptor-binding&gt;</span>
<span class="tok-nt">&lt;/assembly-descriptor&gt;</span>
<span class="tok-nt">&lt;/ejb-jar&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Una de las ventajas de utilizar el descriptor de despliegue XML es que es posible aplicar el interceptor a todos los métodos de todos los beans desplegados en el módulo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tok-nt">&lt;ejb-jar</span> <span class="tok-na">xmlns =</span> <span class="tok-s">&quot;http://java.sun.com/xml/ns/javaee&quot;</span>
         <span class="tok-na">version =</span> <span class="tok-s">&quot;3.0&quot;</span>
         <span class="tok-na">xmlns:xsi =</span> <span class="tok-s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
         <span class="tok-na">xsi:schemaLocation =</span> <span class="tok-s">&quot;http://java.sun.com/xml/ns/javaee</span>
<span class="tok-s">         http://java.sun.com/xml/ns/javaee/ejb-jar_3_0.xsd&quot;</span><span class="tok-nt">&gt;</span>
<span class="tok-nt">&lt;assembly-descriptor&gt;</span>
   <span class="tok-nt">&lt;interceptor-binding&gt;</span>
      <span class="tok-nt">&lt;ejb-name&gt;</span>*<span class="tok-nt">&lt;/ejb-name&gt;</span>
      <span class="tok-nt">&lt;interceptor-class&gt;</span>es.ua.jtech.ejb.interceptor.Profiler<span class="tok-nt">&lt;/interceptor-class&gt;</span>
   <span class="tok-nt">&lt;/interceptor-binding&gt;</span>
<span class="tok-nt">&lt;/assembly-descriptor&gt;</span>
<span class="tok-nt">&lt;/ejb-jar&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios_4">4.4. Ejercicios</h3>
<div class="sect3">
<h4 id="__0_75_puntos_bean_temporizador">4.4.1. (0,75 puntos) Bean temporizador</h4>
<div class="paragraph">
<p>En el módulo <code>saludo</code> añade un ejemplo de bean temporizador, junto con un servlet que lo lance. Actualiza en <code>index.jsp</code> para poder invocar el servlet que lanza el bean.</p>
</div>
</div>
<div class="sect3">
<h4 id="__0_75_puntos_bean_interceptor">4.4.2. (0,75 puntos) Bean interceptor</h4>
<div class="paragraph">
<p>Define también en el módulo <code>saludo</code> un bean interceptor que escriba en la salida estándar todas las peticiones de saludo realizadas y todos los saludos devueltos.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2014-11-29 07:24:59 CET
</div>
</div>
</body>
</html>