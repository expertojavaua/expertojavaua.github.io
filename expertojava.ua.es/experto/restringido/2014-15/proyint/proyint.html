<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.2">
<meta name="author" content="María Isabel Alfonso, Domingo Gallardo, Alejandro Such, Jose Luis Zamora">
<title>Proyecto de Aplicación Web</title>
<style>/*! normalize.css v2.1.2 | MIT License | git.io/normalize */
/* ========================================================================== HTML5 display definitions ========================================================================== */
/** Correct `block` display not defined in IE 8/9. */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }

/** Correct `inline-block` display not defined in IE 8/9. */
audio, canvas, video { display: inline-block; }

/** Prevent modern browsers from displaying `audio` without controls. Remove excess height in iOS 5 devices. */
audio:not([controls]) { display: none; height: 0; }

/** Address `[hidden]` styling not present in IE 8/9. Hide the `template` element in IE, Safari, and Firefox < 22. */
[hidden], template { display: none; }

script { display: none !important; }

/* ========================================================================== Base ========================================================================== */
/** 1. Set default font family to sans-serif. 2. Prevent iOS text size adjust after orientation change, without disabling user zoom. */
html { font-family: sans-serif; /* 1 */ -ms-text-size-adjust: 100%; /* 2 */ -webkit-text-size-adjust: 100%; /* 2 */ }

/** Remove default margin. */
body { margin: 0; }

/* ========================================================================== Links ========================================================================== */
/** Remove the gray background color from active links in IE 10. */
a { background: transparent; }

/** Address `outline` inconsistency between Chrome and other browsers. */
a:focus { outline: thin dotted; }

/** Improve readability when focused and also mouse hovered in all browsers. */
a:active, a:hover { outline: 0; }

/* ========================================================================== Typography ========================================================================== */
/** Address variable `h1` font-size and margin within `section` and `article` contexts in Firefox 4+, Safari 5, and Chrome. */
h1 { font-size: 2em; margin: 0.67em 0; }

/** Address styling not present in IE 8/9, Safari 5, and Chrome. */
abbr[title] { border-bottom: 1px dotted; }

/** Address style set to `bolder` in Firefox 4+, Safari 5, and Chrome. */
b, strong { font-weight: bold; }

/** Address styling not present in Safari 5 and Chrome. */
dfn { font-style: italic; }

/** Address differences between Firefox and other browsers. */
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }

/** Address styling not present in IE 8/9. */
mark { background: #ff0; color: #000; }

/** Correct font family set oddly in Safari 5 and Chrome. */
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }

/** Improve readability of pre-formatted text in all browsers. */
pre { white-space: pre-wrap; }

/** Set consistent quote types. */
q { quotes: "\201C" "\201D" "\2018" "\2019"; }

/** Address inconsistent and variable font size in all browsers. */
small { font-size: 80%; }

/** Prevent `sub` and `sup` affecting `line-height` in all browsers. */
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }

sup { top: -0.5em; }

sub { bottom: -0.25em; }

/* ========================================================================== Embedded content ========================================================================== */
/** Remove border when inside `a` element in IE 8/9. */
img { border: 0; }

/** Correct overflow displayed oddly in IE 9. */
svg:not(:root) { overflow: hidden; }

/* ========================================================================== Figures ========================================================================== */
/** Address margin not present in IE 8/9 and Safari 5. */
figure { margin: 0; }

/* ========================================================================== Forms ========================================================================== */
/** Define consistent border, margin, and padding. */
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }

/** 1. Correct `color` not being inherited in IE 8/9. 2. Remove padding so people aren't caught out if they zero out fieldsets. */
legend { border: 0; /* 1 */ padding: 0; /* 2 */ }

/** 1. Correct font family not being inherited in all browsers. 2. Correct font size not being inherited in all browsers. 3. Address margins set differently in Firefox 4+, Safari 5, and Chrome. */
button, input, select, textarea { font-family: inherit; /* 1 */ font-size: 100%; /* 2 */ margin: 0; /* 3 */ }

/** Address Firefox 4+ setting `line-height` on `input` using `!important` in the UA stylesheet. */
button, input { line-height: normal; }

/** Address inconsistent `text-transform` inheritance for `button` and `select`. All other form control elements do not inherit `text-transform` values. Correct `button` style inheritance in Chrome, Safari 5+, and IE 8+. Correct `select` style inheritance in Firefox 4+ and Opera. */
button, select { text-transform: none; }

/** 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio` and `video` controls. 2. Correct inability to style clickable `input` types in iOS. 3. Improve usability and consistency of cursor style between image-type `input` and others. */
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; /* 2 */ cursor: pointer; /* 3 */ }

/** Re-set default cursor for disabled elements. */
button[disabled], html input[disabled] { cursor: default; }

/** 1. Address box sizing set to `content-box` in IE 8/9. 2. Remove excess padding in IE 8/9. */
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; /* 1 */ padding: 0; /* 2 */ }

/** 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome. 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome (include `-moz` to future-proof). */
input[type="search"] { -webkit-appearance: textfield; /* 1 */ -moz-box-sizing: content-box; -webkit-box-sizing: content-box; /* 2 */ box-sizing: content-box; }

/** Remove inner padding and search cancel button in Safari 5 and Chrome on OS X. */
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }

/** Remove inner padding and border in Firefox 4+. */
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }

/** 1. Remove default vertical scrollbar in IE 8/9. 2. Improve readability and alignment in all browsers. */
textarea { overflow: auto; /* 1 */ vertical-align: top; /* 2 */ }

/* ========================================================================== Tables ========================================================================== */
/** Remove most spacing between table cells. */
table { border-collapse: collapse; border-spacing: 0; }

meta.foundation-mq-small { font-family: "only screen and (min-width: 768px)"; width: 768px; }

meta.foundation-mq-medium { font-family: "only screen and (min-width:1280px)"; width: 1280px; }

meta.foundation-mq-large { font-family: "only screen and (min-width:1440px)"; width: 1440px; }

*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }

html, body { font-size: 97%; }

body { background: white; color: #222222; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }

a:hover { cursor: pointer; }

img, object, embed { max-width: 100%; height: auto; }

object, embed { height: 100%; }

img { -ms-interpolation-mode: bicubic; }

#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }

.left { float: left !important; }

.right { float: right !important; }

.text-left { text-align: left !important; }

.text-right { text-align: right !important; }

.text-center { text-align: center !important; }

.text-justify { text-align: justify !important; }

.hide { display: none; }

.antialiased, body { -webkit-font-smoothing: antialiased; }

img { display: inline-block; vertical-align: middle; }

textarea { height: auto; min-height: 50px; }

select { width: 100%; }

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }

.subheader, .admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { line-height: 1.4; color: #6f6f6f; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }

/* Typography resets */
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }

/* Default Link Styles */
a { color: #1164be; text-decoration: none; line-height: inherit; }
a img { border: none; }

/* Default paragraph styles */
p { font-family: inherit; font-weight: normal; font-size: 1em; line-height: 1.4; margin-bottom: 1em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }

/* Default header styles */
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: bold; font-style: normal; color: #222222; text-rendering: optimizeLegibility; margin-top: 1em; margin-bottom: 0.5em; line-height: 1.2125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #6f6f6f; line-height: 0; }

h1 { font-size: 2.125em; }

h2 { font-size: 1.6875em; }

h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }

h4 { font-size: 1.125em; }

h5 { font-size: 1.125em; }

h6 { font-size: 1em; }

hr { border: solid #dddddd; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }

/* Helpful Typography Defaults */
em, i { font-style: italic; line-height: inherit; }

strong, b { font-weight: bold; line-height: inherit; }

small { font-size: 60%; line-height: inherit; }

code { font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: bold; }

/* Lists */
ul, ol, dl { font-size: 1em; line-height: 1.4; margin-bottom: 1.25em; list-style-position: outside; font-family: inherit; }

ul, ol { margin-left: 2.5em; }
ul.no-bullet, ol.no-bullet { margin-left: 1.5em; }

/* Unordered Lists */
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; /* Override nested font-size change */ }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }

/* Ordered Lists */
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }

/* Definition Lists */
dl dt { margin-bottom: 0.3125em; font-weight: bold; }
dl dd { margin-bottom: 1.25em; }

/* Abbreviations */
abbr, acronym { text-transform: uppercase; font-size: 90%; color: #222222; border-bottom: 1px dotted #dddddd; cursor: help; }

abbr { text-transform: none; }

/* Blockquotes */
blockquote { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
blockquote cite { display: block; font-size: 0.8125em; color: #555555; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #555555; }

blockquote, blockquote p { line-height: 1.6; color: #6f6f6f; }

/* Microformats */
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #dddddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }

.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }

@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.6875em; }
  h4 { font-size: 1.4375em; } }
/* Tables */
table { background: white; margin-bottom: 1.25em; border: solid 1px #dddddd; }
table thead, table tfoot { background: whitesmoke; font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: #222222; text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: #222222; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #f9f9f9; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.4; }

h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; border-bottom: 1px solid #dddddd }

.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }

*:not(pre) > code { font-size: inherit; font-style: normal !important; letter-spacing: 0; padding: 3px 2px 1px 2px; background-color: #eeeeee; border: 1px solid #dddddd; -webkit-border-radius: 0; border-radius: 0; line-height: inherit; font-weight: normal; }

pre, pre > code { line-height: 1.4; color: black; font-family: monospace, serif; font-weight: normal; }

.keyseq { color: #555555; }

kbd { display: inline-block; color: #222222; font-size: 0.75em; line-height: 1.4; background-color: #f7f7f7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; margin: -0.15em 0.15em 0 0.15em; padding: 0.2em 0.6em 0.2em 0.5em; vertical-align: middle; white-space: nowrap; }

.keyseq kbd:first-child { margin-left: 0; }

.keyseq kbd:last-child { margin-right: 0; }

.menuseq, .menu { color: #090909; }

b.button:before, b.button:after { position: relative; top: -1px; font-weight: normal; }

b.button:before { content: "["; padding: 0 3px 0 2px; }

b.button:after { content: "]"; padding: 0 2px 0 3px; }

#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 0.9375em; padding-right: 0.9375em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }

#content { margin-top: 1.25em; }

#content:before { content: none; }

#header > h1:first-child { color: black; margin-top: 2.25rem; margin-bottom: 0; }
#header > h1:first-child + #toc { margin-top: 8px; border-top: 1px solid #dddddd; }
#header > h1:only-child, body.toc2 #header > h1:nth-last-child(2) { border-bottom: 1px solid #dddddd; padding-bottom: 8px; }
#header .details { border-bottom: 1px solid #dddddd; line-height: 1.45; padding-top: 0.25em; padding-bottom: 0.25em; padding-left: 0.25em; color: #555555; display: -ms-flexbox; display: -webkit-flex; display: flex; -ms-flex-flow: row wrap; -webkit-flex-flow: row wrap; flex-flow: row wrap; }
#header .details span:first-child { margin-left: -0.125em; }
#header .details span.email a { color: #6f6f6f; }
#header .details br { display: none; }
#header .details br + span:before { content: "\00a0\2013\00a0"; }
#header .details br + span.author:before { content: "\00a0\22c5\00a0"; color: #6f6f6f; }
#header .details br + span#revremark:before { content: "\00a0|\00a0"; }
#header #revnumber { text-transform: capitalize; }
#header #revnumber:after { content: "\00a0"; }

#content > h1:first-child:not([class]) { color: black; border-bottom: 1px solid #dddddd; padding-bottom: 8px; margin-top: 0; padding-top: 1rem; margin-bottom: 1.25rem; }

#floating {
  position: fixed;
  z-index: 1000;
  padding: 0.5em;
  right: 0;
  top: 0;
  background: white;
  box-shadow: 0 0 1em #777777;
  -webkit-box-shadow: 0 0 1em #777777;
  -moz-box-shadow: 0 0 1em #777777;
  -webkit-border-bottom-left-radius: 5px;
  -moz-border-radius-bottomleft: 5px;
  max-height: 80%;
  overflow: auto;
}

#floating #full { display: none; } /* Hide the full TOC by default */

#floating:hover #full{
  display: block; /* Show it on hover */
}


#toc { border-bottom: 1px solid #dddddd; padding-bottom: 0.5em; }
#toc > ul { margin-left: 0.125em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin: 0.5em 0; }
#toc ul { font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; list-style-type: none; }
#toc a { text-decoration: none; }
#toc a:active { text-decoration: underline; }

#toctitle { color: #6f6f6f; font-size: 1.2em; }

@media only screen and (min-width: 768px) { #toctitle { font-size: 1.375em; }
  body.toc2 { padding-left: 15em; padding-right: 0; }
  #toc.toc2 { margin-top: 0 !important; background-color: #f2f2f2; position: fixed; width: 15em; left: 0; top: 0; border-right: 1px solid #dddddd; border-top-width: 0 !important; border-bottom-width: 0 !important; z-index: 1000; padding: 1.25em 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; font-size: 1.2em; }
  #toc.toc2 > ul { font-size: 0.9em; margin-bottom: 0; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 15em; }
  body.toc2.toc-right #toc.toc2 { border-right-width: 0; border-left: 1px solid #dddddd; left: auto; right: 0; } }
@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; padding-right: 0; }
  #toc.toc2 { width: 20em; }
  #toc.toc2 #toctitle { font-size: 1.375em; }
  #toc.toc2 > ul { font-size: 0.95em; }
  #toc.toc2 ul ul { padding-left: 1.25em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; } }
#content #toc { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 0; border-radius: 0; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }

#footer { max-width: 100%; background-color: #222222; padding: 1.25em; }

#footer-text { color: #dddddd; line-height: 1.44; }

.sect1 { padding-bottom: 0.625em; }

@media only screen and (min-width: 768px) { .sect1 { padding-bottom: 1.25em; } }
.sect1 + .sect1 { border-top: 1px solid #dddddd; }

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; z-index: 1001; width: 1.5ex; margin-left: -1.5ex; display: block; text-decoration: none !important; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: "\00A7"; font-size: 0.85em; display: block; padding-top: 0.1em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #222222; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #151515; }

.audioblock, .imageblock, .literalblock, .listingblock, .stemblock, .videoblock { margin-bottom: 1.25em; }

.admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-rendering: optimizeLegibility; text-align: left; }

table.tableblock > caption.title { white-space: nowrap; overflow: visible; max-width: 0; }

.paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { color: black; }

table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }

.admonitionblock > table { border-collapse: separate; border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #dddddd; color: #555555; }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }

.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 0; border-radius: 0; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }

.sidebarblock { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 0; border-radius: 0; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock > .content > .title { color: #6f6f6f; margin-top: 0; }

.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }

.literalblock pre, .listingblock pre:not(.highlight), .listingblock pre[class="highlight"], .listingblock pre[class^="highlight "], .listingblock pre.CodeRay, .listingblock pre.prettyprint { background: #eeeeee; }
.sidebarblock .literalblock pre, .sidebarblock .listingblock pre:not(.highlight), .sidebarblock .listingblock pre[class="highlight"], .sidebarblock .listingblock pre[class^="highlight "], .sidebarblock .listingblock pre.CodeRay, .sidebarblock .listingblock pre.prettyprint { background: #f2f1f1; }

.literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { border: 1px solid #cccccc; -webkit-border-radius: 0; border-radius: 0; word-wrap: break-word; padding: 0.8em 0.8em 0.65em 0.8em; font-size: 0.8125em; }
.literalblock pre.nowrap, .literalblock pre[class].nowrap, .listingblock pre.nowrap, .listingblock pre[class].nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
@media only screen and (min-width: 768px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 0.90625em; } }
@media only screen and (min-width: 1280px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 1em; } }

.literalblock.output pre { color: #eeeeee; background-color: black; }

.listingblock pre.highlightjs { padding: 0; }
.listingblock pre.highlightjs > code { padding: 0.8em 0.8em 0.65em 0.8em; -webkit-border-radius: 0; border-radius: 0; }

.listingblock > .content { position: relative; }

.listingblock code[data-lang]:before { display: none; content: attr(data-lang); position: absolute; font-size: 0.75em; top: 0.425rem; right: 0.5rem; line-height: 1; text-transform: uppercase; color: #999; }

.listingblock:hover code[data-lang]:before { display: block; }

.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }

.listingblock.terminal pre .command:not([data-prompt]):before { content: "$"; }

table.pyhltable { border-collapse: separate; border: 0; margin-bottom: 0; background: none; }

table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; }

table.pyhltable td.code { padding-left: .75em; padding-right: 0; }

pre.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #dddddd; }

pre.pygments .lineno { display: inline-block; margin-right: .25em; }

table.pyhltable .linenodiv { background: none !important; padding-right: 0 !important; }

.quoteblock { margin: 0 1em 1.25em 1.5em; display: table; }
.quoteblock > .title { margin-left: -1.5em; margin-bottom: 0.75em; }
.quoteblock blockquote, .quoteblock blockquote p { color: #6f6f6f; font-size: 1.15rem; line-height: 1.75; word-spacing: 0.1em; letter-spacing: 0; font-style: italic; text-align: justify; }
.quoteblock blockquote { margin: 0; padding: 0; border: 0; }
.quoteblock blockquote:before { content: "\201c"; float: left; font-size: 2.75em; font-weight: bold; line-height: 0.6em; margin-left: -0.6em; color: #6f6f6f; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: 0.5em; margin-right: 0.5ex; text-align: right; }
.quoteblock .quoteblock { margin-left: 0; margin-right: 0; padding: 0.5em 0; border-left: 3px solid #555555; }
.quoteblock .quoteblock blockquote { padding: 0 0 0 0.75em; }
.quoteblock .quoteblock blockquote:before { display: none; }

.verseblock { margin: 0 1em 1.25em 1em; }
.verseblock pre { font-family: "Open Sans", "DejaVu Sans", sans; font-size: 1.15rem; color: #6f6f6f; font-weight: 300; text-rendering: optimizeLegibility; }
.verseblock pre strong { font-weight: 400; }
.verseblock .attribution { margin-top: 1.25rem; margin-left: 0.5ex; }

.quoteblock .attribution, .verseblock .attribution { font-size: 0.8125em; line-height: 1.45; font-style: italic; }
.quoteblock .attribution br, .verseblock .attribution br { display: none; }
.quoteblock .attribution cite, .verseblock .attribution cite { display: block; letter-spacing: -0.05em; color: #555555; }

.quoteblock.abstract { margin: 0 0 1.25em 0; display: block; }
.quoteblock.abstract blockquote, .quoteblock.abstract blockquote p { text-align: left; word-spacing: 0; }
.quoteblock.abstract blockquote:before, .quoteblock.abstract blockquote p:first-of-type:before { display: none; }

table.tableblock { max-width: 100%; border-collapse: separate; }
table.tableblock td > .paragraph:last-child p > p:last-child, table.tableblock th > p:last-child, table.tableblock td > p:last-child { margin-bottom: 0; }

table.spread { width: 100%; }

table.tableblock, th.tableblock, td.tableblock { border: 0 solid #dddddd; }

table.grid-all th.tableblock, table.grid-all td.tableblock { border-width: 0 1px 1px 0; }

table.grid-all tfoot > tr > th.tableblock, table.grid-all tfoot > tr > td.tableblock { border-width: 1px 1px 0 0; }

table.grid-cols th.tableblock, table.grid-cols td.tableblock { border-width: 0 1px 0 0; }

table.grid-all * > tr > .tableblock:last-child, table.grid-cols * > tr > .tableblock:last-child { border-right-width: 0; }

table.grid-rows th.tableblock, table.grid-rows td.tableblock { border-width: 0 0 1px 0; }

table.grid-all tbody > tr:last-child > th.tableblock, table.grid-all tbody > tr:last-child > td.tableblock, table.grid-all thead:last-child > tr > th.tableblock, table.grid-rows tbody > tr:last-child > th.tableblock, table.grid-rows tbody > tr:last-child > td.tableblock, table.grid-rows thead:last-child > tr > th.tableblock { border-bottom-width: 0; }

table.grid-rows tfoot > tr > th.tableblock, table.grid-rows tfoot > tr > td.tableblock { border-width: 1px 0 0 0; }

table.frame-all { border-width: 1px; }

table.frame-sides { border-width: 0 1px; }

table.frame-topbot { border-width: 1px 0; }

th.halign-left, td.halign-left { text-align: left; }

th.halign-right, td.halign-right { text-align: right; }

th.halign-center, td.halign-center { text-align: center; }

th.valign-top, td.valign-top { vertical-align: top; }

th.valign-bottom, td.valign-bottom { vertical-align: bottom; }

th.valign-middle, td.valign-middle { vertical-align: middle; }

table thead th, table tfoot th { font-weight: bold; }

tbody tr th { display: table-cell; line-height: 1.4; background: whitesmoke; }

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p { color: #222222; font-weight: bold; }

p.tableblock > code:only-child { background: none; padding: 0; }

p.tableblock { font-size: 1em; }

td > div.verse { white-space: pre; }

ol { margin-left: 2.5em; }

ul li ol { margin-left: 1.5em; }

dl dd { margin-left: 1.125em; }

dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }

ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.625em; }

ul.unstyled, ol.unnumbered, ul.checklist, ul.none { list-style-type: none; }

ul.unstyled, ol.unnumbered, ul.checklist { margin-left: 0.625em; }

ul.checklist li > p:first-child > .fa-check-square-o:first-child, ul.checklist li > p:first-child > input[type="checkbox"]:first-child { margin-right: 0.25em; }

ul.checklist li > p:first-child > input[type="checkbox"]:first-child { position: relative; top: 1px; }

ul.inline { margin: 0 auto 0.625em auto; margin-left: -1.375em; margin-right: 0; padding: 0; list-style: none; overflow: hidden; }
ul.inline > li { list-style: none; float: left; margin-left: 1.375em; display: block; }
ul.inline > li > * { display: block; }

.unstyled dl dt { font-weight: normal; font-style: normal; }

ol.arabic { list-style-type: decimal; }

ol.decimal { list-style-type: decimal-leading-zero; }

ol.loweralpha { list-style-type: lower-alpha; }

ol.upperalpha { list-style-type: upper-alpha; }

ol.lowerroman { list-style-type: lower-roman; }

ol.upperroman { list-style-type: upper-roman; }

ol.lowergreek { list-style-type: lower-greek; }

.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }

td.hdlist1 { padding-right: .75em; font-weight: bold; }

td.hdlist1, td.hdlist2 { vertical-align: top; }

.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }

.colist > table tr > td:first-of-type { padding: 0 0.75em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.25em 0; }

.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: 0 0 0 1px #dddddd; box-shadow: 0 0 0 1px #dddddd; }

.imageblock.left, .imageblock[style*="float: left"] { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }

.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }

a.image { text-decoration: none; }

span.footnote, span.footnoteref { vertical-align: super; font-size: 0.875em; }
span.footnote a, span.footnoteref a { text-decoration: none; }
span.footnote a:active, span.footnoteref a:active { text-decoration: underline; }

#footnotes { padding-top: 0.75em; padding-bottom: 0.75em; margin-bottom: 0.625em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -.25em 0 .75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.375em; line-height: 1.3; font-size: 0.875em; margin-left: 1.2em; text-indent: -1.2em; margin-bottom: .2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }

#content #footnotes { margin-top: -0.625em; margin-bottom: 0; padding: 0.75em 0; }

.gist .file-data > table { border: 0; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }

div.unbreakable { page-break-inside: avoid; }

.big { font-size: larger; }

.small { font-size: smaller; }

.underline { text-decoration: underline; }

.overline { text-decoration: overline; }

.line-through { text-decoration: line-through; }

.aqua { color: #00bfbf; }

.aqua-background { background-color: #00fafa; }

.black { color: black; }

.black-background { background-color: black; }

.blue { color: #0000bf; }

.blue-background { background-color: #0000fa; }

.fuchsia { color: #bf00bf; }

.fuchsia-background { background-color: #fa00fa; }

.gray { color: #606060; }

.gray-background { background-color: #7d7d7d; }

.green { color: #006000; }

.green-background { background-color: #007d00; }

.lime { color: #00bf00; }

.lime-background { background-color: #00fa00; }

.maroon { color: #600000; }

.maroon-background { background-color: #7d0000; }

.navy { color: #000060; }

.navy-background { background-color: #00007d; }

.olive { color: #606000; }

.olive-background { background-color: #7d7d00; }

.purple { color: #600060; }

.purple-background { background-color: #7d007d; }

.red { color: #bf0000; }

.red-background { background-color: #fa0000; }

.silver { color: #909090; }

.silver-background { background-color: #bcbcbc; }

.teal { color: #006060; }

.teal-background { background-color: #007d7d; }

.white { color: #bfbfbf; }

.white-background { background-color: #fafafa; }

.yellow { color: #bfbf00; }

.yellow-background { background-color: #fafa00; }

span.icon > .fa { cursor: default; }

.admonitionblock td.icon [class^="fa icon-"] { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #207c98; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }

.conum[data-value] { display: inline-block; color: #fff !important; background-color: #222222; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; font-size: 0.75em; width: 1.67em; height: 1.67em; line-height: 1.67em; font-family: "Open Sans", "DejaVu Sans", sans-serif; font-style: normal; font-weight: bold; }
.conum[data-value] * { color: #fff !important; }
.conum[data-value] + b { display: none; }
.conum[data-value]:after { content: attr(data-value); }
pre .conum[data-value] { position: relative; top: -0.125em; }

b.conum * { color: inherit !important; }

.conum:not([data-value]):empty { display: none; }

.literalblock pre, .listingblock pre { background: #eeeeee; }

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.min.css">
<style>.listingblock .pygments .hll { background-color: #ffffcc }
.listingblock .pygments  { background: #f8f8f8; }
.listingblock .pygments .tok-c { color: #408080; font-style: italic } /* Comment */
.listingblock .pygments .tok-err { border: 1px solid #FF0000 } /* Error */
.listingblock .pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
.listingblock .pygments .tok-o { color: #666666 } /* Operator */
.listingblock .pygments .tok-cm { color: #408080; font-style: italic } /* Comment.Multiline */
.listingblock .pygments .tok-cp { color: #BC7A00 } /* Comment.Preproc */
.listingblock .pygments .tok-c1 { color: #408080; font-style: italic } /* Comment.Single */
.listingblock .pygments .tok-cs { color: #408080; font-style: italic } /* Comment.Special */
.listingblock .pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
.listingblock .pygments .tok-ge { font-style: italic } /* Generic.Emph */
.listingblock .pygments .tok-gr { color: #FF0000 } /* Generic.Error */
.listingblock .pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
.listingblock .pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
.listingblock .pygments .tok-go { color: #888888 } /* Generic.Output */
.listingblock .pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.listingblock .pygments .tok-gs { font-weight: bold } /* Generic.Strong */
.listingblock .pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.listingblock .pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
.listingblock .pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.listingblock .pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.listingblock .pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.listingblock .pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
.listingblock .pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.listingblock .pygments .tok-kt { color: #B00040 } /* Keyword.Type */
.listingblock .pygments .tok-m { color: #666666 } /* Literal.Number */
.listingblock .pygments .tok-s { color: #BA2121 } /* Literal.String */
.listingblock .pygments .tok-na { color: #7D9029 } /* Name.Attribute */
.listingblock .pygments .tok-nb { color: #008000 } /* Name.Builtin */
.listingblock .pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
.listingblock .pygments .tok-no { color: #880000 } /* Name.Constant */
.listingblock .pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
.listingblock .pygments .tok-ni { color: #999999; font-weight: bold } /* Name.Entity */
.listingblock .pygments .tok-ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.listingblock .pygments .tok-nf { color: #0000FF } /* Name.Function */
.listingblock .pygments .tok-nl { color: #A0A000 } /* Name.Label */
.listingblock .pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.listingblock .pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
.listingblock .pygments .tok-nv { color: #19177C } /* Name.Variable */
.listingblock .pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.listingblock .pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
.listingblock .pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
.listingblock .pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
.listingblock .pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
.listingblock .pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
.listingblock .pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
.listingblock .pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
.listingblock .pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
.listingblock .pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.listingblock .pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
.listingblock .pygments .tok-se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.listingblock .pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
.listingblock .pygments .tok-si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.listingblock .pygments .tok-sx { color: #008000 } /* Literal.String.Other */
.listingblock .pygments .tok-sr { color: #BB6688 } /* Literal.String.Regex */
.listingblock .pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
.listingblock .pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
.listingblock .pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
.listingblock .pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
.listingblock .pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
.listingblock .pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
.listingblock .pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Proyecto de Aplicación Web</h1>
<div class="details">
<span id="author" class="author">María Isabel Alfonso</span><br>
<span id="email" class="email"><a href="mailto:eli@ua.es">eli@ua.es</a></span><br>
<span id="author2" class="author">Domingo Gallardo</span><br>
<span id="email2" class="email"><a href="mailto:domingo.gallardo@ua.es">domingo.gallardo@ua.es</a></span><br>
<span id="author3" class="author">Alejandro Such</span><br>
<span id="email3" class="email"><a href="mailto:alejandro.such@ua.es">alejandro.such@ua.es</a></span><br>
<span id="author4" class="author">Jose Luis Zamora</span><br>
<span id="email4" class="email"><a href="mailto:joseluis.zamora@ua.es">joseluis.zamora@ua.es</a></span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Índice de contenidos</div>
<ul class="sectlevel1">
<li><a href="#sesion00">1. Presentación</a>
<ul class="sectlevel2">
<li><a href="#_la_plataforma_java_ee">1.1. La plataforma Java EE</a>
<ul class="sectlevel3">
<li><a href="#_la_plataforma_java">1.1.1. La plataforma Java</a></li>
<li><a href="#_aplicaciones_web_y_servidores_de_aplicaciones">1.1.2. Aplicaciones web y servidores de aplicaciones</a></li>
<li><a href="#_historia_de_java_ee">1.1.3. Historia de Java EE</a></li>
<li><a href="#_detalles_de_la_plataforma_java_ee_7">1.1.4. Detalles de la plataforma Java EE 7</a></li>
</ul>
</li>
<li><a href="#_arquitectura_del_proyecto_de_aplicaci%C3%B3n_web">1.2. Arquitectura del proyecto de aplicación web</a>
<ul class="sectlevel3">
<li><a href="#_aplicaciones_web_basadas_en_rest">1.2.1. Aplicaciones web basadas en REST</a></li>
<li><a href="#_servicio_rest">1.2.2. Servicio REST</a></li>
<li><a href="#_aplicaci%C3%B3n_cliente_javascript">1.2.3. Aplicación cliente JavaScript</a></li>
</ul>
</li>
<li><a href="#_gu%C3%ADa_de_laboratorio">1.3. Guía de laboratorio</a>
<ul class="sectlevel3">
<li><a href="#_materiales_docentes">1.3.1. Materiales docentes</a></li>
<li><a href="#_moodle">1.3.2. Moodle</a></li>
<li><a href="#_ordenadores_de_la_ua">1.3.3. Ordenadores de la UA</a></li>
<li><a href="#_m%C3%A1quina_virtual_virtual_box">1.3.4. Máquina virtual Virtual Box</a></li>
<li><a href="#_m%C3%A1quina_virtual_lubuntu">1.3.5. Máquina virtual Lubuntu</a></li>
<li><a href="#_paso_a_paso_creaci%C3%B3n_de_la_mv_ubuntu_en_el_ordenador_anfitri%C3%B3n">1.3.6. Paso a paso: creación de la MV Ubuntu en el ordenador anfitrión</a></li>
<li><a href="#_git_y_bitbucket">1.3.7. Git y Bitbucket</a></li>
<li><a href="#_creaci%C3%B3n_de_proyectos_con_intellij">1.3.8. Creación de proyectos con IntelliJ</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sesion01">2. (1,5 puntos) Caso de estudio</a>
<ul class="sectlevel2">
<li><a href="#_introducci%C3%B3n_a_maven">2.1. Introducción a Maven</a>
<ul class="sectlevel3">
<li><a href="#_instalaci%C3%B3n_de_maven">2.1.1. Instalación de Maven</a></li>
<li><a href="#_dependencias_de_librer%C3%ADas_en_proyectos_java">2.1.2. Dependencias de librerías en proyectos Java</a></li>
<li><a href="#_el_proceso_de_build_de_un_proyecto">2.1.3. El proceso de build de un proyecto</a></li>
<li><a href="#_estructura_de_un_proyecto_maven">2.1.4. Estructura de un proyecto Maven</a></li>
<li><a href="#_pom_project_object_model">2.1.5. POM: Project Object Model</a></li>
<li><a href="#_repositorios_maven">2.1.6. Repositorios Maven</a></li>
<li><a href="#_versiones">2.1.7. Versiones</a></li>
<li><a href="#_gesti%C3%B3n_de_dependencias">2.1.8. Gestión de dependencias</a></li>
<li><a href="#_el_ciclo_de_vida_de_maven">2.1.9. El ciclo de vida de Maven</a></li>
<li><a href="#_ejecuci%C3%B3n_de_tests">2.1.10. Ejecución de  tests</a></li>
<li><a href="#_uso_de_maven_en_intellij">2.1.11. Uso de Maven en IntelliJ</a></li>
<li><a href="#_maven_con_git">2.1.12. Maven con Git</a></li>
</ul>
</li>
<li><a href="#_paso_a_paso_despliegue_con_maven">2.2. Paso a paso: despliegue con Maven</a></li>
<li><a href="#_paso_a_paso_despliegue_con_intellij">2.3. Paso a paso: despliegue con IntelliJ</a></li>
<li><a href="#_caso_de_estudio_y_modelo_de_dominio">2.4. Caso de estudio y modelo de dominio</a>
<ul class="sectlevel3">
<li><a href="#_introducci%C3%B3n">2.4.1. Introducción</a></li>
<li><a href="#_historias_de_usuario">2.4.2. Historias de usuario</a></li>
<li><a href="#_requisitos_de_informaci%C3%B3n_irq">2.4.3. Requisitos de información (IRQ)</a></li>
<li><a href="#_casos_de_uso">2.4.4. Casos de uso</a></li>
<li><a href="#_requisitos_de_restricci%C3%B3n_crq">2.4.5. Requisitos de restricción (CRQ)</a></li>
<li><a href="#_modelo_de_clases">2.4.6. Modelo de clases</a></li>
</ul>
</li>
<li><a href="#_desarrollo_e_implementaci%C3%B3n_parte_guiada_0_5_puntos">2.5. Desarrollo e implementación (parte guiada, 0,5 puntos)</a>
<ul class="sectlevel3">
<li><a href="#_clase_de_domino_code_libro_code">2.5.1. Clase de domino <code>Libro</code></a></li>
<li><a href="#_jerarqu%C3%ADa_de_clases_code_usuario_code_code_alumno_code_code_profesor_code">2.5.2. Jerarquía de clases <code>Usuario</code>, <code>Alumno</code>, <code>Profesor</code></a></li>
<li><a href="#_gesti%C3%B3n_de_excepciones">2.5.3. Gestión de excepciones</a></li>
<li><a href="#_reglas_de_negocio">2.5.4. Reglas de negocio</a></li>
<li><a href="#_p%C3%A1gina_web_de_prueba">2.5.5. Página web de prueba</a></li>
</ul>
</li>
<li><a href="#_desarrollo_e_implementaci%C3%B3n_parte_no_guiada_1_punto">2.6. Desarrollo e implementación (parte no guiada, 1 punto)</a></li>
</ul>
</li>
<li><a href="#sesion02">3. (2,5 puntos) Capa de persistencia y capa de negocio</a>
<ul class="sectlevel2">
<li><a href="#_api_del_servicio">3.1. API del servicio</a></li>
<li><a href="#_iteraci%C3%B3n_1">3.2. Iteración 1</a>
<ul class="sectlevel3">
<li><a href="#_capa_de_persistencia">3.2.1. Capa de persistencia</a></li>
<li><a href="#_capa_de_l%C3%B3gica_de_negocio">3.2.2. Capa de lógica de negocio</a></li>
<li><a href="#_clase_de_servicio">3.2.3. Clase de servicio</a></li>
<li><a href="#_prueba_desde_un_servlet">3.2.4. Prueba desde un servlet</a></li>
<li><a href="#_prueba_con_arquillian">3.2.5. Prueba con Arquillian</a></li>
</ul>
</li>
<li><a href="#_resto_de_iteraciones">3.3. Resto de iteraciones</a>
<ul class="sectlevel3">
<li><a href="#_entrega">3.3.1. Entrega</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sesion03">4. (1,5 puntos) Servicio REST</a>
<ul class="sectlevel2">
<li><a href="#_pantallas_y_esquema_de_navegaci%C3%B3n_del_cliente">4.1. Pantallas y esquema de navegación del cliente</a>
<ul class="sectlevel3">
<li><a href="#_acceso">4.1.1. Acceso</a></li>
<li><a href="#_listado_de_libros">4.1.2. Listado de libros</a></li>
<li><a href="#_detalle_de_libro">4.1.3. Detalle de libro</a></li>
<li><a href="#_mis_libros">4.1.4. Mis libros</a></li>
</ul>
</li>
<li><a href="#_api_rest">4.2. API REST</a>
<ul class="sectlevel3">
<li><a href="#_clases_json">4.2.1. Clases JSON</a></li>
<li><a href="#_seguridad">4.2.2. Seguridad</a></li>
<li><a href="#_usuarios">4.2.3. Usuarios</a></li>
<li><a href="#_libros">4.2.4. Libros</a></li>
</ul>
</li>
<li><a href="#_pruebas">4.3. Pruebas</a></li>
<li><a href="#_entrega_2">4.4. Entrega</a></li>
</ul>
</li>
<li><a href="#sesion04">5. (1,5 puntos) Despliegue en plataforma en la nube</a>
<ul class="sectlevel2">
<li><a href="#_revisi%C3%B3n_del_proyecto_pom_xml">5.1. Revisión del proyecto pom.xml</a>
<ul class="sectlevel3">
<li><a href="#_tareas">5.1.1. Tareas</a></li>
</ul>
</li>
<li><a href="#_revisi%C3%B3n_del_entorno_local_de_pruebas">5.2. Revisión del entorno local de pruebas</a>
<ul class="sectlevel3">
<li><a href="#_tareas_2">5.2.1. Tareas</a></li>
</ul>
</li>
<li><a href="#_configuraci%C3%B3n_y_despliegue_de_la_capa_de_servidor_en_openshift">5.3. Configuración y despliegue de la capa de servidor en OpenShift</a>
<ul class="sectlevel3">
<li><a href="#_tareas_3">5.3.1. Tareas</a></li>
</ul>
</li>
<li><a href="#_utilizar_integraci%C3%B3n_continua_mediante_shippable_a_partir_de_nuestro_repositorio_en_bitbucket">5.4. Utilizar Integración Continua mediante Shippable a partir de nuestro repositorio en Bitbucket.</a>
<ul class="sectlevel3">
<li><a href="#_tareas_4">5.4.1. Tareas</a></li>
</ul>
</li>
<li><a href="#_entrega_3">5.5. Entrega</a></li>
<li><a href="#_referencias">5.6. Referencias</a></li>
</ul>
</li>
<li><a href="#sesion05">6. (3 puntos) Cliente AngularJS</a>
<ul class="sectlevel2">
<li><a href="#_fork_del_repositorio">6.1. Fork del repositorio</a></li>
<li><a href="#_instalaci%C3%B3n_de_las_dependencias_del_proyecto">6.2. Instalación de las dependencias del proyecto</a></li>
<li><a href="#_cors_en_clientes_web">6.3. CORS en clientes web</a></li>
<li><a href="#_aplicaci%C3%B3n_web">6.4. Aplicación web</a>
<ul class="sectlevel3">
<li><a href="#_login">6.4.1. Login</a></li>
<li><a href="#_listado_de_libros_2">6.4.2. Listado de libros</a></li>
<li><a href="#_detalle_de_un_libro">6.4.3. Detalle de un libro</a></li>
<li><a href="#_listado_de_pr%C3%A9stamos">6.4.4. Listado de préstamos</a></li>
<li><a href="#_devoluciones">6.4.5. Devoluciones.</a></li>
</ul>
</li>
<li><a href="#_control_de_acceso">6.5. Control de acceso</a></li>
<li><a href="#_comunicaci%C3%B3n_con_el_servidor">6.6. Comunicación con el servidor</a></li>
<li><a href="#_estructura_del_proyecto">6.7. Estructura del proyecto</a></li>
<li><a href="#_automatizaci%C3%B3n">6.8. Automatización</a></li>
<li><a href="#_correcci%C3%B3n">6.9. Corrección</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="sesion00">1. Presentación</h2>
<div class="sectionbody">
<div class="paragraph">
<p>En esta primera sesión vamos a introducir brevemente la plataforma Java EE, la arquitectura del proyecto de aplicación web y vamos a presentar una <em>guía de laboratorio</em> en la que introduciremos y practicaremos algunos de los servicios y herramientas que utilizaremos durante el curso: servidores del curso, ordenadores de la UA, máquina virtual, IntelliJ y Bitbucket.</p>
</div>
<div class="sect2">
<h3 id="_la_plataforma_java_ee">1.1. La plataforma Java EE</h3>
<div class="paragraph">
<p>La plataforma Java EE (Java Enterprise Edition) es la plataforma Java estándar propuesta por Oracle para el desarrollo de aplicaciones web y aplicaciones empresariales (<em>enterprise applications</em>). Nace en el año 2000 con el nombre de Java 2 EE y en sus 15 años de existencia ha evolucionado en 6 distintas versiones hasta llegar a la versión Java EE 7 existente en la actualidad.</p>
</div>
<div class="paragraph">
<p>¿Qué es una aplicación empresarial o una aplicación web? ¿Cuál es la diferencia fundamental entre estas aplicaciones y las aplicaciones Java de escritorio (Java SE)? Lo veremos con detalle más adelante, pero vamos a adelantar un concepto muy importante: el <em>servidor de aplicaciones</em>. La diferencia fundamental entre estos tipos de aplicaciones y una aplicación Java de escritorio (Java SE) es el soporte de ejecución sobre el que corren. Estas últimas corren sobre la JVM mientras que las primeras se ejecutan <em>dentro</em> de un servidor de aplicaciones.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Un <em>servidor de aplicaciones</em> es un programa Java que corre sobre la JVM y que da soporte de ejecución a otros programas Java que se <em>despliegan</em> en él.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La Máquina Virtual Java (JVM) proporciona a una aplicación Java SE todo el soporte necesario para su ejecución (bibliotecas, ejecución de <em>bytecodes</em>, soporte de multi-hilos, etc.). Sin embargo, una aplicación web o una aplicación empresarial necesita para su ejecución una capa más (que también corre sobre la JVM), un programa Java denominado <em>servidor de aplicaciones</em>. Este programa ejecuta aplicaciones web o empresariales (que <em>se despliegan</em> en él) y da soporte de ejecución (<em>runtime</em>) a todo un conjunto de servicios y recursos, como procesamiento de las peticiones HTTP, acceso a bases de datos, a colas de mensajes o gestión de objetos creados por el propio servidor de aplicaciones. Todos estos recursos están a disposición de la aplicación desplegada y del programador que la desarrolla. Veremos más adelante estos conceptos con más detalle.</p>
</div>
<div class="paragraph">
<p>Existen dos posibles enfoques para definir la arquitectura de una aplicación Java EE.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>En la versión más tradicional de la plataforma Java EE las aplicaciones web están diseñadas como una aplicación multi-capa, con una capa de <em>frontend</em> que genera la presentación HTML, una capa intermedia que proporciona seguridad y transaccionalidad y una capa de <em>backend</em> que proporciona conectividad a una base de datos o a un sistema heredado (<em>legacy</em>). Todo ello en el servidor.</p>
</li>
<li>
<p>En la versión mas moderna de Java EE se promueve una arquitectura alternativa en donde la capa de presentación o <em>frontend</em> se lleva al cliente web y se implementa en HTML5 y JavaScript. El servidor implementa un servicio REST con el que se comunica el cliente usando el protocolo HTTP. Este servicio REST, implementado con el API de Java EE 7,  proporciona todas las funcionalidades de negocio y de acceso a datos. Al separar físicamente la capa de <em>frontend</em> de la capa de <em>backend</em> la aplicación se hace mucho más modular y más fácil de diseñar y mantener. Este es el estilo que vamos a seguir en el proyecto de aplicación web y en el Experto Java en general.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Aunque Java EE es una propuesta de Oracle, su diseño e implementación es un proceso en el que participan un gran número de empresas e instituciones, formando una comunidad abierta muy dinámica, con muchas aportaciones, propuestas y oportunidades.</p>
</div>
<div class="sect3">
<h4 id="_la_plataforma_java">1.1.1. La plataforma Java</h4>
<div class="paragraph">
<p>La definición de la <a href="http://en.wikipedia.org/wiki/Java_(software_platform)">plataforma Java</a> en la Wikipedia en inglés es muy acertada:</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>La plataforma Java es el nombre de un conjunto de programas relacionados que permiten desarrollar y ejecutar programas escritos en el lenguaje de programación Java. La plataforma no está ligada a un procesador o sistema operativo, sino a un motor de ejecución (llamado máquina virtual - <em>Java Virtual Machine</em>, JVM) y a un compilador con un conjunto de bibliotecas implementadas para distintos sistemas operativos y sistemas hardware, de forma que los programas Java pueden correr de forma idéntica en todos ellos.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Entre los programas que forman parte de la plataforma los dos más importantes son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>El compilador <code>javac</code> que convierte el código fuente Java en ficheros <code>.class</code> formados por código Java intermedio o <em>bytecodes</em>, idénticos para todas las plataformas</p>
</li>
<li>
<p>El intérprete <code>java</code> (JVM, <em>Java Virtual Machine</em>) que ejecuta los programas <em>bytecodes</em> de forma nativa en cada plataforma</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Una característica fundamental de Java es que los ficheros <code>.class</code> son, por tanto, <strong>multiplataforma</strong>. Y también lo son los ficheros <code>.jar</code> y <code>.war</code>, ficheros archivo en el se incluyen múltiples archivos <code>.class</code> y que constituyen las bibliotecas de clases Java que se distribuyen e instalan en los distintos sistemas operativos. No es necesario compilar distintas versiones de una determinada biblioteca para los distintos sistemas operativos, sino que la diversidad la trata el soporte de ejecución (la JVM) que interpreta estos ficheros JAR.</p>
</div>
<div class="paragraph">
<p>Dentro de la JVM hay un denominado <em>compilador JIT</em> (<em>Just In Time</em>) que optimiza el funcionamiento en tiempo de ejecución del código interpretado. De esta forma se consigue reducir muchísimo la diferencia en tiempo de ejecución entre un programa Java con <em>bytecodes</em> interpretado y un programa compilado a código nativo. La introducción de esta técnica en la JVM supuso un gran avance en la adopción de Java y una forma de vencer las críticas sobre la lentitud del código comparado con código nativo. Hoy en día ya casi nadie critica a Java por ese motivo e incluso el enfoque de la máquina virtual que interpreta código intermedio ha sido adoptado también por la plataforma .NET de Microsoft.</p>
</div>
<div class="paragraph">
<p>Otro elemento fundamental de la plataforma Java es su enorme biblioteca de clases (<em>class libraries</em>). Se trata de un conjunto de bibliotecas estándar que proporcionan una gran cantidad de utilidades y funciones para todo tipo de operaciones, como el procesamiento de expresiones regulares, el trabajo con distintos tipos de colecciones, funciones de bajo nivel de entrada-salida o el procesamiento de imágenes. Las librerías se distribuyen como ficheros JAR que se cargan de forma dinámica en el intérprete y a las que nuestras aplicaciones llaman en tiempo de ejecución.</p>
</div>
<div class="paragraph">
<p>El API de las bibliotecas Java depende de la plataforma de Java (Java SE o Java EE). Toda la biblioteca de funciones de Java SE está disponible en Java EE. La plataforma Java EE define un conjunto adicional de funcionalidades implementadas por más de 20 APIs.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint00/JavaEE_APIs.png" alt="APIs JavaEE" width="66%">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_aplicaciones_web_y_servidores_de_aplicaciones">1.1.2. Aplicaciones web y servidores de aplicaciones</h4>
<div class="paragraph">
<p>Las aplicaciones en el servidor necesitan estar funcionando continuamente para responder a todas las peticiones que reciben. Por ejemplo, una aplicación web que recibe peticiones HTTP debe estar continuamente escuchando el puerto (normalmente el 80), recibiendo las peticiones GET o POST de los clientes (navegadores), procesándolas y contestándolas.</p>
</div>
<div class="paragraph">
<p>El desarrollo de este tipo de aplicaciones sería complicadísimo si tuviéramos que preocuparnos de todo su ciclo de vida. Por ejemplo, sería un infierno tener que  implementar nosotros todo el bucle de procesamiento de las peticiones que llegan al servidor, utilizando hilos concurrentes que gestionan la entrada-salida y que lanzan las llamadas a los métodos que realizan el procesamiento.</p>
</div>
<div class="paragraph">
<p>En la plataforma Java EE se utiliza la idea de <em>contenedor</em> para solucionar este problema. El contenedor es la aplicación Java que se encarga de realizar todo el trabajo de infraestructura (como escuchar los puertos para recibir las peticiones) y que delega el procesamiento final en las aplicaciones (<em>componentes</em>) <em>desplegadas</em> en él. El desarrollador implementa estos componentes escribiendo las interfaces de las clases que se utilizan para definir los componentes. Un ejemplo concreto es el funcionamiento de los <em>servlets</em> que veremos en la primera asignatura del curso.</p>
</div>
<div class="paragraph">
<p>En palabras de Arun Gupta (en su libro <em>Java EE 7 Essentials</em>):</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Los componentes Java se despliegan en contenedores que proporcionan el soporte de su ejecución (<em>runtime</em>). Los contenedores proporcionan las APIs Java EE subyacentes a los componentes de aplicación. Las aplicaciones componentes Java EE nunca interaccionan directamente con otras aplicaciones componente. Utilizan protocolos y métodos del contenedor para interactuar entre ellas y con los servicios de la plataforma. La interposición de un contenedor entre las aplicaciones componentes y los servicios Java EE permite al contenedor inyectar transparentemente los servicios requeridos por el componete, como gestión declarativa de las transacciones, comprobaciones de seguridad, <em>pooling</em> de recursos y gestión del estado.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Los servidores de aplicaciones ofrecen tambien un conjunto de servicios relacionados con la alta disponibilidad, como son tolerancia a fallos, concurrencia o clustering.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint00/server_clients.png" alt="Servidor y clientes" width="50%">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_historia_de_java_ee">1.1.3. Historia de Java EE</h4>
<div class="paragraph">
<p>En la actualidad Sun proporciona tres grandes distribuciones (o ediciones):</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Java ME (Java Micro Edition)</dt>
<dd>
<p>Para el desarrollo de aplicaciones Java en pequeños dispositivos (móviles, tarjetas de crédito, bluetooth, televisiones o reproductores blu-ray).</p>
</dd>
<dt class="hdlist1">Java SE (Java Standard Edition)</dt>
<dd>
<p>Para el desarrollo de aplicaciones de escritorio en ordenadores personales.</p>
</dd>
<dt class="hdlist1">Java EE (Java Enterprise Edition)</dt>
<dd>
<p>Para el desarrollo de aplicaciones distribuidas (cliente-servidor o con múltiples capas) como aplicaciones web o servicios web.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>La historia de las versiones de estas distribuciones Java es la siguiente:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Enero de 1996</dt>
<dd>
<p><strong>JDK 1.0</strong>. Lanzamiento de JDK (Java Development Kit) 1.0, la primera versión del lenguaje.</p>
</dd>
<dt class="hdlist1">Febrero de 1997</dt>
<dd>
<p><strong>JDK 1.1</strong>. lanzamiento de JDK 1.1, que incluía la primera versión de JDBC y de RMI (llamadas a objetos remotos).</p>
</dd>
<dt class="hdlist1">Diciembre de 1998</dt>
<dd>
<p><strong>J2SE 1.2</strong>. En el primer cambio de nombre, la plataforma pasa a llamarse J2SE (Java 2 Platform, Standard Edition). La versión inicial de la distribución SE es la 1.2 (para mantener la numeración de versiones consistente con la del JDK). Se introducen importantes cambios en el lenguaje y en la plataforma. Se introduce la API Swing para el desarrollo de interfaces de usuario.</p>
</dd>
<dt class="hdlist1">Diciembre de 1999</dt>
<dd>
<p><strong>J2EE 1.2</strong>. Aparece la primera versión de Java Enterprise, que incluye: JSP, Servlets, JDBC, EJB, JMS, JTA y JavaMail.</p>
</dd>
<dt class="hdlist1">Mayo de 2000</dt>
<dd>
<p><strong>J2SE 1.3</strong>. Mejora la eficiencia de Java con la máquina virtual HotSpot.</p>
</dd>
<dt class="hdlist1">Septiembre de 2001</dt>
<dd>
<p><strong>J2EE 1.3</strong>. Segunda versión de Java Enterprise, en la que se mejora el rendimiento de los EJB (EJB 2.0) y se introducen nuevas versiones de las APIs como JSP 1.2 o servlets 2.3.</p>
</dd>
<dt class="hdlist1">Febrero de 2002</dt>
<dd>
<p><strong>J2SE 1.4</strong>. Se introducen APIs para tratar XML (JAXP), seguridad y criptografía (JCE, JSSE, JAAS). Se incluye Java Web Start para la distribución remota de aplicaciones Java de escritorio.</p>
</dd>
<dt class="hdlist1">Noviembre de 2003</dt>
<dd>
<p><strong>J2EE 1.4</strong>. Nuevas versiones de las APIs: EJB 2.1, JSP 1.3, Servlets 2.4, JDBC 3.0. Se introducen por primera vez las librerías para los servicios Web.</p>
</dd>
<dt class="hdlist1">Septiembre de 2004</dt>
<dd>
<p><strong>J2SE 1.5</strong>. Importantes cambios en el lenguaje: genéricos, anotaciones, enumeraciones o iteración.</p>
</dd>
<dt class="hdlist1">Mayo de 2006</dt>
<dd>
<p><strong>Java EE 5</strong>. Otro cambio de nomenclatura de la plataforma, junto con un gran cambio en bastantes APIs. Se elimina el 2 después de la palabra Java y se elimina el 1 del número de versión. Se introduce la especificación 3.0 de los EJB con anotaciones, uso de persistencia (JPA) y timers. Nuevas versiones de APIs: JSP 2.1, Servlets 2.5, JDBC 4.0. Se introduce JSF y mejoras en los servicios Web.</p>
</dd>
<dt class="hdlist1">Diciembre de 2006</dt>
<dd>
<p><strong>Java SE 6</strong>. Se incluye el cambio de nomenclatura que elimina el 2 después de Java. Mejoras en el rendimiento de Swing. Mejoras: Servicios web en Java SE, scripting (soporte para Python y Ruby), Java DB (base de datos basada en Apache Derby).</p>
</dd>
<dt class="hdlist1">Julio de 2008</dt>
<dd>
<p><strong>Java SE 7</strong>. Lenguajes dinámicos en la JVM. Nueva librería de entrada/salida. Mejoras en el intérprete/compilador HotSpot.</p>
</dd>
<dt class="hdlist1">Diciembre de 2009</dt>
<dd>
<p><strong> Java EE 6</strong>. Se introduce el perfil Web, con la intención de popularizar Java EE no sólo para el desarrollo de aplicaciones enterprise, sino también aplicaciones web sencillas. En esta línea, se define la versión reducida de EJB, EJB Lite, el API de servicios REST y los <em>Web Beans</em>.</p>
</dd>
<dt class="hdlist1">Marzo de 2014</dt>
<dd>
<p><strong>Java SE 8</strong>. Grandes cambios en el lenguaje: expresiones lambda, anotaciones.</p>
</dd>
<dt class="hdlist1">Junio de 2014</dt>
<dd>
<p><strong>Java EE 7</strong>. Se mejora el perfil Web, con énfasis en servicios REST, JSON, <em>Web sockets</em> y conexión con HTML5/JavaScript. En la parte enteprise, se profundiza en el despliegue en la nube y en el concepto de <em>platform as a service</em>.</p>
</dd>
</dl>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint00/javaee_history.png" alt="Historia Java EE" width="66%">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_detalles_de_la_plataforma_java_ee_7">1.1.4. Detalles de la plataforma Java EE 7</h4>
<div class="paragraph">
<p>La plataforma Java EE 7 se define en la <a href="https://www.jcp.org/aboutJava/communityprocess/final/jsr342/index.html">JSR 342</a>. En la especificación se definen dos <em>perfiles</em>: el perfil web y el perfil completo. El perfil web está orientado a aplicaciones web básicas que no necesitan componentes transaccionales distribuidos. Las APIs que debe ofrecer el servidor de aplicaciones que soporta este perfil son las siguientes, agrupadas por la funcionalidad que proporcionan:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Anotaciones:</p>
<div class="ulist">
<ul>
<li>
<p>Common Annotations for the Java Platform (JSR-250) 1.2</p>
</li>
</ul>
</div>
</li>
<li>
<p>Procesamiento de peticiones HTTP y ciclo de vida de la aplicación web:</p>
<div class="ulist">
<ul>
<li>
<p>Servlet 3.1</p>
</li>
<li>
<p>Managed Beans 1.0</p>
</li>
<li>
<p>Interceptors 1.2</p>
</li>
<li>
<p>Contexts and Dependency Injection for the Java EE Platform 1.1</p>
</li>
</ul>
</div>
</li>
<li>
<p>Generación de páginas HTML:</p>
<div class="ulist">
<ul>
<li>
<p>JavaServer Pages (JSP) 2.3</p>
</li>
<li>
<p>Expression Language (EL) 3.0</p>
</li>
<li>
<p>Standard Tag Library for JavaServer Pages (JSTL) 1.2</p>
</li>
<li>
<p>JavaServer Faces (JSF) 2.2</p>
</li>
</ul>
</div>
</li>
<li>
<p>Servicios REST y APIs avanzadas de comunicación con clientes:</p>
<div class="ulist">
<ul>
<li>
<p>Java API for RESTful Web Services (JAX-RS) 2.0</p>
</li>
<li>
<p>Java API for JSON Processing (JSON-P) 1.0</p>
</li>
<li>
<p>Java API for WebSocket (WebSocket) 1.0</p>
</li>
</ul>
</div>
</li>
<li>
<p>Capa de lógica de negocio y de acceso a bases de datos:</p>
<div class="ulist">
<ul>
<li>
<p>Bean Validation 1.1</p>
</li>
<li>
<p>Enterprise JavaBeans (EJB) 3.2 Lite</p>
</li>
<li>
<p>Java Persistence API (JPA) 2.1</p>
</li>
<li>
<p>Java Transaction API (JTA) 1.2</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Veremos una gran parte de estas APIs a lo largo de la primera parte del curso.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint00/javaee_themes.png" alt="Java EE" width="66%">
</div>
</div>
<div class="paragraph">
<p>La plataforma completa Java EE 7 añade a las APIs anteriores otro conjunto de características, orientadas sobre todo al soporte de aplicaciones transaccionales distribuidas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Enterprise JavaBeans (EJB) 3.2 completo</p>
</li>
<li>
<p>Java Message Service (JMS) 2.0</p>
</li>
<li>
<p>JavaMail 1.5</p>
</li>
<li>
<p>Connector 1.7</p>
</li>
<li>
<p>Web Services 1.4</p>
</li>
<li>
<p>Concurrency Utilities 1.0</p>
</li>
<li>
<p>Batch 1.0</p>
</li>
<li>
<p>Procesamiento XML con JAXB 2.2</p>
</li>
<li>
<p>Java EE Management 1.1</p>
</li>
<li>
<p>Java Authorization Contract for Containers (JACC) 1.5</p>
</li>
<li>
<p>Java Authentication Service Provider Interface for Containers (JASPIC) 1.1</p>
</li>
<li>
<p>Web Services Metadata 2.1</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Todas estas especificaciones se encuentran detalladas en distintas especficaciones denominadas JSRs (<em>Java Specification Request</em>). Cada JSR tiene un número de identificación y puede ser consultada en el sitio web <a href="https://www.jcp.org/en/home/index">Java Community Process</a>. Todas las especificaciones de APIs sufren un largo proceso desde que comienza su propuesta hasta su aprobación final en una votación en la que participan todos los <em>partners</em> interesados en el API.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, ahora mismo (el 22 de septiembre) se acaba de aprobar (con 24 votos a favor y ninguno en contra) que comience el desarrollo de la <a href="https://www.jcp.org/en/jsr/detail?id=366">JSR 366</a> que definirá la nueva especificación de Java EE 8. Todas las JSRs de APIs de la plataforma Java EE (incluidas las ya retiradas) se encuentran en <a href="https://www.jcp.org/en/jsr/platform?listBy=3&amp;listByType=platform">este enlace</a>. Y, por ejemplo, la especificación de Java EE 7 se define en la <a href="https://www.jcp.org/en/jsr/detail?id=342">JSR 342</a> que tardó dos años en ser completada.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Si la especificación de Java EE 8 tarda lo mismo en terminarse que la de Java EE 7, la nueva versión de la plataforma llegará a finales de 2016 o comienzos de 2017.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Todas estas especificaciones sirven para que empresas independientes de Oracle (y también Oracle) desarrollen servidores de aplicaciones que compitan en rendimiento y funcionalidades adicionales, pero que sean todos compatibles entre si. El servidor GlassFish de Oracle es un servidor gratuito que sirve de plataforma de prueba de las especificaciones.</p>
</div>
<div class="paragraph">
<p>En la página de Oracle de <a href="http://www.oracle.com/technetwork/java/javaee/overview/compatibility-jsp-136984.html">compatibilidad de servidores de aplicaciones Java EE</a> se listan los servidores de aplicaciones que han pasado las pruebas necesarias para obtener una compatibilidad con una determinada especificación Java EE.  Existen muy pocos servidores de aplicaciones totalmente compatibles con Java EE 7, tanto en el perfil Web como en el perfil completo:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>GlassFish (Oracle, perfiles web y completo)</p>
</li>
<li>
<p>Wildfly (anteriormente JBoss, RedHat, perfiles web y completo)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Por su mayor antiguedad, hay más servidores compatibles con Java EE 6:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>GlassFish (Oracle, perfiles web y completo)</p>
</li>
<li>
<p>WebLogic (Oracle, perfil completo)</p>
</li>
<li>
<p>Wildfly (anteriormente JBoss, RedHat, perfiles web y completo)</p>
</li>
<li>
<p>WebSphere (IBM, perfil completo)</p>
</li>
<li>
<p>Geronimo (Apache, perfil completo)</p>
</li>
<li>
<p>TomEE (Apache, perfil web)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>El servidor de aplicaciones que vamos a utilizar en el curso es <em>Wildfly</em>, uno de los más avanzados, ligeros y competitivos. Está desarrollado por Red Hat y es muy posible que lo conozcas con el nombre que tenía anteriormente: <em>JBoss</em>. Es un servidor gratuito que tiene la posibilidad de contratar licencias comerciales para su uso en entornos que requieran un funcionamiento continuo y una disposición inmediata para solución de incidencias.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_arquitectura_del_proyecto_de_aplicación_web">1.2. Arquitectura del proyecto de aplicación web</h3>
<div class="paragraph">
<p>En los últimos años está ganando cada vez más popularidad la arquitectura REST como enfoque para construir las aplicaciones web. De hecho, el temario del curso de experto y sus asignaturas está muy influenciado por esta filosofía. Y la aplicación web que vamos a implementar a lo largo del curso va a tener precisamente esta arquitectura.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint00/javaee_javascript.png" alt="Java EE - JavaScript" width="66%">
</div>
</div>
<div class="paragraph">
<p>¿En qué consiste una arquitectura REST? ¿Cuáles son sus ventajas? ¿Cuál es la razón de su popularidad? En el curso vamos a dedicar una asignatura completa a hablar de cómo construir APIs REST utilizando la tecnología Java JAX-RS. Pero vamos a avanzar ahora algunos aspectos básicos de esta arquitectura.</p>
</div>
<div class="sect3">
<h4 id="_aplicaciones_web_basadas_en_rest">1.2.1. Aplicaciones web basadas en REST</h4>
<div class="paragraph">
<p>Ideas fundamentales:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Separación clara de responsabilidades entre del cliente y el servicio: el cliente se encarga de la interfaz de usuario y el servicio de la lógica de negocio. El cliente suele ser un navegador web o una aplicación móvil en el que se ejecuta el programa que interactua con el usuario, recoge sus peticiones y las envía al servicio. El servicio realiza toda las operaciones relacionadas con el procesamiento de la petición. Recoge los datos de la petición, accede a la base de datos, procesa los resultados y los devuelve al cliente.</p>
</li>
<li>
<p>Se utiliza el protocolo HTTP como base de la comunicación entre el cliente y el servidor: el cliente realiza peticiones utilizando los métodos GET, POST, PUT o DELETE para indicar el tipo de acción a realizar y las URLs como identificadores de los recursos sobre los que se está haciendo la petición. El servidor recibe la petición y devuelve un código de respuesta HTTP y el contenido de la respuesta.</p>
</li>
<li>
<p>La comunicación entre el cliente y el servidor se realiza usando texto estructurado. Las peticiones llevan los parámetros en las cabeceras HTTP o en las URL del recurso al que se está accediendo. Y los resultados se devuelven en formato texto XML o JSON.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_servicio_rest">1.2.2. Servicio REST</h4>
<div class="paragraph">
<p>El servicio REST proporciona el <em>backend</em> de la aplicación. Lo implementamos con la tecnología Java EE, que proporciona APIs para definir las distintas capas de la aplicación:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>API JAX-RS para implementar el API REST de la aplicación</p>
</li>
<li>
<p>Objetos EJB <strong>lite</strong> para definir la lógica de negocio</p>
</li>
<li>
<p>JPA/Hibernate para definir la capa de modelo y la conexión con la base de datos</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Dibujo y ejemplo concreto.</p>
</div>
</div>
<div class="sect3">
<h4 id="_aplicación_cliente_javascript">1.2.3. Aplicación cliente JavaScript</h4>
<div class="paragraph">
<p>La aplicación cliente se ejecuta en dispositivos separados del servidor (navegadores web o dispositivos móviles), construye la interfaz con la que interactúan los usuarios y se comunica con el servicio REST usando HTTP.</p>
</div>
<div class="paragraph">
<p>La tendencia que está ganando cada vez más fuerza es construir la aplicación cliente como una aplicación JavaScript que corre en un navegador web usando algún <em>framework</em> de alto nivel como AngularJS o BackboneJS. La aplicación cliente lanza peticiones HTTP al servicio y <em>pinta</em> la interfaz de usuario y la rellena con los resultados de las peticiones.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="_guía_de_laboratorio">1.3. Guía de laboratorio</h3>
<div class="paragraph">
<p>En esta sesión de ejercicios vamos a describir los aspectos más importantes de las distintas plataformas, utilidades y sitios web necesarios para el desarrollo de las prácticas del Experto.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Máquina VirtualBox Linux Ubuntu</dt>
<dd>
<p>Las prácticas se desarrollarán en una máquina virtual (MV) VirtualBox basada en Linux Ubuntu.
Disco SSD externo de 120 GB. Ponemos a vuestra disposición un disco SSD de 120 GB de alta velocidad, de más de 400 MB/s de escritura y lectura, el <a href="http://www.xataka.com/analisis/samsung-840-evo-analisis">Samsung 840 EVO</a>. El disco está instalado en una <a href="http://es.startech.com/Almacenamiento-Datos/Cajas/Caja-de-disco-duro-USB-3-con-UASP~S2510BMU33CBS">caja USB 3.0 StarTech</a> con cable integrado. En el disco se guarda una imagen de la máquina VirtualBox con todo el software necesario para desarrollar las prácticas (fichero <code>Experto_Java_2014.vdi</code>). El disco se encuentra formateado con el sistema de ficheros exFAT, para que sea posible guardar ficheros de más de 4GB (límite de FAT32). Para los usuarios de Mac esto puede ser un problema, ya que no es posible escribir de forma nativa en este sistema de ficheros. Consúltanos y te dejaremos algún programa para solucionar el problema.</p>
</dd>
<dt class="hdlist1">Cuentas Bitbucket</dt>
<dd>
<p>Profesores y estudiantes usaremos cuentas en <a href="https://bitbucket.org">Bitbucket</a> para guardar los repositorios git de los proyectos que se van desarrollando a lo largo del curso. La cuenta común <a href="https://bitbucket.org/java_ua">bitbucket/java_ua</a> guardará los repositorios iniciales (<em>plantillas</em>) de los distintos módulos del curso. Una vez terminado el módulo y entregados y corregidos los ejercicios se añadirá un repositorio con las soluciones. Las cuentas de los estudiantes serán privadas y contendrán los repositorios desarrollados por cada uno. Servirán como copia de seguridad del trabajo realizado y se utilizará también para realizar las entregas de los ejercicios de cada módulo.</p>
</dd>
<dt class="hdlist1">Apuntes y materiales docentes</dt>
<dd>
<p>Todos los apuntes, transparencias y materiales docentes están disponibles en una zona restringida de la web de apuntes del Experto (<a href="../../../../index.html" class="bare">http://expertojava.ua.es</a>).</p>
</dd>
<dt class="hdlist1">Moodle</dt>
<dd>
<p>Se utilizará la plataforma Moodle del Campus Virtual de la UA para la interacción on-line. Usaremos principalmente sus funcionalidades de foros y de puntuaciones de las entregas de ejercicios.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>A continuación vamos a detallar el uso de estos elementos y algunos otros también necesarios para el desarrollo de las prácticas del Experto.</p>
</div>
<div class="sect3">
<h4 id="_materiales_docentes">1.3.1. Materiales docentes</h4>
<div class="paragraph">
<p>Los apuntes, trasparencias y demás material docente se encuentran en un sitio web restringido a los alumnos del Experto. Puedes acceder a los materiales de cada módulo desde los enlaces disponibles en las páginas públicas de cada uno de las asignaturas del experto, accesibles desde el menú superior de las páginas públicas del Experto:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://expertojava.ua.es/experto/publico/web-expertojava.html">Componentes Web</a></p>
</li>
<li>
<p><a href="../../../publico/jpa-expertojava.html">JPA - Framework de persistencia</a></p>
</li>
<li>
<p><a href="http://expertojava.ua.es/experto/publico/ejb-expertojava.html">Componentes Enterprise</a></p>
</li>
<li>
<p><a href="../../../publico/rest-expertojava.html">Servicios REST</a></p>
</li>
<li>
<p><a href="http://expertojava.ua.es/experto/publico/paas-expertojava.html">Servidores Web y PAAS</a></p>
</li>
<li>
<p><a href="../../../publico/js-expertojava.html">Lenguaje JavaScript</a></p>
</li>
<li>
<p><a href="http://expertojava.ua.es/experto/publico/backbone-expertojava.html">Backbone.js</a></p>
</li>
<li>
<p><a href="../../../publico/angularjs-expertojava.html">AngularJS</a></p>
</li>
<li>
<p><a href="../../../publico/nosql-expertojava.html">Bases de datos NOSQL</a></p>
</li>
<li>
<p><a href="../../../publico/grails-expertojava.html">Framework Grails</a></p>
</li>
<li>
<p><a href="../../../publico/proyint-expertojava.html">Proyectos de aplicación Web</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Cuando intentes acceder a la zona restringida del Experto Java aparecerá una página pidiéndote tu usuario y contraseña. El usuario será tu inicial (o iniciales) del nombre y tu primer apellido. Por ejemplo, el login de <em>Juan Luis Pérez</em> será <code>jlperez</code>.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint00/acceso_restringido.png" alt="Página de acceso restringido" width="50%">
</div>
</div>
<div class="paragraph">
<p>Si deseas cambiar tu contraseña (o no la recuerdas), puedes pulsar en el enlace correspondiente. Se enviará un mensaje a tu dirección de correo con un enlace con el que podrás modificar la contraseña.</p>
</div>
</div>
<div class="sect3">
<h4 id="_moodle">1.3.2. Moodle</h4>
<div class="paragraph">
<p>La Universidad de Alicante utiliza dos plataformas on-line para la interacción docente: Campus Virtual y Moodle. En nuestro título vamos a utilizar Moodle por considerarlo bastante más potente, flexible y fácil de utilizar que el Campus Virtual.</p>
</div>
<div class="paragraph">
<p>Para acceder a Moodle debes <em>logearte</em> en el CV de la UA y pulsar en el botón que hay en la parte inferior izquierda:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint00/boton-moodle.png" alt="Moodle" width="25%">
</div>
</div>
<div class="paragraph">
<p>Vamos a utilizar Moodle como plataforma de trabajo colaborativo. La usaremos para gestionar los foros, las calificaciones de los ejercicios y alguna que otra encuesta que iremos presentando.</p>
</div>
<div class="paragraph">
<p>Uno de los elementos principales que utilizaremos de Moodle es el foro, que utilizaremos para resolver dudas que puedan surgir sobre el desarrollo de los ejercicios de las asignaturas o sobre cualquier tema relacionado con el título. Cualquiera puede publicar una entrada nueva en el foro o contestar a las ya existentes. Cada nueva entrada o contestación genera un correo electrónico que se envía a todos los profesores y estudiantes.</p>
</div>
<div class="paragraph">
<p>Para poder utilizar correctamente el foro es muy importante que actualices tu foto. Para esto debes pinchar en <em>Administración</em> &gt; <em>Ajustes de mi perfil</em> &gt; <em>Editar perfil</em>) y seleccionar <em>Imagen del usuario</em>. Allí puedes colocar tu foto. Cuando todos tenemos la foto es mucho más sencillo contestar e interactuar en el foro. La siguiente imagen muestra un ejemplo del foro general en la edición 2009-2010 del especialista:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint00/foro.png" alt="Foro de Moodle" width="66%">
</div>
</div>
<div class="paragraph">
<p>En la página principal del curso podrás encontrar también:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Enlaces a las tareas de entregas de ejercicios de cada una de las asignaturas</p>
</li>
<li>
<p>Calendario de clases y entregas de ejercicios</p>
</li>
<li>
<p>Enlaces a los apuntes y materiales de la asignatura en curso</p>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint00/principal-moodle.png" alt="Página principal de Moodle" width="66%">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ordenadores_de_la_ua">1.3.3. Ordenadores de la UA</h4>
<div class="paragraph">
<p>Las clases se impartirán en un laboratorio gestionado por la EPS (los viernes, el laboratorio L17) y en un laboratorio gestionado por el Servicio de Informática (los sábados, en el Aulario I).</p>
</div>
<div class="paragraph">
<p>Para acceder los laboratorios de la EPS se debe contar con una cuenta de usuario (<a href="http://www.eps.ua.es/es/eservices/ayuda-autentificacion-eservices.html">más información</a>).</p>
</div>
<div class="paragraph">
<p>Al arrancar el ordenador deberás seleccionar como sistema operativo <em>Windows</em>. En este sistema operativo se encuentra el programa VirtualBox con el que se pondrá en marcha la MV en la que se realizarán las prácticas.</p>
</div>
<div class="paragraph">
<p>Trabajaremos directamente con la imagen de la MV en el disco externo SSD. Incluso en ordenadores con USB 2.0 el rendimiento será aceptable. En los ordenadores con USB 3.0 podrás aprovechar completamente la velocidad del disco SSD.</p>
</div>
<div class="paragraph">
<p>Buscar cuál es la disposición de puertos USB 3.0 en los ordenadores nuevos de la EPS.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>¡Cuidado con tus datos! Debes tener precaución con el disco externo. Si le sucediera algo a la máquina virtual perderías todo lo hecho en el curso. Por ello debes tener cuidado de copiar regularmente la máquina virtual en tu ordenador de casa y de subir a Bitbucket los repositorios con los proyectos Java.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_máquina_virtual_virtual_box">1.3.4. Máquina virtual Virtual Box</h4>
<div class="paragraph">
<p>Uno de los elementos más importantes de las prácticas del curso es la MV con una distribución de Linux Lubuntu y con las herramientas necesarias para realizar los ejercicios. Su uso te hace sencillo continuar en casa los ejercicios y prácticas realizados en clase y garantiza que todos utilizamos el mismo entorno de trabajo. También nos hace inmunes a posibles cambios en las instalaciones de los ordenadores de la universidad.</p>
</div>
<div class="paragraph">
<p>El disco imagen de la MV original se encuentra en el disco externo, y también comprimida en la zona restringida de apuntes de la web del Experto y dividida en 4 ficheros ZIP de unos 900 MB cada uno:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://expertojava.ua.es/j2ee/restringido/software/Experto_Java_2014.vdi.z01">Experto_Java_2014.vdi.z01</a></p>
</li>
<li>
<p><a href="http://expertojava.ua.es/j2ee/restringido/software/Experto_Java_2014.vdi.z02">Experto_Java_2014.vdi.z02</a></p>
</li>
<li>
<p><a href="http://expertojava.ua.es/j2ee/restringido/software/Experto_Java_2014.vdi.z03">Experto_Java_2014.vdi.z03</a></p>
</li>
<li>
<p><a href="http://expertojava.ua.es/j2ee/restringido/software/Experto_Java_2014.vdi.zip">Experto_Java_2014.vdi.zip</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La MV Ubuntu es compatible con las últimas versiones VirtualBox. La versión de las Guest Additions instalada en la MV es la 4.3.14.</p>
</div>
<div class="paragraph">
<p>VirtualBox es multiplataforma y opensource. Existen versiones para Windows, Mac y Linux y es posible trabajar con la misma máquina virtual en distintos sistemas operativos. Puedes, por ejemplo, trabajar en la EPS en Windows y después continuar el trabajo en casa en Mac. Puedes bajar la última versión e instalarla en tu ordenador de casa desde la <a href="https://www.virtualbox.org/wiki/Downloads">web de VirtualBox</a>. Una vez instalado el programa VirtualBox, debes instalar también el <em>VirtualBox Extension Pack</em> que proporciona soporte para hardware adicional en el ordenador anfitrión, como el USB 2.0.</p>
</div>
</div>
<div class="sect3">
<h4 id="_máquina_virtual_lubuntu">1.3.5. Máquina virtual Lubuntu</h4>
<div class="paragraph">
<p>En la máquina virtual está instalada la versión 14.04 de <a href="http://lubuntu.net">Lubuntu</a>, una versión más ligera del sistema operativo Ubuntu que usa una interfaz de usuario mínima y funcional basada en LXDE.</p>
</div>
<div class="paragraph">
<p>En la MV se ha creado el usuario <code>expertojava</code> con la contraseña <code>expertojava</code>. Tendrás que utilizar este login para entrar en el sistema, para ejecutar comandos en modo superusuario o cuando se bloquee la pantalla:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint00/pantalla-lubuntu01.png" alt="LUbuntu" width="100%">
</div>
</div>
<div class="paragraph">
<p>El disco de la máquina virtual tiene una capacidad máxima de 52 GB. Las aplicaciones instaladas ocupan inicialmente alrededor de 8 GB.</p>
</div>
<div class="paragraph">
<p>En la máquina virtual se ha instalado el software que vamos a utilizar a lo largo de todos los módulos del curso:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Plataforma Java</strong> 1.7.0_65</p>
</li>
<li>
<p><strong>Entorno de desarrollo</strong> IntelliJ IDEA 13 con licencia de desarrollo para la Universidad de la Alicante</p>
</li>
<li>
<p><strong>Servidor de aplicaciones</strong> JBoss WildFly 8</p>
</li>
<li>
<p><strong>Bases de datos</strong>: MySQL 5.5 (contraseña del usuario root: <code>expertojava</code>) y MongoDB</p>
</li>
<li>
<p>Editor de textos avanzado Atom</p>
</li>
<li>
<p>Node y npm</p>
</li>
<li>
<p>Herramientas: Maven, Git, Curl</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_paso_a_paso_creación_de_la_mv_ubuntu_en_el_ordenador_anfitrión">1.3.6. Paso a paso: creación de la MV Ubuntu en el ordenador anfitrión</h4>
<div class="paragraph">
<p>Lo primero que tenemos que hacer es crear con VirtualBox la máquina virtual en la que vamos a trabajar. Vamos a crear la MV para que trabaje con la imagen vdi en el disco externo (<code>Experto_Java_2014.vdi</code>).</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Arranca VirtualBox en el ordenador anfitrión y crea una nueva MV de tipo Linux Ubuntu con el nombre <code>Experto Java</code>:</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint00/vbox1.png" alt="LUbuntu" width="66%">
</div>
</div>
</li>
<li>
<p>Define el tamaño de la memoria de la MV en un valor suficiente para trabajar cómodamente con el entorno de trabajo y que no comprometa el rendimiento del ordenador anfitrión. Los ordenadores de la EPS tienen 4 GB de memoria y 2 GB está en límite de lo recomendable. Pondremos alrededor de 2 GB.</p>
</li>
<li>
<p>Ahora debemos vincular la imagen vdi del disco externo con la máquina virtual que estamos creando. Para ello, en la pantalla Disco Duro Virtual seleccionamos la opción <em>Usar un archivo de disco duro virtual existente</em> y seleccionamos el fichero <code>Experto_Java_2014.vdi</code> en el disco duro externo.</p>
</li>
<li>
<p>Terminamos configurando el número de procesadores de la MV. Es muy recomendable trabajar con al menos 2 procesadores, porque el rendimiento aumenta muchísimo. Para ello debemos seleccionar la opción <em>Configuración &gt; Sistema &gt; Habilitar IO APIC</em>:</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint00/vbox2.png" alt="LUbuntu" width="66%">
</div>
</div>
<div class="paragraph">
<p>Y después definir más de 1 procesador en la pestaña de <em>Procesador</em>.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>La configuración de la máquina virtual creada se guarda en la carpeta <code>VirtualBox VMs</code> del directorio de usuario en el ordenador anfitrión. Como en los ordenadores de la universidad se restauran los discos duros frecuentemente, deberás repetir esto cada vez que empiece la sesión de prácticas. En tu ordenador de casa, bastará que lo hagas una vez.</p>
</div>
<div class="sect4">
<h5 id="_instalación_de_guest_additions">Instalación de Guest Additions</h5>
<div class="paragraph">
<p>Es recomendable instalar las <em>Guest Additions</em>. Con ellas instaladas es posible pasar del SO invitado (lubuntu) al SO anfitrión sin tener que pulsar ninguna combinación de teclas, sólo moviendo el cursor. También son útiles para copiar y pegar texto entre ambos sistemas operativos, así como para cambiar fácilmente la resolución de la pantalla.</p>
</div>
<div class="paragraph">
<p>Las <em>Guest Additions</em> ya están instaladas en la imagen inicial. Si en algún momento actualizas VirtualBox o lubuntu, deberás también volver a instalar Guest Additions. Para ellos debes seleccionar la opción <em>Dispositivos &gt; Insertar Guest Additions CD Image</em> del menú de Virtual Box que aparece cuando estamos ejecutando la MV. Esto montará en lubunutu un disco con distintos comandos disponibles. Deberás abrir un terminal y ejecutar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> <span class="tok-nb">cd</span> /media/expertojava/VBOXADDITIONS_&lt;version&gt;
<span class="tok-gp">$</span> sudo ./VBoxLinuxAdditions.run</code></pre>
</div>
</div>
<div class="paragraph">
<p>Una vez instaladas, debes desmontar el CD y reiniciar lubuntu.</p>
</div>
</div>
<div class="sect4">
<h5 id="_compartición_de_directorios_con_el_anfitrión">Compartición de directorios con el anfitrión</h5>
<div class="paragraph">
<p>Una vez instaladas las <em>Guest Additions</em> es posible compartir directorios entre el ordenador invitado (lubuntu) y el anfitrión (Windows, Mac, etc.). Para ello selecciona la opción <em>Dispositivos &gt; Directorios Compartidos</em> y pulsa en el icono para añadir un nuevo directorio transitorio (no se guardan los datos de un arranque a otro).</p>
</div>
<div class="paragraph">
<p>Aparecerá una ventana en la que debes indicar la ruta del directorio del ordenador anfitrión que se quiere compartir y un nombre simbólico con el que identificar ese directorio. Para indicar la ruta del directorio en el anfitrión puedes también escoger la opción del desplegable que abre el navegador de archivos para seleccionarlo gráficamente.</p>
</div>
<div class="paragraph">
<p>Crea el directorio <code>Compartido MV</code> en el ordenador anfitrión, escógelo y escribe como nombre simbólico <code>Compartido</code>.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint00/vbox3.png" alt="Directorio compartido" width="66%">
</div>
</div>
<div class="paragraph">
<p>De esta forma estamos creando un dispositivo que puede ser montado en el sistema y que tiene como nombre <code>Compartido</code> y que estará conectado con el directorio `Compartido MV`_ en el ordenador anfitrión.</p>
</div>
<div class="paragraph">
<p>Por último debemos crear un directorio en la MV que haga de punto de montaje del dispositivo que acabamos de crear. Lo podemos llamar con cualquier nombre, por ejemplo <code>Host</code>. Y después usamos el comando mount como root para montarlo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> <span class="tok-nb">cd </span>Escritorio
<span class="tok-gp">$</span> mkdir Host
<span class="tok-gp">$</span> sudo mount -t vboxsf -o <span class="tok-nv">uid</span><span class="tok-o">=</span>1000,gid<span class="tok-o">=</span><span class="tok-m">1000</span> Compartido Host</code></pre>
</div>
</div>
<div class="paragraph">
<p>Los parámetros <em>uid=1000,gid=1000</em> hacen que el propietario de la carpeta compartida sea el propio usuario, con lo que no es necesario ser root para explorarla.</p>
</div>
<div class="paragraph">
<p>Para desmontar el directorio llamamos al comando <em>umount</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> sudo umount Host</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_git_y_bitbucket">1.3.7. Git y Bitbucket</h4>
<div class="paragraph">
<p>Vamos a desarrollar todos los proyectos del experto utilizando el sistema de control de versiones distribuido Git. Con este sistema de control de versiones trabajaremos sobre un repositorio local y tendremos una réplica en un sitio remoto. Iremos confirmando (<em>commit</em>) todos los cambios que vamos realizando sobre el código fuente de nuestros proyectos en el repositorio local y luego <em>subiremos</em> (<em>push</em>) estos cambios al repositorio remoto. El repositorio remoto servirá de copia de seguridad y para compartir el código con los profesores.</p>
</div>
<div class="paragraph">
<p>Para la creación de los repositorios remotos utilizaremos el servicio <a href="https://bitbucket.org/"><em>Bitbucket</em></a>.</p>
</div>
<div class="paragraph">
<p>Vamos a ver en cómo crear nuestro primer repositorio git. Podemos hacerlo primero en remoto y después bajarlo a nuestro ordenador o al revés.</p>
</div>
<div class="sect4">
<h5 id="_creación_de_un_repositorio_remoto_en_bitbucket">Creación de un repositorio remoto en bitbucket</h5>
<div class="paragraph">
<p>Vamos a ver cómo crear un repositorio privado en bitbucket  <a href="https://bitbucket.org/"><em>Bitbucket</em></a> que vincularemos con nuestro repositorio local.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>En primer lugar, deberemos crearnos una cuenta personal en bitbucket, si no disponemos ya de una: (<a href="https://bitbucket.org" class="bare">https://bitbucket.org</a>)</p>
</li>
<li>
<p>Creamos desde nuestra cuenta de bitbucket un repositorio (<em>Repositories &gt; Create repository</em>).</p>
</li>
<li>
<p>Deberemos darle un nombre al repositorio, por ejemplo <code>prueba-expertojava</code>. Será de tipo Git y como lenguaje especificaremos <strong>Java</strong>.</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint00/bitbucket-nuevo-repo.png" alt="Creando repositorio nuevo en Bitbucket" width="50%">
</div>
</div>
</li>
<li>
<p>Una vez hecho esto, veremos el repositorio ya creado, en cuya ficha podremos encontrar la ruta que nos dará acceso a él.</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint00/bitbucket-clone.png" alt="Dirección clone Bitbucket" width="50%">
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Será útil copiar la dirección anterior para vincular con ella nuestro repositorio local al remoto. Veremos como hacer esto en el
siguiente apartado.</p>
</div>
</div>
<div class="sect4">
<h5 id="_creación_del_repositorio_git_local">Creación del repositorio git local</h5>
<div class="paragraph">
<p>Tenemos dos alternativas para crear un repositorio local vinculado al remoto:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Clonar el repositorio remoto, lo cual inicializa un repositorio local en el que ya está configurado el vínculo con el remoto.</p>
</li>
<li>
<p>Crear un repositorio local independiente, y vincularlo posteriormente con un repositorio remoto.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Para realizar cualquiera de estas dos alternativas hay que utilizar comandos de Git. Es posible hacerlo desde el IDE <em>IntelliJ</em>, pero es mucho más útil aprender a trabajar con Git desde línea de comandos. Así podremos utilizar los comandos en cualquier entorno y no dependeremos de tener instalado un entorno gráfico que es mucho más pesado que un sencillo terminal.</p>
</div>
<div class="paragraph">
<p><strong>Creación a partir del repositorio remoto</strong></p>
</div>
<div class="paragraph">
<p>La forma más sencilla de crear un repositorio Git local es hacerlo directamente a partir del repositorio remoto. Si ya tenemos un repositorio remoto (vacío o con contenido) podemos clonarlo en nuestra máquina local con:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> git clone https://&lt;usuario&gt;:bitbucket.org/&lt;usuario&gt;/prueba-expertojava</code></pre>
</div>
</div>
<div class="paragraph">
<p>Este comando podemos copiarlo directamente desde bitbucket, tal como hemos visto en el último paso del apartado anterior (opción <em>Clone</em> de la interfaz del repositorio).</p>
</div>
<div class="paragraph">
<p>De esta forma se crea en nuestro ordenador el directorio <code>prueba-expertojava</code> y se descarga en él el contenido del proyecto, en caso de no estar vacío el repositorio remoto. Además, quedará configurado como repositorio git local y conectado de forma automática con el repositorio git remoto del que lo hemos clonado.</p>
</div>
<div class="paragraph">
<p><strong>Creación de un repositorio local y vinculación con el remoto</strong></p>
</div>
<div class="paragraph">
<p>Esta forma es algo más compleja que la anterior, pero será útil si tenemos ya creado un repositorio git local de antemano, o si queremos vincularlo con varios repositorios remotos.</p>
</div>
<div class="paragraph">
<p>Para la creación de un repositorio git local seguiremos los siguientes pasos.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Creamos un directorio local y nos movemos a él:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> mkdir prueba-expertojava
<span class="tok-gp">$</span> <span class="tok-nb">cd </span>prueba-expertojava</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Inicializamos el repositorio git. Estando en la raíz del directorio <code>prueba-expertojava</code> hacemos:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> git init</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Conectamos el repositirio local con el remoto. En bitbucket veremos la URL que identifica el repositorio, que será del tipo: <code><a href="https://&lt;usuario&gt;@bitbucket.org/&lt;usuario&gt;/presentacion-expertojava.git" class="bare">https://&lt;usuario&gt;@bitbucket.org/&lt;usuario&gt;/presentacion-expertojava.git</a></code>. Desde el directorio raíz del proyecto ejecutamos:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> git remote add origin https://&lt;usuario&gt;@bitbucket.org/&lt;usuario&gt;/prueba-expertojava.git</code></pre>
</div>
</div>
<div class="paragraph">
<p>De esta forma añadimos añadiendo un repositorio remoto llamado <code>origin</code> (el nombre por defecto del repositorio remoto en git) conectado al local. Hemos inicializado nuestro directorio como un repositorio local git y lo hemos conectado con el repositorio remoto situado en Bitbucket.</p>
</div>
</div>
<div class="sect4">
<h5 id="_registrar_cambios_en_el_repositorio">Registrar cambios en el repositorio</h5>
<div class="paragraph">
<p>Independientemente de cuál de los métodos anteriores hayamos utilizado para inicializar nuestro repositorio git local, lo habremos conectado con el repositorio remoto de Bitbucket.</p>
</div>
<div class="paragraph">
<p>Vamos a ver ahora cómo trabajar con un repositorio git.</p>
</div>
<div class="paragraph">
<p>En primer lugar será recomendable añadir un fichero <code>.gitignore</code> al directorio del proyecto, que dependerá del tipo de proyecto y que se encargará de excluir del control de versiones todos aquellos tipos de ficheros que sean generados automáticamente (por ejemplo las clases compiladas). Podemos encontrar diferentes modelos de <code>.gitignore</code> en: (<a href="https://github.com/github/gitignore" class="bare">https://github.com/github/gitignore</a>)</p>
</div>
<div class="paragraph">
<p>Tras añadir el <code>.gitignore</code> correcto para nuestro tipo de proyecto podremos añadir nuevos ficheros, registrarlos en el sistema de control de versiones y confirmar los cambios que realicemos.</p>
</div>
<div class="paragraph">
<p>Antes de añadir ningún cambio al repositorio debemos inicializar en la máquina linux las variables de git <code>user.name</code> y <code>user.email</code> para que quede registrado el usuario que hace los commits. El <code>user.email</code> debe coincidir con el correo electrónico registrado en Bitbucket.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> git config --global user.name <span class="tok-s2">&quot;Pepito Pérez&quot;</span>
<span class="tok-gp">$</span> git config --global user.email pepito.perez@gmail.com</code></pre>
</div>
</div>
<div class="paragraph">
<p>A partir de ahora todos los cambios se registrán como realizados por ese usuario. A partir de ahora cada vez que queramos registrar cambios en el repositorio local deberemos:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Si hemos añadido nuevos archivos al proyecto, deberemos añadirlos al sistema de control de versiones con <code>git add</code>:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> <span class="tok-nb">echo</span> <span class="tok-s2">&quot;Hola mundo&quot;</span> &gt; hola-mundo.txt
<span class="tok-gp">$</span> git add .</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Podemos confirmar los cambios realizados y añadirlos al control de versiones con el comando <code>git commit -a -m</code> (o haciendo <em>commit</em> desde el IDE). Es obligatorio añadir un mensaje con una explicación del cambio realizado:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> git commit -a -m <span class="tok-s2">&quot;Primer fichero en el repositorio&quot;</span></code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Git almacena los cambios confirmados en el repositorio local. En este caso hemos añadido un fichero llamado <code>hola-mundo.txt</code>. Cuando queramos subir un conjunto de cambios al repositorio remoto deberemos hacer un <em>push</em> para subir al repositorio <em>origin</em> (en Bitbucket):</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> git push -u origin master</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Al hacer <code>- u</code> indicamos que la rama master local está haciendo <em>tracking</em> de la rama master en origin. A partir de ahora sólo será necesario hacer <code>git push</code> para subir los cambios.</p>
</li>
<li>
<p>Editamos con algún editor sencillo el fichero <code>hola-mundo.txt</code> y añadimos un par de líneas más. Hacemos después un <em>commit</em>:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> gedit hola-mundo.txt
<span class="tok-gp">$</span> git status  <span class="tok-c"># Comprobamos los cambios sin confirmar</span>
<span class="tok-gp">$</span> git commit -a -m <span class="tok-s2">&quot;Añadidas un par de líneas en hola-mundo.txt&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cada <em>commit</em> representa un punto del desarrollo al que podríamos volver con el comando <code>git checkout &lt;commit-id&gt;</code> para examinar esa versión o crear nuevas ramas.</p>
</div>
<div class="paragraph">
<p>Para listar todos los <em>commits</em> realizados podemos hacer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> git log --oneline</code></pre>
</div>
</div>
<div class="paragraph">
<p>Se listan el identificador del <em>commit</em> y su comentario.</p>
</div>
<div class="paragraph">
<p>Por último, podemos volver a hacer <code>git push</code> para subir los cambios al repositorio:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> git status
<span class="tok-gp">$</span> git push</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_compartición_de_repositorio">Compartición de repositorio</h5>
<div class="paragraph">
<p>Bitbucket permite compartir un repositorio con otros usuarios. Vamos a utilizar esta características para compartir las plantillas iniciales de los ejercicios y para realizar las entregas de los mismos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Los profesores compartirán con vosotros los repositorios iniciales de cada módulo, a partir de los que se comenzaréis a realizar los ejercicios del módulo. Deberéis hacer una copia de propia haciendo un <em>fork</em> en la cuenta personal de Bitbucket.</p>
</li>
<li>
<p>Una vez que hayáis terminado de realizar los ejercicios, en la fecha de entrega de la asignatura, deberéis dar permiso de lectura al repositorio al profesor que ha impartido el módulo. Se puede hacer desde <em>Settings</em> &gt; <em>Access management</em>:</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_creación_de_proyectos_con_intellij">1.3.8. Creación de proyectos con IntelliJ</h4>
<div class="paragraph">
<p>Vamos a realizar una rápida introducción a la creación de proyectos y la sincronización con git y Bitbucket usando <em>IntelliJ</em>, el IDE que utilizaremos a lo largo de todo el curso.</p>
</div>
<div class="paragraph">
<p>En IntelliJ es importante diferenciar entre <em>proyecto</em> y <em>módulo</em>. El <em>proyecto</em> es el directorio principal de trabajo de IntelliJ, en el que se guarda la configuración de los distintos elementos que vamos creando en el entorno. Puede constituir un proyecto Java único, con sus clases, sus bibliotecas, sus ficheros de configuración, etc. O también puede contener más de un <em>módulo</em>, subdirectorios que constituyen subproyectos independientes pero que pueden compartir ciertos elementos situados en el proyecto principal.</p>
</div>
<div class="paragraph">
<p>Los proyectos y módulos del entorno se corresponden con directorios del sistema operativo y guardan la configuración en ficheros XML. La información de un proyecto se guarda en el directorio oculto <code>.idea</code> dentro del directorio con el nombre del proyecto. Por ejemplo, si creamos el proyecto <code>prueba</code> se creará un directorio con el mismo nombre que contendrá el directorio <code>.idea</code>. Lo podemos comprobar desde el terminal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> <span class="tok-nb">cd </span>prueba
<span class="tok-gp">$</span> ls -la</code></pre>
</div>
</div>
<div class="paragraph">
<p>Los que conocen Eclipse pueden ver un proyecto IntelliJ como un <em>workspace</em> de Eclipse, con la diferencia de que en Eclipse no es posible usar un <em>workspace</em> como un proyecto con código fuente.</p>
</div>
<div class="paragraph">
<p>Cada módulo se guarda como un directorio con el nombre del módulo, en el que se crea un fichero <code>&lt;modulo&gt;.iml</code> con la configuración del módulo.</p>
</div>
<div class="paragraph">
<p>En IntelliJ podremos crear tres tipos de proyectos:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Proyectos que contienen únicamente código fuente, sin incluir ningún módulo adicional:</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint00/proyecto1.png" alt="Proyecto sin submódulos" width="33%">
</div>
</div>
</li>
<li>
<p>Proyectos vacíos que contienen distintos módulos:</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint00/proyecto2.png" alt="Proyecto con submódulos" width="33%">
</div>
</div>
</li>
<li>
<p>Proyectos que contienen código fuente y que además incluye módulos adicionales:</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint00/proyecto3.png" alt="Proyecto con código y submódulos" width="33%">
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>En todos los casos anteriores se puede definir un repositorio git en el proyecto principal, que contenga todos sus elementos (ya sea código fuente y/o otros subproyectos).</p>
</div>
<div class="paragraph">
<p>Vamos a empezar con un ejemplo del segundo tipo de proyectos: un proyecto vacío que contiene un par de módulos (programas Java) y que sincronizaremos posteriormente con Bitbucket. Lo hacemos paso a paso.</p>
</div>
<div class="sect4">
<h5 id="_paso_a_paso_creción_de_un_proyecto_git_con_varios_módulos_en_intellij">Paso a paso: creción de un proyecto git con varios módulos en IntelliJ</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un repositorio <code>pres-expertojava</code> en tu cuenta de Bitbucket.</p>
</li>
<li>
<p>Abre IntelliJ y crea un proyecto vacío con el mismo nombre <code>pres-expertojava</code> en cualquier directorio, por ejemplo el escritorio.</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint00/proyecto-vacio.png" alt="Proyecto vacío" width="50%">
</div>
</div>
</li>
<li>
<p>Se habrá creado un directorio nuevo con ese nombre. Vamos ahora a un terminal. Es más fácil inicializar git desde línea de comando que desde IntelliJ. Crea el fichero <code>.gitignore</code> con un editor, por ejemplo <code>atom</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> <span class="tok-nb">cd </span>Escritorio/pres-expertojava
<span class="tok-gp">$</span> atom .gitignore</code></pre>
</div>
</div>
</li>
<li>
<p>Copia el siguiente código:</p>
<div class="listingblock">
<div class="title">Fichero .gitignore:</div>
<div class="content">
<pre class="pygments highlight"><code># IntelliJ
out/
.idea/workspace.xml

# Maven output
target

#OS X stuff
.DS_Store</code></pre>
</div>
</div>
</li>
<li>
<p>Inicializa git en el directorio, añade los ficheros al repositorio y conéctalo con el repositorio remoto en Bitbucket:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> git init
<span class="tok-gp">$</span> git add .
<span class="tok-gp">$</span> git commit -m <span class="tok-s2">&quot;Creado el repositorio&quot;</span>
<span class="tok-gp">$</span> git remote add origin https://&lt;usuario&gt;@bitbucket.org/&lt;usuario&gt;/pres-expertojava.git
<span class="tok-gp">$</span> git push -u origin master</code></pre>
</div>
</div>
<div class="paragraph">
<p>Si ejecutas el comando <code>ls -la</code> verás que se ha creado un directorio oculto <code>.git</code> en el que se guarda la configuración del repositorio git creado (en el fichero <code>.git\config</code>) y todos los <em>commits</em> que se realicen en el repositorio local.</p>
</div>
</li>
<li>
<p>Ahora ya podemos cambiar a IntelliJ. Una vez creado el repositorio es cómodo realizar los <em>commits</em> desde el IDE. Creamos un nuevo módulo Java dentro del proyecto, con la opción <em>File &gt; New Module&#8230;&#8203;</em>. Pichamos <em>Next</em> y le damos el nombre al nuevo módulo: <code>hola-mundo</code>:</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint00/intellij1.png" alt="Proyecto vacío" width="33%">
</div>
</div>
</li>
<li>
<p>Creamos una nueva clase <code>HolaMundo</code> pinchando con el botón derecho sobre el directorio <code>src</code> y seleccionando <em>New &gt; Java Class</em>:</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint00/intellij2.png" alt="New Java Class" width="50%">
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Aunque lo habitual es crear las clases Java dentro de <em>packages</em>, en este caso no lo hemos hecho para simplificar el ejercicio. En el experto vamos a nombrar los paquetes siempre empezando por <code>org.expertojava</code>. Para trabajar con paquetes es recomendable seleccionar la opción <em>Flatten Packages</em> que hay en la rueda dentada en la parte superior derecha del panel de proyectos.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Le damos a la clase como nombre <code>HolaMundo</code> y escribimos el típico código <em>Hola mundo</em>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">HolaMundo</span> <span class="tok-o">{</span>
    <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-kt">void</span> <span class="tok-nf">main</span><span class="tok-o">(</span><span class="tok-n">String</span><span class="tok-o">[]</span> <span class="tok-n">args</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;Hola, mundo\n&quot;</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>En IntelliJ es posible utilizar <strong>abreviaturas</strong> que se expanden en código. Por ejemplo, escribe <code>psvm</code> y pulsa el tabulador. Verás que se expande en la plantilla de la función <code>main</code>. Puedes también escribir <code>sout</code> y pulsar el tabulador. Verás que se expande en una plantilla para hacer un <code>System.out.println</code>.</p>
</div>
<div class="paragraph">
<p>Estas abreviaturas se denominan <em>Live Templates</em>. Puedes consultar, modificar y añadir nuevas plantillas seleccionando <em>File &gt; Settings &gt; IDE Settings &gt; Live Templates</em>.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>IntelliJ todavía no ha detectado que hemos inicializado git en el repositorio. Para ello hay que seleccionar <em>VCS &gt; Enable Version Control Integration&#8230;&#8203;</em> y seleccionar <code>Git</code>.</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint00/intellij3.png" alt="Inicialización Git" width="50%">
</div>
</div>
<div class="paragraph">
<p>El menú <em>VCS</em> (<em>Version Control System</em>) es muy importante, ahí se encuentran todas las opciones relacionadas con Git.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint00/intellij4.png" alt="Menú VCS" width="66%">
</div>
</div>
<div class="paragraph">
<p>Verás que automáticamente en el panel del proyecto cambia el color de los ficheros que no están confirmados y que aparecen nuevas opciones en el entorno.</p>
</div>
</li>
<li>
<p>Abriendo el panel inferior <em>Changes</em> podemos gestionar los cambios pendientes de confirmar del proyecto</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint00/intellij5.png" alt="Changes" width="50%">
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>El color del nombre de un fichero indica su estado en el control de versiones:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Rojo: Fichero sin añadir</p>
</li>
<li>
<p>Verde: Fichero que será añadido en el siguiente commit</p>
</li>
<li>
<p>Azul: Fichero con cambios pendientes de confirmar</p>
</li>
<li>
<p>Negro: Fichero sin cambios</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Pulsamos el botón derecho sobre <em>Unversioned Files</em> y seleccionamos la opción <em>Add to VCS</em> (o pulsamos <em>Ctrl+Alt+A</em>). Los ficheros se añadirán a la lista de cambios (<em>Changelist</em>) Default:</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint00/intellij6.png" alt="Previo al commit" width="50%">
</div>
</div>
</li>
<li>
<p>Pulsamos con el botón derecho <em>Commit</em> y aparecerá una ventana en la que podemos revisar los cambios, añadir un comentario y confirmarlos</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint00/intellij7.png" alt="Commit" width="100%">
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>También podemos realizar un <em>commit</em> de los cambios en un fichero o en un directorio:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Desde el menú <em>VCS</em>, seleccionando el fichero o directorio en el panel del proyecto y seleccionando la opción <em>VCS &gt; Git &gt; Commit File&#8230;&#8203;</em>.</p>
</li>
<li>
<p>Pulsando <em>Ctrl+K</em></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Vamos a terminar creando una configuración de ejecución para ejecutar el programa y subiendo todos los cambios a Bitbucket. Para crear una configuración de ejecución pulsa en el desplegable junto al botón <em>Play</em> (ahora inactivo) y selecciona <em>Edit Configurations&#8230;&#8203;</em></p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint00/intellij8.png" alt="Configuración de ejecución" width="66%">
</div>
</div>
</li>
<li>
<p>Aparece una ventana para gestionar las configuraciones de ejecución. Crea una nueva configuración de ejecución pulsando el símbolo <code>+</code> en la esquina superior izquierda y seleccionando <em>Application</em>. Rellena los siguientes datos:</p>
<div class="ulist">
<ul>
<li>
<p><em>Share</em>: chequeado (para que la configuración se guarde en el control de versiones)</p>
</li>
<li>
<p><em>Name</em>: HolaMundo</p>
</li>
<li>
<p><em>Main class</em>: HolaMundo (puedes seleccionarla con el botón de la derecha del campo)</p>
</li>
<li>
<p><em>Working directory</em>: /home/expertojava/Escritorio/pres-expertojava (aparece por defecto)</p>
</li>
<li>
<p><em>Use classpath of module</em>: hola-mundo</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint00/intellij9.png" alt="Configuración de ejecución" width="66%">
</div>
</div>
<div class="paragraph">
<p>Aparecerá un aviso preguntando si queremos añadir al control de versiones la configuración de ejecución. Decimos que sí. Ya podemos ejecutar o depurar el programa:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint00/intellij10.png" alt="Ejecutar" width="66%">
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Ejecutamos el programa, comprobando que aparece el panel con la salida en la parte inferior de la ventana. Confirmamos los cambios.</p>
</li>
<li>
<p>Por último, subimos (<em>push</em>) los cambios al repositorio en Bitbucket. Lo podemos hacer seleccionando <em>VCS &gt; Git &gt; Push&#8230;&#8203;</em> o <em>Ctrl+Mayús+K</em>. Aparece una ventana que nos permite revisar por última vez los cambios que vamos a subir al repositorio remoto:</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint00/intellij11.png" alt="Push" width="66%">
</div>
</div>
</li>
<li>
<p>Comprobamos en el navegador que se han subido los cambios correctamente a Bitbucket:</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint00/intellij12.png" alt="Bitbucket" width="100%">
</div>
</div>
</li>
<li>
<p>Ahora que ya has aprendido a crear proyectos y módulos en IntelliJ y trabajar con git y bitbucket, crea un nuevo módulo denominado <code>saludo</code> que imprima por la salida estándar <code>Hola, soy &lt;mi nombre&gt;</code>. Crea una configuración de ejecución y sube todo a Bitbucket.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_paso_a_paso_importar_plantillas_de_bitbucket">Paso a paso: importar plantillas de bitbucket</h5>
<div class="paragraph">
<p>Vamos a terminar explicando cómo trabajar con proyectos dejados en Bitbucket por los profesores, que servirán como plantillas de los ejercicios a realizar en la asignatura.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>En tu cuenta de Bitbucket verás el repositorio <code>java_ua/pres2-expertojava</code>. Ese repositorio está en la cuenta <code>java_ua</code>, usada por los profesores del experto para dejar repositorios accesibles a los alumnos. Allí dejaremos los repositorios con las plantillas de ejercicios de las asignaturas y con las soluciones, una vez concluida la fecha de entrega. Los repositorios tienen sólo permiso de lectura para los estudiantes.</p>
</li>
<li>
<p>Copia el repositorio en tu cuenta, haciendo un <em>fork</em> del mismo. Para ello entra en el repositorio, pincha en los puntos suspensivos que hay en la esquina superior izquierda y escoge la opción <em>Fork</em></p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint00/fork.png" alt="Fork en Bitbucket" width="50%">
</div>
</div>
<div class="paragraph">
<p>El repositorio se copia en tu cuenta:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint00/repo-forked.png" alt="Repositorio copiado" width="50%">
</div>
</div>
</li>
<li>
<p>Descárgalo en tu ordenador desde línea de comando. Ve al directorio en el que quieras descargarlo, por ejemplo <code>Escritorio</code>, y haz un <code>git clone</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> <span class="tok-nb">cd </span>Escritorio
<span class="tok-gp">$</span> git clone https://&lt;usuario&gt;@bitbucket.org/&lt;usuario&gt;/pres2-expertojava.git</code></pre>
</div>
</div>
</li>
<li>
<p>Abre el proyecto en IntelliJ seleccionando la opción <em>File &gt; Open</em>.</p>
</li>
<li>
<p>El proyecto se llama <code>agenda</code> y contiene la siguiente clase <code>org.expertojava.pres.Tarjeta</code> que define una tarjeta de contacto de una agenda, con un nombre y un correo electrónico de tipo <code>String</code>, y un identificador de tipo <code>Integer</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">pres</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Tarjeta</span> <span class="tok-o">{</span>
    <span class="tok-n">Integer</span> <span class="tok-n">id</span><span class="tok-o">;</span>
    <span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
    <span class="tok-n">String</span> <span class="tok-n">eMail</span><span class="tok-o">;</span>

    <span class="tok-kd">public</span> <span class="tok-nf">Tarjeta</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">,</span> <span class="tok-n">String</span> <span class="tok-n">eMail</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">nombre</span> <span class="tok-o">=</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">eMail</span> <span class="tok-o">=</span> <span class="tok-n">eMail</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setId</span><span class="tok-o">(</span><span class="tok-n">Integer</span> <span class="tok-n">id</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">id</span> <span class="tok-o">=</span> <span class="tok-n">id</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">Integer</span> <span class="tok-nf">getId</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">id</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getNombre</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">geteMail</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">eMail</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-kt">boolean</span> <span class="tok-nf">equals</span><span class="tok-o">(</span><span class="tok-n">Object</span> <span class="tok-n">o</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-k">this</span> <span class="tok-o">==</span> <span class="tok-n">o</span><span class="tok-o">)</span> <span class="tok-k">return</span> <span class="tok-kc">true</span><span class="tok-o">;</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">o</span> <span class="tok-o">==</span> <span class="tok-kc">null</span> <span class="tok-o">||</span> <span class="tok-n">getClass</span><span class="tok-o">()</span> <span class="tok-o">!=</span> <span class="tok-n">o</span><span class="tok-o">.</span><span class="tok-na">getClass</span><span class="tok-o">())</span> <span class="tok-k">return</span> <span class="tok-kc">false</span><span class="tok-o">;</span>

        <span class="tok-n">Tarjeta</span> <span class="tok-n">tarjeta</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-n">Tarjeta</span><span class="tok-o">)</span> <span class="tok-n">o</span><span class="tok-o">;</span>

        <span class="tok-k">if</span> <span class="tok-o">(!</span><span class="tok-n">eMail</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">tarjeta</span><span class="tok-o">.</span><span class="tok-na">eMail</span><span class="tok-o">))</span> <span class="tok-k">return</span> <span class="tok-kc">false</span><span class="tok-o">;</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">id</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span> <span class="tok-o">?</span> <span class="tok-o">!</span><span class="tok-n">id</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">tarjeta</span><span class="tok-o">.</span><span class="tok-na">id</span><span class="tok-o">)</span> <span class="tok-o">:</span> <span class="tok-n">tarjeta</span><span class="tok-o">.</span><span class="tok-na">id</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-k">return</span> <span class="tok-kc">false</span><span class="tok-o">;</span>
        <span class="tok-k">if</span> <span class="tok-o">(!</span><span class="tok-n">nombre</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">tarjeta</span><span class="tok-o">.</span><span class="tok-na">nombre</span><span class="tok-o">))</span> <span class="tok-k">return</span> <span class="tok-kc">false</span><span class="tok-o">;</span>

        <span class="tok-k">return</span> <span class="tok-kc">true</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-kt">int</span> <span class="tok-nf">hashCode</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-kt">int</span> <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-n">nombre</span><span class="tok-o">.</span><span class="tok-na">hashCode</span><span class="tok-o">();</span>
        <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-mi">31</span> <span class="tok-o">*</span> <span class="tok-n">result</span> <span class="tok-o">+</span> <span class="tok-n">eMail</span><span class="tok-o">.</span><span class="tok-na">hashCode</span><span class="tok-o">();</span>
        <span class="tok-k">return</span> <span class="tok-n">result</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">toString</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-s">&quot;Tarjeta{&quot;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;id=&quot;</span> <span class="tok-o">+</span> <span class="tok-n">id</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, nombre=&#39;&quot;</span> <span class="tok-o">+</span> <span class="tok-n">nombre</span> <span class="tok-o">+</span> <span class="tok-sc">&#39;\&#39;&#39;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, eMail=&#39;&quot;</span> <span class="tok-o">+</span> <span class="tok-n">eMail</span> <span class="tok-o">+</span> <span class="tok-sc">&#39;\&#39;&#39;</span> <span class="tok-o">+</span>
                <span class="tok-sc">&#39;}&#39;</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</li>
<li>
<p>Debes completar la clase <code>Main</code> escribiendo un guarde cuatro tarjetas en un <code>ArrayList</code> y después lo recorra e imprima las tarjetas en la salida estándar. Cuando funcione correctamente haz un <em>commit</em> y sube los cambios a Bitbucket.</p>
</li>
<li>
<p>Para terminar debes compartir los repositorios creados en la sesión con el profesor de la asignatura. En Bitbucket selecciona la configuración del repositorio pulsando el botón <em>Settings</em>, la rueda dentada que hay abajo a la izquierda. Pulsa la opción <em>Access management</em> y añade al profesor de la asignatura con permiso de lectura:</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint00/lectura-repositorio.png" alt="Repositorio con permiso de lectura" width="100%">
</div>
</div>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion01">2. (1,5 puntos) Caso de estudio</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introducción_a_maven">2.1. Introducción a Maven</h3>
<div class="paragraph">
<p>Maven es una herramienta Java de gestión del proceso de desarrollo de proyectos software, que simplifica la complejidad de sus distintas partes: compilación, prueba, empaquetamiento y despliegue. Es una herramienta muy popular en proyectos open source que facilita:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>La descarga de las librerías (ficheros JAR) externas de las que depende un proyecto</p>
</li>
<li>
<p>La construcción, prueba y despliegue del proyecto desarrollado, produciendo el fichero JAR o WAR final a partir de su código fuente y del fichero POM de descripción del proyecto</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Maven se origina de hecho en la comunidad <em>open source</em>, en concreto en la Apache Software Foundation en la que se desarrolló para poder gestionar y minimizar la complejidad de la construcción del proyecto Jakarta Turbine en 2002. El diseñador principal de Maven fue Jason van Zyl, ahora en la empresa Sonatype. En 2003 el proyecto fue aceptado como proyecto de nivel principal de Apache. En octubre de 2005 se lanzó Maven 2. Desde entonces ha sido adoptado como la herramienta de desarrollo de software de muchas empresas y se ha integrado con muchos otros proyectos y entornos. Maven 3.0 se lanzó en octubre de 2010, siendo la mayoría de sus comandos compatibles con Maven 2.</p>
</div>
<div class="paragraph">
<p>Maven es una herramienta de línea de comando, similar a las herramientas habituales en Java como <code>javac</code>, <code>jar</code> o a proyectos como Ant. Aunque es posible utilizar Maven en IDEs como Eclipse o Glassfish, es muy útil conocer la utilización de Maven en línea de comandos porque es la base de cualquier adaptación gráfica.</p>
</div>
<div class="paragraph">
<p>Una de las características principales de Maven es su enfoque declarativo, frente al enfoque orientado a tareas de herramientas tradicionales como Make o Ant. En Maven, el proceso de compilación de un proyecto se basa en una descripción de su estructura y de su contenido. Maven mantiene el concepto de modelo de un proyecto y obliga a definir un identificador único para cada proyecto que desarrollemos, así como declarar sus características (URL, versión, librerías que usa, tipo y nombre del artefacto generado, etc.). Todas estas características deben estar especificadas en el fichero POM (<em>Project Object Model</em>, fichero <code>pom.xml</code> en el directorio raíz del proyecto). De esta forma es posible publicar el proyecto en un <em>repositorio</em> y ponerlo a disposición de la comunidad para que otros a su vez puedan usarlo como librería.</p>
</div>
<div class="paragraph">
<p>Maven impone una estructura de directorios en la que guardar los distintos elementos de un programa Java. En el caso de una aplicación web:</p>
</div>
<div class="sect3">
<h4 id="_instalación_de_maven">2.1.1. Instalación de Maven</h4>
<div class="paragraph">
<p>Maven ya viene preinstalado en la máquina virtual del experto. La instalación en Linux es muy sencilla.</p>
</div>
<div class="paragraph">
<p>En primer lugar debemos descargar la última versión de la <a href="http://maven.apache.org/download.html">página web oficial</a> y descomprimirla en algún directorio del sistema. En el caso de la MV, lo hemos instalado en <code>/usr/local/maven</code>.</p>
</div>
<div class="paragraph">
<p>Maven es una aplicación Java, y utiliza la variable <code>JAVA_HOME</code> para encontrar el path del JDK. También es necesario añadir el directorio <code>bin</code> de Maven al <code>PATH</code> del sistema. Se pueden definir en el fichero de configuración <code>.profile</code> de un usuario. En nuestro caso hemos modificado el único usuario de la MV <code>expertojava</code>. La variabel de entorno <code>M2_HOME</code> es utilizada por IntelliJ para localizar la ubicación de Maven. El código que hemos añadido ha sido este:</p>
</div>
<div class="listingblock">
<div class="title">Fichero .profile:</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">#</span><span class="tok-c"># Java</span>
<span class="tok-go">export JAVA_HOME=/usr/local/java</span>
<span class="tok-go">PATH=$JAVA_HOME/bin:$PATH</span>

<span class="tok-gp">#</span><span class="tok-c"># Maven</span>
<span class="tok-go">export M2_HOME=/usr/local/maven</span>
<span class="tok-go">PATH=$PATH:/usr/local/maven/bin</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_dependencias_de_librerías_en_proyectos_java">2.1.2. Dependencias de librerías en proyectos Java</h4>
<div class="paragraph">
<p>Una característica del desarrollo de proyectos Java es la gran cantidad de librerías (ficheros JAR) necesarios para compilar y ejecutar un proyecto. Todas las librerías que se importan deben estar físicamente tanto en la máquina en la que se compila el proyecto como en la que posteriormente se ejecuta.</p>
</div>
<div class="paragraph">
<p>El proceso de mantener estas dependencias es tedioso y muy propenso a errores. Hay que obtener las librerías, cuidar que sean las versiones correctas, obtener las librerías de las que éstas dependen a su vez y distribuirlas todas ellas en todos los ordenadores de los desarrolladores y en los servidores en los que el proyecto se va a desplegar.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, si nuestro proyecto necesita una implementación de JPA, como Hibernate, es necesario bajarse todos los JAR de Hibernate, junto con los JAR de los que depende, una lista de más de 15 ficheros. Es complicado hacerlo a mano y distribuir los ficheros en todos los ordenadores en los que el proyecto debe compilarse y ejecutarse. Para que Maven automatice el proceso sólo es necesario declarar en el fichero POM las siguientes líneas:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml">...
   <span class="tok-nt">&lt;dependency&gt;</span>
      <span class="tok-nt">&lt;groupId&gt;</span>org.hibernate<span class="tok-nt">&lt;/groupId&gt;</span>
      <span class="tok-nt">&lt;artifactId&gt;</span>hibernate-entitymanager<span class="tok-nt">&lt;/artifactId&gt;</span>
      <span class="tok-nt">&lt;version&gt;</span>3.5.6-Final<span class="tok-nt">&lt;/version&gt;</span>
   <span class="tok-nt">&lt;/dependency&gt;</span>
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Maven se encarga de descargar todas las bibliotecas necesarias para un proyecto cuando ejecutamos el comando <code>mvn install</code>. Las guarda en el denominado <em>repositorio local</em>, el directorio oculto <code>.m2</code> en el directorio raíz del usuario.</p>
</div>
</div>
<div class="sect3">
<h4 id="_el_proceso_de_build_de_un_proyecto">2.1.3. El proceso de build de un proyecto</h4>
<div class="paragraph">
<p>Los que hemos programado en C recordamos los ficheros <code>Makefile</code> en los que se especificaban las dependencias entre los distintos elementos de un proyecto y la secuencia de compilación necesaria para generar una librería o un ejecutable. En Java, el desarrollo de aplicaciones medianamente complejas es más complicado que en C. Estamos obligados a gestionar un gran número de recursos: código fuente, ficheros de configuración, librerías externas, librerías desarrolladas en la empresa, etc. Para gestionar este desarrollo es necesario algo de más nivel que las herramientas que proporciona Java (<code>javac</code>, <code>jar</code>, <code>rmic</code>, <code>java</code>, etc.)</p>
</div>
<div class="paragraph">
<p>¿En qué consiste el proceso de compilación y empaquetado en Java?. Básicamente en construir lo que Maven llama un <em>artefacto</em> (terminología de Maven que significa <em>fichero</em>) a partir de un proyecto Java definido con una estructura propia de Maven (apartado siguiente). Los posibles artefactos en los que podemos empaquetar un programa Java son:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Fichero JAR</dt>
<dd>
<p>librería de clases o aplicación standalone. Contiene clases Java compiladas (.class) organizadas en paquetes, ficheros de recursos y (opcionalmente) otros ficheros JAR con bibliotecas usadas por las clases. En las aplicaciones enterprise, los EJB también se empaquetan en ficheros JAR que se despliegan en servidores de aplicaciones.</p>
</dd>
<dt class="hdlist1">Fichero WAR</dt>
<dd>
<p>aplicación web lista para desplegarse en un servidor web. Contiene un conjunto de clases Java, bibliotecas, ficheros de configuración y ficheros de distintos formatos que maneja el servidor web (HTML, JPG, etc.)</p>
</dd>
<dt class="hdlist1">Fichero EAR</dt>
<dd>
<p>aplicación enterprise que se despliega en un servidor de aplicaciones. Contiene bibliotecas, componentes EJB y distintas aplicaciones web (ficheros WAR).</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Además, el ciclo de desarrollo de un proyecto es más complejo que esta construcción, ya que es necesario realizar un conjunto de tareas adicionales como gestionar las dependencias con librerías externas, integrar el código en repositorios de control de versiones (CVS, subversion o Git), lanzar tests o desplegar la aplicación en algún servidor de aplicaciones.</p>
</div>
<div class="paragraph">
<p>Podría pensarse que los entornos de desarrollo (Eclipse, Netbeans o IntelliJ) pueden dar una buena solución a la complejidad del proceso de construcción, pero no es así. Son imprescindibles para el desarrollo, pero no ayudan demasiado en la construcción del proyecto. La configuración de las dependencias se realiza mediante asistentes gráficos que no generan ficheros de texto comprensibles que podamos utilizar para comunicarnos con otros compañeros o equipos de desarrolladores y que pueden dar lugar a errores. El hecho de que sean entornos gráficos hacen complicado también usarlos en procesos de automatización y de integración continua.</p>
</div>
</div>
<div class="sect3">
<h4 id="_estructura_de_un_proyecto_maven">2.1.4. Estructura de un proyecto Maven</h4>
<div class="paragraph">
<p>La estructura de directorios de una aplicación web Maven es la que aparece en la siguiente figura.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint01/maven.png" alt="Estructura de directorios de Maven" width="33%">
</div>
</div>
<div class="paragraph">
<p>El nombre del directorio raíz no influye en el proyecto Maven, podemos cambiarlo sin que afecte a ninguno de sus elementos. En ese directorio raíz se definen los siguientes directorios:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>src</code>: código fuente del proyecto, tanto clases principales como clases de prueba. Dentro se define un directorio <code>main</code> y otro <code>test</code>, en donde van el código fuente de la aplicación y su código de prueba. Dentro de ambos se define un directorio <code>java</code> con los paquetes de código fuente de la aplicación, un directorio <code>webapps</code> con los ficheros HTML, JSP y de configuración de la aplicación web y un directorio <code>resources</code> en el que se dejan ficheros de configuración. Ambos directorios se añaden al <em>classpath</em>.</p>
</li>
<li>
<p><code>target</code>: clases compiladas y artefactos generados a partir del código fuente y del resto de ficheros del directorio <code>src</code>.</p>
</li>
<li>
<p>fichero <code>pom.xml</code>: fichero con la descripción de los elementos necesarios para todo el ciclo de vida del proyecto: compilación, test, empaquetado, despliegue e instalación en el repositorio de la empresa.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_pom_project_object_model">2.1.5. POM: Project Object Model</h4>
<div class="paragraph">
<p>El elemento más importante de un proyecto Maven, a parte de su estructura, es su fichero POM en el que se define completamente el proyecto. Este fichero define elementos XML preestablecidos que deben ser definidos para el proyecto concreto que estamos desarrollando. Viendo algunos de ellos podemos entender también más características de Maven.</p>
</div>
<div class="paragraph">
<p>Vamos a utilizar como ejemplo la versión inicial del POM del proyecto web que vamos a construir en un rato. Veamos su fichero <code>pom.xml</code>.  Al comienzo nos encontramos con la cabecera XML y la definición del proyecto:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tok-nt">&lt;project</span> <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://maven.apache.org/POM/4.0.0&quot;</span>  <span class="tok-na">xmlns:xsi=</span><span class="tok-s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="tok-na">xsi:schemaLocation=</span><span class="tok-s">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span><span class="tok-nt">&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-nt">&lt;modelVersion&gt;</span>4.0.0<span class="tok-nt">&lt;/modelVersion&gt;</span>

    <span class="tok-nt">&lt;groupId&gt;</span>org.expertojava.jbibrest<span class="tok-nt">&lt;/groupId&gt;</span>
    <span class="tok-nt">&lt;artifactId&gt;</span>jbib-rest<span class="tok-nt">&lt;/artifactId&gt;</span>
    <span class="tok-nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="tok-err">&lt;</span>/version<i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-nt">&lt;packaging&gt;</span>war<span class="tok-nt">&lt;/packaging&gt;</span> <i class="conum" data-value="3"></i><b>(3)</b>

    <span class="tok-nt">&lt;name&gt;</span>jbib-rest<span class="tok-nt">&lt;/name&gt;</span> <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>La primera definición <code>project xmlns</code> es común para todos los ficheros <code>pom.xml</code>. En ella se declara el tipo de esquema XML y la dirección donde se encuentra el fichero de esquema XML. Se utiliza para que los editores de XML puedan validar correctamente el fichero. Esta sintaxis depende de la versión de Maven que se esté utilizando.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Después aparece la identificación del proyecto, en la que hay que definir el grupo que desarrolla el proyecto (<em>groupId</em>), el nombre del artefacto que genera el proyecto (<em>artifactId</em>), el tipo de empaquetamiento (<em>packaging</em>) y su versión (<em>version</em>). Estos campos representan las denominadas <em>coordenadas del proyecto</em> (hablaremos de ello más adelante). En nuestro caso son <code>es.ua.jtech.proyint:jbib-modelo:jar:0.0.1-SNAPSHOT</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>En el atributo <code>packaging</code> debemos definir el tipo de empaquetado del <em>artefacto</em>  resultante. En nuestro caso, será un fichero WAR que contendrá toda la aplicación web. Este artefacto se generará cuando hagamos un <code>mvn package</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Por último, el atributo <code>name</code> define el nombre lógico del proyecto.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A continuación se definen algunas propiedades del proyecto, que se utilizarán en los distintos procesos de Maven. En nuestro caso, por ahora, sólo la codificación de caracteres que estamos utilizando en el código fuente de nuestro proyecto:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;properties&gt;</span>
    <span class="tok-nt">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span class="tok-nt">&lt;/project.build.sourceEncoding&gt;</span>
<span class="tok-nt">&lt;/properties&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Después vienen la definición de las dependencias del proyecto: librerías de las que dependen el proyecto. En nuestro caso:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Librerías Java EE: <code>javax:javaee-web-api:7.0</code></p>
</li>
<li>
<p>Librarías para logs logs_ : <code>log4j:log4j:1.2.17</code> y <code>commons-logging:commons-logging:1.2</code></p>
</li>
<li>
<p>JUnit: <code>junit:junit:4.11</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml">    <span class="tok-nt">&lt;dependencies&gt;</span>
        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>javax<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>javaee-web-api<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>7.0<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>provided<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>
        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>log4j<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>log4j<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>1.2.17<span class="tok-nt">&lt;/version&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>
        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>commons-logging<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>commons-logging<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>1.2<span class="tok-nt">&lt;/version&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>
        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>junit<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>junit<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>4.11<span class="tok-nt">&lt;/version&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>
    <span class="tok-nt">&lt;/dependencies&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por último, definimos algunas características de los procesos de Maven que construyen el proyecto, definiendo parámetros para los <em>pluging</em> de Maven que se encargan de ejecutarlos.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml">    <span class="tok-nt">&lt;build&gt;</span>
        <span class="tok-nt">&lt;finalName&gt;</span>${project.name}<span class="tok-nt">&lt;/finalName&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-nt">&lt;plugins&gt;</span>
            <span class="tok-nt">&lt;plugin&gt;</span>
                <span class="tok-nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="tok-nt">&lt;/groupId&gt;</span>  <i class="conum" data-value="2"></i><b>(2)</b>
                <span class="tok-nt">&lt;artifactId&gt;</span>maven-compiler-plugin<span class="tok-nt">&lt;/artifactId&gt;</span>
                <span class="tok-nt">&lt;version&gt;</span>3.1<span class="tok-nt">&lt;/version&gt;</span>
                <span class="tok-nt">&lt;configuration&gt;</span>
                    <span class="tok-nt">&lt;source&gt;</span>1.7<span class="tok-nt">&lt;/source&gt;</span>
                    <span class="tok-nt">&lt;target&gt;</span>1.7<span class="tok-nt">&lt;/target&gt;</span>
                <span class="tok-nt">&lt;/configuration&gt;</span>
            <span class="tok-nt">&lt;/plugin&gt;</span>
            <span class="tok-nt">&lt;plugin&gt;</span>
                <span class="tok-nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="tok-nt">&lt;/groupId&gt;</span> <i class="conum" data-value="3"></i><b>(3)</b>
                <span class="tok-nt">&lt;artifactId&gt;</span>maven-war-plugin<span class="tok-nt">&lt;/artifactId&gt;</span>
                <span class="tok-nt">&lt;version&gt;</span>2.3<span class="tok-nt">&lt;/version&gt;</span>
                <span class="tok-nt">&lt;configuration&gt;</span>
                    <span class="tok-nt">&lt;failOnMissingWebXml&gt;</span>false<span class="tok-nt">&lt;/failOnMissingWebXml&gt;</span>
                <span class="tok-nt">&lt;/configuration&gt;</span>
            <span class="tok-nt">&lt;/plugin&gt;</span>
            <span class="tok-nt">&lt;plugin&gt;</span>
                <span class="tok-nt">&lt;groupId&gt;</span>org.wildfly.plugins<span class="tok-nt">&lt;/groupId&gt;</span> <i class="conum" data-value="4"></i><b>(4)</b>
                <span class="tok-nt">&lt;artifactId&gt;</span>wildfly-maven-plugin<span class="tok-nt">&lt;/artifactId&gt;</span>
                <span class="tok-nt">&lt;version&gt;</span>1.0.2.Final<span class="tok-nt">&lt;/version&gt;</span>
                <span class="tok-nt">&lt;configuration&gt;</span>
                    <span class="tok-nt">&lt;hostname&gt;</span>localhost<span class="tok-nt">&lt;/hostname&gt;</span>
                    <span class="tok-nt">&lt;port&gt;</span>9990<span class="tok-nt">&lt;/port&gt;</span>
                <span class="tok-nt">&lt;/configuration&gt;</span>
            <span class="tok-nt">&lt;/plugin&gt;</span>
        <span class="tok-nt">&lt;/plugins&gt;</span>
    <span class="tok-nt">&lt;/build&gt;</span>
<span class="tok-nt">&lt;/project&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>En <code>finalName</code> definimos el nombre del <em>artefacto</em> generado cuando hagamos un <code>mvn package</code>. En nuestro caso será <code>jbib-web.war</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>En el plugin <code>maven-compiler-plugin</code> declaramos la versión de Java con la que queremos que se compilen las clases. En nuestro caso, la versión 1.7.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>El plugin <code>maven-war-plugin</code> lo usamos únicamente para declarar que podemos no incluir un fichero <code>web.xml</code> en la aplicación.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Por último, el <a href="https://docs.jboss.org/wildfly/plugins/maven/latest/">plugin de Maven de Wildfly</a> <code>wildfly-maven-plugin</code> permite realizar el despliegue de la aplicación web en el servidor de aplicaciones. El despliegue se realiza con el comando <code>mvn wildfly:deploy</code>.</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_pom_padre">POM padre</h5>
<div class="paragraph">
<p>Es posible definir un conjunto de propiedades y dependencias en un único <em>POM padre</em> y cargarlas en distintos subproyectos, cada uno con su propio POM específico. Es útil para definir elementos comunes y evitar repetirlos en todos los POM. Por ejemplo, podríamos definir un POM en el que se declaren todas las librerías que se usan habitualmente por nuestros proyectos e incluir este POM en todos los proyectos utilizando herencia.</p>
</div>
<div class="paragraph">
<p>También se puede utilizar el POM padre como un <em>POM agregador</em> de varios subproyectos Maven. Cada subproyecto tiene su propio POM para construir su artefacto (por ejemplo JARs) y el POM padre coordina la construcción de todos ellos y, en su caso, la construcción de un WAR o un EAR en el que empaquetarlos.</p>
</div>
<div class="paragraph">
<p>En nuestro proyecto web no vamos a utilizar estas características, sino que vamos a definir un único POM en el que se especifica la generación de un único artefacto (el WAR con la aplicación web).</p>
</div>
<div class="paragraph">
<p>Maven define un <em>super POM</em> que por defecto es el padre de todos los POM. Allí se definen elementos comunes como la localización de los repositorios o la estructura de directorios por defecto de Maven. Se puede encontrar este super POM en el fichero llamado <code>pom-4.0.0.xml</code> en el JAR <code>maven-2.2.1-uber.jar</code> en el directorio <code>lib</code> de Maven.</p>
</div>
<div class="paragraph">
<p>Maven resuelve todas las relaciones de herencia entre POMs y genera internamente un <em>POM efectivo</em> (<em>effective POM</em>) en el que combinan todos los POMs que afectan a un determinado proyecto. Este POM efectivo es el que se utiliza para realizar la construcción del proyecto. Es posible consultar este POM efectivo con el comando:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml">mvn help:effective-pom</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_repositorios_maven">2.1.6. Repositorios Maven</h4>
<div class="paragraph">
<p>Los proyectos software modernos necesitan un gran número de clases y librerías definidas en otros proyectos. Esos proyectos pueden ser otros desarrollados por nosotros en la empresa o librerías open source bajadas de Internet.</p>
</div>
<div class="paragraph">
<p>La tarea de mantener las dependencias de un proyecto es complicada, tanto para las dependencias entre nuestros proyectos como las dependencias con otros proyectos open source disponibles en Internet. Por ejemplo, si queremos utilizar un framework como Spring, tendremos que descargarnos no sólo los JAR desarrollados en el proyecto, sino también un buen número de otras librerías open source que usa. Cada librería es un fichero JAR. ¿Qué pasa si alguna de esas librerías ya las estamos usando y las tenemos ya descargadas? O, peor aún, ¿Qué pasa si estamos usando otras versiones de esas librerías en nuestros proyectos? ¿Podremos detectar los posibles conflictos?. Maven se encarga de gestionar estas dependencias directas y las dependencias transitivas mediante los ficheros POM:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Descarga las librerías necesarias para construir el proyecto y los ficheros POM asociados a esas librerías</p>
</li>
<li>
<p>Resuelve dependencias transitivas, librerías que dependen de librerías de las que dependen nuestro proyecto</p>
</li>
<li>
<p>Resuelve conflictos entre librerías</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Un elemento fundamental para gestionar las dependencias es poder identificar y nombrar un proyecto. En Maven el nombre de un proyecto se define mediante los siguientes elementos (que en Maven se denominan <em>coordenadas</em>):</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">groupId</dt>
<dd>
<p>El grupo, compañía, equipo, organización, etc. Se utiliza una convención similar a la de los paquetes Java, comenzando por el nombre de dominio invertido de la organización que crea el proyecto. Por ejemplo, los <code>groupId</code> de la Apache Software Foundation comienzan con <code>org.apache</code></p>
</dd>
<dt class="hdlist1">artifactId</dt>
<dd>
<p>Identificador único que representa de forma única el proyecto dentro del <code>groupId</code></p>
</dd>
<dt class="hdlist1">version</dt>
<dd>
<p>Número de versión del proyecto, por ejemplo <code>1.3.5</code> o <code>1.3.6-beta-01</code></p>
</dd>
<dt class="hdlist1">packaging</dt>
<dd>
<p>Tipo de empaquetamiento del proyecto. Por defecto es <code>jar</code>. Un tipo <code>jar</code> genera una librería JAR, un tipo <code>war</code> se refiere a una aplicación web.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>En Maven un proyecto genera un artefacto. El artefacto puede ser un fichero JAR, WAR o EAR. El tipo de artefacto viene indicado en el tipo de empaquetamiento del proyecto.</p>
</div>
<div class="paragraph">
<p>El nombre final del fichero resultante de la construcción del proyecto es por defecto: <code>&lt;artifactId&gt;-&lt;version&gt;.&lt;packaging&gt;</code>.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, Apache ha desarrollado el proyecto <code>commons-email</code> que proporciona una serie de utilidades para la gestión de correos electrónicos en Java. Sus coordenadas son:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml">org.apache.commons:commons-email:1.1:jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>El artefacto (fichero JAR) generado por el proyecto tiene como nombre <code>email-1.1.jar</code></p>
</div>
<div class="paragraph">
<p>Cuando ejecutamos Maven por primera vez veremos que descarga un número de ficheros del repositorio remoto de Maven. Estos ficheros corresponden a plugins y librerías que necesita para construir el proyecto con el que estamos trabajando. Maven los descarga de un repositorio global a un repositorio local donde están disponibles para su uso. Sólo es necesario hacer esto la primera vez que se necesita la librería o el plugin. Las siguientes ocasiones ya está disponible en el repositorio local.</p>
</div>
<div class="paragraph">
<p>La direcciones en las que se encuentran los repositorios son las siguientes:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Repositorio central</dt>
<dd>
<p>El repositorio central de Maven se encuentra en <a href="http://repo1.maven.org/maven2">http://repo1.maven.org/maven2</a>. Se puede acceder a la dirección con un navegador y explorar su estructura.</p>
</dd>
<dt class="hdlist1">Repositorio local</dt>
<dd>
<p>El repositorio local se encuentra en el directorio <code>${HOME}/.m2/repository</code>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>La estructura de directorios de los repositorios (tanto el central como el local) está directamente relacionada con las <em>coordenadas</em> de los proyectos. Los proyectos tienen la siguiente ruta, relativa a la raíz del repositorio:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml">/<span class="tok-nt">&lt;groupId&gt;</span>/<span class="tok-nt">&lt;artifactId&gt;</span>/<span class="tok-nt">&lt;version&gt;</span>/<span class="tok-nt">&lt;artifactId&gt;</span>-<span class="tok-nt">&lt;version&gt;</span>.<span class="tok-nt">&lt;packaging&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por ejemplo, el artefacto <code>commons-email-1.1.jar</code>, con coordenadas <code>org.apache.commons:commons-email:1.1:jar</code> está disponible en la ruta:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml">/org/apache/commons/commons-email/1.1/commons-email-1.1.jar]]</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_versiones">2.1.7. Versiones</h4>
<div class="paragraph">
<p>El estándar de Maven para los números de versiones es muy importante, porque permite definir reglas para gestionar correctamente las dependencias en caso de conflicto. El número de versión de un proyecto se define por un número principal, un número menor y un número incremental. También es posible definir un calificador, para indicar una versión alfa o beta. Los números se separan por puntos y el calificador por un guión. Por ejemplo, el número <code>1.3.5-alpha-03</code> define un número de versión principal 1, la versión menor 3, la versión incremental de 5 y el calificador de <code>alpha-03</code>.</p>
</div>
<div class="paragraph">
<p>Maven compara las versiones de una dependencia utilizando este orden. Por ejemplo, la versión 1.3.4 representa un build más reciente que la 1.0.9. Los clasificadores se comparan utilizando comparación de cadenas. Hay que tener cuidado, porque <code>alpha10</code> es anterior a <code>alpha2</code>; habría que llamar al segundo <code>alpha02</code>.</p>
</div>
<div class="paragraph">
<p>Maven permite definir rangos de versiones en las dependencias, utilizando los operadores de rango exclusivos <code>(</code>, <code>)</code> o inclusivos <code>[</code>, <code>]</code>. Así, por ejemplo, si queremos indicar que nuestro proyecto necesita una versión de JUnit mayor o igual de 3.8, pero menor que 4.0, lo podemos indicar con el siguiente rango:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;version&gt;</span>[3.8,4.0)<span class="tok-nt">&lt;/version&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si una dependencia transitiva necesita la versión 3.8.1, esa es la escoge Maven sin crear ningún conflicto.</p>
</div>
<div class="paragraph">
<p>Es posible también indicar rangos de mayor que o menor que dejando sin escribir ningún número de versión antes o después de la coma. Por ejemplo, <code>[4.0,)</code> representa cualquier número mayor o igual que 4.0, <code>(,2.0)</code> representa cualquier versión menor que la <code>2.0</code> y <code>[1.2]</code> significa sólo la versión <code>1.2</code> y ninguna otra.</p>
</div>
<div class="paragraph">
<p>Cuando dos proyectos necesitan dos versiones distintas de la misma librería, Maven intenta resolver el conflicto, descargándose la que satisface todos los rangos. Si no utilizamos los operadores de rango estamos indicando que preferimos esa versión, pero que podríamos utilizar alguna otra. Por ejemplo, es distinto especificar <code>3.1</code> y <code>[3.1]</code>. En el primer caso preferimos la versión 3.1, pero si otro proyecto necesitara la <code>3.2</code> Maven se descargaría esa. En el segundo caso exigimos que la versión descargada sea la <code>3.1</code>. Si otro proyecto especifica otra versión obligatoria, por ejemplo <code>3.2</code>, entonces el proyecto no se compilará.</p>
</div>
<div class="paragraph">
<p>Es posible utilizar la palabra <code>SNAPSHOT</code> en el número de versión para indicar que es una versión en desarrollo y que todavía no está lanzada. Se utiliza internamente en los proyectos en desarrollo. La idea es que antes de que terminemos el desarrollo de la versión 1.0 (o cualquier otro número de versión), utilizaremos el nombre <code>1.0-SNAPSHOT</code> para indicar que se trata de "1.0 en desarrollo".</p>
</div>
<div class="paragraph">
<p>La utilización de la palabra <code>SNAPSHOT</code> en una dependencia hace que Maven descargue al repositorio local la última versión disponible del artefacto. Por ejemplo, si declaramos que necesitamos la librería <code>foo-1.0-SNAPSHOT.jar</code> cuando construyamos el proyecto Maven intentará buscar en el repositorio remoto la última versión de esta librería, incluso aunque ya exista en el repositorio local. Si encuentra en el repositorio remoto la versión <code>foo-1.0.-20110506.110000-1.jar</code> (versión que fue generada el 2011/05/06 a las 11:00:00) la descarga y sustituye la que tiene en el local. De forma inversa, cuando ejecutamos el goal <em>install</em> y se despliega el artefacto en el servidor remoto, Maven sustituye el palabra <code>SNAPSHOT</code> por la fecha actual.</p>
</div>
</div>
<div class="sect3">
<h4 id="_gestión_de_dependencias">2.1.8. Gestión de dependencias</h4>
<div class="paragraph">
<p>Hemos visto que una de las características principales de Maven es la posibilidad de definir las dependencias de un proyecto. En la sección <code>dependencies</code> del fichero POM se declaran las librerías necesarias para compilar, testear y ejecutar nuestra aplicación. Maven obtiene estas dependencias del repositorio central o de algún repositorio local configurado por nuestra empresa y las guarda en el directorio <code>.$HOME/.m2/repository</code>. Si utilizamos la misma librería en un varios proyectos, sólo se descargará una vez, lo que nos ahorrará espacio de disco y tiempo. Y lo que es más importante, el proyecto será mucho más ligero y portable, porque no llevará incluidas las librerías que necesita para su construcción.</p>
</div>
<div class="paragraph">
<p>Ya hemos visto en apartados anteriores cómo se declaran las dependencias en el fichero POM. Cada dependencia se define de forma unívoca utilizando sus coordenadas. El mecanismo de declaración de las dependencias es el mismo para las dependencias de librerías externas como para las definidas dentro de la organización.</p>
</div>
<div class="paragraph">
<p>Para definir una dependencia hay que identificar también el número de versión que se quiere utilizar, utilizando la nomenclatura del apartado anterior. Por ejemplo, la siguiente dependencia especifica una versión 3.0 o posterior de <code>hibernate</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;dependency&gt;</span>
   <span class="tok-nt">&lt;groupId&gt;</span>org.hibernate<span class="tok-nt">&lt;/groupId&gt;</span>
   <span class="tok-nt">&lt;artifactId&gt;</span>hibernate<span class="tok-nt">&lt;/artifactId&gt;</span>
   <span class="tok-nt">&lt;version&gt;</span>[3.0,)<span class="tok-nt">&lt;/version&gt;</span>
<span class="tok-nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Un concepto fundamental en Maven es el de dependencia transitiva. En los repositorios no solo se depositan los artefactos generados por los proyectos, sino también el fichero POM del proyecto. Y en ese fichero se definen las dependencias propias del proyecto. Por ejemplo, junto con el artefacto <code>hibernate-3.0.jar</code> se encuentra el fichero POM <code>hibernate-3.0.pom.xml</code> en el que se definen sus propias dependencias, librerías necesarias para Hibernate-3.0. Estas librerías son dependencias transitivas de nuestro proyecto. Si nuestro proyecto necesita Hibernate, e Hibernate necesita estas otra librería B, nuestro proyecto también necesita (de forma transitiva) la librería B. A su vez esa librería B tendrá también otras dependencias, y así sucesivamente.</p>
</div>
<div class="paragraph">
<p>Maven se encarga de resolver todas las dependencias transitivas y de descargar al respositorio local todos los artefactos necesarios para que nuestro proyecto se construya correctamente.</p>
</div>
<div class="paragraph">
<p>Otro elemento importante es el ámbito (<em>scope</em>) en el que se define la dependencia. El ámbito por defecto es <em>compile</em> y define librerías necesarias para la compilación del proyecto. También es posible especificar otros ámbitos. Por ejemplo <em>test</em>, indicando que la librería es necesaria para realizar pruebas del proyecto:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;dependency&gt;</span>
   <span class="tok-nt">&lt;groupId&gt;</span>junit<span class="tok-nt">&lt;/groupId&gt;</span>
   <span class="tok-nt">&lt;artifactId&gt;</span>junit<span class="tok-nt">&lt;/artifactId&gt;</span>
   <span class="tok-nt">&lt;version&gt;</span>4.8.1<span class="tok-nt">&lt;/version&gt;</span>
   <span class="tok-nt">&lt;type&gt;</span>jar<span class="tok-nt">&lt;/type&gt;</span>
   <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
<span class="tok-nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Otros ámbitos posibles son <em>provided</em> y <em>runtime</em>. Una dependencia se define <em>provided</em> cuando es necesaria para compilar la aplicación, pero que no se incluirá en el WAR y no será desplegada. Por ejemplo las APIs de servlets:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;dependency&gt;</span>
   <span class="tok-nt">&lt;groupId&gt;</span>javax.servlet<span class="tok-nt">&lt;/groupId&gt;</span>
   <span class="tok-nt">&lt;artifactId&gt;</span>servlet-api<span class="tok-nt">&lt;/artifactId&gt;</span>
   <span class="tok-nt">&lt;version&gt;</span>2.4<span class="tok-nt">&lt;/version&gt;</span>
   <span class="tok-nt">&lt;scope&gt;</span>provided<span class="tok-nt">&lt;/scope&gt;</span>
<span class="tok-nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Las dependencias <em>runtime</em> son dependencias que no se necesitan para la compilación, sólo para la ejecución. Por ejemplo los drivers de JDBC para conectarse a la base de datos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;dependency&gt;</span>
   <span class="tok-nt">&lt;groupId&gt;</span>mysql<span class="tok-nt">&lt;/groupId&gt;</span>
   <span class="tok-nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="tok-nt">&lt;/artifactId&gt;</span>
   <span class="tok-nt">&lt;version&gt;</span>3.1.13<span class="tok-nt">&lt;/version&gt;</span>
   <span class="tok-nt">&lt;scope&gt;</span>runtime<span class="tok-nt">&lt;/scope&gt;</span>
<span class="tok-nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Una herramienta muy útil es el informe de dependencia. Este informe se genera cuando se ejecuta el objetivo <code>site</code>. Maven construye un sitio web con información sobre el proyecto y coloca el informe en el fichero <code>target/dependencies.html</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> mvn site</code></pre>
</div>
</div>
<div class="paragraph">
<p>El informe muestra una lista de dependencias directas y transitivas y su ámbito.</p>
</div>
</div>
<div class="sect3">
<h4 id="_el_ciclo_de_vida_de_maven">2.1.9. El ciclo de vida de Maven</h4>
<div class="paragraph">
<p>El concepto de ciclo de vida es central para Maven. El ciclo de vida de un proyecto Maven es una secuencia de fases que hay que seguir de forma ordenada para construir el artefacto final.</p>
</div>
<div class="paragraph">
<p>Las fases principales del ciclo de vida por defecto son:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">validate</dt>
<dd>
<p>valida que el proyecto es correcto y que está disponible toda la información necesaria</p>
</dd>
<dt class="hdlist1">process-resources</dt>
<dd>
<p>procesar el código fuente, por ejemplo para filtrar algunos valores</p>
</dd>
<dt class="hdlist1">compile</dt>
<dd>
<p>compila el código fuente del proyecto</p>
</dd>
<dt class="hdlist1">test</dt>
<dd>
<p>lanza los tests del código fuente compilado del proyecto utilizando el framework de testing disponible. Estos tests no deben necesitar que el proyecto haya sido empaquetado o desplegado</p>
</dd>
<dt class="hdlist1">package</dt>
<dd>
<p>empaqueta el código compilado del proyecto en un formato distribuible, como un JAR</p>
</dd>
<dt class="hdlist1">integration-test</dt>
<dd>
<p>procesa y despliega el paquete en un entorno en donde se pueden realizar tests de integración</p>
</dd>
<dt class="hdlist1">verify</dt>
<dd>
<p>lanza pruebas que verifican que el paquete es válido y satisface ciertos criterios de calidad
install: instala el paquete en el repositorio local, para poder ser usado como librería en otros proyectos locales</p>
</dd>
<dt class="hdlist1">deploy</dt>
<dd>
<p>realizado en un entorno de integración o de lanzamiento, copia el paquete final en el repositorio remoto para ser compartido con otros desarrolladores y otros proyectos.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Todas estas fases se lanzan especificándolas como parámetro en el comando <code>mvn</code>. Si ejecutamos una fase, Maven se asegura que el proyecto pasa por todas las fases anteriores. Por ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> mvn install</code></pre>
</div>
</div>
<div class="paragraph">
<p>Esta llamada realiza la compilación, los tests, el empaquetado los tests de integración y la instalación del paquete resultante en el repositorio local de Maven.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Para un listado completo de todas las opciones de un comando <code>mvn</code> se puede consultar la página de Apache Maven <a href="http://maven.apache.org/guides/introduction/introduction-to-the-lifecycle.html">Introduction to the Build Lifecycle</a></p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_ejecución_de_tests">2.1.10. Ejecución de  tests</h4>
<div class="paragraph">
<p>Los tests de unidad son una parte importante de cualquier metodología moderna de desarrollo, y juegan un papel fundamental en el ciclo de vida de desarrollo de Maven. Por defecto, Maven obliga a pasar los tests antes de empaquetar el proyecto. Maven permite utilizar los frameworks de prueba JUnit y TestNG. Las clases de prueba deben colocarse en el directorio <code>src/test</code>.</p>
</div>
<div class="paragraph">
<p>Para ejecutar los tests se lanza el comando <code>mvn test</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> mvn <span class="tok-nb">test</span>
<span class="tok-go">[INFO] Scanning for projects...</span>
<span class="tok-go">...</span>
<span class="tok-go">-------------------------------------------------------</span>
<span class="tok-go"> T E S T S</span>
<span class="tok-go">-------------------------------------------------------</span>
<span class="tok-go">Running org.expertojava.jbibrest.modelo.UsuarioTest</span>
<span class="tok-go">Tests run: 5, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.082 sec</span>
<span class="tok-go">Running org.expertojava.jbibrest.modelo.OperacionTest</span>
<span class="tok-go">Tests run: 5, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.141 sec</span>
<span class="tok-go">Tests run: 8, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.018 sec</span>
<span class="tok-go">Running org.expertojava.jbibrest.modelo.AvisoTest</span>
<span class="tok-go">Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.012 sec</span>

<span class="tok-go">Results :</span>

<span class="tok-go">Tests run: 19, Failures: 0, Errors: 0, Skipped: 0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Maven compilará los tests si es necesario. Por defecto, los tests deben colocarse en el directorio <code>src/test</code> siguiendo una estructura idéntica a la estructura de clases del proyecto. Maven ejecutará todas las clases que comiencen o terminen con <code>Test</code> o que terminen con <code>TestCase</code>.</p>
</div>
<div class="paragraph">
<p>Los resultados detallados de los tests se producen en texto y en XML y se dejan en el directorio <code>target/surefire-reports</code>. Es posible también generar los resultados en HTML utilizando el comando:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> mvn surefire-report:report</code></pre>
</div>
</div>
<div class="paragraph">
<p>El informe HTML se generará en el fichero <code>target/site/surefire-report.html</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_uso_de_maven_en_intellij">2.1.11. Uso de Maven en IntelliJ</h4>
<div class="paragraph">
<p>IntelliJ reconoce los proyectos Maven a través del POM. Para importar un proyecto Maven en el IDE debes pulsar en el POM del proyecto. IntelliJ analiza el POM, descarga todas las librerías necesarias, identifica los directorios de la aplicación y los configura como directorios de fuentes, de tests, etc.</p>
</div>
<div class="paragraph">
<p>En la siguiente imagen vemos la estructura de directorios y las librerías de una versión inicial del proyecto web cargado. Podemos ver este panel en la parte superior izquierda de IntelliJ.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint01/estructura-directorios.png" alt="Estructura directorios" width="33%">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Bajo el directorio raíz vemos el directorio <code>src</code> con los subdirectorios <code>main</code> y <code>test</code>. También los ficheros <code>pom.xml</code> con el POM de Maven y el fichero <code>.gitignore</code> con los patrones a ignorar en el control de versiones. Y también se encuentra el directorio <code>.idea</code> y el fichero <code>jbib-rest-expertojava.iml</code> propios del IDE.</p>
</li>
<li>
<p>Debajo vemos las librerías declaradas en el POM y descargadas por Maven. IntelliJ las reconoce como librerías del proyecto y las incluirá en el paquete WAR cuando se realice el despliegue y ejecución del proyecto.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>En la parte superior derecha de IntelliJ podemos ver el panel de Maven. Desde este panel podemos interactuar con el comando Maven.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint01/panel-maven.png" alt="Panel Maven" width="33%">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Para ejecutar un <em>goal</em>, por ejemplo <code>package</code>, debemos seleccionar el objetivo y pulsar en el pequeño botón <em>play</em>, o hacer un doble click sobre el objetivo. Veremos que se abre en la parte inferior de IntelliJ un panel en el que se muestra la ejecución del comando Maven. El resultado es el mismo que si abrimos un terminal, nos movemos a la raíz del proyecto (que contiene el fichero POM) y ejecutamos desde línea de comando:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> mvn <span class="tok-nb">test</span></code></pre>
</div>
</div>
</li>
<li>
<p>El plugin <code>org.wildfly.plugins</code> proporciona <em>goals</em> adicionales relacionados con el despliegue del WAR en el servidor de aplicaciones. Los veremos más adelante.</p>
</li>
<li>
<p>El icono <em>Maven</em> sirve para abrir una ventana de diálogo en la que podemos lanzar el comando Maven de forma textual, escribiendo los parámetros adicionales que necesitemos</p>
</li>
<li>
<p>El botón de refresco sirve para recargar el POM en IntelliJ y actualizar la estructura del proyecto y sus dependencias si hemos realizado algún cambio en el fichero.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Otra característica interesante de IntelliJ es que permite añadir dependencias en el POM de forma interactiva. Desde el fichero <code>pom.xml</code> pulsamos el botón derecho y seleccionamos <em>Generate&#8230;&#8203;</em> (o pulsamos <code>Alt+Insertar</code>) y aparecerá el siguiente menú que permite modificar elementos del POM de forma interactiva:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint01/generate-dependency.png" alt="Generate dependency" width="25%">
</div>
</div>
<div class="paragraph">
<p>Por ejemplo, seleccionando <em>Dependency</em> aparece una herramienta de búsqueda de librerías que permite filtrar por nombre y explorar las distintas versiones de las librerías disponibles en el repositorio central de Maven:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint01/add-dependencies.png" alt="Add dependencies" width="66%">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_maven_con_git">2.1.12. Maven con Git</h4>
<div class="paragraph">
<p>Para crear un repositorio Git con un proyecto Maven, hay que hacer lo habitual: inicializar Git en la raíz del proyecto y añadir todos sus ficheros. Hay que tener cuidado de añadir en el repositorio sólo los ficheros fuente. Todos los ficheros de artefacto que crea Maven a partir de los ficheros fuente originales deben ser ignorados. Para ello basta con ignorar el directorio <code>target</code>.</p>
</div>
<div class="paragraph">
<p>El siguiente fichero <code>.gitignore</code> contiene las reglas que determinan los ficheros ignorados en un proyecto Maven en el que trabajamos con IntelliJ. Es recomendable ignorar también el fichero <code>.idea/workspace.xml</code> que contiene el estado de trabajo del IDE (pestañas abiertas, dimensiones de la ventana actual, etc.).</p>
</div>
<div class="listingblock">
<div class="title">Fichero <code>.gitignore</code></div>
<div class="content">
<pre class="pygments highlight"><code># ignore Maven generated target folders
target

# ignore IDEA files
.idea/workspace.xml</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_paso_a_paso_despliegue_con_maven">2.2. Paso a paso: despliegue con Maven</h3>
<div class="paragraph">
<p>El proyecto de aplicación web que vamos a desarrollar a lo largo del curso se compone de dos partes principales:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Una aplicación Java que se despliega en un servidor Java EE (WildFly) e implementa un API REST que proporciona la lógica de negocio</p>
</li>
<li>
<p>Una aplicación JavaScript que proporciona la interfaz de usuario que se ejecuta en el navegador</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Vamos a comenzar a construir la aplicación Java, un artefacto WAR que contendrá distintos paquetes que iremos desarrollando a lo largo de estas sesiones.</p>
</div>
<div class="paragraph">
<p>Comenzaremos con una aplicación muy básica, similar a la que has desarrollado en la asignatura de <em>Componentes Web</em>, que contiene algunos elementos iniciales básicos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Fichero JSP con un formulario que envía una petición a un servlet</p>
</li>
<li>
<p>Servlet que procesa los parámetros de la petición y gestiona algún error e invoca a una clase del modelo</p>
</li>
<li>
<p>Clase del modelo que implementa una sencilla funcionalidad y realiza una mínima gestión de errores</p>
</li>
<li>
<p>Logging</p>
</li>
<li>
<p>Tests</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Todo esto en un proyecto Maven con un POM que permite generar el WAR y desplegarlo en el servidor WildFly.</p>
</div>
<div class="paragraph">
<p>La mayor parte de esta aplicación básica ya está preparada y subida a la cuenta <em>java_ua</em> en Bitbucket, lista para que hagas un <em>fork</em>, te la descargues y comiences a trabajar con ella. Vamos a hacerlo paso a paso:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Haz un fork en tu cuenta de Bitbucket del proyecto <code>java_ua/jbibrest-proyint-expertojava</code></p>
</li>
<li>
<p>Descarga a tu ordenador este proyecto recién copiado. Puedes usar un <code>git clone</code> desde el terminal o la opción de IntelliJ <em>Check out from Version Control &gt; Git</em>:</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint01/clone-repository-intellij.png" alt="Clone Repository IntelliJ" width="100%">
</div>
</div>
</li>
<li>
<p>Vamos a comenzar probando a desplegar la aplicación web desde línea de comando. Abre dos terminales. En uno lanza WildFly con el comando:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> standalone.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>Cuando haya arrancado WildFly, en el otro terminal muévete al directorio donde te has descargado el proyecto y ejecuta el <em>goal</em> <code>wildfly:deploy</code>. Verás cómo el proyecto se compila, pasan los tests definidos y se despliega correctamente en el servidor de aplicaciones:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> <span class="tok-nb">cd </span>jbib-rest-expertojava
<span class="tok-gp">$</span> mvn wildfly:deploy

<span class="tok-go">[INFO] ------------------------------------------------------------------------</span>
<span class="tok-go">[INFO] Building jbib-rest 1.0-SNAPSHOT</span>
<span class="tok-go">[INFO] ------------------------------------------------------------------------</span>
<span class="tok-go">...</span>
<span class="tok-go">-------------------------------------------------------</span>
<span class="tok-go"> T E S T S</span>
<span class="tok-go">-------------------------------------------------------</span>
<span class="tok-go">Running org.expertojava.jbibrest.modelo.NombreTest</span>
<span class="tok-go">Tests run: 2, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.081 sec</span>

<span class="tok-go">Results :</span>

<span class="tok-go">Tests run: 2, Failures: 0, Errors: 0, Skipped: 0</span>

<span class="tok-go">[INFO]</span>
<span class="tok-go">[INFO] --- maven-war-plugin:2.3:war (default-war) @ jbib-rest ---</span>
<span class="tok-go">[INFO] Packaging webapp</span>
<span class="tok-go">[INFO] Assembling webapp [jbib-rest] in [/home/expertojava/Escritorio/jbibrest-proyint-expertojava/target/jbib-rest]</span>
<span class="tok-go">[INFO] Webapp assembled in [99 msecs]</span>
<span class="tok-go">[INFO] Building war: /home/expertojava/Escritorio/jbibrest-proyint-expertojava/target/jbib-rest.war</span>
<span class="tok-go">[INFO] --- wildfly-maven-plugin:1.0.2.Final:deploy (default-cli) @ jbib-rest ---</span>
<span class="tok-go">...</span>
<span class="tok-go">[INFO] ------------------------------------------------------------------------</span>
<span class="tok-go">[INFO] BUILD SUCCESS</span>
<span class="tok-go">[INFO] ------------------------------------------------------------------------</span>
<span class="tok-go">[INFO] Total time: 7.519 s</span>
<span class="tok-go">[INFO] Finished at: 2014-10-26T19:36:24+01:00</span>
<span class="tok-go">[INFO] Final Memory: 15M/128M</span>
<span class="tok-go">[INFO] ------------------------------------------------------------------------</span></code></pre>
</div>
</div>
</li>
<li>
<p>Probamos ahora la aplicación desplegada. En un navegador accede a la URL <em><a href="http://localhost:8080/jbib-rest/" class="bare">http://localhost:8080/jbib-rest/</a></em> en la que estará respondiendo la aplicación. Aparecerá un sencillo formulario con el que puedes comprobar que la aplicación está funcionando. Rellénalo y pulsa <em>Enviar</em>. Verás la petición en la URL y la página resultante con un saludo.</p>
</li>
<li>
<p>Prueba a editar la URL de la petición a mano, cambiando algunos parámetros:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-go">http://localhost:8080/jbib-rest/holamundo?nombre=Leia&amp;edad=22&amp;genero=mujer</span></code></pre>
</div>
</div>
</li>
<li>
<p>Prueba a introducir parámetros erróneos como un género que no existe o una edad negativa. En algunos casos el servlet detectará el error y devolverá un error 400 (BAD REQUEST) y en otros el error se detectará en la clase Java que implementa la lógica de negocio y se generará una excepción en tiempo de ejecución y un mensaje en el log. El fichero con los mensajes del log tiene la ruta <code>/home/expertojava/errors.log</code>.</p>
</li>
<li>
<p>En IntelliJ repasa el código de la aplicación:</p>
<div class="ulist">
<ul>
<li>
<p>El fichero  <code>index.jsp</code> en <code>src/main/webapp</code></p>
</li>
<li>
<p>El servlet <code>org.expertojava.jbibrest.HolaMundo.java</code> en <code>src/main/java/</code></p>
</li>
<li>
<p>La clase de modelo <code>org.expertojava.jbibrest.modelo.Nombre</code> también en el directorio de fuentes</p>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Piensa las siguientes preguntas sobre la aplicación: ¿Quién construye la cadena de saludo? ¿Qué parámetros hay que pasar? ¿Qué prerequisitos deben cumplir esos parámetros? ¿Desde dónde se invoca a esa construcción? ¿Quién, qué códigos de error HTTP se devuelven y en qué casos?</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Los tests merecen mención especial. Son muy sencillos, se encuentran en el fichero <code>org.expertojava.jbib.modelo.NombreTest.java</code> en el directorio <code>src/test/java</code>. Comprueban el método <code>getNombre()</code> del modelo. El nombre de los tests sigue el convenio <em>nombreFunción</em><strong>Should</strong><em>resultado</em><strong>When</strong><em>condiciónInicial</em> :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">getNombreShouldReturnSrWhenHombre</span><span class="tok-o">()</span> <span class="tok-kd">throws</span> <span class="tok-n">Exception</span> <span class="tok-o">{</span>
        <span class="tok-n">Nombre</span> <span class="tok-n">nombre</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Nombre</span><span class="tok-o">(</span><span class="tok-s">&quot;Jack&quot;</span><span class="tok-o">,</span> <span class="tok-mi">40</span><span class="tok-o">,</span> <span class="tok-n">Genero</span><span class="tok-o">.</span><span class="tok-na">hombre</span><span class="tok-o">);</span>
        <span class="tok-n">String</span> <span class="tok-n">nombreStr</span> <span class="tok-o">=</span> <span class="tok-n">nombre</span><span class="tok-o">.</span><span class="tok-na">getNombre</span><span class="tok-o">();</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">nombreStr</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-s">&quot;Sr. Jack (40 años)&quot;</span><span class="tok-o">));</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">getNombreShouldReturnSraWhenMujer</span><span class="tok-o">()</span> <span class="tok-kd">throws</span> <span class="tok-n">Exception</span> <span class="tok-o">{</span>
        <span class="tok-n">Nombre</span> <span class="tok-n">nombre</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Nombre</span><span class="tok-o">(</span><span class="tok-s">&quot;Kate&quot;</span><span class="tok-o">,</span> <span class="tok-mi">30</span><span class="tok-o">,</span> <span class="tok-n">Genero</span><span class="tok-o">.</span><span class="tok-na">mujer</span><span class="tok-o">);</span>
        <span class="tok-n">String</span> <span class="tok-n">nombreStr</span> <span class="tok-o">=</span> <span class="tok-n">nombre</span><span class="tok-o">.</span><span class="tok-na">getNombre</span><span class="tok-o">();</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">nombreStr</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-s">&quot;Sra. Kate (30 años)&quot;</span><span class="tok-o">));</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</li>
<li>
<p>Elimina la aplicación WAR desplegada haciendo:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>$ mvn wildfly:undeploy</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Para comprobar si el WAR está desplegado puedes conectarte a la URL: <em><a href="http://localhost:9990/" class="bare">http://localhost:9990/</a></em>, entrar en la consola de administración del servidor y seleccionar <em>Runtime &gt; Manage Deployments</em>. Desde esa pantalla puedes gestionar las aplicaciones desplegadas.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Termina deteniendo el servidor WildFly haciendo Ctrl+c en el terminal</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_paso_a_paso_despliegue_con_intellij">2.3. Paso a paso: despliegue con IntelliJ</h3>
<div class="paragraph">
<p>Veamos ahora cómo hacer el despliegue de la aplicación web usando IntelliJ.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Empezamos abriendo el proyecto IntelliJ <code>jbib-rest-expertojava</code> (en el directorio <code>jbibrest-proyint-expertojava</code>). En el repositorio Git se ha guardado también el fichero <code>.idea</code> que hay en la raíz del directorio, por lo que IntelliJ reconoce el proyecto y sus características. En el caso en que no estuviera este fichero habría que importarlo como un proyecto Maven, haciendo un doble click en el fichero POM.</p>
</li>
<li>
<p>Creamos una configuración de ejecución del tipo <em>JBoss Server &gt; Local</em>. Le ponemos como nombre <code>jbib-rest</code>, seleccionamos <em>JBoss 8.1.0.Final</em> como servidor de aplicaciones. Pulsamos en la pestaña de <em>Deployment</em> y en el símbolo <em>+</em> seleccionamos <em>Artifact&#8230;&#8203; &gt; jbib-rest-expertojava:war</em>. Seleccionamos también <em>Hot Swap Classes</em> para permitir desplegar <em>en caliente</em> las clases compiladas en las que hemos realizado cambios y marcamos la casilla <em>Share</em> para que se guarde en el repositorio Git la configuración de ejecución:</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint01/run-configuration.png" alt="Run Configuration" width="66%">
</div>
</div>
</li>
<li>
<p>Ahora pulsamos el botón de ejecución junto al desplegable con el nombre de la configuración de ejecución.</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint01/boton-run.png" alt="Run Configuration" width="25%">
</div>
</div>
<div class="paragraph">
<p>Veremos cómo se abre en la parte inferior el panel <em>Run</em>. Está dividido en dos zonas. En la zona derecha se muestra la consola del servidor de aplicaciones seleccionado en la configuración de ejecución (WildFly). El servidor se pone en marcha y vemos los mensajes que va escribiendo. En la parte izquierda está el panel de herramientas relacionadas con el despliegue de aplicación.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint01/run-intelliJ.png" alt="Run Configuration" width="66%">
</div>
</div>
<div class="paragraph">
<p>En la configuración de ejecución hemos seleccionado el artefacto <code>jbib-rest-expertojava:war</code>. IntelliJ compila las clases, las deja en el directorio <code>target/classes</code> y las empaqueta en el fichero <code>jbib-rest.war</code> en <code>target</code> (IntelliJ reutiliza los mismos directorios de Maven). Después lo despliega en WildFly y abre una navegador en la página definida en la configuración de ejecución. Si todo ha funcionado bien, veremos la página con el formulario. Cuando introducimos los datos vemos el saludo.</p>
</div>
</li>
<li>
<p>Desde IntelliJ también podemos usar el panel de Maven y desplegar (o seleccionar cualquier otro objetivo) con él el WAR. Por ejemplo, una vez desplegado el WAR podemos pulsar en el objetivo <em>Plugins &gt; wildfly &gt; wildfly:undeploy</em> para eliminar el WAR. Cuando lo hacemos se abre una nueva pestaña en el panel de consola en la que aparece la salida del comando Maven. Podemos intentar cargar la página inicial para comprobar que la aplicación ya no está disponible.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Después de modificar el estado de un artefacto (desplegarla o eliminarla) con Maven, su estado no se actualiza correctamente en el panel de ejecución. Debes pulsar el botón de refresco para actualizarlo.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_caso_de_estudio_y_modelo_de_dominio">2.4. Caso de estudio y modelo de dominio</h3>
<div class="sect3">
<h4 id="_introducción">2.4.1. Introducción</h4>
<div class="paragraph">
<p>A partir de un supuesto básico de la gestión de una biblioteca, vamos a crear un caso de estudio completo que evolucionará conforme estudiemos las diferentes tecnologías de la plataforma Java Enterprise.</p>
</div>
<div class="paragraph">
<p>El objetivo de esta sesión es introducir el caso de estudio que vamos a desarrollar, obtener una visión global del proyecto, fijando los casos de uso y requisitos principales y definiendo el esqueleto inicial del problema.</p>
</div>
</div>
<div class="sect3">
<h4 id="_historias_de_usuario">2.4.2. Historias de usuario</h4>
<div class="paragraph">
<p>El Instituto de Educación Secundaria "jUA" nos ha encargado que desarrollemos una aplicación para la gestión de los préstamos realizados en la biblioteca del centro, lo que implica tanto una gestión de los libros como de los alumnos y profesores que realizan estos prestamos.</p>
</div>
<div class="paragraph">
<p>Tras una serie de entrevistas y reuniones con diferente personal del centro, hemos decidido hacer un prototipo inicial que servirá para probar el funcionamiento de la parte de la aplicación destinada a los <em>clientes</em> de la biblioteca: profesores y alumnos que van a poder solicitar préstamos de libros a través de la aplicación.</p>
</div>
<div class="paragraph">
<p>En concreto, las características que vamos a implementar en este prototipo serán las siguientes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>La biblioteca contiene <strong>libros</strong>. El sistema debe guardar toda la información necesaria de cada libro: su título, autor, ISBN, etc. Puede existir más de un <strong>ejemplar</strong> de un mismo libro. Se quiere también guardar la información propia de cada ejemplar: fecha de adquisición, defectos que pueda tener, etc.</p>
</li>
<li>
<p>Los <strong>usuarios</strong> de la biblioteca (profesores y alumnos) utilizarán la aplicación para realizar una serie de acciones sobre estos libros: consultar su disponibilidad, pedirlos prestados, consultar la lista de libros prestados, etc. En concreto:</p>
<div class="ulist">
<ul>
<li>
<p>Pedir prestado un ejemplar disponible (que el bibliotecario le entregará cuando se pase por el mostrador)</p>
</li>
<li>
<p>Consultar el <strong>estado de los libros</strong> y sus ejemplares: un libro puede estar prestado (en sala, en casa o en el departamento) o disponible.</p>
</li>
<li>
<p>Consultar los libros que tiene prestados</p>
</li>
<li>
<p>Consultar los libros de la biblioteca</p>
</li>
</ul>
</div>
</li>
<li>
<p>La <strong>fecha de devolución del ejemplar</strong> dependerá de si el usuario es alumno o profesor y empezará a contar a partir del momento en que el libro se toma prestado con la aplicación. El número máximo de libros que puede tener en préstamo un usuario dependerá también de si es profesor o alumno.</p>
</li>
<li>
<p>Existe un <strong>número máximo de préstamos y reservas</strong> (operaciones) que puede hacer un usuario. La suma del número de préstamos y reservas de un usuario no puede sobrepasar este máximo. El máximo depende de si el usuario es un profesor o un alumno.</p>
</li>
<li>
<p>El estado por defecto de un usuario es <strong>activo</strong>. Cuando el usuario se retrasa en la devolución de un préstamo pasa a estado <strong>moroso</strong>. En ese estado no puede pedir prestado ni reservar ningún otro libro. Cuando devuelve el libro se le crea una multa y pasa a estado <strong>multado</strong>.</p>
</li>
<li>
<p>De la <strong>multa</strong> nos interesa saber la fecha de inicio y de finalización de la misma. La finalización de la multa dependerá del tipo de usuario. Nos han comunicado que quieren mantener un histórico de las multas que ha tenido un usuario. Cuando pasa la fecha de finalización, el estado del usuario vuelve a activo.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Estas funcionalidades las vamos a convertir más adelante en casos de uso y las vamos a implementar a lo largo del curso, conforme vaya avanzando el proyecto de integración.</p>
</div>
</div>
<div class="sect3">
<h4 id="_requisitos_de_información_irq">2.4.3. Requisitos de información (IRQ)</h4>
<div class="paragraph">
<p>Los requisitos de información resumen la información persistente que nos interesa almacenar relacionada con el sistema.</p>
</div>
<div class="paragraph">
<p>Respecto a un <strong>usuario</strong>, nos interesa almacenar:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Tipo de usuario</em>: profesor, alumno</p>
</li>
<li>
<p><em>Login</em> y <em>password</em></p>
</li>
<li>
<p>Nombre y apellidos</p>
</li>
<li>
<p><em>Correo electrónico</em></p>
</li>
<li>
<p>Lista de <em>préstamos</em> del usuario (actuales y pasados)</p>
</li>
<li>
<p><em>Estado de un usuario</em>: activo, moroso o multado</p>
</li>
<li>
<p>Datos referentes a su dirección, como son <em>calle</em>, <em>número</em>, <em>piso</em>, <em>ciudad</em> y <em>código postal</em>.</p>
</li>
<li>
<p>Si el usuario es alumno, necesitaremos guardar quién es su profesor <em>tutor</em></p>
</li>
<li>
<p>Si el usuario es profesor, necesitaremos el <em>nombre de su departamento</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Respecto a un <strong>libro</strong>, nos interesa almacenar:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>ISBN</em></p>
</li>
<li>
<p><em>Título y autor</em></p>
</li>
<li>
<p><em>Número de páginas</em></p>
</li>
<li>
<p><em>Fecha de alta</em> del libro</p>
</li>
<li>
<p><em>Número de ejemplares disponibles</em>: cambiará conforme se presten y devuelvan ejemplares</p>
</li>
<li>
<p><em>Ejemplares</em> de ese título</p>
</li>
<li>
<p><em>Tipo de finalización de la reserva</em>: cancelada o préstamo</p>
</li>
<li>
<p><em>URI de la portada</em>: dirección web de la imagen de donde se puede cargar la portada</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Queremos que la aplicación realice también recomendaciones de libros, de forma que para un libro a prestar se muestre una lista de libros relacionados. Esta lista de libros se obtendrá a partir de los libros que han tomado prestado usuarios que han tomado prestado el libro original.</p>
</div>
<div class="paragraph">
<p>Para ello cada vez que un usuario tome prestado un libro -<em>libro1</em>- se incrementará en 1 la frecuencia de la pareja (<em>libro1</em>, <em>libro-X</em>) para todos los _libro-X- que ha tomado prestado el usuario en el curso actual. De esta forma obtendremos una tabla de frecuencias de préstamo conjunto de libros.</p>
</div>
<div class="paragraph">
<p>Respecto a un <strong>ejemplar</strong>, almacenaremos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Identificador del ejemplar</em></p>
</li>
<li>
<p><em>Libro</em> al que pertenece el ejemplar</p>
</li>
<li>
<p><em>Fecha de adquisición</em></p>
</li>
<li>
<p><em>Observaciones</em>: texto sobre el estado del ejemplar</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Un <strong>préstamo</strong> relaciona ejemplares y usuarios. En cada préstamo guardaremos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Identificador del préstamo</em>
_ <em>Ejemplar</em> del préstamo
_ <em>Usuario</em> del préstamo</p>
</li>
<li>
<p><em>Fecha de préstamo</em></p>
</li>
<li>
<p><em>Fecha en la que debería devolverse</em></p>
</li>
<li>
<p><em>Fecha en la que se ha devuelto en realidad</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Cuando un usuario se retrase en la devolución de un libro, se le creará una <strong>multa</strong>. Nos han comunicado que quieren mantener un histórico de las multas que ha tenido un usuario. De cada multa nos interesa saber:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Usuario</em> que tiene la multa</p>
</li>
<li>
<p><em>Fecha de inicio</em></p>
</li>
<li>
<p><em>Fecha de finalización</em></p>
</li>
<li>
<p><em>Identificador del préstamo</em> causante de la multa</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_casos_de_uso">2.4.4. Casos de uso</h4>
<div class="paragraph">
<p>Los casos de uso son bastante sencillos. Vamos a centrarnos sólo en la parte del usuario registrado en la biblioteca, dejando para otro momento la parte de la aplicación del bibliotecario en la que se realizaría una gestión (altas, bajas y modificaciones) de los libros, ejemplares y usuarios. El siguiente esquema muestra los casos de uso de un usuario logeado en el sistema:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint01/casos-de-uso.png" alt="Casos de uso" width="66%">
</div>
</div>
<div class="paragraph">
<p>El <strong>usuario</strong> podrá consultar los libros disponibles en la biblioteca y obtener más información sobre aquellos en los que esté interesado, accediendo a la pantalla de detalle del libro. Desde esta pantalla de detalle podrá solicitar el préstamo del libro y ver la información de libros recomendados relacionados con el actual.</p>
</div>
<div class="paragraph">
<p>Para hacerse una idea mejor del funcionamiento de la aplicación es conveniente hacer diseños iniciales o <em>mockups</em> de estas pantallas, junto con un esquema de navegación de las mismas. Los vemos a continuación.</p>
</div>
<div class="paragraph">
<p>Esquema de navegación:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint01/esquema-navegacion.png" alt="Esquema de navegación" width="50%">
</div>
</div>
<div class="paragraph">
<p>Pantalla con el listado de libros:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint01/listado-libros.png" alt="Listado de libros" width="66%">
</div>
</div>
<div class="paragraph">
<p>Pantalla con el detalle de libro:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint01/detalle-libro.png" alt="Detalle del libro" width="66%">
</div>
</div>
<div class="paragraph">
<p>Pantalla con los libros que tiene prestados un usuario:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint01/mis-libros.png" alt="Mis libros" width="66%">
</div>
</div>
<div class="paragraph">
<p>Estos son bocetos iniciales de pantallas. A partir de ellas, del modelo de datos y de las reglas de negocio que veremos más adelante, diseñaremos el API REST con las funcionalidades que ofrecerá nuestro servicio.</p>
</div>
</div>
<div class="sect3">
<h4 id="_requisitos_de_restricción_crq">2.4.5. Requisitos de restricción (CRQ)</h4>
<div class="paragraph">
<p>Podemos resumir en la siguiente tabla las restricciones a aplicar a los casos de uso anteriores:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33%;">
<col style="width: 33%;">
<col style="width: 33%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Tipo de usuario</th>
<th class="tableblock halign-left valign-top">Número máximo de préstamos</th>
<th class="tableblock halign-left valign-top">Días de préstamo</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Alumno</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Profesor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">30</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>El máximo de libros prestados de un alumno es 6. Los libros prestados los tiene que devolver antes de 7 días.</p>
</div>
<div class="paragraph">
<p>En el momento que un usuario tenga una demora en la devolución de un préstamo, se considerará al usuario moroso y se le impondrá una penalización del doble de días de desfase durante los cuales no podrá ni reservar ni realizar préstamos de libros.</p>
</div>
</div>
<div class="sect3">
<h4 id="_modelo_de_clases">2.4.6. Modelo de clases</h4>
<div class="paragraph">
<p>A partir de los requisitos y tras unas sesiones de modelado, hemos llegado al siguiente modelo de clases conceptual representado mediante el siguiente diagrama UML:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint01/diagrama-clases.png" alt="Diagrama de clases" width="66%">
</div>
</div>
<div class="paragraph">
<p>Utilizaremos un modelo de clases como punto de partida del modelo de datos. En la siguiente sesión construiremos el modelo de datos basándonos en este modelo de clases y utilizando JPA (Java Persistence API). Veremos que este enfoque se denomina ORM (Object Relational Mapping), porque permite definir una relación directa (<em>mapping</em>) entre clases Java y tablas de la base de datos. La relación entre clases Java y tablas se define por medio de anotaciones JPA añadidas en el código fuente de las clases.</p>
</div>
<div class="paragraph">
<p>Vemos que casi todas las clases tienen un atributo <code>id</code> de tipo <code>Long</code>. Será la clave primaria de la tabla asociada a la clase y será generado automáticamente por la base de datos. Durante un tiempo de la vida del objeto, antes de ser insertado en la base de datos, este identificador va a ser <code>null</code>. Tenemos que tener en cuenta esto a la hora de definir correctamente los métodos <code>equals</code> y <code>hashCode</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>¿Por dónde empezamos al hacer el diseño de la aplicación? ¿Por los datos o por las clases? Podemos empezar modelando los datos o las clases, y ambos modelos serán casi semejantes. Normalmente, la elección viene dada por la destreza del analista, si se siente más seguro comenzando por los datos, o con el modelo conceptual de clases. Otra opción es el modelado en paralelo, de modo que al finalizar ambos modelos, podamos compararlos y validar si hemos comprobado todas las restricciones. Daremos más detalles en la siguiente sesión.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_desarrollo_e_implementación_parte_guiada_0_5_puntos">2.5. Desarrollo e implementación (parte guiada, 0,5 puntos)</h3>
<div class="paragraph">
<p>El objetivo de la sesión de hoy es crear todas las clases anteriores (clases de dominio) en el paquete <code>org.expertojava.jbibrest.modelo</code> del proyecto inicial que ya te has descargado y has probado que funciona correctamente. Estas clases definirán los tipos de datos básicos que utilizaremos para trabajar con la capa de persistencia y de lógica de negocio de nuestra API REST.</p>
</div>
<div class="paragraph">
<p>A lo largo de las siguientes sesiones del proyecto construiremos nuevos módulos necesarios para el API REST con los métodos de negocio y la aplicación JavaScript que construye la interfaz de usuario.</p>
</div>
<div class="paragraph">
<p>Comentamos a continuación los pasos a seguir para desarrollar el esqueleto del dominio del proyecto, que incluye la clase Libro, algunas clases auxiliares, excepciones y pruebas. Al final de esta guía paso a paso tendrás una versión inicial del programa. Deberás entonces terminar de implementar el resto.</p>
</div>
<div class="paragraph">
<p>Es muy importante en esta parte guiada que no te limites a copiar y pegar el código, sino que reflexiones sobre lo que hace.</p>
</div>
<div class="sect3">
<h4 id="_clase_de_domino_code_libro_code">2.5.1. Clase de domino <code>Libro</code></h4>
<div class="paragraph">
<p>Las clases de dominio representan las entidades que van a hacerse persistentes y con las que van a trabajar las capas de persistencia y de lógica de dominio de la aplicación. En las siguientes sesiones, cuando veamos JPA, veremos cómo se podrán definir la capa de persistencia de la aplicación directamente a partir de estas clases y cómo se utilizarán para encapsular los datos pasados como parámetros y devueltos por las funciones de la capa de negocio implementadas por componentes EJB.</p>
</div>
<div class="paragraph">
<p>Para asegurarnos que todos nuestros objetos de dominio tienen una estructura común, definimos una clase abstracta, que será la clase padre de todas las clases de dominio. Definiremos en esa clase los métodos <code>equals()</code> y <code>hashCode()</code> para obligar a que las clases hijas implementen y redefinan la igualdad. Estos métodos son necesarios para poder guardar los objetos en colecciones.</p>
</div>
<div class="listingblock">
<div class="title">org.expertojava.jbibrest.modelo.ClaseDomino</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kd">abstract</span> <span class="tok-kd">class</span> <span class="tok-nc">ClaseDominio</span> <span class="tok-o">{</span>
    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-kd">final</span> <span class="tok-kt">long</span> <span class="tok-n">serialVersionUID</span> <span class="tok-o">=</span> <span class="tok-mi">1L</span><span class="tok-o">;</span>
    <span class="tok-kd">public</span> <span class="tok-kd">abstract</span> <span class="tok-kt">boolean</span> <span class="tok-nf">equals</span><span class="tok-o">(</span><span class="tok-n">Object</span> <span class="tok-n">object</span><span class="tok-o">);</span>
    <span class="tok-kd">public</span> <span class="tok-kd">abstract</span> <span class="tok-kt">int</span> <span class="tok-nf">hashCode</span><span class="tok-o">();</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Todas las entidades las vamos a definir dentro del paquete <code>org.expertojava.jbibrest.modelo</code>. Cada objeto de dominio se compone de sus atributos, relaciones y de todos los <em>getter/setter</em> que encapsulan al objeto.</p>
</div>
<div class="paragraph">
<p>Vamos a definir las clases <code>Libro</code> y <code>Ejemplar</code>. Define también la otra clase (pero vacía, sin incluir código) <code>PrestadoJuntoCon</code> para que no haya errores de compilación.</p>
</div>
<div class="paragraph">
<p>Empezamos por la clase <code>Libro</code>:</p>
</div>
<div class="listingblock">
<div class="title">org.expertojava.jbibrest.modelo.Libro</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">modelo</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.apache.commons.logging.Log</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.apache.commons.logging.LogFactory</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">java.util.HashSet</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.Set</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Libro</span> <span class="tok-kd">extends</span> <span class="tok-n">ClaseDominio</span> <span class="tok-o">{</span>
    <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">PrestadoJuntoCon</span><span class="tok-o">&gt;</span> <span class="tok-n">prestadoCon</span><span class="tok-o">;</span>
    <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Ejemplar</span><span class="tok-o">&gt;</span> <span class="tok-n">ejemplares</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-n">Long</span> <span class="tok-n">id</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">isbn</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">autor</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">titulo</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-n">Integer</span> <span class="tok-n">numPaginas</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-n">Integer</span> <span class="tok-n">numEjemplares</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">portadaURI</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">Log</span> <span class="tok-n">logger</span> <span class="tok-o">=</span> <span class="tok-n">LogFactory</span><span class="tok-o">.</span><span class="tok-na">getLog</span><span class="tok-o">(</span><span class="tok-n">Libro</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>

    <span class="tok-kd">public</span> <span class="tok-nf">Libro</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">isbn</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">isbn</span> <span class="tok-o">=</span> <span class="tok-n">isbn</span><span class="tok-o">;</span>
        <span class="tok-n">prestadoCon</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">HashSet</span><span class="tok-o">&lt;</span><span class="tok-n">PrestadoJuntoCon</span><span class="tok-o">&gt;();</span>
        <span class="tok-n">ejemplares</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">HashSet</span><span class="tok-o">&lt;</span><span class="tok-n">Ejemplar</span><span class="tok-o">&gt;();</span>
        <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-na">debug</span><span class="tok-o">(</span><span class="tok-s">&quot;Nueva instancia de Libro: &quot;</span> <span class="tok-o">+</span> <span class="tok-n">isbn</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">Long</span> <span class="tok-nf">getId</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">id</span><span class="tok-o">;</span> <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getIsbn</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">isbn</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setIsbn</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">isbn</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">isbn</span> <span class="tok-o">=</span> <span class="tok-n">isbn</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getAutor</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">autor</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setAutor</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">autor</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">autor</span> <span class="tok-o">=</span> <span class="tok-n">autor</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getTitulo</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">titulo</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setTitulo</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">titulo</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">titulo</span> <span class="tok-o">=</span> <span class="tok-n">titulo</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">Integer</span> <span class="tok-nf">getNumPaginas</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">numPaginas</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setNumPaginas</span><span class="tok-o">(</span><span class="tok-n">Integer</span> <span class="tok-n">numPaginas</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">numPaginas</span> <span class="tok-o">=</span> <span class="tok-n">numPaginas</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">Integer</span> <span class="tok-nf">getNumEjemplares</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">numEjemplares</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setNumEjemplares</span><span class="tok-o">(</span><span class="tok-n">Integer</span> <span class="tok-n">numEjemplares</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">numEjemplares</span> <span class="tok-o">=</span> <span class="tok-n">numEjemplares</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getPortadaURI</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">portadaURI</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setPortadaURI</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">portadaURI</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">portadaURI</span> <span class="tok-o">=</span> <span class="tok-n">portadaURI</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">PrestadoJuntoCon</span><span class="tok-o">&gt;</span> <span class="tok-nf">getPrestadoCon</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">prestadoCon</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setPrestadoCon</span><span class="tok-o">(</span><span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">PrestadoJuntoCon</span><span class="tok-o">&gt;</span> <span class="tok-n">prestadoCon</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">prestadoCon</span> <span class="tok-o">=</span> <span class="tok-n">prestadoCon</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Ejemplar</span><span class="tok-o">&gt;</span> <span class="tok-nf">getEjemplares</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">ejemplares</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setEjemplares</span><span class="tok-o">(</span><span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Ejemplar</span><span class="tok-o">&gt;</span> <span class="tok-n">ejemplares</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">ejemplares</span> <span class="tok-o">=</span> <span class="tok-n">ejemplares</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-c1">// Dos libros son iguales cuando tienen el mismo ISBN</span>
    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-kt">boolean</span> <span class="tok-nf">equals</span><span class="tok-o">(</span><span class="tok-n">Object</span> <span class="tok-n">o</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-k">this</span> <span class="tok-o">==</span> <span class="tok-n">o</span><span class="tok-o">)</span> <span class="tok-k">return</span> <span class="tok-kc">true</span><span class="tok-o">;</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">o</span> <span class="tok-o">==</span> <span class="tok-kc">null</span> <span class="tok-o">||</span> <span class="tok-n">getClass</span><span class="tok-o">()</span> <span class="tok-o">!=</span> <span class="tok-n">o</span><span class="tok-o">.</span><span class="tok-na">getClass</span><span class="tok-o">())</span> <span class="tok-k">return</span> <span class="tok-kc">false</span><span class="tok-o">;</span>
        <span class="tok-n">Libro</span> <span class="tok-n">libro</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-n">Libro</span><span class="tok-o">)</span> <span class="tok-n">o</span><span class="tok-o">;</span>
        <span class="tok-k">if</span> <span class="tok-o">(!</span><span class="tok-n">isbn</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">isbn</span><span class="tok-o">))</span> <span class="tok-k">return</span> <span class="tok-kc">false</span><span class="tok-o">;</span>
        <span class="tok-k">return</span> <span class="tok-kc">true</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-kt">int</span> <span class="tok-nf">hashCode</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">isbn</span><span class="tok-o">.</span><span class="tok-na">hashCode</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">toString</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-s">&quot;Libro{&quot;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;id=&quot;</span> <span class="tok-o">+</span> <span class="tok-n">id</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, isbn=&#39;&quot;</span> <span class="tok-o">+</span> <span class="tok-n">isbn</span> <span class="tok-o">+</span> <span class="tok-sc">&#39;\&#39;&#39;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, autor=&#39;&quot;</span> <span class="tok-o">+</span> <span class="tok-n">autor</span> <span class="tok-o">+</span> <span class="tok-sc">&#39;\&#39;&#39;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, titulo=&#39;&quot;</span> <span class="tok-o">+</span> <span class="tok-n">titulo</span> <span class="tok-o">+</span> <span class="tok-sc">&#39;\&#39;&#39;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, numPaginas=&quot;</span> <span class="tok-o">+</span> <span class="tok-n">numPaginas</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, numEjemplares=&quot;</span> <span class="tok-o">+</span> <span class="tok-n">numEjemplares</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, portadaURI=&#39;&quot;</span> <span class="tok-o">+</span> <span class="tok-n">portadaURI</span> <span class="tok-o">+</span> <span class="tok-sc">&#39;\&#39;&#39;</span> <span class="tok-o">+</span>
                <span class="tok-sc">&#39;}&#39;</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y definimos también la clase <code>Ejemplar</code>:</p>
</div>
<div class="listingblock">
<div class="title">org.expertojava.jbibrest.modelo.Ejemplar</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">modelo</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.apache.commons.logging.Log</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.apache.commons.logging.LogFactory</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">java.util.Date</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.logging.Logger</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Ejemplar</span> <span class="tok-kd">extends</span> <span class="tok-n">ClaseDominio</span> <span class="tok-o">{</span>
    <span class="tok-kd">private</span> <span class="tok-n">Long</span> <span class="tok-n">id</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-n">Libro</span> <span class="tok-n">libro</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">codigoEjemplar</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-n">Date</span> <span class="tok-n">fechaAdquisicion</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">observaciones</span><span class="tok-o">;</span>

    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">Log</span> <span class="tok-n">logger</span> <span class="tok-o">=</span> <span class="tok-n">LogFactory</span><span class="tok-o">.</span><span class="tok-na">getLog</span><span class="tok-o">(</span><span class="tok-n">Ejemplar</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>

    <span class="tok-kd">public</span> <span class="tok-nf">Ejemplar</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">codigoEjemplar</span><span class="tok-o">,</span> <span class="tok-n">Libro</span> <span class="tok-n">libro</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">codigoEjemplar</span> <span class="tok-o">=</span> <span class="tok-n">codigoEjemplar</span><span class="tok-o">;</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">libro</span> <span class="tok-o">=</span> <span class="tok-n">libro</span><span class="tok-o">;</span>
        <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-na">debug</span><span class="tok-o">(</span><span class="tok-s">&quot;Nueva instancia de Ejemplar: &quot;</span> <span class="tok-o">+</span> <span class="tok-n">codigoEjemplar</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">Long</span> <span class="tok-nf">getId</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">id</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">Libro</span> <span class="tok-nf">getLibro</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">libro</span><span class="tok-o">;</span> <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">Date</span> <span class="tok-nf">getFechaAdquisicion</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">fechaAdquisicion</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setFechaAdquisicion</span><span class="tok-o">(</span><span class="tok-n">Date</span> <span class="tok-n">fechaAdquisicion</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">fechaAdquisicion</span> <span class="tok-o">=</span> <span class="tok-n">fechaAdquisicion</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getObservaciones</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">observaciones</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setObservaciones</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">observaciones</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">observaciones</span> <span class="tok-o">=</span> <span class="tok-n">observaciones</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-c1">// Dos ejemplares son iguales cuando tienen el mismo código</span>
    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-kt">boolean</span> <span class="tok-nf">equals</span><span class="tok-o">(</span><span class="tok-n">Object</span> <span class="tok-n">o</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-k">this</span> <span class="tok-o">==</span> <span class="tok-n">o</span><span class="tok-o">)</span> <span class="tok-k">return</span> <span class="tok-kc">true</span><span class="tok-o">;</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">o</span> <span class="tok-o">==</span> <span class="tok-kc">null</span> <span class="tok-o">||</span> <span class="tok-n">getClass</span><span class="tok-o">()</span> <span class="tok-o">!=</span> <span class="tok-n">o</span><span class="tok-o">.</span><span class="tok-na">getClass</span><span class="tok-o">())</span> <span class="tok-k">return</span> <span class="tok-kc">false</span><span class="tok-o">;</span>
        <span class="tok-n">Ejemplar</span> <span class="tok-n">ejemplar</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-n">Ejemplar</span><span class="tok-o">)</span> <span class="tok-n">o</span><span class="tok-o">;</span>
        <span class="tok-k">if</span> <span class="tok-o">(!</span><span class="tok-n">codigoEjemplar</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">ejemplar</span><span class="tok-o">.</span><span class="tok-na">codigoEjemplar</span><span class="tok-o">))</span> <span class="tok-k">return</span> <span class="tok-kc">false</span><span class="tok-o">;</span>
        <span class="tok-k">return</span> <span class="tok-kc">true</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-kt">int</span> <span class="tok-nf">hashCode</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">codigoEjemplar</span><span class="tok-o">.</span><span class="tok-na">hashCode</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Todos los métodos se pueden generar usando el asistente de IntelliJ, con la opción <em>Generate&#8230;&#8203;</em>.</p>
</div>
<div class="sect4">
<h5 id="_claves_naturales_y_claves_primarias_autogeneradas">Claves naturales y claves primarias autogeneradas</h5>
<div class="paragraph">
<p>Es interesante hacer notar la forma en que están implementados los métodos <code>hashCode</code> y <code>equals</code>. Son métodos muy importantes porque son los que se utilizan para buscar en las colecciones. Los podemos generar con IntelliJ usando la opción <em>Generate&#8230;&#8203; &gt; equals() and hashCode()</em>.</p>
</div>
<div class="paragraph">
<p>Para elegir los campos a usar en la comparación debemos tener en cuenta que el conjunto de todos ellos formen una clave única natural de los objetos de dominio, tal y como se explica en el  <a href="https://community.jboss.org/wiki/EqualsAndHashCode">esta nota</a> de jBoss e Hibernate.</p>
</div>
<div class="paragraph">
<p>La ventaja de usar claves naturales frente a las claves generadas artificialmente (claves autogeneradas) para determinar la igualdad de objetos es que habrá veces que podemos no disponer de estas últimas. Las claves autogeneradas las genera normalmente la base de datos cuando hacemos persistente el objeto. Puede darse el caso que estemos trabajando con el objeto, lo insertemos en colecciones o realicemos alguna comparación con él y que no dispongamos de la clave primaria autogenerada.</p>
</div>
<div class="paragraph">
<p>También es importante que garanticemos que los campos que utilicemos en el <code>equals</code> siempre existan y nunca sean <code>null</code>. En el caso del <code>Libro</code> sólo hace falta un único campo: el ISBN.</p>
</div>
<div class="paragraph">
<p>El constructor lo podemos generar con la opción de IntelliJ <em>Generate&#8230;&#8203; &gt; Constructor</em>. En el constructor incluiremos todos aquellos atributos obligatorios que siempre van a existir en el objeto que no van ser <code>null</code>. Cuando utilicemos las clases de dominio para definir el modelo de datos (tablas de la base de datos) veremos que estos atributos definirán campos <em>not null</em>.</p>
</div>
<div class="paragraph">
<p>La próxima sesión, cuando realizemos el mapeado al modelo relacional, a la base de datos, comentaremos cómo trabajar con el identificador único autogenerado. En cada clase hay un campo <code>id</code> de tipo <code>Long</code> en el que se guardará la clave primaria autogenerada por la base de datos. Lo utilizaremos para garantizar la identidad de cada objeto y tener más flexibilidad. Pero es importante que esta identidad será sólo para trabajar con la base de datos. Desde el punto de vista de un objeto de dominio, la identidad debe estar basada en claves naturales propias del objeto.</p>
</div>
</div>
<div class="sect4">
<h5 id="_logging">Logging</h5>
<div class="paragraph">
<p>Cuando estamos desarrollando la aplicación es cómodo poder ver sus mensajes de log en la consola, junto con los mensajes del servidor. Sería interesante modificar el fichero de configuración <code>log4j.properties</code> para que escribiera en la consola, en lugar de en un fichero auxiliar. Sin embargo, un <a href="https://issues.jboss.org/browse/WFLY-2012">bug de WildFly</a> hace que no se muestren los logs si definimos como <em>appender</em> <code>org.apache.log4j.ConsoleAppender</code>.</p>
</div>
<div class="paragraph">
<p>Una forma de solucionarlo es eliminando los ficheros de configuración de logs en la aplicación web. Asegúrate de borrar los ficheros <code>common-logging.properties</code> y <code>log4j.properties</code>.</p>
</div>
<div class="paragraph">
<p>Donde sí podemos añadir los ficheros de configuración de logs es en el directorio de test, en concreto en <code>test/resources</code>. Los ponemos inicialmente en el nivel DEBUG:</p>
</div>
<div class="listingblock">
<div class="title">commons-loggin.properties</div>
<div class="content">
<pre class="pygments highlight"><code>org.apache.commons.logging.Log=org.apache.commons.logging.impl.Log4JLogger</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">log4j.properties</div>
<div class="content">
<pre class="pygments highlight"><code># Coloca el nivel root del logger en DEBUG (muestra mensajes de DEBUG hacia arriba)
# Añade appender A1
log4j.rootLogger=DEBUG, A1

# A1 se redirige a la consola
log4j.appender.A1=org.apache.log4j.ConsoleAppender
log4j.appender.A1.Threshold=DEBUG

#log4j.appender.A1.File=/home/expertojava/errores.log

log4j.appender.A1.layout=org.apache.log4j.PatternLayout
log4j.appender.A1.layout.ConversionPattern=[%d{dd/MM/yyyy HH:mm:ss}] - \
  %p - %m %n</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_primeros_tests">Primeros tests</h5>
<div class="paragraph">
<p>Definimos los dos primeros test de la clase <code>org.expertojava.jbibrest.model.LibroTest</code> en el directorio <code>src/test/java</code>, con los que probamos el funcionamiento correcto de la igualdad en la clase <code>Libro</code> y la búsqueda en un <code>HashSet</code> de libros:</p>
</div>
<div class="listingblock">
<div class="title">org.expertojava.jbibrest.model</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">import</span> <span class="tok-nn">org.junit.Test</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">java.util.HashSet</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">junit</span><span class="tok-o">.</span><span class="tok-na">Assert</span><span class="tok-o">.*;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">LibroTest</span> <span class="tok-o">{</span>

    <span class="tok-cm">/* Comprobación de la búsqueda de un ejemplar en la lista</span>
<span class="tok-cm">     * de ejemplares de un libro</span>
<span class="tok-cm">     */</span>
    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">testEquals</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">Libro</span> <span class="tok-n">libro1</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Libro</span><span class="tok-o">(</span><span class="tok-s">&quot;123456789&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">Libro</span> <span class="tok-n">libro2</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Libro</span><span class="tok-o">(</span><span class="tok-s">&quot;123456789&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">libro1</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">libro2</span><span class="tok-o">));</span>

        <span class="tok-c1">// Cambiando el ISBN de uno de ellos ya no son iguales</span>
        <span class="tok-n">libro2</span><span class="tok-o">.</span><span class="tok-na">setIsbn</span><span class="tok-o">(</span><span class="tok-s">&quot;987654321&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">assertFalse</span><span class="tok-o">(</span><span class="tok-n">libro1</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">libro2</span><span class="tok-o">));</span>
    <span class="tok-o">}</span>

    <span class="tok-cm">/* Comprobación de la búsqueda de un ejemplar en la lista</span>
<span class="tok-cm">     * de ejemplares de un libro</span>
<span class="tok-cm">     */</span>
    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">contieneEjemplarDespuesDeAñadirlo</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">Libro</span> <span class="tok-n">libro</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Libro</span><span class="tok-o">(</span><span class="tok-s">&quot;123456789&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">HashSet</span><span class="tok-o">&lt;</span><span class="tok-n">Ejemplar</span><span class="tok-o">&gt;</span> <span class="tok-n">ejemplares</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">HashSet</span><span class="tok-o">&lt;</span><span class="tok-n">Ejemplar</span><span class="tok-o">&gt;();</span>
        <span class="tok-n">ejemplares</span><span class="tok-o">.</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">Ejemplar</span><span class="tok-o">(</span><span class="tok-s">&quot;0000001&quot;</span><span class="tok-o">,</span> <span class="tok-n">libro</span><span class="tok-o">));</span>
        <span class="tok-n">ejemplares</span><span class="tok-o">.</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">Ejemplar</span><span class="tok-o">(</span><span class="tok-s">&quot;0000002&quot;</span><span class="tok-o">,</span> <span class="tok-n">libro</span><span class="tok-o">));</span>
        <span class="tok-n">ejemplares</span><span class="tok-o">.</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">Ejemplar</span><span class="tok-o">(</span><span class="tok-s">&quot;0000003&quot;</span><span class="tok-o">,</span> <span class="tok-n">libro</span><span class="tok-o">));</span>
        <span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">setEjemplares</span><span class="tok-o">(</span><span class="tok-n">ejemplares</span><span class="tok-o">);</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">getEjemplares</span><span class="tok-o">().</span><span class="tok-na">contains</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">Ejemplar</span>
                <span class="tok-o">(</span><span class="tok-s">&quot;0000002&quot;</span><span class="tok-o">,</span> <span class="tok-n">libro</span><span class="tok-o">)));</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ejecutamos el test con el botón derecho sobre la clase o el paquete y <em>Run tests</em>. También los podemos lanzar usando el <em>goal</em> correspondiente de Maven.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_jerarquía_de_clases_code_usuario_code_code_alumno_code_code_profesor_code">2.5.2. Jerarquía de clases <code>Usuario</code>, <code>Alumno</code>, <code>Profesor</code></h4>
<div class="paragraph">
<p>Vamos a implementar una versión inicial de la jerarquía de clases usuario, definiendo un esqueleto de clases que ampliaremos más adelante.</p>
</div>
<div class="paragraph">
<p>En primer lugar la clase padre abstracta <code>Usuario</code> que hereda de <code>ClaseDominio</code> y que define los atributos comunes <code>login</code> y <code>password</code>. Los métodos <code>equals</code> y <code>hashCode</code> de todas las subclases se basan en estos atributos, porque definen unas claves naturales para estas clases. Definimos entonces esos métodos en la clase padre <code>Usuario</code>. Y escogemos como <em>clave natural</em> el login del usuario, de forma que dos usuarios serán iguales cuando tengan el mismo login.</p>
</div>
<div class="listingblock">
<div class="title">org.expertojava.jbibrest.modelo.Usuario</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">modelo</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">abstract</span> <span class="tok-kd">class</span> <span class="tok-nc">Usuario</span> <span class="tok-kd">extends</span> <span class="tok-n">ClaseDominio</span> <span class="tok-o">{</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">login</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">password</span><span class="tok-o">;</span>

    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getLogin</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">login</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setLogin</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">login</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">login</span> <span class="tok-o">=</span> <span class="tok-n">login</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getPassword</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">password</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setPassword</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">password</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">password</span> <span class="tok-o">=</span> <span class="tok-n">password</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-kt">boolean</span> <span class="tok-nf">equals</span><span class="tok-o">(</span><span class="tok-n">Object</span> <span class="tok-n">o</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-k">this</span> <span class="tok-o">==</span> <span class="tok-n">o</span><span class="tok-o">)</span> <span class="tok-k">return</span> <span class="tok-kc">true</span><span class="tok-o">;</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">o</span> <span class="tok-o">==</span> <span class="tok-kc">null</span> <span class="tok-o">||</span> <span class="tok-n">getClass</span><span class="tok-o">()</span> <span class="tok-o">!=</span> <span class="tok-n">o</span><span class="tok-o">.</span><span class="tok-na">getClass</span><span class="tok-o">())</span> <span class="tok-k">return</span> <span class="tok-kc">false</span><span class="tok-o">;</span>
        <span class="tok-n">Usuario</span> <span class="tok-n">usuario</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-n">Usuario</span><span class="tok-o">)</span> <span class="tok-n">o</span><span class="tok-o">;</span>
        <span class="tok-k">if</span> <span class="tok-o">(!</span><span class="tok-n">login</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">usuario</span><span class="tok-o">.</span><span class="tok-na">login</span><span class="tok-o">))</span> <span class="tok-k">return</span> <span class="tok-kc">false</span><span class="tok-o">;</span>
        <span class="tok-k">return</span> <span class="tok-kc">true</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-kt">int</span> <span class="tok-nf">hashCode</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">login</span><span class="tok-o">.</span><span class="tok-na">hashCode</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Definimos las clases hijas, junto con su constructores:</p>
</div>
<div class="listingblock">
<div class="title">org.expertojava.jbibrest.modelo.Profesor</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">modelo</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.apache.commons.logging.Log</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.apache.commons.logging.LogFactory</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Profesor</span> <span class="tok-kd">extends</span> <span class="tok-n">Usuario</span> <span class="tok-o">{</span>

    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">Log</span> <span class="tok-n">logger</span> <span class="tok-o">=</span> <span class="tok-n">LogFactory</span><span class="tok-o">.</span><span class="tok-na">getLog</span><span class="tok-o">(</span><span class="tok-n">Profesor</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>

    <span class="tok-kd">public</span> <span class="tok-nf">Profesor</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">login</span><span class="tok-o">,</span> <span class="tok-n">String</span> <span class="tok-n">password</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">setLogin</span><span class="tok-o">(</span><span class="tok-n">login</span><span class="tok-o">);</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">setPassword</span><span class="tok-o">(</span><span class="tok-n">password</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">org.expertojava.jbibrest.modelo.Alumno</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">modelo</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.apache.commons.logging.Log</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.apache.commons.logging.LogFactory</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Alumno</span> <span class="tok-kd">extends</span> <span class="tok-n">Usuario</span> <span class="tok-o">{</span>

    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">Log</span> <span class="tok-n">logger</span> <span class="tok-o">=</span> <span class="tok-n">LogFactory</span><span class="tok-o">.</span><span class="tok-na">getLog</span><span class="tok-o">(</span><span class="tok-n">Alumno</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>

    <span class="tok-kd">public</span> <span class="tok-nf">Alumno</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">login</span><span class="tok-o">,</span> <span class="tok-n">String</span> <span class="tok-n">password</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">setLogin</span><span class="tok-o">(</span><span class="tok-n">login</span><span class="tok-o">);</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">setPassword</span><span class="tok-o">(</span><span class="tok-n">password</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_gestión_de_excepciones">2.5.3. Gestión de excepciones</h4>
<div class="paragraph">
<p>Es conveniente definir una clase de excepciones para encapsular en ellas todos los errores generados en la aplicación. Vamos a definir una excepción genérica de tipo <em>unchecked</em> (<code>BibliotecaException</code>), que será la excepción padre de todas las excepciones de aplicación de la biblioteca.</p>
</div>
<div class="paragraph">
<p>En principio la definimos <em>unchecked</em> porque todos los errores que vamos a capturar tienen que ver con el mal uso del API. En general, un método debe realizar su funcionalidad y terminar correctamente cuando todo ha funcionado bien. Se lanzará una excepción si algo falla. Por ejemplo, cuando definamos un método <code>prestar(libro,usuario)</code> lanzaremos excepciones cuando no se cumplan las condiciones que hacen que el libro pueda ser prestado al usuario. Al lanzar excepciones no chequeadas permitimos que el programador chequee las condiciones antes de llamar al método y no tenga que obligatoriamente capturar una excepción que sabemos que no se va a producir. Si es necesario más adelante añadiremos una excepción <em>checked</em>.</p>
</div>
<div class="paragraph">
<p>Definimos las excepciones en el paquete <code>org.expertojava.jbibrest.utils</code>.</p>
</div>
<div class="listingblock">
<div class="title">org.expertojava.jbibrest.utils.BibliotecaException</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">utils</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">BibliotecaException</span> <span class="tok-kd">extends</span> <span class="tok-n">RuntimeException</span> <span class="tok-o">{</span>
    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-kd">final</span> <span class="tok-kt">long</span> <span class="tok-n">serialVersionUID</span> <span class="tok-o">=</span> <span class="tok-mi">1L</span><span class="tok-o">;</span>

    <span class="tok-kd">public</span> <span class="tok-nf">BibliotecaException</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-kd">super</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-nf">BibliotecaException</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">message</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-kd">super</span><span class="tok-o">(</span><span class="tok-n">message</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-nf">BibliotecaException</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">message</span><span class="tok-o">,</span> <span class="tok-n">Throwable</span> <span class="tok-n">cause</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-kd">super</span><span class="tok-o">(</span><span class="tok-n">message</span><span class="tok-o">,</span> <span class="tok-n">cause</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos observar como, al sobrecargar el constructor con los parámetros <code>{String, Throwable}</code>, nuestra excepción permitirá su uso como <em>Nested Exception</em>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_reglas_de_negocio">2.5.4. Reglas de negocio</h4>
<div class="paragraph">
<p>Es común agrupar las reglas de negocio de una aplicación en una o más clases (dependiendo de los diferentes subsistemas de la aplicación), para evitar que estén dispersas por la aplicación y acopladas a un gran número de clases.</p>
</div>
<div class="paragraph">
<p>En nuestro caso, vamos a crear un <em>Singleton</em>, al que llamaremos <code>BibliotecaBR</code> (BR = <em>Business Rules</em>). En principio, los valores estarán escritos directamente sobre la clase, pero en un futuro podríamos querer leer los valores de las reglas de negocio de un fichero de configuración).</p>
</div>
<div class="paragraph">
<p>El código inicial de nuestras reglas de negocio será el siguiente:</p>
</div>
<div class="listingblock">
<div class="title">org.expertojava.jbibrest.utils.BibliotecaBR</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">utils</span><span class="tok-o">;</span>


<span class="tok-kn">import</span> <span class="tok-nn">org.apache.commons.logging.Log</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.apache.commons.logging.LogFactory</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.modelo.Alumno</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.modelo.Profesor</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.modelo.Usuario</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">BibliotecaBR</span> <span class="tok-o">{</span>
    <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">numDiasPrestamoAlumno</span> <span class="tok-o">=</span> <span class="tok-mi">7</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">numDiasPrestamoProfesor</span> <span class="tok-o">=</span> <span class="tok-mi">30</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">cupoOperacionesAlumno</span> <span class="tok-o">=</span> <span class="tok-mi">5</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">cupoOperacionesProfesor</span> <span class="tok-o">=</span> <span class="tok-mi">8</span><span class="tok-o">;</span>

    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">Log</span> <span class="tok-n">logger</span> <span class="tok-o">=</span> <span class="tok-n">LogFactory</span><span class="tok-o">.</span><span class="tok-na">getLog</span><span class="tok-o">(</span><span class="tok-n">BibliotecaBR</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>

    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">BibliotecaBR</span> <span class="tok-n">me</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">BibliotecaBR</span><span class="tok-o">();</span>

    <span class="tok-kd">private</span> <span class="tok-nf">BibliotecaBR</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-na">debug</span><span class="tok-o">(</span><span class="tok-s">&quot;Creada instancia de &quot;</span> <span class="tok-o">+</span> <span class="tok-n">BibliotecaBR</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-n">BibliotecaBR</span> <span class="tok-nf">getInstance</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">me</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">int</span> <span class="tok-nf">calculaNumDiasPrestamo</span><span class="tok-o">(</span><span class="tok-n">Usuario</span> <span class="tok-n">usuario</span><span class="tok-o">)</span>
            <span class="tok-kd">throws</span> <span class="tok-n">BibliotecaException</span> <span class="tok-o">{</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">usuario</span> <span class="tok-k">instanceof</span> <span class="tok-n">Alumno</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-k">return</span> <span class="tok-n">numDiasPrestamoAlumno</span><span class="tok-o">;</span>
        <span class="tok-o">}</span> <span class="tok-k">else</span> <span class="tok-nf">if</span> <span class="tok-o">(</span><span class="tok-n">usuario</span> <span class="tok-k">instanceof</span> <span class="tok-n">Profesor</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-k">return</span> <span class="tok-n">numDiasPrestamoProfesor</span><span class="tok-o">;</span>
        <span class="tok-o">}</span> <span class="tok-k">else</span> <span class="tok-o">{</span>
            <span class="tok-n">String</span> <span class="tok-n">msg</span> <span class="tok-o">=</span> <span class="tok-s">&quot;Solo los alumnos y profesores pueden tener &quot;</span> <span class="tok-o">+</span>
                    <span class="tok-s">&quot;libros prestados&quot;</span><span class="tok-o">;</span>
            <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-na">error</span><span class="tok-o">(</span><span class="tok-n">msg</span><span class="tok-o">);</span>
            <span class="tok-k">throw</span> <span class="tok-k">new</span> <span class="tok-nf">BibliotecaException</span><span class="tok-o">(</span><span class="tok-n">msg</span><span class="tok-o">);</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">compruebaNumDiasPrestamo</span><span class="tok-o">(</span><span class="tok-n">Usuario</span> <span class="tok-n">usuario</span><span class="tok-o">,</span> <span class="tok-kt">int</span> <span class="tok-n">numDias</span><span class="tok-o">)</span>
            <span class="tok-kd">throws</span> <span class="tok-n">BibliotecaException</span> <span class="tok-o">{</span>
        <span class="tok-n">String</span> <span class="tok-n">msg</span><span class="tok-o">;</span>
        <span class="tok-k">if</span> <span class="tok-o">(!(</span><span class="tok-n">usuario</span> <span class="tok-k">instanceof</span> <span class="tok-n">Alumno</span><span class="tok-o">)</span>
                <span class="tok-o">&amp;&amp;</span> <span class="tok-o">!(</span><span class="tok-n">usuario</span> <span class="tok-k">instanceof</span> <span class="tok-n">Profesor</span><span class="tok-o">))</span> <span class="tok-o">{</span>
            <span class="tok-n">msg</span> <span class="tok-o">=</span> <span class="tok-s">&quot;Solo los alumnos y profesores pueden tener libros &quot;</span> <span class="tok-o">+</span>
                    <span class="tok-s">&quot;prestados&quot;</span><span class="tok-o">;</span>
            <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-na">error</span><span class="tok-o">(</span><span class="tok-n">msg</span><span class="tok-o">);</span>
            <span class="tok-k">throw</span> <span class="tok-k">new</span> <span class="tok-nf">BibliotecaException</span><span class="tok-o">(</span><span class="tok-n">msg</span><span class="tok-o">);</span>
        <span class="tok-o">}</span>
        <span class="tok-k">if</span> <span class="tok-o">((</span><span class="tok-n">usuario</span> <span class="tok-k">instanceof</span> <span class="tok-n">Alumno</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-n">numDias</span> <span class="tok-o">&gt;</span>
                <span class="tok-n">numDiasPrestamoAlumno</span><span class="tok-o">)</span> <span class="tok-o">||</span>
                <span class="tok-o">(</span><span class="tok-n">usuario</span> <span class="tok-k">instanceof</span> <span class="tok-n">Profesor</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-n">numDias</span> <span class="tok-o">&gt;</span>
                <span class="tok-n">numDiasPrestamoProfesor</span><span class="tok-o">))</span> <span class="tok-o">{</span>
            <span class="tok-n">msg</span> <span class="tok-o">=</span> <span class="tok-s">&quot;Devolución fuera de plazo&quot;</span><span class="tok-o">;</span>
            <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-na">error</span><span class="tok-o">(</span><span class="tok-n">msg</span><span class="tok-o">);</span>
            <span class="tok-k">throw</span> <span class="tok-k">new</span> <span class="tok-nf">BibliotecaException</span><span class="tok-o">(</span><span class="tok-n">msg</span><span class="tok-o">);</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">int</span> <span class="tok-nf">cupoOperaciones</span><span class="tok-o">(</span><span class="tok-n">Usuario</span> <span class="tok-n">usuario</span><span class="tok-o">)</span>
            <span class="tok-kd">throws</span> <span class="tok-n">BibliotecaException</span> <span class="tok-o">{</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">usuario</span> <span class="tok-k">instanceof</span> <span class="tok-n">Alumno</span><span class="tok-o">)</span>
            <span class="tok-k">return</span> <span class="tok-n">cupoOperacionesAlumno</span><span class="tok-o">;</span>
        <span class="tok-k">else</span> <span class="tok-nf">if</span> <span class="tok-o">(</span><span class="tok-n">usuario</span> <span class="tok-k">instanceof</span> <span class="tok-n">Profesor</span><span class="tok-o">)</span>
            <span class="tok-k">return</span> <span class="tok-n">cupoOperacionesProfesor</span><span class="tok-o">;</span>
        <span class="tok-k">else</span> <span class="tok-o">{</span>
            <span class="tok-n">String</span> <span class="tok-n">msg</span> <span class="tok-o">=</span> <span class="tok-s">&quot;Solo los alumnos y profesores pueden tener libros prestados&quot;</span><span class="tok-o">;</span>
            <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-na">error</span><span class="tok-o">(</span><span class="tok-n">msg</span><span class="tok-o">);</span>
            <span class="tok-k">throw</span> <span class="tok-k">new</span> <span class="tok-nf">BibliotecaException</span><span class="tok-o">(</span><span class="tok-n">msg</span><span class="tok-o">);</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">compruebaCupoOperaciones</span><span class="tok-o">(</span><span class="tok-n">Usuario</span> <span class="tok-n">usuario</span><span class="tok-o">,</span> <span class="tok-kt">int</span> <span class="tok-n">numOp</span><span class="tok-o">)</span>
            <span class="tok-kd">throws</span> <span class="tok-n">BibliotecaException</span> <span class="tok-o">{</span>
        <span class="tok-n">String</span> <span class="tok-n">msg</span><span class="tok-o">;</span>
        <span class="tok-k">if</span> <span class="tok-o">(!(</span><span class="tok-n">usuario</span> <span class="tok-k">instanceof</span> <span class="tok-n">Alumno</span><span class="tok-o">)</span>
                <span class="tok-o">&amp;&amp;</span> <span class="tok-o">!(</span><span class="tok-n">usuario</span> <span class="tok-k">instanceof</span> <span class="tok-n">Profesor</span><span class="tok-o">))</span> <span class="tok-o">{</span>
            <span class="tok-n">msg</span> <span class="tok-o">=</span> <span class="tok-s">&quot;Solo los alumnos y profesores pueden tener libros prestados&quot;</span><span class="tok-o">;</span>
            <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-na">error</span><span class="tok-o">(</span><span class="tok-n">msg</span><span class="tok-o">);</span>
            <span class="tok-k">throw</span> <span class="tok-k">new</span> <span class="tok-nf">BibliotecaException</span><span class="tok-o">(</span><span class="tok-n">msg</span><span class="tok-o">);</span>
        <span class="tok-o">}</span>
        <span class="tok-k">if</span> <span class="tok-o">((</span><span class="tok-n">usuario</span> <span class="tok-k">instanceof</span> <span class="tok-n">Alumno</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-n">numOp</span> <span class="tok-o">&gt;</span>
                <span class="tok-n">cupoOperacionesAlumno</span><span class="tok-o">)</span> <span class="tok-o">||</span>
                <span class="tok-o">(</span><span class="tok-n">usuario</span> <span class="tok-k">instanceof</span> <span class="tok-n">Profesor</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-n">numOp</span> <span class="tok-o">&gt;</span> <span class="tok-n">cupoOperacionesProfesor</span><span class="tok-o">))</span> <span class="tok-o">{</span>
            <span class="tok-n">msg</span> <span class="tok-o">=</span> <span class="tok-s">&quot;El cupo de operaciones posibles esta lleno&quot;</span><span class="tok-o">;</span>
            <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-na">error</span><span class="tok-o">(</span><span class="tok-n">msg</span><span class="tok-o">);</span>
            <span class="tok-k">throw</span> <span class="tok-k">new</span> <span class="tok-nf">BibliotecaException</span><span class="tok-o">(</span><span class="tok-n">msg</span><span class="tok-o">);</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_ampliamos_los_tests">Ampliamos los tests</h5>
<div class="paragraph">
<p>Añadimos inicialmente algunos tests que comprueban el funcionamiento de algunas reglas de negocios.</p>
</div>
<div class="listingblock">
<div class="title">/tests/java/org.expertojava.jbibrest.modelo.BibliotecaBRTest</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">modelo</span><span class="tok-o">;</span>


<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.utils.BibliotecaBR</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.utils.BibliotecaException</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.junit.Test</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">junit</span><span class="tok-o">.</span><span class="tok-na">Assert</span><span class="tok-o">.</span><span class="tok-na">assertEquals</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">junit</span><span class="tok-o">.</span><span class="tok-na">Assert</span><span class="tok-o">.</span><span class="tok-na">fail</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">BibliotecaBRTest</span> <span class="tok-o">{</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">testCalculaNumDiasPrestamoProfesor</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-kt">int</span> <span class="tok-n">diasProfesor</span> <span class="tok-o">=</span> <span class="tok-n">BibliotecaBR</span><span class="tok-o">.</span><span class="tok-na">getInstance</span><span class="tok-o">()</span>
                <span class="tok-o">.</span><span class="tok-na">calculaNumDiasPrestamo</span><span class="tok-o">(</span>
                        <span class="tok-k">new</span> <span class="tok-nf">Profesor</span><span class="tok-o">(</span><span class="tok-s">&quot;severus.snape&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;1234&quot;</span><span class="tok-o">));</span>
        <span class="tok-n">assertEquals</span><span class="tok-o">(</span><span class="tok-mi">30</span><span class="tok-o">,</span> <span class="tok-n">diasProfesor</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">testCompruebaCupoOperacionesProfesorCorrecto</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">try</span> <span class="tok-o">{</span>
            <span class="tok-n">Profesor</span> <span class="tok-n">profesor</span> <span class="tok-o">=</span>
                    <span class="tok-k">new</span> <span class="tok-nf">Profesor</span><span class="tok-o">(</span><span class="tok-s">&quot;severus.snape&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;1234&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">BibliotecaBR</span><span class="tok-o">.</span><span class="tok-na">getInstance</span><span class="tok-o">()</span>
                    <span class="tok-o">.</span><span class="tok-na">compruebaCupoOperaciones</span><span class="tok-o">(</span><span class="tok-n">profesor</span><span class="tok-o">,</span> <span class="tok-mi">8</span><span class="tok-o">);</span>
            <span class="tok-n">BibliotecaBR</span><span class="tok-o">.</span><span class="tok-na">getInstance</span><span class="tok-o">()</span>
                    <span class="tok-o">.</span><span class="tok-na">compruebaCupoOperaciones</span><span class="tok-o">(</span><span class="tok-n">profesor</span><span class="tok-o">,</span> <span class="tok-mi">1</span><span class="tok-o">);</span>
        <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">BibliotecaException</span> <span class="tok-n">e</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">fail</span><span class="tok-o">(</span><span class="tok-s">&quot;No debería fallar - el cupo de operaciones del&quot;</span> <span class="tok-o">+</span>
                    <span class="tok-s">&quot; PROFESOR es correcto&quot;</span><span class="tok-o">);</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span><span class="tok-o">(</span><span class="tok-n">expected</span> <span class="tok-o">=</span> <span class="tok-n">BibliotecaException</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">)</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">testCompruebaCupoOperacionesProfesorIncorrecto</span><span class="tok-o">()</span>
            <span class="tok-kd">throws</span> <span class="tok-n">BibliotecaException</span> <span class="tok-o">{</span>
        <span class="tok-n">BibliotecaBR</span><span class="tok-o">.</span><span class="tok-na">getInstance</span><span class="tok-o">()</span>
                <span class="tok-o">.</span><span class="tok-na">compruebaCupoOperaciones</span><span class="tok-o">(</span>
                        <span class="tok-k">new</span> <span class="tok-nf">Profesor</span><span class="tok-o">(</span><span class="tok-s">&quot;severus.snape&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;1234&quot;</span><span class="tok-o">),</span> <span class="tok-mi">9</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_página_web_de_prueba">2.5.5. Página web de prueba</h4>
<div class="paragraph">
<p>Como último paso de esta parte guiada del proyecto vamos a cambiar la página frontal para probar la aplicación se despliega correctamente. Modificamos la página <code>index.jsp</code> para recoger una cadena de texto que simula un ISBN de un libro</p>
</div>
<div class="listingblock">
<div class="title">webapp/index.jsp</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-cp">&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.0 Transitional//EN&quot;&gt;</span>
<span class="tok-nt">&lt;html&gt;</span>
    <span class="tok-nt">&lt;head&gt;</span>
        <span class="tok-nt">&lt;title&gt;</span>Start Page<span class="tok-nt">&lt;/title&gt;</span>
        <span class="tok-nt">&lt;meta</span> <span class="tok-na">http-equiv=</span><span class="tok-s">&quot;Content-Type&quot;</span> <span class="tok-na">content=</span><span class="tok-s">&quot;text/html; charset=UTF-8&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;/head&gt;</span>
    <span class="tok-nt">&lt;body&gt;</span>
        <span class="tok-nt">&lt;h1&gt;</span>Hello World!<span class="tok-nt">&lt;/h1&gt;</span>
        <span class="tok-nt">&lt;form</span> <span class="tok-na">action=</span><span class="tok-s">&quot;&lt;%=request.getContextPath()%&gt;/holamundo&quot;</span><span class="tok-nt">&gt;</span>
        <span class="tok-nt">&lt;p&gt;</span>ISBN: <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;isbn&quot;</span><span class="tok-nt">&gt;&lt;/p&gt;</span>
        <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;submit&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;Enviar&quot;</span><span class="tok-nt">&gt;</span>
        <span class="tok-nt">&lt;/form&gt;</span>
    <span class="tok-nt">&lt;/body&gt;</span>
<span class="tok-nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y cambiamos también el servlet <code>holamundo</code> para que haga una acción muy sencilla como crear un libro y mostrarlo:</p>
</div>
<div class="listingblock">
<div class="title">org.expertojava.jbibrest.HolaMundo</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-c1">// imports</span>

<span class="tok-nd">@WebServlet</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;holamundo&quot;</span><span class="tok-o">,</span> <span class="tok-n">urlPatterns</span><span class="tok-o">=</span><span class="tok-s">&quot;/holamundo&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">HolaMundo</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span> <span class="tok-o">{</span>


    <span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">doPost</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                          <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>  <span class="tok-kd">throws</span>
            <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>

    <span class="tok-o">}</span>

    <span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                         <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span> <span class="tok-kd">throws</span>
    <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
        <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setContentType</span><span class="tok-o">(</span><span class="tok-s">&quot;text/html&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">String</span> <span class="tok-n">isbnStr</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;isbn&quot;</span><span class="tok-o">);</span>

        <span class="tok-c1">// Comprobamos entradas no nulas</span>

        <span class="tok-kt">int</span> <span class="tok-n">errorStatus</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-o">;</span>
        <span class="tok-n">String</span> <span class="tok-n">errorMsg</span> <span class="tok-o">=</span> <span class="tok-s">&quot;&quot;</span><span class="tok-o">;</span>


        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">isbnStr</span> <span class="tok-o">==</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">errorStatus</span> <span class="tok-o">=</span> <span class="tok-n">HttpServletResponse</span><span class="tok-o">.</span><span class="tok-na">SC_BAD_REQUEST</span><span class="tok-o">;</span>
            <span class="tok-n">errorMsg</span> <span class="tok-o">=</span> <span class="tok-s">&quot;Faltan parámetros en la petición&quot;</span><span class="tok-o">;</span>
        <span class="tok-o">}</span>

        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">errorStatus</span> <span class="tok-o">==</span> <span class="tok-mi">0</span><span class="tok-o">)</span> <span class="tok-o">{</span>

            <span class="tok-c1">// Llamamos al modelo para construir la respuesta</span>

            <span class="tok-n">Libro</span> <span class="tok-n">libro</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Libro</span><span class="tok-o">(</span><span class="tok-n">isbnStr</span><span class="tok-o">);</span>
            <span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">setAutor</span><span class="tok-o">(</span><span class="tok-s">&quot;J. K. Rowling&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">setTitulo</span><span class="tok-o">(</span><span class="tok-s">&quot;Harry Potter y la piedra filosofal&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">setNumEjemplares</span><span class="tok-o">(</span><span class="tok-mi">7</span><span class="tok-o">);</span>

            <span class="tok-n">PrintWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;!DOCTYPE HTML PUBLIC \&quot;&quot;</span> <span class="tok-o">+</span>
                    <span class="tok-s">&quot;-//W3C//DTD HTML 4.0 &quot;</span> <span class="tok-o">+</span>
                    <span class="tok-s">&quot;Transitional//EN\&quot;&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;HTML&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;BODY&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;h1&gt;Creado un nuevo libro&lt;/h1&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;p&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">toString</span><span class="tok-o">());</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/p&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/BODY&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/HTML&quot;</span><span class="tok-o">);</span>
        <span class="tok-o">}</span>

        <span class="tok-c1">// errorStatus &gt; 0</span>
        <span class="tok-k">else</span>  <span class="tok-o">{</span>
            <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setStatus</span><span class="tok-o">(</span><span class="tok-n">errorStatus</span><span class="tok-o">);</span>
            <span class="tok-n">PrintWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">errorMsg</span><span class="tok-o">);</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Con esto terminamos la parte guiada.</p>
</div>
<div class="paragraph">
<p>Los tests estarán funcionando correctamente y la página web de prueba deberá mostrar el libro creado correctamente. Puedes borrar las clases <code>Nombre</code>, <code>Genero</code> y <code>NombreTest</code> del principio de la clase.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_desarrollo_e_implementación_parte_no_guiada_1_punto">2.6. Desarrollo e implementación (parte no guiada, 1 punto)</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Para terminar el ejercicio debes implementar el resto del modelo de dominio:</p>
<div class="ulist">
<ul>
<li>
<p>Completa las clases de la jerarquía de <code>Usuario</code> e implementa el resto de clases de domino como hemos hecho con la clase <code>Libro</code>:</p>
<div class="ulist">
<ul>
<li>
<p>Define los constructores con los atributos no nulos de las clases</p>
</li>
<li>
<p>Define los métodos <code>hashCode</code> y <code>equals</code> usando los atributos que constituyan claves naturales.</p>
</li>
<li>
<p>Las relaciones <em>X-a-muchos</em> las definimos del tipo <code>Set</code>. De esta forma nos aseguramos que no existen objetos duplicados en las relaciones. La identidad en un conjunto se define con el método <code>equals</code> de sus elementos (definido anteriormente).</p>
</li>
</ul>
</div>
</li>
<li>
<p>Define la clase <code>Direccion</code> como una clase normal (no una subclase de <code>ClaseDomino</code>)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Completa los tests de las clases y de <code>BibliotecaBR</code>.</p>
<div class="paragraph">
<p>En los tests de las clases de dominio debemos comprobar las relaciones de igualdad y errores de inicialización. Por ejemplo, a continuación puedes ver el test de la clase <code>Prestamo</code>:</p>
</div>
<div class="listingblock">
<div class="title">/src/test/java/org.expertojava.jbibrest.modelo.PrestamoTest</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">modelo</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.utils.BibliotecaException</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.junit.Before</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.junit.BeforeClass</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.junit.Test</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">java.util.Calendar</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.Date</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">junit</span><span class="tok-o">.</span><span class="tok-na">Assert</span><span class="tok-o">.*;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">PrestamoTest</span> <span class="tok-o">{</span>
    <span class="tok-kd">static</span> <span class="tok-n">Libro</span> <span class="tok-n">libro1</span><span class="tok-o">;</span>
    <span class="tok-kd">static</span> <span class="tok-n">Ejemplar</span> <span class="tok-n">ejemplar1</span><span class="tok-o">,</span> <span class="tok-n">ejemplar2</span><span class="tok-o">;</span>
    <span class="tok-kd">static</span> <span class="tok-n">Usuario</span> <span class="tok-n">usuario1</span><span class="tok-o">,</span> <span class="tok-n">usuario2</span><span class="tok-o">;</span>
    <span class="tok-kd">static</span> <span class="tok-n">Date</span> <span class="tok-n">fecha1</span><span class="tok-o">,</span> <span class="tok-n">fecha2</span><span class="tok-o">,</span> <span class="tok-n">fecha3</span><span class="tok-o">;</span>

    <span class="tok-nd">@BeforeClass</span>
    <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-kt">void</span> <span class="tok-nf">oneTimeSetUp</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">libro1</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Libro</span><span class="tok-o">(</span><span class="tok-s">&quot;123223343434&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">ejemplar1</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Ejemplar</span><span class="tok-o">(</span><span class="tok-s">&quot;000001&quot;</span><span class="tok-o">,</span> <span class="tok-n">libro1</span><span class="tok-o">);</span>
        <span class="tok-n">ejemplar2</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Ejemplar</span><span class="tok-o">(</span><span class="tok-s">&quot;000002&quot;</span><span class="tok-o">,</span> <span class="tok-n">libro1</span><span class="tok-o">);</span>

        <span class="tok-n">usuario1</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Profesor</span><span class="tok-o">(</span><span class="tok-s">&quot;quirinus.quirrell&quot;</span><span class="tok-o">,</span><span class="tok-s">&quot;1234&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">usuario2</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Alumno</span><span class="tok-o">(</span><span class="tok-s">&quot;neville.longbottom&quot;</span><span class="tok-o">,</span><span class="tok-s">&quot;1234&quot;</span><span class="tok-o">);</span>

        <span class="tok-c1">// fecha1 = fecha actual</span>
        <span class="tok-c1">// fecha2 = fecha actual + 7 días</span>
        <span class="tok-c1">// fecha3 = fechaFin + 1 día</span>

        <span class="tok-n">fecha1</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Date</span><span class="tok-o">();</span>
        <span class="tok-n">Calendar</span> <span class="tok-n">calendar</span> <span class="tok-o">=</span> <span class="tok-n">Calendar</span><span class="tok-o">.</span><span class="tok-na">getInstance</span><span class="tok-o">();</span>
        <span class="tok-n">calendar</span><span class="tok-o">.</span><span class="tok-na">setTime</span><span class="tok-o">(</span><span class="tok-n">fecha1</span><span class="tok-o">);</span>
        <span class="tok-n">calendar</span><span class="tok-o">.</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-n">Calendar</span><span class="tok-o">.</span><span class="tok-na">DATE</span><span class="tok-o">,</span> <span class="tok-mi">7</span><span class="tok-o">);</span>
        <span class="tok-n">fecha2</span> <span class="tok-o">=</span> <span class="tok-n">calendar</span><span class="tok-o">.</span><span class="tok-na">getTime</span><span class="tok-o">();</span>
        <span class="tok-n">calendar</span><span class="tok-o">.</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-n">Calendar</span><span class="tok-o">.</span><span class="tok-na">DATE</span><span class="tok-o">,</span> <span class="tok-mi">1</span><span class="tok-o">);</span>
        <span class="tok-n">fecha3</span> <span class="tok-o">=</span> <span class="tok-n">calendar</span><span class="tok-o">.</span><span class="tok-na">getTime</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>


    <span class="tok-cm">/* Dos préstamos son iguales cuando tienen el mismo usuario,</span>
<span class="tok-cm">     * ejemplar y fecha de inicio</span>
<span class="tok-cm">     */</span>
    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">testEquals</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">Prestamo</span> <span class="tok-n">prestamo1</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Prestamo</span><span class="tok-o">(</span><span class="tok-n">usuario1</span><span class="tok-o">,</span> <span class="tok-n">ejemplar1</span><span class="tok-o">,</span> <span class="tok-n">fecha1</span><span class="tok-o">,</span>
                <span class="tok-n">fecha2</span><span class="tok-o">);</span>
        <span class="tok-n">Prestamo</span> <span class="tok-n">prestamo2</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Prestamo</span><span class="tok-o">(</span><span class="tok-n">usuario1</span><span class="tok-o">,</span> <span class="tok-n">ejemplar1</span><span class="tok-o">,</span> <span class="tok-n">fecha1</span><span class="tok-o">,</span>
                <span class="tok-n">fecha3</span><span class="tok-o">);</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">prestamo1</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">prestamo2</span><span class="tok-o">));</span>

        <span class="tok-c1">// Cambiando ejemplar al segundo ya no son iguales</span>
        <span class="tok-n">prestamo2</span><span class="tok-o">.</span><span class="tok-na">setEjemplar</span><span class="tok-o">(</span><span class="tok-n">ejemplar2</span><span class="tok-o">);</span>
        <span class="tok-n">assertFalse</span><span class="tok-o">(</span><span class="tok-n">prestamo1</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">prestamo2</span><span class="tok-o">));</span>

        <span class="tok-c1">// Cambiando el usuario al segundo tampoco son iguales</span>
        <span class="tok-n">prestamo2</span><span class="tok-o">.</span><span class="tok-na">setEjemplar</span><span class="tok-o">(</span><span class="tok-n">ejemplar1</span><span class="tok-o">);</span>
        <span class="tok-n">prestamo2</span><span class="tok-o">.</span><span class="tok-na">setUsuario</span><span class="tok-o">(</span><span class="tok-n">usuario2</span><span class="tok-o">);</span>
        <span class="tok-n">assertFalse</span><span class="tok-o">(</span><span class="tok-n">prestamo1</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">prestamo2</span><span class="tok-o">));</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span><span class="tok-o">(</span><span class="tok-n">expected</span> <span class="tok-o">=</span> <span class="tok-n">BibliotecaException</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">)</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">testExcepcionFechaInicioMayorDevolucion</span><span class="tok-o">()</span> <span class="tok-kd">throws</span>
            <span class="tok-n">BibliotecaException</span> <span class="tok-o">{</span>
        <span class="tok-k">new</span> <span class="tok-nf">Prestamo</span><span class="tok-o">(</span><span class="tok-n">usuario1</span><span class="tok-o">,</span> <span class="tok-n">ejemplar1</span><span class="tok-o">,</span> <span class="tok-n">fecha2</span><span class="tok-o">,</span> <span class="tok-n">fecha1</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para los tests de <code>BibliotecaBR</code> puedes rellenar los siguientes:</p>
</div>
<div class="listingblock">
<div class="title">BibliotecaBRTest</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">BibliotecaBRTest</span> <span class="tok-o">{</span>

      <span class="tok-nd">@Test</span>
      <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">testCalculaNumDiasPrestamoAlumno</span><span class="tok-o">()</span> <span class="tok-o">{</span>
         <span class="tok-c1">// TODO</span>
      <span class="tok-o">}</span>

      <span class="tok-nd">@Test</span>
      <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">testCupoOperacionesProfesor</span><span class="tok-o">()</span> <span class="tok-o">{</span>
         <span class="tok-c1">// TODO</span>
      <span class="tok-o">}</span>

      <span class="tok-nd">@Test</span>
      <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">testCupoOperacionesAlumno</span><span class="tok-o">()</span> <span class="tok-o">{</span>
         <span class="tok-c1">// TODO</span>
      <span class="tok-o">}</span>

      <span class="tok-nd">@Test</span>
      <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">testCompruebaCupoOperacionesAlumnoCorrecto</span><span class="tok-o">()</span> <span class="tok-o">{</span>
         <span class="tok-c1">// TODO</span>
      <span class="tok-o">}</span>

      <span class="tok-nd">@Test</span><span class="tok-o">(</span><span class="tok-n">expected</span> <span class="tok-o">=</span> <span class="tok-n">BibliotecaException</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">)</span>
      <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">testCompruebaCupoOperacionesAlumnoIncorrecto</span><span class="tok-o">()</span>
                  <span class="tok-kd">throws</span> <span class="tok-n">BibliotecaException</span> <span class="tok-o">{</span>
         <span class="tok-c1">// TODO</span>
      <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>A continuación puedes ver una imagen de cómo queda el aspecto del panel del proyecto cuando hayas terminado el ejercicio:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint01/proyecto-final.png" alt="Proyecto final" width="33%">
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion02">3. (2,5 puntos) Capa de persistencia y capa de negocio</h2>
<div class="sectionbody">
<div class="paragraph">
<p>En esta segunda sesión del proyecto web, una vez definidas las clases de modelo de la biblioteca, vamos a desarrollar la capa de persistencia de la aplicación usando JPA y clases DAO y la capa de métodos de negocio utilizando enterprise beans de sesión.</p>
</div>
<div class="paragraph">
<p>Recordemos que el objetivo de la aplicación es gestionar una biblioteca de un centro educativo y proporcionar distintas funcionalidades a los usuarios de la biblioteca y a sus bibliotecarios.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Avisamos de una modificación que hay que realizar en el proyecto resultante de la fase anterior: hay que eliminar el atributo <code>password</code> de las clases <code>Usuario</code> y <code>Bibliotecario</code>. En la sesión de despliegue en PaaS se implementará una autenticación basada en una tabla independiente de las entidades.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_api_del_servicio">3.1. API del servicio</h3>
<div class="paragraph">
<p>Es conveniente remarcar que el objetivo final del desarrollo de la parte del servidor es proporcionar todas las funcionalidades de la aplicación en forma de API RESTful.</p>
</div>
<div class="paragraph">
<p>En concreto, las funcionalidades que vamos a proporcionar son las siguientes, agrupadas por la restricción de acceso.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Debido a la complejidad de realizar tests sobre EJBs con restricciones de seguridad, definiremos las restricciones de acceso en la capa REST. De esta forma todas las funciones de la capa de negocio (EJB) se podrán testear sin realizar ninguna autenticación.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Operaciones restringidas a usuarios y bibliotecarios</strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Obtener información actual de un usuario: se pasa el <em>login del usuario</em> y se obtienen sus datos, su identificador, su estado, num. préstamos activos, multa activa, etc.</p>
</li>
<li>
<p>Obener lista de préstamos de un un usuario: se pasa el <em>identificador del usuario</em> y devuelve la colección de libros (libro y ejemplar) que tiene prestados un usuario</p>
</li>
<li>
<p>Solicitar un préstamo de un libro: se pasa el <em>identificador del usuario</em> y el <em>identificador del libro</em> y se realiza el préstamo de un ejemplar disponible si el ejemplar está disponible. Se lanza un error si no hay ejemplares disponibles, si el usuario está multado o si supera el número de préstamos permitidos. Si se ha realizado el préstamo con éxito se devuelve el nuevo préstamo.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Operación restringida a bibliotecarios</strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Realizar la devolución de un ejemplar: se pasa el <em>identificador de usuario</em> y el <em>identificador de ejemplar</em>, se cierra el préstamo y se crea una multa si la devolución está fuera de plazo. Se devuelve un enumerado con el resultado de la devolución: <code>DEVOLUCIÓN_CORRECTA</code> o <code>DEVOLUCIÓN_FUERA_DE_PLAZO</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Operaciones no restringidas</strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Listado de libros: se devuelve la lista de todos los libros</p>
</li>
<li>
<p>Búsqueda de libros por autor: se pasa una cadena de texto y se devuelve la lista de libros que tienen un autor cuyo nombre contiene esa cadena de texto</p>
</li>
<li>
<p>Búsqueda de libros por título: se pasa una cadena de texto y se devuelve la lista de libros cuyo título contiene esa cadena de texto</p>
</li>
<li>
<p>Búsqueda de libro por identificador: se pasa el <em>identificador del libro</em> y se devuelven los detalles del libro y una colección con sus ejemplares</p>
</li>
<li>
<p>Libros recomendados: se pasa el <em>identificador del libro</em> y un número <em>n</em> de recomendaciones deseadas. Se devuelve la lista de esos <em>n</em> libros que más se han prestado junto con el libro inicial.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Vamos a centrar el desarrollo de la capa de servicios y de persistencia en estas funcionalidades.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implementaremos la capa de persistencia utilizando JPA y <em>Bean Validation</em> y realizaremos las pruebas de esta capa usando DbUnit</p>
</li>
<li>
<p>Para los métodos de negocio utilizaremos enterprise beans que nos proporcionan transaccionalidad. Haremos las pruebas con Arquillian.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Vamos a realizar una primera iteración guiada en la que implementaremos algunas de las funcionalidades relacionadas con libros y ejemplares. Después deberás implementar el resto de funcionalidades.</p>
</div>
</div>
<div class="sect2">
<h3 id="_iteración_1">3.2. Iteración 1</h3>
<div class="paragraph">
<p>En esta primera iteración vamos a implementar las dos funcionalidades:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Listado de libros: se devuelve la lista de todos los libros</p>
</li>
<li>
<p>Libros recomendados: se pasa el <em>identificador del libro</em> y un número <em>n</em> de recomendaciones deseadas. Se devuelve la lista de esos <em>n</em> libros que más se han prestado junto con el libro inicial.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_capa_de_persistencia">3.2.1. Capa de persistencia</h4>
<div class="paragraph">
<p>En la capa de persistencia tenemos que convertir las clases de modelo en entidades, utilizando las anotaciones JPA y <em>bean validation</em> necesarias. Crearemos también las clases DAO que encapsulan las operaciones sobre estas entidades.</p>
</div>
<div class="sect4">
<h5 id="_creación_de_la_base_de_datos">Creación de la base de datos</h5>
<div class="paragraph">
<p>Antes de empezar a trabajar con el código debemos crear la base de datos <code>biblioteca</code> en nuestro ordenador y la fuente de datos <code>BibliotecaDS</code> en nuestro servidor WildFly en donde vamos a hacer las pruebas.</p>
</div>
<div class="paragraph">
<p>Para crear la base de datos desde IntelliJ utiliza el panel <em>Database</em> situado en el lateral derecho:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Abre el panel <em>Database</em> en la parte derecha.</p>
</li>
<li>
<p>Crea una nueva conexión con la base de datos MySQL con la opción <em>+ &gt; Data Source &gt; MySQL</em></p>
</li>
<li>
<p>Inicializa los parámetros de la conexión, sólo tienes que indicar el usuario <code>root</code> y la contraseña <code>expertojava</code>. Aparecerá también un aviso indicando que no está descargado el driver de acceso a MySQL, pincha el enlace y lo descargará e instalará.</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint02/intellij-datasources.png" alt="" width="100%">
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Una vez configurada la conexión, vamos a utilizarla para crear la base de datos <code>biblioteca</code>. En el panel de base de datos podremos ver un desplegable con las bases de datos existentes. Para crear la nueva base de datos abre la consola SQL pulsando el icono correspondiente del panel de base de datos:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint02/panel-base-datos.png" alt="" width="50%">
</div>
</div>
<div class="paragraph">
<p>Y ejecuta el comando:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-k">CREATE</span> <span class="tok-k">DATABASE</span> <span class="tok-n">biblioteca</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Verás que se ha creado una base de datos con ese nombre bajo las ya existentes por defecto en MySQL.</p>
</div>
<div class="paragraph">
<p>Otra forma de crear la base de datos es hacerlo desde línea de comando:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> <span class="tok-nb">echo</span> <span class="tok-s2">&quot;CREATE DATABASE biblioteca&quot;</span> &gt; create.sql
<span class="tok-gp">$</span> mysql -u root -p<span class="tok-s2">&quot;expertojava&quot;</span> &lt; create.sql</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_configuración_de_la_fuente_de_datos_mysql_en_wildfly">Configuración de la fuente de datos MySQL en WildFly</h5>
<div class="paragraph">
<p>Recuerda que para trabajar con JPA en una aplicación web el acceso a la base de datos hay que hacerlo a través de una <strong>fuente de datos</strong> creada y gestionada por el servidor de aplicaciones.</p>
</div>
<div class="paragraph">
<p>Vamos a ver cómo configurar una fuente de datos MySQL en WildFly. Algunos de los pasos siguientes no serán necesarios si estás trabajando con el mismo servidor de aplicaciones con el que has hecho los módulos de JPA o de Componentes EJB. Los incluimos por completitud, por si estás trabajando con un servidor recién instalado.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>En primer lugar localiza el driver MySQL <code>mysql-connector-java-5.1.33.jar</code> (lo puedes encontrar en el repositorio local de Maven <code>.m2/repository/mysql/mysql-connector-java/5.1.33/</code></p>
</li>
<li>
<p>Conéctate a la consola de administración de WildFly y selecciona la opción <em>Runtime &gt; Manage Deployments &gt; Add</em> y añade el JAR. Ponle como nombre <em>mysql_connector</em> (no es importante)</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint02/datasource01.png" alt="" width="50%">
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Pulsa en el botón <em>En/Disable</em> para activar el driver</p>
</li>
<li>
<p>En <em>Configuration &gt; Connector &gt; Datasources &gt; XA DATASOURCES</em> tenemos que crear una nueva fuente de datos. Pulsa el botón <em>Add</em> e introduce los siguientes nombres:</p>
<div class="ulist">
<ul>
<li>
<p><em>Name</em>: <code>BibliotecaDS</code></p>
</li>
<li>
<p><em>JNDI Name</em>: <code>java:/datasources/BibliotecaDS</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Selecciona el driver que acabamos de añadir y escribe como nombre de clase XA DataSource: <code>com.mysql.jdbc.jdbc2.optional.MysqlXADataSource</code>:</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint02/datasource03.png" alt="" width="50%">
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Añade la propiedad <code>URL</code> y el valor <code>jdbc:mysql://localhost:3306/biblioteca</code></p>
</li>
<li>
<p>Y en la última pantalla define el usuario y la contraseña de la conexión</p>
<div class="ulist">
<ul>
<li>
<p><em>Username</em>: <code>root</code></p>
</li>
<li>
<p><em>Password</em>: <code>expertojava</code></p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Y prueba la conexión pulsando el botón.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Por último activamos la fuente de datos:</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint02/datasource04.png" alt="" width="66%">
</div>
</div>
</div>
<div class="sect4">
<h5 id="_configuración_de_jpa">Configuración de JPA</h5>
<div class="paragraph">
<p>Vamos a añadir al proyecto la configuración JPA:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Dependencias en el POM</p>
</li>
<li>
<p>Fichero <code>persistence.xml</code> en la configuración de ejecución</p>
</li>
<li>
<p>Fichero <code>persistence.xml</code> en la configuración de test</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Empezamos con el POM de Maven. Hay que añadir al fichero <code>pom.xml</code> las dependencias relacionadas con Hibernate y DbUnit, para poder ejecutar los tests. El fichero completo es el siguiente:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tok-nt">&lt;project</span> <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="tok-na">xmlns:xsi=</span><span class="tok-s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="tok-na">xsi:schemaLocation=</span><span class="tok-s">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;modelVersion&gt;</span>4.0.0<span class="tok-nt">&lt;/modelVersion&gt;</span>

    <span class="tok-nt">&lt;groupId&gt;</span>org.expertojava.proyint<span class="tok-nt">&lt;/groupId&gt;</span>
    <span class="tok-nt">&lt;artifactId&gt;</span>jbib-rest<span class="tok-nt">&lt;/artifactId&gt;</span>
    <span class="tok-nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="tok-nt">&lt;/version&gt;</span>
    <span class="tok-nt">&lt;packaging&gt;</span>war<span class="tok-nt">&lt;/packaging&gt;</span>

    <span class="tok-nt">&lt;name&gt;</span>jbib-rest<span class="tok-nt">&lt;/name&gt;</span>

    <span class="tok-nt">&lt;properties&gt;</span>
        <span class="tok-nt">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span class="tok-nt">&lt;/project.build.sourceEncoding&gt;</span>
    <span class="tok-nt">&lt;/properties&gt;</span>

    <span class="tok-nt">&lt;dependencies&gt;</span>
        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>javax<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>javaee-web-api<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>7.0<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>provided<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>log4j<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>log4j<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>1.2.17<span class="tok-nt">&lt;/version&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>commons-logging<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>commons-logging<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>1.2<span class="tok-nt">&lt;/version&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-c">&lt;!-- Tests --&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>junit<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>junit<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>4.11<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>


	<span class="tok-c">&lt;!-- Hibernate --&gt;</span>

	<span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.hibernate.javax.persistence<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>hibernate-jpa-2.1-api<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>1.0.0.Final<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-c">&lt;!-- Quitamos el scope test para que no de error el</span>
<span class="tok-c">        elemento provider del persistence.xml de runtime--&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.hibernate<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>hibernate-entitymanager<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>4.3.7.Final<span class="tok-nt">&lt;/version&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>mysql<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>5.1.33<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-c">&lt;!-- DbUnit --&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.dbunit<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>dbunit<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>2.5.0<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.slf4j<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>slf4j-api<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>1.7.7<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.slf4j<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>slf4j-log4j12<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>1.7.7<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

	<span class="tok-c">&lt;!-- Bean Validation --&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.hibernate<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>hibernate-validator<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>5.1.3.Final<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>
        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>javax.el<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>javax.el-api<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>2.2.4<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>
        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.glassfish.web<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>el-impl<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>2.2<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>


    <span class="tok-nt">&lt;/dependencies&gt;</span>

    <span class="tok-nt">&lt;build&gt;</span>
        <span class="tok-nt">&lt;finalName&gt;</span>${project.name}<span class="tok-nt">&lt;/finalName&gt;</span>
        <span class="tok-nt">&lt;plugins&gt;</span>
            <span class="tok-nt">&lt;plugin&gt;</span>
                <span class="tok-nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="tok-nt">&lt;/groupId&gt;</span>
                <span class="tok-nt">&lt;artifactId&gt;</span>maven-compiler-plugin<span class="tok-nt">&lt;/artifactId&gt;</span>
                <span class="tok-nt">&lt;version&gt;</span>3.1<span class="tok-nt">&lt;/version&gt;</span>
                <span class="tok-nt">&lt;configuration&gt;</span>
                    <span class="tok-nt">&lt;source&gt;</span>1.7<span class="tok-nt">&lt;/source&gt;</span>
                    <span class="tok-nt">&lt;target&gt;</span>1.7<span class="tok-nt">&lt;/target&gt;</span>
                <span class="tok-nt">&lt;/configuration&gt;</span>
            <span class="tok-nt">&lt;/plugin&gt;</span>
            <span class="tok-nt">&lt;plugin&gt;</span>
                <span class="tok-nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="tok-nt">&lt;/groupId&gt;</span>
                <span class="tok-nt">&lt;artifactId&gt;</span>maven-war-plugin<span class="tok-nt">&lt;/artifactId&gt;</span>
                <span class="tok-nt">&lt;version&gt;</span>2.3<span class="tok-nt">&lt;/version&gt;</span>
                <span class="tok-nt">&lt;configuration&gt;</span>
                    <span class="tok-nt">&lt;failOnMissingWebXml&gt;</span>false<span class="tok-nt">&lt;/failOnMissingWebXml&gt;</span>
                <span class="tok-nt">&lt;/configuration&gt;</span>
            <span class="tok-nt">&lt;/plugin&gt;</span>
            <span class="tok-nt">&lt;plugin&gt;</span>
                <span class="tok-nt">&lt;groupId&gt;</span>org.wildfly.plugins<span class="tok-nt">&lt;/groupId&gt;</span>
                <span class="tok-nt">&lt;artifactId&gt;</span>wildfly-maven-plugin<span class="tok-nt">&lt;/artifactId&gt;</span>
                <span class="tok-nt">&lt;version&gt;</span>1.0.2.Final<span class="tok-nt">&lt;/version&gt;</span>
                <span class="tok-nt">&lt;configuration&gt;</span>
                    <span class="tok-nt">&lt;hostname&gt;</span>localhost<span class="tok-nt">&lt;/hostname&gt;</span>
                    <span class="tok-nt">&lt;port&gt;</span>9990<span class="tok-nt">&lt;/port&gt;</span>
                <span class="tok-nt">&lt;/configuration&gt;</span>
            <span class="tok-nt">&lt;/plugin&gt;</span>
        <span class="tok-nt">&lt;/plugins&gt;</span>
    <span class="tok-nt">&lt;/build&gt;</span>
<span class="tok-nt">&lt;/project&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En el fichero <code>src/main/resources/META-INF/persistence.xml</code> definimos la configuración de JPA y definimos la unidad de persistencia <code>biblioteca</code>.</p>
</div>
<div class="paragraph">
<p>Incluimos la declaración de las clases de entidad que vamos a implementar en esta primera iteración.</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/persistence.xml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tok-nt">&lt;persistence</span> <span class="tok-na">version=</span><span class="tok-s">&quot;2.0&quot;</span>
   <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://java.sun.com/xml/ns/persistence&quot;</span> <span class="tok-na">xmlns:xsi=</span><span class="tok-s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
   <span class="tok-na">xsi:schemaLocation=</span><span class="tok-s">&quot;</span>
<span class="tok-s">        http://java.sun.com/xml/ns/persistence</span>
<span class="tok-s">        http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd&quot;</span><span class="tok-nt">&gt;</span>
   <span class="tok-nt">&lt;persistence-unit</span> <span class="tok-na">name=</span><span class="tok-s">&quot;biblioteca&quot;</span><span class="tok-nt">&gt;</span>

       <span class="tok-nt">&lt;provider&gt;</span>org.hibernate.jpa.HibernatePersistenceProvider<span class="tok-nt">&lt;/provider&gt;</span>

       <span class="tok-nt">&lt;jta-data-source&gt;</span>java:/datasources/BibliotecaDS<span class="tok-nt">&lt;/jta-data-source&gt;</span>

       <span class="tok-nt">&lt;class&gt;</span>org.expertojava.jbibrest.modelo.Libro<span class="tok-nt">&lt;/class&gt;</span>
       <span class="tok-nt">&lt;class&gt;</span>org.expertojava.jbibrest.modelo.Ejemplar<span class="tok-nt">&lt;/class&gt;</span>
       <span class="tok-nt">&lt;class&gt;</span>org.expertojava.jbibrest.modelo.PrestadoJuntoCon<span class="tok-nt">&lt;/class&gt;</span>

       <span class="tok-nt">&lt;properties&gt;</span>
          <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.dialect&quot;</span>
                    <span class="tok-na">value=</span><span class="tok-s">&quot;org.hibernate.dialect.MySQLDialect&quot;</span><span class="tok-nt">/&gt;</span>
         <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.hbm2ddl.auto&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;update&quot;</span> <span class="tok-nt">/&gt;</span>
         <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.show_sql&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;true&quot;</span> <span class="tok-nt">/&gt;</span>
      <span class="tok-nt">&lt;/properties&gt;</span>
   <span class="tok-nt">&lt;/persistence-unit&gt;</span>
<span class="tok-nt">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y en la configuración de test de Maven añadimos la configuración de JPA que se va a utilizar para lanzar las pruebas. El fichero es <code>src/test/resources/META-INF/persistence.xml</code></p>
</div>
<div class="listingblock">
<div class="title">src/test/resources/META-INF/persistence.xml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;persistence</span> <span class="tok-na">version=</span><span class="tok-s">&quot;2.1&quot;</span>
             <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://xmlns.jcp.org/xml/ns/persistence&quot;</span>
             <span class="tok-na">xmlns:xsi=</span><span class="tok-s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
             <span class="tok-na">xsi:schemaLocation=</span><span class="tok-s">&quot;http://xmlns.jcp.org/xml/ns/persistence&quot;</span><span class="tok-nt">&gt;</span>

    <span class="tok-nt">&lt;persistence-unit</span> <span class="tok-na">name=</span><span class="tok-s">&quot;biblioteca-local&quot;</span>
                      <span class="tok-na">transaction-type=</span><span class="tok-s">&quot;RESOURCE_LOCAL&quot;</span><span class="tok-nt">&gt;</span>

        <span class="tok-nt">&lt;provider&gt;</span>org.hibernate.jpa.HibernatePersistenceProvider<span class="tok-nt">&lt;/provider&gt;</span>
        <span class="tok-nt">&lt;class&gt;</span>org.expertojava.jbibrest.modelo.Ejemplar<span class="tok-nt">&lt;/class&gt;</span>
        <span class="tok-nt">&lt;class&gt;</span>org.expertojava.jbibrest.modelo.Libro<span class="tok-nt">&lt;/class&gt;</span>
        <span class="tok-nt">&lt;class&gt;</span>org.expertojava.jbibrest.modelo.PrestadoJuntoCon<span class="tok-nt">&lt;/class&gt;</span>

	<span class="tok-nt">&lt;properties&gt;</span>

            <span class="tok-c">&lt;!-- JPA properties --&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;javax.persistence.jdbc.driver&quot;</span>
                      <span class="tok-na">value=</span><span class="tok-s">&quot;com.mysql.jdbc.Driver&quot;</span><span class="tok-nt">/&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;javax.persistence.jdbc.url&quot;</span>
                      <span class="tok-na">value=</span><span class="tok-s">&quot;jdbc:mysql://localhost:3306/biblioteca&quot;</span><span class="tok-nt">/&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;javax.persistence.jdbc.user&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;root&quot;</span><span class="tok-nt">/&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;javax.persistence.jdbc.password&quot;</span>
                      <span class="tok-na">value=</span><span class="tok-s">&quot;expertojava&quot;</span><span class="tok-nt">/&gt;</span>

            <span class="tok-c">&lt;!-- Hibernate properties --&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.dialect&quot;</span>
                      <span class="tok-na">value=</span><span class="tok-s">&quot;org.hibernate.dialect.MySQLDialect&quot;</span><span class="tok-nt">/&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.show_sql&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;true&quot;</span><span class="tok-nt">/&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.format_sql&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;false&quot;</span><span class="tok-nt">/&gt;</span>

            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.hbm2ddl.auto&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;create&quot;</span><span class="tok-nt">/&gt;</span>
        <span class="tok-nt">&lt;/properties&gt;</span>
    <span class="tok-nt">&lt;/persistence-unit&gt;</span>
<span class="tok-nt">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_clases_de_entidades">Clases de entidades</h5>
<div class="paragraph">
<p>Vamos ahora a modificar un pequeño conjunto de clases del modelo, añadiendo las anotaciones necesarias para convertirlas en clases de entidad JPA. En concreto, las clases son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Libro</code></p>
</li>
<li>
<p><code>Ejemplar</code></p>
</li>
<li>
<p><code>PrestadoJuntoCon</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Añadiremos anotaciones JPA y anotaciones <em>Bean Validation</em>.</p>
</div>
<div class="paragraph">
<p>Listamos a continuación las clases.</p>
</div>
<div class="listingblock">
<div class="title">org.expertojava.jbibrest.modelo.Libro.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">modelo</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.apache.commons.logging.Log</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.apache.commons.logging.LogFactory</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.validation.constraints.Min</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.validation.constraints.NotNull</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.HashSet</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.Set</span><span class="tok-o">;</span>

<span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Libro</span> <span class="tok-kd">extends</span> <span class="tok-n">ClaseDominio</span> <span class="tok-o">{</span>
    <span class="tok-nd">@Id</span>
    <span class="tok-nd">@GeneratedValue</span><span class="tok-o">(</span><span class="tok-n">strategy</span><span class="tok-o">=</span> <span class="tok-n">GenerationType</span><span class="tok-o">.</span><span class="tok-na">AUTO</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">Long</span> <span class="tok-n">id</span><span class="tok-o">;</span>

    <span class="tok-nd">@NotNull</span>
    <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">unique</span><span class="tok-o">=</span><span class="tok-kc">true</span><span class="tok-o">,</span> <span class="tok-n">nullable</span> <span class="tok-o">=</span> <span class="tok-kc">false</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">isbn</span><span class="tok-o">;</span>

    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">autor</span><span class="tok-o">;</span>

    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">titulo</span><span class="tok-o">;</span>

    <span class="tok-nd">@Min</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">Integer</span> <span class="tok-n">numPaginas</span><span class="tok-o">;</span>

    <span class="tok-nd">@Min</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">numEjemplares</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-o">;</span>

    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">portadaURI</span><span class="tok-o">;</span>

    <span class="tok-nd">@OneToMany</span><span class="tok-o">(</span><span class="tok-n">mappedBy</span> <span class="tok-o">=</span> <span class="tok-s">&quot;libro1&quot;</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">PrestadoJuntoCon</span><span class="tok-o">&gt;</span> <span class="tok-n">prestadoCon</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">HashSet</span><span class="tok-o">&lt;&gt;();</span>

    <span class="tok-nd">@OneToMany</span><span class="tok-o">(</span><span class="tok-n">mappedBy</span> <span class="tok-o">=</span> <span class="tok-s">&quot;libro&quot;</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Ejemplar</span><span class="tok-o">&gt;</span> <span class="tok-n">ejemplares</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">HashSet</span><span class="tok-o">&lt;&gt;();</span>

    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">Log</span> <span class="tok-n">logger</span> <span class="tok-o">=</span> <span class="tok-n">LogFactory</span><span class="tok-o">.</span><span class="tok-na">getLog</span><span class="tok-o">(</span><span class="tok-n">Libro</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>

    <span class="tok-kd">public</span> <span class="tok-nf">Libro</span><span class="tok-o">()</span> <span class="tok-o">{}</span>

    <span class="tok-kd">public</span> <span class="tok-nf">Libro</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">isbn</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">isbn</span> <span class="tok-o">=</span> <span class="tok-n">isbn</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-c1">//</span>
    <span class="tok-c1">// Getters y setters</span>
    <span class="tok-c1">//</span>

    <span class="tok-c1">// Dos libros son iguales cuando tienen el mismo ISBN</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-kt">boolean</span> <span class="tok-nf">equals</span><span class="tok-o">(</span><span class="tok-n">Object</span> <span class="tok-n">o</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-k">this</span> <span class="tok-o">==</span> <span class="tok-n">o</span><span class="tok-o">)</span> <span class="tok-k">return</span> <span class="tok-kc">true</span><span class="tok-o">;</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">o</span> <span class="tok-o">==</span> <span class="tok-kc">null</span> <span class="tok-o">||</span> <span class="tok-n">getClass</span><span class="tok-o">()</span> <span class="tok-o">!=</span> <span class="tok-n">o</span><span class="tok-o">.</span><span class="tok-na">getClass</span><span class="tok-o">())</span> <span class="tok-k">return</span> <span class="tok-kc">false</span><span class="tok-o">;</span>

        <span class="tok-n">Libro</span> <span class="tok-n">libro</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-n">Libro</span><span class="tok-o">)</span> <span class="tok-n">o</span><span class="tok-o">;</span>

        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">isbn</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span> <span class="tok-o">?</span> <span class="tok-o">!</span><span class="tok-n">isbn</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">isbn</span><span class="tok-o">)</span> <span class="tok-o">:</span> <span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">isbn</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">)</span>
            <span class="tok-k">return</span> <span class="tok-kc">false</span><span class="tok-o">;</span>

        <span class="tok-k">return</span> <span class="tok-kc">true</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-kt">int</span> <span class="tok-nf">hashCode</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">isbn</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span> <span class="tok-o">?</span> <span class="tok-n">isbn</span><span class="tok-o">.</span><span class="tok-na">hashCode</span><span class="tok-o">()</span> <span class="tok-o">:</span> <span class="tok-mi">0</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">toString</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-s">&quot;Libro{&quot;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;id=&quot;</span> <span class="tok-o">+</span> <span class="tok-n">id</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, isbn=&#39;&quot;</span> <span class="tok-o">+</span> <span class="tok-n">isbn</span> <span class="tok-o">+</span> <span class="tok-sc">&#39;\&#39;&#39;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, autor=&#39;&quot;</span> <span class="tok-o">+</span> <span class="tok-n">autor</span> <span class="tok-o">+</span> <span class="tok-sc">&#39;\&#39;&#39;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, titulo=&#39;&quot;</span> <span class="tok-o">+</span> <span class="tok-n">titulo</span> <span class="tok-o">+</span> <span class="tok-sc">&#39;\&#39;&#39;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, numPaginas=&quot;</span> <span class="tok-o">+</span> <span class="tok-n">numPaginas</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, numEjemplares=&quot;</span> <span class="tok-o">+</span> <span class="tok-n">numEjemplares</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, portadaURI=&#39;&quot;</span> <span class="tok-o">+</span> <span class="tok-n">portadaURI</span> <span class="tok-o">+</span> <span class="tok-sc">&#39;\&#39;&#39;</span> <span class="tok-o">+</span>
                <span class="tok-sc">&#39;}&#39;</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">org.expertojava.jbibrest.modelo.Ejemplar.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">modelo</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.apache.commons.logging.Log</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.apache.commons.logging.LogFactory</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.validation.constraints.NotNull</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.Date</span><span class="tok-o">;</span>

<span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Ejemplar</span> <span class="tok-kd">extends</span> <span class="tok-n">ClaseDominio</span> <span class="tok-o">{</span>
    <span class="tok-nd">@Id</span>
    <span class="tok-nd">@GeneratedValue</span><span class="tok-o">(</span><span class="tok-n">strategy</span><span class="tok-o">=</span> <span class="tok-n">GenerationType</span><span class="tok-o">.</span><span class="tok-na">AUTO</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">Long</span> <span class="tok-n">id</span><span class="tok-o">;</span>

    <span class="tok-nd">@NotNull</span>
    <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">nullable</span> <span class="tok-o">=</span> <span class="tok-kc">false</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">codigoEjemplar</span><span class="tok-o">;</span>

    <span class="tok-nd">@NotNull</span>
    <span class="tok-nd">@ManyToOne</span>
    <span class="tok-kd">private</span> <span class="tok-n">Libro</span> <span class="tok-n">libro</span><span class="tok-o">;</span>

    <span class="tok-nd">@Temporal</span><span class="tok-o">(</span><span class="tok-n">TemporalType</span><span class="tok-o">.</span><span class="tok-na">DATE</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">Date</span> <span class="tok-n">fechaAdquisicion</span><span class="tok-o">;</span>

    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">observaciones</span><span class="tok-o">;</span>

    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">Log</span> <span class="tok-n">logger</span> <span class="tok-o">=</span> <span class="tok-n">LogFactory</span><span class="tok-o">.</span><span class="tok-na">getLog</span><span class="tok-o">(</span><span class="tok-n">Ejemplar</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>

    <span class="tok-kd">public</span> <span class="tok-nf">Ejemplar</span><span class="tok-o">()</span> <span class="tok-o">{}</span>

    <span class="tok-kd">public</span> <span class="tok-nf">Ejemplar</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">codigoEjemplar</span><span class="tok-o">,</span> <span class="tok-n">Libro</span> <span class="tok-n">libro</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">codigoEjemplar</span> <span class="tok-o">=</span> <span class="tok-n">codigoEjemplar</span><span class="tok-o">;</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">libro</span> <span class="tok-o">=</span> <span class="tok-n">libro</span><span class="tok-o">;</span>
        <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-na">debug</span><span class="tok-o">(</span><span class="tok-s">&quot;Nueva instancia de Ejemplar: &quot;</span> <span class="tok-o">+</span> <span class="tok-n">codigoEjemplar</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-c1">//</span>
    <span class="tok-c1">// Getters y setters</span>
    <span class="tok-c1">//</span>

    <span class="tok-c1">// Dos ejemplares son iguales cuando tienen el mismo código y son</span>
    <span class="tok-c1">// del mismo libro</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-kt">boolean</span> <span class="tok-nf">equals</span><span class="tok-o">(</span><span class="tok-n">Object</span> <span class="tok-n">o</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-k">this</span> <span class="tok-o">==</span> <span class="tok-n">o</span><span class="tok-o">)</span> <span class="tok-k">return</span> <span class="tok-kc">true</span><span class="tok-o">;</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">o</span> <span class="tok-o">==</span> <span class="tok-kc">null</span> <span class="tok-o">||</span> <span class="tok-n">getClass</span><span class="tok-o">()</span> <span class="tok-o">!=</span> <span class="tok-n">o</span><span class="tok-o">.</span><span class="tok-na">getClass</span><span class="tok-o">())</span> <span class="tok-k">return</span> <span class="tok-kc">false</span><span class="tok-o">;</span>

        <span class="tok-n">Ejemplar</span> <span class="tok-n">ejemplar</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-n">Ejemplar</span><span class="tok-o">)</span> <span class="tok-n">o</span><span class="tok-o">;</span>

        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">codigoEjemplar</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span> <span class="tok-o">?</span>
                <span class="tok-o">!</span><span class="tok-n">codigoEjemplar</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">ejemplar</span><span class="tok-o">.</span><span class="tok-na">codigoEjemplar</span><span class="tok-o">)</span> <span class="tok-o">:</span>
                <span class="tok-n">ejemplar</span><span class="tok-o">.</span><span class="tok-na">codigoEjemplar</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-k">return</span> <span class="tok-kc">false</span><span class="tok-o">;</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">libro</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span> <span class="tok-o">?</span> <span class="tok-o">!</span><span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">ejemplar</span><span class="tok-o">.</span><span class="tok-na">libro</span><span class="tok-o">)</span> <span class="tok-o">:</span>
                <span class="tok-n">ejemplar</span><span class="tok-o">.</span><span class="tok-na">libro</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-k">return</span> <span class="tok-kc">false</span><span class="tok-o">;</span>

        <span class="tok-k">return</span> <span class="tok-kc">true</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-kt">int</span> <span class="tok-nf">hashCode</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-kt">int</span> <span class="tok-n">result</span> <span class="tok-o">=</span>
                <span class="tok-n">codigoEjemplar</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span> <span class="tok-o">?</span> <span class="tok-n">codigoEjemplar</span><span class="tok-o">.</span><span class="tok-na">hashCode</span><span class="tok-o">()</span> <span class="tok-o">:</span> <span class="tok-mi">0</span><span class="tok-o">;</span>
        <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-mi">31</span> <span class="tok-o">*</span> <span class="tok-n">result</span> <span class="tok-o">+</span> <span class="tok-o">(</span><span class="tok-n">libro</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span> <span class="tok-o">?</span> <span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">hashCode</span><span class="tok-o">()</span> <span class="tok-o">:</span> <span class="tok-mi">0</span><span class="tok-o">);</span>
        <span class="tok-k">return</span> <span class="tok-n">result</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">org.expertojava.jbibrest.modelo.PrestadoJuntoCon.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">modelo</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.apache.commons.logging.Log</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.apache.commons.logging.LogFactory</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.*</span><span class="tok-o">;</span>

<span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">PrestadoJuntoCon</span> <span class="tok-kd">extends</span> <span class="tok-n">ClaseDominio</span> <span class="tok-o">{</span>
    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">Log</span> <span class="tok-n">logger</span> <span class="tok-o">=</span> <span class="tok-n">LogFactory</span><span class="tok-o">.</span><span class="tok-na">getLog</span><span class="tok-o">(</span><span class="tok-n">PrestadoJuntoCon</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>

    <span class="tok-nd">@Id</span>
    <span class="tok-nd">@GeneratedValue</span><span class="tok-o">(</span><span class="tok-n">strategy</span><span class="tok-o">=</span> <span class="tok-n">GenerationType</span><span class="tok-o">.</span><span class="tok-na">AUTO</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">Long</span> <span class="tok-n">id</span><span class="tok-o">;</span>

    <span class="tok-nd">@ManyToOne</span>
    <span class="tok-kd">private</span> <span class="tok-n">Libro</span> <span class="tok-n">libro1</span><span class="tok-o">;</span>

    <span class="tok-nd">@OneToOne</span>
    <span class="tok-kd">private</span> <span class="tok-n">Libro</span> <span class="tok-n">libro2</span><span class="tok-o">;</span>

    <span class="tok-nd">@NotNull</span>
    <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">nullable</span> <span class="tok-o">=</span> <span class="tok-kc">false</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">Integer</span> <span class="tok-n">numVeces</span><span class="tok-o">;</span>

    <span class="tok-kd">public</span> <span class="tok-nf">PrestadoJuntoCon</span><span class="tok-o">()</span> <span class="tok-o">{}</span>

    <span class="tok-kd">public</span> <span class="tok-nf">PrestadoJuntoCon</span><span class="tok-o">(</span><span class="tok-n">Libro</span> <span class="tok-n">libro1</span><span class="tok-o">,</span> <span class="tok-n">Libro</span> <span class="tok-n">libro2</span><span class="tok-o">,</span> <span class="tok-n">Integer</span> <span class="tok-n">numVeces</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">libro1</span> <span class="tok-o">=</span> <span class="tok-n">libro1</span><span class="tok-o">;</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">libro2</span> <span class="tok-o">=</span> <span class="tok-n">libro2</span><span class="tok-o">;</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">numVeces</span> <span class="tok-o">=</span> <span class="tok-n">numVeces</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-c1">//</span>
    <span class="tok-c1">// Getters y setters</span>
    <span class="tok-c1">//</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-kt">boolean</span> <span class="tok-nf">equals</span><span class="tok-o">(</span><span class="tok-n">Object</span> <span class="tok-n">o</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-k">this</span> <span class="tok-o">==</span> <span class="tok-n">o</span><span class="tok-o">)</span> <span class="tok-k">return</span> <span class="tok-kc">true</span><span class="tok-o">;</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">o</span> <span class="tok-o">==</span> <span class="tok-kc">null</span> <span class="tok-o">||</span> <span class="tok-n">getClass</span><span class="tok-o">()</span> <span class="tok-o">!=</span> <span class="tok-n">o</span><span class="tok-o">.</span><span class="tok-na">getClass</span><span class="tok-o">())</span> <span class="tok-k">return</span> <span class="tok-kc">false</span><span class="tok-o">;</span>

        <span class="tok-n">PrestadoJuntoCon</span> <span class="tok-n">that</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-n">PrestadoJuntoCon</span><span class="tok-o">)</span> <span class="tok-n">o</span><span class="tok-o">;</span>

        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">libro1</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span> <span class="tok-o">?</span> <span class="tok-o">!</span><span class="tok-n">libro1</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">that</span><span class="tok-o">.</span><span class="tok-na">libro1</span><span class="tok-o">)</span> <span class="tok-o">:</span> <span class="tok-n">that</span><span class="tok-o">.</span><span class="tok-na">libro1</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-k">return</span> <span class="tok-kc">false</span><span class="tok-o">;</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">libro2</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span> <span class="tok-o">?</span> <span class="tok-o">!</span><span class="tok-n">libro2</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">that</span><span class="tok-o">.</span><span class="tok-na">libro2</span><span class="tok-o">)</span> <span class="tok-o">:</span> <span class="tok-n">that</span><span class="tok-o">.</span><span class="tok-na">libro2</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-k">return</span> <span class="tok-kc">false</span><span class="tok-o">;</span>

        <span class="tok-k">return</span> <span class="tok-kc">true</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-kt">int</span> <span class="tok-nf">hashCode</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-kt">int</span> <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-n">libro1</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span> <span class="tok-o">?</span> <span class="tok-n">libro1</span><span class="tok-o">.</span><span class="tok-na">hashCode</span><span class="tok-o">()</span> <span class="tok-o">:</span> <span class="tok-mi">0</span><span class="tok-o">;</span>
        <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-mi">31</span> <span class="tok-o">*</span> <span class="tok-n">result</span> <span class="tok-o">+</span> <span class="tok-o">(</span><span class="tok-n">libro2</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span> <span class="tok-o">?</span> <span class="tok-n">libro2</span><span class="tok-o">.</span><span class="tok-na">hashCode</span><span class="tok-o">()</span> <span class="tok-o">:</span> <span class="tok-mi">0</span><span class="tok-o">);</span>
        <span class="tok-k">return</span> <span class="tok-n">result</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Puedes comprobar que en los métodos <code>equals</code> y <code>hashcode</code> hemos permitido que los atributos sean <code>null</code> para que funcione correctamente el lanzamiento de la excepción de <em>bean validation</em>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_pruebas_con_dbunit">Pruebas con DbUnit</h5>
<div class="paragraph">
<p>Vamos a probar estas tres primeras entidades utilizando DbUnit. Empezamos por crear el fichero <code>src/test/resources/datasets/dataset1.xml</code> con un conjunto de datos de prueba.</p>
</div>
<div class="listingblock">
<div class="title">src/test/resources/datasets/dataset1.xml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;?xml version=&#39;1.0&#39; encoding=&#39;UTF-8&#39;?&gt;</span>
<span class="tok-nt">&lt;dataset&gt;</span>
    <span class="tok-nt">&lt;Libro</span> <span class="tok-na">id=</span><span class="tok-s">&quot;1&quot;</span> <span class="tok-na">titulo=</span><span class="tok-s">&quot;Patterns Of Enterprise Application Architecture&quot;</span>
           <span class="tok-na">autor=</span><span class="tok-s">&quot;Martin Fowler&quot;</span> <span class="tok-na">isbn=</span><span class="tok-s">&quot;0321127420&quot;</span> <span class="tok-na">numEjemplares=</span><span class="tok-s">&quot;2&quot;</span>
           <span class="tok-na">numPaginas=</span><span class="tok-s">&quot;533&quot;</span> <span class="tok-na">portadaURI=</span><span class="tok-s">&quot;0321127420.jpg&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;Libro</span> <span class="tok-na">id=</span><span class="tok-s">&quot;2&quot;</span> <span class="tok-na">titulo=</span><span class="tok-s">&quot;Clean Code&quot;</span> <span class="tok-na">autor=</span><span class="tok-s">&quot;Robert C. Martin&quot;</span>
           <span class="tok-na">isbn=</span><span class="tok-s">&quot;0132350882&quot;</span> <span class="tok-na">numEjemplares=</span><span class="tok-s">&quot;1&quot;</span> <span class="tok-na">numPaginas=</span><span class="tok-s">&quot;288&quot;</span>
           <span class="tok-na">portadaURI=</span><span class="tok-s">&quot;0132350882.jpg&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;Libro</span> <span class="tok-na">id=</span><span class="tok-s">&quot;3&quot;</span> <span class="tok-na">titulo=</span><span class="tok-s">&quot;Test Driven Development&quot;</span> <span class="tok-na">autor=</span><span class="tok-s">&quot;Kent Beck&quot;</span>
           <span class="tok-na">isbn=</span><span class="tok-s">&quot;0321146530&quot;</span> <span class="tok-na">numEjemplares=</span><span class="tok-s">&quot;1&quot;</span> <span class="tok-na">numPaginas=</span><span class="tok-s">&quot;192&quot;</span>
           <span class="tok-na">portadaURI=</span><span class="tok-s">&quot;0321146530.jpg&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;Ejemplar</span> <span class="tok-na">id=</span><span class="tok-s">&quot;1&quot;</span> <span class="tok-na">codigoEjemplar=</span><span class="tok-s">&quot;001&quot;</span> <span class="tok-na">fechaAdquisicion=</span><span class="tok-s">&quot;2014-10-01&quot;</span>
              <span class="tok-na">libro_id=</span><span class="tok-s">&quot;1&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;Ejemplar</span> <span class="tok-na">id=</span><span class="tok-s">&quot;2&quot;</span> <span class="tok-na">codigoEjemplar=</span><span class="tok-s">&quot;002&quot;</span> <span class="tok-na">fechaAdquisicion=</span><span class="tok-s">&quot;2014-10-01&quot;</span>
              <span class="tok-na">libro_id=</span><span class="tok-s">&quot;1&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;Ejemplar</span> <span class="tok-na">id=</span><span class="tok-s">&quot;3&quot;</span> <span class="tok-na">codigoEjemplar=</span><span class="tok-s">&quot;001&quot;</span> <span class="tok-na">fechaAdquisicion=</span><span class="tok-s">&quot;2014-11-01&quot;</span>
              <span class="tok-na">libro_id=</span><span class="tok-s">&quot;2&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;Ejemplar</span> <span class="tok-na">id=</span><span class="tok-s">&quot;4&quot;</span> <span class="tok-na">codigoEjemplar=</span><span class="tok-s">&quot;001&quot;</span> <span class="tok-na">fechaAdquisicion=</span><span class="tok-s">&quot;2014-11-21&quot;</span>
              <span class="tok-na">libro_id=</span><span class="tok-s">&quot;3&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;PrestadoJuntoCon</span> <span class="tok-na">id=</span><span class="tok-s">&quot;1&quot;</span> <span class="tok-na">libro1_id=</span><span class="tok-s">&quot;1&quot;</span> <span class="tok-na">libro2_id=</span><span class="tok-s">&quot;2&quot;</span> <span class="tok-na">numVeces=</span><span class="tok-s">&quot;4&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;PrestadoJuntoCon</span> <span class="tok-na">id=</span><span class="tok-s">&quot;2&quot;</span> <span class="tok-na">libro1_id=</span><span class="tok-s">&quot;2&quot;</span> <span class="tok-na">libro2_id=</span><span class="tok-s">&quot;1&quot;</span> <span class="tok-na">numVeces=</span><span class="tok-s">&quot;4&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;PrestadoJuntoCon</span> <span class="tok-na">id=</span><span class="tok-s">&quot;3&quot;</span> <span class="tok-na">libro1_id=</span><span class="tok-s">&quot;1&quot;</span> <span class="tok-na">libro2_id=</span><span class="tok-s">&quot;3&quot;</span> <span class="tok-na">numVeces=</span><span class="tok-s">&quot;2&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;PrestadoJuntoCon</span> <span class="tok-na">id=</span><span class="tok-s">&quot;4&quot;</span> <span class="tok-na">libro1_id=</span><span class="tok-s">&quot;3&quot;</span> <span class="tok-na">libro2_id=</span><span class="tok-s">&quot;1&quot;</span> <span class="tok-na">numVeces=</span><span class="tok-s">&quot;2&quot;</span><span class="tok-nt">/&gt;</span>
<span class="tok-nt">&lt;/dataset&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Par empezar definimos dos tests sencillos. Uno que carga la unidad de persistencia y otro que comprueba el método <code>find</code> del DAO. Los creamos en el fichero <code>src/test/java/org.expertojava.jbibrest.persistencia.PersistenciaTest.java</code>.</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/org.expertojava.jbibrest.persistencia.PersistenciaTest.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">persistencia</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.apache.commons.logging.Log</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.apache.commons.logging.LogFactory</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManager</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManagerFactory</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.Persistence</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.dbunit.database.DatabaseConfig</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.dbunit.database.DatabaseConnection</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.dbunit.database.IDatabaseConnection</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.dbunit.dataset.IDataSet</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.dbunit.dataset.xml.FlatXmlDataSetBuilder</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.dbunit.ext.mysql.MySqlDataTypeFactory</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.dbunit.operation.DatabaseOperation</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.modelo.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.junit.AfterClass</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.junit.Before</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.junit.BeforeClass</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.junit.Test</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">java.sql.Connection</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.sql.DriverManager</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">junit</span><span class="tok-o">.</span><span class="tok-na">Assert</span><span class="tok-o">.</span><span class="tok-na">assertTrue</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">junit</span><span class="tok-o">.</span><span class="tok-na">Assert</span><span class="tok-o">.</span><span class="tok-na">fail</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">PersistenciaTest</span> <span class="tok-o">{</span>
    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">IDatabaseConnection</span> <span class="tok-n">connection</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">IDataSet</span> <span class="tok-n">dataset</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">EntityManagerFactory</span> <span class="tok-n">emf</span><span class="tok-o">;</span>

    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">Log</span> <span class="tok-n">logger</span> <span class="tok-o">=</span> <span class="tok-n">LogFactory</span>
            <span class="tok-o">.</span><span class="tok-na">getLog</span><span class="tok-o">(</span><span class="tok-n">PersistenciaTest</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>

    <span class="tok-nd">@BeforeClass</span>
    <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-kt">void</span> <span class="tok-nf">initDatabaseTest</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-na">info</span><span class="tok-o">(</span><span class="tok-s">&quot;Obteniendo JPA EntityManagerFactory para los tests&quot;</span><span class="tok-o">);</span>
        <span class="tok-k">try</span> <span class="tok-o">{</span>
            <span class="tok-n">emf</span> <span class="tok-o">=</span> <span class="tok-n">Persistence</span>
                    <span class="tok-o">.</span><span class="tok-na">createEntityManagerFactory</span><span class="tok-o">(</span><span class="tok-s">&quot;biblioteca-local&quot;</span><span class="tok-o">);</span>
            <span class="tok-c1">// Inicializamos la conexión a la BD necesaria para</span>
            <span class="tok-c1">// que DBUnit cargue los datos de los tests</span>
            <span class="tok-n">Class</span><span class="tok-o">.</span><span class="tok-na">forName</span><span class="tok-o">(</span><span class="tok-s">&quot;com.mysql.jdbc.Driver&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">Connection</span> <span class="tok-n">jdbcConnection</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-n">Connection</span><span class="tok-o">)</span> <span class="tok-n">DriverManager</span>
                    <span class="tok-o">.</span><span class="tok-na">getConnection</span><span class="tok-o">(</span>
                            <span class="tok-s">&quot;jdbc:mysql://localhost:3306/biblioteca&quot;</span><span class="tok-o">,</span>
                            <span class="tok-s">&quot;root&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;expertojava&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">connection</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">DatabaseConnection</span><span class="tok-o">(</span><span class="tok-n">jdbcConnection</span><span class="tok-o">);</span>

            <span class="tok-c1">// added this 2 lines to get rid of the warning</span>
            <span class="tok-n">DatabaseConfig</span> <span class="tok-n">dbConfig</span> <span class="tok-o">=</span> <span class="tok-n">connection</span><span class="tok-o">.</span><span class="tok-na">getConfig</span><span class="tok-o">();</span>
            <span class="tok-n">dbConfig</span><span class="tok-o">.</span><span class="tok-na">setProperty</span><span class="tok-o">(</span><span class="tok-n">DatabaseConfig</span><span class="tok-o">.</span><span class="tok-na">PROPERTY_DATATYPE_FACTORY</span><span class="tok-o">,</span>
                    <span class="tok-k">new</span> <span class="tok-nf">MySqlDataTypeFactory</span><span class="tok-o">());</span>

            <span class="tok-n">FlatXmlDataSetBuilder</span> <span class="tok-n">flatXmlDataSetBuilder</span> <span class="tok-o">=</span>
                    <span class="tok-k">new</span> <span class="tok-nf">FlatXmlDataSetBuilder</span><span class="tok-o">();</span>
            <span class="tok-n">flatXmlDataSetBuilder</span><span class="tok-o">.</span><span class="tok-na">setColumnSensing</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">);</span>
            <span class="tok-n">dataset</span> <span class="tok-o">=</span> <span class="tok-n">flatXmlDataSetBuilder</span><span class="tok-o">.</span><span class="tok-na">build</span><span class="tok-o">(</span><span class="tok-n">Thread</span><span class="tok-o">.</span><span class="tok-na">currentThread</span><span class="tok-o">()</span>
                    <span class="tok-o">.</span><span class="tok-na">getContextClassLoader</span><span class="tok-o">()</span>
                    <span class="tok-o">.</span><span class="tok-na">getResourceAsStream</span><span class="tok-o">(</span><span class="tok-s">&quot;datasets/dataset1.xml&quot;</span><span class="tok-o">));</span>
        <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">Exception</span> <span class="tok-n">ex</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">ex</span><span class="tok-o">.</span><span class="tok-na">printStackTrace</span><span class="tok-o">();</span>
            <span class="tok-n">fail</span><span class="tok-o">(</span><span class="tok-s">&quot;Excepción al inicializar el emf y DbUnit&quot;</span><span class="tok-o">);</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Before</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">cleanDB</span><span class="tok-o">()</span> <span class="tok-kd">throws</span> <span class="tok-n">Exception</span> <span class="tok-o">{</span>
        <span class="tok-c1">// Se hace un &quot;clean insert&quot; de los datos de prueba</span>
        <span class="tok-c1">// definidos en el fichero XML. El &quot;clean insert&quot; vacía las</span>
        <span class="tok-c1">// tablas de los datos de prueba y después inserta los datos</span>
        <span class="tok-n">DatabaseOperation</span><span class="tok-o">.</span><span class="tok-na">CLEAN_INSERT</span><span class="tok-o">.</span><span class="tok-na">execute</span><span class="tok-o">(</span><span class="tok-n">connection</span><span class="tok-o">,</span> <span class="tok-n">dataset</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">entityManagerTest</span><span class="tok-o">()</span> <span class="tok-o">{</span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">em</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-c1">// Primer test de Libro</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">findDevuelveLibro</span><span class="tok-o">()</span> <span class="tok-o">{</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">Libro</span> <span class="tok-n">libro</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Libro</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">1L</span><span class="tok-o">);</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">getTitulo</span><span class="tok-o">().</span><span class="tok-na">equals</span><span class="tok-o">(</span>
	          <span class="tok-s">&quot;Patterns Of Enterprise Application Architecture&quot;</span><span class="tok-o">));</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@AfterClass</span>
    <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-kt">void</span> <span class="tok-nf">closeEntityManagerFactory</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-na">info</span><span class="tok-o">(</span><span class="tok-s">&quot;Closing JPA EntityManagerFactory&quot;</span><span class="tok-o">);</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">emf</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">)</span>
            <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Probamos los tests desde IntelliJ y desde el panel de Maven, para comprobar que funcionan correctamente en ambas configuraciones.</p>
</div>
<div class="paragraph">
<p>Añadimos el resto de tests, que comprueban el método <code>find</code> y las relaciones entre las entidades:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">findDevuelveLibroConEjemplares</span><span class="tok-o">()</span> <span class="tok-o">{</span> <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">Libro</span> <span class="tok-n">libro</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Libro</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">1L</span><span class="tok-o">);</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">getEjemplares</span><span class="tok-o">().</span><span class="tok-na">size</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-mi">2</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>

    <span class="tok-c1">// Tests de Ejemplar</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">findDevuelveEjemplar</span><span class="tok-o">()</span> <span class="tok-o">{</span> <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">Ejemplar</span> <span class="tok-n">ejemplar</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Ejemplar</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">2L</span><span class="tok-o">);</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">ejemplar</span><span class="tok-o">.</span><span class="tok-na">getLibro</span><span class="tok-o">().</span><span class="tok-na">getTitulo</span><span class="tok-o">().</span><span class="tok-na">equals</span><span class="tok-o">(</span>
	          <span class="tok-s">&quot;Patterns Of Enterprise Application Architecture&quot;</span><span class="tok-o">));</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>

    <span class="tok-c1">// Tests de PrestadoJuntoCon</span>


    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">prestadoVecesConmutativo</span><span class="tok-o">()</span> <span class="tok-o">{</span><i class="conum" data-value="5"></i><b>(5)</b>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">Libro</span> <span class="tok-n">libro1</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Libro</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">1L</span><span class="tok-o">);</span>
        <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">PrestadoJuntoCon</span> <span class="tok-n">juntoCon</span> <span class="tok-o">:</span> <span class="tok-n">libro1</span><span class="tok-o">.</span><span class="tok-na">getPrestadoCon</span><span class="tok-o">())</span> <span class="tok-o">{</span>
            <span class="tok-n">Libro</span> <span class="tok-n">libro2</span> <span class="tok-o">=</span> <span class="tok-n">juntoCon</span><span class="tok-o">.</span><span class="tok-na">getLibro2</span><span class="tok-o">();</span>
            <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">PrestadoJuntoCon</span> <span class="tok-n">juntoCon2</span> <span class="tok-o">:</span> <span class="tok-n">libro2</span><span class="tok-o">.</span><span class="tok-na">getPrestadoCon</span><span class="tok-o">())</span> <span class="tok-o">{</span>
                <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">juntoCon</span><span class="tok-o">.</span><span class="tok-na">getLibro1</span><span class="tok-o">().</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">juntoCon2</span><span class="tok-o">.</span><span class="tok-na">getLibro2</span><span class="tok-o">()))</span> <span class="tok-o">{</span>
                    <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-na">info</span><span class="tok-o">(</span><span class="tok-n">juntoCon</span><span class="tok-o">.</span><span class="tok-na">getLibro1</span><span class="tok-o">().</span><span class="tok-na">getTitulo</span><span class="tok-o">()</span> <span class="tok-o">+</span>
                            <span class="tok-s">&quot; - &quot;</span> <span class="tok-o">+</span> <span class="tok-n">juntoCon2</span><span class="tok-o">.</span><span class="tok-na">getLibro1</span><span class="tok-o">().</span><span class="tok-na">getTitulo</span><span class="tok-o">()</span> <span class="tok-o">+</span>
                            <span class="tok-s">&quot; : &quot;</span> <span class="tok-o">+</span> <span class="tok-n">juntoCon</span><span class="tok-o">.</span><span class="tok-na">getNumVeces</span><span class="tok-o">());</span>
                    <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">juntoCon</span><span class="tok-o">.</span><span class="tok-na">getNumVeces</span><span class="tok-o">()</span>
                            <span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">juntoCon2</span><span class="tok-o">.</span><span class="tok-na">getNumVeces</span><span class="tok-o">()));</span>
                <span class="tok-o">}</span>
            <span class="tok-o">}</span>
        <span class="tok-o">}</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_clases_dao">Clases DAO</h5>
<div class="paragraph">
<p>Añadimos ahora las clases DAO correspondientes a las entidades anteriores. Lo hacemos en el paquete <code>org.expertojava.persistencia</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>org.expertojava.persistencia.Dao</code></p>
</li>
<li>
<p><code>org.expertojava.persistencia.LibroDAO</code></p>
</li>
<li>
<p><code>org.expertojava.persistencia.EjemplarDAO</code></p>
</li>
<li>
<p><code>org.expertojava.persistencia.PrestadoJuntoConDAO</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La clase abstracta <code>Dao</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org.expertojava.persistencia.Dao</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">persistencia</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManager</span><span class="tok-o">;</span>

<span class="tok-kd">abstract</span> <span class="tok-kd">class</span> <span class="tok-nc">Dao</span><span class="tok-o">&lt;</span><span class="tok-n">T</span><span class="tok-o">,</span> <span class="tok-n">K</span><span class="tok-o">&gt;</span> <span class="tok-o">{</span>
    <span class="tok-n">EntityManager</span> <span class="tok-n">em</span><span class="tok-o">;</span>

    <span class="tok-kd">public</span> <span class="tok-nf">Dao</span><span class="tok-o">(</span><span class="tok-n">EntityManager</span> <span class="tok-n">em</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">em</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">EntityManager</span> <span class="tok-nf">getEntityManager</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">em</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">T</span> <span class="tok-nf">create</span><span class="tok-o">(</span><span class="tok-n">T</span> <span class="tok-n">t</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">persist</span><span class="tok-o">(</span><span class="tok-n">t</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">flush</span><span class="tok-o">();</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">refresh</span><span class="tok-o">(</span><span class="tok-n">t</span><span class="tok-o">);</span>
        <span class="tok-k">return</span> <span class="tok-n">t</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">T</span> <span class="tok-nf">update</span><span class="tok-o">(</span><span class="tok-n">T</span> <span class="tok-n">t</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-o">(</span><span class="tok-n">T</span><span class="tok-o">)</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">merge</span><span class="tok-o">(</span><span class="tok-n">t</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">delete</span><span class="tok-o">(</span><span class="tok-n">T</span> <span class="tok-n">t</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">t</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">merge</span><span class="tok-o">(</span><span class="tok-n">t</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">remove</span><span class="tok-o">(</span><span class="tok-n">t</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kd">abstract</span> <span class="tok-n">T</span> <span class="tok-nf">find</span><span class="tok-o">(</span><span class="tok-n">K</span> <span class="tok-n">id</span><span class="tok-o">);</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La clase <code>LibroDao</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org.expertojava.persistencia.LibroDao</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">persistencia</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.modelo.Libro</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManager</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.List</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">LibroDao</span> <span class="tok-kd">extends</span> <span class="tok-n">Dao</span><span class="tok-o">&lt;</span><span class="tok-n">Libro</span><span class="tok-o">,</span> <span class="tok-n">Long</span><span class="tok-o">&gt;</span> <span class="tok-o">{</span>

    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-kd">final</span> <span class="tok-n">String</span> <span class="tok-n">QUERY_ALL_LIBROS</span> <span class="tok-o">=</span>
            <span class="tok-s">&quot;SELECT l FROM Libro l&quot;</span><span class="tok-o">;</span>

    <span class="tok-kd">public</span> <span class="tok-nf">LibroDao</span><span class="tok-o">(</span><span class="tok-n">EntityManager</span> <span class="tok-n">em</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-kd">super</span><span class="tok-o">(</span><span class="tok-n">em</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">Libro</span> <span class="tok-nf">find</span><span class="tok-o">(</span><span class="tok-n">Long</span> <span class="tok-n">id</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">getEntityManager</span><span class="tok-o">();</span>
        <span class="tok-k">return</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Libro</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-n">id</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@SuppressWarnings</span><span class="tok-o">(</span><span class="tok-s">&quot;unchecked&quot;</span><span class="tok-o">)</span>
    <span class="tok-kd">public</span> <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Libro</span><span class="tok-o">&gt;</span> <span class="tok-nf">getAllLibros</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">getEntityManager</span><span class="tok-o">();</span>
        <span class="tok-k">return</span> <span class="tok-o">(</span><span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Libro</span><span class="tok-o">&gt;)</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">createQuery</span><span class="tok-o">(</span><span class="tok-n">QUERY_ALL_LIBROS</span><span class="tok-o">)</span>
                <span class="tok-o">.</span><span class="tok-na">getResultList</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La clase <code>EjemplarDao</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org.expertojava.persistencia.EjemplarDao</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">persistencia</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.modelo.Ejemplar</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManager</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.List</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">EjemplarDao</span> <span class="tok-kd">extends</span> <span class="tok-n">Dao</span><span class="tok-o">&lt;</span><span class="tok-n">Ejemplar</span><span class="tok-o">,</span> <span class="tok-n">Long</span><span class="tok-o">&gt;</span> <span class="tok-o">{</span>

    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-kd">final</span> <span class="tok-n">String</span> <span class="tok-n">QUERY_ALL_EJEMPLARES</span> <span class="tok-o">=</span>
            <span class="tok-s">&quot;SELECT e FROM Ejemplar e&quot;</span><span class="tok-o">;</span>

    <span class="tok-kd">public</span> <span class="tok-nf">EjemplarDao</span><span class="tok-o">(</span><span class="tok-n">EntityManager</span> <span class="tok-n">em</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-kd">super</span><span class="tok-o">(</span><span class="tok-n">em</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">Ejemplar</span> <span class="tok-nf">find</span><span class="tok-o">(</span><span class="tok-n">Long</span> <span class="tok-n">id</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">getEntityManager</span><span class="tok-o">();</span>
        <span class="tok-k">return</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Ejemplar</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-n">id</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@SuppressWarnings</span><span class="tok-o">(</span><span class="tok-s">&quot;unchecked&quot;</span><span class="tok-o">)</span>
    <span class="tok-kd">public</span> <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Ejemplar</span><span class="tok-o">&gt;</span> <span class="tok-nf">getAllEjemplares</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">getEntityManager</span><span class="tok-o">();</span>
        <span class="tok-k">return</span> <span class="tok-o">(</span><span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Ejemplar</span><span class="tok-o">&gt;)</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">createQuery</span><span class="tok-o">(</span><span class="tok-n">QUERY_ALL_EJEMPLARES</span><span class="tok-o">)</span>
                <span class="tok-o">.</span><span class="tok-na">getResultList</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y la clase <code>PrestadoJuntoConDao</code> que nos permite obtener el número de veces que un libro se ha prestado junto con otros.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org.expertojava.persistencia.PrestadoJuntoConDao</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">persistencia</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.modelo.Ejemplar</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManager</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.List</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">PrestadoJuntoConDao</span> <span class="tok-kd">extends</span> <span class="tok-n">Dao</span><span class="tok-o">&lt;</span><span class="tok-n">PrestadoJuntoCon</span><span class="tok-o">,</span> <span class="tok-n">Long</span><span class="tok-o">&gt;</span> <span class="tok-o">{</span>

    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-kd">final</span> <span class="tok-n">String</span> <span class="tok-n">QUERY_PRESTADOS_JUNTO_CON</span> <span class="tok-o">=</span>
            <span class="tok-s">&quot;SELECT p FROM PrestadoJuntoCon p &quot;</span> <span class="tok-o">+</span>
            <span class="tok-s">&quot;WHERE p.libro1.id = :id &quot;</span> <span class="tok-o">+</span>
	    <span class="tok-s">&quot;ORDER BY p.numVeces DESC&quot;</span><span class="tok-o">;</span>

    <span class="tok-kd">public</span> <span class="tok-nf">PrestadoJuntoConDao</span><span class="tok-o">(</span><span class="tok-n">EntityManager</span> <span class="tok-n">em</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-kd">super</span><span class="tok-o">(</span><span class="tok-n">em</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">PrestadoJuntoCon</span> <span class="tok-nf">find</span><span class="tok-o">(</span><span class="tok-n">Long</span> <span class="tok-n">id</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">getEntityManager</span><span class="tok-o">();</span>
        <span class="tok-k">return</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">PrestadoJuntoCon</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-n">id</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@SuppressWarnings</span><span class="tok-o">(</span><span class="tok-s">&quot;unchecked&quot;</span><span class="tok-o">)</span>
    <span class="tok-kd">public</span> <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">PrestadoJuntoCon</span><span class="tok-o">&gt;</span> <span class="tok-nf">getLibrosPrestadosJuntoCon</span><span class="tok-o">(</span><span class="tok-n">Long</span> <span class="tok-n">libroId</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">getEntityManager</span><span class="tok-o">();</span>
        <span class="tok-k">return</span> <span class="tok-o">(</span><span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">PrestadoJuntoCon</span><span class="tok-o">&gt;)</span>
                <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">createQuery</span><span class="tok-o">(</span><span class="tok-n">QUERY_PRESTADOS_JUNTO_CON</span><span class="tok-o">)</span>
                <span class="tok-o">.</span><span class="tok-na">setParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;id&quot;</span><span class="tok-o">,</span> <span class="tok-n">libroId</span><span class="tok-o">)</span>
                <span class="tok-o">.</span><span class="tok-na">getResultList</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_pruebas_de_las_clases_dao">Pruebas de las clases Dao</h5>
<div class="paragraph">
<p>Para probar que las clases Dao funcionan correctamente, creamos una clase de test para cada clase Dao. En cada clase realizamos alguna pruebas, sin ser demasiado exhaustivos. Todas las pruebas las definimos en el paquete <code>org.expertojava.jbibrest.persistencia</code>.</p>
</div>
<div class="paragraph">
<p>Vamos a trabajar con el mismo conjunto de datos que hemos creado en las pruebas de las entidades.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, podemos probar:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Método <code>find</code></p>
</li>
<li>
<p>Métodos de actualización</p>
</li>
<li>
<p>Consulta <code>getAll</code></p>
</li>
<li>
<p>Restricciones <em>Bean Validation</em></p>
</li>
<li>
<p>Relaciones con otras entidades</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Empezamos con las pruebas sobre <code>LibroDao</code>. Fíjate en los nombres de los tests, porque son bastante descriptivos.</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/org.expertojava.jbibrest.persistencia.LibroDaoTest.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">persistencia</span><span class="tok-o">;</span>

<span class="tok-c1">//</span>
<span class="tok-c1">// Imports</span>
<span class="tok-c1">//</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">LibroDaoTest</span> <span class="tok-o">{</span>
    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">IDatabaseConnection</span> <span class="tok-n">connection</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">IDataSet</span> <span class="tok-n">dataset</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">EntityManagerFactory</span> <span class="tok-n">emf</span><span class="tok-o">;</span>

    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">Log</span> <span class="tok-n">logger</span> <span class="tok-o">=</span> <span class="tok-n">LogFactory</span>
            <span class="tok-o">.</span><span class="tok-na">getLog</span><span class="tok-o">(</span><span class="tok-n">LibroDaoTest</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>

    <span class="tok-nd">@BeforeClass</span>
    <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-kt">void</span> <span class="tok-nf">initDatabaseTest</span><span class="tok-o">()</span> <span class="tok-o">{</span>
       <span class="tok-c1">//</span>
       <span class="tok-c1">// Inicialización</span>
       <span class="tok-c1">//</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Before</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">cleanDB</span><span class="tok-o">()</span> <span class="tok-kd">throws</span> <span class="tok-n">Exception</span> <span class="tok-o">{</span>
        <span class="tok-c1">// Se hace un &quot;clean insert&quot; de los datos de prueba</span>
        <span class="tok-c1">// definidos en el fichero XML. El &quot;clean insert&quot; vacía las</span>
        <span class="tok-c1">// tablas de los datos de prueba y después inserta los datos</span>
        <span class="tok-n">DatabaseOperation</span><span class="tok-o">.</span><span class="tok-na">CLEAN_INSERT</span><span class="tok-o">.</span><span class="tok-na">execute</span><span class="tok-o">(</span><span class="tok-n">connection</span><span class="tok-o">,</span> <span class="tok-n">dataset</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">findLibroDaoTest</span><span class="tok-o">()</span> <span class="tok-o">{</span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">LibroDao</span> <span class="tok-n">libroDao</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">LibroDao</span><span class="tok-o">(</span><span class="tok-n">em</span><span class="tok-o">);</span>
        <span class="tok-n">Libro</span> <span class="tok-n">libro</span> <span class="tok-o">=</span> <span class="tok-n">libroDao</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-mi">2L</span><span class="tok-o">);</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">getTitulo</span><span class="tok-o">().</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-s">&quot;Clean Code&quot;</span><span class="tok-o">));</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">updateLibroDaoActualizaBienElAutor</span><span class="tok-o">()</span> <span class="tok-o">{</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-n">String</span> <span class="tok-n">nuevoAutor</span> <span class="tok-o">=</span> <span class="tok-s">&quot;Kent Beck&quot;</span><span class="tok-o">;</span>

        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">begin</span><span class="tok-o">();</span>
        <span class="tok-n">LibroDao</span> <span class="tok-n">libroDao</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">LibroDao</span><span class="tok-o">(</span><span class="tok-n">em</span><span class="tok-o">);</span>
        <span class="tok-n">Libro</span> <span class="tok-n">libro</span> <span class="tok-o">=</span> <span class="tok-n">libroDao</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-mi">1L</span><span class="tok-o">);</span>
        <span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">setAutor</span><span class="tok-o">(</span><span class="tok-n">nuevoAutor</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">();</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>

        <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">libroDao</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">LibroDao</span><span class="tok-o">(</span><span class="tok-n">em</span><span class="tok-o">);</span>
        <span class="tok-n">libro</span> <span class="tok-o">=</span> <span class="tok-n">libroDao</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-mi">1L</span><span class="tok-o">);</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">getAutor</span><span class="tok-o">().</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">nuevoAutor</span><span class="tok-o">));</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">getAllLibrosDevuelveTodosLosLibros</span><span class="tok-o">()</span> <span class="tok-o">{</span> <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">LibroDao</span> <span class="tok-n">libroDao</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">LibroDao</span><span class="tok-o">(</span><span class="tok-n">em</span><span class="tok-o">);</span>
        <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Libro</span><span class="tok-o">&gt;</span> <span class="tok-n">libros</span> <span class="tok-o">=</span> <span class="tok-n">libroDao</span><span class="tok-o">.</span><span class="tok-na">getAllLibros</span><span class="tok-o">();</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">libros</span><span class="tok-o">.</span><span class="tok-na">size</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-mi">3</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span><span class="tok-o">(</span><span class="tok-n">expected</span> <span class="tok-o">=</span> <span class="tok-n">ConstraintViolationException</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">)</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">createLibroLanzaExcepcionConIsbnNull</span><span class="tok-o">()</span> <span class="tok-o">{</span> <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-k">try</span> <span class="tok-o">{</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">begin</span><span class="tok-o">();</span>
            <span class="tok-n">LibroDao</span> <span class="tok-n">libroDao</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">LibroDao</span><span class="tok-o">(</span><span class="tok-n">em</span><span class="tok-o">);</span>
            <span class="tok-n">Libro</span> <span class="tok-n">libro</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Libro</span><span class="tok-o">(</span><span class="tok-kc">null</span><span class="tok-o">);</span>
            <span class="tok-n">libroDao</span><span class="tok-o">.</span><span class="tok-na">create</span><span class="tok-o">(</span><span class="tok-n">libro</span><span class="tok-o">);</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">();</span>
        <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">RuntimeException</span> <span class="tok-n">ex</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-na">info</span><span class="tok-o">(</span><span class="tok-s">&quot;Excpeción: &quot;</span> <span class="tok-o">+</span> <span class="tok-n">ex</span><span class="tok-o">.</span><span class="tok-na">getMessage</span><span class="tok-o">());</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">rollback</span><span class="tok-o">();</span>
            <span class="tok-k">throw</span> <span class="tok-n">ex</span><span class="tok-o">;</span>
        <span class="tok-o">}</span> <span class="tok-k">finally</span> <span class="tok-o">{</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">numEjemplaresSeCorrespondeConEjemplaresAsociados</span><span class="tok-o">()</span> <span class="tok-o">{</span> <i class="conum" data-value="5"></i><b>(5)</b>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">LibroDao</span> <span class="tok-n">libroDao</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">LibroDao</span><span class="tok-o">(</span><span class="tok-n">em</span><span class="tok-o">);</span>
        <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Libro</span><span class="tok-o">&gt;</span> <span class="tok-n">libros</span> <span class="tok-o">=</span> <span class="tok-n">libroDao</span><span class="tok-o">.</span><span class="tok-na">getAllLibros</span><span class="tok-o">();</span>
        <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">Libro</span> <span class="tok-n">libro</span> <span class="tok-o">:</span> <span class="tok-n">libros</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-kt">int</span> <span class="tok-n">nEjempRelacion</span> <span class="tok-o">=</span> <span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">getEjemplares</span><span class="tok-o">().</span><span class="tok-na">size</span><span class="tok-o">();</span>
            <span class="tok-n">assertEquals</span><span class="tok-o">((</span><span class="tok-kt">long</span><span class="tok-o">)</span> <span class="tok-n">nEjempRelacion</span><span class="tok-o">,</span> <span class="tok-o">(</span><span class="tok-kt">long</span><span class="tok-o">)</span> <span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">getNumEjemplares</span><span class="tok-o">());</span>
        <span class="tok-o">}</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@AfterClass</span>
    <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-kt">void</span> <span class="tok-nf">closeEntityManagerFactory</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-na">info</span><span class="tok-o">(</span><span class="tok-s">&quot;Closing JPA EntityManagerFactory&quot;</span><span class="tok-o">);</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">emf</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">)</span>
            <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Las pruebas de la clase <code>EjemplarDao</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/org.expertojava.jbibrest.persistencia.EjemplarDaoTest.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">persistencia</span><span class="tok-o">;</span>

<span class="tok-c1">//</span>
<span class="tok-c1">// Imports</span>
<span class="tok-c1">//</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">EjemplarDaoTest</span> <span class="tok-o">{</span>
    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">IDatabaseConnection</span> <span class="tok-n">connection</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">IDataSet</span> <span class="tok-n">dataset</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">EntityManagerFactory</span> <span class="tok-n">emf</span><span class="tok-o">;</span>

    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">Log</span> <span class="tok-n">logger</span> <span class="tok-o">=</span> <span class="tok-n">LogFactory</span>
            <span class="tok-o">.</span><span class="tok-na">getLog</span><span class="tok-o">(</span><span class="tok-n">EjemplarDaoTest</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>

    <span class="tok-nd">@BeforeClass</span>
    <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-kt">void</span> <span class="tok-nf">initDatabaseTest</span><span class="tok-o">()</span> <span class="tok-o">{</span>

        <span class="tok-c1">//</span>
        <span class="tok-c1">// Inicialización</span>
        <span class="tok-c1">//</span>

    <span class="tok-o">}</span>

    <span class="tok-nd">@Before</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">cleanDB</span><span class="tok-o">()</span> <span class="tok-kd">throws</span> <span class="tok-n">Exception</span> <span class="tok-o">{</span>
        <span class="tok-c1">// Se hace un &quot;clean insert&quot; de los datos de prueba</span>
        <span class="tok-c1">// definidos en el fichero XML. El &quot;clean insert&quot; vacía las</span>
        <span class="tok-c1">// tablas de los datos de prueba y después inserta los datos</span>
        <span class="tok-n">DatabaseOperation</span><span class="tok-o">.</span><span class="tok-na">CLEAN_INSERT</span><span class="tok-o">.</span><span class="tok-na">execute</span><span class="tok-o">(</span><span class="tok-n">connection</span><span class="tok-o">,</span> <span class="tok-n">dataset</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">findEjemplarDaoTest</span><span class="tok-o">()</span> <span class="tok-o">{</span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">EjemplarDao</span> <span class="tok-n">ejemplarDao</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">EjemplarDao</span><span class="tok-o">(</span><span class="tok-n">em</span><span class="tok-o">);</span>
        <span class="tok-n">Ejemplar</span> <span class="tok-n">ejemplar</span> <span class="tok-o">=</span> <span class="tok-n">ejemplarDao</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-mi">3L</span><span class="tok-o">);</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">ejemplar</span><span class="tok-o">.</span><span class="tok-na">getLibro</span><span class="tok-o">().</span><span class="tok-na">getTitulo</span><span class="tok-o">().</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-s">&quot;Clean Code&quot;</span><span class="tok-o">));</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">updateEjemplarDaoActualizaBienCodigo</span><span class="tok-o">()</span> <span class="tok-o">{</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-n">String</span> <span class="tok-n">nuevoCodigo</span><span class="tok-o">=</span><span class="tok-s">&quot;002&quot;</span><span class="tok-o">;</span>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>

        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">begin</span><span class="tok-o">();</span>
        <span class="tok-n">EjemplarDao</span> <span class="tok-n">ejemplarDao</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">EjemplarDao</span><span class="tok-o">(</span><span class="tok-n">em</span><span class="tok-o">);</span>
        <span class="tok-n">Ejemplar</span> <span class="tok-n">ejemplar</span> <span class="tok-o">=</span> <span class="tok-n">ejemplarDao</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-mi">3L</span><span class="tok-o">);</span>
        <span class="tok-n">ejemplar</span><span class="tok-o">.</span><span class="tok-na">setCodigoEjemplar</span><span class="tok-o">(</span><span class="tok-n">nuevoCodigo</span><span class="tok-o">);</span>
        <span class="tok-n">ejemplarDao</span><span class="tok-o">.</span><span class="tok-na">update</span><span class="tok-o">(</span><span class="tok-n">ejemplar</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">();</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>

        <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">ejemplarDao</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">EjemplarDao</span><span class="tok-o">(</span><span class="tok-n">em</span><span class="tok-o">);</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">ejemplarDao</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-mi">3L</span><span class="tok-o">).</span><span class="tok-na">getCodigoEjemplar</span><span class="tok-o">().</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">nuevoCodigo</span><span class="tok-o">));</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">getAllEjemplaresDevuelveTodosLosEjemplares</span><span class="tok-o">()</span> <span class="tok-o">{</span> <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">EjemplarDao</span> <span class="tok-n">ejemplarDao</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">EjemplarDao</span><span class="tok-o">(</span><span class="tok-n">em</span><span class="tok-o">);</span>
        <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Ejemplar</span><span class="tok-o">&gt;</span> <span class="tok-n">ejemplares</span> <span class="tok-o">=</span> <span class="tok-n">ejemplarDao</span><span class="tok-o">.</span><span class="tok-na">getAllEjemplares</span><span class="tok-o">();</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">ejemplares</span><span class="tok-o">.</span><span class="tok-na">size</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-mi">4</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span><span class="tok-o">(</span><span class="tok-n">expected</span> <span class="tok-o">=</span> <span class="tok-n">ConstraintViolationException</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">)</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">createEjemplarLanzaExcepcionConLibroNull</span><span class="tok-o">()</span> <span class="tok-o">{</span> <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-k">try</span> <span class="tok-o">{</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">begin</span><span class="tok-o">();</span>
            <span class="tok-n">EjemplarDao</span> <span class="tok-n">ejemplarDao</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">EjemplarDao</span><span class="tok-o">(</span><span class="tok-n">em</span><span class="tok-o">);</span>
            <span class="tok-n">Ejemplar</span> <span class="tok-n">ejemplar</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Ejemplar</span><span class="tok-o">(</span><span class="tok-s">&quot;001&quot;</span><span class="tok-o">,</span> <span class="tok-kc">null</span><span class="tok-o">);</span>
            <span class="tok-n">ejemplarDao</span><span class="tok-o">.</span><span class="tok-na">create</span><span class="tok-o">(</span><span class="tok-n">ejemplar</span><span class="tok-o">);</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">();</span>
        <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">RuntimeException</span> <span class="tok-n">ex</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-na">info</span><span class="tok-o">(</span><span class="tok-s">&quot;Excpeción: &quot;</span> <span class="tok-o">+</span> <span class="tok-n">ex</span><span class="tok-o">.</span><span class="tok-na">getMessage</span><span class="tok-o">());</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">rollback</span><span class="tok-o">();</span>
            <span class="tok-k">throw</span> <span class="tok-n">ex</span><span class="tok-o">;</span>
        <span class="tok-o">}</span> <span class="tok-k">finally</span> <span class="tok-o">{</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@AfterClass</span>
    <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-kt">void</span> <span class="tok-nf">closeEntityManagerFactory</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-na">info</span><span class="tok-o">(</span><span class="tok-s">&quot;Closing JPA EntityManagerFactory&quot;</span><span class="tok-o">);</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">emf</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">)</span>
            <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y las pruebas de la clase <code>PrestadoJuntoCon</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/org.expertojava.jbibrest.persistencia.PrestadoJuntoConTest.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">PrestadoJuntoConDaoTest</span> <span class="tok-o">{</span>
    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">IDatabaseConnection</span> <span class="tok-n">connection</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">IDataSet</span> <span class="tok-n">dataset</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">EntityManagerFactory</span> <span class="tok-n">emf</span><span class="tok-o">;</span>

    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">Log</span> <span class="tok-n">logger</span> <span class="tok-o">=</span> <span class="tok-n">LogFactory</span>
            <span class="tok-o">.</span><span class="tok-na">getLog</span><span class="tok-o">(</span><span class="tok-n">PrestadoJuntoConDaoTest</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>

    <span class="tok-nd">@BeforeClass</span>
    <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-kt">void</span> <span class="tok-nf">initDatabaseTest</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-c1">//</span>
        <span class="tok-c1">// Inicialización</span>
     	<span class="tok-c1">//</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Before</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">cleanDB</span><span class="tok-o">()</span> <span class="tok-kd">throws</span> <span class="tok-n">Exception</span> <span class="tok-o">{</span>
        <span class="tok-c1">// Se hace un &quot;clean insert&quot; de los datos de prueba</span>
        <span class="tok-c1">// definidos en el fichero XML. El &quot;clean insert&quot; vacía las</span>
        <span class="tok-c1">// tablas de los datos de prueba y después inserta los datos</span>
        <span class="tok-n">DatabaseOperation</span><span class="tok-o">.</span><span class="tok-na">CLEAN_INSERT</span><span class="tok-o">.</span><span class="tok-na">execute</span><span class="tok-o">(</span><span class="tok-n">connection</span><span class="tok-o">,</span> <span class="tok-n">dataset</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">findPrestadoJuntoConDaoTest</span><span class="tok-o">()</span> <span class="tok-o">{</span> 
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span><i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-n">PrestadoJuntoConDao</span> <span class="tok-n">juntoConDao</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">PrestadoJuntoConDao</span><span class="tok-o">(</span><span class="tok-n">em</span><span class="tok-o">);</span>
        <span class="tok-n">PrestadoJuntoCon</span> <span class="tok-n">juntoCon</span> <span class="tok-o">=</span> <span class="tok-n">juntoConDao</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-mi">2L</span><span class="tok-o">);</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">juntoCon</span><span class="tok-o">.</span><span class="tok-na">getLibro1</span><span class="tok-o">().</span><span class="tok-na">getTitulo</span><span class="tok-o">().</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-s">&quot;Clean Code&quot;</span><span class="tok-o">));</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">juntoCon</span><span class="tok-o">.</span><span class="tok-na">getLibro2</span><span class="tok-o">().</span><span class="tok-na">getTitulo</span><span class="tok-o">()</span>
                        <span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-s">&quot;Patterns Of Enterprise Application Architecture&quot;</span><span class="tok-o">));</span>
        <span class="tok-n">assertEquals</span><span class="tok-o">(</span><span class="tok-mi">4L</span><span class="tok-o">,</span> <span class="tok-o">(</span><span class="tok-kt">long</span><span class="tok-o">)</span> <span class="tok-n">juntoCon</span><span class="tok-o">.</span><span class="tok-na">getNumVeces</span><span class="tok-o">());</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">librosPrestadosJuntoConDevuelveListaTest</span><span class="tok-o">()</span> <span class="tok-o">{</span> 
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span><i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-n">PrestadoJuntoConDao</span> <span class="tok-n">juntoConDao</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">PrestadoJuntoConDao</span><span class="tok-o">(</span><span class="tok-n">em</span><span class="tok-o">);</span>
        <span class="tok-n">Libro</span> <span class="tok-n">libro</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">LibroDao</span><span class="tok-o">(</span><span class="tok-n">em</span><span class="tok-o">).</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-mi">1L</span><span class="tok-o">);</span>
        <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">PrestadoJuntoCon</span><span class="tok-o">&gt;</span> <span class="tok-n">listaJuntoCon</span> <span class="tok-o">=</span> <span class="tok-n">juntoConDao</span>
                <span class="tok-o">.</span><span class="tok-na">getLibrosPrestadosJuntoCon</span><span class="tok-o">(</span><span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">getId</span><span class="tok-o">());</span>
        <span class="tok-n">assertEquals</span><span class="tok-o">(</span><span class="tok-mi">2L</span><span class="tok-o">,</span> <span class="tok-n">listaJuntoCon</span><span class="tok-o">.</span><span class="tok-na">size</span><span class="tok-o">());</span>
        <span class="tok-kt">long</span> <span class="tok-n">total</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-o">;</span>
        <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">PrestadoJuntoCon</span> <span class="tok-n">juntoCon</span> <span class="tok-o">:</span> <span class="tok-n">listaJuntoCon</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">total</span> <span class="tok-o">=</span> <span class="tok-n">total</span> <span class="tok-o">+</span> <span class="tok-n">juntoCon</span><span class="tok-o">.</span><span class="tok-na">getNumVeces</span><span class="tok-o">();</span>
        <span class="tok-o">}</span>
        <span class="tok-n">assertEquals</span><span class="tok-o">(</span><span class="tok-mi">6L</span><span class="tok-o">,</span> <span class="tok-n">total</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">librosPrestadosJuntoConDevuelveOrdenadosTest</span><span class="tok-o">()</span> <span class="tok-o">{</span> 
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span><i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-n">PrestadoJuntoConDao</span> <span class="tok-n">juntoConDao</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">PrestadoJuntoConDao</span><span class="tok-o">(</span><span class="tok-n">em</span><span class="tok-o">);</span>
        <span class="tok-n">Libro</span> <span class="tok-n">libro</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">LibroDao</span><span class="tok-o">(</span><span class="tok-n">em</span><span class="tok-o">).</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-mi">1L</span><span class="tok-o">);</span>
        <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">PrestadoJuntoCon</span><span class="tok-o">&gt;</span> <span class="tok-n">listaJuntoCon</span> <span class="tok-o">=</span> <span class="tok-n">juntoConDao</span>
                <span class="tok-o">.</span><span class="tok-na">getLibrosPrestadosJuntoCon</span><span class="tok-o">(</span><span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">getId</span><span class="tok-o">());</span>
        <span class="tok-n">assertEquals</span><span class="tok-o">(</span><span class="tok-mi">2L</span><span class="tok-o">,</span> <span class="tok-n">listaJuntoCon</span><span class="tok-o">.</span><span class="tok-na">size</span><span class="tok-o">());</span>
        <span class="tok-kt">boolean</span> <span class="tok-n">ordenado</span> <span class="tok-o">=</span> <span class="tok-kc">true</span><span class="tok-o">;</span>
        <span class="tok-n">Integer</span> <span class="tok-n">nVecesPrevio</span> <span class="tok-o">=</span> <span class="tok-n">Integer</span><span class="tok-o">.</span><span class="tok-na">MAX_VALUE</span><span class="tok-o">;</span>
        <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">PrestadoJuntoCon</span> <span class="tok-n">juntoCon</span> <span class="tok-o">:</span> <span class="tok-n">listaJuntoCon</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">juntoCon</span><span class="tok-o">.</span><span class="tok-na">getNumVeces</span><span class="tok-o">()</span> <span class="tok-o">&gt;</span> <span class="tok-n">nVecesPrevio</span><span class="tok-o">)</span> <span class="tok-o">{</span>
                <span class="tok-n">ordenado</span> <span class="tok-o">=</span> <span class="tok-kc">false</span><span class="tok-o">;</span>
                <span class="tok-k">break</span><span class="tok-o">;</span>
            <span class="tok-o">}</span>
            <span class="tok-n">nVecesPrevio</span> <span class="tok-o">=</span> <span class="tok-n">juntoCon</span><span class="tok-o">.</span><span class="tok-na">getNumVeces</span><span class="tok-o">();</span>
        <span class="tok-o">}</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">ordenado</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@AfterClass</span>
    <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-kt">void</span> <span class="tok-nf">closeEntityManagerFactory</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-na">info</span><span class="tok-o">(</span><span class="tok-s">&quot;Closing JPA EntityManagerFactory&quot;</span><span class="tok-o">);</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">emf</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">)</span>
            <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
¡¡No te limites a copiar y pegar!! Es imprescindible que leas bien el código y entiendas qué se está probando en cada test.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_capa_de_lógica_de_negocio">3.2.2. Capa de lógica de negocio</h4>
<div class="paragraph">
<p>Una vez definida la capa de persistencia, vamos a implementar los siguientes métodos de negocio en esta primera iteración:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Listado de libros: se devuelve la lista de todos los libros</p>
</li>
<li>
<p>Libros recomendados: se pasa el <em>identificador del libro</em> y un número <em>n</em> de recomendaciones deseadas. Se devuelve la lista de esos <em>n</em> libros que más se han prestado junto con el libro inicial.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Los métodos de negocio los vamos a definir en enterprise beans, que van a proporcionar transaccionalidad en las llamadas a distintas clases DAOs.</p>
</div>
<div class="paragraph">
<p>Vamos a probar la capa de negocio de dos formas. Primero lo haremos accediendo al método desde un servlet y mostrando los resultados en una página web. Y la otra, más correcta, usando Arquillian.</p>
</div>
</div>
<div class="sect3">
<h4 id="_clase_de_servicio">3.2.3. Clase de servicio</h4>
<div class="paragraph">
<p>Creamos en el paquete <code>org.expertojava.proyint.servicio</code> la clase <code>LibroServicio</code>, un bean de sesión sin estado que contiene los métodos <code>listaLibros()</code> y <code>listaRecomendaciones()</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org.expertojava.jbibrest.servicio.LibroServicio</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">servicio</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.modelo.Libro</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.modelo.PrestadoJuntoCon</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.persistencia.LibroDao</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.persistencia.PrestadoJuntoConDao</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.ejb.Stateless</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManager</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.PersistenceContext</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.ArrayList</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.List</span><span class="tok-o">;</span>

<span class="tok-nd">@Stateless</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">LibroServicio</span> <span class="tok-o">{</span>
    <span class="tok-nd">@PersistenceContext</span><span class="tok-o">(</span><span class="tok-n">unitName</span> <span class="tok-o">=</span> <span class="tok-s">&quot;biblioteca&quot;</span><span class="tok-o">)</span>
    <span class="tok-n">EntityManager</span> <span class="tok-n">em</span><span class="tok-o">;</span>

    <span class="tok-kd">public</span> <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Libro</span><span class="tok-o">&gt;</span> <span class="tok-nf">listaLibros</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">LibroDao</span> <span class="tok-n">libroDao</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">LibroDao</span><span class="tok-o">(</span><span class="tok-n">em</span><span class="tok-o">);</span>
        <span class="tok-k">return</span> <span class="tok-n">libroDao</span><span class="tok-o">.</span><span class="tok-na">getAllLibros</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">PrestadoJuntoCon</span><span class="tok-o">&gt;</span> <span class="tok-nf">listaRecomendaciones</span><span class="tok-o">(</span><span class="tok-n">Long</span> <span class="tok-n">libroId</span><span class="tok-o">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">PrestadoJuntoCon</span><span class="tok-o">&gt;</span> <span class="tok-n">listaDevuelta</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">ArrayList</span><span class="tok-o">&lt;&gt;();</span>
        <span class="tok-n">PrestadoJuntoConDao</span> <span class="tok-n">juntoConDao</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">PrestadoJuntoConDao</span><span class="tok-o">(</span><span class="tok-n">em</span><span class="tok-o">);</span>
        <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">PrestadoJuntoCon</span><span class="tok-o">&gt;</span> <span class="tok-n">listaJuntoCon</span> <span class="tok-o">=</span> <span class="tok-n">juntoConDao</span>
                <span class="tok-o">.</span><span class="tok-na">getLibrosPrestadosJuntoCon</span><span class="tok-o">(</span><span class="tok-n">libroId</span><span class="tok-o">);</span>

	<span class="tok-c1">// Llenamos la lista a devolver hasta el número de</span>
	<span class="tok-c1">// libros solicitados</span>

        <span class="tok-kt">int</span> <span class="tok-n">anyadidos</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-o">;</span>
        <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">PrestadoJuntoCon</span> <span class="tok-n">juntoCon</span> <span class="tok-o">:</span> <span class="tok-n">listaJuntoCon</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">anyadidos</span> <span class="tok-o">==</span> <span class="tok-n">n</span><span class="tok-o">)</span> <span class="tok-k">break</span><span class="tok-o">;</span>
            <span class="tok-n">listaDevuelta</span><span class="tok-o">.</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-n">juntoCon</span><span class="tok-o">);</span>
            <span class="tok-n">anyadidos</span><span class="tok-o">++;</span>
        <span class="tok-o">}</span>
        <span class="tok-k">return</span> <span class="tok-n">listaDevuelta</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Tal y como hemos visto en el módulo de componentes enterprise, el bean obtiene el <em>entity manager</em> por inyección de dependencias y lo utiliza en los métodos de negocio. Cada método de negocio se ejecuta dentro de una transacción que crea automáticamente el servidor de aplicaciones.</p>
</div>
</div>
<div class="sect3">
<h4 id="_prueba_desde_un_servlet">3.2.4. Prueba desde un servlet</h4>
<div class="paragraph">
<p>Para probar el bean desde un servlet debemos añadir en el módulo el directorio <code>src/main/webapp</code> con el directorio <code>WEB-INF</code> que contiene el fichero <code>web.xml</code> vacío:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/WEB-INF/web.xml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tok-nt">&lt;web-app</span> <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://java.sun.com/xml/ns/javaee&quot;</span>
           <span class="tok-na">xmlns:xsi=</span><span class="tok-s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
           <span class="tok-na">xsi:schemaLocation=</span><span class="tok-s">&quot;http://java.sun.com/xml/ns/javaee</span>
<span class="tok-s">		  http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;</span>
           <span class="tok-na">version=</span><span class="tok-s">&quot;3.0&quot;</span><span class="tok-nt">&gt;</span>

<span class="tok-nt">&lt;/web-app&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Añadimos también el fichero <code>src/main/webapp/index.jsp</code> desde donde lanzamos las peticiones a los servlets:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/index.jsp</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-cp">&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.0 Transitional//EN&quot;&gt;</span>
<span class="tok-nt">&lt;html&gt;</span>
    <span class="tok-nt">&lt;head&gt;</span>
        <span class="tok-nt">&lt;title&gt;</span>Start Page<span class="tok-nt">&lt;/title&gt;</span>
        <span class="tok-nt">&lt;meta</span> <span class="tok-na">http-equiv=</span><span class="tok-s">&quot;Content-Type&quot;</span> <span class="tok-na">content=</span><span class="tok-s">&quot;text/html&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;/head&gt;</span>
    <span class="tok-nt">&lt;body&gt;</span>
        <span class="tok-nt">&lt;h1&gt;</span>Pruebas métodos de negocio<span class="tok-nt">&lt;/h1&gt;</span>
        <span class="tok-nt">&lt;hr/&gt;</span>
        <span class="tok-nt">&lt;p&gt;&lt;a</span> <span class="tok-na">href=</span><span class="tok-s">&quot;&lt;%=request.getContextPath()%&gt;/listalibros&quot;</span><span class="tok-nt">&gt;</span>Listado de libros<span class="tok-nt">&lt;/a&gt;&lt;/p&gt;</span>
        <span class="tok-nt">&lt;hr/&gt;</span>
        <span class="tok-nt">&lt;form</span> <span class="tok-na">action=</span><span class="tok-s">&quot;&lt;%=request.getContextPath()%&gt;/listarecomendaciones&quot;</span><span class="tok-nt">&gt;</span>
            <span class="tok-nt">&lt;p&gt;</span>Identificador del libro: <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;libroId&quot;</span><span class="tok-nt">&gt;&lt;/p&gt;</span>
            <span class="tok-nt">&lt;p&gt;</span>Número de recomendaciones: <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;numRecomendaciones&quot;</span><span class="tok-nt">&gt;&lt;/p&gt;</span>
            <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;submit&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;Enviar&quot;</span><span class="tok-nt">&gt;</span>
        <span class="tok-nt">&lt;/form&gt;</span>
        <span class="tok-nt">&lt;/form&gt;</span>
        <span class="tok-nt">&lt;hr/&gt;</span>
    <span class="tok-nt">&lt;/body&gt;</span>
<span class="tok-nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y añadimos los dos servlets que realizan la llamada a los métodos de negocio. En primer lugar <code>src/main/java/org.expertojava.jbibrest.ListadoLibros</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org.expertojava.jbibrest.ListadoLibros.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.modelo.Libro</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.servicio.LibroServicio</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.ejb.EJB</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.ServletException</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.annotation.WebServlet</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.http.HttpServlet</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.http.HttpServletRequest</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.http.HttpServletResponse</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.io.IOException</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.io.PrintWriter</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.List</span><span class="tok-o">;</span>

<span class="tok-nd">@WebServlet</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;listalibros&quot;</span><span class="tok-o">,</span> <span class="tok-n">urlPatterns</span><span class="tok-o">=</span><span class="tok-s">&quot;/listalibros&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">ListadoLibros</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span> <span class="tok-o">{</span>

    <span class="tok-nd">@EJB</span>
    <span class="tok-n">LibroServicio</span> <span class="tok-n">libroServicio</span><span class="tok-o">;</span> <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">doPost</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                          <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>  <span class="tok-kd">throws</span>
            <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>

    <span class="tok-o">}</span>

    <span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                         <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span> <span class="tok-kd">throws</span>
    <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>

        <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Libro</span><span class="tok-o">&gt;</span> <span class="tok-n">listaLibros</span>
                <span class="tok-o">=</span> <span class="tok-n">libroServicio</span><span class="tok-o">.</span><span class="tok-na">listaLibros</span><span class="tok-o">();</span> <i class="conum" data-value="2"></i><b>(2)</b>

        <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setContentType</span><span class="tok-o">(</span><span class="tok-s">&quot;text/html&quot;</span><span class="tok-o">);</span>

        <span class="tok-n">PrintWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;!DOCTYPE HTML PUBLIC \&quot;&quot;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;-//W3C//DTD HTML 4.0 &quot;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;Transitional//EN\&quot;&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;HTML&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;BODY&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;ul&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">Libro</span> <span class="tok-n">libro</span> <span class="tok-o">:</span> <span class="tok-n">listaLibros</span> <span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;li&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">getAutor</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-s">&quot; : &quot;</span> <span class="tok-o">+</span> <span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">getTitulo</span><span class="tok-o">());</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/li&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-o">}</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/ul&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/BODY&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/HTML&quot;</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Inyección del bean enterprise</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Llamada al método de negocio del bean</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Y en segundo lugar <code>src/main/java/org.expertojava.jbibrest.ListaRecomendaciones</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org.expertojava.jbibrest.ListaRecomendaciones.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.modelo.PrestadoJuntoCon</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.servicio.LibroServicio</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.ejb.EJB</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.ServletException</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.annotation.WebServlet</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.http.HttpServlet</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.http.HttpServletRequest</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.http.HttpServletResponse</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.io.IOException</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.io.PrintWriter</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.List</span><span class="tok-o">;</span>

<span class="tok-nd">@WebServlet</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;listarecomendaciones&quot;</span><span class="tok-o">,</span> <span class="tok-n">urlPatterns</span><span class="tok-o">=</span><span class="tok-s">&quot;/listarecomendaciones&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">ListaRecomendaciones</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span> <span class="tok-o">{</span>

    <span class="tok-nd">@EJB</span>
    <span class="tok-n">LibroServicio</span> <span class="tok-n">libroServicio</span><span class="tok-o">;</span>

    <span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">doPost</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                          <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>  <span class="tok-kd">throws</span>
            <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>

    <span class="tok-o">}</span>

    <span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                         <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span> <span class="tok-kd">throws</span>
    <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>

        <span class="tok-n">Long</span> <span class="tok-n">libroId</span> <span class="tok-o">=</span> <span class="tok-n">Long</span><span class="tok-o">.</span><span class="tok-na">valueOf</span><span class="tok-o">(</span><span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;libroId&quot;</span><span class="tok-o">));</span>
        <span class="tok-kt">int</span> <span class="tok-n">nRec</span> <span class="tok-o">=</span> <span class="tok-n">Integer</span><span class="tok-o">.</span><span class="tok-na">valueOf</span><span class="tok-o">(</span><span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;numRecomendaciones&quot;</span><span class="tok-o">));</span>

        <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">PrestadoJuntoCon</span><span class="tok-o">&gt;</span> <span class="tok-n">listaRecomendaciones</span>
                <span class="tok-o">=</span> <span class="tok-n">libroServicio</span><span class="tok-o">.</span><span class="tok-na">listaRecomendaciones</span><span class="tok-o">(</span><span class="tok-n">libroId</span><span class="tok-o">,</span><span class="tok-n">nRec</span><span class="tok-o">);</span>

        <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setContentType</span><span class="tok-o">(</span><span class="tok-s">&quot;text/html&quot;</span><span class="tok-o">);</span>

        <span class="tok-n">PrintWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;!DOCTYPE HTML PUBLIC \&quot;&quot;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;-//W3C//DTD HTML 4.0 &quot;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;Transitional//EN\&quot;&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;HTML&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;BODY&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;p&gt; El libro &quot;</span> <span class="tok-o">+</span> <span class="tok-n">listaRecomendaciones</span>
                <span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">).</span><span class="tok-na">getLibro1</span><span class="tok-o">().</span><span class="tok-na">getTitulo</span><span class="tok-o">()</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot; se ha prestado junto con: &lt;/p&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;ul&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">PrestadoJuntoCon</span> <span class="tok-n">prestadoCon</span> <span class="tok-o">:</span> <span class="tok-n">listaRecomendaciones</span> <span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;li&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">prestadoCon</span><span class="tok-o">.</span><span class="tok-na">getLibro2</span><span class="tok-o">().</span><span class="tok-na">getTitulo</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-s">&quot; : &quot;</span> <span class="tok-o">+</span>
                    <span class="tok-n">prestadoCon</span><span class="tok-o">.</span><span class="tok-na">getNumVeces</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-s">&quot; veces&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/li&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-o">}</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/ul&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/BODY&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/HTML&quot;</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_prueba_con_arquillian">3.2.5. Prueba con Arquillian</h4>
<div class="paragraph">
<p>Para probar los métodos de servicio desde Arquillian debemos seguir los siguientes pasos.</p>
</div>
<div class="paragraph">
<p>En primer lugar, añadimos las dependencias necesarias en el fichero POM del proyecto Maven:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="xml">    ...

    <span class="tok-nt">&lt;properties&gt;</span>
        <span class="tok-nt">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span class="tok-nt">&lt;/project.build.sourceEncoding&gt;</span>
    <span class="tok-nt">&lt;/properties&gt;</span>

    <span class="tok-nt">&lt;dependencyManagement&gt;</span>
        <span class="tok-nt">&lt;dependencies&gt;</span>
            <span class="tok-nt">&lt;dependency&gt;</span>
                <span class="tok-nt">&lt;groupId&gt;</span>org.jboss.arquillian<span class="tok-nt">&lt;/groupId&gt;</span>
                <span class="tok-nt">&lt;artifactId&gt;</span>arquillian-bom<span class="tok-nt">&lt;/artifactId&gt;</span>
                <span class="tok-nt">&lt;version&gt;</span>1.1.4.Final<span class="tok-nt">&lt;/version&gt;</span>
                <span class="tok-nt">&lt;scope&gt;</span>import<span class="tok-nt">&lt;/scope&gt;</span>
                <span class="tok-nt">&lt;type&gt;</span>pom<span class="tok-nt">&lt;/type&gt;</span>
            <span class="tok-nt">&lt;/dependency&gt;</span>
        <span class="tok-nt">&lt;/dependencies&gt;</span>
    <span class="tok-nt">&lt;/dependencyManagement&gt;</span>

   <span class="tok-nt">&lt;dependencies&gt;</span>

   ...

    <span class="tok-c">&lt;!-- Arquillian --&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.jboss.arquillian.junit<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>arquillian-junit-container<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>1.1.5.Final<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.wildfly<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>wildfly-arquillian-container-remote<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>8.1.0.Final<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

     ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Después añadimos en el directorio <code>test/resources</code> el fichero <code>persistence-datasource.xml</code> que es una copia del <code>persistence.xml</code> usado en tiempo de ejecución. Lo usaremos para que Arquillian lo copie en el war que despliega en el servidor de aplicaciones.</p>
</div>
<div class="paragraph">
<p>Configuramos el modo de cargar la base de datos con <code>update</code> para mantener los datos que introduce DbUnit en la ejecución de los tests de persistencia.</p>
</div>
<div class="listingblock">
<div class="title">test/resources/persistence-datasource.xml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tok-nt">&lt;persistence</span> <span class="tok-na">version=</span><span class="tok-s">&quot;2.0&quot;</span>
             <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://java.sun.com/xml/ns/persistence&quot;</span> <span class="tok-na">xmlns:xsi=</span><span class="tok-s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
             <span class="tok-na">xsi:schemaLocation=</span><span class="tok-s">&quot;</span>
<span class="tok-s">        http://java.sun.com/xml/ns/persistence</span>
<span class="tok-s">        http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;persistence-unit</span> <span class="tok-na">name=</span><span class="tok-s">&quot;biblioteca&quot;</span><span class="tok-nt">&gt;</span>

        <span class="tok-nt">&lt;provider&gt;</span>org.hibernate.jpa.HibernatePersistenceProvider<span class="tok-nt">&lt;/provider&gt;</span>

        <span class="tok-nt">&lt;jta-data-source&gt;</span>java:/datasources/BibliotecaDS<span class="tok-nt">&lt;/jta-data-source&gt;</span>
        <span class="tok-nt">&lt;class&gt;</span>org.expertojava.jbibrest.modelo.Libro<span class="tok-nt">&lt;/class&gt;</span>
        <span class="tok-nt">&lt;class&gt;</span>org.expertojava.jbibrest.modelo.Ejemplar<span class="tok-nt">&lt;/class&gt;</span>
        <span class="tok-nt">&lt;class&gt;</span>org.expertojava.jbibrest.modelo.PrestadoJuntoCon<span class="tok-nt">&lt;/class&gt;</span>
        <span class="tok-nt">&lt;class&gt;</span>org.expertojava.jbibrest.modelo.Usuario<span class="tok-nt">&lt;/class&gt;</span>
        <span class="tok-nt">&lt;class&gt;</span>org.expertojava.jbibrest.modelo.Alumno<span class="tok-nt">&lt;/class&gt;</span>
        <span class="tok-nt">&lt;class&gt;</span>org.expertojava.jbibrest.modelo.Profesor<span class="tok-nt">&lt;/class&gt;</span>
        <span class="tok-nt">&lt;class&gt;</span>org.expertojava.jbibrest.modelo.Prestamo<span class="tok-nt">&lt;/class&gt;</span>
        <span class="tok-nt">&lt;class&gt;</span>org.expertojava.jbibrest.modelo.Multa<span class="tok-nt">&lt;/class&gt;</span>

        <span class="tok-nt">&lt;properties&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.dialect&quot;</span>
                      <span class="tok-na">value=</span><span class="tok-s">&quot;org.hibernate.dialect.MySQLDialect&quot;</span><span class="tok-nt">/&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.hbm2ddl.auto&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;update&quot;</span> <span class="tok-nt">/&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.show_sql&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;true&quot;</span> <span class="tok-nt">/&gt;</span>
        <span class="tok-nt">&lt;/properties&gt;</span>
    <span class="tok-nt">&lt;/persistence-unit&gt;</span>
<span class="tok-nt">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configuramos el modo de cargar la base de datos con <code>update</code> para mantener los datos que introduce DbUnit en la ejecución de los tests de persistencia.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Por último, definimos el test con Arquillian:</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/org.expertojava.jbibrest.servicio.LibroServicioTest</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">servicio</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.apache.commons.logging.Log</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.apache.commons.logging.LogFactory</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.modelo.Libro</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.persistencia.LibroDao</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.utils.BibliotecaBR</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.arquillian.junit.Arquillian</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.arquillian.container.test.api.Deployment</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.shrinkwrap.api.Archive</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.shrinkwrap.api.ShrinkWrap</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.shrinkwrap.api.asset.EmptyAsset</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.shrinkwrap.api.spec.WebArchive</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.junit.Test</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.junit.runner.RunWith</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.ejb.EJB</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">junit</span><span class="tok-o">.</span><span class="tok-na">Assert</span><span class="tok-o">.</span><span class="tok-na">assertEquals</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">junit</span><span class="tok-o">.</span><span class="tok-na">Assert</span><span class="tok-o">.</span><span class="tok-na">assertTrue</span><span class="tok-o">;</span>

<span class="tok-nd">@RunWith</span><span class="tok-o">(</span><span class="tok-n">Arquillian</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">LibroServicioTest</span> <span class="tok-o">{</span>
    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">Log</span> <span class="tok-n">logger</span> <span class="tok-o">=</span> <span class="tok-n">LogFactory</span>
            <span class="tok-o">.</span><span class="tok-na">getLog</span><span class="tok-o">(</span><span class="tok-n">LibroServicioTest</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>

    <span class="tok-nd">@EJB</span>
    <span class="tok-n">LibroServicio</span> <span class="tok-n">libroServicio</span><span class="tok-o">;</span>

    <span class="tok-nd">@Deployment</span>
    <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-n">Archive</span><span class="tok-o">&lt;?&gt;</span> <span class="tok-n">deployment</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">ShrinkWrap</span><span class="tok-o">.</span><span class="tok-na">create</span><span class="tok-o">(</span><span class="tok-n">WebArchive</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-s">&quot;test.war&quot;</span><span class="tok-o">)</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">Libro</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">BibliotecaBR</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">LibroDao</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">LibroServicio</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addAsResource</span><span class="tok-o">(</span><span class="tok-s">&quot;persistence-datasource.xml&quot;</span><span class="tok-o">,</span>
                        <span class="tok-s">&quot;META-INF/persistence.xml&quot;</span><span class="tok-o">)</span>
                <span class="tok-o">.</span><span class="tok-na">addAsWebInfResource</span><span class="tok-o">(</span><span class="tok-n">EmptyAsset</span><span class="tok-o">.</span><span class="tok-na">INSTANCE</span><span class="tok-o">,</span> <span class="tok-s">&quot;beans.xml&quot;</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">listaLibrosTraeTodosLosLibrosTest</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-na">info</span><span class="tok-o">(</span><span class="tok-s">&quot;Test: listaLibrosTraeTodosLosLibros&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">assertEquals</span><span class="tok-o">(</span><span class="tok-mi">3L</span><span class="tok-o">,</span> <span class="tok-o">(</span><span class="tok-kt">long</span><span class="tok-o">)</span> <span class="tok-n">libroServicio</span><span class="tok-o">.</span><span class="tok-na">listaLibros</span><span class="tok-o">().</span><span class="tok-na">size</span><span class="tok-o">());</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">listaRecomendacionesTraeRecomendaciones</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">PrestadoJuntoCon</span><span class="tok-o">&gt;</span> <span class="tok-n">prestadoCon</span> <span class="tok-o">=</span>
	         <span class="tok-n">libroServicio</span><span class="tok-o">.</span><span class="tok-na">listaRecomendaciones</span><span class="tok-o">(</span><span class="tok-mi">1L</span><span class="tok-o">,</span> <span class="tok-mi">3</span><span class="tok-o">);</span>
        <span class="tok-n">assertEquals</span><span class="tok-o">(</span><span class="tok-mi">2L</span><span class="tok-o">,</span> <span class="tok-n">prestadoCon</span><span class="tok-o">.</span><span class="tok-na">size</span><span class="tok-o">());</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_resto_de_iteraciones">3.3. Resto de iteraciones</h3>
<div class="paragraph">
<p>Una vez que hemos realizado de forma guiada la primera iteración, debes completar el resto del proyecto siguiendo las pautas anteriores.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Debido a la complejidad de realizar tests sobre EJBs con restricciones de seguridad, definiremos las restricciones de acceso en la capa REST. De esta forma todas las funciones de la capa de negocio (EJB) se podrán testear sin realizar ninguna autenticación.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Las funcionalidades que faltan por implementar son:</p>
</div>
<div class="paragraph">
<p><strong>Operaciones en la clase <code>UsuarioServicio</code> (que restringiremos en la capa REST a usuarios y bibliotecarios)</strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Obtener información actual de un usuario: se pasa el <em>login del usuario</em> y se obtienen sus datos, su identificador, su estado, num. todos sus préstamos, todas sus multas (incluidos préstamos y multas históricas), etc.</p>
</li>
<li>
<p>Obener lista de préstamos de un un usuario: se pasa el <em>identificador del usuario</em> y devuelve la colección de libros (libro y ejemplar) que tiene prestados un usuario</p>
</li>
<li>
<p>Solicitar un préstamo de un libro: se pasa el <em>identificador del usuario</em> y el <em>identificador del libro</em> y se realiza el préstamo de un ejemplar disponible si el ejemplar está disponible. Se lanza un error si no hay ejemplares disponibles, si el usuario está multado o si supera el número de préstamos permitidos. Si se ha realizado el préstamo con éxito se devuelven los datos del nuevo préstamo.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Operación en la clase <code>BibliotecarioServicio</code> (que restringiremos en la capa REST a bibliotecarios)</strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Realizar la devolución de un ejemplar: se pasa el <em>identificador de ejemplar</em>, se cierra el préstamo y se crea una multa si la devolución está fuera de plazo. Se devuelve un enumerado con el resultado de la devolución: <code>DEVOLUCIÓN_CORRECTA</code> o <code>DEVOLUCIÓN_FUERA_DE_PLAZO</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Operaciones en la clase <code>LibroServicio</code> (que no restringiremos en la capa REST)</strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Búsqueda de libros por autor: se pasa una cadena de texto y se devuelve la lista de libros que tienen un autor cuyo nombre contiene esa cadena de texto</p>
</li>
<li>
<p>Búsqueda de libros por título: se pasa una cadena de texto y se devuelve la lista de libros cuyo título contiene esa cadena de texto</p>
</li>
<li>
<p>Búsqueda de libro por identificador: se pasa el <em>identificador del libro</em> y se devuelven los detalles del libro y una colección con sus ejemplares</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Para implementar estas funcionalidades tendrás que:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Añadir las anotaciones JPA a las clases restantes y completar el fichero de pruebas <code>PersistenciaTest</code> con pruebas de las relaciones y de las restricciones:</p>
<div class="ulist">
<ul>
<li>
<p><code>Usuario</code> (abstracta) y su relación de herencia con <code>Alumno</code> y <code>Profesor</code></p>
</li>
<li>
<p><code>Prestamo</code></p>
</li>
<li>
<p><code>Multa</code></p>
</li>
<li>
<p><code>Bibliotecario</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Crear las clases DAO y los ficheros de pruebas correspondientes:</p>
<div class="ulist">
<ul>
<li>
<p><code>UsuarioDao</code></p>
</li>
<li>
<p><code>PrestamoDao</code></p>
</li>
<li>
<p><code>MultaDao</code></p>
</li>
<li>
<p><code>BibliotecarioDao</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Crear los enterprise beans con los métodos de negocio:</p>
<div class="ulist">
<ul>
<li>
<p><code>UsuarioServicio</code>:</p>
<div class="ulist">
<ul>
<li>
<p><code>recuperarUsuario(String login)</code></p>
</li>
<li>
<p><code>prestamosActivos(Long idUsuario)</code></p>
</li>
<li>
<p><code>obtenerPrestamo(Long idUsuario, Long idLibro)</code></p>
</li>
</ul>
</div>
</li>
<li>
<p><code>BibliotecarioServicio</code>:</p>
<div class="ulist">
<ul>
<li>
<p><code>devolverEjemplar(Long idUsuario, Long idEjemplar)</code></p>
</li>
</ul>
</div>
</li>
<li>
<p><code>LibroServicio</code> (completar):</p>
<div class="ulist">
<ul>
<li>
<p><code>buscarLibrosAutor(String autor)</code></p>
</li>
<li>
<p><code>buscarLibrosTitulo(String titulo)</code></p>
</li>
<li>
<p><code>obtenerLibro(Long idLibro)</code></p>
<div class="paragraph">
<p>Para devolver resultados erróneos (por ejemplo, si se llama a <code>obtenerPrestamo</code> por un usuario multado) deberás lanzar una excepción en el método del bean. Puedes añadir nuevas excepciones, que hereden de la clase <code>BibliotecaException</code>. Esas excepciones se capturarán en la capa de servicio REST y se devolverán formateadas y con un código de error HTTP.</p>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Deberás crear los tests Arquillian correspondientes para comprobar que funcionan correctamente los métodos de negocio. Si lo crees conveniente puedes también añadir algún servlet adicional con el que probarlos manualmente.</p>
<div class="paragraph">
<p>En las pruebas de Arquillian en las que debas modificar la base de datos deberás hacer un <em>rollback</em> una vez terminado el test, para dejar todos los datos sin modificar y que un test no afecte al resto. Por ejemplo, el siguiente test comprueba que un libro se crea (llamando a un supuesto método de negocio <code>nuevoLibro</code>) y que después se obtiene correctamente. Al final se hace un <code>setRollbackOnly</code> para que el servidor de aplicaciones deshaga la transacción y deje la base de datos como estaba al principio.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Test</span>
<span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">creaNuevoLibroYEncuentraloTest</span><span class="tok-o">()</span> <span class="tok-kd">throws</span> <span class="tok-n">SystemException</span><span class="tok-o">,</span> <span class="tok-n">NotSupportedException</span> <span class="tok-o">{</span>
    <span class="tok-n">userTransaction</span><span class="tok-o">.</span><span class="tok-na">begin</span><span class="tok-o">();</span>
    <span class="tok-n">Libro</span> <span class="tok-n">libro</span> <span class="tok-o">=</span> <span class="tok-n">libroServicio</span><span class="tok-o">.</span><span class="tok-na">nuevoLibro</span><span class="tok-o">(</span><span class="tok-s">&quot;0201485672&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Martin Fowler&quot;</span><span class="tok-o">,</span>
         <span class="tok-s">&quot;Refactoring: Improving the Design of Existing Code&quot;</span><span class="tok-o">);</span>
    <span class="tok-n">Libro</span> <span class="tok-n">libro2</span> <span class="tok-o">=</span> <span class="tok-n">libroServicio</span><span class="tok-o">.</span><span class="tok-na">obtenerLibro</span><span class="tok-o">(</span><span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">getId</span><span class="tok-o">());</span>
    <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">libro2</span><span class="tok-o">));</span>
    <span class="tok-n">userTransaction</span><span class="tok-o">.</span><span class="tok-na">setRollbackOnly</span><span class="tok-o">();</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_entrega">3.3.1. Entrega</h4>
<div class="paragraph">
<p>La fecha de entrega del proyecto será el jueves 8 de enero.</p>
</div>
<div class="paragraph">
<p>Añade la etiqueta <code>sesion-2</code> al respositorio después de hacer el último commit y sube los cambios al repositorio <code>jbibrest-proyint-expertojava</code> en Bitbucket:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> git tag -a sesion-2 -m <span class="tok-s2">&quot;Sesión 2&quot;</span>
<span class="tok-gp">$</span> git push origin --tags</code></pre>
</div>
</div>
<div class="paragraph">
<p>Recuerda dar premiso de lectura al usuario <strong>entregas-expertojava</strong> y confirmar la entrega en Moodle.
&lt;&lt;&lt;</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion03">4. (1,5 puntos) Servicio REST</h2>
<div class="sectionbody">
<div class="paragraph">
<p>En esta sesión continuaremos trabajando con la parte del servidor del proyecto de integración. Implementaremos la capa REST del proyecto, utilizando JAX-RS para definir el API y basándonos en las funcionalidades implementadas en la capa de negocio de la sesión anterior. Las características básicas del API REST a desarrollar serán:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Interfaz REST a las funcionalidades implementadas por los EJBs de la capa de negocio</p>
</li>
<li>
<p>Trabaja con objetos JSON</p>
</li>
<li>
<p>Implementa el login y las restricciones de seguridad usando el método BASIC</p>
</li>
<li>
<p>Convierte las excepciones generadas por las capas inferiores en códigos de error HTTP</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Todas las clases necesarias las crearemos en el paquete <code>org.expertojava.jbibrest.rest</code>.</p>
</div>
<div class="paragraph">
<p>Todas las URIs de las peticiones tendrán el prefijo <code>/jbib-rest/api/</code>. Por ejemplo: <code>GET http&#58;//&lt;servidor&gt;/jbib-rest/api/libros/0321127420</code>.</p>
</div>
<div class="paragraph">
<p>Es interesante consultar algunos ejemplos de APIs REST que trabajan con JSON. Algunas sencillas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The Star Wars API: <a href="http://swapi.co">http://swapi.co</a></p>
</li>
<li>
<p>Pokemon API: <a href="http://pokeapi.co">http://pokeapi.co</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Otras algo más complicadas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>OpenWeatherMap: <a href="http://openweathermap.org/api">http://openweathermap.org/api</a></p>
</li>
<li>
<p>Marvel: <a href="http://developer.marvel.com">http://developer.marvel.com</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_pantallas_y_esquema_de_navegación_del_cliente">4.1. Pantallas y esquema de navegación del cliente</h3>
<div class="paragraph">
<p>Para poner en contexto el API REST que vamos a desarrollar, es conveniente considerar cómo va a ser utilizada desde la aplicación cliente. La aplicación cliente tendrá las siguientes pantallas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Login</p>
</li>
<li>
<p>Listado de libros</p>
</li>
<li>
<p>Listado de préstamos activos y multa activa</p>
</li>
<li>
<p>Detalle de libro</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Se podrá navegar entre ellas según el siguiente esquema:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint03/esquema-navegacion.png" alt="" width="66%">
</div>
</div>
<div class="sect3">
<h4 id="_acceso">4.1.1. Acceso</h4>
<div class="paragraph">
<p>Llamará al método <code>GET /usuarios/{usuario}</code>. <code>{usuario}</code> es el login del usuario, no su ID. Si devuelve error 401 nos mantenemos en la página. Cualquier error 401 en cualquier otra petición redirige aquí, Si devuelve información del usuario, vamos al listado de libros.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint03/login.png" alt="" width="66%">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_listado_de_libros">4.1.2. Listado de libros</h4>
<div class="paragraph">
<p>Se devuelven todos los libros y se hace la paginación en el cliente.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint03/listado-libros.png" alt="" width="66%">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_detalle_de_libro">4.1.3. Detalle de libro</h4>
<div class="paragraph">
<p>Llamará tanto a <code>GET /libros/{isbn}</code> como a <code>GET /libros/{isbn}/recomendaciones?numrec=3</code>. Aprovecharemos el mismo componente del listado de libros para las recomendaciones.</p>
</div>
<div class="paragraph">
<p>El botón de pedir préstamo sólo aparecerá si el libro tiene ejemplares disponibles (lo debe indicar la información devuelta por el <code>GET /libros</code>) y si el usuario logeado en el cliente no tiene multas pendientes. Si la petición POST a prestamos devuelve un error se mostrará un alert indicando el motivo del error.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint03/detalle-libro.png" alt="" width="66%">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_mis_libros">4.1.4. Mis libros</h4>
<div class="paragraph">
<p>Muestra el listado de reservas del usuario. En la tabla, saldrán en rojo aquellos libros cuya fecha de devolución ha vencido, y en amarillo aquellos cuya fecha de devolución sea igual o inferior a tres días.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint03/mis-libros.png" alt="" width="66%">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_api_rest">4.2. API REST</h3>
<div class="sect3">
<h4 id="_clases_json">4.2.1. Clases JSON</h4>
<div class="paragraph">
<p>El API REST trabajará con representaciones JSON de los objetos. Utilizaremos JAXB para mapear JSON en objetos y definiremos las clases necesarias también el paquete <code>org.expertojava.jbibrest.rest</code>.</p>
</div>
<div class="paragraph">
<p>Recomendamos usar clases específicas para cada caso de uso, nombrándolas con el nombre del modelo como prefijo y un sufijo relacionado con el caso de uso o pantalla de la aplicación cliente en la que se van a mostrar los datos. Por ejemplo: <code>LibroDetalle</code> para los datos devueltos por <code>GET /libros/{isbn}</code> o <code>LibroItem</code> para los elementos de la colección devuelta por <code>GET /libros</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_seguridad">4.2.2. Seguridad</h4>
<div class="paragraph">
<p>Utilizaremos la autenticación HTTP BASIC en cada petición, enviando una cabecera <code>Authorization</code> con la cadena <code>usuario:contraseña</code> codificada en base64. Ejemplo: <code>Authorization: Basic bG9naW46cGFzc3dvcmQ=</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_usuarios">4.2.3. Usuarios</h4>
<div class="ulist">
<ul>
<li>
<p><code>GET /usuarios/{usuario}</code>: Restringida al usuario. Devuelve la info actual del usuario, su estado, num. préstamos activos, días de multa, etc.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>GET http://localhost:8080/jbib-rest/api/usuario/antonioperez</code></pre>
</div>
</div>
<div class="paragraph">
<p>Resultado:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>{
  "id": 1,
  "email": "antonio.perez@gmail.com"
  "nombre": "Antonio",
  "apellido1": "Pérez",
  "apellido2": "Barrio",
  "estado": "multado",
  "tipo_usuario": "alumno",
  "multas": [{"fecha": "2015-01-25"}],
  "num_prestamos": 1
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>GET /usuarios/{usuario}/prestamos</code>: Restringida al usuario. El usuario es el identificador. Devuelve colección de libros (libro y ejemplar) que tiene prestados un usuario. Cada ítem contiene la URI que representa el enlace al recurso correspondiente (HATEOAS)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>GET http://localhost:8080/jbib-rest/api/usuarios/1/prestamos</code></pre>
</div>
</div>
<div class="paragraph">
<p>Resultado:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>[
  {
    "fecha_prestamo": "2015-01-01",
    "fecha_devolucion": 2015-01-31",
    "libro": {
      "resource_uri": "http://localhost:8080/jbib-rest/api/libros/0321127420",
      "isbn": "0321127420",
      "titulo": "Patterns Of Enterprise Application Architecture",
      "ejemplar_id": 1
    }
  },
  {
    "fecha_prestamo": "2014-12-20",
    "fecha_devolucion": 2015-01-20",
    "libro": {
      "resource_uri": "http://localhost:8080/jbib-rest/api/libros/0132350882",
      "isbn": "0132350882",
      "titulo": "Clean Code",
      "ejemplar_id": 3
    }
  }
]</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>POST /usuarios/{usuario}/prestamos</code>: Restringida al usuario. Se envía por POST el isbn del libro (no <em>la información del ejemplar</em> como se decía en una versión anterior de este enunciado) y se realiza un préstamo. Se devuelve OK o un error cuando el ejemplar no está disponible o el usuario está multado.</p>
</li>
<li>
<p><code>POST /usuarios/{usuario}/devoluciones</code>: Restringida al bibliotecario. Se envía por POST el identificador del ejemplar y se realiza la devolución.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_libros">4.2.4. Libros</h4>
<div class="ulist">
<ul>
<li>
<p><code>GET /libros</code>: Devuelve la lista de todos los libros. Cada ítem de libro contiene un enlace al recurso (HATEOAS). Búsqueda por autor o título: <code>?autor=`y `?titulo=</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>GET http://localhost:8080/jbib-rest/api/libros?autor=Martin</code></pre>
</div>
</div>
<div class="paragraph">
<p>Resultado:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>[
  {
    "resource_uri": "http://localhost:8080/jbib-rest/api/libros/0321127420",
    "isbn": "0321127420",
    "titulo": "Patterns Of Enterprise Application Architecture",
    "autor": "Martin Fowler",
    "image": "http://localhost:8080/jbib-rest/media/img/0321127420.png",
  },
  {
    "resource_uri": "http://localhost:8080/jbib-rest/api/libros/0132350882",
    "isbn": "0132350882",
    "titulo": "Clean code"
    "autor": "Robert C. Martin",
    "image": "http://localhost:8080/jbib-rest/media/img/0132350882.png"
  }
]</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>GET /libros/{isbn}</code>: Datos de un libro, número de ejemplares totales y número de ejemplares disponibles.</p>
</li>
<li>
<p><code>GET /libros/{isbn}/recomendaciones?numrec=</code>: Lista de libros recomendados relacionados con un libro dado (HATEOAS).</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_pruebas">4.3. Pruebas</h3>
<div class="paragraph">
<p>Debido a la extensión de esta sesión (y de las anteriores), no son obligatorias las pruebas automáticas del API REST. Puedes probar el API de forma manual usando el cliente REST de IntelliJ o el plug-in Postman de Google Chrome.</p>
</div>
</div>
<div class="sect2">
<h3 id="_entrega_2">4.4. Entrega</h3>
<div class="paragraph">
<p>La fecha de entrega del proyecto será el jueves 22 de enero.</p>
</div>
<div class="paragraph">
<p>Añade la etiqueta <code>sesion-3</code> al respositorio después de hacer el último commit y sube los cambios al repositorio <code>jbibrest-proyint-expertojava</code> en Bitbucket:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> git tag -a sesion-3 -m <span class="tok-s2">&quot;Sesión 3&quot;</span>
<span class="tok-gp">$</span> git push origin --tags</code></pre>
</div>
</div>
<div class="paragraph">
<p>Recuerda dar premiso de lectura al usuario <strong>entregas-expertojava</strong> y confirmar la entrega en Moodle.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion04">5. (1,5 puntos) Despliegue en plataforma en la nube</h2>
<div class="sectionbody">
<div class="paragraph">
<p>En esta sesión vamos a utilizar los conocimientos que hemos adquirido durante las sesiones de PaaS para desplegar la parte del servidor en la nube, utilizando OpenShift.</p>
</div>
<div class="paragraph">
<p>Como resumen realizaremos las siguientes tareas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Revisión del proyecto pom.xml del proyecto.</p>
</li>
<li>
<p>Revisión del entorno local de pruebas.</p>
</li>
<li>
<p>Configuración y despliegue de la capa de servidor en OpenShift.</p>
</li>
<li>
<p>Utilizar Integración Continua mediante Shippable a partir de nuestro repositorio en Bitbucket.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_revisión_del_proyecto_pom_xml">5.1. Revisión del proyecto pom.xml</h3>
<div class="paragraph">
<p>La definición actual del proyecto pom.xml tiene algunos aspectos que debemos mejorar, sobre todo pensando en que vamos a intentar realizar un despliegue lo más cercano a lo que podríamos hacer en un proyecto "real".</p>
</div>
<div class="ulist">
<ul>
<li>
<p>El proyecto trabaja con dependencias codificadas con versiones que no tienen porqué ser las que incluye el servidor de aplicaciones. Salvo causa de fuerza mayor ya sabemos que es recomendable utilizar el conjunto de librerías del servidor pues entre otras cosas están validadas para trabajar en conjunto.</p>
</li>
<li>
<p>No está pensado para utilizar diferentes versiones del servidor de aplicaciones según la plataforma destino. Recordad que actualmente desarrollamos con WildFly 8.1 pero en OpenShift se trabaja con WildFly 8.2.</p>
</li>
<li>
<p>Perfiles. El pom.xml original no define ningún perfil. En el escenario en el que nos vamos a mover necesitaremos tres perfiles distintos:</p>
<div class="ulist">
<ul>
<li>
<p><em>arq-remote</em> que será el perfil que hemos utilizado hasta ahora para realizar la compilación y pruebas del proyecto. En este perfil Arquillian trabaja contra un servidor de aplicaciones que se encuentre en ejecución en nuestro equipo.</p>
</li>
<li>
<p><em>arq-managed</em> este perfil será el que se utilice para compilar y probar el proyecto en Shippable. La diferencia con el perfil anterior es que Arquillian se encargará de ejecutar WildFly para lanzar las pruebas, y que además generaremos informes de Cobertura de pruebas. Este perfil se puede utilizar en local siempre y cuando tengamos definido la variable de entorno <em>JBOSS_HOME</em> apuntando a la carpeta de WildFly <em>/usr/local/wildfly/</em>.</p>
</li>
<li>
<p><em>openshift</em> como ya sabemos es el perfil que utilizará OpenShift para compilar el proyecto: <em>mvn clean package -Popenshift -DskipTests</em></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>En su lugar proponemos el siguiente fichero pom.xml</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tok-nt">&lt;project</span> <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="tok-na">xmlns:xsi=</span><span class="tok-s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="tok-na">xsi:schemaLocation=</span><span class="tok-s">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;modelVersion&gt;</span>4.0.0<span class="tok-nt">&lt;/modelVersion&gt;</span>

    <span class="tok-nt">&lt;groupId&gt;</span>org.expertojava.proyint<span class="tok-nt">&lt;/groupId&gt;</span>
    <span class="tok-nt">&lt;artifactId&gt;</span>jbib-rest<span class="tok-nt">&lt;/artifactId&gt;</span>
    <span class="tok-nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="tok-nt">&lt;/version&gt;</span>
    <span class="tok-nt">&lt;packaging&gt;</span>war<span class="tok-nt">&lt;/packaging&gt;</span>

    <span class="tok-nt">&lt;name&gt;</span>jbib-rest<span class="tok-nt">&lt;/name&gt;</span>

   <span class="tok-nt">&lt;properties&gt;</span>
        <span class="tok-nt">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span class="tok-nt">&lt;/project.build.sourceEncoding&gt;</span>
	<span class="tok-c">&lt;!-- Define the version of the JBoss BOMs we want to import to specify tested stacks. --&gt;</span>
        <span class="tok-nt">&lt;wildfly.version&gt;</span>8.1.0.Final<span class="tok-nt">&lt;/wildfly.version&gt;</span>
    <span class="tok-nt">&lt;/properties&gt;</span>

    <span class="tok-nt">&lt;dependencyManagement&gt;</span>
        <span class="tok-nt">&lt;dependencies&gt;</span>

	<span class="tok-nt">&lt;dependency&gt;</span>
                <span class="tok-nt">&lt;groupId&gt;</span>org.wildfly.bom<span class="tok-nt">&lt;/groupId&gt;</span>
                <span class="tok-nt">&lt;artifactId&gt;</span>jboss-javaee-7.0-with-tools<span class="tok-nt">&lt;/artifactId&gt;</span>
                <span class="tok-nt">&lt;version&gt;</span>${wildfly.version}<span class="tok-nt">&lt;/version&gt;</span>
                <span class="tok-nt">&lt;type&gt;</span>pom<span class="tok-nt">&lt;/type&gt;</span>
                <span class="tok-nt">&lt;scope&gt;</span>import<span class="tok-nt">&lt;/scope&gt;</span>
            <span class="tok-nt">&lt;/dependency&gt;</span>

            <span class="tok-nt">&lt;dependency&gt;</span>
                <span class="tok-nt">&lt;groupId&gt;</span>org.wildfly.bom<span class="tok-nt">&lt;/groupId&gt;</span>
                <span class="tok-nt">&lt;artifactId&gt;</span>jboss-javaee-7.0-with-hibernate<span class="tok-nt">&lt;/artifactId&gt;</span>
                <span class="tok-nt">&lt;version&gt;</span>${wildfly.version}<span class="tok-nt">&lt;/version&gt;</span>
                <span class="tok-nt">&lt;type&gt;</span>pom<span class="tok-nt">&lt;/type&gt;</span>
                <span class="tok-nt">&lt;scope&gt;</span>import<span class="tok-nt">&lt;/scope&gt;</span>
            <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-nt">&lt;/dependencies&gt;</span>
    <span class="tok-nt">&lt;/dependencyManagement&gt;</span>

    <span class="tok-nt">&lt;dependencies&gt;</span>
        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>javax<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>javaee-web-api<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>7.0<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>provided<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>log4j<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>log4j<span class="tok-nt">&lt;/artifactId&gt;</span>
	   <span class="tok-nt">&lt;scope&gt;</span>provided<span class="tok-nt">&lt;/scope&gt;</span>
           <span class="tok-nt">&lt;version&gt;</span>1.2.17<span class="tok-nt">&lt;/version&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>commons-logging<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>commons-logging<span class="tok-nt">&lt;/artifactId&gt;</span>
	   <span class="tok-nt">&lt;scope&gt;</span>provided<span class="tok-nt">&lt;/scope&gt;</span>
            	<span class="tok-nt">&lt;version&gt;</span>1.2<span class="tok-nt">&lt;/version&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-c">&lt;!-- Tests --&gt;</span>
        <span class="tok-c">&lt;!-- Import the JPA API, we use provided scope as the API is included in JBoss WildFly --&gt;</span>
        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.hibernate.javax.persistence<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>hibernate-jpa-2.1-api<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-c">&lt;!-- Quitamos el scope test para que no de error el</span>
<span class="tok-c">        elemento provider del persistence.xml de runtime--&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.hibernate<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>hibernate-entitymanager<span class="tok-nt">&lt;/artifactId&gt;</span>
           <span class="tok-nt">&lt;scope&gt;</span>provided<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>mysql<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>5.1.33<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-c">&lt;!-- DbUnit --&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.dbunit<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>dbunit<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>2.5.0<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

	<span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.slf4j<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>slf4j-api<span class="tok-nt">&lt;/artifactId&gt;</span>
	    <span class="tok-nt">&lt;version&gt;</span>1.7.7<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.slf4j<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>slf4j-log4j12<span class="tok-nt">&lt;/artifactId&gt;</span>
	    <span class="tok-nt">&lt;version&gt;</span>1.7.7<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-c">&lt;!-- Bean Validation --&gt;</span>

        <span class="tok-c">&lt;!-- JSR-303 (Bean Validation) Implementation --&gt;</span>
        <span class="tok-c">&lt;!-- Provides portable constraints such as @Email --&gt;</span>
        <span class="tok-c">&lt;!-- Hibernate Validator is shipped in JBoss WildFly --&gt;</span>
        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.hibernate<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>hibernate-validator<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>provided<span class="tok-nt">&lt;/scope&gt;</span>
            <span class="tok-nt">&lt;exclusions&gt;</span>
                <span class="tok-nt">&lt;exclusion&gt;</span>
                    <span class="tok-nt">&lt;groupId&gt;</span>org.slf4j<span class="tok-nt">&lt;/groupId&gt;</span>
                    <span class="tok-nt">&lt;artifactId&gt;</span>slf4j-api<span class="tok-nt">&lt;/artifactId&gt;</span>
                <span class="tok-nt">&lt;/exclusion&gt;</span>
            <span class="tok-nt">&lt;/exclusions&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-c">&lt;!-- Arquillian --&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.jboss.arquillian.junit<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>arquillian-junit-container<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>
    <span class="tok-nt">&lt;/dependencies&gt;</span>

  <span class="tok-nt">&lt;profiles&gt;</span>
    <span class="tok-nt">&lt;profile&gt;</span>
      <span class="tok-nt">&lt;id&gt;</span>arq-remote<span class="tok-nt">&lt;/id&gt;</span>
      <span class="tok-nt">&lt;activation&gt;</span>
        <span class="tok-nt">&lt;activeByDefault&gt;</span>true<span class="tok-nt">&lt;/activeByDefault&gt;</span>
      <span class="tok-nt">&lt;/activation&gt;</span>
	<span class="tok-nt">&lt;dependencies&gt;</span>
	        <span class="tok-nt">&lt;dependency&gt;</span>
	            <span class="tok-nt">&lt;groupId&gt;</span>org.wildfly<span class="tok-nt">&lt;/groupId&gt;</span>
	            <span class="tok-nt">&lt;artifactId&gt;</span>wildfly-arquillian-container-remote<span class="tok-nt">&lt;/artifactId&gt;</span>
	            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
	        <span class="tok-nt">&lt;/dependency&gt;</span>
	<span class="tok-nt">&lt;/dependencies&gt;</span>
          <span class="tok-nt">&lt;build&gt;</span>
        <span class="tok-nt">&lt;finalName&gt;</span>${project.name}<span class="tok-nt">&lt;/finalName&gt;</span>
        <span class="tok-nt">&lt;plugins&gt;</span>
          <span class="tok-nt">&lt;plugin&gt;</span>
              <span class="tok-nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="tok-nt">&lt;/groupId&gt;</span>
              <span class="tok-nt">&lt;artifactId&gt;</span>maven-compiler-plugin<span class="tok-nt">&lt;/artifactId&gt;</span>
              <span class="tok-nt">&lt;version&gt;</span>3.1<span class="tok-nt">&lt;/version&gt;</span>
              <span class="tok-nt">&lt;configuration&gt;</span>
                  <span class="tok-nt">&lt;source&gt;</span>1.7<span class="tok-nt">&lt;/source&gt;</span>
                  <span class="tok-nt">&lt;target&gt;</span>1.7<span class="tok-nt">&lt;/target&gt;</span>
              <span class="tok-nt">&lt;/configuration&gt;</span>
          <span class="tok-nt">&lt;/plugin&gt;</span>
          <span class="tok-nt">&lt;plugin&gt;</span>
              <span class="tok-nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="tok-nt">&lt;/groupId&gt;</span>
              <span class="tok-nt">&lt;artifactId&gt;</span>maven-surefire-plugin<span class="tok-nt">&lt;/artifactId&gt;</span>
              <span class="tok-nt">&lt;version&gt;</span>2.17<span class="tok-nt">&lt;/version&gt;</span>
          <span class="tok-nt">&lt;/plugin&gt;</span>
	     <span class="tok-nt">&lt;plugin&gt;</span>
                <span class="tok-nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="tok-nt">&lt;/groupId&gt;</span>
                <span class="tok-nt">&lt;artifactId&gt;</span>maven-war-plugin<span class="tok-nt">&lt;/artifactId&gt;</span>
                <span class="tok-nt">&lt;version&gt;</span>2.3<span class="tok-nt">&lt;/version&gt;</span>
                <span class="tok-nt">&lt;configuration&gt;</span>
                    <span class="tok-nt">&lt;failOnMissingWebXml&gt;</span>false<span class="tok-nt">&lt;/failOnMissingWebXml&gt;</span>
                <span class="tok-nt">&lt;/configuration&gt;</span>
            <span class="tok-nt">&lt;/plugin&gt;</span>
            <span class="tok-nt">&lt;plugin&gt;</span>
                <span class="tok-nt">&lt;groupId&gt;</span>org.wildfly.plugins<span class="tok-nt">&lt;/groupId&gt;</span>
                <span class="tok-nt">&lt;artifactId&gt;</span>wildfly-maven-plugin<span class="tok-nt">&lt;/artifactId&gt;</span>
                <span class="tok-nt">&lt;version&gt;</span>1.0.2.Final<span class="tok-nt">&lt;/version&gt;</span>
                <span class="tok-nt">&lt;configuration&gt;</span>
                    <span class="tok-nt">&lt;hostname&gt;</span>localhost<span class="tok-nt">&lt;/hostname&gt;</span>
                    <span class="tok-nt">&lt;port&gt;</span>9990<span class="tok-nt">&lt;/port&gt;</span>
                <span class="tok-nt">&lt;/configuration&gt;</span>
            <span class="tok-nt">&lt;/plugin&gt;</span>
        <span class="tok-nt">&lt;/plugins&gt;</span>
    <span class="tok-nt">&lt;/build&gt;</span>
    <span class="tok-nt">&lt;/profile&gt;</span>
    <span class="tok-nt">&lt;profile&gt;</span>
      <span class="tok-nt">&lt;id&gt;</span>arq-managed<span class="tok-nt">&lt;/id&gt;</span>
      <span class="tok-nt">&lt;dependencies&gt;</span>
	        <span class="tok-nt">&lt;dependency&gt;</span>
	            <span class="tok-nt">&lt;groupId&gt;</span>org.wildfly<span class="tok-nt">&lt;/groupId&gt;</span>
	            <span class="tok-nt">&lt;artifactId&gt;</span>wildfly-arquillian-container-managed<span class="tok-nt">&lt;/artifactId&gt;</span>
	            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
	        <span class="tok-nt">&lt;/dependency&gt;</span>
      <span class="tok-nt">&lt;/dependencies&gt;</span>
	 <span class="tok-nt">&lt;build&gt;</span>
        <span class="tok-nt">&lt;finalName&gt;</span>${project.name}<span class="tok-nt">&lt;/finalName&gt;</span>
        <span class="tok-nt">&lt;plugins&gt;</span>
            <span class="tok-nt">&lt;plugin&gt;</span>
                <span class="tok-nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="tok-nt">&lt;/groupId&gt;</span>
                <span class="tok-nt">&lt;artifactId&gt;</span>maven-compiler-plugin<span class="tok-nt">&lt;/artifactId&gt;</span>
                <span class="tok-nt">&lt;version&gt;</span>3.1<span class="tok-nt">&lt;/version&gt;</span>
                <span class="tok-nt">&lt;configuration&gt;</span>
                    <span class="tok-nt">&lt;source&gt;</span>1.7<span class="tok-nt">&lt;/source&gt;</span>
                    <span class="tok-nt">&lt;target&gt;</span>1.7<span class="tok-nt">&lt;/target&gt;</span>
                <span class="tok-nt">&lt;/configuration&gt;</span>
            <span class="tok-nt">&lt;/plugin&gt;</span>
	<span class="tok-nt">&lt;plugin&gt;</span>
	        <span class="tok-nt">&lt;groupId&gt;</span>org.codehaus.mojo<span class="tok-nt">&lt;/groupId&gt;</span>
	        <span class="tok-nt">&lt;artifactId&gt;</span>cobertura-maven-plugin<span class="tok-nt">&lt;/artifactId&gt;</span>
	        <span class="tok-nt">&lt;version&gt;</span>2.6<span class="tok-nt">&lt;/version&gt;</span>
	        <span class="tok-nt">&lt;configuration&gt;</span>
		          <span class="tok-nt">&lt;format&gt;</span>xml<span class="tok-nt">&lt;/format&gt;</span>
		          <span class="tok-nt">&lt;maxmem&gt;</span>256m<span class="tok-nt">&lt;/maxmem&gt;</span>
		          <span class="tok-nt">&lt;aggregate&gt;</span>true<span class="tok-nt">&lt;/aggregate&gt;</span>
		          <span class="tok-nt">&lt;outputDirectory&gt;</span>shippable/codecoverage<span class="tok-nt">&lt;/outputDirectory&gt;</span>
	        <span class="tok-nt">&lt;/configuration&gt;</span>
      <span class="tok-nt">&lt;/plugin&gt;</span>
            <span class="tok-nt">&lt;plugin&gt;</span>
        <span class="tok-nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="tok-nt">&lt;/groupId&gt;</span>
        <span class="tok-nt">&lt;artifactId&gt;</span>maven-surefire-plugin<span class="tok-nt">&lt;/artifactId&gt;</span>
        <span class="tok-nt">&lt;version&gt;</span>2.17<span class="tok-nt">&lt;/version&gt;</span>
        <span class="tok-nt">&lt;configuration&gt;</span>
          <span class="tok-nt">&lt;redirectTestOutputToFile&gt;</span>true<span class="tok-nt">&lt;/redirectTestOutputToFile&gt;</span>
          <span class="tok-nt">&lt;reportsDirectory&gt;</span>shippable/testresults<span class="tok-nt">&lt;/reportsDirectory&gt;</span>
        <span class="tok-nt">&lt;/configuration&gt;</span>
        <span class="tok-nt">&lt;dependencies&gt;</span>
          <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.apache.maven.surefire<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>surefire-junit4<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>2.7.2<span class="tok-nt">&lt;/version&gt;</span>
          <span class="tok-nt">&lt;/dependency&gt;</span>
        <span class="tok-nt">&lt;/dependencies&gt;</span>
      <span class="tok-nt">&lt;/plugin&gt;</span>
           <span class="tok-nt">&lt;plugin&gt;</span>
                <span class="tok-nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="tok-nt">&lt;/groupId&gt;</span>
                <span class="tok-nt">&lt;artifactId&gt;</span>maven-war-plugin<span class="tok-nt">&lt;/artifactId&gt;</span>
                <span class="tok-nt">&lt;version&gt;</span>2.3<span class="tok-nt">&lt;/version&gt;</span>
                <span class="tok-nt">&lt;configuration&gt;</span>
                    <span class="tok-nt">&lt;failOnMissingWebXml&gt;</span>false<span class="tok-nt">&lt;/failOnMissingWebXml&gt;</span>
                <span class="tok-nt">&lt;/configuration&gt;</span>
            <span class="tok-nt">&lt;/plugin&gt;</span>
            <span class="tok-nt">&lt;plugin&gt;</span>
                <span class="tok-nt">&lt;groupId&gt;</span>org.wildfly.plugins<span class="tok-nt">&lt;/groupId&gt;</span>
                <span class="tok-nt">&lt;artifactId&gt;</span>wildfly-maven-plugin<span class="tok-nt">&lt;/artifactId&gt;</span>
                <span class="tok-nt">&lt;version&gt;</span>1.0.2.Final<span class="tok-nt">&lt;/version&gt;</span>
                <span class="tok-nt">&lt;configuration&gt;</span>
                    <span class="tok-nt">&lt;hostname&gt;</span>localhost<span class="tok-nt">&lt;/hostname&gt;</span>
                    <span class="tok-nt">&lt;port&gt;</span>9990<span class="tok-nt">&lt;/port&gt;</span>
                <span class="tok-nt">&lt;/configuration&gt;</span>
            <span class="tok-nt">&lt;/plugin&gt;</span>
        <span class="tok-nt">&lt;/plugins&gt;</span>
    <span class="tok-nt">&lt;/build&gt;</span>
    <span class="tok-nt">&lt;/profile&gt;</span>
  <span class="tok-nt">&lt;/profiles&gt;</span>
<span class="tok-nt">&lt;/project&gt;</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_tareas">5.1.1. Tareas</h4>
<div class="ulist">
<ul>
<li>
<p>Reemplazar el pom.xml antiguo por el propuesto.</p>
</li>
<li>
<p>Añadir el perfil openshift para que se pueda desplegar correctamente en PaaS</p>
</li>
<li>
<p>Definir un MANIFEST.MF que referencie a los módulos <em>org.apache.commons.logging y org.apache.log4j</em> que forman parte del paquete de librerías de WildFly y no es necesario incluirlos en el WAR.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Con estos cambios conseguiremos que la aplicación pase de unos 6Mb a 56kb aproximadamente gracias al uso de paquetes de dependencias tipo BOM . Ademas el pom admitirá una serie de parámetros:</p>
</div>
<div class="paragraph">
<p>mvn [goal]&#8230;&#8203; -P[perfil]  -Dwildfly.version[versión]</p>
</div>
<div class="paragraph">
<p>Por defecto el perfil será <em>arq-remote</em> y la versión   <em>8.1.0.Final</em></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_revisión_del_entorno_local_de_pruebas">5.2. Revisión del entorno local de pruebas</h3>
<div class="paragraph">
<p>El objetivo final es que utilicemos Integración continua para desplegar nuestra aplicación con lo que debemos modificar ciertos aspectos de la configuración actual del proyecto de modo que sea más portable:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Utilizar una base de datos distinta de la de trabajo para pruebas y que coincida con la que Shippable nos proporciona.</p>
</li>
<li>
<p>Deshabilitar los test de Arquillian. Esta es una cuestión que nos hemos encontrado al probar contra Shippable. El orden de ejecución de los test no tiene porqué ser el esperado en local y en algunos casos se producen errores si los test no se ejecutan en orden.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_tareas_2">5.2.1. Tareas</h4>
<div class="ulist">
<ul>
<li>
<p>Exportar el contenido actual de la base de datos biblioteca a un fichero SQL mediante el comando:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">mysqldump -u root -p biblioteca &gt; fichero.sql</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El <em>fichero.sql</em> lo necesitaremos para cargar la instancia de MySQL de OpenShift.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Crear una base de datos local de nombre <strong>test</strong> y un usuario <strong>shippable sin password</strong> que tenga permisos de administrador sobre ella. Podéis utilizar cualquier herramienta como MySQL WorkBench.</p>
</li>
<li>
<p>Modificar la configuración de acceso a base de datos de los Test de los DAO&#8217;s de modo que apunten a la BD de pruebas que acabamos de crear:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-o">.</span><span class="tok-na">getConnection</span><span class="tok-o">(</span>
	<span class="tok-s">&quot;jdbc:mysql://localhost/test&quot;</span><span class="tok-o">,</span>
    <span class="tok-s">&quot;shippable&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;&quot;</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Modificar la unidad de persistencia <em>persistence.xml</em> de pruebas de modo que apunte a la nueva base de datos de test.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"> value=&quot;jdbc:mysql://localhost:3306/test&quot;/&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Modificar los test de Arquillian <em>UsuarioServicioTest,LibroServicioTest y BibliotecarioServicioTest</em></p>
<div class="ulist">
<ul>
<li>
<p>Crear un Datasource de nombre <em>test-ds.xml</em> en <em>/src/test/resources</em>:</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>

<span class="tok-nt">&lt;datasources</span> <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://www.jboss.org/ironjacamar/schema&quot;</span>
             <span class="tok-na">xmlns:xsi=</span><span class="tok-s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
             <span class="tok-na">xsi:schemaLocation=</span><span class="tok-s">&quot;http://www.jboss.org/ironjacamar/schema http://docs.jboss.org/ironjacamar/schema/datasources_1_0.xsd&quot;</span><span class="tok-nt">&gt;</span>

    <span class="tok-nt">&lt;xa-datasource</span> <span class="tok-na">jndi-name=</span><span class="tok-s">&quot;java:/datasources/test&quot;</span> <span class="tok-na">pool-name=</span><span class="tok-s">&quot;MySQLTest&quot;</span> <span class="tok-na">enabled=</span><span class="tok-s">&quot;true&quot;</span> <span class="tok-na">use-ccm=</span><span class="tok-s">&quot;true&quot;</span><span class="tok-nt">&gt;</span>
        <span class="tok-nt">&lt;xa-datasource-property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;URL&quot;</span><span class="tok-nt">&gt;</span>
            jdbc:mysql://localhost/test
        <span class="tok-nt">&lt;/xa-datasource-property&gt;</span>
        <span class="tok-nt">&lt;xa-datasource-class&gt;</span>com.mysql.jdbc.jdbc2.optional.MysqlXADataSource<span class="tok-nt">&lt;/xa-datasource-class&gt;</span>
        <span class="tok-nt">&lt;driver&gt;</span>mysql-connector-java-5.1.34-bin.jar_com.mysql.jdbc.Driver_5_1<span class="tok-nt">&lt;/driver&gt;</span>
        <span class="tok-nt">&lt;security&gt;</span>
            <span class="tok-nt">&lt;user-name&gt;</span>shippable<span class="tok-nt">&lt;/user-name&gt;</span>
        <span class="tok-nt">&lt;/security&gt;</span>
    <span class="tok-nt">&lt;/xa-datasource&gt;</span>
<span class="tok-nt">&lt;/datasources&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Incluir el datasource en el war de pruebas:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-o">.</span><span class="tok-na">addAsResource</span><span class="tok-o">(</span><span class="tok-s">&quot;persistence-datasource.xml&quot;</span><span class="tok-o">,</span>
                        <span class="tok-s">&quot;META-INF/persistence.xml&quot;</span><span class="tok-o">)</span>
                <span class="tok-o">.</span><span class="tok-na">addAsWebInfResource</span><span class="tok-o">(</span><span class="tok-s">&quot;test-ds.xml&quot;</span><span class="tok-o">,</span>
                        <span class="tok-s">&quot;test-ds.xml&quot;</span><span class="tok-o">)</span>	<span class="tok-c1">// Incluir el datasource</span>
                <span class="tok-o">.</span><span class="tok-na">addAsWebInfResource</span><span class="tok-o">(</span><span class="tok-n">EmptyAsset</span><span class="tok-o">.</span><span class="tok-na">INSTANCE</span><span class="tok-o">,</span> <span class="tok-s">&quot;beans.xml&quot;</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Deshabilitar los test de la capa de Servicio temporalmente para que no den error en Shippable (hasta nueva orden)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>@RunWith(Arquillian.class)
@Ignore("not ready yet")	// Nueva anotación
public class BibliotecarioServicioTest {</pre>
</div>
</div>
<div class="paragraph">
<p>Con estos cambios podréis ejecutar en local las pruebas contra la nueva base de datos. Ahora os saldrán menos casos de pruebas ejecutados al haber deshabilitado los de la capa servicio.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuración_y_despliegue_de_la_capa_de_servidor_en_openshift">5.3. Configuración y despliegue de la capa de servidor en OpenShift</h3>
<div class="paragraph">
<p>En esta parte crearemos una aplicación escalable con soporte de BD MySQL y añadiremos el código fuente de la capa REST.</p>
</div>
<div class="sect3">
<h4 id="_tareas_3">5.3.1. Tareas</h4>
<div class="ulist">
<ul>
<li>
<p>Crear una aplicación escalable, de nombre <em>jbibrest</em> con los cartridges de WildFly 8 y MySQL. (Si por lentitud os tardase demasiado podéis configurarla como no escalable, es una buena práctica pero no es requerido por el ejercicio).</p>
</li>
<li>
<p>Eliminar el código fuente de ejemplo (pom.xml y carpeta src).</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">git rm -r src/ pom.xml</span>
<span class="tok-go">git commit -m &quot;borrado plantilla&quot;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Inicializar manualmente el contenido de la BD MySQL de OpenShift a partir del fichero de backup que creamos en el primer apartado.</p>
</li>
<li>
<p>Añadir un repositorio Git remoto (el de bitbucket):</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">git remote add bitbucket https://[usuario]@bitbucket.org/[usuario]/[repositorio].git</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Hacer un "pull" del repositorio de Bitbucket para traernos los fuentes de nuestro proyecto:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">git pull bitbucket master</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Definir en el fichero <em>standalone.xml</em> de la configuración, el datasource XA <em>BibliotecaDS</em>. Fijaos que OpenShift por defecto crea una BD de WildFly con el mismo nombre que la aplicación (jbibrest) por tanto utilizad esta BD en el datasource. Recordad que debéis trabajar con las variables de entorno en lugar de con valores fijos.</p>
</li>
<li>
<p>Hacer un push al repositorio de Bitbucket para almacenar el proyecto actualizado con los ficheros de configuración de OpenShift.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">git add .</span>
<span class="tok-go">git commit -m &quot;integración con OpenShift&quot;</span>
<span class="tok-go">git push bitbucket master</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Hacer un push al repositorio de OpenShift y asegurarnos de que la aplicación está funcionando correctamente en http:&#47;&#47;jbibrest-[usuario].rhcloud.com.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">git push origin master</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Por último, dar de alta dos usuarios en el ApplicationRealm de WildFly:</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all" style="width: 50%;">
<colgroup>
<col style="width: 33%;">
<col style="width: 33%;">
<col style="width: 33%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Usuario</th>
<th class="tableblock halign-left valign-top">Password</th>
<th class="tableblock halign-left valign-top">Rol</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">usu1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">expertojava</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">usuario</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">biblio1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">expertojava</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bibliotecario</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_utilizar_integración_continua_mediante_shippable_a_partir_de_nuestro_repositorio_en_bitbucket">5.4. Utilizar Integración Continua mediante Shippable a partir de nuestro repositorio en Bitbucket.</h3>
<div class="paragraph">
<p>Dada la lentitud de los gear gratuitos de OpenShift  es preferible utilizar un proveedor de CI externo, como pueda ser Shippable. Shippable tiene varias ventajas sobre otras opciones.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Nos proporciona una instancia de CI de forma gratuita.</p>
</li>
<li>
<p>Integración con OpenShift, GitHub y BitBucket.</p>
</li>
<li>
<p>Uso muy sencillo, mediante un script YAML.</p>
</li>
<li>
<p>Uso de imágenes de Docker como base para realizar las pruebas. Se configura el entorno de pruebas desde cero en cada prueba con los elementos que necesitamos.</p>
</li>
<li>
<p>Acceso simple mediante Oauth utilizando vuestras credenciales de Bitbucket.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La idea es que ante cualquier cambio que subáis a vuestro repositorio de BitBucket, se active una instancia de Shippable, recoja estos cambios, haga las pruebas que hayamos definido y si todo es correcto, lo despliegue en el gear de OpenShift.</p>
</div>
<div class="sect3">
<h4 id="_tareas_4">5.4.1. Tareas</h4>
<div class="ulist">
<ul>
<li>
<p>Crear un script de integración continua donde se detallan los pasos para configurar el entorno y realizar las pruebas. El fichero se llamará <em>shippable.yml</em> y se situará al mismo nivel que el fichero <em>pom.xml</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>El contenido del fichero será el siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">language: java</span>

<span class="tok-go">jdk:</span>
<span class="tok-go">   - openjdk7</span>

<span class="tok-go">env:</span>
<span class="tok-go">  global:</span>
<span class="tok-go">    - JBOSS_HOME=/tmp/wildfly-8.2.0.Final</span>
<span class="tok-go">    - JBOSS_SERVER_LOCATION=http://download.jboss.org/wildfly/8.2.0.Final/wildfly-8.2.0.Final.tar.gz</span>
<span class="tok-go">    - OPENSHIFT_REPO=ssh://54bd8f985973ca36b6000025@jbibrest-jlzamora.rhcloud.com/~/git/jbibrest.git</span>
<span class="tok-go">    - MYSQL_DRIVER=http://www.jtech.ua.es/experto/publico/mysql-connector-java-5.1.34-bin.jar</span>
<span class="tok-go">    - MYSQL_DRIVER_DEST=/tmp/wildfly-8.2.0.Final/standalone/deployments/mysql-connector-java-5.1.34-bin.jar</span>

<span class="tok-go">before_install:</span>
<span class="tok-go">  - if [ ! -e $JBOSS_HOME ]; then curl -s $JBOSS_SERVER_LOCATION | tar zx -C /tmp; fi</span>
<span class="tok-go">  - curl -s $MYSQL_DRIVER &gt;$MYSQL_DRIVER_DEST</span>
<span class="tok-go">  - git remote -v | grep ^openshift || git remote add openshift $OPENSHIFT_REPO</span>

<span class="tok-go">before_script:</span>
<span class="tok-go">  - mkdir -p shippable/testresults</span>
<span class="tok-go">  - mkdir -p shippable/codecoverage</span>
<span class="tok-go">  - mysql -e &#39;create database test;&#39;</span>

<span class="tok-go">script:</span>
<span class="tok-go">  - mvn clean test cobertura:cobertura -Parq-managed  -Dwildfly.version=8.2.0.Final</span>

<span class="tok-go">after_success:</span>
<span class="tok-go">  - git push -f openshift $BRANCH:master</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Este script descarga y descomprime la misma versión de WildFly que se utilizará en OpenShift, prepara el entorno para lanzar las pruebas y si las pruebas concluyen con éxito hace un <em>push</em> del código al respositorio Git de OpenShift. También hemos subido a la web de Jtech el driver de MySQL que utilizaremos en las pruebas, y que el script copia diretamente a deployments.</p>
</div>
<div class="paragraph">
<p><strong>Debeis modificar el script con la ruta SSH a vuestro gear concreto</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Acceder a <a href="http://www.shippable.com" class="bare">http://www.shippable.com</a> autenticándonos con el usuario/password de Bitbucket. Esto nos permitirá listar nuestros proyectos.</p>
</li>
<li>
<p>En el panel de la derecha saldrá nuestro usuario de BitBucket y podremos seleccionar un repositorio para habilitar integración continua. Seleccionar el repositorio del proyecto de la capa REST.</p>
</li>
<li>
<p>Obtener la "Developer Key" de nuestra sesión en Shippable. Esta clave se debe registrar en WildFly para que quede constancia de que damos permisos a Shippable para subir código a los repositorios Git gestionados por OpenShift. Dentro de Shippable, pulsaremos en <em>Organizations &#8594; bitbucket/&lt;usuario&gt;</em> Y luego en <em>deployment key.</em></p>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint04/int1.png" alt="" width="100%">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>En Settings de OpenShift, daremos de alta esta clave como <em>public key</em>. El nombre asociado puede ser el que queráis, por ejemplo <em>Shippable</em></p>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint04/int2.png" alt="" width="100%">
</div>
</div>
<div class="paragraph">
<p>Hacer un <em>push</em> únicamente al repositorio de Bitbucket. Si lo hemos hecho todo bien, se iniciará una tarea de compilación en Shippable y podremos seguir paso a paso todo el proceso. Si falla algo, revisad la ejecuión de los pasos en busca del error concreto que se haya producido.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint04/int3.png" alt="" width="100%">
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint04/int4.png" alt="" width="100%">
</div>
</div>
<div class="paragraph">
<p>Si todo es correcto, para trabajar en futuras sesiones de integración bastaría con clonarnos el repositorio de Bitbucket a local y gracias a Shippable podremos desplegar nuestros cambios en OpenShift sin necesidad de tener nada configurado, únicamente subiendo los cambios a Bitbucket.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_entrega_3">5.5. Entrega</h3>
<div class="paragraph">
<p>La fecha de entrega del proyecto será el jueves 12 de marzo.</p>
</div>
<div class="paragraph">
<p>Añade la etiqueta <code>sesion-4</code> al respositorio después de hacer el último commit y sube los cambios al repositorio <code>jbibrest-proyint-expertojava</code> en Bitbucket:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> git tag -a sesion-4 -m <span class="tok-s2">&quot;Sesión 4&quot;</span>
<span class="tok-gp">$</span> git push origin --tags</code></pre>
</div>
</div>
<div class="paragraph">
<p>Recuerda dar premiso de lectura/escritura al usuario <strong>entregas-expertojava</strong> y confirmar la entrega en Moodle. Una de las pruebas será modificar el código fuente y comprobar que los cambios se despliegan correctamente en OpenShift.</p>
</div>
<div class="paragraph">
<p>Adicionalmente revisaremos que la aplicación esté desplegada correctamente en OpenShift accediendo a la URL convenida:</p>
</div>
<div class="paragraph">
<p>http:&#47;&#47;jbibrest-[usuario].rhcloud.com.</p>
</div>
<div class="paragraph">
<p>Para verificar que la parte de integración continua funciona correctamente os pediremos un fichero de log de Shippable. Este se puede obtener pulsando en el icono en forma de nube que se muestra junto con la información de cada build:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint04/int5.png" alt="" width="100%">
</div>
</div>
<div class="paragraph">
<p>Si os diese errores la parte de integración continua con Shippable u os resulta compleja de configurar, podéis entregar el ejercicio simplemente activando la opción de Integración continua con Jenkins que integra OpenShift, pero tendrá las siguientes limitaciones:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>La aplicación jbibrest no puede ser escalable porque sólo para pruebas ya vamos a necesitar 2 gears.</p>
</li>
<li>
<p>Los test de Arquillian son costosos de ejecutar sobre los gears gratuitos así que es posible que las tareas de Jenkins no acaben correctamente.</p>
</li>
<li>
<p>No vais a tener integración entre Bitbucket y el repositorio de Git por tanto debéis copiar los fuentes manualmente de un repositorio a otro.</p>
</li>
<li>
<p>Mucho más fácil = Menos puntuación y menos interesante&#8230;&#8203;</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_referencias">5.6. Referencias</h3>
<div class="paragraph">
<p>Shippable &amp; OpenShift <a href="http://docs.shippable.com/en/latest/continuous_deployment.html#continuous-deployment-to-red-hat-openshift" class="bare">http://docs.shippable.com/en/latest/continuous_deployment.html#continuous-deployment-to-red-hat-openshift</a></p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion05">6. (3 puntos) Cliente AngularJS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>En esta sesión vamos a hacer uso de los servicios REST implementados, y vamos a crear una interfaz web realizada en HTML5 + Bootstrap + AngularJS para consumir dichos servicios a través de una aplicación web SPA.</p>
</div>
<div class="paragraph">
<p>Dado que estamos trabajando con clientes ricos y aplicaciones desacopladas, nuestra aplicación web se desarrollará en un proyecto independiente del proyecto java, y también se ejecutará en otro servidor.</p>
</div>
<div class="paragraph">
<p>Las ventajas de esta arquitectura son múltiples. Al tratarse nuestra aplicación web de un consumidor de servicios, sería muy fácil crear una aplicación móvil con <a href="https://cordova.apache.org/">Apache Cordova</a>, o una aplicación de escritorio con <a href="http://nwjs.io/">NW.js</a>. Simplemente habría que introducir el código del ejercicio en la carpeta webapps de cada plataforma.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Aunque la aplicación es <em>responsive</em>, la maquetación llevada a cabo no se adapta del todo bien a dispositivos móviles.</p>
</div>
<div class="paragraph">
<p>Aunque las aplicaciones se puedan adaptar correctamente, en mi opinión los dispositivos móviles suelen utilizar otros patrones y el desarrollo de la interfaz no debería ser adaptable, sino específico para éstos. Es por ello que considere a ionic framework algo imprescindible para las interfaces de aplicaciones móviles, pudiendo reaprovechar lógica de negicio existente en servicios, filtros y algunas directivas..</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Mediante el uso de <a href="http://getbootstrap.com/">Bootstrap</a>, estamos garantizando un diseño responsive que se adapta de manera adecuada a todo tipo de dispositivos. Aunque la solución idónea para dispositivos móviles pasa por <a href="http://ionicframework.com/">Ionic Framework</a>: un framework basado en AngularJS y con ui-router como gestor de rutas que se ha convertido en el framework de referencia a la hora de desarrollar aplicaciones móviles híbridas.</p>
</div>
<div class="sect2">
<h3 id="_fork_del_repositorio">6.1. Fork del repositorio</h3>
<div class="paragraph">
<p>Empezaremos realizando un <em>fork</em> del repositorio <a href="https://bitbucket.org/java_ua/angular-proyint-expertojava" class="bare">https://bitbucket.org/java_ua/angular-proyint-expertojava</a>. Éste tiene una base de código sobre la que empezaremos.</p>
</div>
</div>
<div class="sect2">
<h3 id="_instalación_de_las_dependencias_del_proyecto">6.2. Instalación de las dependencias del proyecto</h3>
<div class="paragraph">
<p>Fijémonos en los ficheros <code>.bowerrc</code> y <code>package.json</code>. En éstos se definen las dependencias de nuestro proyecto, de igual manera que maven lo hace con los paquetes java que podamos necesitar. El hecho de usar un gestor de dependencias hace que el tamaño de nuestro repositorio sea mucho más liviano, que podamos ver las versiones de nuestras dependencias de una manera sencilla (el fichero indica la versión), y que todos los desarrolladores trabajen con las mismas versiones de las librerías dependientes.</p>
</div>
<div class="paragraph">
<p>Para instalarnos las dependencias, ejecutaremos, desde la línea de comandos y poniéndonos en la raíz de nuestro proyecto:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> npm install</code></pre>
</div>
</div>
<div class="paragraph">
<p>Con esto habremos instalado las librerías que necesitamos para automatizar tareas. Ahora, para instalar las dependencias de nuestra aplicación web, ejecutaremos el comando:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> bower install</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ya tenemos instaladas todas las dependencias. El gestor también nos habrá instalado un pequeño servidor web, que utilizaremos para probar nuestra aplicación. Podemos lanzarlo mediante el comando:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> node node_modules/webserver/webserver.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>Si todo va bien, deberíamos obtener la salida:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-go">WEBROOT.</span>
<span class="tok-go">Listening @ 8003</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Así, ya tenemos un servidor corriendo y escuchando en el puerto 8003, y otro servidor con un WildFly escuchando en el puerto 8080. También podemos utilizar el servidor que tenemos desplegado en OpenShift para probar y tener más presente el desacoplamiento. Sin embargo, y por comodidad, el ejercicio se corregirá probándolo contra un servidor local y toda la configuración deberá dejarse preparada de esta manera.</p>
</div>
</div>
<div class="sect2">
<h3 id="_cors_en_clientes_web">6.3. CORS en clientes web</h3>
<div class="paragraph">
<p>En sesiones anteriores, se ha creado un filtro para que la aplicación soporte CORS (Cross-Origin Resource Sharing). Vamos a tener que realizar alguna modificación más sobre nuestro código Java.</p>
</div>
<div class="paragraph">
<p>Esto se debe a que muchas peticiones requieren una comunicación extra entre el cliente y el servidor antes de realizar una petición <code>GET</code>, <code>POST</code>, <code>PUT</code> o <code>DELETE</code>. A esto se le conoce como <em>preflight request</em>, y es una llamada al servidor, sin <em>payload</em>, y que se envía con una cabecera <code>OPTIONS</code>.</p>
</div>
<div class="paragraph">
<p>Es por ello que debemos preparar nuestro código Java para que acepte este tipo de llamadas. Esto podríamos resolverlo de dos maneras:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Creando una función para cada llamada con la anotación <code>@OPTIONS</code> y devuelva un código de respuesta <code>200 OK</code>.</p>
</li>
<li>
<p>Creando un filtro que devuelva una respuesta <code>200 OK</code> en cada petición con cabecera <code>OPTIONS</code> directamente desde el filtro, sin llegar a pasar por la lógica de negocio.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Para el ejercicio, se ha optado por la primera opción, al considerarla más restrictiva.</p>
</div>
<div class="paragraph">
<p>Un ejemplo concreto, para la clase UsuarioResource, sería el siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@OPTIONS</span>
<span class="tok-nd">@Consumes</span><span class="tok-o">({</span><span class="tok-s">&quot;application/json&quot;</span><span class="tok-o">})</span>
<span class="tok-nd">@Path</span><span class="tok-o">(</span><span class="tok-s">&quot;{usuario}/prestamos&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-n">Response</span> <span class="tok-nf">realizarPrestamoOptions</span><span class="tok-o">(</span><span class="tok-nd">@PathParam</span><span class="tok-o">(</span><span class="tok-s">&quot;usuario&quot;</span><span class="tok-o">)</span> <span class="tok-n">String</span> <span class="tok-n">login</span><span class="tok-o">)</span> <span class="tok-o">{</span>
  <span class="tok-k">return</span> <span class="tok-n">Response</span><span class="tok-o">.</span><span class="tok-na">ok</span><span class="tok-o">().</span><span class="tok-na">build</span><span class="tok-o">();</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Antes de realizar un préstamo, se enviará una petición sin <em>payload</em> al servidor y con la cabecera <code>OPTIONS</code>. Si la respuesta es correcta, será entonces cuando se envíe la petición <code>POST</code>.</p>
</div>
<div class="paragraph">
<p>Para aliviar la tarea de implementar estos servicios, se adjuntan versiones modificadas de las clases de recursos, con estas anotaciones añadidas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="resources/UsuarioResource.java.txt">UsuarioResource.java</a></p>
</li>
<li>
<p><a href="resources/LibroResource.java.txt">LibroResource.java</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_aplicación_web">6.4. Aplicación web</h3>
<div class="paragraph">
<p>Como hemos dicho, la aplicación web estará desarrollada en AngularJS, y hará uso de los servicios REST implementados.</p>
</div>
<div class="paragraph">
<p>El código de la aplicaión (javascript y HTML) está incompleto, y tendremos que terminarlo para que ésta funcione.</p>
</div>
<div class="paragraph">
<p>Se ha puesto un <code>TODO</code> allá donde haga falta realizar algo. IntelliJ Idea tiene una vista de TO-DOs, donde podemos verlos todos juntos para que no se nos pase ninguno:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint05/todo.png" alt="" width="100%">
</div>
</div>
<div class="paragraph">
<p>La funcionalidad se corresponderá con las funcionalidades asocidadas a un usuario, y pasamos a ver en los siguientes pantallazos:</p>
</div>
<div class="sect3">
<h4 id="_login">6.4.1. Login</h4>
<div class="paragraph">
<p>Será el punto de entrada a la aplicación, y desde la que el usuario introducirá sus credenciales de acceso:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint05/login.png" alt="" width="100%">
</div>
</div>
<div class="paragraph">
<p>Si las credenciales introducidas son incorrectas, se indicará al usuario mediante un mensaje:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint05/login_error.png" alt="" width="100%">
</div>
</div>
<div class="paragraph">
<p>El sistema de autenticación</p>
</div>
</div>
<div class="sect3">
<h4 id="_listado_de_libros_2">6.4.2. Listado de libros</h4>
<div class="paragraph">
<p>Inmediatamente después de acceder a la aplicación, veremos el listado de libros:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint05/listado.png" alt="" width="100%">
</div>
</div>
<div class="paragraph">
<p>Cada libro es una directiva que tendremos que terminar de implementar. Además, como el serivcio REST nos devuelve la miniatura de la imagen, vamos a implementar un filtro que modifique la cadena para que devuelva la imagen a tamaño completo. No queremos modificar el servicio, sino lo que éste nos devuelve y por eso lo vamos a hacer desde el lado del cliente.</p>
</div>
</div>
<div class="sect3">
<h4 id="_detalle_de_un_libro">6.4.3. Detalle de un libro</h4>
<div class="paragraph">
<p>Muestra el detalle de un libro:título, autor, isbn, número de ejemplares total y número de ejemplares disponibles. Además, habrá un botón <em>Volver</em> que hará un <code>history.back()</code> del navegador y un botón <em>Reservar</em>, que invocará al servicio de reservas.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint05/detalle.png" alt="" width="100%">
</div>
</div>
<div class="paragraph">
<p>Si se puede realizar la reserva de manera correcta, se mostrará una alerta en verde. Si por el contrario no se puede realizar la reserva, se mostrará un mensaje en rojo y el motivo (por ejemplo: usuario no válido porque tiene una multa). El fichero UsuarioResource ya captura excepciones y manda un mensaje de error junto con una cabecera 403 (<code>Forbidden</code>) en caso de no poder realizar una reserva.</p>
</div>
<div class="paragraph">
<p>El detalle del libro es una directiva. Ésta muestra en rojo el número de ejemplares disponibles cuando es cero. Además, el botón de reservas deberá quedar deshabilitado si el número de ejemplares disponibles es cero. Si se está haciendo una reserva, el botón de reservar también se deshabilitará para evitar el doble click, y mostrará una rueda girando. La clase CSS de la rueda girando está preparada y se llama <code>glyphicon-cog</code>.</p>
</div>
<div class="paragraph">
<p>A continuación del detalle del libro tenemos la lista de libros relacionados. Deberá ser un máximo de 8, y reaprovecharemos la misma directiva empleada en el listado principal de libros.</p>
</div>
</div>
<div class="sect3">
<h4 id="_listado_de_préstamos">6.4.4. Listado de préstamos</h4>
<div class="paragraph">
<p>Mostrará todos los préstamos del usuario:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint05/prestamos.png" alt="" width="100%">
</div>
</div>
<div class="paragraph">
<p>Aunque están marcados en azul sólo los títulos de los libros, haciendo click en cualquier lugar de la fila seremos llevados al detalle del libro.</p>
</div>
<div class="paragraph">
<p>Si la fecha de devolución de un préstamo ha vencido, el texto tendrá la clase <code>text-alert</code> para mostrarse en rojo.</p>
</div>
<div class="paragraph">
<p>En caso de no tener ningún préstamo, en lugar de mostrar la tabla, se enseñará un mensaje informativo:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint05/listado_vacio.png" alt="" width="100%">
</div>
</div>
<div class="paragraph">
<p>Habrá que intentar que la vista no haga <em>flickering</em>, mostrando una cosa un milisegundo y luego mostrando otra.</p>
</div>
</div>
<div class="sect3">
<h4 id="_devoluciones">6.4.5. Devoluciones.</h4>
<div class="paragraph">
<p>La funcionalidad de devolución es responsabilidad del bibliotecario y queda fuera de este proyecto. En caso de necesitar hacer una devolución lo haremos a través de la aplicación <em>Postman</em>, o cualquier otro cliente REST.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_control_de_acceso">6.5. Control de acceso</h3>
<div class="paragraph">
<p>Se ha implementado un sencillo control de acceso en la aplicación. Lo podemos ver en el fichero <code>jbib.js</code>, en el método <code>run</code> de la aplicación. Básicamente consiste en que si no estamos en los <code>states</code> de nombre <code>login</code> o <code>logout</code> se mirará si el usuario está logado. Si no lo está, redirigirá a la pantalla de login.</p>
</div>
</div>
<div class="sect2">
<h3 id="_comunicación_con_el_servidor">6.6. Comunicación con el servidor</h3>
<div class="paragraph">
<p>Toda la comunicación con el servidor se hará con el módulo <a href="https://docs.angularjs.org/api/ngResource"><code>ngResource</code></a>, que hemos visto que facilita la integración con servicios REST.</p>
</div>
<div class="paragraph">
<p>Deberemos terminar la implementación de los siguientes servicios, que son los que favorecerán dicha comunicación:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>booksResource.js</p>
</li>
<li>
<p>borrowService.js</p>
</li>
<li>
<p>relatedBooksResource.js</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Observad en el código que <code>borrowsService</code> se ha concebido de manera ligeramente distinta: mientras los otros dos devuelven el propio recurso, éste implementa una factoría como las que hemos visto en clase.</p>
</div>
</div>
<div class="sect2">
<h3 id="_estructura_del_proyecto">6.7. Estructura del proyecto</h3>
<div class="paragraph">
<p>Se ha tenido en cuenta algunas de las <em>best practices</em> a la hora de elaborar la estructura del proyecto. Cada funcionalidad está en una carpeta distinta (préstamos, libros, acceso, dashboard). Dentro de cada una de ellas, habrá una carpeta para servicios, directivas, controladores, filtros y vistas.</p>
</div>
<div class="paragraph">
<p>Las funcionalidades de login y gestión de acceso se han creado como módulos independientes, con la idea de poder ser reutilizados en otros proyectos.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="txt"><span class="tok-err">.</span>
<span class="tok-err">├──</span> <span class="tok-err">books</span>
<span class="tok-err">│</span>   <span class="tok-err">├──</span> <span class="tok-err">controllers</span>
<span class="tok-err">│</span>   <span class="tok-err">│</span>   <span class="tok-err">├──</span> <span class="tok-err">bookController.js</span>
<span class="tok-err">│</span>   <span class="tok-err">│</span>   <span class="tok-err">└──</span> <span class="tok-err">booksController.js</span>
<span class="tok-err">│</span>   <span class="tok-err">├──</span> <span class="tok-err">directives</span>
<span class="tok-err">│</span>   <span class="tok-err">│</span>   <span class="tok-err">├──</span> <span class="tok-err">book</span>
<span class="tok-err">│</span>   <span class="tok-err">│</span>   <span class="tok-err">│</span>   <span class="tok-err">├──</span> <span class="tok-err">book.html</span>
<span class="tok-err">│</span>   <span class="tok-err">│</span>   <span class="tok-err">│</span>   <span class="tok-err">└──</span> <span class="tok-err">book.js</span>
<span class="tok-err">│</span>   <span class="tok-err">│</span>   <span class="tok-err">└──</span> <span class="tok-err">book-detail</span>
<span class="tok-err">│</span>   <span class="tok-err">│</span>       <span class="tok-err">├──</span> <span class="tok-err">book-detail.html</span>
<span class="tok-err">│</span>   <span class="tok-err">│</span>       <span class="tok-err">└──</span> <span class="tok-err">bookDetail.js</span>
<span class="tok-err">│</span>   <span class="tok-err">├──</span> <span class="tok-err">filters</span>
<span class="tok-err">│</span>   <span class="tok-err">│</span>   <span class="tok-err">└──</span> <span class="tok-err">largeImg.js</span>
<span class="tok-err">│</span>   <span class="tok-err">├──</span> <span class="tok-err">services</span>
<span class="tok-err">│</span>   <span class="tok-err">│</span>   <span class="tok-err">├──</span> <span class="tok-err">booksResource.js</span>
<span class="tok-err">│</span>   <span class="tok-err">│</span>   <span class="tok-err">├──</span> <span class="tok-err">borrowService.js</span>
<span class="tok-err">│</span>   <span class="tok-err">│</span>   <span class="tok-err">└──</span> <span class="tok-err">relatedBooksResource.js</span>
<span class="tok-err">│</span>   <span class="tok-err">└──</span> <span class="tok-err">views</span>
<span class="tok-err">│</span>       <span class="tok-err">├──</span> <span class="tok-err">book.html</span>
<span class="tok-err">│</span>       <span class="tok-err">└──</span> <span class="tok-err">books.html</span>
<span class="tok-err">├──</span> <span class="tok-err">borrows</span>
<span class="tok-err">│</span>   <span class="tok-err">├──</span> <span class="tok-err">controllers</span>
<span class="tok-err">│</span>   <span class="tok-err">│</span>   <span class="tok-err">└──</span> <span class="tok-err">borrowsController.js</span>
<span class="tok-err">│</span>   <span class="tok-err">└──</span> <span class="tok-err">views</span>
<span class="tok-err">│</span>       <span class="tok-err">└──</span> <span class="tok-err">borrows.html</span>
<span class="tok-err">├──</span> <span class="tok-err">bower_components</span>
<span class="tok-err">├──</span> <span class="tok-err">bower.json</span>
<span class="tok-err">├──</span> <span class="tok-err">components</span>
<span class="tok-err">│</span>   <span class="tok-err">├──</span> <span class="tok-err">auth</span>
<span class="tok-err">│</span>   <span class="tok-err">│</span>   <span class="tok-err">├──</span> <span class="tok-err">authInterceptor.js</span>
<span class="tok-err">│</span>   <span class="tok-err">│</span>   <span class="tok-err">├──</span> <span class="tok-err">auth.module.js</span>
<span class="tok-err">│</span>   <span class="tok-err">│</span>   <span class="tok-err">└──</span> <span class="tok-err">authService.js</span>
<span class="tok-err">│</span>   <span class="tok-err">└──</span> <span class="tok-err">images</span>
<span class="tok-err">│</span>       <span class="tok-err">└──</span> <span class="tok-err">nophoto.png</span>
<span class="tok-err">├──</span> <span class="tok-err">dashboard</span>
<span class="tok-err">│</span>   <span class="tok-err">├──</span> <span class="tok-err">directives</span>
<span class="tok-err">│</span>   <span class="tok-err">│</span>   <span class="tok-err">├──</span> <span class="tok-err">navbar</span>
<span class="tok-err">│</span>   <span class="tok-err">│</span>   <span class="tok-err">│</span>   <span class="tok-err">├──</span> <span class="tok-err">navbar.html</span>
<span class="tok-err">│</span>   <span class="tok-err">│</span>   <span class="tok-err">│</span>   <span class="tok-err">└──</span> <span class="tok-err">navbar.js</span>
<span class="tok-err">│</span>   <span class="tok-err">│</span>   <span class="tok-err">└──</span> <span class="tok-err">sidebar</span>
<span class="tok-err">│</span>   <span class="tok-err">│</span>       <span class="tok-err">├──</span> <span class="tok-err">sidebar.html</span>
<span class="tok-err">│</span>   <span class="tok-err">│</span>       <span class="tok-err">└──</span> <span class="tok-err">sidebar.js</span>
<span class="tok-err">│</span>   <span class="tok-err">└──</span> <span class="tok-err">views</span>
<span class="tok-err">│</span>       <span class="tok-err">└──</span> <span class="tok-err">dashboard.html</span>
<span class="tok-err">├──</span> <span class="tok-err">dist</span>
<span class="tok-err">├──</span> <span class="tok-err">Gruntfile.js</span>
<span class="tok-err">├──</span> <span class="tok-err">index.html</span>
<span class="tok-err">├──</span> <span class="tok-err">jbib.css</span>
<span class="tok-err">├──</span> <span class="tok-err">jbib.js</span>
<span class="tok-err">├──</span> <span class="tok-err">login</span>
<span class="tok-err">│</span>   <span class="tok-err">├──</span> <span class="tok-err">directives</span>
<span class="tok-err">│</span>   <span class="tok-err">│</span>   <span class="tok-err">├──</span> <span class="tok-err">login-form.html</span>
<span class="tok-err">│</span>   <span class="tok-err">│</span>   <span class="tok-err">└──</span> <span class="tok-err">loginForm.js</span>
<span class="tok-err">│</span>   <span class="tok-err">├──</span> <span class="tok-err">login.module.js</span>
<span class="tok-err">│</span>   <span class="tok-err">└──</span> <span class="tok-err">views</span>
<span class="tok-err">│</span>       <span class="tok-err">└──</span> <span class="tok-err">login.html</span>
<span class="tok-err">├──</span> <span class="tok-err">node_modules</span>
<span class="tok-err">├──</span> <span class="tok-err">package.json</span>
<span class="tok-err">├──</span> <span class="tok-err">tree.txt</span>
<span class="tok-err">└──</span> <span class="tok-err">tsd.json</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_automatización">6.8. Automatización</h3>
<div class="paragraph">
<p>Se han creado unas reglas de <a href="http://jshint.com/"><em>linting</em></a> y minificación. En las etapas iniciales del desarrollo será complicado de usar, pero a medida que vayamos avanzando será necesario.  La prueba de la aplicación se hará sobre el código minificado, y éste no se minificará si no pasa el <em>linting</em>.</p>
</div>
<div class="paragraph">
<p>Lanzado el siguiente comando desde la raíz del proyecto:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> grunt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Se ejecutará un <em>listener</em> que intentará pasar las reglas de JSHint y minificar el código cada vez que realizamos una modificación en el mismo. Así, sólo tendremos que refrescar el navegador cuando estas tareas se hayan realizado.</p>
</div>
<div class="paragraph">
<p>Si sólo queremos minificar el código sin que se ejecute ningún <em>listener</em>, haremos uso del comando:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> grunt dist</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>La carpeta <code>dist</code> está en el .gitignore y no deberá subirse al repositorio. El código de distribución se generará en el momento de la corrección.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_corrección">6.9. Corrección</h3>
<div class="paragraph">
<p>Aplica el tag <code>FINAL</code> al <em>commit</em> que quieras que se te corrija.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2015-04-24 13:43:41 CEST
</div>
</div>
</body>
</html>