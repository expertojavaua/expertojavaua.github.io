<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.2">
<meta name="author" content="Otto Colomina">
<title>Backbone.js</title>
<style>/*! normalize.css v2.1.2 | MIT License | git.io/normalize */
/* ========================================================================== HTML5 display definitions ========================================================================== */
/** Correct `block` display not defined in IE 8/9. */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }

/** Correct `inline-block` display not defined in IE 8/9. */
audio, canvas, video { display: inline-block; }

/** Prevent modern browsers from displaying `audio` without controls. Remove excess height in iOS 5 devices. */
audio:not([controls]) { display: none; height: 0; }

/** Address `[hidden]` styling not present in IE 8/9. Hide the `template` element in IE, Safari, and Firefox < 22. */
[hidden], template { display: none; }

script { display: none !important; }

/* ========================================================================== Base ========================================================================== */
/** 1. Set default font family to sans-serif. 2. Prevent iOS text size adjust after orientation change, without disabling user zoom. */
html { font-family: sans-serif; /* 1 */ -ms-text-size-adjust: 100%; /* 2 */ -webkit-text-size-adjust: 100%; /* 2 */ }

/** Remove default margin. */
body { margin: 0; }

/* ========================================================================== Links ========================================================================== */
/** Remove the gray background color from active links in IE 10. */
a { background: transparent; }

/** Address `outline` inconsistency between Chrome and other browsers. */
a:focus { outline: thin dotted; }

/** Improve readability when focused and also mouse hovered in all browsers. */
a:active, a:hover { outline: 0; }

/* ========================================================================== Typography ========================================================================== */
/** Address variable `h1` font-size and margin within `section` and `article` contexts in Firefox 4+, Safari 5, and Chrome. */
h1 { font-size: 2em; margin: 0.67em 0; }

/** Address styling not present in IE 8/9, Safari 5, and Chrome. */
abbr[title] { border-bottom: 1px dotted; }

/** Address style set to `bolder` in Firefox 4+, Safari 5, and Chrome. */
b, strong { font-weight: bold; }

/** Address styling not present in Safari 5 and Chrome. */
dfn { font-style: italic; }

/** Address differences between Firefox and other browsers. */
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }

/** Address styling not present in IE 8/9. */
mark { background: #ff0; color: #000; }

/** Correct font family set oddly in Safari 5 and Chrome. */
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }

/** Improve readability of pre-formatted text in all browsers. */
pre { white-space: pre-wrap; }

/** Set consistent quote types. */
q { quotes: "\201C" "\201D" "\2018" "\2019"; }

/** Address inconsistent and variable font size in all browsers. */
small { font-size: 80%; }

/** Prevent `sub` and `sup` affecting `line-height` in all browsers. */
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }

sup { top: -0.5em; }

sub { bottom: -0.25em; }

/* ========================================================================== Embedded content ========================================================================== */
/** Remove border when inside `a` element in IE 8/9. */
img { border: 0; }

/** Correct overflow displayed oddly in IE 9. */
svg:not(:root) { overflow: hidden; }

/* ========================================================================== Figures ========================================================================== */
/** Address margin not present in IE 8/9 and Safari 5. */
figure { margin: 0; }

/* ========================================================================== Forms ========================================================================== */
/** Define consistent border, margin, and padding. */
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }

/** 1. Correct `color` not being inherited in IE 8/9. 2. Remove padding so people aren't caught out if they zero out fieldsets. */
legend { border: 0; /* 1 */ padding: 0; /* 2 */ }

/** 1. Correct font family not being inherited in all browsers. 2. Correct font size not being inherited in all browsers. 3. Address margins set differently in Firefox 4+, Safari 5, and Chrome. */
button, input, select, textarea { font-family: inherit; /* 1 */ font-size: 100%; /* 2 */ margin: 0; /* 3 */ }

/** Address Firefox 4+ setting `line-height` on `input` using `!important` in the UA stylesheet. */
button, input { line-height: normal; }

/** Address inconsistent `text-transform` inheritance for `button` and `select`. All other form control elements do not inherit `text-transform` values. Correct `button` style inheritance in Chrome, Safari 5+, and IE 8+. Correct `select` style inheritance in Firefox 4+ and Opera. */
button, select { text-transform: none; }

/** 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio` and `video` controls. 2. Correct inability to style clickable `input` types in iOS. 3. Improve usability and consistency of cursor style between image-type `input` and others. */
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; /* 2 */ cursor: pointer; /* 3 */ }

/** Re-set default cursor for disabled elements. */
button[disabled], html input[disabled] { cursor: default; }

/** 1. Address box sizing set to `content-box` in IE 8/9. 2. Remove excess padding in IE 8/9. */
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; /* 1 */ padding: 0; /* 2 */ }

/** 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome. 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome (include `-moz` to future-proof). */
input[type="search"] { -webkit-appearance: textfield; /* 1 */ -moz-box-sizing: content-box; -webkit-box-sizing: content-box; /* 2 */ box-sizing: content-box; }

/** Remove inner padding and search cancel button in Safari 5 and Chrome on OS X. */
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }

/** Remove inner padding and border in Firefox 4+. */
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }

/** 1. Remove default vertical scrollbar in IE 8/9. 2. Improve readability and alignment in all browsers. */
textarea { overflow: auto; /* 1 */ vertical-align: top; /* 2 */ }

/* ========================================================================== Tables ========================================================================== */
/** Remove most spacing between table cells. */
table { border-collapse: collapse; border-spacing: 0; }

meta.foundation-mq-small { font-family: "only screen and (min-width: 768px)"; width: 768px; }

meta.foundation-mq-medium { font-family: "only screen and (min-width:1280px)"; width: 1280px; }

meta.foundation-mq-large { font-family: "only screen and (min-width:1440px)"; width: 1440px; }

*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }

html, body { font-size: 97%; }

body { background: white; color: #222222; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }

a:hover { cursor: pointer; }

img, object, embed { max-width: 100%; height: auto; }

object, embed { height: 100%; }

img { -ms-interpolation-mode: bicubic; }

#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }

.left { float: left !important; }

.right { float: right !important; }

.text-left { text-align: left !important; }

.text-right { text-align: right !important; }

.text-center { text-align: center !important; }

.text-justify { text-align: justify !important; }

.hide { display: none; }

.antialiased, body { -webkit-font-smoothing: antialiased; }

img { display: inline-block; vertical-align: middle; }

textarea { height: auto; min-height: 50px; }

select { width: 100%; }

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }

.subheader, .admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { line-height: 1.4; color: #6f6f6f; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }

/* Typography resets */
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }

/* Default Link Styles */
a { color: #1164be; text-decoration: none; line-height: inherit; }
a img { border: none; }

/* Default paragraph styles */
p { font-family: inherit; font-weight: normal; font-size: 1em; line-height: 1.4; margin-bottom: 1em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }

/* Default header styles */
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: bold; font-style: normal; color: #1c355e; text-rendering: optimizeLegibility; margin-top: 1em; margin-bottom: 0.5em; line-height: 1.2125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #6f6f6f; line-height: 0; }

h1 { font-size: 2.125em; }

h2 { font-size: 1.6875em; }

h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }

h4 { font-size: 1.125em; }

h5 { font-size: 1.125em; }

h6 { font-size: 1em; }

hr { border: solid #dddddd; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }

/* Helpful Typography Defaults */
em, i { font-style: italic; line-height: inherit; }

strong, b { font-weight: bold; line-height: inherit; }

small { font-size: 60%; line-height: inherit; }

code { font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: bold; }

/* Lists */
ul, ol, dl { font-size: 1em; line-height: 1.4; margin-bottom: 1.25em; list-style-position: outside; font-family: inherit; }

ul, ol { margin-left: 2.5em; }
ul.no-bullet, ol.no-bullet { margin-left: 1.5em; }

/* Unordered Lists */
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; /* Override nested font-size change */ }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }

/* Ordered Lists */
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }

/* Definition Lists */
dl dt { margin-bottom: 0.3125em; font-weight: bold; }
dl dd { margin-bottom: 1.25em; }

/* Abbreviations */
abbr, acronym { text-transform: uppercase; font-size: 90%; color: #222222; border-bottom: 1px dotted #dddddd; cursor: help; }

abbr { text-transform: none; }

/* Blockquotes */
blockquote { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
blockquote cite { display: block; font-size: 0.8125em; color: #555555; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #555555; }

blockquote, blockquote p { line-height: 1.6; color: #6f6f6f; }

/* Microformats */
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #dddddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }

.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }

/*@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.6875em; }
  h4 { font-size: 1.4375em; } }*/
/* Tables */
table { background: white; margin-bottom: 1.25em; border: solid 1px #dddddd; }
table thead, table tfoot { background: whitesmoke; font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: #222222; text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: #222222; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #f9f9f9; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.4; }

h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; border-bottom: 1px solid #dddddd }

.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }

*:not(pre) > code { font-size: inherit; font-style: normal !important; letter-spacing: 0; padding: 3px 2px 1px 2px; background-color: #eeeeee; border: 1px solid #dddddd; -webkit-border-radius: 0; border-radius: 0; line-height: inherit; font-weight: normal; }

pre, pre > code { line-height: 1.4; color: black; font-family: monospace, serif; font-weight: normal; }

.keyseq { color: #555555; }

kbd { display: inline-block; color: #222222; font-size: 0.75em; line-height: 1.4; background-color: #f7f7f7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; margin: -0.15em 0.15em 0 0.15em; padding: 0.2em 0.6em 0.2em 0.5em; vertical-align: middle; white-space: nowrap; }

.keyseq kbd:first-child { margin-left: 0; }

.keyseq kbd:last-child { margin-right: 0; }

.menuseq, .menu { color: #090909; }

b.button:before, b.button:after { position: relative; top: -1px; font-weight: normal; }

b.button:before { content: "["; padding: 0 3px 0 2px; }

b.button:after { content: "]"; padding: 0 2px 0 3px; }

#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 0.9375em; padding-right: 0.9375em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }

#content { margin-top: 1.25em; }

#content:before { content: none; }

#header > h1:first-child { color: black; margin-top: 2.25rem; margin-bottom: 0; }
#header > h1:first-child + #toc { margin-top: 8px; border-top: 1px solid #dddddd; }
#header > h1:only-child, body.toc2 #header > h1:nth-last-child(2) { border-bottom: 1px solid #dddddd; padding-bottom: 8px; }
#header .details { border-bottom: 1px solid #dddddd; line-height: 1.45; padding-top: 0.25em; padding-bottom: 0.25em; padding-left: 0.25em; color: #555555; display: -ms-flexbox; display: -webkit-flex; display: flex; -ms-flex-flow: row wrap; -webkit-flex-flow: row wrap; flex-flow: row wrap; }
#header .details span:first-child { margin-left: -0.125em; }
#header .details span.email a { color: #6f6f6f; }
#header .details br { display: none; }
#header .details br + span:before { content: "\00a0\2013\00a0"; }
#header .details br + span.author:before { content: "\00a0\22c5\00a0"; color: #6f6f6f; }
#header .details br + span#revremark:before { content: "\00a0|\00a0"; }
#header #revnumber { text-transform: capitalize; }
#header #revnumber:after { content: "\00a0"; }

#content > h1:first-child:not([class]) { color: black; border-bottom: 1px solid #dddddd; padding-bottom: 8px; margin-top: 0; padding-top: 1rem; margin-bottom: 1.25rem; }

#floating {
  position: fixed;
  z-index: 1000;
  padding: 0.5em;
  right: 0;
  top: 0;
  background: white;
  box-shadow: 0 0 1em #777777;
  -webkit-box-shadow: 0 0 1em #777777;
  -moz-box-shadow: 0 0 1em #777777;
  -webkit-border-bottom-left-radius: 5px;
  -moz-border-radius-bottomleft: 5px;
  max-height: 80%;
  overflow: auto;
}

#floating #full { display: none; } /* Hide the full TOC by default */

#floating:hover #full{
  display: block; /* Show it on hover */
}


#toc { border-bottom: 1px solid #dddddd; padding-bottom: 0.5em; }
#toc > ul { margin-left: 0.125em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin: 0.5em 0; }
#toc ul { font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; list-style-type: none; }
#toc a { text-decoration: none; }
#toc a:active { text-decoration: underline; }

#toctitle { color: #6f6f6f; font-size: 1.2em; }

@media only screen and (min-width: 768px) { #toctitle { font-size: 1.375em; }
  body.toc2 { padding-left: 15em; padding-right: 0; }
  #toc.toc2 { margin-top: 0 !important; background-color: #f2f2f2; position: fixed; width: 15em; left: 0; top: 0; border-right: 1px solid #dddddd; border-top-width: 0 !important; border-bottom-width: 0 !important; z-index: 1000; padding: 1.25em 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; font-size: 1.2em; }
  #toc.toc2 > ul { font-size: 0.9em; margin-bottom: 0; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 15em; }
  body.toc2.toc-right #toc.toc2 { border-right-width: 0; border-left: 1px solid #dddddd; left: auto; right: 0; } }
@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; padding-right: 0; }
  #toc.toc2 { width: 20em; }
  #toc.toc2 #toctitle { font-size: 1.375em; }
  #toc.toc2 > ul { font-size: 0.95em; }
  #toc.toc2 ul ul { padding-left: 1.25em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; } }
#content #toc { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 0; border-radius: 0; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }

#footer { max-width: 100%; background-color: #222222; padding: 1.25em; }

#footer-text { color: #dddddd; line-height: 1.44; }

.sect1 { padding-bottom: 0.625em; }

@media only screen and (min-width: 768px) { .sect1 { padding-bottom: 1.25em; } }
.sect1 + .sect1 { border-top: 1px solid #dddddd; }

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; z-index: 1001; width: 1.5ex; margin-left: -1.5ex; display: block; text-decoration: none !important; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: "\00A7"; font-size: 0.85em; display: block; padding-top: 0.1em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #222222; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #151515; }

.audioblock, .imageblock, .literalblock, .listingblock, .stemblock, .videoblock { margin-bottom: 1.25em; }

.admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-rendering: optimizeLegibility; text-align: left; }

table.tableblock > caption.title { white-space: nowrap; overflow: visible; max-width: 0; }

.paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { color: black; }

table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }

.admonitionblock > table { border-collapse: separate; border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #dddddd; color: #555555; }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }

.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 0; border-radius: 0; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }

.sidebarblock { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 0; border-radius: 0; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock > .content > .title { color: #6f6f6f; margin-top: 0; }

.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }

.literalblock pre, .listingblock pre:not(.highlight), .listingblock pre[class="highlight"], .listingblock pre[class^="highlight "], .listingblock pre.CodeRay, .listingblock pre.prettyprint { background: #eeeeee; }
.sidebarblock .literalblock pre, .sidebarblock .listingblock pre:not(.highlight), .sidebarblock .listingblock pre[class="highlight"], .sidebarblock .listingblock pre[class^="highlight "], .sidebarblock .listingblock pre.CodeRay, .sidebarblock .listingblock pre.prettyprint { background: #f2f1f1; }

.literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { border: 1px solid #cccccc; -webkit-border-radius: 0; border-radius: 0; word-wrap: break-word; padding: 0.8em 0.8em 0.65em 0.8em; font-size: 0.8125em; }
.literalblock pre.nowrap, .literalblock pre[class].nowrap, .listingblock pre.nowrap, .listingblock pre[class].nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
@media only screen and (min-width: 768px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 0.90625em; } }
@media only screen and (min-width: 1280px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 1em; } }

.literalblock.output pre { color: #eeeeee; background-color: black; }

.listingblock pre.highlightjs { padding: 0; }
.listingblock pre.highlightjs > code { padding: 0.8em 0.8em 0.65em 0.8em; -webkit-border-radius: 0; border-radius: 0; }

.listingblock > .content { position: relative; }

.listingblock code[data-lang]:before { display: none; content: attr(data-lang); position: absolute; font-size: 0.75em; top: 0.425rem; right: 0.5rem; line-height: 1; text-transform: uppercase; color: #999; }

.listingblock:hover code[data-lang]:before { display: block; }

.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }

.listingblock.terminal pre .command:not([data-prompt]):before { content: "$"; }

table.pyhltable { border-collapse: separate; border: 0; margin-bottom: 0; background: none; }

table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; }

table.pyhltable td.code { padding-left: .75em; padding-right: 0; }

pre.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #dddddd; }

pre.pygments .lineno { display: inline-block; margin-right: .25em; }

table.pyhltable .linenodiv { background: none !important; padding-right: 0 !important; }

.quoteblock { margin: 0 1em 1.25em 1.5em; display: table; }
.quoteblock > .title { margin-left: -1.5em; margin-bottom: 0.75em; }
.quoteblock blockquote, .quoteblock blockquote p { color: #6f6f6f; font-size: 1.15rem; line-height: 1.75; word-spacing: 0.1em; letter-spacing: 0; font-style: italic; text-align: justify; }
.quoteblock blockquote { margin: 0; padding: 0; border: 0; }
.quoteblock blockquote:before { content: "\201c"; float: left; font-size: 2.75em; font-weight: bold; line-height: 0.6em; margin-left: -0.6em; color: #6f6f6f; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: 0.5em; margin-right: 0.5ex; text-align: right; }
.quoteblock .quoteblock { margin-left: 0; margin-right: 0; padding: 0.5em 0; border-left: 3px solid #555555; }
.quoteblock .quoteblock blockquote { padding: 0 0 0 0.75em; }
.quoteblock .quoteblock blockquote:before { display: none; }

.verseblock { margin: 0 1em 1.25em 1em; }
.verseblock pre { font-family: "Open Sans", "DejaVu Sans", sans; font-size: 1.15rem; color: #6f6f6f; font-weight: 300; text-rendering: optimizeLegibility; }
.verseblock pre strong { font-weight: 400; }
.verseblock .attribution { margin-top: 1.25rem; margin-left: 0.5ex; }

.quoteblock .attribution, .verseblock .attribution { font-size: 0.8125em; line-height: 1.45; font-style: italic; }
.quoteblock .attribution br, .verseblock .attribution br { display: none; }
.quoteblock .attribution cite, .verseblock .attribution cite { display: block; letter-spacing: -0.05em; color: #555555; }

.quoteblock.abstract { margin: 0 0 1.25em 0; display: block; }
.quoteblock.abstract blockquote, .quoteblock.abstract blockquote p { text-align: left; word-spacing: 0; }
.quoteblock.abstract blockquote:before, .quoteblock.abstract blockquote p:first-of-type:before { display: none; }

table.tableblock { max-width: 100%; border-collapse: separate; }
table.tableblock td > .paragraph:last-child p > p:last-child, table.tableblock th > p:last-child, table.tableblock td > p:last-child { margin-bottom: 0; }

table.spread { width: 100%; }

table.tableblock, th.tableblock, td.tableblock { border: 0 solid #dddddd; }

table.grid-all th.tableblock, table.grid-all td.tableblock { border-width: 0 1px 1px 0; }

table.grid-all tfoot > tr > th.tableblock, table.grid-all tfoot > tr > td.tableblock { border-width: 1px 1px 0 0; }

table.grid-cols th.tableblock, table.grid-cols td.tableblock { border-width: 0 1px 0 0; }

table.grid-all * > tr > .tableblock:last-child, table.grid-cols * > tr > .tableblock:last-child { border-right-width: 0; }

table.grid-rows th.tableblock, table.grid-rows td.tableblock { border-width: 0 0 1px 0; }

table.grid-all tbody > tr:last-child > th.tableblock, table.grid-all tbody > tr:last-child > td.tableblock, table.grid-all thead:last-child > tr > th.tableblock, table.grid-rows tbody > tr:last-child > th.tableblock, table.grid-rows tbody > tr:last-child > td.tableblock, table.grid-rows thead:last-child > tr > th.tableblock { border-bottom-width: 0; }

table.grid-rows tfoot > tr > th.tableblock, table.grid-rows tfoot > tr > td.tableblock { border-width: 1px 0 0 0; }

table.frame-all { border-width: 1px; }

table.frame-sides { border-width: 0 1px; }

table.frame-topbot { border-width: 1px 0; }

th.halign-left, td.halign-left { text-align: left; }

th.halign-right, td.halign-right { text-align: right; }

th.halign-center, td.halign-center { text-align: center; }

th.valign-top, td.valign-top { vertical-align: top; }

th.valign-bottom, td.valign-bottom { vertical-align: bottom; }

th.valign-middle, td.valign-middle { vertical-align: middle; }

table thead th, table tfoot th { font-weight: bold; }

tbody tr th { display: table-cell; line-height: 1.4; background: whitesmoke; }

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p { color: #222222; font-weight: bold; }

p.tableblock > code:only-child { background: none; padding: 0; }

p.tableblock { font-size: 1em; }

td > div.verse { white-space: pre; }

ol { margin-left: 2.5em; }

ul li ol { margin-left: 1.5em; }

dl dd { margin-left: 1.125em; }

dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }

ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.625em; }

ul.unstyled, ol.unnumbered, ul.checklist, ul.none { list-style-type: none; }

ul.unstyled, ol.unnumbered, ul.checklist { margin-left: 0.625em; }

ul.checklist li > p:first-child > .fa-check-square-o:first-child, ul.checklist li > p:first-child > input[type="checkbox"]:first-child { margin-right: 0.25em; }

ul.checklist li > p:first-child > input[type="checkbox"]:first-child { position: relative; top: 1px; }

ul.inline { margin: 0 auto 0.625em auto; margin-left: -1.375em; margin-right: 0; padding: 0; list-style: none; overflow: hidden; }
ul.inline > li { list-style: none; float: left; margin-left: 1.375em; display: block; }
ul.inline > li > * { display: block; }

.unstyled dl dt { font-weight: normal; font-style: normal; }

ol.arabic { list-style-type: decimal; }

ol.decimal { list-style-type: decimal-leading-zero; }

ol.loweralpha { list-style-type: lower-alpha; }

ol.upperalpha { list-style-type: upper-alpha; }

ol.lowerroman { list-style-type: lower-roman; }

ol.upperroman { list-style-type: upper-roman; }

ol.lowergreek { list-style-type: lower-greek; }

.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }

td.hdlist1 { padding-right: .75em; font-weight: bold; }

td.hdlist1, td.hdlist2 { vertical-align: top; }

.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }

.colist > table tr > td:first-of-type { padding: 0 0.75em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.25em 0; }

.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: 0 0 0 1px #dddddd; box-shadow: 0 0 0 1px #dddddd; }

.imageblock.left, .imageblock[style*="float: left"] { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }

.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }

a.image { text-decoration: none; }

span.footnote, span.footnoteref { vertical-align: super; font-size: 0.875em; }
span.footnote a, span.footnoteref a { text-decoration: none; }
span.footnote a:active, span.footnoteref a:active { text-decoration: underline; }

#footnotes { padding-top: 0.75em; padding-bottom: 0.75em; margin-bottom: 0.625em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -.25em 0 .75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.375em; line-height: 1.3; font-size: 0.875em; margin-left: 1.2em; text-indent: -1.2em; margin-bottom: .2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }

#content #footnotes { margin-top: -0.625em; margin-bottom: 0; padding: 0.75em 0; }

.gist .file-data > table { border: 0; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }

div.unbreakable { page-break-inside: avoid; }

.big { font-size: larger; }

.small { font-size: smaller; }

.underline { text-decoration: underline; }

.overline { text-decoration: overline; }

.line-through { text-decoration: line-through; }

.aqua { color: #00bfbf; }

.aqua-background { background-color: #00fafa; }

.black { color: black; }

.black-background { background-color: black; }

.blue { color: #0000bf; }

.blue-background { background-color: #0000fa; }

.fuchsia { color: #bf00bf; }

.fuchsia-background { background-color: #fa00fa; }

.gray { color: #606060; }

.gray-background { background-color: #7d7d7d; }

.green { color: #006000; }

.green-background { background-color: #007d00; }

.lime { color: #00bf00; }

.lime-background { background-color: #00fa00; }

.maroon { color: #600000; }

.maroon-background { background-color: #7d0000; }

.navy { color: #000060; }

.navy-background { background-color: #00007d; }

.olive { color: #606000; }

.olive-background { background-color: #7d7d00; }

.purple { color: #600060; }

.purple-background { background-color: #7d007d; }

.red { color: #bf0000; }

.red-background { background-color: #fa0000; }

.silver { color: #909090; }

.silver-background { background-color: #bcbcbc; }

.teal { color: #006060; }

.teal-background { background-color: #007d7d; }

.white { color: #bfbfbf; }

.white-background { background-color: #fafafa; }

.yellow { color: #bfbf00; }

.yellow-background { background-color: #fafa00; }

span.icon > .fa { cursor: default; }

.admonitionblock td.icon [class^="fa icon-"] { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #207c98; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }

.conum[data-value] { display: inline-block; color: #fff !important; background-color: #222222; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; font-size: 0.75em; width: 1.67em; height: 1.67em; line-height: 1.67em; font-family: "Open Sans", "DejaVu Sans", sans-serif; font-style: normal; font-weight: bold; }
.conum[data-value] * { color: #fff !important; }
.conum[data-value] + b { display: none; }
.conum[data-value]:after { content: attr(data-value); }
pre .conum[data-value] { position: relative; top: -0.125em; }

b.conum * { color: inherit !important; }

.conum:not([data-value]):empty { display: none; }

.literalblock pre, .listingblock pre { background: #eeeeee; }

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.min.css">
<style>.listingblock .pygments .hll { background-color: #ffffcc }
.listingblock .pygments  { background: #f8f8f8; }
.listingblock .pygments .tok-c { color: #408080; font-style: italic } /* Comment */
.listingblock .pygments .tok-err { border: 1px solid #FF0000 } /* Error */
.listingblock .pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
.listingblock .pygments .tok-o { color: #666666 } /* Operator */
.listingblock .pygments .tok-cm { color: #408080; font-style: italic } /* Comment.Multiline */
.listingblock .pygments .tok-cp { color: #BC7A00 } /* Comment.Preproc */
.listingblock .pygments .tok-c1 { color: #408080; font-style: italic } /* Comment.Single */
.listingblock .pygments .tok-cs { color: #408080; font-style: italic } /* Comment.Special */
.listingblock .pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
.listingblock .pygments .tok-ge { font-style: italic } /* Generic.Emph */
.listingblock .pygments .tok-gr { color: #FF0000 } /* Generic.Error */
.listingblock .pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
.listingblock .pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
.listingblock .pygments .tok-go { color: #888888 } /* Generic.Output */
.listingblock .pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.listingblock .pygments .tok-gs { font-weight: bold } /* Generic.Strong */
.listingblock .pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.listingblock .pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
.listingblock .pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.listingblock .pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.listingblock .pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.listingblock .pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
.listingblock .pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.listingblock .pygments .tok-kt { color: #B00040 } /* Keyword.Type */
.listingblock .pygments .tok-m { color: #666666 } /* Literal.Number */
.listingblock .pygments .tok-s { color: #BA2121 } /* Literal.String */
.listingblock .pygments .tok-na { color: #7D9029 } /* Name.Attribute */
.listingblock .pygments .tok-nb { color: #008000 } /* Name.Builtin */
.listingblock .pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
.listingblock .pygments .tok-no { color: #880000 } /* Name.Constant */
.listingblock .pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
.listingblock .pygments .tok-ni { color: #999999; font-weight: bold } /* Name.Entity */
.listingblock .pygments .tok-ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.listingblock .pygments .tok-nf { color: #0000FF } /* Name.Function */
.listingblock .pygments .tok-nl { color: #A0A000 } /* Name.Label */
.listingblock .pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.listingblock .pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
.listingblock .pygments .tok-nv { color: #19177C } /* Name.Variable */
.listingblock .pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.listingblock .pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
.listingblock .pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
.listingblock .pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
.listingblock .pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
.listingblock .pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
.listingblock .pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
.listingblock .pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
.listingblock .pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
.listingblock .pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.listingblock .pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
.listingblock .pygments .tok-se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.listingblock .pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
.listingblock .pygments .tok-si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.listingblock .pygments .tok-sx { color: #008000 } /* Literal.String.Other */
.listingblock .pygments .tok-sr { color: #BB6688 } /* Literal.String.Regex */
.listingblock .pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
.listingblock .pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
.listingblock .pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
.listingblock .pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
.listingblock .pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
.listingblock .pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
.listingblock .pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Backbone.js</h1>
<div class="details">
<span id="author" class="author">Otto Colomina</span><br>
<span id="email" class="email">&lt;<a href="mailto:otto@dccia.ua.es">otto@dccia.ua.es</a>&gt;</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Índice de contenidos</div>
<ul class="sectlevel1">
<li><a href="#sesion01">1. Hola MVC en Javascript, Hola Backbone</a>
<ul class="sectlevel2">
<li><a href="#_mvc_y_las_aplicaciones_javascript">1.1. MVC y las aplicaciones Javascript</a></li>
<li><a href="#__em_frameworks_em_mvc_en_javascript_backbone">1.2. <em>Frameworks</em> MVC en Javascript. Backbone</a></li>
<li><a href="#_un_ejemplo_b%C3%A1sico_de_aplicaci%C3%B3n_backbone_el_em_widget_em_del_tiempo">1.3. Un ejemplo básico de aplicación Backbone : el <em>widget</em> del tiempo</a></li>
<li><a href="#sesion01ejer">1.4. Ejercicios de introducción a Backbone</a></li>
</ul>
</li>
<li><a href="#sesion02">2. Modelos y colecciones</a>
<ul class="sectlevel2">
<li><a href="#_modelos_funcionalidades_b%C3%A1sicas">2.1. Modelos. Funcionalidades básicas</a></li>
<li><a href="#_persistencia_con_apis_rest">2.2. Persistencia con APIs REST</a></li>
<li><a href="#_colecciones">2.3. Colecciones</a></li>
<li><a href="#_eventos_2">2.4. Eventos</a></li>
<li><a href="#_configuraci%C3%B3n_de_la_comunicaci%C3%B3n_con_el_api_rest">2.5. Configuración de la comunicación con el API REST</a></li>
<li><a href="#sesion02ejer">2.6. Ejercicios de modelos y colecciones</a></li>
</ul>
</li>
<li><a href="#sesion03">3. Vistas y templates. Routing</a>
<ul class="sectlevel2">
<li><a href="#_vistas">3.1. Vistas</a></li>
<li><a href="#_vistas_y_modelos">3.2. Vistas y modelos</a></li>
<li><a href="#__em_templates_em_plantillas_el_lenguaje_de_plantillas_mustache">3.3. <em>Templates</em> (plantillas). El lenguaje de plantillas Mustache</a></li>
<li><a href="#_routers">3.4. Routers</a></li>
<li><a href="#sesion03ejer">3.5. Ejercicios de vistas</a></li>
</ul>
</li>
<li><a href="#sesion04">4. Jerarquías de vistas</a>
<ul class="sectlevel2">
<li><a href="#_listados_din%C3%A1micos">4.1. Listados dinámicos</a></li>
<li><a href="#_composici%C3%B3n_gen%C3%A9rica_de_vistas">4.2. Composición genérica de vistas</a></li>
<li><a href="#sesion04ejer">4.3. Ejercicios de jerarquías de vistas</a></li>
</ul>
</li>
<li><a href="#sesion05">5. Miniproyecto de aplicación con Backbone y Marionette</a>
<ul class="sectlevel2">
<li><a href="#_requerimientos">5.1. Requerimientos</a></li>
<li><a href="#_implementaci%C3%B3n_de_los_requerimientos_iniciales">5.2. Implementación de los requerimientos "iniciales"</a></li>
<li><a href="#_requerimientos_adicionales_1_punto_en_total">5.3. Requerimientos "adicionales" (1 punto en total)</a></li>
</ul>
</li>
<li><a href="#sesion06">6. Interfaces web con ReactJS</a>
<ul class="sectlevel2">
<li><a href="#__por_qu%C3%A9_reactjs">6.1. ¿Por qué ReactJS?</a></li>
<li><a href="#__hola_react_nuestros_primeros_componentes">6.2. ¡Hola React!. Nuestros primeros componentes</a></li>
<li><a href="#_componentes_sin_estado_propiedades">6.3. Componentes sin estado. Propiedades</a></li>
<li><a href="#_componentes_con_estado">6.4. Componentes con estado</a></li>
<li><a href="#_interactividad_eventos">6.5. Interactividad. Eventos</a></li>
<li><a href="#_jsx">6.6. JSX</a></li>
<li><a href="#_manejo_de_formularios">6.7. Manejo de formularios</a></li>
<li><a href="#sesion06ejer">6.8. Ejercicios de React (I)</a></li>
</ul>
</li>
<li><a href="#sesion07">7. Interfaces web con ReactJS (II)</a>
<ul class="sectlevel2">
<li><a href="#_composici%C3%B3n_de_componentes">7.1. Composición de componentes</a></li>
<li><a href="#_ciclo_de_vida_de_un_componente">7.2. Ciclo de vida de un componente</a></li>
<li><a href="#_react_y_backbone">7.3. React y Backbone</a></li>
<li><a href="#sesion07ejer">7.4. Ejercicios de React (II)</a></li>
</ul>
</li>
<li><a href="#sesion08">8. Introducción a la arquitectura Flux para aplicaciones React</a>
<ul class="sectlevel2">
<li><a href="#__por_qu%C3%A9_flux">8.1. ¿ Por qué Flux?</a></li>
<li><a href="#_flux_a_grandes_rasgos">8.2. Flux a grandes rasgos</a></li>
<li><a href="#_un_ejemplo_sencillo">8.3. Un ejemplo sencillo</a></li>
<li><a href="#sesion08ejer">8.4. Ejercicio de Flux (1,25 puntos en total)</a></li>
</ul>
</li>
<li><a href="#apendice01">9. Apéndice: Herramientas para gestionar el flujo de trabajo en el desarrollo <em>frontend</em></a>
<ul class="sectlevel2">
<li><a href="#_gesti%C3%B3n_de_paquetes_con_code_bower_code">9.1. Gestión de paquetes con <code>Bower</code></a></li>
<li><a href="#_creaci%C3%B3n_de_plantillas_con_code_yeoman_code">9.2. Creación de plantillas con <code>Yeoman</code></a></li>
<li><a href="#_npm_em_bundler_em">9.3. npm + <em>bundler</em></a></li>
</ul>
</li>
<li><a href="#apendice02">10. Apéndice: <em>testing</em> con Backbone</a>
<ul class="sectlevel2">
<li><a href="#_introducci%C3%B3n_a_jasmine">10.1. Introducción a Jasmine</a></li>
<li><a href="#_pruebas_con_jasmine_en_backbone">10.2. Pruebas con Jasmine en Backbone</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="sesion01">1. Hola MVC en Javascript, Hola Backbone</h2>
<div class="sectionbody">
<div class="paragraph">
<p>En esta primera sesión vamos a hacer una breve introducción al patrón MVC (Modelo/Vista/Controlador) y cómo en los últimos años se ha desplazado del servidor hacia el cliente. También veremos los conceptos básicos de Backbone e implementaremos una pequeña aplicación, que muestre cómo se aplican estos conceptos en la práctica. En el resto de sesiones de la asignatura iremos profundizando en las distintas funcionalidades de Backbone.</p>
</div>
<div class="sect2">
<h3 id="_mvc_y_las_aplicaciones_javascript">1.1. MVC y las aplicaciones Javascript</h3>
<div class="paragraph">
<p>El patrón <strong>MVC</strong> o <strong>Modelo/Vista/Controlador</strong> es uno de los patrones de diseño arquitectónicos más conocidos y usados en la actualidad. La idea básica consiste en que deseamos separar el <strong>modelo</strong>, esto es, los datos de nuestra aplicación, de la <strong>vista</strong>, es decir, de su presentación en la interfaz de usuario. Como veremos esta idea básica admite multitud de variantes, motivo por el cual en esta definición básica no hemos introducido al <strong>controlador</strong>. Según la variante de MVC cambia el papel exacto que debe desempeñar el controlador, o cómo se pueden comunicar entre sí los tres componentes.</p>
</div>
<div class="sect3">
<h4 id="_mvc_en_la_web_servidor">1.1.1. MVC en la web (servidor)</h4>
<div class="paragraph">
<p>MVC es un patrón omnipresente en el lado del servidor. Existe en todas las plataformas web: JSF, Struts o Spring MVC en JavaEE, ASP.NET MVC en .NET, CakePHP, Symphony, Codeigniter y otros en PHP, Rails en Ruby, Django en Python,&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>A finales de los 90, Sun propugnó lo que dio en llamar "modelo 2" como patrón básico de arquitectura para aplicaciones web basadas en servlets y JSPs. Con mayores o menores modificaciones, este modelo fue la base de Struts y otros <em>frameworks</em> MVC del mundo JavaEE como Spring MVC. En el <em>modelo 2</em>, las peticiones del cliente las recibe un <em>servlet</em>, que hace el papel de <strong>controlador</strong>, y que delega la lógica de negocio en un conjunto de JavaBeans (el <strong>modelo</strong>). Finalmente el control se transfiere a un JSP (la <strong>vista</strong>), que muestra los resultados al usuario. No obstante, Sun nunca llegó a estandarizar un API o un <em>framework</em> para implementar MVC en nuestras aplicaciones.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/01/modelo2.png" alt="Modelo 2 de aplicaciones JSP" width="50%">
</div>
<div class="title">Figure 1. Modelo 2 de aplicaciones JSP. (By Libertyernie2 - Own work. CC BY-SA 3.0 via Wikimedia Commons)</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
En realidad, JSF podría considerarse el <em>framework</em> MVC estándar de JavaEE, pero su filosofía es muy distinta a la de otros como Struts o Spring MVC. JSF está orientado a <em>componentes</em>, mientras que los otros están orientados a <em>acciones</em> (aquí podéis ver  <a href="http://www.oracle.com/technetwork/articles/java/mvc-2280472.html">una comparación</a>). Además MVC en realidad es solo una pequeña parte de JSF, siendo su parte más importante todo el tema de componentes de usuario. Por ello se está en proceso de elaboración de un JSR para elaborar un <a href="https://jcp.org/en/jsr/detail?id=371">estándar de MVC en JavaEE</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En la actualidad, en un mundo de aplicaciones web convertidas en "simples" APIs en el lado del servidor, la antigua preponderancia de MVC en el servidor parece haberse difuminado un poco. Lo que es lógico, ya que la vista se ha trasladado al cliente. Así, la "necesidad" de usar MVC para estructurar la aplicación ha acabado trasladándose también al lado del cliente.</p>
</div>
</div>
<div class="sect3">
<h4 id="_mvc_en_la_web_cliente">1.1.2. MVC en la web (cliente)</h4>
<div class="paragraph">
<p>Cuando el uso de Javascript se limitaba a cosas como validación de formularios, pequeños cálculos y algunos efectos visuales MVC en el cliente no hacía una gran falta. El interfaz ya venía construido desde el servidor en forma de plantillas, y asímismo el servidor ya generaba casi todos los datos que se le mostraban al usuario. Pero en la actualidad se tiende a ir hacia SPAs (Single Page Applications), en las que básicamente <strong>la interfaz se construye dinámicamente con Javascript</strong>, lo que incluye también el formateo y presentación de los datos que está viendo el usuario, y la gestión de los nuevos que crea. Esto implica que desde Javascript también debemos poder manipular el modelo y ejecutar lógica de negocio. El servidor se queda como una especie de fuente de datos remota. Como vemos, prácticamente todo el esquema del antiguo "modelo 2" se ha trasladado al cliente.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="__em_frameworks_em_mvc_en_javascript_backbone">1.2. <em>Frameworks</em> MVC en Javascript. Backbone</h3>
<div class="paragraph">
<p>En una época en la que parece que hay que usar un <em>framework</em> para todo, el interés de llevar MVC al cliente provocó la aparición de multitud de <em>frameworks</em> MVC para Javascript. Surgieron tantas alternativas diferentes que en una cierta época era realmente difícil poder <a href="http://www.smashingmagazine.com/2012/07/27/journey-through-the-javascript-mvc-jungle/">decidirse por uno de ellos</a>. En <a href="http://todomvc.com/">TodoMVC</a> se usa una idea interesante que es escribir una aplicación de referencia (la típica lista de tareas) en cada uno de los <em>frameworks</em> para que el código hable por sí mismo.</p>
</div>
<div class="sect3">
<h4 id="_características_de_backbone">1.2.1. Características de Backbone</h4>
<div class="paragraph">
<p>Backbone fue uno de los primeros <em>frameworks</em> MVC en hacerse popular. Su filosofía va en la línea de lo que los anglosajones llaman <strong>"non opinionated"</strong>, es decir, un <em>framework</em> que da libertad al desarrollador para hacer las cosas con su propio estilo, y no impone cierta forma de trabajar. Esto si lo queremos ver desde el punto de vista negativo, hace que el proceso de aprendizaje esté mezclado con cierta inseguridad para el desarrollador, ya que nunca acaba de tener claro "si lo está haciendo bien".</p>
</div>
<div class="paragraph">
<p>Otro aspecto que define el carácter de Backbone es la <strong>simplicidad</strong>. Es pequeño en términos de número de líneas de código y por tanto las funcionalidades que ofrece "tal cual" son limitadas. No ofrece facilidades "automágicas", casi todo está bajo control del desarrollador. Esto ha hecho que surjan multitud de <em>plugins</em> para cubrir las funcionalidaes que Backbone no tiene y sí tienen otros <em>frameworks</em> más complejos.</p>
</div>
</div>
<div class="sect3">
<h4 id="_estructura_conceptual_de_una_aplicación_backbone">1.2.2. Estructura conceptual de una aplicación Backbone</h4>
<div class="paragraph">
<p>Cuando se habla de MVC, siempre surge la duda de exactamente de qué tipo de MVC se está hablando. Desde que apareció la <a href="http://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93controller#History">versión original</a> del patrón en los 70, en el contexto de aplicaciones de escritorio desarrolladas en Smalltalk, han surgido <a href="http://kasparov.skife.org/blog/src/java/mvc.html">multitud de variantes</a>, en las que cambian los <em>roles</em> que desarrolla exactamente cada uno de los componentes "Modelo/Vista/Controlador" o el flujo de información que hay entre ellos. Incluso hay versiones en las que alguno de los componentes del trío original desaparece y es sustituído por otros, como MVP (Model/View/Presenter), MVVM (Model/View/ViewModel),&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Backbone no es exactamente MVC, más que nada porque directamente carece de controladores. En cuanto a <a href="http://lostechies.com/derickbailey/2011/12/23/backbone-js-is-not-an-mvc-framework/">qué es entonces, exactamente</a> no lo vamos a responder aquí, más que nada porque es una <a href="http://stackoverflow.com/questions/10745782/is-backbone-js-really-an-mvc">discusión probablamente infructuosa</a> y que en cualquier caso no va a ayudar a comprender mejor su funcionamiento. Nos conformaremos con llamarlo MV*, como dicen los anglosajones, MV- <em>whatever</em>, o MV- <em>loquesea</em>.</p>
</div>
<div class="paragraph">
<p>Teniendo presente lo que acabamos de decir, la siguiente figura mostraría una <strong>posible estructura</strong> conceptual de una aplicación Backbone (posible porque también podríamos estructurar las cosas de otro modo y tampoco "estaría mal"). La figura está tomada del libro de <a href="https://twitter.com/addyosmani">Addy Osmani</a> <a href="http://shop.oreilly.com/product/0636920025344.do">"Developing Backbone Applications"</a>, que además está <a href="http://addyosmani.github.io/backbone-fundamentals/">disponible en Github</a></p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/01/backbone_mvc.png" alt="backbone mvc" width="100%">
</div>
<div class="title">Figure 2. Típico flujo de información en una aplicación Backbone</div>
</div>
<div class="paragraph">
<p>Como vemos en la figura, en el "corazón" de Backbone están los <strong>modelos</strong> y las <strong>vistas</strong>. Además, para reflejar el hecho de que típicamente en una aplicación vamos a manejar más de una instancia del mismo tipo de modelo (clientes, libros, mensajes,&#8230;&#8203;) Backbone modeliza también la idea de <strong>colección</strong> de modelos.</p>
</div>
<div class="paragraph">
<p>Las colecciones de modelos interactúan (se sincronizan, <em>sync</em>) con una fuente de datos, típicamente un API REST en el servidor.</p>
</div>
<div class="paragraph">
<p>Por otro lado, la vista interactúa con el HTML de la página. La vista actualiza el DOM, modificando así el HTML "en tiempo real" y en el sentido contrario, los eventos del DOM se procesan en la vista.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Hablar de DOM (o árbol HTML) y de vista como elementos separados nos puede dar la idea de que <strong>el concepto de vista</strong> no es igual en Backbone que en otros muchos <em>frameworks</em> MVC, en los que la vista es precisamente la interfaz, que en nuestro caso sería el HTML. Lo veremos con más profundidad en la sesión 3.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Vista y modelo se comunican mediante <strong>eventos</strong>. Esto se hace así para reducir el acoplamiento entre ambos. Es normal que la vista tenga que conocer ciertos detalles del modelo para poder interactuar con él, pero en general el modelo no debería tener que conocer cómo es la vista para comunicarse con ella. Así podremos reutilizar los modelos cambiando una vista por otra. Para solucionar este problema se usa el paradigma de comunicación "Publicar/Suscribir" (<em>Publish/Subscribe</em> o <em>Pub/Sub</em>). En este paradigma el objeto que quiere comunicarse con otro sin acoplarse con él no lo hace directamente sino <em>emitiendo eventos</em>. El objeto interesado se suscribe a esos eventos. En Backbone veremos que la vista se suscribe a los eventos que le interesan del modelo.</p>
</div>
<div class="paragraph">
<p>Para terminar, el <strong>router</strong> es un componente que asocia URLs con código Javascript. La idea es que cada operación o cada estado de nuestra aplicación debería identificarse con una URL, lo que permitiría que el usuario creara sin problemas sus <em>bookmarks</em>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_un_ejemplo_básico_de_aplicación_backbone_el_em_widget_em_del_tiempo">1.3. Un ejemplo básico de aplicación Backbone : el <em>widget</em> del tiempo</h3>
<div class="paragraph">
<p>En lugar de seguir discutiendo de manera abstracta sobre las funcionalidades, vamos a introducir los aspectos básicos del desarrollo en Backbone con un ejemplo sencillo.</p>
</div>
<div class="paragraph">
<p>Queremos implementar un <em>widget</em> donde se pueda consultar el tiempo que hace en una determinada localidad. Algo al estilo de lo que se muestra en la siguiente imagen:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/01/widget_tiempo.png" alt="widget tiempo" width="33%">
</div>
<div class="title">Figure 3. El aspecto del <em>widget</em> terminado</div>
</div>
<div class="paragraph">
<p>Como vemos, simplemente hay un campo de texto para teclear la localidad y al pulsar el botón aparecen los datos meteorológicos. Para obtener los datos reales usaremos un <a href="http://openweathermap.org">servicio externo</a>.</p>
</div>
<div class="sect3">
<h4 id="_el_modelo">1.3.1. El modelo</h4>
<div class="paragraph">
<p>Como ya hemos visto, el modelo es el <em>conjunto de objetos que forman el dominio de nuestra aplicación</em> y por tanto depende enteramente de su naturaleza: en un "campus virtual" tendremos  profesores, alumnos, notas, &#8230;&#8203; mientras que en una red social tendremos usuarios, mensajes, fotos, &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Los modelos son realmente las mismas entidades que usamos en la capa de negocio de la aplicación. En ellos encapsulamos por tanto dos aspectos: los <em>datos</em> y la <em>lógica de negocio</em>. En nuestro ejemplo del tiempo los datos serán los parámetros que definen el estado actual del tiempo (temperatura, humedad, descripción en modo texto: - <em>"soleado"</em>, <em>"nublado"</em>, &#8230;&#8203;-). La lógica de negocio se ocuparía de la comunicación con el servicio web remoto que nos ofrece los datos.</p>
</div>
<div class="paragraph">
<p>Backbone nos ofrece una "clase" base, <code>Backbone.Model</code>, que podemos extender para crear nuestros propios modelos. No es necesario especificar por adelantado las propiedades del modelo, se pueden crear en cualquier momento, igual que con los objetos Javascript convencionales</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">DatosTiempo</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">Model</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">();</span>  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kd">var</span> <span class="tok-nx">miTiempo</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">DatosTiempo</span><span class="tok-p">({</span><span class="tok-s2">&quot;localidad&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;Alicante&quot;</span><span class="tok-p">});</span>  <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">miTiempo</span><span class="tok-p">.</span><span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-s2">&quot;localidad&quot;</span><span class="tok-p">));</span> <i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-nx">miTiempo</span><span class="tok-p">.</span><span class="tok-nx">set</span><span class="tok-p">(</span><span class="tok-s2">&quot;localidad&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;San Vicente del Raspeig&quot;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Creamos la clase para representar nuestro modelo.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Creamos una instancia de dicha clase, y le asignamos una propiedad "localidad" con valor "Alicante".</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Como vemos, la clase <code>Model</code> nos proporciona <em>getters</em> y <em>setters</em>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Antes de ver cómo implementamos la lógica de negocio, necesitamos saber cómo funciona el API del servicio web. Básicamente hay que hacer una petición GET a <code><a href="http://api.openweathermap.org/data/2.5/weather" class="bare">http://api.openweathermap.org/data/2.5/weather</a></code> con el parámetro <code>q</code> igual al nombre de la localidad y el valor de nuestra API KEY como valor del parámetro APPID (podemos obtenerla <a href="https://home.openweathermap.org/users/sign_up">registrándonos en OpenWeatherMap</a>) . Podemos hacer pruebas provisionales con <code>APPID=1adb13e22f23c3de1ca37f3be90763a9</code>.</p>
</div>
<div class="paragraph">
<p>Si además añadimos los parámetros <code>units=metric&amp;lang=es</code> obtendremos el resultado en español usando unidades del sistema métrico. La respuesta será un JSON del estilo</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-s2">&quot;coord&quot;</span><span class="tok-o">:</span> <span class="tok-p">{</span>
  <span class="tok-s2">&quot;lon&quot;</span><span class="tok-o">:</span> <span class="tok-o">-</span><span class="tok-mf">0.48</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;lat&quot;</span><span class="tok-o">:</span> <span class="tok-mf">38.35</span>
<span class="tok-p">},</span>
<span class="tok-s2">&quot;sys&quot;</span><span class="tok-o">:</span> <span class="tok-p">{</span>
  <span class="tok-s2">&quot;message&quot;</span><span class="tok-o">:</span> <span class="tok-mf">0.1941</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;country&quot;</span><span class="tok-o">:</span> <span class="tok-s2">&quot;ES&quot;</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;sunrise&quot;</span><span class="tok-o">:</span> <span class="tok-mi">1423292456</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;sunset&quot;</span><span class="tok-o">:</span> <span class="tok-mi">1423330269</span>
<span class="tok-p">},</span>
<span class="tok-s2">&quot;weather&quot;</span><span class="tok-o">:</span> <span class="tok-p">[</span>
  <span class="tok-p">{</span>
    <span class="tok-s2">&quot;id&quot;</span><span class="tok-o">:</span> <span class="tok-mi">800</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;main&quot;</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Clear&quot;</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;description&quot;</span><span class="tok-o">:</span> <span class="tok-s2">&quot;cielo claro&quot;</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;icon&quot;</span><span class="tok-o">:</span> <span class="tok-s2">&quot;01n&quot;</span>
  <span class="tok-p">}</span>
<span class="tok-p">],</span>
<span class="tok-p">...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Como vemos, la descripción del tiempo está en el campo <code>weather[0].description</code>. El <code>weather[0].icon</code> es el icono que lo representa gráficamente. <a href="http://openweathermap.org/weather-conditions">Como indica la documentación</a>, para obtener el icono hay que ponerle delante a este nombre una URL base.</p>
</div>
<div class="paragraph">
<p>Con esto ya podemos implementar la llamada al servicio web desde nuestro modelo. La lógica de negocio la implementaremos normalmente con propiedades de tipo <code>function()</code>. Como la funcionalidad la deben tener todas las instancias de la clase, le asignaremos la propiedad a la clase:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">URL_API</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;http://api.openweathermap.org/data/2.5/weather?APPID=1adb13e22f23c3de1ca37f3be90763a9&amp;units=metric&amp;lang=es&quot;</span><span class="tok-p">;</span>
<span class="tok-kd">var</span> <span class="tok-nx">URL_BASE_ICONO</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;http://openweathermap.org/img/w/&quot;</span>

<span class="tok-kd">var</span> <span class="tok-nx">DatosTiempo</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">Model</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span>
    <span class="tok-nx">actualizarTiempo</span><span class="tok-o">:</span> <span class="tok-kd">function</span> <span class="tok-p">()</span> <span class="tok-p">{</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-kd">var</span> <span class="tok-nx">callback</span> <span class="tok-o">=</span> <span class="tok-kd">function</span> <span class="tok-p">(</span><span class="tok-nx">data</span><span class="tok-p">)</span> <span class="tok-p">{</span>   <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">set</span><span class="tok-p">(</span><span class="tok-s1">&#39;descripcion&#39;</span><span class="tok-p">,</span> <span class="tok-nx">data</span><span class="tok-p">.</span><span class="tok-nx">weather</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">].</span><span class="tok-nx">description</span><span class="tok-p">);</span>
            <span class="tok-kd">var</span> <span class="tok-nx">icono_url</span> <span class="tok-o">=</span> <span class="tok-nx">URL_BASE_ICONO</span> <span class="tok-o">+</span> <span class="tok-nx">data</span><span class="tok-p">.</span><span class="tok-nx">weather</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">].</span><span class="tok-nx">icon</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;.png&quot;</span><span class="tok-p">;</span>
            <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">set</span><span class="tok-p">(</span><span class="tok-s1">&#39;icono_url&#39;</span><span class="tok-p">,</span> <span class="tok-nx">icono_url</span><span class="tok-p">);</span>
            <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">set</span><span class="tok-p">(</span><span class="tok-s1">&#39;dt&#39;</span><span class="tok-p">,</span> <span class="tok-nx">data</span><span class="tok-p">.</span><span class="tok-nx">dt</span><span class="tok-p">);</span>
            <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;Se ha leído el tiempo del servicio web&quot;</span><span class="tok-p">);</span>
        <span class="tok-p">}</span>
        <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">getJSON</span><span class="tok-p">(</span>   <i class="conum" data-value="3"></i><b>(3)</b>
            <span class="tok-nx">URL_API</span><span class="tok-p">,</span>
            <span class="tok-p">{</span><span class="tok-nx">q</span><span class="tok-o">:</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-s1">&#39;localidad&#39;</span><span class="tok-p">)},</span> <i class="conum" data-value="4"></i><b>(4)</b>
            <span class="tok-nx">callback</span><span class="tok-p">.</span><span class="tok-nx">bind</span><span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">)</span>   <i class="conum" data-value="5"></i><b>(5)</b>
        <span class="tok-p">);</span>
    <span class="tok-p">}</span>
<span class="tok-p">});</span>
<span class="tok-kd">var</span> <span class="tok-nx">miTiempo</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">DatosTiempo</span><span class="tok-p">();</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Como vemos, la propiedad es una función, así que luego haremos <code>miTiempo.actualizarTiempo()</code> cuando queramos disparar la actualización</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Creamos un <em>callback</em> para la petición AJAX, que recibirá el JSON ya parseado. Aquí es donde rellenamos los datos del modelo con los recibidos del servicio web, la <code>descripcion</code> del tiempo, la <code>icono_url</code> que la representa gráficamente, y un atributo <code>dt</code> que es un <em>timestamp</em> indicando cuándo se han obtenido los datos. Así, si el <em>timestamp</em> no cambia no va a ser necesario refrescar el HTML.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Usamos jQuery para hacer más compacto el código.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Pasamos el parámetro <code>q=</code> nombre de la localidad buscada.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Y aquí es donde viene el truco necesario para que el código funcione. En el <em>callback</em> usamos <code>this</code> para referirnos al modelo. Sin embargo si usamos jQuery, en el <em>callback</em> <code>this</code> va a ser el objeto jQuery usado para hacer la petición. Con <code>bind</code> forzamos a que <code>this</code> sea lo que necesitamos.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Podemos probar el funcionamiento del código anterior tecleando algo como lo que sigue en la consola Javascript:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">miTiempo</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">DatosTiempo</span><span class="tok-p">();</span>
<span class="tok-nx">miTiempo</span><span class="tok-p">.</span><span class="tok-nx">set</span><span class="tok-p">(</span><span class="tok-s1">&#39;localidad&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;Alicante&#39;</span><span class="tok-p">);</span>
<span class="tok-nx">miTiempo</span><span class="tok-p">.</span><span class="tok-nx">actualizarTiempo</span><span class="tok-p">();</span>
<span class="tok-c1">//Hay que dar tiempo a que la petición AJAX acabe antes de teclear esto</span>
<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">miTiempo</span><span class="tok-p">.</span><span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-s1">&#39;descripcion&#39;</span><span class="tok-p">));</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Mucho cuidado con el código anterior: <code>miTiempo.actualizarTiempo()</code> dispara una petición AJAX <strong>asíncrona</strong>, con lo que después de ejecutar esta línea tendríamos que esperar a que aparezca el mensaje <code>Se ha leído el tiempo del servicio web</code> que se imprime al final del <em>callback</em> para asegurarnos de que se ha procesado ya la respuesta. Luego veremos cómo se arregla esto en la versión completa.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_la_vista">1.3.2. La vista</h4>
<div class="paragraph">
<p>La vista en Backbone tiene la misión de generar el HTML que represente el modelo en pantalla. Es decir, de dibujar el <em>widget</em>. También debe responder a los eventos del usuario. En nuestro caso el único evento es la pulsación en el botón "ver tiempo".</p>
</div>
<div class="paragraph">
<p>Las vistas heredan de la clase <code>Backbone.View</code>, y deben tener asociada una instancia de un modelo (también podrían tener varias instancias, como veremos en la siguiente sesión).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">TiempoWidget</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">View</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span>
    <span class="tok-nx">render</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>   <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">$el</span><span class="tok-p">.</span><span class="tok-nx">html</span><span class="tok-p">(</span><span class="tok-s1">&#39;&lt;input type=&quot;text&quot; id=&quot;localidad&quot;&gt;&#39;</span> <span class="tok-o">+</span>
           <span class="tok-s1">&#39;&lt;input type=&quot;button&quot; value=&quot;Ver tiempo&quot; id=&quot;ver_tiempo&quot;&gt;&#39;</span> <span class="tok-o">+</span>
           <span class="tok-s1">&#39;&lt;div&gt; &lt;img id=&quot;icono&quot; src=&quot;&quot;&gt;&lt;/div&gt;&#39;</span> <span class="tok-o">+</span>
           <span class="tok-s1">&#39;&lt;div id=&quot;descripcion&quot;&gt;&lt;/div&gt;&#39;</span><span class="tok-p">);</span>
    <span class="tok-p">},</span>
    <span class="tok-nx">renderData</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s1">&#39;#icono&#39;</span><span class="tok-p">).</span><span class="tok-nx">attr</span><span class="tok-p">(</span><span class="tok-s1">&#39;src&#39;</span><span class="tok-p">,</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">model</span><span class="tok-p">.</span><span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-s2">&quot;icono_url&quot;</span><span class="tok-p">));</span>
        <span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s1">&#39;#descripcion&#39;</span><span class="tok-p">).</span><span class="tok-nx">html</span><span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">model</span><span class="tok-p">.</span><span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-s2">&quot;descripcion&quot;</span><span class="tok-p">));</span>
    <span class="tok-p">},</span>
    <span class="tok-nx">events</span><span class="tok-o">:</span> <span class="tok-p">{</span>  <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-s2">&quot;click #ver_tiempo&quot;</span><span class="tok-o">:</span> <span class="tok-s2">&quot;ver_tiempo_de&quot;</span>
    <span class="tok-p">},</span>
    <span class="tok-nx">ver_tiempo_de</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>  <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">model</span><span class="tok-p">.</span><span class="tok-nx">set</span><span class="tok-p">(</span><span class="tok-s2">&quot;localidad&quot;</span><span class="tok-p">,</span> <span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s2">&quot;#localidad&quot;</span><span class="tok-p">).</span><span class="tok-nx">val</span><span class="tok-p">());</span>
        <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">model</span><span class="tok-p">.</span><span class="tok-nx">actualizarTiempo</span><span class="tok-p">();</span>
        <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">renderData</span><span class="tok-p">();</span>
    <span class="tok-p">}</span>
<span class="tok-p">})</span>

<span class="tok-kd">var</span> <span class="tok-nx">miTiempo</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">DatosTiempo</span><span class="tok-p">();</span>
<span class="tok-kd">var</span> <span class="tok-nx">miWidget</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">TiempoWidget</span><span class="tok-p">({</span><span class="tok-nx">model</span><span class="tok-o">:</span> <span class="tok-nx">miTiempo</span><span class="tok-p">});</span> <i class="conum" data-value="5"></i><b>(5)</b>
<span class="tok-nx">miWidget</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">();</span>  <i class="conum" data-value="6"></i><b>(6)</b>
<span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s1">&#39;#tiempo_widget&#39;</span><span class="tok-p">).</span><span class="tok-nx">html</span><span class="tok-p">(</span><span class="tok-nx">miWidget</span><span class="tok-p">.</span><span class="tok-nx">$el</span><span class="tok-p">)</span> <i class="conum" data-value="7"></i><b>(7)</b></code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Esta versión de la vista no va a funcionar correctamente por el motivo que se discutirá a continuación. ¡No hagáis esto tal cual en casa!.
</td>
</tr>
</table>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Esta función se encarga de generar el HTML de la vista. <code>this.$el</code> es un nodo de jQuery que representa la "raíz" de la vista. Manipulando su HTML estamos manipulando el HTML de la vista.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Esta función se encarga de actualizar únicamente el icono del tiempo y la descripción textual. La vista solo hará falta dibujarla completa la primera vez, las siguientes bastará con esto.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Esta propiedad se encarga de vincular los eventos producidos sobre la vista con manejadores de evento. La propiedad debe llamarse <code>events</code> y es un conjunto de pares <code>clave:valor</code> donde la <em>clave</em> es un nombre de evento + selector CSS y el valor el nombre de la función a asociar.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Tal y como se ha definido <code>events</code>, esta sería la función que se dispararía al hacer <em>clic</em> sobre el botón, que tiene el id <code>ver_tiempo</code>. Aquí tomamos la localidad, que estará escrita en el campo de texto con id <code>localidad</code>, llamamos al <code>actualizarTiempo</code> del modelo y luego a <code>renderData</code> para actualizar gráficamente la información del tiempo. Pero <strong>en realidad esto no va a funcionar</strong> ya que al ser <code>actualizarTiempo</code> asíncrono deberíamos esperar a que terminara para llamar a <code>renderData()</code>. Ahora veremos cómo resolverlo.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Creamos una instancia de la vista y le asociamos una instancia del modelo.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Llamamos al <code>render</code> de la vista para generar su HTML, pero este todavía no está en la página, solo en la propiedad <code>$el</code> de la vista.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Finalmente incluimos el HTML de la vista en la página usando el API de jQuery</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_eventos">1.3.3. Eventos</h4>
<div class="paragraph">
<p>Como ya hemos dicho, tenemos un pequeño problema: ¿cómo hacemos que el modelo avise a la vista de que <code>actualizarTiempo</code> ya ha acabado y que por tanto se puede ejecutar el <code>renderData()</code>? podría ejecutarlo el propio modelo, pero necesitaría mantener una referencia a la vista y esto haría que dejara de ser genérico y se "atara" a la vista (asumiera que siempre va a estar asociado a una vista que tiene un método <code>renderData</code>).</p>
</div>
<div class="paragraph">
<p>La solución más limpia para comunicar del modelo hacia la vista es no tocar el código del modelo en absoluto y usar la idea de "Publicar/Suscribir". Por defecto, los modelos de Backbone emiten eventos cuando se dan ciertas situaciones, por ejemplo que cambia una propiedad, o que el modelo se sincroniza con el estado del servidor. Lo único que debe hacer la vista es encontrar el evento apropiado y suscribirse a él. En este caso, el evento que nos viene que ni pintado sería que la propiedad <code>dt</code> del modelo adquiera un nuevo valor. Recordemos que esta propiedad es un <em>timestamp</em> que nos indica cuándo se han obtenido los datos.</p>
</div>
<div class="paragraph">
<p>En el <code>initialize</code> de la vista, que se usa para inicializar valores por defecto y otros elementos, podemos suscribirnos al evento del modelo. Esto se puede hacer con el método <code>listenTo</code>, indicando a qué objeto queremos suscribirnos, qué evento nos interesa, y cuál va a ser el manejador de evento:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">TiempoWidget</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">View</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span>
    <span class="tok-nx">initialize</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
        <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">listenTo</span><span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">model</span><span class="tok-p">,</span> <span class="tok-s1">&#39;change:dt&#39;</span><span class="tok-p">,</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">renderData</span><span class="tok-p">)</span>
    <span class="tok-p">},</span>
    <span class="tok-p">...</span>
    <span class="tok-nx">ver_tiempo_de</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
     <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">model</span><span class="tok-p">.</span><span class="tok-nx">set</span><span class="tok-p">(</span><span class="tok-s2">&quot;localidad&quot;</span><span class="tok-p">,</span> <span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s2">&quot;#localidad&quot;</span><span class="tok-p">).</span><span class="tok-nx">val</span><span class="tok-p">())</span>
     <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">model</span><span class="tok-p">.</span><span class="tok-nx">actualizarTiempo</span><span class="tok-p">()</span>
    <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El resto del código de la vista quedaría igual que antes. Como vemos, la función que dispara la actualización del tiempo no necesita llamar a <code>renderData</code> ella misma. Si la operación de actualización cambia el atributo <code>dt</code> del modelo se llamará a <code>renderData</code> automáticamente.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="sesion01ejer">1.4. Ejercicios de introducción a Backbone</h3>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Como norma general de la asignatura, para cada ejercicio crearemos una carpeta con su nombre e incluiremos en ella todo lo necesario: el HTML, el JS propio, las librerías JS usadas (jQuery, Backbone, &#8230;&#8203;). Aunque repitamos los archivos, así lo tenemos todo de manera independiente. En las plantillas de la asignatura tenéis una plantilla genérica de aplicación con Backbone, <code>plantilla_backbone</code>, podéis usarla como base para los ejercicios.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_modificación_del_em_widget_em_del_tiempo_0_4">1.4.1. Modificación del <em>widget</em> del tiempo (0.4)</h4>
<div class="paragraph">
<p>Este ejercicio debes entregarlo en una carpeta llamada <code>mi_tiempo_backbone</code>.</p>
</div>
<div class="paragraph">
<p>En este ejercicio vamos a modificar el modelo del <em>widget</em> del tiempo para incluir también la temperatura actual, y crearemos una nueva vista que incluya esta información.</p>
</div>
<div class="sect4">
<h5 id="_modificación_del_modelo">Modificación del modelo</h5>
<div class="paragraph">
<p>Modificar la clase del modelo <code>DatosTiempo</code> para que cuando se reciba la respuesta del servidor se incluya también la temperatura actual, en una nueva propiedad <code>temp</code>. Este dato está en el campo <code>main.temp</code> del JSON recibido del servidor.</p>
</div>
<div class="paragraph">
<p>Comprobad, usando la consola Javascript, que la temperatura se almacena correctamente en el modelo, llamando manualmente a <code>actualizarTiempo</code> y luego mostrando la propiedad <code>temp</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_creación_de_una_nueva_vista">Creación de una nueva vista</h5>
<div class="paragraph">
<p>Crear un nuevo tipo de vista <code>TemperaturaWidget</code> similar a <code>TiempoWidget</code> pero que únicamente mostrará la temperatura actual. Insertarlo en el HTML y comprobar que funciona.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_uadivino_0_6_puntos">1.4.2. UAdivino (0.6 puntos)</h4>
<div class="paragraph">
<p>Este ejercicio debes entregarlo en una carpeta llamada <code>UAdivino</code>.</p>
</div>
<div class="paragraph">
<p>Crear una aplicación de Backbone que funcione al estilo de la conocida "bola 8 mágica", a la que se le "hace una pregunta" en voz alta y nos responde algo al azar.</p>
</div>
<div class="paragraph">
<p>El <em>widget</em> tendrá un aspecto similar al siguiente:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/01/widget_uadivino.png" alt="widget uadivino" width="50%">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>El modelo</p>
<div class="ulist">
<ul>
<li>
<p>Tendrá una propiedad llamada "nombre", con el nombre del adivino (Rappel, Zoltar, &#8230;&#8203;)</p>
</li>
<li>
<p>Tendrá un único método de lógica de negocio llamado <code>obtenerRespuesta()</code>, que devolverá una respuesta al azar de entre las predefinidas.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Podéis guardar las respuestas predefinidas en un array dentro del objeto <code>defaults</code>, que en Backbone se usa para guardar valores por defecto
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">Adivino</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">Model</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span>
  <span class="tok-nx">defaults</span><span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-nx">respuestas</span><span class="tok-o">:</span> <span class="tok-p">[</span><span class="tok-s2">&quot;Sí&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;No&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;Ni de coña&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;¡Claro que sí!&quot;</span><span class="tok-p">]</span>
  <span class="tok-p">},</span>
  <span class="tok-c1">//Resto del modelo...</span>
  <span class="tok-p">...</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>La vista</p>
<div class="ulist">
<ul>
<li>
<p>Inicialmente muestra el nombre del adivino y un botón para obtener respuesta</p>
</li>
<li>
<p>Podéis mostrar la respuesta con un <code>alert</code> para simplificar, o bien insertarla en el HTML del <em>widget</em>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion02">2. Modelos y colecciones</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_modelos_funcionalidades_básicas">2.1. Modelos. Funcionalidades básicas</h3>
<div class="paragraph">
<p>Un modelo en nuestra aplicación no es más que una clase propia que hereda de la clase <code>Backbone.Model</code>. Para la herencia se usa el método <code>extend</code>. Una vez creada la clase del modelo podemos crear instancias del mismo con <code>new</code>, como es habitual en Javascript.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">Usuario</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">Model</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({})</span>
<span class="tok-kd">var</span> <span class="tok-nx">u1</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Usuario</span><span class="tok-p">()</span> <span class="tok-c1">//un usuario</span>
<span class="tok-kd">var</span> <span class="tok-nx">u2</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Usuario</span><span class="tok-p">()</span> <span class="tok-c1">//otro</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Ya sabemos que en Javascript (o en ECMAScript hasta la versión 5 inclusive, para hablar con algo más de propiedad) no existen las clases como tales, ni tampoco la herencia al estilo Java o C++,  sino los objetos y la herencia basada en prototipos. No obstante Backbone al igual que muchos otros <em>frameworks</em> "imita" el enfoque clásico de la POO basada en clases, instancias y herencia entre clases. Aunque no sea totalmente correcto hablar de la "clase Usuario" a partir de ahora vamos a usar esta terminología para simplificar.
Si queréis más información sobre cómo se implementan las clases y la herencia en Backbone podéis consultar este <a href="http://dailyjs.com/2012/08/09/mvstar-5/">tutorial</a> o directamente el propio código fuente anotado de Backbone, en el  <a href="http://backbonejs.org/docs/backbone.html#helpers">apartado "Helpers"</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El método <code>extend</code> admite como parámetro un objeto en el que podemos encapsular diversas propiedades del modelo, más tarde veremos su uso. En el ejemplo hemos usado un objeto vacío. (<code>{}</code>).</p>
</div>
<div class="sect3">
<h4 id="_atributos">2.1.1. Atributos</h4>
<div class="paragraph">
<p>Los modelos en Backbone siguen la filosofía de Javascript: son dinámicos y podemos añadir y eliminar atributos sobre la marcha. Para añadir un atributo, o cambiar su valor si este ya existe, usamos <code>set(nombre, valor)</code>. Para obtener el valor, <code>get(nombre)</code>. Continuando con el ejemplo anterior:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">Usuario</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">Model</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({})</span>
<span class="tok-kd">var</span> <span class="tok-nx">u1</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Usuario</span><span class="tok-p">()</span>
<span class="tok-nx">u1</span><span class="tok-p">.</span><span class="tok-nx">set</span><span class="tok-p">(</span><span class="tok-s2">&quot;nombre&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;Pepe&quot;</span><span class="tok-p">)</span>
<span class="tok-nx">u1</span><span class="tok-p">.</span><span class="tok-nx">set</span><span class="tok-p">(</span><span class="tok-s2">&quot;fecha_nac&quot;</span><span class="tok-p">,</span> <span class="tok-k">new</span> <span class="tok-nb">Date</span><span class="tok-p">(</span><span class="tok-mi">1990</span><span class="tok-p">,</span><span class="tok-mi">0</span><span class="tok-p">,</span><span class="tok-mi">1</span><span class="tok-p">))</span> <span class="tok-c1">//1 de enero de 1990</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>También podemos fijar los valores de los atributos al instanciar el objeto con <code>new</code>. Se los pasamos a este método en forma de <em>hash</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">u1</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Usuario</span><span class="tok-p">({</span><span class="tok-nx">nombre</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Pepe&quot;</span><span class="tok-p">,</span> <span class="tok-nx">fecha_nac</span><span class="tok-o">:</span><span class="tok-k">new</span> <span class="tok-nb">Date</span><span class="tok-p">(</span><span class="tok-mi">1990</span><span class="tok-p">,</span><span class="tok-mi">0</span><span class="tok-p">,</span><span class="tok-mi">1</span><span class="tok-p">)})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si deseamos eliminar un atributo podemos usar <code>unset(nombre)</code>, aunque este método lo único que hace es borrar el atributo usando <code>delete</code>. Podríamos hacer lo mismo accediendo directamente a la propiedad de la clase llamada <code>attributes</code>, que es la que contiene los atributos en sí</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">u1</span><span class="tok-p">.</span><span class="tok-nx">unset</span><span class="tok-p">(</span><span class="tok-s2">&quot;fecha_nac&quot;</span><span class="tok-p">)</span>  <span class="tok-c1">//es lo mismo que delete u1.attributes(&quot;fecha_nac&quot;)</span></code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
aunque podemos acceder a los atributos directamente modificando <code>attributes</code>, se recomienda hacerlo siempre a través de <code>get/set</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Podemos comprobar si un objeto tiene un determinado atributo con <code>has(nombre)</code>, que devolverá un valor booleano indicándolo.</p>
</div>
</div>
<div class="sect3">
<h4 id="_métodos_y_propiedades_de_un_modelo">2.1.2. Métodos y propiedades de un modelo</h4>
<div class="paragraph">
<p>Como ya hemos dicho, cuando creamos una clase que hereda de <code>Backbone.Model</code> podemos definir propiedades en forma de objeto Javascript, normalmente usando notación literal. De hecho podemos definir propiedades de instancia y propiedades de clase. Las primeras serían propias de cada instancia de nuestro modelo. Las segundas serían de la clase del modelo en sí. En Backbone ya vienen definidas por defecto unas cuantas propiedades de instancia. Por ejemplo cada objeto tiene un <code>cid</code> que es un identificador único y se va generando secuencialmente.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
podríamos usar las propiedades especificadas en <code>extend</code> para definir variables miembro de nuestros objetos, pero lo habitual es usar atributos para esta tarea.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Lo  habitual es <strong>usar las propiedades especificadas en el <code>extend</code> para definir <em>métodos</em></strong>. Un método no va a ser más que una propiedad que resulta ser una función. Por ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">Usuario</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">Model</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span>
  <span class="tok-nx">toString</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-k">return</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-s2">&quot;nombre&quot;</span><span class="tok-p">)</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;.Nacido/a el &quot;</span>
           <span class="tok-o">+</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-s2">&quot;fecha_nac&quot;</span><span class="tok-p">).</span><span class="tok-nx">toLocaleDateString</span><span class="tok-p">()</span>
  <span class="tok-p">}</span>
<span class="tok-p">})</span>
<span class="tok-kd">var</span> <span class="tok-nx">u1</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Usuario</span><span class="tok-p">({</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s2">&quot;Pepe&quot;</span><span class="tok-p">,</span> <span class="tok-nx">fecha_nac</span><span class="tok-o">:</span> <span class="tok-k">new</span> <span class="tok-nb">Date</span><span class="tok-p">(</span><span class="tok-mi">1990</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">)})</span>
<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">u1</span><span class="tok-p">.</span><span class="tok-nx">toString</span><span class="tok-p">())</span> <span class="tok-c1">//Pepe. Nacido/a el 1/1/1990</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Todos los modelos tienen una propiedad por defecto <code>cid</code> (<em>client id</em>) que actúa como identificador y cuyo valor va generando automáticamente Backbone. Como luego veremos, cuando el modelo se almacena en el servidor también pasa a tener una propiedad <code>id</code>, con valor asignado por este.</p>
</div>
</div>
<div class="sect3">
<h4 id="_inicializador_y_valores_por_defecto">2.1.3. Inicializador y valores por defecto</h4>
<div class="paragraph">
<p>Podemos ejecutar un determinado código cuando se cree el modelo, poniéndolo en el método <code>initialize</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">Usuario</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">Model</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span>
  <span class="tok-nx">initialize</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;Inicializando usuario...&quot;</span><span class="tok-p">)</span>
    <span class="tok-c1">//como fecha de alta del usuario ponemos la actual</span>
    <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">set</span><span class="tok-p">(</span><span class="tok-s2">&quot;fecha_alta&quot;</span><span class="tok-p">,</span> <span class="tok-k">new</span> <span class="tok-nb">Date</span><span class="tok-p">())</span>
  <span class="tok-p">}</span>
<span class="tok-p">})</span>
<span class="tok-kd">var</span> <span class="tok-nx">u1</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Usuario</span><span class="tok-p">()</span>  <span class="tok-c1">//Imprime: inicializando usuario...</span>
<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">u1</span><span class="tok-p">.</span><span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-s2">&quot;fecha_alta&quot;</span><span class="tok-p">))</span>  <span class="tok-c1">//imprime la fecha actual</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Aunque si lo que queremos es simplemente inicializar atributos con valores por defecto es más directo usar la propiedad <code>defaults</code>. A esta propiedad se le pasa un objeto en notación literal con los nombres de los atributos y sus valores por defecto:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">Usuario</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">Model</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span>
  <span class="tok-nx">defaults</span><span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-s1">&#39;saldo&#39;</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
  <span class="tok-p">}</span>
<span class="tok-p">})</span>
<span class="tok-nx">u1</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Usuario</span><span class="tok-p">()</span>
<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">u1</span><span class="tok-p">.</span><span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-s2">&quot;saldo&quot;</span><span class="tok-p">))</span>   <span class="tok-c1">//0</span></code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Recordemos que los objetos en Javascript se pasan por referencia, de modo que si usamos un objeto como valor por defecto todas las instancias referenciarán el mismo objeto. Y además modificar el contenido del atributo en una instancia lo modificará en todas, por ejemplo:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">Usuario</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">Model</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span>
  <span class="tok-nx">defaults</span><span class="tok-o">:</span> <span class="tok-p">{</span>
      <span class="tok-s1">&#39;fecha_alta&#39;</span><span class="tok-o">:</span> <span class="tok-k">new</span> <span class="tok-nb">Date</span><span class="tok-p">()</span>
  <span class="tok-p">}</span>
<span class="tok-p">})</span>
<span class="tok-kd">var</span> <span class="tok-nx">u1</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Usuario</span><span class="tok-p">();</span>
<span class="tok-kd">var</span> <span class="tok-nx">u2</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Usuario</span><span class="tok-p">();</span>
<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">u1</span><span class="tok-p">.</span><span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-s2">&quot;fecha_alta&quot;</span><span class="tok-p">)</span><span class="tok-o">==</span><span class="tok-nx">u2</span><span class="tok-p">.</span><span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-s2">&quot;fecha_alta&quot;</span><span class="tok-p">))</span>  <span class="tok-c1">//true</span>
<span class="tok-nx">u1</span><span class="tok-p">.</span><span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-s2">&quot;fecha_alta&quot;</span><span class="tok-p">).</span><span class="tok-nx">setFullYear</span><span class="tok-p">(</span><span class="tok-mi">2000</span><span class="tok-p">)</span>
<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">u2</span><span class="tok-p">.</span><span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-s2">&quot;fecha_alta&quot;</span><span class="tok-p">).</span><span class="tok-nx">getFullYear</span><span class="tok-p">())</span>          <span class="tok-c1">//2000!!</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La solución es hacer que <code>defaults</code> sea una función que devuelva un objeto con los valores deseados, así, cada instancia tendrá su propia copia de valores por defecto.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">Usuario</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">Model</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span>
  <span class="tok-nx">defaults</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-k">return</span> <span class="tok-p">{</span><span class="tok-s1">&#39;fecha_alta&#39;</span><span class="tok-o">:</span> <span class="tok-k">new</span> <span class="tok-nb">Date</span><span class="tok-p">()}</span>
  <span class="tok-p">}</span>
<span class="tok-p">})</span>
<span class="tok-kd">var</span> <span class="tok-nx">u1</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Usuario</span><span class="tok-p">();</span>
<span class="tok-kd">var</span> <span class="tok-nx">u2</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Usuario</span><span class="tok-p">();</span>
<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">u1</span><span class="tok-p">.</span><span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-s2">&quot;fecha_alta&quot;</span><span class="tok-p">)</span><span class="tok-o">==</span><span class="tok-nx">u2</span><span class="tok-p">.</span><span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-s2">&quot;fecha_alta&quot;</span><span class="tok-p">))</span>  <span class="tok-c1">//false</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_validación_de_datos">2.1.4. Validación de datos</h4>
<div class="paragraph">
<p>Backbone ofrece un método <code>validate()</code> para la validación de datos, pero el código tenemos que escribirlo nosotros por completo, no existe ningún tipo de validación declarativa.</p>
</div>
<div class="paragraph">
<p>Si la validación es correcta el método <code>validate()</code> no debería devolver nada. En caso de que sea incorrecta, corre por cuenta del desarrollador qué devolver, mientras se devuelva algo. Por ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">Usuario</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">Model</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span>
  <span class="tok-nx">validate</span><span class="tok-o">:</span> <span class="tok-kd">function</span> <span class="tok-p">(</span><span class="tok-nx">attrs</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kd">var</span> <span class="tok-nx">password</span> <span class="tok-o">=</span> <span class="tok-nx">attrs</span><span class="tok-p">.</span><span class="tok-nx">password</span><span class="tok-p">;</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-nx">password</span> <span class="tok-o">||</span> <span class="tok-nx">password</span><span class="tok-p">.</span><span class="tok-nx">length</span><span class="tok-o">&lt;</span><span class="tok-mi">6</span><span class="tok-p">)</span>
    <span class="tok-k">return</span> <span class="tok-s2">&quot;Password no válido&quot;</span><span class="tok-p">;</span>
  <span class="tok-p">}</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>validate()</code> recibe como parámetro un objeto con los atributos que se están validando. Backbone llama automáticamente a <code>validate()</code> al guardar un objeto en el servidor. En ese caso los atributos recibidos en <code>validate()</code> son los actuales del objeto.</p>
</div>
<div class="paragraph">
<p>Además validará el cambio de valor de un atributo si pasamos la opción <code>validate:true</code>. En este caso los atributos recibidos en <code>validate()</code> son los nuevos valores que estamos intentando fijar.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-c1">//Continúa el código del ejemplo anterior</span>
<span class="tok-kd">var</span> <span class="tok-nx">unUsuario</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Usuario</span><span class="tok-p">();</span>
<span class="tok-nx">unUsuario</span><span class="tok-p">.</span><span class="tok-nx">set</span><span class="tok-p">({</span><span class="tok-s2">&quot;password&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;&quot;</span><span class="tok-p">},{</span><span class="tok-nx">validate</span><span class="tok-o">:</span><span class="tok-kc">true</span><span class="tok-p">});</span>
<span class="tok-c1">//la propiedad &quot;validationError&quot; nos da el último valor devuelto por &quot;validate&quot;</span>
<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">unUsuario</span><span class="tok-p">.</span><span class="tok-nx">validationError</span><span class="tok-p">)</span> <span class="tok-c1">//&quot;Password no válido&quot;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_persistencia_con_apis_rest">2.2. Persistencia con APIs REST</h3>
<div class="paragraph">
<p>Con Backbone podemos sincronizar de forma sencilla el estado local de un modelo con el estado en el servidor. El <em>framework</em> está preparado por defecto para comunicarse con el servidor empleando las convenciones REST habituales. Partiendo de la URL que referencia el modelo en el servidor, Backbone va a generar por nosotros las llamadas AJAX necesarias para hacer CRUD del modelo, ahorrándonos tener que escribir nosotros mismos el código.</p>
</div>
<div class="paragraph">
<p>Con la propiedad <code>urlRoot</code> fijamos la URL "base" del modelo. Es decir, será la URL de la "colección" en la que está incluido en el servidor. Por ejemplo  un usuario en el servidor podría estar en una URL del tipo <code><a href="http://miapp.com/api/usuarios/" class="bare">http://miapp.com/api/usuarios/</a><em>identificador</em></code>. Por tanto la URL base será solamente <code><a href="http://miapp.com/api/usuarios/" class="bare">http://miapp.com/api/usuarios/</a></code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">Usuario</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">Model</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span>
  <span class="tok-nx">urlRoot</span><span class="tok-o">:</span> <span class="tok-s1">&#39;miapp.com/api/usuarios/&#39;</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Una vez establecida la propiedad <code>urlRoot</code> podemos hacer CRUD del modelo de forma muy sencilla.</p>
</div>
<div class="sect3">
<h4 id="_create_post">2.2.1. Create (POST)</h4>
<div class="paragraph">
<p>Para <strong>crear</strong> el modelo en el lado del servidor llamaríamos al método <code>save()</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-c1">//Continuando con el ejemplo anterior</span>
<span class="tok-kd">var</span> <span class="tok-nx">usuario</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Usuario</span><span class="tok-p">()</span>
<span class="tok-nx">usuario</span><span class="tok-p">.</span><span class="tok-nx">set</span><span class="tok-p">({</span><span class="tok-s1">&#39;login&#39;</span><span class="tok-o">:</span><span class="tok-s1">&#39;experto&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;password&#39;</span><span class="tok-o">:</span> <span class="tok-s1">&#39;123456&#39;</span><span class="tok-p">})</span>
<span class="tok-nx">usuario</span><span class="tok-p">.</span><span class="tok-nx">save</span><span class="tok-p">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La creación del objeto en el servidor implica una petición POST. Antes de hacer esta petición se llama a <code>validate()</code>, y si la validación falla, <code>save()</code> devuelve <code>false</code>.</p>
</div>
<div class="paragraph">
<p>Una vez hecha la petición, Backbone espera que el servidor le devuelva un JSON incluyendo al menos la propiedad "id" con el identificador del nuevo recurso creado. Si esto se cumple, la librería establece la propiedad <code>id</code> del modelo a este valor.</p>
</div>
<div class="paragraph">
<p>Si el servidor usara una propiedad con nombre distinto a <code>id</code> para devolver el identificador del objeto, podemos poner este nombre como valor del atributo <code>idAttribute</code> del modelo.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Por defecto Backbone <a href="https://github.com/jashkenas/backbone/issues/1660">no sigue el "estándar"</a> que usan algunos API REST de devolver la URL del nuevo recurso en la cabecera <code>Location</code>. Backbone ignorará la cabecera y para extraer de ella el nuevo <code>id</code> tendríamos que sobreescribir el método <code>save()</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para tener más información sobre la respuesta devuelta por el servidor debemos pasar dos <em>callbacks</em> en el <code>save()</code>, uno para llamar en caso de éxito (código de estado en el rango 200-299) y otro en caso de error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">usuario</span><span class="tok-p">.</span><span class="tok-nx">save</span><span class="tok-p">(</span><span class="tok-kc">null</span><span class="tok-p">,</span> <span class="tok-p">{</span>
  <span class="tok-nx">success</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">model</span><span class="tok-p">,</span> <span class="tok-nx">response</span><span class="tok-p">,</span> <span class="tok-nx">options</span><span class="tok-p">){</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;Modelo guardado OK&#39;</span><span class="tok-p">);</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;Id: &#39;</span>  <span class="tok-o">+</span> <span class="tok-nx">model</span><span class="tok-p">.</span><span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-s1">&#39;id&#39;</span><span class="tok-p">));</span>
  <span class="tok-p">},</span>
  <span class="tok-nx">error</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">model</span><span class="tok-p">,</span> <span class="tok-nx">xhr</span><span class="tok-p">,</span> <span class="tok-nx">options</span><span class="tok-p">){</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;Error al intentar guardar modelo&#39;</span><span class="tok-p">);</span>
  <span class="tok-p">}</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>También podemos usar la sintaxis de promesas. En caso de superar la validación, <code>save</code> devuelve un objeto <a href="http://api.jquery.com/jQuery.ajax/#jqXHR"><code>jqXHR</code></a>, que es un <em>wrapper</em> de jQuery para el <code>XMLHttpRequest</code> nativo que además implementa la interfaz de promesas, así que podemos simplificar un poco la sintaxis y por ejemplo hacer más sencillo el encadenamiento de operaciones:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">usuario</span><span class="tok-p">.</span><span class="tok-nx">save</span><span class="tok-p">.</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(){</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;usuario guardado OK&#39;</span><span class="tok-p">)</span>
  <span class="tok-k">return</span> <span class="tok-nx">pedido</span><span class="tok-p">.</span><span class="tok-nx">save</span><span class="tok-p">();</span>
<span class="tok-p">}).</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(){</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;pedido guardado OK&#39;</span><span class="tok-p">)</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_read_get">2.2.2. READ (GET)</h4>
<div class="paragraph">
<p>El método <code>fetch()</code> le pide al servidor los datos del modelo, sobreescribiendo los actuales. Asume que la respuesta va a venir en forma de objeto JSON. Para poder usar este método el objeto ya debe tener un <code>id</code> asignado, ya que la URL a la que se va a lanzar la petición get es la <code>urlRoot</code> + <code>/id</code>.</p>
</div>
<div class="paragraph">
<p>Si los valores de los atributos procedentes del servidor difieren de los actuales se disparará un evento <code>change</code>. Posteriormente veremos cómo  hacer que un objeto determinado observe un evento que genera otro.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Las interacciones con el servidor son <em>asíncronas</em>, lo que significa que tras ejecutar <code>fetch()</code> se continuará con el resto del programa aunque todavía no se haya recibido respuesta del servidor. Esto puede dar lugar a <em>bugs</em> difíciles de depurar salvo que recordemos el carácter asíncrono de la operación. Por ejemplo, en el siguiente código:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">u</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Usuario</span><span class="tok-p">();</span>
<span class="tok-nx">u</span><span class="tok-p">.</span><span class="tok-nx">set</span><span class="tok-p">(</span><span class="tok-s2">&quot;id&quot;</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">);</span>
<span class="tok-nx">u</span><span class="tok-p">.</span><span class="tok-nx">fetch</span><span class="tok-p">();</span>
<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">u</span><span class="tok-p">.</span><span class="tok-nx">login</span><span class="tok-p">);</span>  <span class="tok-c1">//undefined!!!</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La última línea imprimirá <code>undefined</code> ya que no habrá dado tiempo a que el servidor responda y a rellenar el objeto con los valores de la respuesta. Sin embargo si depuramos el código ayudándonos de un <em>debugger</em> paso a paso, daremos tiempo a que se procese la respuesta y sí mostrará el login correctamente, con el consiguiente WTF! por nuestra parte. Para poder enterarnos de cuándo se ha rellenado la información del objeto tenemos que usar callbacks en <code>fetch()</code> o bien usar eventos, como veremos al final de la sesión.</p>
</div>
</div>
<div class="sect3">
<h4 id="_update_put">2.2.3. UPDATE (PUT)</h4>
<div class="paragraph">
<p>La actualización se dispara con el mismo método que sirve para crear un objeto en el servidor: <code>save()</code>. Backbone asume que un modelo que tiene valor asignado a la propiedad <code>id</code> ya existe en el servidor, y por tanto al llamar a <code>save()</code> lanzará un <code>PUT</code> a <code>urlRoot</code> + <code>/id</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_delete_delete">2.2.4. DELETE (DELETE)</h4>
<div class="paragraph">
<p>Para eliminar un objeto del servidor se usa <code>destroy()</code>, que lanzará una petición <code>DELETE</code> a <code>urlRoot</code> + <code>/id</code>, salvo que todavía no haya sido guardado en el servidor (no tenga <code>id</code>), en cuyo caso no hará petición y devolverá <code>false</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_colecciones">2.3. Colecciones</h3>
<div class="paragraph">
<p>De la mayor parte de los modelos de nuestra aplicación normalmente no habrá una única instancia, sino una colección de ellas: <em>posts</em>, <em>tags</em> o <em>categorías</em> en un blog, <em>mensajes</em>, <em>hilos</em> o <em>usuarios</em> en un foro, &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>La clase <code>Collection</code> de Backbone representa precisamente una colección de modelos. Así podemos tratarlos conjuntamente, lo que facilita la realización de ciertas operaciones, como persistir los datos en el servidor o poder escuchar eventos en cualquier modelo de la colección.</p>
</div>
<div class="paragraph">
<p>El uso de <code>Collection</code> es muy similar al de <code>Model</code>. Primero extendemos la clase y luego creamos las instancias que sean necesarias. Al extender la clase habitualmente especificaremos con la propiedad <code>model</code> el tipo de los modelos que forman la colección.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">Usuario</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">Model</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">();</span>
<span class="tok-kd">var</span> <span class="tok-nx">Usuarios</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">Collection</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span><span class="tok-nx">model</span><span class="tok-o">:</span><span class="tok-nx">Usuario</span><span class="tok-p">});</span>
<span class="tok-kd">var</span> <span class="tok-nx">u1</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Usuario</span><span class="tok-p">({</span><span class="tok-s1">&#39;login&#39;</span><span class="tok-o">:</span><span class="tok-s1">&#39;experto&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;password&#39;</span><span class="tok-o">:</span><span class="tok-s1">&#39;123456&#39;</span><span class="tok-p">});</span>
<span class="tok-kd">var</span> <span class="tok-nx">u2</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Usuario</span><span class="tok-p">({</span><span class="tok-s1">&#39;login&#39;</span><span class="tok-o">:</span><span class="tok-s1">&#39;master&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;password&#39;</span><span class="tok-o">:</span><span class="tok-s1">&#39;654321&#39;</span><span class="tok-p">});</span>
<span class="tok-kd">var</span> <span class="tok-nx">lista</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Usuarios</span><span class="tok-p">([</span><span class="tok-nx">u1</span><span class="tok-p">,</span><span class="tok-nx">u2</span><span class="tok-p">]);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Como puede verse en el constructor de la instancia podemos pasar un <em>array</em> de modelos.</p>
</div>
<div class="sect3">
<h4 id="_navegar_por_las_colecciones">2.3.1. Navegar por las colecciones</h4>
<div class="paragraph">
<p>Podemos obtener el modelo en una posición con el método <code>at()</code>. Como los arrays, las colecciones mantienen una propiedad <code>length</code> con el número de elementos.</p>
</div>
<div class="paragraph">
<p>Si conocemos el <code>id</code> o el <code>cid</code> del modelo, podemos obtenerlo directamente con <code>get()</code>.</p>
</div>
<div class="paragraph">
<p>para <strong>iterar por la colección</strong> podemos usar el típico bucle <code>for</code> que vaya incrementando un índice y usar <code>at()</code>, pero también podemos usar un <em>iterador</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">misUsuarios</span><span class="tok-p">.</span><span class="tok-nx">forEach</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">usuario</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">usuario</span><span class="tok-p">.</span><span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-s2">&quot;login&quot;</span><span class="tok-p">));</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Al <code>forEach</code> se le pasa una función, que será llamada conforme se vaya iterando por la lista. Como argumento la función recibirá el objeto en la posición actual. Este y otros métodos de manejo de colecciones y eventos procede en realidad de la librería <code>underscore</code>, que como ya hemos comentado es un prerrequisito de Backbone.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<a href="http://underscorejs.org">Underscore</a> es una pequeña librería que proporciona diversos métodos típicos de programación funcional como <code>map</code>, <code>filter</code>, <code>invoke</code>,&#8230;&#8203; Además tiene pequeñas utilidades como la posibilidad de especificar <em>binding</em> de funciones, un pequeño motor de plantillas,&#8230;&#8203; Es interesante echarle al menos un vistazo ya que sus funcionalidades pueden ser realmente útiles en ocasiones.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_ordenación_y_filtrado">2.3.2. Ordenación y filtrado</h4>
<div class="paragraph">
<p>En principio el <strong>orden de los elementos</strong> al recorrer la colección es el de inserción, pero también podemos especificar un criterio de ordenación. Para casos sencillos podemos darle al atributo <code>comparator</code> el nombre del campo usado para clasificar.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">misUsuarios</span><span class="tok-p">.</span><span class="tok-nx">comparator</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;login&quot;</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si necesitamos usar un criterio más complejo le podemos asignar a <code>comparator</code>  una función con un único argumento que a partir del objeto devuelva el criterio de ordenación.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-c1">//Ordenar por longitud del password</span>
<span class="tok-nx">misUsuarios</span><span class="tok-p">.</span><span class="tok-nx">comparator</span> <span class="tok-o">=</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">usu</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-k">return</span> <span class="tok-nx">usu</span><span class="tok-p">.</span><span class="tok-nx">password</span><span class="tok-p">.</span><span class="tok-nx">length</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Aunque Backbone (en realidad Underscore) solo nos permite ordenar en sentido ascendente, podemos usar un pequeño truco para ordenar de forma descendente: multiplicar por -1 la función de ordenación.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-c1">//Ordenar por longitud del password, pero ahora de mayor a menor</span>
<span class="tok-nx">misUsuarios</span><span class="tok-p">.</span><span class="tok-nx">comparator</span> <span class="tok-o">=</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">usu</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-k">return</span> <span class="tok-o">-</span><span class="tok-nx">usu</span><span class="tok-p">.</span><span class="tok-nx">password</span><span class="tok-p">.</span><span class="tok-nx">length</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>También podemos usar una función con dos argumentos que actúe como un <em>comparador</em>: dados dos objetos a comparar devuelve -1 si el primer argumento es menor que el segundo, +1 si es mayor y 0 si son iguales.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
las colecciones no se reordenan automáticamente cuando un modelo cambia el valor de alguno de sus atributos. Puedes ordenarlas de nuevo llamando a <code>sort()</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Podemos filtrar una colección ayudándonos de la función <code>filter</code> de underscore. Por ejemplo, aquí vemos cómo podríamos filtrar una colección de usuarios obteniendo solo los que tienen un password de menos de 6 caracteres.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">passwordsCortos</span> <span class="tok-o">=</span> <span class="tok-nx">lista</span><span class="tok-p">.</span><span class="tok-nx">filter</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">usu</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-c1">//devolvemos true si queremos quedarnos con el objeto</span>
  <span class="tok-k">return</span> <span class="tok-nx">usu</span><span class="tok-p">.</span><span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-s2">&quot;password&quot;</span><span class="tok-p">).</span><span class="tok-nx">length</span><span class="tok-o">&lt;</span><span class="tok-mi">6</span><span class="tok-p">;</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_manipulación_básica">2.3.3. Manipulación básica</h4>
<div class="paragraph">
<p>Podemos añadir un nuevo modelo o array de modelos a la colección con <code>add()</code>. El modelo se añadirá en la posición especificada por el criterio de ordenación actual. Si queremos añadir por la cabeza usaríamos <code>unshift()</code> y por la cola <code>push()</code>. Podemos eliminar un modelo o un array de ellos con <code>remove()</code>, o eliminar el de la cabeza con <code>shift()</code> y el de la cola con <code>pop()</code>.</p>
</div>
<div class="paragraph">
<p>El método <code>set()</code> se usa para "actualizar" una colección. Si un modelo de la nueva colección no existe en la actual se añadirá, si estaba en la antigua pero no en la nueva se eliminará, y si existe en ambas se mezclarán sus atributos (los que existan en antigua y nueva se actualizarán al valor de la nueva).</p>
</div>
</div>
<div class="sect3">
<h4 id="_persistencia_con_apis_rest_2">2.3.4. Persistencia con APIs REST</h4>
<div class="paragraph">
<p>Para <strong>obtener una colección del servidor</strong> se usa el método <code>fetch()</code>, igual que con los modelos. Si la colección no está vacía no se elimina completamente, sino que se usa el método <code>set()</code> para actualizar la del cliente.</p>
</div>
<div class="paragraph">
<p>Para <strong>guardar la colección</strong> en el servidor, <strong>actualizarla</strong> o <strong>eliminarla</strong> tendremos que ir procesando los modelos uno a uno. No obstante en los modelos incluidos en colecciones no es necesario especificar la <code>urlRoot</code> de cada uno por separado, se usa automáticamente la <code>url</code> de la colección como URL base.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_eventos_2">2.4. Eventos</h3>
<div class="paragraph">
<p>Los eventos son la forma de comunicación principal entre componentes de Backbone. Cuando un objeto quiere comunicar al resto que ha sucedido algo interesante, emite un evento. El resto de objetos puede suscribirse al/los eventos que desee asociados a un objeto, de modo que cuando este emita el evento se llamará a una función que actúe de <em>callback</em>. Como vemos, es un mecanismo análogo al de los eventos en Javascript, con la diferencia de que en Javascript la mayoría de eventos  vienen asociados a acciones del usuario, y en Backbone se asocian típicamente con cambios en el modelo o en las colecciones.</p>
</div>
<div class="paragraph">
<p>La documentación de Backbone incluye una <a href="http://backbonejs.org/#Events-catalog">referencia de todos los eventos</a>. La gran mayoría son emitidos por modelos y colecciones, salvo unos pocos que lo son por <em>routers</em> (otros componentes de Backbone, que ya veremos en su momento).</p>
</div>
<div class="sect3">
<h4 id="_tratar_con_eventos_desde_objetos_javascript">2.4.1. Tratar con eventos desde objetos Javascript</h4>
<div class="paragraph">
<p>En Backbone cualquier componente (modelo, vista, colección o <em>router</em>) puede observar los eventos emitidos por cualquier otro componente. Pero también podemos hacer que cualquier objeto Javascript pueda emitir y recibir eventos.
También podemos hacer que cualquier objeto Javascript sea capaz de observar eventos de Backbone haciendo un <em>mixin</em> del objeto con la clase <code>Backbone.Events</code>. Es tan sencillo como llamar al método <code>_.extend</code> de Underscore pasándole como parámetros el objeto y la clase <code>Events</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">_</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">(</span><span class="tok-nx">obs</span><span class="tok-p">,</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">Events</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Un <em>mixin</em> es un mecanismo distinto a la herencia que permite incorporar funcionalidades nuevas a un objeto. Algunos lenguajes incorporan los <em>mixin</em> de forma nativa, por ejemplo Ruby o Scala (aunque en este último se denominan <em>traits</em>). Javascript no los tiene de forma nativa pero al ser dinámico es relativamente sencillo implementarlos copiando al objeto las funciones y propiedades que queramos incorporarle. Esto es de hecho lo que hace el método <code>_.extend()</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_suscribirse_desuscribirse_a_eventos">2.4.2. Suscribirse/desuscribirse a eventos</h4>
<div class="paragraph">
<p>Hay varias posibilidades para suscribirnos a los eventos que nos interese. La más usada es el método <code>listenTo</code>, al que se le pasa como parámetro el objeto a observar, el nombre del evento y la función <em>handler</em>. Por ejemplo, supongamos que desde un modelo queremos observar cuándo cambia algún atributo de otro:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">Usuario</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">Model</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span><span class="tok-nx">urlRoot</span><span class="tok-o">:</span><span class="tok-s1">&#39;http://localhost:4567/usuarios&#39;</span><span class="tok-p">});</span>
<span class="tok-kd">var</span> <span class="tok-nx">usuario</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Usuario</span><span class="tok-p">();</span>
<span class="tok-kd">var</span> <span class="tok-nx">MiModelo</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">Model</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span>
    <span class="tok-nx">handler</span> <span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">modelo</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;handler del evento &#39;change&#39;&quot;</span><span class="tok-p">)</span>
    <span class="tok-p">}</span>
<span class="tok-p">});</span>
<span class="tok-kd">var</span> <span class="tok-nx">observador</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">MiModelo</span><span class="tok-p">({});</span>
<span class="tok-c1">//Nos suscribimos al evento &#39;change&#39; sobre el modelo &#39;usuario&#39;</span>
<span class="tok-nx">observador</span><span class="tok-p">.</span><span class="tok-nx">listenTo</span><span class="tok-p">(</span><span class="tok-nx">usuario</span><span class="tok-p">,</span> <span class="tok-s1">&#39;change&#39;</span><span class="tok-p">,</span> <span class="tok-nx">observador</span><span class="tok-p">.</span><span class="tok-nx">handler</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Recordemos que si el observador no es un componente de Backbone, primero tenemos que hacer un <em>mixin</em> con <code>Backbone.Events</code>. Lo demás es idéntico.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-c1">//El objeto que va a hacer de observador</span>
<span class="tok-kd">var</span> <span class="tok-nx">obs</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
  <span class="tok-nx">handler</span> <span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">modelo</span><span class="tok-p">,</span> <span class="tok-nx">opts</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-p">...</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;handler del evento &#39;change&#39;&quot;</span><span class="tok-p">)</span>
  <span class="tok-p">}</span>
  <span class="tok-c1">//Más funciones y propiedades</span>
  <span class="tok-p">...</span>
<span class="tok-p">};</span>
<span class="tok-c1">//Mixin con Backbone.events</span>
<span class="tok-nx">_</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">(</span><span class="tok-nx">obs</span><span class="tok-p">,</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">Events</span><span class="tok-p">);</span>
<span class="tok-c1">//Nos suscribimos al evento &#39;change&#39; sobre el modelo &#39;usuario&#39;</span>
<span class="tok-nx">obs</span><span class="tok-p">.</span><span class="tok-nx">listenTo</span><span class="tok-p">(</span><span class="tok-nx">usuario</span><span class="tok-p">,</span> <span class="tok-s1">&#39;change&#39;</span><span class="tok-p">,</span> <span class="tok-nx">obs</span><span class="tok-p">.</span><span class="tok-nx">handler</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para dejar de escuchar todos los eventos que emite un objeto podemos usar <code>stopListening</code> pasando como parámetro el objeto que queremos "ignorar" de ahora en adelante.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-c1">//Continuando con el ejemplo anterior, si nos &quot;cansamos&quot; de escuchar</span>
<span class="tok-nx">obs</span><span class="tok-p">.</span><span class="tok-nx">stopListening</span><span class="tok-p">(</span><span class="tok-nx">usuario</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Habitualmente los observadores de los eventos no serán objetos propios como en nuestro ejemplo, sino componentes de Backbone. <strong>Típicamente son las vistas las que observan el comportamiento del modelo, lo que permite comunicarlos sin introducir acoplamiento entre ambos</strong>. El modelo puede indicar que ha cambiado para que la vista muestre los nuevos datos, sin necesidad de mantener una referencia a la vista, ni siquiera saber cómo se llama el método de la vista que procesa los cambios.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
ECMAScript 6 añade el método <code>object.observe</code>, que permite a cualquier objeto observar directamente los cambios en otro. Es de esperar que cuando el método esté <a href="http://caniuse.com/#feat=object-observe">implementado en los navegadores</a> actuales cambie el funcionamiento interno de la gestión de eventos en muchos <em>frameworks</em> MVC que ahora usan técnicas propias.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_eventos_para_gestionar_operaciones_asíncronas">2.4.3. Eventos para gestionar operaciones asíncronas</h4>
<div class="paragraph">
<p>Antes hemos visto el caso de la operación <code>fetch</code>, para actualizar un modelo/colección con los datos del servidor, que al ser asíncrona continúa la ejecución sin haber recibido todavía los datos. Podríamos saber cuándo se han recibido por ejemplo suscribiéndonos al evento <code>sync</code>, que se dispara cuando los datos locales se sincronizan con el servidor.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">Usuario</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">Model</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span><span class="tok-nx">urlRoot</span><span class="tok-o">:</span><span class="tok-s1">&#39;http://localhost:4567/usuarios&#39;</span><span class="tok-p">});</span>
<span class="tok-kd">var</span> <span class="tok-nx">u1</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Usuario</span><span class="tok-p">();</span>
<span class="tok-nx">u1</span><span class="tok-p">.</span><span class="tok-nx">set</span><span class="tok-p">(</span><span class="tok-s2">&quot;id&quot;</span><span class="tok-p">,</span><span class="tok-mi">1</span><span class="tok-p">)</span>
<span class="tok-kd">var</span> <span class="tok-nx">obs</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
  <span class="tok-nx">sync_handler</span> <span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">modelo</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;Recibido el usuario con login &quot;</span> <span class="tok-o">+</span> <span class="tok-nx">modelo</span><span class="tok-p">.</span><span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-s2">&quot;login&quot;</span><span class="tok-p">));</span>
  <span class="tok-p">}</span>
<span class="tok-p">};</span>
<span class="tok-nx">_</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">(</span><span class="tok-nx">obs</span><span class="tok-p">,</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">Events</span><span class="tok-p">);</span>
<span class="tok-nx">obs</span><span class="tok-p">.</span><span class="tok-nx">listenTo</span><span class="tok-p">(</span><span class="tok-nx">u1</span><span class="tok-p">,</span><span class="tok-s1">&#39;sync&#39;</span><span class="tok-p">,</span><span class="tok-nx">obs</span><span class="tok-p">.</span><span class="tok-nx">sync_handler</span><span class="tok-p">)</span>
<span class="tok-nx">u1</span><span class="tok-p">.</span><span class="tok-nx">fetch</span><span class="tok-p">();</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_emitir_eventos_de_manera_manual_eventos_propios">2.4.4. Emitir eventos de manera manual. Eventos propios</h4>
<div class="paragraph">
<p>Podemos también generar un evento manualmente, incluso eventos propios. En caso de ser un evento propio lo único que tenemos que hacer es inventar un nombre para el evento. Por convenio se usa el tipo de componente y el nombre dado al evento separados por <code>:</code>. Por ejemplo <code>model:miEvento</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">Usuario</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">Model</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span><span class="tok-nx">urlRoot</span><span class="tok-o">:</span><span class="tok-s1">&#39;http://localhost:4567/usuarios&#39;</span><span class="tok-p">});</span>
<span class="tok-kd">var</span> <span class="tok-nx">u1</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Usuario</span><span class="tok-p">();</span>
<span class="tok-kd">var</span> <span class="tok-nx">obs</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
  <span class="tok-nx">miEvento_handler</span> <span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">modelo</span><span class="tok-p">,</span> <span class="tok-nx">mensaje</span><span class="tok-p">)</span> <span class="tok-p">{</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;evento sobre &quot;</span> <span class="tok-o">+</span> <span class="tok-nx">modelo</span><span class="tok-p">.</span><span class="tok-nx">cid</span><span class="tok-p">);</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;el mensaje dice &quot;</span> <span class="tok-o">+</span> <span class="tok-nx">mensaje</span><span class="tok-p">);</span>
  <span class="tok-p">}</span>
<span class="tok-p">};</span>
<span class="tok-nx">_</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">(</span><span class="tok-nx">obs</span><span class="tok-p">,</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">Events</span><span class="tok-p">);</span>
<span class="tok-nx">obs</span><span class="tok-p">.</span><span class="tok-nx">listenTo</span><span class="tok-p">(</span><span class="tok-nx">u1</span><span class="tok-p">,</span><span class="tok-s1">&#39;model:miEvento&#39;</span><span class="tok-p">,</span><span class="tok-nx">obs</span><span class="tok-p">.</span><span class="tok-nx">miEvento_handler</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>En un momento veremos de dónde salen los dos parámetros del <em>handler</em>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Disparamos el evento llamando a <code>trigger</code> desde el objeto que emite el evento:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">u1</span><span class="tok-p">.</span><span class="tok-nx">trigger</span><span class="tok-p">(</span><span class="tok-s2">&quot;model:miEvento&quot;</span><span class="tok-p">,</span> <span class="tok-nx">u1</span><span class="tok-p">,</span> <span class="tok-s2">&quot;¡hola!&quot;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>trigger</code> admite un número variable de argumentos.  El primero es el nombre del evento a generar y el resto son los parámetros que se le pasarán al <em>handler</em>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuración_de_la_comunicación_con_el_api_rest">2.5. Configuración de la comunicación con el API REST</h3>
<div class="paragraph">
<p>Backbone sigue por defecto algunas convenciones habituales en REST a la hora de comunicarse con el API, por ejemplo que las inserciones se hacen con POST, que la URL de un modelo se obtiene concatenando el <code>id</code> con la URL de la colección, etc. Sin embargo ¿qué ocurre si nuestro API REST no sigue alguna de estas convenciones?. Tendremos que sobreescribir alguno de los métodos de Backbone para adaptarlo a nuestras necesidades.</p>
</div>
<div class="paragraph">
<p>También es muy típico el caso en el que debemos autentificarnos enviando un <em>api key</em>, bien sea en una cabecera HTTP o bien como un parámetro de la petición. Es decir, que tenemos que enviar información adicional a la que envía Backbone por defecto. Vamos a ver cómo tratar también con estos casos.</p>
</div>
<div class="sect3">
<h4 id="_configuración_del_identificador_y_o_la_url_del_modelo">2.5.1. Configuración del identificador y/o la URL del modelo</h4>
<div class="paragraph">
<p>Ya hemos comentado que Backbone necesita que cada modelo tenga un <code>id</code> para poder identificarlo de manera única en el servidor. Si los objetos que devuelve nuestro API siguen la misma convención no tendremos que hacer nada en especial, pero hay algunas plataformas en las que el identificador no es el atributo <code>id</code> sino que se usa otro nombre. Por ejemplo como veréis en la asignatura de NoSQL, en MongoDB se usa el campo <code>_id</code> como identificador. En ese caso lo único que tendremos que hacer es asignar a la propiedad <code>idAttribute</code> del modelo el nombre del atributo que actúa de identificador.</p>
</div>
<div class="paragraph">
<p>Si el API devuelve un identificador más complejo (por ejemplo formado por dos atributos, o por parte de un atributo) no podemos establecer esta simple correspondencia. En ese caso lo que podemos hacer es sobreescribir el método <code>url()</code>, que debería devolver la URL del modelo, y que por defecto se obtiene como la URL "base" más el <code>id</code>. La URL base de un modelo se define bien como la <code>url</code> de la colección, si el modelo está incluido en una, bien como el valor de la propiedad <code>urlRoot</code> del modelo (que por defecto es vacío y tenemos que especificar si lo deseamos).</p>
</div>
<div class="paragraph">
<p>Por ejemplo supongamos que un API usara como identificador el atributo <code>id</code> pero luego la URL de un objeto se formara concatenando la URL base + el id + el sufijo <code>/data</code> (de acuerdo, es un ejemplo un poco raro pero podría ser). En el modelo haríamos algo como:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">MiModelo</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">Model</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span>
  <span class="tok-nx">url</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-k">return</span> <span class="tok-s1">&#39;http://miapi.com/api/&#39;</span> <span class="tok-o">+</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">id</span> <span class="tok-o">+</span> <span class="tok-s1">&#39;/data&#39;</span><span class="tok-p">;</span>
  <span class="tok-p">}</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_parseo_a_medida_de_la_respuesta_del_servidor">2.5.2. Parseo "a medida" de la respuesta del servidor</h4>
<div class="paragraph">
<p>Por defecto Backbone toma la respuesta del servidor como un objeto JSON y asigna sus propiedades "de primer nivel" como atributos del modelo. Esto es porque <a href="http://backbonejs.org/docs/backbone.html#section-75">la implementación por defecto de la función <code>parse()</code></a>, que es la que se usa para analizar la respuesta del servidor, simplemente devuelve tal cual el cuerpo de la respuesta:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">parse</span><span class="tok-o">:</span> <span class="tok-kd">function</span> <span class="tok-p">(</span><span class="tok-nx">resp</span><span class="tok-p">,</span> <span class="tok-nx">options</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-k">return</span> <span class="tok-nx">resp</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Sin embargo hay muchos APIs que en los listados "envuelven" los resultados en un objeto que actúa como <em>wrapper</em> y los resultados en sí están dentro de él. Esto es típico de las operaciones de búsqueda o listados, por ejemplo al <a href="https://developer.github.com/v3/search/">buscar repositorios en el API de GitHub</a>. En este caso lo que haría Backbone es guardar el <em>wrapper</em> dentro del modelo, que no es lo que queremos. Tendremos pues que sobreescribir <code>parse()</code>. En el ejemplo de búsqueda en GitHub, el <em>wrapper</em> tiene una propiedad <code>items</code> donde están los resultados como un array. De modo que si tuvieramos una colección <code>Repositorios</code> tendríamos que hacer algo como:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">Repositorios</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">Collection</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span>
  <span class="tok-p">...</span>
  <span class="tok-nx">parse</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">response</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-k">return</span> <span class="tok-nx">response</span><span class="tok-p">.</span><span class="tok-nx">items</span><span class="tok-p">;</span>
  <span class="tok-p">}</span>
  <span class="tok-p">...</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_autentificación">2.5.3. Autentificación</h4>
<div class="paragraph">
<p>Todos los APIs en los que podamos modificar información van a requerir que nos autentifiquemos de una forma u otra. Incluso muchos APIs en los que solo se puede leer información requieren del uso de una <em>api key</em> para identificar al "usuario" y evitar que un mismo usuario haga un número de peticiones excesivo. Por defecto Backbone no incorpora ningún mecanismo de autentificación, así que tendremos que añadirlo de algún modo.</p>
</div>
<div class="sect4">
<h5 id="_autentificación_basic">Autentificación BASIC</h5>
<div class="paragraph">
<p>Algunos APIs REST usan autentificación BASIC (aunque está en desuso frente a estándares más modernos como OAuth). La autentificación BASIC implica que hay que enviar el usuario y el password en una cabecera HTTP en cada petición que requiera permisos. Esto se podría implementar como veremos en la siguiente sección, pero dado que HTTP BASIC <a href="https://es.wikipedia.org/wiki/Autenticaci%C3%B3n_de_acceso_b%C3%A1sica">es un estándar</a>, ya hay <em>plugins</em> de terceros listos para usar en Backbone. El más conocido es probablemente <a href="https://github.com/fiznool/backbone.basicauth">este</a>. Lo que hace es sobreescribir la función <code>sync</code> para añadir automáticamente las cabeceras HTTP adecuadas. Para usarlo, solo hay que incluir el <code>.js</code> en la página después de incluir el Backbone original. Veamos un ejemplo de uso:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">Modelo</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">Model</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span>
  <span class="tok-nx">urlRoot</span><span class="tok-o">:</span> <span class="tok-s1">&#39;https://miapi.com/modelos&#39;</span>
<span class="tok-p">});</span>

<span class="tok-kd">var</span> <span class="tok-nx">m</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Modelo</span><span class="tok-p">();</span>
<span class="tok-c1">//Fijamos usuario y password que se enviarán al servidor cuando hagamos GET/POST/PUT/DELETE del modelo</span>
<span class="tok-nx">m</span><span class="tok-p">.</span><span class="tok-nx">credentials</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
  <span class="tok-nx">username</span><span class="tok-o">:</span> <span class="tok-s1">&#39;pepe&#39;</span><span class="tok-p">,</span>
  <span class="tok-nx">password</span><span class="tok-o">:</span> <span class="tok-s1">&#39;pepe&#39;</span>
<span class="tok-p">}</span>
<span class="tok-nx">m</span><span class="tok-p">.</span><span class="tok-nx">set</span><span class="tok-p">(</span><span class="tok-s1">&#39;saludo&#39;</span><span class="tok-p">,</span><span class="tok-s1">&#39;Hola Backbone&#39;</span><span class="tok-p">);</span>
<span class="tok-nx">m</span><span class="tok-p">.</span><span class="tok-nx">save</span><span class="tok-p">().</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;salvado!!&#39;</span><span class="tok-p">));</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_autentificación_a_medida">Autentificación "A medida"</h5>
<div class="paragraph">
<p>La mayoría de veces la información de autentificación hay que enviarla en forma de una cabecera especial, típicamente <code>Authorization</code>, con un <em>token</em> de sesión que el servidor nos debe haber devuelto previamente al hacer login.</p>
</div>
<div class="paragraph">
<p>Hay varias formas de enviar la cabecera adicional requerida. Una solución es sobreescribir el <code>sync</code> de Backbone. Se pueden implementar algunas "menos invasivas"  pero menos elegantes aprovechando que internamente Backbone usa jQuery para hacer las peticiones AJAX, por lo que podemos usar los métodos estándar de jQuery para manipular la petición. Por ejemplo el método <code>$.ajaxPrefilter()</code> nos permite modificar una petición antes de que se envíe al servidor, cambiando sus opciones, que son las mismas que podemos usar en el típico <code>$.ajax()</code>.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, si tenemos que autentificarnos o enviar datos adicionales mediante cabeceras especiales, podríamos hacer algo como:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">ajaxPrefilter</span><span class="tok-p">(</span><span class="tok-kd">function</span> <span class="tok-p">(</span><span class="tok-nx">opts</span><span class="tok-p">,</span> <span class="tok-nx">originalOpts</span><span class="tok-p">,</span> <span class="tok-nx">jqXHR</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-kd">var</span> <span class="tok-nx">headers</span> <span class="tok-o">=</span> <span class="tok-nx">originalOpts</span><span class="tok-p">.</span><span class="tok-nx">headers</span> <span class="tok-o">||</span> <span class="tok-p">{};</span>
  <span class="tok-nx">opts</span><span class="tok-p">.</span><span class="tok-nx">headers</span> <span class="tok-o">=</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">(</span><span class="tok-nx">headers</span><span class="tok-p">,</span> <span class="tok-p">{</span>
      <span class="tok-s2">&quot;Authorization&quot;</span><span class="tok-o">:</span> <span class="tok-s2">&quot;ponemos_lo_que_haga_falta&quot;</span>
      <span class="tok-s2">&quot;X-Una-Cabecera-Arbitraria&quot;</span><span class="tok-o">:</span> <span class="tok-s2">&quot;un_valor_arbitrario&quot;</span><span class="tok-p">,</span>
  <span class="tok-p">});</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En ocasiones es necesario enviar una <code>api key</code> como un parámetro más de la petición. Podemos hacer esto en el <code>fetch</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-c1">//supongamos que el API pide que enviemos la clave en un parámetro HTTP llamado &quot;apikey&quot;</span>
<span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">fetch</span><span class="tok-p">({</span><span class="tok-nx">data</span><span class="tok-o">:</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">param</span><span class="tok-p">({</span><span class="tok-nx">apikey</span><span class="tok-o">:</span> <span class="tok-nx">MI_API_KEY</span><span class="tok-p">})</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_apis_no_rest_localstorage">2.5.4. APIs no REST. LocalStorage.</h4>
<div class="paragraph">
<p>Para los APIs que no sean del todo REST tendremos que sobreescribir el método <code>sync()</code>, que es el "corazón" de la comunicación con el servidor. Evidentemente esto va a ser mucho más complicado que todas las configuraciones que hemos visto hasta ahora. No obstante, hay ciertos casos de uso típicos para los que se han desarrollado <em>plugins</em> de terceros.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, hay APIs de terceros que permiten sincronizar los datos con el <em>LocalStorage</em> del navegador en lugar de con un servidor remoto. Esto es muy interesante para aplicaciones que puedan trabajar <em>offline</em> por ejemplo agendas, listas de tareas, notas, &#8230;&#8203; el más conocido es <a href="http://documentup.com/jeromegn/backbone.localStorage"><em>Backbone localStorage Adapter</em></a>, que nos permite sincronizar una colección automáticamente con el LocalStorage, sin más que definir una propiedad <code>localStorage</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">UnaColleccion</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">Collection</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span>

  <span class="tok-nx">localStorage</span><span class="tok-o">:</span> <span class="tok-k">new</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">LocalStorage</span><span class="tok-p">(</span><span class="tok-s2">&quot;UnaColeccion&quot;</span><span class="tok-p">),</span> <span class="tok-c1">// Un nombre único dentro de la aplicación</span>

  <span class="tok-c1">// ... todo lo demás es igual</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Incluso hay <em>plugins</em>, como <a href="https://github.com/nilbus/Backbone.dualStorage"><em>DualStorage</em></a> que permiten trabajar con el API REST remoto por defecto y cambiar de manera transparente al LocalStorage cuando se detecta que estamos <em>offline</em>.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="sesion02ejer">2.6. Ejercicios de modelos y colecciones</h3>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Por el momento las aplicaciones que vamos a desarrollar no tendrán interfaz, solo modelos y colecciones. Así que la forma más sencilla de probarlas es a través de la <strong>consola de Javascript</strong> del navegador.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_star_wars_api_0_4">2.6.1. Star Wars API (0,4)</h4>
<div class="paragraph">
<p>Este ejercicio debes entregarlo en una carpeta llamada <code>star_wars</code>.</p>
</div>
<div class="paragraph">
<p>Vamos a probar cómo comunicarnos mediante Backbone con el  <a href="http://swapi.co/">API de Star Wars</a> que ya has usado en otros ejercicios. Como sabes, el API solo permite hacer peticiones GET, por lo que vamos a centrarnos en listar y filtrar datos.</p>
</div>
<div class="paragraph">
<p>Tendremos que adaptar la persistencia REST que implementa Backbone por defecto a las peculiaridades de este API.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Define una clase modelo llamada <code>Personaje</code> y una clase colección <code>Personajes</code></strong> formada por instancias de la anterior.</p>
<div class="ulist">
<ul>
<li>
<p><strong>Define la <code>url</code></strong> de la colección al valor que consideres apropiado.</p>
</li>
<li>
<p>Si haces una <a href="http://swapi.co/api/people">petición para listar personajes</a> verás que el objeto JSON devuelto no es directamente la lista, sino que la lista está dentro de la propiedad <code>results</code>. <strong>Sobreescribe el método <code>parse()</code></strong> de la colección <code>Personajes</code> para que rellene la colección adecuadamente.</p>
</li>
<li>
<p>Finalmente comprueba en la consola del navegador que si creas una colección vacía y haces <code>fetch</code> se llena de resultados. ¡¡Recuerda que <code>fetch</code> es asíncrono y si lo pruebas interactivamente tendrás que esperar un poco a obtener resultados!!.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Como los listados del API están paginados, al hacer un <code>fetch()</code> solo vas a obtener los 10 primeros resultados. Para arreglar esto tendríamos que <a href="http://stackoverflow.com/questions/13753540/appending-data-to-same-collection-after-every-pagination-fetch">sobreescribir el método <code>parse()</code></a> para que vaya haciendo <code>fetch()</code> mientras queden resultados. No es necesario que lo hagas, trabajaremos solo con 10 resultados.
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Recuerda que Backbone necesita identificar cada modelo de manera única y que por defecto lo hace con la propiedad <code>id</code>. No obstante si accedes a <a href="http://swapi.co/api/people">http://swapi.co/api/people</a> verás que los personajes no tienen <code>id</code>. Tendrás que escoger un campo que sirva de identificador y  <strong>definir la propiedad <code>idAttribute</code> de <code>Personaje</code></strong> para indicar que este debe actuar de identificador. Para comprobar que funciona, crea de nuevo una colección vacía, haz fetch() y luego imprime el <code>id</code> del primer objeto, algo como:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">lista</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Personajes</span><span class="tok-p">();</span>
<span class="tok-nx">lista</span><span class="tok-p">.</span><span class="tok-nx">fetch</span><span class="tok-p">().</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(){</span>
   <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">lista</span><span class="tok-p">.</span><span class="tok-nx">at</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">).</span><span class="tok-nx">id</span><span class="tok-p">);</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Modifica la colección <code>Personajes</code> para hacer que <strong>la colección esté ordenada</strong> alfabéticamente por nombre de manera ascendente.</p>
</li>
<li>
<p>Añade un método a la colección llamado <code>buscarPorNombre(cadena)</code>, <strong>que la filtre</strong> devolviendo solo aquellos personajes cuyo nombre contenga la subcadena especificada.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_comunicación_con_un_api_rest_completo_0_6">2.6.2. Comunicación con un API REST completo (0,6)</h4>
<div class="paragraph">
<p>Este ejercicio debes entregarlo en una carpeta llamada <code>alquiler_coches</code>. Seguiremos trabajando sobre la misma carpeta en más sesiones.</p>
</div>
<div class="paragraph">
<p>Vamos a ir creando en sucesivas sesiones una aplicación para una compañía de alquiler de coches. En concreto vamos a ir desarrollando solo la parte de administración en la que se podrá listar los vehículos, darlos de alta/baja, editarlos,&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Para no tener que programarnos el <em>backend</em> desde cero, ya que no es el objetivo de la asignatura, usaremos una plataforma de tipo <em>BaaS (Backend As A Service)</em>, con la que podemos crear un <em>backend</em> de tipo REST de manera sencilla.</p>
</div>
<div class="sect4">
<h5 id="_uso_básico_de_la_plataforma_baas">Uso básico de la plataforma BaaS</h5>
<div class="paragraph">
<p>Usaremos una plataforma llamada <a href="http://kinvey.com">Kinvey</a>. Aunque ofrece otros servicios, el que nos interesa es el de <em>DataStore</em>, con el que podemos hacer CRUD de objetos en el servidor mediante un API REST. Los objetos no son más que conjuntos de pares <em>propiedad-valor</em>, al igual que en Backbone.</p>
</div>
<div class="paragraph">
<p>Para usar la plataforma primero hay que <a href="https://console.kinvey.com/sign-up">darse de alta</a> como desarrollador. Una vez dados de alta, pulsamos sobre "Get Started with your first app" y comenzamos a crear una app en el servidor. Lo primero será elegir un nombre, por ejemplo <code>expertojava</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/02ejer/crear_app.png" alt="crear app" width="50%">
</div>
</div>
<div class="paragraph">
<p>Una vez creada (tardará unos segundos), pasamos a editar el entorno de <code>Development</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/02ejer/editar_development.png" alt="editar development" width="50%">
</div>
</div>
<div class="paragraph">
<p>Aparecerá nuestro <em>dashboard</em>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/02ejer/dashboard.png" alt="dashboard" width="50%">
</div>
</div>
<div class="paragraph">
<p>Lo primero que podemos hacer es crear una colección de entidades, el equivalente a una colección de Backbone pero en el lado del servidor. Si nos fijamos, en la parte derecha de la pantalla tenemos un apartado 'Collections' que nos invita a crear una nueva. Para crearla solo necesitamos darle un nombre, en nuestro caso <code>coches</code>.</p>
</div>
<div class="paragraph">
<p>Una vez creada la colección (vacía, por el momento) debemos crear un nuevo usuario, ya que desde el lado de Backbone siempre hay que autentificarse para hacer cualquier operación con el <em>backend</em>. En el menú lateral izquierdo, hacemos <em>click</em> sobre <code>Users</code>, y luego en la barra de herramientas de la parte superior, sobre el de <code>Add user</code>. Nos pedirá simplemente un <code>username</code> y un <code>password</code> (este no es nuestro usuario de Kinvey, es un usuario ficticio para poder probar nuestra <em>app</em>, valdrá cualquiera).</p>
</div>
<div class="paragraph">
<p>Ahora ya podemos probar el <em>backend</em>. Antes de ponernos con backbone podemos hacerlo desde la terminal de linux, con <code>curl</code>. Vamos a probar a crear un nuevo coche</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">curl -H <span class="tok-s1">&#39;Content-type:application/json&#39;</span> --user MI_USUARIO:MI_PASSWORD -d <span class="tok-s1">&#39;{&quot;matricula&quot;:&quot;1111AAA&quot;, &quot;modelo&quot;:&quot;Opel Corsa&quot;}&#39;</span> https://baas.kinvey.com/appdata/MI_APP_ID/coches</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>CUIDADO:</strong> hay que cambiar MI_USUARIO y MI_PASSWORD por los del usuario que acabamos de dar de alta para nuestra <em>app</em>, y MI_APP_ID por el identificador único para nuestra app, podemos verlo en la parte superior del <em>dashboard</em>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/02ejer/app_id.png" alt="app id" width="50%">
</div>
</div>
<div class="paragraph">
<p>una vez ejecutado el comando, si todo ha ido bien el servidor debería responder con un JSON con los datos del nuevo objeto creado, y al examinar la colección <code>Coches</code> desde el <em>dashboard</em> deberían aparecer los datos del coche dado de alta.</p>
</div>
</div>
<div class="sect4">
<h5 id="_el_modelo_code_coche_code_en_backbone">El modelo <code>Coche</code> en Backbone</h5>
<div class="paragraph">
<p>Por el momento los coches tendrán una <code>matricula</code>, un <code>modelo</code>, un <code>kilometraje</code> y un valor <code>disponible</code> indicando si está disponible o por el contrario está alquilado.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Crea un modelo de Backbone</strong> llamado <code>Coche</code>.</p>
</li>
<li>
<p>Adapta el modelo para que pueda comunicarse con el API remoto, de manera similar a como hiciste en el API de Star Wars</p>
<div class="ulist">
<ul>
<li>
<p><strong>Define el valor de la propiedad <code>urlRoot</code></strong> para que se pueda sincronizar el modelo con el servidor aunque no esté dentro de una colección. Recuerda que antes sincronizábamos con el servidor una colección, y en ese caso la propiedad se llama <code>url</code>. Para un modelo se llama <code>urlRoot</code>. Recuerda que la URL sería  <code><a href="https://baas.kinvey.com/appdata/MI_APP_ID/coches" class="bare">https://baas.kinvey.com/appdata/MI_APP_ID/coches</a></code>, sustituyendo <code>MI_APP_ID</code> por el de nuestra <em>app</em>.</p>
</li>
<li>
<p><strong>Define como campo <code>id</code></strong> el que Kinvey llama <code>_id</code>.</p>
</li>
<li>
<p>Usa el <em>plugin</em> de autentificación BASIC para backbone que hemos visto en los apuntes, ya que todas las peticiones a Kinvey deben estar autentificadas.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Implementa un <strong>método de validación</strong> para comprobar al menos que la matrícula está formada por 4 dígitos seguidos de 3 letras.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Para probar lo implementado, en la consola Javascript crea manualmente coches, asignándoles valores a los campos y comprueba interactivamente que se pueden guardar, recuperar, y modificar. Comprueba que si la matrícula no es válida no se llega a hacer la petición al servidor.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Crea la colección de Backbone* <code>ListaCoches</code>, formada por instancias del modelo anterior.</p>
<div class="ulist">
<ul>
<li>
<p>Define su <code>url</code> como proceda para poder comunicarse con Kinvey</p>
</li>
<li>
<p>Usa el <em>plugin</em> de autentificación BASIC</p>
</li>
</ul>
</div>
</li>
<li>
<p>Comprueba que al hacer <code>fetch()</code> de la colección obtienes los mismos modelos que ves en tu <em>dashboard</em> de la web de Kinvey.</p>
</li>
<li>
<p>Crea un método <code>listarDisponibles</code> que filtre los coches mostrando solo los que están disponibles para alquilar.</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion03">3. Vistas y templates. Routing</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_vistas">3.1. Vistas</h3>
<div class="paragraph">
<p>Las vistas son los componentes que se encargan de mostrar la información al usuario. En otros <em>frameworks</em> MVC las vistas son <em>plantillas</em>: mitad HTML, mitad variables e instrucciones, que son el esqueleto de lo que el usuario va a ver en su pantalla. Esto sucede por ejemplo en Rails (Ruby), en Spring MVC (Java),&#8230;&#8203; En Backbone, por el contrario, <strong>las vistas son <em>código javascript</em></strong>. Este código genera el HTML de la interfaz y encapsula los manejadores de evento que se ocupan de las acciones del usuario. En Backbone se pueden usar <em>templates</em>  para generar el HTML, pero en cuanto a si usarlas o no o qué motor de plantillas usar, es totalmente "agnóstico".</p>
</div>
<div class="paragraph">
<p>La vista más simple que podemos crear en Backbone es la que aparece a continuación, aunque es un poco "aburrida", ya que está prácticamente vacía. Como se puede ver, la mecánica es similar a la de crear un modelo</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-c1">//Creamos la &quot;clase&quot; Vista</span>
<span class="tok-kd">var</span> <span class="tok-nx">Vista</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">View</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">();</span>
<span class="tok-c1">//Instanciamos una vista</span>
<span class="tok-kd">var</span> <span class="tok-nx">unaVista</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Vista</span><span class="tok-p">();</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_la_propiedad_el">3.1.1. La propiedad "el"</h4>
<div class="paragraph">
<p>Todas las vistas tienen una propiedad predefinida llamada <strong><code>el</code>, que representa el nodo del DOM que es la raíz del HTML de la vista</strong>. La vista genera HTML y lo lo coloca dentro de <code>el</code> (luego veremos cómo se hace esto habitualmente). Después nosotros somos los responsables de tomar esa propiedad <code>el</code> e insertarla en el lugar que queramos del DOM.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">Vista</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">View</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">();</span>
<span class="tok-kd">var</span> <span class="tok-nx">unaVista</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Vista</span><span class="tok-p">();</span>
<span class="tok-c1">//generamos el HTML y lo metemos en &#39;el&#39; (todavía no aparecerá en pantalla)</span>
<span class="tok-c1">//normalmente no se suele manipular &#39;el&#39; desde fuera, esto es solo un ejemplo</span>
<span class="tok-nx">unaVista</span><span class="tok-p">.</span><span class="tok-nx">el</span><span class="tok-p">.</span><span class="tok-nx">innerHTML</span><span class="tok-p">(</span><span class="tok-s1">&#39;Hola soy una vista de Backbone&#39;</span><span class="tok-p">)</span>
<span class="tok-c1">//Añadimos el HTML generado al cuerpo de la página</span>
<span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">body</span><span class="tok-p">.</span><span class="tok-nx">appendChild</span><span class="tok-p">(</span><span class="tok-nx">unaVista</span><span class="tok-p">.</span><span class="tok-nx">el</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por defecto, <code>el</code> es una etiqueta <code>&lt;div&gt;</code>. Si ejecutamos el código anterior veremos que por tanto se le añade un <code>&lt;div&gt;</code> a la página con el mensaje que hemos puesto.</p>
</div>
<div class="paragraph">
<p>Podemos darle el valor que queramos a <code>el</code> si no nos interesa el valor por defecto. De hecho podemos configurarla totalmente a nuestra medida con una serie de atributos</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&lt;</span><span class="tok-nx">div</span> <span class="tok-nx">id</span><span class="tok-o">=</span><span class="tok-s2">&quot;miVista&quot;</span><span class="tok-o">&gt;</span>
<span class="tok-o">&lt;</span><span class="tok-err">/div&gt;</span>
<span class="tok-o">&lt;</span><span class="tok-nx">script</span> <span class="tok-nx">type</span><span class="tok-o">=</span><span class="tok-s2">&quot;text/javascript&quot;</span><span class="tok-o">&gt;</span>
<span class="tok-kd">var</span> <span class="tok-nx">Vista</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">View</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">();</span>
<span class="tok-kd">var</span> <span class="tok-nx">unaVista</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Vista</span><span class="tok-p">({</span>
    <span class="tok-nx">tagName</span><span class="tok-o">:</span> <span class="tok-s1">&#39;span&#39;</span><span class="tok-p">,</span>
    <span class="tok-nx">className</span><span class="tok-o">:</span> <span class="tok-s1">&#39;vista&#39;</span><span class="tok-p">,</span>
    <span class="tok-nx">id</span><span class="tok-o">:</span> <span class="tok-s1">&#39;vista_principal&#39;</span><span class="tok-p">,</span>
    <span class="tok-nx">attributes</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-s1">&#39;data-fecha&#39;</span><span class="tok-o">:</span> <span class="tok-k">new</span> <span class="tok-nb">Date</span><span class="tok-p">()}</span>
  <span class="tok-p">});</span>
  <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">body</span><span class="tok-p">.</span><span class="tok-nx">appendChild</span><span class="tok-p">(</span><span class="tok-nx">unaVista</span><span class="tok-p">.</span><span class="tok-nx">el</span><span class="tok-p">)</span>
<span class="tok-o">&lt;</span><span class="tok-err">/script&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Al ejecutar el código anterior al cuerpo de la página se le añadirá un HTML como este</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;span</span> <span class="tok-na">data-fecha=</span><span class="tok-s">&quot;Thu Jan 29 2015 11:39:38 GMT+0100 (CET)&quot;</span> <span class="tok-na">id=</span><span class="tok-s">&quot;vista_principal&quot;</span> <span class="tok-na">class=</span><span class="tok-s">&quot;vista&quot;</span><span class="tok-nt">&gt;&lt;/span&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Hasta ahora hemos observado que la vista genera el HTML pero nosotros somos los responsables de incluirlo en la página. Hay otra posibilidad: darle al <code>el</code> como valor el <code>id</code> de algún nodo de la página. Así, al poner</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&lt;</span><span class="tok-nx">div</span> <span class="tok-nx">id</span><span class="tok-o">=</span><span class="tok-s2">&quot;miVista&quot;</span><span class="tok-o">&gt;</span>
<span class="tok-o">&lt;</span><span class="tok-err">/div&gt;</span>
<span class="tok-o">&lt;</span><span class="tok-nx">script</span><span class="tok-o">&gt;</span>
<span class="tok-kd">var</span> <span class="tok-nx">Vista</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">View</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">();</span>
<span class="tok-kd">var</span> <span class="tok-nx">unaVista</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Vista</span><span class="tok-p">({</span><span class="tok-nx">el</span><span class="tok-o">:</span><span class="tok-s1">&#39;#miVista&#39;</span><span class="tok-p">});</span>
<span class="tok-nx">unaVista</span><span class="tok-p">.</span><span class="tok-nx">el</span><span class="tok-p">.</span><span class="tok-nx">innerHTML</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;Hola yo ya estoy en la página&quot;</span><span class="tok-p">;</span>
<span class="tok-o">&lt;</span><span class="tok-err">/script&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El contenido ya aparecería insertado en el DOM de la página actual.</p>
</div>
<div class="paragraph">
<p>Como ya hemos dicho en otras ocasiones Backbone facilita el trabajo con jQuery. En este caso tiene predefinida una propiedad <code>$el</code> que representa lo mismo que <code>el</code> pero es un objeto jQuery en lugar de  un nodo DOM estándar, por lo que podemos usar el API de jQuery si nos resulta más cómodo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">unaVista</span><span class="tok-p">.</span><span class="tok-nx">$el</span><span class="tok-p">.</span><span class="tok-nx">html</span><span class="tok-p">(</span><span class="tok-s2">&quot;Hola estoy dentro de la vista&quot;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ya hemos visto que la inclusión de la vista en el DOM se hace manualmente o bien poniendo como valor de <code>el</code> un nodo ya existente en el DOM. Para eliminar la vista del DOM se usa el método <code>remove()</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="__em_rendering_em">3.1.2. <em>Rendering</em></h4>
<div class="paragraph">
<p>Hasta ahora hemos estado manipulando directamente el <code>el</code> para incluir contenido en la vista, pero esta forma de trabajar no es muy "limpia" que digamos. <strong>La convención habitual en Backbone es sobreescribir el método <code>render()</code></strong>, que debería rellenar el contenido del <code>el</code>, generando el HTML de la vista. Y decimos convención ya que si examinamos los fuentes de Backbone veremos que el resto del código no llama a <code>render()</code> en ningún momento, y la implementación por defecto <a href="http://backbonejs.org/docs/backbone.html#section-135">no hace nada</a> (salvo devolver <code>this</code>, hablaremos ahora sobre esto).</p>
</div>
<div class="paragraph">
<p>Así, los ejemplos que hemos puesto hasta ahora quedarían mejor como:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">Vista</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">View</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span>
  <span class="tok-nx">render</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
            <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">$el</span><span class="tok-p">.</span><span class="tok-nx">html</span><span class="tok-p">(</span><span class="tok-s2">&quot;Hola soy una vista&quot;</span><span class="tok-p">)</span>
            <span class="tok-k">return</span> <span class="tok-k">this</span><span class="tok-p">;</span>  <i class="conum" data-value="1"></i><b>(1)</b>
          <span class="tok-p">}</span>
<span class="tok-p">});</span>
<span class="tok-kd">var</span> <span class="tok-nx">unaVista</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Vista</span><span class="tok-p">();</span>
<span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s1">&#39;body&#39;</span><span class="tok-p">).</span><span class="tok-nx">append</span><span class="tok-p">(</span><span class="tok-nx">unaVista</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">().</span><span class="tok-nx">$el</span><span class="tok-p">)</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nótese que:</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Por convenio <code>render()</code> devuelve la vista,lo que es cómodo porque permite encadenar las llamadas, al estilo jQuery: (<code>render().$el</code>).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Debemos llamar explícitamente a <code>render()</code> para rellenar el contenido del <code>el</code>. Ni Backbone ni nadie lo va a hacer por nosotros.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Volvemos a recalcar que <code>render()</code> es simplemente una convención. Podríamos llamar al método que genera el HTML <code>pintar()</code> y funcionaría igual, ya que los responsables de llamarlo somos nosotros. No obstante todos los desarrolladores de Backbone suelen respetar la nomenclatura estándar. Así, cuando se lee código Backbone y se ve el <code>render()</code> uno ya sabe a qué atenerse. Por supuesto en una SPA es de esperar que haya formas de <em>renderizar</em> solo parte de la vista. Pero para eso ya no hay un estándar, definiremos los métodos propios que deseemos.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_eventos_3">3.1.3. Eventos</h4>
<div class="paragraph">
<p>Las vistas que solo muestran contenido estático no son muy divertidas. Normalmente nos interesará que sean interactivas y respondan a eventos. La gestión de eventos también es responsabilidad de la vista, y se define en un objeto en formato JSON llamado <code>events</code>. Las propiedades son nombres de eventos (y de manera opcional un selector CSS indicando el nodo o nodos DOM al que afecta). Los valores son cadenas con el nombre del manejador correspondiente. Por ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">Vista</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">View</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span>
  <span class="tok-nx">render</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">$el</span><span class="tok-p">.</span><span class="tok-nx">html</span><span class="tok-p">(</span><span class="tok-s2">&quot;Ahora soy una vista interactiva &lt;br&gt;&quot;</span><span class="tok-p">);</span>
    <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">$el</span><span class="tok-p">.</span><span class="tok-nx">append</span><span class="tok-p">(</span><span class="tok-s1">&#39;&lt;input type=&quot;button&quot; class=&quot;boton&quot; value=&quot;Haz clic&quot;&gt;&#39;</span><span class="tok-p">);</span>
    <span class="tok-k">return</span> <span class="tok-k">this</span><span class="tok-p">;</span>
  <span class="tok-p">},</span>
  <span class="tok-nx">verMensaje</span> <span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
      <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;Hola!!!&quot;</span><span class="tok-p">);</span>
  <span class="tok-p">},</span>
  <span class="tok-nx">events</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
        <span class="tok-s1">&#39;click .boton&#39;</span> <span class="tok-o">:</span> <span class="tok-s1">&#39;verMensaje&#39;</span>
  <span class="tok-p">}</span>
<span class="tok-p">});</span>
<span class="tok-kd">var</span> <span class="tok-nx">unaVista</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Vista</span><span class="tok-p">();</span>
<span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s1">&#39;body&#39;</span><span class="tok-p">).</span><span class="tok-nx">append</span><span class="tok-p">(</span><span class="tok-nx">unaVista</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">().</span><span class="tok-nx">el</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El selector CSS se busca únicamente dentro de la vista. En el ejemplo, si en la página (fuera de la vista) hubiera otras etiquetas con <code>class="boton"</code> no se verían afectadas por esta gestión de eventos. Esto es interesante porque hace a las vistas <em>modulares</em> y  <em>autocontenidas</em>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
En listados de datos es muy habitual, como veremos en la siguiente sesión, que cada elemento del listado sea una vista distinta. El manejo separado de eventos permite que todas puedan coexistir, cada una procesando sus propios eventos y sin interferir con las demás.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Podemos modificar dinámicamente la gestión de eventos llamando al método <code>delegateEvents()</code> y pasándole un  objeto JSON con el nuevo valor a darle a <code>events</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_vistas_y_modelos">3.2. Vistas y modelos</h3>
<div class="sect3">
<h4 id="_relación_entre_vista_y_modelo">3.2.1. Relación entre vista y modelo</h4>
<div class="paragraph">
<p>Hasta ahora hemos hablado de vistas, pero ¿qué relación mantienen con los modelos?. La idea es que cada vista normalmente tiene una referencia al modelo o colección que representa. Hasta ahora en los ejemplos que hemos visto no había modelo, pero esto en realidad no es lo habitual. Es más habitual algo como:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">Libro</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">Model</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">();</span>
<span class="tok-kd">var</span> <span class="tok-nx">unLibro</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Libro</span><span class="tok-p">({</span><span class="tok-nx">titulo</span><span class="tok-o">:</span><span class="tok-s2">&quot;El mundo del río&quot;</span><span class="tok-p">,</span> <span class="tok-nx">autor</span><span class="tok-o">:</span><span class="tok-s2">&quot;P.J.Farmer&quot;</span><span class="tok-p">});</span>
<span class="tok-kd">var</span> <span class="tok-nx">Vista</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">View</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span>
  <span class="tok-nx">render</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">$el</span>
      <span class="tok-p">.</span><span class="tok-nx">append</span><span class="tok-p">(</span><span class="tok-s2">&quot;&lt;b&gt;&quot;</span><span class="tok-o">+</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">model</span><span class="tok-p">.</span><span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-s2">&quot;titulo&quot;</span><span class="tok-p">)</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;&lt;/b&gt;&quot;</span><span class="tok-p">)</span>
      <span class="tok-p">.</span><span class="tok-nx">append</span><span class="tok-p">(</span><span class="tok-s2">&quot;&lt;br&gt; &lt;em&gt;&quot;</span><span class="tok-o">+</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">model</span><span class="tok-p">.</span><span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-s2">&quot;autor&quot;</span><span class="tok-p">)</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;&lt;/em&gt;&quot;</span><span class="tok-p">)</span>
    <span class="tok-k">return</span> <span class="tok-k">this</span><span class="tok-p">;</span>
  <span class="tok-p">}</span>
<span class="tok-p">});</span>
<span class="tok-kd">var</span> <span class="tok-nx">unaVista</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Vista</span><span class="tok-p">(</span><span class="tok-nx">model</span><span class="tok-o">:</span> <span class="tok-nx">unLibro</span><span class="tok-p">);</span>
<span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s1">&#39;body&#39;</span><span class="tok-p">).</span><span class="tok-nx">append</span><span class="tok-p">(</span><span class="tok-nx">unaVista</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">().</span><span class="tok-nx">$el</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="http://jsbin.com/rovak/1/edit">Código</a> en JSbin.com</p>
</div>
<div class="paragraph">
<p>Con la propiedad <code>collection</code> podemos pasarle una colección a la vista.</p>
</div>
</div>
<div class="sect3">
<h4 id="_data_binding">3.2.2. Data binding</h4>
<div class="paragraph">
<p>El <em>data binding</em> es la vinculación  entre ciertos componentes del modelo y de la vista, de modo que cuando cambia uno de ellos el otro se actualiza automáticamente. La vinculación puede ser solo en un sentido o en ambos. La de un solo sentido suele funcionar del modelo hacia la vista (si cambia el primero se actualiza la segunda) pero no al contrario. La bidireccional se suele usar en formularios, cuando estamos editando los datos del modelo.</p>
</div>
<div class="paragraph">
<p>Backbone no tiene <em>data binding</em> propiamente dicho, ya que el único momento en que están vinculados los datos del modelo y la vista es justo cuando se hace un <em>render</em> de la vista.</p>
</div>
</div>
<div class="sect3">
<h4 id="_data_binding_con_eventos">3.2.3. Data binding con eventos</h4>
<div class="paragraph">
<p>En Backbone es habitual vincular el modelo con la vista usando eventos. Las vistas pueden suscribirse a eventos del modelo. Al recibir el evento la vista debe hacer un <em>rendering</em> parcial, modificando únicamente la parte que no varía. Backbone no va a ayudarnos en esto último, tendremos que hacerlo nosotros mismos. Por ejemplo, supongamos que tenemos un <em>widget</em> que monitoriza el estado de un servidor y debe actualizar la vista automáticamente cuando cambie éste:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">Servidor</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">Model</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">();</span>
<span class="tok-kd">var</span> <span class="tok-nx">miServidor</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Servidor</span><span class="tok-p">({</span><span class="tok-nx">estado</span><span class="tok-o">:</span><span class="tok-s2">&quot;funcionando&quot;</span><span class="tok-p">});</span>
<span class="tok-kd">var</span> <span class="tok-nx">VistaServidor</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">View</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span>
    <span class="tok-nx">initialize</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
      <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">listenTo</span><span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">model</span><span class="tok-p">,</span> <span class="tok-s1">&#39;change:estado&#39;</span><span class="tok-p">,</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">renderEstado</span><span class="tok-p">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-p">},</span>
    <span class="tok-nx">render</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
        <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">$el</span><span class="tok-p">.</span><span class="tok-nx">html</span><span class="tok-p">(</span><span class="tok-s1">&#39;El servidor está: &lt;span id=&quot;estado&quot;&gt;&#39;</span>        <i class="conum" data-value="2"></i><b>(2)</b>
           <span class="tok-o">+</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">model</span><span class="tok-p">.</span><span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-s1">&#39;estado&#39;</span><span class="tok-p">)</span> <span class="tok-o">+</span> <span class="tok-s1">&#39;&lt;/span&gt;&#39;</span><span class="tok-p">);</span>
        <span class="tok-k">return</span> <span class="tok-k">this</span><span class="tok-p">;</span>
    <span class="tok-p">},</span>
    <span class="tok-nx">renderEstado</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>                                     <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s1">&#39;#estado&#39;</span><span class="tok-p">).</span><span class="tok-nx">text</span><span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">model</span><span class="tok-p">.</span><span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-s1">&#39;estado&#39;</span><span class="tok-p">))</span>
    <span class="tok-p">}</span>
<span class="tok-p">});</span>
<span class="tok-kd">var</span> <span class="tok-nx">miVista</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">VistaServidor</span><span class="tok-p">({</span><span class="tok-nx">model</span><span class="tok-o">:</span> <span class="tok-nx">miServidor</span><span class="tok-p">});</span>
<span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s1">&#39;body&#39;</span><span class="tok-p">).</span><span class="tok-nx">append</span><span class="tok-p">(</span><span class="tok-nx">miVista</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">().</span><span class="tok-nx">$el</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Suscribimos a la vista a los cambios de la propiedad <code>estado</code> de su modelo asociado.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Marcamos una parte del HTML con el <code>id="estado"</code> para luego poder cambiar su valor directamente.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>El método <code>renderEstado</code> solamente cambia el HTML que muestra directamente el estado del servidor, no toda la vista.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si ahora cambiara el valor de la propiedad `estado `del modelo el estado se actualizaría sin tener que redibujar totalmente la vista. Podemos probarlo de manera sencilla tecleando en la consola del navegador:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">miServidor</span><span class="tok-p">.</span><span class="tok-nx">set</span><span class="tok-p">(</span><span class="tok-s2">&quot;estado&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;parado&quot;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_data_binding_automático">3.2.4. Data binding automático</h4>
<div class="paragraph">
<p>Aunque ya hemos dicho que Backbone tal cual no tiene <em>binding automático</em>, existen varios <em>plugins</em> que proporcionan esta funcionalidad. Uno de los más conocidos es <a href="http://nytimes.github.io/backbone.stickit/"><code>stickit</code></a>, que vamos a ver aquí brevemente. Hay otros como por ejemplo <a href="http://perka.github.io/backbone-ui/"><code>backbone UI</code></a>, que además incluye <em>widgets</em> o <a href="http://spacenick.github.io/backbone-baguette/"><code>backbone baguette</code></a>.</p>
</div>
<div class="paragraph">
<p>Veamos un ejemplo de cómo conseguir <em>data binding</em> automático desde el modelo hacia la vista. Hasta cierto punto la idea es similar a lo que hacíamos antes con los eventos: en la vista debemos tener ciertas secciones del HTML marcadas indicando que ahí van los datos que queremos vincular. La diferencia es que <code>stickit</code> los actualizará automáticamente por nosotros sin necesidad de gestionar los eventos ni implementar el <em>rendering</em> parcial.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">Libro</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">Model</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">();</span>
<span class="tok-kd">var</span> <span class="tok-nx">unLibro</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Libro</span><span class="tok-p">({</span><span class="tok-s1">&#39;titulo&#39;</span><span class="tok-o">:</span><span class="tok-s1">&#39;Juego de tronos&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;autor&#39;</span><span class="tok-o">:</span><span class="tok-s1">&#39;George R.R. Martin&#39;</span><span class="tok-p">})</span>
<span class="tok-kd">var</span> <span class="tok-nx">VistaLibro</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">View</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span>
    <span class="tok-nx">render</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
      <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">$el</span><span class="tok-p">.</span><span class="tok-nx">html</span><span class="tok-p">(</span><span class="tok-s1">&#39;&lt;b id=&quot;titulo&quot;&gt;&lt;/b&gt;, de &lt;em id=&quot;autor&quot;&gt;&lt;/em&gt;&#39;</span><span class="tok-p">);</span>  <i class="conum" data-value="1"></i><b>(1)</b>
      <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">stickit</span><span class="tok-p">();</span> <i class="conum" data-value="2"></i><b>(2)</b>
      <span class="tok-k">return</span> <span class="tok-k">this</span><span class="tok-p">;</span>
    <span class="tok-p">},</span>
    <span class="tok-nx">bindings</span><span class="tok-o">:</span> <span class="tok-p">{</span>  <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-s1">&#39;#titulo&#39;</span><span class="tok-o">:</span> <span class="tok-s1">&#39;titulo&#39;</span><span class="tok-p">,</span>
        <span class="tok-s1">&#39;#autor&#39;</span> <span class="tok-o">:</span> <span class="tok-s1">&#39;autor&#39;</span>
    <span class="tok-p">}</span>
<span class="tok-p">});</span>
<span class="tok-kd">var</span> <span class="tok-nx">miVista</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">VistaLibro</span><span class="tok-p">({</span><span class="tok-nx">model</span><span class="tok-o">:</span><span class="tok-nx">unLibro</span><span class="tok-p">});</span>
<span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s1">&#39;body&#39;</span><span class="tok-p">).</span><span class="tok-nx">append</span><span class="tok-p">(</span><span class="tok-nx">miVista</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">().</span><span class="tok-nx">$el</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>En el HTML de la vista marcamos (en este caso usando <code>id</code>) las partes donde luego queremos que se coloquen los datos. Esto elimina la necesidad de colocar incluso el valor inicial del dato, ya que <code>stickit</code> se encargará de ello automáticamente.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Para que funcione correctamente <code>stickit</code> debemos incluir esta línea al final del método <code>render</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Definimos un conjunto de pares "propiedad":"valor" llamado <code>bindings</code> y muy similar en formato al <code>events</code> de Backbone. Pero en este caso la propiedad es un selector CSS que identifica en la vista dónde está un dato y el valor es el nombre del atributo del modelo que queremos colocar allí.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si ahora modificamos el modelo, la vista se actualizará automáticamente, por ejemplo podemos ejecutar en la consola Javascript la siguiente línea para ver cómo se actualiza la vista</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">unLibro</span><span class="tok-p">.</span><span class="tok-nx">set</span><span class="tok-p">(</span><span class="tok-s2">&quot;titulo&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;Tormenta de espadas&quot;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Stickit</code> soporta también el <em>data binding</em> bidireccional. Lo único que hay que hacer en el ejemplo anterior es cambiar las etiquetas <code>&lt;b&gt;</code> y <code>&lt;em&gt;</code> por campos de formulario de tipo texto, por ejemplo. Podremos observar que cuando se modifica el contenido del campo el atributo del modelo refleja el cambio.</p>
</div>
<div class="paragraph">
<p>Los ejemplos anteriores son con la configuración de la librería por defecto. Podemos forzar el tipo de vinculación que queramos (por ejemplo solo de una dirección en campos de formulario), configurar los eventos de vista que disparan los cambios en el modelo,  incluir nuestros propios <em>handlers</em>,&#8230;&#8203;. La librería es bastante completa y flexible, aquí solo queremos mostrar una pequeña introducción a cómo funcionaría el <em>data binding</em> integrado con Backbone.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="__em_templates_em_plantillas_el_lenguaje_de_plantillas_mustache">3.3. <em>Templates</em> (plantillas). El lenguaje de plantillas Mustache</h3>
<div class="paragraph">
<p>Con el último ejemplo podemos intuir que cuanto más se complique el HTML que debe generar la vista más engorroso va a ser el código, hasta llegar a un punto que lo haga inmanejable para vistas complejas. La solución es la misma a la que se llegó en el lado del servidor hace ya años, en aplicaciones "clásicas" en las que el servidor debe enviar al cliente la página totalmente formada: usar plantillas (<em>templates</em>). Ejemplos clásicos de lenguajes que podríamos considerar de plantillas son JSP, ASP, PHP,&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Al igual que las del servidor, las <em>templates</em> del cliente son fragmentos de HTML con variables intercaladas, y suelen incluir secciones condicionales y secciones repetidas. Aunque las plantillas del lado del servidor pueden incluir típicamente instrucciones arbitrarias de algún lenguaje de programación, dicha posibilidad nunca ha sido muy bien vista desde una perspectiva "purista", ya que acaba mezclando lógica con presentación. Las plantillas definidas en el cliente no suelen usar esta funcionalidad, limitándose habitualmente a condicionales y bucles sencillos.</p>
</div>
<div class="paragraph">
<p>Backbone en sí no incluye ningún lenguaje de <em>templates</em> ni facilita especialmente la integración con ninguno en concreto. Eso sí, la librería <code>underscore</code>, que es un requisito de Backbone, incluye un <a href="http://underscorejs.org/#template">pequeño lenguaje de plantillas</a> que es una elección razonable para casos sencillos.</p>
</div>
<div class="paragraph">
<p>Nosotros veremos aquí un lenguaje de plantillas algo más sofisticado que el de <code>underscore</code> (no mucho más) pero que es mucho más usado en la web: Mustache.</p>
</div>
<div class="paragraph">
<p><a href="https://mustache.github.io/">Mustache</a> es un lenguaje de plantillas del que existen implementaciones en los entornos y lenguajes de programación más variopintos. No solo Javascript, sino también Java, Ruby, Python, Scala, .NET, Android,&#8230;&#8203; Como puede deducirse de esta lista, se puede usar tanto en el lado del cliente como del servidor.</p>
</div>
<div class="paragraph">
<p>La baza principal de Mustache es la simplicidad: aunque se pueden mostrar partes de manera condicional y se puede iterar por listas de valores, no se hace explícitamente con sentencias condicionales o con bucles. Todo se hace con lo que en Mustache se llaman etiquetas o <em>tags</em>, que no son precisamente como las de HTML.</p>
</div>
<div class="paragraph">
<p>Existen implementaciones alternativas a la "de referencia" que incluyen algunas funcionalidades adicionales: muy conocidas son por ejemplo  <a href="http://handlebarsjs.com/">Handlebars.js</a> o <a href="http://twitter.github.io/hogan.js/">Hogan</a>.</p>
</div>
<div class="sect3">
<h4 id="_sintaxis_básica">3.3.1. Sintaxis básica</h4>
<div class="paragraph">
<p>La idea básica es que una plantilla más un "objeto" formado por pares propiedad-valor va a generar el resultado final. En la plantilla se toma todo como literal excepto las partes entre dobles llaves (<code>{{ }}</code>), que representan variables o indican secciones especiales, como ahora veremos.</p>
</div>
<div class="paragraph">
<p>La sintaxis del lenguaje se puede consultar en el <a href="https://mustache.github.io/mustache.5.html">manual <em>online</em></a>. Vamos a ver un ejemplo que incluye todas las características típicas que vamos a necesitar aquí:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-c">&lt;!-- Plantilla --&gt;</span>
<span class="tok-nt">&lt;p&gt;</span>Bienvenido a  <span class="tok-nt">&lt;b&gt;</span>{{lenguaje}}<span class="tok-nt">&lt;/b&gt;</span>, {{#usuario}}{{nombre}}{{/usuario}}. Vamos a usar:<span class="tok-nt">&lt;/p&gt;</span>  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-nt">&lt;ul&gt;</span>
   {{#frameworks}}  <i class="conum" data-value="2"></i><b>(2)</b>
      <span class="tok-nt">&lt;li&gt;</span>{{nombre}} ({{lenguaje}})<span class="tok-nt">&lt;/li&gt;</span>
   {{/frameworks}}
<span class="tok-nt">&lt;/ul&gt;</span>
{{#aviso}}Este curso puede ser peligroso para tu salud{{/aviso}}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-c1">//Datos</span>
<span class="tok-p">{</span>
  <span class="tok-s2">&quot;lenguaje&quot;</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Mustache&quot;</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;usuario&quot;</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-s2">&quot;nombre&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;ExpertoJava&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;curso&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;2014-15&quot;</span><span class="tok-p">},</span>
  <span class="tok-s2">&quot;frameworks&quot;</span><span class="tok-o">:</span> <span class="tok-p">[</span>  <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-p">{</span><span class="tok-s2">&quot;nombre&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;Backbone&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;lenguaje&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;JS&quot;</span><span class="tok-p">},</span>
    <span class="tok-p">{</span><span class="tok-s2">&quot;nombre&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;Angular&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;lenguaje&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;JS&quot;</span><span class="tok-p">},</span>
    <span class="tok-p">{</span><span class="tok-s2">&quot;nombre&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;RESTEasy&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;lenguaje&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;Java&quot;</span><span class="tok-p">},</span>
  <span class="tok-p">],</span>
  <span class="tok-nx">aviso</span><span class="tok-o">:</span> <span class="tok-kc">false</span>  <i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-c">&lt;!-- Resultado final --&gt;</span>
<span class="tok-nt">&lt;p&gt;</span>Bienvenido a  <span class="tok-nt">&lt;b&gt;</span>Mustache<span class="tok-nt">&lt;/b&gt;</span>, ExpertoJava. Vamos a usar:<span class="tok-nt">&lt;/p&gt;</span>
<span class="tok-nt">&lt;ul&gt;</span>
  <span class="tok-nt">&lt;li&gt;</span>Backbone (JS)<span class="tok-nt">&lt;/li&gt;</span>
  <span class="tok-nt">&lt;li&gt;</span>Angular (JS)<span class="tok-nt">&lt;/li&gt;</span>
  <span class="tok-nt">&lt;li&gt;</span>RESTEasy (Java)<span class="tok-nt">&lt;/li&gt;</span>
<span class="tok-nt">&lt;/ul&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>cuando aparece un identificador entre dobles llaves  se sustituye por el valor de la correspondiente propiedad.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>También se pueden usar <em>secciones</em>, que se marcan convencionalmente como <code>{{#seccion}&#8230;&#8203;{{/seccion}}</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Si la sección se corresponde en los datos con una <em>lista</em>, se va iterando por ella. El objeto que se corresponde con la sección es ahora el que marca el contexto de donde tomamos las propiedades.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Podemos usar una sección que se corresponda con una propiedad <em>booleana</em> para implementar partes condicionales. En el resultado final no aparece el último mensaje porque la propiedad correspondiente es <code>false</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_plantillas_en_el_lado_del_cliente">3.3.2. Plantillas en el lado del cliente</h4>
<div class="paragraph">
<p>Estando en el lado del cliente, y usando HTML+JS veamos dónde almacenaríamos la plantilla, de dónde sacaríamos los datos y cómo uniríamos ambos elementos para obtener el resultado final.</p>
</div>
<div class="sect4">
<h5 id="__em_rendering_em_2"><em>Rendering</em></h5>
<div class="paragraph">
<p>En primer lugar, <strong>la plantilla no es más que una cadena</strong>, por tanto la podríamos almacenar en una variable Javascript:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">plantilla</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;&lt;p&gt;Bienvenido a  &lt;b&gt;{{lenguaje}}&lt;/b&gt;, {{#usuario}}{{nombre}}{{/usuario}}. Vamos a usar:&lt;/p&gt;&quot;</span><span class="tok-p">;</span>
<span class="tok-nx">plantilla</span> <span class="tok-o">+=</span> <span class="tok-s2">&quot;&lt;ul&gt; {{#frameworks}} &lt;li&gt;{{nombre}} ({{lenguaje}})&lt;/li&gt; {{/frameworks}}&quot;</span>
<span class="tok-nx">plantilla</span> <span class="tok-o">+=</span> <span class="tok-s2">&quot;{{#aviso}}Este curso puede ser peligroso para tu salud{{/aviso}}&lt;/ul&gt;&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Este código es muy engorroso, en un momento veremos algunas formas de solucionarlo. Por el momento vamos a usarlo tal cual.</p>
</div>
<div class="paragraph">
<p>La lista de pares propiedad-valor no es más que un objeto Javascript, por lo que solo nos queda unir las dos partes para obtener el resultado final. En  <a href="https://github.com/janl/mustache.js">la implementación Javascript</a> de Mustache esto se hace con el método <code>Mustache.render</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-c1">//opcionalmente podemos ejecutar esta línea, que &quot;compilará&quot; la plantilla y la cacheará</span>
<span class="tok-nx">Mustache</span><span class="tok-p">.</span><span class="tok-nx">parse</span><span class="tok-p">(</span><span class="tok-nx">template</span><span class="tok-p">)</span>
<span class="tok-c1">//unir plantilla y datos para generar texto resultante</span>
<span class="tok-kd">var</span> <span class="tok-nx">html</span> <span class="tok-o">=</span> <span class="tok-nx">Mustache</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">(</span><span class="tok-nx">template</span><span class="tok-p">,</span> <span class="tok-nx">datos</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_dónde_almacenar_la_plantilla">Dónde almacenar la plantilla</h5>
<div class="paragraph">
<p>Es evidente que este enfoque se va haciendo inmanejable conforme crece el tamaño y complejidad de la plantilla. Una posibilidad sería <strong>almacenar la plantilla en un archivo aparte</strong> y acceder a ella con una petición AJAX. Por ejemplo, usando jQuery:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-s1">&#39;plantilla.mustache&#39;</span><span class="tok-p">,</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">template</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-kd">var</span> <span class="tok-nx">res</span> <span class="tok-o">=</span> <span class="tok-nx">Mustache</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">(</span><span class="tok-nx">template</span><span class="tok-p">,</span> <span class="tok-nx">datos</span><span class="tok-p">);</span>
  <span class="tok-p">...</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Otra posibilidad es <strong>almacenar la plantilla en la propia página</strong>, pero necesitamos que el navegador lo ignore para que no lo muestre tal cual en la página. Un truco muy usado es incluir la plantilla dentro de una etiqueta <code>&lt;script&gt;</code> con un <code>type</code> no estándar (cualquiera, una cadena inventada al estilo <code>type="text/x-tmpl-mustache"</code>). Si el navegador no reconoce el valor de dicho atributo simplemente ignorará el contenido de la etiqueta, asumiendo que es un <em>script</em> en algún extraño lenguaje de programación para el que no tiene intérprete:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;script </span><span class="tok-na">id=</span><span class="tok-s">&quot;miTemplate&quot;</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text/x-tmpl-mustache&quot;</span><span class="tok-nt">&gt;</span>
  <span class="tok-o">&lt;</span><span class="tok-nx">p</span><span class="tok-o">&gt;</span><span class="tok-nx">Bienvenido</span> <span class="tok-nx">a</span>  <span class="tok-o">&lt;</span><span class="tok-nx">b</span><span class="tok-o">&gt;</span><span class="tok-p">{{</span><span class="tok-nx">lenguaje</span><span class="tok-p">}}</span><span class="tok-o">&lt;</span><span class="tok-err">/b&gt;, {{#usuario}}{{nombre}}{{/usuario}}. Vamos a usar:&lt;/p&gt;</span>
  <span class="tok-o">&lt;</span><span class="tok-nx">ul</span><span class="tok-o">&gt;</span>
     <span class="tok-p">{{</span><span class="tok-err">#</span><span class="tok-nx">frameworks</span><span class="tok-p">}}</span>
        <span class="tok-o">&lt;</span><span class="tok-nx">li</span><span class="tok-o">&gt;</span><span class="tok-p">{{</span><span class="tok-nx">nombre</span><span class="tok-p">}}</span> <span class="tok-p">({{</span><span class="tok-nx">lenguaje</span><span class="tok-p">}})</span><span class="tok-o">&lt;</span><span class="tok-err">/li&gt;</span>
     <span class="tok-p">{{</span><span class="tok-err">/frameworks}}</span>
  <span class="tok-o">&lt;</span><span class="tok-err">/ul&gt;</span>
  <span class="tok-p">{{</span><span class="tok-err">#</span><span class="tok-nx">aviso</span><span class="tok-p">}}</span><span class="tok-nx">Este</span> <span class="tok-nx">curso</span> <span class="tok-nx">puede</span> <span class="tok-nx">ser</span> <span class="tok-nx">peligroso</span> <span class="tok-nx">para</span> <span class="tok-nx">tu</span> <span class="tok-nx">salud</span><span class="tok-p">{{</span><span class="tok-err">/aviso}}</span>
<span class="tok-nt">&lt;/script&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>y ahora accederíamos al nodo correspondiente del DOM, por ejemplo usando jQuery:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html">var res = Mustache.render($(&#39;#miTemplate&#39;).html(), datos);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_uso_típico_de_plantillas_en_backbone">3.3.3. Uso típico de plantillas en Backbone</h4>
<div class="paragraph">
<p>Como Backbone en sí no prevé ni aporta nada con respecto a las plantillas, en realidad no hay una "forma correcta" de usar plantillas en el código Backbone, pero hay algunos fragmentos de código típicos que se repiten más o menos literalmente en muchas aplicaciones Backbone. Vamos a ver un par de casos de uso.</p>
</div>
<div class="sect4">
<h5 id="_una_vista_que_se_corresponde_con_un_único_modelo">Una vista que se corresponde con un único modelo</h5>
<div class="paragraph">
<p>En este caso, la única diferencia con lo que veníamos haciendo hasta el momento es llamar a <code>Mustache.render</code> dentro del <code>render</code> de Backbone en lugar de generar "manualmente" el HTML</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;script </span><span class="tok-na">id=</span><span class="tok-s">&quot;template_libro&quot;</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text/x-tmpl-mustache&quot;</span><span class="tok-nt">&gt;</span>
  <span class="tok-o">&lt;</span><span class="tok-nx">b</span><span class="tok-o">&gt;</span><span class="tok-p">{{</span><span class="tok-nx">titulo</span><span class="tok-p">}}</span><span class="tok-o">&lt;</span><span class="tok-err">/b&gt;, por &lt;em&gt;{{autor}}&lt;/em&gt;</span>
<span class="tok-nt">&lt;/script&gt;</span>
<span class="tok-nt">&lt;script </span><span class="tok-na">type=</span><span class="tok-s">&quot;text/javascript&quot;</span><span class="tok-nt">&gt;</span>
  <span class="tok-kd">var</span> <span class="tok-nx">Libro</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">Model</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">();</span>
  <span class="tok-kd">var</span> <span class="tok-nx">unLibro</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Libro</span><span class="tok-p">({</span><span class="tok-nx">titulo</span><span class="tok-o">:</span><span class="tok-s2">&quot;Juego de Tronos&quot;</span><span class="tok-p">,</span>
                           <span class="tok-nx">autor</span><span class="tok-o">:</span><span class="tok-s2">&quot;George R.R. Martin&quot;</span><span class="tok-p">});</span>
  <span class="tok-kd">var</span> <span class="tok-nx">Vista</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">View</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span>
    <span class="tok-nx">template</span><span class="tok-o">:</span> <span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s1">&#39;#template_libro&#39;</span><span class="tok-p">).</span><span class="tok-nx">html</span><span class="tok-p">(),</span>
    <span class="tok-nx">render</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
      <span class="tok-kd">var</span> <span class="tok-nx">res</span> <span class="tok-o">=</span> <span class="tok-nx">Mustache</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">template</span><span class="tok-p">,</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">model</span><span class="tok-p">.</span><span class="tok-nx">toJSON</span><span class="tok-p">())</span>
      <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">$el</span><span class="tok-p">.</span><span class="tok-nx">html</span><span class="tok-p">(</span><span class="tok-nx">res</span><span class="tok-p">)</span>
      <span class="tok-k">return</span> <span class="tok-k">this</span><span class="tok-p">;</span>
    <span class="tok-p">}</span>
  <span class="tok-p">});</span>
  <span class="tok-kd">var</span> <span class="tok-nx">unaVista</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Vista</span><span class="tok-p">({</span><span class="tok-nx">model</span><span class="tok-o">:</span><span class="tok-nx">unLibro</span><span class="tok-p">})</span>
  <span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s1">&#39;body&#39;</span><span class="tok-p">).</span><span class="tok-nx">append</span><span class="tok-p">(</span><span class="tok-nx">unaVista</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">().</span><span class="tok-nx">$el</span><span class="tok-p">)</span>
<span class="tok-nt">&lt;/script&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_una_vista_que_se_corresponde_con_un_listado_de_modelos">Una vista que se corresponde con un listado de modelos</h5>
<div class="paragraph">
<p>Como veremos en la siguiente sesión, cuando tenemos listas editables es mucho mejor hacer que cada elemento del listado sea una subvista de la vista principal, pero cuando simplemente queremos listar datos que van a ser "estáticos" en la página, podemos usar una única vista para todos. Si usamos Mustache no va a haber prácticamente diferencia con lo anterior, ya que las secciones <code>{{#}}</code> y <code>{{/}}</code> nos permiten iterar implícitamente por los datos.</p>
</div>
<div class="paragraph">
<p>La plantilla sería algo como</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;script </span><span class="tok-na">id=</span><span class="tok-s">&quot;template_lista&quot;</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text/x-tmpl-mustache&quot;</span><span class="tok-nt">&gt;</span>
  <span class="tok-p">{{</span><span class="tok-err">#</span><span class="tok-p">.}}</span>
    <span class="tok-o">&lt;</span><span class="tok-nx">b</span><span class="tok-o">&gt;</span><span class="tok-p">{{</span><span class="tok-nx">titulo</span><span class="tok-p">}}</span><span class="tok-o">&lt;</span><span class="tok-err">/b&gt;, por &lt;em&gt;{{autor}}&lt;/em&gt; &lt;br&gt;</span>
  <span class="tok-p">{{</span><span class="tok-err">/.}}</span>
<span class="tok-nt">&lt;/script&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nótese que si la sección por la que vamos a iterar se corresponde con el "nivel superior" del objeto y no con una propiedad entonces podemos usar el símbolo "." Eso nos permite iterar por un array JSON: <code>[{'titulo':'Tormenta de espadas', 'autor':'George R.R. Martin'}, {'titulo':'Beginning Backbone', 'autor', 'James Sugrue'}]</code>.</p>
</div>
<div class="paragraph">
<p>Además de esto la diferencia en el Javascript es que en lugar de serializar en JSON un único modelo serializamos una colección.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">Libro</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">Model</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">();</span>
<span class="tok-kd">var</span> <span class="tok-nx">unLibro</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Libro</span><span class="tok-p">({</span><span class="tok-s1">&#39;titulo&#39;</span><span class="tok-o">:</span><span class="tok-s1">&#39;Juego de tronos&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;autor&#39;</span><span class="tok-o">:</span><span class="tok-s1">&#39;George R.R. Martin&#39;</span><span class="tok-p">});</span>
<span class="tok-kd">var</span> <span class="tok-nx">otroLibro</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Libro</span><span class="tok-p">({</span><span class="tok-s1">&#39;titulo&#39;</span><span class="tok-o">:</span><span class="tok-s1">&#39;Tormenta de espadas&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;autor&#39;</span><span class="tok-o">:</span> <span class="tok-s1">&#39;George R.R. Martin&#39;</span><span class="tok-p">});</span>
<span class="tok-kd">var</span> <span class="tok-nx">Biblioteca</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">Collection</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span>
  <span class="tok-nx">model</span><span class="tok-o">:</span><span class="tok-nx">Libro</span>
<span class="tok-p">});</span>
<span class="tok-kd">var</span> <span class="tok-nx">miBib</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Biblioteca</span><span class="tok-p">([</span><span class="tok-nx">unLibro</span><span class="tok-p">,</span> <span class="tok-nx">otroLibro</span><span class="tok-p">]);</span>

<span class="tok-kd">var</span> <span class="tok-nx">VistaBiblioteca</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">View</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span>
    <span class="tok-nx">template</span><span class="tok-o">:</span> <span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s1">&#39;#template_lista&#39;</span><span class="tok-p">).</span><span class="tok-nx">html</span><span class="tok-p">(),</span>
    <span class="tok-nx">render</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
      <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">$el</span><span class="tok-p">.</span><span class="tok-nx">html</span><span class="tok-p">(</span><span class="tok-nx">Mustache</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">template</span><span class="tok-p">,</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">collection</span><span class="tok-p">.</span><span class="tok-nx">toJSON</span><span class="tok-p">()));</span>
    <span class="tok-p">}</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_routers">3.4. Routers</h3>
<div class="paragraph">
<p>Todos los <em>frameworks</em> web en el lado del servidor implementan de un modo u otro la idea de mapeado de <strong>rutas</strong>: especificamos qué se va a ejecutar cuando se reciba una petición a determinada URL. Habitualmente la URL no tiene por qué ser literal sino que se pueden usar variables, expresiones regulares, etc. Como ya sabemos, en JavaEE las rutas se pueden configurar en el <code>web.xml</code> o bien especificar directamente en el código con la anotación <code>@Path</code>.</p>
</div>
<div class="paragraph">
<p>En las SPAs por su propia naturaleza no hay cambio de URL cuando el usuario va realizando operaciones en la aplicación. Hasta el momento nosotros no hemos tenido que asociar rutas con ningún caso de uso. Pero esto representa un problema desde el punto de vista de la <em>usabilidad</em>. En la web el usuario depende de la URL para poder volver en otro momento a acceder a la información, pero ahora mismo tal y como funcionan nuestras aplicaciones, los <em>bookmarks</em> son inútiles: todos apuntarían al HTML que se cargó originalmente con la aplicación, pero no al estado actual de la misma.</p>
</div>
<div class="paragraph">
<p>Los <strong>routers</strong> intentan resolver este problema. Permiten asociar a una URL un código a ejecutar.</p>
</div>
<div class="sect3">
<h4 id="_routers_básicos">3.4.1. Routers básicos</h4>
<div class="paragraph">
<p>Para crear un <em>router</em> debemos extender la clase <code>Backbone.Router</code>. Dicha clase tiene una propiedad básica, <code>routes</code>, que es un conjunto de pares clave/valor, al estilo del <code>events</code> de las vistas. La clave es la ruta, y el valor el nombre de la función a ejecutar. Por ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">MiRouter</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">Router</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-nx">routes</span><span class="tok-o">:</span> <span class="tok-p">{</span>
        <span class="tok-s1">&#39;hola&#39;</span> <span class="tok-o">:</span> <span class="tok-s1">&#39;holaRouter&#39;</span>
    <span class="tok-p">},</span>
    <span class="tok-nx">holaRouter</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
        <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;Hola Router&quot;</span><span class="tok-p">);</span>
    <span class="tok-p">}</span>
 <span class="tok-p">});</span>
 <span class="tok-kd">var</span> <span class="tok-nx">unRouter</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">MiRouter</span><span class="tok-p">();</span>   <i class="conum" data-value="2"></i><b>(2)</b>
 <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">history</span><span class="tok-p">.</span><span class="tok-nx">start</span><span class="tok-p">();</span> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Extendemos la clase <code>Backbone.Router</code> y definimos la propiedad <code>routes</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Creamos una instancia de router</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Esta instrucción es necesaria para que Backbone "escuche" los cambios en la URL.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Suponiendo que la página que contiene el código anterior fuera <code>index.html</code> si en la barra de direcciones del navegador cambiamos la URL por <code>index.html#hola</code>, veremos aparecer el mensaje en la consola Javascript.</p>
</div>
<div class="paragraph">
<p>Nótese que en las rutas tal y como las ve el usuario, <strong>lo que cambia entre una ruta y otra es el <em>hash fragment</em></strong>, es decir, la parte que va detrás del símbolo <code>#</code>. Para usar URLs convencionales habría que configurar la parte del servidor, como veremos luego.</p>
</div>
</div>
<div class="sect3">
<h4 id="_rutas_con_partes_variables">3.4.2. Rutas con partes variables</h4>
<div class="paragraph">
<p>Podemos definir partes variables en una ruta poniéndoles un nombre precedido del símbolo ':'. La función Javascript asociada a la ruta recibirá tantos parámetros JS como partes variables tenga la ruta.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">MiRouter</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">Router</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span>
    <span class="tok-nx">routes</span><span class="tok-o">:</span> <span class="tok-p">{</span>
        <span class="tok-s1">&#39;hola/:nombre&#39;</span> <span class="tok-o">:</span> <span class="tok-s1">&#39;holaRouter&#39;</span>
    <span class="tok-p">},</span>
    <span class="tok-nx">holaRouter</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">nom</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;Hola &quot;</span> <span class="tok-o">+</span> <span class="tok-nx">nom</span><span class="tok-p">);</span>
    <span class="tok-p">}</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos poner varias partes variables en una ruta. La siguiente ruta encajaría con <code>#hola/Pepe/Pérez</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">routes</span><span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-s1">&#39;hola/:nombre/:apellidos&#39;</span> <span class="tok-o">:</span> <span class="tok-s1">&#39;holaRouter&#39;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para especificar alguna parte como opcional la pondríamos entre paréntesis:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">routes</span><span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-s1">&#39;hola/:nombre(/:apellidos)&#39;</span> <span class="tok-o">:</span> <span class="tok-s1">&#39;holaRouter&#39;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En el ejemplo anterior, la ruta encajaría tanto con <code>#hola/Pepe/Pérez</code>, como simplemente con <code>#hola/Pepe</code>. En este último caso, el parámetro Javascript asociado a los apellidos sería <code>null</code>.</p>
</div>
<div class="paragraph">
<p>Las partes variables de las rutas se tratan al estilo de las expresiones regulares. Por ejemplo podemos poner una parte fija mezclada con la variable, o usar el símbolo <code>*</code> para indicar cualquier secuencia de caracteres. Esto último es útil si queremos recoger un <em>path</em> completo, o sea una cadena que contenga también el carácter <code>/</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">routes</span><span class="tok-o">:</span> <span class="tok-p">{</span>
   <span class="tok-s1">&#39;hola/Pep:sufijo&#39;</span> <span class="tok-o">:</span> <span class="tok-s1">&#39;holaRouter&#39;</span>
   <span class="tok-s1">&#39;adios/*var&#39;</span> <span class="tok-o">:</span> <span class="tok-s1">&#39;adiosRouter&#39;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La ruta <code>#hola/Pepito</code> encajaría con la primera expresión, por lo que la variable adquiriría el valor <code>ito</code>. Si fuéramos por ejemplo a <code>#adios/mas/cosas/por/aqui</code>, el parámetro JS asociado a la variable <code>var</code> tomaría el valor <code>mas/cosas/por/aqui</code></p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
si la URL encaja con más de una ruta se usará la primera ruta que encaje.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_rutas_por_defecto">3.4.3. Rutas por defecto</h4>
<div class="paragraph">
<p>Es conveniente definir un par de rutas por defecto en cualquier aplicación: la ruta vacía <code>''</code>, que se usa cuando el <em>hash fragment</em> está vacío, y <code>*default</code>, que se usará con la URL actual si esta no encaja con ninguna de las definidas en el <em>router</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">MiRouter</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">Router</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span>
   <span class="tok-nx">routes</span><span class="tok-o">:</span> <span class="tok-p">{</span>
       <span class="tok-s1">&#39;&#39;</span> <span class="tok-o">:</span> <span class="tok-s1">&#39;vacia&#39;</span><span class="tok-p">,</span>
       <span class="tok-s1">&#39;*default&#39;</span><span class="tok-o">:</span> <span class="tok-s1">&#39;defecto&#39;</span>
   <span class="tok-p">},</span>
   <span class="tok-nx">defecto</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">path</span><span class="tok-p">)</span> <span class="tok-p">{</span>   <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;Ruta por defecto: &#39;</span> <span class="tok-o">+</span> <span class="tok-nx">path</span><span class="tok-p">);</span>
   <span class="tok-p">},</span>
   <span class="tok-nx">vacia</span><span class="tok-o">:</span> <span class="tok-kd">function</span> <span class="tok-p">()</span> <span class="tok-p">{</span>
        <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;Ruta vacía&#39;</span><span class="tok-p">);</span>
   <span class="tok-p">}</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>En el caso de la ruta por defecto, el parámetro JS asociado contendrá el <em>path</em> completo.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_navegación_en_el_código">3.4.4. Navegación en el código</h4>
<div class="paragraph">
<p>En cualquier momento <strong>podemos navegar a una URL determinada</strong> con el método <code>navigate</code> de la clase <code>Router</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">miRouter</span><span class="tok-p">.</span><span class="tok-nx">navigate</span><span class="tok-p">(</span><span class="tok-s1">&#39;hola/Pepe&#39;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Esta operación añadirá la nueva URL al historial del navegador. No obstante, navegar a una URL <strong>por defecto no disparará la función asociada a la ruta</strong> correspondiente, salvo que lo especifiquemos con <code>{trigger:true}</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">miRouter</span><span class="tok-p">.</span><span class="tok-nx">navigate</span><span class="tok-p">(</span><span class="tok-s1">&#39;hola/Pepe&#39;</span><span class="tok-p">,</span> <span class="tok-p">{</span><span class="tok-nx">trigger</span><span class="tok-o">:</span> <span class="tok-kc">true</span><span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Al contrario, podemos <strong>detectar en nuestro código que se ha disparado una ruta determinada</strong> respondiendo a los eventos con prefijo <code>route:</code>. El nombre completo del evento se obtiene añadiendo a este prefijo el nombre de la función asociada. Por ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">MiRouter</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">Router</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span>
   <span class="tok-nx">routes</span><span class="tok-o">:</span> <span class="tok-p">{</span>
       <span class="tok-s1">&#39;hola&#39;</span><span class="tok-o">:</span><span class="tok-s1">&#39;holaRouter&#39;</span>
   <span class="tok-p">},</span>
   <span class="tok-nx">holaRouter</span> <span class="tok-o">:</span> <span class="tok-kd">function</span> <span class="tok-p">()</span> <span class="tok-p">{</span>
       <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;Hola Router&quot;</span><span class="tok-p">)</span>
   <span class="tok-p">}</span>
<span class="tok-p">});</span>
<span class="tok-kd">var</span> <span class="tok-nx">unRouter</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">MiRouter</span><span class="tok-p">();</span>
<span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">history</span><span class="tok-p">.</span><span class="tok-nx">start</span><span class="tok-p">();</span>
<span class="tok-nx">unRouter</span><span class="tok-p">.</span><span class="tok-nx">on</span><span class="tok-p">(</span><span class="tok-s1">&#39;route:holaRouter&#39;</span><span class="tok-p">,</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;Se ha disparado la función holaRouter&quot;</span><span class="tok-p">);</span>
<span class="tok-p">})</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_urls_completas">3.4.5. URLs completas</h4>
<div class="paragraph">
<p>Usar una URL con <em>hash fragments</em> simplifica la gestión para Backbone, ya que en realidad no estamos cambiando de página. Pero puede parecer "algo rara" para el usuario. Podemos configurar Backbone para usar URLs convencionales, pero hay que solucionar dos pequeños problemas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>El navegador debe ser compatible con el <em>history API</em> de HTML5. Este API  permite manipular el historial de navegación y Backbone lo usa para cambiar la URL sin tener que hacer nuevas peticiones HTTP.</p>
</li>
<li>
<p>Debemos configurar el servidor para que todas las peticiones se redirijan a la misma página, la de nuestra SPA. La configuración del servidor queda fuera del ámbito de estos apuntes.</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="sesion03ejer">3.5. Ejercicios de vistas</h3>
<div class="paragraph">
<p>En los ejercicios de esta sesión vamos a implementar un interfaz rudimentario para la aplicación de alquiler de coches. Por tanto seguirás trabajando sobre la misma carpeta <code>alquiler_coches</code>.</p>
</div>
<div class="sect3">
<h4 id="_formulario_para_dar_coches_de_alta_0_5_puntos">3.5.1. Formulario para dar coches de alta (0,5 puntos)</h4>
<div class="paragraph">
<p>Implementa un formulario que sea una vista de Backbone y que permita dar de alta un nuevo vehículo.
- El modelo asociado a la vista será una instancia de <code>Coche</code>
- Puedes crear una plantilla Mustache para la vista, pero ten en cuenta que será totalmente estática (solo HTML), ya que no sirve para mostrar datos, sino para introducirlos.
- La vista debería escuchar el evento <code>sync</code> sobre el modelo, que indicará que el alta en el servidor se ha producido correctamente. En ese caso se debería mostrar un mensaje indicándolo (muéstralo en algún lugar del HTML, y pon algún botón o enlace para eliminar luego el mensaje. Recuerda que es más sencillo con jQuery). Escucha también el evento <code>error</code> que indica un error, y muestra también un mensaje adecuado en el HTML.</p>
</div>
</div>
<div class="sect3">
<h4 id="_listado_de_coches_0_5_puntos">3.5.2. Listado de coches (0,5 puntos)</h4>
<div class="paragraph">
<p>Implementa una vista de Backbone que muestre un listado con todos los coches. El listado será totalmente estático salvo por el hecho de que cuando se inserte un nuevo coche en el formulario de alta debe aparecer también aquí. Para ello:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Cuando se dé de alta el modelo, debes añadirlo también a la colección.</p>
</li>
<li>
<p>La vista de listado debe escuchar el evento <code>add</code> sobre la colección y si se produce, añadir al HTML ya existente el del nuevo coche.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
también se podría redibujar la lista entera, pero eso no sería demasiado eficiente, así que no lo hagas de ese modo.
</td>
</tr>
</table>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion04">4. Jerarquías de vistas</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hasta ahora todas los ejemplos de Backbone que hemos tratado contenían una única vista. Es fácil ver que en aplicaciones reales esto no va a ser así: la interfaz de una SPA está compuesta de una serie de secciones diferenciadas, y es lógico pensar que cada una de ellas podemos modelarla como una vista de Backbone. De hecho, probablemente haya vistas compuestas a su vez de otras vistas más pequeñas, o vistas "hijas". Vamos a tratar aquí diferentes patrones de organización de vistas en web, y cómo podemos tratarlas de modo eficiente en Backbone. Veremos que como Backbone "se queda corto" cuando las vistas alcanzan una cierta complejidad los desarrolladores suelen usar extensiones de Backbone como <a href="http://marionettejs.com/">MarionetteJS</a>.</p>
</div>
<div class="sect2">
<h3 id="_listados_dinámicos">4.1. Listados dinámicos</h3>
<div class="paragraph">
<p>Este patrón se da cuando tenemos que mostrar un listado de elementos dinámicos,  sobre los que se puede realizar una serie de operaciones (ver detalles, editar, borrar&#8230;&#8203;). Es una situación muy común en multitud de aplicaciones web.</p>
</div>
<div class="paragraph">
<p>La organización más habitual de un listado de este tipo en Backbone es como una vista que engloba un conjunto de <em>subvistas</em>, una por cada elemento del listado:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/04/subvistas.png" alt="Vista y subvistas" width="66%">
</div>
<div class="title">Figure 4. Vista Backbone compuesta a su vez de subvistas</div>
</div>
<div class="paragraph">
<p>La vista global, además de servir como "contenedor", se encarga de algunas operaciones que no son propias de ningún elemento en concreto. En el ejemplo anterior se podría encargar de crear un nuevo contacto si le añadiéramos el correspondiente formulario.</p>
</div>
<div class="paragraph">
<p>Hay algunas razones por la que esta organización es adecuada:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Representar cada elemento del listado como una subvista nos ayuda a "componentizar" y organizar mejor el código.</p>
</li>
<li>
<p>Podremos gestionar de modo más sencillo los eventos para editar, borrar,&#8230;&#8203; Al estar cada elemento de la lista en una subvista diferente, cada vista se tiene que responsabilizar únicamente de procesar sus propios eventos. Esto simplifica el código.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Vamos a ver cómo implementaríamos la lista de contactos que veíamos en la figura anterior. Para simplificar, las únicas operaciones que podemos realizar son crear un nuevo contacto y borrar un contacto. La primera de ellas es de tipo global y corresponde a la vista principal. La segunda corresponde a cada subvista por separado.</p>
</div>
<div class="sect3">
<h4 id="_subvistas_en_backbone">4.1.1. Subvistas en Backbone</h4>
<div class="paragraph">
<p>Cada subvista será una instancia de la clase <code>VistaContacto</code>, y será responsable de <em>renderizarse</em> "ella misma" y procesar sus eventos. El código Javascript sería algo como lo que sigue:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">VistaContacto</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">View</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span>

  <span class="tok-c1">//queremos que la etiqueta de la que &quot;cuelga&quot; la vista tenga la class=&quot;contacto&quot;</span>
  <span class="tok-c1">//Así podremos darle un estilo apropiado con CSS</span>
  <span class="tok-nx">className</span><span class="tok-o">:</span> <span class="tok-s1">&#39;contacto&#39;</span><span class="tok-p">,</span>

  <span class="tok-c1">//plantilla Mustache</span>
  <span class="tok-nx">template</span><span class="tok-o">:</span> <span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s1">&#39;#contacto_tmpl&#39;</span><span class="tok-p">).</span><span class="tok-nx">html</span><span class="tok-p">(),</span>

  <span class="tok-nx">render</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-c1">//Usamos el toJSON() de Backbone en vez del stringify estándar</span>
    <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">el</span><span class="tok-p">.</span><span class="tok-nx">innerHTML</span> <span class="tok-o">=</span> <span class="tok-nx">Mustache</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">template</span><span class="tok-p">,</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">model</span><span class="tok-p">.</span><span class="tok-nx">toJSON</span><span class="tok-p">())</span>
    <span class="tok-k">return</span> <span class="tok-k">this</span>
  <span class="tok-p">},</span>


  <span class="tok-nx">borrar</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
      <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">model</span><span class="tok-p">.</span><span class="tok-nx">destroy</span><span class="tok-p">()</span>
      <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">remove</span><span class="tok-p">()</span>
  <span class="tok-p">},</span>

  <span class="tok-c1">//Cada contacto tiene su propio botón de borrar</span>
  <span class="tok-nx">events</span><span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-s1">&#39;click .boton_borrar&#39;</span> <span class="tok-o">:</span> <span class="tok-s1">&#39;borrar&#39;</span>
  <span class="tok-p">}</span>
<span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La plantilla Mustache asociada sería la siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;script </span><span class="tok-na">id=</span><span class="tok-s">&quot;contacto_tmpl&quot;</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text/x-mustache-template&quot;</span><span class="tok-nt">&gt;</span>
  <span class="tok-o">&lt;</span><span class="tok-nx">b</span><span class="tok-o">&gt;</span><span class="tok-p">{{</span><span class="tok-nx">nombre</span><span class="tok-p">}}</span> <span class="tok-p">{{</span><span class="tok-nx">apellidos</span><span class="tok-p">}}</span><span class="tok-o">&lt;</span><span class="tok-err">/b&gt; &lt;br&gt;</span>
  <span class="tok-o">&lt;</span><span class="tok-nx">em</span><span class="tok-o">&gt;</span><span class="tok-p">{{</span><span class="tok-nx">telefono</span><span class="tok-p">}}</span><span class="tok-o">&lt;</span><span class="tok-err">/em&gt; &lt;br&gt;</span>
  <span class="tok-o">&lt;</span><span class="tok-nx">input</span> <span class="tok-nx">type</span><span class="tok-o">=</span><span class="tok-s2">&quot;button&quot;</span> <span class="tok-kr">class</span><span class="tok-o">=</span><span class="tok-s2">&quot;boton_borrar&quot;</span> <span class="tok-nx">value</span><span class="tok-o">=</span><span class="tok-s2">&quot;Borrar&quot;</span><span class="tok-o">&gt;</span>
<span class="tok-nt">&lt;/script&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Esta vista no tiene nada sustancialmente diferente de las que hemos usado hasta el momento. La clave, pues, está en la vista global.</p>
</div>
</div>
<div class="sect3">
<h4 id="_la_vista_global">4.1.2. La vista global</h4>
<div class="paragraph">
<p>La plantilla Mustache asociada a la vista no es excesivamente interesante, únicamente contiene la parte "externa" a la lista de contactos en sí: un título y un formulario para dar de alta un nuevo contacto:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;script </span><span class="tok-na">id=</span><span class="tok-s">&quot;listado_tmpl&quot;</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text/x-handlebars-template&quot;</span><span class="tok-nt">&gt;</span>
  <span class="tok-o">&lt;</span><span class="tok-nx">h1</span><span class="tok-o">&gt;</span><span class="tok-nx">Lista</span> <span class="tok-nx">de</span> <span class="tok-nx">contactos</span><span class="tok-o">&lt;</span><span class="tok-err">/h1&gt;</span>
  <span class="tok-o">&lt;</span><span class="tok-nx">label</span> <span class="tok-k">for</span><span class="tok-o">=</span><span class="tok-s2">&quot;nombre_edit&quot;</span><span class="tok-o">&gt;</span><span class="tok-nx">Nombre</span><span class="tok-o">:&lt;</span><span class="tok-err">/label&gt;</span>
  <span class="tok-o">&lt;</span><span class="tok-nx">input</span> <span class="tok-nx">type</span><span class="tok-o">=</span><span class="tok-s2">&quot;text&quot;</span> <span class="tok-nx">id</span><span class="tok-o">=</span><span class="tok-s2">&quot;nombre&quot;</span><span class="tok-o">&gt;</span> <span class="tok-o">&lt;</span><span class="tok-nx">br</span><span class="tok-o">&gt;</span>
  <span class="tok-o">&lt;</span><span class="tok-nx">label</span> <span class="tok-k">for</span><span class="tok-o">=</span><span class="tok-s2">&quot;apellidos_edit&quot;</span><span class="tok-o">&gt;</span><span class="tok-nx">Apellidos</span><span class="tok-o">:&lt;</span><span class="tok-err">/label&gt;</span>
  <span class="tok-o">&lt;</span><span class="tok-nx">input</span> <span class="tok-nx">type</span><span class="tok-o">=</span><span class="tok-s2">&quot;text&quot;</span> <span class="tok-nx">id</span><span class="tok-o">=</span><span class="tok-s2">&quot;apellidos&quot;</span><span class="tok-o">&gt;</span> <span class="tok-o">&lt;</span><span class="tok-nx">br</span><span class="tok-o">&gt;</span>
  <span class="tok-o">&lt;</span><span class="tok-nx">label</span> <span class="tok-k">for</span><span class="tok-o">=</span><span class="tok-s2">&quot;telefono_edit&quot;</span><span class="tok-o">&gt;</span><span class="tok-nx">Tel</span><span class="tok-err">é</span><span class="tok-nx">fono</span><span class="tok-o">:&lt;</span><span class="tok-err">/label&gt;</span>
  <span class="tok-o">&lt;</span><span class="tok-nx">input</span> <span class="tok-nx">type</span><span class="tok-o">=</span><span class="tok-s2">&quot;text&quot;</span> <span class="tok-nx">id</span><span class="tok-o">=</span><span class="tok-s2">&quot;telefono&quot;</span><span class="tok-o">&gt;</span> <span class="tok-o">&lt;</span><span class="tok-nx">br</span><span class="tok-o">&gt;</span>
  <span class="tok-o">&lt;</span><span class="tok-nx">input</span> <span class="tok-nx">type</span><span class="tok-o">=</span><span class="tok-s2">&quot;button&quot;</span> <span class="tok-nx">id</span><span class="tok-o">=</span><span class="tok-s2">&quot;boton_nuevo&quot;</span> <span class="tok-nx">value</span><span class="tok-o">=</span><span class="tok-s2">&quot;Nuevo&quot;</span><span class="tok-o">&gt;</span>
<span class="tok-nt">&lt;/script&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La parte realmente interesante es el código del método <code>render()</code>. Además de renderizar la plantilla asociada, debe ir creando una subvista por cada elemento del listado, haciendo el <code>render()</code> de dicha subvista y añadiendo el resultado al HTML propio.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">render</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">$el</span><span class="tok-p">.</span><span class="tok-nx">html</span><span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">template</span><span class="tok-p">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">collection</span><span class="tok-p">.</span><span class="tok-nx">each</span><span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">renderContacto</span><span class="tok-p">)</span>  <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="tok-k">return</span> <span class="tok-k">this</span>
<span class="tok-p">},</span>

<span class="tok-nx">renderContacto</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">contacto</span><span class="tok-p">)</span> <span class="tok-p">{</span>  <i class="conum" data-value="3"></i><b>(3)</b>
  <span class="tok-kd">var</span> <span class="tok-nx">vc</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">VistaContacto</span><span class="tok-p">({</span><span class="tok-nx">model</span><span class="tok-o">:</span> <span class="tok-nx">contacto</span><span class="tok-p">})</span> <i class="conum" data-value="4"></i><b>(4)</b>
  <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">$el</span><span class="tok-p">.</span><span class="tok-nx">append</span><span class="tok-p">(</span><span class="tok-nx">vc</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">().</span><span class="tok-nx">$el</span><span class="tok-p">)</span>  <i class="conum" data-value="5"></i><b>(5)</b>
<span class="tok-p">},</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Lo primero que hacemos es <em>renderizar</em> la plantilla global propiamente dicha</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Usando el iterador <code>each</code> de Underscore, iteramos por la colección de contactos, y para cada uno de ellos llamamos a la función <code>renderContacto</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Esta función se encarga de <em>renderizar</em> el contacto. El <code>each</code> hace que automáticamente reciba como parámetro el objeto correspondiente a la iteración actual.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Creamos la subvista asociada al contacto</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Renderizamos la subvista y la añadimos al HTML de la vista global</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Este código es lo que los anglosajones llaman <em>boilerplate</em>, lo vamos a encontrar de manera casi literal en muchos proyectos de Backbone. Hasta tal punto es típico, que como veremos a continuación algunos <em>frameworks</em> basados en Backbone (como Marionette) lo incorporan automáticamente, para que no haya que escribirlo "a mano".
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El código anterior tiene un pequeño problema. Ya hemos visto alguna vez que <strong>cuando desde una función de una clase de Backbone llamamos a otra, <code>this</code> no tiene como valor el objeto actual, sino el objeto global (<code>window</code>)</strong>. Para resolverlo, en la inicialización de la vista enlazamos (<em>bind</em>) la función <code>renderContacto</code> con la vista:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">initialize</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-nx">_</span><span class="tok-p">.</span><span class="tok-nx">bindAll</span><span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">,</span> <span class="tok-s2">&quot;renderContacto&quot;</span><span class="tok-p">)</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En el código Backbone típico se suele usar el <code>_.bindAll</code> de Underscore para vincular una función con un objeto, más que nada porque es cómodo y nos asegura el soporte en navegadores antiguos. También podríamos haber usado el <code>bind</code> de Javascript estándar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">initialize</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">renderContacto</span> <span class="tok-o">=</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">renderContacto</span><span class="tok-p">.</span><span class="tok-nx">bind</span><span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">)</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_subvistas_con_marionette">4.1.3. Subvistas con Marionette</h4>
<div class="paragraph">
<p>Marionette es una extensión de Backbone. Le añade una serie de funcionalidades interesantes para el trabajo cotidiano con el <em>framework</em>. Por ejemplo ya hemos visto que Backbone "aporta poco" en cuanto a la gestión de las vistas, prácticamente lo tenemos que hacer todo nosotros. Marionette automatiza mucho más el trabajo con las vistas, implementando un <code>render</code> que a diferencia del de Backbone sí hace algo por defecto: serializa el modelo en JSON, aplica la plantilla, &#8230;&#8203;. Además incluye clases pensadas para representar explícitamente jerarquías de vistas. Enseguida veremos una pequeña introducción a  estas funcionalidades. Por otro lado Marionette también incluye funcionalidades no relativas a vistas como por ejemplo la definición de módulos, que nos permiten organizar mejor nuestro código, o la ampliación del sistema de eventos de Backbone.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
En lugar de dedicar una sesión entera a Marionette vamos a ir viendo sus características poco a poco. Conforme vayamos explicando funcionalidades de Backbone iremos viendo en qué se "quedan cortas" y cómo nos puede facilitar Marionette el trabajo. Podéis consultar la documentación de Marionette y ver algunos tutoriales y <em>screencasts</em> interesantes en su <a href="http://marionettejs.com">sitio web</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Marionette tiene dos tipos de vista pensados para resolver nuestro problema. La clase <code>ItemView</code> nos sirve para representar un único modelo, mientras que <code>CollectionView</code> representa una colección. Un <code>CollectionView</code> tendrá un conjunto de <code>ItemView</code> como vistas "hijas".</p>
</div>
<div class="paragraph">
<p>Continuando con el ejemplo del apartado anterior, para representar cada contacto usaríamos un <code>ItemView</code>. Marionette implementa un <code>render</code> por defecto que:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Serializa automáticamente el modelo asociado a la vista.</p>
</li>
<li>
<p>Aplica la plantilla, que debe estar asociada a una propiedad <code>template</code> de la vista.</p>
</li>
<li>
<p>Actualiza el <code>el</code> de la vista con el resultado.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">Marionette</span><span class="tok-p">.</span><span class="tok-nx">Renderer</span><span class="tok-p">.</span><span class="tok-nx">render</span> <span class="tok-o">=</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">template</span><span class="tok-p">,</span><span class="tok-nx">data</span><span class="tok-p">)</span> <span class="tok-p">{</span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="tok-k">return</span> <span class="tok-nx">Mustache</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">(</span><span class="tok-nx">template</span><span class="tok-p">,</span><span class="tok-nx">data</span><span class="tok-p">);</span>
<span class="tok-p">}</span>

<span class="tok-kd">var</span> <span class="tok-nx">contacto_tmpl</span> <span class="tok-o">=</span>  <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="tok-s1">&#39;&lt;b&gt; {{apellidos}}, {{nombre}} &lt;/b&gt; &lt;br&gt;&#39;</span> <span class="tok-o">+</span>
  <span class="tok-s1">&#39;&lt;em&gt;{{telefono}}&lt;/em&gt;&#39;</span>


<span class="tok-kd">var</span> <span class="tok-nx">VistaContacto</span> <span class="tok-o">=</span> <span class="tok-nx">Marionette</span><span class="tok-p">.</span><span class="tok-nx">ItemView</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span>  <i class="conum" data-value="3"></i><b>(3)</b>
  <span class="tok-nx">template</span><span class="tok-o">:</span> <span class="tok-nx">contacto_tmpl</span>
<span class="tok-p">})</span>

<span class="tok-c1">//Vamos a probar cómo funciona</span>
<span class="tok-kd">var</span> <span class="tok-nx">c1</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Contacto</span><span class="tok-p">({</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s2">&quot;Pepe&quot;</span><span class="tok-p">,</span> <span class="tok-nx">apellidos</span><span class="tok-o">:</span><span class="tok-s2">&quot;Pérez Martínez&quot;</span><span class="tok-p">,</span> <span class="tok-nx">telefono</span><span class="tok-o">:</span><span class="tok-s2">&quot;966123456&quot;</span><span class="tok-p">});</span> <i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-kd">var</span> <span class="tok-nx">vc</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">VistaContacto</span><span class="tok-p">({</span><span class="tok-nx">model</span><span class="tok-o">:</span><span class="tok-nx">c1</span><span class="tok-p">});</span>
<span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s1">&#39;body&#39;</span><span class="tok-p">).</span><span class="tok-nx">append</span><span class="tok-p">(</span><span class="tok-nx">vc</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">().</span><span class="tok-nx">$el</span><span class="tok-p">);</span> <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Por defecto Marionette está configurado para usar <em>templates</em> de Underscore. Podemos configurarlo para usar otro motor de plantillas sobreescribiendo el método <code>Marionette.Renderer.render</code>. Este método acepta como parámetros una plantilla y unos datos y debe devolver el resultado de combinar ambos. En el ejemplo, lo configuramos para usar Mustache.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Definimos la plantilla de Mustache para mostrar un contacto, no hay diferencia con Backbone.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Definimos la clase de la vista, que hereda de la clase <code>ItemView</code>. Le asignamos a la propiedad <code>template</code>, propia de Marionette, la plantilla asociada. Nótese que no tenemos que implementar el <code>render</code> ya que Marionette lo hace por nosotros.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Definimos una instancia de un modelo y de una vista, asociada al modelo.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Añadimos el HTML de la vista al cuerpo de la página, como vemos es idéntico a como se hace en Backbone.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Una vez hemos definido la vista para un item de la lista, ya podemos definir la vista "global" para la lista de elementos. En Marionette para esto se usa un <code>CollectionView</code>, que incluirá como vistas "hijas" varias <code>ItemView</code>. Siguiendo con nuestro ejemplo, para presentar la lista de contactos: (mostramos solo lo que hay que añadir al código anterior)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">VistaAgenda</span> <span class="tok-o">=</span> <span class="tok-nx">Marionette</span><span class="tok-p">.</span><span class="tok-nx">CollectionView</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span>
  <span class="tok-nx">childView</span><span class="tok-o">:</span> <span class="tok-nx">VistaContacto</span><span class="tok-p">,</span>
<span class="tok-p">});</span>

<span class="tok-c1">//Vamos a probar cómo funciona</span>
<span class="tok-kd">var</span> <span class="tok-nx">c1</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Contacto</span><span class="tok-p">({</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s2">&quot;Pepe&quot;</span><span class="tok-p">,...</span>
<span class="tok-kd">var</span> <span class="tok-nx">c2</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Contacto</span><span class="tok-p">(...</span>
<span class="tok-kd">var</span> <span class="tok-nx">miAgenda</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Agenda</span><span class="tok-p">([</span><span class="tok-nx">c1</span><span class="tok-p">,</span><span class="tok-nx">c2</span><span class="tok-p">]);</span>
<span class="tok-kd">var</span> <span class="tok-nx">va</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">VistaAgenda</span><span class="tok-p">({</span><span class="tok-nx">collection</span><span class="tok-o">:</span> <span class="tok-nx">miAgenda</span><span class="tok-p">})</span>
<span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s1">&#39;body&#39;</span><span class="tok-p">).</span><span class="tok-nx">append</span><span class="tok-p">(</span><span class="tok-nx">va</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">().</span><span class="tok-nx">$el</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Como vemos, lo único que necesitamos para definir la vista asociada a la colección es especificar qué clase va a actuar como vista para cada elemento. En nuestro caso es la clase <code>VistaContacto</code>. El <code>render</code> de la <code>CollectionView</code> creará automáticamente una <code>VistaContacto</code> por cada elemento de la colección si es necesario, llamará a su <code>render</code> y concatenará todos los HTML resultantes, es decir, lo mismo que antes teníamos que hacer de modo manual.</p>
</div>
<div class="paragraph">
<p>Nótese que una CollectionView no tiene HTML "propio", su HTML es el formado por la concatenación del de sus vistas hijas. Si queremos que la vista "madre" contenga información propia deberíamos usar una <code>CompositeView</code>, que es como una <code>CollectionView</code> pero se le puede asociar también un <code>model</code> y una <code>template</code>.</p>
</div>
<div class="paragraph">
<p>Marionette hace un <em>re-render</em> automático cada vez que se modifica la colección asociada a una <code>CollectionView</code>. Si nos vamos a la consola Javascript y tecleamos</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">va</span><span class="tok-p">.</span><span class="tok-nx">collection</span><span class="tok-p">.</span><span class="tok-nx">add</span><span class="tok-p">(</span><span class="tok-k">new</span> <span class="tok-nx">Contacto</span><span class="tok-p">({</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s2">&quot;Luis Ricardo&quot;</span><span class="tok-p">,</span> <span class="tok-nx">apellidos</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Borriquero&quot;</span><span class="tok-p">,</span> <span class="tok-nx">telefono</span><span class="tok-o">:</span><span class="tok-s2">&quot;965656565&quot;</span><span class="tok-p">}))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>veremos cómo se redibuja automáticamente la vista y aparece el nuevo contacto. Es decir, el <code>CollectionView</code> implementa un <em>data binding</em> unidireccional, del modelo hacia la vista.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_composición_genérica_de_vistas">4.2. Composición genérica de vistas</h3>
<div class="paragraph">
<p>En una aplicación web es muy común dividir la página en diferentes secciones. Estas secciones se suelen representar en el HTML con etiquetas <code>&lt;div&gt;</code> (o <code>&lt;section&gt;</code>, <code>&lt;nav&gt;</code>, <code>&lt;article&gt;</code>,&#8230;&#8203; si usamos HTML5) y se marcan con distintas clases o identificadores. Así se les puede dar estilo con CSS y pueden ser manipuladas dinámicamente con Javascript. Por ejemplo aquí tenemos la típica página con contenido, pie y barra lateral:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-c">&lt;!-- Falta el CSS que haga aparecer las cosas &quot;en su sitio&quot; --&gt;</span>
<span class="tok-nt">&lt;div</span> <span class="tok-na">id=</span><span class="tok-s">&quot;sidebar&quot;</span><span class="tok-nt">&gt;</span>
<span class="tok-nt">&lt;div&gt;</span>Esto es la barra lateral<span class="tok-nt">&lt;/div&gt;</span>
<span class="tok-nt">&lt;/div&gt;</span>
<span class="tok-nt">&lt;div</span> <span class="tok-na">id=</span><span class="tok-s">&quot;main&quot;</span><span class="tok-nt">&gt;</span>
<span class="tok-nt">&lt;div&gt;</span>Esto es el contenido principal<span class="tok-nt">&lt;/div&gt;</span>
<span class="tok-nt">&lt;/div&gt;</span>
<span class="tok-nt">&lt;div</span> <span class="tok-na">id=</span><span class="tok-s">&quot;footer&quot;</span><span class="tok-nt">&gt;</span>
<span class="tok-nt">&lt;div&gt;</span>Y esto es teóricamente el pie<span class="tok-nt">&lt;/div&gt;</span>
<span class="tok-nt">&lt;/div&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En Backbone podemos crear una vista por cada sección, pero el <em>framework</em> no nos da ninguna facilidad para coordinar las vistas entre sí ni estructurarlas si necesitamos que a su vez una sección se componga de subsecciones. Para trabajar con este tipo de estructuras de manera más sencilla podemos usar Marionette.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
si necesitamos trabajar con jerarquías de vistas pero no queremos usar Marionette porque no nos hacen falta sus otras funcionalidades, una alternativa más "ligera" es un <em>plugin</em> de Backbone muy conocido llamado <a href="https://github.com/tbranyen/backbone.layoutmanager">Layout Manager</a>.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_composición_de_secciones_con_marionette">4.2.1. Composición de secciones con Marionette</h4>
<div class="paragraph">
<p>En Marionette podemos definir una vista que sea una composición de otras extendiendo la clase <code>LayoutView</code>. Esta clase tiene una propiedad <code>regions</code> en la que daremos una lista de las secciones (o como las llama Marionette, <em>regiones</em>) que componen la vista. Para cada sección especificamos un nombre simbólico y un selector que identifique la región dentro de la página.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">VistaGlobal</span> <span class="tok-o">=</span> <span class="tok-nx">Marionette</span><span class="tok-p">.</span><span class="tok-nx">LayoutView</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span>
  <span class="tok-nx">el</span><span class="tok-o">:</span> <span class="tok-s1">&#39;body&#39;</span><span class="tok-p">,</span>
  <span class="tok-nx">regions</span><span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-nx">barra</span><span class="tok-o">:</span><span class="tok-s1">&#39;#sidebar&#39;</span><span class="tok-p">,</span>
    <span class="tok-nx">principal</span><span class="tok-o">:</span> <span class="tok-s1">&#39;#main&#39;</span><span class="tok-p">,</span>
    <span class="tok-nx">pie</span><span class="tok-o">:</span> <span class="tok-s1">&#39;#footer&#39;</span>
  <span class="tok-p">}</span>
<span class="tok-p">});</span>
<span class="tok-kd">var</span> <span class="tok-nx">laVistaGlobal</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">VistaGlobal</span><span class="tok-p">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Una vez creada la instancia de <code>LayoutView</code> podemos acceder a sus regiones por identificador y mostrar una vista en cada una de ellas con <code>show</code>. Podemos eliminar la vista con <code>empty</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
las regiones son zonas más o menos permantentes de la página, mientras que las vistas habitualmente se mostrarán y eliminarán de manera dinámica con <code>show</code> y <code>empty</code>.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-c1">//Suponemos que &quot;MiVista&quot; y &quot;miModelo&quot; ya están definidos</span>
<span class="tok-kd">var</span> <span class="tok-nx">unaVista</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">MiVista</span><span class="tok-p">({</span><span class="tok-nx">model</span><span class="tok-o">:</span><span class="tok-nx">miModelo</span><span class="tok-p">});</span>
<span class="tok-c1">//mostramos una vista</span>
<span class="tok-nx">laVistaGlobal</span><span class="tok-p">.</span><span class="tok-nx">getRegion</span><span class="tok-p">(</span><span class="tok-s1">&#39;principal&#39;</span><span class="tok-p">).</span><span class="tok-nx">show</span><span class="tok-p">(</span><span class="tok-nx">unaVista</span><span class="tok-p">);</span>
<span class="tok-c1">//La ocultamos a los dos segundos</span>
<span class="tok-nx">setTimeOut</span><span class="tok-p">(</span><span class="tok-mi">2000</span><span class="tok-p">,</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-nx">laVistaGlobal</span><span class="tok-p">.</span><span class="tok-nx">getRegion</span><span class="tok-p">(</span><span class="tok-s1">&#39;principal&#39;</span><span class="tok-p">).</span><span class="tok-nx">empty</span><span class="tok-p">();</span>
<span class="tok-p">})</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_secciones_anidadas_con_marionette">4.2.2. Secciones anidadas con Marionette</h4>
<div class="paragraph">
<p>Para anidar vistas dentro de otras podemos hacer que la vista mostrada en una región sea a su vez una <code>LayoutView</code>. Supongamos que ahora queremos que la región principal se divida a su vez en un título y en otra subregión para el texto del cuerpo principal.</p>
</div>
<div class="paragraph">
<p>Vamos a usar plantillas para modularizar las regiones:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;script </span><span class="tok-na">id=</span><span class="tok-s">&quot;global_tmpl&quot;</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text/x-template&quot;</span><span class="tok-nt">&gt;</span>
  <span class="tok-o">&lt;</span><span class="tok-nx">div</span> <span class="tok-nx">id</span><span class="tok-o">=</span><span class="tok-s2">&quot;sidebar&quot;</span><span class="tok-o">&gt;</span>
  <span class="tok-nx">Esto</span> <span class="tok-nx">es</span> <span class="tok-nx">la</span> <span class="tok-nx">barra</span> <span class="tok-nx">de</span> <span class="tok-nx">navegaci</span><span class="tok-err">ó</span><span class="tok-nx">n</span>
  <span class="tok-o">&lt;</span><span class="tok-err">/div&gt;</span>
  <span class="tok-o">&lt;</span><span class="tok-nx">div</span> <span class="tok-nx">id</span><span class="tok-o">=</span><span class="tok-s2">&quot;main&quot;</span><span class="tok-o">&gt;</span>
  <span class="tok-o">&lt;</span><span class="tok-err">/div&gt;</span>
  <span class="tok-o">&lt;</span><span class="tok-nx">div</span> <span class="tok-nx">id</span><span class="tok-o">=</span><span class="tok-s2">&quot;footer&quot;</span><span class="tok-o">&gt;</span>
  <span class="tok-o">&lt;</span><span class="tok-err">/div&gt;</span>
<span class="tok-nt">&lt;/script&gt;</span>

<span class="tok-nt">&lt;script </span><span class="tok-na">id=</span><span class="tok-s">&quot;principal_tmpl&quot;</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text/X-template&quot;</span><span class="tok-nt">&gt;</span>
  <span class="tok-o">&lt;</span><span class="tok-nx">div</span><span class="tok-o">&gt;&lt;</span><span class="tok-nx">h1</span><span class="tok-o">&gt;</span><span class="tok-nx">Esto</span> <span class="tok-nx">es</span> <span class="tok-nx">el</span> <span class="tok-nx">t</span><span class="tok-err">í</span><span class="tok-nx">tulo</span> <span class="tok-nx">del</span> <span class="tok-nx">contenido</span> <span class="tok-nx">principal</span><span class="tok-o">&lt;</span><span class="tok-err">/h1&gt;&lt;/div&gt;</span>
  <span class="tok-o">&lt;</span><span class="tok-nx">div</span> <span class="tok-nx">id</span><span class="tok-o">=</span><span class="tok-s2">&quot;main_content&quot;</span><span class="tok-o">&gt;</span>
  <span class="tok-o">&lt;</span><span class="tok-err">/div&gt;</span>
<span class="tok-nt">&lt;/script&gt;</span>

<span class="tok-nt">&lt;script </span><span class="tok-na">id=</span><span class="tok-s">&quot;texto_principal_tmpl&quot;</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text/X-template&quot;</span><span class="tok-nt">&gt;</span>
  <span class="tok-nx">Esto</span> <span class="tok-nx">es</span> <span class="tok-nx">el</span> <span class="tok-nx">texto</span> <span class="tok-nx">del</span> <span class="tok-nx">contenido</span> <span class="tok-nx">principal</span>
<span class="tok-nt">&lt;/script&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora el código sería algo como lo que sigue:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">miApp</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Marionette</span><span class="tok-p">.</span><span class="tok-nx">Application</span><span class="tok-p">();</span>  
<i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-nx">miApp</span><span class="tok-p">.</span><span class="tok-nx">addRegions</span><span class="tok-p">({</span>
  <span class="tok-nx">todo</span><span class="tok-o">:</span> <span class="tok-s2">&quot;#all&quot;</span>
<span class="tok-p">});</span>

<span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-nb">document</span><span class="tok-p">).</span><span class="tok-nx">ready</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-kd">var</span> <span class="tok-nx">vg</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">VistaGlobal</span><span class="tok-p">();</span>
    <span class="tok-nx">miApp</span><span class="tok-p">.</span><span class="tok-nx">getRegion</span><span class="tok-p">(</span><span class="tok-s1">&#39;todo&#39;</span><span class="tok-p">).</span><span class="tok-nx">show</span><span class="tok-p">(</span><span class="tok-k">new</span> <span class="tok-nx">VistaGlobal</span><span class="tok-p">());</span>
<span class="tok-p">});</span>


<span class="tok-kd">var</span> <span class="tok-nx">VistaGlobal</span> <span class="tok-o">=</span> <span class="tok-nx">Mn</span><span class="tok-p">.</span><span class="tok-nx">LayoutView</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span>  
  <span class="tok-nx">template</span><span class="tok-o">:</span><span class="tok-s1">&#39;#global_tmpl&#39;</span><span class="tok-p">,</span><i class="conum" data-value="2"></i><b>(2)</b>
  <span class="tok-nx">regions</span><span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-nx">barra</span><span class="tok-o">:</span> <span class="tok-s1">&#39;#sidebar&#39;</span><span class="tok-p">,</span>
    <span class="tok-nx">principal</span><span class="tok-o">:</span> <span class="tok-s1">&#39;#main&#39;</span><span class="tok-p">,</span>
    <span class="tok-nx">pie</span><span class="tok-o">:</span> <span class="tok-s1">&#39;#footer&#39;</span>
  <span class="tok-p">},</span>
  <span class="tok-nx">onBeforeShow</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
      <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">getRegion</span><span class="tok-p">(</span><span class="tok-s1">&#39;principal&#39;</span><span class="tok-p">).</span><span class="tok-nx">show</span><span class="tok-p">(</span><span class="tok-k">new</span> <span class="tok-nx">VistaPrincipal</span><span class="tok-p">());</span>
  <span class="tok-p">}</span>
<span class="tok-p">});</span>

<span class="tok-kd">var</span> <span class="tok-nx">VistaPrincipal</span> <span class="tok-o">=</span> <span class="tok-nx">Mn</span><span class="tok-p">.</span><span class="tok-nx">LayoutView</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span>
  <span class="tok-nx">template</span><span class="tok-o">:</span> <span class="tok-s1">&#39;#principal_tmpl&#39;</span><span class="tok-p">,</span>
  <span class="tok-nx">regions</span><span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-nx">textoprincipal</span><span class="tok-o">:</span> <span class="tok-s1">&#39;#main_content&#39;</span>
  <span class="tok-p">},</span>
  <span class="tok-nx">onBeforeShow</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
      <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">getRegion</span><span class="tok-p">(</span><span class="tok-s1">&#39;textoprincipal&#39;</span><span class="tok-p">).</span><span class="tok-nx">show</span><span class="tok-p">(</span><span class="tok-k">new</span> <span class="tok-nx">VistaTextoPrincipal</span><span class="tok-p">());</span>
  <span class="tok-p">}</span>
<span class="tok-p">});</span>

<span class="tok-kd">var</span> <span class="tok-nx">VistaTextoPrincipal</span> <span class="tok-o">=</span> <span class="tok-nx">Mn</span><span class="tok-p">.</span><span class="tok-nx">ItemView</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span>
  <span class="tok-nx">template</span><span class="tok-o">:</span> <span class="tok-s1">&#39;#texto_principal_tmpl&#39;</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Creamos un objeto <code>Marionette.Application</code> al que podemos añadir regiones. Tenemos una única region que engloba la aplicación y que está dividida en subregiones (con vistas asociadas).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>La <code>VistaGlobal</code> tiene tres regiones, de las cuales solo la llamada <code>principal</code> es dinámica. Igual que antes usamos el <code>onBeforeShow</code> de la región "madre" para pintar la "hija". Con la única diferencia de qua ahora la "hija" a su vez es una <code>LayoutView</code> compuesta de subregiones.</td>
</tr>
</table>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="sesion04ejer">4.3. Ejercicios de jerarquías de vistas</h3>
<div class="paragraph">
<p>En esta sesión vamos a mejorar la interfaz implementada en la sesión anterior para permitir que se eliminen coches. Para ello vamos a crear una subvista por cada coche del listado, primero con Backbone y luego usando Marionette.</p>
</div>
<div class="sect3">
<h4 id="_vistas_y_subvistas_con_backbone_0_5_puntos">4.3.1. Vistas y subvistas con Backbone (0,5 puntos)</h4>
<div class="paragraph">
<p>Para este ejercicio haz una copia de la carpeta <code>alquiler_coches</code> que ya tenías, y llámala <code>alquiler_coches_subvistas</code>.</p>
</div>
<div class="paragraph">
<p>Usando solamente Backbone, sin Marionette, cambia el listado "estático" que ya tenías y que usaba una sola vista por un listado dinámico en el que se puedan eliminar coches, y cada coche se muestre con una subvista. Cada coche debería aparecer con un botón o enlace "eliminar" que:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://backbonejs.org/#Model-destroy">borre el modelo del servidor</a> (<code>destroy()</code>)</p>
</li>
<li>
<p>Si se elimina correctamente del servidor, <a href="http://backbonejs.org/#View-remove">elimine la vista</a> de la página (<code>remove()</code> de <code>View</code>).</p>
</li>
<li>
<p><a href="http://backbonejs.org/#Collection-remove">Quite el modelo</a> de la colección (<code>remove()</code> de <code>Collection</code>)</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_vistas_y_subvistas_con_marionette_0_5_puntos">4.3.2. Vistas y subvistas con Marionette (0,5 puntos)</h4>
<div class="paragraph">
<p>Para este ejercicio deberás coger tu código JS (solo los modelos, no las vistas) y juntarlo con la plantilla de aplicación Marionette que tienes en las plantillas de la asignatura. Entrega el ejercicio en una carpeta <code>alquiler_coches_marionette</code>.</p>
</div>
<div class="paragraph">
<p>Usando Marionette implementar las mismas funcionalidades del ejercicio anterior. Ten en cuenta que como la vista global debe mostrar el formulario de alta no te valdrá con una <code>CollectionView</code> sino que debes usar una <code>CompositeView</code> que sí puede tener una <code>template</code> asociada.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion05">5. Miniproyecto de aplicación con Backbone y Marionette</h2>
<div class="sectionbody">
<div class="paragraph">
<p>En esta sesión vamos a desarrollar una pequeña aplicación algo más compleja que los ejercicios de las otras sesiones. El objetivo es trabajar con varias vistas de manera coordinada y algo más realista que lo que hemos hecho hasta ahora.</p>
</div>
<div class="sect2">
<h3 id="_requerimientos">5.1. Requerimientos</h3>
<div class="paragraph">
<p>Queremos desarrollar una pequeña aplicación de gestión de comics en la que podamos buscar comics de Marvel usando <a href="http://developer.marvel.com/">su API REST</a>. Si estamos autentificados también podremos marcar comics como favoritos, y gestionar luego esta lista de favoritos.</p>
</div>
<div class="paragraph">
<p>Como requerimientos "iniciales":</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Se podrán buscar comics por título, listando los resultados de modo resumido</p>
</li>
<li>
<p>Se podrán ver todos los detalles de un comic determinado</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Como requerimientos "adicionales"</p>
</div>
<div class="paragraph">
<p>Se usará Kinvey como <em>backend</em> para realizar las siguientes operaciones:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Se podrá hacer <em>login</em> y <em>logout</em></p>
</li>
<li>
<p>Si estamos logueados, se podrán marcar comics como favoritos, añadiéndolos a una lista de "mis comics".</p>
</li>
<li>
<p>Se podrán eliminar comics de la lista "mis comics".</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Fíjate que la aplicación trabaja con dos <em>backends</em>. El servidor de Marvel solo nos permite leer datos. En él buscaremos comics y obtendremos sus datos. El servidor de Kinvey nos permite también guardar información, así que ahí es donde guardaremos los datos de nuestros comics favoritos.</p>
</div>
<div class="paragraph">
<p>Daremos aquí instrucciones paso a paso de cómo implementar los requerimientos "iniciales", pero solo algunas guías genéricas de cómo implementar los "adicionales".</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Para hacer peticiones al API de Marvel hay que tener un "API key". En la plantilla del proyecto se usa la API Key del profesor (tiene unas 3000 llamadas diarias de límite, seguramente más que suficientes). No obstante, si deseas usar tu propia API key, puedes <a href="https://developer.marvel.com/pleasesignin">darte de alta como desarrollador</a> en la web de Marvel para obtenerla, accediendo luego a tu panel de control de desarrollador.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_implementación_de_los_requerimientos_iniciales">5.2. Implementación de los requerimientos "iniciales"</h3>
<div class="paragraph">
<p>Aquí tienes la <a href="https://bitbucket.org/ottocol/marvel-miscomics/downloads">plantilla de proyecto</a> que puedes usar como base para tu código.</p>
</div>
<div class="sect3">
<h4 id="_la_lógica_de_negocio">5.2.1. La "lógica de negocio"</h4>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
para que funcionen las llamadas al API de Marvel con la clave del profesor, la página debe ser servida por un servidor web que funcione en localhost (si abrís el <code>.html</code> dando doble clic y probáis una llamada al API dará error HTTP 409). Podéis poner en marcha un servidor web simple yendo al directorio donde está la aplicación y ejecutando <code>python -m SimpleHTTPServer</code>, que empezará a funcionar por <code><a href="http://localhost:8000" class="bare">http://localhost:8000</a></code>. También podéis instalar un servidor basado en Node con <code>sudo npm install -g http-server</code> y luego ejecutarlo con <code>http-server</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La plantilla usa espacios de nombres y módulos al estilo "patrón módulo". Tienes ya implementado un modelo (<code>Comic</code>) y una colección (<code>Comics</code>). Esta última ya implementa la comunicación con el API de Marvel, para buscar comics por título. Puedes ir a la consola Javascript y teclear:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">lista</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Marvel</span><span class="tok-p">.</span><span class="tok-nx">Collections</span><span class="tok-p">.</span><span class="tok-nx">Comics</span><span class="tok-p">()</span>
<span class="tok-nx">lista</span><span class="tok-p">.</span><span class="tok-nx">buscar</span><span class="tok-p">(</span><span class="tok-s2">&quot;Hulk&quot;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pasados unos segundos si examinas la variable "lista" debería contener un conjunto de modelos <code>Comic</code> cada uno con los datos de un comic. Aunque el API está paginado y podríamos irle solicitando resultados de 20 en 20 como mucho, para simplificar la aplicación nos "conformaremos" con listar solo los 20 primeros (podría haber menos), no es necesario implementar paginado.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Vamos a usar Marionette para la interfaz porque simplifica bastante el renderizado y la gestión dinámica de las vistas, pero también se podría implementar con Backbone "puro". Puedes hacerlo así si eres lo suficientemente masoquista.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_estructura_de_la_interfaz">5.2.2. Estructura de la interfaz</h4>
<div class="paragraph">
<p>Dividiremos la pantalla en tres secciones, representadas con tres <code>div</code> en el <code>index.html</code></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Parte superior ("cabecera"): aquí aparecerá el formulario de login, y si ya estamos autentificados, un botón o enlace para gestionar "mis comics".</p>
</li>
<li>
<p>Parte media ("formBusqueda"): el formulario de búsqueda</p>
</li>
<li>
<p>Parte inferior ("listado"): Esta parte irá cambiando. Si hemos buscado mostrará la lista de resultados de búsqueda. Si hemos elegido "mis comics" aparecerán los que hemos ido seleccionando. Si pulsamos sobre "ver detalles" de un comic se verá únicamente el cómic seleccionado.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
aunque hablemos de parte superior, media e inferior, la colocación en pantalla es libre. Con el CSS adecuado podrías poner por ejemplo la página a tres columnas y colocar en cada columna una sección. Pero sí deberías respetar las tres secciones y el papel que desempeña cada una de ellas. Por otro lado, dale prioridad a la funcionalidad sobre la interfaz, no te preocupes demasiado del aspecto estético, no es el objetivo del ejercicio.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Estas tres secciones estarán controladas por una "vista global" de Marionette, que gestionará a las vistas "hijas". Pero vamos por partes. Primero vamos a ver y probar las vistas básicas, para ver un solo comic y un listado de comics.</p>
</div>
</div>
<div class="sect3">
<h4 id="_vista_de_un_solo_comic_code_js_views_vistacomic_js_code">5.2.3. Vista de un solo comic: <code>js/views/VistaComic.js</code></h4>
<div class="paragraph">
<p>La clase ya la tienes definida, ya que en Marionette solo hace falta referenciar dónde está la <em>template</em>, el <em>render</em> lo implementa Marionette. Eso sí, tendrás que definir tú la <em>template</em> usando Mustache en el <code>script id="VistaComicTmpl"</code>, que ahora está vacío. Muestra al menos el <code>title</code> y la <code>description</code> del comic. Además muestra una imagen a tamaño reducido. Las imágenes se obtienen concatenando:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Una URL (propiedad <code>thumbnail.path</code>)</p>
</li>
<li>
<p>Un tipo de imagen (que puede ser "standard_small", "standard_medium", "standard_large",&#8230;&#8203; <a href="http://developer.marvel.com/documentation/images">consulta aquí</a> todos los tipos o <em>image variants</em> y escoge el que prefieras).</p>
</li>
<li>
<p>Una extensión de archivo (normalmente <code>.jpg</code> pero puede variar, así que se usa el atributo <code>thumbnail.extension</code> para ser más genérico).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Para comprobar que funciona, desde la consola de Javascript lanza una búsqueda de comics como has hecho antes, asegúrate de que ya ha respondido el servidor (la colección no está vacía) y luego crea una vista pasándole una posición de la colección y renderízala en la página. Algo como:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">lista</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Marvel</span><span class="tok-p">.</span><span class="tok-nx">Collections</span><span class="tok-p">.</span><span class="tok-nx">Comics</span><span class="tok-p">()</span>
<span class="tok-nx">lista</span><span class="tok-p">.</span><span class="tok-nx">buscar</span><span class="tok-p">(</span><span class="tok-s2">&quot;Hulk&quot;</span><span class="tok-p">)</span>
<span class="tok-p">...</span><span class="tok-nx">espera</span> <span class="tok-nx">unos</span> <span class="tok-nx">segundos</span><span class="tok-p">,</span> <span class="tok-nx">aseg</span><span class="tok-err">ú</span><span class="tok-nx">rate</span> <span class="tok-nx">de</span> <span class="tok-nx">que</span> <span class="tok-s2">&quot;lista&quot;</span> <span class="tok-nx">contiene</span> <span class="tok-nx">datos</span>
<span class="tok-nx">v</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Marvel</span><span class="tok-p">.</span><span class="tok-nx">Views</span><span class="tok-p">.</span><span class="tok-nx">VistaComic</span><span class="tok-p">({</span><span class="tok-nx">model</span><span class="tok-o">:</span><span class="tok-nx">lista</span><span class="tok-p">.</span><span class="tok-nx">at</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">)});</span>
<span class="tok-nx">v</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">().</span><span class="tok-nx">$el</span><span class="tok-p">.</span><span class="tok-nx">appendTo</span><span class="tok-p">(</span><span class="tok-s1">&#39;body&#39;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Deberían aparecer en pantalla los datos del comic.</p>
</div>
</div>
<div class="sect3">
<h4 id="_vista_de_lista_de_comics">5.2.4. Vista de lista de comics</h4>
<div class="paragraph">
<p>Esta vista es del tipo <code>CollectionView</code>, lo que quiere decir que no tiene HTML propio, su HTML es solo una concatenación de los HTML de las vistas "hijas" (del tipo <code>VistaComic</code>). Por tanto no tiene <em>template</em>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Si quisieras que esta vista tuviera HTML propio y por tanto <em>template</em> (por ejemplo para mostrar un título "Lista de resultados") tendrías que cambiar el tipo por <code>CompositeView</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>No obstante para asegurarte de que todo es correcto puedes hacer una prueba similar a la que has hecho para <code>VistaComic</code>, pero ahora para mostrar un listado completo</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">lista</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Marvel</span><span class="tok-p">.</span><span class="tok-nx">Collections</span><span class="tok-p">.</span><span class="tok-nx">Comics</span><span class="tok-p">()</span>
<span class="tok-nx">lista</span><span class="tok-p">.</span><span class="tok-nx">buscar</span><span class="tok-p">(</span><span class="tok-s2">&quot;Hulk&quot;</span><span class="tok-p">)</span>
<span class="tok-p">...</span><span class="tok-nx">espera</span> <span class="tok-nx">unos</span> <span class="tok-nx">segundos</span><span class="tok-p">,</span> <span class="tok-nx">aseg</span><span class="tok-err">ú</span><span class="tok-nx">rate</span> <span class="tok-nx">de</span> <span class="tok-nx">que</span> <span class="tok-s2">&quot;lista&quot;</span> <span class="tok-nx">contiene</span> <span class="tok-nx">datos</span>
<span class="tok-nx">v</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Marvel</span><span class="tok-p">.</span><span class="tok-nx">Views</span><span class="tok-p">.</span><span class="tok-nx">VistaComics</span><span class="tok-p">({</span><span class="tok-nx">collection</span><span class="tok-o">:</span><span class="tok-nx">lista</span><span class="tok-p">});</span>
<span class="tok-nx">v</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">().</span><span class="tok-nx">$el</span><span class="tok-p">.</span><span class="tok-nx">appendTo</span><span class="tok-p">(</span><span class="tok-s1">&#39;body&#39;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Vale, ya estamos seguros de que al menos las piezas básicas con los datos de los comics funcionan. Vamos con las piezas de "alto nivel".</p>
</div>
</div>
<div class="sect3">
<h4 id="_vista_global">5.2.5. Vista Global</h4>
<div class="paragraph">
<p>Tienes el esqueleto en <code>js/views/VistaGlobal.js</code>. Es una vista de tipo <code>LayoutView</code>, o sea compuesta. El esqueleto únicamente especifica las secciones que controla (con el objeto <code>regions</code>, que establece la correspondencia entre nombres simbólicos de secciones y nodos del HTML).</p>
</div>
<div class="paragraph">
<p>Fijate que en el archivo <code>js/main.js</code>, cuando se carga el documento (evento <code>$(document).ready</code>) se crea una instancia de la vista global y se muestra una vista con el formulario de búsqueda en la sección <code>formBusqueda</code>. Pero por ahora el formulario no hace nada. Vamos a solucionar esto enseguida.</p>
</div>
</div>
<div class="sect3">
<h4 id="_vista_de_búsqueda_0_5_puntos">5.2.6. Vista de búsqueda (0,5 puntos)</h4>
<div class="paragraph">
<p>Esta vista debe ser la encargada de mostrar el formulario, disparar la búsqueda y obtener los resultados, que le pasará a la vista global. Por ahora solo muestra el formulario.</p>
</div>
<div class="paragraph">
<p>Está representada en el código por:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Una clase <code>Marvel.Views.VistaBuscarComics</code>, cuyo esqueleto básico ya tienes implementado en <code>js/views/VistaBuscarComics.js</code></p>
</li>
<li>
<p>Una <em>template</em> que tienes en <code>index.html</code> en forma de <code>script</code> con un <code>id=VistaBuscarComicsTmpl</code>, con un formulario básico (puedes modificarlo si lo deseas).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Para que esta vista haga su trabajo completo, tienes que:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Definir el array <code>events</code> para que cuando se pulse sobre el botón con <code>id=botonBuscar</code> se llame a una función <code>buscar</code> de la vista, que debes definir.</p>
</li>
<li>
<p>En esta función <code>buscar</code> debes llamar al método <code>buscar</code> de la colección (el que has probado antes en la consola).</p>
</li>
<li>
<p>En el <code>initialize</code> debes crear la colección de comics asociada, por el momento vacía (se llenará de datos cuando se haga el <code>fetch</code>)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">initialize</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">collection</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Marvel</span><span class="tok-p">.</span><span class="tok-nx">Collections</span><span class="tok-p">.</span><span class="tok-nx">Comics</span><span class="tok-p">();</span>
  <span class="tok-c1">//Todavía faltan cosas</span>
  <span class="tok-p">...</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Como la búsqueda es asíncrona, para saber cuándo se han recibido resultados usaremos el evento <code>sync</code> de la colección que indica que se ha recibido del servidor. En el <code>initialize</code> debes hacer que la vista escuche el evento <code>sync</code> sobre la colección y que cuando se produzca llame a una función de la vista <code>busquedaCompletada</code>.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
recuerda que cuando un evento llama a un <em>callback</em>, <code>this</code> no apunta a la vista sino a <code>window</code>. Para solucionarlo puedes hacerlo de dos formas
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-c1">//Forma 1: usando el bindAll de la librería underscore</span>
<span class="tok-nx">_</span><span class="tok-p">.</span><span class="tok-nx">bindAll</span><span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">,</span> <span class="tok-s1">&#39;busquedaCompletada&#39;</span><span class="tok-p">);</span>
<span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">listenTo</span><span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">collection</span><span class="tok-p">,</span> <span class="tok-s1">&#39;sync&#39;</span><span class="tok-p">,</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">busquedaCompletada</span><span class="tok-p">);</span>
<span class="tok-c1">//Forma 2 (USA SOLO UNA DE ELLAS!!): usando el &quot;bind&quot; estándar de Javascript</span>
<span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">listenTo</span><span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">collection</span><span class="tok-p">,</span> <span class="tok-s1">&#39;sync&#39;</span><span class="tok-p">,</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">busquedaCompletada</span><span class="tok-p">.</span><span class="tok-nx">bind</span><span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">));</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Finalmente define la función <code>busquedaCompletada</code> para que lance un evento "a medida" (es decir, no estándar de Backbone) y que escuchará la vista global, luego veremos cómo.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">busquedaCompletada</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-c1">//El nombre `completed:search` es totalmente inventado, podrías poner lo que quieras.</span>
    <span class="tok-c1">//this.collection se le pasará como parámetro a quien esté escuchando este evento</span>
    <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">triggerMethod</span><span class="tok-p">(</span><span class="tok-s1">&#39;completed:search&#39;</span><span class="tok-p">,</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">collection</span><span class="tok-p">);</span>
<span class="tok-p">},</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Sí, es un poco retorcido esto de capturar el evento <code>sync</code> para lanzar un evento <code>completed:search</code>. En Marionette una vista global puede escuchar eventos de las vistas hijas, pero no directamente de una colección gestionada por una vista hija. También podrías pasarle a la vista global una referencia a la colección para que pudiera escuchar directamente el evento <code>sync</code>. Pero es un poco embrollado que las vistas se pongan a escuchar eventos sobre objetos que en principio no son suyos.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_de_nuevo_a_la_vista_global_0_25">5.2.7. De nuevo a la vista global (0,25)</h4>
<div class="paragraph">
<p>Ahora para que la <strong>vista global</strong> escuche el evento <code>completed:search</code> y en respuesta muestre una vista con la lista de comics encontrados puedes añadirle lo siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">childEvents</span><span class="tok-o">:</span> <span class="tok-p">{</span>
  <span class="tok-c1">//los eventos de las subvistas automáticamente reciben como 1er parámetro la subvista</span>
  <span class="tok-c1">//y luego los que hayamos incluido cuando generamos el evento con el triggerMethod</span>
  <span class="tok-s1">&#39;completed:search&#39;</span> <span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">child</span><span class="tok-p">,</span> <span class="tok-nx">col</span><span class="tok-p">)</span> <span class="tok-p">{</span>
      <span class="tok-c1">//Creamos una vista para mostrar una lista de comics, le pasamos la colección</span>
      <span class="tok-c1">//y la mostramos en la sección &quot;listado&quot; de la vista global</span>
      <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">showChildView</span><span class="tok-p">(</span><span class="tok-s1">&#39;listado&#39;</span><span class="tok-p">,</span> <span class="tok-k">new</span> <span class="tok-nx">Marvel</span><span class="tok-p">.</span><span class="tok-nx">Views</span><span class="tok-p">.</span><span class="tok-nx">VistaComics</span><span class="tok-p">({</span>
        <span class="tok-nx">collection</span><span class="tok-o">:</span> <span class="tok-nx">col</span>
      <span class="tok-p">}))</span>
  <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ver_detalles_de_comic_0_25">5.2.8. Ver detalles de comic (0,25)</h4>
<div class="paragraph">
<p>Nuestro objetivo ahora es que cuando pulsemos en "ver detalles" de un comic se sustituya la lista de comics por los datos detallados del comic elegido. Luego al "cerrar detalles" aparecerá de nuevo la lista.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Lo primero, tendrás que modificar la <em>template</em> de la vista que solo muestra un comic <code>VistaComic</code> para añadirle un enlace o botón "ver detalles".</p>
</li>
<li>
<p>Después usa la propiedad <code>events</code> de la vista para asociar el click sobre el enlace o botón con una función <code>verDetalles</code></p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
En la función <code>verDetalles</code>, lo primero asegúrate de que anulas el comportamiento por defecto del enlace o botón, ya que podría recargar la página y se comportaría de forma "extraña":
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-c1">//Los manejadores de evento Javascript reciben automáticamente el evento producido</span>
<span class="tok-kd">function</span> <span class="tok-nx">verDetalles</span><span class="tok-p">(</span><span class="tok-nx">evento</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-c1">//Anular el manejador por defecto del navegador, que podría recargar la página</span>
  <span class="tok-nx">evento</span><span class="tok-p">.</span><span class="tok-nx">preventDefault</span><span class="tok-p">();</span>
  <span class="tok-p">...</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Además de lo anterior, en la función <code>verDetalles</code> debes generar un evento "a medida" que llegará a la vista global y le indicará que hay que mostrar los detalles de un comic concreto. Pasa algo parecido a la búsqueda. En este caso una vista "madre" no puede escuchar directamente los eventos de interfaz de usuario de las hijas, así que las hijas tienen que capturarlos ellas mismas y lanzar un nuevo evento para la "madre". Finalmente <code>verDetalles</code> quedará:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-c1">//Los manejadores de evento Javascript reciben automáticamente el evento producido</span>
<span class="tok-kd">function</span> <span class="tok-nx">verDetalles</span><span class="tok-p">(</span><span class="tok-nx">evento</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-c1">//Anular el manejador por defecto del navegador, que podría recargar la página</span>
  <span class="tok-nx">evento</span><span class="tok-p">.</span><span class="tok-nx">preventDefault</span><span class="tok-p">();</span>
  <span class="tok-c1">//me invento un evento (¡y rima!). Pasamos el modelo, para que la vista &quot;madre&quot; sepa</span>
  <span class="tok-c1">//de quién hay que mostrar los detalles</span>
  <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">triggerMethod</span><span class="tok-p">(</span><span class="tok-s1">&#39;show:details&#39;</span><span class="tok-p">,</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">model</span><span class="tok-p">);</span>
<span class="tok-p">}}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Ahora tendremos que modificar el código de la vista global</strong>, que es la que tiene que recibir el evento <code>show:details</code>. En respuesta a este evento, sustituiremos la vista con la lista de comics por una vista para mostrar los detalles (clase <code>VistaDetallesComic</code>). Pero como cuando cerremos los detalles queremos volver a la lista, le diremos a Marionette que no destruya la vista de lista, y la guardaremos en el objeto vista global.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">childEvents</span><span class="tok-o">:</span> <span class="tok-p">{</span>
  <span class="tok-s1">&#39;completed:search&#39;</span> <span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">child</span><span class="tok-p">,</span> <span class="tok-nx">col</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-c1">//...esto ya lo teníamos de antes</span>
  <span class="tok-p">},</span>
  <span class="tok-s1">&#39;show:details&#39;</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">child</span><span class="tok-p">,</span> <span class="tok-nx">model</span><span class="tok-p">)</span> <span class="tok-p">{</span>
      <span class="tok-c1">//guardamos la vista con el listado actual</span>
      <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">vistaLista</span> <span class="tok-o">=</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">getRegion</span><span class="tok-p">(</span><span class="tok-s1">&#39;listado&#39;</span><span class="tok-p">).</span><span class="tok-nx">currentView</span><span class="tok-p">;</span>
      <span class="tok-c1">//Creamos una vista de tipo &quot;detalle&quot; asociada al modelo</span>
      <span class="tok-kd">var</span> <span class="tok-nx">nv</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Marvel</span><span class="tok-p">.</span><span class="tok-nx">Views</span><span class="tok-p">.</span><span class="tok-nx">VistaDetallesComic</span><span class="tok-p">({</span><span class="tok-nx">model</span><span class="tok-o">:</span> <span class="tok-nx">model</span><span class="tok-p">});</span>
      <span class="tok-c1">//mostramos la nueva vista, diciéndole a Marionette que no libere la memoria</span>
      <span class="tok-c1">//de la anterior, ya que luego la colocaremos otra vez en su sitio</span>
      <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">getRegion</span><span class="tok-p">(</span><span class="tok-s1">&#39;listado&#39;</span><span class="tok-p">).</span><span class="tok-nx">show</span><span class="tok-p">(</span><span class="tok-nx">nv</span><span class="tok-p">,{</span><span class="tok-nx">preventDestroy</span><span class="tok-o">:</span><span class="tok-kc">true</span><span class="tok-p">});</span>
   <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cuidado, si quieres probar esto, lo primero que debes hacer es rellenar la <em>template</em> asociada a la <code>VistaDetallesComic</code>, para que aparezca información en pantalla. Coloca los datos que quieras, y una imagen a mayor tamaño que la que aparece en el listado.</p>
</div>
</div>
<div class="sect3">
<h4 id="_cerrar_la_vista_de_detalles_y_volver_al_listado_de_comics_0_25_puntos">5.2.9. Cerrar la vista de detalles y volver al listado de comics (0,25 puntos)</h4>
<div class="paragraph">
<p>En la <em>template</em> asociada a la clase <code>VistaDetallesComic</code> tiene que haber un botón o enlace "Cerrar". Ahora es similar al proceso seguido para mostrar los detalles. En la clase <code>VistaDetallesComic</code></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Mediante el <code>events</code> debes asociar el click sobre "Cerrar" con una función de la vista <code>cerrarDetalles</code></p>
</li>
<li>
<p>En la función <code>cerrarDetalles</code> debes generar un evento "a medida" para que lo capture la vista "madre". Por similitud con el anterior, puedes llamarlo "hide:details" (o como quieras).</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
recuerda llamar a <code>preventDefault()</code> para evitar posibles recargas de la página.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finalmente, modifica el código de la vista global para que reciba el evento <code>hide:details</code> (o como lo hayas llamado) y vuelva a poner "en su sitio" la lista de comics.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">childEvents</span><span class="tok-o">:</span> <span class="tok-p">{</span>
  <span class="tok-p">...</span>
  <span class="tok-p">...</span>
  <span class="tok-s1">&#39;hide:details&#39;</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
      <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">getRegion</span><span class="tok-p">(</span><span class="tok-s1">&#39;listado&#39;</span><span class="tok-p">).</span><span class="tok-nx">show</span><span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">vistaLista</span><span class="tok-p">);</span>
  <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_requerimientos_adicionales_1_punto_en_total">5.3. Requerimientos "adicionales" (1 punto en total)</h3>
<div class="paragraph">
<p>Con la guía anterior espero que hayas adquirido una idea básica de cómo coordinar varias vistas desde una vista "madre", que es la parte más complicada. Los requerimientos que faltan necesitan de la gestión de vistas y además de la interacción con el <em>backend</em> de Kinvey.</p>
</div>
<div class="paragraph">
<p>Pistas de implementación para los requerimientos que faltan:</p>
</div>
<div class="paragraph">
<p><strong>Para el "login": <em>(0,3 puntos)</em></strong></p>
</div>
<div class="paragraph">
<p>Tendrás que definir una vista <code>VistaFormLogin</code> o similar que muestre un formulario de login. Tómate la operación de login simplemente como una "comprobación de que el login y el password son correctos". En realidad no usamos una sesión de usuario ya que recuerda que en cada petición a Kinvey mandamos de nuevo login y password, al estar usando HTTP Basic.</p>
</div>
<div class="paragraph">
<p>Para <a href="http://devcenter.kinvey.com/rest/guides/users#login">hacer login en Kinvey</a> con el API REST hay que hacer una petición POST a <code><a href="https://baas.kinvey.com/user/MI_APP_ID/login" class="bare">https://baas.kinvey.com/user/MI_APP_ID/login</a></code>, mandando un objeto JSON con las propiedades 'username' y 'password'. La petición debe estar autentificada usando HTTP BASIC con las credenciales de la aplicación, es decir, como login el APP_ID y como password el APP_SECRET, que aparecen en la parte superior del <em>dashboard</em> web de Kinvey.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
puede haber cierta confusión entre las credenciales (login+password) del usuario y las credenciales de la aplicación. Para la operación de login en Kinvey debemos enviar un objeto JSON con las credenciales del usuario. Pero es que además TODAS las peticiones a Kinvey deben estar autentificadas. ¿Pero con qué credenciales, si precisamente estamos intentando hace login ahora mismo?. En Kinvey esto se resuelve usando las credenciales de la aplicación (APP ID+APP SECRET), que viene a ser una especie de "usuario global" de la app.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Crea un modelo Backbone llamado <code>Usuario</code>, con las propiedades <code>username</code> y <code>password</code>, y define en él un método <code>login</code> que llame internamente al <code>save()</code> de Backbone. Cuando el login se efectúe con éxito (evento <code>sync</code> sobre el modelo), la vista de la barra superior debería cambiar para mostrar tu login y un botón/enlace para ver "mis comics".</p>
</div>
<div class="paragraph">
<p>Aunque en Kinvey existe una operación de <em>logout</em>, en nuestro caso no tiene sentido, porque no estamos usando sesiones. Simplemente cuando se haga <em>logout</em> tu aplicación debería dejar de mostrar los datos del usuario actual y volver a mostrar el formulario de login.</p>
</div>
<div class="paragraph">
<p><strong>Para la gestión de "mis comics" <em>(0,7 puntos)</em></strong>: La idea sería que usaras un modelo <code>Favorito</code> en la que almacenaras los datos que quieras guardar del comic (como mínimo su <code>id</code>, para poder recuperar el resto de datos con el API de Marvel, o bien copiar los campos y repetirlos en Kinvey para no tener que buscar de nuevo en Marvel). Tendrás que implementar:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>La parte de interfaz que te permite marcar un comic como favorito</p>
</li>
<li>
<p>La sustitución de los resultados de búsqueda por la lista de tus comics cuando pulsas en "mis comics"</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Como es lógico también deberían poderse eliminar los favoritos, pero ya son bastantes requerimientos, lo dejaremos fuera.</p>
</div>
<div class="paragraph">
<p>Puedes implementar estas funcionalidades de la forma que mejor te parezca, mientras funcionen correctamente.¡Suerte!.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion06">6. Interfaces web con ReactJS</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="__por_qué_reactjs">6.1. ¿Por qué ReactJS?</h3>
<div class="paragraph">
<p>Una de las partes más tediosas de una SPA es actualizar la interfaz gráfica de manera dinámica. Conforme cambia el modelo y las colecciones debemos estar constantemente redibujando la interfaz para reflejarlo. Si además tenemos en cuenta que Backbone no ofrece <em>data binding</em> de manera nativa es fácil ver que va a ser una labor que consuma bastante tiempo de desarrollo si se quiere hacer de forma eficiente, redibujando solo la parte que cambia.</p>
</div>
<div class="paragraph">
<p>Recordemos que el <code>render</code> de una vista en Backbone, por convenio genera <strong>todo</strong> el HTML de la vista. Si queremos redibujar solo parte de la interfaz tenemos que escribir otros métodos de <em>rendering</em> adecuados para la tarea en particular, como hacíamos en el primer ejemplo del <em>widget</em> del tiempo con el método <code>renderData</code>. El problema es que en una interfaz compleja acabaríamos con multitud de métodos <code>renderXXX</code> o solo con unos pocos pero que tendrían una lógica de control complicada.</p>
</div>
<div class="paragraph">
<p>La solución que propone ReactJS a este problema puede sorprender inicialmente por su aparente "ingenuidad": si es tan tedioso comprobar qué ha cambiado y redibujar solamente eso, ¿por qué no <strong>redibujar siempre toda la interfaz</strong>?. Así estaríamos seguros de que está correctamente actualizada. "Ya, pero eso debe ser muy ineficiente", habrás pensado inmediatamente. Pues resulta que no, porque una de las ideas clave de ReactJS es que <em>aunque el desarrollador se limita simplemente a forzar el redibujado completo, ReactJS calcula automáticamente qué es lo que cambia en la vista del estado actual al siguiente, y solo redibuja las partes necesarias</em>.</p>
</div>
<div class="paragraph">
<p>Una cosa que hay que tener clara es que <strong>ReactJS es únicamente un <em>framework</em> para la vista</strong>, no es un <em>framework</em> MVC completo. No tiene modelos ni tampoco controladores. En aplicaciones complejas adicionalmente a React se recomienda usar  una arquitectura denominada <strong>flux</strong>, que veremos en las siguientes sesiones.</p>
</div>
<div class="paragraph">
<p>Un aspecto interesante de React es que está orientado al desarrollo de <strong>componentes de interfaz</strong>, que pueden ser fácilmente reutilizables. Además dichos componentes se pueden organizar de modo jerárquico para montar la interfaz completa de la aplicación uniendo componentes simples.</p>
</div>
<div class="paragraph">
<p>React es un proyecto <em>open source</em> creado originalmente por Facebook y usado en producción por la misma Facebook en su sitio web y también en sitios "hermanos" como Instagram. Además se usa en  <a href="https://github.com/facebook/react/wiki/Sites-Using-React">muchos otros sitios web</a> de tráfico elevado (Khan Academy, Codecademy, Atlassian,&#8230;&#8203;).</p>
</div>
</div>
<div class="sect2">
<h3 id="__hola_react_nuestros_primeros_componentes">6.2. ¡Hola React!. Nuestros primeros componentes</h3>
<div class="paragraph">
<p>Lo primero es instalar la librería. Lo más sencillo es simplemente bajarla desde <a href="https://facebook.github.io/react/">su sitio web</a>. Como es habitual en este tipo de librerías viene en versión <strong>minificada</strong> y de desarrollo. Usaremos aquí esta última ya que muestra más avisos en la consola del navegador. Necesitaremos como mínimo los archivos <code>react.js</code> y <code>react-dom.js</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
La forma clásica de referenciar librerías Javascript usando <code>&lt;script&gt;</code> no es precisamente modular. Actualmente se tiende a usar herramientas como <a href="https://webpack.github.io/">Webpack</a> o <a href="http://browserify.org/">Browserify</a> para referenciar librerías externas de forma más "elegante". Al ser React un <em>framework</em> bastante moderno, muchos tutoriales y libros de React tienden a usar estas herramientas, cosa que no haremos aquí para poder concentrarnos en aprender React, sin perdernos en tecnologías adicionales. Por el mismo motivo tampoco usaremos funcionalidades de EcmaScript versión 6 (ES6) en los ejemplos.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Los componentes de React son muy similares a las vistas de Backbone. Veamos primero cómo instanciaríamos un componente de los ya predefinidos en React. La librería incluye como componentes todas las etiquetas de HTML. Así por ejemplo si quisiéramos crear un encabezado <code>h1</code> que fuera un componente de React haríamos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&lt;</span><span class="tok-nx">script</span> <span class="tok-nx">src</span><span class="tok-o">=</span><span class="tok-s2">&quot;react.js&quot;</span><span class="tok-o">&gt;&lt;</span><span class="tok-err">/script&gt;   </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-o">&lt;</span><span class="tok-nx">script</span> <span class="tok-nx">src</span><span class="tok-o">=</span><span class="tok-s2">&quot;react-dom.js&quot;</span><span class="tok-o">&gt;&lt;</span><span class="tok-err">/script&gt;</span>
<span class="tok-o">&lt;</span><span class="tok-nx">div</span> <span class="tok-nx">id</span><span class="tok-o">=</span><span class="tok-s2">&quot;miApp&quot;</span><span class="tok-o">&gt;&lt;</span><span class="tok-err">/div&gt;  </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-o">&lt;</span><span class="tok-nx">script</span><span class="tok-o">&gt;</span>
  <span class="tok-kd">var</span> <span class="tok-nx">miComponente</span> <span class="tok-o">=</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">DOM</span><span class="tok-p">.</span><span class="tok-nx">h1</span><span class="tok-p">({</span><span class="tok-nx">id</span><span class="tok-o">:</span><span class="tok-s2">&quot;saludo&quot;</span><span class="tok-p">},</span> <span class="tok-s1">&#39;¡Hola React!&#39;</span><span class="tok-p">);</span>  <i class="conum" data-value="3"></i><b>(3)</b>
  <span class="tok-nx">ReactDOM</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">(</span><span class="tok-nx">miComponente</span><span class="tok-p">,</span> <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s1">&#39;miApp&#39;</span><span class="tok-p">));</span> <i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-o">&lt;</span><span class="tok-err">/script&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Incluimos la librería. Como ya hemos dicho como mínimo necesitamos estos dos archivos.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Necesitamos un "sitio" en el HTML para colgar el componente React, al igual que ocurre con las vistas en Backbone. Lo más habitual es usar un <code>div</code> vacío.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Creamos el componente. En este caso es simplemente uno de los predefinidos en React. En React tenemos toda una familia de métodos <code>React.DOM.*</code> que se corresponden con las etiquetas de HTML. Especificamos sus propiedades como un literal JSON y su contenido (al ser un <code>h1</code> será su texto).</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Finalmente pintamos el componente en el lugar destinado para ello.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
es posible que en algún tutorial o ejemplo de React veas en lugar de <code>React.DOM.h1</code> código al estilo <code>React.createElement('h1', &#8230;&#8203;)</code>. La primera forma no es más que un método de conveniencia para evitar el método general, que es un poco más tedioso de usar.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
En versiones anteriores de React se usaba <code>React.render</code> en lugar de <code>ReactDOM.render</code>. Por eso es posible que encuentres en Internet o en fuentes impresas muchos ejemplos que lo hacen así. No obstante en la versión actual la primera forma genera un <em>warning</em> en la consola del navegador, especificando que el método apropiado es el que hemos usado aquí.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En el mundo real es de esperar que nuestro componente sea algo más que una única etiqueta simple de HTML, normalmente contendrá otras en diferentes niveles, formando un fragmento de HTML. El API de <code>React.DOM.*</code> nos permite anidar etiquetas. Cuando una etiqueta admita dentro un conjunto de otras, en el API podremos pasar un array con los correspondientes componentes. Por ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&lt;</span><span class="tok-nx">script</span> <span class="tok-nx">src</span><span class="tok-o">=</span><span class="tok-s2">&quot;lib/react.js&quot;</span><span class="tok-o">&gt;&lt;</span><span class="tok-err">/script&gt;</span>
<span class="tok-o">&lt;</span><span class="tok-nx">script</span> <span class="tok-nx">src</span><span class="tok-o">=</span><span class="tok-s2">&quot;lib/react-dom.js&quot;</span><span class="tok-o">&gt;&lt;</span><span class="tok-err">/script&gt;</span>
<span class="tok-o">&lt;</span><span class="tok-nx">div</span> <span class="tok-nx">id</span><span class="tok-o">=</span><span class="tok-s2">&quot;miApp&quot;</span><span class="tok-o">&gt;&lt;</span><span class="tok-err">/div&gt;</span>
<span class="tok-o">&lt;</span><span class="tok-nx">script</span><span class="tok-o">&gt;</span>
    <span class="tok-kd">var</span> <span class="tok-nx">miLista</span> <span class="tok-o">=</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">DOM</span><span class="tok-p">.</span><span class="tok-nx">ul</span><span class="tok-p">(</span><span class="tok-kc">null</span><span class="tok-p">,</span>
            <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">DOM</span><span class="tok-p">.</span><span class="tok-nx">li</span><span class="tok-p">(</span><span class="tok-kc">null</span><span class="tok-p">,</span> <span class="tok-s1">&#39;Pan&#39;</span><span class="tok-p">),</span>
            <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">DOM</span><span class="tok-p">.</span><span class="tok-nx">li</span><span class="tok-p">(</span><span class="tok-kc">null</span><span class="tok-p">,</span> <span class="tok-s1">&#39;Patatas&#39;</span><span class="tok-p">)</span>
    <span class="tok-p">);</span>
    <span class="tok-nx">ReactDOM</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">(</span><span class="tok-nx">miLista</span><span class="tok-p">,</span> <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s1">&#39;miApp&#39;</span><span class="tok-p">));</span>
<span class="tok-o">&lt;</span><span class="tok-err">/script&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nótese que la intención del ejemplo anterior es simplemente ilustrar que unos componentes pueden contener otros. Por desgracia tal y como está el ejemplo no es muy útil, ya que los datos de la lista están fijos en el código. Sería interesante que los items se pudieran especificar desde fuera del componente (por ejemplo obtenidos del servidor) y además que la lista fuera modificable (por ejemplo ir "tachando" las cosas a medida que las vamos comprando). En los siguientes apartados veremos cómo se pueden conseguir estas funcionalidades a través de las <em>propiedades</em> y del <em>estado</em> del componente, respectivamente.</p>
</div>
<div class="sect3">
<h4 id="_componentes_personalizados_clases">6.2.1. Componentes personalizados. Clases.</h4>
<div class="paragraph">
<p>Usar como componente de nuestra aplicación directamente uno de los predefinidos en React puede ser divertido (ejem) pero tiene un alcance limitado, ya que la posible personalización se limita a especificar los atributos de la etiqueta HTML. Es mucho más útil poder controlar también su comportamiento, y para eso necesitaremos crear nuestra propia <em>clase</em> de componente.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&lt;</span><span class="tok-nx">script</span> <span class="tok-nx">src</span><span class="tok-o">=</span><span class="tok-s2">&quot;lib/react.js&quot;</span><span class="tok-o">&gt;&lt;</span><span class="tok-err">/script&gt;</span>
<span class="tok-o">&lt;</span><span class="tok-nx">script</span> <span class="tok-nx">src</span><span class="tok-o">=</span><span class="tok-s2">&quot;lib/react-dom.js&quot;</span><span class="tok-o">&gt;&lt;</span><span class="tok-err">/script&gt;</span>
<span class="tok-o">&lt;</span><span class="tok-nx">div</span> <span class="tok-nx">id</span><span class="tok-o">=</span><span class="tok-s2">&quot;miApp&quot;</span><span class="tok-o">&gt;&lt;</span><span class="tok-err">/div&gt;</span>
<span class="tok-o">&lt;</span><span class="tok-nx">script</span><span class="tok-o">&gt;</span>
    <span class="tok-kd">var</span> <span class="tok-nx">MiPrimerComponente</span> <span class="tok-o">=</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">createClass</span><span class="tok-p">({</span>  <i class="conum" data-value="1"></i><b>(1)</b>
      <span class="tok-nx">render</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-kd">var</span> <span class="tok-nx">mensaje</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;Soy un componente personalizado&quot;</span><span class="tok-p">;</span>
        <span class="tok-nx">mensaje</span> <span class="tok-o">+=</span>   <span class="tok-s2">&quot; (&quot;</span> <span class="tok-o">+</span> <span class="tok-nx">mensaje</span><span class="tok-p">.</span><span class="tok-nx">length</span> <span class="tok-o">+</span> <span class="tok-s2">&quot; caracteres )&quot;</span><span class="tok-p">;</span>
        <span class="tok-k">return</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">DOM</span><span class="tok-p">.</span><span class="tok-nx">h1</span><span class="tok-p">(</span><span class="tok-kc">null</span><span class="tok-p">,</span> <span class="tok-nx">mensaje</span><span class="tok-p">);</span>
      <span class="tok-p">}</span>
    <span class="tok-p">});</span>
    <span class="tok-kd">var</span> <span class="tok-nx">instancia</span> <span class="tok-o">=</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">createElement</span><span class="tok-p">(</span><span class="tok-nx">MiPrimerComponente</span><span class="tok-p">,</span> <span class="tok-kc">null</span><span class="tok-p">);</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-nx">ReactDOM</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">(</span><span class="tok-nx">instancia</span><span class="tok-p">,</span> <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s1">&#39;miApp&#39;</span><span class="tok-p">));</span>
<span class="tok-o">&lt;</span><span class="tok-err">/script&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Para crear un componente propio usamos <code>React.createClass</code>. Esta función acepta como parametro un literal JSON con las propiedades del componente.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Como mínimo el componente debería tener una función <code>render</code> que puede ejecutar el código que queramos y finalmente debe devolver un componente React como resultado.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Para crear una instancia de un componente propio usamos este método. El segundo parámetro vamos a dejarlo por el momento a <code>null</code> y posteriormente veremos su uso.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Como vemos la función <code>render</code> del componente es similar en espíritu a la del mismo nombre de Backbone. Con la diferencia, eso sí, de que con React no manipulamos directamente el DOM de la página, sino que trabajamos con una capa de abstracción por encima.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_componentes_sin_estado_propiedades">6.3. Componentes sin estado. Propiedades</h3>
<div class="paragraph">
<p>En el ejemplo anterior el mensaje que muestra el componente está fijado en el propio código, lo que claramente no es muy flexible. React permite que los componentes tengan <strong>propiedades</strong>, que podemos pasarle al componente cuando lo instanciamos. Las propiedades se especifican en forma de literal Javascript, y desde el componente serán accesibles a través de <code>this.props</code>. Veamos cómo reescribiríamos el ejemplo anterior para hacer uso de propiedades:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;script </span><span class="tok-na">src=</span><span class="tok-s">&quot;lib/react.js&quot;</span><span class="tok-nt">&gt;&lt;/script&gt;</span>
<span class="tok-nt">&lt;script </span><span class="tok-na">src=</span><span class="tok-s">&quot;lib/react-dom.js&quot;</span><span class="tok-nt">&gt;&lt;/script&gt;</span>
<span class="tok-nt">&lt;div</span> <span class="tok-na">id=</span><span class="tok-s">&quot;miApp&quot;</span><span class="tok-nt">&gt;&lt;/div&gt;</span>
<span class="tok-nt">&lt;script&gt;</span>
    <span class="tok-kd">var</span> <span class="tok-nx">MiComponente</span> <span class="tok-o">=</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">createClass</span><span class="tok-p">({</span>
      <span class="tok-nx">render</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
        <span class="tok-kd">var</span> <span class="tok-nx">mensaje</span> <span class="tok-o">=</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">props</span><span class="tok-p">.</span><span class="tok-nx">texto</span><span class="tok-p">;</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-nx">mensaje</span> <span class="tok-o">+=</span>   <span class="tok-s2">&quot; (&quot;</span> <span class="tok-o">+</span> <span class="tok-nx">mensaje</span><span class="tok-p">.</span><span class="tok-nx">length</span> <span class="tok-o">+</span> <span class="tok-s2">&quot; caracteres )&quot;</span><span class="tok-p">;</span>
        <span class="tok-k">return</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">DOM</span><span class="tok-p">.</span><span class="tok-nx">h1</span><span class="tok-p">(</span><span class="tok-kc">null</span><span class="tok-p">,</span> <span class="tok-nx">mensaje</span><span class="tok-p">);</span>
      <span class="tok-p">}</span>
    <span class="tok-p">});</span>
    <span class="tok-kd">var</span> <span class="tok-nx">instancia</span> <span class="tok-o">=</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">createElement</span><span class="tok-p">(</span><span class="tok-nx">MiComponente</span><span class="tok-p">,</span> <span class="tok-p">{</span><span class="tok-nx">texto</span><span class="tok-o">:</span><span class="tok-s1">&#39;Hola React&#39;</span><span class="tok-p">})</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-nx">ReactDOM</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">(</span><span class="tok-nx">instancia</span><span class="tok-p">,</span> <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s1">&#39;miApp&#39;</span><span class="tok-p">));</span>
<span class="tok-nt">&lt;/script&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Pasamos las propiedades en forma de literal JS. Es decir, las propiedades no son más que un objeto Javascript. En este caso dicho objeto tiene una propiedad llamada <code>texto</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Desde el componente accedemos a las propiedades con <code>this.props</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Según la filosofía de React <strong>las propiedades de un componente deberían ser solo de lectura</strong>. Por tanto no deberíamos modificar en el código del componente el valor de <code>this.props</code>. Como el valor de <code>props</code> no es en principio modificable, a este tipo de componentes se les denomina estáticos o <em>sin estado</em> (<em>stateless</em> ).</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Nada nos impide modificar <code>this.props</code>, bien directamente o bien a través del método <code>setProps</code>. En React modificar las propiedades de un componente durante su ciclo de vida se considera una mala práctica. Para almacenar datos que puedan cambiar durante la vida del componente usaremos el <em>estado</em>, como veremos en el siguiente apartado.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Veamos cómo trabajaríamos con un <code>props</code> algo más complicado. Volvamos al ejemplo de la lista de la compra y vamos a solucionar el primero de sus problemas: que los <em>items</em> de la lista están fijos en el código.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;script </span><span class="tok-na">src=</span><span class="tok-s">&quot;lib/react.js&quot;</span><span class="tok-nt">&gt;&lt;/script&gt;</span>
<span class="tok-nt">&lt;script </span><span class="tok-na">src=</span><span class="tok-s">&quot;lib/react-dom.js&quot;</span><span class="tok-nt">&gt;&lt;/script&gt;</span>
<span class="tok-nt">&lt;div</span> <span class="tok-na">id=</span><span class="tok-s">&quot;miApp&quot;</span><span class="tok-nt">&gt;&lt;/div&gt;</span>
<span class="tok-nt">&lt;script&gt;</span>
    <span class="tok-kd">var</span> <span class="tok-nx">ListaCompra</span> <span class="tok-o">=</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">createClass</span><span class="tok-p">({</span>
      <span class="tok-nx">render</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
        <span class="tok-k">return</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">DOM</span><span class="tok-p">.</span><span class="tok-nx">ul</span><span class="tok-p">(</span><span class="tok-kc">null</span><span class="tok-p">,</span>
          <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">props</span><span class="tok-p">.</span><span class="tok-nx">items</span><span class="tok-p">.</span><span class="tok-nx">map</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">item</span><span class="tok-p">)</span> <span class="tok-p">{</span>  <i class="conum" data-value="3"></i><b>(3)</b>
            <span class="tok-kd">var</span> <span class="tok-nx">texto</span> <span class="tok-o">=</span> <span class="tok-nx">item</span><span class="tok-p">.</span><span class="tok-nx">nombre</span> <span class="tok-o">+</span> <span class="tok-s1">&#39; (&#39;</span> <span class="tok-o">+</span> <span class="tok-nx">item</span><span class="tok-p">.</span><span class="tok-nx">cantidad</span> <span class="tok-o">+</span> <span class="tok-s1">&#39;)&#39;</span><span class="tok-p">;</span>
            <span class="tok-k">return</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">DOM</span><span class="tok-p">.</span><span class="tok-nx">li</span><span class="tok-p">(</span><span class="tok-kc">null</span><span class="tok-p">,</span> <span class="tok-nx">texto</span><span class="tok-p">);</span>
          <span class="tok-p">})</span>
        <span class="tok-p">);</span>
      <span class="tok-p">}</span>
    <span class="tok-p">});</span>
    <span class="tok-kd">var</span> <span class="tok-nx">lista</span> <span class="tok-o">=</span> <span class="tok-p">[{</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s1">&#39;huevos&#39;</span><span class="tok-p">,</span> <span class="tok-nx">cantidad</span><span class="tok-o">:</span><span class="tok-mi">12</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s1">&#39;pan&#39;</span><span class="tok-p">,</span> <span class="tok-nx">cantidad</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">}];</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-kd">var</span> <span class="tok-nx">instancia</span> <span class="tok-o">=</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">createElement</span><span class="tok-p">(</span><span class="tok-nx">ListaCompra</span><span class="tok-p">,</span> <span class="tok-p">{</span><span class="tok-nx">items</span><span class="tok-o">:</span> <span class="tok-nx">lista</span><span class="tok-p">});</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-nx">ReactDOM</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">(</span><span class="tok-nx">instancia</span><span class="tok-p">,</span> <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s1">&#39;miApp&#39;</span><span class="tok-p">));</span>
<span class="tok-nt">&lt;/script&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Por simplicidad definimos los datos de la lista directamente como una variable en nuestro código, pero idealmente vendrían del servidor como respuesta a una petición al API.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Pasamos la lista como la propiedad <code>items</code> del componente, por lo que dentro de él será accesible como <code>this.props.items</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Generamos el array de <code>React.DOM.li</code> a partir de la propiedad <code>items</code> usando el método de Javascript estándar llamado <code>map</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El <a href="https://developer.mozilla.org/es/docs/Web/JavaScript/Referencia/Objetos_globales/Array/map">método <code>map</code></a> no tiene nada que ver con React, es javascript "puro". Lo que hace es ejecutar una función para cada uno de los componentes del array e ir componiendo un nuevo array con los resultados que va devolviendo dicha función. En nuestro caso partimos del array <code>items</code> y queremos obtener un array de <code>React.DOM.li</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Si has usado alguna vez programación funcional probablemente recuerdes que <code>map</code> es típica de este paradigma. Podríamos haber empleado un bucle <code>for</code> convencional para generar el array de <code>React.DOM.li</code>, pero en casi todos los ejemplos de React que encontrarás por ahí se suele usar <code>map</code>. Una vez asimilado su uso produce un código bastante más elegante y compacto.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Te estarás dando cuenta de que conforme se va complicando el HTML del componente, crearlo usando el API de <code>React.DOM.*</code> se va haciendo cada vez más tedioso. Luego veremos una sintaxis alternativa denominada JSX que nos permite escribir directamente el HTML del componente, resultando en un código mucho más intuitivo.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si ejecutas el ejemplo anterior y abres la consola del desarrollador de tu navegador, verás un <em>warning</em> que dice "Each child in an array or iterator should have a unique "key" prop". Este mensaje nos está indicando que las etiquetas que forman parte de una colección de elementos deben tener un atributo <code>key</code> con un valor único que las identifique. El valor debe ser único dentro de la colección, no es necesario que lo sea dentro de la app de React. Afortunadamente, la función <em>map</em> nos pasa como segundo parámetro la posición actual dentro del array, que nos puede servir como valor para <code>key</code>. Así que arreglaremos el código dejándolo como sigue:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">ListaCompra</span> <span class="tok-o">=</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">createClass</span><span class="tok-p">({</span>
  <span class="tok-nx">render</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-k">return</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">DOM</span><span class="tok-p">.</span><span class="tok-nx">ul</span><span class="tok-p">(</span><span class="tok-kc">null</span><span class="tok-p">,</span>
      <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">props</span><span class="tok-p">.</span><span class="tok-nx">items</span><span class="tok-p">.</span><span class="tok-nx">map</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">item</span><span class="tok-p">,</span> <span class="tok-nx">pos</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-kd">var</span> <span class="tok-nx">texto</span> <span class="tok-o">=</span> <span class="tok-nx">item</span><span class="tok-p">.</span><span class="tok-nx">nombre</span> <span class="tok-o">+</span> <span class="tok-s1">&#39; (&#39;</span> <span class="tok-o">+</span> <span class="tok-nx">item</span><span class="tok-p">.</span><span class="tok-nx">cantidad</span> <span class="tok-o">+</span> <span class="tok-s1">&#39;)&#39;</span><span class="tok-p">;</span>
        <span class="tok-k">return</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">DOM</span><span class="tok-p">.</span><span class="tok-nx">li</span><span class="tok-p">({</span><span class="tok-nx">key</span><span class="tok-o">:</span><span class="tok-nx">pos</span><span class="tok-p">},</span> <span class="tok-nx">texto</span><span class="tok-p">);</span>
      <span class="tok-p">})</span>
    <span class="tok-p">);</span>
  <span class="tok-p">}</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_componentes_con_estado">6.4. Componentes con estado</h3>
<div class="paragraph">
<p>Para los componentes que vayan a ser interactivos necesitaremos probablemente mantener un <em>estado</em>. La diferencia entre estado y propiedades es que el primero puede cambiar durante el ciclo de vida del componente. Recordemos que las propiedades no deben cambiar.</p>
</div>
<div class="paragraph">
<p>Por ejemplo supongamos que en la lista de la compra queremos ir "tachando" las cosas a medida que las vamos comprando. Para cada <em>item</em> de la lista necesitaremos una variable booleana. Por tanto el estado del componente "lista de la compra" podría ser simplemente un array de valores booleanos.</p>
</div>
<div class="paragraph">
<p>El estado de un componente se guarda en una propiedad llamada <em>state</em>, que al estilo de <em>props</em> es simplemente un objeto Javascript con las propiedades que deseemos. Nuestro objetivo va a ser que visualmente los <em>items</em> ya comprados aparezcan "tachados". Para eso lo primero que definiremos en el HTML es el estilo CSS apropiado:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;head&gt;</span>
  <span class="tok-nt">&lt;style&gt;</span>
    <span class="tok-nc">.tachado</span> <span class="tok-p">{</span><span class="tok-k">text-decoration</span><span class="tok-o">:</span> <span class="tok-k">line-through</span><span class="tok-p">}</span>
  <span class="tok-nt">&lt;/style&gt;</span>
  <span class="tok-c">&lt;!-- aquí vendría el resto de tags que tengamos en el head --&gt;</span>
<span class="tok-nt">&lt;/head&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora modificaremos el <code>render</code> para que asigne la clase <code>tachado</code> a los items ya comprados, algo como:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">render</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-k">return</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">DOM</span><span class="tok-p">.</span><span class="tok-nx">ul</span><span class="tok-p">(</span><span class="tok-kc">null</span><span class="tok-p">,</span>
    <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">props</span><span class="tok-p">.</span><span class="tok-nx">items</span><span class="tok-p">.</span><span class="tok-nx">map</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">item</span><span class="tok-p">,</span> <span class="tok-nx">indice</span><span class="tok-p">)</span> <span class="tok-p">{</span>   <i class="conum" data-value="1"></i><b>(1)</b>
      <span class="tok-kd">var</span> <span class="tok-nx">texto</span> <span class="tok-o">=</span> <span class="tok-nx">item</span><span class="tok-p">.</span><span class="tok-nx">nombre</span> <span class="tok-o">+</span> <span class="tok-s1">&#39; (&#39;</span> <span class="tok-o">+</span> <span class="tok-nx">item</span><span class="tok-p">.</span><span class="tok-nx">cantidad</span> <span class="tok-o">+</span> <span class="tok-s1">&#39;)&#39;</span><span class="tok-p">;</span>
      <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">state</span><span class="tok-p">.</span><span class="tok-nx">comprados</span><span class="tok-p">[</span><span class="tok-nx">indice</span><span class="tok-p">])</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-k">return</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">DOM</span><span class="tok-p">.</span><span class="tok-nx">li</span><span class="tok-p">({</span><span class="tok-nx">className</span><span class="tok-o">:</span><span class="tok-s1">&#39;tachado&#39;</span><span class="tok-p">},</span> <span class="tok-nx">texto</span><span class="tok-p">);</span>
      <span class="tok-k">else</span> <span class="tok-p">{</span>
        <span class="tok-k">return</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">DOM</span><span class="tok-p">.</span><span class="tok-nx">li</span><span class="tok-p">(</span><span class="tok-kc">null</span><span class="tok-p">,</span> <span class="tok-nx">texto</span><span class="tok-p">);</span>
      <span class="tok-p">}</span>
    <span class="tok-p">}.</span><span class="tok-nx">bind</span><span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">))</span>  <i class="conum" data-value="3"></i><b>(3)</b>
  <span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Como el estado es un array que almacena los datos por posición del item en la lista de la compra, necesitamos saber el índice del item actual. Por suerte el <code>map</code> pasa automáticamente a su <em>callback</em> dicho índice como segundo parámetro.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>La propiedad <code>comprados</code> dentro de <code>this.state</code> es el array con los valores booleanos que indican si un item ha sido ya comprado o no. En caso de que haya sido comprado, devolvemos un <code>li</code> de la clase <code>tachado</code>. En caso contrario devolvemos un li "simple". Nótese que como estamos asignando el atributo <code>class</code> de HTML, que es una palabra reservada en Javascript, nos vemos obligados a cambiarla por <code>className</code>, que es la convención habitual.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Nos hemos visto obligados a añadir el <code>bind(this)</code> al <em>callback</em> ya que si no lo hacíamos el contexto de ejecución del mismo (su valor de <code>this</code>) acababa siendo <code>window</code>.  Nosotros queremos que <code>this</code> sea el componente porque ahora necesitamos acceder a <code>this.state</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Nos queda por atar un par de "cabos sueltos": ¿Cómo se modifica el estado y cómo se fija su valor inicial?.</p>
</div>
<div class="paragraph">
<p>Fijar el valor inicial del estado es bastante sencillo: un componente con estado debería definir una función llamada <code>getInitialState</code> que devolviera el estado inicial. En nuestro caso algo como:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">getInitialState</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-k">return</span> <span class="tok-p">{</span><span class="tok-nx">comprados</span><span class="tok-o">:</span> <span class="tok-k">new</span> <span class="tok-nb">Array</span><span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">props</span><span class="tok-p">.</span><span class="tok-nx">items</span><span class="tok-p">.</span><span class="tok-nx">length</span><span class="tok-p">)}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Es decir, creamos un array de tantos elementos como tengamos en la lista de la compra (propiedad <code>items</code> del componente). No necesitamos inicializar el array ya que contendrá <code>undefined</code> y recordemos que en términos booleanos esto es lo mismo que <code>false</code>.</p>
</div>
<div class="paragraph">
<p>Con respecto a modificar el estado, hay dos cosas de las que hablar: cómo se hace en el API de React y cómo se implemente a nivel de interfaz de usuario. Con respecto a esto último. probablemente en una aplicación real cada item sería "pulsable" o tendría una casilla de verificación para cambiar su estado. No obstante la parte de la interfaz la vamos a dejar de lado por el momento para no complicarnos con el manejo de eventos en React. Por ahora baste con saber que en el API de React para cambiar el estado se usa el método <code>setState</code>, pasándole un objeto con las propiedades que queramos modificar</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">setState</span><span class="tok-p">({</span><span class="tok-nx">comprados</span><span class="tok-o">:</span><span class="tok-p">[</span><span class="tok-kc">true</span><span class="tok-p">,</span> <span class="tok-kc">false</span><span class="tok-p">]})</span></code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
no hay que cambiar nunca el estado directamente accediendo a <code>this.state</code>, siempre hay que hacerlo a través de la llamada a <code>setState</code>, ahora mismo veremos por qué.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Como no tenemos por el momento un mecanismo para que el usuario final pueda marcar un item como comprado tendremos que hacer un poco de "trampa" y manipular el componente desde la consola Javascript. El componente React es en realidad el resultado que devuelve la llamada a <code>ReactDOM.render</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">componente</span> <span class="tok-o">=</span> <span class="tok-nx">ReactDOM</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">(</span><span class="tok-nx">instancia</span><span class="tok-p">,</span> <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s1">&#39;miApp&#39;</span><span class="tok-p">));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora si abrimos la consola Javascript del navegador podemos hacer algo como:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">componente</span><span class="tok-p">.</span><span class="tok-nx">setState</span><span class="tok-p">({</span><span class="tok-nx">comprado</span><span class="tok-o">:</span><span class="tok-p">[</span><span class="tok-kc">true</span><span class="tok-p">,</span> <span class="tok-kc">false</span><span class="tok-p">]})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si probamos esto experimentaremos por fin la parte más <em>cool</em> de React: la llamada a <code>setState</code> desencadena automáticamente un <em>repintado</em> del componente. Nuestra función <code>render</code> se vuelve a llamar de nuevo, como podríamos comprobar si insertáramos en ella un <code>console.log</code>. Y por tanto la lista aparece con el primer componente tachado.</p>
</div>
<div class="paragraph">
<p>Podríamos pensar que ejecutar el <code>render</code> entero cada vez que cambie el estado es extremadamente ineficiente, pero en una función de este tipo el cuello de botella va a estar en la manipulación del DOM y no en el resto de código (salvo que el código de <code>render</code> hiciera cómputos costosos, lo que normalmente no es el caso, y de darse sería una mala práctica). Nótese que con React no manipulamos directamente el DOM sino que usamos objetos propios del <em>framework</em> (<code>React.DOM.*</code>), lo que en React se denomina el <em>DOM virtual</em>. Lo que va a hacer React es a partir de este DOM virtual calcular automáticamente la <em>transformación mínima que se debería hacer en el DOM "real"</em> para obtener el resultado deseado. Es decir, si hemos cambiado el estado únicamente del primer item no hace falta modificar todo el <code>ul</code>, solo el primer <code>li</code>. Y esto es lo que va a calcular React automáticamente para nosotros en cada cambio de estado del componente.</p>
</div>
<div class="paragraph">
<p>Podemos usar las <a href="http://facebook.github.io/react/docs/perf.html">herramientas de medición de rendimiento</a> de React (<code>React.addons.Perf</code>) para comprobar qué está haciendo para actualizar la interfaz:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">addons</span><span class="tok-p">.</span><span class="tok-nx">Perf</span><span class="tok-p">.</span><span class="tok-nx">start</span><span class="tok-p">();</span>
<span class="tok-nx">componente</span><span class="tok-p">.</span><span class="tok-nx">setState</span><span class="tok-p">({</span><span class="tok-nx">comprado</span><span class="tok-o">:</span><span class="tok-p">[</span><span class="tok-kc">true</span><span class="tok-p">,</span> <span class="tok-kc">false</span><span class="tok-p">]});</span>
<span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">addons</span><span class="tok-p">.</span><span class="tok-nx">Perf</span><span class="tok-p">.</span><span class="tok-nx">stop</span><span class="tok-p">();</span>
<span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">addons</span><span class="tok-p">.</span><span class="tok-nx">Perf</span><span class="tok-p">.</span><span class="tok-nx">printDOM</span><span class="tok-p">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para poder usar las herramientas de medición de rendimiento hay que incluir el <em>script</em> <code>react-with-addons.js</code> en lugar del <code>react.js</code> original.</p>
</div>
<div class="paragraph">
<p>Con las llamadas a <code>start()</code> y <code>stop()</code> comienza y termina el bloque de código en que queremos las medidas. Una vez ejecutado el <code>stop</code> podemos ver distintas tablas de rendimiento, por ejemplo <code>printDOM()</code> imprime las modificaciones que React ha tenido que hacer en el DOM para actualizar la interfaz (figura 1). Nótese que solo ha modificado el elemento necesario, no el resto. Además React ha hecho un "buen trabajo" ya que ha detectado que el único cambio necesario era añadir la clase "tachado" a la etiqueta.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/06/printDOMLista.png" alt="printDOMLista" width="66%">
</div>
<div class="title">Figure 5. Operaciones sobre el DOM para actualizar la interfaz de la "lista de la compra"</div>
</div>
<div class="paragraph">
<p>Es fácil de adivinar que la "prohibición" de modificar directamente la variable <code>state</code> es porque si cambiamos directamente la variable React no está "informado" de que el estado ha cambiado, mientras que al llamar a <code>setState</code> se lo estamos indicando.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<code>setState</code> no tiene por qué desencadenar un cambio inmediato del estado. Si en nuestro código llamamos a <code>setState</code> e inmediatamente después accedemos a <code>this.state</code> es posible que nos encontremos con que este no ha cambiado todavía. Por cuestiones de eficiencia React determina cuándo cambiar de manera efectiva el estado, en <em>batches</em>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_interactividad_eventos">6.5. Interactividad. Eventos</h3>
<div class="paragraph">
<p>Recapitulemos primero sobre cómo se tratan los eventos de la interfaz de usuario en aplicaciones no React. En la mayoría de los casos (aunque no siempre) los cambios en la interfaz se desencadenan como consecuencia de acciones del usuario, por ejemplo un <em>clic</em> sobre un botón. En Javascript ya estamos acostumbrados a modelar dichas acciones como eventos y a tratarlas con manejadores de eventos. La forma clásica de definir estos manejadores en la web es usando la familia de atributos HTML <code>on_xxx</code>, por ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;p</span> <span class="tok-na">onClick=</span><span class="tok-s">&quot;alert(&#39;has hecho clic&#39;)&quot;</span><span class="tok-nt">&gt;</span>Hola<span class="tok-nt">&lt;/p&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En React vamos a definir los manejadores de eventos de forma similar (aunque como veremos es similar solo en la sintaxis, pero no así en el funcionamiento interno). Al igual que podemos definir cualquier atributo HTML de un componente de <code>React.DOM</code> en sus propiedades, podemos hacer lo propio con los manejadores de evento asociados:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;div</span> <span class="tok-na">id=</span><span class="tok-s">&quot;miApp&quot;</span><span class="tok-nt">&gt;&lt;/div&gt;</span>
<span class="tok-nt">&lt;script&gt;</span>
  <span class="tok-kd">var</span> <span class="tok-nx">MiComponente</span> <span class="tok-o">=</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">createClass</span><span class="tok-p">({</span>
    <span class="tok-nx">saludar</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>  <i class="conum" data-value="1"></i><b>(1)</b>
      <span class="tok-nx">alert</span><span class="tok-p">(</span><span class="tok-s1">&#39;Has hecho clic&#39;</span><span class="tok-p">);</span>
    <span class="tok-p">},</span>
    <span class="tok-nx">render</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
      <span class="tok-k">return</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">DOM</span><span class="tok-p">.</span><span class="tok-nx">h1</span><span class="tok-p">({</span><span class="tok-nx">onClick</span><span class="tok-o">:</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">saludar</span><span class="tok-p">},</span> <span class="tok-s1">&#39;Hola&#39;</span><span class="tok-p">);</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-p">}</span>
  <span class="tok-p">});</span>
  <span class="tok-kd">var</span> <span class="tok-nx">instancia</span> <span class="tok-o">=</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">createElement</span><span class="tok-p">(</span><span class="tok-nx">MiComponente</span><span class="tok-p">,</span> <span class="tok-kc">null</span><span class="tok-p">)</span>
  <span class="tok-nx">ReactDOM</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">(</span><span class="tok-nx">instancia</span><span class="tok-p">,</span> <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s1">&#39;miApp&#39;</span><span class="tok-p">));</span>
<span class="tok-nt">&lt;/script&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Definimos el manejador de evento como una función en nuestro componente</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Asociamos el evento con el manejador dando el valor para el correspondiente atributo <code>onXxx</code>. Nótese que React usa la sintaxis "camel case" para este atributo.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Visto así parece que React usa simplemente la sintaxis clásica para definir manejadores de evento, adaptada a las necesidades del <em>framework</em>, pero en realidad hay mucho más.</p>
</div>
<div class="paragraph">
<p>Por un lado, <strong>el API de React usa <em>eventos sintéticos</em></strong>, es decir el desarrollador no está tratando directamente con los eventos nativos del navegador, sino con una fina capa de abstracción que uniformiza el tratamiento  de los eventos independientemente de la compatibilidad del navegador (un poco al estilo jQuery). Así, todos los manejadores de evento reciben automáticamente un objeto con las propiedades del evento, al estilo W3C, y dichas propiedades serán <a href="https://facebook.github.io/react/docs/events.html">las mismas en todos los navegadores</a>.</p>
</div>
<div class="paragraph">
<p>Por otro lado, da la impresión de que estamos asociando directamente el manejador de evento a la etiqueta HTML correspondiente cuando en realidad no es así. <strong>React usa automáticamente <em>delegación de eventos</em></strong>, lo que quiere decir que vincula los manejadores de evento al nivel superior del DOM. Este es un método de gestión de eventos mucho más eficiente que vincular los manejadores a los nodos del DOM directamente implicados (pensemos por ejemplo qué pasaría con un evento clic al que tiene que responder cada fila de una tabla). Para ver con más detalle cómo funciona la delegación de eventos se puede consultar <a href="https://davidwalsh.name/event-delegate">este artículo</a>, referenciado en la documentación de React.</p>
</div>
<div class="paragraph">
<p>Vamos a aplicar esto a nuestro ejemplo de la lista de la compra. Queremos que cada vez que se pulse sobre un item este cambie de estado (de no comprado a comprado, y viceversa)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;script </span><span class="tok-na">src=</span><span class="tok-s">&quot;lib/react-with-addons.js&quot;</span><span class="tok-nt">&gt;&lt;/script&gt;</span>
<span class="tok-nt">&lt;script </span><span class="tok-na">src=</span><span class="tok-s">&quot;lib/react-dom.js&quot;</span><span class="tok-nt">&gt;&lt;/script&gt;</span>
<span class="tok-nt">&lt;div</span> <span class="tok-na">id=</span><span class="tok-s">&quot;miApp&quot;</span><span class="tok-nt">&gt;&lt;/div&gt;</span>
<span class="tok-nt">&lt;script&gt;</span>
    <span class="tok-kd">var</span> <span class="tok-nx">ListaCompra</span> <span class="tok-o">=</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">createClass</span><span class="tok-p">({</span>
      <span class="tok-nx">getInitialState</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
        <span class="tok-k">return</span> <span class="tok-p">{</span><span class="tok-nx">comprados</span><span class="tok-o">:</span> <span class="tok-k">new</span> <span class="tok-nb">Array</span><span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">props</span><span class="tok-p">.</span><span class="tok-nx">items</span><span class="tok-p">.</span><span class="tok-nx">length</span><span class="tok-p">)}</span>
      <span class="tok-p">},</span>
      <span class="tok-nx">toggle</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">indice</span><span class="tok-p">)</span> <span class="tok-p">{</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-kd">var</span> <span class="tok-nx">compradosNew</span> <span class="tok-o">=</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">state</span><span class="tok-p">.</span><span class="tok-nx">comprados</span><span class="tok-p">.</span><span class="tok-nx">slice</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">);</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">state</span><span class="tok-p">.</span><span class="tok-nx">comprados</span><span class="tok-p">[</span><span class="tok-nx">indice</span><span class="tok-p">])</span>  <i class="conum" data-value="3"></i><b>(3)</b>
          <span class="tok-nx">compradosNew</span><span class="tok-p">[</span><span class="tok-nx">indice</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-kc">false</span><span class="tok-p">;</span>
        <span class="tok-k">else</span> <span class="tok-p">{</span>
          <span class="tok-nx">compradosNew</span><span class="tok-p">[</span><span class="tok-nx">indice</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-kc">true</span><span class="tok-p">;</span>
        <span class="tok-p">}</span>
        <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">setState</span><span class="tok-p">({</span><span class="tok-nx">comprados</span><span class="tok-o">:</span> <span class="tok-nx">compradosNew</span><span class="tok-p">});</span> <i class="conum" data-value="4"></i><b>(4)</b>
      <span class="tok-p">},</span>
      <span class="tok-nx">render</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
        <span class="tok-k">return</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">DOM</span><span class="tok-p">.</span><span class="tok-nx">ul</span><span class="tok-p">(</span><span class="tok-kc">null</span><span class="tok-p">,</span>
          <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">props</span><span class="tok-p">.</span><span class="tok-nx">items</span><span class="tok-p">.</span><span class="tok-nx">map</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">item</span><span class="tok-p">,</span> <span class="tok-nx">indice</span><span class="tok-p">)</span> <span class="tok-p">{</span>
            <span class="tok-kd">var</span> <span class="tok-nx">texto</span> <span class="tok-o">=</span> <span class="tok-nx">item</span><span class="tok-p">.</span><span class="tok-nx">nombre</span> <span class="tok-o">+</span> <span class="tok-s1">&#39; (&#39;</span> <span class="tok-o">+</span> <span class="tok-nx">item</span><span class="tok-p">.</span><span class="tok-nx">cantidad</span> <span class="tok-o">+</span> <span class="tok-s1">&#39;)&#39;</span><span class="tok-p">;</span>
            <span class="tok-kd">var</span> <span class="tok-nx">atribs</span> <span class="tok-o">=</span> <span class="tok-p">{</span><span class="tok-nx">onClick</span><span class="tok-o">:</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">toggle</span><span class="tok-p">.</span><span class="tok-nx">bind</span><span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">,</span><span class="tok-nx">indice</span><span class="tok-p">),</span> <span class="tok-nx">key</span><span class="tok-o">:</span><span class="tok-nx">indice</span><span class="tok-p">}</span>
            <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">state</span><span class="tok-p">.</span><span class="tok-nx">comprados</span><span class="tok-p">[</span><span class="tok-nx">indice</span><span class="tok-p">])</span> <span class="tok-p">{</span>
              <span class="tok-nx">atribs</span><span class="tok-p">.</span><span class="tok-nx">className</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;tachado&#39;</span><span class="tok-p">;</span>
              <span class="tok-k">return</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">DOM</span><span class="tok-p">.</span><span class="tok-nx">li</span><span class="tok-p">(</span><span class="tok-nx">atribs</span><span class="tok-p">,</span> <span class="tok-nx">texto</span><span class="tok-p">);</span>
            <span class="tok-p">}</span>
            <span class="tok-k">else</span> <span class="tok-p">{</span>
              <span class="tok-k">return</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">DOM</span><span class="tok-p">.</span><span class="tok-nx">li</span><span class="tok-p">(</span><span class="tok-nx">atribs</span><span class="tok-p">,</span> <span class="tok-nx">texto</span><span class="tok-p">);</span>
            <span class="tok-p">}</span>
          <span class="tok-p">}.</span><span class="tok-nx">bind</span><span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">))</span>
        <span class="tok-p">);</span>
      <span class="tok-p">}</span>
    <span class="tok-p">});</span>
    <span class="tok-kd">var</span> <span class="tok-nx">lista</span> <span class="tok-o">=</span> <span class="tok-p">[{</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s1">&#39;huevos&#39;</span><span class="tok-p">,</span> <span class="tok-nx">cantidad</span><span class="tok-o">:</span><span class="tok-mi">12</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s1">&#39;pan&#39;</span><span class="tok-p">,</span> <span class="tok-nx">cantidad</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">}];</span>
    <span class="tok-kd">var</span> <span class="tok-nx">instancia</span> <span class="tok-o">=</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">createElement</span><span class="tok-p">(</span><span class="tok-nx">ListaCompra</span><span class="tok-p">,</span> <span class="tok-p">{</span><span class="tok-nx">items</span><span class="tok-o">:</span> <span class="tok-nx">lista</span><span class="tok-p">});</span>
    <span class="tok-nx">ReactDOM</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">(</span><span class="tok-nx">instancia</span><span class="tok-p">,</span> <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s1">&#39;miApp&#39;</span><span class="tok-p">));</span>
<span class="tok-nt">&lt;/script&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Nuestro manejador de evento se ocupa de cambiar el estado correspondiente al item en que hemos hecho <em>clic</em>. Recibe como parámetro el indice de dicho item, en un momento veremos cómo se lo hemos pasado.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Clonamos el array con la información sobre productos comprados. Un truco muy habitual en Javascript es usar el método <code>slice</code>, que nos devuelve una copia de una porción de un array (o del array entero si pasamos 0 como índice).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Cambiamos el estado del item en que hemos hecho clic de <code>true</code> a <code>false</code> o viceversa.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Cambiamos el estado pasándole el nuevo array a <code>setState</code>. Esta llamada desencadenará el repintado del componente.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_jsx">6.6. JSX</h3>
<div class="paragraph">
<p>Habrás visto que el código del método <code>render</code> se complica mucho conforme se va complicando el HTML a generar. Se hace cada vez más tedioso usar el API Javascript para generar HTML. Es el mismo problema que tiene el API del DOM estándar cuando necesitamos generar HTML dinámicamente con él.</p>
</div>
<div class="paragraph">
<p>En React existe una sintaxis alternativa, llamada <strong>JSX</strong>, que nos permite mezclar fragmentos de HTML (XML, en realidad) con código JS de manera mucho más natural y concisa que con el API anterior.  Por eso el código que hemos visto hasta el momento no es "nada típico" en los ejemplos, libros y tutoriales de React que puedes ver por ahí.</p>
</div>
<div class="paragraph">
<p>Así, recordemos nuestro primer ejemplo de "Hola React"</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;div</span> <span class="tok-na">id=</span><span class="tok-s">&quot;miApp&quot;</span><span class="tok-nt">&gt;&lt;/div&gt;</span>
<span class="tok-nt">&lt;script&gt;</span>
  <span class="tok-kd">var</span> <span class="tok-nx">miComponente</span> <span class="tok-o">=</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">DOM</span><span class="tok-p">.</span><span class="tok-nx">h1</span><span class="tok-p">({</span><span class="tok-nx">id</span><span class="tok-o">:</span><span class="tok-s2">&quot;saludo&quot;</span><span class="tok-p">},</span> <span class="tok-s1">&#39;¡Hola React!&#39;</span><span class="tok-p">);</span>
  <span class="tok-nx">ReactDOM</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">(</span><span class="tok-nx">miComponente</span><span class="tok-p">,</span> <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s1">&#39;miApp&#39;</span><span class="tok-p">));</span>
<span class="tok-nt">&lt;/script&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lo podríamos reescribir usando JSX del siguiente modo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;script </span><span class="tok-na">src=</span><span class="tok-s">&quot;react.js&quot;</span><span class="tok-nt">&gt;&lt;/script&gt;</span>   
<span class="tok-nt">&lt;script </span><span class="tok-na">src=</span><span class="tok-s">&quot;react-dom.js&quot;</span><span class="tok-nt">&gt;&lt;/script&gt;</span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-nt">&lt;script </span><span class="tok-na">src=</span><span class="tok-s">&quot;https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js&quot;</span><span class="tok-nt">&gt;&lt;/script&gt;</span>
<span class="tok-nt">&lt;div</span> <span class="tok-na">id=</span><span class="tok-s">&quot;miApp&quot;</span><span class="tok-nt">&gt;&lt;/div&gt;</span>
<span class="tok-nt">&lt;script </span><span class="tok-na">type=</span><span class="tok-s">&quot;text/babel&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-kd">var</span> <span class="tok-nx">saludo</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;Hola&quot;</span><span class="tok-p">;</span>
    <span class="tok-kd">var</span> <span class="tok-nx">miComponente</span> <span class="tok-o">=</span> <span class="tok-o">&lt;</span><span class="tok-nx">h1</span> <span class="tok-nx">id</span><span class="tok-o">=</span><span class="tok-s2">&quot;saludo&quot;</span><span class="tok-o">&gt;</span><span class="tok-err">¡</span><span class="tok-p">{</span><span class="tok-nx">saludo</span><span class="tok-p">}</span> <span class="tok-nx">React</span><span class="tok-o">!&lt;</span><span class="tok-err">/h1&gt;;</span>
    <span class="tok-nx">ReactDOM</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">(</span><span class="tok-nx">miComponente</span><span class="tok-p">,</span><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s1">&#39;miApp&#39;</span><span class="tok-p">));</span>
<span class="tok-nt">&lt;/script&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lo más notable del ejemplo es que estamos escribiendo directamente el HTML que queremos generar, en lugar de usar un API Javascript.</p>
</div>
<div class="paragraph">
<p>Además hemos aprovechado para insertar JS en medio del HTML para que se vea que es posible hacerlo, sin más que rodearlo de llaves <code>{&#8230;&#8203;}</code>. Por lo demás el código es funcionalmente equivalente al ejemplo que no usa JSX, solo que con una sintaxis mucho más concisa y cómoda de usar.</p>
</div>
<div class="paragraph">
<p>Por otro lado podemos ver que referenciamos un <code>&lt;script&gt;</code> externo adicional y que además hemos añadido un atributo <code>type="text/babel"</code> a nuestro código. Explicaremos esto en el siguiente apartado.</p>
</div>
<div class="sect3">
<h4 id="_de_jsx_a_js">6.6.1. De JSX a JS</h4>
<div class="paragraph">
<p>Escribir código JSX no es simplemente concatenar cadenas de HTML dentro del JS. Nótese que <em>el HTML está tal cual dentro del código, sin delimitadores</em>. Por eso este <em>script</em> no encaja con la sintaxis JS estándar y de ahí que en el <code>type</code> del <em>script</em> se haya puesto el valor especial <code>text/babel</code>. Hay que incluir una librería adicional para <em>parsear</em> el JSX y transformarlo automáticamente a JS convencional, resultando en algo del estilo de la versión "antigua" de nuestro "Hola React". Las etiquetas tipo HTML se convierten en llamadas a  <code>React.CreateElement</code>. El proceso de traducción de JSX a JS se denomina "transpilación". Aquí tenemos un ejemplo de cómo se traduciría</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-c1">// Original (JSX):</span>
<span class="tok-kd">var</span> <span class="tok-nx">app</span> <span class="tok-o">=</span> <span class="tok-o">&lt;</span><span class="tok-nx">div</span> <span class="tok-nx">className</span><span class="tok-o">=</span><span class="tok-s2">&quot;pie&quot;</span> <span class="tok-o">/&gt;</span><span class="tok-p">;</span>
<span class="tok-c1">// Resultado (JS):</span>
<span class="tok-kd">var</span> <span class="tok-nx">app</span> <span class="tok-o">=</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">createElement</span><span class="tok-p">(</span><span class="tok-s1">&#39;div&#39;</span><span class="tok-p">,</span> <span class="tok-p">{</span><span class="tok-nx">className</span><span class="tok-o">:</span><span class="tok-s2">&quot;pie&quot;</span><span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Hay que acordarse del <code>type="text/babel"</code> en el <em>tag</em> <code>script</code>, siempre que escribamos código JSX y queramos que lo transforme a JS el propio navegador.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para que el navegador transpile el JSX a JS "sobre la marcha" simplemente incluimos en el HTML la librería adecuada. En versiones antiguas de React esto se hacía en una librería propia denominada JSXTransformer. A partir de la versión 0.14 se hace con una librería de terceros denominada <a href="http://babeljs.io">Babel</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;script </span><span class="tok-na">src=</span><span class="tok-s">&quot;https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js&quot;</span><span class="tok-nt">&gt;&lt;/script&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Babel es un proyecto <em>open source</em> ampliamente conocido y usado en la web, ya que no solo hace <em>transpilación</em> de JSX a JS, sino también de ES6 a ES5, permitiéndonos usar la nueva sintaxis JS en los navegadores actuales, aunque no ofrezcan soporte nativo.</p>
</div>
<div class="paragraph">
<p>En aplicaciones en producción, por eficiencia no se recomienda hacer la <em>transpilación</em> desde el propio navegador, sino realizarla <em>offline</em> como parte del proceso de construcción de la aplicación, e incluir en el HTML el JS ya transformado. Se recomienda consultar la documentación de React para ver más detalles sobre el proceso.</p>
</div>
<div class="paragraph">
<p>Aquí tenemos otro ejemplo un poco más complicado para ilustrar cómo mezclar JSX y JS, el componente <code>ListaCompra</code> (sin estado y sin eventos, para simplificar el código). Nótese que se pueden introducir variables y fragmentos de código JS entre llaves <code>{&#8230;&#8203;}</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html">var ListaCompra = React.createClass({
      render: function() {
        var items = this.props.items.map(function(item, indice){
          return <span class="tok-nt">&lt;li</span> <span class="tok-na">key=</span><span class="tok-s">{indice}</span><span class="tok-nt">&gt;</span> {item.nombre} ({item.cantidad}) <span class="tok-nt">&lt;/li&gt;</span>
        });
        return <span class="tok-nt">&lt;ul&gt;</span>{items}<span class="tok-nt">&lt;/ul&gt;</span>
      }
});

var lista = [{nombre:&#39;huevos&#39;, cantidad:12}, {nombre:&#39;pan&#39;, cantidad:1}];
var instancia = <span class="tok-nt">&lt;ListaCompra</span> <span class="tok-na">items=</span><span class="tok-s">{lista}/</span><span class="tok-nt">&gt;</span>;
var componente = ReactDOM.render(instancia, document.getElementById(&#39;miApp&#39;));</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nótese que cuando creamos un componente React, en JSX estamos "creando" la etiqueta equivalente, que podemos usar en nuestro código. En nuestro caso hemos creado una etiqueta <code>&lt;ListaCompra&gt;</code>. Para pasarle <code>props</code> al componente usamos atributos con el mismo nombre.</p>
</div>
</div>
<div class="sect3">
<h4 id="__gotchas_de_jsx">6.6.2. "Gotchas" de JSX</h4>
<div class="paragraph">
<p>Vamos a ver algunas pequeñas pegas o problemas que se nos pueden plantear en el uso de JSX.</p>
</div>
<div class="paragraph">
<p>La primera cuestión importante es que <strong>JSX usa sintaxis XML, no HTML</strong>. Eso significa que todas las etiquetas deben abrirse y cerrarse. En HTML el cierre de algunas es opcional, por ejemplo el de <code>&lt;p&gt;</code>. Los atributos HTML deben usar sintaxis <em>camel case</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html">//(...en una función render)
//¡¡no va a funcionar!!
return <span class="tok-nt">&lt;a</span> <span class="tok-na">onclick=</span><span class="tok-s">{this.saludar}</span> <span class="tok-na">href=</span><span class="tok-s">&#39;#&#39;</span><span class="tok-nt">&gt;</span>Clicame<span class="tok-nt">&lt;/a&gt;</span>;
//pero esto sí
return <span class="tok-nt">&lt;a</span> <span class="tok-na">onClick=</span><span class="tok-s">{this.saludar}</span> <span class="tok-na">href=</span><span class="tok-s">&#39;#&#39;</span><span class="tok-nt">&gt;</span>Clicame<span class="tok-nt">&lt;/a&gt;</span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Otra cosa a tener en cuenta es que <strong>el <code>render</code> solo debe devolver una única etiqueta de "nivel superior"</strong>. Es decir, esto no es legal en un <code>render</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html">return (
  <span class="tok-nt">&lt;span&gt;</span>Hola<span class="tok-nt">&lt;/span&gt;</span>
  <span class="tok-nt">&lt;span&gt;</span>mundo<span class="tok-nt">&lt;/span&gt;</span>
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Pero esto sí</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html">return (
  <span class="tok-nt">&lt;div&gt;</span>
    <span class="tok-nt">&lt;span&gt;</span>Hola<span class="tok-nt">&lt;/span&gt;</span>
    <span class="tok-nt">&lt;span&gt;</span>mundo<span class="tok-nt">&lt;/span&gt;</span>
  <span class="tok-nt">&lt;/div&gt;</span>
)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_el_operador_spread">6.6.3. El operador "spread"</h4>
<div class="paragraph">
<p>Es sencillo tomar los valores de los atributos HTML de variables Javascript. Como hemos visto, solo hay que usar la sintaxis <code>{}</code>. Por ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html">render: function() {
  var url = &#39;http://expertojava.ua.es&#39;;
  var destino = &#39;_blank&#39;;
  return <span class="tok-nt">&lt;a</span> <span class="tok-na">href=</span><span class="tok-s">{url}</span> <span class="tok-na">target=</span><span class="tok-s">{destino}</span><span class="tok-nt">&gt;</span>Experto Java<span class="tok-nt">&lt;/a&gt;</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Lo que sucede es que si el número de atributos es muy grande puede llegar a ser un poco tedioso ir poniéndolos todos. Para simplificar esto, podemos usar una funcionalidad que JSX toma prestada de ES6 denominada el <em>spread operator</em> o el operador <code>&#8230;&#8203;</code>. Creamos un objeto con las propiedades correspondientes a los atributos y estos se asignarán automáticamente, por nombre.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-nx">render</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-kd">var</span> <span class="tok-nx">enlace</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
    <span class="tok-nx">href</span><span class="tok-o">:</span> <span class="tok-s1">&#39;http://expertojava.ua.es&#39;</span><span class="tok-p">,</span>
    <span class="tok-nx">target</span><span class="tok-o">:</span> <span class="tok-s1">&#39;_blank&#39;</span>
  <span class="tok-p">};</span>
  <span class="tok-k">return</span> <span class="tok-o">&lt;</span><span class="tok-nx">a</span> <span class="tok-p">{...</span><span class="tok-nx">enlace</span><span class="tok-p">}</span><span class="tok-o">&gt;</span><span class="tok-nx">Experto</span> <span class="tok-nx">Java</span><span class="tok-o">&lt;</span><span class="tok-err">/a&gt;;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nótese que hemos tenido que cambiar los nombres de las variables para que coincidan con los atributos de la etiqueta <code>&lt;a&gt;</code>, pero es un pequeño precio a pagar por la simplificación de la sintaxis.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_manejo_de_formularios">6.7. Manejo de formularios</h3>
<div class="paragraph">
<p>Los formularios tienen algunas peculiaridades en React con respecto a lo que es habitual en el DOM nativo. Vamos a verlas.</p>
</div>
<div class="paragraph">
<p>Los componentes en los que hay diferencias son los interactivos, como <code>&lt;input&gt;</code>, <code>&lt;textarea&gt;</code> o <code>&lt;option&gt;</code>. Estos componentes soportan varias <code>props</code> a las que afectan las interacciones del usuario:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>value</code>: al igual que en HTML para los <code>&lt;input&gt;</code>, y en React se usa también para <code>&lt;textarea&gt;</code> por consistencia (recordemos que en HTML es el contenido de la etiqueta).</p>
</li>
<li>
<p><code>checked</code>: para los <code>&lt;input&gt;</code> de tipo <code>checkbox</code> o <code>radio</code>.</p>
</li>
<li>
<p><code>selected</code>: para los <code>&lt;option&gt;</code>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_componentes_controlados">6.7.1. Componentes controlados</h4>
<div class="paragraph">
<p>Los componentes para los que especificamos estas <code>props</code> se dice que son <strong>controlados</strong>. La interacción del usuario no tendrá un efecto directo sobre ellos. Es decir, si tenemos un componente cuyo <code>render</code> es así:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html">render: function() {
  return <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;hola&quot;</span><span class="tok-nt">/&gt;</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Estamos especificando que el valor del campo sea <em>siempre</em> "hola", por lo que React no "hará caso" a lo que el usuario quiera modificar en el campo. Nótese que en HTML el atributo <code>value</code> significa el valor inicial, pero en React significa el valor, en cualquier momento. Si queremos especificar el valor inicial podemos usar la <code>prop</code> llamada <code>defaultValue.</code></p>
</div>
<div class="paragraph">
<p>Si queremos que la interacción del usuario tenga efecto sobre un componente controlado, tenemos que hacerlo explícitamente usando los eventos, por ejemplo, para hacer que se pueda escribir en un campo de texto controlado lo que haremos será que el <code>value</code> dependa del estado actual e ir cambiando el estado a medida que el usuario va tecleando (evento <code>onChange</code>). Este evento se dispara con cada pulsación de tecla, a diferencia del <code>onChange</code> de HTML:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">MiForm</span> <span class="tok-o">=</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">createClass</span><span class="tok-p">({</span>
  <span class="tok-nx">getInitialState</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-k">return</span> <span class="tok-p">{</span><span class="tok-nx">value</span><span class="tok-o">:</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">props</span><span class="tok-p">.</span><span class="tok-nx">texto</span><span class="tok-p">};</span>
  <span class="tok-p">},</span>
  <span class="tok-nx">handleChange</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">event</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">setState</span><span class="tok-p">({</span><span class="tok-nx">value</span><span class="tok-o">:</span> <span class="tok-nx">event</span><span class="tok-p">.</span><span class="tok-nx">target</span><span class="tok-p">.</span><span class="tok-nx">value</span><span class="tok-p">});</span>
  <span class="tok-p">},</span>
  <span class="tok-nx">render</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-k">return</span> <span class="tok-o">&lt;</span><span class="tok-nx">input</span> <span class="tok-nx">type</span><span class="tok-o">=</span><span class="tok-s2">&quot;text&quot;</span> <span class="tok-nx">value</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">state</span><span class="tok-p">.</span><span class="tok-nx">value</span><span class="tok-p">}</span> <span class="tok-nx">onChange</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">handleChange</span><span class="tok-p">}</span><span class="tok-o">/&gt;</span><span class="tok-p">;</span>
  <span class="tok-p">}</span>
<span class="tok-p">});</span>
<span class="tok-kd">var</span> <span class="tok-nx">instancia</span> <span class="tok-o">=</span> <span class="tok-o">&lt;</span><span class="tok-nx">MiForm</span> <span class="tok-nx">texto</span><span class="tok-o">=</span><span class="tok-s2">&quot;hola&quot;</span><span class="tok-o">/&gt;</span>
<span class="tok-kd">var</span> <span class="tok-nx">componente</span> <span class="tok-o">=</span> <span class="tok-nx">ReactDOM</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">(</span><span class="tok-nx">instancia</span><span class="tok-p">,</span> <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s1">&#39;miApp&#39;</span><span class="tok-p">));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Esto puede parecer muy engorroso, pero nos permite controlar perfectamente el estado del campo, por ejemplo si quisiéramos limitar el texto a 140 caracteres, cambiaríamos la función <code>handleChange</code> anterior por esta:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">handleChange</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">event</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">setState</span><span class="tok-p">({</span><span class="tok-nx">value</span><span class="tok-o">:</span> <span class="tok-nx">event</span><span class="tok-p">.</span><span class="tok-nx">target</span><span class="tok-p">.</span><span class="tok-nx">value</span><span class="tok-p">.</span><span class="tok-nx">substr</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">140</span><span class="tok-p">)});</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_refs">6.7.2. refs</h4>
<div class="paragraph">
<p>Una necesidad muy típica cuando se trabaja con formularios no controlados es obtener el valor actual que tiene un campo. Para esto podemos usar una "ref", que salvando las distancias viene a ser como los <code>id</code> del DOM tradicional, pero limitados al componente. Así si en un <code>render</code> hacemos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&lt;</span><span class="tok-nx">input</span> <span class="tok-nx">ref</span><span class="tok-o">=</span><span class="tok-s2">&quot;miCampo&quot;</span><span class="tok-o">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En una función de nuestro componente podríamos hacer esto para referenciar al campo</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">valor</span> <span class="tok-o">=</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">refs</span><span class="tok-p">.</span><span class="tok-nx">miCampo</span><span class="tok-p">.</span><span class="tok-nx">value</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Esta forma en la que un <code>ref</code> se especifica como una cadena es <em>legacy</em> en la versión actual de React, y tiende a sustituirse por la posibilidad de asignar una función <em>callback</em> que se ejecutará en el momento de montar el componente. Este <em>callback</em> puede por ejemplo guardar la referencia para usarla posteriormente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">render</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-k">return</span> <span class="tok-o">&lt;</span><span class="tok-nx">input</span> <span class="tok-nx">ref</span><span class="tok-o">=</span><span class="tok-s2">&quot;{function(nodo) {this.campo = nodo}}/&gt;&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span>
<span class="tok-nx">otraFuncion</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">campo</span><span class="tok-p">.</span><span class="tok-nx">value</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nótese que los <code>refs</code> no están ni mucho menos limitados a los formularios, son usables en cualquier tipo de componente, pero el empleo en formularios es un caso de uso muy típico</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="sesion06ejer">6.8. Ejercicios de React (I)</h3>
<div class="paragraph">
<p>Almacena los ejercicios en una carpeta <code>sesion06</code>. Para todos ellos puedes usar como base la carpeta <code>plantilla-react</code> incluida en el repositorio de plantillas. Simplemente puedes copiar/pegar y cambiar de nombre.</p>
</div>
<div class="sect3">
<h4 id="_el_retorno_del_widget_del_tiempo_0_4">6.8.1. El retorno del Widget del tiempo (0,4)</h4>
<div class="paragraph">
<p>Guarda este ejercicio en una carpeta <code>sesion06/tiempo</code>.</p>
</div>
<div class="paragraph">
<p><strong>Reescribe usando React el <strong>widget</strong> del tiempo</strong> que hicimos en la sesión 1. Guárdalo en una carpeta llamada <code>tiempo_react_v1</code>. No uses JSX en este ejercicio, ya que uno de los objetivos es practicar con el API <code>React.DOM.*</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">TiempoWidget</span> <span class="tok-o">=</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">createClass</span><span class="tok-p">({</span>
    <span class="tok-nx">getInitialState</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
      <span class="tok-p">...</span><span class="tok-nx">Devolver</span><span class="tok-err">á</span> <span class="tok-nx">un</span> <span class="tok-nx">estado</span> <span class="tok-nx">con</span> <span class="tok-nx">una</span> <span class="tok-nx">descripcion</span> <span class="tok-nx">y</span> <span class="tok-nx">una</span> <span class="tok-nx">icono_url</span> <span class="tok-nx">vac</span><span class="tok-err">í</span><span class="tok-nx">os</span> <span class="tok-p">(</span><span class="tok-s1">&#39;&#39;</span><span class="tok-p">)</span>
    <span class="tok-nx">verTiempo</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
      <span class="tok-p">...</span><span class="tok-nx">Aqu</span><span class="tok-err">í</span> <span class="tok-nx">ir</span><span class="tok-err">á</span> <span class="tok-nx">la</span> <span class="tok-nx">llamada</span> <span class="tok-nx">AJAX</span> <span class="tok-nx">al</span> <span class="tok-nx">servidor</span>
    <span class="tok-nx">render</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
      <span class="tok-p">...</span><span class="tok-nx">Devolver</span><span class="tok-err">á</span> <span class="tok-nx">el</span> <span class="tok-nx">widget</span> <span class="tok-s2">&quot;envuelto&quot;</span> <span class="tok-nx">en</span> <span class="tok-nx">un</span> <span class="tok-o">&lt;</span><span class="tok-nx">div</span><span class="tok-o">&gt;</span><span class="tok-p">,</span> <span class="tok-nx">usando</span> <span class="tok-nx">los</span> <span class="tok-nx">m</span><span class="tok-err">é</span><span class="tok-nx">todos</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">DOM</span><span class="tok-p">.</span><span class="tok-o">*</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Guías para la implementación:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Debes eliminar del código todas las referencias a Backbone y usar sólo React. No obstante puedes reutilizar código de la sesión 1, siempre que no use el API de Backbone.</p>
</li>
<li>
<p>incluye jQuery en la página si quieres seguir usando el <code>$.getJSON</code> para hacer la llamada AJAX. Puedes copiar el <code>.js</code> de la plantilla de Backbone o referenciara de una CDN</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&lt;</span><span class="tok-nx">script</span> <span class="tok-nx">src</span><span class="tok-o">=</span><span class="tok-s2">&quot;https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js&quot;</span><span class="tok-o">&gt;&lt;</span><span class="tok-err">/script&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_componente_tabla_de_datos">6.8.2. Componente tabla de datos</h4>
<div class="paragraph">
<p>Almacena este ejercicio en una carpeta <code>/sesion06/tabla</code></p>
</div>
<div class="paragraph">
<p>Crea un componente que muestre una serie de datos como una tabla HTML. Los datos se obtendrán de dos arrays:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">cabeceras</span> <span class="tok-o">=</span> <span class="tok-p">[</span><span class="tok-s1">&#39;titulo&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;distribuidora&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;recaudación ($)&#39;</span><span class="tok-p">];</span>
<span class="tok-kd">var</span> <span class="tok-nx">datos</span> <span class="tok-o">=</span> <span class="tok-p">[[</span><span class="tok-s1">&#39;Jurassic World&#39;</span><span class="tok-p">,</span>	<span class="tok-s1">&#39;Universal&#39;</span><span class="tok-p">,</span>	<span class="tok-mi">1668984926</span><span class="tok-p">],</span>
<span class="tok-p">[</span><span class="tok-s1">&#39;Furious 7&#39;</span><span class="tok-p">,</span>	<span class="tok-s1">&#39;Universal&#39;</span><span class="tok-p">,</span>	<span class="tok-mi">1515047671</span><span class="tok-p">],</span>
<span class="tok-p">[</span><span class="tok-s1">&#39;Los Vengadores: la era de Ultrón&#39;</span><span class="tok-p">,</span>	<span class="tok-s1">&#39;Buenavista&#39;</span><span class="tok-p">,</span>	<span class="tok-mi">1405035767</span><span class="tok-p">],</span>
<span class="tok-p">[</span><span class="tok-s1">&#39;Star Wars: el despertar de la Fuerza&#39;</span><span class="tok-p">,</span>	<span class="tok-s1">&#39;Buenavista&#39;</span><span class="tok-p">,</span>	<span class="tok-mi">1228349526</span><span class="tok-p">],</span>
<span class="tok-p">[</span><span class="tok-s1">&#39;Los Minions&#39;</span><span class="tok-p">,</span>	<span class="tok-s1">&#39;Universal&#39;</span><span class="tok-p">,</span>	<span class="tok-mi">1157275017</span><span class="tok-p">],</span>
<span class="tok-p">[</span><span class="tok-s1">&#39;Del revés&#39;</span><span class="tok-p">,</span>	<span class="tok-s1">&#39;Buenavista&#39;</span><span class="tok-p">,</span>	<span class="tok-mi">856130132</span><span class="tok-p">]</span> <span class="tok-p">,</span>
<span class="tok-p">[</span><span class="tok-s1">&#39;Spectre&#39;</span><span class="tok-p">,</span>	<span class="tok-s1">&#39;Sony&#39;</span><span class="tok-p">,</span>	<span class="tok-mi">850604955</span><span class="tok-p">]</span> <span class="tok-p">,</span>
<span class="tok-p">[</span><span class="tok-s1">&#39;Misión Imposible: nación secreta&#39;</span><span class="tok-p">,</span>	<span class="tok-s1">&#39;Paramount&#39;</span><span class="tok-p">,</span>	<span class="tok-mi">682330139</span><span class="tok-p">]</span> <span class="tok-p">,</span>
<span class="tok-p">[</span><span class="tok-s1">&#39;Los Juegos del Hambre: Sinsajo parte 2&#39;</span><span class="tok-p">,</span>	<span class="tok-s1">&#39;Lionsgate&#39;</span><span class="tok-p">,</span>	<span class="tok-mi">619444461</span><span class="tok-p">]</span> <span class="tok-p">,</span>
<span class="tok-p">[</span><span class="tok-s1">&#39;Marte (The Martian)&#39;</span><span class="tok-p">,</span>	<span class="tok-s1">&#39;Fox&#39;</span><span class="tok-p">,</span>	<span class="tok-mi">594161725</span><span class="tok-p">]];</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Puedes usar JSX, simplificará el código.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Recuerda usar el <code>type=text/babel</code> en el <code>&lt;script&gt;</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Haz dos versiones del componente</p>
</div>
<div class="paragraph">
<p>En la <strong>primera versión, <code>tabla_v1.html</code>, se mostrarán los datos de forma estática</strong> (0,4 puntos). Decide si es más conveniente usar <code>props</code> o <code>state</code> para guardar los datos.</p>
</div>
<div class="paragraph">
<p>Puedes usar dos <code>map</code> anidados para generar los datos, o bucles convencionales</p>
</div>
<div class="paragraph">
<p>En la <strong>segunda versión, <code>tabla_v2.html</code>, haz que además de lo anterior se puedan ordenar los datos</strong> (0,45 puntos) haciendo <em>clic</em> sobre las celdas de la cabecera. Para simplificar basta con hacer que aparezcan ordenados solo de menor a mayor, no es necesario cambiar el sentido de la ordenación al hacer <em>clic</em> de nuevo en la misma columna.</p>
</div>
<div class="paragraph">
<p>Para ordenar puedes usar la siguiente función, que debes hacer que se dispare con el <em>clic</em> en una celda de la cabecera:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">ordenar</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">evento</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-c1">//evento.target es la celda en que se ha pulsado, y cellIndex el número de la celda</span>
    <span class="tok-kd">var</span> <span class="tok-nx">numCol</span> <span class="tok-o">=</span> <span class="tok-nx">evento</span><span class="tok-p">.</span><span class="tok-nx">target</span><span class="tok-p">.</span><span class="tok-nx">cellIndex</span><span class="tok-p">;</span>
    <span class="tok-c1">//con slice(0) clonamos el array</span>
    <span class="tok-kd">var</span> <span class="tok-nx">ordenados</span> <span class="tok-o">=</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">state</span><span class="tok-p">.</span><span class="tok-nx">datos</span><span class="tok-p">.</span><span class="tok-nx">slice</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">);</span>
    <span class="tok-c1">//con sort ordenamos. Hay que pasarle un callback que, dadas dos filas A y B devuelva:</span>
    <span class="tok-c1">//&lt;0 si A debe ir antes que B</span>
    <span class="tok-c1">//&gt;0 si A debe ir después que B</span>
    <span class="tok-nx">ordenados</span><span class="tok-p">.</span><span class="tok-nx">sort</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">filaA</span><span class="tok-p">,</span><span class="tok-nx">filaB</span><span class="tok-p">){</span>
      <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-k">typeof</span> <span class="tok-nx">filaA</span><span class="tok-p">[</span><span class="tok-nx">numCol</span><span class="tok-p">]</span><span class="tok-o">==</span><span class="tok-s1">&#39;string&#39;</span><span class="tok-p">)</span>
        <span class="tok-k">return</span> <span class="tok-nx">filaA</span><span class="tok-p">[</span><span class="tok-nx">numCol</span><span class="tok-p">].</span><span class="tok-nx">localeCompare</span><span class="tok-p">(</span><span class="tok-nx">filaB</span><span class="tok-p">[</span><span class="tok-nx">numCol</span><span class="tok-p">]);</span>
      <span class="tok-k">else</span> <span class="tok-p">{</span>
        <span class="tok-k">return</span> <span class="tok-nx">filaA</span><span class="tok-p">[</span><span class="tok-nx">numCol</span><span class="tok-p">]</span><span class="tok-o">-</span><span class="tok-nx">filaB</span><span class="tok-p">[</span><span class="tok-nx">numCol</span><span class="tok-p">];</span>
      <span class="tok-p">}</span>
    <span class="tok-p">});</span>
    <span class="tok-c1">//ATENCION. Si tu variable de estado no se llama &#39;datos&#39; tendrás que cambiar esto</span>
    <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">setState</span><span class="tok-p">({</span><span class="tok-nx">datos</span><span class="tok-o">:</span><span class="tok-nx">ordenados</span><span class="tok-p">});</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion07">7. Interfaces web con ReactJS (II)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>En esta segunda sesión vamos a ver cómo construir jerarquías de componentes. No solo desde el punto de vista de qué código necesitamos para ello, sino también cuáles son las "buenas prácticas" al hacerlo, sobre todo la cuestión de cuándo usar estado y cuándo usar <code>props</code>. También veremos cuál es el ciclo de vida de un componente y dónde introducir nuestro código para que se dispare en el momento adecuado de este ciclo. Terminaremos dando unas guías de cómo usar Backbone para almacenar los modelos de una aplicación React, lo que puede ser útil si tenemos una aplicación Backbone y queremos aprovechar las ventajas que nos da React sobre las vistas nativas de Backbone.</p>
</div>
<div class="sect2">
<h3 id="_composición_de_componentes">7.1. Composición de componentes</h3>
<div class="paragraph">
<p>Una de las características más interesantes de React es que los componentes se pueden anidar o componer (ejem, por otro lado&#8230;&#8203;¿qué clase de componentes serían si no?). Como <a href="https://facebook.github.io/react/docs/multiple-components.html#motivation-separation-of-concerns">se resume perfectamente</a> en la propia documentación de React:</p>
</div>
<div class="paragraph">
<p>"Al desarrollar componentes modulares que reutilizan otros componentes con interfaces bien definidas, se consiguen los mismos beneficios que al usar funciones o clases. Específicamente se pueden separar las diferentes responsabilidades (<em>concerns</em>) de la aplicación como mejor parezca simplemente desarrollando nuevos componentes. Al desarrollar una biblioteca de componentes personalizados para la aplicación se está expresando la interfaz de usuario en el modo que mejor se ajusta al dominio"</p>
</div>
<div class="paragraph">
<p>Por ejemplo veamos la siguiente jerarquía de componentes, tomada de un <a href="https://facebook.github.io/react/docs/thinking-in-react.html">tutorial</a> muy interesante que forma parte de la documentación de React.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/06/component_tree.png" alt="component tree" width="66%">
</div>
<div class="title">Figure 6. Ejemplo de jerarquía de componentes</div>
</div>
<div class="paragraph">
<p>Yendo a un ejemplo un poco más sencillo veamos cómo podríamos "componentizar" nuestra lista de la compra, por el momento  dejando fuera el estado y los eventos, para simplificar. Nuestro componente <code>ListaCompra</code> ahora contendrá una colección de componentes de tipo <code>Item</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">Item</span> <span class="tok-o">=</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">createClass</span><span class="tok-p">({</span>
  <span class="tok-nx">render</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-k">return</span> <span class="tok-o">&lt;</span><span class="tok-nx">li</span><span class="tok-o">&gt;</span> <span class="tok-p">{</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">props</span><span class="tok-p">.</span><span class="tok-nx">nombre</span><span class="tok-p">}</span> <span class="tok-p">({</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">props</span><span class="tok-p">.</span><span class="tok-nx">cantidad</span><span class="tok-p">})</span> <span class="tok-o">&lt;</span><span class="tok-err">/li&gt;</span>
  <span class="tok-p">}</span>
<span class="tok-p">});</span>

<span class="tok-kd">var</span> <span class="tok-nx">ListaCompra</span> <span class="tok-o">=</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">createClass</span><span class="tok-p">({</span>
   <span class="tok-nx">render</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
     <span class="tok-kd">var</span> <span class="tok-nx">items</span> <span class="tok-o">=</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">props</span><span class="tok-p">.</span><span class="tok-nx">items</span><span class="tok-p">.</span><span class="tok-nx">map</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">item</span><span class="tok-p">,</span> <span class="tok-nx">indice</span><span class="tok-p">)</span> <span class="tok-p">{</span>
       <span class="tok-k">return</span> <span class="tok-o">&lt;</span><span class="tok-nx">Item</span> <span class="tok-nx">key</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-nx">indice</span><span class="tok-p">}</span> <span class="tok-nx">nombre</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-nx">item</span><span class="tok-p">.</span><span class="tok-nx">nombre</span><span class="tok-p">}</span> <span class="tok-nx">cantidad</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-nx">item</span><span class="tok-p">.</span><span class="tok-nx">cantidad</span><span class="tok-p">}</span><span class="tok-o">/&gt;</span>
     <span class="tok-p">})</span>
     <span class="tok-k">return</span> <span class="tok-o">&lt;</span><span class="tok-nx">ul</span><span class="tok-o">&gt;</span><span class="tok-p">{</span><span class="tok-nx">items</span><span class="tok-p">}</span><span class="tok-o">&lt;</span><span class="tok-err">/ul&gt;;</span>
   <span class="tok-p">}</span>
 <span class="tok-p">});</span>
 <span class="tok-kd">var</span> <span class="tok-nx">lista</span> <span class="tok-o">=</span> <span class="tok-p">[{</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s1">&#39;huevos&#39;</span><span class="tok-p">,</span> <span class="tok-nx">cantidad</span><span class="tok-o">:</span><span class="tok-mi">12</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s1">&#39;pan&#39;</span><span class="tok-p">,</span> <span class="tok-nx">cantidad</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">}];</span>
 <span class="tok-kd">var</span> <span class="tok-nx">instancia</span> <span class="tok-o">=</span> <span class="tok-o">&lt;</span><span class="tok-nx">ListaCompra</span> <span class="tok-nx">items</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-nx">lista</span><span class="tok-p">}</span><span class="tok-o">/&gt;</span><span class="tok-p">;</span>
 <span class="tok-nx">ReactDOM</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">(</span><span class="tok-nx">instancia</span><span class="tok-p">,</span> <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s1">&#39;miApp&#39;</span><span class="tok-p">));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Como en JSX cada componente se escribe como una etiqueta lo único que hacemos de especial es generar la etiqueta <code>&lt;Item&gt;</code> en lugar de directamente HTML, dentro del <code>render</code> de <code>ListaCompra</code>.</p>
</div>
<div class="paragraph">
<p>En la terminología de React se dice que <code>ListaCompra</code> es el componente "dueño" (<em>owner</em>) del componente <code>Item</code>. Un componente "dueño" fija el  valor de los <code>props</code> de sus componentes hijos. Es decir, en React existe un <em>flujo de datos unidireccional</em> que va del dueño a sus hijos en forma de <code>props</code>.</p>
</div>
<div class="sect3">
<h4 id="_dónde_colocar_el_estado">7.1.1. Dónde colocar el estado</h4>
<div class="paragraph">
<p>Vamos a añadir estado a nuestra nueva versión de la lista de la compra. Como ahora tenemos dos componentes, ¿En cuál deberíamos mantener el estado, en <code>ListaCompra</code> como hacíamos antes, o en cada <code>Item</code> por separado?. Para responder a esta pregunta debemos revisar la filosofía de diseño de React. Uno de estos principios de diseño es <em>reducir al máximo el número de componentes que deben mantener estado</em>. La idea es que esto hará los componentes más fáciles de depurar y testear, ya que para un componente sin estado (solo con <code>props</code>) solo necesitamos comprobar si dado un determinado valor para estas <em>props</em> el resultado es el deseado.</p>
</div>
<div class="paragraph">
<p>Se puede formular una serie de reglas prácticas que nos permitan identificar dónde almacenar el estado. Para cada variable perteneciente al estado debemos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Identificar todos los componentes que <em>renderizan</em> algo basándose en esa variable</p>
</li>
<li>
<p>Encontrar un componente dueño común a todos ellos (es decir, un único componente por encima en la jerarquía de todos los que necesitan ese estado).</p>
</li>
<li>
<p>El estado debería residir en ese dueño común o en otro componente todavía más alto en la jerarquía.</p>
</li>
<li>
<p>Si no podemos encontrar un componente en el que pueda residir el estado, crear uno nuevo simplemente para almacenarlo, y añadirlo en la jerarquía en algún lugar por encima de ese dueño común.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Las reglas anteriores están tomadas del excelente tutorial que ya hemos nombrado aquí llamado <a href="https://facebook.github.io/react/docs/thinking-in-react.html"><em>Thinking in React</em></a>, de Pete Hunt.</p>
</div>
<div class="paragraph">
<p>En nuestro caso parece claro según las reglas anteriores que el estado debería residir en <code>ListaCompra</code> y no en cada <code>Item</code> por separado. Cada item de la lista debe "saber" si debe mostrarse tachado o no, pero desde su "punto de vista" esta información es un <code>prop</code>, no es estado. Por tanto el código quedará como sigue:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&lt;</span><span class="tok-nx">script</span> <span class="tok-nx">type</span><span class="tok-o">=</span><span class="tok-s2">&quot;text/babel&quot;</span><span class="tok-o">&gt;</span>
<span class="tok-kd">var</span> <span class="tok-nx">Item</span> <span class="tok-o">=</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">createClass</span><span class="tok-p">({</span>
   <span class="tok-nx">render</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
     <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">props</span><span class="tok-p">.</span><span class="tok-nx">comprado</span><span class="tok-p">)</span> <span class="tok-p">{</span>
       <span class="tok-k">return</span> <span class="tok-o">&lt;</span><span class="tok-nx">li</span> <span class="tok-nx">className</span><span class="tok-o">=</span><span class="tok-s2">&quot;tachado&quot;</span><span class="tok-o">&gt;</span><span class="tok-p">{</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">props</span><span class="tok-p">.</span><span class="tok-nx">nombre</span><span class="tok-p">}</span> <span class="tok-p">({</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">props</span><span class="tok-p">.</span><span class="tok-nx">cantidad</span><span class="tok-p">})</span><span class="tok-o">&lt;</span><span class="tok-err">/li&gt;</span>
     <span class="tok-p">}</span>
     <span class="tok-k">else</span> <span class="tok-p">{</span>
       <span class="tok-k">return</span> <span class="tok-o">&lt;</span><span class="tok-nx">li</span><span class="tok-o">&gt;</span><span class="tok-p">{</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">props</span><span class="tok-p">.</span><span class="tok-nx">nombre</span><span class="tok-p">}</span> <span class="tok-p">({</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">props</span><span class="tok-p">.</span><span class="tok-nx">cantidad</span><span class="tok-p">})</span><span class="tok-o">&lt;</span><span class="tok-err">/li&gt;</span>
     <span class="tok-p">}</span>
   <span class="tok-p">}</span>
<span class="tok-p">});</span>
<span class="tok-kd">var</span> <span class="tok-nx">ListaCompra</span> <span class="tok-o">=</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">createClass</span><span class="tok-p">({</span>
   <span class="tok-nx">getInitialState</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
     <span class="tok-k">return</span> <span class="tok-p">{</span><span class="tok-nx">comprados</span><span class="tok-o">:</span> <span class="tok-k">new</span> <span class="tok-nb">Array</span><span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">props</span><span class="tok-p">.</span><span class="tok-nx">items</span><span class="tok-p">.</span><span class="tok-nx">length</span><span class="tok-p">)};</span>
   <span class="tok-p">},</span>
   <span class="tok-nx">render</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
      <span class="tok-kd">var</span> <span class="tok-nx">items</span> <span class="tok-o">=</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">props</span><span class="tok-p">.</span><span class="tok-nx">items</span><span class="tok-p">.</span><span class="tok-nx">map</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">item</span><span class="tok-p">,</span> <span class="tok-nx">indice</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-k">return</span> <span class="tok-o">&lt;</span><span class="tok-nx">Item</span> <span class="tok-nx">key</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-nx">indice</span><span class="tok-p">}</span> <span class="tok-nx">nombre</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-nx">item</span><span class="tok-p">.</span><span class="tok-nx">nombre</span><span class="tok-p">}</span> <span class="tok-nx">cantidad</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-nx">item</span><span class="tok-p">.</span><span class="tok-nx">cantidad</span><span class="tok-p">}</span> <span class="tok-nx">comprado</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">state</span><span class="tok-p">.</span><span class="tok-nx">comprados</span><span class="tok-p">[</span><span class="tok-nx">indice</span><span class="tok-p">]}</span><span class="tok-o">/&gt;</span>
      <span class="tok-p">}.</span><span class="tok-nx">bind</span><span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">));</span>
      <span class="tok-k">return</span> <span class="tok-o">&lt;</span><span class="tok-nx">ul</span><span class="tok-o">&gt;</span><span class="tok-p">{</span><span class="tok-nx">items</span><span class="tok-p">}</span><span class="tok-o">&lt;</span><span class="tok-err">/ul&gt;;</span>
   <span class="tok-p">}</span>
  <span class="tok-p">});</span>
<span class="tok-kd">var</span> <span class="tok-nx">lista</span> <span class="tok-o">=</span> <span class="tok-p">[{</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s1">&#39;huevos&#39;</span><span class="tok-p">,</span> <span class="tok-nx">cantidad</span><span class="tok-o">:</span><span class="tok-mi">12</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s1">&#39;pan&#39;</span><span class="tok-p">,</span> <span class="tok-nx">cantidad</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">}];</span>
<span class="tok-kd">var</span> <span class="tok-nx">instancia</span> <span class="tok-o">=</span> <span class="tok-o">&lt;</span><span class="tok-nx">ListaCompra</span> <span class="tok-nx">items</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-nx">lista</span><span class="tok-p">}</span><span class="tok-o">/&gt;</span><span class="tok-p">;</span>
<span class="tok-nb">window</span><span class="tok-p">.</span><span class="tok-nx">miComponente</span> <span class="tok-o">=</span> <span class="tok-nx">ReactDOM</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">(</span><span class="tok-nx">instancia</span><span class="tok-p">,</span> <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s1">&#39;miApp&#39;</span><span class="tok-p">));</span>
<span class="tok-o">&lt;</span><span class="tok-err">/script&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para poder "jugar" con la variable <code>miComponente</code> desde la consola del desarrollador la hemos metido dentro del objeto global predefinido <code>window</code>. Antes no era necesario esto porque escribíamos el código JS directamente, pero tengamos en cuenta que ahora el código está <em>transpilado</em> por Babel y las variables definidas en él <a href="http://stackoverflow.com/questions/33109430/script-tag-text-babel-variable-scope">no son accesibles desde fuera</a>.</p>
</div>
<div class="paragraph">
<p>Para probar el código anterior haríamos cosas como:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nb">window</span><span class="tok-p">.</span><span class="tok-nx">miComponente</span><span class="tok-p">.</span><span class="tok-nx">setState</span><span class="tok-p">({</span><span class="tok-nx">comprados</span><span class="tok-o">:</span><span class="tok-p">[</span><span class="tok-kc">true</span><span class="tok-p">,</span><span class="tok-kc">false</span><span class="tok-p">]})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Al cambiar el estado del componente <em>owner</em> se llamará automáticamente a su <code>render</code>, lo que implica que también se hace el <em>render</em> de los hijos con los nuevos valores para las <code>props</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_comunicación_de_abajo_a_arriba">7.1.2. Comunicación de abajo a arriba</h4>
<div class="paragraph">
<p>Aunque el flujo de datos primario en React es de arriba a abajo, en muchos casos será necesario comunicarnos en sentido inverso. Esto es típico de los casos en los que hay interactividad. Por ejemplo en la lista de la compra queremos que al hacer <em>clic</em> sobre un item cambie su estado (comprado/no-comprado), pero este no está contenido en el propio item sino en el "padre". Esto nos obliga a comunicarnos con el padre para notificar el cambio de estado.</p>
</div>
<div class="paragraph">
<p>La forma más típica de hacer esto en React es que el padre le pase al hijo un <em>callback</em> al que éste debe llamar para indicar el cambio de estado. En nuestro ejemplo sería algo como:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">Item</span> <span class="tok-o">=</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">createClass</span><span class="tok-p">({</span>
  <span class="tok-nx">toggle</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">props</span><span class="tok-p">.</span><span class="tok-nx">handleClick</span><span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">props</span><span class="tok-p">.</span><span class="tok-nx">id</span><span class="tok-p">);</span>   <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="tok-p">},</span>
  <span class="tok-nx">render</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-kd">var</span> <span class="tok-nx">atribs</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
      <span class="tok-nx">onClick</span><span class="tok-o">:</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">toggle</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-p">};</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">props</span><span class="tok-p">.</span><span class="tok-nx">comprado</span><span class="tok-p">)</span> <span class="tok-p">{</span>
      <span class="tok-nx">atribs</span><span class="tok-p">.</span><span class="tok-nx">className</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;tachado&#39;</span><span class="tok-p">;</span>
    <span class="tok-p">}</span>
    <span class="tok-k">return</span> <span class="tok-o">&lt;</span><span class="tok-nx">li</span> <span class="tok-p">{...</span><span class="tok-nx">atribs</span><span class="tok-p">}</span><span class="tok-o">&gt;</span><span class="tok-p">{</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">props</span><span class="tok-p">.</span><span class="tok-nx">nombre</span><span class="tok-p">}</span> <span class="tok-p">({</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">props</span><span class="tok-p">.</span><span class="tok-nx">cantidad</span><span class="tok-p">})</span><span class="tok-o">&lt;</span><span class="tok-err">/li&gt;  </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-p">}</span>
<span class="tok-p">});</span>
<span class="tok-kd">var</span> <span class="tok-nx">ListaCompra</span> <span class="tok-o">=</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">createClass</span><span class="tok-p">({</span>
  <span class="tok-nx">getInitialState</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-k">return</span> <span class="tok-p">{</span><span class="tok-nx">comprados</span><span class="tok-o">:</span> <span class="tok-k">new</span> <span class="tok-nb">Array</span><span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">props</span><span class="tok-p">.</span><span class="tok-nx">items</span><span class="tok-p">.</span><span class="tok-nx">length</span><span class="tok-p">)};</span>
  <span class="tok-p">},</span>
  <span class="tok-nx">toggleState</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">id</span><span class="tok-p">)</span> <span class="tok-p">{</span>   <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="tok-kd">var</span> <span class="tok-nx">compradosNew</span> <span class="tok-o">=</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">state</span><span class="tok-p">.</span><span class="tok-nx">comprados</span><span class="tok-p">.</span><span class="tok-nx">slice</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">);</span>
    <span class="tok-nx">compradosNew</span><span class="tok-p">[</span><span class="tok-nx">id</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-o">!</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">state</span><span class="tok-p">.</span><span class="tok-nx">comprados</span><span class="tok-p">[</span><span class="tok-nx">id</span><span class="tok-p">];</span>
    <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">setState</span><span class="tok-p">({</span><span class="tok-nx">comprados</span><span class="tok-o">:</span> <span class="tok-nx">compradosNew</span><span class="tok-p">});</span>
  <span class="tok-p">},</span>
  <span class="tok-nx">render</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
     <span class="tok-kd">var</span> <span class="tok-nx">items</span> <span class="tok-o">=</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">props</span><span class="tok-p">.</span><span class="tok-nx">items</span><span class="tok-p">.</span><span class="tok-nx">map</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">item</span><span class="tok-p">,</span> <span class="tok-nx">indice</span><span class="tok-p">)</span> <span class="tok-p">{</span>
       <span class="tok-k">return</span> <span class="tok-o">&lt;</span><span class="tok-nx">Item</span> <span class="tok-nx">id</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-nx">indice</span><span class="tok-p">}</span> <span class="tok-nx">key</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-nx">indice</span><span class="tok-p">}</span>
         <span class="tok-nx">nombre</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-nx">item</span><span class="tok-p">.</span><span class="tok-nx">nombre</span><span class="tok-p">}</span>
         <span class="tok-nx">cantidad</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-nx">item</span><span class="tok-p">.</span><span class="tok-nx">cantidad</span><span class="tok-p">}</span>
         <span class="tok-nx">comprado</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">state</span><span class="tok-p">.</span><span class="tok-nx">comprados</span><span class="tok-p">[</span><span class="tok-nx">indice</span><span class="tok-p">]}</span>
         <span class="tok-nx">handleClick</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">toggleState</span><span class="tok-p">}</span><span class="tok-o">/&gt;</span>  <i class="conum" data-value="5"></i><b>(5)</b>
     <span class="tok-p">}.</span><span class="tok-nx">bind</span><span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">));</span>
     <span class="tok-k">return</span> <span class="tok-o">&lt;</span><span class="tok-nx">ul</span><span class="tok-o">&gt;</span><span class="tok-p">{</span><span class="tok-nx">items</span><span class="tok-p">}</span><span class="tok-o">&lt;</span><span class="tok-err">/ul&gt;;</span>
  <span class="tok-p">}</span>
 <span class="tok-p">});</span>
 <span class="tok-kd">var</span> <span class="tok-nx">lista</span> <span class="tok-o">=</span> <span class="tok-p">[{</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s1">&#39;huevos&#39;</span><span class="tok-p">,</span> <span class="tok-nx">cantidad</span><span class="tok-o">:</span><span class="tok-mi">12</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s1">&#39;pan&#39;</span><span class="tok-p">,</span> <span class="tok-nx">cantidad</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">}];</span>
 <span class="tok-kd">var</span> <span class="tok-nx">instancia</span> <span class="tok-o">=</span> <span class="tok-o">&lt;</span><span class="tok-nx">ListaCompra</span> <span class="tok-nx">items</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-nx">lista</span><span class="tok-p">}</span><span class="tok-o">/&gt;</span><span class="tok-p">;</span>
 <span class="tok-nx">ReactDOM</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">(</span><span class="tok-nx">instancia</span><span class="tok-p">,</span> <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s1">&#39;miApp&#39;</span><span class="tok-p">));</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>esta función <code>toggle</code> es la que se dispara cuando hacemos <em>clic</em> en un item, luego veremos dónde se vincula el evento con ella. Dentro llamamos a <code>handleClick</code>, que no es más que una <code>prop</code> que nos pasa el padre (como el resto de <code>props</code>), pero que en lugar de ser un dato, es una función. A esta función tenemos que llamar para que el padre actualice el estado. Le pasamos el índice del item.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Creamos un objeto con los atributos HTML que va a tener nuestro item. El primero es el manejador de evento <code>onClick</code>. Aquí vinculamos el evento con la función <code>toggle</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Usamos el <em>spread operator</em> para asignar los atributos al componente <code>Item</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>En el "padre", este es el <em>callback</em> que se llama desde los hijos para indicar que se ha hecho <em>clic</em>. Recibimos el índice del hijo como parámetro y actualizamos el estado</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Finalmente, aquí es donde le hemos pasado el <em>callback</em> al hijo como una <code>prop</code> más.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Todo esto puede parecer un poco complicado frente a lo "sencillo" que sería mantener el estado en los hijos para evitar la comunicación con el padre. Pero como ya hemos dicho, el objetivo es reducir al máximo el número de componentes con estado. En el extremo de esta filosofía, en que tenemos un único componente con estado, o incluso centralizado en un elemento separado de la jerarquía de componentes, el flujo de datos sería como el de la siguiente figura:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/07/data_flow.png" alt="data flow" width="50%">
</div>
<div class="title">Figure 7. Flujo de datos con estado centralizado (tomada de <a href="http://aeflash.com/2015-02/react-tips-and-best-practices.html">React Tips and Best Practices</a>)</div>
</div>
<div class="paragraph">
<p>Tenemos un flujo de datos unidireccional, y los componentes son sin estado y por tanto más fáciles de testear: "solo" hay que verificar que generan el HTML correcto dado un valor de <code>props</code> y que se llama a los <em>callbacks</em> adecuados cuando se producen los eventos correspondientes. Pero no hay interacciones complejas entre ellos que dependan del estado actual de unos y otros. Como veremos en la siguiente sesión esta es una de las ideas centrales de una arquitectura denominada <strong>Flux</strong>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ciclo_de_vida_de_un_componente">7.2. Ciclo de vida de un componente</h3>
<div class="paragraph">
<p>Los componentes tienen un ciclo de vida: un componente aparecerá por primera vez en la página, o desaparecerá de ella, o se re-renderizará por haber cambiado su <em>state</em> o sus <em>props</em>. En ciertos de estos momentos podría interesarnos ejecutar código propio. Por ejemplo podemos aprovechar el momento en que se inserte por primera vez el componente en la página para solicitarle al API REST del servidor los datos que debe mostrar. O el momento en que se cambia el <code>state</code> para chequear si es un cambio que no necesita de re-renderizado. React nos ofrece un conjunto de <em>hooks</em> o métodos del ciclo de vida, que podemos implementar para ejecutar código propio en el momento adecuado.</p>
</div>
<div class="paragraph">
<p>A grandes rasgos podemos dividir estos métodos en varios tipos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Montado</strong> de componentes: cuando un componente se inserta por primera vez en la aplicación, o cuando desaparece de ella. Esta parte del ciclo de vida se muestra en la siguiente figura. En rojo se ponen los métodos que nosotros podemos implementar y en gris los procesos "internos" de React en los que no podemos intervenir directamente.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/07/lifecycle_mount.png" alt="lifecycle mount" width="50%">
</div>
<div class="title">Figure 8. Ciclo de vida al montar un componente</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Desmontado</strong> de componentes: cuando se elimina de la aplicación. Esto es más típico de los componentes hijos (por ejemplo pensemos en un item que se elimina de una lista)</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/07/lifecycle_unmount.png" alt="lifecycle unmount" width="50%">
</div>
<div class="title">Figure 9. Ciclo de vida al desmontar un componente</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Cambio en <code>props</code></strong></p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/07/lifecycle_props.png" alt="lifecycle props" width="50%">
</div>
<div class="title">Figure 10. Ciclo de vida al cambiar <code>props</code></div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Cambio en <code>state</code></strong>: es prácticamente igual al cambio de <code>props</code>, salvo que como es lógico no tiene el primero de los métodos, el <code>componentWillReceiveProps</code>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_ejemplo_carga_de_datos_con_ajax">7.2.1. Ejemplo: carga de datos con AJAX</h4>
<div class="paragraph">
<p>Un ejemplo de uso muy típico del ciclo de vida es cuando un componente tiene que cargar datos del servidor con AJAX. El momento adecuado para hacer la petición es cuando se dispare el <code>componentDidMount</code>. Podemos aprovechar el <code>componentWillUnmount</code> para cancelar la petición AJAX si es que todavía está pendiente. Veamos un ejemplo de un componente que muestra datos básicos del perfil de un usuario de GitHub a partir de su login.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">GitHubUserProfile</span> <span class="tok-o">=</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">createClass</span><span class="tok-p">({</span>  <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="tok-nx">render</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-k">return</span>  <span class="tok-p">(</span><span class="tok-o">&lt;</span><span class="tok-nx">div</span><span class="tok-o">&gt;</span>
         <span class="tok-o">&lt;</span><span class="tok-nx">h3</span><span class="tok-o">&gt;</span><span class="tok-p">{</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">props</span><span class="tok-p">.</span><span class="tok-nx">nombre</span><span class="tok-p">}</span><span class="tok-o">&lt;</span><span class="tok-err">/h3&gt;</span>
         <span class="tok-o">&lt;</span><span class="tok-nx">img</span> <span class="tok-nx">src</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">props</span><span class="tok-p">.</span><span class="tok-nx">url_avatar</span><span class="tok-p">}</span><span class="tok-o">/&gt;</span>
      <span class="tok-o">&lt;</span><span class="tok-err">/div&gt;)</span>
  <span class="tok-p">}</span>
<span class="tok-p">});</span>
<span class="tok-kd">var</span> <span class="tok-nx">GitHubUser</span> <span class="tok-o">=</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">createClass</span><span class="tok-p">({</span>   <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="tok-nx">getInitialState</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
     <span class="tok-k">return</span> <span class="tok-p">{</span>
       <span class="tok-nx">nombre</span><span class="tok-o">:</span> <span class="tok-s1">&#39;&#39;</span><span class="tok-p">,</span>
       <span class="tok-nx">url_avatar</span><span class="tok-o">:</span> <span class="tok-s1">&#39;&#39;</span>
     <span class="tok-p">};</span>
  <span class="tok-p">},</span>
  <span class="tok-nx">componentDidMount</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>  <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-kd">var</span> <span class="tok-nx">peticion</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">XMLHttpRequest</span><span class="tok-p">();</span>
    <span class="tok-nx">peticion</span><span class="tok-p">.</span><span class="tok-nx">onreadystatechange</span> <span class="tok-o">=</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
      <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">peticion</span><span class="tok-p">.</span><span class="tok-nx">readyState</span> <span class="tok-o">==</span> <span class="tok-mi">4</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-kd">var</span> <span class="tok-nx">datos</span> <span class="tok-o">=</span> <span class="tok-nx">JSON</span><span class="tok-p">.</span><span class="tok-nx">parse</span><span class="tok-p">(</span><span class="tok-nx">peticion</span><span class="tok-p">.</span><span class="tok-nx">responseText</span><span class="tok-p">);</span>
        <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">setState</span><span class="tok-p">({</span><span class="tok-nx">nombre</span><span class="tok-o">:</span> <span class="tok-nx">datos</span><span class="tok-p">.</span><span class="tok-nx">name</span><span class="tok-p">,</span> <span class="tok-nx">url_avatar</span><span class="tok-o">:</span><span class="tok-nx">datos</span><span class="tok-p">.</span><span class="tok-nx">avatar_url</span><span class="tok-p">});</span>
      <span class="tok-p">}</span>
    <span class="tok-p">}.</span><span class="tok-nx">bind</span><span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">);</span>  <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="tok-nx">peticion</span><span class="tok-p">.</span><span class="tok-nx">open</span><span class="tok-p">(</span><span class="tok-s1">&#39;GET&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;https://api.github.com/users/&#39;</span><span class="tok-o">+</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">props</span><span class="tok-p">.</span><span class="tok-nx">login</span><span class="tok-p">,</span> <span class="tok-kc">true</span><span class="tok-p">);</span>
    <span class="tok-nx">peticion</span><span class="tok-p">.</span><span class="tok-nx">send</span><span class="tok-p">();</span>
    <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">peticion</span> <span class="tok-o">=</span> <span class="tok-nx">peticion</span><span class="tok-p">;</span>
  <span class="tok-p">},</span>
  <span class="tok-nx">componentWillUnmount</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>  <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">peticion</span><span class="tok-p">.</span><span class="tok-nx">abort</span><span class="tok-p">();</span>
  <span class="tok-p">},</span>
  <span class="tok-nx">render</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-k">return</span> <span class="tok-o">&lt;</span><span class="tok-nx">GitHubUserProfile</span> <span class="tok-nx">nombre</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">state</span><span class="tok-p">.</span><span class="tok-nx">nombre</span><span class="tok-p">}</span>
           <span class="tok-nx">url_avatar</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">state</span><span class="tok-p">.</span><span class="tok-nx">url_avatar</span><span class="tok-p">}</span><span class="tok-o">/&gt;</span>
  <span class="tok-p">}</span>
<span class="tok-p">})</span>

<span class="tok-kd">var</span> <span class="tok-nx">instancia</span> <span class="tok-o">=</span> <span class="tok-o">&lt;</span><span class="tok-nx">GitHubUser</span> <span class="tok-nx">login</span><span class="tok-o">=</span><span class="tok-s1">&#39;octocat&#39;</span><span class="tok-o">/&gt;</span><span class="tok-p">;</span>
<span class="tok-nx">ReactDOM</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">(</span><span class="tok-nx">instancia</span><span class="tok-p">,</span> <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s1">&#39;miApp&#39;</span><span class="tok-p">));</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Este es el componente que muestra los datos del perfil propiamente dicho, pero no se encarga de nada más. Por tanto otro componente tendrá que hacer la petición al API de GitHub. Nótese que siguiendo las buenas prácticas de React es un componente sin estado.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Este componente se encarga de hacer la petición correspondiente al API de GitHub y pasarle los datos a una instancia del componente anterior. Este sí es un componente con estado, ya que no tenemos los datos del perfil hasta que recibimos la respuesta del servidor.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>En el <code>componentDidMount</code> hacemos la petición AJAX y cuando el servidor nos devuelve la respuesta en JSON guardamos los datos que nos interesan en el estado, forzando por tanto un <em>render</em>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Nótese el <code>bind</code> que nos hemos visto forzados a hacer en el <em>callback</em> de la petición AJAX para que <code>this</code> sea el componente y poder acceder así a su estado con <code>this.state</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>En el <code>componentWillUnmount</code> abortamos la petición AJAX por si estuviera pendiente, ya que si se elimina el componente ya no tiene sentido.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Podemos forzar el desmontado del componente para probar el <code>componentWillUnmount</code> ejecutando desde la consola del navegador: <code>ReactDOM.unmountComponentAtNode(document.getElementById('miApp'))</code> (suponiendo que <code>miApp</code> es el <code>id</code> del nodo del DOM donde hemos hecho el <code>ReactDOM.render</code>).
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_mejora_del_rendimiento_con_code_shouldcomponentupdate_code">7.2.2. Mejora del rendimiento con <code>shouldComponentUpdate</code></h4>
<div class="paragraph">
<p>Aunque uno de los mantras de React es que "Javascript es más rápido de lo que crees", no siempre es adecuado disparar el <code>render</code> ciegamente cada vez que cambia el estado o las props o cada vez que se re-renderiza el componente "padre" y se fuerza por tanto al <em>re-rendering</em> de los hijos. En ciertas circunstancias nos podemos ahorrar el <em>render</em>.</p>
</div>
<div class="paragraph">
<p>El método <code>shouldComponentUpdate</code> del ciclo de vida nos da una oportunidad de decidir si se debería o no disparar el <em>render</em>. Recibimos como argumentos el nuevo valor para <code>props</code> y <code>state</code>, en este orden, y si devolvemos <code>false</code> indicamos que el <code>render</code> no se debe ejecutar.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_react_y_backbone">7.3. React y Backbone</h3>
<div class="paragraph">
<p>Vamos a ver aquí cómo conectar Backbone, con el que implementaremos la parte del modelo, con React, que nos va a dar una implementación mucho más avanzada de las vistas que las nativas de Backbone. En principio React no está preparado especialmente para trabajar junto con Backbone. Afortunadamente, React implementa una forma de <em>mixins</em>, que nos permiten compartir código Javascript entre múltiples componentes, sin tener que repetirlo. Eso nos facilita definir componentes React que incorporen las funcionalidades necesarias para trabajar de forma sencilla con modelos y colecciones de Backbone.</p>
</div>
<div class="paragraph">
<p>Hay varias implementaciones hechas por terceros de <em>mixins</em> para combinar Backbone y React. De ellas vamos a usar aquí una llamada <a href="https://github.com/magalhas/backbone-react-component">backbone-react-component</a>. Para usar dicho código es necesario incluir un <a href="https://raw.githubusercontent.com/magalhas/backbone-react-component/master/dist/backbone-react-component-min.js">script JS</a> en nuestra página.</p>
</div>
<div class="paragraph">
<p>Como dice su documentación, el <em>mixin</em> sirve de "pegamento" entre componentes React y modelos y/o colecciones de Backbone. De esta forma si tenemos por ejemplo un componente asociado a una colección y esta cambia, el <em>mixin</em> disparará el re-renderizado.</p>
</div>
<div class="sect3">
<h4 id="_un_componente_con_un_modelo_asociado">7.3.1. Un componente con un modelo asociado</h4>
<div class="paragraph">
<p>Este es el caso más sencillo, tenemos un componente y queremos asociarle un modelo de Backbone. Al definir el componente, en el método <code>render</code> los atributos del modelo estarán accesibles a través de propiedades de <code>state</code> del mismo nombre. Por ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&lt;</span><span class="tok-nx">script</span> <span class="tok-nx">type</span><span class="tok-o">=</span><span class="tok-s2">&quot;text/babel&quot;</span><span class="tok-o">&gt;</span>
    <span class="tok-kd">var</span> <span class="tok-nx">LibroComp</span> <span class="tok-o">=</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">createClass</span><span class="tok-p">({</span>
        <span class="tok-nx">mixins</span><span class="tok-o">:</span> <span class="tok-p">[</span><span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">Component</span><span class="tok-p">.</span><span class="tok-nx">mixin</span><span class="tok-p">],</span>
        <span class="tok-nx">render</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
          <span class="tok-k">return</span> <span class="tok-p">(</span>
            <span class="tok-o">&lt;</span><span class="tok-nx">div</span> <span class="tok-nx">className</span><span class="tok-o">=</span><span class="tok-s2">&quot;libro&quot;</span><span class="tok-o">&gt;</span>
              <span class="tok-o">&lt;</span><span class="tok-nx">b</span><span class="tok-o">&gt;</span><span class="tok-p">{</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">state</span><span class="tok-p">.</span><span class="tok-nx">titulo</span><span class="tok-p">}</span><span class="tok-o">&lt;</span><span class="tok-err">/b&gt;, por &lt;em&gt;{this.state.autor}&lt;/em&gt;</span>
            <span class="tok-o">&lt;</span><span class="tok-err">/div&gt;</span>
          <span class="tok-p">);</span>
        <span class="tok-p">}</span>
    <span class="tok-p">});</span>
    <span class="tok-kd">var</span> <span class="tok-nx">libro1</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">LibroModel</span><span class="tok-p">({</span><span class="tok-nx">titulo</span><span class="tok-o">:</span><span class="tok-s2">&quot;Crónicas marcianas&quot;</span><span class="tok-p">,</span> <span class="tok-nx">autor</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Ray Bradbury&quot;</span><span class="tok-p">});</span>
    <span class="tok-nx">ReactDOM</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">(</span><span class="tok-o">&lt;</span><span class="tok-nx">LibroComp</span> <span class="tok-nx">model</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-nx">libro1</span><span class="tok-p">}</span><span class="tok-o">&gt;&lt;</span><span class="tok-err">/LibroComp&gt;,</span>
                 <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s1">&#39;un_libro&#39;</span><span class="tok-p">));</span>
<span class="tok-o">&lt;</span><span class="tok-err">/script&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si cambiamos el modelo, el <em>mixin</em> disparará un re-rendering automáticamente.</p>
</div>
<div class="paragraph">
<p>Además de solo a los atributos podemos acceder al modelo completo con el método <code>getModel()</code>. Así, podríamos haber implementado el <code>render</code> como:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">...</span>
<span class="tok-nx">render</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-kd">var</span> <span class="tok-nx">m</span> <span class="tok-o">=</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">getModel</span><span class="tok-p">();</span>
  <span class="tok-k">return</span> <span class="tok-p">(</span>
    <span class="tok-o">&lt;</span><span class="tok-nx">div</span> <span class="tok-nx">className</span><span class="tok-o">=</span><span class="tok-s2">&quot;libro&quot;</span><span class="tok-o">&gt;</span>
      <span class="tok-o">&lt;</span><span class="tok-nx">b</span><span class="tok-o">&gt;</span><span class="tok-p">{</span><span class="tok-nx">m</span><span class="tok-p">.</span><span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-s1">&#39;titulo&#39;</span><span class="tok-p">)}</span><span class="tok-o">&lt;</span><span class="tok-err">/b&gt;, por &lt;em&gt;{m.get(&#39;autor&#39;)}&lt;/em&gt;</span>
    <span class="tok-o">&lt;</span><span class="tok-err">/div&gt;</span>
  <span class="tok-p">);</span>
<span class="tok-p">}</span>
<span class="tok-p">...</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_un_componente_con_una_colección_asociada">7.3.2. Un componente con una colección asociada</h4>
<div class="paragraph">
<p>Vamos a ver el mismo ejemplo de antes de la colección de libros, pero ahora usando un modelo de Backbone para almacenar los datos de un libro y una colección para almacenar la lista de libros.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&lt;</span><span class="tok-nx">script</span> <span class="tok-nx">type</span><span class="tok-o">=</span><span class="tok-s2">&quot;text/javascript&quot;</span><span class="tok-o">&gt;</span>
    <span class="tok-kd">var</span> <span class="tok-nx">LibroModel</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">Model</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({});</span>   <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-kd">var</span> <span class="tok-nx">Biblioteca</span> <span class="tok-o">=</span> <span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">Collection</span><span class="tok-p">.</span><span class="tok-nx">extend</span><span class="tok-p">({</span>
        <span class="tok-nx">model</span><span class="tok-o">:</span> <span class="tok-nx">LibroModel</span>
    <span class="tok-p">});</span>
    <span class="tok-kd">var</span> <span class="tok-nx">miBiblio</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Biblioteca</span><span class="tok-p">([</span>
        <span class="tok-k">new</span> <span class="tok-nx">LibroModel</span><span class="tok-p">({</span><span class="tok-nx">titulo</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Juego de tronos&quot;</span><span class="tok-p">,</span> <span class="tok-nx">autor</span><span class="tok-o">:</span> <span class="tok-s2">&quot;George R.R. Martin&quot;</span><span class="tok-p">}),</span>
        <span class="tok-k">new</span> <span class="tok-nx">LibroModel</span><span class="tok-p">({</span><span class="tok-nx">titulo</span><span class="tok-o">:</span> <span class="tok-s2">&quot;El mundo del río&quot;</span><span class="tok-p">,</span> <span class="tok-nx">autor</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Philip J. Farmer&quot;</span><span class="tok-p">})</span>
    <span class="tok-p">]);</span>
<span class="tok-o">&lt;</span><span class="tok-err">/script&gt;</span>
<span class="tok-o">&lt;</span><span class="tok-nx">script</span> <span class="tok-nx">type</span><span class="tok-o">=</span><span class="tok-s2">&quot;text/babel&quot;</span><span class="tok-o">&gt;</span>
    <span class="tok-kd">var</span> <span class="tok-nx">ListaLibros</span> <span class="tok-o">=</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">createClass</span><span class="tok-p">({</span>
       <span class="tok-nx">mixins</span><span class="tok-o">:</span> <span class="tok-p">[</span><span class="tok-nx">Backbone</span><span class="tok-p">.</span><span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">Component</span><span class="tok-p">.</span><span class="tok-nx">mixin</span><span class="tok-p">],</span>  <i class="conum" data-value="2"></i><b>(2)</b>
       <span class="tok-nx">render</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
           <span class="tok-kd">var</span> <span class="tok-nx">libros</span> <span class="tok-o">=</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">getCollection</span><span class="tok-p">().</span><span class="tok-nx">map</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">libro</span><span class="tok-p">)</span> <span class="tok-p">{</span>  <i class="conum" data-value="3"></i><b>(3)</b>
              <span class="tok-k">return</span> <span class="tok-p">(</span>
                 <span class="tok-o">&lt;</span><span class="tok-nx">Libro</span> <span class="tok-nx">autor</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-nx">libro</span><span class="tok-p">.</span><span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-s2">&quot;autor&quot;</span><span class="tok-p">)}</span><span class="tok-o">&gt;</span>
                    <span class="tok-p">{</span><span class="tok-nx">libro</span><span class="tok-p">.</span><span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-s2">&quot;titulo&quot;</span><span class="tok-p">)}</span>
                 <span class="tok-o">&lt;</span><span class="tok-err">/Libro&gt;</span>
              <span class="tok-p">);</span>
           <span class="tok-p">});</span>

           <span class="tok-k">return</span> <span class="tok-p">(</span>
             <span class="tok-o">&lt;</span><span class="tok-nx">div</span> <span class="tok-nx">className</span><span class="tok-o">=</span><span class="tok-s2">&quot;listaLibros&quot;</span><span class="tok-o">&gt;</span>
                <span class="tok-p">{</span><span class="tok-nx">libros</span><span class="tok-p">}</span>
             <span class="tok-o">&lt;</span><span class="tok-err">/div&gt;</span>
           <span class="tok-p">);</span>
       <span class="tok-p">}</span>
    <span class="tok-p">});</span>

    <span class="tok-kd">var</span> <span class="tok-nx">Libro</span> <span class="tok-o">=</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">createClass</span><span class="tok-p">({</span>
        <span class="tok-nx">render</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
            <span class="tok-k">return</span> <span class="tok-p">(</span>
              <span class="tok-o">&lt;</span><span class="tok-nx">div</span> <span class="tok-nx">className</span><span class="tok-o">=</span><span class="tok-s2">&quot;libro&quot;</span><span class="tok-o">&gt;</span>
                  <span class="tok-o">&lt;</span><span class="tok-nx">b</span><span class="tok-o">&gt;</span><span class="tok-p">{</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">props</span><span class="tok-p">.</span><span class="tok-nx">children</span><span class="tok-p">}</span><span class="tok-o">&lt;</span><span class="tok-err">/b&gt;, por &lt;em&gt;{this.props.autor}&lt;/em&gt;</span>
              <span class="tok-o">&lt;</span><span class="tok-err">/div&gt;</span>
            <span class="tok-p">);</span>
        <span class="tok-p">}</span>
    <span class="tok-p">});</span>

    <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">(</span>
        <span class="tok-o">&lt;</span><span class="tok-nx">ListaLibros</span> <span class="tok-nx">collection</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-nx">miBiblio</span><span class="tok-p">}</span><span class="tok-o">&gt;&lt;</span><span class="tok-err">/ListaLibros&gt;,  </span><i class="conum" data-value="4"></i><b>(4)</b>
        <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s1">&#39;example&#39;</span><span class="tok-p">)</span>
    <span class="tok-p">);</span>
<span class="tok-o">&lt;</span><span class="tok-err">/script&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Definimos un modelo <code>Libro</code> y una colección <code>Biblioteca</code> usando Backbone. Este código no tiene nada de ReactJS.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Como dice la documentación de <code>backbone-react-component</code> hay que incluir este <em>mixin</em> en el componente raíz de la jerarquía.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>El componente React tiene una colección asociada (luego veremos cómo asociarla), que es accesible mediante <code>getCollection()</code>. Como cada elemento de la colección es un modelo de Backbone usamos los `getter`s correspondientes para acceder a los datos.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Aquí es donde asociamos la coleccción de Backbone al componente de React. El <em>mixin</em> está preparado para que la propiedad que referencia a la colección se llame <code>collection</code>. Si quisiéramos asociar un modelo usaríamos una propiedad llamada <code>model</code>. En la documentación de <code>backbone-react-component</code> podemos ver <a href="https://github.com/magalhas/backbone-react-component#multiple-models-and-collections">cómo asociar más de un modelo y/o colección</a> a un componente React.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El <em>mixin</em> que hemos usado se ocupará de que cuando cambie algún modelo de la colección el componente se redibuje automáticamente. No obstante, también podríamos gestionar manualmente la comunicación, como se hace por ejemplo en <a href="http://www.thomasboyt.com/2013/12/17/using-reactjs-as-a-backbone-view.html">este artículo</a>. Además del <em>mixin</em> que hemos usado aquí, hay algunas otras <a href="https://github.com/clayallsopp/react.backbone">implementaciones alternativas</a>.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="sesion07ejer">7.4. Ejercicios de React (II)</h3>
<div class="paragraph">
<p>En ambos ejercicios puedes usar JSX o bien el API JS, como prefieras.</p>
</div>
<div class="sect3">
<h4 id="_composición_de_componentes_y_ciclo_de_vida_0_5_puntos">7.4.1. Composición de componentes y ciclo de vida (0,5 puntos)</h4>
<div class="paragraph">
<p>Crea un componente React denominado <code>Crono</code>, que debe mostrar un cronómetro indicando minutos y segundos desde que se cargó. El componente contendrá dos componentes hijos <code>Elemento</code>, uno para visualizar los minutos y otro para los segundos.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>El estado debería estar en el componente de nivel superior. Necesitamos guardar los minutos y segundos transcurridos</p>
</li>
<li>
<p>En la función del ciclo de vida <code>componentDidMount</code>:</p>
<div class="ulist">
<ul>
<li>
<p>Para actualizar el estado usa un temporizador JS. Recuerda que puedes crearlo con la función <a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowTimers/setInterval"><code>setInterval</code></a>. No lo llames cada segundo justo, porque un <em>timer</em> puede ejecutarse con cierto retraso, ejecútalo cada menos tiempo, por ejemplo cada 500ms o menos.</p>
</li>
<li>
<p>Puedes calcular el tiempo transcurrido desde que se cargó el componente guardando la fecha inicial en el estado y luego restando la fecha actual menos la inicial. Te dará el tiempo transcurrido en milisegundos, que luego puedes convertir a minutos y segundos.</p>
<div class="literalblock">
<div class="content">
<pre>[source, javascript]
----
//momento actual
var ahora = new Date();
//tiempo transcurrido en ms. Suponemos inicializado "momentoInicial" y guardado en state
var tiempo = (ahora-this.state.momentoInicial)/1000;
this.setState({minutos:Math.round(tiempo/60), segundos:Math.round(tiempo%60)});
----</pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_comunicación_en_la_jerarquía_de_componentes_0_75_puntos">7.4.2. Comunicación en la jerarquía de componentes (0,75 puntos)</h4>
<div class="paragraph">
<p>Crea una nueva versión del <strong>widget</strong> del tiempo con React que hiciste en la sesión anterior, pero ahora usa una jerarquía de 3 componentes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>El componente <code>TiempoWidget</code>, que  contendrá el código que comunica con el API del servidor y los dos componentes hijos que se ocupan de dibujar la interfaz.</p>
</li>
<li>
<p>Un componente hijo que contendrá únicamente los campos de formulario. Tendrá que comunicarse con el padre llamando a  un <em>callback</em>, cuando el usuario pulse sobre el botón <code>Ver tiempo</code>.</p>
</li>
<li>
<p>Un componente hijo que se limitará a mostrar el tiempo en modo texto y con el icono.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Sigue las prácticas recomendadas en React en cuanto a dónde almacenar el estado: éste debería residir únicamente en el componente de nivel superior, y los hijos si necesitan mostrar datos deberían recibirlos como <code>props</code>.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion08">8. Introducción a la arquitectura Flux para aplicaciones React</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="__por_qué_flux">8.1. ¿ Por qué Flux?</h3>
<div class="paragraph">
<p>Flux es una alternativa a MVC propuesta por los ingenieros de Facebook y especialmente pensada para aplicaciones de tamaño mediano y grande (aunque nada impide usarla en aplicaciones pequeñas, ya que no es una arquitectura compleja).</p>
</div>
<div class="paragraph">
<p>Flux fue presentada en la conferencia de desarrolladores de Facebook, la F8, en 2014, en una charla titulada <a href="https://www.youtube.com/watch?v=nYkdrAPrdcw">"Hacker Way: Rethinking Web App Development at Facebook"</a>. La información de este apartado está adaptada de dicha charla. Además del video podéis consultar también unas <a href="https://drive.google.com/file/d/0B6FDE5kMwYTldkdLWEo1X05rQzA/view">notas sobre la presentación en PDF</a>.</p>
</div>
<div class="paragraph">
<p>MVC es un patrón arquitectónico muy conocido y ampliamente probado, pero según los proponentes de Flux no es adecuado para aplicaciones de tamaño mediano o grande. En aplicaciones pequeñas la arquitectura MVC es clara y sencilla:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/08/mvc_simple.png" alt="mvc simple" width="50%">
</div>
<div class="title">Figure 11. MVC en aplicaciones pequeñas</div>
</div>
<div class="paragraph">
<p>Sin embargo en aplicaciones de mayor tamaño, donde hay un número elevado de modelos y vistas, el diagrama se complica de manera considerable:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/08/mvc_complejo.png" alt="mvc complejo" width="50%">
</div>
<div class="title">Figure 12. MVC en aplicaciones medianas o grandes</div>
</div>
<div class="paragraph">
<p>El problema fundamental aquí es la complicada relación que existe entre todos los modelos y las vistas, formando un grafo complejo y con ciclos. Cuando hay este tipo de ciclos, un <em>bug</em> en un componente puede causar problemas en muchos otros, que además serán difíciles de detectar al ser el flujo de datos tan complicado. Contra esto, se propone una arquitectura basada en un <strong>flujo unidireccional de datos</strong>. Este flujo unidireccional va a hacer mucho más fácil la detección de <em>bugs</em> y a mejorar la comprensión que tienen los desarrolladores del sistema.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/08/flux_simple.png" alt="flux simple" width="50%">
</div>
<div class="title">Figure 13. Flujo unidireccional de datos en Flux</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
La discusión anterior está contada desde el punto de vista de los ingenieros que propusieron Flux. Es posible que una aplicación MVC bien diseñada no se parezca tanto al diagrama puesto como ejemplo de "mala práctica". Parte del problema reside en que no hay un acuerdo 100% en lo que significa MVC. De cualquier modo, el argumento principal de Flux es primar el flujo unidireccional de datos con respecto a cualquier otra arquitectura que no lo tenga. En ese sentido no tiene tanta importancia que la "mala práctica" sea MVC o no, se trata solo de evitarla.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_flux_a_grandes_rasgos">8.2. Flux a grandes rasgos</h3>
<div class="paragraph">
<p>Una de las ideas principales de Flux es separar en lo posible el estado de la aplicación de los componentes de la interfaz. Ya hemos discutido en sesiones anteriores por qué nos interesa tener componentes sin estado. Idealmente tendríamos por un lado el estado de la aplicación, y cuando este estado se actualizara, de alguna forma los componentes serían notificados del cambio para que se <em>re-renderizaran</em>. Recordemos este diagrama:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/07/data_flow.png" alt="data flow" width="50%">
</div>
<div class="title">Figure 14. Flujo de datos con estado centralizado (tomada de <a href="http://aeflash.com/2015-02/react-tips-and-best-practices.html">React Tips and Best Practices</a>)</div>
</div>
<div class="sect3">
<h4 id="_stores">8.2.1. Stores</h4>
<div class="paragraph">
<p>Al elemento que almacena el estado en una aplicación Flux se le denomina <strong>Store</strong>. Aunque estemos hablando en singular, puede haber varios. Las vistas (componentes de React) se suscriben a los <em>stores</em> que les interesa para recibir las notificaciones de que se han actualizado los datos.</p>
</div>
<div class="paragraph">
<p>En un paradigma MVC tradicional, los <em>stores</em> se corresponderían más o menos con los modelos. Sin embargo hay una diferencia importante: se puede acceder a los datos que contienen los <em>stores</em> (tienen <em>getters</em>) pero no se los puede cambiar directamente (no tienen <em>setters</em>). La única forma que hay de cambiar los datos de un <em>store</em> es de modo indirecto a través de <strong>acciones</strong>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_actions">8.2.2. Actions</h4>
<div class="paragraph">
<p>Las <strong>acciones</strong> son "cosas que suceden en la aplicación". Por ejemplo en Facebook sería que el usuario pone un <em>post</em> en el muro, o sube una foto, o le da <em>like</em> a otra,&#8230;&#8203; es decir, más o menos los casos de uso, aunque pueden tener una granularidad más fina.</p>
</div>
<div class="paragraph">
<p>Cada acción tiene un <em>tipo</em> (un valor único que la identifica) y opcionalmente un <em>payload</em> con más información. Las acciones se despachan a los <em>stores</em>, y estos son los encargados de procesarlas. Cada <em>store</em> debe saber cómo actualizar los datos que contiene en respuesta a una determinada acción.</p>
</div>
</div>
<div class="sect3">
<h4 id="_dispatcher">8.2.3. Dispatcher</h4>
<div class="paragraph">
<p>El <strong>dispatcher</strong> es la última pieza que nos falta. Es el que se encarga de <em>despachar</em> las acciones a los <em>stores</em>. A diferencia de un sistema típico publicar/suscribir, el <em>dispatcher</em> despacha "ciegamente" todas las acciones a todos los <em>stores</em> que se han suscrito a él. Es responsabilidad del <em>store</em> procesar la acción efectivamente o no.</p>
</div>
<div class="paragraph">
<p>El <em>dispatcher</em> suele ser la pieza más genérica e intercambiable entre todas las aplicaciones Flux, así que es la que dan ya implementada la mayor parte de las librerías que implementan esta arquitectura, como componente "listo para usar".</p>
</div>
</div>
<div class="sect3">
<h4 id="_flujo_de_datos">8.2.4. Flujo de datos</h4>
<div class="paragraph">
<p>Estos son los únicos componentes de Flux. Recapitulando, las acciones van al <em>dispatcher</em> que se encarga de enviarlas a los <em>stores</em>. Estos a su vez notifican a los componentes interesados del cambio en el estado para que se repinten. Nótese que esto genera un flujo unidireccional de datos: Acciones&#8594;Dispatcher&#8594;Stores&#8594;Componentes React, que es uno de los <em>mantras</em> de Flux. No obstante, evidentemente tiene que haber un sitio del que salgan las acciones. Típicamente las disparará el usuario al interactuar con los componentes, así que hay una retroalimentación para "cerrar el bucle" de la aplicación, como se ve en el siguiente diagrama</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/08/flux_not_so_simple.png" alt="flux not so simple" width="50%">
</div>
<div class="title">Figure 15. Flujo de datos en Flux</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_un_ejemplo_sencillo">8.3. Un ejemplo sencillo</h3>
<div class="paragraph">
<p>Vamos a ver cómo funciona Flux en una aplicación muy sencilla. Al ser un ejemplo <em>de juguete</em> evidentemente el uso aquí de Flux o de cualquier otra arquitectura no está justificado en realidad, salvo por motivos pedagógicos.</p>
</div>
<div class="paragraph">
<p>La idea es hacer una pequeña aplicación que en teoría mantenga el saldo de nuestra cuenta bancaria. El componente React debería mostrar en todo momento el saldo actual y permitir que se hagan ingresos y reintegros de la cuenta (nuestro único objetivo es que se vaya actualizando y mostrando el saldo, no hacer ingresos ni reintegros reales con ningún API).</p>
</div>
<div class="sect3">
<h4 id="_librerías_para_implementar_flux">8.3.1. Librerías para implementar Flux</h4>
<div class="paragraph">
<p>Lo primero que debemos tener claro es que Flux es una arquitectura, al igual que MVC, y no una librería ni un <em>framework</em> concreto. Facebook tiene <a href="https://github.com/facebook/flux">su propia implementación de Flux</a>, que es <em>open source</em>. Al ser la "oficial" de Facebook es la más difundida. Básicamente lo que hace esta implementación es proporcionarnos un <em>dispatcher</em> listo para usar y poco más, al menos en las primeras versiones.</p>
</div>
<div class="paragraph">
<p>No obstante, a tono con la ebullición general de todo lo que tenga que ver con React, últimamente ha surgido multitud de implementaciones alternativas a la original, algo interesante teniendo en cuenta que se trata de una arquitectura que no llega a los dos años de vida: Redux, Reflux, DeLorean, Alt, &#8230;&#8203; Una vez introducidos en Flux, sería interesante echarle un vistazo a alguna de las comparativas de implementaciones, por ejemplo <a href="https://medium.com/social-tables-tech/we-compared-13-top-flux-implementations-you-won-t-believe-who-came-out-on-top-1063db32fe73#.wq0efptrq">esta</a> o <a href="http://pixelhunter.me/post/110248593059/flux-solutions-compared-by-example">esta</a>. Dado que es la más difundida usaremos la implementación de Facebook.</p>
</div>
<div class="paragraph">
<p>Casi todas las implementaciones de Flux recomiendan el uso de <code>npm</code> para su instalación junto con un <em>bundler</em> como browserify o webpack que nos permita usar en el navegador los paquetes instalados con React. Para no complicarnos la vida inicialmente con estas herramientas y centrarnos en lo que es Flux en sí, vamos a usar Flux "a la antigua usanza", es decir, incluyéndolo con una etiqueta <code>&lt;script&gt;</code>. No obstante, para el trabajo "más serio" con Flux una vez se ha aprendido, se recomienda encarecidamente usar estas herramientas. Su uso se describe brevemente en uno de los apéndices de los apuntes.</p>
</div>
<div class="paragraph">
<p>En los ejemplos, incluiremos Flux desde una CDN, para no tener que bajarlo localmente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;script </span><span class="tok-na">src=</span><span class="tok-s">&quot;https://cdnjs.cloudflare.com/ajax/libs/flux/2.1.1/Flux.js&quot;</span><span class="tok-nt">&gt;&lt;/script&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_el_em_dispatcher_em">8.3.2. El <em>Dispatcher</em></h4>
<div class="paragraph">
<p>Como ya hemos comentado, el <em>dispatcher</em> es la única pieza "lista para usar" que nos da la implementación de Facebook. Aunque en el diagrama de la arquitectura no es la primera del flujo de datos, empezaremos por ella, ya que cuando creemos las acciones debemos poder enviarlas aquí y por tanto necesitamos tener ya instanciado el <em>dispatcher</em>. Para instanciar un <em>dispatcher</em>, simplemente haremos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">MiDispatcher</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Flux</span><span class="tok-p">.</span><span class="tok-nx">Dispatcher</span><span class="tok-p">();</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_las_acciones">8.3.3. Las acciones</h4>
<div class="paragraph">
<p>Tenemos que identificar las "cosas que pueden pasar" en nuestra aplicación. En nuestro caso es sencillo, solo hay tres: nuestra cuenta puede abrirse para empezar con 0 euros, podemos ingresar dinero y podemos sacar dinero.</p>
</div>
<div class="paragraph">
<p>Una acción no es más que un objeto Javascript típicamente con dos campos, el tipo y el <em>payload</em>. El primero es simplemente una constante que identifica la acción de manera única. El segundo contiene más información sobre la acción, en nuestro ejemplo la cantidad ingresada o sacada. Primero vamos a definir los tipos de las acciones como constantes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">Ctes</span> <span class="tok-o">=</span> <span class="tok-nx">Ctes</span> <span class="tok-o">||</span> <span class="tok-p">{};</span>
<span class="tok-nx">Ctes</span><span class="tok-p">.</span><span class="tok-nx">Acciones</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
  <span class="tok-nx">CUENTA_CREADA</span><span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
  <span class="tok-nx">ABONO</span><span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
  <span class="tok-nx">CARGO</span><span class="tok-o">:</span> <span class="tok-mi">3</span><span class="tok-p">,</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora, una acción no sería más que un objeto como:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span>
  <span class="tok-nx">tipo</span><span class="tok-o">:</span> <span class="tok-nx">Ctes</span><span class="tok-p">.</span><span class="tok-nx">Acciones</span><span class="tok-p">.</span><span class="tok-nx">ABONO</span><span class="tok-p">,</span>
  <span class="tok-nx">cantidad</span><span class="tok-o">:</span> <span class="tok-mi">100</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Aunque es un elemento que no figura en la arquitectura Flux genérica, en las implementaciones se suelen usar <em>creadores de acciones</em>, que son simplemente métodos para crear acciones y que se suelen "empaquetar" en un objeto Javascript. No es que sean estrictamente necesarios, pero nos facilitan crear una acción desde el punto del código que la necesitemos. El creador de acción debe instanciar el objeto con el <em>tipo</em> y el <em>payload</em> y enviarla al <em>dispatcher</em> para que este la despache a los <em>stores</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">Acciones</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
  <span class="tok-nx">crearCuenta</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-nx">MiDispatcher</span><span class="tok-p">.</span><span class="tok-nx">dispatch</span><span class="tok-p">({</span>
      <span class="tok-nx">tipo</span><span class="tok-o">:</span> <span class="tok-nx">Ctes</span><span class="tok-p">.</span><span class="tok-nx">Acciones</span><span class="tok-p">.</span><span class="tok-nx">CUENTA_CREADA</span><span class="tok-p">,</span>
      <span class="tok-nx">cantidad</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
    <span class="tok-p">});</span>
  <span class="tok-p">},</span>
  <span class="tok-nx">depositarEnCuenta</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">cant</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nx">MiDispatcher</span><span class="tok-p">.</span><span class="tok-nx">dispatch</span><span class="tok-p">({</span>
      <span class="tok-nx">tipo</span><span class="tok-o">:</span> <span class="tok-nx">Ctes</span><span class="tok-p">.</span><span class="tok-nx">Acciones</span><span class="tok-p">.</span><span class="tok-nx">ABONO</span><span class="tok-p">,</span>
      <span class="tok-nx">cantidad</span><span class="tok-o">:</span> <span class="tok-nx">cant</span>
    <span class="tok-p">});</span>
  <span class="tok-p">},</span>
  <span class="tok-nx">sacarDeCuenta</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">cant</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nx">MiDispatcher</span><span class="tok-p">.</span><span class="tok-nx">dispatch</span><span class="tok-p">({</span>
      <span class="tok-nx">tipo</span><span class="tok-o">:</span> <span class="tok-nx">Ctes</span><span class="tok-p">.</span><span class="tok-nx">Acciones</span><span class="tok-p">.</span><span class="tok-nx">CARGO</span><span class="tok-p">,</span>
      <span class="tok-nx">cantidad</span><span class="tok-o">:</span> <span class="tok-nx">cant</span>
    <span class="tok-p">});</span>
  <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El código anterior lo hemos implementado simplemente porque ahora desde cualquier punto es muy sencillo crear una acción y enviarla al <em>dispatcher</em>, por ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">Acciones</span><span class="tok-p">.</span><span class="tok-nx">crearCuenta</span><span class="tok-p">();</span>
<span class="tok-nx">Acciones</span><span class="tok-p">.</span><span class="tok-nx">depositarEnCuenta</span><span class="tok-p">(</span><span class="tok-mi">100</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_los_em_stores_em">8.3.4. Los <em>stores</em></h4>
<div class="paragraph">
<p>Nuestra aplicación es tan sencilla que solo crearemos uno, pero en una aplicación más real normalmente habría varios. Los <em>stores</em> almacenan el estado y también la lógica para actualizar ese estado. Veamos una primera versión.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">CuentaStore</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
  <span class="tok-nx">balance</span><span class="tok-o">:</span> <span class="tok-mi">0</span><span class="tok-p">,</span>  <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="tok-nx">getBalance</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-k">return</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">balance</span><span class="tok-p">;</span>
  <span class="tok-p">},</span>
  <span class="tok-nx">manejarAccion</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">accion</span><span class="tok-p">)</span> <span class="tok-p">{</span>  <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-k">switch</span><span class="tok-p">(</span><span class="tok-nx">accion</span><span class="tok-p">.</span><span class="tok-nx">tipo</span><span class="tok-p">)</span> <span class="tok-p">{</span>
      <span class="tok-k">case</span> <span class="tok-nx">Ctes</span><span class="tok-p">.</span><span class="tok-nx">Acciones</span><span class="tok-p">.</span><span class="tok-nx">CUENTA_CREADA</span><span class="tok-o">:</span>
         <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">balance</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
         <span class="tok-k">break</span><span class="tok-p">;</span>
      <span class="tok-k">case</span> <span class="tok-nx">Ctes</span><span class="tok-p">.</span><span class="tok-nx">Acciones</span><span class="tok-p">.</span><span class="tok-nx">ABONO</span><span class="tok-o">:</span>
         <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">balance</span> <span class="tok-o">+=</span> <span class="tok-nx">accion</span><span class="tok-p">.</span><span class="tok-nx">cantidad</span><span class="tok-p">;</span>
         <span class="tok-k">break</span><span class="tok-p">;</span>
      <span class="tok-k">case</span> <span class="tok-nx">Ctes</span><span class="tok-p">.</span><span class="tok-nx">Acciones</span><span class="tok-p">.</span><span class="tok-nx">CARGO</span><span class="tok-o">:</span>
         <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">balance</span> <span class="tok-o">-=</span> <span class="tok-nx">accion</span><span class="tok-p">.</span><span class="tok-nx">cantidad</span><span class="tok-p">;</span>
         <span class="tok-k">break</span><span class="tok-p">;</span>
    <span class="tok-p">}</span>
  <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Aquí almacenamos el estado, en nuestro caso nos basta con el balance actual de la cuenta. Este estado deberíamos intentar hacerlo privado, aunque aquí lo hemos dejado como una propiedad convencional para simplificar.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Aquí tenemos un <em>getter</em> para obtener el valor actual del estado.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Aquí agrupamos la lógica que actualiza el estado en función de las posibles acciones.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Nos falta conectar el <em>store</em> por un lado con el <em>dispatcher</em> y por otro con los componentes React. Para hacer lo primero tenemos que registrar el <em>dispatcher</em> con la función del <em>store</em> que gestiona las acciones. Hacemos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">MiDispatcher</span><span class="tok-p">.</span><span class="tok-nx">register</span><span class="tok-p">(</span><span class="tok-nx">CuentaStore</span><span class="tok-p">.</span><span class="tok-nx">manejarAccion</span><span class="tok-p">.</span><span class="tok-nx">bind</span><span class="tok-p">(</span><span class="tok-nx">CuentaStore</span><span class="tok-p">));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Una vez que se haya ejecutado la lógica de gestión de la acción, el <em>store</em> habrá actualizado su estado y debe notificar a las vistas interesadas que el estado ha cambiado. Así las vistas podrán obtener el nuevo estado y repintarse. Vamos a hacer esta notificación mediante eventos, al modo en que se comunican modelos y vistas en Backbone.</p>
</div>
<div class="paragraph">
<p>Los navegadores ofrecen soporte para gestionar los eventos típicos del DOM (<em>click</em>, <em>mouseOver</em>, <em>load</em>, &#8230;&#8203;) pero no podemos crear eventos personalizados. Necesitamos alguna librería adicional que nos permita generar y escuchar eventos propios. Facebook ofrece una librería propia de tipo <em>open source</em> llamada <a href="https://www.npmjs.com/package/fbemitter"><code>fbemitter</code></a>. Nosotros usaremos otra distinta denominada <a href="https://github.com/Olical/EventEmitter"><code>EventEmitter</code></a>, simplemente porque la de Facebook está pensada para instalarla con <code>npm</code>, que no estamos usando aquí por el momento. El API de ambas es prácticamente igual. Podemos incluir esta última librería simplemente con un <em>tag</em> <code>&lt;script&gt;</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;script </span><span class="tok-na">src=</span><span class="tok-s">&quot;https://cdnjs.cloudflare.com/ajax/libs/EventEmitter/4.3.0/EventEmitter.min.js&quot;</span><span class="tok-nt">&gt;&lt;/script&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La librería nos proporciona una "clase" <code>EventEmitter</code> con capacidad para generar eventos arbitrarios y registrar <em>listeners</em> para esos eventos. Para añadir esas capacidades a un objeto de nuestra aplicación (el <em>store</em>) podemos usar el <code>Object.assign</code> de Javascript. Cambiamos la primera línea donde definíamos el <code>CuentaStore</code> por la siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">CuentaStore</span> <span class="tok-o">=</span> <span class="tok-nb">Object</span><span class="tok-p">.</span><span class="tok-nx">assign</span><span class="tok-p">({},</span> <span class="tok-nx">EventEmitter</span><span class="tok-p">.</span><span class="tok-nx">prototype</span><span class="tok-p">,</span> <span class="tok-p">{</span>
  <span class="tok-c1">//propiedades del objeto</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lo que estamos haciendo es crear el <code>CuentaStore</code> a partir de un objeto vacío, <code>{}</code>, y sobre él estamos copiando las propiedades de <code>EventEmitter.prototype</code>, y después las propiedades que  definíamos antes (<code>balance</code>, <code>getBalance</code>,&#8230;&#8203;). Este prototipo contiene los métodos que necesitamos para emitir y escuchar eventos (podéis consultar el funcionamiento de <a href="https://developer.mozilla.org/es/docs/Web/JavaScript/Referencia/Objetos_globales/Object/assign"><code>Object.assign</code></a> si tenéis dudas).</p>
</div>
<div class="paragraph">
<p>Lo que tenemos que hacer es emitir un evento cuando cambie el estado del <em>store</em> (en nuestro caso el balance, que es la única variable de estado). Primero definiremos una constante para representar dicho evento:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">Ctes</span><span class="tok-p">.</span><span class="tok-nx">Eventos</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
  <span class="tok-nx">CAMBIO_CUENTA</span><span class="tok-o">:</span> <span class="tok-s1">&#39;cambio_cuenta&#39;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>usamos <code>cambio_cuenta</code> como nombre "real" del evento ya que es típico que los eventos tengan un nombre y no un valor numérico, aunque también funcionaría con este último.</p>
</div>
<div class="paragraph">
<p>Ya solo nos falta emitir el evento tras el cambio de estado. Lo haremos al final del <code>manejarAccion</code> del <em>store</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">manejarAccion</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">accion</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-k">switch</span><span class="tok-p">(</span><span class="tok-nx">accion</span><span class="tok-p">.</span><span class="tok-nx">tipo</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-k">case</span> <span class="tok-nx">Ctes</span><span class="tok-p">.</span><span class="tok-nx">Acciones</span><span class="tok-p">.</span><span class="tok-nx">CUENTA_CREADA</span><span class="tok-o">:</span>
       <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">balance</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
       <span class="tok-k">break</span><span class="tok-p">;</span>
    <span class="tok-k">case</span> <span class="tok-nx">Ctes</span><span class="tok-p">.</span><span class="tok-nx">Acciones</span><span class="tok-p">.</span><span class="tok-nx">ABONO</span><span class="tok-o">:</span>
       <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">balance</span> <span class="tok-o">+=</span> <span class="tok-nx">accion</span><span class="tok-p">.</span><span class="tok-nx">cantidad</span><span class="tok-p">;</span>
       <span class="tok-k">break</span><span class="tok-p">;</span>
    <span class="tok-k">case</span> <span class="tok-nx">Ctes</span><span class="tok-p">.</span><span class="tok-nx">Acciones</span><span class="tok-p">.</span><span class="tok-nx">CARGO</span><span class="tok-o">:</span>
       <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">balance</span> <span class="tok-o">-=</span> <span class="tok-nx">accion</span><span class="tok-p">.</span><span class="tok-nx">cantidad</span><span class="tok-p">;</span>
       <span class="tok-k">break</span><span class="tok-p">;</span>
  <span class="tok-p">}</span>
  <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">emitEvent</span><span class="tok-p">(</span><span class="tok-nx">Ctes</span><span class="tok-p">.</span><span class="tok-nx">Eventos</span><span class="tok-p">.</span><span class="tok-nx">CAMBIO_CUENTA</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A este evento lo estarán escuchando una o más vistas, es decir, uno o más componentes de React. Vamos a ver ya el último paso de Flux: cómo detectan los componentes React el cambio de estado y se repintan automáticamente.</p>
</div>
</div>
<div class="sect3">
<h4 id="_los_componentes_react">8.3.5. Los componentes React</h4>
<div class="paragraph">
<p>Hemos transformado el problema de detectar el cambio de estado en el de escuchar el evento <code>Ctes.Eventos.CAMBIO_CUENTA</code>. Usando la librería <code>EventEmitter</code> esto es muy sencillo, simplemente se trata de registrar una función que actúe de <em>listener</em> del evento.</p>
</div>
<div class="paragraph">
<p>Recordemos que en React el <em>re-rendering</em> es automático cada vez que se cambia el estado de un componente con <code>setState</code>, y este cambio va a ser el que vamos a hacer cuando recibamos el evento de cambio de estado del <em>store</em>. Es decir, la idea es que los cambios de estado del <em>store</em> disparen cambios de estado en los componentes.</p>
</div>
<div class="paragraph">
<p>Recordemos también que una buena práctica en React es que el máximo posible de componentes sean sin estado y solo usen <code>props</code>. Pero entonces, si solo tenemos <code>props</code> y no estado, ¿cómo vamos a disparar el <em>re-rendering</em>?. La solución es que por cada árbol de componentes (por cada componente que contenga a otros) tendremos un componente adicional de "nivel superior" que en lugar de tener parte propia de interfaz en realidad actúa como "controlador". Almacena el estado, escucha el evento de cambio y actualiza su estado con la información del <em>store</em>, disparando así el <em>re-rendering</em> de los componentes de niveles inferiores.</p>
</div>
<div class="paragraph">
<p>En nuestro ejemplo vamos a implementar un componente React llamado <code>CajeroController</code> que hará este papel:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">CajeroController</span> <span class="tok-o">=</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">createClass</span><span class="tok-p">({</span>
  <span class="tok-nx">componentDidMount</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>   <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-nx">CuentaStore</span><span class="tok-p">.</span><span class="tok-nx">addListener</span><span class="tok-p">(</span><span class="tok-nx">Ctes</span><span class="tok-p">.</span><span class="tok-nx">Eventos</span><span class="tok-p">.</span><span class="tok-nx">CAMBIO_CUENTA</span><span class="tok-p">,</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">cambiaStoreListener</span><span class="tok-p">)</span>
  <span class="tok-p">},</span>
  <span class="tok-nx">componentWillUnmount</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-nx">CuentaStore</span><span class="tok-p">.</span><span class="tok-nx">removeListener</span><span class="tok-p">(</span><span class="tok-nx">Ctes</span><span class="tok-p">.</span><span class="tok-nx">Eventos</span><span class="tok-p">.</span><span class="tok-nx">CAMBIO_CUENTA</span><span class="tok-p">,</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">cambiaStoreListener</span><span class="tok-p">)</span>
  <span class="tok-p">},</span>
  <span class="tok-nx">cambiaStoreListener</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>  <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">setState</span><span class="tok-p">({</span><span class="tok-nx">balance</span><span class="tok-o">:</span> <span class="tok-nx">CuentaStore</span><span class="tok-p">.</span><span class="tok-nx">getBalance</span><span class="tok-p">()});</span>
  <span class="tok-p">},</span>
  <span class="tok-nx">getInitialState</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>  <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="tok-nx">Acciones</span><span class="tok-p">.</span><span class="tok-nx">crearCuenta</span><span class="tok-p">();</span>
    <span class="tok-k">return</span> <span class="tok-p">{</span><span class="tok-nx">balance</span><span class="tok-o">:</span> <span class="tok-nx">CuentaStore</span><span class="tok-p">.</span><span class="tok-nx">getBalance</span><span class="tok-p">()};</span>
  <span class="tok-p">},</span>
  <span class="tok-nx">render</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>  <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="tok-k">return</span> <span class="tok-o">&lt;</span><span class="tok-nx">Cajero</span> <span class="tok-nx">balance</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">state</span><span class="tok-p">.</span><span class="tok-nx">balance</span><span class="tok-p">}</span><span class="tok-o">/&gt;</span><span class="tok-p">;</span>
  <span class="tok-p">}</span>
<span class="tok-p">});</span>

<span class="tok-kd">var</span> <span class="tok-nx">instancia</span> <span class="tok-o">=</span> <span class="tok-o">&lt;</span><span class="tok-nx">CajeroController</span> <span class="tok-o">/&gt;</span><span class="tok-p">;</span>
<span class="tok-nb">window</span><span class="tok-p">.</span><span class="tok-nx">componente</span> <span class="tok-o">=</span> <span class="tok-nx">ReactDOM</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">(</span><span class="tok-nx">instancia</span><span class="tok-p">,</span> <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s1">&#39;miApp&#39;</span><span class="tok-p">));</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Cuando el componente se monta en el DOM empezamos a escuchar el evento que genera el <em>store</em>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Al desmontar el componente aprovechamos para eliminar el <em>listener</em> del evento.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>El <em>listener</em> lo que hace simplemente es actualizar el estado del componente con la información que viene del <em>store</em>. En este sencillo ejemplo, componente y <em>store</em> almacenan la única variable de estado que hay, pero en un ejemplo más complejo el <em>store</em> podría tener otras variables de estado que no nos interesaran aquí. Recuérdese que el <code>setState</code> además de cambiar el estado dispara el <em>re-rendering</em> del componente, y de los componentes hijos. Con esto hemos conseguido que cada vez que se actualice el <em>store</em> se actualice también el componente.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Aquí vemos un ejemplo de "flecha en la otra dirección" en Flux. Al inicializar el estado del componente, creamos la cuenta. Nótese que no podemos (o no debemos) manipular el <em>store</em> directamente. Lo que hacemos es disparar una acción que a su vez será la que actualice el estado del <em>store</em>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Como vemos el componente que actúa de controlador no tiene HTML por sí mismo, simplemente tiene un componente hijo al que le pasa su estado pero en forma de <code>props</code>. Así conseguimos eliminar el estado del resto de componentes y simplificar su comportamiento.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Vamos a ver el componente <code>Cajero</code> que es el que muestra la interfaz de usuario propiamente dicha:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">Cajero</span> <span class="tok-o">=</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">createClass</span><span class="tok-p">({</span>
        <span class="tok-nx">depositar</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
          <span class="tok-nx">Acciones</span><span class="tok-p">.</span><span class="tok-nx">depositarEnCuenta</span><span class="tok-p">(</span><span class="tok-nb">Number</span><span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">refs</span><span class="tok-p">.</span><span class="tok-nx">cantidad</span><span class="tok-p">.</span><span class="tok-nx">value</span><span class="tok-p">));</span>
        <span class="tok-p">},</span>
        <span class="tok-nx">reintegrar</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
          <span class="tok-nx">Acciones</span><span class="tok-p">.</span><span class="tok-nx">sacarDeCuenta</span><span class="tok-p">(</span><span class="tok-nb">Number</span><span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">refs</span><span class="tok-p">.</span><span class="tok-nx">cantidad</span><span class="tok-p">.</span><span class="tok-nx">value</span><span class="tok-p">));</span>
        <span class="tok-p">},</span>
        <span class="tok-nx">render</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
          <span class="tok-k">return</span> <span class="tok-p">(</span>
            <span class="tok-o">&lt;</span><span class="tok-nx">div</span><span class="tok-o">&gt;</span>
               <span class="tok-o">&lt;</span><span class="tok-nx">h1</span><span class="tok-o">&gt;</span><span class="tok-p">{</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">props</span><span class="tok-p">.</span><span class="tok-nx">balance</span><span class="tok-p">}</span><span class="tok-o">&lt;</span><span class="tok-err">/h1&gt;</span>
               <span class="tok-o">&lt;</span><span class="tok-nx">input</span> <span class="tok-nx">type</span><span class="tok-o">=</span><span class="tok-s2">&quot;text&quot;</span> <span class="tok-nx">ref</span><span class="tok-o">=</span><span class="tok-s2">&quot;cantidad&quot;</span><span class="tok-o">/&gt;</span>
               <span class="tok-o">&lt;</span><span class="tok-nx">button</span> <span class="tok-nx">onClick</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">depositar</span><span class="tok-p">}</span><span class="tok-o">&gt;</span><span class="tok-nx">Depositar</span><span class="tok-o">&lt;</span><span class="tok-err">/button&gt;</span>
               <span class="tok-o">&lt;</span><span class="tok-nx">button</span> <span class="tok-nx">onClick</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">reintegrar</span><span class="tok-p">}</span><span class="tok-o">&gt;</span><span class="tok-nx">Reintegrar</span><span class="tok-o">&lt;</span><span class="tok-err">/button&gt;</span>
            <span class="tok-o">&lt;</span><span class="tok-err">/div&gt;</span>
          <span class="tok-p">)</span>
        <span class="tok-p">}</span>
<span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El componente lo primero que hace es mostrar el balance de la cuenta, que él ha recibido del componente "controlador" como un <code>prop</code> (para evitar tener que guardar su propio estado). Luego tenemos un cuadro de texto en el que tecleamos una cantidad y unos botones para "depositar" esta cantidad en la cuenta o hacer el reintegro de la misma. Esos botones están vinculados con métodos que lo que hacen es disparar las correspondientes acciones de <code>depositarEnCuenta</code> y <code>reintegrarEnCuenta</code>, que a su vez serán despachadas al <em>store</em>, que a su vez actualizará su estado y avisará al componente "controlador", cerrando así un nuevo ciclo de Flux.</p>
</div>
</div>
<div class="sect3">
<h4 id="_coordinación_entre_em_stores_em">8.3.6. Coordinación entre <em>stores</em></h4>
<div class="paragraph">
<p>Hasta ahora en el ejemplo solo tenemos un <em>store</em>, pero vamos a ver qué sucede si introducimos uno adicional. Por poner un caso simple, supongamos que el banco hace una promoción en la que da distintos regalos a los clientes según el saldo que tengan en la cuenta. Crearemos un <em>store</em> para almacenar los datos del regalo que debería recibir el cliente con el saldo actual. Para simplificar almacenaremos solo el nombre del regalo. Cada vez que se cambie el saldo de la cuenta este se actualizará. Nótese que para que esto funcione, <em>primero</em> se debe actualizar el saldo y <em>después</em> el regalo. Es decir, debe haber una coordinación entre <em>stores</em>.</p>
</div>
<div class="paragraph">
<p>Al procesar una acción en un <em>store</em> podemos especificar que primero tienen que haberla procesado otros <em>stores</em>. Para ello se usa el método <code>waitFor</code> del <em>dispatcher</em>, al que se le pasa un array con los "identificadores" o <em>dispatch token</em> de los <em>stores</em> a los que hay que esperar. Este método se "bloqueará" hasta que hayan procesado la acción. El <em>dispatch token</em> de un <em>store</em> se obtiene como resultado de la llamada al método <code>register</code> del <em>dispatcher</em> (hasta el momento habíamos ignorado este valor de retorno). Es decir, al registrar un <em>store</em> con el <em>dispatcher</em>, haremos algo como:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">CuentaStore</span><span class="tok-p">.</span><span class="tok-nx">dispatchToken</span> <span class="tok-o">=</span> <span class="tok-nx">MiDispatcher</span><span class="tok-p">.</span><span class="tok-nx">register</span><span class="tok-p">(</span><span class="tok-nx">CuentaStore</span><span class="tok-p">.</span><span class="tok-nx">manejarAccion</span><span class="tok-p">.</span><span class="tok-nx">bind</span><span class="tok-p">(</span><span class="tok-nx">CuentaStore</span><span class="tok-p">));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Vamos a ver el código del nuevo <em>store</em>, al que llamaremos <code>PromocionStore</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">PromocionStore</span> <span class="tok-o">=</span> <span class="tok-nb">Object</span><span class="tok-p">.</span><span class="tok-nx">assign</span><span class="tok-p">({},</span> <span class="tok-nx">EventEmitter</span><span class="tok-p">.</span><span class="tok-nx">prototype</span><span class="tok-p">,</span> <span class="tok-p">{</span>
      <span class="tok-nx">promocion</span> <span class="tok-o">:</span> <span class="tok-s1">&#39;&#39;</span><span class="tok-p">,</span>
      <span class="tok-nx">getPromocion</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
        <span class="tok-k">return</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">promocion</span><span class="tok-p">;</span>
      <span class="tok-p">},</span>
      <span class="tok-nx">manejarAccion</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">accion</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-nx">MiDispatcher</span><span class="tok-p">.</span><span class="tok-nx">waitFor</span><span class="tok-p">([</span><span class="tok-nx">CuentaStore</span><span class="tok-p">.</span><span class="tok-nx">dispatchToken</span><span class="tok-p">]);</span>
        <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">accion</span><span class="tok-p">.</span><span class="tok-nx">tipo</span><span class="tok-o">==</span><span class="tok-nx">Ctes</span><span class="tok-p">.</span><span class="tok-nx">Acciones</span><span class="tok-p">.</span><span class="tok-nx">ABONO</span> <span class="tok-o">||</span> <span class="tok-nx">accion</span><span class="tok-p">.</span><span class="tok-nx">tipo</span><span class="tok-o">==</span><span class="tok-nx">Ctes</span><span class="tok-p">.</span><span class="tok-nx">Acciones</span><span class="tok-p">.</span><span class="tok-nx">CARGO</span><span class="tok-p">)</span> <span class="tok-p">{</span>
          <span class="tok-kd">var</span> <span class="tok-nx">saldo</span> <span class="tok-o">=</span> <span class="tok-nx">CuentaStore</span><span class="tok-p">.</span><span class="tok-nx">getBalance</span><span class="tok-p">();</span>
          <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">saldo</span><span class="tok-o">&gt;</span><span class="tok-mi">0</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-nx">saldo</span><span class="tok-o">&lt;</span><span class="tok-mi">1000</span><span class="tok-p">)</span>
            <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">promocion</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;Taza de Hello Kitty&#39;</span><span class="tok-p">;</span>
          <span class="tok-k">else</span> <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">saldo</span><span class="tok-o">&gt;</span><span class="tok-mi">1000</span><span class="tok-p">)</span>
            <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">promocion</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;Vajilla completa&#39;</span><span class="tok-p">;</span>
        <span class="tok-p">}</span>
        <span class="tok-k">else</span> <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">accion</span><span class="tok-p">.</span><span class="tok-nx">tipo</span><span class="tok-o">==</span><span class="tok-nx">Ctes</span><span class="tok-p">.</span><span class="tok-nx">Acciones</span><span class="tok-p">.</span><span class="tok-nx">CUENTA_CREADA</span><span class="tok-p">)</span> <span class="tok-p">{</span>
          <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">promocion</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;&#39;</span><span class="tok-p">;</span>
        <span class="tok-p">}</span>
        <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">emitEvent</span><span class="tok-p">(</span><span class="tok-nx">Ctes</span><span class="tok-p">.</span><span class="tok-nx">Eventos</span><span class="tok-p">.</span><span class="tok-nx">CAMBIO_PROMOCION</span><span class="tok-p">);</span>
      <span class="tok-p">}</span>
  <span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lo primero que hacemos al manejar la acción es esperar a <code>CuentaStore</code>. Una vez que se ha actualizado su estado, ya podemos usar el balance de la cuenta para determinar el regalo al que tiene derecho el cliente. Una vez terminado el procesamiento de la acción, emitimos un nuevo evento: <code>Ctes.Eventos.CAMBIO_PROMOCION</code> (que debemos haber definido en nuestro código, aunque aquí no mostramos la defición).</p>
</div>
<div class="paragraph">
<p>Tendremos que modificar el componente React <code>CajeroController</code> para que escuche el nuevo evento y actualice su estado en respuesta a él:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">CajeroController</span> <span class="tok-o">=</span> <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">createClass</span><span class="tok-p">({</span>
    <span class="tok-nx">componentDidMount</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
      <span class="tok-nx">CuentaStore</span><span class="tok-p">.</span><span class="tok-nx">addListener</span><span class="tok-p">(</span><span class="tok-nx">Ctes</span><span class="tok-p">.</span><span class="tok-nx">Eventos</span><span class="tok-p">.</span><span class="tok-nx">CAMBIO_CUENTA</span><span class="tok-p">,</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">cambiaStoreListener</span><span class="tok-p">)</span>
      <span class="tok-nx">PromocionStore</span><span class="tok-p">.</span><span class="tok-nx">addListener</span><span class="tok-p">(</span><span class="tok-nx">Ctes</span><span class="tok-p">.</span><span class="tok-nx">Eventos</span><span class="tok-p">.</span><span class="tok-nx">CAMBIO_PROMOCION</span><span class="tok-p">,</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">cambiaStoreListener</span><span class="tok-p">)</span>
    <span class="tok-p">},</span>
    <span class="tok-nx">componentWillUnmount</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
      <span class="tok-nx">CuentaStore</span><span class="tok-p">.</span><span class="tok-nx">removeListener</span><span class="tok-p">(</span><span class="tok-nx">Ctes</span><span class="tok-p">.</span><span class="tok-nx">Eventos</span><span class="tok-p">.</span><span class="tok-nx">CAMBIO_CUENTA</span><span class="tok-p">,</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">cambiaStoreListener</span><span class="tok-p">)</span>
      <span class="tok-nx">PromocionStore</span><span class="tok-p">.</span><span class="tok-nx">removeListener</span><span class="tok-p">(</span><span class="tok-nx">Ctes</span><span class="tok-p">.</span><span class="tok-nx">Eventos</span><span class="tok-p">.</span><span class="tok-nx">CAMBIO_PROMOCION</span><span class="tok-p">,</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">cambiaStoreListener</span><span class="tok-p">)</span>
    <span class="tok-p">},</span>
    <span class="tok-nx">cambiaStoreListener</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
      <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">setState</span><span class="tok-p">({</span><span class="tok-nx">balance</span><span class="tok-o">:</span> <span class="tok-nx">CuentaStore</span><span class="tok-p">.</span><span class="tok-nx">getBalance</span><span class="tok-p">(),</span> <span class="tok-nx">regalo</span><span class="tok-o">:</span> <span class="tok-nx">PromocionStore</span><span class="tok-p">.</span><span class="tok-nx">getPromocion</span><span class="tok-p">()});</span>
    <span class="tok-p">},</span>
    <span class="tok-nx">getInitialState</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
      <span class="tok-nx">Acciones</span><span class="tok-p">.</span><span class="tok-nx">crearCuenta</span><span class="tok-p">();</span>
      <span class="tok-k">return</span> <span class="tok-p">{</span><span class="tok-nx">balance</span><span class="tok-o">:</span> <span class="tok-nx">CuentaStore</span><span class="tok-p">.</span><span class="tok-nx">getBalance</span><span class="tok-p">(),</span> <span class="tok-nx">regalo</span><span class="tok-o">:</span> <span class="tok-nx">PromocionStore</span><span class="tok-p">.</span><span class="tok-nx">getPromocion</span><span class="tok-p">()};</span>
    <span class="tok-p">},</span>
    <span class="tok-nx">render</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
      <span class="tok-k">return</span> <span class="tok-o">&lt;</span><span class="tok-nx">Cajero</span> <span class="tok-nx">balance</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">state</span><span class="tok-p">.</span><span class="tok-nx">balance</span><span class="tok-p">}</span> <span class="tok-nx">regalo</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">state</span><span class="tok-p">.</span><span class="tok-nx">regalo</span><span class="tok-p">}</span><span class="tok-o">/&gt;</span><span class="tok-p">;</span>
    <span class="tok-p">}</span>
  <span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Al montar el componente tenemos que añadir un nuevo <em>listener</em> para el nuevo evento. Podríamos haber usado un <em>listener</em> para cada evento, pero para simplificar hemos usado el mismo que ya teníamos, solo que ahora ampliamos el estado con una nueva variable para almacenar el regalo que se le puede hacer al cliente. El componente de interfaz <code>Cajero</code> admite una nueva <code>prop</code> con esta información.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="sesion08ejer">8.4. Ejercicio de Flux (1,25 puntos en total)</h3>
<div class="paragraph">
<p>Rediseña (¡cómo no!) el <em>widget</em> del tiempo para usar la arquitectura Flux.</p>
</div>
<div class="sect3">
<h4 id="_acciones_0_4_puntos">8.4.1. Acciones (0,4 puntos)</h4>
<div class="paragraph">
<p>Lo primero que debes hacer es identificar las acciones de tu aplicación. A primera vista la única acción que habría sería la de "Actualizar el tiempo", disparada cuando el usuario pulsa sobre el botón de "Ver tiempo". No obstante esta acción comunica de forma asíncrona con el servidor, por lo que necesitaremos dos acciones más para representar la respuesta de éste (respuesta OK con los datos del tiempo a mostrar, y respuesta de error).</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Define las constantes que creas apropiadas para representar las tres acciones.</p>
</li>
<li>
<p>Implementa el <em>creador de acciones</em>. Al crear la acción de "actualizar el tiempo" es cuando se hará la petición al API del  servidor, y desde el <em>callback</em> de la petición es desde donde se llamará a las otras dos acciones.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Para comprobar el caso en que el servidor devuelve un error lo más sencillo es poner la localidad vacía, ya que si se escribe una cadena arbitraria el API buscará un nombre similar en lugar de devolver un error.</p>
</div>
</div>
<div class="sect3">
<h4 id="_stores_0_4_puntos">8.4.2. Stores (0,4 puntos)</h4>
<div class="paragraph">
<p>Implementa el <code>TiempoStore</code>, que como propiedades debe tener como mínimo la "descripción" del tiempo (sol, nubes,&#8230;&#8203;) y la url del icono que lo representa. Cuando se actualice el tiempo con éxito o se actualice con error debes generar los eventos apropiados.</p>
</div>
</div>
<div class="sect3">
<h4 id="_componente_react_0_45_puntos">8.4.3. Componente React (0,45 puntos)</h4>
<div class="paragraph">
<p>Modifica el componente React de la sesión anterior para que tome los datos de <code>TiempoStore</code>,escuchando los eventos correspondientes, y para que al pulsar en el botón de <code>Ver tiempo</code> se llame ahora a la acción correspondiente.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="apendice01">9. Apéndice: Herramientas para gestionar el flujo de trabajo en el desarrollo <em>frontend</em></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Durante mucho tiempo la forma habitual de usar librerías Javascript en una aplicación ha sido ir a la web de la librería, bajarse el <code>.zip</code> con la última versión e incluir la librería y las dependencias con etiquetas <code>&lt;script src=""&gt;</code>. Sin embargo esta ya no es la manera más común de trabajar en el lado del servidor desde hace algún tiempo. Las librerías no se suelen bajar manualmente de la web sino que se usan herramientas como Maven para gestionar automáticamente las dependencias y generar una plantilla para no tener que partir de cero. Con el aumento de la complejidad de las aplicaciones en el lado del cliente también ha surgido un conjunto de herramientas para gestionar más o menos las mismas cosas que podemos gestionar con Maven.</p>
</div>
<div class="paragraph">
<p>Aunque las herramientas del lado del cliente todavía no están tan maduras como las del lado del servidor, han surgido algunas que se han ido imponiendo como estándares "de facto". Vamos a instalar aquí tres de ellas, que iremos usando a lo largo de los ejercicios de la asignatura.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
La variedad y complejidad de las herramientas de desarrollo para <em>frontend</em> ha "explotado" en los últimos tiempos, para dar soporte a los cada vez más complejos flujos de trabajo del proceso de desarrollo en el cliente. Como información adicional sobre otras (muchas) herramientas existentes podéis consultar <a href="https://speakerdeck.com/addyosmani/front-end-tooling-workflows">estas transparencias</a> de Addy Osmani o echarle un vistazo a <a href="https://www.youtube.com/playlist?list=PLMh6HwjXBltUZ4IixGItJ_pSG6NN3mlQr/">esta <em>playlist</em></a> de YouTube con interesantes charlas sobre el tema.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Muchas herramientas de <em>frontend</em> están implementadas en Javascript (¿Qué mejor que una herramienta en Javascript para trabajar con aplicaciones Javascript?). Y la mayoría de las implementadas en este lenguaje usan <a href="http://nodejs.org/">Node.js</a> como soporte, básicamente porque es un intérprete JS que puede realizar operaciones que son necesarias para una herramienta de desarrollo pero que no se pueden hacer desde el navegador, como escribir en el sistema de archivos local.</p>
</div>
<div class="paragraph">
<p>En la máquina virtual del curso ya está instalado <code>Node.js</code> junto con su gestor de paquetes, <code>npm</code>. Usaremos este último para instalar las tres herramientas de desarrollo que vamos a necesitar: <a href="http://yeoman.io/">Yeoman</a>, <a href="http://bower.io/">Bower</a> y <a href="http://gruntjs.com/">Grunt</a> (las dos últimas son dependencias de la primera).</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
En principio las herramientas habría que instalarlas en modo superusuario. Son paquetes de <code>npm</code> que se instalan en modo global <code>-g</code> para que estén disponibles desde cualquier directorio, y por defecto esto instalaría archivos en directorios del sistema. Una alternativa es cambiar el <code>prefix</code> de <code>npm</code> para que instale siempre los paquetes en el directorio del usuario. <a href="https://github.com/sindresorhus/guides/blob/master/npm-global-without-sudo.md">Esta alternativa es la recomendada</a> por muchos desarrolladores, por ser más segura.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
para poder instalar globalmente paquetes de <code>npm</code> de forma sencilla sin privilegios de superusuario puedes ejecutar primero <a href="https://raw.githubusercontent.com/glenpike/npm-g_nosudo/master/npm-g-no-sudo.sh">este script</a> (con <a href="https://github.com/glenpike/npm-g_nosudo">repositorio</a> en Github). Irónicamente, lo primero que hace el <em>script</em> es pedir permisos de superusuario. Luego cambiará el prefijo de la instalación de paquetes npm y nos pedirá permiso para modificar el <code>.bashrc</code> para que <code>npm</code> tenga en cuenta el nuevo prefijo a partir de ahora.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para instalar yeoman, abrir una terminal y teclear:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">npm install -g yo bower grunt-cli</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tras un rato en el que se instalarán unos cuantos paquetes de Node, si todo ha ido bien podremos empezar a trabajar con las herramientas. En la documentación de Yeoman hay una imagen bastante ilustrativa de la relación entre las tres y el papel que desempeña cada una.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/01/workflow.png" alt="workflow" width="50%">
</div>
<div class="title">Figure 16. Flujo de trabajo con <code>Yeoman</code>, <code>Bower</code> y <code>Grunt</code> <a href="http://yeoman.io/learning/index.html">(página original)</a></div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Grunt</strong> es una herramienta para automatizar tareas repetitivas. La podríamos asimilar al <code>make</code> de C (o al "antiguo" <code>ant</code> de Java).</p>
</li>
<li>
<p><strong>Bower</strong> es un gestor de dependencias entre paquetes. Con él podemos bajarnos una determinada versión de una librería Javascript y automáticamente todas sus dependencias.</p>
</li>
<li>
<p><strong>Yeoman</strong> es un generador de plantillas para no tener que partir de cero cada vez que comencemos una nueva aplicación web. Haría más o menos el mismo papel que hacen los arquetipos en Maven. Depende de <code>Bower</code> y <code>Grunt</code> (o mas genéricamente, depende de un gestor de paquetes y de un sistema de automatización, es configurable para trabajar con otros, por ejemplo <code>npm</code> y <code>gulp</code> respectivamente).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Por el momento vamos a dejar a Grunt un poco apartado y vamos a ver cómo trabajar con las otras dos herramientas a nivel básico.</p>
</div>
<div class="sect2">
<h3 id="_gestión_de_paquetes_con_code_bower_code">9.1. Gestión de paquetes con <code>Bower</code></h3>
<div class="paragraph">
<p>Bower facilita la tarea de bajarse librerías junto con sus dependencias. Al igual que con Maven, hay un registro centralizado de "artefactos" que especifica las relaciones de dependencia. Podemos buscar librerías desde línea de comandos con <code>search</code>. Por ejemplo, podemos teclear en la terminal</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">bower search backbone</code></pre>
</div>
</div>
<div class="paragraph">
<p>para ver todos los paquetes que contienen <code>backbone</code> en el nombre (que como podemos ver, son muchos). Para bajarse una librería usamos el comando <code>install</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">bower install backbone</code></pre>
</div>
</div>
<div class="paragraph">
<p>Este comando nos instalará <code>backbone</code> y sus dependencias directas (underscore). Lo que hace es bajárselo a un directorio llamado <code>bower_components</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Bower se baja las dependencias, pero el cómo las usemos en nuestro proyecto ya es cosa nuestra. Nos tocará incluir los .js manualmente con las típicas <code>&lt;script src=""&gt;</code>. Alternativamente también podemos usar herramientas que pueden hacer esto por nosotros, como Yeoman.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_creación_de_plantillas_con_code_yeoman_code">9.2. Creación de plantillas con <code>Yeoman</code></h3>
<div class="paragraph">
<p>Con yeoman podemos generar la estructura básica de nuestra aplicación, para no tener que partir de cero. Como ya hemos dicho es algo similar a los arquetipos de Maven.</p>
</div>
<div class="paragraph">
<p>Para poder crear una plantilla de aplicación que use una determinada tecnología (Backbone, Angular, Bootstrap,&#8230;&#8203;) necesitamos que alguien haya desarrollado un <em>generador</em>. El <a href="http://yeoman.io/generators/">repositorio de Yeoman</a> tiene un gran número de ellos, y por supuesto también podríamos definirlo nosotros.</p>
</div>
<div class="paragraph">
<p>Por ejemplo el generador básico para aplicaciones backbone se llama <a href="https://github.com/yeoman/generator-backbone">"generator-backbone"</a>. Lo instalamos con</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">npm install -g generator-backbone</code></pre>
</div>
</div>
<div class="paragraph">
<p>Una vez instalado el generador, podemos generar una plantilla de aplicación Backbone sin más que ejecutar</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">yo backbone <span class="tok-o">[</span>nombre-de-la-aplicación<span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_npm_em_bundler_em">9.3. npm + <em>bundler</em></h3>
<div class="paragraph">
<p>Una opción que se está popularizando enormemente en los últimos tiempos es usar directamente <code>npm</code> como gestor de paquetes también para el <em>frontend</em>. Este sistema de módulos es muy sencillo: cuando vamos a referenciar uno lo hacemos con la instrucción <code>require</code>. Esta instrucción nos devuelve un valor que para la mayoría de módulos es un objeto que encapsula el API.</p>
</div>
<div class="paragraph">
<p>Veamos un ejemplo sencillo de uso: por ejemplo el módulo <code>detect-browser</code> nos devuelve el nombre y versión del navegador en que estamos. Lo primero es instalar el paquete con npm</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">npm install --save detect-browser</code></pre>
</div>
</div>
<div class="paragraph">
<p>y luego en nuestro código haríamos algo como:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">navegador</span> <span class="tok-o">=</span> <span class="tok-nx">require</span><span class="tok-p">(</span><span class="tok-s1">&#39;detect-browser&#39;</span><span class="tok-p">);</span>
<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">navegador</span><span class="tok-p">.</span><span class="tok-nx">name</span><span class="tok-p">);</span>
<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">navegador</span><span class="tok-p">.</span><span class="tok-nx">version</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El problema es que este código no es usable directamente desde el navegador, ya que por desgracia los navegadores no ofrecen soporte nativo para <code>CommonJS</code>. Y aquí es donde intervienen unas herramientas denominadas genéricamente <em>bundlers</em>. El <em>bundler</em> toma nuestro código y los módulos referenciados por él con <code>require</code> y los une en un único archivo JS (un <em>bundle</em>), que contiene todo el Javascript necesario y que sí es usable directamente desde el navegador.</p>
</div>
<div class="paragraph">
<p>En la actualidad los <em>bundler</em> más usados son <a href="http://browserify.org">browserify</a> y <a href="https://webpack.github.io">webpack</a>. Este último está ganando bastante tracción últimamente, aunque es un poco más complicado de usar, por lo que vamos a ver un ejemplo sencillo pero completo de código React usando <code>browserify</code>.</p>
</div>
<div class="sect3">
<h4 id="_uso_de_code_browserify_code">9.3.1. Uso de <code>browserify</code></h4>
<div class="paragraph">
<p>Lo primero es <strong>instalar el propio <code>browserify</code></strong>, que se distribuye en forma de paquete <code>npm</code>. Es una herramienta en línea de comandos, por lo que la instalaremos con el <em>switch</em> <code>-g</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">npm install -g browserify</code></pre>
</div>
</div>
<div class="paragraph">
<p>Vamos a usarlo con React. Lo primero es instalar los paquetes necesarios con npm:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">npm install --save react react-dom</code></pre>
</div>
</div>
<div class="paragraph">
<p>y luego escribir el código React en un archivo <code>ejemplo.js</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">React</span> <span class="tok-o">=</span> <span class="tok-nx">require</span><span class="tok-p">(</span><span class="tok-s1">&#39;react&#39;</span><span class="tok-p">);</span>
<span class="tok-kd">var</span> <span class="tok-nx">ReactDOM</span> <span class="tok-o">=</span> <span class="tok-nx">require</span><span class="tok-p">(</span><span class="tok-s1">&#39;react-dom&#39;</span><span class="tok-p">);</span>

<span class="tok-nx">ReactDOM</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">(</span>
  <span class="tok-nx">React</span><span class="tok-p">.</span><span class="tok-nx">DOM</span><span class="tok-p">.</span><span class="tok-nx">h1</span><span class="tok-p">(</span><span class="tok-kc">null</span><span class="tok-p">,</span> <span class="tok-s1">&#39;¡Hola React!&#39;</span><span class="tok-p">),</span>
  <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s1">&#39;miApp&#39;</span><span class="tok-p">)</span>
<span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora tenemos que transformar el <code>ejemplo.js</code> junto con todo el código de React que referencie en un único archivo .js que podemos llamar <code>bundle.js</code>. Este archivo podemos generarlo en línea de comandos con <code>browserify</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">browserify ejemplo.js -o bundle.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>Y este <code>bundle.js</code> ya podemos incluirlo en nuestro HTML al "modo clásico", porque ya es usable desde el navegador:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html">...
<span class="tok-nt">&lt;div</span> <span class="tok-na">id=</span><span class="tok-s">&quot;miApp&quot;</span><span class="tok-nt">&gt;&lt;/div&gt;</span>
<span class="tok-nt">&lt;script </span><span class="tok-na">src=</span><span class="tok-s">&quot;bundle.js&quot;</span><span class="tok-nt">&gt;&lt;/script&gt;</span>
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Un problema que se nos va a plantear al cargar el <code>bundle.js</code> en el navegador en lugar del archivo original es que se complica mucho la detección de errores y la depuración, ya que <code>browserify</code> no detecta los errores en el código, se detectan al cargarlos en el navegador, y por tanto los mensajes de error se referirán a las líneas del archivo <code>bundle.js</code>. Tampoco  podremos usar el depurador integrado en el navegador para depurar el código original.</p>
</div>
<div class="paragraph">
<p>Para solucionar esto podemos decirle a <code>browserify</code> que genere un <em>source map</em>, que es un archivo que mapea la relación entre el código original y el resultante, permitiéndonos depurar sobre el código original. Basta con pasarle el <em>switch</em> <code>-d</code> a <code>broswerify</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">browserify -o bundle.js -d ejemplo.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>Otro problema es la incomodidad de tener que estar ejecutando manualmente la orden anterior cada vez que modificamos el código. Para solucionarlo existe una serie de herramientas que detectan cambios automáticamente en el fichero original y generan el <em>bundle</em> automáticamente. La más conocida es <code>watchify</code>. Se instala con <code>npm</code> (usando <code>-g</code>, ya que instala una herramienta en línea de comandos) y su uso es muy sencillo, simplemente hay que reemplazar <code>browserify</code> por <code>watchify</code>, y dejar la orden ejecutándose permanentemente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">watchify -o bundle.js -d ejemplo.js</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="__code_browserify_code_y_babel">9.3.2. <code>browserify</code> y babel</h4>
<div class="paragraph">
<p>En el tema de React hemos visto que para usar JSX tenemos que emplear una librería denominada <code>babel</code>, que se encarga de traducir (o <em>transpilar</em>) el código JSX a código Javascript nativo. Cuando explicábamos el tema hacíamos la transformación en el propio navegador, pero esto presenta dos problemas: por un lado, la transpilación tiene un coste en tiempo, lo que no es apropiado en aplicaciones en producción. Además tenemos el mismo problema que al hacer <em>bundling</em>: se dificulta la depuración y la detección de errores. Por esto se suele recomendar que la transpilación la haga alguna herramienta antes de cargar el código en el navegador, y dejar la transformación en el navegador para pruebas rápidas.</p>
</div>
<div class="paragraph">
<p>Primero necesitamos instalar un par de paquetes <code>npm</code> adicionales:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">npm install --save babelify babel-preset-react</code></pre>
</div>
</div>
<div class="paragraph">
<p>Luego debemos crear un fichero de configuración para Babel llamado <code>.babelrc</code> en el directorio del proyecto. El contenido del fichero depende del uso que estemos haciendo de Babel, en nuestro caso lo usamos para React, así que contendría lo siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span> <span class="tok-s2">&quot;presets&quot;</span><span class="tok-o">:</span> <span class="tok-p">[</span><span class="tok-s2">&quot;react&quot;</span><span class="tok-p">]</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finalmente debemos pasarle a <code>browserify</code> el <em>switch</em> <code>-t babelify</code> para que se haga la transpilación:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">browserify -t babelify -d ejemplo.jsx -o bundle.js</code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="apendice02">10. Apéndice: <em>testing</em> con Backbone</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Backbone es <em>agnóstico</em> en cuanto a qué <em>framework</em> de <em>testing</em> usar. Nosotros emplearemos Jasmine, que es bastante sencillo de usar ya que está "autocontenido" (incluye el <em>test runner</em>, las aserciones e incluso métodos para generar <em>mocks</em>). No obstante puedes encontrar muchos libros y tutoriales sobre Backbone que usan <em>frameworks</em> de testing con otra filosofía más de "juntar las piezas", como por ejemplo <a href="https://mochajs.org">Mocha</a>. Para usar esta última necesitamos además una librería adicional que implemente las aserciones, otra para generar <em>mocks</em>, etc.</p>
</div>
<div class="paragraph">
<p>Jasmine es una herramienta de <em>testing</em> que sigue el paradigma BDD (Behavior Driven Development), y como tal usa la terminología habitual en este paradigma, un poco diferente de la habitualmente usada en las pruebas unitarias "clásicas".</p>
</div>
<div class="sect2">
<h3 id="_introducción_a_jasmine">10.1. Introducción a Jasmine</h3>
<div class="sect3">
<h4 id="_suites_y_casos_de_prueba">10.1.1. Suites y casos de prueba</h4>
<div class="paragraph">
<p>Al igual que en cualquier herramienta de tipo xUnit, las pruebas se escriben como <strong>casos de prueba</strong> y estos se agrupan en <em>*suites*</em>. No obstante la sintaxis es algo distinta a la tradicional en xUnit.</p>
</div>
<div class="paragraph">
<p>Para empezar, las pruebas no se suelen llamar <em>tests</em> sino <em>specs</em> (de "especificaciones"). Así, es habitual colocar el código de prueba en archivos con sufijo <code>spec.js</code>, en lugar del que sería más "tradicional" <code>test.js</code>.</p>
</div>
<div class="paragraph">
<p>Las <em>suites</em> se definen con <code>describe</code>, seguido de una cadena con la descripción de la <em>suite</em> y una función que encapsula todo su código. Cada caso de prueba (cada <em>spec</em>, por seguir la terminología habitual) se define de manera similar, usando la palabra <code>it</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">describe</span><span class="tok-p">(</span><span class="tok-s1">&#39;Préstamo de libros&#39;</span><span class="tok-p">,</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-nx">it</span><span class="tok-p">(</span><span class="tok-s1">&#39;Un libro recién creado no debería estar prestado&#39;</span><span class="tok-p">,</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-p">...</span>
  <span class="tok-p">});</span>
  <span class="tok-nx">it</span><span class="tok-p">(</span><span class="tok-s1">&#39;Al prestar un libro debería dejar de estar disponible&#39;</span><span class="tok-p">,</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-p">...</span>
  <span class="tok-p">});</span>
  <span class="tok-p">...</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Como vemos, la idea de esta estructura es que quede clara cuál es la intención de cada <em>suite</em> y de cada caso de prueba. Las "etiquetas" de texto de <code>describe</code> e <code>it</code> sustituyen a los nombres de los métodos de <em>test</em> en xUnit, que si quereremos que sean descriptivos resultan engorrosos (<code>testLibroRecienCreadoNoDeberiaEstarPrestado</code>).</p>
</div>
<div class="paragraph">
<p>Las <em>suites</em> de pruebas pueden contener a su vez otras <em>suites</em>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
en algunos casos puede que tengamos una <em>spec</em> a medio crear y necesitemos ejecutar las pruebas. En lugar de comentarla para que no dé error, podemos ponerle una <code>x</code> delante al <code>it</code> (cambiarlo por <code>xit</code>). No se ejecutará, y en el informe de ejecución de Jasmine se marcará la prueba como pendiente. Podemos hacer lo propio con una <em>suite</em> al completo (<code>xdescribe</code>).
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_expectativas_y_em_matchers_em">10.1.2. Expectativas y <em>matchers</em></h4>
<div class="paragraph">
<p>En el mundo <em>xUnit</em> las comprobaciones sobre el código se suelen hacer con <code>assert</code>. En cambio en BDD se suele usar la forma <code>expect</code> (que indica que esperamos determinado resultado, o que se cumpla determinada condición). Los partidarios de esta sintaxis defienden que mejora la legibilidad de las pruebas al hacer la sintaxis más similar a la del lenguaje natural.</p>
</div>
<div class="paragraph">
<p>Las expectativas se construyen con <code>expect</code> sobre una expresión, que es el valor real que queremos comprobar. El <code>expect</code> se encadena con el valor deseado a través de un <em>matcher</em>. El más sencillo es el de igualdad, <code>toBe</code>, equivalente a comprobar si el valor real es <code>==</code> al deseado.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">it</span><span class="tok-p">(</span><span class="tok-s2">&quot;Prueba de ser o no ser&quot;</span><span class="tok-p">,</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-nx">a</span> <span class="tok-o">=</span> <span class="tok-kc">true</span><span class="tok-p">;</span>
    <span class="tok-nx">expect</span><span class="tok-p">(</span><span class="tok-nx">a</span><span class="tok-p">).</span><span class="tok-nx">toBe</span><span class="tok-p">(</span><span class="tok-kc">true</span><span class="tok-p">);</span>
    <span class="tok-nx">expect</span><span class="tok-p">(</span><span class="tok-nx">a</span><span class="tok-p">).</span><span class="tok-nx">not</span><span class="tok-p">.</span><span class="tok-nx">toBe</span><span class="tok-p">(</span><span class="tok-kc">false</span><span class="tok-p">);</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Como vemos en el ejemplo, <code>not</code> se puede usar antes de cualquier <em>matcher</em> para invertir el sentido.</p>
</div>
<div class="paragraph">
<p>Jasmine tiene un amplio conjunto de <em>matchers</em> para comprobar si dos valores primitivos son iguales (el <code>toBe</code> que ya hemos visto), si lo son dos objetos (<code>toEqual</code>), si una cadena encaja con una expresión regular (<code>toMatch</code>), si un valor es <code>undefined</code> (<code>toBeUndefined</code>), o <code>null</code> (<code>toBeNull</code>), si un array contiene un valor (<code>toContain</code>),&#8230;&#8203; La documentación de Jasmine contiene <a href="http://jasmine.github.io/2.1/introduction.html#section-Included_Matchers">numerosos ejemplos</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_configuración_de_cada_prueba">10.1.3. Configuración de cada prueba</h4>
<div class="paragraph">
<p>Podemos ejecutar código para preparar las pruebas, bien antes de la suite (<code>beforeAll</code>) o bien antes de cada prueba (<code>beforeEach</code>). Igualmente podemos ejecutar código  de "limpieza" cuando acabe la suite (<code>afterAll</code>) o después de cada prueba (<code>afterEach</code>)</p>
</div>
</div>
<div class="sect3">
<h4 id="_ejecutar_las_pruebas">10.1.4. Ejecutar las pruebas</h4>
<div class="paragraph">
<p>Podemos bajar un .zip con la versión actual de Jasmine de la página con las <a href="https://github.com/jasmine/jasmine/releases">releases</a>, del <a href="https://github.com/jasmine/jasmine">repositorio</a> en Github.</p>
</div>
<div class="paragraph">
<p>Al descomprimirlo veremos en la raíz un archivo <code>specRunner.html</code>.  Es una plantilla que nos puede servir de base para ejecutar nuestras propias pruebas. Básicamente en el <em>runner</em> tenemos que cargar varias cosas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>La propia librería Jasmine</p>
</li>
<li>
<p>Los <em>plugins</em> o librerías auxiliares para <em>testing</em> con Jasmine que estemos usando</p>
</li>
<li>
<p>Nuestro código fuente</p>
</li>
<li>
<p>Las <em>specs</em> que queramos ejecutar</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>En nuestro caso, el JS incluido en el <em>spec runner</em> sería algo como:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">...</span>
<span class="tok-c">&lt;!--</span> <span class="tok-nx">Jasmine</span> <span class="tok-p">(</span><span class="tok-nx">luego</span> <span class="tok-nx">iremos</span> <span class="tok-nx">a</span><span class="tok-err">ñ</span><span class="tok-nx">adiendo</span> <span class="tok-nx">plugins</span><span class="tok-p">)</span> <span class="tok-o">--&gt;</span>
<span class="tok-o">&lt;</span><span class="tok-nx">script</span> <span class="tok-nx">src</span><span class="tok-o">=</span><span class="tok-s2">&quot;lib/jasmine-2.2.0/jasmine.js&quot;</span><span class="tok-o">&gt;&lt;</span><span class="tok-err">/script&gt;</span>
<span class="tok-o">&lt;</span><span class="tok-nx">script</span> <span class="tok-nx">src</span><span class="tok-o">=</span><span class="tok-s2">&quot;lib/jasmine-2.2.0/jasmine-html.js&quot;</span><span class="tok-o">&gt;&lt;</span><span class="tok-err">/script&gt;</span>

<span class="tok-c">&lt;!--</span> <span class="tok-nx">c</span><span class="tok-err">ó</span><span class="tok-nx">digo</span> <span class="tok-nx">fuente</span> <span class="tok-nx">a</span> <span class="tok-nx">probar</span><span class="tok-p">,</span> <span class="tok-nx">y</span> <span class="tok-nx">librer</span><span class="tok-err">í</span><span class="tok-nx">as</span> <span class="tok-nx">de</span> <span class="tok-nx">las</span> <span class="tok-nx">que</span> <span class="tok-nx">depende</span><span class="tok-p">...</span> <span class="tok-o">--&gt;</span>
<span class="tok-o">&lt;</span><span class="tok-nx">script</span> <span class="tok-nx">src</span><span class="tok-o">=</span><span class="tok-s2">&quot;../lib/jquery.js&quot;</span><span class="tok-o">&gt;&lt;</span><span class="tok-err">/script&gt;</span>
<span class="tok-o">&lt;</span><span class="tok-nx">script</span> <span class="tok-nx">src</span><span class="tok-o">=</span><span class="tok-s2">&quot;../lib/underscore-min.js&quot;</span><span class="tok-o">&gt;&lt;</span><span class="tok-err">/script&gt;</span>
<span class="tok-o">&lt;</span><span class="tok-nx">script</span> <span class="tok-nx">src</span><span class="tok-o">=</span><span class="tok-s2">&quot;../lib/backbone-min.js&quot;</span><span class="tok-o">&gt;&lt;</span><span class="tok-err">/script&gt;</span>
<span class="tok-o">&lt;</span><span class="tok-nx">script</span> <span class="tok-nx">src</span><span class="tok-o">=</span><span class="tok-s2">&quot;../tiempo.js&quot;</span><span class="tok-o">&gt;&lt;</span><span class="tok-err">/script&gt;</span>

<span class="tok-c">&lt;!--</span> <span class="tok-nx">specs</span><span class="tok-p">...</span> <span class="tok-o">--&gt;</span>
<span class="tok-o">&lt;</span><span class="tok-nx">script</span> <span class="tok-nx">src</span><span class="tok-o">=</span><span class="tok-s2">&quot;spec/modelo_spec.js&quot;</span><span class="tok-o">&gt;&lt;</span><span class="tok-err">/script&gt;</span>
<span class="tok-o">&lt;</span><span class="tok-nx">script</span> <span class="tok-nx">src</span><span class="tok-o">=</span><span class="tok-s2">&quot;spec/vista_spec.js&quot;</span><span class="tok-o">&gt;&lt;</span><span class="tok-err">/script&gt;</span>
<span class="tok-p">...</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_pruebas_con_jasmine_en_backbone">10.2. Pruebas con Jasmine en Backbone</h3>
<div class="paragraph">
<p>En realidad las pruebas en Backbone no se diferencian demasiado de las de otros tipos de código, pero sí es verdad que por los patrones que se suelen usar en aplicaciones Backbone hay ciertos "casos de uso típicos" para las pruebas. Vamos a ver algunos de ellos.</p>
</div>
<div class="paragraph">
<p>Usaremos como hilo conductor de los ejemplos el <em>widget</em> del tiempo que vimos en la primera sesión, aunque ligeramente modificado para complicarlo un poco.</p>
</div>
<div class="sect3">
<h4 id="_pruebas_de_lógica_de_negocio">10.2.1. Pruebas de lógica de negocio</h4>
<div class="paragraph">
<p>Una de las ventajas fundamentales de usar un <em>framework</em> MVC como Backbone es que nos hace separar modelo y vista. Entre otras cosas esto nos va a facilitar los <em>tests</em> de lógica de negocio, que básicamente tendrán que tratar únicamente con modelos y colecciones.</p>
</div>
<div class="paragraph">
<p>Las pruebas "puras" de lógica de negocio no tienen nada de particular, simplemente usamos el API de Jasmine para formular expectativas sobre el código:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">it</span><span class="tok-p">(</span><span class="tok-s2">&quot;Un modelo recién creado no tiene localidad asignada&quot;</span><span class="tok-p">,</span> <span class="tok-kd">function</span> <span class="tok-p">()</span> <span class="tok-p">{</span>
     <span class="tok-nx">expect</span><span class="tok-p">(</span><span class="tok-k">new</span> <span class="tok-nx">DatosTiempo</span><span class="tok-p">().</span><span class="tok-nx">has</span><span class="tok-p">(</span><span class="tok-s2">&quot;localidad&quot;</span><span class="tok-p">)).</span><span class="tok-nx">toBeFalsy</span><span class="tok-p">();</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_pruebas_sobre_html">10.2.2. Pruebas sobre HTML</h4>
<div class="paragraph">
<p>Una de las cosas de las que hay que asegurarse en una vista es que genera el HTML correcto. Más que comprobar si el HTML es literalmente igual a una cadena de referencia en general será más sencillo simplemente comprobar si contiene determinados elementos. Podemos usar un <em>plugin</em> llamado <a href="https://github.com/velesin/jasmine-jquery"><code>jasmine-jquery</code></a> para facilitar esta tarea. Este <em>plugin</em> define un <a href="http://jasmine.github.io/2.2/introduction.html#section-Included_Matchers">gran número de <em>matchers</em></a> con los que podemos chequear de manera sencilla el contenido del HTML usando selectores de jQuery.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, vamos a <strong>comprobar que el <em>widget</em> genera correctamente el HTML en su estado inicial</strong>. Podemos ver que los <em>matchers</em> de jasmine-jquery son bastante autoexplicativos.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">it</span><span class="tok-p">(</span><span class="tok-s2">&quot;El HTML generado debe ser correcto&quot;</span><span class="tok-p">,</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-nx">vista</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">TiempoWidget</span><span class="tok-p">({</span><span class="tok-nx">model</span><span class="tok-o">:</span> <span class="tok-k">new</span> <span class="tok-nx">DatosTiempo</span><span class="tok-p">()});</span>
    <span class="tok-nx">vista</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">();</span>
    <span class="tok-nx">expect</span><span class="tok-p">(</span><span class="tok-nx">vista</span><span class="tok-p">.</span><span class="tok-nx">$el</span><span class="tok-p">).</span><span class="tok-nx">toContainElement</span><span class="tok-p">(</span><span class="tok-s1">&#39;#localidad&#39;</span><span class="tok-p">);</span>
    <span class="tok-nx">expect</span><span class="tok-p">(</span><span class="tok-nx">vista</span><span class="tok-p">.</span><span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s1">&#39;#descripcion&#39;</span><span class="tok-p">)).</span><span class="tok-nx">toBeEmpty</span><span class="tok-p">();</span>
    <span class="tok-nx">expect</span><span class="tok-p">(</span><span class="tok-nx">vista</span><span class="tok-p">.</span><span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s1">&#39;#ver_tiempo&#39;</span><span class="tok-p">)).</span><span class="tok-nx">toHaveValue</span><span class="tok-p">(</span><span class="tok-s1">&#39;Ver tiempo&#39;</span><span class="tok-p">);</span>
    <span class="tok-nx">expect</span><span class="tok-p">(</span><span class="tok-nx">vista</span><span class="tok-p">.</span><span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s1">&#39;#icono&#39;</span><span class="tok-p">)).</span><span class="tok-nx">toHaveAttr</span><span class="tok-p">(</span><span class="tok-s2">&quot;src&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;&quot;</span><span class="tok-p">);</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Una ventaja de las vistas de Backbone es que son <em>autocontenidas</em>, es decir, que el HTML se genera dentro del <code>el</code> y que para comprobar que es correcto no es necesario insertar la vista en el DOM de la página. De este modo no tenemos que tocar el HTML del <em>runner</em> de los test para probar la parte de la interfaz.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Otra funcionalidad interesante de jasmine-jquery es la posibilidad de definir <em>fixtures</em> de HTML, es decir, fragmentos de HTML que necesitamos que estén presentes en la página actual para que interactúen con nuestro código. Así podríamos probar no solo el funcionamiento interno de la vista sino también el del código que la inserta en el lugar apropiado del DOM. Las <em>fixtures</em> se cargan desde ficheros independientes y se limpian automáticamente con cada <em>spec</em>, para no ir "ensuciando" la página con el <em>runner</em> de los test. Se recomienda consultar la documentación del <em>plugin</em> para ver cómo usar esta funcionalidad.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_uso_de_espías">10.2.3. Uso de "espías"</h4>
<div class="paragraph">
<p>En muchas ocasiones, más que comprobar el valor de una variable o el valor de retorno de una función nos interesará saber si una determinada función ha sido llamada correctamente (el número de veces que debería, con los parámetros adecuados, etc.). Esto es necesario cuando estamos probando un método que se llama desde otra parte de nuestro código.</p>
</div>
<div class="paragraph">
<p>En <em>testing</em> en general se suelen tratar estos casos usando <em>mocks</em>. El nombre que reciben en Jasmine es <em>spies</em>, por motivos evidentes.</p>
</div>
<div class="paragraph">
<p>Un caso de uso típico en vistas de Backbone es <strong>comprobar que los eventos del DOM sobre la vista disparan los <em>callbacks</em> adecuados</strong>. En el ejemplo del tiempo, comprobar que al pulsar sobre el botón de "ver tiempo" se llama efectivamente a la función <code>ver_tiempo_de</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv">1
2
3
4
5
6
7
8
9</div></td><td class="code"><span class="tok-nx">it</span><span class="tok-p">(</span><span class="tok-s2">&quot;Al clicar sobre el botón se debería llamar a &#39;ver_tiempo_de&#39;&quot;</span><span class="tok-p">,</span> <span class="tok-kd">function</span><span class="tok-p">(){</span>
    <span class="tok-nx">vista</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">TiempoWidget</span><span class="tok-p">({</span><span class="tok-nx">model</span><span class="tok-o">:</span> <span class="tok-k">new</span> <span class="tok-nx">DatosTiempo</span><span class="tok-p">()});</span>
    <span class="tok-nx">spyOn</span><span class="tok-p">(</span><span class="tok-nx">vista</span><span class="tok-p">,</span> <span class="tok-s1">&#39;ver_tiempo_de&#39;</span><span class="tok-p">);</span>
    <span class="tok-nx">vista</span><span class="tok-p">.</span><span class="tok-nx">delegateEvents</span><span class="tok-p">();</span>
    <span class="tok-nx">vista</span><span class="tok-p">.</span><span class="tok-nx">render</span><span class="tok-p">();</span>
    <span class="tok-kd">var</span> <span class="tok-nx">elem</span> <span class="tok-o">=</span> <span class="tok-nx">vista</span><span class="tok-p">.</span><span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s1">&#39;#ver_tiempo&#39;</span><span class="tok-p">)</span>
    <span class="tok-nx">elem</span><span class="tok-p">.</span><span class="tok-nx">click</span><span class="tok-p">();</span>
    <span class="tok-nx">expect</span><span class="tok-p">(</span><span class="tok-nx">vista</span><span class="tok-p">.</span><span class="tok-nx">ver_tiempo_de</span><span class="tok-p">).</span><span class="tok-nx">toHaveBeenCalled</span><span class="tok-p">();</span>
<span class="tok-p">});</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Líneas 2 y 3</strong>: creamos una nueva vista y el espía sobre el método <code>vista.ver_tiempo_de</code></p>
</li>
<li>
<p><strong>Línea 4</strong>: al haber creado el espía hemos cambiado el manejador de evento, hay que decirle a Backbone que lo tenga en cuenta y "refresque" los manejadores</p>
</li>
<li>
<p><strong>Línea 5</strong>: renderizamos la vista para generar el HTML y tener algo en lo que clicar.</p>
</li>
<li>
<p><strong>Líneas 6 y 7</strong>: Accedemos al botón y simulamos el click</p>
</li>
<li>
<p><strong>Línea 8</strong>: comprobamos que se ha llamado al espía.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Es posible que veas muchos libros y tutoriales que usen la librería Sinon.js junto con Jasmine para trabajar con espías. Las versiones anteriores de Jasmine tenían algunas funcionalidades muy limitadas y de ahí la necesidad de librerías auxiliares. La versión actual de Jasmine ofrece funcionalidades en cuanto a <em>spies</em> muy similares a las que tiene Sinon.js
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Otro caso similar al anterior y también muy típico es <strong>comprobar que cuando se dispara un evento de Backbone se está llamando al <em>callback</em> adecuado</strong>. En realidad es el mismo caso que antes, pero ahora con eventos de Backbone en lugar de eventos del DOM.</p>
</div>
<div class="paragraph">
<p>Por ejemplo en el <em>widget</em> del tiempo queremos comprobar que efectivamente se está llamando a <code>renderDatos</code> cuando cambia el atributo <code>dt</code> del modelo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">it</span><span class="tok-p">(</span><span class="tok-s2">&quot;Al cambiar el atributo &#39;dt&#39; del modelo se llama a &#39;renderData&#39;&quot;</span><span class="tok-p">,</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-nx">spyOn</span><span class="tok-p">(</span><span class="tok-nx">TiempoWidget</span><span class="tok-p">.</span><span class="tok-nx">prototype</span><span class="tok-p">,</span> <span class="tok-s1">&#39;renderData&#39;</span><span class="tok-p">);</span>
    <span class="tok-nx">vista</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">TiempoWidget</span><span class="tok-p">({</span><span class="tok-nx">model</span><span class="tok-o">:</span> <span class="tok-k">new</span> <span class="tok-nx">DatosTiempo</span><span class="tok-p">()});</span>
    <span class="tok-nx">vista</span><span class="tok-p">.</span><span class="tok-nx">model</span><span class="tok-p">.</span><span class="tok-nx">trigger</span><span class="tok-p">(</span><span class="tok-s2">&quot;change:dt&quot;</span><span class="tok-p">);</span>
    <span class="tok-nx">expect</span><span class="tok-p">(</span><span class="tok-nx">vista</span><span class="tok-p">.</span><span class="tok-nx">renderData</span><span class="tok-p">).</span><span class="tok-nx">toHaveBeenCalled</span><span class="tok-p">();</span>
 <span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Recordar que <a href="https://github.com/ottocol/tiempo_backbone/blob/master/tiempo.js#L25">en el <code>initialize</code> de <code>TiempoWidget</code></a> vinculábamos el método <code>renderData</code> al evento de cambio sobre el atributo <code>dt</code> del modelo. Si tras ejecutar el <code>initialize</code> creamos un espía sobre <code>renderData</code> el evento Backbone seguirá vinculado al <code>renderData</code> original. Es por esto que tenemos que crear el espía ANTES de vincular el evento. Nos vemos obligados a trabajar sobre el prototipo de la clase <code>TiempoWidget</code> ya que cuando se instancie la clase será demasiado tarde.</p>
</div>
</div>
<div class="sect3">
<h4 id="_pruebas_con_ajax">10.2.4. Pruebas con AJAX</h4>
<div class="paragraph">
<p>Aunque es posible probar las funcionalidades AJAX de la aplicación con el servidor real, tendremos dos problemas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Coste temporal: la ejecución de la <em>suite</em> se hará muy lenta si incluimos muchas pruebas con AJAX.</p>
</li>
<li>
<p>Fiabilidad: no sabremos si una prueba falla por nuestro código o bien porque el servidor externo ha fallado ocasionalmente. En algunos casos tampoco sabemos lo que va a devolver el servidor y por tanto no podemos asegurar que nuestro código esté procesando bien la información que recibe (caso del <em>widget</em> del tiempo).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Por ello, en la mayoría de los casos es mejor <em>simular</em> que estamos trabajando con un servidor externo. Jasmine incluye un <em>plugin</em> llamado <code>jasmine-ajax</code> que es un <em>mock</em> para el XMLHttpRequest.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
De nuevo es posible que veas Sinon.js usado para esta finalidad en libros o tutoriales, ya que <code>jasmine-ajax</code> es relativamente reciente.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para hacer que cualquier llamada a XMLHttpRequest se haga en realidad al <em>mock</em> hay que haber hecho antes la llamada <code>jasmine.Ajax.install()</code>, y para que las llamadas AJAX "vuelvan a la normalidad" se hace <code>jasmine.Ajax.uninstall()</code>. Típicamente estas llamadas se harán en un <code>beforeEach/afterEach</code> respectivamente o un <code>beforeAll/afterAll</code>.</p>
</div>
<div class="paragraph">
<p>En el <em>widget</em> del tiempo, <strong>queremos comprobar que el código que hace la petición al servicio web y el <em>callback</em> que procesa la respuesta del servidor funcionan correctamente</strong>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">it</span><span class="tok-p">(</span><span class="tok-s2">&quot;La comunicación con el servicio web funciona correctamente&quot;</span><span class="tok-p">,</span> <span class="tok-kd">function</span> <span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-nx">jasmine</span><span class="tok-p">.</span><span class="tok-nx">Ajax</span><span class="tok-p">.</span><span class="tok-nx">install</span><span class="tok-p">();</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-nx">t</span><span class="tok-p">.</span><span class="tok-nx">set</span><span class="tok-p">(</span><span class="tok-s2">&quot;localidad&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;Alicante&quot;</span><span class="tok-p">);</span>
    <span class="tok-nx">t</span><span class="tok-p">.</span><span class="tok-nx">actualizarTiempo</span><span class="tok-p">();</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-c1">//comprobamos que la petición es correcta</span>
     <span class="tok-nx">expect</span><span class="tok-p">(</span><span class="tok-nx">jasmine</span><span class="tok-p">.</span><span class="tok-nx">Ajax</span><span class="tok-p">.</span><span class="tok-nx">requests</span><span class="tok-p">.</span><span class="tok-nx">mostRecent</span><span class="tok-p">().</span><span class="tok-nx">url</span><span class="tok-p">).</span><span class="tok-nx">toEqual</span><span class="tok-p">(</span><span class="tok-nx">URL_API</span> <span class="tok-o">+</span> <span class="tok-s1">&#39;&amp;q=Alicante&#39;</span><span class="tok-p">);</span> <i class="conum" data-value="3"></i><b>(3)</b>
     <span class="tok-nx">expect</span><span class="tok-p">(</span><span class="tok-nx">jasmine</span><span class="tok-p">.</span><span class="tok-nx">Ajax</span><span class="tok-p">.</span><span class="tok-nx">requests</span><span class="tok-p">.</span><span class="tok-nx">mostRecent</span><span class="tok-p">().</span><span class="tok-nx">method</span><span class="tok-p">).</span><span class="tok-nx">toEqual</span><span class="tok-p">(</span><span class="tok-s1">&#39;GET&#39;</span><span class="tok-p">);</span>
    <span class="tok-c1">//devolvemos una respuesta fake</span>
    <span class="tok-nx">jasmine</span><span class="tok-p">.</span><span class="tok-nx">Ajax</span><span class="tok-p">.</span><span class="tok-nx">requests</span><span class="tok-p">.</span><span class="tok-nx">mostRecent</span><span class="tok-p">().</span><span class="tok-nx">respondWith</span><span class="tok-p">({</span>  <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="tok-nx">status</span><span class="tok-o">:</span> <span class="tok-mi">200</span><span class="tok-p">,</span>
        <span class="tok-nx">responseText</span><span class="tok-o">:</span> <span class="tok-nx">JSON</span><span class="tok-p">.</span><span class="tok-nx">stringify</span><span class="tok-p">({</span>
            <span class="tok-nx">weather</span><span class="tok-o">:</span> <span class="tok-p">[</span>
                <span class="tok-p">{</span><span class="tok-nx">description</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Prueba&quot;</span><span class="tok-p">,</span> <span class="tok-nx">icon</span><span class="tok-o">:</span> <span class="tok-s2">&quot;test&quot;</span><span class="tok-p">}</span>
            <span class="tok-p">],</span>
            <span class="tok-nx">dt</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
        <span class="tok-p">})</span>
    <span class="tok-p">});</span>
    <span class="tok-c1">//comprobamos que las propiedades se han instanciado OK con la info del &quot;servidor&quot;  </span><i class="conum" data-value="5"></i><b>(5)</b>
    <span class="tok-nx">expect</span><span class="tok-p">(</span><span class="tok-nx">t</span><span class="tok-p">.</span><span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-s2">&quot;dt&quot;</span><span class="tok-p">)).</span><span class="tok-nx">toBe</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">);</span>
    <span class="tok-nx">expect</span><span class="tok-p">(</span><span class="tok-nx">t</span><span class="tok-p">.</span><span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-s2">&quot;descripcion&quot;</span><span class="tok-p">)).</span><span class="tok-nx">toEqual</span><span class="tok-p">(</span><span class="tok-s2">&quot;Prueba&quot;</span><span class="tok-p">);</span>
    <span class="tok-nx">jasmine</span><span class="tok-p">.</span><span class="tok-nx">Ajax</span><span class="tok-p">.</span><span class="tok-nx">uninstall</span><span class="tok-p">();</span>  <i class="conum" data-value="6"></i><b>(6)</b>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Queremos que dentro de este código se use un <em>mock</em> de AJAX y no el real</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Llamamos al método de negocio que dispara la petición AJAX</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>El API del <em>mock</em> nos permite obtener información de las peticiones hechas, en este caso de la última. Comprobamos que la URL solicitada es correcta y que se ha hecho una petición GET.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Devolvemos una respuesta <em>fake</em>, para nuestro código será como si se la hubiera devuelto el servidor</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Comprobamos que las propiedades del modelo se han fijado a los valores correctos, que venían en la respuesta del servidor.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Finalmente, eliminamos el API <em>mock</em> por si otra prueba quiere hacer una llamada AJAX real.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2016-04-22 16:11:42 CEST
</div>
</div>
</body>
</html>