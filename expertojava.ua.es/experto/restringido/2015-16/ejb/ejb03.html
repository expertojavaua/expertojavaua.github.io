<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.2">
<meta name="author" content="Domingo Gallardo">
<title>Componentes enterprise</title>
<style>/*! normalize.css v2.1.2 | MIT License | git.io/normalize */
/* ========================================================================== HTML5 display definitions ========================================================================== */
/** Correct `block` display not defined in IE 8/9. */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }

/** Correct `inline-block` display not defined in IE 8/9. */
audio, canvas, video { display: inline-block; }

/** Prevent modern browsers from displaying `audio` without controls. Remove excess height in iOS 5 devices. */
audio:not([controls]) { display: none; height: 0; }

/** Address `[hidden]` styling not present in IE 8/9. Hide the `template` element in IE, Safari, and Firefox < 22. */
[hidden], template { display: none; }

script { display: none !important; }

/* ========================================================================== Base ========================================================================== */
/** 1. Set default font family to sans-serif. 2. Prevent iOS text size adjust after orientation change, without disabling user zoom. */
html { font-family: sans-serif; /* 1 */ -ms-text-size-adjust: 100%; /* 2 */ -webkit-text-size-adjust: 100%; /* 2 */ }

/** Remove default margin. */
body { margin: 0; }

/* ========================================================================== Links ========================================================================== */
/** Remove the gray background color from active links in IE 10. */
a { background: transparent; }

/** Address `outline` inconsistency between Chrome and other browsers. */
a:focus { outline: thin dotted; }

/** Improve readability when focused and also mouse hovered in all browsers. */
a:active, a:hover { outline: 0; }

/* ========================================================================== Typography ========================================================================== */
/** Address variable `h1` font-size and margin within `section` and `article` contexts in Firefox 4+, Safari 5, and Chrome. */
h1 { font-size: 2em; margin: 0.67em 0; }

/** Address styling not present in IE 8/9, Safari 5, and Chrome. */
abbr[title] { border-bottom: 1px dotted; }

/** Address style set to `bolder` in Firefox 4+, Safari 5, and Chrome. */
b, strong { font-weight: bold; }

/** Address styling not present in Safari 5 and Chrome. */
dfn { font-style: italic; }

/** Address differences between Firefox and other browsers. */
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }

/** Address styling not present in IE 8/9. */
mark { background: #ff0; color: #000; }

/** Correct font family set oddly in Safari 5 and Chrome. */
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }

/** Improve readability of pre-formatted text in all browsers. */
pre { white-space: pre-wrap; }

/** Set consistent quote types. */
q { quotes: "\201C" "\201D" "\2018" "\2019"; }

/** Address inconsistent and variable font size in all browsers. */
small { font-size: 80%; }

/** Prevent `sub` and `sup` affecting `line-height` in all browsers. */
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }

sup { top: -0.5em; }

sub { bottom: -0.25em; }

/* ========================================================================== Embedded content ========================================================================== */
/** Remove border when inside `a` element in IE 8/9. */
img { border: 0; }

/** Correct overflow displayed oddly in IE 9. */
svg:not(:root) { overflow: hidden; }

/* ========================================================================== Figures ========================================================================== */
/** Address margin not present in IE 8/9 and Safari 5. */
figure { margin: 0; }

/* ========================================================================== Forms ========================================================================== */
/** Define consistent border, margin, and padding. */
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }

/** 1. Correct `color` not being inherited in IE 8/9. 2. Remove padding so people aren't caught out if they zero out fieldsets. */
legend { border: 0; /* 1 */ padding: 0; /* 2 */ }

/** 1. Correct font family not being inherited in all browsers. 2. Correct font size not being inherited in all browsers. 3. Address margins set differently in Firefox 4+, Safari 5, and Chrome. */
button, input, select, textarea { font-family: inherit; /* 1 */ font-size: 100%; /* 2 */ margin: 0; /* 3 */ }

/** Address Firefox 4+ setting `line-height` on `input` using `!important` in the UA stylesheet. */
button, input { line-height: normal; }

/** Address inconsistent `text-transform` inheritance for `button` and `select`. All other form control elements do not inherit `text-transform` values. Correct `button` style inheritance in Chrome, Safari 5+, and IE 8+. Correct `select` style inheritance in Firefox 4+ and Opera. */
button, select { text-transform: none; }

/** 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio` and `video` controls. 2. Correct inability to style clickable `input` types in iOS. 3. Improve usability and consistency of cursor style between image-type `input` and others. */
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; /* 2 */ cursor: pointer; /* 3 */ }

/** Re-set default cursor for disabled elements. */
button[disabled], html input[disabled] { cursor: default; }

/** 1. Address box sizing set to `content-box` in IE 8/9. 2. Remove excess padding in IE 8/9. */
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; /* 1 */ padding: 0; /* 2 */ }

/** 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome. 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome (include `-moz` to future-proof). */
input[type="search"] { -webkit-appearance: textfield; /* 1 */ -moz-box-sizing: content-box; -webkit-box-sizing: content-box; /* 2 */ box-sizing: content-box; }

/** Remove inner padding and search cancel button in Safari 5 and Chrome on OS X. */
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }

/** Remove inner padding and border in Firefox 4+. */
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }

/** 1. Remove default vertical scrollbar in IE 8/9. 2. Improve readability and alignment in all browsers. */
textarea { overflow: auto; /* 1 */ vertical-align: top; /* 2 */ }

/* ========================================================================== Tables ========================================================================== */
/** Remove most spacing between table cells. */
table { border-collapse: collapse; border-spacing: 0; }

meta.foundation-mq-small { font-family: "only screen and (min-width: 768px)"; width: 768px; }

meta.foundation-mq-medium { font-family: "only screen and (min-width:1280px)"; width: 1280px; }

meta.foundation-mq-large { font-family: "only screen and (min-width:1440px)"; width: 1440px; }

*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }

html, body { font-size: 97%; }

body { background: white; color: #222222; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }

a:hover { cursor: pointer; }

img, object, embed { max-width: 100%; height: auto; }

object, embed { height: 100%; }

img { -ms-interpolation-mode: bicubic; }

#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }

.left { float: left !important; }

.right { float: right !important; }

.text-left { text-align: left !important; }

.text-right { text-align: right !important; }

.text-center { text-align: center !important; }

.text-justify { text-align: justify !important; }

.hide { display: none; }

.antialiased, body { -webkit-font-smoothing: antialiased; }

img { display: inline-block; vertical-align: middle; }

textarea { height: auto; min-height: 50px; }

select { width: 100%; }

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }

.subheader, .admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { line-height: 1.4; color: #6f6f6f; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }

/* Typography resets */
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }

/* Default Link Styles */
a { color: #1164be; text-decoration: none; line-height: inherit; }
a img { border: none; }

/* Default paragraph styles */
p { font-family: inherit; font-weight: normal; font-size: 1em; line-height: 1.4; margin-bottom: 1em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }

/* Default header styles */
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: bold; font-style: normal; color: #1c355e; text-rendering: optimizeLegibility; margin-top: 1em; margin-bottom: 0.5em; line-height: 1.2125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #6f6f6f; line-height: 0; }

h1 { font-size: 2.125em; }

h2 { font-size: 1.6875em; }

h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }

h4 { font-size: 1.125em; }

h5 { font-size: 1.125em; }

h6 { font-size: 1em; }

hr { border: solid #dddddd; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }

/* Helpful Typography Defaults */
em, i { font-style: italic; line-height: inherit; }

strong, b { font-weight: bold; line-height: inherit; }

small { font-size: 60%; line-height: inherit; }

code { font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: bold; }

/* Lists */
ul, ol, dl { font-size: 1em; line-height: 1.4; margin-bottom: 1.25em; list-style-position: outside; font-family: inherit; }

ul, ol { margin-left: 2.5em; }
ul.no-bullet, ol.no-bullet { margin-left: 1.5em; }

/* Unordered Lists */
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; /* Override nested font-size change */ }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }

/* Ordered Lists */
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }

/* Definition Lists */
dl dt { margin-bottom: 0.3125em; font-weight: bold; }
dl dd { margin-bottom: 1.25em; }

/* Abbreviations */
abbr, acronym { text-transform: uppercase; font-size: 90%; color: #222222; border-bottom: 1px dotted #dddddd; cursor: help; }

abbr { text-transform: none; }

/* Blockquotes */
blockquote { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
blockquote cite { display: block; font-size: 0.8125em; color: #555555; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #555555; }

blockquote, blockquote p { line-height: 1.6; color: #6f6f6f; }

/* Microformats */
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #dddddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }

.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }

/*@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.6875em; }
  h4 { font-size: 1.4375em; } }*/
/* Tables */
table { background: white; margin-bottom: 1.25em; border: solid 1px #dddddd; }
table thead, table tfoot { background: whitesmoke; font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: #222222; text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: #222222; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #f9f9f9; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.4; }

h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; border-bottom: 1px solid #dddddd }

.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }

*:not(pre) > code { font-size: inherit; font-style: normal !important; letter-spacing: 0; padding: 3px 2px 1px 2px; background-color: #eeeeee; border: 1px solid #dddddd; -webkit-border-radius: 0; border-radius: 0; line-height: inherit; font-weight: normal; }

pre, pre > code { line-height: 1.4; color: black; font-family: monospace, serif; font-weight: normal; }

.keyseq { color: #555555; }

kbd { display: inline-block; color: #222222; font-size: 0.75em; line-height: 1.4; background-color: #f7f7f7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; margin: -0.15em 0.15em 0 0.15em; padding: 0.2em 0.6em 0.2em 0.5em; vertical-align: middle; white-space: nowrap; }

.keyseq kbd:first-child { margin-left: 0; }

.keyseq kbd:last-child { margin-right: 0; }

.menuseq, .menu { color: #090909; }

b.button:before, b.button:after { position: relative; top: -1px; font-weight: normal; }

b.button:before { content: "["; padding: 0 3px 0 2px; }

b.button:after { content: "]"; padding: 0 2px 0 3px; }

#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 0.9375em; padding-right: 0.9375em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }

#content { margin-top: 1.25em; }

#content:before { content: none; }

#header > h1:first-child { color: black; margin-top: 2.25rem; margin-bottom: 0; }
#header > h1:first-child + #toc { margin-top: 8px; border-top: 1px solid #dddddd; }
#header > h1:only-child, body.toc2 #header > h1:nth-last-child(2) { border-bottom: 1px solid #dddddd; padding-bottom: 8px; }
#header .details { border-bottom: 1px solid #dddddd; line-height: 1.45; padding-top: 0.25em; padding-bottom: 0.25em; padding-left: 0.25em; color: #555555; display: -ms-flexbox; display: -webkit-flex; display: flex; -ms-flex-flow: row wrap; -webkit-flex-flow: row wrap; flex-flow: row wrap; }
#header .details span:first-child { margin-left: -0.125em; }
#header .details span.email a { color: #6f6f6f; }
#header .details br { display: none; }
#header .details br + span:before { content: "\00a0\2013\00a0"; }
#header .details br + span.author:before { content: "\00a0\22c5\00a0"; color: #6f6f6f; }
#header .details br + span#revremark:before { content: "\00a0|\00a0"; }
#header #revnumber { text-transform: capitalize; }
#header #revnumber:after { content: "\00a0"; }

#content > h1:first-child:not([class]) { color: black; border-bottom: 1px solid #dddddd; padding-bottom: 8px; margin-top: 0; padding-top: 1rem; margin-bottom: 1.25rem; }

#floating {
  position: fixed;
  z-index: 1000;
  padding: 0.5em;
  right: 0;
  top: 0;
  background: white;
  box-shadow: 0 0 1em #777777;
  -webkit-box-shadow: 0 0 1em #777777;
  -moz-box-shadow: 0 0 1em #777777;
  -webkit-border-bottom-left-radius: 5px;
  -moz-border-radius-bottomleft: 5px;
  max-height: 80%;
  overflow: auto;
}

#floating #full { display: none; } /* Hide the full TOC by default */

#floating:hover #full{
  display: block; /* Show it on hover */
}


#toc { border-bottom: 1px solid #dddddd; padding-bottom: 0.5em; }
#toc > ul { margin-left: 0.125em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin: 0.5em 0; }
#toc ul { font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; list-style-type: none; }
#toc a { text-decoration: none; }
#toc a:active { text-decoration: underline; }

#toctitle { color: #6f6f6f; font-size: 1.2em; }

@media only screen and (min-width: 768px) { #toctitle { font-size: 1.375em; }
  body.toc2 { padding-left: 15em; padding-right: 0; }
  #toc.toc2 { margin-top: 0 !important; background-color: #f2f2f2; position: fixed; width: 15em; left: 0; top: 0; border-right: 1px solid #dddddd; border-top-width: 0 !important; border-bottom-width: 0 !important; z-index: 1000; padding: 1.25em 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; font-size: 1.2em; }
  #toc.toc2 > ul { font-size: 0.9em; margin-bottom: 0; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 15em; }
  body.toc2.toc-right #toc.toc2 { border-right-width: 0; border-left: 1px solid #dddddd; left: auto; right: 0; } }
@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; padding-right: 0; }
  #toc.toc2 { width: 20em; }
  #toc.toc2 #toctitle { font-size: 1.375em; }
  #toc.toc2 > ul { font-size: 0.95em; }
  #toc.toc2 ul ul { padding-left: 1.25em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; } }
#content #toc { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 0; border-radius: 0; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }

#footer { max-width: 100%; background-color: #222222; padding: 1.25em; }

#footer-text { color: #dddddd; line-height: 1.44; }

.sect1 { padding-bottom: 0.625em; }

@media only screen and (min-width: 768px) { .sect1 { padding-bottom: 1.25em; } }
.sect1 + .sect1 { border-top: 1px solid #dddddd; }

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; z-index: 1001; width: 1.5ex; margin-left: -1.5ex; display: block; text-decoration: none !important; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: "\00A7"; font-size: 0.85em; display: block; padding-top: 0.1em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #222222; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #151515; }

.audioblock, .imageblock, .literalblock, .listingblock, .stemblock, .videoblock { margin-bottom: 1.25em; }

.admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-rendering: optimizeLegibility; text-align: left; }

table.tableblock > caption.title { white-space: nowrap; overflow: visible; max-width: 0; }

.paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { color: black; }

table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }

.admonitionblock > table { border-collapse: separate; border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #dddddd; color: #555555; }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }

.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 0; border-radius: 0; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }

.sidebarblock { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 0; border-radius: 0; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock > .content > .title { color: #6f6f6f; margin-top: 0; }

.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }

.literalblock pre, .listingblock pre:not(.highlight), .listingblock pre[class="highlight"], .listingblock pre[class^="highlight "], .listingblock pre.CodeRay, .listingblock pre.prettyprint { background: #eeeeee; }
.sidebarblock .literalblock pre, .sidebarblock .listingblock pre:not(.highlight), .sidebarblock .listingblock pre[class="highlight"], .sidebarblock .listingblock pre[class^="highlight "], .sidebarblock .listingblock pre.CodeRay, .sidebarblock .listingblock pre.prettyprint { background: #f2f1f1; }

.literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { border: 1px solid #cccccc; -webkit-border-radius: 0; border-radius: 0; word-wrap: break-word; padding: 0.8em 0.8em 0.65em 0.8em; font-size: 0.8125em; }
.literalblock pre.nowrap, .literalblock pre[class].nowrap, .listingblock pre.nowrap, .listingblock pre[class].nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
@media only screen and (min-width: 768px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 0.90625em; } }
@media only screen and (min-width: 1280px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 1em; } }

.literalblock.output pre { color: #eeeeee; background-color: black; }

.listingblock pre.highlightjs { padding: 0; }
.listingblock pre.highlightjs > code { padding: 0.8em 0.8em 0.65em 0.8em; -webkit-border-radius: 0; border-radius: 0; }

.listingblock > .content { position: relative; }

.listingblock code[data-lang]:before { display: none; content: attr(data-lang); position: absolute; font-size: 0.75em; top: 0.425rem; right: 0.5rem; line-height: 1; text-transform: uppercase; color: #999; }

.listingblock:hover code[data-lang]:before { display: block; }

.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }

.listingblock.terminal pre .command:not([data-prompt]):before { content: "$"; }

table.pyhltable { border-collapse: separate; border: 0; margin-bottom: 0; background: none; }

table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; }

table.pyhltable td.code { padding-left: .75em; padding-right: 0; }

pre.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #dddddd; }

pre.pygments .lineno { display: inline-block; margin-right: .25em; }

table.pyhltable .linenodiv { background: none !important; padding-right: 0 !important; }

.quoteblock { margin: 0 1em 1.25em 1.5em; display: table; }
.quoteblock > .title { margin-left: -1.5em; margin-bottom: 0.75em; }
.quoteblock blockquote, .quoteblock blockquote p { color: #6f6f6f; font-size: 1.15rem; line-height: 1.75; word-spacing: 0.1em; letter-spacing: 0; font-style: italic; text-align: justify; }
.quoteblock blockquote { margin: 0; padding: 0; border: 0; }
.quoteblock blockquote:before { content: "\201c"; float: left; font-size: 2.75em; font-weight: bold; line-height: 0.6em; margin-left: -0.6em; color: #6f6f6f; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: 0.5em; margin-right: 0.5ex; text-align: right; }
.quoteblock .quoteblock { margin-left: 0; margin-right: 0; padding: 0.5em 0; border-left: 3px solid #555555; }
.quoteblock .quoteblock blockquote { padding: 0 0 0 0.75em; }
.quoteblock .quoteblock blockquote:before { display: none; }

.verseblock { margin: 0 1em 1.25em 1em; }
.verseblock pre { font-family: "Open Sans", "DejaVu Sans", sans; font-size: 1.15rem; color: #6f6f6f; font-weight: 300; text-rendering: optimizeLegibility; }
.verseblock pre strong { font-weight: 400; }
.verseblock .attribution { margin-top: 1.25rem; margin-left: 0.5ex; }

.quoteblock .attribution, .verseblock .attribution { font-size: 0.8125em; line-height: 1.45; font-style: italic; }
.quoteblock .attribution br, .verseblock .attribution br { display: none; }
.quoteblock .attribution cite, .verseblock .attribution cite { display: block; letter-spacing: -0.05em; color: #555555; }

.quoteblock.abstract { margin: 0 0 1.25em 0; display: block; }
.quoteblock.abstract blockquote, .quoteblock.abstract blockquote p { text-align: left; word-spacing: 0; }
.quoteblock.abstract blockquote:before, .quoteblock.abstract blockquote p:first-of-type:before { display: none; }

table.tableblock { max-width: 100%; border-collapse: separate; }
table.tableblock td > .paragraph:last-child p > p:last-child, table.tableblock th > p:last-child, table.tableblock td > p:last-child { margin-bottom: 0; }

table.spread { width: 100%; }

table.tableblock, th.tableblock, td.tableblock { border: 0 solid #dddddd; }

table.grid-all th.tableblock, table.grid-all td.tableblock { border-width: 0 1px 1px 0; }

table.grid-all tfoot > tr > th.tableblock, table.grid-all tfoot > tr > td.tableblock { border-width: 1px 1px 0 0; }

table.grid-cols th.tableblock, table.grid-cols td.tableblock { border-width: 0 1px 0 0; }

table.grid-all * > tr > .tableblock:last-child, table.grid-cols * > tr > .tableblock:last-child { border-right-width: 0; }

table.grid-rows th.tableblock, table.grid-rows td.tableblock { border-width: 0 0 1px 0; }

table.grid-all tbody > tr:last-child > th.tableblock, table.grid-all tbody > tr:last-child > td.tableblock, table.grid-all thead:last-child > tr > th.tableblock, table.grid-rows tbody > tr:last-child > th.tableblock, table.grid-rows tbody > tr:last-child > td.tableblock, table.grid-rows thead:last-child > tr > th.tableblock { border-bottom-width: 0; }

table.grid-rows tfoot > tr > th.tableblock, table.grid-rows tfoot > tr > td.tableblock { border-width: 1px 0 0 0; }

table.frame-all { border-width: 1px; }

table.frame-sides { border-width: 0 1px; }

table.frame-topbot { border-width: 1px 0; }

th.halign-left, td.halign-left { text-align: left; }

th.halign-right, td.halign-right { text-align: right; }

th.halign-center, td.halign-center { text-align: center; }

th.valign-top, td.valign-top { vertical-align: top; }

th.valign-bottom, td.valign-bottom { vertical-align: bottom; }

th.valign-middle, td.valign-middle { vertical-align: middle; }

table thead th, table tfoot th { font-weight: bold; }

tbody tr th { display: table-cell; line-height: 1.4; background: whitesmoke; }

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p { color: #222222; font-weight: bold; }

p.tableblock > code:only-child { background: none; padding: 0; }

p.tableblock { font-size: 1em; }

td > div.verse { white-space: pre; }

ol { margin-left: 2.5em; }

ul li ol { margin-left: 1.5em; }

dl dd { margin-left: 1.125em; }

dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }

ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.625em; }

ul.unstyled, ol.unnumbered, ul.checklist, ul.none { list-style-type: none; }

ul.unstyled, ol.unnumbered, ul.checklist { margin-left: 0.625em; }

ul.checklist li > p:first-child > .fa-check-square-o:first-child, ul.checklist li > p:first-child > input[type="checkbox"]:first-child { margin-right: 0.25em; }

ul.checklist li > p:first-child > input[type="checkbox"]:first-child { position: relative; top: 1px; }

ul.inline { margin: 0 auto 0.625em auto; margin-left: -1.375em; margin-right: 0; padding: 0; list-style: none; overflow: hidden; }
ul.inline > li { list-style: none; float: left; margin-left: 1.375em; display: block; }
ul.inline > li > * { display: block; }

.unstyled dl dt { font-weight: normal; font-style: normal; }

ol.arabic { list-style-type: decimal; }

ol.decimal { list-style-type: decimal-leading-zero; }

ol.loweralpha { list-style-type: lower-alpha; }

ol.upperalpha { list-style-type: upper-alpha; }

ol.lowerroman { list-style-type: lower-roman; }

ol.upperroman { list-style-type: upper-roman; }

ol.lowergreek { list-style-type: lower-greek; }

.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }

td.hdlist1 { padding-right: .75em; font-weight: bold; }

td.hdlist1, td.hdlist2 { vertical-align: top; }

.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }

.colist > table tr > td:first-of-type { padding: 0 0.75em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.25em 0; }

.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: 0 0 0 1px #dddddd; box-shadow: 0 0 0 1px #dddddd; }

.imageblock.left, .imageblock[style*="float: left"] { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }

.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }

a.image { text-decoration: none; }

span.footnote, span.footnoteref { vertical-align: super; font-size: 0.875em; }
span.footnote a, span.footnoteref a { text-decoration: none; }
span.footnote a:active, span.footnoteref a:active { text-decoration: underline; }

#footnotes { padding-top: 0.75em; padding-bottom: 0.75em; margin-bottom: 0.625em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -.25em 0 .75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.375em; line-height: 1.3; font-size: 0.875em; margin-left: 1.2em; text-indent: -1.2em; margin-bottom: .2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }

#content #footnotes { margin-top: -0.625em; margin-bottom: 0; padding: 0.75em 0; }

.gist .file-data > table { border: 0; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }

div.unbreakable { page-break-inside: avoid; }

.big { font-size: larger; }

.small { font-size: smaller; }

.underline { text-decoration: underline; }

.overline { text-decoration: overline; }

.line-through { text-decoration: line-through; }

.aqua { color: #00bfbf; }

.aqua-background { background-color: #00fafa; }

.black { color: black; }

.black-background { background-color: black; }

.blue { color: #0000bf; }

.blue-background { background-color: #0000fa; }

.fuchsia { color: #bf00bf; }

.fuchsia-background { background-color: #fa00fa; }

.gray { color: #606060; }

.gray-background { background-color: #7d7d7d; }

.green { color: #006000; }

.green-background { background-color: #007d00; }

.lime { color: #00bf00; }

.lime-background { background-color: #00fa00; }

.maroon { color: #600000; }

.maroon-background { background-color: #7d0000; }

.navy { color: #000060; }

.navy-background { background-color: #00007d; }

.olive { color: #606000; }

.olive-background { background-color: #7d7d00; }

.purple { color: #600060; }

.purple-background { background-color: #7d007d; }

.red { color: #bf0000; }

.red-background { background-color: #fa0000; }

.silver { color: #909090; }

.silver-background { background-color: #bcbcbc; }

.teal { color: #006060; }

.teal-background { background-color: #007d7d; }

.white { color: #bfbfbf; }

.white-background { background-color: #fafafa; }

.yellow { color: #bfbf00; }

.yellow-background { background-color: #fafa00; }

span.icon > .fa { cursor: default; }

.admonitionblock td.icon [class^="fa icon-"] { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #207c98; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }

.conum[data-value] { display: inline-block; color: #fff !important; background-color: #222222; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; font-size: 0.75em; width: 1.67em; height: 1.67em; line-height: 1.67em; font-family: "Open Sans", "DejaVu Sans", sans-serif; font-style: normal; font-weight: bold; }
.conum[data-value] * { color: #fff !important; }
.conum[data-value] + b { display: none; }
.conum[data-value]:after { content: attr(data-value); }
pre .conum[data-value] { position: relative; top: -0.125em; }

b.conum * { color: inherit !important; }

.conum:not([data-value]):empty { display: none; }

.literalblock pre, .listingblock pre { background: #eeeeee; }

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.min.css">
<style>.listingblock .pygments .hll { background-color: #ffffcc }
.listingblock .pygments  { background: #f8f8f8; }
.listingblock .pygments .tok-c { color: #408080; font-style: italic } /* Comment */
.listingblock .pygments .tok-err { border: 1px solid #FF0000 } /* Error */
.listingblock .pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
.listingblock .pygments .tok-o { color: #666666 } /* Operator */
.listingblock .pygments .tok-cm { color: #408080; font-style: italic } /* Comment.Multiline */
.listingblock .pygments .tok-cp { color: #BC7A00 } /* Comment.Preproc */
.listingblock .pygments .tok-c1 { color: #408080; font-style: italic } /* Comment.Single */
.listingblock .pygments .tok-cs { color: #408080; font-style: italic } /* Comment.Special */
.listingblock .pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
.listingblock .pygments .tok-ge { font-style: italic } /* Generic.Emph */
.listingblock .pygments .tok-gr { color: #FF0000 } /* Generic.Error */
.listingblock .pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
.listingblock .pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
.listingblock .pygments .tok-go { color: #888888 } /* Generic.Output */
.listingblock .pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.listingblock .pygments .tok-gs { font-weight: bold } /* Generic.Strong */
.listingblock .pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.listingblock .pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
.listingblock .pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.listingblock .pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.listingblock .pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.listingblock .pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
.listingblock .pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.listingblock .pygments .tok-kt { color: #B00040 } /* Keyword.Type */
.listingblock .pygments .tok-m { color: #666666 } /* Literal.Number */
.listingblock .pygments .tok-s { color: #BA2121 } /* Literal.String */
.listingblock .pygments .tok-na { color: #7D9029 } /* Name.Attribute */
.listingblock .pygments .tok-nb { color: #008000 } /* Name.Builtin */
.listingblock .pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
.listingblock .pygments .tok-no { color: #880000 } /* Name.Constant */
.listingblock .pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
.listingblock .pygments .tok-ni { color: #999999; font-weight: bold } /* Name.Entity */
.listingblock .pygments .tok-ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.listingblock .pygments .tok-nf { color: #0000FF } /* Name.Function */
.listingblock .pygments .tok-nl { color: #A0A000 } /* Name.Label */
.listingblock .pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.listingblock .pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
.listingblock .pygments .tok-nv { color: #19177C } /* Name.Variable */
.listingblock .pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.listingblock .pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
.listingblock .pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
.listingblock .pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
.listingblock .pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
.listingblock .pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
.listingblock .pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
.listingblock .pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
.listingblock .pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
.listingblock .pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.listingblock .pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
.listingblock .pygments .tok-se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.listingblock .pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
.listingblock .pygments .tok-si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.listingblock .pygments .tok-sx { color: #008000 } /* Literal.String.Other */
.listingblock .pygments .tok-sr { color: #BB6688 } /* Literal.String.Regex */
.listingblock .pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
.listingblock .pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
.listingblock .pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
.listingblock .pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
.listingblock .pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
.listingblock .pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
.listingblock .pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Componentes enterprise</h1>
<div class="details">
<span id="author" class="author">Domingo Gallardo</span><br>
<span id="email" class="email"><a href="mailto:domingo.gallardo@ua.es">domingo.gallardo@ua.es</a></span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Índice de contenidos</div>
<ul class="sectlevel1">
<li><a href="#sesion03">3. Enterprise beans y JPA</a>
<ul class="sectlevel2">
<li><a href="#_proyecto_b%C3%A1sico_jpa">3.1. Proyecto básico JPA</a></li>
<li><a href="#_gesti%C3%B3n_de_transacciones_con_beans_de_sesi%C3%B3n">3.2. Gestión de transacciones con beans de sesión</a>
<ul class="sectlevel3">
<li><a href="#_gesti%C3%B3n_de_transacciones_bmt">3.2.1. Gestión de transacciones BMT</a></li>
<li><a href="#_gesti%C3%B3n_de_transacciones_cmt">3.2.2. Gestión de transacciones CMT</a></li>
<li><a href="#_gesti%C3%B3n_de_la_transacci%C3%B3n_con_la_interfaz_usertransaction">3.2.3. Gestión de la transacción con la interfaz UserTransaction</a></li>
<li><a href="#_transacciones_a_trav%C3%A9s_de_m%C3%BAltiples_bases_de_datos">3.2.4. Transacciones a través de múltiples bases de datos</a></li>
</ul>
</li>
<li><a href="#_entity_manager_y_contexto_de_persistencia_en_los_beans">3.3. Entity manager y contexto de persistencia en los beans</a></li>
<li><a href="#_ejemplo_completo">3.4. Ejemplo completo</a></li>
<li><a href="#_ejercicios">3.5. Ejercicios</a>
<ul class="sectlevel3">
<li><a href="#__3_5_puntos_aplicaci%C3%B3n_web_filmoteca">3.5.1. (3,5 puntos) Aplicación web filmoteca</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="sesion03">3. Enterprise beans y JPA</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Veremos en este apartado cómo se gestionan las transacciones y el contexto de persistencia (entity manager) con beans de sesión.</p>
</div>
<div class="sect2">
<h3 id="_proyecto_básico_jpa">3.1. Proyecto básico JPA</h3>
<div class="paragraph">
<p>Vamos a retomar el ejemplo básico con el que terminamos la sesión de JPA, en el que definimos una aplicación web con las entidades <code>Autor</code> y <code>Mensaje</code> y una relación uno-a-muchos entre ellas. Nos vamos a olvidar por el momento de los DAOs y vamos a trabajar directamente con las entidades.</p>
</div>
<div class="paragraph">
<p>Por simplificar, vamos a colocar todas las clases de entidad en el paquete <code>org.expertojava.ejb</code>:</p>
</div>
<div class="listingblock">
<div class="title">Autor.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">ejb</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.HashSet</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.Set</span><span class="tok-o">;</span>

<span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Autor</span> <span class="tok-o">{</span>
    <span class="tok-nd">@Id</span>
    <span class="tok-nd">@GeneratedValue</span>
    <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s">&quot;autor_id&quot;</span><span class="tok-o">)</span>
    <span class="tok-n">Long</span> <span class="tok-n">id</span><span class="tok-o">;</span>
    <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;email&quot;</span><span class="tok-o">,</span> <span class="tok-n">nullable</span> <span class="tok-o">=</span> <span class="tok-kc">false</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">correo</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
    <span class="tok-nd">@OneToMany</span><span class="tok-o">(</span><span class="tok-n">mappedBy</span> <span class="tok-o">=</span> <span class="tok-s">&quot;autor&quot;</span><span class="tok-o">,</span> <span class="tok-n">cascade</span> <span class="tok-o">=</span> <span class="tok-n">CascadeType</span><span class="tok-o">.</span><span class="tok-na">ALL</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Mensaje</span><span class="tok-o">&gt;</span> <span class="tok-n">mensajes</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">HashSet</span><span class="tok-o">&lt;</span><span class="tok-n">Mensaje</span><span class="tok-o">&gt;();</span>

    <span class="tok-kd">public</span> <span class="tok-n">Long</span> <span class="tok-nf">getId</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">id</span><span class="tok-o">;</span> <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getCorreo</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">correo</span><span class="tok-o">;</span> <span class="tok-o">}</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setCorreo</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">correo</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">correo</span> <span class="tok-o">=</span> <span class="tok-n">correo</span><span class="tok-o">;</span> <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getNombre</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">nombre</span><span class="tok-o">;</span> <span class="tok-o">}</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setNombre</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">nombre</span> <span class="tok-o">=</span> <span class="tok-n">nombre</span><span class="tok-o">;</span> <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Mensaje</span><span class="tok-o">&gt;</span> <span class="tok-nf">getMensajes</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">mensajes</span><span class="tok-o">;</span> <span class="tok-o">}</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setMensajes</span><span class="tok-o">(</span><span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Mensaje</span><span class="tok-o">&gt;</span> <span class="tok-n">mensajes</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">mensajes</span> <span class="tok-o">=</span> <span class="tok-n">mensajes</span><span class="tok-o">;</span> <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-nf">Autor</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-nf">Autor</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">,</span> <span class="tok-n">String</span> <span class="tok-n">correo</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">nombre</span> <span class="tok-o">=</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">correo</span> <span class="tok-o">=</span> <span class="tok-n">correo</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-kt">boolean</span> <span class="tok-nf">equals</span><span class="tok-o">(</span><span class="tok-n">Object</span> <span class="tok-n">o</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-k">this</span> <span class="tok-o">==</span> <span class="tok-n">o</span><span class="tok-o">)</span> <span class="tok-k">return</span> <span class="tok-kc">true</span><span class="tok-o">;</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">o</span> <span class="tok-o">==</span> <span class="tok-kc">null</span> <span class="tok-o">||</span> <span class="tok-n">getClass</span><span class="tok-o">()</span> <span class="tok-o">!=</span> <span class="tok-n">o</span><span class="tok-o">.</span><span class="tok-na">getClass</span><span class="tok-o">())</span> <span class="tok-k">return</span> <span class="tok-kc">false</span><span class="tok-o">;</span>

        <span class="tok-n">Autor</span> <span class="tok-n">autor</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-n">Autor</span><span class="tok-o">)</span> <span class="tok-n">o</span><span class="tok-o">;</span>

        <span class="tok-k">if</span> <span class="tok-o">(!</span><span class="tok-n">correo</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">correo</span><span class="tok-o">))</span> <span class="tok-k">return</span> <span class="tok-kc">false</span><span class="tok-o">;</span>
        <span class="tok-k">if</span> <span class="tok-o">(!</span><span class="tok-n">nombre</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">nombre</span><span class="tok-o">))</span> <span class="tok-k">return</span> <span class="tok-kc">false</span><span class="tok-o">;</span>

        <span class="tok-k">return</span> <span class="tok-kc">true</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-kt">int</span> <span class="tok-nf">hashCode</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-kt">int</span> <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-n">correo</span><span class="tok-o">.</span><span class="tok-na">hashCode</span><span class="tok-o">();</span>
        <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-mi">31</span> <span class="tok-o">*</span> <span class="tok-n">result</span> <span class="tok-o">+</span> <span class="tok-n">nombre</span><span class="tok-o">.</span><span class="tok-na">hashCode</span><span class="tok-o">();</span>
        <span class="tok-k">return</span> <span class="tok-n">result</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">toString</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-s">&quot;Autor{&quot;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;id=&quot;</span> <span class="tok-o">+</span> <span class="tok-n">id</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, correo=&#39;&quot;</span> <span class="tok-o">+</span> <span class="tok-n">correo</span> <span class="tok-o">+</span> <span class="tok-sc">&#39;\&#39;&#39;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, nombre=&#39;&quot;</span> <span class="tok-o">+</span> <span class="tok-n">nombre</span> <span class="tok-o">+</span> <span class="tok-sc">&#39;\&#39;&#39;</span> <span class="tok-o">+</span>
                <span class="tok-sc">&#39;}&#39;</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Mensaje.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">ejb</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.Date</span><span class="tok-o">;</span>

<span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Mensaje</span> <span class="tok-o">{</span>

    <span class="tok-nd">@Id</span>
    <span class="tok-nd">@GeneratedValue</span>
    <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s">&quot;mensaje_id&quot;</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">Long</span> <span class="tok-n">id</span><span class="tok-o">;</span>
    <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">nullable</span> <span class="tok-o">=</span> <span class="tok-kc">false</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">texto</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-n">Date</span> <span class="tok-n">fecha</span><span class="tok-o">;</span>
    <span class="tok-nd">@ManyToOne</span>
    <span class="tok-nd">@JoinColumn</span><span class="tok-o">(</span><span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s">&quot;autor&quot;</span><span class="tok-o">,</span> <span class="tok-n">nullable</span> <span class="tok-o">=</span> <span class="tok-kc">false</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">Autor</span> <span class="tok-n">autor</span><span class="tok-o">;</span>

    <span class="tok-kd">public</span> <span class="tok-n">Long</span> <span class="tok-nf">getId</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">id</span><span class="tok-o">;</span> <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getTexto</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">texto</span><span class="tok-o">;</span> <span class="tok-o">}</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setTexto</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">texto</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">texto</span> <span class="tok-o">=</span> <span class="tok-n">texto</span><span class="tok-o">;</span> <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">Date</span> <span class="tok-nf">getFecha</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">fecha</span><span class="tok-o">;</span> <span class="tok-o">}</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setFecha</span><span class="tok-o">(</span><span class="tok-n">Date</span> <span class="tok-n">fecha</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">fecha</span> <span class="tok-o">=</span> <span class="tok-n">fecha</span><span class="tok-o">;</span> <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">Autor</span> <span class="tok-nf">getAutor</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">autor</span><span class="tok-o">;</span> <span class="tok-o">}</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setAutor</span><span class="tok-o">(</span><span class="tok-n">Autor</span> <span class="tok-n">autor</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">autor</span> <span class="tok-o">=</span> <span class="tok-n">autor</span><span class="tok-o">;</span> <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-nf">Mensaje</span><span class="tok-o">()</span> <span class="tok-o">{}</span>

    <span class="tok-kd">public</span> <span class="tok-nf">Mensaje</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">texto</span><span class="tok-o">,</span> <span class="tok-n">Autor</span> <span class="tok-n">autor</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">texto</span> <span class="tok-o">=</span> <span class="tok-n">texto</span><span class="tok-o">;</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">autor</span> <span class="tok-o">=</span> <span class="tok-n">autor</span><span class="tok-o">;</span>
     <span class="tok-o">}</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-kt">boolean</span> <span class="tok-nf">equals</span><span class="tok-o">(</span><span class="tok-n">Object</span> <span class="tok-n">o</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-k">this</span> <span class="tok-o">==</span> <span class="tok-n">o</span><span class="tok-o">)</span> <span class="tok-k">return</span> <span class="tok-kc">true</span><span class="tok-o">;</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">o</span> <span class="tok-o">==</span> <span class="tok-kc">null</span> <span class="tok-o">||</span> <span class="tok-n">getClass</span><span class="tok-o">()</span> <span class="tok-o">!=</span> <span class="tok-n">o</span><span class="tok-o">.</span><span class="tok-na">getClass</span><span class="tok-o">())</span> <span class="tok-k">return</span> <span class="tok-kc">false</span><span class="tok-o">;</span>

        <span class="tok-n">Mensaje</span> <span class="tok-n">mensaje</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-n">Mensaje</span><span class="tok-o">)</span> <span class="tok-n">o</span><span class="tok-o">;</span>

        <span class="tok-k">if</span> <span class="tok-o">(!</span><span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">mensaje</span><span class="tok-o">.</span><span class="tok-na">autor</span><span class="tok-o">))</span> <span class="tok-k">return</span> <span class="tok-kc">false</span><span class="tok-o">;</span>
        <span class="tok-k">if</span> <span class="tok-o">(!</span><span class="tok-n">texto</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">mensaje</span><span class="tok-o">.</span><span class="tok-na">texto</span><span class="tok-o">))</span> <span class="tok-k">return</span> <span class="tok-kc">false</span><span class="tok-o">;</span>

        <span class="tok-k">return</span> <span class="tok-kc">true</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-kt">int</span> <span class="tok-nf">hashCode</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-kt">int</span> <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-n">texto</span><span class="tok-o">.</span><span class="tok-na">hashCode</span><span class="tok-o">();</span>
        <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-mi">31</span> <span class="tok-o">*</span> <span class="tok-n">result</span> <span class="tok-o">+</span> <span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">hashCode</span><span class="tok-o">();</span>
        <span class="tok-k">return</span> <span class="tok-n">result</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">toString</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-s">&quot;Mensaje{&quot;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;id=&quot;</span> <span class="tok-o">+</span> <span class="tok-n">id</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, texto=&#39;&quot;</span> <span class="tok-o">+</span> <span class="tok-n">texto</span> <span class="tok-o">+</span> <span class="tok-sc">&#39;\&#39;&#39;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, fecha=&quot;</span> <span class="tok-o">+</span> <span class="tok-n">fecha</span> <span class="tok-o">+</span>
                <span class="tok-sc">&#39;}&#39;</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El fichero <code>persistence.xml</code> es el siguiente. suponemos que en el servidor de aplicaciones ya está creada la fuente de datos <code>java:/datasources/MensajesDS</code>.</p>
</div>
<div class="listingblock">
<div class="title">META-INF/persistence.xml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tok-nt">&lt;persistence</span> <span class="tok-na">version=</span><span class="tok-s">&quot;2.0&quot;</span>
             <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://java.sun.com/xml/ns/persistence&quot;</span> <span class="tok-na">xmlns:xsi=</span><span class="tok-s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
             <span class="tok-na">xsi:schemaLocation=</span><span class="tok-s">&quot;</span>
<span class="tok-s">        http://java.sun.com/xml/ns/persistence</span>
<span class="tok-s">        http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;persistence-unit</span> <span class="tok-na">name=</span><span class="tok-s">&quot;mensajes&quot;</span><span class="tok-nt">&gt;</span>
        <span class="tok-nt">&lt;jta-data-source&gt;</span>java:/datasources/MensajesDS<span class="tok-nt">&lt;/jta-data-source&gt;</span>
        <span class="tok-nt">&lt;properties&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.hbm2ddl.auto&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;create&quot;</span> <span class="tok-nt">/&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.show_sql&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;true&quot;</span> <span class="tok-nt">/&gt;</span>
        <span class="tok-nt">&lt;/properties&gt;</span>
    <span class="tok-nt">&lt;/persistence-unit&gt;</span>
<span class="tok-nt">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_gestión_de_transacciones_con_beans_de_sesión">3.2. Gestión de transacciones con beans de sesión</h3>
<div class="paragraph">
<p>Los beans de sesión permiten dos tipos de gestión de transacciones, denominados CMP (<em>Container Managed Persistence</em>) y BMP (<em>Bean Managed Persistence</em>).</p>
</div>
<div class="paragraph">
<p>Cuando se utiliza CMP, los beans gestionan de forma automática las transacciones. Toda llamada a un método del bean es interceptada por el contenedor, que crea un contexto transaccional que dura hasta que el método ha terminado (con éxito o con fracaso, al lanzar una excepción). Si el método 	termina con éxito el contenedor hace un commit de la transacción. Si el método lanza una excepción el contenedor hace un rollback.</p>
</div>
<div class="paragraph">
<p>Cuando se utiliza BMP es el programador el que debe abrir y cerrar las transacciones utilizando JTA de forma explícita el código de los métodos del bean.</p>
</div>
<div class="paragraph">
<p>Ambos enfoques se basan en JTA, que es utilizado por el servidor de aplicaciones para gestionar las transacciones distribuidas utilizando el algoritmo <em>two phase commit</em>. Los recursos que participan en estas transacciones deben ser fuentes de datos XA.</p>
</div>
<div class="paragraph">
<p>Un uso muy común de los beans de sesión es la implementación de	la capa de negocio de la aplicación, definiendo métodos de servicio transaccionales. En cada método de servicio se realizan llamadas a la capa de persistencia definida por los DAO que gestionan las entidades del modelo. Los DAO utilizan entity managers inyectados por el contenedor. El contenedor se encarga automáticamente de inyectar el mismo entity manager en todos los DAO que participan en la misma transacción, de forma que todos los DAO van a compartir el mismo contexto de persistencia. Se libera a los DAO de la gestión de transacciones y su implementación se hace más sencilla y flexible.</p>
</div>
<div class="paragraph">
<p>Al utilizar JTA es posible llamar desde un método de servicio a otros servicios de la capa de negocio y englobar todo ello en una única transacción.</p>
</div>
<div class="sect3">
<h4 id="_gestión_de_transacciones_bmt">3.2.1. Gestión de transacciones BMT</h4>
<div class="paragraph">
<p>En la gestión de transacciones denominada BMT (<em>Bean Managed Transactions</em>) el programador se hace cargo de la gestión de transacciones dentro de los métodos de los beans utilizando JTA. Ya hemos visto anteriormente un ejemplo cuando describimos JTA:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Stateless</span>
<span class="tok-nd">@TransactionManagement</span><span class="tok-o">(</span><span class="tok-n">TransactionManagementType</span><span class="tok-o">.</span><span class="tok-na">BEAN</span><span class="tok-o">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">PedidoService</span> <span class="tok-o">{</span>
   <span class="tok-nd">@Resource</span>
   <span class="tok-kd">private</span> <span class="tok-n">UserTransaction</span> <span class="tok-n">userTransaction</span><span class="tok-o">;</span> <i class="conum" data-value="2"></i><b>(2)</b>

   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">hacerPedido</span><span class="tok-o">(</span><span class="tok-n">Item</span> <span class="tok-n">item</span><span class="tok-o">,</span> <span class="tok-n">Cliente</span> <span class="tok-n">cliente</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-k">try</span> <span class="tok-o">{</span>
         <span class="tok-n">userTransaction</span><span class="tok-o">.</span><span class="tok-na">begin</span><span class="tok-o">();</span> <i class="conum" data-value="3"></i><b>(3)</b>
         <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">itemService</span><span class="tok-o">.</span><span class="tok-na">disponible</span><span class="tok-o">(</span><span class="tok-n">item</span><span class="tok-o">))</span> <span class="tok-o">{</span>
            <span class="tok-n">pedidoService</span><span class="tok-o">.</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-n">cliente</span><span class="tok-o">,</span><span class="tok-n">item</span><span class="tok-o">);</span>
            <span class="tok-n">clienteService</span><span class="tok-o">.</span><span class="tok-na">anotaCargo</span><span class="tok-o">(</span><span class="tok-n">cliente</span><span class="tok-o">,</span><span class="tok-n">item</span><span class="tok-o">);</span>
            <span class="tok-n">itemService</span><span class="tok-o">.</span><span class="tok-na">empaqueta</span><span class="tok-o">(</span><span class="tok-n">cliente</span><span class="tok-o">,</span><span class="tok-n">item</span><span class="tok-o">);</span>
         <span class="tok-o">}</span>
         <span class="tok-n">userTransaction</span><span class="tok-o">.</span><span class="tok-na">commit</span><span class="tok-o">();</span>
      <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">Exception</span> <span class="tok-n">e</span><span class="tok-o">)</span> <span class="tok-o">{</span> <i class="conum" data-value="4"></i><b>(4)</b>
         <span class="tok-n">userTransaction</span><span class="tok-o">.</span><span class="tok-na">rollback</span><span class="tok-o">();</span>
         <span class="tok-n">e</span><span class="tok-o">.</span><span class="tok-na">printStackTrace</span><span class="tok-o">();</span>
      <span class="tok-o">}</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Se declara el tipo de gestión de transacción como BMT, para lo que se define el valor <code>TransactionManagementType.BEAN</code> como tipo de la anotación <code>@TransactionManagement</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Se declara el recurso <code>UserTransaction</code> que vamos a utilizar para controlar la transacción mediante JTA. Se define utilizando inyección de dependencias.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Se inicia la transacción. Las siguientes líneas de código definen las llamadas a los métodos transaccionales de otros beans de sesión. En estos métodos se utilizan conexiones XA que participan en la transacción definida en el bean.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Si alguna de estas llamadas genera una excepción, ésta se recoge y se llama a <code>userTransaction.rollback()</code>, con lo que automáticamente se deshace la transacción y todos los recursos implicados en la transacción vuelven a su estado original.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En el caso en que todas las llamadas terminen correctamente, se realiza la llamada <code>userTransaction.commit();</code> que la transacción y final se propaga a todos los recursos que intervienen en la transacción.</p>
</div>
<div class="paragraph">
<p>Vemos que el funcionamiento es idéntico al que hemos definido cuando hemos hablado de JTA. Todas las llamadas a los beans de sesión se incorporan a la misma transacción, <em>sin modificar el código de los métodos</em>. De esta forma no perdemos flexibilidad en los métodos de negocio, siguen siendo atómicos, se pueden utilizar de forma independiente y, además, pueden incorporarse distintas llamadas a la misma transacción.</p>
</div>
<div class="paragraph">
<p>Un problema de BMT es que no se puede unir una	transacción definida en un método a una transacción ya abierta por el llamador. De esta forma, si el método anterior es llamado desde un cliente que tiene una transacción JTA abierta, esta transacción del llamador se suspende. JTA no permite transacciones anidadas. De la misma forma, los métodos dentro de la transacción definida en el bean (<code>pedidoBean.add()</code> y demás) no pueden a su vez abrir una nueva transacción con BMT, ya que estaríamos en el mismo caso que el que hemos mencionado, abriendo una transacción anidad. En el siguiente apartado veremos que la gestión de transacciones por el contenedor (CMT, <em>Containter Managed Transaction</em>) proporciona más flexibilidad, ya que, por ejemplo, permite que los métodos de los beans se incorporen a transacciones ya abiertas.</p>
</div>
</div>
<div class="sect3">
<h4 id="_gestión_de_transacciones_cmt">3.2.2. Gestión de transacciones CMT</h4>
<div class="paragraph">
<p>Cuando verdaderamente aprovechamos todas las funcionalidades del contenedor EJB es cuando utilizamos el otro enfoque de la gestión de las transacciones en los enterprise beans, el llamado CMT (<em>Container Managed Transactions</em>). Aquí, el programador no tiene que escribir explícitamente ninguna instrucción para definir el alcance de la transacción, sino que es el contenedor EJB el que la maneja automáticamente. En este enfoque, los métodos de negocio de los beans se anotan y podemos configurar con anotaciones cómo se van a comportar. Veamos cómo definiríamos con CMT el mismo ejemplo anterior.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Stateless</span>
<span class="tok-nd">@TransactionManagement</span><span class="tok-o">(</span><span class="tok-n">TransactionManagementType</span><span class="tok-o">.</span><span class="tok-na">CONTAINER</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">PedidoService</span> <span class="tok-o">{</span>

   <span class="tok-nd">@TransactionAttribute</span><span class="tok-o">(</span><span class="tok-n">TransactionAttributeType</span><span class="tok-o">.</span><span class="tok-na">REQUIRED</span><span class="tok-o">)</span>
   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">hacerPedido</span><span class="tok-o">(</span><span class="tok-n">Item</span> <span class="tok-n">item</span><span class="tok-o">,</span> <span class="tok-n">Cliente</span> <span class="tok-n">cliente</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">itemService</span><span class="tok-o">.</span><span class="tok-na">disponible</span><span class="tok-o">(</span><span class="tok-n">item</span><span class="tok-o">))</span> <span class="tok-o">{</span>
         <span class="tok-n">pedidoService</span><span class="tok-o">.</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-n">cliente</span><span class="tok-o">,</span><span class="tok-n">item</span><span class="tok-o">);</span>
         <span class="tok-n">clienteService</span><span class="tok-o">.</span><span class="tok-na">anotaCargo</span><span class="tok-o">(</span><span class="tok-n">cliente</span><span class="tok-o">,</span><span class="tok-n">item</span><span class="tok-o">);</span>
         <span class="tok-n">itemService</span><span class="tok-o">.</span><span class="tok-na">empaqueta</span><span class="tok-o">(</span><span class="tok-n">cliente</span><span class="tok-o">,</span><span class="tok-n">item</span><span class="tok-o">);</span>
      <span class="tok-o">}</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Definimos en la clase el tipo de gestión de transacciones como <code>TransactionManagementType.CONTAINER</code>. El contenedor se encarga de la gestión de las transacciones del bean. Nosotros sólo 	debemos indicar en cada método qué tipo de gestión de transacción se debe hacer. En el método <code>hacerPedido</code> lo hemos definido como <code>REQUIRED</code> usando la anotación	<code>@TransactionAttribute</code>.</p>
</div>
<div class="paragraph">
<p>La anotación <code>@TransactionAttribute</code> se puede realizar a nivel de método o a nivel de clase. En este último caso todos los métodos de la clase se comportan de la forma especificada.</p>
</div>
<div class="paragraph">
<p>El tipo de atributo de transacción REQUIRED obliga a que el método se ejecute dentro de una transacción. En el caso en que el llamador del método haya abierto ya una transacción, el contenedor ejecuta este método en el ámbito de esa transacción. En el caso en que el llamador no haya definido ninguna transacción, el contenedor inicia automáticamente una transacción nueva.</p>
</div>
<div class="paragraph">
<p>El tipo de atributo de transacción REQUIRED es el que tienen por defecto todos los métodos de los componentes EJB. Por eso se dice que son componentes transaccionales.</p>
</div>
<div class="paragraph">
<p>Todas las llamadas a otros métodos desde el bean se ejecutan en una transacción. Estas llamadas pueden ser a la capa de persistencia o a otros métodos de negocio.</p>
</div>
<div class="paragraph">
<p>Si el método no termina normalmente, sino que lanza una excepción de tipo <code>RuntimeException</code> (porque la lanza él mismo o alguna de las llamadas realizadas) se realiza automáticamente un rollback de la transacción. El contenedor captura la excepción provocada por el método y llama a JTA para realizar un rollback.</p>
</div>
<div class="paragraph">
<p>Si se lanza una excepción chequeada que no es de tipo <code>RuntimeException</code> el rollback no se realiza automáticamente. En este caso hay que llamar al método <code>setRollbackOnly</code> del <code>EJBContext</code> que se puede	obtener por inyección de dependencias:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Stateless</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">PeliculaService</span> <span class="tok-o">{</span>
   <span class="tok-nd">@Resource</span>
   <span class="tok-kd">private</span> <span class="tok-n">EJBContext</span> <span class="tok-n">context</span><span class="tok-o">;</span>

   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">metodoTransaccional</span><span class="tok-o">()</span> <span class="tok-kd">throws</span> <span class="tok-n">AlgunaExcepcionChequeada</span> <span class="tok-o">{</span>

      <span class="tok-c1">// Llamadas a otros métodos</span>

      <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">seHaProducidoError</span><span class="tok-o">)</span> <span class="tok-o">{</span>
         <span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-na">setRollbackOnly</span><span class="tok-o">();</span>
         <span class="tok-k">throw</span> <span class="tok-k">new</span> <span class="tok-nf">AlgunaExcepcionChequeada</span><span class="tok-o">(</span><span class="tok-s">&quot;Se ha producido un error&quot;</span><span class="tok-o">);</span>
      <span class="tok-o">}</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si el método del bean termina normalmente, el contenedor hace commit de la transacción.</p>
</div>
<div class="paragraph">
<p>El código resultante es muy sencillo ya toda la gestión de la transacción se realiza de forma implícita. En el código sólo aparece la lógica de negocio.</p>
</div>
<div class="paragraph">
<p>La utilización de las transacciones CMT tiene la ventaja añadida de que los métodos pueden participar en transacciones abiertas en otros métodos.</p>
</div>
<div class="sect4">
<h5 id="_propagación_de_transacciones">Propagación de transacciones</h5>
<div class="paragraph">
<p>Existen seis posibles formas de propagar una transacción, definidas por los posibles tipos de atributos de transacción:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>TransactionAttributeType.REQUIRED</code></p>
</li>
<li>
<p><code>TransactionAttributeType.REQUIRES_NEW</code></p>
</li>
<li>
<p><code>TransactionAttributeType.SUPPPORTS</code></p>
</li>
<li>
<p><code>TransactionAttributeType.MANDATORY</code></p>
</li>
<li>
<p><code>TransactionAttributeType.NOT_SUPPORTED</code></p>
</li>
<li>
<p><code>TransactionAttributeType.NEVER</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>El funcionamiento de cada tipo de gestión depende de si el llamador del método hace la llamada con una transacción ya abierta o no. Vamos a ver un ejemplo. Supongamos que los métodos a los que se llama	en <code>hacerPedido()</code> no son métodos de un DAO (un POJO), sino que se tratan de métodos de negocio de otros EJBs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Stateless</span>
<span class="tok-nd">@TransactionManagement</span><span class="tok-o">(</span><span class="tok-n">TransactionManagementType</span><span class="tok-o">.</span><span class="tok-na">CONTAINER</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">PedidoEJB</span> <span class="tok-kd">implements</span> <span class="tok-n">PedidoLocal</span> <span class="tok-o">{</span>
   <span class="tok-nd">@Resource</span>
   <span class="tok-kd">private</span> <span class="tok-n">SessionContext</span> <span class="tok-n">context</span><span class="tok-o">;</span>

   <span class="tok-nd">@TransactionAttribute</span><span class="tok-o">(</span><span class="tok-n">TransactionAttributeType</span><span class="tok-o">.</span><span class="tok-na">REQUIRED</span><span class="tok-o">)</span>
   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">hacerPedido</span><span class="tok-o">(</span><span class="tok-n">Item</span> <span class="tok-n">item</span><span class="tok-o">,</span> <span class="tok-n">Cliente</span> <span class="tok-n">cliente</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-k">try</span> <span class="tok-o">{</span>
         <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">itemEJB</span><span class="tok-o">.</span><span class="tok-na">disponible</span><span class="tok-o">(</span><span class="tok-n">item</span><span class="tok-o">))</span> <span class="tok-o">{</span>
            <span class="tok-n">pedidoEJB</span><span class="tok-o">.</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-n">cliente</span><span class="tok-o">,</span><span class="tok-n">item</span><span class="tok-o">);</span>
            <span class="tok-n">clienteEJB</span><span class="tok-o">.</span><span class="tok-na">anotaCargo</span><span class="tok-o">(</span><span class="tok-n">cliente</span><span class="tok-o">,</span><span class="tok-n">item</span><span class="tok-o">);</span>
            <span class="tok-n">itemEJB</span><span class="tok-o">.</span><span class="tok-na">empaqueta</span><span class="tok-o">(</span><span class="tok-n">cliente</span><span class="tok-o">,</span><span class="tok-n">item</span><span class="tok-o">);</span>
         <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">Exception</span> <span class="tok-n">e</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-na">setRollbackOnly</span><span class="tok-o">();</span>
         <span class="tok-o">}</span>
      <span class="tok-o">}</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En este caso tenemos una situación como la que se muestra en la	siguiente figura, en la que un método de negocio de un EJB llama a otro método de negocio. ¿Cómo van a gestionar la transacción los métodos llamados? Va a depender de qué tipo de <code>@TransactionAttribute</code> se hayan definido en los métodos.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="imagenes/ejb/transacciones01.png" alt="" width="50%">
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>REQUIRED</code></dt>
<dd>
<p>se trata del tipo de gestión de transacciones por defecto. Si no declaramos el tipo en el método (ni en el bean) éste es el que se aplica. El código del método siempre debe estar en una transacción. Si el llamador realiza la llamada al método dentro de una transacción, el método participa en	ella y se une a la transacción. En el caso de que el llamador no haya definido ninguna transacción, se crea una nueva que finaliza al terminar el método.</p>
<div class="paragraph">
<p>Si la transacción falla en el método y éste participa en una transacción definida en el cliente, el contenedor deshará la transacción en el método y devolverá al cliente la excepción <code>javax.transaction.RollbackException</code>, para que el cliente obre en consecuencia.</p>
</div>
<div class="paragraph">
<p>Si el método termina sin que se genere ninguna excepción y la transacción es nueva (el llamador no había definido ninguna), el contenedor hace un commit de la transacción. En el caso en que el método participe en una transacción abierta en el cliente, será éste el que deberá hacer el commit.</p>
</div>
</dd>
<dt class="hdlist1"><code>REQUIRES_NEW</code></dt>
<dd>
<p>indica que el contenedor debe crear siempre una transacción nueva al comienzo del método, independientemente de si el cliente ha llamado al método con una transacción creada o no. La transacción en el llamador  (si existe) queda suspendida hasta que la llamada termina. Además, el método llamado no participa	en la transacción del llamador. El método llamado tiene su propia transacción y realiza un commit cuando termina. Si la transacción en el cliente falla después, el rollback ya no afecta al método terminado.</p>
<div class="paragraph">
<p>Un ejemplo de uso de este atributo es una llamada a un método para escribir logs. Si hay un error en la escritura del log, no queremos que se propague al llamador. Por otro lado, si el llamador falla queremos que quede constancia de ello.</p>
</div>
</dd>
<dt class="hdlist1"><code>SUPPORTS</code></dt>
<dd>
<p>el método hereda el estado transaccional del llamador. Si el llamador define una transacción, el método participa en ella. Si no, el método no se ejecuta en ninguna transacción. Suele utilizarse cuando el bean realiza operaciones de lectura que no modifican el estado de sus recursos transaccionales.</p>
</dd>
<dt class="hdlist1"><code>MANDATORY</code></dt>
<dd>
<p>el cliente debe	obligatoriamente crear una transacción antes de llamar a este método. Si se llama al método desde un entorno en el que no se ha abierto una transacción, se genera una excepción. Se usa muy raramente.</p>
</dd>
<dt class="hdlist1"><code>NOT_SUPPORTED</code></dt>
<dd>
<p>el método se ejecuta sin crear una transacción. En el caso en que el llamador haya creado una, ésta se suspende, se ejecuta el método y después continua. Para el cliente el comportamiento es igual que <code>REQUIRES_NEW</code>. La diferencia es que en el bean no se ha creado ninguna transacción.</p>
<div class="paragraph">
<p>Se suele usar sólo por MDB soportando un proveedor JMS no transaccional</p>
</div>
</dd>
<dt class="hdlist1"><code>NEVER</code></dt>
<dd>
<p>se genera una excepción si el cliente invoca el método habiendo creado una transacción. No se usa casi nunca.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_gestión_de_la_transacción_con_la_interfaz_usertransaction">3.2.3. Gestión de la transacción con la interfaz UserTransaction</h4>
<div class="paragraph">
<p>Para gestionar una transacción JTA de forma programativa deberemos en primer lugar obtener del servidor de aplicaciones el objeto <code>javax.transacion.UserTransaction</code>. La forma más sencilla de hacerlo es mediante inyección de dependencias, declarándolo con la anotación:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Resource</span>
<span class="tok-n">UserTransaction</span> <span class="tok-n">utx</span><span class="tok-o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Una vez obtenido el <code>UserTransaction</code> podemos llamar a los métodos de la interfaz para demarcar la transacción:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>public void begin()</code></p>
</li>
<li>
<p><code>public void commit()</code></p>
</li>
<li>
<p><code>public void rollback()</code></p>
</li>
<li>
<p><code>public int getStatus()</code></p>
</li>
<li>
<p><code>public void setRollbackOnly()</code></p>
</li>
<li>
<p><code>public void setTransactionTimeout(int segundos)</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Para comenzar una transacción la aplicación se debe llamar a <code>begin()</code>. Para finalizarla, la transacción debe llamar o bien a <code>commit()</code> o bien a <code>rollback()</code>.</p>
</div>
<div class="paragraph">
<p>El método <code>setRollbackOnly()</code> modifica la transacción actual de forma que el único resultado posible de la misma sea de roll back (falllo).</p>
</div>
<div class="paragraph">
<p>El método <code>setTransactionTimeout(int segundos)</code> permite modificar el timeout asociado con la transacción actual. El parámetro 	determina la duración del timeout en segundos. Si se le pasa como valor cero, el timeout de la transacción es el definido por defecto.</p>
</div>
<div class="paragraph">
<p>El siguiente ejemplo simplificado muestra un fragmento de código que utiliza transacciones JTA. En el ejemplo mostramos un fragmento de código en el que un usuario de una biblioteca devuelve tarde un préstamo y se le anota una multa</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">UserTransaction</span> <span class="tok-n">tx</span><span class="tok-o">;</span>

<span class="tok-c1">//...</span>
<span class="tok-c1">// Obtenemos el UserTransaction</span>
<span class="tok-c1">// y lo guardamos en tx</span>
<span class="tok-c1">//...</span>

<span class="tok-n">tx</span><span class="tok-o">.</span><span class="tok-na">begin</span><span class="tok-o">();</span>
<span class="tok-k">try</span> <span class="tok-o">{</span>
   <span class="tok-n">operacionService</span><span class="tok-o">.</span><span class="tok-na">devolverEjemplar</span><span class="tok-o">(</span><span class="tok-n">ejemplar</span><span class="tok-o">);</span>
   <span class="tok-n">usuarioService</span><span class="tok-o">.</span><span class="tok-na">multar</span><span class="tok-o">(</span><span class="tok-n">login</span><span class="tok-o">,</span> <span class="tok-n">fechaDevolucionPrevista</span><span class="tok-o">,</span>
                         <span class="tok-n">fechaDevolucionReal</span><span class="tok-o">);</span>
   <span class="tok-n">tx</span><span class="tok-o">.</span><span class="tok-na">commit</span><span class="tok-o">();</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">Exception</span> <span class="tok-n">e</span><span class="tok-o">)</span> <span class="tok-o">{</span>
   <span class="tok-n">tx</span><span class="tok-o">.</span><span class="tok-na">rollback</span><span class="tok-o">();</span>
   <span class="tok-k">throw</span> <span class="tok-k">new</span> <span class="tok-nf">BusinessException</span><span class="tok-o">(</span><span class="tok-s">&quot;Error al hacer la devolución&quot;</span><span class="tok-o">,</span> <span class="tok-n">e</span><span class="tok-o">);</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Los objetos <code>operacionService</code> y <code>usuarioService</code> son beans de sesión sin estado y los métodos <code>devolverEjemplar</code> y <code>multar</code> son métodos atómicos. Cada uno de ellos crea su  propia transacción. JTA nos permite incorporar ambas llamadas en una única transacción, de forma que si uno de los métodos devuelve algún error se deshace toda la operación.</p>
</div>
<div class="paragraph">
<p>El código anterior puede ejecutarse en cualquier componente gestionado por el contenedor, como por ejemplo un servlet. También puede incluirse en un bean que define un servicio componiendo llamadas a otros servicios.</p>
</div>
<div class="paragraph">
<p>La otra forma de gestionar transacciones es gestionándolas de forma declarativa con anotaciones en los EJBs. Lo veremos más adelante.</p>
</div>
</div>
<div class="sect3">
<h4 id="_transacciones_a_través_de_múltiples_bases_de_datos">3.2.4. Transacciones a través de múltiples bases de datos</h4>
<div class="paragraph">
<p>Una de las características interesantes de JTA es que permite gestionar transacciones distribuidas que afectan a distintas bases de datos. Podemos utilizar distintas unidades de persistencia en los beans y agruparlas en una misma transacción. Las siguientes figuran muestran dos posibles escenarios:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="imagenes/ejb/transacciones02.png" alt="" width="50%">
</div>
</div>
<div class="paragraph">
<p>En la figura anterior, el cliente invoca un método de negocio en el Bean-A. El método de negocio inicia una transacción, actualiza la base de datos X, actualiza la base de datos Y e invoca un método de negocio en el Bean-B. El segundo método de negocio actualiza la base de datos Z y devuelve el control al método de negocio en el Bean-A, que finaliza con éxito la transacción. Las tres actualizaciones de la base de datos ocurren en la misma transacción.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="imagenes/ejb/transacciones03.png" alt="" width="50%">
</div>
</div>
<div class="paragraph">
<p>En la figura anterior, el cliente llama a un método de negocio en el Bean-A, que comienza una transacción y actualiza la base de datos 	X. Luego el Bean-A invoca un segundo método de negocio en el Bean-B, que reside en un servidor de aplicaciones remoto. El método en el Bean-B actualiza la base de datos Y. La gestión de transacciones de ambos servidores de aplicaciones se asegura de que ambas actualizaciones se realizan en la misma transacción. Es un ejemplo de una transacción distribuida a nivel de servidores de aplicaciones.</p>
</div>
<div class="paragraph">
<p>Para este segundo ejemplo necesitamos un servidor de aplicaciones compatible con la especificación completa de Java EE 6. No basta con un servidor compatible con el perfil Web.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_entity_manager_y_contexto_de_persistencia_en_los_beans">3.3. Entity manager y contexto de persistencia en los beans</h3>
<div class="paragraph">
<p>Todas las acciones efectivas sobre las base de datos se realizan a través del <em>entity manager</em>. Es el objeto que se encarga de realizar las consultas y actualizaciones en las tablas y de mantener sincronizados con la base de datos los objetos entidad que residen en su contexto de persistencia.</p>
</div>
<div class="paragraph">
<p>Recordemos que el contexto de persistencia de un <em>entity manager</em> está formado por todos los objetos entidad gestionadas por el <em>entity manager</em> y que representan una caché de primer nivel de los datos.</p>
</div>
<div class="paragraph">
<p>El <em>entity manager</em> se encarga de propagar a la base de datos los cambios realizados en los objetos entidad haciendo un <em>flush</em> de forma automática cuando la transacción termina o antes de ejecutar una query.</p>
</div>
<div class="paragraph">
<p>En JPA gestionado por el contenedor la forma normal de obtener el <em>entity manager</em> es usando la inyección de dependencias:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@PersistenceContext</span><span class="tok-o">(</span><span class="tok-n">unitName</span> <span class="tok-o">=</span> <span class="tok-s">&quot;mensajes-ejbPU&quot;</span><span class="tok-o">)</span>
<span class="tok-n">EntityManager</span> <span class="tok-n">em</span><span class="tok-o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El atributo <code>unitName</code> indica la unidad de persistencia con la que se conecta el <em>entity manager</em>.</p>
</div>
<div class="paragraph">
<p>Esta inyección de dependencias hay que hacerla en un objeto gestionado al que el contenedor tenga acceso. Lo habitual es hacerla en el bean de sesión que define la interfaz de negocio.</p>
</div>
<div class="paragraph">
<p>Vamos a empezar definiendo un método de negocio muy sencillo. El método <code>nuevoAutor</code> que añade un autor a la base de datos.</p>
</div>
<div class="listingblock">
<div class="title">AutorService.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">ejb</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.ejb.Stateless</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManager</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.PersistenceContext</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.Date</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.List</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.Set</span><span class="tok-o">;</span>

<span class="tok-nd">@Stateless</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">AutorServicio</span> <span class="tok-o">{</span>

    <span class="tok-nd">@PersistenceContext</span><span class="tok-o">(</span><span class="tok-n">unitName</span> <span class="tok-o">=</span> <span class="tok-s">&quot;mensajes&quot;</span><span class="tok-o">)</span>
    <span class="tok-n">EntityManager</span> <span class="tok-n">em</span><span class="tok-o">;</span>

    <span class="tok-kd">public</span> <span class="tok-n">Autor</span> <span class="tok-nf">nuevoAutor</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">correo</span><span class="tok-o">,</span> <span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">Autor</span> <span class="tok-n">autor</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Autor</span><span class="tok-o">(</span><span class="tok-n">nombre</span><span class="tok-o">,</span> <span class="tok-n">correo</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">persist</span><span class="tok-o">(</span><span class="tok-n">autor</span><span class="tok-o">);</span>
        <span class="tok-k">return</span> <span class="tok-n">autor</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El contenedor es el encargado de inyectar el <em>entity manager</em>. El contenedor decidirá si debe crear un entity manager nuevo o si debe utilizar uno ya existente dependiendo del atributo <code>type</code> de la anotación <code>@PersistenceContext</code>.</p>
</div>
<div class="paragraph">
<p>El valor por defecto del atributo <code>type</code> es <code>PersistenceContextType.TRANSACTION</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@PersistenceContext</span><span class="tok-o">(</span><span class="tok-n">type</span><span class="tok-o">=</span><span class="tok-n">PersistenceContextType</span><span class="tok-o">.</span><span class="tok-na">TRANSACTION</span><span class="tok-o">)</span>
<span class="tok-n">EntityManager</span> <span class="tok-n">em</span><span class="tok-o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En los entity managers de tipo <code>TRANSACTION</code> se inyecta el mismo <em>entity manager</em> en todos los DAO que comparten la transacción. Esto significa que los distintos DAOs estarán compartiendo también el mismo contexto de persistencia y aprovechando la caché de entidades gestionadas.</p>
</div>
<div class="paragraph">
<p>El otro tipo de gestión de la vida del entity manager se utiliza con los beans de sesión con estado. El contexto de persistencia se mantiene abierto mientras que existe el bean con estado y las entidades permanecen gestionadas a lo largo de múltiples transacciones. Es lo que se denomina contexto de persistencia extendido:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@PersistenceContext</span><span class="tok-o">(</span><span class="tok-n">type</span><span class="tok-o">=</span><span class="tok-n">PersistenceContextType</span><span class="tok-o">.</span><span class="tok-na">EXTENDED</span><span class="tok-o">)</span>
<span class="tok-n">EntityManager</span> <span class="tok-n">em</span><span class="tok-o">;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ejemplo_completo">3.4. Ejemplo completo</h3>
<div class="paragraph">
<p>Los beans de sesión sin estado son, por sus características de transaccionalidad y seguridad, los componentes idóneos para implementar la capa de negocio de una aplicación.</p>
</div>
<div class="paragraph">
<p>Podemos comprobar su funcionamiento en el siguiente ejemplo, en el que completamos la aplicación web <code>mensajes</code> con la que hemos comenzado esta sesión.</p>
</div>
<div class="paragraph">
<p>El bean sin estado <code>AutorServicio</code> define los métodos de negocio. Obtiene un entity manager por inyección de dependencias.</p>
</div>
<div class="listingblock">
<div class="title">AutorServicio.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">ejb</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.ejb.Stateless</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManager</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.PersistenceContext</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.Date</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.List</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.Set</span><span class="tok-o">;</span>

<span class="tok-nd">@Stateless</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">AutorServicio</span> <span class="tok-o">{</span>

    <span class="tok-nd">@PersistenceContext</span><span class="tok-o">(</span><span class="tok-n">unitName</span> <span class="tok-o">=</span> <span class="tok-s">&quot;mensajes&quot;</span><span class="tok-o">)</span>
    <span class="tok-n">EntityManager</span> <span class="tok-n">em</span><span class="tok-o">;</span>

    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-kd">final</span> <span class="tok-n">String</span> <span class="tok-n">all_autores</span> <span class="tok-o">=</span> <span class="tok-s">&quot;SELECT a FROM Autor a&quot;</span><span class="tok-o">;</span>

    <span class="tok-kd">public</span> <span class="tok-n">Autor</span> <span class="tok-nf">nuevoAutor</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">correo</span><span class="tok-o">,</span> <span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">Autor</span> <span class="tok-n">autor</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Autor</span><span class="tok-o">(</span><span class="tok-n">nombre</span><span class="tok-o">,</span> <span class="tok-n">correo</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">persist</span><span class="tok-o">(</span><span class="tok-n">autor</span><span class="tok-o">);</span>
        <span class="tok-k">return</span> <span class="tok-n">autor</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">Mensaje</span> <span class="tok-nf">nuevoMensaje</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">texto</span><span class="tok-o">,</span> <span class="tok-n">Long</span> <span class="tok-n">idAutor</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">Autor</span> <span class="tok-n">autor</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Autor</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-n">idAutor</span><span class="tok-o">);</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">autor</span> <span class="tok-o">==</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
           <span class="tok-k">throw</span> <span class="tok-k">new</span> <span class="tok-nf">RuntimeException</span><span class="tok-o">(</span><span class="tok-s">&quot;No existe autor&quot;</span><span class="tok-o">);</span>
        <span class="tok-o">}</span> <span class="tok-k">else</span> <span class="tok-o">{</span>
            <span class="tok-n">Mensaje</span> <span class="tok-n">mens</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Mensaje</span><span class="tok-o">(</span><span class="tok-n">texto</span><span class="tok-o">,</span> <span class="tok-n">autor</span><span class="tok-o">);</span>
            <span class="tok-n">mens</span><span class="tok-o">.</span><span class="tok-na">setFecha</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">Date</span><span class="tok-o">());</span>
            <span class="tok-n">mens</span><span class="tok-o">.</span><span class="tok-na">setAutor</span><span class="tok-o">(</span><span class="tok-n">autor</span><span class="tok-o">);</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">persist</span><span class="tok-o">(</span><span class="tok-n">mens</span><span class="tok-o">);</span>
            <span class="tok-k">return</span> <span class="tok-n">mens</span><span class="tok-o">;</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Mensaje</span><span class="tok-o">&gt;</span> <span class="tok-nf">listaMensajes</span><span class="tok-o">(</span><span class="tok-n">Long</span> <span class="tok-n">idAutor</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">Autor</span> <span class="tok-n">autor</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Autor</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-n">idAutor</span><span class="tok-o">);</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">autor</span> <span class="tok-o">==</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-k">throw</span> <span class="tok-k">new</span> <span class="tok-nf">RuntimeException</span><span class="tok-o">(</span><span class="tok-s">&quot;No existe autor&quot;</span><span class="tok-o">);</span>
        <span class="tok-o">}</span> <span class="tok-k">else</span> <span class="tok-o">{</span>
            <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Mensaje</span><span class="tok-o">&gt;</span> <span class="tok-n">listaMensajes</span> <span class="tok-o">=</span> <span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">getMensajes</span><span class="tok-o">();</span>
            <span class="tok-n">listaMensajes</span><span class="tok-o">.</span><span class="tok-na">size</span><span class="tok-o">();</span>
            <span class="tok-k">return</span> <span class="tok-n">listaMensajes</span><span class="tok-o">;</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Autor</span><span class="tok-o">&gt;</span> <span class="tok-nf">listaAutores</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">createQuery</span><span class="tok-o">(</span><span class="tok-n">all_autores</span><span class="tok-o">).</span><span class="tok-na">getResultList</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Los siguientes servlets muestran cómo definir la capa de <em>controlador</em>  de la aplicación que recibe peticiones del usuario y las convierte en llamadas a los métodos de negocio. Más adelante veremos que es posible sustituir esta capa por los controladores de un API RESTful.</p>
</div>
<div class="paragraph">
<p>Los servlets son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>NuevoMensajeServlet</code>: añade un nuevo mensaje a un autor</p>
</li>
<li>
<p><code>NuevoAutorMensajeServlet</code>: añade un autor y un mensaje en una única transacción. Es un ejemplo que muestra cómo es posible utilizar la propagación de transacciones en los métodos de negocio.</p>
</li>
<li>
<p><code>ListaMensajesServlet</code>: devuelve los mensajes de un autor</p>
</li>
<li>
<p><code>ListaAutoresServlet</code>: devuelve todos los autores</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">NuevoMensajeServlet.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@WebServlet</span><span class="tok-o">(</span><span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s">&quot;nuevomensaje&quot;</span><span class="tok-o">,</span> <span class="tok-n">urlPatterns</span> <span class="tok-o">=</span> <span class="tok-s">&quot;/nuevomensaje&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">NuevoMensajesServlet</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span> <span class="tok-o">{</span>

    <span class="tok-nd">@EJB</span>
    <span class="tok-n">AutorServicio</span> <span class="tok-n">autorServicio</span><span class="tok-o">;</span>

    <span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">doPost</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                          <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
            <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>

    <span class="tok-o">}</span>

    <span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                         <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
            <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
        <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setContentType</span><span class="tok-o">(</span><span class="tok-s">&quot;text/html&quot;</span><span class="tok-o">);</span>

        <span class="tok-n">String</span> <span class="tok-n">texto</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;texto&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">Integer</span> <span class="tok-n">id</span> <span class="tok-o">=</span> <span class="tok-n">Integer</span><span class="tok-o">.</span><span class="tok-na">parseInt</span><span class="tok-o">(</span><span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;idAutor&quot;</span><span class="tok-o">));</span>

        <span class="tok-n">PrintWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>
        <span class="tok-n">Mensaje</span> <span class="tok-n">mens</span> <span class="tok-o">=</span> <span class="tok-n">autorServicio</span><span class="tok-o">.</span><span class="tok-na">nuevoMensaje</span><span class="tok-o">(</span><span class="tok-n">texto</span><span class="tok-o">,</span> <span class="tok-n">id</span><span class="tok-o">.</span><span class="tok-na">longValue</span><span class="tok-o">());</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;!DOCTYPE HTML PUBLIC \&quot;&quot;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;-//W3C//DTD HTML 4.0 &quot;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;Transitional//EN\&quot;&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;HTML&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;BODY&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;h1&gt;Mensaje&lt;/h1&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;p&gt;&quot;</span> <span class="tok-o">+</span> <span class="tok-n">mens</span><span class="tok-o">.</span><span class="tok-na">toString</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-s">&quot;&lt;/p&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/BODY&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/HTML&quot;</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">NuevoAutorMensaje.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@WebServlet</span><span class="tok-o">(</span><span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s">&quot;nuevoautor&quot;</span><span class="tok-o">,</span> <span class="tok-n">urlPatterns</span> <span class="tok-o">=</span> <span class="tok-s">&quot;/nuevoautor&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">NuevoAutorMensajeServlet</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span> <span class="tok-o">{</span>

    <span class="tok-nd">@EJB</span>
    <span class="tok-n">AutorServicio</span> <span class="tok-n">autorServicio</span><span class="tok-o">;</span>
    <span class="tok-nd">@Resource</span>
    <span class="tok-n">UserTransaction</span> <span class="tok-n">tx</span><span class="tok-o">;</span>

    <span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">doPost</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                          <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
            <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>

    <span class="tok-o">}</span>

    <span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                         <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
            <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>

        <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setContentType</span><span class="tok-o">(</span><span class="tok-s">&quot;text/html&quot;</span><span class="tok-o">);</span>

        <span class="tok-n">String</span> <span class="tok-n">nombre</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;nombre&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">String</span> <span class="tok-n">correo</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;correo&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">String</span> <span class="tok-n">texto</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;texto&quot;</span><span class="tok-o">);</span>

        <span class="tok-n">PrintWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>
        <span class="tok-k">try</span> <span class="tok-o">{</span>
            <span class="tok-n">tx</span><span class="tok-o">.</span><span class="tok-na">begin</span><span class="tok-o">();</span>
            <span class="tok-n">Autor</span> <span class="tok-n">autor</span> <span class="tok-o">=</span> <span class="tok-n">autorServicio</span><span class="tok-o">.</span><span class="tok-na">nuevoAutor</span><span class="tok-o">(</span><span class="tok-n">correo</span><span class="tok-o">,</span> <span class="tok-n">nombre</span><span class="tok-o">);</span>
            <span class="tok-n">autorServicio</span><span class="tok-o">.</span><span class="tok-na">nuevoMensaje</span><span class="tok-o">(</span><span class="tok-n">texto</span><span class="tok-o">,</span> <span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">getId</span><span class="tok-o">());</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;!DOCTYPE HTML PUBLIC \&quot;&quot;</span> <span class="tok-o">+</span>
                    <span class="tok-s">&quot;-//W3C//DTD HTML 4.0 &quot;</span> <span class="tok-o">+</span>
                    <span class="tok-s">&quot;Transitional//EN\&quot;&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;HTML&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;BODY&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;h1&gt;Añadido autor y mensaje&lt;/h1&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;p&gt;&quot;</span> <span class="tok-o">+</span> <span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">toString</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-s">&quot;&lt;p&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/BODY&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/HTML&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">tx</span><span class="tok-o">.</span><span class="tok-na">commit</span><span class="tok-o">();</span>
        <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">Exception</span> <span class="tok-n">e</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-k">try</span> <span class="tok-o">{</span>
                <span class="tok-n">tx</span><span class="tok-o">.</span><span class="tok-na">rollback</span><span class="tok-o">();</span>
            <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">SystemException</span> <span class="tok-n">e1</span><span class="tok-o">)</span> <span class="tok-o">{</span>
                <span class="tok-n">e1</span><span class="tok-o">.</span><span class="tok-na">printStackTrace</span><span class="tok-o">();</span>
                <span class="tok-k">throw</span> <span class="tok-k">new</span> <span class="tok-nf">RuntimeException</span><span class="tok-o">(</span><span class="tok-n">e1</span><span class="tok-o">);</span>
            <span class="tok-o">}</span>
            <span class="tok-k">throw</span> <span class="tok-k">new</span> <span class="tok-nf">RuntimeException</span><span class="tok-o">(</span><span class="tok-n">e</span><span class="tok-o">);</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">ListaMensajesServlet.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@WebServlet</span><span class="tok-o">(</span><span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s">&quot;listamensajes&quot;</span><span class="tok-o">,</span> <span class="tok-n">urlPatterns</span> <span class="tok-o">=</span> <span class="tok-s">&quot;/listamensajes&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">ListaMensajesServlet</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span> <span class="tok-o">{</span>

    <span class="tok-nd">@EJB</span>
    <span class="tok-n">AutorServicio</span> <span class="tok-n">autorServicio</span><span class="tok-o">;</span>

    <span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">doPost</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                          <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
            <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>

    <span class="tok-o">}</span>

    <span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                         <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
            <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
        <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setContentType</span><span class="tok-o">(</span><span class="tok-s">&quot;text/html&quot;</span><span class="tok-o">);</span>

        <span class="tok-n">Integer</span> <span class="tok-n">id</span> <span class="tok-o">=</span> <span class="tok-n">Integer</span><span class="tok-o">.</span><span class="tok-na">parseInt</span><span class="tok-o">(</span><span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;idAutor&quot;</span><span class="tok-o">));</span>

        <span class="tok-n">PrintWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>
        <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Mensaje</span><span class="tok-o">&gt;</span> <span class="tok-n">mensajes</span> <span class="tok-o">=</span>
                <span class="tok-n">autorServicio</span><span class="tok-o">.</span><span class="tok-na">listaMensajes</span><span class="tok-o">(</span><span class="tok-n">id</span><span class="tok-o">.</span><span class="tok-na">longValue</span><span class="tok-o">());</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;!DOCTYPE HTML PUBLIC \&quot;&quot;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;-//W3C//DTD HTML 4.0 &quot;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;Transitional//EN\&quot;&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;HTML&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;BODY&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;h1&gt;Mensajes&lt;/h1&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;ul&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">Mensaje</span> <span class="tok-n">m</span> <span class="tok-o">:</span> <span class="tok-n">mensajes</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;li&gt;&quot;</span> <span class="tok-o">+</span> <span class="tok-n">m</span><span class="tok-o">.</span><span class="tok-na">toString</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-s">&quot;&lt;/li&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-o">}</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/ul&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/BODY&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/HTML&quot;</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">ListaAutoresServlet.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@WebServlet</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;listaautores&quot;</span><span class="tok-o">,</span> <span class="tok-n">urlPatterns</span><span class="tok-o">=</span><span class="tok-s">&quot;/listaautores&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">ListaAutoresServlet</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span> <span class="tok-o">{</span>

    <span class="tok-nd">@EJB</span>
    <span class="tok-n">AutorServicio</span> <span class="tok-n">autorServicio</span><span class="tok-o">;</span>

    <span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">doPost</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                          <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
            <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>

    <span class="tok-o">}</span>

    <span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                         <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
            <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
        <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setContentType</span><span class="tok-o">(</span><span class="tok-s">&quot;text/html&quot;</span><span class="tok-o">);</span>

        <span class="tok-n">PrintWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>
        <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Autor</span><span class="tok-o">&gt;</span> <span class="tok-n">autores</span> <span class="tok-o">=</span> <span class="tok-n">autorServicio</span><span class="tok-o">.</span><span class="tok-na">listaAutores</span><span class="tok-o">();</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;!DOCTYPE HTML PUBLIC \&quot;&quot;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;-//W3C//DTD HTML 4.0 &quot;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;Transitional//EN\&quot;&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;HTML&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;BODY&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;h1&gt;Mensajes&lt;/h1&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;ul&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">Autor</span> <span class="tok-n">a</span> <span class="tok-o">:</span> <span class="tok-n">autores</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;li&gt;&quot;</span> <span class="tok-o">+</span> <span class="tok-n">a</span><span class="tok-o">.</span><span class="tok-na">toString</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-s">&quot;&lt;/li&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-o">}</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/ul&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/BODY&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/HTML&quot;</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por último, el siguiente JSP es el que recoge los datos mediante formularios y realiza las invocaciones a los servlets correspondientes.</p>
</div>
<div class="listingblock">
<div class="title">index.jsp</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-cp">&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.0 Transitional//EN&quot;&gt;</span>
<span class="tok-nt">&lt;html&gt;</span>
<span class="tok-nt">&lt;head&gt;</span>
    <span class="tok-nt">&lt;title&gt;</span>Start Page<span class="tok-nt">&lt;/title&gt;</span>
    <span class="tok-nt">&lt;meta</span> <span class="tok-na">http-equiv=</span><span class="tok-s">&quot;Content-Type&quot;</span> <span class="tok-na">content=</span><span class="tok-s">&quot;text/html; charset=UTF-8&quot;</span><span class="tok-nt">&gt;</span>
<span class="tok-nt">&lt;/head&gt;</span>
<span class="tok-nt">&lt;body&gt;</span>

<span class="tok-nt">&lt;h1&gt;</span>¡Mensajes!<span class="tok-nt">&lt;/h1&gt;</span>

<span class="tok-nt">&lt;h3&gt;</span>Nuevo autor y mensaje<span class="tok-nt">&lt;/h3&gt;</span>

<span class="tok-nt">&lt;form</span> <span class="tok-na">action=</span><span class="tok-s">&quot;&lt;%=request.getContextPath()%&gt;/nuevoautor&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;p&gt;</span>Correo: <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;correo&quot;</span><span class="tok-nt">&gt;&lt;/p&gt;</span>
    <span class="tok-nt">&lt;p&gt;</span>Nombre: <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;nombre&quot;</span><span class="tok-nt">&gt;&lt;/p&gt;</span>
    <span class="tok-nt">&lt;p&gt;</span>Texto: <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;texto&quot;</span><span class="tok-nt">&gt;&lt;/p&gt;</span>
    <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;submit&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;Enviar&quot;</span><span class="tok-nt">&gt;</span>
<span class="tok-nt">&lt;/form&gt;</span>

<span class="tok-nt">&lt;h3&gt;</span>Nuevo mensaje<span class="tok-nt">&lt;/h3&gt;</span>

<span class="tok-nt">&lt;form</span> <span class="tok-na">action=</span><span class="tok-s">&quot;&lt;%=request.getContextPath()%&gt;/nuevomensaje&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;p&gt;</span>Texto: <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;texto&quot;</span><span class="tok-nt">&gt;&lt;/p&gt;</span>
    <span class="tok-nt">&lt;p&gt;</span>Autor id: <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;idAutor&quot;</span><span class="tok-nt">&gt;&lt;/p&gt;</span>
    <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;submit&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;Enviar&quot;</span><span class="tok-nt">&gt;</span>
<span class="tok-nt">&lt;/form&gt;</span>

<span class="tok-nt">&lt;h3&gt;</span>Lista mensajes<span class="tok-nt">&lt;/h3&gt;</span>

<span class="tok-nt">&lt;form</span> <span class="tok-na">action=</span><span class="tok-s">&quot;&lt;%=request.getContextPath()%&gt;/listamensajes&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;p&gt;</span>Autor id: <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;idAutor&quot;</span><span class="tok-nt">&gt;&lt;/p&gt;</span>
    <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;submit&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;Enviar&quot;</span><span class="tok-nt">&gt;</span>
<span class="tok-nt">&lt;/form&gt;</span>

<span class="tok-nt">&lt;h3&gt;</span>Lista autores<span class="tok-nt">&lt;/h3&gt;</span>


<span class="tok-nt">&lt;form</span> <span class="tok-na">action=</span><span class="tok-s">&quot;&lt;%=request.getContextPath()%&gt;/listaautores&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;submit&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;Enviar&quot;</span><span class="tok-nt">&gt;</span>
<span class="tok-nt">&lt;/form&gt;</span>


<span class="tok-nt">&lt;/body&gt;</span>
<span class="tok-nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Un ejemplo de test Arquillian de la operación de negocio que crea un nuevo autor:</p>
</div>
<div class="listingblock">
<div class="title">SaludoServicioTest.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@RunWith</span><span class="tok-o">(</span><span class="tok-n">Arquillian</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">SaludoServicioTest</span> <span class="tok-o">{</span>

    <span class="tok-nd">@EJB</span>
    <span class="tok-kd">private</span> <span class="tok-n">AutorServicio</span> <span class="tok-n">autorServicio</span><span class="tok-o">;</span>

    <span class="tok-nd">@Deployment</span>
    <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-n">Archive</span><span class="tok-o">&lt;?&gt;</span> <span class="tok-n">deployment</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">ShrinkWrap</span><span class="tok-o">.</span><span class="tok-na">create</span><span class="tok-o">(</span><span class="tok-n">WebArchive</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">)</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">Autor</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addAsResource</span><span class="tok-o">(</span><span class="tok-s">&quot;META-INF/persistence.xml&quot;</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">deberiaDevolverNuevoAutor</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">String</span> <span class="tok-n">correo</span> <span class="tok-o">=</span> <span class="tok-s">&quot;pedro.picapiedra@gmail.com&quot;</span><span class="tok-o">;</span>
        <span class="tok-n">String</span> <span class="tok-n">nombre</span> <span class="tok-o">=</span> <span class="tok-s">&quot;Pedro Picapiedra&quot;</span><span class="tok-o">;</span>
        <span class="tok-n">Autor</span> <span class="tok-n">autor</span> <span class="tok-o">=</span> <span class="tok-n">autorServicio</span><span class="tok-o">.</span><span class="tok-na">nuevoAutor</span><span class="tok-o">(</span><span class="tok-n">correo</span><span class="tok-o">,</span> <span class="tok-n">nombre</span><span class="tok-o">);</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">getCorreo</span><span class="tok-o">().</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">correo</span><span class="tok-o">)</span> <span class="tok-o">&amp;&amp;</span>
                   <span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">getNombre</span><span class="tok-o">().</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">nombre</span><span class="tok-o">));</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios">3.5. Ejercicios</h3>
<div class="sect3">
<h4 id="__3_5_puntos_aplicación_web_filmoteca">3.5.1. (3,5 puntos) Aplicación web filmoteca</h4>
<div class="paragraph">
<p>Crea la aplicación web <code>filmoteca</code> con todas las entidades y DAOs que hayas definido en los ejercicios de JPA. Convierte las clases <code>PeliculaServicio</code> y <code>ActorServicio</code> en beans de sesión y crea un mínimo de 4 servlets que prueben su funcionamiento. Define también un test Arquilian como mínimo.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2015-11-25 16:18:06 CET
</div>
</div>
</body>
</html>