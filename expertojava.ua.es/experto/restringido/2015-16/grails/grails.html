<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.2">
<meta name="author" content="Fran García">
<title>Grails</title>
<style>/*! normalize.css v2.1.2 | MIT License | git.io/normalize */
/* ========================================================================== HTML5 display definitions ========================================================================== */
/** Correct `block` display not defined in IE 8/9. */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }

/** Correct `inline-block` display not defined in IE 8/9. */
audio, canvas, video { display: inline-block; }

/** Prevent modern browsers from displaying `audio` without controls. Remove excess height in iOS 5 devices. */
audio:not([controls]) { display: none; height: 0; }

/** Address `[hidden]` styling not present in IE 8/9. Hide the `template` element in IE, Safari, and Firefox < 22. */
[hidden], template { display: none; }

script { display: none !important; }

/* ========================================================================== Base ========================================================================== */
/** 1. Set default font family to sans-serif. 2. Prevent iOS text size adjust after orientation change, without disabling user zoom. */
html { font-family: sans-serif; /* 1 */ -ms-text-size-adjust: 100%; /* 2 */ -webkit-text-size-adjust: 100%; /* 2 */ }

/** Remove default margin. */
body { margin: 0; }

/* ========================================================================== Links ========================================================================== */
/** Remove the gray background color from active links in IE 10. */
a { background: transparent; }

/** Address `outline` inconsistency between Chrome and other browsers. */
a:focus { outline: thin dotted; }

/** Improve readability when focused and also mouse hovered in all browsers. */
a:active, a:hover { outline: 0; }

/* ========================================================================== Typography ========================================================================== */
/** Address variable `h1` font-size and margin within `section` and `article` contexts in Firefox 4+, Safari 5, and Chrome. */
h1 { font-size: 2em; margin: 0.67em 0; }

/** Address styling not present in IE 8/9, Safari 5, and Chrome. */
abbr[title] { border-bottom: 1px dotted; }

/** Address style set to `bolder` in Firefox 4+, Safari 5, and Chrome. */
b, strong { font-weight: bold; }

/** Address styling not present in Safari 5 and Chrome. */
dfn { font-style: italic; }

/** Address differences between Firefox and other browsers. */
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }

/** Address styling not present in IE 8/9. */
mark { background: #ff0; color: #000; }

/** Correct font family set oddly in Safari 5 and Chrome. */
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }

/** Improve readability of pre-formatted text in all browsers. */
pre { white-space: pre-wrap; }

/** Set consistent quote types. */
q { quotes: "\201C" "\201D" "\2018" "\2019"; }

/** Address inconsistent and variable font size in all browsers. */
small { font-size: 80%; }

/** Prevent `sub` and `sup` affecting `line-height` in all browsers. */
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }

sup { top: -0.5em; }

sub { bottom: -0.25em; }

/* ========================================================================== Embedded content ========================================================================== */
/** Remove border when inside `a` element in IE 8/9. */
img { border: 0; }

/** Correct overflow displayed oddly in IE 9. */
svg:not(:root) { overflow: hidden; }

/* ========================================================================== Figures ========================================================================== */
/** Address margin not present in IE 8/9 and Safari 5. */
figure { margin: 0; }

/* ========================================================================== Forms ========================================================================== */
/** Define consistent border, margin, and padding. */
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }

/** 1. Correct `color` not being inherited in IE 8/9. 2. Remove padding so people aren't caught out if they zero out fieldsets. */
legend { border: 0; /* 1 */ padding: 0; /* 2 */ }

/** 1. Correct font family not being inherited in all browsers. 2. Correct font size not being inherited in all browsers. 3. Address margins set differently in Firefox 4+, Safari 5, and Chrome. */
button, input, select, textarea { font-family: inherit; /* 1 */ font-size: 100%; /* 2 */ margin: 0; /* 3 */ }

/** Address Firefox 4+ setting `line-height` on `input` using `!important` in the UA stylesheet. */
button, input { line-height: normal; }

/** Address inconsistent `text-transform` inheritance for `button` and `select`. All other form control elements do not inherit `text-transform` values. Correct `button` style inheritance in Chrome, Safari 5+, and IE 8+. Correct `select` style inheritance in Firefox 4+ and Opera. */
button, select { text-transform: none; }

/** 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio` and `video` controls. 2. Correct inability to style clickable `input` types in iOS. 3. Improve usability and consistency of cursor style between image-type `input` and others. */
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; /* 2 */ cursor: pointer; /* 3 */ }

/** Re-set default cursor for disabled elements. */
button[disabled], html input[disabled] { cursor: default; }

/** 1. Address box sizing set to `content-box` in IE 8/9. 2. Remove excess padding in IE 8/9. */
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; /* 1 */ padding: 0; /* 2 */ }

/** 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome. 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome (include `-moz` to future-proof). */
input[type="search"] { -webkit-appearance: textfield; /* 1 */ -moz-box-sizing: content-box; -webkit-box-sizing: content-box; /* 2 */ box-sizing: content-box; }

/** Remove inner padding and search cancel button in Safari 5 and Chrome on OS X. */
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }

/** Remove inner padding and border in Firefox 4+. */
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }

/** 1. Remove default vertical scrollbar in IE 8/9. 2. Improve readability and alignment in all browsers. */
textarea { overflow: auto; /* 1 */ vertical-align: top; /* 2 */ }

/* ========================================================================== Tables ========================================================================== */
/** Remove most spacing between table cells. */
table { border-collapse: collapse; border-spacing: 0; }

meta.foundation-mq-small { font-family: "only screen and (min-width: 768px)"; width: 768px; }

meta.foundation-mq-medium { font-family: "only screen and (min-width:1280px)"; width: 1280px; }

meta.foundation-mq-large { font-family: "only screen and (min-width:1440px)"; width: 1440px; }

*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }

html, body { font-size: 97%; }

body { background: white; color: #222222; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }

a:hover { cursor: pointer; }

img, object, embed { max-width: 100%; height: auto; }

object, embed { height: 100%; }

img { -ms-interpolation-mode: bicubic; }

#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }

.left { float: left !important; }

.right { float: right !important; }

.text-left { text-align: left !important; }

.text-right { text-align: right !important; }

.text-center { text-align: center !important; }

.text-justify { text-align: justify !important; }

.hide { display: none; }

.antialiased, body { -webkit-font-smoothing: antialiased; }

img { display: inline-block; vertical-align: middle; }

textarea { height: auto; min-height: 50px; }

select { width: 100%; }

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }

.subheader, .admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { line-height: 1.4; color: #6f6f6f; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }

/* Typography resets */
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }

/* Default Link Styles */
a { color: #1164be; text-decoration: none; line-height: inherit; }
a img { border: none; }

/* Default paragraph styles */
p { font-family: inherit; font-weight: normal; font-size: 1em; line-height: 1.4; margin-bottom: 1em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }

/* Default header styles */
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: bold; font-style: normal; color: #1c355e; text-rendering: optimizeLegibility; margin-top: 1em; margin-bottom: 0.5em; line-height: 1.2125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #6f6f6f; line-height: 0; }

h1 { font-size: 2.125em; }

h2 { font-size: 1.6875em; }

h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }

h4 { font-size: 1.125em; }

h5 { font-size: 1.125em; }

h6 { font-size: 1em; }

hr { border: solid #dddddd; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }

/* Helpful Typography Defaults */
em, i { font-style: italic; line-height: inherit; }

strong, b { font-weight: bold; line-height: inherit; }

small { font-size: 60%; line-height: inherit; }

code { font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: bold; }

/* Lists */
ul, ol, dl { font-size: 1em; line-height: 1.4; margin-bottom: 1.25em; list-style-position: outside; font-family: inherit; }

ul, ol { margin-left: 2.5em; }
ul.no-bullet, ol.no-bullet { margin-left: 1.5em; }

/* Unordered Lists */
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; /* Override nested font-size change */ }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }

/* Ordered Lists */
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }

/* Definition Lists */
dl dt { margin-bottom: 0.3125em; font-weight: bold; }
dl dd { margin-bottom: 1.25em; }

/* Abbreviations */
abbr, acronym { text-transform: uppercase; font-size: 90%; color: #222222; border-bottom: 1px dotted #dddddd; cursor: help; }

abbr { text-transform: none; }

/* Blockquotes */
blockquote { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
blockquote cite { display: block; font-size: 0.8125em; color: #555555; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #555555; }

blockquote, blockquote p { line-height: 1.6; color: #6f6f6f; }

/* Microformats */
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #dddddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }

.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }

/*@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.6875em; }
  h4 { font-size: 1.4375em; } }*/
/* Tables */
table { background: white; margin-bottom: 1.25em; border: solid 1px #dddddd; }
table thead, table tfoot { background: whitesmoke; font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: #222222; text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: #222222; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #f9f9f9; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.4; }

h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; border-bottom: 1px solid #dddddd }

.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }

*:not(pre) > code { font-size: inherit; font-style: normal !important; letter-spacing: 0; padding: 3px 2px 1px 2px; background-color: #eeeeee; border: 1px solid #dddddd; -webkit-border-radius: 0; border-radius: 0; line-height: inherit; font-weight: normal; }

pre, pre > code { line-height: 1.4; color: black; font-family: monospace, serif; font-weight: normal; }

.keyseq { color: #555555; }

kbd { display: inline-block; color: #222222; font-size: 0.75em; line-height: 1.4; background-color: #f7f7f7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; margin: -0.15em 0.15em 0 0.15em; padding: 0.2em 0.6em 0.2em 0.5em; vertical-align: middle; white-space: nowrap; }

.keyseq kbd:first-child { margin-left: 0; }

.keyseq kbd:last-child { margin-right: 0; }

.menuseq, .menu { color: #090909; }

b.button:before, b.button:after { position: relative; top: -1px; font-weight: normal; }

b.button:before { content: "["; padding: 0 3px 0 2px; }

b.button:after { content: "]"; padding: 0 2px 0 3px; }

#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 0.9375em; padding-right: 0.9375em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }

#content { margin-top: 1.25em; }

#content:before { content: none; }

#header > h1:first-child { color: black; margin-top: 2.25rem; margin-bottom: 0; }
#header > h1:first-child + #toc { margin-top: 8px; border-top: 1px solid #dddddd; }
#header > h1:only-child, body.toc2 #header > h1:nth-last-child(2) { border-bottom: 1px solid #dddddd; padding-bottom: 8px; }
#header .details { border-bottom: 1px solid #dddddd; line-height: 1.45; padding-top: 0.25em; padding-bottom: 0.25em; padding-left: 0.25em; color: #555555; display: -ms-flexbox; display: -webkit-flex; display: flex; -ms-flex-flow: row wrap; -webkit-flex-flow: row wrap; flex-flow: row wrap; }
#header .details span:first-child { margin-left: -0.125em; }
#header .details span.email a { color: #6f6f6f; }
#header .details br { display: none; }
#header .details br + span:before { content: "\00a0\2013\00a0"; }
#header .details br + span.author:before { content: "\00a0\22c5\00a0"; color: #6f6f6f; }
#header .details br + span#revremark:before { content: "\00a0|\00a0"; }
#header #revnumber { text-transform: capitalize; }
#header #revnumber:after { content: "\00a0"; }

#content > h1:first-child:not([class]) { color: black; border-bottom: 1px solid #dddddd; padding-bottom: 8px; margin-top: 0; padding-top: 1rem; margin-bottom: 1.25rem; }

#floating {
  position: fixed;
  z-index: 1000;
  padding: 0.5em;
  right: 0;
  top: 0;
  background: white;
  box-shadow: 0 0 1em #777777;
  -webkit-box-shadow: 0 0 1em #777777;
  -moz-box-shadow: 0 0 1em #777777;
  -webkit-border-bottom-left-radius: 5px;
  -moz-border-radius-bottomleft: 5px;
  max-height: 80%;
  overflow: auto;
}

#floating #full { display: none; } /* Hide the full TOC by default */

#floating:hover #full{
  display: block; /* Show it on hover */
}


#toc { border-bottom: 1px solid #dddddd; padding-bottom: 0.5em; }
#toc > ul { margin-left: 0.125em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin: 0.5em 0; }
#toc ul { font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; list-style-type: none; }
#toc a { text-decoration: none; }
#toc a:active { text-decoration: underline; }

#toctitle { color: #6f6f6f; font-size: 1.2em; }

@media only screen and (min-width: 768px) { #toctitle { font-size: 1.375em; }
  body.toc2 { padding-left: 15em; padding-right: 0; }
  #toc.toc2 { margin-top: 0 !important; background-color: #f2f2f2; position: fixed; width: 15em; left: 0; top: 0; border-right: 1px solid #dddddd; border-top-width: 0 !important; border-bottom-width: 0 !important; z-index: 1000; padding: 1.25em 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; font-size: 1.2em; }
  #toc.toc2 > ul { font-size: 0.9em; margin-bottom: 0; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 15em; }
  body.toc2.toc-right #toc.toc2 { border-right-width: 0; border-left: 1px solid #dddddd; left: auto; right: 0; } }
@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; padding-right: 0; }
  #toc.toc2 { width: 20em; }
  #toc.toc2 #toctitle { font-size: 1.375em; }
  #toc.toc2 > ul { font-size: 0.95em; }
  #toc.toc2 ul ul { padding-left: 1.25em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; } }
#content #toc { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 0; border-radius: 0; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }

#footer { max-width: 100%; background-color: #222222; padding: 1.25em; }

#footer-text { color: #dddddd; line-height: 1.44; }

.sect1 { padding-bottom: 0.625em; }

@media only screen and (min-width: 768px) { .sect1 { padding-bottom: 1.25em; } }
.sect1 + .sect1 { border-top: 1px solid #dddddd; }

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; z-index: 1001; width: 1.5ex; margin-left: -1.5ex; display: block; text-decoration: none !important; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: "\00A7"; font-size: 0.85em; display: block; padding-top: 0.1em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #222222; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #151515; }

.audioblock, .imageblock, .literalblock, .listingblock, .stemblock, .videoblock { margin-bottom: 1.25em; }

.admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-rendering: optimizeLegibility; text-align: left; }

table.tableblock > caption.title { white-space: nowrap; overflow: visible; max-width: 0; }

.paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { color: black; }

table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }

.admonitionblock > table { border-collapse: separate; border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #dddddd; color: #555555; }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }

.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 0; border-radius: 0; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }

.sidebarblock { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 0; border-radius: 0; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock > .content > .title { color: #6f6f6f; margin-top: 0; }

.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }

.literalblock pre, .listingblock pre:not(.highlight), .listingblock pre[class="highlight"], .listingblock pre[class^="highlight "], .listingblock pre.CodeRay, .listingblock pre.prettyprint { background: #eeeeee; }
.sidebarblock .literalblock pre, .sidebarblock .listingblock pre:not(.highlight), .sidebarblock .listingblock pre[class="highlight"], .sidebarblock .listingblock pre[class^="highlight "], .sidebarblock .listingblock pre.CodeRay, .sidebarblock .listingblock pre.prettyprint { background: #f2f1f1; }

.literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { border: 1px solid #cccccc; -webkit-border-radius: 0; border-radius: 0; word-wrap: break-word; padding: 0.8em 0.8em 0.65em 0.8em; font-size: 0.8125em; }
.literalblock pre.nowrap, .literalblock pre[class].nowrap, .listingblock pre.nowrap, .listingblock pre[class].nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
@media only screen and (min-width: 768px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 0.90625em; } }
@media only screen and (min-width: 1280px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 1em; } }

.literalblock.output pre { color: #eeeeee; background-color: black; }

.listingblock pre.highlightjs { padding: 0; }
.listingblock pre.highlightjs > code { padding: 0.8em 0.8em 0.65em 0.8em; -webkit-border-radius: 0; border-radius: 0; }

.listingblock > .content { position: relative; }

.listingblock code[data-lang]:before { display: none; content: attr(data-lang); position: absolute; font-size: 0.75em; top: 0.425rem; right: 0.5rem; line-height: 1; text-transform: uppercase; color: #999; }

.listingblock:hover code[data-lang]:before { display: block; }

.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }

.listingblock.terminal pre .command:not([data-prompt]):before { content: "$"; }

table.pyhltable { border-collapse: separate; border: 0; margin-bottom: 0; background: none; }

table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; }

table.pyhltable td.code { padding-left: .75em; padding-right: 0; }

pre.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #dddddd; }

pre.pygments .lineno { display: inline-block; margin-right: .25em; }

table.pyhltable .linenodiv { background: none !important; padding-right: 0 !important; }

.quoteblock { margin: 0 1em 1.25em 1.5em; display: table; }
.quoteblock > .title { margin-left: -1.5em; margin-bottom: 0.75em; }
.quoteblock blockquote, .quoteblock blockquote p { color: #6f6f6f; font-size: 1.15rem; line-height: 1.75; word-spacing: 0.1em; letter-spacing: 0; font-style: italic; text-align: justify; }
.quoteblock blockquote { margin: 0; padding: 0; border: 0; }
.quoteblock blockquote:before { content: "\201c"; float: left; font-size: 2.75em; font-weight: bold; line-height: 0.6em; margin-left: -0.6em; color: #6f6f6f; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: 0.5em; margin-right: 0.5ex; text-align: right; }
.quoteblock .quoteblock { margin-left: 0; margin-right: 0; padding: 0.5em 0; border-left: 3px solid #555555; }
.quoteblock .quoteblock blockquote { padding: 0 0 0 0.75em; }
.quoteblock .quoteblock blockquote:before { display: none; }

.verseblock { margin: 0 1em 1.25em 1em; }
.verseblock pre { font-family: "Open Sans", "DejaVu Sans", sans; font-size: 1.15rem; color: #6f6f6f; font-weight: 300; text-rendering: optimizeLegibility; }
.verseblock pre strong { font-weight: 400; }
.verseblock .attribution { margin-top: 1.25rem; margin-left: 0.5ex; }

.quoteblock .attribution, .verseblock .attribution { font-size: 0.8125em; line-height: 1.45; font-style: italic; }
.quoteblock .attribution br, .verseblock .attribution br { display: none; }
.quoteblock .attribution cite, .verseblock .attribution cite { display: block; letter-spacing: -0.05em; color: #555555; }

.quoteblock.abstract { margin: 0 0 1.25em 0; display: block; }
.quoteblock.abstract blockquote, .quoteblock.abstract blockquote p { text-align: left; word-spacing: 0; }
.quoteblock.abstract blockquote:before, .quoteblock.abstract blockquote p:first-of-type:before { display: none; }

table.tableblock { max-width: 100%; border-collapse: separate; }
table.tableblock td > .paragraph:last-child p > p:last-child, table.tableblock th > p:last-child, table.tableblock td > p:last-child { margin-bottom: 0; }

table.spread { width: 100%; }

table.tableblock, th.tableblock, td.tableblock { border: 0 solid #dddddd; }

table.grid-all th.tableblock, table.grid-all td.tableblock { border-width: 0 1px 1px 0; }

table.grid-all tfoot > tr > th.tableblock, table.grid-all tfoot > tr > td.tableblock { border-width: 1px 1px 0 0; }

table.grid-cols th.tableblock, table.grid-cols td.tableblock { border-width: 0 1px 0 0; }

table.grid-all * > tr > .tableblock:last-child, table.grid-cols * > tr > .tableblock:last-child { border-right-width: 0; }

table.grid-rows th.tableblock, table.grid-rows td.tableblock { border-width: 0 0 1px 0; }

table.grid-all tbody > tr:last-child > th.tableblock, table.grid-all tbody > tr:last-child > td.tableblock, table.grid-all thead:last-child > tr > th.tableblock, table.grid-rows tbody > tr:last-child > th.tableblock, table.grid-rows tbody > tr:last-child > td.tableblock, table.grid-rows thead:last-child > tr > th.tableblock { border-bottom-width: 0; }

table.grid-rows tfoot > tr > th.tableblock, table.grid-rows tfoot > tr > td.tableblock { border-width: 1px 0 0 0; }

table.frame-all { border-width: 1px; }

table.frame-sides { border-width: 0 1px; }

table.frame-topbot { border-width: 1px 0; }

th.halign-left, td.halign-left { text-align: left; }

th.halign-right, td.halign-right { text-align: right; }

th.halign-center, td.halign-center { text-align: center; }

th.valign-top, td.valign-top { vertical-align: top; }

th.valign-bottom, td.valign-bottom { vertical-align: bottom; }

th.valign-middle, td.valign-middle { vertical-align: middle; }

table thead th, table tfoot th { font-weight: bold; }

tbody tr th { display: table-cell; line-height: 1.4; background: whitesmoke; }

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p { color: #222222; font-weight: bold; }

p.tableblock > code:only-child { background: none; padding: 0; }

p.tableblock { font-size: 1em; }

td > div.verse { white-space: pre; }

ol { margin-left: 2.5em; }

ul li ol { margin-left: 1.5em; }

dl dd { margin-left: 1.125em; }

dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }

ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.625em; }

ul.unstyled, ol.unnumbered, ul.checklist, ul.none { list-style-type: none; }

ul.unstyled, ol.unnumbered, ul.checklist { margin-left: 0.625em; }

ul.checklist li > p:first-child > .fa-check-square-o:first-child, ul.checklist li > p:first-child > input[type="checkbox"]:first-child { margin-right: 0.25em; }

ul.checklist li > p:first-child > input[type="checkbox"]:first-child { position: relative; top: 1px; }

ul.inline { margin: 0 auto 0.625em auto; margin-left: -1.375em; margin-right: 0; padding: 0; list-style: none; overflow: hidden; }
ul.inline > li { list-style: none; float: left; margin-left: 1.375em; display: block; }
ul.inline > li > * { display: block; }

.unstyled dl dt { font-weight: normal; font-style: normal; }

ol.arabic { list-style-type: decimal; }

ol.decimal { list-style-type: decimal-leading-zero; }

ol.loweralpha { list-style-type: lower-alpha; }

ol.upperalpha { list-style-type: upper-alpha; }

ol.lowerroman { list-style-type: lower-roman; }

ol.upperroman { list-style-type: upper-roman; }

ol.lowergreek { list-style-type: lower-greek; }

.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }

td.hdlist1 { padding-right: .75em; font-weight: bold; }

td.hdlist1, td.hdlist2 { vertical-align: top; }

.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }

.colist > table tr > td:first-of-type { padding: 0 0.75em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.25em 0; }

.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: 0 0 0 1px #dddddd; box-shadow: 0 0 0 1px #dddddd; }

.imageblock.left, .imageblock[style*="float: left"] { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }

.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }

a.image { text-decoration: none; }

span.footnote, span.footnoteref { vertical-align: super; font-size: 0.875em; }
span.footnote a, span.footnoteref a { text-decoration: none; }
span.footnote a:active, span.footnoteref a:active { text-decoration: underline; }

#footnotes { padding-top: 0.75em; padding-bottom: 0.75em; margin-bottom: 0.625em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -.25em 0 .75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.375em; line-height: 1.3; font-size: 0.875em; margin-left: 1.2em; text-indent: -1.2em; margin-bottom: .2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }

#content #footnotes { margin-top: -0.625em; margin-bottom: 0; padding: 0.75em 0; }

.gist .file-data > table { border: 0; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }

div.unbreakable { page-break-inside: avoid; }

.big { font-size: larger; }

.small { font-size: smaller; }

.underline { text-decoration: underline; }

.overline { text-decoration: overline; }

.line-through { text-decoration: line-through; }

.aqua { color: #00bfbf; }

.aqua-background { background-color: #00fafa; }

.black { color: black; }

.black-background { background-color: black; }

.blue { color: #0000bf; }

.blue-background { background-color: #0000fa; }

.fuchsia { color: #bf00bf; }

.fuchsia-background { background-color: #fa00fa; }

.gray { color: #606060; }

.gray-background { background-color: #7d7d7d; }

.green { color: #006000; }

.green-background { background-color: #007d00; }

.lime { color: #00bf00; }

.lime-background { background-color: #00fa00; }

.maroon { color: #600000; }

.maroon-background { background-color: #7d0000; }

.navy { color: #000060; }

.navy-background { background-color: #00007d; }

.olive { color: #606000; }

.olive-background { background-color: #7d7d00; }

.purple { color: #600060; }

.purple-background { background-color: #7d007d; }

.red { color: #bf0000; }

.red-background { background-color: #fa0000; }

.silver { color: #909090; }

.silver-background { background-color: #bcbcbc; }

.teal { color: #006060; }

.teal-background { background-color: #007d7d; }

.white { color: #bfbfbf; }

.white-background { background-color: #fafafa; }

.yellow { color: #bfbf00; }

.yellow-background { background-color: #fafa00; }

span.icon > .fa { cursor: default; }

.admonitionblock td.icon [class^="fa icon-"] { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #207c98; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }

.conum[data-value] { display: inline-block; color: #fff !important; background-color: #222222; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; font-size: 0.75em; width: 1.67em; height: 1.67em; line-height: 1.67em; font-family: "Open Sans", "DejaVu Sans", sans-serif; font-style: normal; font-weight: bold; }
.conum[data-value] * { color: #fff !important; }
.conum[data-value] + b { display: none; }
.conum[data-value]:after { content: attr(data-value); }
pre .conum[data-value] { position: relative; top: -0.125em; }

b.conum * { color: inherit !important; }

.conum:not([data-value]):empty { display: none; }

.literalblock pre, .listingblock pre { background: #eeeeee; }

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.min.css">
<style>.listingblock .pygments .hll { background-color: #ffffcc }
.listingblock .pygments  { background: #f8f8f8; }
.listingblock .pygments .tok-c { color: #408080; font-style: italic } /* Comment */
.listingblock .pygments .tok-err { border: 1px solid #FF0000 } /* Error */
.listingblock .pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
.listingblock .pygments .tok-o { color: #666666 } /* Operator */
.listingblock .pygments .tok-cm { color: #408080; font-style: italic } /* Comment.Multiline */
.listingblock .pygments .tok-cp { color: #BC7A00 } /* Comment.Preproc */
.listingblock .pygments .tok-c1 { color: #408080; font-style: italic } /* Comment.Single */
.listingblock .pygments .tok-cs { color: #408080; font-style: italic } /* Comment.Special */
.listingblock .pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
.listingblock .pygments .tok-ge { font-style: italic } /* Generic.Emph */
.listingblock .pygments .tok-gr { color: #FF0000 } /* Generic.Error */
.listingblock .pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
.listingblock .pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
.listingblock .pygments .tok-go { color: #888888 } /* Generic.Output */
.listingblock .pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.listingblock .pygments .tok-gs { font-weight: bold } /* Generic.Strong */
.listingblock .pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.listingblock .pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
.listingblock .pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.listingblock .pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.listingblock .pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.listingblock .pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
.listingblock .pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.listingblock .pygments .tok-kt { color: #B00040 } /* Keyword.Type */
.listingblock .pygments .tok-m { color: #666666 } /* Literal.Number */
.listingblock .pygments .tok-s { color: #BA2121 } /* Literal.String */
.listingblock .pygments .tok-na { color: #7D9029 } /* Name.Attribute */
.listingblock .pygments .tok-nb { color: #008000 } /* Name.Builtin */
.listingblock .pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
.listingblock .pygments .tok-no { color: #880000 } /* Name.Constant */
.listingblock .pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
.listingblock .pygments .tok-ni { color: #999999; font-weight: bold } /* Name.Entity */
.listingblock .pygments .tok-ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.listingblock .pygments .tok-nf { color: #0000FF } /* Name.Function */
.listingblock .pygments .tok-nl { color: #A0A000 } /* Name.Label */
.listingblock .pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.listingblock .pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
.listingblock .pygments .tok-nv { color: #19177C } /* Name.Variable */
.listingblock .pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.listingblock .pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
.listingblock .pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
.listingblock .pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
.listingblock .pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
.listingblock .pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
.listingblock .pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
.listingblock .pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
.listingblock .pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
.listingblock .pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.listingblock .pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
.listingblock .pygments .tok-se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.listingblock .pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
.listingblock .pygments .tok-si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.listingblock .pygments .tok-sx { color: #008000 } /* Literal.String.Other */
.listingblock .pygments .tok-sr { color: #BB6688 } /* Literal.String.Regex */
.listingblock .pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
.listingblock .pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
.listingblock .pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
.listingblock .pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
.listingblock .pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
.listingblock .pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
.listingblock .pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Grails</h1>
<div class="details">
<span id="author" class="author">Fran García</span><br>
<span id="email" class="email">&lt;<a href="mailto:fgarciarico@gmail.com">fgarciarico@gmail.com</a>&gt;</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Índice de contenidos</div>
<ul class="sectlevel1">
<li><a href="#sesion01">1. Introducción a Groovy</a>
<ul class="sectlevel2">
<li><a href="#__qu%C3%A9_es_groovy">1.1. ¿Qué es Groovy?</a></li>
<li><a href="#_instalaci%C3%B3n">1.2. Instalación</a></li>
<li><a href="#_hola_mundo">1.3. Hola Mundo</a></li>
<li><a href="#_caracter%C3%ADsticas">1.4. Características</a></li>
<li><a href="#_tipos_de_datos_en_groovy">1.5. Tipos de datos en Groovy</a></li>
<li><a href="#_colecciones">1.6. Colecciones</a></li>
<li><a href="#_ejercicios">1.7. Ejercicios</a></li>
</ul>
</li>
<li><a href="#sesion02">2. Aspectos avanzados del Lenguaje Groovy. Metaprogramación.</a>
<ul class="sectlevel2">
<li><a href="#_closures">2.1. Closures</a></li>
<li><a href="#_groovy_como_lenguaje_orientado_a_objetos">2.2. Groovy como lenguaje orientado a objetos</a></li>
<li><a href="#_metaprogramaci%C3%B3n">2.3. Metaprogramación</a></li>
<li><a href="#_groovy_builders">2.4. Groovy Builders</a></li>
<li><a href="#_ejercicios_2">2.5. Ejercicios</a></li>
</ul>
</li>
<li><a href="#sesion03">3. Introducción a Grails. Scaffolding.</a>
<ul class="sectlevel2">
<li><a href="#__qu%C3%A9_es">3.1. ¿Qué es?</a></li>
<li><a href="#_caracter%C3%ADsticas_de_grails">3.2. Características de Grails</a></li>
<li><a href="#_arquitectura">3.3. Arquitectura</a></li>
<li><a href="#_instalaci%C3%B3n_de_grails">3.4. Instalación de Grails</a></li>
<li><a href="#_scaffolding_2">3.5. Scaffolding</a></li>
<li><a href="#_ejercicios_3">3.6. Ejercicios</a></li>
</ul>
</li>
<li><a href="#sesion04">4. Patrón MVC: Vistas y controladores.</a>
<ul class="sectlevel2">
<li><a href="#_estructura_de_las_vistas_en_grails">4.1. Estructura de las vistas en Grails</a></li>
<li><a href="#_plantillas">4.2. Plantillas</a></li>
<li><a href="#_p%C3%A1ginas">4.3. Páginas</a></li>
<li><a href="#_etiquetas">4.4. Etiquetas</a></li>
<li><a href="#_librer%C3%ADa_de_etiquetas">4.5. Librería de etiquetas</a></li>
<li><a href="#_controladores">4.6. Controladores</a></li>
<li><a href="#_filtros">4.7. Filtros</a></li>
<li><a href="#_ejercicios_4">4.8. Ejercicios</a></li>
</ul>
</li>
<li><a href="#sesion05">5. Patrón MVC: Dominios y servicios.</a>
<ul class="sectlevel2">
<li><a href="#_dominios">5.1. Dominios</a></li>
<li><a href="#_restricciones">5.2. Restricciones</a></li>
<li><a href="#_aspectos_avanzados_de_gorm">5.3. Aspectos avanzados de GORM</a></li>
<li><a href="#_interactuar_con_la_base_de_datos">5.4. Interactuar con la base de datos</a></li>
<li><a href="#_servicios">5.5. Servicios</a></li>
<li><a href="#_ejercicios_5">5.6. Ejercicios</a></li>
</ul>
</li>
<li><a href="#sesion06">6. Framework de test Spock.</a>
<ul class="sectlevel2">
<li><a href="#_introducci%C3%B3n_a_los_tests">6.1. Introducción a los tests</a></li>
<li><a href="#_framework_de_tests_spock">6.2. Framework de tests Spock</a></li>
<li><a href="#_spock_en_grails">6.3. Spock en Grails</a></li>
<li><a href="#_ejercicios_6">6.4. Ejercicios</a></li>
</ul>
</li>
<li><a href="#sesion07">7. Seguridad con Spring Security plugin.</a>
<ul class="sectlevel2">
<li><a href="#_instalaci%C3%B3n_del_plugin">7.1. Instalación del plugin</a></li>
<li><a href="#_configuraci%C3%B3n_del_plugin">7.2. Configuración del plugin</a></li>
<li><a href="#_clases_de_dominio">7.3. Clases de dominio</a></li>
<li><a href="#_asegurar_peticiones">7.4. Asegurar peticiones</a></li>
<li><a href="#_controladores_2">7.5. Controladores</a></li>
<li><a href="#_librer%C3%ADas_adicionales">7.6. Librerías adicionales</a></li>
<li><a href="#_otros_aspectos_interesantes_de_spring_security">7.7. Otros aspectos interesantes de Spring Security</a></li>
<li><a href="#_ejercicios_7">7.8. Ejercicios</a></li>
</ul>
</li>
<li><a href="#sesion08">8. Configuración de aplicaciones. Plugins interesantes</a>
<ul class="sectlevel2">
<li><a href="#_configuraci%C3%B3n_de_aplicaciones">8.1. Configuración de aplicaciones</a></li>
<li><a href="#_empaquetamiento_de_aplicaciones">8.2. Empaquetamiento de aplicaciones</a></li>
<li><a href="#_otros_comandos_interesantes_de_grails">8.3. Otros comandos interesantes de Grails</a></li>
<li><a href="#_plugins_2">8.4. Plugins</a></li>
<li><a href="#_ejercicios_8">8.5. Ejercicios</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="sesion01">1. Introducción a Groovy</h2>
<div class="sectionbody">
<div class="paragraph">
<p>En esta primera sesión del módulo, empezaremos explicando qué es el lenguaje de programación Groovy y, cómo, dónde y porqué se creo para ponernos un poco en situación. Posteriormente, pasaremos a implementar nuestro primer ejemplo en Groovy, el típico Hola Mundo y lo compararemos con lo que sería el mismo ejemplo en Java.</p>
</div>
<div class="paragraph">
<p>Seguidamente describiremos detalladamente algunos aspectos básicos de Groovy, tales como la sintaxis, los tipos de datos y el trabajo con colecciones.</p>
</div>
<div class="sect2">
<h3 id="__qué_es_groovy">1.1. ¿Qué es Groovy?</h3>
<div class="paragraph">
<p>Groovy nació con la intención de ser un lenguaje rico en características típicas de lenguajes dinámicos, así como para interactuar sin problemas en el entorno Java, para de esta forma, utilizar los beneficios de estos lenguajes dinámicos en una plataforma tan robusta como es Java y todo su entorno. Posiblemente, habrá lenguajes que tengan más características típicas de los lenguajes dinámicos que Groovy o que se integren mejor en la Plataforma Java, pero ninguno de estos, presenta una combinación de estos detalles (lenguaje dinámico y entorno Java) tan eficiente como Groovy. Pero, <em>¿cómo podríamos definir exactamente Groovy?</em></p>
</div>
<div class="paragraph">
<p>Una buena definición de Groovy podría ser la que se nos proporciona desde la propia página web de Groovy (<a href="http://groovy.codehaus.org" class="bare">http://groovy.codehaus.org</a>):</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Definición</strong></p>
</div>
<div class="paragraph">
<p>Groovy es un lenguaje de programación ágil y dinámico diseñado para la Plataforma Java con determinadas características inspiradas en lenguajes como Python, Ruby o Smalltalk, poniéndolas a disposición de los programadores Java mediante una sintaxis típica de Java. Groovy se integra sin ningún problema con cualquier librería Java y se compila directamente a código byte, con lo que Java y Groovy pueden convivir sin ningún tipo de problemas.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En ocasiones se tacha a Groovy de ser un lenguaje meramente de script, pero esto es un error, a pesar de que Groovy funciona realmente bien como lenguaje script. Groovy puede ser precompilado a Java bytecode, estar integrado en aplicaciones Java, construir robustas aplicaciones web e incluso ser la base de una aplicación completa por si solo.</p>
</div>
<div class="paragraph">
<p>Se puede afirmar rotundamente que Groovy está destinado a ser utilizado en la Plataforma Java, no en vano muchas partes de Groovy están desarrolladas en Java, así que cuando decimos que <em>al programar en Groovy, estamos realmente programando en Java</em>, no estamos diciendo ninguna barbaridad. Todas las características de Java están esperando a ser utilizadas en Groovy, incluido todo el conjunto de librerías de Java.</p>
</div>
<div class="sect3">
<h4 id="_integración_con_java">1.1.1. Integración con Java</h4>
<div class="paragraph">
<p>Cuando hablamos de <em>integración con Java</em>, nos referimos a dos aspectos. Por un lado, de integración imperceptible, puesto que Groovy es simplemente una nueva forma de crear nuestras habituales clases Java. Al fin y al cabo, Groovy es Java con un archivo jar como dependencia. Por otro lado, la sintaxis de Groovy es más precisa y compacta que en Java y a pesar de eso, cualquier programador Java puede entender el funcionamiento de un fragmento de código escrito en Groovy.</p>
</div>
</div>
<div class="sect3">
<h4 id="__a_quién_va_dirigido_groovy">1.1.2. ¿A quién va dirigido Groovy?</h4>
<div class="sect4">
<h5 id="_a_los_programadores_java">A los programadores Java</h5>
<div class="paragraph">
<p>Un programador Java con muchos años de experiencia conocerá todas las partes importantes del entorno Java y su API, así como otros paquetes adicionales. Sin embargo, algo aparentemente tan sencillo como listar todos los archivos recursivamente que cuelgan de un directorio se hace demasiado pesado en Java y suponiendo que existiera la función <em>eachFileRecurse()</em> tendríamos algo similar a:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">ListFiles</span> <span class="tok-o">{</span>
	<span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-kt">void</span> <span class="tok-nf">main</span><span class="tok-o">(</span><span class="tok-n">String</span><span class="tok-o">[]</span> <span class="tok-n">args</span><span class="tok-o">){</span>
		<span class="tok-k">new</span> <span class="tok-n">java</span><span class="tok-o">.</span><span class="tok-na">io</span><span class="tok-o">.</span><span class="tok-na">File</span><span class="tok-o">(</span><span class="tok-s">&quot;.&quot;</span><span class="tok-o">).</span><span class="tok-na">eachFileRecurse</span><span class="tok-o">(</span>
			<span class="tok-k">new</span> <span class="tok-nf">FileListener</span><span class="tok-o">()</span> <span class="tok-o">{</span>
				<span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">onFile</span> <span class="tok-o">(</span><span class="tok-n">File</span> <span class="tok-n">file</span><span class="tok-o">)</span> <span class="tok-o">{</span>
					<span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">file</span><span class="tok-o">.</span><span class="tok-na">toString</span><span class="tok-o">());</span>
				<span class="tok-o">}</span>
			<span class="tok-o">}</span>
		<span class="tok-o">);</span>
	<span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Mientras que con Groovy podría quedar en una sola línea que podríamos ejecutar incluso en línea de comandos de la siguiente forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">groovy</span> <span class="tok-o">-</span><span class="tok-n">e</span> <span class="tok-s2">&quot;new File(&#39;.&#39;).eachFileRecurse { println it}&quot;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_a_los_programadores_de_scripts">A los programadores de scripts</h5>
<div class="paragraph">
<p>Groovy también va dirigido a aquellos programadores que han pasado muchos años trabajando con lenguajes de programación como Perl, Ruby, Python o PHP. En ocasiones, sobre todo en las grandes empresas, los clientes requieren obligatoriamente el uso de una Plataforma robusta como puede ser Java. Estos programadores deben reciclarse, ya que no es factible cualquier solución que pase por utilizar un lenguaje script como los mencionados anteriormente.</p>
</div>
<div class="paragraph">
<p>Continuamente este tipo de programadores afirman que se sienten frustrados por toda la verborrea que conlleva un lenguaje como Java y la frase <em>"con un lenguaje como Ruby, podría escribir todo este método en una sola línea"</em> es su pan de cada día. Groovy puede darles lo que ellos piden y supone una vía de escape hacía adelante a este tipo de programadores.</p>
</div>
</div>
<div class="sect4">
<h5 id="_a_los_programadores_ágiles_y_extremos">A los programadores ágiles y extremos</h5>
<div class="paragraph">
<p>Este tipo de programadores están acostumbrados a trabajar con la próxima revisión tan cercana, que pararse a pensar en utilizar un nuevo lenguaje de programación queda fuera de sus principales objetivos. Sin embargo, una de los aspectos más importantes para los programadores ágiles, consiste en tener siempre a su disposición los mejores recursos y metodologías para llevar a cabo su trabajo.</p>
</div>
<div class="paragraph">
<p>Y ahí es donde Groovy les puede aportar mucho, ya que Groovy es un lenguaje perfecto para realizar esas tareas de automatización tan habituales en sus proyectos. Estas tareas van desde la integración continua o la puesta en práctica de teorías como TDD (Test Driven Development).</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_instalación">1.2. Instalación</h3>
<div class="paragraph">
<p>Antes de avanzar en la sesión, vamos a ver como se realizaría la instalación de Groovy en nuestro ordenador. Aunque podríamos descargarnos la última versión de Groovy desde la web oficial <a href="http://groovy.codehaus.org/Download" class="bare">http://groovy.codehaus.org/Download</a>, nosotros vamos a utilizar un gestor de paquetes conocido como <em>sdkman (<a href="http://sdkman.io" class="bare">http://sdkman.io</a>)</em> (antes conocido como <em>gvmtool</em> que nos permitirá gestionar varias versiones de Groovy en una misma máquina de forma muy sencilla. Además, esta misma herramienta nos servirá para instalar y gestionar Grails, entre otras interesantes librerías como Gradle o Vert.x.</p>
</div>
<div class="paragraph">
<p>Para instalar <em>sdkman</em> y <em>groovy</em> simplemente debemos en línea de comandos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">curl -s get.sdkman.io <span class="tok-p">|</span> bash

<span class="tok-nb">source</span> <span class="tok-s2">&quot;$HOME/.sdkman/bin/sdkman-init.sh&quot;</span>

sdk list groovy

sdk install groovy 2.4.5</code></pre>
</div>
</div>
<div class="paragraph">
<p>Si necesitaramos alternar entre varias versiones de Groovy, simplemente deberías ejecutar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">sdk use groovy 1.8.0</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_hola_mundo">1.3. Hola Mundo</h3>
<div class="paragraph">
<p>Ahora que ya tenemos una primera idea de lo que es Groovy, vamos a pasar a desarrollar nuestro primer ejemplo y a realizar nuestras primeras pruebas de ejecución y compilación de archivos Groovy. Pero antes de eso, vamos a introducir las diferentes formas de ejecutar nuestros programas en Groovy.</p>
</div>
<div class="paragraph">
<p>Tras la instalación de Groovy con la herramienta <em>sdk</em>, vamos a disponer de tres comandos que son <em>groovysh</em>, <em>groovyConsole</em> y <em>groovy</em>, entre otros. Podemos utilizar cualquiera de estos tres archivos para empezar a realizar nuestras pruebas con código Groovy. Vamos a verlos uno a uno:</p>
</div>
<div class="sect3">
<h4 id="_groovysh">1.3.1. groovysh</h4>
<div class="paragraph">
<p>Permite ejecutar en línea de comandos código Groovy de forma interactiva. Más información en <a href="http://groovy.codehaus.org/Groovy+Shell" class="bare">http://groovy.codehaus.org/Groovy+Shell</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">groovy:000&gt; <span class="tok-s2">&quot;Hola Mundo!&quot;</span>

<span class="tok-o">====</span> &gt; Hola Mundo!</code></pre>
</div>
</div>
<div class="paragraph">
<p>Otro ejemplo podría ser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">groovy:000&gt; <span class="tok-nv">saludo</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;Hola&quot;</span>
<span class="tok-o">===</span>&gt; Hola
groovy:000&gt; <span class="tok-s2">&quot;${saludo} Mundo!&quot;</span>

<span class="tok-o">===</span>&gt; Hola Mundo!</code></pre>
</div>
</div>
<div class="paragraph">
<p>E incluso podemos definir funciones con parámetros:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">groovy:000&gt; def hola<span class="tok-o">(</span>nombre<span class="tok-o">){</span>
groovy:001&gt; println <span class="tok-s2">&quot;Hola $nombre&quot;</span>
groovy:002&gt; <span class="tok-o">}</span>
<span class="tok-o">===</span>&gt; <span class="tok-nb">true</span>
groovy:000&gt; hola<span class="tok-o">(</span><span class="tok-s2">&quot;Fran&quot;</span><span class="tok-o">)</span>
Hola <span class="tok-nv">Fran</span>
<span class="tok-o">====</span> &gt; null</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_groovyconsole">1.3.2. groovyConsole</h4>
<div class="paragraph">
<p>Mediante una interfaz Swing, groovyConsole actua como intérprete de comandos Groovy. Tiene la posibilidad de cargar y salvar ficheros desde su menú File. Más información en <a href="http://groovy.codehaus.org/Groovy+Console" class="bare">http://groovy.codehaus.org/Groovy+Console</a></p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/grails01/groovyConsole.jpg" alt="Groovy Console" width="50%">
</div>
</div>
<div class="paragraph">
<p>Como podemos observar, en la parte superior podemos escribir nuestro código Groovy, mientras que la parte inferior nos muestra la salida del programa ejecutado.</p>
</div>
<div class="paragraph">
<p>Además la groovyConsole nos permite también indicarle archivos jar externos que serán importados automáticamente en el código de nuestros scripts.</p>
</div>
</div>
<div class="sect3">
<h4 id="_groovy">1.3.3. groovy</h4>
<div class="paragraph">
<p>El último método sirve para ejecutar archivos groovy y simplemente ejecutando en la línea de comandos <em>groovy holamundo.groovy</em>, podemos ver la salida producida por el programa. En la siguiente imagen, puedes comprobar el funcionamiento de este método con un fichero de ejemplo que realiza el cálculo de la sucesión de Fibonacci.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/grails01/groovy.jpg" alt="Groovy command" width="50%">
</div>
</div>
<div class="paragraph">
<p>Quizás ya te hayas dado cuenta, pero a diferencia de en Java, Groovy puede ejecutar sus archivos sin necesidad de compilarlos previamente. Esta forma de utilizar Groovy se llama <strong>Modo directo</strong> y nuestro código es ejecutado sin necesidad de generar archivos ejecutables. Se puede decir que nuestros archivos son interpretados. Sin embargo, existe otra forma de ejecutar nuestros programas Groovy y se llama <strong>Modo precompilado</strong>. En el modo precompilado, en primer lugar se compila el programa groovy y posteriormente se ejecuta. El programa compilado es compatible con los archivos bytecode de Java.</p>
</div>
<div class="paragraph">
<p>Para compilar nuestros programas Groovy, utilizamos una sentencia en línea de comandos llamada <strong>groovyc</strong> (también disponible tras la instalación de Groovy). Si quisieramos compilar el anterior ejemplo (<em>fibonacci.groovy</em>), ejecutaríamos <em>groovyc -d classes fibonacci.groovy</em>. Con el parámetro -d le hemos indicado que nos genere los archivos compilados en el directorio <em>classes</em>, y en el caso de que no existiera, lo crearía. Si observamos el contenido de este directorio, veremos que hay un par de ficheros .class. El número de archivos dependerá del propio script, de la misma forma que sucede cuando compilamos archivo en Java.</p>
</div>
<div class="paragraph">
<p>Una vez ya tenemos nuestro programa compilado, vamos a ver como podríamos ejecutarlo con Java. !Sí, con Java!, ya que para ejecutar un programa en Groovy debemos hacer exactamente lo mismo que hacemos en Java. Simplemente, debemos añadir al classpath el archivo jar de Groovy. Debemos hacer lo mismo con el directorio donde residen nuestros archivos compilados. Quedaría algo así:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">java -cp <span class="tok-nv">$GROOVY_HOME</span>/embeddable/groovy-all-2.4.0.jar:classes fibonacci</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_características">1.4. Características</h3>
<div class="paragraph">
<p>En la siguiente sección, vamos a introducir diferentes aspectos básicos del lenguaje Groovy, tales como la introducción de comentarios, diferencias y similitudes con Java, la brevedad del código en Groovy y otros pequeños detalles del lenguaje.</p>
</div>
<div class="sect3">
<h4 id="_comentarios">1.4.1. Comentarios</h4>
<div class="paragraph">
<p>Los comentarios en Groovy siguen el mismo formato que en Java. Esto es:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>//, comentarios de una línea</p>
</li>
<li>
<p>/* &#8230;&#8203;. */, comentarios multilínea</p>
</li>
<li>
<p>/** &#8230;&#8203;. */, comentarios del estilo Javadoc, que nos permitirá documentar nuestros programas con <em>Groovydoc</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Sin embargo, también podemos introducir en la primera línea comentarios del estilo shebang con la combinación de caracteres <strong>#!</strong></p>
</div>
</div>
<div class="sect3">
<h4 id="_comparando_la_sintaxis_de_java_y_groovy">1.4.2. Comparando la sintaxis de Java y Groovy</h4>
<div class="paragraph">
<p>Es habitual leer que la sintaxis de Groovy es una superclase de Java y esto es debido a las grandes similitudes que hay entre ambos lenguajes. Sin embargo, no es correcto afirmar que un lenguaje es una superclase del otro. Existen pequeños detalles de programación en Java que no existen en Groovy, como puede ser que el operador <em>==</em> que en Groovy tiene unas connotaciones diferentes.</p>
</div>
<div class="paragraph">
<p>Pero aparte de algunas pequeñas diferencias, podemos decir que gran parte de la sintaxis de Java es válida en Groovy. Estas similitudes son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Mecanismo de paquetes</p>
</li>
<li>
<p>Sentencias</p>
</li>
<li>
<p>Definición de clases y métodos</p>
</li>
<li>
<p>Estructuras de control</p>
</li>
<li>
<p>Operadores, asignaciones y expresiones</p>
</li>
<li>
<p>Manejo de excepciones</p>
</li>
<li>
<p>Declaración de literales</p>
</li>
<li>
<p>Instanciación de objetos y llamadas a métodos</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>No obstante, Groovy posee un valor añadido gracias a:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Fácil acceso a los objetos Java a través de nuevas expresiones y operadores</p>
</li>
<li>
<p>Nuevas formas de declarar objetos</p>
</li>
<li>
<p>Nuevas estructuras de control</p>
</li>
<li>
<p>Nuevos tipos de datos con sus correspondientes operadores y expresiones</p>
</li>
<li>
<p>Todo se gestiona como un objeto</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Estas nuevas características hacen que Groovy sea un lenguaje fácil de leer y de entender.</p>
</div>
</div>
<div class="sect3">
<h4 id="_brevedad_del_lenguaje">1.4.3. Brevedad del lenguaje</h4>
<div class="paragraph">
<p>Groovy pretende evitar en todo momento toda la ceremonia que acompaña a Java en sus programas y nos permite obviar determinados aspectos obligatorios y centrarnos en nuestro objetivo. Para empezar, se elimina la obligatoriedad de utilizar los puntos y comas (;) al finalizar cada línea. Si lo pensamos un poco es lógico, porque ¿cuántos de nosotros escribimos más de una sentencia en la misma línea del código fuente?. Esto no quiere decir que en Groovy no podamos escribir puntos y coma al final de cada línea, simplemente no es obligatorio.</p>
</div>
<div class="paragraph">
<p>Además, también se elimina la obligatoriedad de utilizar paréntesis al pasar parámetros en la llamada a funciones.</p>
</div>
<div class="paragraph">
<p>Otro ejemplo de la brevedad del lenguaje que aporta Groovy es el siguiente ejemplo. Mientras que en Java tendríamos lo siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">java</span><span class="tok-o">.</span><span class="tok-na">net</span><span class="tok-o">.</span><span class="tok-na">URLEncoder</span><span class="tok-o">.</span><span class="tok-na">encode</span> <span class="tok-o">(</span><span class="tok-s">&quot;a b&quot;</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>en Groovy tendríamos</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">URLEncoder</span><span class="tok-o">.</span><span class="tok-na">encode</span> <span class="tok-s1">&#39;a b&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Esto no sólo significa que el código en Groovy va a ser más corto, sino también más expresivo evitando toda la parafernalia que acompaña a Java en determinadas ocasiones.</p>
</div>
<div class="paragraph">
<p>Groovy además importa automáticamente los paquetes <em>groovy.lang.*</em>, <em>groovy.util.*</em>, <em>java.lang.*</em>, <em>java.util.*</em>, <em>java.net.*</em> y <em>java.io.*</em>, así como las clases <em>java.Math.BigInteger</em> y <em>java.Math.BigDecimal</em>, así que siempre vas a poder utilizar todas sus clases sin necesidad de que sean importados sus paquetes al inicio del programa. Esto también es diferente a Java, donde sólo se importa automáticamente el paquete <em>java.lang.*</em>.</p>
</div>
<div class="paragraph">
<p>Resumiendo. Groovy nos permite olvidarnos de los paréntesis, la declaración de paquetes, puntos y comas y centrarnos en la funcionalidad de nuestros programas y métodos.</p>
</div>
</div>
<div class="sect3">
<h4 id="_aserciones">1.4.4. Aserciones</h4>
<div class="paragraph">
<p>Las aserciones permiten desde Java 1.4 comprobar si nuestro programa funciona como debería funcionar y Groovy no iba a ser menos, así que también las incluye. Las aserciones se insertan en medio de nuestro código y se utilizan, por ejemplo, para comprobar posibles incongruencias en las variables pasadas a un método. Fundamentalmente las aserciones se utilizarán en los tests que desarrollemos para nuestra aplicación y que asegurarán que las cosas funcionan correctamente. Algunos ejemplos de aserciones serían:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-k">assert</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">)</span>
<span class="tok-k">assert</span> <span class="tok-mi">1</span> <span class="tok-o">==</span> <span class="tok-mi">1</span>
<span class="tok-kt">def</span> <span class="tok-n">x</span> <span class="tok-o">=</span> <span class="tok-mi">1</span>
<span class="tok-k">assert</span> <span class="tok-n">x</span> <span class="tok-o">==</span> <span class="tok-mi">1</span>
<span class="tok-kt">def</span> <span class="tok-n">y</span> <span class="tok-o">=</span> <span class="tok-mi">1</span><span class="tok-o">;</span> <span class="tok-k">assert</span> <span class="tok-n">y</span> <span class="tok-o">==</span> <span class="tok-mi">1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Como se puede comprobar en los ejemplos las aserciones pueden tomar expresiones completas y no únicamente variables, como en el ejemplo <em>assert 1 == 1</em>. Además las aserciones no sólo nos servirán para comprobar el estado de nuestro programa, sino que también podremos reemplazar determinados comentarios por aserciones, que además de clarificar el código fuente de nuestro programa, nos sirve también para pasar pequeñas pruebas a nuestro código.</p>
</div>
<div class="paragraph">
<p>Cuando usamos aserciones, es una buena práctica incluir un mensaje que nos clarifique el error que se ha producido. Esto lo podemos hacer añadiendo después de la aserción el mensaje de texto que queremos precedido de <em>:</em>, como en el siguiente ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-k">assert</span> <span class="tok-mi">1</span><span class="tok-o">==</span><span class="tok-mi">2</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Desde cuando 1 es igual a 2&quot;</span>
<span class="tok-c1">//Obteniendo el siguiente mensaje</span>
<span class="tok-c1">//Exception thrown: Desde cuando 1 es igual a 2. Expression: (1 == 2)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Además, en las últimas versiones de Groovy se ha mejorado el sistema de mensajes mostrados cuando fallan las aserciones fallan. Si por ejemplo, ejecutamos el siguiente fragmento de código:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-k">assert</span> <span class="tok-k">new</span> <span class="tok-nf">File</span><span class="tok-o">(</span><span class="tok-s1">&#39;foo.bar&#39;</span><span class="tok-o">)</span> <span class="tok-o">==</span> <span class="tok-k">new</span> <span class="tok-n">File</span><span class="tok-o">(</span><span class="tok-s1">&#39;example.txt&#39;</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Groovy nos mostraría el siguiente mensaje de error</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">Exception</span> <span class="tok-n">thrown</span>

<span class="tok-n">Assertion</span> <span class="tok-nl">failed:</span>

<span class="tok-k">assert</span> <span class="tok-k">new</span> <span class="tok-nf">File</span><span class="tok-o">(</span><span class="tok-s1">&#39;foo.bar&#39;</span><span class="tok-o">)</span> <span class="tok-o">==</span> <span class="tok-k">new</span> <span class="tok-n">File</span><span class="tok-o">(</span><span class="tok-s1">&#39;example.txt&#39;</span><span class="tok-o">)</span>
       <span class="tok-o">|</span>                   <span class="tok-o">|</span>  <span class="tok-o">|</span>
       <span class="tok-n">foo</span><span class="tok-o">.</span><span class="tok-na">bar</span>             <span class="tok-o">|</span>  <span class="tok-n">example</span><span class="tok-o">.</span><span class="tok-na">txt</span>
                           <span class="tok-kc">false</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_un_primer_vistazo_al_código_en_groovy">1.4.5. Un primer vistazo al código en Groovy</h4>
<div class="paragraph">
<p>Antes de comenzar a ver las principales características de Groovy, podéis encontrar toda la documentación de sus clases y librerías en la dirección <a href="http://groovy.codehaus.org/gapi" class="bare">http://groovy.codehaus.org/gapi</a>.</p>
</div>
<div class="sect4">
<h5 id="_declaración_de_clases">Declaración de clases</h5>
<div class="paragraph">
<p>Las clases son la clave de cualquier lenguaje orientado a objetos y Groovy no iba a ser menos. El siguiente fragmento consiste en la declaración de la clase <em>Libro</em>, con una sola propiedad <em>Titulo</em>, el constructor de la clase y un método <em>getter</em> para obtener el título del libro.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">Libro</span> <span class="tok-o">{</span>
	<span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">titulo</span>

	<span class="tok-nf">Libro</span> <span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">elTitulo</span><span class="tok-o">){</span>
		<span class="tok-n">titulo</span> <span class="tok-o">=</span> <span class="tok-n">elTitulo</span>
	<span class="tok-o">}</span>
	<span class="tok-n">String</span> <span class="tok-nf">getTitulo</span><span class="tok-o">(){</span>
		<span class="tok-k">return</span> <span class="tok-n">titulo</span>
	<span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Se puede comprobar como el código es bastante similar a Java. Sin embargo, no hay la necesidad de emplear modificadores de acceso a los métodos, ya que por defecto siempre serán públicos.</p>
</div>
</div>
<div class="sect4">
<h5 id="_scripts_en_groovy">Scripts en Groovy</h5>
<div class="paragraph">
<p>Los scripts en Groovy son archivos de texto plano con extensión <em>.groovy</em> y que pueden ser ejecutados, tal y como comentábamos en una sección anterior mediante el comando <em>groovy miarchivo.groovy</em>. A diferencia de en Java, en Groovy no necesitamos compilar nuestros scripts, ya que son precompilados por nosotros al mismo tiempo que lo ejecutamos, así que a simple vista, es como si pudiéramos ejecutar un archivo groovy.</p>
</div>
<div class="paragraph">
<p>En Groovy podemos tener sentencias fuera de la definición de las clases e incluso podemos añadir métodos a nuestros scripts que también queden fuera de las definiciones de nuestras clases, si con ello conseguimos clarificar nuestro código, con lo que el método <em>main()</em> típico de Java, no es necesario en Groovy y sólo lo necesitaremos en el caso de que nuestro script necesite parámetros pasados en línea de comandos. Veamos un ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">Libro</span> <span class="tok-n">cgg</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Libro</span><span class="tok-o">(</span><span class="tok-s1">&#39;Curso GroovyGrails&#39;</span><span class="tok-o">)</span>

<span class="tok-k">assert</span> <span class="tok-n">cgg</span><span class="tok-o">.</span><span class="tok-na">getTitulo</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;Curso GroovyGrails&#39;</span>
<span class="tok-k">assert</span> <span class="tok-nf">getTituloAlReves</span><span class="tok-o">(</span><span class="tok-n">cgg</span><span class="tok-o">)</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;sliarGyvoorG osruC&#39;</span>

<span class="tok-n">String</span> <span class="tok-nf">getTituloAlReves</span><span class="tok-o">(</span><span class="tok-n">libro</span><span class="tok-o">)</span> <span class="tok-o">{</span>
	<span class="tok-n">titulo</span> <span class="tok-o">=</span> <span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">getTitulo</span><span class="tok-o">()</span>
	<span class="tok-k">return</span> <span class="tok-n">titulo</span><span class="tok-o">.</span><span class="tok-na">reverse</span><span class="tok-o">()</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos comprobar que llamamos al método <em>getTituloAlReves()</em> incluso antes de que éste sea declarado. Otro aspecto importante es que no necesitamos compilar nuestra clase <em>Libro</em>, ya que Groovy lo hace por nosotros. El único requisito es que la clase Libro se encuentre en el <em>CLASSPATH</em>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_groovybeans">GroovyBeans</h5>
<div class="paragraph">
<p>Fundamentalmente los JavaBeans son clases que definen propiedades. Por ejemplo, en nuestro ejemplo de la clase Libro, sus propiedades serían el título, el autor, la editorial, etc. Estos JavaBeans tienen métodos para obtener los valores de estas propiedades (getters) y modificarlas (setters). Estos métodos deben ser definidos en cada JavaBean, con lo que esta tarea se vuelve algo repetitiva.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">class</span> <span class="tok-nc">Libro</span><span class="tok-o">{</span>
	<span class="tok-n">String</span> <span class="tok-n">titulo</span><span class="tok-o">;</span>

	<span class="tok-n">String</span> <span class="tok-nf">getTitulo</span><span class="tok-o">(){</span>
		<span class="tok-k">return</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">titulo</span>
	<span class="tok-o">}</span>

	<span class="tok-kt">void</span> <span class="tok-nf">setTitulo</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">str</span><span class="tok-o">){</span>
		<span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">titulo</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">String</span><span class="tok-o">(</span><span class="tok-n">str</span><span class="tok-o">)</span>
	<span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Sin embargo, Groovy gestiona esta definición de los métodos <em>get()</em> y <em>set()</em> por nosotros, con lo que ya no debemos preocuparnos. Con esto, el código anterior, en Groovy quedaría así:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">Libro</span><span class="tok-o">{</span>
	<span class="tok-n">String</span> <span class="tok-n">titulo</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Además, tenemos la gran ventaja de que podemos sobreescribir estos métodos en el caso de que queramos modificar su comportamiento básico.</p>
</div>
<div class="paragraph">
<p>En realidad, lo que hace Groovy es tratar de entender el comportamiento de las propiedades de un bean a partir de como están definidas. Con esto tenemos los siguientes casos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Si una propiedad de una clase es declarada sin ningún modificador, se genera un campo privado con sus correspondientes métodos públicos <em>getter()</em> y <em>setter()</em></p>
</li>
<li>
<p>Si una propiedad de una clase es declarada como final, dicha propiedad será privada y se definirá también su <em>getter()</em>, pero no su <em>setter()</em></p>
</li>
<li>
<p>Si necesitamos una propiedad de tipo privado o protegida debemos declarar sus métodos <em>getter()</em> y <em>setter()</em> de forma privada o protegida</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_todo_son_objetos">Todo son objetos</h5>
<div class="paragraph">
<p>En Groovy, a diferencia que en Java, los números son tratados como objetos y no como tipos primitivos. En Java no podemos utilizar métodos de la clase Integer si el entero es de tipo primitivo y tampoco podemos hacer <em>y*2</em> si la variable <em>y</em> es un objeto. Esto también es diferente en Groovy, ya que podemos utilizar operadores y métodos indiferentemente.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">x</span> <span class="tok-o">=</span> <span class="tok-mi">1</span>
<span class="tok-kt">def</span> <span class="tok-n">y</span> <span class="tok-o">=</span> <span class="tok-mi">2</span>
<span class="tok-k">assert</span> <span class="tok-n">x</span> <span class="tok-o">+</span> <span class="tok-n">y</span> <span class="tok-o">==</span> <span class="tok-mi">3</span>
<span class="tok-k">assert</span> <span class="tok-n">x</span><span class="tok-o">.</span><span class="tok-na">plus</span><span class="tok-o">(</span><span class="tok-n">y</span><span class="tok-o">)</span> <span class="tok-o">==</span> <span class="tok-mi">3</span>
<span class="tok-k">assert</span> <span class="tok-n">x</span> <span class="tok-k">instanceof</span> <span class="tok-n">Integer</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En el ejemplo anterior se puede observar que hemos podido utilizar el operador + de los tipos primitivos y el método plus() de la clase Integer.</p>
</div>
<div class="paragraph">
<p>En realidad, en Groovy, todo es un objeto, con lo que aunque declaremos variables como tipos de datos primitivos en realidad Groovy los convierte a tipo de dato referencia, tal y como puedes ver en los siguientes ejemplos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">double</span> <span class="tok-n">d</span> <span class="tok-o">=</span> <span class="tok-mf">10.23</span>
<span class="tok-k">assert</span> <span class="tok-n">d</span> <span class="tok-k">instanceof</span> <span class="tok-n">Double</span>
<span class="tok-kt">char</span> <span class="tok-n">a</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;a&#39;</span>
<span class="tok-k">assert</span> <span class="tok-n">a</span> <span class="tok-k">instanceof</span> <span class="tok-n">Character</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_operador">Operador ==</h5>
<div class="paragraph">
<p>Es importante comentar también que en Groovy el operador <em>==</em> tiene una connotación diferente a la que tiene en Java. En Java, este operador significa igualdad en variables primitivas mientras que en objetos significa objetos idénticos. En Groovy, el significado de este operador es el mismo que la función <em>equals()</em>. Si necesitamos comprobar la identidad de dos variables siempre podremos utilizar el método <em>is()</em> tal y como vemos en el siguiente ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">foo</span><span class="tok-o">.</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">bar</span><span class="tok-o">))</span>
	<span class="tok-n">println</span> <span class="tok-s2">&quot;foo y bar son el mismo objeto&quot;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_la_verdad_en_groovy">La verdad en Groovy</h5>
<div class="paragraph">
<p>Cabe aquí comentar lo que se conoce como <em>la verdad en Groovy</em> que es un término que se refiere a que se considera como cierto en Groovy y que no. Veamos algunos ejemplos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">a</span> <span class="tok-o">=</span> <span class="tok-kc">true</span>
<span class="tok-kt">def</span> <span class="tok-n">b</span> <span class="tok-o">=</span> <span class="tok-kc">true</span>
<span class="tok-kt">def</span> <span class="tok-n">c</span> <span class="tok-o">=</span> <span class="tok-kc">false</span>
<span class="tok-k">assert</span> <span class="tok-n">a</span>
<span class="tok-k">assert</span> <span class="tok-n">a</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-n">b</span>
<span class="tok-k">assert</span> <span class="tok-n">a</span> <span class="tok-o">||</span> <span class="tok-n">c</span>
<span class="tok-k">assert</span> <span class="tok-o">!</span><span class="tok-n">c</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Hasta aquí ninguna novedad, pero ¿qué pasa si no estamos evaluando directamente un <em>booleano</em>?. Pues que Groovy añade una serie de reglas para indicar si esa expresión es cierta o no. Por ejemplo, en las colecciones (listas y mapas) se entenderá que una variable de estos tipos será cierta cuando contenga al menos un elemento.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">numeros</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-k">assert</span> <span class="tok-n">numeros</span> <span class="tok-c1">//cierto, ya que numeros no está vacía</span>
<span class="tok-n">numeros</span> <span class="tok-o">=</span> <span class="tok-o">[]</span> <span class="tok-c1">//vacíamos la lista</span>
<span class="tok-k">assert</span> <span class="tok-o">!</span><span class="tok-n">numeros</span> <span class="tok-c1">//cierto, ya que ahora la lista está vacía</span>

<span class="tok-k">assert</span> <span class="tok-o">[</span><span class="tok-s1">&#39;one&#39;</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">]</span> <span class="tok-c1">//este mapa contiene un elemento con lo que se evalúa a cierto</span>
<span class="tok-k">assert</span> <span class="tok-o">![:]</span> <span class="tok-c1">//este mapa está vacío</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En lo que a las cadenas de texto se refiere, siempre que éstas no sean la cadena vacía, se evaluarán a cierto.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Strings</span>
<span class="tok-k">assert</span> <span class="tok-s1">&#39;Esto es cierto&#39;</span>
<span class="tok-k">assert</span> <span class="tok-o">!</span><span class="tok-s1">&#39;&#39;</span>
<span class="tok-c1">//GStrings</span>
<span class="tok-kt">def</span> <span class="tok-n">s</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;&#39;</span>
<span class="tok-k">assert</span> <span class="tok-o">!(</span><span class="tok-s2">&quot;$s&quot;</span><span class="tok-o">)</span>
<span class="tok-n">s</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;x&#39;</span>
<span class="tok-k">assert</span> <span class="tok-o">(</span><span class="tok-s2">&quot;$s&quot;</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si evalúamos un número, siempre que éste no sea cero se evaluará a cierto.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-k">assert</span> <span class="tok-o">!</span><span class="tok-mi">0</span>
<span class="tok-k">assert</span> <span class="tok-mi">1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por último, siempre que un objeto no sea <em>null</em> éste se evaluará a cierto.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-k">assert</span> <span class="tok-k">new</span> <span class="tok-nf">Object</span><span class="tok-o">()</span>
<span class="tok-k">assert</span> <span class="tok-o">!</span><span class="tok-kc">null</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_estructuras_de_control_en_groovy">Estructuras de control en Groovy</h5>
<div class="paragraph">
<p>Algunas estructuras de control en Groovy son tratadas de la misma forma que en Java. Estos bloques son <em>if-else</em>, <em>while</em>, <em>switch</em> y <em>try-catch-finally</em>, aunque es conveniente hacer algunas anotaciones. En los condicionales, <em>null</em> es tratado como <em>false</em>, mientras que <em>!null</em> será <em>true</em>.</p>
</div>
<div class="paragraph">
<p>Con respecto a la sentencia <em>if</em>, Groovy soporta la sentencia de forma anidada.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-k">if</span> <span class="tok-o">(</span> <span class="tok-o">...</span> <span class="tok-o">)</span> <span class="tok-o">{</span>
<span class="tok-o">...</span>
<span class="tok-o">}</span> <span class="tok-k">else</span> <span class="tok-k">if</span> <span class="tok-o">(...)</span> <span class="tok-o">{</span>
<span class="tok-o">...</span>
<span class="tok-o">}</span> <span class="tok-k">else</span> <span class="tok-o">{</span>
<span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>De igual forma, se introduce también el operador ternario.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">y</span> <span class="tok-o">=</span> <span class="tok-mi">5</span>
<span class="tok-kt">def</span> <span class="tok-n">x</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-n">y</span> <span class="tok-o">&gt;</span> <span class="tok-mi">1</span><span class="tok-o">)</span> <span class="tok-o">?</span> <span class="tok-s2">&quot;funciona&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;falla&quot;</span>
<span class="tok-k">assert</span> <span class="tok-n">x</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;funciona&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Así como el operador Elvis</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">usuario</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-nl">nombre:</span><span class="tok-s2">&quot;Fran&quot;</span><span class="tok-o">]</span>
<span class="tok-kt">def</span> <span class="tok-n">nombre</span> <span class="tok-o">=</span> <span class="tok-n">usuario</span><span class="tok-o">.</span><span class="tok-na">nombre</span> <span class="tok-o">?:</span> <span class="tok-s2">&quot;Anónimo&quot;</span>
<span class="tok-k">assert</span> <span class="tok-n">nombre</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;Fran&quot;</span>
<span class="tok-n">usuario</span> <span class="tok-o">=</span> <span class="tok-o">[:]</span>
<span class="tok-n">nombre</span> <span class="tok-o">=</span> <span class="tok-n">usuario</span><span class="tok-o">.</span><span class="tok-na">nombre</span> <span class="tok-o">?:</span> <span class="tok-s2">&quot;Anónimo&quot;</span>
<span class="tok-k">assert</span> <span class="tok-n">nombre</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;Anónimo&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Con respecto a la estructura <em>switch</em>, la única diferencia entre Groovy y Java es que en la condición se puede utilizar cualquier tipo de comprobación, tal y como vemos en el siguiente ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">x</span> <span class="tok-o">=</span> <span class="tok-mf">1.23</span>
<span class="tok-kt">def</span> <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;&quot;</span>

<span class="tok-k">switch</span> <span class="tok-o">(</span> <span class="tok-n">x</span> <span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-k">case</span> <span class="tok-s2">&quot;foo&quot;</span><span class="tok-o">:</span>
        <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;found foo&quot;</span>
        <span class="tok-c1">// lets fall through</span>

    <span class="tok-k">case</span> <span class="tok-s2">&quot;bar&quot;</span><span class="tok-o">:</span>
        <span class="tok-n">result</span> <span class="tok-o">+=</span> <span class="tok-s2">&quot;bar&quot;</span>

    <span class="tok-k">case</span> <span class="tok-o">[</span><span class="tok-mi">4</span><span class="tok-o">,</span> <span class="tok-mi">5</span><span class="tok-o">,</span> <span class="tok-mi">6</span><span class="tok-o">,</span> <span class="tok-s1">&#39;inList&#39;</span><span class="tok-o">]:</span>
        <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;list&quot;</span>
        <span class="tok-k">break</span>

    <span class="tok-k">case</span> <span class="tok-mi">12</span><span class="tok-o">..</span><span class="tok-mi">30</span><span class="tok-o">:</span>
        <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;range&quot;</span>
        <span class="tok-k">break</span>

    <span class="tok-k">case</span> <span class="tok-nl">Integer:</span>
        <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;integer&quot;</span>
        <span class="tok-k">break</span>

    <span class="tok-k">case</span> <span class="tok-nl">Number:</span>
        <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;number&quot;</span>
        <span class="tok-k">break</span>

    <span class="tok-k">default</span><span class="tok-o">:</span>
        <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;default&quot;</span>
<span class="tok-o">}</span>

<span class="tok-k">assert</span> <span class="tok-n">result</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;number&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Groovy permite realizar las siguientes comprobaciones en una estructura <em>switch</em>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Comparar la clase de una variable</p>
</li>
<li>
<p>Expresiones regulares</p>
</li>
<li>
<p>Comprobar si la variable está contenida en una colección</p>
</li>
<li>
<p>Y en último lugar, se comprueba la igualdad entre la variable evaluada y el caso en particular</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Los bloques de código del tipo <em>for</em> utilizan la notación <em>for(i in x){cuerpo}</em> donde <em>x</em> puede ser cualquier cosa que Groovy sepa como iterar (iteradores, enumeraciones, colecciones, mapas, rangos, etc.)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-k">for</span><span class="tok-o">(</span><span class="tok-n">i</span> <span class="tok-k">in</span> <span class="tok-mi">1</span><span class="tok-o">..</span><span class="tok-mi">10</span><span class="tok-o">)</span>
	<span class="tok-n">println</span> <span class="tok-n">i</span>

<span class="tok-nf">for</span><span class="tok-o">(</span><span class="tok-n">i</span> <span class="tok-k">in</span> <span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-mi">9</span><span class="tok-o">,</span><span class="tok-mi">10</span><span class="tok-o">])</span>
	<span class="tok-n">println</span> <span class="tok-n">i</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En Groovy es una práctica habitual utilizar un closure para simular un bucle <em>for</em> como por ejemplo en el siguiente código</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">alumnos</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-s1">&#39;Pedro&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;Miguel&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;Alejandro&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;Elena&#39;</span><span class="tok-o">]</span>
<span class="tok-n">alumnos</span><span class="tok-o">.</span><span class="tok-na">each</span><span class="tok-o">{</span><span class="tok-n">nombre</span> <span class="tok-o">-&gt;</span> <span class="tok-n">println</span> <span class="tok-n">nombre</span><span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tipos_de_datos_en_groovy">1.5. Tipos de datos en Groovy</h3>
<div class="sect3">
<h4 id="_tipos_primitivos_y_referencias">1.5.1. Tipos primitivos y referencias</h4>
<div class="paragraph">
<p>En Java, existen los tipos de datos primitivos (<em>int, double, float, char</em>, etc) y las referencias (<em>Object, String</em>, etc), Los tipos de datos primitivos son aquellos que tienen valor por si mismos, bien sea un entero, un carácter o un número en coma flotante y es imposible crear nuevos tipos de datos primitivos.</p>
</div>
<div class="paragraph">
<p>Mientras que las referencias son identificadores de instancias de clases Java y, como su nombre indica, simplemente es una referencia a un objeto. En los tipos de datos primitivos es imposible realizar llamadas a métodos y éstos no pueden ser utilizados en aquellos lugares donde se espera la presencia de un tipo <em>java.lang.Object</em>. Esto hace que determinados fragmentos de código de nuestros programas, se compliquen demasiado, como puede ser el siguiente ejemplo que realiza la suma posición por posición de un par de vectores de enteros.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">ArrayList</span> <span class="tok-n">resultados</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">ArrayList</span><span class="tok-o">();</span>
<span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-o">=</span><span class="tok-mi">0</span><span class="tok-o">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-n">listaUno</span><span class="tok-o">.</span><span class="tok-na">size</span><span class="tok-o">();</span> <span class="tok-n">i</span><span class="tok-o">++){</span>
    <span class="tok-n">Integer</span> <span class="tok-n">primero</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-n">Integer</span><span class="tok-o">)</span><span class="tok-n">listaUno</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-n">i</span><span class="tok-o">);</span>
    <span class="tok-n">Integer</span> <span class="tok-n">segundo</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-n">Integer</span><span class="tok-o">)</span><span class="tok-n">listaDos</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-n">i</span><span class="tok-o">);</span>

    <span class="tok-kt">int</span> <span class="tok-n">suma</span> <span class="tok-o">=</span> <span class="tok-n">primero</span><span class="tok-o">.</span><span class="tok-na">intValue</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-n">segundo</span><span class="tok-o">.</span><span class="tok-na">intValue</span><span class="tok-o">();</span>
    <span class="tok-n">resultados</span><span class="tok-o">.</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">Integer</span><span class="tok-o">(</span><span class="tok-n">suma</span><span class="tok-o">));</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En Groovy, todo es un objeto y una solución al ejemplo anterior podría ser utilizando el método <em>plus()</em> que Groovy añade al tipo Integer: <em>resultados.add(primero.plus(segundo))</em>, con lo que nos podríamos ahorrar el paso de la conversión de tipo de dato referencia a tipo de dato primitivo (<em>primero.intValue()</em>).</p>
</div>
<div class="paragraph">
<p>Sin embargo, esta solución también se podría conseguir en Java si se añadiera el método plus a la clase Integer. Así que Groovy decide ir un poco más lejos y permite la utilización de operadores entre objetos, con lo que la solución en Groovy sería <em>resultados.add (primero + segundo)</em>.</p>
</div>
<div class="paragraph">
<p>De esta forma, lo que en Groovy puede parecer una variable de tipo de dato primitivo, en realidad es una referencia a una clase Java, tal y como se muestra en la siguiente tabla.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Tipo primitivo</th>
<th class="tableblock halign-left valign-top">Tipo referencia</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Byte</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">short</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Short</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Integer</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Long</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">float</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Float</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">double</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Double</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">char</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Character</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Boolean</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Así que cada vez que utilices un tipo de datos primitivo en tus programas en Groovy, en realidad estás utilizando la correspondiente clase indicada en la tabla anterior,  con lo que, puedes ahorrarte el uso de tipos primitivos en Groovy, porque por detrás se está haciendo una conversión a un tipo de dato referencia.</p>
</div>
</div>
<div class="sect3">
<h4 id="_boxing_unboxing_y_autoboxing">1.5.2. Boxing, unboxing y autoboxing</h4>
<div class="paragraph">
<p>La conversión de un tipo de dato primitivo a un tipo de dato referencia se conoce en Java como <em>boxing</em>, mientras que la conversión de un tipo de dato referencia a un tipo de dato primitivo se conoce <em>unboxing</em>. Groovy automatiza estas operaciones en lo que se conoce como <em>autoboxing</em>.</p>
</div>
<div class="paragraph">
<p>Pero, si Groovy convierte todo a un tipo de dato referencia, ¿qué pasa con aquellos métodos de Java que esperan un parámetro de tipo de dato primitivo?	No hay de que preocuparse, el autoboxing de Groovy se encarga de eso. Por ejemplo, en el método <em>indexOf</em> de la clase <em>java.lang.String</em> se espera como parámetro un entero (<em>int</em>) que indica el carácter buscado en la cadena, devolviendo también un entero indicando la posición en la que se ha encontrado el caracter. Si probamos el siguiente ejemplo, veremos como todo funciona correctamente, ya que Groovy se encarga de realizar el autoboxing allí donde considere oportuno, en este caso, en el paso del parámetro a la función <em>indexOf</em>. El siguiente código trata de obtener la posición de la primera 'o' de la cadena.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-k">assert</span> <span class="tok-s1">&#39;Hola Mundo&#39;</span><span class="tok-o">.</span><span class="tok-na">indexOf</span><span class="tok-o">(</span><span class="tok-mi">111</span><span class="tok-o">)</span> <span class="tok-o">==</span> <span class="tok-mi">1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En un principio Groovy, debería convertir el tipo de datos <em>int</em> del valor 111 a <em>Integer</em>, sin embargo, la función <em>indexOf()</em> requiere un parámetro de tipo <em>int</em>, con lo que el autoboxing de Groovy funciona de tal forma para convertir el parámetro al tipo de dato requerido, en este caso, <em>int</em>.</p>
</div>
<div class="paragraph">
<p>Otro aspecto interesante del autoboxing de Groovy es que no siempre se ejecuta el autoboxing para la realización de determinadas operaciones. Por ejemplo, en la operación <em>1 + 2</em>, podemos pensar que los valores 1 y 2 son del tipo referencia <em>Integer</em>, lo cual es cierto y que para poder realizarse la operación, éstos deben ser convertidos a tipo <em>int</em>, lo cual no es cierto.</p>
</div>
<div class="paragraph">
<p>De Groovy se dice que es incluso más orientado a objetos que Java y se dice por cuestiones como esta. En la operación <em>1 + 2</em>, lo que Groovy está realmente ejecutando es <em>1.plus(2)</em>, con lo que no es necesaria ninguna conversión para realizar esta operación.</p>
</div>
</div>
<div class="sect3">
<h4 id="_tipado_dinámico">1.5.3. Tipado dinámico</h4>
<div class="paragraph">
<p>Hasta el momento, en prácticamente todos los ejemplos que hemos visto en Groovy, hemos obviado especificar los tipos de datos utilizados, dejando que Groovy lo haga por nosotros. Esto es lo que se conoce como tipado dinámico y en este punto, vamos a ver los pros y los contras de su uso. La siguiente tabla, muestra un ejemplo con definiciones de variables y como actúa Groovy en cada caso.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Sentencia</th>
<th class="tableblock halign-left valign-top">Tipo de variable</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">def a = 2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Integer</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">def b = 0.4f</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Float</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">def c = 'a'</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">int d = 3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Integer</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">float e = 4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Float</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">char f = '1'</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Character</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">Integer g = 6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Integer</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">String h = '1'</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">Character i = 'a'</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Character</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">a</span> <span class="tok-o">=</span> <span class="tok-mi">2</span>
<span class="tok-kt">def</span> <span class="tok-n">b</span> <span class="tok-o">=</span> <span class="tok-mf">0.4f</span>
<span class="tok-kt">def</span> <span class="tok-n">c</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;a&#39;</span>
<span class="tok-kt">int</span> <span class="tok-n">d</span> <span class="tok-o">=</span> <span class="tok-mi">3</span>
<span class="tok-kt">float</span> <span class="tok-n">e</span> <span class="tok-o">=</span> <span class="tok-mi">4</span>
<span class="tok-kt">char</span> <span class="tok-n">f</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;1&#39;</span>
<span class="tok-n">Integer</span> <span class="tok-n">g</span> <span class="tok-o">=</span> <span class="tok-mi">6</span>
<span class="tok-n">String</span> <span class="tok-n">h</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;1&#39;</span>
<span class="tok-n">Character</span> <span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;a&#39;</span>

<span class="tok-k">assert</span> <span class="tok-n">a</span> <span class="tok-k">instanceof</span> <span class="tok-n">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">Integer</span>
<span class="tok-k">assert</span> <span class="tok-n">b</span> <span class="tok-k">instanceof</span> <span class="tok-n">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">Float</span>
<span class="tok-k">assert</span> <span class="tok-n">c</span> <span class="tok-k">instanceof</span> <span class="tok-n">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">String</span>
<span class="tok-k">assert</span> <span class="tok-n">d</span> <span class="tok-k">instanceof</span> <span class="tok-n">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">Integer</span>
<span class="tok-k">assert</span> <span class="tok-n">e</span> <span class="tok-k">instanceof</span> <span class="tok-n">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">Float</span>
<span class="tok-k">assert</span> <span class="tok-n">f</span> <span class="tok-k">instanceof</span> <span class="tok-n">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">Character</span>
<span class="tok-k">assert</span> <span class="tok-n">g</span> <span class="tok-k">instanceof</span> <span class="tok-n">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">Integer</span>
<span class="tok-k">assert</span> <span class="tok-n">h</span> <span class="tok-k">instanceof</span> <span class="tok-n">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">String</span>
<span class="tok-k">assert</span> <span class="tok-n">i</span> <span class="tok-k">instanceof</span> <span class="tok-n">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">Character</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La palabra reservada <em>def</em> se utiliza cuando no queremos especificar ningún tipo de dato en especial y dejamos que Groovy decida por nosotros, tal y como aparece en los tres primeros ejemplos. En los tres ejemplos siguientes, podemos ver como independientemente de declarar una variable como tipo de dato primitivo, ésta acabará siendo un tipo de dato referencia. Los tres últimos ejemplos, servirán a la persona que esté leyendo el código para entender que esa variable es un objeto.</p>
</div>
<div class="paragraph">
<p>Aquí es importante resaltar que Groovy es un lenguaje de tipado dinámico de datos seguro, lo que quiere decir, que Groovy no nos va a permitir realizar operaciones de una determinada clase a un objeto definido de forma diferente. Por ejemplo, en el trozo de código <em>String f = '1'</em>, la variable <em>f</em> nunca va a poder ser utilizada para realizar operaciones matemáticas como si fuera de la clase <em>java.lang.Number</em> salvo que hagamos la correspondiente conversión.</p>
</div>
<div class="paragraph">
<p>Poder elegir si utilizamos tipado dinámico o estático, es una de las mejores cosas que tiene Groovy. En Internet existen muchos foros de discusión creados a partir de este debate donde se exponen los pros y los contras de cada método. El <em>tipado estático</em> nos proporciona más información para la optimización de nuestros programas y revelan información adicional sobre el significado de la variable o del parámetro utilizado en un método determinado.</p>
</div>
<div class="paragraph">
<p>Por otro lado, el <em>tipado dinámico</em> no sólo es el método utilizado por los programadores vagos que no quieren estar definiendo los tipos de las variables, sino que también se utiliza cuando la salida de un método es utilizado como entrada de otro sin tener que hacer ningún trabajo extra por nuestra parte. De esta forma, el programador deja a Groovy que se encargue de la conversión de los datos en caso de que sea necesario y factible.</p>
</div>
<div class="paragraph">
<p>Otro aspecto interesante del tipado dinámico, es lo que se conoce como el <em>duck typing</em> (tipado de patos) y es que, si hay algo que camina como un pato y habla como un pato, lo más probable es que sea un pato. El tipado dinámico es interesante utilizarlo cuando se desconoce a ciencia cierta el tipo de datos de una determinada variable o parámetro. Esto nos proporciona un gran nivel de reutilización de nuestro código, así como la posibilidad de implementar funciones genéricas.</p>
</div>
</div>
<div class="sect3">
<h4 id="_trabajo_con_cadenas">1.5.4. Trabajo con cadenas</h4>
<div class="paragraph">
<p>Groovy nos facilita el trabajo con las cadenas de texto en mayor medida que lo hace Java, añadiendo su propia librería <em>groovy.lang.GString</em>, con lo que además de los métodos ofrecidos por la clase <em>java.lang.String</em>, Groovy cuenta con más metodos ofrecidos por esta librería. Una característica de como trabaja Groovy con las cadenas de texto es que nos permite introducir variables en las cadenas sin tener que utilizar caracteres de escape como por ejemplo <em>"hola $minombre"</em>, donde en la misma cadena se introduce el valor de una variable. Esto es típico de algunos lenguajes de programación como PHP y facilita la lectura de nuestro código ya que no tenemos que estar escapando constantemente.</p>
</div>
<div class="paragraph">
<p>La siguiente tabla muestra las diferentes formas que hay en Groovy para crear una cadena de texto:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33%;">
<col style="width: 33%;">
<col style="width: 33%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Caracteres utilizados</th>
<th class="tableblock halign-left valign-top">Ejemplo</th>
<th class="tableblock halign-left valign-top">Soporte GString</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Comillas simples</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">'hola Juan'</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Comillas dobles</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"hola $nombre"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sí</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3 comillas simples</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">'''-------------&lt;br/&gt;Total:0.02&lt;br/&gt;-------------'''</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3 comillas dobles</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"""-------------&lt;br/&gt;Total:$total&lt;br/&gt;-------------"""</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sí</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Símbolo /</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/x(\d*)y/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sí</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>La diferencia entre las comillas simples y las dobles es la posibilidad de incluir variables precedidas del símbolo $ para mostrar su valor. Las cadenas introducidas con el símbolo / son utilizadas con expresiones regulares, como veremos más adelante.</p>
</div>
<div class="sect4">
<h5 id="_la_librería_gstring">La librería GString</h5>
<div class="paragraph">
<p>La librería GString (<em>groovy.lang.GString</em>) añade determinados métodos para facilitarnos el trabajo con cadenas de texto, las cuales normalmente se crean utilizando comillas dobles. Básicamente, una cadena de tipo GString nos va a permitir introducir variables precedidas del símbolo $. También es posible introducir expresiones entre llaves (<em>${expresion}</em>), tal y como si estuviéramos escribiendo un <em>closure</em>. Veamos algunos ejemplos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">nombre</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;Fran&#39;</span>
<span class="tok-n">apellidos</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;García&#39;</span>
<span class="tok-n">salida</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;Apellidos, nombre: $apellidos, $nombre&quot;</span>

<span class="tok-n">fecha</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Date</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">)</span>
<span class="tok-n">salida</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;Año $fecha.year, Mes $fecha.month, Día $fecha.date&quot;</span>

<span class="tok-n">salida</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;La fecha es ${fecha.toGMTString()}&quot;</span>

<span class="tok-n">sentenciasql</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;&quot;&quot;</span>
<span class="tok-s2">SELECT nombre, apellidos</span>
<span class="tok-s2">FROM usuarios</span>
<span class="tok-s2">WHERE anyo_nacimiento=$fecha.year</span>
<span class="tok-s2">&quot;&quot;&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora que ya podemos declarar variables de texto, vamos a ver algunos métodos que podemos utilizar en Groovy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">saludo</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;Hola Juan&#39;</span>

<span class="tok-k">assert</span> <span class="tok-n">saludo</span><span class="tok-o">.</span><span class="tok-na">startsWith</span><span class="tok-o">(</span><span class="tok-s1">&#39;Hola&#39;</span><span class="tok-o">)</span>

<span class="tok-k">assert</span> <span class="tok-n">saludo</span><span class="tok-o">.</span><span class="tok-na">getAt</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">)</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;a&#39;</span>
<span class="tok-k">assert</span> <span class="tok-n">saludo</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">]</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;a&#39;</span>

<span class="tok-k">assert</span> <span class="tok-n">saludo</span><span class="tok-o">.</span><span class="tok-na">indexOf</span><span class="tok-o">(</span><span class="tok-s1">&#39;Juan&#39;</span><span class="tok-o">)</span> <span class="tok-o">==</span> <span class="tok-mi">5</span>
<span class="tok-k">assert</span> <span class="tok-n">saludo</span><span class="tok-o">.</span><span class="tok-na">contains</span><span class="tok-o">(</span><span class="tok-s1">&#39;Juan&#39;</span><span class="tok-o">)</span>

<span class="tok-k">assert</span> <span class="tok-n">saludo</span><span class="tok-o">[</span><span class="tok-mi">5</span><span class="tok-o">..</span><span class="tok-mi">8</span><span class="tok-o">]</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;Juan&#39;</span>

<span class="tok-k">assert</span> <span class="tok-s1">&#39;Buenos días&#39;</span> <span class="tok-o">+</span> <span class="tok-n">saludo</span> <span class="tok-o">-</span> <span class="tok-s1">&#39;Hola&#39;</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;Buenos días Juan&#39;</span>

<span class="tok-k">assert</span> <span class="tok-n">saludo</span><span class="tok-o">.</span><span class="tok-na">count</span><span class="tok-o">(</span><span class="tok-s1">&#39;a&#39;</span><span class="tok-o">)</span> <span class="tok-o">==</span> <span class="tok-mi">2</span>

<span class="tok-k">assert</span> <span class="tok-s1">&#39;b&#39;</span><span class="tok-o">.</span><span class="tok-na">padLeft</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">)</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;  b&#39;</span>
<span class="tok-k">assert</span> <span class="tok-s1">&#39;b&#39;</span><span class="tok-o">.</span><span class="tok-na">padRight</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-s1">&#39;_&#39;</span><span class="tok-o">)</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;b__&#39;</span>
<span class="tok-k">assert</span> <span class="tok-s1">&#39;b&#39;</span><span class="tok-o">.</span><span class="tok-na">center</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">)</span> <span class="tok-o">==</span> <span class="tok-s1">&#39; b &#39;</span>
<span class="tok-k">assert</span> <span class="tok-s1">&#39;b&#39;</span> <span class="tok-o">*</span> <span class="tok-mi">3</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;bbb&#39;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_expresiones_regulares">Expresiones regulares</h5>
<div class="paragraph">
<p>Las expresiones regulares nos permiten especificar un patrón y buscar si éste aparece en un fragmento de texto determinado. Groovy deje que sea Java la encargada del tratamiento de las expresiones regulares, pero además, añade tres métodos para facilitarnos este trabajo:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>El operador =~: <em>find</em></p>
</li>
<li>
<p>El operador ==~: <em>match</em></p>
</li>
<li>
<p>El operador ~String: <em>pattern</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Con los patrones de las expresiones regulares, realmente estamos indicando que estamos buscando exactamente. Veamos algunos ejemplos:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Patrón</th>
<th class="tableblock halign-left valign-top">Significado</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">algo de texto</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">simplemente encontrará la frase "algo de texto"</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">algo de\s+texto</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">encontrará frases que empiecen con "algo de", vayan seguidos por uno o más caracteres y terminen con la palabra texto</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">\d\d/\d\d/\d\d\d\d</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">detectará fechas como por ejemplo 28/06/2008</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>El punto clave de los patrones de las expresiones regulares, son los símbolos, que los podemos sustituir por determinados fragmentos de texto. La siguiente tabla presenta estos símbolos:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Símbolo</th>
<th class="tableblock halign-left valign-top">Significado</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cualquier carácter</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">^</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">El inicio de una línea</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">$</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">El final de una línea</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">\d</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Un dígito</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">\D</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cualquier cosa excepto un dígito</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">\s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Un espacio en blanco</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">\S</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cualquier cosa excepto un espacio en blanco</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">\w</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Un carácter de texto</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">\W</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cualquier carácter excepto los de texto</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">\b</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Límite de palabras</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">()</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Agrupación</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">(x|y)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">O x o y</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">x*</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cero o más ocurrencias de x</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">x+</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Una o más ocurrencias de x</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">x?</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cero o una ocurrencia de x</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">x{m,n}</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Entre m y n ocurrencias de x</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">x{m}</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exactamente m ocurrencias de x</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">[a-d]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Incluye los caracteres a, b, c y d</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">[^a]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cualquier carácter excepto la letra a</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Las expresiones regulares nos ayudarán en Groovy a:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Indicarnos si un determinado patrón encaja completamente con un texto</p>
</li>
<li>
<p>Si existe alguna ocurrencia de un patrón en una cadena</p>
</li>
<li>
<p>Contar el número de ocurrencias</p>
</li>
<li>
<p>Hacer algo con una determinada ocurrencia</p>
</li>
<li>
<p>Reemplazar todas las ocurrencias con un determinado texto</p>
</li>
<li>
<p>Separar una cadena en múltiples cadenas a partir de las ocurrencias que aparezcan en la misma</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>El siguiente fragmento de código muestra el funcionamiento básico de las expresiones regulares.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">refran</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;tres tristes tigres tigraban en un tigral&quot;</span>

<span class="tok-c1">//Compruebo que hay al menos un fragmento de código que empieza por t,</span>
<span class="tok-c1">//le siga cualquier caracter y posteriormente haya una g</span>
<span class="tok-k">assert</span> <span class="tok-n">refran</span> <span class="tok-o">=~</span> <span class="tok-s">/t.g/</span>

<span class="tok-c1">//Compruebo que el refrán esté compuesto sólo</span>
<span class="tok-c1">//por palabras seguidas de un espacio</span>
<span class="tok-k">assert</span> <span class="tok-n">refran</span> <span class="tok-o">==~</span> <span class="tok-s">/(\w+ \w+)*/</span>

<span class="tok-c1">//Compruebo que el valor de una operación de tipo match es un booleano</span>
<span class="tok-k">assert</span> <span class="tok-o">(</span><span class="tok-n">refran</span> <span class="tok-o">==~</span> <span class="tok-s">/(\w+ \w+)*/</span><span class="tok-o">)</span> <span class="tok-k">instanceof</span> <span class="tok-n">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">Boolean</span>

<span class="tok-c1">//A diferencia que una operación de tipo find,</span>
<span class="tok-c1">//las operaciones match se evalúan por completo contra una cadena</span>
<span class="tok-k">assert</span> <span class="tok-o">(</span><span class="tok-n">refran</span> <span class="tok-o">==~</span> <span class="tok-s">/t.g/</span><span class="tok-o">)</span> <span class="tok-o">==</span> <span class="tok-kc">false</span>

<span class="tok-c1">//Sustituyo las palabras por el caracter x</span>
<span class="tok-k">assert</span> <span class="tok-o">(</span><span class="tok-n">refran</span><span class="tok-o">.</span><span class="tok-na">replaceAll</span><span class="tok-o">(</span><span class="tok-s">/\w+/</span><span class="tok-o">,</span><span class="tok-s1">&#39;x&#39;</span><span class="tok-o">))</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;x x x x x x x&#39;</span>

<span class="tok-c1">//Devuelve un array con todas las palabras del refrán</span>
<span class="tok-n">palabras</span> <span class="tok-o">=</span> <span class="tok-n">refran</span><span class="tok-o">.</span><span class="tok-na">split</span><span class="tok-o">(</span><span class="tok-s">/ /</span><span class="tok-o">)</span>
<span class="tok-k">assert</span> <span class="tok-n">palabras</span><span class="tok-o">.</span><span class="tok-na">size</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-mi">7</span>
<span class="tok-k">assert</span> <span class="tok-n">palabras</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">]</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;tigres&#39;</span>
<span class="tok-k">assert</span> <span class="tok-n">palabras</span><span class="tok-o">.</span><span class="tok-na">getAt</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">)</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;tigraban&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Es importante resaltar la diferencia entre el operador <em>find</em> y el operador <em>match</em>. El operador <em>match</em> es más restrictivo puesto que intenta hacer coincidir un patrón con la cadena entera, mientras que el operador <em>find</em>, sólo pretende encontrar una ocurrencia del patrón en la cadena.</p>
</div>
<div class="paragraph">
<p>Ya sabemos como localizar fragmentos de texto en cadenas, pero ¿y si queremos hacer algo con estas cadenas encontradas? Groovy nos vuelve a facilitar esta tarea y pone a nuestra disposición un par de formas para recorrer las ocurrencias encontradas: <em>each</em> y <em>eachMatch</em>. Por un lado, al método <em>eachMatch</em> se le pasa una cadena con un patrón de expresión regular como parámetro: <em>String.eachMatch(patron)</em>, mientras que al método <em>each</em> se le pasa directamente el resultado de una operación de tipo <em>find()</em> o <em>match()</em>: <em>Matcher.each()</em>. Veámos ambos métodos en funcionamiento.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">refran</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;tres tristes tigres tigraban en un tigral&quot;</span>

<span class="tok-c1">//Busco todas las palabras que acaben en &#39;es&#39;</span>
<span class="tok-n">rima</span> <span class="tok-o">=</span> <span class="tok-o">~</span><span class="tok-s">/\b\w*es\b/</span>
<span class="tok-n">resultado</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;&#39;</span>
<span class="tok-n">refran</span><span class="tok-o">.</span><span class="tok-na">eachMatch</span><span class="tok-o">(</span><span class="tok-n">rima</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-n">match</span> <span class="tok-o">-&gt;</span>
    <span class="tok-n">resultado</span> <span class="tok-o">+=</span> <span class="tok-n">match</span> <span class="tok-o">+</span> <span class="tok-s1">&#39; &#39;</span>
<span class="tok-o">}</span>

<span class="tok-k">assert</span> <span class="tok-n">resultado</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;tres tristes tigres &#39;</span>

<span class="tok-c1">//Hago lo mismo con el método each</span>
<span class="tok-n">resultado</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;&#39;</span>
<span class="tok-o">(</span><span class="tok-n">refran</span> <span class="tok-o">=~</span> <span class="tok-n">rima</span><span class="tok-o">).</span><span class="tok-na">each</span> <span class="tok-o">{</span> <span class="tok-n">match</span> <span class="tok-o">-&gt;</span>
    <span class="tok-n">resultado</span> <span class="tok-o">+=</span> <span class="tok-n">match</span> <span class="tok-o">+</span> <span class="tok-s1">&#39; &#39;</span>
<span class="tok-o">}</span>

<span class="tok-k">assert</span> <span class="tok-n">resultado</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;tres tristes tigres &#39;</span>

<span class="tok-c1">//Sustituyo todas las rimas por guiones bajos</span>
<span class="tok-k">assert</span> <span class="tok-o">(</span><span class="tok-n">refran</span><span class="tok-o">.</span><span class="tok-na">replaceAll</span><span class="tok-o">(</span><span class="tok-n">rima</span><span class="tok-o">){</span> <span class="tok-n">it</span><span class="tok-o">-</span><span class="tok-s1">&#39;es&#39;</span><span class="tok-o">+</span><span class="tok-s1">&#39;__&#39;</span><span class="tok-o">}</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;tr__ trist__ tigr__ tigraban en un tigral&#39;</span><span class="tok-o">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_números">1.5.5. Números</h4>
<div class="paragraph">
<p>El GDK de Groovy introduce algunos métodos interesantes en cuanto al tratamiento de números. Estos métodos funcionan como closures y nos servirán como otras formas de realizar bucles. Estos métodos son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>times()</em>, se utiliza para realizar repeticiones</p>
</li>
<li>
<p><em>upto()</em>, utilizado para realizar una secuencia de acciones de forma creciente</p>
</li>
<li>
<p><em>downto()</em>, igual que el anterior pero de forma decreciente</p>
</li>
<li>
<p><em>step()</em>, es el método general para realizar una secuencia paso a paso</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Pero como siempre, veamos varios ejemplos.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">cadena</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;&#39;</span>
<span class="tok-mi">10</span><span class="tok-o">.</span><span class="tok-na">times</span> <span class="tok-o">{</span>
    <span class="tok-n">cadena</span> <span class="tok-o">+=</span> <span class="tok-s1">&#39;g&#39;</span>
<span class="tok-o">}</span>
<span class="tok-k">assert</span> <span class="tok-n">cadena</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;gggggggggg&#39;</span>

<span class="tok-n">cadena</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;&#39;</span>
<span class="tok-mi">1</span><span class="tok-o">.</span><span class="tok-na">upto</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-n">numero</span> <span class="tok-o">-&gt;</span>
    <span class="tok-n">cadena</span> <span class="tok-o">+=</span> <span class="tok-n">numero</span>
<span class="tok-o">}</span>

<span class="tok-k">assert</span> <span class="tok-n">cadena</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;12345&#39;</span>

<span class="tok-n">cadena</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;&#39;</span>
<span class="tok-mi">2</span><span class="tok-o">.</span><span class="tok-na">downto</span><span class="tok-o">(-</span><span class="tok-mi">2</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-n">numero</span> <span class="tok-o">-&gt;</span>
    <span class="tok-n">cadena</span> <span class="tok-o">+=</span> <span class="tok-n">numero</span> <span class="tok-o">+</span> <span class="tok-s1">&#39; &#39;</span>
<span class="tok-o">}</span>

<span class="tok-k">assert</span> <span class="tok-n">cadena</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;2 1 0 -1 -2 &#39;</span>

<span class="tok-n">cadena</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;&#39;</span>
<span class="tok-mi">0</span><span class="tok-o">.</span><span class="tok-na">step</span><span class="tok-o">(</span><span class="tok-mf">0.5</span><span class="tok-o">,</span> <span class="tok-mf">0.1</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-n">numero</span> <span class="tok-o">-&gt;</span>
    <span class="tok-n">cadena</span> <span class="tok-o">+=</span> <span class="tok-n">numero</span> <span class="tok-o">+</span> <span class="tok-s1">&#39; &#39;</span>
<span class="tok-o">}</span>

<span class="tok-k">assert</span> <span class="tok-n">cadena</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;0 0.1 0.2 0.3 0.4 &#39;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_colecciones">1.6. Colecciones</h3>
<div class="paragraph">
<p>Ahora que ya hemos introducido los tipos de datos simples, llega el turno de hablar de las colecciones presentes en Groovy. En este apartado vamos a ver tres tipos de datos. Por un lado, las <em>listas</em> y los <em>mapas</em>, que tienen prácticamente las mismas connotaciones que en Java, con alguna nueva característica que añade Groovy, y por otro, los <em>rangos</em>, un concepto que no existe en Java.</p>
</div>
<div class="sect3">
<h4 id="_rangos">1.6.1. Rangos</h4>
<div class="paragraph">
<p>Empecemos por lo novedoso. Cuantas veces no nos habremos encontrado con un bloque de código similar al siguiente</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-o">=</span><span class="tok-mi">0</span><span class="tok-o">;</span><span class="tok-n">i</span><span class="tok-o">&lt;</span><span class="tok-mi">10</span><span class="tok-o">;</span><span class="tok-n">i</span><span class="tok-o">++){</span>
	<span class="tok-c1">//hacer algo con la variable i</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El anterior fragmento de código se ejecutará empezando en un límite inferior (0) y terminará de ejecutarse cuando la variable <em>i</em> llegue al valor 10. Uno de los objetivos de Groovy consiste en facilitar al programador la lectura y la comprensión del código, así que los creadores de Groovy pensaron que sería útil introducir el concepto de rango, el cual tendría por definición un límite inferior y uno superior.</p>
</div>
<div class="paragraph">
<p>Para especificar un rango, simplemente se escribe el límite inferior seguido de dos puntos y el límite superior, <em>limiteInferior..limiteSuperior</em>. Este rango indicaría que ambos valores establecidos están dentro del rango, así que si queremos indicarle que el límite superior no está dentro del rango, debemos utilizar el operador ..&lt;, <em>limiteInferior..&lt;limiteSuperior</em>. También existen los <em>rangos inversos</em>, en los que el límite inferior es mayor que el límite superior. Veamos algunos ejemplos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">//Rangos inclusivos</span>
<span class="tok-k">assert</span> <span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">..</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">contains</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">)</span>
<span class="tok-k">assert</span> <span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">..</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">contains</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">)</span>

<span class="tok-c1">//Rangos medio-exclusivos</span>
<span class="tok-k">assert</span> <span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">..&lt;</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">contains</span><span class="tok-o">(</span><span class="tok-mi">9</span><span class="tok-o">)</span>
<span class="tok-k">assert</span> <span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">..&lt;</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">contains</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">)</span> <span class="tok-o">==</span> <span class="tok-kc">false</span>

<span class="tok-c1">//Comprobación de tipos</span>
<span class="tok-kt">def</span> <span class="tok-n">a</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-o">..</span><span class="tok-mi">10</span>
<span class="tok-k">assert</span> <span class="tok-n">a</span> <span class="tok-k">instanceof</span> <span class="tok-n">Range</span>

<span class="tok-c1">//Definición explícita</span>
<span class="tok-n">a</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">IntRange</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">,</span><span class="tok-mi">10</span><span class="tok-o">)</span>
<span class="tok-k">assert</span> <span class="tok-n">a</span><span class="tok-o">.</span><span class="tok-na">contains</span><span class="tok-o">(</span><span class="tok-mi">4</span><span class="tok-o">)</span>

<span class="tok-c1">//Rangos para fechas</span>
<span class="tok-kt">def</span> <span class="tok-n">hoy</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Date</span><span class="tok-o">()</span>
<span class="tok-kt">def</span> <span class="tok-n">ayer</span> <span class="tok-o">=</span> <span class="tok-n">hoy</span> <span class="tok-o">-</span> <span class="tok-mi">1</span>
<span class="tok-k">assert</span> <span class="tok-o">(</span><span class="tok-n">ayer</span><span class="tok-o">..</span><span class="tok-na">hoy</span><span class="tok-o">).</span><span class="tok-na">size</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-mi">2</span>

<span class="tok-c1">//Rangos para caracteres</span>
<span class="tok-k">assert</span> <span class="tok-o">(</span><span class="tok-s1">&#39;a&#39;</span><span class="tok-o">..</span><span class="tok-s1">&#39;f&#39;</span><span class="tok-o">).</span><span class="tok-na">contains</span><span class="tok-o">(</span><span class="tok-s1">&#39;e&#39;</span><span class="tok-o">)</span>

<span class="tok-c1">//El bucle for con rangos</span>
<span class="tok-kt">def</span> <span class="tok-n">salida</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;&#39;</span>
<span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">elemento</span> <span class="tok-k">in</span> <span class="tok-mi">1</span><span class="tok-o">..</span><span class="tok-mi">5</span><span class="tok-o">){</span>
    <span class="tok-n">salida</span> <span class="tok-o">+=</span> <span class="tok-n">elemento</span>
<span class="tok-o">}</span>
<span class="tok-k">assert</span> <span class="tok-n">salida</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;12345&#39;</span>

<span class="tok-c1">//El bucle for con rangos inversos</span>
<span class="tok-n">salida</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;&#39;</span>
<span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">elemento</span> <span class="tok-k">in</span> <span class="tok-mi">5</span><span class="tok-o">..</span><span class="tok-mi">1</span><span class="tok-o">){</span>
    <span class="tok-n">salida</span> <span class="tok-o">+=</span> <span class="tok-n">elemento</span>
<span class="tok-o">}</span>
<span class="tok-k">assert</span> <span class="tok-n">salida</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;54321&#39;</span>

<span class="tok-c1">//Simulación del bucle for con rangos inversos</span>
<span class="tok-c1">//y el método each con un closure</span>
<span class="tok-n">salida</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;&#39;</span>
<span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">..&lt;</span><span class="tok-mi">1</span><span class="tok-o">).</span><span class="tok-na">each</span> <span class="tok-o">{</span> <span class="tok-n">elemento</span> <span class="tok-o">-&gt;</span>
    <span class="tok-n">salida</span> <span class="tok-o">+=</span> <span class="tok-n">elemento</span>
<span class="tok-o">}</span>
<span class="tok-k">assert</span> <span class="tok-n">salida</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;5432&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Los rangos son objetos y como tales, pueden ser pasados como parámetros a funciones o bien ejecutar sus propios métodos. Un uso interesante de los rangos es el filtrado de datos. También es interesante verlos como clasificador de grupos y su utilidad se puede comprobar en los bloques de código <em>switch</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">//Rangos como clasificador de grupos</span>
<span class="tok-n">edad</span> <span class="tok-o">=</span> <span class="tok-mi">31</span>
<span class="tok-k">switch</span> <span class="tok-o">(</span><span class="tok-n">edad</span><span class="tok-o">){</span>
    <span class="tok-k">case</span> <span class="tok-mi">16</span><span class="tok-o">..</span><span class="tok-mi">20</span><span class="tok-o">:</span> <span class="tok-n">interesAplicado</span> <span class="tok-o">=</span> <span class="tok-mf">0.25</span><span class="tok-o">;</span> <span class="tok-k">break</span>
    <span class="tok-k">case</span> <span class="tok-mi">21</span><span class="tok-o">..</span><span class="tok-mi">50</span><span class="tok-o">:</span> <span class="tok-n">interesAplicado</span> <span class="tok-o">=</span> <span class="tok-mf">0.30</span><span class="tok-o">;</span> <span class="tok-k">break</span>
    <span class="tok-k">case</span> <span class="tok-mi">51</span><span class="tok-o">..</span><span class="tok-mi">65</span><span class="tok-o">:</span> <span class="tok-n">interesAplicado</span> <span class="tok-o">=</span> <span class="tok-mf">0.35</span><span class="tok-o">;</span> <span class="tok-k">break</span>
<span class="tok-o">}</span>
<span class="tok-k">assert</span> <span class="tok-n">interesAplicado</span> <span class="tok-o">==</span> <span class="tok-mf">0.30</span>

<span class="tok-c1">//Rangos para el filtrado de datos</span>
<span class="tok-n">edades</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-mi">16</span><span class="tok-o">,</span><span class="tok-mi">29</span><span class="tok-o">,</span><span class="tok-mi">34</span><span class="tok-o">,</span><span class="tok-mi">42</span><span class="tok-o">,</span><span class="tok-mi">55</span><span class="tok-o">]</span>
<span class="tok-n">joven</span> <span class="tok-o">=</span> <span class="tok-mi">16</span><span class="tok-o">..</span><span class="tok-mi">30</span>
<span class="tok-k">assert</span> <span class="tok-n">edades</span><span class="tok-o">.</span><span class="tok-na">grep</span><span class="tok-o">(</span><span class="tok-n">joven</span><span class="tok-o">)</span> <span class="tok-o">==</span> <span class="tok-o">[</span><span class="tok-mi">16</span><span class="tok-o">,</span><span class="tok-mi">29</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Como se ha podido comprobar, podemos especificar rangos para fechas e incluso para cadenas. En realidad, cualquier tipo de dato puede ser utilizado en un rango, siempre que se cumplan una serie de condiciones:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>El tipo implemente los métodos <em>next()</em> y <em>previous()</em>, que sobrecargan los operadores <em>++</em> y <em>--</em></p>
</li>
<li>
<p>El tipo implemente <em>java.lang.Comparable</em>, implementando el método <em>compareTo()</em> que sobrecarga el operador <em>&lt;&#8658;</em></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_listas">1.6.2. Listas</h4>
<div class="paragraph">
<p>En Java, agregar un nuevo elemento a un array no es algo trivial. Una solución es convertir el array a una lista del tipo <em>java.util.List</em>, añadir el nuevo elemento y volver a convertir la lista en un array. Otra solución pasa por construir un nuevo array del tamaño del array original más uno, copiar los viejos valores y el nuevo elemento. Eso es la parte negativa de los arrays en Java. La parte positiva es que nos permite trabajar con índices en los arrays para recuperar su información, así como modificar su valor, como por ejemplo, <em>miarray[indice] = nuevoelemento</em>. Groovy se aprovecha de la parte positiva de Java en este sentido, y añade nuevas características para mejorar su parte negativa.</p>
</div>
<div class="paragraph">
<p>La definición de una lista en Groovy se consigue utilizando los corchetes [] y especificando los valores de la lista. Si no especificamos ningún valor entre los corchetes, declararemos una lista vacía. Por defecto, las listas en Groovy son del tipo <em>java.util.ArrayList</em>. Podemos rellenar fácilmente las listas a partir de otras con el método <em>addAll()</em>. También se pueden definir listas a partir de otras con el constructor de la clase <em>LinkedList</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">miLista</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">]</span>

<span class="tok-k">assert</span> <span class="tok-n">miLista</span><span class="tok-o">.</span><span class="tok-na">size</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-mi">3</span>
<span class="tok-k">assert</span> <span class="tok-n">miLista</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">]</span> <span class="tok-o">==</span> <span class="tok-mi">3</span>
<span class="tok-k">assert</span> <span class="tok-n">miLista</span> <span class="tok-k">instanceof</span> <span class="tok-n">ArrayList</span>

<span class="tok-n">listaVacia</span> <span class="tok-o">=</span> <span class="tok-o">[]</span>
<span class="tok-k">assert</span> <span class="tok-n">listaVacia</span><span class="tok-o">.</span><span class="tok-na">size</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-mi">0</span>

<span class="tok-n">listaLarga</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">..</span><span class="tok-mi">1000</span><span class="tok-o">).</span><span class="tok-na">toList</span><span class="tok-o">()</span>
<span class="tok-k">assert</span> <span class="tok-n">listaLarga</span><span class="tok-o">[</span><span class="tok-mi">324</span><span class="tok-o">]</span> <span class="tok-o">==</span> <span class="tok-mi">324</span>

<span class="tok-n">listaExplicita</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">ArrayList</span><span class="tok-o">()</span>
<span class="tok-n">listaExplicita</span><span class="tok-o">.</span><span class="tok-na">addAll</span><span class="tok-o">(</span><span class="tok-n">miLista</span><span class="tok-o">)</span>
<span class="tok-k">assert</span> <span class="tok-n">listaExplicita</span><span class="tok-o">.</span><span class="tok-na">size</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-mi">3</span>
<span class="tok-n">listaExplicita</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">]</span> <span class="tok-o">=</span> <span class="tok-mi">4</span>
<span class="tok-k">assert</span> <span class="tok-n">listaExplicita</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">]</span> <span class="tok-o">==</span> <span class="tok-mi">4</span>

<span class="tok-n">listaExplicita</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">LinkedList</span><span class="tok-o">(</span><span class="tok-n">miLista</span><span class="tok-o">)</span>
<span class="tok-k">assert</span> <span class="tok-n">listaExplicita</span><span class="tok-o">.</span><span class="tok-na">size</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-mi">3</span>
<span class="tok-n">listaExplicita</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">]</span> <span class="tok-o">=</span> <span class="tok-mi">4</span>
<span class="tok-k">assert</span> <span class="tok-n">listaExplicita</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">]</span> <span class="tok-o">==</span> <span class="tok-mi">4</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En el fragmento de código anterior, hemos visto como se puede especificar un valor a un elemento de la lista. Pero, ¿qué pasa si queremos especificar un mismo valor a toda la lista o un trozo de la misma? Los creadores de Groovy ya han pensado en ese problema y podemos utilizar rangos y colecciones en las listas.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">miLista</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-s1">&#39;a&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;b&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;c&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;d&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;e&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;f&#39;</span><span class="tok-o">]</span>

<span class="tok-k">assert</span> <span class="tok-n">miLista</span><span class="tok-o">[</span><span class="tok-mi">0</span><span class="tok-o">..</span><span class="tok-mi">2</span><span class="tok-o">]</span> <span class="tok-o">==</span> <span class="tok-o">[</span><span class="tok-s1">&#39;a&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;b&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;c&#39;</span><span class="tok-o">]</span><span class="tok-c1">//Acceso con Rangos</span>
<span class="tok-k">assert</span> <span class="tok-n">miLista</span><span class="tok-o">[</span><span class="tok-mi">0</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">]</span> <span class="tok-o">==</span> <span class="tok-o">[</span><span class="tok-s1">&#39;a&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;c&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;e&#39;</span><span class="tok-o">]</span><span class="tok-c1">//Acceso con colección de índices</span>

<span class="tok-c1">//Modificar elementos</span>
<span class="tok-n">miLista</span><span class="tok-o">[</span><span class="tok-mi">0</span><span class="tok-o">..</span><span class="tok-mi">2</span><span class="tok-o">]</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-s1">&#39;x&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;y&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;z&#39;</span><span class="tok-o">]</span>
<span class="tok-k">assert</span> <span class="tok-n">miLista</span> <span class="tok-o">==</span> <span class="tok-o">[</span><span class="tok-s1">&#39;x&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;y&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;z&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;d&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;e&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;f&#39;</span><span class="tok-o">]</span>

<span class="tok-c1">//Eliminar elementos de la lista</span>
<span class="tok-n">miLista</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">..</span><span class="tok-mi">5</span><span class="tok-o">]</span> <span class="tok-o">=</span> <span class="tok-o">[]</span>
<span class="tok-k">assert</span> <span class="tok-n">miLista</span> <span class="tok-o">==</span> <span class="tok-o">[</span><span class="tok-s1">&#39;x&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;y&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;z&#39;</span><span class="tok-o">]</span>

<span class="tok-c1">//Añadir elementos a la lista</span>
<span class="tok-n">miLista</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">..</span><span class="tok-mi">1</span><span class="tok-o">]</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-s1">&#39;y&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;1&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;2&#39;</span><span class="tok-o">]</span>
<span class="tok-k">assert</span> <span class="tok-n">miLista</span> <span class="tok-o">==</span> <span class="tok-o">[</span><span class="tok-s1">&#39;x&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;y&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;1&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;2&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;z&#39;</span><span class="tok-o">]</span>

<span class="tok-n">miLista</span> <span class="tok-o">=</span> <span class="tok-o">[]</span>

<span class="tok-c1">//Añado objetos a la lista con el operador +</span>
<span class="tok-n">miLista</span> <span class="tok-o">+=</span> <span class="tok-s1">&#39;a&#39;</span>
<span class="tok-k">assert</span> <span class="tok-n">miLista</span> <span class="tok-o">==</span> <span class="tok-o">[</span><span class="tok-s1">&#39;a&#39;</span><span class="tok-o">]</span>

<span class="tok-c1">//Añado colecciones a la lista con el operador +</span>
<span class="tok-n">miLista</span> <span class="tok-o">+=</span> <span class="tok-o">[</span><span class="tok-s1">&#39;b&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;c&#39;</span><span class="tok-o">]</span>
<span class="tok-k">assert</span> <span class="tok-n">miLista</span> <span class="tok-o">==</span> <span class="tok-o">[</span><span class="tok-s1">&#39;a&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;b&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;c&#39;</span><span class="tok-o">]</span>

<span class="tok-n">miLista</span> <span class="tok-o">=</span> <span class="tok-o">[]</span>
<span class="tok-n">miLista</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-s1">&#39;a&#39;</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-s1">&#39;b&#39;</span>
<span class="tok-k">assert</span> <span class="tok-n">miLista</span> <span class="tok-o">==</span> <span class="tok-o">[</span><span class="tok-s1">&#39;a&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;b&#39;</span><span class="tok-o">]</span>

<span class="tok-k">assert</span> <span class="tok-n">miLista</span> <span class="tok-o">-</span> <span class="tok-o">[</span><span class="tok-s1">&#39;b&#39;</span><span class="tok-o">]</span> <span class="tok-o">==</span> <span class="tok-o">[</span><span class="tok-s1">&#39;a&#39;</span><span class="tok-o">]</span>

<span class="tok-k">assert</span> <span class="tok-n">miLista</span> <span class="tok-o">*</span> <span class="tok-mi">2</span> <span class="tok-o">==</span> <span class="tok-o">[</span><span class="tok-s1">&#39;a&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;b&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;a&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;b&#39;</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En ocasiones las listas son utilizadas juntos a estructuras de control para controlar el flujo de nuestro programa.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">miLista</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-s1">&#39;a&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;b&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;c&#39;</span><span class="tok-o">]</span>

<span class="tok-c1">//Listas como clasificador de grupos</span>
<span class="tok-n">letra</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;a&#39;</span>
<span class="tok-k">switch</span> <span class="tok-o">(</span><span class="tok-n">letra</span><span class="tok-o">){</span>
    <span class="tok-k">case</span> <span class="tok-nl">miLista:</span> <span class="tok-k">assert</span> <span class="tok-kc">true</span><span class="tok-o">;</span> <span class="tok-k">break</span><span class="tok-o">;</span>
    <span class="tok-k">default</span><span class="tok-o">:</span> <span class="tok-k">assert</span> <span class="tok-kc">false</span>
<span class="tok-o">}</span>

<span class="tok-c1">//Listas como filtrado de datos</span>
<span class="tok-k">assert</span> <span class="tok-o">[</span><span class="tok-s1">&#39;x&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;y&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;a&#39;</span><span class="tok-o">].</span><span class="tok-na">grep</span><span class="tok-o">(</span><span class="tok-n">miLista</span><span class="tok-o">)</span> <span class="tok-o">==</span> <span class="tok-o">[</span><span class="tok-s1">&#39;a&#39;</span><span class="tok-o">]</span>

<span class="tok-c1">//Bucle for con lista</span>
<span class="tok-n">salida</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;&#39;</span>
<span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">i</span> <span class="tok-k">in</span> <span class="tok-n">miLista</span><span class="tok-o">){</span>
    <span class="tok-n">salida</span> <span class="tok-o">+=</span> <span class="tok-n">i</span>
<span class="tok-o">}</span>
<span class="tok-k">assert</span> <span class="tok-n">salida</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;abc&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Las listas tienen una larga lista de métodos disponibles en el API de Java en la interfaz <em>java.util.List</em> para por ejemplo ordenar, unir e intersectar listas.</p>
</div>
</div>
<div class="sect3">
<h4 id="_mapas">1.6.3. Mapas</h4>
<div class="paragraph">
<p>Un mapa es prácticamente igual que una lista, con la salvedad de que los elementos están referenciados a partir de una clave única (sin caracteres extraños ni palabras reservadas por Groovy), <em>miMapa['clave'] = valor</em>. Podemos especificar un mapa al igual que lo hacíamos con las listas utilizando los corchetes, pero ahora debemos añadir la clave a cada valor introducido, como por ejemplo <em>miMapa = [a:1, b:2, c:3]</em>. Los mapas creados implícitamente son del tipo <em>java.util.HashMap</em>. Veámoslo con ejemplos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">miMapa</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-mi">1</span><span class="tok-o">,</span> <span class="tok-nl">b:</span><span class="tok-mi">2</span><span class="tok-o">,</span> <span class="tok-nl">c:</span><span class="tok-mi">3</span><span class="tok-o">]</span>

<span class="tok-k">assert</span> <span class="tok-n">miMapa</span> <span class="tok-k">instanceof</span> <span class="tok-n">HashMap</span>
<span class="tok-k">assert</span> <span class="tok-n">miMapa</span><span class="tok-o">.</span><span class="tok-na">size</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-mi">3</span>
<span class="tok-k">assert</span> <span class="tok-n">miMapa</span><span class="tok-o">[</span><span class="tok-s1">&#39;a&#39;</span><span class="tok-o">]</span> <span class="tok-o">==</span> <span class="tok-mi">1</span>

<span class="tok-c1">//Definimos un mapa vacio</span>
<span class="tok-kt">def</span> <span class="tok-n">mapaVacio</span> <span class="tok-o">=</span> <span class="tok-o">[:]</span>
<span class="tok-k">assert</span> <span class="tok-n">mapaVacio</span><span class="tok-o">.</span><span class="tok-na">size</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-mi">0</span>

<span class="tok-c1">//Definimos un mapa de la clase TreeMap</span>
<span class="tok-kt">def</span> <span class="tok-n">mapaExplicito</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">TreeMap</span><span class="tok-o">()</span>
<span class="tok-n">mapaExplicito</span><span class="tok-o">.</span><span class="tok-na">putAll</span><span class="tok-o">(</span><span class="tok-n">miMapa</span><span class="tok-o">)</span>
<span class="tok-k">assert</span> <span class="tok-n">mapaExplicito</span><span class="tok-o">[</span><span class="tok-s1">&#39;c&#39;</span><span class="tok-o">]</span> <span class="tok-o">==</span> <span class="tok-mi">3</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Las operaciones más comunes con los mapas se refieren a la recuperación y almacenamiento de datos a partir de la clave. Veamos algunos métodos de acceso y modificación de los elementos de un mapa:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">miMapa</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-mi">1</span><span class="tok-o">,</span> <span class="tok-nl">b:</span><span class="tok-mi">2</span><span class="tok-o">,</span> <span class="tok-nl">c:</span><span class="tok-mi">3</span><span class="tok-o">]</span>

<span class="tok-c1">//Varias formas de obtener los valores de un mapa</span>
<span class="tok-k">assert</span> <span class="tok-n">miMapa</span><span class="tok-o">[</span><span class="tok-s1">&#39;a&#39;</span><span class="tok-o">]</span> <span class="tok-o">==</span> <span class="tok-mi">1</span>
<span class="tok-k">assert</span> <span class="tok-n">miMapa</span><span class="tok-o">.</span><span class="tok-na">a</span> <span class="tok-o">==</span> <span class="tok-mi">1</span>
<span class="tok-k">assert</span> <span class="tok-n">miMapa</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-s1">&#39;a&#39;</span><span class="tok-o">)</span> <span class="tok-o">==</span> <span class="tok-mi">1</span>
<span class="tok-c1">//Si no existe la clave, devuelve un valor por defecto, en este caso 0</span>
<span class="tok-k">assert</span> <span class="tok-n">miMapa</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-s1">&#39;a&#39;</span><span class="tok-o">,</span><span class="tok-mi">0</span><span class="tok-o">)</span> <span class="tok-o">==</span> <span class="tok-mi">1</span>

<span class="tok-c1">//Asignación de valores</span>
<span class="tok-n">miMapa</span><span class="tok-o">[</span><span class="tok-s1">&#39;d&#39;</span><span class="tok-o">]</span> <span class="tok-o">=</span> <span class="tok-mi">4</span>
<span class="tok-k">assert</span> <span class="tok-n">miMapa</span><span class="tok-o">.</span><span class="tok-na">d</span> <span class="tok-o">==</span> <span class="tok-mi">4</span>
<span class="tok-n">miMapa</span><span class="tok-o">.</span><span class="tok-na">e</span> <span class="tok-o">=</span> <span class="tok-mi">5</span>
<span class="tok-k">assert</span> <span class="tok-n">miMapa</span><span class="tok-o">.</span><span class="tok-na">e</span> <span class="tok-o">==</span> <span class="tok-mi">5</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Los mapas en Groovy utilizan los mismos métodos que los mapas en Java y éstos están en el API de Java referente a <em>java.util.Map</em>, pero además, Groovy añade un par de métodos llamados <em>any()</em> y <em>every()</em>, los cuales, utilizados como closures, permite evaluar si todos (every) o al menos uno (any) de los elementos del mapa cumplen una determinada condición. Además, en el siguiente fragmento de código, vamos a ver como iterar sobre los mapas.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">miMapa</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-mi">1</span><span class="tok-o">,</span> <span class="tok-nl">b:</span><span class="tok-mi">2</span><span class="tok-o">,</span> <span class="tok-nl">c:</span><span class="tok-mi">3</span><span class="tok-o">]</span>

<span class="tok-kt">def</span> <span class="tok-n">resultado</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;&#39;</span>
<span class="tok-n">miMapa</span><span class="tok-o">.</span><span class="tok-na">each</span> <span class="tok-o">{</span> <span class="tok-n">item</span> <span class="tok-o">-&gt;</span>
    <span class="tok-n">resultado</span> <span class="tok-o">+=</span> <span class="tok-n">item</span><span class="tok-o">.</span><span class="tok-na">key</span> <span class="tok-o">+</span> <span class="tok-s1">&#39;:&#39;</span>
    <span class="tok-n">resultado</span> <span class="tok-o">+=</span> <span class="tok-n">item</span><span class="tok-o">.</span><span class="tok-na">value</span> <span class="tok-o">+</span> <span class="tok-s1">&#39;, &#39;</span>
<span class="tok-o">}</span>
<span class="tok-k">assert</span> <span class="tok-n">resultado</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;a:1, b:2, c:3, &#39;</span>

<span class="tok-n">resultado</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;&#39;</span>
<span class="tok-n">miMapa</span><span class="tok-o">.</span><span class="tok-na">each</span> <span class="tok-o">{</span> <span class="tok-n">key</span><span class="tok-o">,</span> <span class="tok-n">value</span> <span class="tok-o">-&gt;</span>
    <span class="tok-n">resultado</span> <span class="tok-o">+=</span> <span class="tok-n">key</span> <span class="tok-o">+</span> <span class="tok-s1">&#39;:&#39;</span>
    <span class="tok-n">resultado</span> <span class="tok-o">+=</span> <span class="tok-n">value</span> <span class="tok-o">+</span> <span class="tok-s1">&#39;, &#39;</span>
<span class="tok-o">}</span>
<span class="tok-k">assert</span> <span class="tok-n">resultado</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;a:1, b:2, c:3, &#39;</span>

<span class="tok-n">resultado</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;&#39;</span>
<span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">key</span> <span class="tok-k">in</span> <span class="tok-n">miMapa</span><span class="tok-o">.</span><span class="tok-na">keySet</span><span class="tok-o">()){</span>
    <span class="tok-n">resultado</span> <span class="tok-o">+=</span> <span class="tok-n">key</span> <span class="tok-o">+</span> <span class="tok-s1">&#39;:&#39;</span>
    <span class="tok-n">resultado</span> <span class="tok-o">+=</span> <span class="tok-n">miMapa</span><span class="tok-o">[</span><span class="tok-n">key</span><span class="tok-o">]</span> <span class="tok-o">+</span> <span class="tok-s1">&#39;, &#39;</span>
<span class="tok-o">}</span>
<span class="tok-k">assert</span> <span class="tok-n">resultado</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;a:1, b:2, c:3, &#39;</span>

<span class="tok-n">resultado</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;&#39;</span>
<span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">value</span> <span class="tok-k">in</span> <span class="tok-n">miMapa</span><span class="tok-o">.</span><span class="tok-na">values</span><span class="tok-o">()){</span>
    <span class="tok-n">resultado</span> <span class="tok-o">+=</span> <span class="tok-n">value</span> <span class="tok-o">+</span> <span class="tok-s1">&#39; &#39;</span>
<span class="tok-o">}</span>
<span class="tok-k">assert</span> <span class="tok-n">resultado</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;1 2 3 &#39;</span>

<span class="tok-kt">def</span> <span class="tok-n">valor1</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span> <span class="tok-mi">2</span><span class="tok-o">,</span> <span class="tok-mi">3</span><span class="tok-o">].</span><span class="tok-na">every</span> <span class="tok-o">{</span> <span class="tok-n">it</span> <span class="tok-o">&lt;</span> <span class="tok-mi">5</span> <span class="tok-o">}</span>
<span class="tok-k">assert</span> <span class="tok-n">valor1</span>

<span class="tok-kt">def</span> <span class="tok-n">valor2</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span> <span class="tok-mi">2</span><span class="tok-o">,</span> <span class="tok-mi">3</span><span class="tok-o">].</span><span class="tok-na">any</span> <span class="tok-o">{</span> <span class="tok-n">it</span> <span class="tok-o">&gt;</span> <span class="tok-mi">2</span> <span class="tok-o">}</span>
<span class="tok-k">assert</span> <span class="tok-n">valor2</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y para terminar con los mapas, vamos a ver otros métodos añadidos por Groovy para el manejo de los mapas, que nos permitirán:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Crear un submapa de un mapa dado a partir de algunas claves: <em>subMap()</em></p>
</li>
<li>
<p>Encontrar todos los elementos de un mapa que cumplen una determinada condición: <em>findAll()</em></p>
</li>
<li>
<p>Encontrar un elemento de un mapa que cumpla una determinada condición: <em>find()</em></p>
</li>
<li>
<p>Realizar operaciones sobre los elementos de un mapa: <em>collect()</em></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">miMapa</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-mi">1</span><span class="tok-o">,</span> <span class="tok-nl">b:</span><span class="tok-mi">2</span><span class="tok-o">,</span> <span class="tok-nl">c:</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-kt">def</span> <span class="tok-n">miSubmapa</span> <span class="tok-o">=</span> <span class="tok-n">miMapa</span><span class="tok-o">.</span><span class="tok-na">subMap</span><span class="tok-o">([</span><span class="tok-s1">&#39;a&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;b&#39;</span><span class="tok-o">])</span>
<span class="tok-k">assert</span> <span class="tok-n">miSubmapa</span><span class="tok-o">.</span><span class="tok-na">size</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-mi">2</span>

<span class="tok-kt">def</span> <span class="tok-n">miOtromapa</span> <span class="tok-o">=</span> <span class="tok-n">miMapa</span><span class="tok-o">.</span><span class="tok-na">findAll</span> <span class="tok-o">{</span> <span class="tok-n">entry</span> <span class="tok-o">-&gt;</span> <span class="tok-n">entry</span><span class="tok-o">.</span><span class="tok-na">value</span> <span class="tok-o">&gt;</span> <span class="tok-mi">1</span> <span class="tok-o">}</span>
<span class="tok-k">assert</span> <span class="tok-n">miOtromapa</span><span class="tok-o">.</span><span class="tok-na">size</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-mi">2</span>
<span class="tok-k">assert</span> <span class="tok-n">miOtromapa</span><span class="tok-o">.</span><span class="tok-na">c</span> <span class="tok-o">==</span> <span class="tok-mi">3</span>

<span class="tok-kt">def</span> <span class="tok-n">encontrado</span> <span class="tok-o">=</span> <span class="tok-n">miMapa</span><span class="tok-o">.</span><span class="tok-na">find</span> <span class="tok-o">{</span> <span class="tok-n">entry</span> <span class="tok-o">-&gt;</span> <span class="tok-n">entry</span><span class="tok-o">.</span><span class="tok-na">value</span> <span class="tok-o">&lt;</span> <span class="tok-mi">3</span><span class="tok-o">}</span>
<span class="tok-k">assert</span> <span class="tok-n">encontrado</span><span class="tok-o">.</span><span class="tok-na">key</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;a&#39;</span>
<span class="tok-k">assert</span> <span class="tok-n">encontrado</span><span class="tok-o">.</span><span class="tok-na">value</span> <span class="tok-o">==</span> <span class="tok-mi">1</span>

<span class="tok-kt">def</span> <span class="tok-n">miMapaDoble</span> <span class="tok-o">=</span> <span class="tok-n">miMapa</span><span class="tok-o">.</span><span class="tok-na">collect</span> <span class="tok-o">{</span> <span class="tok-n">entry</span> <span class="tok-o">-&gt;</span> <span class="tok-n">entry</span><span class="tok-o">.</span><span class="tok-na">value</span> <span class="tok-o">*=</span> <span class="tok-mi">2</span><span class="tok-o">}</span>
<span class="tok-c1">//Todos los elementos son pares</span>
<span class="tok-k">assert</span> <span class="tok-n">miMapaDoble</span><span class="tok-o">.</span><span class="tok-na">every</span> <span class="tok-o">{</span> <span class="tok-n">item</span> <span class="tok-o">-&gt;</span> <span class="tok-n">item</span> <span class="tok-o">%</span> <span class="tok-mi">2</span> <span class="tok-o">==</span> <span class="tok-mi">0</span> <span class="tok-o">}</span></code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios">1.7. Ejercicios</h3>
<div class="sect3">
<h4 id="_de_java_a_groovy_0_25_puntos">1.7.1. De Java a Groovy (0.25 puntos)</h4>
<div class="paragraph">
<p>Modificar la siguiente clase en Java para convertirla en una clase en Groovy y que quede lo más simplificada posible con la misma funcionalidad.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">import</span> <span class="tok-nn">java.util.List</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.ArrayList</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.Iterator</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Todo</span> <span class="tok-o">{</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">titulo</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">descripcion</span><span class="tok-o">;</span>

    <span class="tok-kd">public</span> <span class="tok-nf">Todo</span><span class="tok-o">()</span> <span class="tok-o">{}</span>

    <span class="tok-kd">public</span> <span class="tok-nf">Todo</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">tit</span><span class="tok-o">,</span> <span class="tok-n">String</span> <span class="tok-n">des</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">titulo</span> <span class="tok-o">=</span> <span class="tok-n">tit</span><span class="tok-o">;</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">descripcion</span> <span class="tok-o">=</span> <span class="tok-n">des</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getTitulo</span><span class="tok-o">(){</span>
        <span class="tok-k">return</span> <span class="tok-n">titulo</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setTitulo</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">tit</span><span class="tok-o">){</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">titulo</span> <span class="tok-o">=</span> <span class="tok-n">tit</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getDescripcion</span><span class="tok-o">(){</span>
        <span class="tok-k">return</span> <span class="tok-n">descripcion</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setDescripcion</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">des</span><span class="tok-o">){</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">descripcion</span> <span class="tok-o">=</span> <span class="tok-n">des</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-kt">void</span> <span class="tok-nf">main</span> <span class="tok-o">(</span><span class="tok-n">String</span><span class="tok-o">[]</span> <span class="tok-n">args</span><span class="tok-o">){</span>
        <span class="tok-n">List</span> <span class="tok-n">todos</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">ArrayList</span><span class="tok-o">();</span>
        <span class="tok-n">todos</span><span class="tok-o">.</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">Todo</span><span class="tok-o">(</span><span class="tok-s">&quot;Lavadora&quot;</span><span class="tok-o">,</span><span class="tok-s">&quot;Poner lavadora&quot;</span><span class="tok-o">));</span>
        <span class="tok-n">todos</span><span class="tok-o">.</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">Todo</span><span class="tok-o">(</span><span class="tok-s">&quot;Impresora&quot;</span><span class="tok-o">,</span><span class="tok-s">&quot;Comprar cartuchos impresora&quot;</span><span class="tok-o">));</span>
        <span class="tok-n">todos</span><span class="tok-o">.</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">Todo</span><span class="tok-o">(</span><span class="tok-s">&quot;Películas&quot;</span><span class="tok-o">,</span><span class="tok-s">&quot;Devolver películas videoclub&quot;</span><span class="tok-o">));</span>

        <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">Iterator</span> <span class="tok-n">iter</span> <span class="tok-o">=</span> <span class="tok-n">todos</span><span class="tok-o">.</span><span class="tok-na">iterator</span><span class="tok-o">();</span><span class="tok-n">iter</span><span class="tok-o">.</span><span class="tok-na">hasNext</span><span class="tok-o">();)</span> <span class="tok-o">{</span>
            <span class="tok-n">Todo</span> <span class="tok-n">todo</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-n">Todo</span><span class="tok-o">)</span><span class="tok-n">iter</span><span class="tok-o">.</span><span class="tok-na">next</span><span class="tok-o">();</span>
            <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">todo</span><span class="tok-o">.</span><span class="tok-na">getTitulo</span><span class="tok-o">()+</span><span class="tok-s">&quot; &quot;</span><span class="tok-o">+</span><span class="tok-n">todo</span><span class="tok-o">.</span><span class="tok-na">getDescripcion</span><span class="tok-o">());</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_groovybeans_0_50_puntos">1.7.2. GroovyBeans (0.50 puntos)</h4>
<div class="paragraph">
<p>Crear la clase <em>Libro</em> con las propiedades mínimas necesarias que lo describan. La información a almacenar de estos libros será el <em>nombre</em> del libro, el <em>año de edición</em> y el <em>autor</em> del mismo.</p>
</div>
<div class="paragraph">
<p>Simplemente crearemos un constructor de la clase <em>Libro</em> que permita especificar las tres propiedades de la clase (nombre, año de edición y autor). Para comprobar que nuestra clase funciona correctamente, insertaremos los siguientes ejemplos de libros:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Nombre: La colmena, año de edición: 1951, autor: Cela Trulock, Camilo José</p>
</li>
<li>
<p>Nombre: La galatea, año de edición: 1585, autor: de Cervantes Saavedra, Miguel</p>
</li>
<li>
<p>Nombre: La dorotea, año de edición: 1632, autor: Lope de Vega y Carpio, Félix Arturo</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Posteriormente comprueba que se han insertado correctamente cada uno de los libros indicados anteriormente mediante el uso de sentencias <em>asserts</em> y las funciones tipo <em>getter()</em> generadas automáticamente en Groovy</p>
</div>
<div class="paragraph">
<p>A continuación añade una nueva propiedad a la clase <em>Libro</em> para almacenar la editorial de los libros. Sin modificar la inserción de libros realizada anteriormente, inserta la editorial de cada uno de los libros utilizando los <em>setters()</em> definidos automáticamente por Groovy. Comprueba que los cambios se han efectuado correctamente nuevamente mediante la utilización de <em>asserts</em>.</p>
</div>
<div class="paragraph">
<p>Por último, modifica el comportamiento del &lt;em&gt;getter()&lt;/em&gt; correspondiente a la propiedad <em>autor</em> para que modifique su comportamiento por defecto y devuelva en su lugar el autor del libro con el formato nombre y apellidos.</p>
</div>
<div class="paragraph">
<p>Como siempre, comprueba que el nuevo método funciona correctamente mediante la utilización de &lt;em&gt;assert&lt;/em&gt;.</p>
</div>
</div>
<div class="sect3">
<h4 id="_expresiones_regulares_0_5_puntos">1.7.3. Expresiones regulares (0.5 puntos)</h4>
<div class="paragraph">
<p>Crea un script en Groovy que permite agrupar las palabras que aparecen en un párrafo en función del número de letras que contengan. Almacenaremos este catálogo de palabras en un mapa cuya clave será el tamaño y el valor será una lista con todas las palabras de ese mismo tamaño.</p>
</div>
<div class="paragraph">
<p>El párrafo a analizar será el inicio de <em>El Ingenioso Hidalgo Don Quijote de la Mancha</em>:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>En un lugar de la Mancha, de cuyo nombre no quiero acordarme, no ha mucho tiempo que vivía un hidalgo de los de lanza en astillero, adarga antigua, rocín flaco y galgo corredor. Una olla de algo más vaca que carnero, salpicón las más noches, duelos y quebrantos los sábados, lentejas los viernes, algún palomino de añadidura los domingos, consumían las tres partes de su hacienda. El resto della concluían sayo de velarte, calzas de velludo para las fiestas con sus pantuflos de lo mismo, los días de entre semana se honraba con su vellori de lo más fino. Tenía en su casa una ama que pasaba de los cuarenta, y una sobrina que no llegaba a los veinte, y un mozo de campo y plaza, que así ensillaba el rocín como tomaba la podadera. Frisaba la edad de nuestro hidalgo con los cincuenta años, era de complexión recia, seco de carnes, enjuto de rostro; gran madrugador y amigo de la caza. Quieren decir que tenía el sobrenombre de Quijada o Quesada (que en esto hay alguna diferencia en los autores que deste caso escriben), aunque por conjeturas verosímiles se deja entender que se llama Quijana; pero esto importa poco a nuestro cuento; basta que en la narración dél no se salga un punto de la verdad.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para comprobar si tu script funciona correctamente, puedes añadir estas líneas:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-k">assert</span> <span class="tok-n">palabras</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">]</span> <span class="tok-o">==</span> <span class="tok-o">[</span><span class="tok-s1">&#39;y&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;a&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;o&#39;</span><span class="tok-o">]</span>
<span class="tok-k">assert</span> <span class="tok-n">palabras</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">]</span> <span class="tok-o">==</span> <span class="tok-o">[</span><span class="tok-s1">&#39;en&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;un&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;de&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;la&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;no&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;ha&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;su&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;el&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;lo&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;se&#39;</span><span class="tok-o">]</span>
<span class="tok-k">assert</span> <span class="tok-n">palabras</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">]</span> <span class="tok-o">==</span> <span class="tok-o">[</span><span class="tok-s1">&#39;que&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;los&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;una&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;más&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;las&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;con&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;sus&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;ama&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;así&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;era&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;hay&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;por&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;dél&#39;</span><span class="tok-o">]</span>
<span class="tok-k">assert</span> <span class="tok-n">palabras</span><span class="tok-o">[</span><span class="tok-mi">4</span><span class="tok-o">]</span> <span class="tok-o">==</span> <span class="tok-o">[</span><span class="tok-s1">&#39;cuyo&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;olla&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;algo&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;vaca&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;tres&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;sayo&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;para&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;días&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;fino&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;casa&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;mozo&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;como&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;edad&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;años&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;seco&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;gran&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;caza&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;esto&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;caso&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;deja&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;pero&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;poco&#39;</span><span class="tok-o">]</span>
<span class="tok-k">assert</span> <span class="tok-n">palabras</span><span class="tok-o">[</span><span class="tok-mi">5</span><span class="tok-o">]</span> <span class="tok-o">==</span> <span class="tok-o">[</span><span class="tok-s1">&#39;lugar&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;mucho&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;vivía&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;lanza&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;rocín&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;flaco&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;galgo&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;algún&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;resto&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;della&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;mismo&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;entre&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;tenía&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;campo&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;plaza&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;recia&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;amigo&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;decir&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;deste&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;llama&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;basta&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;salga&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;punto&#39;</span><span class="tok-o">]</span>
<span class="tok-k">assert</span> <span class="tok-n">palabras</span><span class="tok-o">[</span><span class="tok-mi">6</span><span class="tok-o">]</span> <span class="tok-o">==</span> <span class="tok-o">[</span><span class="tok-s1">&#39;mancha&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;nombre&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;quiero&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;tiempo&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;adarga&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;noches&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;duelos&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;partes&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;calzas&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;semana&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;pasaba&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;veinte&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;tomaba&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;carnes&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;enjuto&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;rostro&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;alguna&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;aunque&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;cuento&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;verdad&#39;</span><span class="tok-o">]</span>
<span class="tok-k">assert</span> <span class="tok-n">palabras</span><span class="tok-o">[</span><span class="tok-mi">7</span><span class="tok-o">]</span> <span class="tok-o">==</span> <span class="tok-o">[</span><span class="tok-s1">&#39;hidalgo&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;antigua&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;carnero&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;sábados&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;viernes&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;velarte&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;velludo&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;fiestas&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;honraba&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;vellori&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;sobrina&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;llegaba&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;frisaba&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;nuestro&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;quieren&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;quijada&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;quesada&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;autores&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;quijana&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;importa&#39;</span><span class="tok-o">]</span>
<span class="tok-k">assert</span> <span class="tok-n">palabras</span><span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">]</span> <span class="tok-o">==</span> <span class="tok-o">[</span><span class="tok-s1">&#39;corredor&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;salpicón&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;lentejas&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;palomino&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;domingos&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;hacienda&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;cuarenta&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;podadera&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;escriben&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;entender&#39;</span><span class="tok-o">]</span>
<span class="tok-k">assert</span> <span class="tok-n">palabras</span><span class="tok-o">[</span><span class="tok-mi">9</span><span class="tok-o">]</span> <span class="tok-o">==</span> <span class="tok-o">[</span><span class="tok-s1">&#39;acordarme&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;astillero&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;añadidura&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;consumían&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;concluían&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;pantuflos&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;ensillaba&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;cincuenta&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;narración&#39;</span><span class="tok-o">]</span>
<span class="tok-k">assert</span> <span class="tok-n">palabras</span><span class="tok-o">[</span><span class="tok-mi">10</span><span class="tok-o">]</span> <span class="tok-o">==</span> <span class="tok-o">[</span><span class="tok-s1">&#39;quebrantos&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;complexión&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;madrugador&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;diferencia&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;conjeturas&#39;</span><span class="tok-o">]</span>
<span class="tok-k">assert</span> <span class="tok-n">palabras</span><span class="tok-o">[</span><span class="tok-mi">11</span><span class="tok-o">]</span> <span class="tok-o">==</span> <span class="tok-o">[</span><span class="tok-s1">&#39;sobrenombre&#39;</span><span class="tok-o">,</span> <span class="tok-s1">&#39;verosímiles&#39;</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion02">2. Aspectos avanzados del Lenguaje Groovy. Metaprogramación.</h2>
<div class="sectionbody">
<div class="paragraph">
<p>En la sesión anterior hacíamos un repaso completo sobre los tipos de tipos de datos simples y algunas características. Posteriormente hablábamos sobre colecciones y comentábamos las excelencias de los rangos, una tipo de datos propio de Groovy, además de los anteriormente conocidos listas y mapas.</p>
</div>
<div class="paragraph">
<p>Por último, echábamos un vistazo a las estructuras de control que podíamos utilizar en Groovy y a la combinación de éstas con los nuevos tipos de datos.</p>
</div>
<div class="paragraph">
<p>En esta sesión, veremos a fondo un nuevo concepto llamado <em>closure</em>. Ya hemos comentado algo sobre ellos en la sesión anterior, pero en esta veremos todas sus características.</p>
</div>
<div class="paragraph">
<p>Una vez vistos los closures, pasaremos a hablar sobre las características de Groovy como lenguaje orientado a objetos y terminaremos viendo un concepto conocido como <em>metaprogramación</em> que te permitirá extender la funcionalidad del lenguaje Groovy de forma muy sencilla.</p>
</div>
<div class="sect2">
<h3 id="_closures">2.1. Closures</h3>
<div class="paragraph">
<p>Aunque en apartados anteriores ya hayamos visto algunos ejemplos de closures, es conveniente dedicarle más tiempo a su explicación, ya que son una de las partes más importantes del lenguaje Groovy y más utilizados en Grails, y al mismo tiempo, puede ser un concepto difícil de entender, ya que no aparece en otros lenguajes de programación. Así que volveremos a ver lo que son los closures, como se declaran y como pueden ser posteriormente referenciados.</p>
</div>
<div class="paragraph">
<p>Más adelante, pasaremos a ver otros métodos disponibles en los closures y el ámbito de aplicación de los mismos, es decir, quien puede acceder a los mismos. Finalmente, definiremos varias tareas comunes que pueden ser realizadas con los closures, que hasta ahora se hacen de otras formas.</p>
</div>
<div class="sect3">
<h4 id="_definición_de_closure">2.1.1. Definición de closure</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Definición</div>
<div class="paragraph">
<p>Un <em>closure</em> es un trozo de código empaquetado como un objeto y definido entre llaves. Actúa como un método, al cual se le pueden pasar parámetros y pueden devolver valores. Es un objeto normal y corriente al cual se pasa una referencia de la misma forma que se le pasa a cualquier otro objeto.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Posiblemente estés pensando, que de momento los closures no te aportan nada que no puedas hacer nada con cualquier otro lenguaje de programación y posiblemente sea cierto. Sin embargo, los closures nos aportan agilidad a la hora de programar, que es lo que en principio buscamos utilizando un lenguaje como Groovy.</p>
</div>
</div>
<div class="sect3">
<h4 id="_declarando_closures">2.1.2. Declarando closures</h4>
<div class="paragraph">
<p>Como comentábamos anteriormente, los closures son bloques de código encerrado entre llaves {}. Y para entrar en calor, vamos a definir un closure para imprimir nuestro nombre.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">nombre</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;Juan&#39;</span>
<span class="tok-kt">def</span> <span class="tok-n">imprimeNombre</span> <span class="tok-o">=</span> <span class="tok-o">{</span> <span class="tok-n">println</span> <span class="tok-s2">&quot;Mi nombre es $nombre&quot;</span><span class="tok-o">}</span>

<span class="tok-n">imprimeNombre</span><span class="tok-o">()</span>

<span class="tok-n">nombre</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;Yolanda&quot;</span>
<span class="tok-n">imprimeNombre</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En primer lugar, cabe destacar en el ejemplo el uso de una variable dentro del closure definido fuera del ámbito del mismo. Es lo que se conoce <em>free variable</em>.</p>
</div>
<div class="paragraph">
<p>Además, te habrás dado cuenta de que el closure que acabamos de crear no está parametrizado, con lo que si se cambiara el nombre de nuestra variable, el closure no se ejecutaría correctamente. Para definir parámetros en nuestros closures, podemos hacerlo al inicio del mismo introduciendo el nombre de nuestros parámetros (separados por comas si hay más de uno) seguido de los caracteres &#8594;. El ejemplo anterior parametrizado quedaría así:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">imprimeNombre</span> <span class="tok-o">=</span> <span class="tok-o">{</span> <span class="tok-n">nombre</span> <span class="tok-o">-&gt;</span> <span class="tok-n">println</span> <span class="tok-s2">&quot;Mi nombre es ${nombre}&quot;</span><span class="tok-o">}</span>

<span class="tok-n">imprimeNombre</span><span class="tok-o">(</span><span class="tok-s2">&quot;Juan&quot;</span><span class="tok-o">)</span>
<span class="tok-n">imprimeNombre</span> <span class="tok-s2">&quot;Yolanda&quot;</span> <span class="tok-c1">//Los paréntesis son opcionales</span>

<span class="tok-c1">//Con múltiples parámetros</span>
<span class="tok-kt">def</span> <span class="tok-n">quintetoInicial</span> <span class="tok-o">=</span> <span class="tok-o">{</span> <span class="tok-n">base</span><span class="tok-o">,</span> <span class="tok-n">escolta</span><span class="tok-o">,</span> <span class="tok-n">alero</span><span class="tok-o">,</span> <span class="tok-n">alapivot</span><span class="tok-o">,</span> <span class="tok-n">pivot</span> <span class="tok-o">-&gt;</span> <span class="tok-n">println</span> <span class="tok-s2">&quot;Quinteto inicial compuesto por: $base, $escolta, $alero, $alapivot y $pivot&quot;</span><span class="tok-o">}</span>

<span class="tok-n">quintetoInicial</span> <span class="tok-s2">&quot;Calderón&quot;</span><span class="tok-o">,</span> <span class="tok-s2">&quot;Navarro&quot;</span><span class="tok-o">,</span> <span class="tok-s2">&quot;Jiménez&quot;</span><span class="tok-o">,</span> <span class="tok-s2">&quot;Garbajosa&quot;</span><span class="tok-o">,</span> <span class="tok-s2">&quot;Pau Gasol&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En aquellos closures que sólo tienen un parámetro, es posible obviar su declaración al inicio del closure, puesto que Groovy pone a nuestra disposición la variable <em>it</em>. El siguiente ejemplo es idéntico al closure <em>imprimeNombre</em> anterior, pero sin declarar sus parámetros.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">imprimeNombre</span> <span class="tok-o">=</span> <span class="tok-o">{</span> <span class="tok-n">println</span> <span class="tok-s2">&quot;Mi nombre es $it&quot;</span> <span class="tok-o">}</span>

<span class="tok-n">imprimeNombre</span><span class="tok-o">(</span><span class="tok-s2">&quot;Juan&quot;</span><span class="tok-o">)</span>
<span class="tok-n">imprimeNombre</span> <span class="tok-s2">&quot;Yolanda&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por último, existe otra forma de declarar un closure y es aprovechando un método ya existente. Con el operador <em>referencia &amp;</em> podemos declarar un closure a partir de un método de una clase ya creada. El siguiente ejemplo, tenemos la clase MetodoClosureEjemplo, en la que existe un método para comprobar si la longitud de la cadena pasada por parámetro es superior a un límite. A partir de este método, crearemos un closure sobre dos instancias de esta clase creadas con límites diferentes. Se puede comprobar como ejecutando el mismo método, obtenemos resultado diferentes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">MetodoClosureEjemplo</span> <span class="tok-o">{</span>
    <span class="tok-kt">int</span> <span class="tok-n">limite</span>

    <span class="tok-nf">MetodoClosureEjemplo</span> <span class="tok-o">(</span><span class="tok-kt">int</span> <span class="tok-n">limite</span><span class="tok-o">){</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">limite</span> <span class="tok-o">=</span> <span class="tok-n">limite</span>
    <span class="tok-o">}</span>

    <span class="tok-kt">boolean</span> <span class="tok-nf">validar</span> <span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">valor</span><span class="tok-o">){</span>
        <span class="tok-k">return</span> <span class="tok-n">valor</span><span class="tok-o">.</span><span class="tok-na">length</span><span class="tok-o">()</span> <span class="tok-o">&lt;=</span> <span class="tok-n">limite</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span>

<span class="tok-n">MetodoClosureEjemplo</span> <span class="tok-n">primero</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">MetodoClosureEjemplo</span><span class="tok-o">(</span><span class="tok-mi">8</span><span class="tok-o">)</span>
<span class="tok-n">MetodoClosureEjemplo</span> <span class="tok-n">segundo</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">MetodoClosureEjemplo</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">)</span>

<span class="tok-n">Closure</span> <span class="tok-n">primerClosure</span> <span class="tok-o">=</span> <span class="tok-n">primero</span><span class="tok-o">.&amp;</span><span class="tok-n">validar</span>

<span class="tok-kt">def</span> <span class="tok-n">palabras</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-s2">&quot;cadena larga&quot;</span><span class="tok-o">,</span> <span class="tok-s2">&quot;mediana&quot;</span><span class="tok-o">,</span> <span class="tok-s2">&quot;corta&quot;</span><span class="tok-o">]</span>

<span class="tok-k">assert</span> <span class="tok-s2">&quot;mediana&quot;</span> <span class="tok-o">==</span> <span class="tok-n">palabras</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">primerClosure</span><span class="tok-o">)</span>
<span class="tok-k">assert</span> <span class="tok-s2">&quot;corta&quot;</span> <span class="tok-o">==</span> <span class="tok-n">palabras</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">segundo</span><span class="tok-o">.&amp;</span><span class="tok-n">validar</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Con la variable <em>primero</em> estamos creando una instancia de la clase <em>MetodoClosureEjemplo</em> que validará aquellas palabras que tengan como mucho 8 caracteres, mientras que la variable <em>segundo</em> validará aquellas palabras con 5 caracteres o menos. Posteriormente, el closure <em>primerClosure</em> devolverá la primera palabra encontrada con 8 o menos caracteres y de la lista de palabras coincidiría con la palabra "mediana". En el segundo closure, el que valida la palabras de 5 o menos caracteres, la palabra devuelta sería "corta".</p>
</div>
<div class="paragraph">
<p>Otra característica interesante de los closures se refiere a la posibilidad de ejecutar diferentes métodos en función de los parámetros pasados y se conoce como <em>multimétodo</em>. La idea es crear una clase que sobrecarga un determinado método y posteriormente crear un closure a partir de ese método sobrecargado.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">MultimetodoClosureEjemplo</span><span class="tok-o">{</span>

    <span class="tok-kt">int</span> <span class="tok-nf">metodoSobrecargado</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">cadena</span><span class="tok-o">){</span>
        <span class="tok-k">return</span> <span class="tok-n">cadena</span><span class="tok-o">.</span><span class="tok-na">length</span><span class="tok-o">()</span>
    <span class="tok-o">}</span>

    <span class="tok-kt">int</span> <span class="tok-nf">metodoSobrecargado</span><span class="tok-o">(</span><span class="tok-n">List</span> <span class="tok-n">lista</span><span class="tok-o">){</span>
        <span class="tok-k">return</span> <span class="tok-n">lista</span><span class="tok-o">.</span><span class="tok-na">size</span><span class="tok-o">()</span>
    <span class="tok-o">}</span>

    <span class="tok-kt">int</span> <span class="tok-nf">metodoSobrecargado</span><span class="tok-o">(</span><span class="tok-kt">int</span> <span class="tok-n">x</span><span class="tok-o">,</span> <span class="tok-kt">int</span> <span class="tok-n">y</span><span class="tok-o">){</span>
        <span class="tok-k">return</span> <span class="tok-n">x</span> <span class="tok-o">*</span> <span class="tok-n">y</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span>

<span class="tok-n">MultimetodoClosureEjemplo</span> <span class="tok-n">instancia</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">MultimetodoClosureEjemplo</span><span class="tok-o">()</span>
<span class="tok-n">Closure</span> <span class="tok-n">multiclosure</span> <span class="tok-o">=</span> <span class="tok-n">instancia</span><span class="tok-o">.&amp;</span><span class="tok-n">metodoSobrecargado</span>

<span class="tok-k">assert</span> <span class="tok-mi">21</span> <span class="tok-o">==</span> <span class="tok-n">multiclosure</span><span class="tok-o">(</span><span class="tok-s2">&quot;una cadena cualquiera&quot;</span><span class="tok-o">)</span>
<span class="tok-k">assert</span> <span class="tok-mi">4</span> <span class="tok-o">==</span> <span class="tok-n">multiclosure</span><span class="tok-o">([</span><span class="tok-s1">&#39;una&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;lista&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;de&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;valores&#39;</span><span class="tok-o">])</span>
<span class="tok-k">assert</span> <span class="tok-mi">21</span> <span class="tok-o">==</span> <span class="tok-n">multiclosure</span><span class="tok-o">(</span><span class="tok-mi">7</span><span class="tok-o">,</span> <span class="tok-mi">3</span><span class="tok-o">)</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_los_closures_como_objetos">2.1.3. Los closures como objetos</h4>
<div class="paragraph">
<p>Anteriormente comentábamos que los closures son objetos y que como tales, pueden ser pasados como parámetros a funciones. Un ejemplo de este caso que ya hemos visto con anterioridad es el método <em>each()</em> de las listas, al cual se le puede pasar un closure para realizar una determinada operación sobre cada elemento de la lista.</p>
</div>
<div class="paragraph">
<p>Si echamos un vistazo al API de Groovy, veremos que el método each recibe como parámetro un objecto de tipo <em>Closure</em> <a href="http://groovy.codehaus.org/api/org/codehaus/groovy/runtime/DefaultGroovyMethods.html" class="bare">http://groovy.codehaus.org/api/org/codehaus/groovy/runtime/DefaultGroovyMethods.html</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">quintetoInicial</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-s2">&quot;Calderón&quot;</span><span class="tok-o">,</span> <span class="tok-s2">&quot;Navarro&quot;</span><span class="tok-o">,</span> <span class="tok-s2">&quot;Jiménez&quot;</span><span class="tok-o">,</span> <span class="tok-s2">&quot;Garbajosa&quot;</span><span class="tok-o">,</span> <span class="tok-s2">&quot;Pau Gasol&quot;</span><span class="tok-o">]</span>

<span class="tok-n">salida</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;&#39;</span>
<span class="tok-n">quintetoInicial</span><span class="tok-o">.</span><span class="tok-na">each</span> <span class="tok-o">{</span>
    <span class="tok-n">salida</span> <span class="tok-o">+=</span> <span class="tok-n">it</span> <span class="tok-o">+</span><span class="tok-s1">&#39;, &#39;</span>
<span class="tok-o">}</span>
<span class="tok-k">assert</span> <span class="tok-n">salida</span><span class="tok-o">.</span><span class="tok-na">take</span><span class="tok-o">(</span><span class="tok-n">salida</span><span class="tok-o">.</span><span class="tok-na">size</span><span class="tok-o">()-</span><span class="tok-mi">2</span><span class="tok-o">)</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;Calderón, Navarro, Jiménez, Garbajosa, Pau Gasol&#39;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_usos_de_los_closures">2.1.4. Usos de los closures</h4>
<div class="paragraph">
<p>Ahora que ya sabemos como declarar los closures, vamos a ver como utilizarlos y como podemos invocarlos. Si tenemos definido un <em>Closure x</em>  y queremos llamarlo podemos hacerlo de dos formas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>x.call()</p>
</li>
<li>
<p>x()</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">suma</span> <span class="tok-o">=</span> <span class="tok-o">{</span> <span class="tok-n">x</span><span class="tok-o">,</span> <span class="tok-n">y</span> <span class="tok-o">-&gt;</span>
<span class="tok-n">x</span> <span class="tok-o">+</span> <span class="tok-n">y</span>
<span class="tok-o">}</span>
<span class="tok-k">assert</span> <span class="tok-mi">10</span> <span class="tok-o">==</span> <span class="tok-n">suma</span><span class="tok-o">(</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">)</span>
<span class="tok-k">assert</span> <span class="tok-mi">13</span> <span class="tok-o">==</span> <span class="tok-n">suma</span><span class="tok-o">.</span><span class="tok-na">call</span><span class="tok-o">(</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A continuación, veremos un ejemplo sobre como pasar un closure como parámetro a un método. El ejemplo nos permitirá tener un campo de pruebas para comprobar que código es más rápido.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-nf">campodepruebas</span><span class="tok-o">(</span><span class="tok-n">repeticiones</span><span class="tok-o">,</span> <span class="tok-n">Closure</span> <span class="tok-n">proceso</span><span class="tok-o">){</span>
   <span class="tok-n">inicio</span> <span class="tok-o">=</span> <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">currentTimeMillis</span><span class="tok-o">()</span>
   <span class="tok-n">repeticiones</span><span class="tok-o">.</span><span class="tok-na">times</span><span class="tok-o">{</span><span class="tok-n">proceso</span><span class="tok-o">(</span><span class="tok-n">it</span><span class="tok-o">)}</span>
   <span class="tok-n">fin</span> <span class="tok-o">=</span> <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">currentTimeMillis</span><span class="tok-o">()</span>
   <span class="tok-k">return</span> <span class="tok-n">fin</span> <span class="tok-o">-</span> <span class="tok-n">inicio</span>
<span class="tok-o">}</span>

<span class="tok-n">lento</span> <span class="tok-o">=</span> <span class="tok-n">campodepruebas</span><span class="tok-o">(</span><span class="tok-mi">999999</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-o">(</span><span class="tok-kt">int</span><span class="tok-o">)</span> <span class="tok-n">it</span> <span class="tok-s">/ 2 }</span>
<span class="tok-s">rapido = campodepruebas(999999) { it.intdiv(2) }</span>

<span class="tok-s">/</span><span class="tok-o">/</span><span class="tok-n">El</span> <span class="tok-n">m</span><span class="tok-err">é</span><span class="tok-n">todo</span> <span class="tok-n">lento</span> <span class="tok-n">es</span> <span class="tok-n">al</span> <span class="tok-n">menos</span> <span class="tok-mi">3</span> <span class="tok-n">m</span><span class="tok-err">á</span><span class="tok-n">s</span> <span class="tok-n">lento</span> <span class="tok-n">que</span> <span class="tok-n">el</span> <span class="tok-n">r</span><span class="tok-err">á</span><span class="tok-n">pido</span>
<span class="tok-k">assert</span> <span class="tok-n">rapido</span> <span class="tok-o">*</span> <span class="tok-mi">3</span> <span class="tok-o">&lt;</span> <span class="tok-n">lento</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cuando ejecutamos <em>campodepruebas(999999)</em> le estamos pasando el primer parámetro, el que indica el número de repeticiones del código a ejecutar, mientras que el código encerrado entre llaves se corresponde con el <em>Closure</em> pasado como segundo parámetro. Cuando definimos un método que recibe como parámetro un closure, es obligatorio que éste sea definido el último parámetro del método.</p>
</div>
</div>
<div class="sect3">
<h4 id="_valores_por_defecto">2.1.5. Valores por defecto</h4>
<div class="paragraph">
<p>Hasta el momento, siempre que hemos creado un closure con parámetros, le hemos pasado tantas variables como parámetros tenía el closure. Sin embargo, al igual que en los métodos, es posible establecer un valor por defecto para los parámetros de un closure de la siguiente forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">suma</span> <span class="tok-o">=</span> <span class="tok-o">{</span> <span class="tok-n">x</span><span class="tok-o">,</span> <span class="tok-n">y</span><span class="tok-o">=</span><span class="tok-mi">3</span> <span class="tok-o">-&gt;</span>
  <span class="tok-n">suma</span> <span class="tok-o">=</span> <span class="tok-n">x</span> <span class="tok-o">+</span> <span class="tok-n">y</span>
<span class="tok-o">}</span>
<span class="tok-k">assert</span> <span class="tok-mi">7</span> <span class="tok-o">==</span> <span class="tok-n">suma</span><span class="tok-o">(</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">)</span>
<span class="tok-k">assert</span> <span class="tok-mi">7</span> <span class="tok-o">==</span> <span class="tok-n">suma</span><span class="tok-o">(</span><span class="tok-mi">4</span><span class="tok-o">)</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_más_métodos_de_los_closures">2.1.6. Más métodos de los closures</h4>
<div class="paragraph">
<p>La clase <em>groovy.lang.Closure</em> (<a href="http://groovy.codehaus.org/api/groovy/lang/Closure.html" class="bare">http://groovy.codehaus.org/api/groovy/lang/Closure.html</a>) es una clase como cualquier otra, aunque es cierto que con una potencia increíble. Hasta ahora, sólo hemos visto la existencia del método <em>call()</em>, pero existen muchos más, de los que vamos a ver los más importantes.</p>
</div>
<div class="paragraph">
<p>Es probable que en alguna ocasión necesites conocer el número de parámetros pasados a un closure para saber como actuar y para ello, los Closures disponen del método <em>getParameterTypes()</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-nf">llamador</span> <span class="tok-o">(</span><span class="tok-n">Closure</span> <span class="tok-n">closure</span><span class="tok-o">){</span>
    <span class="tok-n">closure</span><span class="tok-o">.</span><span class="tok-na">getParameterTypes</span><span class="tok-o">().</span><span class="tok-na">size</span><span class="tok-o">()</span>
<span class="tok-o">}</span>

<span class="tok-k">assert</span> <span class="tok-n">llamador</span> <span class="tok-o">{</span> <span class="tok-n">uno</span> <span class="tok-o">-&gt;</span> <span class="tok-o">}</span> <span class="tok-o">==</span> <span class="tok-mi">1</span>
<span class="tok-k">assert</span> <span class="tok-n">llamador</span> <span class="tok-o">{</span> <span class="tok-n">uno</span><span class="tok-o">,</span> <span class="tok-n">dos</span> <span class="tok-o">-&gt;</span> <span class="tok-o">}</span> <span class="tok-o">==</span> <span class="tok-mi">2</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Existe una técnica en programación llamada <em>currying</em> en honor a su creador <em>Haskell Brooks Curry</em>, que consiste en transformar una función con múltiples parámetros en otra con menos parámetros. Un ejemplo puede ser la función que suma dos valores. Si tenemos esta función con dos parámetros, y queremos crear otra que acepte un sólo parámetro, está claro que debe ser perdiendo el segundo parámetro, lo que conlleva a sumar siempre el mismo valor en esta nueva función. El método <em>curry()</em> devuelve un clon de la función principal, eliminando uno o más parámetros de la misma.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">suma</span> <span class="tok-o">=</span> <span class="tok-o">{</span> <span class="tok-n">x</span><span class="tok-o">,</span> <span class="tok-n">y</span> <span class="tok-o">-&gt;</span> <span class="tok-n">x</span> <span class="tok-o">+</span> <span class="tok-n">y</span> <span class="tok-o">}</span>
<span class="tok-kt">def</span> <span class="tok-n">sumaUno</span> <span class="tok-o">=</span> <span class="tok-n">suma</span><span class="tok-o">.</span><span class="tok-na">curry</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)</span>

<span class="tok-k">assert</span> <span class="tok-nf">suma</span><span class="tok-o">(</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">)</span> <span class="tok-o">==</span> <span class="tok-mi">7</span>
<span class="tok-k">assert</span> <span class="tok-nf">sumaUno</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">)</span> <span class="tok-o">==</span> <span class="tok-mi">6</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El nuevo closure <em>sumaUno</em> siempre toma como segundo parámetro el valor 1.</p>
</div>
</div>
<div class="sect3">
<h4 id="_valores_devueltos_en_los_closures">2.1.7. Valores devueltos en los closures</h4>
<div class="paragraph">
<p>Los <em>closures</em> tienen dos formas de devolver valores:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>De forma implícita</em>. El resultado de la última expresión evaluada por el closure, es lo que éste devuelve. Esto lo que hemos hecho hasta ahora.</p>
</li>
<li>
<p><em>De forma explícita</em>. La palabra reservada <em>return</em> también nos servirá en los closures para devolver valores</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>En el siguiente código de ejemplo, ambos closures tienen el mismo efecto, que es la duplicación de los valores de la lista.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-k">assert</span> <span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">]</span> <span class="tok-o">==</span> <span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">].</span><span class="tok-na">collect</span> <span class="tok-o">{</span> <span class="tok-n">it</span> <span class="tok-o">*</span> <span class="tok-mi">2</span> <span class="tok-o">}</span>
<span class="tok-k">assert</span> <span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">]</span> <span class="tok-o">==</span> <span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">].</span><span class="tok-na">collect</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">it</span> <span class="tok-o">*</span> <span class="tok-mi">2</span> <span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si queremos salir de un closure de forma prematura, también podemos hacer uso del return. Por ejemplo, si en el ejemplo anterior sólo queremos duplicar aquellos valores impares, deberíamos tener algo así.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-k">assert</span> <span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span> <span class="tok-mi">6</span><span class="tok-o">]</span> <span class="tok-o">==</span> <span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">].</span><span class="tok-na">collect</span> <span class="tok-o">{</span>
    <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">it</span><span class="tok-o">%</span><span class="tok-mi">2</span><span class="tok-o">==</span><span class="tok-mi">1</span><span class="tok-o">)</span>
        <span class="tok-k">return</span> <span class="tok-n">it</span> <span class="tok-o">*</span> <span class="tok-mi">2</span>
    <span class="tok-k">return</span> <span class="tok-n">it</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_groovy_como_lenguaje_orientado_a_objetos">2.2. Groovy como lenguaje orientado a objetos</h3>
<div class="paragraph">
<p>Un concepto erróneo que se suele decir de los lenguajes scripts, debido a su dejadez con el tipado de datos y determinadas estructuras de control, es que son lenguajes destinados más a los hackers que a los programadores serios. Esta reputación viene de las primeras versiones del lenguaje Perl, donde la falta de encapsulación y la falta de otras características típicas del modelo orientado a objetos, provocaba un mala gestión del código, con frecuentes trozos de código duplicados e indescifrables fallos de programación.</p>
</div>
<div class="paragraph">
<p>Sin embargo, este panorama ha cambiado drásticamente en los últimos años, ya que lenguajes como el mismo Perl, Python y más recientemente, Ruby, han añadido características del modelo orientado a objetos, que los hacen incluso más productivos que lenguajes como Java o C++. Groovy también se ha subido al carro de estos lenguajes ofreciendo características similares, con lo que ha pasado de ser un lenguaje de script basado en Java, a ser un lenguaje que nos ofrece nuevas características del modelo orientado a objetos.</p>
</div>
<div class="paragraph">
<p>Hasta ahora hemos visto que Groovy nos ofrece tipos de datos referencia donde Java simplemente nos ofrecía tipos de datos simples, tenemos rangos y closures, y muchas estructuras de control para trabajar de forma muy ágil y sencilla con colecciones de objetos. Pero esto es sólo la punta del iceberg, y a partir de ahora veremos otras características, que hacen de Groovy un lenguaje con mucho futuro. Empezaremos repasando las clases y los scripts en Groovy, seguiremos por la organización de nuestras clases y terminaremos viendo características avanzadas del modelo orientado a objetos en Groovy.</p>
</div>
<div class="sect3">
<h4 id="_clases_y_scripts">2.2.1. Clases y scripts</h4>
<div class="paragraph">
<p>La definición de clases en Groovy es prácticamente idéntica a como se hace en Java. Las clases se declaran utilizando la palabra reservada <em>class</em> y una clase puede tener <em>campos</em>, <em>constructores</em> y <em>métodos</em>. Los métodos y los constructores pueden utilizar <em>variables locales</em>. Por otro lado tenemos los <em>scripts</em> que puede contener la definición de variables y métodos, así como la declaración de clases.</p>
</div>
<div class="paragraph">
<p>La <strong>declaración de variables</strong> debe realizarse antes de que se utilicen. Declarar una variable supone indicar un nombre a la misma y un tipo, aunque en Groovy esto es opcional.</p>
</div>
<div class="paragraph">
<p>Groovy utiliza los mismos modificadores que Java, que son: <em>private</em>, <em>protected</em> y <em>public</em> para modificar la visibilidad de las variables; <em>final</em> para evitar la modificación de variables; y <em>static</em> para la declaración de las variables de la clase.</p>
</div>
<div class="paragraph">
<p>La definición del tipo de la variable es opcional en Groovy y cuando no se especifica, debemos introducir previamente al nombre de la variable, la palabra reserva <em>def</em>. Por último y aunque pueda resultar obvio, en Groovy es imposible asignar valores a variables que no coincidan en el tipo. Por ejemplo, un valor numérico no puede ser asignado a una variable definida de tipo <em>String</em>. Como vimos anteriormente, Groovy se encarga de hacer el llamado <em>autoboxing</em> siempre y cuando sea posible.</p>
</div>
<div class="paragraph">
<p>Otro aspecto interesante de Groovy es la asignación de valores a las propiedades de las clases. Si hemos definido un campo en una clase en Groovy, podemos acceder al valor del mismo de la forma habitual <em>objeto.campo</em> o bien <em>objeto['campo']</em>. Esto nos permite una mayor facilidad para acceder a los campos de las clases de forma dinámica, tal y como se hace en el siguiente fragmento de código.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">miClase</span> <span class="tok-o">{</span>
    <span class="tok-kd">public</span> <span class="tok-n">campo1</span><span class="tok-o">,</span> <span class="tok-n">campo2</span><span class="tok-o">,</span> <span class="tok-n">campo3</span><span class="tok-o">,</span> <span class="tok-n">campo4</span> <span class="tok-o">=</span> <span class="tok-mi">0</span>
<span class="tok-o">}</span>

<span class="tok-kt">def</span> <span class="tok-n">miobjeto</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">miClase</span><span class="tok-o">()</span>

<span class="tok-n">miobjeto</span><span class="tok-o">.</span><span class="tok-na">campo1</span> <span class="tok-o">=</span> <span class="tok-mi">2</span>
<span class="tok-k">assert</span> <span class="tok-n">miobjeto</span><span class="tok-o">.</span><span class="tok-na">campo1</span> <span class="tok-o">==</span> <span class="tok-mi">2</span>

<span class="tok-n">miobjeto</span><span class="tok-o">[</span><span class="tok-s1">&#39;campo2&#39;</span><span class="tok-o">]</span> <span class="tok-o">=</span> <span class="tok-mi">3</span>
<span class="tok-k">assert</span> <span class="tok-n">miobjeto</span><span class="tok-o">.</span><span class="tok-na">campo2</span> <span class="tok-o">==</span> <span class="tok-mi">3</span>

<span class="tok-k">for</span><span class="tok-o">(</span><span class="tok-n">i</span><span class="tok-o">=</span><span class="tok-mi">1</span><span class="tok-o">;</span><span class="tok-n">i</span><span class="tok-o">&lt;=</span><span class="tok-mi">4</span><span class="tok-o">;</span><span class="tok-n">i</span><span class="tok-o">++)</span>
    <span class="tok-n">miobjeto</span><span class="tok-o">[</span><span class="tok-s1">&#39;campo&#39;</span><span class="tok-o">+</span><span class="tok-n">i</span><span class="tok-o">]</span> <span class="tok-o">=</span> <span class="tok-n">i</span> <span class="tok-o">-</span> <span class="tok-mi">1</span>

<span class="tok-k">assert</span> <span class="tok-n">miobjeto</span><span class="tok-o">.</span><span class="tok-na">campo1</span> <span class="tok-o">==</span> <span class="tok-mi">0</span>
<span class="tok-k">assert</span> <span class="tok-n">miobjeto</span><span class="tok-o">[</span><span class="tok-s1">&#39;campo2&#39;</span><span class="tok-o">]</span> <span class="tok-o">==</span> <span class="tok-mi">1</span>
<span class="tok-k">assert</span> <span class="tok-n">miobjeto</span><span class="tok-o">.</span><span class="tok-na">campo3</span> <span class="tok-o">==</span> <span class="tok-mi">2</span>
<span class="tok-k">assert</span> <span class="tok-n">miobjeto</span><span class="tok-o">[</span><span class="tok-s1">&#39;campo4&#39;</span><span class="tok-o">]</span> <span class="tok-o">==</span> <span class="tok-mi">3</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La <strong>declaración de los métodos</strong> sigue los mismos criterios que acabamos de ver con las variables. Se pueden utilizar los modificadores Java, es opcional devolver algo con la sentencia <em>return</em> y si no se utilizan modificadores ni queremos especificar el tipo de dato a devolver, debemos utilizar la palabra reservada <em>def</em> para declarar nuestros métodos. Por defecto, la visibilidad de los métodos en Groovy es <em>public</em>.</p>
</div>
<div class="paragraph">
<p>Veamos una clase ejemplo y con ella, algunas diferencias con la misma clase en Java.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">MiClase</span><span class="tok-o">{</span>

       <span class="tok-kd">static</span> <span class="tok-nf">main</span><span class="tok-o">(</span><span class="tok-n">args</span><span class="tok-o">){</span>
           <span class="tok-kt">def</span> <span class="tok-n">algo</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">MiClase</span><span class="tok-o">()</span>
           <span class="tok-n">algo</span><span class="tok-o">.</span><span class="tok-na">metodoPublicoVacio</span><span class="tok-o">()</span>
           <span class="tok-k">assert</span> <span class="tok-s2">&quot;hola&quot;</span> <span class="tok-o">==</span> <span class="tok-n">algo</span><span class="tok-o">.</span><span class="tok-na">metodoNoTipado</span><span class="tok-o">()</span>
           <span class="tok-k">assert</span> <span class="tok-s1">&#39;adios&#39;</span> <span class="tok-o">==</span> <span class="tok-n">algo</span><span class="tok-o">.</span><span class="tok-na">metodoTipado</span><span class="tok-o">()</span>
           <span class="tok-n">metodoCombinado</span><span class="tok-o">()</span>
       <span class="tok-o">}</span>

       <span class="tok-kt">void</span> <span class="tok-nf">metodoPublicoVacio</span><span class="tok-o">(){</span>
           <span class="tok-o">;</span>
       <span class="tok-o">}</span>

       <span class="tok-kt">def</span> <span class="tok-nf">metodoNoTipado</span><span class="tok-o">(){</span>
           <span class="tok-k">return</span> <span class="tok-s1">&#39;hola&#39;</span>
       <span class="tok-o">}</span>

       <span class="tok-n">String</span> <span class="tok-nf">metodoTipado</span><span class="tok-o">(){</span>
           <span class="tok-k">return</span> <span class="tok-s1">&#39;adios&#39;</span>
       <span class="tok-o">}</span>

       <span class="tok-kd">protected</span> <span class="tok-kd">static</span> <span class="tok-kd">final</span> <span class="tok-kt">void</span> <span class="tok-nf">metodoCombinado</span><span class="tok-o">(){</span>

       <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En la primera sesión comentábamos que el método <em>main</em> típico de Java y C, ya no era necesario en Groovy, puesto que podíamos ejecutar nuestro código sin necesidad de incluirlo en dicho método. Sin embargo, si queremos introducir parámetros a nuestro programa, tendremos que utilizarlo, tal y como aparece en el ejemplo. No obstante, este método main es algo diferente al de Java, puesto que no es necesario indicarle que el método es público, ya que, por defecto y salvo que se diga que lo contrario, todo método en Groovy es <em>public</em>. La segunda diferencia con Java es que los argumentos debían ser del tipo <em>String[]</em> mientras que en Groovy simplemente es un objeto y no es necesario especificarle el tipo. Puesto que en la función main no se va a devolver nada, es posible obviar la etiqueta <em>void</em> en la declaración del método. Resumiendo, mientras que en Java tendríamos esto <em>public static void main (String[] args)</em>, en Groovy quedaría algo así <em>static main (args)</em>.</p>
</div>
<div class="paragraph">
<p>Groovy nos ahorra también bastante trabajo en cuanto a la comprobación de errores. En este sentido, cuando intentamos llamar a un método o un objeto cuya referencia es <em>null</em>, obtendremos una excepción del tipo <em>NullPointerException</em>, lo cual es muy útil para comprobar que nuestro código funciona tal y como debe funcionar. Veamos un ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">mapa</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-o">[</span><span class="tok-nl">b:</span><span class="tok-o">[</span><span class="tok-nl">c:</span><span class="tok-mi">1</span><span class="tok-o">]]]</span>

<span class="tok-k">assert</span> <span class="tok-n">mapa</span><span class="tok-o">.</span><span class="tok-na">a</span><span class="tok-o">.</span><span class="tok-na">b</span><span class="tok-o">.</span><span class="tok-na">c</span> <span class="tok-o">==</span> <span class="tok-mi">1</span>

<span class="tok-c1">//Protección con cortocircuito</span>
<span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">mapa</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-n">mapa</span><span class="tok-o">.</span><span class="tok-na">a</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-n">mapa</span><span class="tok-o">.</span><span class="tok-na">a</span><span class="tok-o">.</span><span class="tok-na">x</span><span class="tok-o">){</span>
    <span class="tok-k">assert</span> <span class="tok-n">mapa</span><span class="tok-o">.</span><span class="tok-na">a</span><span class="tok-o">.</span><span class="tok-na">x</span><span class="tok-o">.</span><span class="tok-na">c</span> <span class="tok-o">==</span> <span class="tok-kc">null</span>
<span class="tok-o">}</span>

<span class="tok-c1">//Protección con un bloque try/catch</span>
<span class="tok-k">try</span><span class="tok-o">{</span>
    <span class="tok-k">assert</span> <span class="tok-n">mapa</span><span class="tok-o">.</span><span class="tok-na">a</span><span class="tok-o">.</span><span class="tok-na">x</span><span class="tok-o">.</span><span class="tok-na">c</span> <span class="tok-o">==</span> <span class="tok-kc">null</span>
<span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">NullPointerException</span> <span class="tok-n">npe</span><span class="tok-o">){}</span>

<span class="tok-c1">//Protección con el operador ?.</span>
<span class="tok-k">assert</span> <span class="tok-n">mapa</span><span class="tok-o">?.</span><span class="tok-na">a</span><span class="tok-o">?.</span><span class="tok-na">x</span><span class="tok-o">?.</span><span class="tok-na">c</span> <span class="tok-o">==</span> <span class="tok-kc">null</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En el ejemplo, estamos intentando acceder a una propiedad que no existe como es <em>mapa.a.x</em>. Antes de acceder a dicha propiedad, protegemos el acceso para comprobar que no sea <em>null</em> y en caso de que no lo sea, acceder a su valor. Aparecen tres tipos de protección de este tipo de errores. La comprobación en cortocircuito con un bloque <em>if</em>, es decir, que cuando se detecte una condición de la expresión que sea falsa, nos salimos del if. En segundo lugar, intentamos proteger el acceso erróneo con un bloque <em>try/catch</em>. Y por último, con el operador <em>?.</em>, el cual no es en sí una comprobación y es la opción que menos código emplea.</p>
</div>
<div class="paragraph">
<p>Por último, es necesario mencionar algo sobre los constructores en Groovy. Los constructores tienen la función de inicializar los objetos de una determinada clase y en caso de que no se especifique ningún constructor para la clase, éstos son creados directamente por el compilador. Nada que no se haga ya en Java. Sin embargo, era extraño que la gente de Groovy no hiciera algo más y así es, hay más.</p>
</div>
<div class="paragraph">
<p>Existen dos formas de llamar a los constructores de las clases creadas en Groovy. Por un lado, el método tradicional pasando parámetros de forma posicional, donde el primer parámetro significa una cosa, el segundo otra y así sucesivamente. Y por otro lado, tenemos también la posibilidad de pasar los parámetros a los constructores utilizando directamente los nombres de los campos. Esta característica surge debido a que pasar parámetros según su posición tiene el inconveniente de aquellos constructores que tienen demasiados campos y no es sencillo recordar el orden de los mismos.</p>
</div>
<div class="paragraph">
<p>Cuando creamos un objeto de una clase mediante su constructor, podemos pasarle los parámetros de tres formas diferentes en Groovy:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Mediante la forma tradicional, pasando parámetros en orden</p>
</li>
<li>
<p>Mediante la palabra reservada <em>as</em> y una lista de parámetros</p>
</li>
<li>
<p>Mediante una lista de parámetros</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Veamos un ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">Libro</span><span class="tok-o">{</span>
    <span class="tok-n">String</span> <span class="tok-n">titulo</span><span class="tok-o">,</span> <span class="tok-n">autor</span>

    <span class="tok-n">Libro</span><span class="tok-o">(</span><span class="tok-n">titulo</span><span class="tok-o">,</span> <span class="tok-n">autor</span><span class="tok-o">){</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">titulo</span> <span class="tok-o">=</span> <span class="tok-n">titulo</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">autor</span> <span class="tok-o">=</span> <span class="tok-n">autor</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span>

<span class="tok-c1">//Forma tradicional</span>
<span class="tok-kt">def</span> <span class="tok-n">primero</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Libro</span><span class="tok-o">(</span><span class="tok-s1">&#39;Groovy in action&#39;</span><span class="tok-o">,</span> <span class="tok-s1">&#39;Dierk König&#39;</span><span class="tok-o">)</span>

<span class="tok-c1">//Mediante la palabra reservada as y una lista de parámetros</span>
<span class="tok-kt">def</span> <span class="tok-n">segundo</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-s1">&#39;Groovy in action&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;Dierk König&#39;</span><span class="tok-o">]</span> <span class="tok-k">as</span> <span class="tok-n">Libro</span>

<span class="tok-c1">//Mediante una lista de parámetros</span>
<span class="tok-n">Libro</span> <span class="tok-n">tercero</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-s1">&#39;Groovy in action&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;Dierk König&#39;</span><span class="tok-o">]</span>

<span class="tok-k">assert</span> <span class="tok-n">primero</span><span class="tok-o">.</span><span class="tok-na">getTitulo</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;Groovy in action&#39;</span>
<span class="tok-k">assert</span> <span class="tok-n">segundo</span><span class="tok-o">.</span><span class="tok-na">getAutor</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;Dierk König&#39;</span>
<span class="tok-k">assert</span> <span class="tok-n">tercero</span><span class="tok-o">.</span><span class="tok-na">titulo</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;Groovy in action&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Además del motivo de tener que recordar el orden de los parámetros pasados al constructor de la clase, otra razón para utilizar este tipo de llamadas a los constructores es que podemos ahorrarnos la creación de varios constructores. Imagina el caso en que tengamos dos campos de la clase, y ambos sean opcionales. Esto supone crear cuatro constructores: sin parámetros, con uno de los campos, con el otro campo y con los dos campos. Si utilizamos este tipo de llamadas a los constructores nos ahorraremos la creación de estos cuatro constructores. Veamos el mismo caso que antes con la clase <em>Libro</em>. En el ejemplo, dejamos que Groovy cree por nosotros los constructores.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">Libro</span> <span class="tok-o">{</span>
  <span class="tok-n">String</span> <span class="tok-n">titulo</span><span class="tok-o">,</span> <span class="tok-n">autor</span>
<span class="tok-o">}</span>

<span class="tok-kt">def</span> <span class="tok-n">primero</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Libro</span><span class="tok-o">()</span>
<span class="tok-kt">def</span> <span class="tok-n">segundo</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Libro</span><span class="tok-o">(</span><span class="tok-nl">titulo:</span> <span class="tok-s1">&#39;Groovy in action&#39;</span><span class="tok-o">)</span>
<span class="tok-kt">def</span> <span class="tok-n">tercero</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Libro</span><span class="tok-o">(</span><span class="tok-nl">autor:</span> <span class="tok-s1">&#39;Dierk König&#39;</span><span class="tok-o">)</span>
<span class="tok-kt">def</span> <span class="tok-n">cuarto</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Libro</span><span class="tok-o">(</span><span class="tok-nl">titulo:</span> <span class="tok-s1">&#39;Groovy in action&#39;</span><span class="tok-o">,</span> <span class="tok-nl">autor:</span> <span class="tok-s1">&#39;Dierk König&#39;</span><span class="tok-o">)</span>

<span class="tok-k">assert</span> <span class="tok-n">primero</span><span class="tok-o">.</span><span class="tok-na">getTitulo</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-kc">null</span>
<span class="tok-k">assert</span> <span class="tok-n">segundo</span><span class="tok-o">.</span><span class="tok-na">titulo</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;Groovy in action&#39;</span>
<span class="tok-k">assert</span> <span class="tok-n">tercero</span><span class="tok-o">.</span><span class="tok-na">getAutor</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;Dierk König&#39;</span>
<span class="tok-k">assert</span> <span class="tok-n">cuarto</span><span class="tok-o">.</span><span class="tok-na">autor</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;Dierk König&#39;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_organizando_nuestras_clases_y_scripts">2.2.2. Organizando nuestras clases y scripts</h4>
<div class="paragraph">
<p>En este apartado, vamos a ver como podemos organizar nuestras clases y ficheros de la aplicación, y la relación entre ellos. También veremos la utilización de paquetes (<em>packages</em>) y el alias de tipos. Comencemos por la relación entre las clases y los ficheros fuentes.</p>
</div>
<div class="paragraph">
<p>La relación entre los ficheros fuente y las clases en Groovy no es tan estricta como en Java y los ficheros fuente en Groovy pueden contener tantas definiciones de clases como queramos, siguiente una serie de reglas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Si el fichero <em>.groovy</em> no tiene la declaración de ninguna clase, éste se trata como si fuera un <em>script</em> y automáticamente se genera una clase de tipo <em>Script</em> con el mismo nombre que el fichero <em>.groovy</em>.</p>
</li>
<li>
<p>Si el fichero <em>.groovy</em> contiene una sola clase definida con el mismo nombre que el fichero, la relación es la misma que en Java, es decir, un fichero .class por cada fichero <em>.groovy</em></p>
</li>
<li>
<p>Si el fichero <em>.groovy</em> contiene más de una clase definida, el compilador de groovy, <em>groovyc</em>, creará tantos ficheros <em>.class</em> como sean necesarios para cada una de las clases definidas en el fichero <em>.groovy</em>. Si quisiéramos llamar a nuestros scripts directamente a través de la línea de comandos, deberíamos añadir el método <em>main()</em> a la primera de las clases definidas en el fichero <em>.groovy</em>.</p>
</li>
<li>
<p>Un fichero Groovy puede mezclar la definición de clases con el código script. En este caso, el código script se convierte en la clase principal a ejecutar, con lo que no se puede declarar una clase con el mismo nombre que el fichero fuente.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Otro aspecto importante para la organización de los ficheros de nuestros proyectos en Groovy es la <strong>organización en paquetes</strong>. En este sentido, Groovy sigue el mismo convenio que Java y su organización jerárquica. De esta forma, la estructura de paquetes se corresponde con los ficheros <em>.class</em> de la estructura de directorios.</p>
</div>
<div class="paragraph">
<p>Sin embargo, como ya se ha comentado en la sesión anterior, no es necesario compilar nuestros archivos <em>.groovy</em>, con lo que se añade un problema a la hora de ejecutar dichos archivos. Si no existen los archivos compilados <em>.class</em>, ¿dónde los va a buscar? Groovy soluciona este <em>problema</em>, buscando también en los archivos <em>.groovy</em> aquellas clases necesarias. Así, que el <em>classpath</em> no sólo nos va a servir para indicar los directorios donde debe buscar los archivos <em>.class</em>, sino también para decirle donde pueden estar los archivos <em>.groovy</em>, en caso de que los archivos <em>.class</em> no estén. En el caso de que Groovy encuentre en el classpath, tanto ambos archivos, <em>.groovy</em> y <em>.class</em>, se quedará con el más reciente, y así se evitarán los problemas producidos porque se nos haya olvidado compilar nuestro archivo <em>.groovy</em>.</p>
</div>
<div class="paragraph">
<p>Al igual que en Java, las clases Groovy deben especificar su pertenencia a un paquete antes de su declaración. El siguiente fragmento de código muestra un ejemplo de un archivo con dos clases definidas que forman parte de un mismo paquete.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">negocio</span>

<span class="tok-kd">class</span> <span class="tok-nc">Cliente</span> <span class="tok-o">{</span>
  <span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">,</span> <span class="tok-n">producto</span>
  <span class="tok-n">Direccion</span> <span class="tok-n">direccion</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Direccion</span><span class="tok-o">()</span>
<span class="tok-o">}</span>

<span class="tok-kd">class</span> <span class="tok-nc">Direccion</span> <span class="tok-o">{</span>
  <span class="tok-n">String</span> <span class="tok-n">calle</span><span class="tok-o">,</span> <span class="tok-n">ciudad</span><span class="tok-o">,</span> <span class="tok-n">provincia</span><span class="tok-o">,</span> <span class="tok-n">pais</span><span class="tok-o">,</span> <span class="tok-n">codigopostal</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para poder utilizar las clases declaradas <em>Cliente</em> y <em>Direccion</em>, debemos <em>importar</em> el paquete correspondiente <em>negocio</em>, tal y como aparece en el siguiente ejemplo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">import</span> <span class="tok-nn">negocio.*</span>

<span class="tok-kt">def</span> <span class="tok-n">clienteua</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Cliente</span><span class="tok-o">()</span>
<span class="tok-n">clienteua</span><span class="tok-o">.</span><span class="tok-na">nombre</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;Universidad de Alicante&#39;</span>
<span class="tok-n">clienteua</span><span class="tok-o">.</span><span class="tok-na">producto</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;Pizarras digitales&#39;</span>

<span class="tok-k">assert</span> <span class="tok-n">clienteua</span><span class="tok-o">.</span><span class="tok-na">getNombre</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;Universidad de Alicante&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El último aspecto importante a comentar en cuanto a la organización de las clases y los archivos de nuestras aplicaciones, se refiere a la posibilidad de establecer alias a los paquetes importados. Imaginad el caso de tener dos paquetes procedentes de terceras partes que contengan una clase con el mismo nombre. En Groovy podemos solucionar este conflicto de nomenclatura utilizando los alias. Veamos como:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">import</span> <span class="tok-nn">agenteexterno1.OtraClase</span> <span class="tok-k">as</span> <span class="tok-n">OtraClase1</span>
<span class="tok-kn">import</span> <span class="tok-nn">agenteexterno2.OtraClase</span> <span class="tok-k">as</span> <span class="tok-n">OtraClase2</span>

<span class="tok-kt">def</span> <span class="tok-n">otraClase1</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">OtraClase1</span><span class="tok-o">()</span>
<span class="tok-kt">def</span> <span class="tok-n">otraClase2</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">OtraClase2</span><span class="tok-o">()</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_características_avanzadas_del_modelo_orientado_a_objetos">2.2.3. Características avanzadas del modelo orientado a objetos</h4>
<div class="paragraph">
<p>Ahora que ya tenemos unos conocimientos básicos de lo que Groovy nos permite en cuanto al modelo orientado a objetos, pasemos a ver conceptos algo más avanzados de los vistos hasta ahora, como son la <em>herencia</em>, los <em>interfaces</em> y los <em>multimétodos</em>.</p>
</div>
<div class="paragraph">
<p>Cuando hablamos de <strong>herencia</strong> en el modelo orientado a objetos, nos referimos a la posibilidad de añadir campos y métodos a una clase a partir de una clase base. Groovy permite la herencia en los mismos términos que lo hace Java. Es más, una clase Groovy puede extender una clase Java y viceversa.</p>
</div>
<div class="paragraph">
<p>Groovy también soporta el modelo de <em>interfaces</em> de Java. En Java, un interface es una clase especial en la que todos sus métodos son abstractos y públicos. Sin embargo, estos métodos no están implementados en la clase interface, sino que esa labor se deja para la clase que implemente esa interface. Los interfaces son lo más parecido a la herencia múltiple, ya que una clase puede implementar más de un interface pero sólo puede extender una clase.</p>
</div>
<div class="paragraph">
<p>Por último, comentar que en Groovy el tipo de los datos se elige de manera dinámica cuando éstos son pasados como parámetros a los métodos de nuestras clases. Esta característica de Groovy se le conoce como <em>multimétodo</em> y lo mejor es que veamos un ejemplo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-nf">multimetodo</span><span class="tok-o">(</span><span class="tok-n">Object</span> <span class="tok-n">o</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-s1">&#39;objeto&#39;</span> <span class="tok-o">}</span>
<span class="tok-kt">def</span> <span class="tok-nf">multimetodo</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">o</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-s1">&#39;string&#39;</span> <span class="tok-o">}</span>

<span class="tok-n">Object</span> <span class="tok-n">x</span> <span class="tok-o">=</span> <span class="tok-mi">1</span>
<span class="tok-n">Object</span> <span class="tok-n">y</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;foo&#39;</span>

<span class="tok-k">assert</span> <span class="tok-s1">&#39;objeto&#39;</span> <span class="tok-o">==</span> <span class="tok-n">multimetodo</span><span class="tok-o">(</span><span class="tok-n">x</span><span class="tok-o">)</span>
<span class="tok-k">assert</span> <span class="tok-s1">&#39;string&#39;</span> <span class="tok-o">==</span> <span class="tok-n">multimetodo</span><span class="tok-o">(</span><span class="tok-n">y</span><span class="tok-o">)</span><span class="tok-c1">//En Java, esta llamada hubiera devuelto la palabra &#39;objeto&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En el ejemplo anterior, el tipo de datos estático de la variable <em>x</em> es <em>Object</em> mientras que su tipo dinámico es <em>Integer</em>, mientras que el tipo estático de <em>y</em> es <em>Object</em> mientras que su tipo dinámico es <em>String</em>. Debido a que Groovy intenta utilizar el tipo dinámico de las variables, en el segundo caso se ejecuta el método que tiene como parámetro una variable de tipo String.</p>
</div>
</div>
<div class="sect3">
<h4 id="_groovybeans_2">2.2.4. GroovyBeans</h4>
<div class="paragraph">
<p>En Java, los JavaBeans se introdujeron en su momento para definir un modelo de componentes para la construcción de aplicaciones Java. Básicamente el modelo consiste en una serie de convenciones en cuanto a los nombres que permiten a las clases Java comunicarse unas con otras. Groovy utiliza también el concepto inherente a los JavaBeans, pero lo transforma para dar paso a los GroovyBeans, con unas mejoras particulares, como facilitar el acceso a los métodos. Vayamos paso a paso.</p>
</div>
<div class="paragraph">
<p>Empecemos por la declaración de los GroovyBeans. Imaginemos que tenemos de nuevo la clase Libro con tan solo la propiedad título. En Java tendríamos el siguiente JavaBean:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Libro</span> <span class="tok-kd">implements</span> <span class="tok-n">java</span><span class="tok-o">.</span><span class="tok-na">io</span><span class="tok-o">.</span><span class="tok-na">Serializable</span> <span class="tok-o">{</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">titulo</span><span class="tok-o">;</span>

    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getTitulo</span><span class="tok-o">(){</span>
        <span class="tok-k">return</span> <span class="tok-n">titulo</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setTitulo</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">valor</span><span class="tok-o">){</span>
        <span class="tok-n">titulo</span> <span class="tok-o">=</span> <span class="tok-n">valor</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Mientras que en Groovy, simplemente necesitaríamos tener esto otro:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">Libro</span> <span class="tok-kd">implements</span> <span class="tok-n">java</span><span class="tok-o">.</span><span class="tok-na">io</span><span class="tok-o">.</span><span class="tok-na">Serializable</span> <span class="tok-o">{</span>
  <span class="tok-n">String</span> <span class="tok-n">titulo</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Las diferencias son evidentes, ¿no crees? Pero no sólo es una cuestión de ahorro en código, sino también de eficiencia. Imagina simplemente que por cualquier motivo, tuvieras que cambiar el nombre al campo <em>titulo</em>, ese simple cambio en Java supondría cambiar el código en tres lugares diferentes, sin embargo, en Groovy, simplemente cambiando el nombre de la propiedad lo tendríamos todo. Además, Groovy también nos ahorra tener que escribir los métodos <em>setTitulo()</em> y <em>getTitulo()</em>. Esto lo hace únicamente cuando no se han especificado dichos métodos en el GroovyBean. Además, Groovy sabe perfectamente cuando debe especificar un método <em>set</em> para acceder a una propiedad. Por ejemplo, si establecemos que una propiedad de nuestro GroovyBean es <em>final</em>, esta propiedad solamente será de lectura, así que Groovy no implementa su correspondiente método <em>set</em>.</p>
</div>
<div class="paragraph">
<p>De igual forma, Groovy también permite el acceso a las propiedades utilizando el operador ., como por ejemplo <em>libro.titulo = 'Groovy in action'</em>. Pero, como siempre, hay algo más. Observemos detenidamente el siguiente ejemplo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">Persona</span> <span class="tok-o">{</span>
    <span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">,</span> <span class="tok-n">apellidos</span>

    <span class="tok-n">String</span> <span class="tok-nf">getNombreCompleto</span><span class="tok-o">(){</span>
        <span class="tok-k">return</span> <span class="tok-s2">&quot;$nombre $apellidos&quot;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span>

<span class="tok-kt">def</span> <span class="tok-n">juan</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Persona</span><span class="tok-o">(</span><span class="tok-nl">nombre:</span><span class="tok-s2">&quot;Juan&quot;</span><span class="tok-o">)</span>
<span class="tok-n">juan</span><span class="tok-o">.</span><span class="tok-na">apellidos</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;Martínez&quot;</span>

<span class="tok-k">assert</span> <span class="tok-n">juan</span><span class="tok-o">.</span><span class="tok-na">nombreCompleto</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;Juan Martínez&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Tenemos el método <em>getNombreCompleto()</em> para obtener el nombre completo de la persona en cuestión. Pues Groovy además, crea al vuelo una propiedad equivalente al método <em>get()</em>, en nuestro caso, <em>nombreCompleto</em>.</p>
</div>
<div class="paragraph">
<p>En ocasiones, los métodos <em>get()</em> no tienen porque devolver el valor concreto del campo en cuestión, sino que es posible que hayan hecho algún tratamiento sobre dicho campo para modificar el valor devuelto. Imaginemos una clase que duplique el valor de su única propiedad cuando se invoca por los métodos tradicionales (bien mediante el método get o mediante el operador .).</p>
</div>
<div class="paragraph">
<p>Además, Groovy también nos ofrece la posibilidad de recuperar el valor original del campo sin pasar por su correspondiente getter con el operador <em>@</em>, tal y como aparece en la última línea de este ejemplo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">DobleValor</span> <span class="tok-o">{</span>
    <span class="tok-kt">def</span> <span class="tok-n">valor</span>

    <span class="tok-kt">void</span> <span class="tok-nf">setValor</span><span class="tok-o">(</span><span class="tok-n">valor</span><span class="tok-o">){</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">valor</span> <span class="tok-o">=</span> <span class="tok-n">valor</span>
    <span class="tok-o">}</span>

    <span class="tok-kt">def</span> <span class="tok-nf">getValor</span><span class="tok-o">(){</span>
        <span class="tok-n">valor</span> <span class="tok-o">*</span> <span class="tok-mi">2</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span>

<span class="tok-kt">def</span> <span class="tok-n">doble</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">DobleValor</span><span class="tok-o">(</span><span class="tok-nl">valor:</span> <span class="tok-mi">300</span><span class="tok-o">)</span>

<span class="tok-k">assert</span> <span class="tok-mi">600</span> <span class="tok-o">==</span> <span class="tok-n">doble</span><span class="tok-o">.</span><span class="tok-na">getValor</span><span class="tok-o">()</span>
<span class="tok-k">assert</span> <span class="tok-mi">600</span> <span class="tok-o">==</span> <span class="tok-n">doble</span><span class="tok-o">.</span><span class="tok-na">valor</span>
<span class="tok-k">assert</span> <span class="tok-mi">300</span> <span class="tok-o">==</span> <span class="tok-n">doble</span><span class="tok-o">.</span><span class="tok-nd">@valor</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_operador_2">2.2.5. Operador *</h4>
<div class="paragraph">
<p>Groovy presenta además, otra característica conocida como el operador <em>spread *</em>. Este operador permite pasar una lista a un método que contiene una serie de parámetros. De esta forma, se consigue en cierta forma sobrecargar el método en cuestión como si permitiese también la introducción de sus parámetros en forma de lista. Veamos un ejemplo. Imagina que tienes un método que devuelve una lista de resultados, los cuales deben pasados uno por uno a otro método.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-nf">getLista</span><span class="tok-o">(){</span>
    <span class="tok-k">return</span> <span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">]</span>
<span class="tok-o">}</span>

<span class="tok-kt">def</span> <span class="tok-nf">suma</span><span class="tok-o">(</span><span class="tok-n">a</span><span class="tok-o">,</span> <span class="tok-n">b</span><span class="tok-o">,</span> <span class="tok-n">c</span><span class="tok-o">,</span> <span class="tok-n">d</span><span class="tok-o">,</span> <span class="tok-n">e</span><span class="tok-o">){</span>
    <span class="tok-k">return</span> <span class="tok-n">a</span> <span class="tok-o">+</span> <span class="tok-n">b</span> <span class="tok-o">+</span> <span class="tok-n">c</span> <span class="tok-o">+</span> <span class="tok-n">d</span> <span class="tok-o">+</span> <span class="tok-n">e</span>
<span class="tok-o">}</span>

<span class="tok-k">assert</span> <span class="tok-mi">15</span> <span class="tok-o">==</span> <span class="tok-n">suma</span><span class="tok-o">(*</span><span class="tok-n">lista</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Sencillo, y sin tener que destripar la lista en varios parámetros.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_metaprogramación">2.3. Metaprogramación</h3>
<div class="sect3">
<h4 id="_definición_de_metaprogramación">2.3.1. Definición de metaprogramación</h4>
<div class="paragraph">
<p>Según Wikipedia:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Definición de Metaprogramación</strong></p>
</div>
<div class="paragraph">
<p>La metaprogramación consiste en escribir programas que escriben o manipulen otros programas (o a sí mismos) como datos, o que hacen en tiempo de compilación parte del trabajo que, de otra forma, se haría en tiempo de ejecución. Esto permite al programador ahorrar tiempo en la producción de código.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Básicamente esto significa que en tiempo de ejecución nuestro programa podrá cambiar su funcionamiento sin necesidad de ser compilado nuevamente.</p>
</div>
</div>
<div class="sect3">
<h4 id="_metaprogramación_en_groovy">2.3.2. Metaprogramación en Groovy</h4>
<div class="paragraph">
<p>Entre las mejores cualidades de Groovy como lenguaje de programación destaca las facilidades que presenta para realizar dicha metaprogramación. ¿Y cuáles son estas características?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Todo método de cualquier objecto invocado desde Groovy pasa por un intermediario (MOP - MetaObjectProtocol)</p>
</li>
<li>
<p>Posibilidad de interceptar llamadas a métodos o acceso a propiedades</p>
</li>
<li>
<p>Crear y modificar métodos en tiempo de ejecución para por ejemplo extender directamente la clase <em>java.lang.String</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Pero veamos algún ejemplo de lo que podemos hacer con metaprogramación en Groovy.</p>
</div>
</div>
<div class="sect3">
<h4 id="_clase_expando">2.3.3. Clase Expando</h4>
<div class="paragraph">
<p>Groovy dispone de una clase llamada <em>Expando (<a href="http://groovy.codehaus.org/api/groovy/util/Expando.html" class="bare">http://groovy.codehaus.org/api/groovy/util/Expando.html</a>)</em>. Esta es una clase especial de Groovy que nos permitirá añadir métodos, constructores, propiedades y métodos estáticos utilizando una sintaxis basada en closures, tal y como demuestra el siguiente ejemplo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">miExpando</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Expando</span><span class="tok-o">()</span>

<span class="tok-n">miExpando</span><span class="tok-o">.</span><span class="tok-na">factor</span> <span class="tok-o">=</span> <span class="tok-mi">5</span>

<span class="tok-n">miExpando</span><span class="tok-o">.</span><span class="tok-na">multiplica</span> <span class="tok-o">=</span> <span class="tok-o">{</span> <span class="tok-n">a</span> <span class="tok-o">-&gt;</span> <span class="tok-n">factor</span> <span class="tok-o">*</span> <span class="tok-n">a</span> <span class="tok-o">}</span>

<span class="tok-k">assert</span> <span class="tok-n">miExpando</span><span class="tok-o">.</span><span class="tok-na">multiplica</span><span class="tok-o">(</span><span class="tok-mi">4</span><span class="tok-o">)</span> <span class="tok-o">==</span> <span class="tok-mi">20</span>

<span class="tok-k">assert</span> <span class="tok-n">miExpando</span><span class="tok-o">.</span><span class="tok-na">resto</span> <span class="tok-o">==</span> <span class="tok-kc">null</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>¿Mágia? Por supuesto que no. Esto es lo que realmente está pasando.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">miExpando</span><span class="tok-o">.</span><span class="tok-na">factor</span> <span class="tok-o">=</span> <span class="tok-mi">5</span>
<span class="tok-c1">//Realmente...</span>
<span class="tok-n">miExpando</span><span class="tok-o">.</span><span class="tok-na">setProperty</span><span class="tok-o">(</span><span class="tok-s1">&#39;factor&#39;</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">)</span>

<span class="tok-n">miExpando</span><span class="tok-o">.</span><span class="tok-na">factor</span>
<span class="tok-c1">//Realmente...</span>
<span class="tok-n">miExpando</span><span class="tok-o">.</span><span class="tok-na">getProperty</span><span class="tok-o">(</span><span class="tok-s1">&#39;factor&#39;</span><span class="tok-o">)</span>

<span class="tok-n">miExpando</span><span class="tok-o">.</span><span class="tok-na">multiplica</span><span class="tok-o">(</span><span class="tok-mi">4</span><span class="tok-o">)</span>
<span class="tok-c1">//Realmente...</span>
<span class="tok-n">miExpando</span><span class="tok-o">.</span><span class="tok-na">invokeMethod</span><span class="tok-o">(</span><span class="tok-s1">&#39;multiplica&#39;</span><span class="tok-o">,</span> <span class="tok-o">[</span><span class="tok-mi">4</span><span class="tok-o">]</span> <span class="tok-k">as</span> <span class="tok-n">Object</span><span class="tok-o">[])</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Veamos otro ejemplo de lo que supone la metaprogramación en Groovy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">MiExpando</span> <span class="tok-o">{</span>
    <span class="tok-kd">private</span> <span class="tok-n">dynamicProperties</span> <span class="tok-o">=</span> <span class="tok-o">[:]</span>

    <span class="tok-kt">void</span> <span class="tok-nf">setProperty</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">propName</span><span class="tok-o">,</span> <span class="tok-n">val</span><span class="tok-o">){</span>
        <span class="tok-n">dynamicProperties</span><span class="tok-o">[</span><span class="tok-n">propName</span><span class="tok-o">]</span> <span class="tok-o">=</span> <span class="tok-n">val</span>
    <span class="tok-o">}</span>

    <span class="tok-kt">def</span> <span class="tok-nf">getProperty</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">propName</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">dynamicProperties</span><span class="tok-o">[</span><span class="tok-n">propName</span><span class="tok-o">]</span>
    <span class="tok-o">}</span>

    <span class="tok-kt">def</span> <span class="tok-nf">methodMissing</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">methodName</span><span class="tok-o">,</span> <span class="tok-n">args</span><span class="tok-o">){</span>
        <span class="tok-kt">def</span> <span class="tok-n">prop</span> <span class="tok-o">=</span> <span class="tok-n">dynamicProperties</span><span class="tok-o">[</span><span class="tok-n">methodName</span><span class="tok-o">]</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">prop</span> <span class="tok-k">instanceof</span> <span class="tok-n">Closure</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-k">return</span> <span class="tok-nf">prop</span><span class="tok-o">(*</span><span class="tok-n">args</span><span class="tok-o">)</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span>

<span class="tok-kt">def</span> <span class="tok-n">miExpando</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">MiExpando</span><span class="tok-o">()</span>
<span class="tok-n">miExpando</span><span class="tok-o">.</span><span class="tok-na">a</span> <span class="tok-o">=</span> <span class="tok-mi">4</span>
<span class="tok-n">miExpando</span><span class="tok-o">.</span><span class="tok-na">b</span> <span class="tok-o">=</span> <span class="tok-mi">5</span>
<span class="tok-n">miExpando</span><span class="tok-o">.</span><span class="tok-na">suma</span> <span class="tok-o">=</span> <span class="tok-o">{</span> <span class="tok-n">x</span><span class="tok-o">,</span> <span class="tok-n">y</span> <span class="tok-o">-&gt;</span> <span class="tok-n">x</span> <span class="tok-o">+</span> <span class="tok-n">y</span> <span class="tok-o">}</span>

<span class="tok-k">assert</span> <span class="tok-n">miExpando</span><span class="tok-o">.</span><span class="tok-na">a</span> <span class="tok-o">==</span> <span class="tok-mi">4</span>
<span class="tok-k">assert</span> <span class="tok-n">miExpando</span><span class="tok-o">.</span><span class="tok-na">b</span> <span class="tok-o">==</span> <span class="tok-mi">5</span>
<span class="tok-k">assert</span> <span class="tok-n">miExpando</span><span class="tok-o">.</span><span class="tok-na">suma</span><span class="tok-o">(</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Como podrás imaginar, la nueva clase <em>MiExpando</em> que acabamos de crear tiene la misma funcionalidad que la clase de Groovy <em>Expando</em>. Por supuesto, la magia reside en los métodos <em>setProperty(String, Object)</em>, <em>getProperty(String)</em> y <em>methodMissing(String, Object[])</em>. Cuando en Groovy se realiza una llamada a un método que no existe, se intenta llamar al método <em>methodMissing(String, Object[])</em> con lo que si sobrecargamos ese método vamos a poder hacer cualquier cosa, como por ejemplo invocar un closure o bien escribir un log indicando que alguien ha llamada a un método que no existe.</p>
</div>
</div>
<div class="sect3">
<h4 id="_objeto_delegate">2.3.4. Objeto delegate</h4>
<div class="paragraph">
<p>Todo closure tiene asociado un objeto conocido como <em>delegate</em> que puede ser cualquier tipo de objeto y es la forma de tener un objeto que responda a determinadas llamadas a métodos y propiedades.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">miclosure</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
    <span class="tok-n">concat</span> <span class="tok-s2">&quot; Mundo!&quot;</span>
<span class="tok-o">}</span>

<span class="tok-kt">def</span> <span class="tok-n">s</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;Hola&quot;</span>
<span class="tok-n">miclosure</span><span class="tok-o">.</span><span class="tok-na">delegate</span> <span class="tok-o">=</span> <span class="tok-n">s</span>
<span class="tok-k">assert</span> <span class="tok-n">miclosure</span><span class="tok-o">.</span><span class="tok-na">call</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;Hola Mundo!&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pero, ¿qué pasaría si tuviéramos un método <em>concat(String)</em>? ¿Cuál de los dos métodos se ejecutaría al realizar la llamada desde el closure?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-nf">concat</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">arg</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-k">return</span> <span class="tok-s2">&quot;Concat llamado con arg = $arg&quot;</span>
<span class="tok-o">}</span>

<span class="tok-kt">def</span> <span class="tok-n">miclosure</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
    <span class="tok-n">concat</span> <span class="tok-s2">&quot; Mundo!&quot;</span>
<span class="tok-o">}</span>

<span class="tok-kt">def</span> <span class="tok-n">s</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;Hola&quot;</span>
<span class="tok-n">miclosure</span><span class="tok-o">.</span><span class="tok-na">delegate</span> <span class="tok-o">=</span> <span class="tok-n">s</span>
<span class="tok-k">assert</span> <span class="tok-n">miclosure</span><span class="tok-o">.</span><span class="tok-na">call</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;Concat llamado con arg =  Mundo!&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Como véis, el método invocado ha sido el que hemos creado con lo que el objeto <em>delegate</em> no ha sido contemplado dentro del closure a la hora de invocar el método <em>concat(String)</em>. Aquí es donde surge el concepto de la estrategia que tienen los closures para resolver las llamadas a métodos y tenemos cuatro estrategías diferentes: <em>OWNER_FIRST</em>, <em>DELEGATE_FIRST</em>, <em>OWNER_ONLY</em> y <em>DELEGATE_ONLY</em> y en función de que estrategía se utilice, la llamada al método concat se resolverá de una forma u otra. Por defecto, la estrategia seguida si no se indica otra es <em>OWNER_FIRST</em>. Comentar también que cada closure tiene un <em>owner (propietario)</em> y que siempre es aquel objeto o clase que cree el closure.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-nf">concat</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">arg</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-k">return</span> <span class="tok-s2">&quot;Concat llamado con arg = $arg&quot;</span>
<span class="tok-o">}</span>

<span class="tok-kt">def</span> <span class="tok-n">miclosure</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
    <span class="tok-n">concat</span> <span class="tok-s2">&quot; Mundo!&quot;</span>
<span class="tok-o">}</span>

<span class="tok-kt">def</span> <span class="tok-n">s</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;Hola&quot;</span>
<span class="tok-n">miclosure</span><span class="tok-o">.</span><span class="tok-na">delegate</span> <span class="tok-o">=</span> <span class="tok-n">s</span>

<span class="tok-k">assert</span> <span class="tok-n">miclosure</span><span class="tok-o">.</span><span class="tok-na">resolveStrategy</span> <span class="tok-o">==</span> <span class="tok-n">Closure</span><span class="tok-o">.</span><span class="tok-na">OWNER_FIRST</span>
<span class="tok-k">assert</span> <span class="tok-n">miclosure</span><span class="tok-o">.</span><span class="tok-na">call</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;Concat llamado con arg =  Mundo!&quot;</span>

<span class="tok-n">miclosure</span><span class="tok-o">.</span><span class="tok-na">resolveStrategy</span> <span class="tok-o">=</span> <span class="tok-n">Closure</span><span class="tok-o">.</span><span class="tok-na">OWNER_FIRST</span>
<span class="tok-k">assert</span> <span class="tok-n">miclosure</span><span class="tok-o">.</span><span class="tok-na">call</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;Concat llamado con arg =  Mundo!&quot;</span>

<span class="tok-n">miclosure</span><span class="tok-o">.</span><span class="tok-na">resolveStrategy</span> <span class="tok-o">=</span> <span class="tok-n">Closure</span><span class="tok-o">.</span><span class="tok-na">DELEGATE_FIRST</span>
<span class="tok-k">assert</span> <span class="tok-n">miclosure</span><span class="tok-o">.</span><span class="tok-na">call</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;Hola Mundo!&quot;</span>

<span class="tok-n">miclosure</span><span class="tok-o">.</span><span class="tok-na">resolveStrategy</span> <span class="tok-o">=</span> <span class="tok-n">Closure</span><span class="tok-o">.</span><span class="tok-na">OWNER_ONLY</span>
<span class="tok-k">assert</span> <span class="tok-n">miclosure</span><span class="tok-o">.</span><span class="tok-na">call</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;Concat llamado con arg =  Mundo!&quot;</span>

<span class="tok-n">miclosure</span><span class="tok-o">.</span><span class="tok-na">resolveStrategy</span> <span class="tok-o">=</span> <span class="tok-n">Closure</span><span class="tok-o">.</span><span class="tok-na">DELEGATE_ONLY</span>
<span class="tok-k">assert</span> <span class="tok-n">miclosure</span><span class="tok-o">.</span><span class="tok-na">call</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;Hola Mundo!&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Comentar por último que, el object <em>delegate</em> por defecto de cualquier closure siempre será el propietario del closure.</p>
</div>
</div>
<div class="sect3">
<h4 id="_metaclass">2.3.5. Metaclass</h4>
<div class="paragraph">
<p>Toda clase creada en Groovy tiene un objeto asociado conocido como <em>metaClass</em>. Este objeto es del tipo <em>MetaClassImpl (<a href="http://groovy.codehaus.org/gapi/groovy/lang/MetaClassImpl.html" class="bare">http://groovy.codehaus.org/gapi/groovy/lang/MetaClassImpl.html</a>)</em> y gracias a él vamos a poder por ejemplo extender en tiempo de ejecución cualquier clase, como por ejemplo <em>java.lang.String</em>.</p>
</div>
<div class="paragraph">
<p>Habitualmente, en cualquier proyecto con Groovy tendremos una clase llamada StringUtils donde solemos meter todo tipo de métodos estáticos para realizar operaciones sobre las cadenas de caracteres. Sin embargo, con Groovy vamos a poder extender la clase <em>java.lang.String</em> sin necesidad de crear una nueva clase extendida. Para ello utilizaremos el objeto <em>metaClass</em> que, recordad, tienen todos las clases creadas en Groovy.</p>
</div>
<div class="paragraph">
<p>En el siguiente ejemplo vamos a modificar en tiempo de ejecución la clase <em>java.lang.String</em> para añadir un nuevo método que corte aquellas cadenas de caracteres a los primeros 140 caracteres.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">textoLargo</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;&quot;&quot;La metaprogramación consiste en escribir programas que escriben o manipulan otros programas</span>
<span class="tok-s2">(o a sí mismos) como datos, o que hacen en tiempo de compilación parte del trabajo que, de</span>
<span class="tok-s2">otra forma, se haría en tiempo de ejecución. Esto permite al programador ahorrar tiempo en</span>
<span class="tok-s2">la producción de código.&quot;&quot;&quot;</span>

<span class="tok-kt">def</span> <span class="tok-n">textoCorto</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;La metaprogramación consiste en escribir programas que escriben o manipulan otros programas&quot;</span>

<span class="tok-k">assert</span> <span class="tok-n">textoLargo</span> <span class="tok-k">instanceof</span> <span class="tok-n">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">String</span>
<span class="tok-k">assert</span> <span class="tok-n">textoCorto</span> <span class="tok-k">instanceof</span> <span class="tok-n">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">String</span>


<span class="tok-n">String</span><span class="tok-o">.</span><span class="tok-na">metaClass</span><span class="tok-o">.</span><span class="tok-na">cortaLosPrimeros140Caracteres</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
    <span class="tok-n">delegate</span><span class="tok-o">.</span><span class="tok-na">size</span><span class="tok-o">()</span> <span class="tok-o">&gt;=</span> <span class="tok-mi">140</span> <span class="tok-o">?</span> <span class="tok-s2">&quot;${delegate.take(137)}...&quot;</span> <span class="tok-o">:</span> <span class="tok-n">delegate</span>
<span class="tok-o">}</span>

<span class="tok-n">println</span> <span class="tok-n">textoLargo</span><span class="tok-o">.</span><span class="tok-na">cortaLosPrimeros140Caracteres</span><span class="tok-o">()</span>
<span class="tok-n">println</span> <span class="tok-n">textoCorto</span><span class="tok-o">.</span><span class="tok-na">cortaLosPrimeros140Caracteres</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Además de las clases, las objetos creados en Groovy también tienen el objeto <em>metaClass</em> con lo que en ocasiones es posible que nos interese simplemente modificar el comportamiento de un sólo objeto y no de todos los objetos de una determinada clase. Esto nos será de gran utilidad cuando veamos la parte de los tests unitarios en Grails.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">texto1</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;texto 1&quot;</span>
<span class="tok-kt">def</span> <span class="tok-n">texto2</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;texto 2&quot;</span>

<span class="tok-n">texto1</span><span class="tok-o">.</span><span class="tok-na">metaClass</span><span class="tok-o">.</span><span class="tok-na">foo</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
    <span class="tok-s2">&quot;${delegate}foo&quot;</span>
<span class="tok-o">}</span>

<span class="tok-k">assert</span> <span class="tok-n">texto1</span><span class="tok-o">.</span><span class="tok-na">foo</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;texto 1foo&quot;</span>

<span class="tok-k">try</span> <span class="tok-o">{</span>
    <span class="tok-k">assert</span> <span class="tok-n">texto2</span><span class="tok-o">.</span><span class="tok-na">foo</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;texto 2foo&quot;</span>
<span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">MissingMethodException</span> <span class="tok-n">mme</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-n">println</span> <span class="tok-s2">&quot;El método foo no existe&quot;</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Es importante saber, que cuando no necesitemos los métodos especifados en el objeto <em>metaClass</em> debemos referenciar dicho objeto a <em>null</em> para evitar problemas.</p>
</div>
<div class="paragraph">
<p>Además de poder crear nuevo métodos, también vamos a poder sobreescribir aquellos ya existentes en la propia clase por nuestra propia implementación. En el siguiente ejemplo vamos a modificar el comportamiento del método <em>substring(int beginIndex)</em> de la clase <em>java.lang.String</em> para que el índice pasado por parámetro empiece por el número 1.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">texto</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;En Groovy podemos sobreescribir métodos ya existentes&quot;</span>

<span class="tok-kt">def</span> <span class="tok-n">textoZeroBased</span> <span class="tok-o">=</span> <span class="tok-n">texto</span><span class="tok-o">.</span><span class="tok-na">substring</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">)</span>

<span class="tok-n">String</span><span class="tok-o">.</span><span class="tok-na">metaClass</span><span class="tok-o">.</span><span class="tok-na">substring</span> <span class="tok-o">=</span> <span class="tok-o">{</span> <span class="tok-kt">int</span> <span class="tok-n">beginIndex</span> <span class="tok-o">-&gt;</span>
      <span class="tok-n">delegate</span><span class="tok-o">[</span><span class="tok-n">beginIndex</span><span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-o">..</span><span class="tok-na">delegate</span><span class="tok-o">.</span><span class="tok-na">size</span><span class="tok-o">()-</span><span class="tok-mi">1</span><span class="tok-o">]</span>
<span class="tok-o">}</span>

<span class="tok-kt">def</span> <span class="tok-n">textoOneBased</span> <span class="tok-o">=</span> <span class="tok-n">texto</span><span class="tok-o">.</span><span class="tok-na">substring</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)</span>

<span class="tok-k">assert</span> <span class="tok-n">textoOneBased</span> <span class="tok-o">==</span> <span class="tok-n">textoZeroBased</span>

<span class="tok-n">String</span><span class="tok-o">.</span><span class="tok-na">metaClass</span> <span class="tok-o">=</span> <span class="tok-kc">null</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si lo que estamos sobrecargando es un método estático, debemos hacer referencia a la metaclase de la siguiente forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">String</span><span class="tok-o">.</span><span class="tok-na">metaClass</span><span class="tok-o">.</span><span class="tok-s1">&#39;static&#39;</span><span class="tok-o">.</span><span class="tok-na">valueOf</span> <span class="tok-o">=</span> <span class="tok-o">{</span> <span class="tok-n">Boolean</span> <span class="tok-n">b</span> <span class="tok-o">-&gt;</span>
    <span class="tok-n">b</span> <span class="tok-o">?</span> <span class="tok-s2">&quot;false&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;true&quot;</span>
<span class="tok-o">}</span>

<span class="tok-k">assert</span> <span class="tok-s2">&quot;false&quot;</span> <span class="tok-o">==</span> <span class="tok-n">String</span><span class="tok-o">.</span><span class="tok-na">valueOf</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">)</span>
<span class="tok-k">assert</span> <span class="tok-s2">&quot;true&quot;</span> <span class="tok-o">==</span> <span class="tok-n">String</span><span class="tok-o">.</span><span class="tok-na">valueOf</span><span class="tok-o">(</span><span class="tok-kc">false</span><span class="tok-o">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_groovy_builders">2.4. Groovy Builders</h3>
<div class="paragraph">
<p>Los <em>Builders</em> en Groovy se utilizan para hacer que determinadas tareas complejas se conviertan en un juego de niños. Con ellos veremos que la construcción de archivos XML, la automatización de tareas con Ant o el diseño de interfaces gráficas se facilita muchísimo. Veremos como generar archivo XML y JSON gracias a estos builders.</p>
</div>
<div class="sect3">
<h4 id="_markupbuilder">2.4.1. MarkupBuilder</h4>
<div class="paragraph">
<p>Los archivos XML son un tipo de archivo ampliamente extendido para el intercambio de información entre aplicaciones, así que Groovy quiere ayudarnos en esa labor, tratando que escribamos el código para construir esos archivos XML de la forma más sencilla y clara posible y el <em>builder</em> encargado de esa labor es <em>MarkupBuilder</em>, el cual nos ayudará a escribir tanto archivos XML como HTML.</p>
</div>
<div class="paragraph">
<p>El ejemplo que vamos a ver consiste en crear un archivo XML referido a facturas de una empresa. Cada factura contendrá una serie de ítems, cada uno con un producto.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">builder</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">groovy</span><span class="tok-o">.</span><span class="tok-na">xml</span><span class="tok-o">.</span><span class="tok-na">MarkupBuilder</span><span class="tok-o">()</span>
<span class="tok-kt">def</span> <span class="tok-n">facturas</span> <span class="tok-o">=</span> <span class="tok-n">builder</span><span class="tok-o">.</span><span class="tok-na">facturas</span> <span class="tok-o">{</span>
    <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">dia</span> <span class="tok-k">in</span> <span class="tok-mi">1</span><span class="tok-o">..</span><span class="tok-mi">3</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">factura</span><span class="tok-o">(</span><span class="tok-nl">fecha:</span> <span class="tok-k">new</span> <span class="tok-n">Date</span><span class="tok-o">()</span> <span class="tok-o">-</span> <span class="tok-n">dia</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">item</span><span class="tok-o">(</span><span class="tok-nl">id:</span><span class="tok-n">dia</span><span class="tok-o">){</span>
                <span class="tok-n">producto</span><span class="tok-o">(</span><span class="tok-nl">nombre:</span> <span class="tok-s1">&#39;Teclado&#39;</span><span class="tok-o">,</span> <span class="tok-nl">euros:</span><span class="tok-mi">876</span><span class="tok-o">)</span>
            <span class="tok-o">}</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span>

<span class="tok-n">facturas</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lo que produciría el siguiente archivo XML.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">&lt;</span><span class="tok-n">facturas</span><span class="tok-o">&gt;</span>
  <span class="tok-o">&lt;</span><span class="tok-n">factura</span> <span class="tok-n">fecha</span><span class="tok-o">=</span><span class="tok-s1">&#39;Sun Jan 03 00:00:00 CET 2014&#39;</span><span class="tok-o">&gt;</span>
    <span class="tok-o">&lt;</span><span class="tok-n">item</span> <span class="tok-n">id</span><span class="tok-o">=</span><span class="tok-s1">&#39;1&#39;</span><span class="tok-o">&gt;</span>
      <span class="tok-o">&lt;</span><span class="tok-n">producto</span> <span class="tok-n">nombre</span><span class="tok-o">=</span><span class="tok-s1">&#39;Teclado&#39;</span> <span class="tok-n">euros</span><span class="tok-o">=</span><span class="tok-s1">&#39;876&#39;</span> <span class="tok-s">/&gt;</span>
<span class="tok-s">    &lt;/</span><span class="tok-n">item</span><span class="tok-o">&gt;</span>
  <span class="tok-o">&lt;</span><span class="tok-s">/factura&gt;</span>
<span class="tok-s">  &lt;factura fecha=&#39;Mon Jan 02 00:00:00 CET 2014&#39;&gt;</span>
<span class="tok-s">    &lt;item id=&#39;2&#39;&gt;</span>
<span class="tok-s">      &lt;producto nombre=&#39;Teclado&#39; euros=&#39;876&#39; /</span><span class="tok-o">&gt;</span>
    <span class="tok-o">&lt;</span><span class="tok-s">/item&gt;</span>
<span class="tok-s">  &lt;/</span><span class="tok-n">factura</span><span class="tok-o">&gt;</span>
  <span class="tok-o">&lt;</span><span class="tok-n">factura</span> <span class="tok-n">fecha</span><span class="tok-o">=</span><span class="tok-s1">&#39;Tue Jan 01 00:00:00 CET 2014&#39;</span><span class="tok-o">&gt;</span>
    <span class="tok-o">&lt;</span><span class="tok-n">item</span> <span class="tok-n">id</span><span class="tok-o">=</span><span class="tok-s1">&#39;3&#39;</span><span class="tok-o">&gt;</span>
      <span class="tok-o">&lt;</span><span class="tok-n">producto</span> <span class="tok-n">nombre</span><span class="tok-o">=</span><span class="tok-s1">&#39;Teclado&#39;</span> <span class="tok-n">euros</span><span class="tok-o">=</span><span class="tok-s1">&#39;876&#39;</span> <span class="tok-s">/&gt;</span>
<span class="tok-s">    &lt;/</span><span class="tok-n">item</span><span class="tok-o">&gt;</span>
  <span class="tok-o">&lt;</span><span class="tok-s">/factura&gt;</span>
<span class="tok-s">&lt;/</span><span class="tok-n">facturas</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Se puede comprobar la limpieza del código utilizado para generar el archivo XML y prácticamente, el código sigue el mismo tabulado que el posterior archivo XML, con lo que la lectura del código por terceras personas se facilita muchísimo.</p>
</div>
<div class="paragraph">
<p>Pero <em>MarkupBuilder</em> no sólo nos va a servir para generar archivos XML, sino también archivos HTML. No es raro, puesto que HTML es en el fondo XML. Veamos como construir el mismo ejemplo anterior para que se vea como una página web. Un ejemplo de página web podría ser el siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">&lt;</span><span class="tok-n">html</span><span class="tok-o">&gt;</span>
  <span class="tok-o">&lt;</span><span class="tok-n">head</span><span class="tok-o">&gt;</span>
    <span class="tok-o">&lt;</span><span class="tok-n">title</span><span class="tok-o">&gt;</span><span class="tok-n">Facturas</span><span class="tok-o">&lt;</span><span class="tok-s">/title&gt;</span>
<span class="tok-s">  &lt;/</span><span class="tok-n">head</span><span class="tok-o">&gt;</span>
  <span class="tok-o">&lt;</span><span class="tok-n">body</span><span class="tok-o">&gt;</span>
    <span class="tok-o">&lt;</span><span class="tok-n">h1</span><span class="tok-o">&gt;</span><span class="tok-n">Facturas</span><span class="tok-o">&lt;</span><span class="tok-s">/h1&gt;</span>
<span class="tok-s">    &lt;ul&gt;</span>
<span class="tok-s">      &lt;li&gt;Sun Jan 03 00:00:00 CET 2015&lt;/</span><span class="tok-n">li</span><span class="tok-o">&gt;</span>
      <span class="tok-o">&lt;</span><span class="tok-n">ul</span><span class="tok-o">&gt;</span>
        <span class="tok-o">&lt;</span><span class="tok-n">li</span><span class="tok-o">&gt;</span><span class="tok-mi">1</span><span class="tok-o">.-</span> <span class="tok-n">Teclado</span> <span class="tok-o">=&gt;</span> <span class="tok-mi">876</span><span class="tok-n">euros</span><span class="tok-o">&lt;</span><span class="tok-s">/li&gt;</span>
<span class="tok-s">      &lt;/</span><span class="tok-n">ul</span><span class="tok-o">&gt;</span>
    <span class="tok-o">&lt;</span><span class="tok-s">/ul&gt;</span>
<span class="tok-s">    &lt;ul&gt;</span>
<span class="tok-s">      &lt;li&gt;Sun Jan 02 00:00:00 CET 2015&lt;/</span><span class="tok-n">li</span><span class="tok-o">&gt;</span>
      <span class="tok-o">&lt;</span><span class="tok-n">ul</span><span class="tok-o">&gt;</span>
        <span class="tok-o">&lt;</span><span class="tok-n">li</span><span class="tok-o">&gt;</span><span class="tok-mi">2</span><span class="tok-o">.-</span> <span class="tok-n">Teclado</span> <span class="tok-o">=&gt;</span> <span class="tok-mi">876</span><span class="tok-n">euros</span><span class="tok-o">&lt;</span><span class="tok-s">/li&gt;</span>
<span class="tok-s">      &lt;/</span><span class="tok-n">ul</span><span class="tok-o">&gt;</span>
    <span class="tok-o">&lt;</span><span class="tok-s">/ul&gt;</span>
<span class="tok-s">    &lt;ul&gt;</span>
<span class="tok-s">      &lt;li&gt;Sun Jan 01 00:00:00 CET 2015&lt;/</span><span class="tok-n">li</span><span class="tok-o">&gt;</span>
      <span class="tok-o">&lt;</span><span class="tok-n">ul</span><span class="tok-o">&gt;</span>
        <span class="tok-o">&lt;</span><span class="tok-n">li</span><span class="tok-o">&gt;</span><span class="tok-mi">3</span><span class="tok-o">.-</span> <span class="tok-n">Teclado</span> <span class="tok-o">=&gt;</span> <span class="tok-mi">876</span><span class="tok-n">euros</span><span class="tok-o">&lt;</span><span class="tok-s">/li&gt;</span>
<span class="tok-s">      &lt;/</span><span class="tok-n">ul</span><span class="tok-o">&gt;</span>
    <span class="tok-o">&lt;</span><span class="tok-s">/ul&gt;</span>
<span class="tok-s">  &lt;/</span><span class="tok-n">body</span><span class="tok-o">&gt;</span>
<span class="tok-o">&lt;/</span><span class="tok-n">html</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Este ejemplo de HTML se podría construir con el siguiente código, haciendo uso de MarkupBuilder.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">builder</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">groovy</span><span class="tok-o">.</span><span class="tok-na">xml</span><span class="tok-o">.</span><span class="tok-na">MarkupBuilder</span><span class="tok-o">()</span>

<span class="tok-n">builder</span><span class="tok-o">.</span><span class="tok-na">html</span> <span class="tok-o">{</span>
    <span class="tok-n">head</span> <span class="tok-o">{</span>
        <span class="tok-n">title</span> <span class="tok-s1">&#39;Facturas&#39;</span>
    <span class="tok-o">}</span>

    <span class="tok-n">body</span> <span class="tok-o">{</span>
        <span class="tok-n">h1</span> <span class="tok-s1">&#39;Facturas&#39;</span>

        <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">dia</span> <span class="tok-k">in</span> <span class="tok-mi">1</span><span class="tok-o">..</span><span class="tok-mi">3</span><span class="tok-o">){</span>
            <span class="tok-n">ul</span><span class="tok-o">{</span>
                <span class="tok-n">li</span> <span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-n">Date</span><span class="tok-o">()</span> <span class="tok-o">-</span> <span class="tok-n">dia</span><span class="tok-o">).</span><span class="tok-na">toString</span><span class="tok-o">()</span>
                <span class="tok-n">ul</span> <span class="tok-o">{</span>
                    <span class="tok-n">li</span> <span class="tok-s2">&quot;$dia.- Teclado =&gt; 876euros&quot;</span>
                <span class="tok-o">}</span>
            <span class="tok-o">}</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El código HTML generado por MarkupBuilder será compatible con los estándares y no tendremos incluso que preocuparnos por la conversión de determinados caracteres como el símbolo &lt; (&amp;lt;), ya que él mismo será el encargado de realizar dicha conversión.</p>
</div>
</div>
<div class="sect3">
<h4 id="_jsonbuilder">2.4.2. JsonBuilder</h4>
<div class="paragraph">
<p>Si en lugar de generar XML queremos generar JSON, Groovy también dispone de otro builder que nos permite generar estos JSON de forma muy sencilla y de forma muy similar a como veiamos con el generador de XML. Veamos un ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">builder</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">groovy</span><span class="tok-o">.</span><span class="tok-na">json</span><span class="tok-o">.</span><span class="tok-na">JsonBuilder</span><span class="tok-o">()</span>
<span class="tok-kt">def</span> <span class="tok-n">root</span> <span class="tok-o">=</span> <span class="tok-n">builder</span><span class="tok-o">.</span><span class="tok-na">teachers</span> <span class="tok-o">{</span>
   <span class="tok-n">professor</span> <span class="tok-o">{</span>
       <span class="tok-n">firstName</span> <span class="tok-s1">&#39;Fran&#39;</span>
       <span class="tok-n">lastName</span> <span class="tok-s1">&#39;Garcia&#39;</span>
       <span class="tok-n">address</span><span class="tok-o">(</span>
               <span class="tok-nl">city:</span> <span class="tok-s1">&#39;Oxford&#39;</span><span class="tok-o">,</span>
               <span class="tok-nl">country:</span> <span class="tok-s1">&#39;UK&#39;</span><span class="tok-o">,</span>
               <span class="tok-nl">zip:</span> <span class="tok-mi">12345</span><span class="tok-o">,</span>
       <span class="tok-o">)</span>
       <span class="tok-n">married</span> <span class="tok-kc">true</span>
       <span class="tok-n">modules</span> <span class="tok-s1">&#39;Groovy&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;Grails&#39;</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span>

<span class="tok-k">assert</span> <span class="tok-n">root</span> <span class="tok-k">instanceof</span> <span class="tok-n">Map</span>

<span class="tok-k">assert</span> <span class="tok-n">builder</span><span class="tok-o">.</span><span class="tok-na">toString</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;{&quot;teachers&quot;:{&quot;professor&quot;:{&quot;firstName&quot;:&quot;Fran&quot;,&quot;lastName&quot;:&quot;Garcia&quot;,&quot;address&quot;:{&quot;city&quot;:&quot;Oxford&quot;,&quot;country&quot;:&quot;UK&quot;,&quot;zip&quot;:12345},&quot;married&quot;:true,&quot;modules&quot;:[&quot;Groovy&quot;,&quot;Grails&quot;]}}}&#39;</span></code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios_2">2.5. Ejercicios</h3>
<div class="sect3">
<h4 id="_closures_sobre_colecciones_0_25_puntos">2.5.1. Closures sobre colecciones (0.25 puntos)</h4>
<div class="paragraph">
<p>Implementar un closure que realice la operación matemática factorial del número pasado como parámetro.</p>
</div>
<div class="paragraph">
<p>A continuación crear una lista o un mapa de números enteros y utilizar algunos de los métodos vistos para recorrer la lista o el mapa, generar el número factorial de cada uno de sus elementos con el closure que hemos creado acabamos de crear y mostrarlo por pantalla.</p>
</div>
<div class="paragraph">
<p>Por último, crear dos closures llamados ayer y mañana que devuelvan las fechas correspondientes a los días anterior y posterior a la fecha pasada. Podemos crear fechas mediante la sentencia <em>new Date().parse("d/M/yyyy H:m:s","28/6/2008 00:30:20")</em>.</p>
</div>
<div class="paragraph">
<p>Posteriormente, crear una lista de fechas y utilizar los closures recién creados para obtener las fechas del día anterior y posterior a todos los elementos de la lista.</p>
</div>
</div>
<div class="sect3">
<h4 id="_clase_completa_en_groovy_0_5_puntos">2.5.2. Clase completa en Groovy (0.5 puntos)</h4>
<div class="paragraph">
<p>Crear una clase llamada <em>Calculadora</em> que permita la realización de cálculos matemáticos con dos número enteros. Estos cálculos serán la suma, resta, multiplicación y división.</p>
</div>
<div class="paragraph">
<p>Los parámetros serán solicitados como entrada a la aplicación. Para leer parámetros por línea de comandos se pueda utilizar el siguiente closure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">in</span><span class="tok-o">.</span><span class="tok-na">withReader</span> <span class="tok-o">{</span>
  <span class="tok-n">print</span> <span class="tok-s1">&#39;Introduzca operador: &#39;</span>
  <span class="tok-n">op1</span> <span class="tok-o">=</span> <span class="tok-n">it</span><span class="tok-o">.</span><span class="tok-na">readLine</span><span class="tok-o">()</span>
  <span class="tok-n">println</span><span class="tok-o">(</span><span class="tok-n">op1</span><span class="tok-o">)</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El sistema nos debe pedir que introduzcamos los operandos así como el tipo de operación que queremos realizar y mostrará por pantalla el resultado de la operación.</p>
</div>
</div>
<div class="sect3">
<h4 id="_metaprogramación_0_5_puntos">2.5.3. Metaprogramación (0.5 puntos)</h4>
<div class="paragraph">
<p>Utilizando los conceptos sobre metaprogramación vistos en la parte teórica, añade un método llamado <em>moneda(String)</em> que recibirá por parámetro una cadena que representa un determinado <em>locale</em> y en función de este <em>locale</em> imprimirá un símbolo u otro. Para simplificar, vamos a limitar el número de posibles <em>locales</em> a tres: es_ES, en_EN y en_US. Para comprobar si tu método funciona correctamente, puedes pasarle las siguientes aserciones tras modificar adecuadamente la clase correspondiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-k">assert</span> <span class="tok-mf">10.2</span><span class="tok-o">.</span><span class="tok-na">moneda</span><span class="tok-o">(</span><span class="tok-s2">&quot;en_EN&quot;</span><span class="tok-o">)</span> <span class="tok-o">==</span>  <span class="tok-s2">&quot;£10.2&quot;</span>
<span class="tok-k">assert</span> <span class="tok-mf">10.2</span><span class="tok-o">.</span><span class="tok-na">moneda</span><span class="tok-o">(</span><span class="tok-s2">&quot;en_US&quot;</span><span class="tok-o">)</span> <span class="tok-o">==</span>  <span class="tok-s2">&quot;\$10.2&quot;</span>
<span class="tok-k">assert</span> <span class="tok-mf">10.2</span><span class="tok-o">.</span><span class="tok-na">moneda</span><span class="tok-o">(</span><span class="tok-s2">&quot;es_ES&quot;</span><span class="tok-o">)</span> <span class="tok-o">==</span>  <span class="tok-s2">&quot;10.2€&quot;</span>

<span class="tok-k">assert</span> <span class="tok-mi">10</span><span class="tok-o">.</span><span class="tok-na">moneda</span><span class="tok-o">(</span><span class="tok-s2">&quot;en_EN&quot;</span><span class="tok-o">)</span> <span class="tok-o">==</span>  <span class="tok-s2">&quot;£10&quot;</span>
<span class="tok-k">assert</span> <span class="tok-mi">10</span><span class="tok-o">.</span><span class="tok-na">moneda</span><span class="tok-o">(</span><span class="tok-s2">&quot;en_US&quot;</span><span class="tok-o">)</span> <span class="tok-o">==</span>  <span class="tok-s2">&quot;\$10&quot;</span>
<span class="tok-k">assert</span> <span class="tok-mi">10</span><span class="tok-o">.</span><span class="tok-na">moneda</span><span class="tok-o">(</span><span class="tok-s2">&quot;es_ES&quot;</span><span class="tok-o">)</span> <span class="tok-o">==</span>  <span class="tok-s2">&quot;10€&quot;</span>

<span class="tok-k">assert</span> <span class="tok-k">new</span> <span class="tok-nf">Float</span><span class="tok-o">(</span><span class="tok-mf">10.2</span><span class="tok-o">).</span><span class="tok-na">moneda</span><span class="tok-o">(</span><span class="tok-s2">&quot;en_EN&quot;</span><span class="tok-o">)</span> <span class="tok-o">==</span>  <span class="tok-s2">&quot;£10.2&quot;</span>
<span class="tok-k">assert</span> <span class="tok-k">new</span> <span class="tok-nf">Float</span><span class="tok-o">(</span><span class="tok-mf">10.2</span><span class="tok-o">).</span><span class="tok-na">moneda</span><span class="tok-o">(</span><span class="tok-s2">&quot;en_US&quot;</span><span class="tok-o">)</span> <span class="tok-o">==</span>  <span class="tok-s2">&quot;\$10.2&quot;</span>
<span class="tok-k">assert</span> <span class="tok-k">new</span> <span class="tok-nf">Float</span><span class="tok-o">(</span><span class="tok-mf">10.2</span><span class="tok-o">).</span><span class="tok-na">moneda</span><span class="tok-o">(</span><span class="tok-s2">&quot;es_ES&quot;</span><span class="tok-o">)</span> <span class="tok-o">==</span>  <span class="tok-s2">&quot;10.2€&quot;</span>

<span class="tok-k">assert</span> <span class="tok-k">new</span> <span class="tok-nf">Double</span><span class="tok-o">(</span><span class="tok-mf">10.2</span><span class="tok-o">).</span><span class="tok-na">moneda</span><span class="tok-o">(</span><span class="tok-s2">&quot;en_EN&quot;</span><span class="tok-o">)</span> <span class="tok-o">==</span>  <span class="tok-s2">&quot;£10.2&quot;</span>
<span class="tok-k">assert</span> <span class="tok-k">new</span> <span class="tok-nf">Double</span><span class="tok-o">(</span><span class="tok-mf">10.2</span><span class="tok-o">).</span><span class="tok-na">moneda</span><span class="tok-o">(</span><span class="tok-s2">&quot;en_US&quot;</span><span class="tok-o">)</span> <span class="tok-o">==</span>  <span class="tok-s2">&quot;\$10.2&quot;</span>
<span class="tok-k">assert</span> <span class="tok-k">new</span> <span class="tok-nf">Double</span><span class="tok-o">(</span><span class="tok-mf">10.2</span><span class="tok-o">).</span><span class="tok-na">moneda</span><span class="tok-o">(</span><span class="tok-s2">&quot;es_ES&quot;</span><span class="tok-o">)</span> <span class="tok-o">==</span>  <span class="tok-s2">&quot;10.2€&quot;</span></code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion03">3. Introducción a Grails. Scaffolding.</h2>
<div class="sectionbody">
<div class="paragraph">
<p>En esta primera sesión de Grails, comenzaremos, como no puede ser de otra forma, viendo una descripción de lo que es Grails, sus características y las ventajas que conlleva su uso como entorno para el desarrollo rápido de aplicaciones. Seguiremos analizando su arquitectura y las herramientas de código abierto que aúna Grails y terminaremos desarrollando nuestra primera aplicación en Grails aprovechándonos del <em>scaffolding</em>.</p>
</div>
<div class="sect2">
<h3 id="__qué_es">3.1. ¿Qué es?</h3>
<div class="paragraph">
<p>Grails es un framework para el desarrollo de aplicaciones web basado en el lenguaje de programación Groovy, que a su vez se basa en la Plataforma Java. Grails está basado en los paradigmas <em>convención sobre configuración</em> y <em>DRY (don&#8217;t repite yourself)</em> o no te repitas, los cuales permiten al programador olvidarse en gran parte de los detalles de configuración de más bajo nivel.</p>
</div>
<div class="paragraph">
<p>Como la mayoría de los framework de desarrollo web, Grails está basado en el patrón <em>Modelo Vista Controlador (MVC)</em>. En Grails los <em>modelos</em> se conocen como <em>clases de dominio</em> que permiten a la aplicación mostrar los datos utilizando la <em>vista</em>. A diferencia de otros frameworks, en Grails las clases de dominio de Grails son automáticamente persistidas y es incluso posible generar el esquema de la base de datos. Los <em>controladores</em> por su parte, permiten gestionar las peticiones a la aplicación y organizar los servicios proporcionados. Por último, la <em>vista</em> en Grails son las conocidas como <em>Groovy Server Pages (GSP)</em> (análogamente a las Java Server Pages -JSP-) y habitualmente se encargan de generar el contenido de nuestra aplicación en formato HTML.</p>
</div>
<div class="paragraph">
<p>Como comentábamos anteriormente, Grails permite al programador olvidarse de gran parte de la configuración típica que incluyen los frameworks MVC. Además Grails se aprovecha de un lenguaje dinámico como Groovy para acortar los tiempos de desarrollo y que el equipo de desarrolladores puedan centrarse simplemente en escribir código, actualizar, testear y depurar fallos. Esto hace que el desarrollo de la aplicación sea mucho más ágil que con otros frameworks MVC.</p>
</div>
<div class="paragraph">
<p>Habitualmente cuando hablamos de framework, se entiende como un marco de los programadores pueden utilizar las técnicas del Modelo Vista Controlador para el desarrollo rápido de sus aplicaciones. Pero, ¿qué pasa con el resto de elementos necesarios para el desarrollo de una aplicación como pueden ser los servidores web o los gestores de bases de datos?. En este sentido, Grails no es simplemente un framework de desarrollo de aplicaciones sino que es más una plataforma completa, puesto que incluye también un contenedor web, bases de datos, sistemas de empaquetado de la aplicación y un completo sistema para la realización de tests. De esta forma, no debemos perder el tiempo buscando y descargando un servidor web para nuestra futura aplicación o un gestor de base de datos. Ni tan siquiera será necesario escribir complicados scripts de configuración para el empaquetado de la aplicación. Todo esto se convierte en una tarea tan sencilla como instalar Grails.</p>
</div>
<div class="sect3">
<h4 id="__qué_empresas_utilizan_grails">3.1.1. ¿Qué empresas utilizan Grails?</h4>
<div class="paragraph">
<p>Desde los inicios de Grails, muchas han sido las empresas que apostaron por este framework y que a día de hoy siguen utilizándolo para desarrollar sus aplicaciones.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Netflix, <a href="http://www.netflix.com" class="bare">http://www.netflix.com</a></p>
</li>
<li>
<p>Sky, <a href="http://www.sky.com" class="bare">http://www.sky.com</a></p>
</li>
<li>
<p>Secret Escapes, <a href="http://www.secretescapes.com" class="bare">http://www.secretescapes.com</a></p>
</li>
<li>
<p>Engage Sciences, <a href="http://www.engagesciences.com" class="bare">http://www.engagesciences.com</a></p>
</li>
<li>
<p>Odobo, <a href="http://www.odobo.com" class="bare">http://www.odobo.com</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_características_de_grails">3.2. Características de Grails</h3>
<div class="paragraph">
<p>Algunas de las características más importantes que presenta Grails son las siguientes:</p>
</div>
<div class="sect3">
<h4 id="_convención_sobre_configuración">3.2.1. Convención sobre configuración</h4>
<div class="paragraph">
<p>En lugar de tener que escribir interminables archivos de configuración en formato XML, Grails se basa en una serie de convenciones para que el desarrollo de la aplicación sea mucho más rápido y productivo. Además, gracias al uso de convenciones, se refuerza el otro principio del que hablábamos anteriormente, <em>DRY (don&#8217;t repite yourself)</em> o no te repitas.</p>
</div>
</div>
<div class="sect3">
<h4 id="_tests">3.2.2. Tests</h4>
<div class="paragraph">
<p>Una de las partes más importantes en el desarrollo de software se refiere a los tests implementados que garantizan un software de calidad y el fácil mantenimiento de una aplicación. Gracias a estos tests, es muy sencillo detectar y solucionar fallos provocados por cambios en el código. Cada vez que se genera en Grails una clase de dominio o un controlador, paralelamente es generado también un test para comprobar la nueva clase o controlador, que por supuesto nosotros deberemos completar (Grails es muy bueno, pero no lo hace todo).</p>
</div>
<div class="paragraph">
<p>Grails distingue entre tests unitarios y tests de integración. Los tests unitarios son tests sin dependencias de ningún tipo, salvo algún que otro objeto <em>mock</em>. Por otro lado, los tests de integración tienen acceso completo al entorno de Grails, incluyendo la base de datos. Además, Grails permite también la creación de tests funcionales para comprobar la funcionalidad de nuestra aplicación web a nivel de interacción con el usuario.</p>
</div>
</div>
<div class="sect3">
<h4 id="_scaffolding">3.2.3. Scaffolding</h4>
<div class="paragraph">
<p>El scaffolding es una característica de determinados frameworks que permite la generación automática de código para las cuatro operaciones básicas de cualquier aplicación, que son la <em>creación</em>, <em>lectura</em>, <em>edición</em> y <em>borrado</em>, lo que en inglés se conoce como <em>CRUD (create, read, update and delete)</em>.</p>
</div>
<div class="paragraph">
<p>Grails permite también utilizar scaffolding en nuestras aplicaciones a través de un plugin que viene instalado por defecto. En versiones anteriores, el scaffolding venía como parte del <em>core</em> de Grails, sin embargo en las últimas versiones esta característica ha sido movida a un plugin. El scaffolding en Grails se consigue escribiendo muy pocas líneas de código, con lo que podemos centrarnos en especificar las propiedades, comportamientos y restricciones de nuestras clases de dominio.</p>
</div>
<div class="paragraph">
<p>Una gran cantidad de aplicaciones consisten en simplemente ofrecer la posibilidad a los usuarios de realizar esas cuatro operaciones básicas que comentábamos anteriormente sobre algunas entidades o clases de dominio con lo que en ocasiones este scaffolding nos ahorrará mucho tiempo.</p>
</div>
</div>
<div class="sect3">
<h4 id="_mapeo_objeto_relacional">3.2.4. Mapeo objeto-relacional</h4>
<div class="paragraph">
<p>Grails incluye un potente framework para el mapeo objeto-relacional conocido como <em>GORM (Grails Object Relational Mapping)</em>. Como cualquier framework de persistencia, GORM permite mapear objetos contra bases de datos relacionales y representar relaciones entre dichos objetos del tipo <em>uno-a-uno</em>, <em>uno-a-muchos</em> y <em>muchos-a-muchos</em>.</p>
</div>
<div class="paragraph">
<p>Por defecto, Grails utiliza Hibernate por debajo para realizar este mapeo, con lo que no debemos preocuparnos de que tipo de base de datos vamos a utilizar en nuestra aplicación (MySQL, Oracle, SQL Server, etc) porque Grails se encargará por nosotros de esta parte. Además, en los últimos tiempo están proliferando lo que se conoce como las bases de datos <em>noSQL</em> como MongoDB, Redis, Neo4j, etc. Aunque éstos tipos de bases de datos todavía no están soportadas en el núcleo de Grails, si están apareciendo al mismo tiempo diversos plugins para la utilización de éstas sin apenas modificar nada en nuestra aplicación.</p>
</div>
</div>
<div class="sect3">
<h4 id="_plugins">3.2.5. Plugins</h4>
<div class="paragraph">
<p>Sin embargo, Grails no siempre es la solución a cualquier problema que se nos pueda plantear en el desarrollo de aplicaciones web. Para ayudarnos, Grails dispone de una arquitectura de plugins con una comunidad de usuarios detrás (cada vez más grande) que ofrecen plugins para seguridad, AJAX, testeo, búsqueda, informes, servicios web, etc. Este sistema de plugins hace que añadir complejas funcionalidades a nuestra aplicación se convierte en algo muy sencillo. En la actualidad hay alrededor de 1200 plugins desarrollados para Grails.</p>
</div>
</div>
<div class="sect3">
<h4 id="_internacionalización_i18n">3.2.6. Internacionalización (i18n)</h4>
<div class="paragraph">
<p>Cuando creamos un proyecto en Grails, automáticamente se crea toda la estructura de datos necesaria para la internacionalización de la aplicación sin ningún problema.</p>
</div>
</div>
<div class="sect3">
<h4 id="_software_de_código_abierto">3.2.7. Software de código abierto</h4>
<div class="paragraph">
<p>Por suerte, Grails no sufre del síndrome <em><a href="http://en.wikipedia.org/wiki/Not_Invented_Here">Not Invented Here (NIH)</a></em> y lo hace integrando en su arquitectura las mejores soluciones de software libre del mercado para crear un framework robusto. Veamos cuales son estas soluciones.</p>
</div>
<div class="sect4">
<h5 id="_groovy_2">Groovy</h5>
<div class="paragraph">
<p><a href="http://groovy.codehaus.org/">Groovy</a> es la parte fundamental en la que se basa Grails. Como vimos en las dos primeras sesiones, Groovy es un potente y flexible lenguaje de programación. Su integración con Java, las características como lenguaje dinámico y su sintaxis sencilla, hacen de este lenguaje de programación el compañero perfecto para Grails.</p>
</div>
</div>
<div class="sect4">
<h5 id="_framework_spring">Framework Spring</h5>
<div class="paragraph">
<p>El framework <a href="http://www.springsource.org">Spring</a> ofrece un alto nivel de abstracción al programador que en lugar de tratar directamente con las transacciones, proporciona una forma para declarar dichas transacciones utilizando los <em>POJOs (Plain Old Java Objects)</em>, con lo que el programador se puede centrar en la implementación de la lógica de negocio.</p>
</div>
</div>
<div class="sect4">
<h5 id="_hibernate">Hibernate</h5>
<div class="paragraph">
<p><a href="https://www.hibernate.org">Hibernate</a> es un framework de persistencia objeto-relacional y constituye la base de GORM. Es capaz de mapear complejas clases de dominio contra las tablas de una base de datos, así como establecer las relaciones entre las distintas tablas.</p>
</div>
</div>
<div class="sect4">
<h5 id="_sitemesh">SiteMesh</h5>
<div class="paragraph">
<p><a href="http://www.opensymphony.com/sitemesh">SiteMesh</a> es un framework web para el renderizado de documentos HTML que implementa el patrón de diseño <a href="http://es.wikipedia.org/wiki/Decorator_(patr%C3%B3n_de_dise%C3%B1o)">Decorator</a> con componentes como cabeceras, pies de páginas y sistemas de navegación.</p>
</div>
</div>
<div class="sect4">
<h5 id="_tomcat_y_jetty">Tomcat y Jetty</h5>
<div class="paragraph">
<p>Como comentábamos anteriormente, Grails es una plataforma completa, y esto es en parte gracias a la inclusión de un servidor web como <a href="http://www.mortbay.org/jetty">Jetty</a> o <a href="http://tomcat.apache.org">Tomcat</a>. Esto no significa que Grails solo funcione con estos dos servidores de aplicaciones sino que en nuestra instalación local de Grails podremos utilizar cualquiera de ellos.</p>
</div>
</div>
<div class="sect4">
<h5 id="_h2">H2</h5>
<div class="paragraph">
<p>Grails también incluye un gestor de bases de datos relacionales como <a href="http://www.h2database.com">H2</a>. H2 es un gestor de base de datos en memoría de tamaño muy reducido y que en la mayoría de los casos nos servirá para nuestra fase de desarrollo (nunca para producción). Esto tampoco quiere decir que nuestras aplicaciones desarrolladas en Grails sólo funcionen con H2, sino que para desarrollar nuestra aplicación no vamos a necesitar ningún gestor de base de datos externo.</p>
</div>
</div>
<div class="sect4">
<h5 id="_spock">Spock</h5>
<div class="paragraph">
<p>En las primeras versiones de Grails, se utilizaba como framework para el desarrollo de tests el ampliamente aceptado JUnit, pero en las últimas versiones se ha decidido utilizar otro framework que ha tenido gran aceptación por parte de la comunidad llamado <a href="http://spock-framework.readthedocs.org">Spock</a>. Spock nos permitirá realizar tests unitarios, de integración y funcionales, tal y como veremos en la sesión 6.</p>
</div>
</div>
<div class="sect4">
<h5 id="_gant">Gant</h5>
<div class="paragraph">
<p><a href="http://gant.codehaus.org">Gant</a> es un entorno en línea de comandos que envuelve el archiconocido sistema de automatización de tareas <a href="http://ant.apache.org">Apache Ant</a>. Con Gant vamos a poder realizar todo tipo de tareas en un proyecto Grails, como la creación de todo tipo de artefactos en la aplicación, la generación del código de scaffolding necesario, la realización de las pruebas unitarias y de integración y el empaqueta de la aplicación, entre otras cosas.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_arquitectura">3.3. Arquitectura</h3>
<div class="paragraph">
<p>Ahora que ya tenemos una idea de lo que es Grails y las ventajas que nos puede aportar a la hora de desarrollar nuestros proyectos web, veamos gráficamente su arquitectura.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/grails03/arquitectura.jpg" alt="Arquitectura Grails" width="50%">
</div>
</div>
<div class="paragraph">
<p>Podemos decir que la arquitectura de Grails está formada por cuatro capas claramente diferenciadas. La base de la arquitectura de Grails es la máquina virtual de Java. Por encima de ésta se encuentran los lenguajes de programación en lo que está basado Grails, Java y Groovy. En la tercera capa tenemos el propio framework Grails, al cual le acompañan todos los frameworks de los que hablábamos en la sección anterior, SiteMesh, Spring, GORM, etc. En esta capa también se ha añadido una opción abierta como es la posibilidad de incluir otras librerías externas que no están incluidas en Grails. La última capa está formada por la aplicación en si, siguiendo el patrón modelo vista controlador.</p>
</div>
<div class="paragraph">
<p>Además, envolviendo a todo el proyecto Grails aparece Gant, la herramienta en línea de comandos que nos permitirá una gran variedad de acciones sobre el mismo.</p>
</div>
<div class="paragraph">
<p>Desde el punto de vista de la ejecución de un proyecto Grails, se podría esquematizar de la siguiente forma:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/grails03/grails_runtime.jpg" alt="Grails runtime" width="50%">
</div>
</div>
<div class="paragraph">
<p>De la imagen podemos concluir que una página web realiza una petición al servidor web. Esta petición se pasa a un controlador, el cual podrá utilizar o no una clase de dominio (modelo). Esta clase de dominio puede ser a su vez estar persistida en una base de datos gracias a GORM. Una vez el controlador termina, pasa la petición al correspondiente GSP para que renderice la vista y sea enviada de nuevo al navegador en forma de página HTML.</p>
</div>
</div>
<div class="sect2">
<h3 id="_instalación_de_grails">3.4. Instalación de Grails</h3>
<div class="paragraph">
<p>Si tenemos en cuenta lo que decíamos anteriormente de que Grails es un completo framework con un servidor web, un gestor de base de datos y el resto de características ya comentadas, podríamos pensar que su instalación puede ser muy complicada. Sin embargo, la instalación de Grails se convierte en un juego de niños, ya que nos olvidamos de tener que buscar soluciones externas para cada uno de los aspectos relacionados con el desarrollo de una aplicación web.</p>
</div>
<div class="paragraph">
<p>Aquí vamos a configurar Grails para poder utilizarlo tanto desde línea de comandos como desde el entorno de desarrollo IntelliJ IDEA.</p>
</div>
<div class="sect3">
<h4 id="_instalación_de_grails_en_línea_de_comandos">3.4.1. Instalación de Grails en línea de comandos</h4>
<div class="paragraph">
<p>Tal y como hacíamos en la instalación de Groovy, vamos a utilizar el gestor de paquetes <em>sdkman (<a href="http://sdkman.io/" class="bare">http://sdkman.io/</a>)</em>. Estos son los pasos para instalar Grails en nuestro ordenador:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">curl -s get.sdkman.io <span class="tok-p">|</span> bash

<span class="tok-nb">source</span> <span class="tok-s2">&quot;$HOME/.sdkman/bin/sdkman-init.sh&quot;</span>

sdk list grails

sdk install grails 2.5.2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Si necesitaramos alternar entre varias versiones de Grails, simplemente deberías ejecutar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">sdk use grails 2.1.0</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_instalación_en_intellij_idea">3.4.2. Instalación en IntelliJ IDEA</h4>
<div class="paragraph">
<p>En principio IntelliJ IDEA ofrece automáticamente la posibilidad de crear proyectos Grails gracias al plugin instalado por defecto. Puedes comprobarlo en las preferencias de <em>IntelliJ IDEA &gt; IDE Settings &gt; Plugins</em> y ahí buscar el plugin de Grails. Cuando intentemos crear un nuevo proyecto en Grails, IntelliJ nos pedirá que le indiquemos donde se encuentra el framework instalado.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/grails03/creategrailsproject.png" alt="Crear proyecto Grails" width="100%">
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/grails03/selectgrailsversion.png" alt="Seleccionar la versión de Grails desde la instalación de sdk" width="100%">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_scaffolding_2">3.5. Scaffolding</h3>
<div class="paragraph">
<p>Una vez ya tenemos configurado nuestro entorno de desarrollo, pasemos a la acción desarrollando con Grails una sencilla aplicación. En este módulo, vamos a desarrollar un ejemplo de lo que sería el completo desarrollo de una aplicación web que nos permita manejar una lista de tareas. Empezaremos desarrollando este ejemplo de aplicación para explicar como Grails implementa el scaffolding. Pero, ¿qué es el scaffolding?</p>
</div>
<div class="paragraph">
<p>El scaffolding es un término utilizado en programación para designar la construcción automática de aplicaciones a partir del esquema de la base de datos. Está soportado por varios frameworks MVC y Grails no podía ser menos y el equipo de desarrollo decidió incluirlo entre sus características más importantes. La idea del scaffolding es, partiendo del esquema de la base de datos, generar el código necesario para implementar las cuatro operaciones básicas en cualquier aplicación, que son: creación, lectura, actualización y borrado. Este tipo de aplicaciones se las conoce como <em>CRUD (create, read, update y delete)</em>.</p>
</div>
<div class="paragraph">
<p>Grails además nos ofrece dos tipos de scaffolding, el <em>dinámico</em>, en el cual Grails genera por nosotros al vuelo el código referente a las vistas y a los controladores y por otro lado el <em>scaffolding estático</em> en el que Grails generará de forma estática el código de controladores y vistas.</p>
</div>
<div class="paragraph">
<p>Como comentabamos anteriormente, vamos a ver un ejemplo de lo que es el scaffolding, desarrollando la típica aplicación <em>todo</em>, aplicación que iremos mejorando durante todo este módulo.</p>
</div>
<div class="sect3">
<h4 id="_descripción_de_la_aplicación_ejemplo">3.5.1. Descripción de la aplicación ejemplo</h4>
<div class="paragraph">
<p>Básicamente el funcionamiento de la aplicación debe permitir la creación y mantenimiento de tareas así como la posibilidad de categorizarlas. Para simplificar la aplicación, una tarea sólo podrá pertenecer como mucho a una categoría mientras que una categoría podrá tener por supuesto muchas tareas.</p>
</div>
<div class="paragraph">
<p>Además, también vamos a permitir la posibilidad etiquetar dichas tareas, con lo que una tarea puede tener varias etiquetas y una etiqueta estar asignada a varias tareas.</p>
</div>
<div class="paragraph">
<p>Por el momento, no nos vamos a preocupar de la gestión de usuarios, ya que lo haremos en la sesión 7 utilizando un plugin que se encargará por nosotros de todo el tema de seguridad de nuestra aplicación.</p>
</div>
</div>
<div class="sect3">
<h4 id="_creación_del_proyecto_grails">3.5.2. Creación del proyecto Grails</h4>
<div class="paragraph">
<p>Si todo ha ido bien en la instalación de Grails, podremos crear nuestra primera aplicación en Grails gracias al comando <em>grails</em>. Este será el comando que utilizaremos a lo largo de todo el curso para crear todas las partes de nuestra aplicación. Para ver un listado completo de las opciones del comando <em>grails</em>, podemos ejecutar <em>grails help</em>. Si echamos un primer vistazo a esta listado, descubriremos la opción <em>create-app</em>, la cual nos servirá para crear la estructura de directorios de la aplicación. Ejecutamos <em>grails create-app todo</em> y se nos generará el directorio <em>todo</em> con una serie de subdirectorios que comentaremos en breve.</p>
</div>
<div class="paragraph">
<p>Esta estructura de directorios generada automáticamente por Grails viene como consecuencia de lo que comentábamos anteriormente como uno de los paradigmas en que se basa Grails, <em>convención sobre configuración</em>. De esta forma, Grails nos genera la estructura de directorios que albergará todo nuestro proyecto para que nosotros lo vayamos <em>completando</em>. Veamos para que sirven los directorios más importantes generados dentro de nuestro proyecto <em>todo</em>.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Directorio</th>
<th class="tableblock halign-left valign-top">Descripción</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">grails-app/conf</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ficheros de configuración de la aplicación</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">grails-app/conf/hibernate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Archivos de mapeado de Hibernate</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">grails-app/conf/spring</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Archivos de mapeado de Spring</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">grails-app/controllers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Controladores de la aplicación que gestionan las peticiones</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">grails-app/domain</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Clases de dominio del modelo</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">grails-app/i18n</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mensajes para la internacionalización de la aplicación</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">grails-app/services</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Servicios</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">grails-app/taglib</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Librerías de etiquetas dinámicas</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">grails-app/utils</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Utilidades específicas de Grails</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">grails-app/views</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Archivos GSP</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">grails-app/views/layout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Archivos de diseño de las páginas web</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">grails-app/assets/images</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Imágenes utilizadas por la aplicación en el entorno del plugin pipeline</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">grails-app/assets/javascripts</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Archivos javascript utilizados por la aplicación en el entorno del plugin pipeline</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">grails-app/assets/stylesheets</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hojas de estilo utilizadas por la aplicación en el entorno del plugin pipeline</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">lib</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Archivos JAR de terceras partes, tales como controladores de bases de datos</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">scripts</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Scripts <em>GANT</em> para el automatizado de tareas</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">src/java</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Archivos fuente adicionales en Java</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">src/groovy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Archivos fuente adicionales en Groovy</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">test/integration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tests de integración</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">test/unit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tests unitarios</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">web-app</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Artefactos web que finalmente serán comprimidos a un <em>WAR (Web Application Archive)</em></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">web-app/css</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hojas de estilo</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">web-app/images</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Imágenes de la aplicación</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">web-app/js</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Javascript</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">web-app/WEB-INF</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Archivos de configuración para Spring o SiteMesh</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Ahora que ya tenemos una primera idea de lo que significa cada uno de los directorios generados por Grails al crear un proyecto, vamos a abrirlo con el editor IntelliJ IDEA. Grails es capaz de crear también los archivos de configuración necesarios para que podamos editar el proyecto con diferentes editores como Eclipse, Textmate y NetBeans, con lo que simplemente abrimos el editor y localizamos el proyecto <em>todo</em> y lo abrimos como un nuevo proyecto. Como vemos en la imagen, IDEA ha cambiado la estructura de directorios por una más clara para el desarrollador, aunque siempre podemos ver la estructura real de directorios si accedemos a la vista <em>Project</em>.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/grails03/intellijgrailsapp.png" alt="Aplicación Grails con IntelliJ Idea" width="50%">
</div>
</div>
<div class="paragraph">
<p>Nuestro proyecto ya está listo para ser ejecutado, aunque imaginarás que por el momento no hará nada. Para ver la primera versión del proyecto <em>todo</em> podemos ejecutar el comando <em>grails run-app</em>, que nos generará una aplicación en la dirección <a href="http://localhost:8080/todo" class="bare">http://localhost:8080/todo</a>. El comando <em>grails run-app</em> lo que ha hecho es crear una instancia del servidor web Tomcat en el puerto 8080 y cargar en él la aplicación <em>todo</em>. Por ahora esta aplicación hace más bien poco y simplemente nos muestra un mensaje de bienvenida, pero vamos a ver lo sencillo que es generar su contenido.</p>
</div>
</div>
<div class="sect3">
<h4 id="_creación_de_clases_de_dominio">3.5.3. Creación de clases de dominio</h4>
<div class="paragraph">
<p>Al desarrollar una aplicación de este tipo, lo habitual es crear en primer lugar las clases de dominio necesarias para después pasar a generar los controladores, así que vamos a empezar creando la clase de dominio referente a los <em>todos</em>. En Grails tenemos el comando <em>grails create-domain-class</em> para generar una determinada clase de dominio, con lo que si ejecutamos <em>grails create-domain-class es.ua.expertojava.todo.todo</em>, Grails nos creará la estructura necesaria para las tareas de nuestra aplicación. En caso de no indicar el nombre de la clase, el sistema nos preguntará por él.</p>
</div>
<div class="paragraph">
<p>Como podemos comprobar en nuestro proyecto con IDEA, se nos ha creado una clase de dominio llamada <em>Todo</em>, que como ves empieza por mayúscula a pesar de que nosotros introdujimos el nombre de la clase de dominio en minúsculas. Esto es debido a que Grails sigue una serie de convenios para el nombre de las clases. El contenido de <em>Todo.groovy</em> es el siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">es</span><span class="tok-o">.</span><span class="tok-na">ua</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">todo</span>

<span class="tok-kd">class</span> <span class="tok-nc">Todo</span> <span class="tok-o">{</span>

    <span class="tok-kd">static</span> <span class="tok-n">constraints</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Además, también se crea un test unitario llamado <em>es.ua.expertojava.todo.TodoSpec</em>, que de momento dejaremos tal cual está pero que volveremos a él en la sesión 6 en la que hablaremos de los tests unitarios.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">es</span><span class="tok-o">.</span><span class="tok-na">ua</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">todo</span>

<span class="tok-kn">import</span> <span class="tok-nn">grails.test.mixin.TestFor</span>
<span class="tok-kn">import</span> <span class="tok-nn">spock.lang.Specification</span>

<span class="tok-cm">/**</span>
<span class="tok-cm"> * See the API for {@link grails.test.mixin.domain.DomainClassUnitTestMixin} for usage instructions</span>
<span class="tok-cm"> */</span>
<span class="tok-nd">@TestFor</span><span class="tok-o">(</span><span class="tok-n">Todo</span><span class="tok-o">)</span>
<span class="tok-kd">class</span> <span class="tok-nc">TodoSpec</span> <span class="tok-kd">extends</span> <span class="tok-n">Specification</span> <span class="tok-o">{</span>

    <span class="tok-kt">def</span> <span class="tok-nf">setup</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-o">}</span>

    <span class="tok-kt">def</span> <span class="tok-nf">cleanup</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-o">}</span>

    <span class="tok-kt">void</span> <span class="tok-s2">&quot;test something&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La clase de dominio <em>Todo</em> está preparada para que le añadamos los campos necesarios, tales como título, descripción, fecha, etc. La información referente a las tareas serán <em>título</em>, <em>descripción</em>, <em>fecha</em>, <em>fechaRecordatorio</em> y <em>url</em>. Con estos datos, la clase de dominio <em>Todo</em> quedaría así:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">es</span><span class="tok-o">.</span><span class="tok-na">ua</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">todo</span>

<span class="tok-kd">class</span> <span class="tok-nc">Todo</span> <span class="tok-o">{</span>
    <span class="tok-n">String</span> <span class="tok-n">title</span>
    <span class="tok-n">String</span> <span class="tok-n">description</span>
    <span class="tok-n">Date</span> <span class="tok-n">date</span>
    <span class="tok-n">Date</span> <span class="tok-n">reminderDate</span>
    <span class="tok-n">String</span> <span class="tok-n">url</span>

    <span class="tok-kd">static</span> <span class="tok-n">constraints</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
        <span class="tok-n">title</span><span class="tok-o">(</span><span class="tok-nl">blank:</span><span class="tok-kc">false</span><span class="tok-o">)</span>
        <span class="tok-n">description</span><span class="tok-o">(</span><span class="tok-nl">blank:</span><span class="tok-kc">true</span><span class="tok-o">,</span> <span class="tok-nl">nullable:</span><span class="tok-kc">true</span><span class="tok-o">,</span> <span class="tok-nl">maxSize:</span><span class="tok-mi">1000</span><span class="tok-o">)</span>
        <span class="tok-n">date</span><span class="tok-o">(</span><span class="tok-nl">nullable:</span><span class="tok-kc">false</span><span class="tok-o">)</span>
        <span class="tok-n">reminderDate</span><span class="tok-o">(</span><span class="tok-nl">nullable:</span><span class="tok-kc">true</span><span class="tok-o">)</span>
        <span class="tok-n">url</span><span class="tok-o">(</span><span class="tok-nl">nullable:</span><span class="tok-kc">true</span><span class="tok-o">,</span> <span class="tok-nl">url:</span><span class="tok-kc">true</span><span class="tok-o">)</span>
    <span class="tok-o">}</span>

    <span class="tok-n">String</span> <span class="tok-nf">toString</span><span class="tok-o">(){</span>
        <span class="tok-n">title</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Como puedes comprobar, en ningún momento se ha indicado ninguna propiedad como clave primaria y esto es debido a que Grails añade siempre las propiedades <em>id</em> y <em>version</em>, los cuales sirven respectivamente como clave primaria de la tabla en cuestión y para garantizar la integridad de los datos. La propiedad <em>version</em> es un mecanismo utilizado en <em>Hibernate</em> para el bloqueo de las tablas y que evita que se produzcan inconsistencias en los datos.</p>
</div>
<div class="paragraph">
<p>Por otro lado, la clase <em>Todo</em> no sólo contiene propiedades sino que también se han añadido una serie de restricciones (<em>constraints</em>) que deben cumplir dichas propiedades para que una tarea se pueda insertar en la base de datos. Por ejemplo, la propiedad <em>title</em> no puede dejarse en blanco, la propiedad <em>date</em> no puede ser <em>null</em>, mientras que las propiedades <em>description</em>, <em>reminderDate</em> y <em>url</em> pueden tener un valor <em>null</em> y además ésta última, en caso de contener valor, debe ser una dirección url bien formada. Además, observa también como la descripción no puede exceder de 1000 caracteres.</p>
</div>
</div>
<div class="sect3">
<h4 id="_creación_de_controladores">3.5.4. Creación de controladores</h4>
<div class="paragraph">
<p>Ahora que tenemos nuestra primera clase de dominio creada, necesitamos un controlador que gestione todas las peticiones que le lleguen a esta clase de dominio. El controlador es el encargado de gestionar la interacción entre la vista y las clases de dominio, con lo que podemos decir sin género de dudas que es la parte más ardua del sistema. Sin embargo, gracias a que Grails nos permite utilizar <em>scaffolding</em> esto se convierte de nuevo en un juego para niños.</p>
</div>
<div class="paragraph">
<p>Para crear un controlador en Grails, debemos ejecutar el comando <em>grails create-controller</em> y se generará un nuevo controlador en el directorio <em>grails-app/controllers</em>, así como un test unitario en el directorio <em>test/unit/&lt;paquete&gt;</em>. Antes de seguir vamos a crear el controlador de la clase <em>Todo</em> ejecutando <em>grails create-controller es.ua.expertojava.todo.todo</em>, el cual creará el archivo <em>grails-app/controllers/es/ua/expertojava/todo/TodoController.groovy</em> con el siguiente contenido</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">es</span><span class="tok-o">.</span><span class="tok-na">ua</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">todo</span>

<span class="tok-kd">class</span> <span class="tok-nc">TodoController</span> <span class="tok-o">{</span>

    <span class="tok-kt">def</span> <span class="tok-nf">index</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Además, tal y como pasaba cuando creábamos la clase de dominio, Grails crea por nosotros un test unitario llamado <em>es.ua.expertojava.todo.TodoControllerSpec</em> que nos permitirá más adelante testear el controlador.</p>
</div>
<div class="paragraph">
<p>Para poder utilizar <em>scaffolding</em> de la clase <em>Todo</em> simplemente debemos cambiar la línea</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">index</span> <span class="tok-o">=</span> <span class="tok-o">{}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>por el siguiente código</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">scaffold</span> <span class="tok-o">=</span> <span class="tok-n">Todo</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>o bien por</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">scaffold</span> <span class="tok-o">=</span> <span class="tok-kc">true</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si actualizamos la web de la aplicación veremos como nos aparece un nuevo enlace en el que podremos controlar las tareas de nuestra aplicación. El scaffolding de Grails ha creado por nosotros los cuatro métodos necesarios para la gestión de las tareas <em>creación</em>, <em>lectura</em>, <em>edición</em> y <em>borrado</em>. En la siguiente imagen podemos ver el formulario para añadir una nueva tarea.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/grails03/addtodo.png" alt="Añadir una tarea" width="50%">
</div>
</div>
<div class="paragraph">
<p>Si nos fijamos bien, observaremos que el orden para el formulario de creación de una nueva tarea sigue el mismo orden en el que aparecen definidas las restricciones para la validación de los datos. También es interesante ver como para la propiedad <em>description</em> ha creado un <em>textarea</em> en lugar de un campo <em>text</em> como ha hecho con el resto de propiedades de tipo <em>String</em>. Esto es porque para el campo <em>description</em> hemos establecido la restricción del tamaño máximo.</p>
</div>
<div class="paragraph">
<p>Probemos ahora a insertar tareas que no cumplan alguna de las restricciones que le impusimos en la definición de la clase de dominio. Si por ejemplo intentamos insertar una nueva tarea sin especificar su <em>título</em> el sistema nos proporcionará un error indicando que el campo en cuestión no puede estar vacío. Además, el campo de texto aparece remarcado en rojo para que el usuario sepa que ahí está pasando algo no permitido.</p>
</div>
<div class="paragraph">
<p>Si solucionamos este problema con el <em>título</em>, se insertará una nueva tarea en la base de datos de nuestra aplicación, que posteriormente podremos visualizar, editar y eliminar.</p>
</div>
<div class="paragraph">
<p>Continúemos con nuestro pequeño ejemplo de scaffolding, y para ello vamos a definir también la clase de dominio y el controlador para las <em>categorías</em> de las <em>tareas</em>. Empecemos creando las clases de dominio necesarias y empecemos por las <em>categorías</em> de las tareas. Para ello ejecutamos el comando <em>grails create-domain-class es.ua.expertojava.todo.category</em>. De estas categorías necesitamos conocer su <em>nombre</em> y una <em>descripción</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">es</span><span class="tok-o">.</span><span class="tok-na">ua</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">todo</span>

<span class="tok-kd">class</span> <span class="tok-nc">Category</span> <span class="tok-o">{</span>

    <span class="tok-n">String</span> <span class="tok-n">name</span>
    <span class="tok-n">String</span> <span class="tok-n">description</span>

    <span class="tok-kd">static</span> <span class="tok-n">hasMany</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-nl">todos:</span><span class="tok-n">Todo</span><span class="tok-o">]</span>

    <span class="tok-kd">static</span> <span class="tok-n">constraints</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
        <span class="tok-n">name</span><span class="tok-o">(</span><span class="tok-nl">blank:</span><span class="tok-kc">false</span><span class="tok-o">)</span>
        <span class="tok-n">description</span><span class="tok-o">(</span><span class="tok-nl">blank:</span><span class="tok-kc">true</span><span class="tok-o">,</span> <span class="tok-nl">nullable:</span><span class="tok-kc">true</span><span class="tok-o">,</span> <span class="tok-nl">maxSize:</span><span class="tok-mi">1000</span><span class="tok-o">)</span>
    <span class="tok-o">}</span>

    <span class="tok-n">String</span> <span class="tok-nf">toString</span><span class="tok-o">(){</span>
        <span class="tok-n">name</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lo novedoso en la declaración de la clase <em>Category</em> es la aparición de la especificación de la relación entre ésta y la clase <em>Todo</em>. Si pensamos en la relación existente entre las tareas y las categorías, está claro que esta relación es del tipo uno a muchos, es decir, que una categoría puede tener muchas tareas y que una tarea sólo pertenecerá por simplicidad a una categoría. Teniendo esto en cuenta, debemos especificar en la clase de dominio <em>Todo</em> la otra parte de la relación. Esto lo vamos a hacer añadiendo una nueva propiedad estática en la case de dominio del siguiente modo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">es</span><span class="tok-o">.</span><span class="tok-na">ua</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">todo</span>

<span class="tok-kd">class</span> <span class="tok-nc">Todo</span> <span class="tok-o">{</span>
    <span class="tok-n">String</span> <span class="tok-n">title</span>
    <span class="tok-n">String</span> <span class="tok-n">description</span>
    <span class="tok-n">Date</span> <span class="tok-n">date</span>
    <span class="tok-n">Date</span> <span class="tok-n">reminderDate</span>
    <span class="tok-n">String</span> <span class="tok-n">url</span>
    <span class="tok-n">Category</span> <span class="tok-n">category</span>

    <span class="tok-kd">static</span> <span class="tok-n">constraints</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
        <span class="tok-n">title</span><span class="tok-o">(</span><span class="tok-nl">blank:</span><span class="tok-kc">false</span><span class="tok-o">)</span>
        <span class="tok-n">description</span><span class="tok-o">(</span><span class="tok-nl">blank:</span><span class="tok-kc">true</span><span class="tok-o">,</span> <span class="tok-nl">nullable:</span><span class="tok-kc">true</span><span class="tok-o">,</span> <span class="tok-nl">maxSize:</span><span class="tok-mi">1000</span><span class="tok-o">)</span>
        <span class="tok-n">date</span><span class="tok-o">(</span><span class="tok-nl">nullable:</span><span class="tok-kc">false</span><span class="tok-o">)</span>
        <span class="tok-n">reminderDate</span><span class="tok-o">(</span><span class="tok-nl">nullable:</span><span class="tok-kc">true</span><span class="tok-o">)</span>
        <span class="tok-n">url</span><span class="tok-o">(</span><span class="tok-nl">nullable:</span><span class="tok-kc">true</span><span class="tok-o">,</span> <span class="tok-nl">url:</span><span class="tok-kc">true</span><span class="tok-o">)</span>
        <span class="tok-n">category</span><span class="tok-o">(</span><span class="tok-nl">nullable:</span><span class="tok-kc">true</span><span class="tok-o">)</span>
    <span class="tok-o">}</span>

    <span class="tok-n">String</span> <span class="tok-nf">toString</span><span class="tok-o">(){</span>
        <span class="tok-s2">&quot;title&quot;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Una vez ya tenemos definidas la clase de dominio <em>Category</em>, podemos crear el controlador e indicarle que queremos utilizar el scaffolding para gestionar su información. Para ello ejecutamos <em>grails create-controller es.ua.expertojava.todo.category</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">es</span><span class="tok-o">.</span><span class="tok-na">ua</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">todo</span>

<span class="tok-kd">class</span> <span class="tok-nc">CategoryController</span> <span class="tok-o">{</span>

    <span class="tok-kt">def</span> <span class="tok-n">scaffold</span> <span class="tok-o">=</span> <span class="tok-n">Category</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por último, vamos a añadir la clase de dominio referente a las etiquetas que vamos a poder asignar a las tareas. Ejecutamos <em>grails create-domain-class es.ua.expertojava.todo.tag</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">es</span><span class="tok-o">.</span><span class="tok-na">ua</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">todo</span>

<span class="tok-kd">class</span> <span class="tok-nc">Tag</span> <span class="tok-o">{</span>

    <span class="tok-n">String</span> <span class="tok-n">name</span>

    <span class="tok-kd">static</span> <span class="tok-n">hasMany</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-nl">todos:</span><span class="tok-n">Todo</span><span class="tok-o">]</span>

    <span class="tok-kd">static</span> <span class="tok-n">constraints</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
        <span class="tok-n">name</span><span class="tok-o">(</span><span class="tok-nl">blank:</span><span class="tok-kc">false</span><span class="tok-o">,</span> <span class="tok-nl">nullable:</span><span class="tok-kc">true</span><span class="tok-o">,</span> <span class="tok-nl">unique:</span><span class="tok-kc">true</span><span class="tok-o">)</span>
    <span class="tok-o">}</span>

    <span class="tok-n">String</span> <span class="tok-nf">toString</span><span class="tok-o">(){</span>
    	<span class="tok-n">name</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Como puedes observar, una etiqueta puede estar asignada a muchas tareas. De igual forma, una tarea podrá tener muchas etiquetas. Más adelante veremos a fondo como se deben establecer este tipo de relaciones.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">es</span><span class="tok-o">.</span><span class="tok-na">ua</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">todo</span>

<span class="tok-kd">class</span> <span class="tok-nc">Todo</span> <span class="tok-o">{</span>
    <span class="tok-n">String</span> <span class="tok-n">title</span>
    <span class="tok-n">String</span> <span class="tok-n">description</span>
    <span class="tok-n">Date</span> <span class="tok-n">date</span>
    <span class="tok-n">Date</span> <span class="tok-n">reminderDate</span>
    <span class="tok-n">String</span> <span class="tok-n">url</span>
    <span class="tok-n">Category</span> <span class="tok-n">category</span>

    <span class="tok-kd">static</span> <span class="tok-n">hasMany</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-nl">tags:</span><span class="tok-n">Tag</span><span class="tok-o">]</span>
    <span class="tok-kd">static</span> <span class="tok-n">belongsTo</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-n">Tag</span><span class="tok-o">]</span>

    <span class="tok-kd">static</span> <span class="tok-n">constraints</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
        <span class="tok-n">title</span><span class="tok-o">(</span><span class="tok-nl">blank:</span><span class="tok-kc">false</span><span class="tok-o">)</span>
        <span class="tok-n">description</span><span class="tok-o">(</span><span class="tok-nl">blank:</span><span class="tok-kc">true</span><span class="tok-o">,</span> <span class="tok-nl">nullable:</span><span class="tok-kc">true</span><span class="tok-o">,</span> <span class="tok-nl">maxSize:</span><span class="tok-mi">1000</span><span class="tok-o">)</span>
        <span class="tok-n">date</span><span class="tok-o">(</span><span class="tok-nl">nullable:</span><span class="tok-kc">false</span><span class="tok-o">)</span>
        <span class="tok-n">reminderDate</span><span class="tok-o">(</span><span class="tok-nl">nullable:</span><span class="tok-kc">true</span><span class="tok-o">)</span>
        <span class="tok-n">url</span><span class="tok-o">(</span><span class="tok-nl">nullable:</span><span class="tok-kc">true</span><span class="tok-o">,</span> <span class="tok-nl">url:</span><span class="tok-kc">true</span><span class="tok-o">)</span>
        <span class="tok-n">category</span><span class="tok-o">(</span><span class="tok-nl">nullable:</span><span class="tok-kc">true</span><span class="tok-o">)</span>
    <span class="tok-o">}</span>

    <span class="tok-n">String</span> <span class="tok-nf">toString</span><span class="tok-o">(){</span>
        <span class="tok-s2">&quot;title&quot;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Como siempre, no olvidemos crear el controlador que se encargará de gestionar las etiquetas:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">es</span><span class="tok-o">.</span><span class="tok-na">ua</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">todo</span>

<span class="tok-kd">class</span> <span class="tok-nc">TagController</span> <span class="tok-o">{</span>

    <span class="tok-kt">def</span> <span class="tok-n">scaffold</span> <span class="tok-o">=</span> <span class="tok-n">Tag</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora sí, nuestra aplicación empieza a tomar forma de como debe ser la aplicación final, aunque por supuesto todavía quedan muchas cosas que iremos viendo a lo largo del módulo. Ahora mismo, podemos empezar a probar la aplicación insertando datos en cada una de las clases y comprobar que todo funciona correctamente. Sin embargo, la labor de introducción de los datos a mano en la aplicación es algo muy repetitivo y aburrido, así que vamos a ver como podemos convertir esta tarea en algo más sencillo y no tener que repetirla cada vez que probamos la aplicación (recuerda que ahora mismo la base de datos está en memoria con lo que se destruye cada vez que reiniciamos la aplicación).</p>
</div>
<div class="paragraph">
<p>En el directorio de configuración de nuestra aplicación (<em>grails-app/conf</em>) tenemos un archivo llamado <em>BootStrap.groovy</em> cuya funcionalidad es posibilitar la realización de acciones al arrancar y al finalizar nuestra aplicación. Como ya estaréis imaginando, vamos a aprovechar este fichero para introducir algunos datos en nuestra aplicación para tener algo de información ya introducida en nuestra aplicación. El siguiente ejemplo, inserta tareas, categorías y etiquetas en nuestra aplicación.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">import</span> <span class="tok-nn">es.ua.expertojava.todo.*</span>

<span class="tok-kd">class</span> <span class="tok-nc">BootStrap</span> <span class="tok-o">{</span>

    <span class="tok-kt">def</span> <span class="tok-n">init</span> <span class="tok-o">=</span> <span class="tok-o">{</span> <span class="tok-n">servletContext</span> <span class="tok-o">-&gt;</span>
        <span class="tok-kt">def</span> <span class="tok-n">categoryHome</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Category</span><span class="tok-o">(</span><span class="tok-nl">name:</span><span class="tok-s2">&quot;Hogar&quot;</span><span class="tok-o">).</span><span class="tok-na">save</span><span class="tok-o">()</span>
        <span class="tok-kt">def</span> <span class="tok-n">categoryJob</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Category</span><span class="tok-o">(</span><span class="tok-nl">name:</span><span class="tok-s2">&quot;Trabajo&quot;</span><span class="tok-o">).</span><span class="tok-na">save</span><span class="tok-o">()</span>

        <span class="tok-kt">def</span> <span class="tok-n">tagEasy</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Tag</span><span class="tok-o">(</span><span class="tok-nl">name:</span><span class="tok-s2">&quot;Fácil&quot;</span><span class="tok-o">).</span><span class="tok-na">save</span><span class="tok-o">()</span>
        <span class="tok-kt">def</span> <span class="tok-n">tagDifficult</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Tag</span><span class="tok-o">(</span><span class="tok-nl">name:</span><span class="tok-s2">&quot;Difícil&quot;</span><span class="tok-o">).</span><span class="tok-na">save</span><span class="tok-o">()</span>
        <span class="tok-kt">def</span> <span class="tok-n">tagArt</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Tag</span><span class="tok-o">(</span><span class="tok-nl">name:</span><span class="tok-s2">&quot;Arte&quot;</span><span class="tok-o">).</span><span class="tok-na">save</span><span class="tok-o">()</span>
        <span class="tok-kt">def</span> <span class="tok-n">tagRoutine</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Tag</span><span class="tok-o">(</span><span class="tok-nl">name:</span><span class="tok-s2">&quot;Rutina&quot;</span><span class="tok-o">).</span><span class="tok-na">save</span><span class="tok-o">()</span>
        <span class="tok-kt">def</span> <span class="tok-n">tagKitchen</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Tag</span><span class="tok-o">(</span><span class="tok-nl">name:</span><span class="tok-s2">&quot;Cocina&quot;</span><span class="tok-o">).</span><span class="tok-na">save</span><span class="tok-o">()</span>

        <span class="tok-kt">def</span> <span class="tok-n">todoPaintKitchen</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Todo</span><span class="tok-o">(</span><span class="tok-nl">title:</span><span class="tok-s2">&quot;Pintar cocina&quot;</span><span class="tok-o">,</span> <span class="tok-nl">date:</span><span class="tok-k">new</span> <span class="tok-n">Date</span><span class="tok-o">()+</span><span class="tok-mi">1</span><span class="tok-o">)</span>
        <span class="tok-kt">def</span> <span class="tok-n">todoCollectPost</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Todo</span><span class="tok-o">(</span><span class="tok-nl">title:</span><span class="tok-s2">&quot;Recoger correo postal&quot;</span><span class="tok-o">,</span> <span class="tok-nl">date:</span><span class="tok-k">new</span> <span class="tok-n">Date</span><span class="tok-o">()+</span><span class="tok-mi">2</span><span class="tok-o">)</span>
        <span class="tok-kt">def</span> <span class="tok-n">todoBakeCake</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Todo</span><span class="tok-o">(</span><span class="tok-nl">title:</span><span class="tok-s2">&quot;Cocinar pastel&quot;</span><span class="tok-o">,</span> <span class="tok-nl">date:</span><span class="tok-k">new</span> <span class="tok-n">Date</span><span class="tok-o">()+</span><span class="tok-mi">4</span><span class="tok-o">)</span>
        <span class="tok-kt">def</span> <span class="tok-n">todoWriteUnitTests</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Todo</span><span class="tok-o">(</span><span class="tok-nl">title:</span><span class="tok-s2">&quot;Escribir tests unitarios&quot;</span><span class="tok-o">,</span> <span class="tok-nl">date:</span><span class="tok-k">new</span> <span class="tok-n">Date</span><span class="tok-o">())</span>

        <span class="tok-n">todoPaintKitchen</span><span class="tok-o">.</span><span class="tok-na">addToTags</span><span class="tok-o">(</span><span class="tok-n">tagDifficult</span><span class="tok-o">)</span>
        <span class="tok-n">todoPaintKitchen</span><span class="tok-o">.</span><span class="tok-na">addToTags</span><span class="tok-o">(</span><span class="tok-n">tagArt</span><span class="tok-o">)</span>
        <span class="tok-n">todoPaintKitchen</span><span class="tok-o">.</span><span class="tok-na">addToTags</span><span class="tok-o">(</span><span class="tok-n">tagKitchen</span><span class="tok-o">)</span>
        <span class="tok-n">todoPaintKitchen</span><span class="tok-o">.</span><span class="tok-na">category</span> <span class="tok-o">=</span> <span class="tok-n">categoryHome</span>
        <span class="tok-n">todoPaintKitchen</span><span class="tok-o">.</span><span class="tok-na">save</span><span class="tok-o">()</span>

        <span class="tok-n">todoCollectPost</span><span class="tok-o">.</span><span class="tok-na">addToTags</span><span class="tok-o">(</span><span class="tok-n">tagRoutine</span><span class="tok-o">)</span>
        <span class="tok-n">todoCollectPost</span><span class="tok-o">.</span><span class="tok-na">category</span> <span class="tok-o">=</span> <span class="tok-n">categoryJob</span>
        <span class="tok-n">todoCollectPost</span><span class="tok-o">.</span><span class="tok-na">save</span><span class="tok-o">()</span>

        <span class="tok-n">todoBakeCake</span><span class="tok-o">.</span><span class="tok-na">addToTags</span><span class="tok-o">(</span><span class="tok-n">tagEasy</span><span class="tok-o">)</span>
        <span class="tok-n">todoBakeCake</span><span class="tok-o">.</span><span class="tok-na">addToTags</span><span class="tok-o">(</span><span class="tok-n">tagKitchen</span><span class="tok-o">)</span>
        <span class="tok-n">todoBakeCake</span><span class="tok-o">.</span><span class="tok-na">category</span> <span class="tok-o">=</span> <span class="tok-n">categoryHome</span>
        <span class="tok-n">todoBakeCake</span><span class="tok-o">.</span><span class="tok-na">save</span><span class="tok-o">()</span>

        <span class="tok-n">todoWriteUnitTests</span><span class="tok-o">.</span><span class="tok-na">addToTags</span><span class="tok-o">(</span><span class="tok-n">tagEasy</span><span class="tok-o">)</span>
        <span class="tok-n">todoWriteUnitTests</span><span class="tok-o">.</span><span class="tok-na">category</span> <span class="tok-o">=</span> <span class="tok-n">categoryJob</span>
        <span class="tok-n">todoWriteUnitTests</span><span class="tok-o">.</span><span class="tok-na">save</span><span class="tok-o">()</span>
    <span class="tok-o">}</span>
    <span class="tok-kt">def</span> <span class="tok-n">destroy</span> <span class="tok-o">=</span> <span class="tok-o">{</span> <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_scaffolding_estático">3.5.5. Scaffolding estático</h4>
<div class="paragraph">
<p>Una vez hemos visto lo rápido que hemos desarrollado la base de nuestra aplicación, vamos a ver como podemos llegar algo más lejos con nuestras aplicaciones gracias al scaffolding estático. Hasta el momento, el código de nuestros controladores y vistas se genera al vuelo y no podemos realizar ni siquiera una pequeña modificación a estos artefactos.</p>
</div>
<div class="paragraph">
<p>Para pasar de scaffolding dinámico a estático, Grails dispone de tres comandos para realizar esta tarea:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>generate-controller</p>
</li>
<li>
<p>generate-views</p>
</li>
<li>
<p>generate-all</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Los tres comandos esperan como parámetro una clase de dominio para la cual generar el código necesario. Veamos un ejemplo sobre las clases de dominio de la aplicación.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">grails generate-all es.ua.expertojava.todo.Todo</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tras ejecutar este comando, si echamos un vistazo a nuestro proyecto en IntelliJ IDEA, veremos como el controlador <em>es.ua.expertojava.todo.TodoController</em> y el directorio de las vistas <em>views/todo</em> han cambiado considerablemente.</p>
</div>
<div class="paragraph">
<p>Por un lado, el controlador ahora tiene todo el contenido necesario de forma estática de forma que vamos a poder modificarlo según nuestras necesidades. Además, en el directorio de las vistas correspondientes a la clase de dominio <em>todo</em> podemos ver los archivos necesarios para poder completar el CRUD de la clase <em>Todo</em>.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/grails03/projectaftergenerateall.png" alt="Proyecto tras generar todo" width="50%">
</div>
</div>
<div class="paragraph">
<p>Los otros dos comandos comentados anteriormente van a realizar en conjunto las mismas acciones que el comando <em>generate-all</em>. Veamos un ejemplo con la clase de dominio <em>Tag</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">grails generate-controller es.ua.expertojava.todo.Tag
grails generate-views es.ua.expertojava.todo.Tag</code></pre>
</div>
</div>
<div class="paragraph">
<p>Como podrás comprobar en el proyecto, el controlador <em>es.ua.expertojava.todo.TagController</em> se ha definido de forma estática y las vistas han sido generadas para poder ser modificadas más fácilmente.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios_3">3.6. Ejercicios</h3>
<div class="sect3">
<h4 id="_marcar_como_realizada_una_tarea_0_25_puntos">3.6.1. Marcar como realizada una tarea (0.25 puntos)</h4>
<div class="paragraph">
<p>En la definición de la aplicación <em>todo</em> hemos pasado por alto algo fundamental y es que una tarea puede haber sido realizada o no. Añade la información necesaria a nuestras clases de dominio para saber si una tarea ha sido ya completada.</p>
</div>
<div class="paragraph">
<p>No olvides añadir el valor deseado en el archivo <em>Bootstrap.groovy</em> para la nueva propiedad añadida.</p>
</div>
</div>
<div class="sect3">
<h4 id="_modificación_pantalla_inicial_0_25_puntos">3.6.2. Modificación pantalla inicial (0.25 puntos)</h4>
<div class="paragraph">
<p>Vamos a modificar la pantalla de bienvenida a la aplicación con las siguientes indicaciones:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Eliminar el logo de Grails de la parte superior para indicar el nombre la aplicación</p>
</li>
<li>
<p>Indicar nuestro nombre, apellidos y DNI</p>
</li>
<li>
<p>Añadir una imagen de vuestro perfil (puede valer la misma que tenéis en el campus virtual)</p>
</li>
<li>
<p>Eliminar el bloque de la izquierda donde aparece toda la información relativa a nuestra aplicación</p>
</li>
<li>
<p>Añadir una descripción apropiada de la aplicación</p>
</li>
<li>
<p>Añadir los enlaces correspondientes a las acciones que podemos realizar por el momento en nuestra aplicación</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Podría quedar algo así:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/grails03/ejemplopantallainicial.png" alt="Ejemplo pantalla inicial aplicación TODO" width="50%">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_scaffolding_estático_sobre_la_clase_categoría_0_75_puntos">3.6.3. Scaffolding estático sobre la clase Categoría (0.75 puntos)</h4>
<div class="paragraph">
<p>La única clase de dominio que nos queda por definir de forma estática es la referente a las categorías. Utilicemos también scaffolding estático para esta clase. Además, vamos a realizar las siguientes modificaciones sobre las vistas de las categorías:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Cuando creamos una categoría, Grails nos ofrece un enlace para crear <em>tareas</em> que por el momento vamos a eliminar.</p>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/grails03/createcategory.png" alt="Crear una categoría" width="50%">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>En el listado de categorías, vamos a eliminar el campo descripción porque en ocasiones esa descripción puede ser demasiado extensa.</p>
</li>
<li>
<p>Cuando creamos una categoría utilizando la aplicación, el mensaje que aparece indica que la categoría con identificado <em>X</em> ha sido creada correctamente. Realiza los cambios necesarios en el controlador para que en lugar de indicar el identificador, aparezca el nombre de la nueva categoría creada.</p>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/grails03/categorycreatedwithid.png" alt="Indicando el identificador de la categoría" width="50%">
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/grails03/categorycreatedwithname.png" alt="Indicando el nombre de la categoría" width="50%">
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion04">4. Patrón MVC: Vistas y controladores.</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Tras una primera sesión introductoria a Grails en la que ya hemos visto como crear una sencilla aplicación utilizando el scaffolding que nos ofrece Grails. Aunque en esta primera sesión no hemos comentado nada sobre las vistas, ya podemos suponer como Grails las organiza siguiendo el principio de <em>convención sobre configuración</em>.</p>
</div>
<div class="paragraph">
<p>En esta sesión profundizaremos en más aspectos relativos a las vistas, tales como creación de plantillas o etiquetas. También aprovecharemos para hablar más detalladamente sobre los controladores en Grails.</p>
</div>
<div class="sect2">
<h3 id="_estructura_de_las_vistas_en_grails">4.1. Estructura de las vistas en Grails</h3>
<div class="paragraph">
<p>Lo primero que hay que comentar es que en Grails los archivos de las vistas de nuestras aplicaciones tienen extensión <em>GSP</em>. Además, y siguiendo con el paradigma de <em>convención sobre configuración</em>, Grails aconseja que las vistas utilizadas en nuestra aplicación se alojen en el directorio <em>grails-app/views</em>. Dentro de este directorio, al crear nuestro proyecto se ha creado también el subdirectorio <em>layouts</em>. Este directorio viene por defecto con un archivo <em>main.gsp</em>, que podríamos decir que es el encargado de pintar la apariencia de toda la aplicación en Grails.</p>
</div>
<div class="paragraph">
<p>Como comentábamos en la sesión de introducción a Grails, éste utiliza el framework Sitemesh para renderizar una aplicación en Grails y una de las características de Sitemesh es que utiliza lo que podríamos llamar un archivo padre (layout) y dentro de este archivo padre se pintarán todas las vistas de la aplicación. Veamos ahora el contenido del único archivo (<em>/grails-app/views/layouts/main.gsp</em>) que aparece por el momento en el directorio <em>layouts</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-cp">&lt;!DOCTYPE html&gt;</span>
<span class="tok-c">&lt;!--[if lt IE 7 ]&gt; &lt;html lang=&quot;en&quot; class=&quot;no-js ie6&quot;&gt; &lt;![endif]--&gt;</span>
<span class="tok-c">&lt;!--[if IE 7 ]&gt;    &lt;html lang=&quot;en&quot; class=&quot;no-js ie7&quot;&gt; &lt;![endif]--&gt;</span>
<span class="tok-c">&lt;!--[if IE 8 ]&gt;    &lt;html lang=&quot;en&quot; class=&quot;no-js ie8&quot;&gt; &lt;![endif]--&gt;</span>
<span class="tok-c">&lt;!--[if IE 9 ]&gt;    &lt;html lang=&quot;en&quot; class=&quot;no-js ie9&quot;&gt; &lt;![endif]--&gt;</span>
<span class="tok-c">&lt;!--[if (gt IE 9)|!(IE)]&gt;&lt;!--&gt;</span>
<span class="tok-nt">&lt;html</span> <span class="tok-na">lang=</span><span class="tok-s">&quot;en&quot;</span> <span class="tok-na">class=</span><span class="tok-s">&quot;no-js&quot;</span><span class="tok-nt">&gt;</span><span class="tok-c">&lt;!--&lt;![endif]--&gt;</span>
    <span class="tok-nt">&lt;head&gt;</span>
        <span class="tok-nt">&lt;meta</span> <span class="tok-na">http-equiv=</span><span class="tok-s">&quot;Content-Type&quot;</span> <span class="tok-na">content=</span><span class="tok-s">&quot;text/html; charset=UTF-8&quot;</span><span class="tok-nt">&gt;</span>
        <span class="tok-nt">&lt;meta</span> <span class="tok-na">http-equiv=</span><span class="tok-s">&quot;X-UA-Compatible&quot;</span> <span class="tok-na">content=</span><span class="tok-s">&quot;IE=edge,chrome=1&quot;</span><span class="tok-nt">&gt;</span>
        <span class="tok-nt">&lt;title&gt;&lt;g:layoutTitle</span> <span class="tok-na">default=</span><span class="tok-s">&quot;Grails&quot;</span><span class="tok-nt">/&gt;&lt;/title&gt;</span>
        <span class="tok-nt">&lt;meta</span> <span class="tok-na">name=</span><span class="tok-s">&quot;viewport&quot;</span> <span class="tok-na">content=</span><span class="tok-s">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="tok-nt">&gt;</span>
        <span class="tok-nt">&lt;link</span> <span class="tok-na">rel=</span><span class="tok-s">&quot;shortcut icon&quot;</span> <span class="tok-na">href=</span><span class="tok-s">&quot;${assetPath(src: &#39;favicon.ico&#39;)}&quot;</span> <span class="tok-na">type=</span><span class="tok-s">&quot;image/x-icon&quot;</span><span class="tok-nt">&gt;</span>
        <span class="tok-nt">&lt;link</span> <span class="tok-na">rel=</span><span class="tok-s">&quot;apple-touch-icon&quot;</span> <span class="tok-na">href=</span><span class="tok-s">&quot;${assetPath(src: &#39;apple-touch-icon.png&#39;)}&quot;</span><span class="tok-nt">&gt;</span>
        <span class="tok-nt">&lt;link</span> <span class="tok-na">rel=</span><span class="tok-s">&quot;apple-touch-icon&quot;</span> <span class="tok-na">sizes=</span><span class="tok-s">&quot;114x114&quot;</span> <span class="tok-na">href=</span><span class="tok-s">&quot;${assetPath(src: &#39;apple-touch-icon-retina.png&#39;)}&quot;</span><span class="tok-nt">&gt;</span>
        <span class="tok-nt">&lt;asset:stylesheet</span> <span class="tok-na">src=</span><span class="tok-s">&quot;application.css&quot;</span><span class="tok-nt">/&gt;</span>
        <span class="tok-nt">&lt;asset:javascript</span> <span class="tok-na">src=</span><span class="tok-s">&quot;application.js&quot;</span><span class="tok-nt">/&gt;</span>
        <span class="tok-nt">&lt;g:layoutHead/&gt;</span>
    <span class="tok-nt">&lt;/head&gt;</span>
    <span class="tok-nt">&lt;body&gt;</span>
        <span class="tok-nt">&lt;div</span> <span class="tok-na">id=</span><span class="tok-s">&quot;grailsLogo&quot;</span> <span class="tok-na">role=</span><span class="tok-s">&quot;banner&quot;</span><span class="tok-nt">&gt;&lt;a</span> <span class="tok-na">href=</span><span class="tok-s">&quot;http://grails.org&quot;</span><span class="tok-nt">&gt;&lt;asset:image</span> <span class="tok-na">src=</span><span class="tok-s">&quot;grails_logo.png&quot;</span> <span class="tok-na">alt=</span><span class="tok-s">&quot;Grails&quot;</span><span class="tok-nt">/&gt;&lt;/a&gt;&lt;/div&gt;</span>
        <span class="tok-nt">&lt;g:layoutBody/&gt;</span>
        <span class="tok-nt">&lt;div</span> <span class="tok-na">class=</span><span class="tok-s">&quot;footer&quot;</span> <span class="tok-na">role=</span><span class="tok-s">&quot;contentinfo&quot;</span><span class="tok-nt">&gt;&lt;/div&gt;</span>
        <span class="tok-nt">&lt;div</span> <span class="tok-na">id=</span><span class="tok-s">&quot;spinner&quot;</span> <span class="tok-na">class=</span><span class="tok-s">&quot;spinner&quot;</span> <span class="tok-na">style=</span><span class="tok-s">&quot;display:none;&quot;</span><span class="tok-nt">&gt;&lt;g:message</span> <span class="tok-na">code=</span><span class="tok-s">&quot;spinner.alt&quot;</span> <span class="tok-na">default=</span><span class="tok-s">&quot;Loading&amp;hellip;&quot;</span><span class="tok-nt">/&gt;&lt;/div&gt;</span>
    <span class="tok-nt">&lt;/body&gt;</span>
<span class="tok-nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si analizamos un poco el código fuente de este archivo <em>main.gsp</em>, comprobaremos la existencia de una serie de etiqueta que veremos posteriormente cuyo espacio de nombres es <em>g</em>, como por ejemplo <em>&lt;g:layoutTitle default="Grails"/&gt;</em>, <em>&lt;g:layoutHead/&gt;</em> o <em>&lt;g:layoutBody/&gt;</em>. Estas tres etiquetas están indicando a Grails que deben ser sustituidas por el título, la cabecera y el contenido de las páginas que estemos renderizando.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, otro archivo que ha creado Grails automáticamente es el archivo que se encuentra en la raiz del directorio <em>views</em> llamado <em>error.gsp</em>. El contenido de este archivo es el siguiente</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-cp">&lt;!DOCTYPE html&gt;</span>
<span class="tok-nt">&lt;html&gt;</span>
    <span class="tok-nt">&lt;head&gt;</span>
        <span class="tok-nt">&lt;title&gt;</span>
            <span class="tok-nt">&lt;g:if</span> <span class="tok-na">env=</span><span class="tok-s">&quot;development&quot;</span><span class="tok-nt">&gt;</span>Grails Runtime Exception<span class="tok-nt">&lt;/g:if&gt;&lt;g:else&gt;</span>Error<span class="tok-nt">&lt;/g:else&gt;</span>
        <span class="tok-nt">&lt;/title&gt;</span>
        <span class="tok-nt">&lt;meta</span> <span class="tok-na">name=</span><span class="tok-s">&quot;layout&quot;</span> <span class="tok-na">content=</span><span class="tok-s">&quot;main&quot;</span><span class="tok-nt">&gt;</span>
        <span class="tok-nt">&lt;g:if</span> <span class="tok-na">env=</span><span class="tok-s">&quot;development&quot;</span><span class="tok-nt">&gt;&lt;asset:stylesheet</span> <span class="tok-na">src=</span><span class="tok-s">&quot;errors.css&quot;</span><span class="tok-nt">/&gt;&lt;/g:if&gt;</span>
    <span class="tok-nt">&lt;/head&gt;</span>
    <span class="tok-nt">&lt;body&gt;</span>
        <span class="tok-nt">&lt;g:if</span> <span class="tok-na">env=</span><span class="tok-s">&quot;development&quot;</span><span class="tok-nt">&gt;</span>
            <span class="tok-nt">&lt;g:renderException</span> <span class="tok-na">exception=</span><span class="tok-s">&quot;${exception}&quot;</span> <span class="tok-nt">/&gt;</span>
        <span class="tok-nt">&lt;/g:if&gt;</span>
        <span class="tok-nt">&lt;g:else&gt;</span>
            <span class="tok-nt">&lt;ul</span> <span class="tok-na">class=</span><span class="tok-s">&quot;errors&quot;</span><span class="tok-nt">&gt;</span>
                <span class="tok-nt">&lt;li&gt;</span>An error has occurred<span class="tok-nt">&lt;/li&gt;</span>
            <span class="tok-nt">&lt;/ul&gt;</span>
        <span class="tok-nt">&lt;/g:else&gt;</span>
    <span class="tok-nt">&lt;/body&gt;</span>
<span class="tok-nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>¿Cómo actuaría Grails cuando quiera pintar este archivo <em>error.gsp</em>? En primer lugar, detecta que este archivo se tiene que pintar envuelto en el layout <em>main</em> puesto que tenemos la etiqueta <em>&lt;meta name="layout" content="main"&gt;</em>. Una vez Grails ya sabe que esa página debe ser pintada utilizando un envoltorio (layout), realizará las sustituciones correspondientes en las etiquetas de dicho envoltorio <em>&lt;g:layoutTitle default="Grails"/&gt;</em> (sustituida por el texto Grails Runtime Exception), <em>&lt;g:layoutHead/&gt;</em> (sustituido por todo lo que esté dentro de la cabecera de <em>error.gsp</em>, que en este caso es únicamente la referencia a los estilos <em>&lt;g:layoutHead/&gt;</em>) y <em>&lt;g:layoutBody/&gt;</em>, que será sustituido por la salida que produzca la etiqueta <em>&lt;g:renderException exception="${exception}" /&gt;</em> en caso de que estemos en el entorno de desarrollo o bien por un texto indicando <em>"An error has ocurred"</em>.</p>
</div>
<div class="paragraph">
<p>Una vez tenemos claro como se organizan las vistas en un proyecto desarrollado en Grails, ¿cómo podemos organizar estas vistas de forma lógica? En Grails vamos a distinguir dos tipos de vistas: las plantillas y las vistas. Básicamente las primeras serán fragmentos de código que podremos utilizar en varias partes de nuestra aplicación mientras que las vistas se corresponderán con páginas renderizadas gracias a una llamada de un controlador.</p>
</div>
</div>
<div class="sect2">
<h3 id="_plantillas">4.2. Plantillas</h3>
<div class="paragraph">
<p>En Grails las plantillas se diferencian de las vistas porque en las primeras su nombre siempre empieza por un subrayado bajo. Otra diferencia notable entre las vistas y las plantillas, es su utilidad y es que las plantillas normalmente las utilizaremos insertadas en vistas y nos facilitará la labor en aquellas partes de las interfaz de usuario que aparezca en varias páginas. Un buen ejemplo de una plantilla podría ser el menú con todas las opciones de nuestra aplicación.</p>
</div>
<div class="paragraph">
<p>Las buenas prácticas de Grails indican que cualquier plantilla relacionada con una clase de dominio deben estar alojadas todas en un directorio, como por ejemplo <em>grails-app/views/todo/_mytemplate.gsp</em>. De igual forma, aquellas plantillas que vayan a ser utilizadas de una forma más genérica en varias clases de dominio, deben alojarse en un lugar común, por ejemplo en <em>grails-app/views/common</em>. Las plantillas tendrán extensión GSP que son las siglas de <em>Groovy Server Pages</em>.</p>
</div>
<div class="sect3">
<h4 id="_plantilla_de_pie_de_página">4.2.1. Plantilla de pie de página</h4>
<div class="paragraph">
<p>Para comprobar el funcionamiento de las plantillas en Grails, vamos a crear una que nos permita mostrar un pie de página en toda nuestra aplicación que sustituirá al que Grails ha creado por nosotros. Como es una plantilla común a toda la aplicación, la almacenaremos en el directorio <em>grails-app/views/common</em> y la vamos a llamar <em>_footer.gsp</em> y su contenido será algo parecido a esto:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">&lt;</span><span class="tok-n">div</span> <span class="tok-n">class</span><span class="tok-o">=</span><span class="tok-s2">&quot;footer&quot;</span> <span class="tok-n">role</span><span class="tok-o">=</span><span class="tok-s2">&quot;contentinfo&quot;</span><span class="tok-o">&gt;</span>
    <span class="tok-o">&amp;</span><span class="tok-n">copy</span><span class="tok-o">;</span> <span class="tok-mi">2015</span> <span class="tok-n">Experto</span> <span class="tok-n">en</span> <span class="tok-n">Desarrollo</span> <span class="tok-n">de</span> <span class="tok-n">Aplicaciones</span> <span class="tok-n">Web</span> <span class="tok-n">con</span> <span class="tok-n">JavaEE</span> <span class="tok-n">y</span> <span class="tok-n">Javascript</span><span class="tok-o">&lt;</span><span class="tok-n">br</span><span class="tok-s">/&gt;</span>
<span class="tok-s">    Aplicación Todo creada por Francisco José García Rico (21.542.334F)</span>
<span class="tok-s">&lt;/</span><span class="tok-n">div</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Una vez creada la plantilla, necesitamos poder incrustarla en nuestro proyecto. Para ello, vamos a modificar el layout <em>main.gsp</em> para incluir la llamada correspondiente a esta plantilla. Nosotros vamos a añadir esta plantilla justo después de la etiqueta <em>&lt;g:layoutBody/&gt;</em>, quedando de esta forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">...</span>
<span class="tok-o">&lt;</span><span class="tok-nl">g:</span><span class="tok-n">layoutBody</span><span class="tok-s">/&gt;</span>
<span class="tok-s">&lt;g:render template=&quot;/</span><span class="tok-n">common</span><span class="tok-s">/footer&quot;/</span><span class="tok-o">&gt;</span>
<span class="tok-o">&lt;</span><span class="tok-n">div</span> <span class="tok-n">id</span><span class="tok-o">=</span><span class="tok-s2">&quot;spinner&quot;</span><span class="tok-o">...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para pintar la plantilla correspondiente hemos utilizado la etiqueta de Grails <em>g:render</em> y como habrás podido comprobar, no es necesario poner ni el subrayado bajo ni la extensión gsp en el parámetro <em>template</em>, puesto que Grails ya lo hace por nosotros.</p>
</div>
<div class="paragraph">
<p>Nuestra aplicación ya dispone de un pie de página con la información sobre los creadores de la aplicación. Pero, ¿qué pasa si queremos modificar la apariencia de como se muestra este pie de página para por ejemplo centrar el texto? Esto lo conseguiremos editando la información relativa a los estilos de la página (CSS). Las hojas de estilos de las aplicaciones en Grails se encuentran en el directorio <em>grails-app/assets/stylesheets/</em>, y concretamente tenemos un archivo llamado <em>main.css</em>. Lo que vamos a hacer a continuación es modificar la clase correspondiente al pie de página (<em>.footer</em>). Abrimos la hoja de estilos <em>main.css</em> y localizamos la clase <em>.footer</em> para dejarla de la siguiente forma.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="css"><span class="tok-nc">.footer</span> <span class="tok-p">{</span>
    <span class="tok-k">background</span><span class="tok-o">:</span> <span class="tok-m">#abbf78</span><span class="tok-p">;</span>
    <span class="tok-k">color</span><span class="tok-o">:</span> <span class="tok-m">#000</span><span class="tok-p">;</span>
    <span class="tok-k">clear</span><span class="tok-o">:</span> <span class="tok-k">both</span><span class="tok-p">;</span>
    <span class="tok-k">font-size</span><span class="tok-o">:</span> <span class="tok-m">0.8em</span><span class="tok-p">;</span>
    <span class="tok-k">margin-top</span><span class="tok-o">:</span> <span class="tok-m">1.5em</span><span class="tok-p">;</span>
    <span class="tok-k">padding</span><span class="tok-o">:</span> <span class="tok-m">1em</span><span class="tok-p">;</span>
    <span class="tok-k">min-height</span><span class="tok-o">:</span> <span class="tok-m">1em</span><span class="tok-p">;</span>
    <span class="tok-k">text-align</span><span class="tok-o">:</span><span class="tok-k">center</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_plantilla_de_encabezado">4.2.2. Plantilla de encabezado</h4>
<div class="paragraph">
<p>La primera plantilla que hemos creado no nos ha supuesto mucha complicación y era muy sencilla de implementar, pero al menos nos ha servido como introducción al sistema de plantillas de Grails y a comprender como se renderizan estas plantillas en el sistema. La segunda plantilla que vamos a implementar nos va a complicar algo más la vida.</p>
</div>
<div class="paragraph">
<p>Aunque nuestra aplicación todavía no tiene el concepto de usuario (es algo que añadiremos en la sesión 7), esta plantilla será la encargada de mostrar un enlace indicando la palabra <em>login</em> para que cuando los futuros usuarios hagan clic sobre ella, aparezca un formulario donde el usuario podrá identificarse en el sistema. Ahora bien, ¿qué pasa si el usuario ya se ha identificado? Pues lo que se hace habitualmente es modificar esa primera línea para que en lugar de mostrar un enlace con la palabra <em>login</em>, se muestre una línea con el nombre completo del usuario en cuestión y un enlace para que abandone el sistema de forma segura. Eso es lo que vamos a hacer con esta segunda plantilla.</p>
</div>
<div class="paragraph">
<p>En primer lugar, vamos a modificar el archivo <em>grails-app/views/layout/main.gsp</em> para que en la parte superior de la aplicación, aparezca un encabezado que definiremos posteriormente. El archivo <em>main.gsp</em> quedaría así:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html">...
<span class="tok-nt">&lt;body&gt;</span>
<span class="tok-nt">&lt;g:render</span> <span class="tok-na">template=</span><span class="tok-s">&quot;/common/header&quot;</span><span class="tok-nt">/&gt;</span>
<span class="tok-nt">&lt;div</span> <span class="tok-na">id=</span><span class="tok-s">&quot;grailsLogo&quot;</span> <span class="tok-na">role=</span><span class="tok-s">&quot;banner&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;a</span> <span class="tok-na">href=</span><span class="tok-s">&quot;http://grails.org&quot;</span><span class="tok-nt">&gt;</span>
        <span class="tok-nt">&lt;img</span> <span class="tok-na">src=</span><span class="tok-s">&quot;${resource(dir: &#39;images&#39;, file: &#39;grails_logo.png&#39;)}&quot;</span> <span class="tok-na">alt=</span><span class="tok-s">&quot;Grails&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;/a&gt;</span>
<span class="tok-nt">&lt;/div&gt;</span>
<span class="tok-nt">&lt;g:layoutBody/&gt;</span>
<span class="tok-nt">&lt;g:render</span> <span class="tok-na">template=</span><span class="tok-s">&quot;/common/footer&quot;</span><span class="tok-nt">/&gt;</span>
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Si intentas actualizar ahora la aplicación, verás como Grails nos devuelve un error y esto es debido a que todavía no hemos creado la correspondiente plantilla <em>_header.gsp</em>, así que antes de continuar vamos a crearla en el directorio <em>grails-app/views/common/</em>, puesto que es una plantilla que se utilizará a lo largo de toda la aplicación independientemente de la clase que estemos utilizando en cada momento. Vamos a ver el contenido de esta nueva plantilla y luego lo comentamos más ampliamente.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;div</span> <span class="tok-na">id=</span><span class="tok-s">&quot;menu&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;nobr&gt;</span>
        <span class="tok-nt">&lt;g:if</span> <span class="tok-na">test=</span><span class="tok-s">&quot;${isUserLoggedIn}&quot;</span><span class="tok-nt">&gt;</span>
            <span class="tok-nt">&lt;b&gt;</span>${userInstance?.name} ${userInstance?.surnames}<span class="tok-nt">&lt;/b&gt;</span> |
            <span class="tok-nt">&lt;g:link</span> <span class="tok-na">controller=</span><span class="tok-s">&quot;user&quot;</span> <span class="tok-na">action=</span><span class="tok-s">&quot;logout&quot;</span><span class="tok-nt">&gt;</span>Logout<span class="tok-nt">&lt;/g:link&gt;</span>
        <span class="tok-nt">&lt;/g:if&gt;</span>
        <span class="tok-nt">&lt;g:else&gt;</span>
            <span class="tok-nt">&lt;g:link</span> <span class="tok-na">controller=</span><span class="tok-s">&quot;user&quot;</span> <span class="tok-na">action=</span><span class="tok-s">&quot;login&quot;</span><span class="tok-nt">&gt;</span>Login<span class="tok-nt">&lt;/g:link&gt;</span>
        <span class="tok-nt">&lt;/g:else&gt;</span>
    <span class="tok-nt">&lt;/nobr&gt;</span>
<span class="tok-nt">&lt;/div&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si actualizamos ahora la aplicación en el navegador, veremos como el enlace con la palabra <em>Login</em> queda a la izquierda, lo que no es lo habitual en las aplicaciones web, donde suele aparecer casi siempre en la parte superior derecha de la pantalla. Para solucionar esto, volvemos a editar los estilos de nuestra aplicación y le añadimos las siguientes entradas:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="css"><span class="tok-nf">#header</span> <span class="tok-p">{</span>
    <span class="tok-k">text-align</span><span class="tok-o">:</span><span class="tok-k">left</span><span class="tok-p">;</span>
    <span class="tok-k">margin</span><span class="tok-o">:</span> <span class="tok-m">0px</span><span class="tok-p">;</span>
    <span class="tok-k">padding</span><span class="tok-o">:</span> <span class="tok-m">0</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-nf">#header</span> <span class="tok-nf">#menu</span><span class="tok-p">{</span>
    <span class="tok-k">float</span><span class="tok-o">:</span> <span class="tok-k">right</span><span class="tok-p">;</span>
    <span class="tok-k">width</span><span class="tok-o">:</span> <span class="tok-m">240px</span><span class="tok-p">;</span>
    <span class="tok-k">text-align</span><span class="tok-o">:</span><span class="tok-k">right</span><span class="tok-p">;</span>
    <span class="tok-k">font-size</span><span class="tok-o">:</span><span class="tok-m">12px</span><span class="tok-p">;</span>
    <span class="tok-k">padding</span><span class="tok-o">:</span><span class="tok-m">4px</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ya tenemos alineado a la derecha el texto con la palabra <em>Login</em>, que además, aparecerá en cualquier página de la aplicación. Antes de continuar, vamos a explicar el contenido del archivo <em>grails-app/views/common/_header.gsp</em>. Podemos comprobar como se hace una comprobación para saber si el usuario actual se ha identificado o no en nuestro sistema. Para realizar esta comprobación utilizamos la etiqueta <em>&lt;g:if&gt;</em>, a la que se le pasa el parámetro <em>test</em> con la variable <em>${isUserLoggedIn}</em> (variable que todavía no existe). En caso de que esta variable esté ya definida (el usuario ya se ha identificado en el sistema), se mostrará su nombre y apellidos seguido de un enlace para que abandone la aplicación de forma segura. En caso contrario, se le mostrará un enlace con la palabra <em>Login</em> para que se identifique. En ambos casos, se utiliza la etiqueta <em>&lt;g:link&gt;</em> que permite crear enlaces que apunten a una determinada acción de un controlador, tal y como veremos más adelante.</p>
</div>
<div class="paragraph">
<p>Si ahora hacemos clic sobre <em>Login</em>, veremos como Grails nos devuelve un error del tipo 404, puesto que no hemos definido nada para que la aplicación actúe en consecuencia. Lo dejaremos así hasta que nuestra aplicación soporte usuarios que veremos en la sesión de Spring Security.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_páginas">4.3. Páginas</h3>
<div class="paragraph">
<p>Las páginas en Grails podemos definirlas como aquellos archivos de la interfaz de usuario que se pintarán a partir de una llamada realizada desde un controlador. Por ejemplo, si nuestra aplicación necesita una sección con las preguntas más frecuentes de la aplicación, podríamos crear una vista llamada <em>faqs.gsp</em> que se encargue de esto. Además, como esta vista no va a pertenecer a ninguna clase de dominio en cuestión sino que será común a toda la aplicación, la ubicaremos en el directorio <em>/grails-app/views/common</em>. Más adelante crearemos un controlador que se encargará de pintar las preguntas más frecuentes de nuestra aplicación.</p>
</div>
<div class="paragraph">
<p>Aunque ya te habrás dado cuenta, a diferencia de las plantillas, las vistas no deben utilizar un subrayado bajo al inicio del nombre pero también deben tener extensión GSP.</p>
</div>
<div class="sect3">
<h4 id="_variables_y_alcance_de_las_mismas_en_páginas">4.3.1. Variables y alcance de las mismas en páginas</h4>
<div class="paragraph">
<p>En GSP podemos utilizar podemos utilizar los símbolos <em>&lt;%  %&gt;</em> de la siguiente forma</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">&lt;%</span> <span class="tok-n">now</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Date</span><span class="tok-o">()</span> <span class="tok-o">%&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y de forma similar podemos acceder a esa variables con</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">&lt;%=</span> <span class="tok-n">now</span> <span class="tok-o">%&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Dentro del alcance de una página GSP, tendremos a nuestra disposición una serie de variables predefinidas, que son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>application - Instancia de <a href="http://docs.oracle.com/javaee/7/api/javax/servlet/ServletContext.html">javax.servlet.ServletContext</a></p>
</li>
<li>
<p>applicationContext - Instancia de Spring ApplicationContext</p>
</li>
<li>
<p>flash - El objecto flash que veremos más adelante en la sección de los controladores</p>
</li>
<li>
<p>grailsApplication - Instancia de GrailsApplication</p>
</li>
<li>
<p>out - Un response writer para escribir la salida</p>
</li>
<li>
<p>params - Los parámetros pasados en la petición</p>
</li>
<li>
<p>request - Instnaica de <a href="http://docs.oracle.com/javaee/7/api/javax/servlet/http/HttpServletRequest.html">HttpServletRequest</a></p>
</li>
<li>
<p>response - Instancia de <a href="http://docs.oracle.com/javaee/7/api/javax/servlet/http/HttpServletResponse.html">HttpServletResponse</a></p>
</li>
<li>
<p>session - Instancia de <a href="http://docs.oracle.com/javaee/7/api/javax/servlet/http/HttpSession.html">HttpSession</a></p>
</li>
<li>
<p>webRequest - Instancia de <a href="http://grails.org/doc/latest/api/org/codehaus/groovy/grails/web/servlet/mvc/GrailsWebRequest.html">GrailsWebRequest</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Utilizando los símbolos &lt;% y %&gt; vamos a poder realizar bucles:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">&lt;</span><span class="tok-n">html</span><span class="tok-o">&gt;</span>
   <span class="tok-o">&lt;</span><span class="tok-n">body</span><span class="tok-o">&gt;</span>
      <span class="tok-o">&lt;%</span> <span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">].</span><span class="tok-na">each</span> <span class="tok-o">{</span> <span class="tok-n">num</span> <span class="tok-o">-&gt;</span> <span class="tok-o">%&gt;</span>
         <span class="tok-o">&lt;</span><span class="tok-n">p</span><span class="tok-o">&gt;&lt;%=</span><span class="tok-s2">&quot;Hello ${num}!&quot;</span> <span class="tok-o">%&gt;&lt;</span><span class="tok-s">/p&gt;</span>
<span class="tok-s">      &lt;%}%&gt;</span>
<span class="tok-s">   &lt;/</span><span class="tok-n">body</span><span class="tok-o">&gt;</span>
<span class="tok-o">&lt;/</span><span class="tok-n">html</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>así como comprobaciónes lógicas:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">&lt;</span><span class="tok-n">html</span><span class="tok-o">&gt;</span>
   <span class="tok-o">&lt;</span><span class="tok-n">body</span><span class="tok-o">&gt;</span>
      <span class="tok-o">&lt;%</span> <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">params</span><span class="tok-o">.</span><span class="tok-na">hello</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;true&#39;</span><span class="tok-o">)%&gt;</span>
      <span class="tok-o">&lt;%=</span><span class="tok-s2">&quot;Hello!&quot;</span><span class="tok-o">%&gt;</span>
      <span class="tok-o">&lt;%</span> <span class="tok-k">else</span> <span class="tok-o">%&gt;</span>
      <span class="tok-o">&lt;%=</span><span class="tok-s2">&quot;Goodbye!&quot;</span><span class="tok-o">%&gt;</span>
   <span class="tok-o">&lt;</span><span class="tok-s">/body&gt;</span>
<span class="tok-s">&lt;/</span><span class="tok-n">html</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_directivas_de_páginas">4.3.2. Directivas de páginas</h4>
<div class="paragraph">
<p>Las páginas GSP soportan además algunas directivas típicas de las JSP tales como <em>importar clases</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">&lt;%</span><span class="tok-err">@</span> <span class="tok-n">page</span> <span class="tok-n">import</span><span class="tok-o">=</span><span class="tok-s2">&quot;java.awt.*&quot;</span> <span class="tok-o">%&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>o incluso las directivas para especificar el tipo de contenido de la página visualizada:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">&lt;%</span><span class="tok-err">@</span> <span class="tok-n">page</span> <span class="tok-n">contentType</span><span class="tok-o">=</span><span class="tok-s2">&quot;text/json&quot;</span> <span class="tok-o">%&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_expresiones">4.3.3. Expresiones</h4>
<div class="paragraph">
<p>La sintaxis vista en el punto anterior que utiliza los símbolos &lt;% y %&gt; sin embargo no es tan utilizada debido a la existencia de las expresiones GSP, que son similares a las expresiones JSP EL y tienen la forma <em>${expresion}</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">&lt;</span><span class="tok-n">html</span><span class="tok-o">&gt;</span>
  <span class="tok-o">&lt;</span><span class="tok-n">body</span><span class="tok-o">&gt;</span>
    <span class="tok-n">Hello</span> <span class="tok-n">$</span><span class="tok-o">{</span><span class="tok-n">params</span><span class="tok-o">.</span><span class="tok-na">name</span><span class="tok-o">}</span>
  <span class="tok-o">&lt;</span><span class="tok-s">/body&gt;</span>
<span class="tok-s">&lt;/</span><span class="tok-n">html</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_etiquetas">4.4. Etiquetas</h3>
<div class="paragraph">
<p>En los ejemplos que hemos visto hasta el momento, han aparecido algunas de las etiquetas más utilizadas en Grails. Sin embargo, son muchas más las disponibles y a continuación vamos a ver algunas de ellas. El número de etiquetas de Grails crece continuamente gracias al aporte de la cada vez mayor comunidad de usuarios con sus plugins. A continuación vamos a ver aquellas etiquetas que vienen con el <em>core</em> de Grails.</p>
</div>
<div class="sect3">
<h4 id="_etiquetas_lógicas">4.4.1. Etiquetas lógicas</h4>
<div class="paragraph">
<p>Estas etiquetas nos permitirán realizar comprobaciones del tipo <em>si-entonces-sino</em>.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33%;">
<col style="width: 33%;">
<col style="width: 33%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Etiqueta</th>
<th class="tableblock halign-left valign-top">Descripción</th>
<th class="tableblock halign-left valign-top">API</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:if&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Evalúa una expresión y actúa en consecuencia</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/if.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/if.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:else&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">La parte <em>else</em> del bloque <em>if</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/else.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/else.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:elseif&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">La parte <em>elseif</em> del bloque <em>if</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/elseif.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/elseif.html</a></p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;g:if</span> <span class="tok-na">test=</span><span class="tok-s">&quot;${userInstance?.type == &#39;admin&#39;}&quot;</span><span class="tok-nt">&gt;</span>
   <span class="tok-err">&lt;</span>%-- mostrar funciones de administrador --%&gt;
<span class="tok-nt">&lt;/g:if&gt;</span>
<span class="tok-nt">&lt;g:else&gt;</span>
   <span class="tok-err">&lt;</span>%-- mostrar funciones básicas --%&gt;
<span class="tok-nt">&lt;/g:else&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_etiquetas_de_iteración">4.4.2. Etiquetas de iteración</h4>
<div class="paragraph">
<p>Son utilizadas para iterar a través de colecciones de datos o hasta que una determinada condición se evalúe a falso.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33%;">
<col style="width: 33%;">
<col style="width: 33%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Etiqueta</th>
<th class="tableblock halign-left valign-top">Descripción</th>
<th class="tableblock halign-left valign-top">API</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:while&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ejecuta un bloque de código mientras una condición se evalúe a cierto</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/while.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/while.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:each&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Itera sobre una colección de objetos</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/each.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/each.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:collect&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Itera sobre una colección y transforma los resultados tal y como se defina en el parámetro <em>expr</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/collect.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/collect.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:findAll&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Itera sobre una colección donde los elementos se corresponden con la expresión GPath definida en el parámetro <em>expr</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/findAll.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/findAll.html</a></p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">&lt;</span><span class="tok-nl">g:</span><span class="tok-n">set</span> <span class="tok-n">var</span><span class="tok-o">=</span><span class="tok-s2">&quot;num&quot;</span> <span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-s2">&quot;${1}&quot;</span> <span class="tok-s">/&gt;</span>
<span class="tok-s">&lt;g:while test=&quot;${num &lt; 5 }&quot;&gt;</span>
<span class="tok-s">    &lt;p&gt;Number ${num++}</span>
<span class="tok-s">&lt;/</span><span class="tok-nl">g:</span><span class="tok-k">while</span><span class="tok-o">&gt;</span>

<span class="tok-cm">/*************************************/</span>

<span class="tok-o">&lt;</span><span class="tok-nl">g:</span><span class="tok-n">each</span> <span class="tok-k">in</span><span class="tok-o">=</span><span class="tok-s2">&quot;${[1,2,3]}&quot;</span> <span class="tok-n">var</span><span class="tok-o">=</span><span class="tok-s2">&quot;num&quot;</span><span class="tok-o">&gt;</span>
   <span class="tok-o">&lt;</span><span class="tok-n">p</span><span class="tok-o">&gt;</span><span class="tok-n">Number</span> <span class="tok-n">$</span><span class="tok-o">{</span><span class="tok-n">num</span><span class="tok-o">}&lt;</span><span class="tok-s">/p&gt;</span>
<span class="tok-s">&lt;/</span><span class="tok-nl">g:</span><span class="tok-n">each</span><span class="tok-o">&gt;</span>

<span class="tok-cm">/*************************************/</span>
<span class="tok-n">Stephen</span> <span class="tok-n">King</span><span class="tok-s1">&#39;s Books:</span>
<span class="tok-s1">&lt;g:findAll in=&quot;${books}&quot; expr=&quot;it.author == &#39;</span><span class="tok-n">Stephen</span> <span class="tok-n">King</span><span class="tok-err">&#39;&quot;</span><span class="tok-o">&gt;</span>
     <span class="tok-o">&lt;</span><span class="tok-n">p</span><span class="tok-o">&gt;</span><span class="tok-nl">Title:</span> <span class="tok-n">$</span><span class="tok-o">{</span><span class="tok-n">it</span><span class="tok-o">.</span><span class="tok-na">title</span><span class="tok-o">}</span>
<span class="tok-o">&lt;/</span><span class="tok-nl">g:</span><span class="tok-n">findAll</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_etiquetas_de_asignación">4.4.3. Etiquetas de asignación</h4>
<div class="paragraph">
<p>Nos servirán para asignar valores a variables.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33%;">
<col style="width: 33%;">
<col style="width: 33%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Etiqueta</th>
<th class="tableblock halign-left valign-top">Descripción</th>
<th class="tableblock halign-left valign-top">API</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:set&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define y establece el valor de una variable utilizada en una página GSP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/set.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/set.html</a></p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">&lt;</span><span class="tok-nl">g:</span><span class="tok-n">set</span> <span class="tok-n">var</span><span class="tok-o">=</span><span class="tok-s2">&quot;now&quot;</span> <span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-s2">&quot;${new Date()}&quot;</span> <span class="tok-s">/&gt;</span>

<span class="tok-s">/</span><span class="tok-o">*************************************</span><span class="tok-s">/</span>
<span class="tok-s">&lt;g:set var=&quot;myHTML&quot;&gt;</span>
<span class="tok-s">   Some re-usable code on: ${new Date()}</span>
<span class="tok-s">&lt;/</span><span class="tok-nl">g:</span><span class="tok-n">set</span><span class="tok-o">&gt;</span>

<span class="tok-cm">/*************************************/</span>
<span class="tok-o">&lt;</span><span class="tok-nl">g:</span><span class="tok-n">set</span> <span class="tok-n">var</span><span class="tok-o">=</span><span class="tok-s2">&quot;now&quot;</span> <span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-s2">&quot;${new Date()}&quot;</span> <span class="tok-n">scope</span><span class="tok-o">=</span><span class="tok-s2">&quot;request&quot;</span> <span class="tok-o">/&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_etiquetas_de_enlaces">4.4.4. Etiquetas de enlaces</h4>
<div class="paragraph">
<p>Crean enlaces a partir de los parámetros pasados.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33%;">
<col style="width: 33%;">
<col style="width: 33%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Etiqueta</th>
<th class="tableblock halign-left valign-top">Descripción</th>
<th class="tableblock halign-left valign-top">API</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:link&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Crea un enlace HTML utilizando los parámetros pasados</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/link.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/link.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:createLink&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Crea un enlace HTML que puede ser utilizado dentro de otras etiquetas</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/createLink.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/createLink.html</a></p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;g:link</span> <span class="tok-na">action=</span><span class="tok-s">&quot;show&quot;</span> <span class="tok-na">id=</span><span class="tok-s">&quot;1&quot;</span><span class="tok-nt">&gt;</span>Book 1<span class="tok-nt">&lt;/g:link&gt;</span>
<span class="tok-nt">&lt;g:link</span> <span class="tok-na">action=</span><span class="tok-s">&quot;show&quot;</span> <span class="tok-na">id=</span><span class="tok-s">&quot;${currentBook.id}&quot;</span><span class="tok-nt">&gt;</span>${currentBook.name}<span class="tok-nt">&lt;/g:link&gt;</span>
<span class="tok-nt">&lt;g:link</span> <span class="tok-na">controller=</span><span class="tok-s">&quot;book&quot;</span><span class="tok-nt">&gt;</span>Book Home<span class="tok-nt">&lt;/g:link&gt;</span>
<span class="tok-nt">&lt;g:link</span> <span class="tok-na">controller=</span><span class="tok-s">&quot;book&quot;</span> <span class="tok-na">action=</span><span class="tok-s">&quot;list&quot;</span><span class="tok-nt">&gt;</span>Book List<span class="tok-nt">&lt;/g:link&gt;</span>
<span class="tok-nt">&lt;g:link</span> <span class="tok-na">url=</span><span class="tok-s">&quot;[action: &#39;list&#39;, controller: &#39;book&#39;]&quot;</span><span class="tok-nt">&gt;</span>Book List<span class="tok-nt">&lt;/g:link&gt;</span>
<span class="tok-nt">&lt;g:link</span> <span class="tok-na">params=</span><span class="tok-s">&quot;[sort: &#39;title&#39;, order: &#39;asc&#39;, author: currentBook.author]&quot;</span> <span class="tok-na">action=</span><span class="tok-s">&quot;list&quot;</span><span class="tok-nt">&gt;</span>
    Book List
<span class="tok-nt">&lt;/g:link&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_etiquetas_de_formularios">4.4.5. Etiquetas de formularios</h4>
<div class="paragraph">
<p>Las utilizaremos para crear nuestros propios formularios HTML.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33%;">
<col style="width: 33%;">
<col style="width: 33%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Etiqueta</th>
<th class="tableblock halign-left valign-top">Descripción</th>
<th class="tableblock halign-left valign-top">API</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:actionSubmit&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Crea un botón de tipo <em>submit</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/actionSubmit.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/actionSubmit.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:actionSubmitImage&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Crea un botón de tipo <em>submit</em> con una imagen</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/actionSubmitImage.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/actionSubmitImage.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:checkBox&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Crea un elemento de formulario de tipo checkbox</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/checkBox.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/checkBox.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:currencySelect&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Crea un campo de tipo <em>select</em> con un listado de monedas</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/currencySelect.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/currencySelect.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:datePicker&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Crea un elemento de formulario para seleccionar una fecha con día, mes, año, hora, minutos y segundos</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/datePicker.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/datePicker.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:form&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Crea un formulario</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/form.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/form.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:hiddenField&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Crea un campo oculto</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/hiddenField.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/hiddenField.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:localeSelect&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Crea un elemento de formulario de tipo <em>select</em> con un listado de posibles localizaciones</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/localeSelect.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/localeSelect.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:radio&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Crea un elemento de formulario de tipo radio</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/radio.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/radio.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:radioGroup&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Crea un grupo de elementos de formulario de tipo radio</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/radioGroup.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/radioGroup.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:select&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Crea un elemento de formulario de tipo <em>select combo box</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/select.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/select.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:textField&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Crea un elemento de formulario de tipo <em>text</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/textField.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/textField.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:passwordField&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Crea un elemento de formulario de tipo <em>password</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/passwordField.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/passwordField.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:textArea&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Crea un elemento de formulario de tipo <em>textarea</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/textArea.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/textArea.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:timeZoneSelect&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Crea un elemento de formulario de tipo <em>select</em> con un listado de zonas horarias</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/timeZoneSelect.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/timeZoneSelect.html</a></p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">&lt;</span><span class="tok-nl">g:</span><span class="tok-n">form</span> <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">&quot;myForm&quot;</span> <span class="tok-n">url</span><span class="tok-o">=</span><span class="tok-s2">&quot;[controller:&#39;book&#39;,action:&#39;list&#39;]&quot;</span><span class="tok-o">&gt;...&lt;</span><span class="tok-s">/g:form&gt;</span>

<span class="tok-s">/</span><span class="tok-o">*************************************</span><span class="tok-s">/</span>
<span class="tok-s">&lt;g:textField name=&quot;myField&quot; value=&quot;${myValue}&quot; /</span><span class="tok-o">&gt;</span>

<span class="tok-cm">/*************************************/</span>
<span class="tok-o">&lt;</span><span class="tok-nl">g:</span><span class="tok-n">actionSubmit</span> <span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-s2">&quot;Some update label&quot;</span> <span class="tok-n">action</span><span class="tok-o">=</span><span class="tok-s2">&quot;update&quot;</span> <span class="tok-o">/&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_etiquetas_de_renderizado">4.4.6. Etiquetas de renderizado</h4>
<div class="paragraph">
<p>Permite renderizar las páginas web de nuestras aplicaciones utilizando las plantillas.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33%;">
<col style="width: 33%;">
<col style="width: 33%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Etiqueta</th>
<th class="tableblock halign-left valign-top">Descripción</th>
<th class="tableblock halign-left valign-top">API</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:applyLayout&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Aplica un determinado diseño a una página o una plantilla</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/applyLayout.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/applyLayout.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:formatDate&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Aplica el formato <em>SimpleDateFormat</em> a una fecha</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/formatDate.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/formatDate.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:formatNumber&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Aplica el formato <em>DecimalFormat</em> a un número</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/formatNumber.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/formatNumber.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:layoutHead&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Muestra una determinada cabecera para una página</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/layoutHead.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/layoutHead.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:layoutBody&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Muestra un determinado contenido para una página</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/layoutBody.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/layoutBody.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:layoutTitle&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Muestra un determinado título para una página</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/layoutTitle.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/layoutTitle.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:meta&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Muestra las propiedades del archivo <em>application.properties</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/meta.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/meta.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:render&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Muestra un modelo utilizando una plantilla</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/render.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/render.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:renderErrors&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Muestra los errores producidos en una página</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/renderErrors.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/renderErrors.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:pageProperty&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Muestra una propiedad de una página</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/pageProperty.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/pageProperty.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:paginate&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Muestra los típicos botones <em>Anterior</em> y <em>Siguiente</em> y las <em>migas de pan</em> cuando se devuelven muchos resultados</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/paginate.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/paginate.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:sortableColumn&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Muestra una columna de una tabla con la posibilidad de ordenarla</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/sortableColumn.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/sortableColumn.html</a></p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">&lt;</span><span class="tok-nl">g:</span><span class="tok-n">render</span> <span class="tok-n">template</span><span class="tok-o">=</span><span class="tok-s2">&quot;bookTemplate&quot;</span> <span class="tok-n">model</span><span class="tok-o">=</span><span class="tok-s2">&quot;[book: myBook]&quot;</span> <span class="tok-s">/&gt;</span>

<span class="tok-s">/</span><span class="tok-o">*************************************</span><span class="tok-s">/</span>
<span class="tok-s">&lt;g:render template=&quot;bookTemplate&quot; var=&quot;book&quot; collection=&quot;${bookList}&quot; /</span><span class="tok-o">&gt;</span>

<span class="tok-cm">/*************************************/</span>
<span class="tok-o">&lt;</span><span class="tok-n">img</span> <span class="tok-n">src</span><span class="tok-o">=</span><span class="tok-s2">&quot;&lt;g:createLinkTo dir=&quot;</span><span class="tok-n">images</span><span class="tok-s2">&quot; file=&quot;</span><span class="tok-n">logo</span><span class="tok-o">.</span><span class="tok-na">jpg</span><span class="tok-s2">&quot; /&gt;&quot;</span> <span class="tok-o">/&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_etiquetas_de_validación">4.4.7. Etiquetas de validación</h4>
<div class="paragraph">
<p>Se utilizan para mostrar errores y mensajes de advertencia.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33%;">
<col style="width: 33%;">
<col style="width: 33%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Etiqueta</th>
<th class="tableblock halign-left valign-top">Descripción</th>
<th class="tableblock halign-left valign-top">API</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:eachError&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Itera a través de los errores producidos en un bean o un modelo</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/eachError.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/eachError.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:hasErrors&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Comprueba si se ha producido algún error en un bean o un modelo</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/hasErrors.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/hasErrors.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;g:message&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Muestra un mensaje a partir de la propiedad pasada por parámetro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.grails.org/doc/latest/ref/Tags/message.html" class="bare">http://www.grails.org/doc/latest/ref/Tags/message.html</a></p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">&lt;</span><span class="tok-nl">g:</span><span class="tok-n">eachError</span> <span class="tok-n">bean</span><span class="tok-o">=</span><span class="tok-s2">&quot;${book}&quot;</span><span class="tok-o">&gt;</span>
    <span class="tok-o">&lt;</span><span class="tok-n">li</span><span class="tok-o">&gt;</span><span class="tok-n">$</span><span class="tok-o">{</span><span class="tok-n">it</span><span class="tok-o">}&lt;</span><span class="tok-s">/li&gt;</span>
<span class="tok-s">&lt;/</span><span class="tok-nl">g:</span><span class="tok-n">eachError</span><span class="tok-o">&gt;</span>

<span class="tok-cm">/*************************************/</span>
<span class="tok-o">&lt;</span><span class="tok-nl">g:</span><span class="tok-n">message</span> <span class="tok-n">code</span><span class="tok-o">=</span><span class="tok-s2">&quot;my.message.code&quot;</span> <span class="tok-o">/&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_librería_de_etiquetas">4.5. Librería de etiquetas</h3>
<div class="paragraph">
<p>Como acabamos de ver, Grails nos ofrece la posibilidad de utilizar un amplio rango de etiquetas tanto JSP como GSP, pero en ocasiones, es probable que necesitemos crear nuestras propias etiquetas. Estas etiquetas nos van a permitir realizar tareas repetitivas de forma rápida y sencilla.</p>
</div>
<div class="paragraph">
<p>Las librerías de etiquetas no requieren ninguna tarea de configuración y, como casi siempre, se recargan automáticamente sin reiniciar el servidor.</p>
</div>
<div class="paragraph">
<p>En Grails tenemos dos métodos para crear etiquetas. Por un lado mediante el comando <em>grails create-tag-lib</em> y por otro creando una nueva clase en el directorio <em>grails-app/taglib</em> cuyo nombre termine en <em>TagLib</em>. Nosotros utilizaremos como hasta ahora el comando <em>grails create-tag-lib es.ua.expertojava.todo.Todo</em>.</p>
</div>
<div class="paragraph">
<p>Este será el resultado de la nueva librería de etiquetas creada:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">es</span><span class="tok-o">.</span><span class="tok-na">ua</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">todo</span>

<span class="tok-kd">class</span> <span class="tok-nc">TodoTagLib</span> <span class="tok-o">{</span>
    <span class="tok-kd">static</span> <span class="tok-n">defaultEncodeAs</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-nl">taglib:</span><span class="tok-s1">&#39;html&#39;</span><span class="tok-o">]</span>
    <span class="tok-c1">//static encodeAsForTags = [tagName: [taglib:&#39;html&#39;], otherTagName: [taglib:&#39;none&#39;]]</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Las dos propiedades estáticas creadas nos servirán para indicar de forma global o por etiqueta como queremos renderizarlas. Por ejemplo, con <em>static defaultEncodeAs = [taglib:'html']</em> estamos indicando que cuando la etiqueta imprima el símbolo <em>&lt;</em> o <em>&gt;</em> lo hará por su correspondiente entidad, ésto es, &amp;lt; o &amp;gt;.</p>
</div>
<div class="paragraph">
<p>Además de definirlo de forma global, también vamos a poder especificarlo por etiqueta utilizando la variable <em>encodeAsForTags</em> y por supuesto modificando las claves utilizadas en el ejemplo por los nombres de nuestras etiquetas.</p>
</div>
<div class="paragraph">
<p>En nuestros ejemplos, vamos a tener que modificar la variable <em>defaultEncodeAs</em> por el siguiente valor: <em>[taglib:'html']</em>.</p>
</div>
<div class="sect3">
<h4 id="_etiquetas_simples">4.5.1. Etiquetas simples</h4>
<div class="paragraph">
<p>El primer ejemplo de etiqueta que vamos a crear será una etiqueta que permita la inclusión de archivos de funciones javascript en el código de nuestras páginas GSPs. Para ello definimos un método en la nueva clase <em>TodoTagLib</em> con el siguiente contenido:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">includeJs</span> <span class="tok-o">=</span> <span class="tok-o">{</span><span class="tok-n">attrs</span> <span class="tok-o">-&gt;</span>
    <span class="tok-n">out</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-s2">&quot;&lt;script src=&#39;scripts/${attrs[&#39;script&#39;]}.js&#39; &gt;&lt;/script&gt;&quot;</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La creación de la etiqueta necesita como parámetro los atributos de la misma. En este primer ejemplo, sólo vamos a utilizar un atributo que será el nombre del archivo javascript que queremos invocar en nuestra página GSP.</p>
</div>
<div class="paragraph">
<p>Una vez creada la etiqueta, para realizar la invocación de la misma en las páginas GSP utilizaremos el siguiente código.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">&lt;</span><span class="tok-nl">g:</span><span class="tok-n">includeJs</span> <span class="tok-n">script</span><span class="tok-o">=</span><span class="tok-s2">&quot;miscript&quot;</span><span class="tok-o">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para invocar la nueva librería creada se utiliza el <em>namespace</em> genérico <em>&lt;g&gt;</em>. Sin embargo, Grails nos permite crear nuestro propio espacio de nombres para que el código generado sea sencillo de leer. El espacio de nombres que vamos a utilizar será <em>me</em>, acrónimo de <em>mis etiquetas</em>. Para ello debemos definir una variable estática al inicio de la clase <em>TodoTagLib</em> llamada <em>namespace</em> e indicándole el valor del nuevo espacio de nombres, tal y como aparece en el siguiente fragmento de código.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">es</span><span class="tok-o">.</span><span class="tok-na">ua</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">todo</span>

<span class="tok-kd">class</span> <span class="tok-nc">TodoTagLib</span> <span class="tok-o">{</span>

    <span class="tok-kd">static</span> <span class="tok-n">defaultEncodeAs</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-nl">taglib:</span><span class="tok-s1">&#39;html&#39;</span><span class="tok-o">]</span>
    <span class="tok-c1">//static encodeAsForTags = [tagName: [taglib:&#39;html&#39;], otherTagName: [taglib:&#39;none&#39;]]</span>

    <span class="tok-kd">static</span> <span class="tok-n">namespace</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;me&#39;</span>

    <span class="tok-kt">def</span> <span class="tok-n">includeJs</span> <span class="tok-o">=</span> <span class="tok-o">{</span><span class="tok-n">attrs</span> <span class="tok-o">-&gt;</span>
        <span class="tok-n">out</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-s2">&quot;&lt;script src=&#39;scripts/${attrs[&#39;script&#39;]}.js&#39;/&gt;&quot;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>De esta forma, en nuestras páginas GSP ya no tendríamos que utilizar <em>&lt;g:includeJs script="miscript"/&gt;</em> sino que podríamos emplear <em>&lt;me:includeJs script="miscript"/&gt;</em>, con lo que la persona que lea el código podrá detectar que esa etiqueta es una etiqueta propia de la aplicación.</p>
</div>
<div class="paragraph">
<p>En ocasiones, es posible que sea necesario referenciar a nuestras etiquetas desde controladores o desde otras etiquetas y no nos va a ser posible referenciar a estas etiqueta de la forma habitual. En este caso deberíamos llamar a la etiqueta de la siguiente forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">renderImage</span> <span class="tok-o">=</span> <span class="tok-o">{</span> <span class="tok-n">attrs</span> <span class="tok-o">-&gt;</span>
    <span class="tok-n">println</span> <span class="tok-s2">&quot;Rendering the image ${attrs.image}&quot;</span>
    <span class="tok-n">asset</span><span class="tok-o">.</span><span class="tok-na">image</span><span class="tok-o">(</span><span class="tok-nl">src:</span><span class="tok-n">attrs</span><span class="tok-o">.</span><span class="tok-na">image</span><span class="tok-o">)</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En este ejemplo, en primer lugar imprimimos un log para saber que estamos renderizando una image y después utilizamos una librería de etiquetas disponible en el plugin <em>asset-pipeline</em> que nos permite renderizar imágenes de forma optimizada en todos los entornos.</p>
</div>
</div>
<div class="sect3">
<h4 id="_etiquetas_lógicas_2">4.5.2. Etiquetas lógicas</h4>
<div class="paragraph">
<p>Con Grails también es posible crear etiquetas lógicas que evalúen una cierta condición y actúen en consecuencia en función de dicha evaluación. El siguiente ejemplo es una etiqueta que comprueba si el usuario autenticado es un administrador. El siguiente método realiza esta comprobación y en caso de ser cierto, se mostraría el contenido encerrado entre la etiqueta.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">esAdmin</span> <span class="tok-o">=</span> <span class="tok-o">{</span> <span class="tok-n">attrs</span><span class="tok-o">,</span> <span class="tok-n">body</span> <span class="tok-o">-&gt;</span>
    <span class="tok-kt">def</span> <span class="tok-n">usuario</span> <span class="tok-o">=</span> <span class="tok-n">attrs</span><span class="tok-o">[</span><span class="tok-s1">&#39;usuario&#39;</span><span class="tok-o">]</span>
    <span class="tok-k">if</span><span class="tok-o">(</span><span class="tok-n">usuario</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-n">usuario</span><span class="tok-o">.</span><span class="tok-na">tipo</span><span class="tok-o">==</span><span class="tok-s2">&quot;administrador&quot;</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">out</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-n">body</span><span class="tok-o">()</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En esta ocasión, la nueva etiqueta no sólo recibe el atributo <em>attrs</em> sino que también necesita del atributo <em>body</em>, que se refiere a aquello que esté encerrado entre la apertura y el cierre de la etiqueta. El método comprueba si el usuario pasado por parámetro es un administrador. En la página GSP correspondiente deberíamos indicar el siguiente código.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">&lt;</span><span class="tok-nl">me:</span><span class="tok-n">esAdmin</span> <span class="tok-n">usuario</span><span class="tok-o">=</span><span class="tok-s2">&quot;${session.usuario}&quot;</span><span class="tok-o">&gt;</span>
    <span class="tok-n">Dar</span> <span class="tok-n">de</span> <span class="tok-n">baja</span> <span class="tok-n">a</span> <span class="tok-n">usuario</span>
<span class="tok-o">&lt;/</span><span class="tok-nl">me:</span><span class="tok-n">esAdmin</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_generador_de_código_hmtl">4.5.3. Generador de código HMTL</h4>
<div class="paragraph">
<p>Grails ofrece la posibilidad de generar código HTML de forma muy sencilla gracias a un Builder conocido como <em>MarkupBuilder</em>. Para comprobar el funcionamiento de este Builder, vamos a crear una nueva etiqueta que imprima un enlace cuyo atributo <em>href</em> coincida con el título. Por ejemplo, para imprimir un enlace a la página de Google, normalmente debemos incluir el código &lt;a href="http://www.google.com"&gt;<a href="http://www.google.com" class="bare">http://www.google.com</a>&lt;/a&gt;. Con esta etiqueta que vamos a crear nos ahorraremos escribir la dirección url dos veces.</p>
</div>
<div class="paragraph">
<p>En primer lugar creamos un nuevo método en el archivo <em>TodoTagLib.groovy</em> y lo llamaremos <em>printLink()</em>. Este método utilizará el <em>MarkupBuilder</em> e imprimirá un enlace con el valor del atributo <em>href</em> igual al contenido.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">printLink</span> <span class="tok-o">=</span> <span class="tok-o">{</span> <span class="tok-n">attrs</span><span class="tok-o">,</span> <span class="tok-n">body</span> <span class="tok-o">-&gt;</span>
    <span class="tok-kt">def</span> <span class="tok-n">mkp</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">groovy</span><span class="tok-o">.</span><span class="tok-na">xml</span><span class="tok-o">.</span><span class="tok-na">MarkupBuilder</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">)</span>
    <span class="tok-n">mkp</span><span class="tok-o">.</span><span class="tok-na">a</span><span class="tok-o">(</span><span class="tok-nl">href:</span><span class="tok-n">body</span><span class="tok-o">(),</span><span class="tok-n">body</span><span class="tok-o">())</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora en la vista podemos añadir una etiqueta como <em>&lt;me:printLink&gt;<a href="http://www.google.com" class="bare">http://www.google.com</a>&lt;/me:printLink&gt;</em>, la cual será traducida al código HTML <em>&lt;a href="http://www.google.com"&gt;<a href="http://www.google.com" class="bare">http://www.google.com</a>&lt;/a&gt;</em>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_controladores">4.6. Controladores</h3>
<div class="paragraph">
<p>Una vez visto a fondo todo lo relativo a las vistas en las aplicaciones en Grails, vamos a analizar los controladores. En la sesión anterior generábamos el scaffolding de forma estática de tal forma que ahora vamos a analizar con más detalle todos los aspectos relativos a los controladores.</p>
</div>
<div class="sect3">
<h4 id="_acciones_en_los_controladores">4.6.1. Acciones en los controladores</h4>
<div class="paragraph">
<p>Como veíamos anteriormente, los controladores en Grails se ubican en el directorio <em>grails-app/controllers</em>. Si recordamos la imagen donde se explicaba el proceso típico de una aplicación que utiliza el patrón Módelo Vista Controlador, los controladores se encargan básicamente de dirigir las llamadas a nuestra aplicación y de ponerse en contacto tanto con las clases de dominio, las vistas y los servicios para ponerlos de acuerdo.</p>
</div>
<div class="paragraph">
<p>Para analizar el formato de los controladores en Grails, veamos uno cualquiera de los generados en la sesión anterior, como por ejemplo <em>TodoController.groovy</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">es</span><span class="tok-o">.</span><span class="tok-na">ua</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">todo</span>

<span class="tok-kn">import</span> <span class="tok-nn">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">springframework</span><span class="tok-o">.</span><span class="tok-na">http</span><span class="tok-o">.</span><span class="tok-na">HttpStatus</span><span class="tok-o">.*</span>
<span class="tok-kn">import</span> <span class="tok-nn">grails.transaction.Transactional</span>

<span class="tok-nd">@Transactional</span><span class="tok-o">(</span><span class="tok-n">readOnly</span> <span class="tok-o">=</span> <span class="tok-kc">true</span><span class="tok-o">)</span>
<span class="tok-kd">class</span> <span class="tok-nc">TodoController</span> <span class="tok-o">{</span>

    <span class="tok-kd">static</span> <span class="tok-n">allowedMethods</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-nl">save:</span> <span class="tok-s2">&quot;POST&quot;</span><span class="tok-o">,</span> <span class="tok-nl">update:</span> <span class="tok-s2">&quot;PUT&quot;</span><span class="tok-o">,</span> <span class="tok-nl">delete:</span> <span class="tok-s2">&quot;DELETE&quot;</span><span class="tok-o">]</span>

    <span class="tok-kt">def</span> <span class="tok-nf">index</span><span class="tok-o">(</span><span class="tok-n">Integer</span> <span class="tok-n">max</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">params</span><span class="tok-o">.</span><span class="tok-na">max</span> <span class="tok-o">=</span> <span class="tok-n">Math</span><span class="tok-o">.</span><span class="tok-na">min</span><span class="tok-o">(</span><span class="tok-n">max</span> <span class="tok-o">?:</span> <span class="tok-mi">10</span><span class="tok-o">,</span> <span class="tok-mi">100</span><span class="tok-o">)</span>
        <span class="tok-n">respond</span> <span class="tok-n">Todo</span><span class="tok-o">.</span><span class="tok-na">list</span><span class="tok-o">(</span><span class="tok-n">params</span><span class="tok-o">),</span> <span class="tok-nl">model:</span><span class="tok-o">[</span><span class="tok-nl">todoInstanceCount:</span> <span class="tok-n">Todo</span><span class="tok-o">.</span><span class="tok-na">count</span><span class="tok-o">()]</span>
    <span class="tok-o">}</span>

    <span class="tok-o">....</span>

<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En primer lugar vemos que se especifica mediante la anotación <em>@Transactional</em> la transaccionalidad de todos los métodos del controlador. En la siguiente sesión aprovecharemos para hablar sobre los diferentes niveles de transaccionalidad cuando veamos los servicios en Grails.</p>
</div>
<div class="paragraph">
<p>La variable estática <em>allowedMethods</em> nos permite especificar para determinados métodos de nuestros controladores, el tipo de petición aceptada. En el caso del controlador generado vemos como el método <em>save()</em> sólo puede ser procesado por una petición de tipo <em>POST</em>, las actualizaciones por peticiones de tipo <em>PUT</em> y por último los borrados sólo serán válidos cuando se hagan mediante una petición de tipo <em>DELETE</em>.</p>
</div>
<div class="paragraph">
<p>Los parámetros pasados a los métodos serán mapeados directamente por Grails a partir de los parámetros pasados en la petición. Por ejemplo, si efectuamos la petición <em><a href="http://localhost:8080/todo/todo/index?max=20" class="bare">http://localhost:8080/todo/todo/index?max=20</a></em>, el parámetro max de la petición con valor 20 será pasado como parámetro al método index.</p>
</div>
<div class="paragraph">
<p>Como has podido comprobar en el ejemplo anterior, no es necesario especificar lo que van a devolver los método de los controladores con lo que podemos dejar que sea Grails quien se encargue de definirlo especificando la palabra reservada <em>def</em>.</p>
</div>
<div class="paragraph">
<p>Comentar también que en la últimas versiones de Grails se ha añadido el método <em>respond</em> que provocará una salida diferente en función de la petición HTTP efectuada. Por ejemplo, si abrimos un terminal y ejecutamos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">curl</span> <span class="tok-o">-</span><span class="tok-n">v</span> <span class="tok-o">-</span><span class="tok-n">H</span> <span class="tok-s2">&quot;Accept: application/json&quot;</span> <span class="tok-o">-</span><span class="tok-n">H</span> <span class="tok-s2">&quot;Content-type: application/json&quot;</span> <span class="tok-o">-</span><span class="tok-n">X</span> <span class="tok-n">GET</span>  <span class="tok-nl">http:</span><span class="tok-c1">//localhost:8080/todo/todo/index</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>veremos que la salida del método será en formato json, mientras que si ejecutamos</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">curl</span> <span class="tok-o">-</span><span class="tok-n">v</span> <span class="tok-o">-</span><span class="tok-n">H</span> <span class="tok-s2">&quot;Accept: text/xml&quot;</span> <span class="tok-o">-</span><span class="tok-n">H</span> <span class="tok-s2">&quot;Content-type: text/xml&quot;</span> <span class="tok-o">-</span><span class="tok-n">X</span> <span class="tok-n">GET</span>  <span class="tok-nl">http:</span><span class="tok-c1">//localhost:8080/todo/todo/index</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>veremos que la salida del método será en formato xml, mientras que si desde un navegador vamos a la dirección <em><a href="http://localhost:8080/todo/todo/index" class="bare">http://localhost:8080/todo/todo/index</a></em>, Grails renderizará una página html siguiendo una serie de convenios que veremos a continuación.</p>
</div>
<div class="paragraph">
<p>Además, cada controlador en Grails tiene un método por defecto que sigue las siguientes reglas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Si sólo hay un método, por supuesto ese será el método por defecto</p>
</li>
<li>
<p>Si hay un método con el nombre <em>index()</em>, ese será el método por defecto</p>
</li>
<li>
<p>Si la clase define la propiedad <em>defaultAction</em>, el método especificado será el escogido por defecto</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">static</span> <span class="tok-n">defaultAction</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;list&quot;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_Ámbitos_de_los_controladores">4.6.2. Ámbitos de los controladores</h4>
<div class="paragraph">
<p>Los ámbitos (<em>scopes</em>) son una serie de objetos que nos permitirán almacenar variables en una aplicación en Grails. Tenemos los siguientes ámbitos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>servletContext</em>: también conocido con el ámbito <em>aplicación</em> y que nos servirá para compartir variables a través de cualquier artefacto de la aplicación. Hablaremos de él cuando veamos como configurar una aplicación en Grails.</p>
</li>
<li>
<p><em>session</em>: es utilizada para controlar el estado de un determinado usuario de nuestra aplicación. Habitualmente, se utilizan cookies para asociar la <em>session</em> con el usuario.</p>
</li>
<li>
<p><em>request</em>: contendrá toda la información de la petición.</p>
</li>
<li>
<p><em>params</em>: es un mapa con la información pasada a la petición en forma de parámetro <em>GET</em> o <em>POST</em>.</p>
</li>
<li>
<p><em>flash</em>: es una variable <em>efímera</em> de tal forma que sólo dura una petición y la siguiente, con lo que no es necesario destruirla a mano. Un ejemplo de su uso es el paso de mensajes de error a las vistas.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_relación_entre_vistas_y_controladores">4.6.3. Relación entre vistas y controladores</h4>
<div class="paragraph">
<p>Las vistas serán las encargadas de mostrar al usuario aquello que el controlador quiera mostrar. Si echamos un vistazo a los métodos del controlador <em>TodoController</em> nos costará entender esa relación pues apenas se hace mención a ninguna vista en este controlador. Esto es debido a que cuando no se especifica de forma explícita que vista renderizar, Grails utiliza lo que comentábamos en la sesión anterior al respecto de "convención sobre configuración" y directamente trata de renderizar una vista que coincida con el patrón <em>nombre-del-controlador/nombre-del-método.gsp</em>, con lo que por ejemplo, en el método</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-nf">show</span><span class="tok-o">(</span><span class="tok-n">Todo</span> <span class="tok-n">todoInstance</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-n">respond</span> <span class="tok-n">todoInstance</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>al no haber indicado ninguna vista en el método <em>respond()</em>, Grails renderizará la vista ubicada en el directorio <em>grails-app/todo/show.gsp</em>. Como comentábamos anteriormente, el método <em>respond()</em> se encarga de decidir como renderizar la salida pero si tiene que renderizar una vista en HTML, bien buscará una siguiendo el patrón mencionado o bien le podemos pasar una de forma de implícita, como por ejemplo vemos en el método <em>save()</em> del controlador <em>TodoController</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy">    <span class="tok-o">...</span>
    <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">todoInstance</span><span class="tok-o">.</span><span class="tok-na">hasErrors</span><span class="tok-o">())</span> <span class="tok-o">{</span>
        <span class="tok-n">respond</span> <span class="tok-n">todoInstance</span><span class="tok-o">.</span><span class="tok-na">errors</span><span class="tok-o">,</span> <span class="tok-nl">view:</span><span class="tok-s1">&#39;create&#39;</span>
        <span class="tok-k">return</span>
    <span class="tok-o">}</span>
    <span class="tok-o">...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Sigamos con la relación entre vistas y controladores. Si vemos las vistas y los métodos del controlador <em>TodoController</em> generados automáticamente por el scaffolding estático nos daremos cuenta rápidamente que cuatro de esos métodos tienen vistas asociadas (index, create, edit y show) mientras que otros tres no tienen ninguna vista asociada (save, update y delete). Esto es debido a que estos tres últimos métodos serán los encargados únicamente de crear, actualizar o eliminar una tarea y serán los otros métodos los encargados de renderizar las vistas correspondientes.</p>
</div>
<div class="paragraph">
<p>Si abrimos la vista <em>todo/create.gsp</em> veremos que el formulario se debe procesar con la acción <em>save()</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">&lt;</span><span class="tok-nl">g:</span><span class="tok-n">form</span> <span class="tok-n">url</span><span class="tok-o">=</span><span class="tok-s2">&quot;[resource:todoInstance, action:&#39;save&#39;]&quot;</span> <span class="tok-o">&gt;</span>
    <span class="tok-o">&lt;</span><span class="tok-n">fieldset</span> <span class="tok-n">class</span><span class="tok-o">=</span><span class="tok-s2">&quot;form&quot;</span><span class="tok-o">&gt;</span>
        <span class="tok-o">&lt;</span><span class="tok-nl">g:</span><span class="tok-n">render</span> <span class="tok-n">template</span><span class="tok-o">=</span><span class="tok-s2">&quot;form&quot;</span><span class="tok-s">/&gt;</span>
<span class="tok-s">    &lt;/</span><span class="tok-n">fieldset</span><span class="tok-o">&gt;</span>
    <span class="tok-o">&lt;</span><span class="tok-n">fieldset</span> <span class="tok-n">class</span><span class="tok-o">=</span><span class="tok-s2">&quot;buttons&quot;</span><span class="tok-o">&gt;</span>
        <span class="tok-o">&lt;</span><span class="tok-nl">g:</span><span class="tok-n">submitButton</span> <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">&quot;create&quot;</span> <span class="tok-n">class</span><span class="tok-o">=</span><span class="tok-s2">&quot;save&quot;</span> <span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-s2">&quot;${message(code: &#39;default.button.create.label&#39;, default: &#39;Create&#39;)}&quot;</span> <span class="tok-s">/&gt;</span>
<span class="tok-s">    &lt;/</span><span class="tok-n">fieldset</span><span class="tok-o">&gt;</span>
<span class="tok-o">&lt;/</span><span class="tok-nl">g:</span><span class="tok-n">form</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>con esto conseguimos que al enviar el formulario, el encargado de procesarlo sea el método <em>save()</em>.</p>
</div>
<div class="paragraph">
<p>Veamos ahora todo el proceso de creación de una tarea. Si arrancamos nuestra aplicación y accedemos en el navegador a la dirección <em><a href="http://localhost:8080/todo/todo/create" class="bare">http://localhost:8080/todo/todo/create</a></em>, el método que sale al rescate es <em>TodoController.create()</em>. Este método con una sóla línea de código es capaz de renderizar una vista con una tarea asociada, que en principio tendrá todos sus campos vacios.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-nf">create</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-n">respond</span> <span class="tok-k">new</span> <span class="tok-nf">Todo</span><span class="tok-o">(</span><span class="tok-n">params</span><span class="tok-o">)</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Este método renderizará la vista <em>todo/create.gsp</em> y le pasará una variable llamada <em>todoInstance</em> que contendrá una tarea con sus campos vacios.</p>
</div>
<div class="paragraph">
<p>Si abrimos ahora la vista <em>todo/create.gsp</em> vemos como esa vista únicamente llama a la plantilla <em>todo/_form.gsp</em> que es la que contiene los elementos de formulario necesarios para crear una tarea.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">&lt;</span><span class="tok-nl">g:</span><span class="tok-n">form</span> <span class="tok-n">url</span><span class="tok-o">=</span><span class="tok-s2">&quot;[resource:todoInstance, action:&#39;save&#39;]&quot;</span> <span class="tok-o">&gt;</span>
    <span class="tok-o">&lt;</span><span class="tok-n">fieldset</span> <span class="tok-n">class</span><span class="tok-o">=</span><span class="tok-s2">&quot;form&quot;</span><span class="tok-o">&gt;</span>
        <span class="tok-o">&lt;</span><span class="tok-nl">g:</span><span class="tok-n">render</span> <span class="tok-n">template</span><span class="tok-o">=</span><span class="tok-s2">&quot;form&quot;</span><span class="tok-s">/&gt;</span>
<span class="tok-s">    &lt;/</span><span class="tok-n">fieldset</span><span class="tok-o">&gt;</span>
    <span class="tok-o">&lt;</span><span class="tok-n">fieldset</span> <span class="tok-n">class</span><span class="tok-o">=</span><span class="tok-s2">&quot;buttons&quot;</span><span class="tok-o">&gt;</span>
        <span class="tok-o">&lt;</span><span class="tok-nl">g:</span><span class="tok-n">submitButton</span> <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">&quot;create&quot;</span> <span class="tok-n">class</span><span class="tok-o">=</span><span class="tok-s2">&quot;save&quot;</span> <span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-s2">&quot;${message(code: &#39;default.button.create.label&#39;, default: &#39;Create&#39;)}&quot;</span> <span class="tok-s">/&gt;</span>
<span class="tok-s">    &lt;/</span><span class="tok-n">fieldset</span><span class="tok-o">&gt;</span>
<span class="tok-o">&lt;/</span><span class="tok-nl">g:</span><span class="tok-n">form</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Una vez el usuario envía la información, el método encargado de procesar esa petición será <em>TodoController.save()</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-nd">@Transactional</span>
<span class="tok-kt">def</span> <span class="tok-nf">save</span><span class="tok-o">(</span><span class="tok-n">Todo</span> <span class="tok-n">todoInstance</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">todoInstance</span> <span class="tok-o">==</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">notFound</span><span class="tok-o">()</span>
        <span class="tok-k">return</span>
    <span class="tok-o">}</span>

    <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">todoInstance</span><span class="tok-o">.</span><span class="tok-na">hasErrors</span><span class="tok-o">())</span> <span class="tok-o">{</span>
        <span class="tok-n">respond</span> <span class="tok-n">todoInstance</span><span class="tok-o">.</span><span class="tok-na">errors</span><span class="tok-o">,</span> <span class="tok-nl">view:</span><span class="tok-s1">&#39;create&#39;</span>
        <span class="tok-k">return</span>
    <span class="tok-o">}</span>

    <span class="tok-n">todoInstance</span><span class="tok-o">.</span><span class="tok-na">save</span> <span class="tok-nl">flush:</span><span class="tok-kc">true</span>

    <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">withFormat</span> <span class="tok-o">{</span>
        <span class="tok-n">form</span> <span class="tok-n">multipartForm</span> <span class="tok-o">{</span>
            <span class="tok-n">flash</span><span class="tok-o">.</span><span class="tok-na">message</span> <span class="tok-o">=</span> <span class="tok-n">message</span><span class="tok-o">(</span><span class="tok-nl">code:</span> <span class="tok-s1">&#39;default.created.message&#39;</span><span class="tok-o">,</span> <span class="tok-nl">args:</span> <span class="tok-o">[</span><span class="tok-n">message</span><span class="tok-o">(</span><span class="tok-nl">code:</span> <span class="tok-s1">&#39;todo.label&#39;</span><span class="tok-o">,</span> <span class="tok-k">default</span><span class="tok-o">:</span> <span class="tok-s1">&#39;Todo&#39;</span><span class="tok-o">),</span> <span class="tok-n">todoInstance</span><span class="tok-o">.</span><span class="tok-na">id</span><span class="tok-o">])</span>
            <span class="tok-n">redirect</span> <span class="tok-n">todoInstance</span>
        <span class="tok-o">}</span>
        <span class="tok-s1">&#39;*&#39;</span> <span class="tok-o">{</span> <span class="tok-n">respond</span> <span class="tok-n">todoInstance</span><span class="tok-o">,</span> <span class="tok-o">[</span><span class="tok-nl">status:</span> <span class="tok-n">CREATED</span><span class="tok-o">]</span> <span class="tok-o">}</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pongámonos en el caso en que no hayamos completado correctamente todos los campos requeridos. Si ésto sucede, el método volverá a renderizar la vista <em>todo/create.gsp</em> con los errores que se hayan producido.</p>
</div>
<div class="paragraph">
<p>En caso de que todo vaya bien, se almacena la nueva tarea</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">todoInstance</span><span class="tok-o">.</span><span class="tok-na">save</span> <span class="tok-nl">flush:</span><span class="tok-kc">true</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>y se trata de renderizar el resultado en función del tipo de petición realizada. En caso de que hayamos envíado un formulario se redirige la aplicación para mostrar esa tarea recien creada con una variable de tipo flash para mostrar un mensaje indicando que la tarea se ha creado correctamente.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">flash</span><span class="tok-o">.</span><span class="tok-na">message</span> <span class="tok-o">=</span> <span class="tok-n">message</span><span class="tok-o">(</span><span class="tok-nl">code:</span> <span class="tok-s1">&#39;default.created.message&#39;</span><span class="tok-o">,</span> <span class="tok-nl">args:</span> <span class="tok-o">[</span><span class="tok-n">message</span><span class="tok-o">(</span><span class="tok-nl">code:</span> <span class="tok-s1">&#39;todo.label&#39;</span><span class="tok-o">,</span> <span class="tok-k">default</span><span class="tok-o">:</span> <span class="tok-s1">&#39;Todo&#39;</span><span class="tok-o">),</span> <span class="tok-n">todoInstance</span><span class="tok-o">.</span><span class="tok-na">id</span><span class="tok-o">])</span>
<span class="tok-n">redirect</span> <span class="tok-n">todoInstance</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cuando hacemos esta redirección Grails buscará el método <em>show()</em> y lo renderizará. Este método pintará en el navegador la vista <em>todo/show.gsp</em>. Esta vista, como prácticamente cualquier vista, tiene un fragmento de código que comprueba la presencia de una variable de tipo <em>flash</em> para actuar en consecuencia. En este caso simplemente mostrará el mensaje que hemos completado en el método <em>save()</em> del <em>TodoController</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">&lt;</span><span class="tok-nl">g:</span><span class="tok-k">if</span> <span class="tok-n">test</span><span class="tok-o">=</span><span class="tok-s2">&quot;${flash.message}&quot;</span><span class="tok-o">&gt;</span>
    <span class="tok-o">&lt;</span><span class="tok-n">div</span> <span class="tok-n">class</span><span class="tok-o">=</span><span class="tok-s2">&quot;message&quot;</span> <span class="tok-n">role</span><span class="tok-o">=</span><span class="tok-s2">&quot;status&quot;</span><span class="tok-o">&gt;</span><span class="tok-n">$</span><span class="tok-o">{</span><span class="tok-n">flash</span><span class="tok-o">.</span><span class="tok-na">message</span><span class="tok-o">}&lt;</span><span class="tok-s">/div&gt;</span>
<span class="tok-s">&lt;/</span><span class="tok-nl">g:</span><span class="tok-k">if</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si en lugar de haber envíado un formulario a través de una página HTML, la petición es de cualquier otro tipo, se trata de renderizar una salida acorde al tipo de petición.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-s1">&#39;*&#39;</span> <span class="tok-o">{</span> <span class="tok-n">respond</span> <span class="tok-n">todoInstance</span><span class="tok-o">,</span> <span class="tok-o">[</span><span class="tok-nl">status:</span> <span class="tok-n">CREATED</span><span class="tok-o">]</span> <span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si por ejemplo lanzamos desde la terminal el siguiente comando</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">curl</span> <span class="tok-o">-</span><span class="tok-n">v</span> <span class="tok-o">-</span><span class="tok-n">H</span> <span class="tok-s2">&quot;Accept: application/json&quot;</span> <span class="tok-o">-</span><span class="tok-n">H</span> <span class="tok-s2">&quot;Content-type: application/json&quot;</span> <span class="tok-o">-</span><span class="tok-n">X</span> <span class="tok-n">POST</span> <span class="tok-o">-</span><span class="tok-n">d</span> <span class="tok-s2">&quot;{&#39;title&#39;:&#39;Hacer los ejercicios de Groovy&#39;,&#39;date_day&#39;:25,&#39;date_month&#39;:3,&#39;date_year&#39;:2015,&#39;date&#39;:&#39;date.struct&#39;}&quot;</span> <span class="tok-nl">http:</span><span class="tok-c1">//localhost:8080/todo/todo/save</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>la aplicación nos creará una nueva tarea y nos devolverá el resultado en formato json. Si por el contrario ejecutamos</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">curl</span> <span class="tok-o">-</span><span class="tok-n">v</span> <span class="tok-o">-</span><span class="tok-n">H</span> <span class="tok-s2">&quot;Accept: text/xml&quot;</span> <span class="tok-o">-</span><span class="tok-n">H</span> <span class="tok-s2">&quot;Content-type: application/json&quot;</span> <span class="tok-o">-</span><span class="tok-n">X</span> <span class="tok-n">POST</span> <span class="tok-o">-</span><span class="tok-n">d</span> <span class="tok-s2">&quot;{&#39;title&#39;:&#39;Hacer los ejercicios de Grails&#39;,&#39;date_day&#39;:26,&#39;date_month&#39;:3,&#39;date_year&#39;:2015,&#39;date&#39;:&#39;date.struct&#39;}&quot;</span> <span class="tok-nl">http:</span><span class="tok-c1">//localhost:8080/todo/todo/save</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Con esto hemos podido comprobar como Grails con muy pocas líneas de código es capaz de generar una aplicación que será capaz de responder al cliente de varias formas con lo que podemos tener una aplicación multiplataforma todo integrado en el mismo código fuente.</p>
</div>
<div class="sect4">
<h5 id="_renderizando_vistas">Renderizando vistas</h5>
<div class="paragraph">
<p>En ocasiones, sobre todo cuando realicemos aplicaciones web, tendremos que simplemente renderizar vistas o fragmentos de texto. Para ello Grails dispone del método <em>render()</em> que puede renderizar desde un trozo de texto hasta una plantilla.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">render</span> <span class="tok-s2">&quot;Hello World!&quot;</span>

<span class="tok-n">render</span> <span class="tok-o">{</span>
   <span class="tok-mi">10</span><span class="tok-o">.</span><span class="tok-na">times</span> <span class="tok-o">{</span>
      <span class="tok-n">div</span><span class="tok-o">(</span><span class="tok-nl">id:</span> <span class="tok-n">it</span><span class="tok-o">,</span> <span class="tok-s2">&quot;Div ${it}&quot;</span><span class="tok-o">)</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span>

<span class="tok-n">render</span><span class="tok-o">(</span><span class="tok-nl">view:</span> <span class="tok-s1">&#39;show&#39;</span><span class="tok-o">)</span>

<span class="tok-n">render</span><span class="tok-o">(</span><span class="tok-nl">template:</span> <span class="tok-s1">&#39;book_template&#39;</span><span class="tok-o">,</span> <span class="tok-nl">collection:</span> <span class="tok-n">Book</span><span class="tok-o">.</span><span class="tok-na">list</span><span class="tok-o">())</span>

<span class="tok-n">render</span><span class="tok-o">(</span><span class="tok-nl">text:</span> <span class="tok-s2">&quot;&lt;xml&gt;some xml&lt;/xml&gt;&quot;</span><span class="tok-o">,</span> <span class="tok-nl">contentType:</span> <span class="tok-s2">&quot;text/xml&quot;</span><span class="tok-o">,</span> <span class="tok-nl">encoding:</span> <span class="tok-s2">&quot;UTF-8&quot;</span><span class="tok-o">)</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_redirecciones_y_encadenamientos">Redirecciones y encadenamientos</h5>
<div class="paragraph">
<p>Tal y como veíamos anteriormente, en ocasiones necesitaremos redireccionar nuestra aplicación a otros métodos. Para ello, disponemos del método <em>redirect()</em> que acepta varios parámetros, como en los siguientes ejemplos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">//Redirección que se hace dentro del mismo controlador</span>
<span class="tok-n">redirect</span><span class="tok-o">(</span><span class="tok-nl">action:</span> <span class="tok-n">login</span><span class="tok-o">)</span>

<span class="tok-c1">//Redirección que se hace a otro controlador</span>
<span class="tok-n">redirect</span><span class="tok-o">(</span><span class="tok-nl">controller:</span> <span class="tok-s1">&#39;home&#39;</span><span class="tok-o">,</span> <span class="tok-nl">action:</span> <span class="tok-s1">&#39;index&#39;</span><span class="tok-o">)</span>

<span class="tok-c1">//Redirección a una uri explícitamente</span>
<span class="tok-n">redirect</span><span class="tok-o">(</span><span class="tok-nl">uri:</span> <span class="tok-s2">&quot;/login.html&quot;</span><span class="tok-o">)</span>

<span class="tok-c1">//Redirección a una url absoluta</span>
<span class="tok-n">redirect</span><span class="tok-o">(</span><span class="tok-nl">url:</span> <span class="tok-s2">&quot;http://grails.org&quot;</span><span class="tok-o">)</span>

<span class="tok-c1">//Redirección pasando parámetros</span>
<span class="tok-n">redirect</span><span class="tok-o">(</span><span class="tok-nl">action:</span> <span class="tok-s1">&#39;myaction&#39;</span><span class="tok-o">,</span> <span class="tok-nl">params:</span> <span class="tok-o">[</span><span class="tok-nl">myparam:</span> <span class="tok-s2">&quot;myvalue&quot;</span><span class="tok-o">])</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Además, Grails también ofrece la posibilidad de encadenar acciones. El beneficio de encadenar acciones en lugar de redirigir es que el modelo se pasa de una acción a la siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">ExampleChainController</span> <span class="tok-o">{</span>
    <span class="tok-kt">def</span> <span class="tok-nf">first</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">chain</span><span class="tok-o">(</span><span class="tok-nl">action:</span> <span class="tok-n">second</span><span class="tok-o">,</span> <span class="tok-nl">model:</span> <span class="tok-o">[</span><span class="tok-nl">one:</span> <span class="tok-mi">1</span><span class="tok-o">])</span>
    <span class="tok-o">}</span>

    <span class="tok-kt">def</span> <span class="tok-nf">second</span> <span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">chain</span><span class="tok-o">(</span><span class="tok-nl">action:</span> <span class="tok-n">third</span><span class="tok-o">,</span> <span class="tok-nl">model:</span> <span class="tok-o">[</span><span class="tok-nl">two:</span> <span class="tok-mi">2</span><span class="tok-o">])</span>
    <span class="tok-o">}</span>

    <span class="tok-kt">def</span> <span class="tok-nf">third</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-o">[</span><span class="tok-nl">three:</span> <span class="tok-mi">3</span><span class="tok-o">])</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Esta cadena de acciones terminaría con el método <em>third()</em> recibiendo los modelos</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">one:</span> <span class="tok-mi">1</span><span class="tok-o">,</span> <span class="tok-nl">two:</span> <span class="tok-mi">2</span><span class="tok-o">,</span> <span class="tok-nl">three:</span> <span class="tok-mi">3</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si necesitamos acceder a los modelos dentro de una cadena, podemos utilizar la variable dinámica <em>chainModel</em> que es un mapa con todos los modelos generados en la cadena.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">ChainController</span> <span class="tok-o">{</span>
    <span class="tok-kt">def</span> <span class="tok-nf">nextInChain</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-kt">def</span> <span class="tok-n">model</span> <span class="tok-o">=</span> <span class="tok-n">chainModel</span><span class="tok-o">.</span><span class="tok-na">myModel</span>
        <span class="tok-err">…</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_filtros">4.7. Filtros</h3>
<div class="paragraph">
<p>Los filtros en una aplicación Grails permiten ejecutar acciones antes y después de que los métodos de los controladores sean invocados. El típico ejemplo de uso de los filtros es el de asegurar las peticiones a nuestra aplicación para comprobar si el usuario tiene acceso a un determinado recurso.</p>
</div>
<div class="paragraph">
<p>Otro ejemplo util de los filtros puede ser el de mantener un log cada vez que se ejecuta una petición en nuestra aplicación, es decir, que cada vez que llamemos a un método de un controlador, imprimimos algo por pantalla.</p>
</div>
<div class="paragraph">
<p>Por supuesto que podríamos hacerlo directamente en cada método de los controladores, pero sin duda es algo poco mantenible y no es una buena práctica, con lo que vamos a utilizar los filtros.</p>
</div>
<div class="paragraph">
<p>En Grails, los filtros se generan creando una nueva clase que termine con la palabra <em>Filters</em> o bien mediante el comando <em>grails create-filters</em> para que sea Grails quien lo haga por nosotros y nos cree además un esqueleto de la clase en cuestión. Estas nuevas clases se deben crear en el directorio <em>grails-app/conf</em>. Cada filtro implementa la lógica a ejecutar antes y después de las acciones así como sobre que acciones se debe hacer. En nuestro caso, debemos crear un filtro ejecutando el comando <em>grails create-filters log</em> que se ubicará en el directorio <em>grails-app/conf/todo</em> y se llamará <em>LogFilters.groovy</em>. El esqueleto que Grails ha creado para este filtro es el siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">todo</span>

<span class="tok-kd">class</span> <span class="tok-nc">LogFilters</span> <span class="tok-o">{</span>

    <span class="tok-kt">def</span> <span class="tok-n">filters</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
        <span class="tok-n">all</span><span class="tok-o">(</span><span class="tok-nl">controller:</span><span class="tok-s1">&#39;*&#39;</span><span class="tok-o">,</span> <span class="tok-nl">action:</span><span class="tok-s1">&#39;*&#39;</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">before</span> <span class="tok-o">=</span> <span class="tok-o">{</span>

            <span class="tok-o">}</span>
            <span class="tok-n">after</span> <span class="tok-o">=</span> <span class="tok-o">{</span> <span class="tok-n">Map</span> <span class="tok-n">model</span> <span class="tok-o">-&gt;</span>

            <span class="tok-o">}</span>
            <span class="tok-n">afterView</span> <span class="tok-o">=</span> <span class="tok-o">{</span> <span class="tok-n">Exception</span> <span class="tok-n">e</span> <span class="tok-o">-&gt;</span>

            <span class="tok-o">}</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Tal y como vemos en el código del esqueleto generado por Grails, podemos ejecutar el filtro antes (<em>before</em>) o después (<em>after</em>) de que se ejecute el método correspondiente del controlador o bien hacerlo después de que se genere la vista. Además, también podemos especificar sobre que controladores queremos aplicar estos filtros.</p>
</div>
<div class="paragraph">
<p>Nuestro filtro se aplicará a todos los controladores de nuestra aplicación pero sólo a aquellas acciones que traten de renderizar una vista, que serán <em>index, create, edit y show</em> con lo que podríamos tener algo así:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">todo</span>

<span class="tok-kd">class</span> <span class="tok-nc">LogFilters</span> <span class="tok-o">{</span>

    <span class="tok-kt">def</span> <span class="tok-n">filters</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
        <span class="tok-n">all</span><span class="tok-o">(</span><span class="tok-nl">controller:</span><span class="tok-s1">&#39;todo|category|tag&#39;</span><span class="tok-o">,</span> <span class="tok-nl">action:</span><span class="tok-s1">&#39;create|edit|index|show&#39;</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">before</span> <span class="tok-o">=</span> <span class="tok-o">{</span>

            <span class="tok-o">}</span>
            <span class="tok-n">after</span> <span class="tok-o">=</span> <span class="tok-o">{</span> <span class="tok-n">Map</span> <span class="tok-n">model</span> <span class="tok-o">-&gt;</span>
                <span class="tok-n">println</span> <span class="tok-s2">&quot;Controlador ${controllerName} - Accion ${actionName} - Modelo ${model}&quot;</span>
            <span class="tok-o">}</span>
            <span class="tok-n">afterView</span> <span class="tok-o">=</span> <span class="tok-o">{</span> <span class="tok-n">Exception</span> <span class="tok-n">e</span> <span class="tok-o">-&gt;</span>

            <span class="tok-o">}</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La clase LogFilters únicamente dispone de un filtro, el denominado <em>all()</em>, pero una misma clase puede tener tantos filtros como queramos.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="_ejercicios_4">4.8. Ejercicios</h3>
<div class="sect3">
<h4 id="_modificando_las_vistas_0_25_puntos">4.8.1. Modificando las vistas (0.25 puntos)</h4>
<div class="paragraph">
<p>Si hacemos un rápido test de usabilidad en nuestra aplicación veremos que cada vez que necesitamos editar o eliminar una tarea, tenemos que hacer dos clicks sobre la misma, uno para ver la tarea y otro para editarla. Vamos a solucionar este problema de usabilidad modificando el listado de las tareas para añadir una nueva columna a la izquierda de cada tarea para mostrar dos opciones, una para editar y otra para eliminar una tarea.</p>
</div>
<div class="paragraph">
<p>Aprovecharemos también para eliminar las columnas <em>Description</em> y <em>Reminder Date</em> del listado de las tareas.</p>
</div>
</div>
<div class="sect3">
<h4 id="_etiqueta_para_valores_booleanos_0_50_puntos">4.8.2. Etiqueta para valores booleanos (0.50 puntos)</h4>
<div class="paragraph">
<p>Vamos a crear una etiqueta que nos permita, a partir de un valor booleano, imprimir un icono u otro. La etiqueta se llamara <em>printIconFromBoolean</em> y únicamente recibirá como parámetro el atributo <em>value</em>. Modifica también el namespace de la librería creada para que podamos a ella a través del namespace <em>todo</em> con lo que para llamar a nuestra etiqueta tendríamos que ejecutar algo como:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">&lt;</span><span class="tok-nl">todo:</span><span class="tok-n">printIconFromBoolean</span> <span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-n">$</span><span class="tok-o">{</span><span class="tok-n">todoInstance</span><span class="tok-o">.</span><span class="tok-na">done</span><span class="tok-o">}/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y deberíamos imprimir algo parecido a esto:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/grails04/listadoejercicio2.png" alt="Icono desde un booleano" width="50%">
</div>
</div>
<div class="paragraph">
<p>Sería aconsejable que utilizaras el método <em>image()</em> de la librería de etiquetas del plugin <em>asset pipeline</em>. Aquí tienes un ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">asset</span><span class="tok-o">.</span><span class="tok-na">image</span><span class="tok-o">(</span><span class="tok-nl">src:</span><span class="tok-s2">&quot;icon.png&quot;</span><span class="tok-o">)</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_página_de_confirmación_de_eliminación_de_etiquetas_0_50_puntos">4.8.3. Página de confirmación de eliminación de etiquetas (0.50 puntos)</h4>
<div class="paragraph">
<p>Cuando deseamos eliminar una etiqueta, al hacer click sobre el botón eliminar se nos muestra un mensaje en Javascript para confirmar si realmente queremos eliminar esta etiqueta. Vamos a modificar este sistema para que en lugar de mostrar un mensaje en Javascript, nos muestre una nueva página para pedir confirmación. Esto nos permitirá añadir algo más de seguridad en lo que el usuario está realizando ya que podemos mostrar un mensaje de alerta más evidente, como por ejemplo éste:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/grails04/screenshotejercicio3.png" alt="Mensaje confirmación eliminación de etiquetas" width="50%">
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion05">5. Patrón MVC: Dominios y servicios.</h2>
<div class="sectionbody">
<div class="paragraph">
<p>En esta tercera sesión sobre Grails veremos como Grails hace uso de GORM para mapear objetos contra la base de datos de la aplicación. Recordar que GORM es una capa superior a Hibernate con lo que gran parte de lo aprendido en módulos anteriores sobre Hibernate serán totalmente válidos para trabajar con Grails.</p>
</div>
<div class="paragraph">
<p>Por último, veremos lo sencillo que es en Grails implementar servicios que se encarguen de la lógica de negocio de nuestra aplicación creando un sencillo ejemplo.</p>
</div>
<div class="sect2">
<h3 id="_dominios">5.1. Dominios</h3>
<div class="sect3">
<h4 id="_creación_de_dominios">5.1.1. Creación de dominios</h4>
<div class="paragraph">
<p>Como puedes imaginar, lo primero que se debe hacer con una clase de dominio es crearla. Como ya vimos en sesiones anteriores, el comando utilizado para generar una nueva clase de dominio es <em>grails create-domain-class</em> seguido del nombre de la nueva clase que queremos crear. Pero, ¿qué pasa en la base de datos cuando generamos nuestras clases de dominio? Para ver exactamente que es lo que pasa en la base de datos cuando creamos una nueva clase de dominio, vamos a tomar como ejemplo la clase <em>Todo</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">es</span><span class="tok-o">.</span><span class="tok-na">ua</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">todo</span>

<span class="tok-kd">class</span> <span class="tok-nc">Todo</span> <span class="tok-o">{</span>
    <span class="tok-n">String</span> <span class="tok-n">title</span>
    <span class="tok-n">String</span> <span class="tok-n">description</span>
    <span class="tok-n">Date</span> <span class="tok-n">date</span>
    <span class="tok-n">Date</span> <span class="tok-n">reminderDate</span>
    <span class="tok-n">String</span> <span class="tok-n">url</span>
    <span class="tok-n">Boolean</span> <span class="tok-n">done</span> <span class="tok-o">=</span> <span class="tok-kc">false</span>
    <span class="tok-n">Category</span> <span class="tok-n">category</span>

    <span class="tok-kd">static</span> <span class="tok-n">hasMany</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-nl">tags:</span><span class="tok-n">Tag</span><span class="tok-o">]</span>
    <span class="tok-kd">static</span> <span class="tok-n">belongsTo</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-n">Tag</span><span class="tok-o">]</span>

    <span class="tok-kd">static</span> <span class="tok-n">constraints</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
        <span class="tok-n">title</span><span class="tok-o">(</span><span class="tok-nl">blank:</span><span class="tok-kc">false</span><span class="tok-o">)</span>
        <span class="tok-n">description</span><span class="tok-o">(</span><span class="tok-nl">blank:</span><span class="tok-kc">true</span><span class="tok-o">,</span> <span class="tok-nl">nullable:</span><span class="tok-kc">true</span><span class="tok-o">,</span> <span class="tok-nl">maxSize:</span><span class="tok-mi">1000</span><span class="tok-o">)</span>
        <span class="tok-n">date</span><span class="tok-o">(</span><span class="tok-nl">nullable:</span><span class="tok-kc">false</span><span class="tok-o">)</span>
        <span class="tok-n">reminderDate</span><span class="tok-o">(</span><span class="tok-nl">nullable:</span><span class="tok-kc">true</span><span class="tok-o">)</span>
        <span class="tok-n">url</span><span class="tok-o">(</span><span class="tok-nl">nullable:</span><span class="tok-kc">true</span><span class="tok-o">,</span> <span class="tok-nl">url:</span><span class="tok-kc">true</span><span class="tok-o">)</span>
        <span class="tok-n">done</span><span class="tok-o">(</span><span class="tok-nl">nullable:</span><span class="tok-kc">false</span><span class="tok-o">)</span>
        <span class="tok-n">category</span><span class="tok-o">(</span><span class="tok-nl">nullable:</span><span class="tok-kc">true</span><span class="tok-o">)</span>
    <span class="tok-o">}</span>

    <span class="tok-n">String</span> <span class="tok-nf">toString</span><span class="tok-o">(){</span>
        <span class="tok-n">title</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pasemos a ver que tabla nos ha creado nuestra aplicación en la base de datos. Para esto, vamos a ver una de las características añadidas en las últimas versiones de Grails que es la posibilidad de utilizar una consola web para acceder a la estructura de la base de datos creada. Esta consola se puede acceder desde la dirección <em><a href="http://localhost:8080/todo/dbconsole" class="bare">http://localhost:8080/todo/dbconsole</a></em>. Hay que tener en cuenta que como parámetro JDBC URL debemos introducir la misma url que tengamos configurada en el archivo <em>DataSource.groovy</em>, que por defecto será <em>jdbc:h2:mem:devDb</em>.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/grails05/dbconsole.png" alt="Conexión con DbConsole" width="50%">
</div>
</div>
<div class="paragraph">
<p>Una vez dentro de la consola de H2, podemos ejecutar el comando <em>SHOW COLUMNS FROM TODO</em> para ver el esquema de la tabla <em>TODO</em> y compararla de eta forma con la clase de dominio que nosotros hemos creado para encontrar las siguientes diferencias.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/grails05/tabletodo.png" alt="Table Todo" width="100%">
</div>
</div>
<div class="paragraph">
<p><strong>Nuevas columnas</strong></p>
</div>
<div class="paragraph">
<p>La primera diferencia que encontramos es la existencia de dos nuevas columnas en la tabla correspondiente de la base de datos. La primera de ellas es la columna <em>id</em> que además es la clave primaria de la tabla y autoincremental. Esto puede parecer que es algo en contra de Grails ya que no vamos a poder establecer la clave primaria que nosotros queremos, pero en la práctica se ha demostrado que es la mejor forma a la hora de interactuar con la base de datos. La otra nueva columna que se ha generado en la tabla es el campo <em>version</em> y servirá para garantizar la integridad transaccional y el bloqueo eficiente de las tablas cuando se realizan operaciones de entrada.</p>
</div>
<div class="paragraph">
<p><strong>Nombre de las columnas</strong></p>
</div>
<div class="paragraph">
<p>El nombre de las propiedades que en la clase de dominio seguían el convenio <em>CamelCase</em> (palabras sin espacios en blanco y con la primera letra de cada una de ellas en mayúscula), en la tabla se convierten por defecto al formato <em>snake_case</em> (todas las palabras en minúsculas y separadas por un subrayado bajo _), a pesar de que en la consola de H2 nos aparezca todo en mayúsculas. Si lo comprobáramos con una base de datos MySQL veríamos este cambio de nombre de las propiedades.</p>
</div>
<div class="paragraph">
<p><strong>Claves ajenas</strong></p>
</div>
<div class="paragraph">
<p>GORM representa las claves ajenas en la tabla con el nombre de la clase/tabla referencia en minúsculas seguido de <em>_id</em>. En nuestro caso tenemos la columna <em>category_id</em> que identifica la relación entre las tareas y categorías, con lo que cada tarea sólo puede pertenecer a una categoría.</p>
</div>
<div class="paragraph">
<p><strong>Tipos de datos</strong></p>
</div>
<div class="paragraph">
<p>Dependiendo de la base de datos utilizada (en nuestro caso H2), GORM transformará los tipos de datos de las propiedades de la clase de dominio en otros tipos de datos en la tabla. Por ejemplo, el tipo de dato <em>String</em> se sustituye en la base de datos por <em>varchar()</em>, mientras que el tipo de dato <em>Date</em> es reemplazado por <em>timestamp</em>. Todo esto dependerá de la base de datos utilizada y es posible que varíe entre ellas.</p>
</div>
</div>
<div class="sect3">
<h4 id="_relaciones_entre_clases_de_dominio">5.1.2. Relaciones entre clases de dominio</h4>
<div class="paragraph">
<p>Cualquier aplicación que vayamos a desarrollar, presentará relaciones entre sus clases de dominio. En nuestro ejemplo de scaffolding ya definimos algunas relaciones entre ellas y ahora vamos a ver más en detalle esas relaciones. Las posibles relaciones entre las clases de dominio de una aplicación son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Uno a uno</p>
</li>
<li>
<p>Uno a muchos</p>
</li>
<li>
<p>Muchos a muchos</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Si hacemos algo de memoria de la definición de nuestras clases de dominio, recordaremos que utilizábamos la palabra reservada <em>hasMany</em> y <em>belongsTo</em> para establecer la relación entre las tareas y las etiquetas. También existen la palabra reservada <em>hasOne</em>. A continuación veremos en detalle cada una de las posibles relaciones y como especificarlas.</p>
</div>
<div class="sect4">
<h5 id="_uno_a_uno">Uno a uno</h5>
<div class="paragraph">
<p>Una relación uno-a-uno se da cuando un objeto de la clase A está únicamente relacionado con un objeto de la clase B y viceversa. Por ejemplo, imaginad la aplicación <em>Biblioteca</em> en donde un <em>libro</em> sólo puede tener una <em>operación activa</em>. Esto se representaría con una relación <em>uno-a-uno</em> y podríamos hacerlo de tres formas diferentes.</p>
</div>
<div class="paragraph">
<p><em>Primera forma de establecer una relación uno a uno</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">Book</span><span class="tok-o">{</span>
<span class="tok-o">}</span>

<span class="tok-kd">class</span> <span class="tok-nc">ActiveOperation</span><span class="tok-o">{</span>
    <span class="tok-o">....</span>
    <span class="tok-n">Book</span> <span class="tok-n">book</span>
    <span class="tok-o">....</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Aquí estamos representando una relación unidireccional desde las operaciones activas hasta los libros. Si necesitamos especificar una relación bidireccional podemos utilizar cualquiera de las siguientes formas.</p>
</div>
<div class="paragraph">
<p><em>Segunda forma de establecer una relación uno a uno</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">Book</span><span class="tok-o">{</span>
    <span class="tok-o">....</span>
    <span class="tok-n">ActiveOperation</span> <span class="tok-n">actoper</span>
    <span class="tok-o">....</span>
<span class="tok-o">}</span>

<span class="tok-kd">class</span> <span class="tok-nc">ActiveOperation</span><span class="tok-o">{</span>
    <span class="tok-o">....</span>
    <span class="tok-kd">static</span> <span class="tok-n">belongsTo</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-nl">book:</span><span class="tok-n">Book</span><span class="tok-o">]</span>
    <span class="tok-o">....</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En este caso, las inserciones y los borrados se realizan en cascada. Si por ejemplo hacemos <em>new Book(actoper:new ActiveOperation()).save()</em> en primer lugar se creará una operación activa y posteriormente se creará el libro. De igual forma, si eliminamos el libro asociado a la operación activa, ésta se eliminará también de la base de datos.</p>
</div>
<div class="paragraph">
<p><em>Tercera forma de establecer una relación uno a uno</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">Book</span><span class="tok-o">{</span>
    <span class="tok-o">....</span>
    <span class="tok-kd">static</span> <span class="tok-n">hasOne</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-nl">actoper:</span><span class="tok-n">ActiveOperation</span><span class="tok-o">]</span>

    <span class="tok-kd">static</span> <span class="tok-n">constraints</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
        <span class="tok-n">actoper</span> <span class="tok-nl">unique:</span><span class="tok-kc">true</span>
    <span class="tok-o">}</span>
    <span class="tok-o">....</span>
<span class="tok-o">}</span>

<span class="tok-kd">class</span> <span class="tok-nc">ActiveOperation</span><span class="tok-o">{</span>
    <span class="tok-o">....</span>
    <span class="tok-n">Book</span> <span class="tok-n">book</span>
    <span class="tok-o">....</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En esta ocasión, se creará una relación bidireccional de uno a uno entre los libros y las operaciones activas y se creará una columna de clave ajena en la tabla <em>active_operation</em> llamada <em>book_id</em>.</p>
</div>
<div class="paragraph">
<p>En estos casos, desde la documentación de Grails se aconseja que especifiquemos también una restricción indicando que la propiedad será única.</p>
</div>
</div>
<div class="sect4">
<h5 id="_uno_a_muchos">Uno a muchos</h5>
<div class="paragraph">
<p>Una relación uno-a-muchos se da cuando un registro de la tabla A puede referenciar muchos registros de la tabla B, pero todos los registros de la tabla B sólo pueden referenciar un registro de la tabla A. Por ejemplo, en nuestra aplicación de ejemplo, una tarea sólo puede estar relacionada con una categoría, pero una categoría puede tener muchas tareas. Esto se representa de la siguiente forma en la definición de las clases de dominio.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">Category</span> <span class="tok-o">{</span>
    <span class="tok-o">....</span>
    <span class="tok-kd">static</span> <span class="tok-n">hasMany</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-nl">todos:</span><span class="tok-n">Todo</span><span class="tok-o">]</span>
    <span class="tok-o">....</span>
<span class="tok-o">}</span>

<span class="tok-kd">class</span> <span class="tok-nc">Todo</span> <span class="tok-o">{</span>
    <span class="tok-o">....</span>
    <span class="tok-n">Category</span> <span class="tok-n">category</span>
    <span class="tok-o">....</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Con esta definición de las clases de dominio, las actualizaciones y los almacenamientos se realizan en cascada mientras que los borrados sólo se realizarán en cascada si especificamos la otra parte de la relación con un <em>belongsTo</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">Category</span> <span class="tok-o">{</span>
    <span class="tok-o">....</span>
    <span class="tok-kd">static</span> <span class="tok-n">hasMany</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-nl">todos:</span><span class="tok-n">Todo</span><span class="tok-o">]</span>
    <span class="tok-o">....</span>
<span class="tok-o">}</span>

<span class="tok-kd">class</span> <span class="tok-nc">Todo</span> <span class="tok-o">{</span>
    <span class="tok-o">....</span>
    <span class="tok-kd">static</span> <span class="tok-n">belongsTo</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-nl">category:</span><span class="tok-n">Category</span><span class="tok-o">]</span>
    <span class="tok-o">....</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Estas propiedades que representan la relación de uno a muchos son consideradas como colecciones de datos y para insertar o eliminar datos de las mismas únicamente debemos utilizar un par de métodos de GORM que son <em>addTo()</em> y <em>removeFrom()</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">//Ejemplo para insertar datos en relaciones</span>
<span class="tok-kt">def</span> <span class="tok-n">todo</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Todo</span><span class="tok-o">(</span><span class="tok-nl">title:</span><span class="tok-s2">&quot;Limpiar cocina&quot;</span><span class="tok-o">,</span> <span class="tok-nl">description:</span><span class="tok-s2">&quot;Limpiar la cocina a fondo&quot;</span><span class="tok-o">,</span> <span class="tok-o">...)</span>

<span class="tok-kt">def</span> <span class="tok-n">category</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Category</span><span class="tok-o">(</span><span class="tok-nl">name:</span><span class="tok-s2">&quot;Hogar&quot;</span><span class="tok-o">)</span>

<span class="tok-n">category</span><span class="tok-o">.</span><span class="tok-na">addToTodos</span><span class="tok-o">(</span><span class="tok-n">todo</span><span class="tok-o">)</span>
<span class="tok-n">category</span><span class="tok-o">.</span><span class="tok-na">save</span><span class="tok-o">()</span>

<span class="tok-c1">//Ejemplo para eliminar datos de relaciones</span>
<span class="tok-n">category</span><span class="tok-o">.</span><span class="tok-na">removeFromTodos</span><span class="tok-o">(</span><span class="tok-n">todo</span><span class="tok-o">)</span>
<span class="tok-n">category</span><span class="tok-o">.</span><span class="tok-na">save</span><span class="tok-o">()</span>

<span class="tok-c1">//Ejemplo para buscar tareas dentro de una categoría</span>
<span class="tok-kt">def</span> <span class="tok-n">todosfound</span> <span class="tok-o">=</span> <span class="tok-n">category</span><span class="tok-o">.</span><span class="tok-na">todos</span><span class="tok-o">.</span><span class="tok-na">find</span> <span class="tok-o">{</span><span class="tok-n">it</span><span class="tok-o">.</span><span class="tok-na">title</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;Limpiar cocina&quot;</span><span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_muchos_a_muchos">Muchos a muchos</h5>
<div class="paragraph">
<p>En una relación muchos-a-muchos un registro de la tabla A puede referenciar muchos registros de la tabla B y un registro de la tabla B referenciar igualmente muchos registros de la tabla A. En nuestra aplicación ejemplo  disponemos de la relación entre tareas y etiquetas en la que una tarea puede estar relacionada con muchas etiquetas y viceversa. Esto se representa con una relación muchos-a-muchos de la siguiente forma.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">Tag</span><span class="tok-o">{</span>
    <span class="tok-o">....</span>
    <span class="tok-kd">static</span> <span class="tok-n">hasMany</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-nl">todos:</span><span class="tok-n">Todo</span><span class="tok-o">]</span>
    <span class="tok-o">....</span>
<span class="tok-o">}</span>

<span class="tok-kd">class</span> <span class="tok-nc">Todo</span><span class="tok-o">{</span>
    <span class="tok-o">....</span>
    <span class="tok-kd">static</span> <span class="tok-n">hasMany</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-nl">tags:</span><span class="tok-n">Tag</span><span class="tok-o">]</span>
    <span class="tok-kd">static</span> <span class="tok-n">belongsTo</span> <span class="tok-o">=</span> <span class="tok-n">Tag</span>
    <span class="tok-o">....</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En GORM, una relación muchos-a-muchos se representa indicando en ambas clases la propiedad <em>hasMany</em> y en al menos una de ellas la propiedad <em>belongsTo</em>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_restricciones">5.2. Restricciones</h3>
<div class="paragraph">
<p>El siguiente punto que vamos a ver trata a fondo las definiciones de restricciones en las clases de dominios.</p>
</div>
<div class="sect3">
<h4 id="_restricciones_predefinidas_en_gorm">5.2.1. Restricciones predefinidas en GORM</h4>
<div class="paragraph">
<p>Para controlar estas restricciones, GORM dispone de una serie de funciones comunes predefinidas para establecerlas. Además, también nos permitirá crear nuestras propias restricciones. Hasta ahora, ya hemos visto algunas de estas restricciones como pueden ser <em>size</em>, <em>unique</em> o <em>blank</em> entre otras. Recordamos que para establecer las restricciones de una clase de dominio debemos establecer la propiedad estática <em>constraints</em> como en el siguiente ejemplo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">es</span><span class="tok-o">.</span><span class="tok-na">ua</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">todo</span>

<span class="tok-kd">class</span> <span class="tok-nc">Todo</span> <span class="tok-o">{</span>
    <span class="tok-n">String</span> <span class="tok-n">title</span>
    <span class="tok-n">String</span> <span class="tok-n">description</span>
    <span class="tok-n">Date</span> <span class="tok-n">date</span>
    <span class="tok-n">Date</span> <span class="tok-n">reminderDate</span>
    <span class="tok-n">String</span> <span class="tok-n">url</span>
    <span class="tok-n">Boolean</span> <span class="tok-n">done</span> <span class="tok-o">=</span> <span class="tok-kc">false</span>
    <span class="tok-n">Category</span> <span class="tok-n">category</span>

    <span class="tok-kd">static</span> <span class="tok-n">hasMany</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-nl">tags:</span><span class="tok-n">Tag</span><span class="tok-o">]</span>
    <span class="tok-kd">static</span> <span class="tok-n">belongsTo</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-n">Tag</span><span class="tok-o">]</span>

    <span class="tok-kd">static</span> <span class="tok-n">constraints</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
        <span class="tok-n">title</span><span class="tok-o">(</span><span class="tok-nl">blank:</span><span class="tok-kc">false</span><span class="tok-o">)</span>
        <span class="tok-n">description</span><span class="tok-o">(</span><span class="tok-nl">blank:</span><span class="tok-kc">true</span><span class="tok-o">,</span> <span class="tok-nl">nullable:</span><span class="tok-kc">true</span><span class="tok-o">,</span> <span class="tok-nl">maxSize:</span><span class="tok-mi">1000</span><span class="tok-o">)</span>
        <span class="tok-n">date</span><span class="tok-o">(</span><span class="tok-nl">nullable:</span><span class="tok-kc">false</span><span class="tok-o">)</span>
        <span class="tok-n">reminderDate</span><span class="tok-o">(</span><span class="tok-nl">nullable:</span><span class="tok-kc">true</span><span class="tok-o">)</span>
        <span class="tok-n">url</span><span class="tok-o">(</span><span class="tok-nl">nullable:</span><span class="tok-kc">true</span><span class="tok-o">,</span> <span class="tok-nl">url:</span><span class="tok-kc">true</span><span class="tok-o">)</span>
        <span class="tok-n">done</span><span class="tok-o">(</span><span class="tok-nl">nullable:</span><span class="tok-kc">false</span><span class="tok-o">)</span>
        <span class="tok-n">category</span><span class="tok-o">(</span><span class="tok-nl">nullable:</span><span class="tok-kc">true</span><span class="tok-o">)</span>
    <span class="tok-o">}</span>

    <span class="tok-n">String</span> <span class="tok-nf">toString</span><span class="tok-o">(){</span>
        <span class="tok-n">title</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A continuación, vamos veremos las restricciones que podemos utilizar directamente con GORM.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33%;">
<col style="width: 33%;">
<col style="width: 33%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Nombre</th>
<th class="tableblock halign-left valign-top">Descripción</th>
<th class="tableblock halign-left valign-top">Ejemplo</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">blank</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Valida si la cadena puede quedar o no vacía</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">login(blank:false)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">creditCard</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Valida si la cadena introducida es un número de tarjeta correcto</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">tarjetaCredito(creditCard:true)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">email</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Valida si la cadena introducida es un correo electrónico correcto</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">correoElectronico(email:true)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indica si la propiedad es una contraseña, con lo que al introducirla no se mostrará directamente</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">contrasenya(password:true)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">inList</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Valida que la propiedad contenga cualquiera de los valores pasados por parámetro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">tipo(inList:["administrador", "bibliotecario", "profesor", "socio"])</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">matches</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Valida la cadena introducida contra una expresión regular pasada por parámetro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">login(matches:"[a-zA-Z]+")</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">max</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Valida que el número introducido no sea mayor que el número pasado por parámetro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">price(max:999F)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">min</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Valida que el número introducido no sea menor que el número pasado por parámetro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">price(min:0F)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">minSize</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Valida que la longitud de la cadena introducida sea superior al número pasado por parámetro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">hijos(minSize:5)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">maxSize</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Valida que la longitud de la cadena introducida sea inferior al número pasado por parámetro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">hijos(maxSize:15)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">notEqual</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Valida que el objeto asignado a la propiedad no sea igual que el objeto pasado por parámetro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">login(notEqual:"admin")</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">nullable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Valida si el objeto puede ser <em>null</em> o no</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">edad(nullable:true)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">range</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Valida que el objeto esté dentro del rango pasado por parámetro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">edad(range:0..99)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">scale</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indica el número de decimales de la propiedad</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">salario(scale:2)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Valida que la longitud de la cadena esté dentro del rango pasado por parámetro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">login(size:5..15)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">unique</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Especifica que la propiedad debe ser única y no se puede repetir ningún objeto</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">login(unique:true)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">url</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Valida que la cadena introducida sea una dirección URL correcta</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">website(url:true)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Pero además de estas restricciones, Grails también tiene otras más que suponen una serie de cambios en la interfaz de usuario generado y aunque no es muy recomendable mezclar este tipo de información en las clases de dominio, cuando usamos el scaffolding en gran parte de nuestro proyecto, es muy cómodo indicarle algunas particularidades a nuestro proyecto para facilitarle su renderizado. Estas restricciones son las siguientes:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33%;">
<col style="width: 33%;">
<col style="width: 33%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Nombre</th>
<th class="tableblock halign-left valign-top">Descripción</th>
<th class="tableblock halign-left valign-top">Ejemplo</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">display</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indica si la propiedad debe mostrare o no en las vistas generadas por el scaffolding. El valor por defecto es <em>true</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">password(display:false)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">editable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indica si la propiedad es editable o no. Se suele utilizar en aquellas propiedades de solo lectura</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">username(editable:false)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">format</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Especifica el formato aceptado en aquellos tipos que lo acepten, como pueden ser las fechas</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dateOfBirth(format:'yyyy-MM-dd')</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indica si la propiedad es una contraseña, con lo que al introducirla no se mostrará directamente</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">password(password:true)</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_construir_tus_propias_restricciones">5.2.2. Construir tus propias restricciones</h4>
<div class="paragraph">
<p>Pero seríamos un tanto ilusos si pensáramos que el equipo de desarrollo de Grails ha sido capaz de crear todas las posibles restricciones existentes en cualquier aplicación. Ellos no lo han hecho, pero si han dejado la posibilidad de crear nuestras propias restricciones de una forma rápida y sencilla.</p>
</div>
<div class="paragraph">
<p>Si echamos un vistazo a la clase de dominio <em>Todo</em>, podemos detectar que una posible restricción que nos falta por añadir sería la comprobación de que la <em>fecha</em> sea posterior a la fecha actual. Para esta restricción, Grails se ha olvidado de nosotros ya que si repasamos la lista de restricciones predefinidas, no encontramos ninguna que satisfaga dicha restricción. Para crear nuevas restricciones, tenemos el closure <em>validator</em>. Veamos como quedaría esta restricción:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">date</span><span class="tok-o">(</span><span class="tok-nl">nullable:</span><span class="tok-kc">true</span><span class="tok-o">,</span>
    <span class="tok-nl">validator:</span> <span class="tok-o">{</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">it</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-k">return</span> <span class="tok-n">it</span><span class="tok-o">?.</span><span class="tok-na">after</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-n">Date</span><span class="tok-o">())</span>
        <span class="tok-o">}</span>
        <span class="tok-k">return</span> <span class="tok-kc">true</span>
    <span class="tok-o">}</span>
<span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El closure <em>validator</em> debe devolver <em>true</em> en caso de que la validación se pase correctamente y <em>false</em> en caso contrario. Gracias a la variable <em>it</em> podemos acceder al valor introducido para analizarlo y comprobar que cumple los requisitos, en este caso, que la fecha no sea anterior a la actual.</p>
</div>
<div class="paragraph">
<p>Este closure <em>validator</em> también puede recibir un par de parámetros que nos permitirá evaluar el valor proporcionado a una propiedad con respecto a cualquier otra propiedad del objeto. El siguiente ejemplo de restricción nos permitirá comprobar que la fecha de recordatorio sea siempre anterior a la fecha de la propia tarea:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">reminderDate</span><span class="tok-o">(</span><span class="tok-nl">nullable:</span><span class="tok-kc">true</span><span class="tok-o">,</span>
    <span class="tok-nl">validator:</span> <span class="tok-o">{</span> <span class="tok-n">val</span><span class="tok-o">,</span> <span class="tok-n">obj</span> <span class="tok-o">-&gt;</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">val</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-n">obj</span><span class="tok-o">.</span><span class="tok-na">date</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-k">return</span> <span class="tok-n">val</span><span class="tok-o">.</span><span class="tok-na">before</span><span class="tok-o">(</span><span class="tok-n">obj</span><span class="tok-o">?.</span><span class="tok-na">date</span><span class="tok-o">)</span>
        <span class="tok-o">}</span>
        <span class="tok-k">return</span> <span class="tok-kc">true</span>
    <span class="tok-o">}</span>
<span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En ocasiones es conveniente reutilizar el código de una restricción en diferentes propiedades de diferentes clases de dominio. Para ello en lugar de definir la restricción en la clase de dominio la definiremos en el archivo de configuración <em>Config.groovy</em> de la siguiente forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">grails</span><span class="tok-o">.</span><span class="tok-na">gorm</span><span class="tok-o">.</span><span class="tok-na">default</span><span class="tok-o">.</span><span class="tok-na">constraints</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
    <span class="tok-n">max20chars</span><span class="tok-o">(</span><span class="tok-nl">nullable:</span> <span class="tok-kc">false</span><span class="tok-o">,</span> <span class="tok-nl">blank:</span> <span class="tok-kc">false</span><span class="tok-o">,</span> <span class="tok-nl">maxSize:</span><span class="tok-mi">20</span><span class="tok-o">)</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Posteriormente en la propiedad que necesites utilizar esta restricción, debes referenciarla de esta forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">User</span> <span class="tok-o">{</span>
    <span class="tok-o">...</span>
    <span class="tok-kd">static</span> <span class="tok-n">constraints</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
        <span class="tok-n">password</span> <span class="tok-nl">shared:</span> <span class="tok-s2">&quot;max20chars&quot;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_mensajes_de_error_de_las_restricciones">5.2.3. Mensajes de error de las restricciones</h4>
<div class="paragraph">
<p>Sin lugar a dudas, los mensajes que se generan cuando se produce un error en las restricciones de una clase de dominio, no son lo más deseable para un usuario final, así que es necesario que entendamos el mecanismo que utiliza Grails para devolver estos mensajes cuando se producen estos errores.</p>
</div>
<div class="paragraph">
<p>Si recordamos la clase de dominio <em>Todo</em>, tenemos que el título no puede dejarse vacío. Esto lo hacíamos utilizando la restricción <em>blank:false</em>. Al intentar crear una tarea sin escribir su título, recibiremos un mensaje de error como el siguiente <em>La propiedad [title] de la clase [class Todo] no puede ser vacía</em>. Pero, ¿cómo se encarga Grails de mostrar estos mensajes de error?</p>
</div>
<div class="paragraph">
<p>Grails implementa un sistema jerárquico para los mensajes de error basado en diferentes aspectos como puede ser el nombre de la clase de dominio, la propiedad o el tipo de validación. Para el caso del error producido al saltarnos la restricción de no dejar en blanco el campo <em>title</em> de la clase de dominio <em>Todo</em>, dicha jerarquía sería la siguiente.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">todo</span><span class="tok-o">.</span><span class="tok-na">title</span><span class="tok-o">.</span><span class="tok-na">blank</span><span class="tok-o">.</span><span class="tok-na">error</span><span class="tok-o">.</span><span class="tok-na">title</span>
<span class="tok-n">todo</span><span class="tok-o">.</span><span class="tok-na">title</span><span class="tok-o">.</span><span class="tok-na">blank</span><span class="tok-o">.</span><span class="tok-na">error</span><span class="tok-o">.</span><span class="tok-na">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">String</span>
<span class="tok-n">todo</span><span class="tok-o">.</span><span class="tok-na">title</span><span class="tok-o">.</span><span class="tok-na">blank</span><span class="tok-o">.</span><span class="tok-na">error</span>
<span class="tok-n">todo</span><span class="tok-o">.</span><span class="tok-na">title</span><span class="tok-o">.</span><span class="tok-na">blank</span><span class="tok-o">.</span><span class="tok-na">title</span>
<span class="tok-n">todo</span><span class="tok-o">.</span><span class="tok-na">title</span><span class="tok-o">.</span><span class="tok-na">blank</span><span class="tok-o">.</span><span class="tok-na">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">String</span>
<span class="tok-n">todo</span><span class="tok-o">.</span><span class="tok-na">title</span><span class="tok-o">.</span><span class="tok-na">blank</span>
<span class="tok-n">blank</span><span class="tok-o">.</span><span class="tok-na">title</span>
<span class="tok-n">blank</span><span class="tok-o">.</span><span class="tok-na">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">String</span>
<span class="tok-n">blank</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Este sería el orden en el que Grails buscaría en nuestro archivo <em>message.properties</em> hasta encontrar cualquier propiedad y mostrar su mensaje. En caso de no encontrar ninguna de estas propiedades, se mostraría la cadena asociado a la propiedad <em>default.blank.message</em>, que es la que encontramos por defecto en el archivo <em>message.properties</em>.</p>
</div>
<div class="paragraph">
<p>De esta forma, ya podemos personalizar los mensajes de error generados al incumplir las restricciones de nuestras clases de dominio. Simplemente comentar que para las restricciones creadas por nosotros mismos, la jerarquía de los mensajes en el validador introducido en la clase de dominio <em>Todo</em> empezaría por <em>todo.date.validator.error.date</em> y así sucesivamente tal y como hemos visto anteriormente.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_aspectos_avanzados_de_gorm">5.3. Aspectos avanzados de GORM</h3>
<div class="paragraph">
<p>Ahora que ya hemos visto la parte básica a la hora de crear una clase de dominio (establecer sus propiedades, las restricciones y las relaciones entre ellas), vayamos un paso más adelante y veamos aspectos algo más avanzados de GORM</p>
</div>
<div class="sect3">
<h4 id="_ajustes_de_mapeado">5.3.1. Ajustes de mapeado</h4>
<div class="paragraph">
<p>Hay ocasiones en que los administradores de las bases de datos quieren, por cualquier motivo, que las columnas de las tablas de <em>sus</em> bases de datos sean nombradas siguiendo un determinado patrón. Estos motivos pueden ir desde cuestiones de facilidad en la lectura de los campos hasta argumentos como <em>"así se ha hecho toda la vida y no se va a cambiar"</em>. El tema está en que hay que conformarse con sus ordenes y acatarlas y encontrar la mejor forma para adaptarse a ellas.</p>
</div>
<div class="paragraph">
<p>Para solucionar este posible problema que se nos puede plantear en cualquier organización, GORM dispone de una forma rápida y sencilla para ajustar estos nombres de las columnas de las tablas relacionadas. Para ello, GORM emplea una sintaxis de tipo DSL y exige crear un nuevo closure estático llamado <em>mapping</em> de la siguiente forma <em>static mapping = {//Todo el mapeado de la tabla aquí}</em>. Veamos los posibles cambios que podemos hacer con GORM.</p>
</div>
<div class="sect4">
<h5 id="_nombres_de_las_tablas_y_las_columnas">Nombres de las tablas y las columnas</h5>
<div class="paragraph">
<p>Si necesitáramos cambiar por ejemplo el nombre de la tabla <em>todo</em> por <em>tbl_todo</em>, deberíamos escribir dentro del closure <em>mapping</em> el siguiente código <em>table 'tbl_todo'</em>. Si ahora quisiéramos cambiar el nombre de la columna <em>description</em> por <em>desc</em>, podríamos hacer lo siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">Todo</span> <span class="tok-o">{</span>
    <span class="tok-o">....</span>
    <span class="tok-kd">static</span> <span class="tok-n">mapping</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
        <span class="tok-n">table</span> <span class="tok-s1">&#39;tbl_todo&#39;</span>
        <span class="tok-n">description</span> <span class="tok-nl">column:</span><span class="tok-s1">&#39;desc&#39;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Con esto, ya tendríamos cambiados los nombres de las tablas y de las columnas para adaptarlos al convenio que nosotros queramos seguir.</p>
</div>
</div>
<div class="sect4">
<h5 id="_deshabilitar_el_campo_version">Deshabilitar el campo version</h5>
<div class="paragraph">
<p>Por defecto, GORM utiliza un campo llamado <em>version</em> para garantizar la integridad de los datos y está demostrado que es un buen método. Sin embargo, por cualquier motivo es posible que no queramos tener este campo en nuestra tabla y para ello, simplemente debemos especificar en el mapeado de la clase lo siguiente: <em>version false</em>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_carga_perezosa_de_los_datos">Carga perezosa de los datos</h5>
<div class="paragraph">
<p>Por defecto, Grails realiza una carga perezosa de los datos de las propiedades. Esto es que no se cargarán en memoria hasta que no sean solicitados por la operación, lo cual nos previene de posibles pérdidas de rendimiento al cargar demasiados datos innecesarios. Sin embargo, si queremos cambiar este comportamiento por defecto de Grails, podemos hacerlo de dos formas:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">Person</span> <span class="tok-o">{</span>

    <span class="tok-n">String</span> <span class="tok-n">firstName</span> <span class="tok-n">Pet</span> <span class="tok-n">pet</span>

    <span class="tok-kd">static</span> <span class="tok-n">hasMany</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-nl">addresses:</span> <span class="tok-n">Address</span><span class="tok-o">]</span>

    <span class="tok-kd">static</span> <span class="tok-n">mapping</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
        <span class="tok-n">addresses</span> <span class="tok-nl">lazy:</span> <span class="tok-kc">false</span>
        <span class="tok-n">pet</span> <span class="tok-nl">fetch:</span> <span class="tok-s1">&#39;join&#39;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span>


<span class="tok-kd">class</span> <span class="tok-nc">Address</span> <span class="tok-o">{</span>
    <span class="tok-n">String</span> <span class="tok-n">street</span>
    <span class="tok-n">String</span> <span class="tok-n">postCode</span>
<span class="tok-o">}</span>


<span class="tok-kd">class</span> <span class="tok-nc">Pet</span> <span class="tok-o">{</span>
    <span class="tok-n">String</span> <span class="tok-n">name</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Indicando <em>addresses lazy: false</em> nos aseguramos que cuando los datos de una persona se carguen en nuestra aplicación, sus direcciones serán cargadas al mismo tiempo. Por otro lado, con la opción <em>pet fetch:'join'</em> hacemos básicamente lo mismo salvo que en lugar de hacerlo con un <em>SELECT</em> como se estaría haciendo con la opción anterior lo estaríamos haciendo con una operación de tipo <em>JOIN</em>. Si queremos reducir el número de queries y mejorar el rendimiento de la operación, deberíamos utilizar la segunda opción. Sin embargo, hay que tener cuidado con estas opciones ya que podemos cargar demasiados datos innecesarios.</p>
</div>
</div>
<div class="sect4">
<h5 id="_sistema_caché">Sistema caché</h5>
<div class="paragraph">
<p>Uno de las grandes ventajas de Hibernate es la posibilidad de utilizar una caché de segundo nivel, que almacena los datos asociados a una clase de dominio. Para configurar esta caché de segundo nivel, en primer lugar debemos modificar el archivo de configuración <em>grails-app/conf/DataSource.groovy</em> para indicarle quien se encargará de gestionar esta caché.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">hibernate</span> <span class="tok-o">{</span>
    <span class="tok-n">cache</span><span class="tok-o">.</span><span class="tok-na">use_second_level_cache</span> <span class="tok-o">=</span> <span class="tok-kc">true</span>
    <span class="tok-n">cache</span><span class="tok-o">.</span><span class="tok-na">use_query_cache</span> <span class="tok-o">=</span> <span class="tok-kc">true</span>
    <span class="tok-n">cache</span><span class="tok-o">.</span><span class="tok-na">region</span><span class="tok-o">.</span><span class="tok-na">factory_class</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;net.sf.ehcache.hibernate.EhCacheRegionFactory&#39;</span>
    <span class="tok-n">singleSession</span> <span class="tok-o">=</span> <span class="tok-kc">true</span>
    <span class="tok-n">flush</span><span class="tok-o">.</span><span class="tok-na">mode</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;manual&#39;</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Posteriormente, para utilizar este sistema de caché, podemos especificarlo en la propia clase de dominio de la siguiente forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">User</span> <span class="tok-o">{</span>
    <span class="tok-o">...</span>
    <span class="tok-kd">static</span> <span class="tok-n">mapping</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
        <span class="tok-n">table</span> <span class="tok-s1">&#39;tbl_users&#39;</span>
        <span class="tok-n">cache</span> <span class="tok-kc">true</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Esta caché sería de tipo <em>lectura-escritura</em> e incluiría todas las propiedades, tanto las perezosas como las no perezosas. Pero también es posible ser un poco más específico e indicarle como queremos que se configure la caché de una determinada clase de dominio.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">User</span> <span class="tok-o">{</span>
    <span class="tok-o">...</span>
    <span class="tok-kd">static</span> <span class="tok-n">mapping</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
        <span class="tok-n">table</span> <span class="tok-s1">&#39;tbl_users&#39;</span>
        <span class="tok-n">cache</span> <span class="tok-nl">usage:</span> <span class="tok-s1">&#39;read-only&#39;</span><span class="tok-o">,</span> <span class="tok-nl">include:</span> <span class="tok-s1">&#39;non-lazy&#39;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Incluso también podemos especificar la caché para una asociación de la siguiente forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">Person</span> <span class="tok-o">{</span>

    <span class="tok-n">String</span> <span class="tok-n">firstName</span>

    <span class="tok-kd">static</span> <span class="tok-n">hasMany</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-nl">addresses:</span> <span class="tok-n">Address</span><span class="tok-o">]</span>

    <span class="tok-kd">static</span> <span class="tok-n">mapping</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
        <span class="tok-n">table</span> <span class="tok-s1">&#39;people&#39;</span>
        <span class="tok-n">version</span> <span class="tok-kc">false</span>
        <span class="tok-n">addresses</span> <span class="tok-nl">column:</span> <span class="tok-s1">&#39;Address&#39;</span><span class="tok-o">,</span> <span class="tok-nl">cache:</span> <span class="tok-kc">true</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>De esta forma, sólo estaríamos cacheando la propiedad <em>addresses</em> de la clase <em>Person</em>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_modificar_la_clave_primaria">Modificar la clave primaria</h5>
<div class="paragraph">
<p>En ocasiones podemos necesitar modificar el sistema de clave primaria que utiliza Grails por defecto en el que se añade una propiedad llamada <em>id</em> autonumérico. Podríamos por ejemplo establecer como clave primaria de la tabla de las tareas la composición del título y la categoría de la siguiente forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">static</span> <span class="tok-n">mapping</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
    <span class="tok-n">id</span> <span class="tok-nl">composite:</span> <span class="tok-o">[</span><span class="tok-s1">&#39;title&#39;</span><span class="tok-o">,</span> <span class="tok-s1">&#39;category&#39;</span><span class="tok-o">]</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_herencia_de_clases">5.3.2. Herencia de clases</h4>
<div class="paragraph">
<p>La herencia de clases es algo muy común y GORM lo implementa de forma tan sencilla como <em>extendiendo</em> la clase. Por ejemplo, imagina el caso de una clase de dominio Usuario que a su vez puede tener 3 tipos distintos. Podríamos tener algo así:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">User</span><span class="tok-o">{</span>
    <span class="tok-o">....</span>
<span class="tok-o">}</span>

<span class="tok-kd">class</span> <span class="tok-nc">Administrator</span> <span class="tok-kd">extends</span> <span class="tok-n">User</span><span class="tok-o">{</span>
    <span class="tok-o">....</span>
<span class="tok-o">}</span>

<span class="tok-kd">class</span> <span class="tok-nc">Registered</span> <span class="tok-kd">extends</span> <span class="tok-n">User</span><span class="tok-o">{</span>
    <span class="tok-o">....</span>
<span class="tok-o">}</span>

<span class="tok-kd">class</span> <span class="tok-nc">Guest</span> <span class="tok-kd">extends</span> <span class="tok-n">User</span><span class="tok-o">{</span>
    <span class="tok-o">....</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pero, ¿cómo se transformaría esto en la base de datos? GORM habría almacenado todos los datos en una única tabla y además, hubiera añadido un campo llamado <em>class</em> que permitiría distinguir el tipo de instancia creada. No obstante, si optásemos por tener una tabla por cada tipo de usuario, podríamos tener lo siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">User</span><span class="tok-o">{</span>
    <span class="tok-o">....</span>
<span class="tok-o">}</span>

<span class="tok-kd">class</span> <span class="tok-nc">Administrator</span> <span class="tok-kd">extends</span> <span class="tok-n">User</span><span class="tok-o">{</span>
    <span class="tok-kd">static</span> <span class="tok-n">mapping</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
        <span class="tok-n">table</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;administrator&#39;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span>

<span class="tok-kd">class</span> <span class="tok-nc">Registered</span> <span class="tok-kd">extends</span> <span class="tok-n">User</span><span class="tok-o">{</span>
    <span class="tok-kd">static</span> <span class="tok-n">mapping</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
        <span class="tok-n">table</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;registered&#39;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span>

<span class="tok-kd">class</span> <span class="tok-nc">Guest</span> <span class="tok-kd">extends</span> <span class="tok-n">User</span><span class="tok-o">{</span>
    <span class="tok-kd">static</span> <span class="tok-n">mapping</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
        <span class="tok-n">table</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;guest&#39;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Otra opción sería especificar en la clase padre la propiedad <em>tablePerHierarchy</em> a falso de la siguiente forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">User</span><span class="tok-o">{</span>
    <span class="tok-o">.....</span>
    <span class="tok-kd">static</span> <span class="tok-n">mapping</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
        <span class="tok-n">tablePerHierarchy</span> <span class="tok-kc">false</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_propiedades_transitorias">5.3.3. Propiedades transitorias</h4>
<div class="paragraph">
<p>Por defecto, con GORM todas las propiedades definidas en una clase de dominio son persistidas en la base de datos. Sin embargo, en ocasiones es posible que tengamos determinadas propiedades que no deseamos que sean almacenadas en la base de datos, tales como por ejemplo la confirmación de una contraseña por parte de un usuario. Para ello, podemos añadir una nueva propiedad llamada <em>transients</em> a la clase de dominio correspondiente con la propiedad que no deseamos persistir en la base de datos.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">User</span> <span class="tok-o">{</span>
    <span class="tok-kd">static</span> <span class="tok-n">transients</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-s2">&quot;confirmPassword&quot;</span><span class="tok-o">]</span>

    <span class="tok-n">String</span> <span class="tok-n">username</span>
    <span class="tok-n">String</span> <span class="tok-n">password</span>
    <span class="tok-n">String</span> <span class="tok-n">confirmPassword</span>
    <span class="tok-n">String</span> <span class="tok-n">name</span>
    <span class="tok-n">String</span> <span class="tok-n">surnames</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_eventos_gorm">5.3.4. Eventos GORM</h4>
<div class="paragraph">
<p>GORM dispone de dos métodos que se llaman automáticamente antes y después de insertar y actualizar las tablas de la base de datos. Estos métodos son <em>beforeInsert()</em> y <em>beforeUpdate()</em>. Gracias a estos métodos, vamos a poder realizar determinadas operaciones siempre antes de insertar o actualizar datos de nuestros registros. Por ejemplo, imagina el caso en el que tuviéramos que almacenar quien creó una tarea y quien fue la última persona en actualizarla. Necesitaríamos por ejemplo un par de propiedades llamadas <em>createdBy</em> y <em>lastModifiedBy</em>. Para automáticamente actualizar esta información en nuestra clase de dominio, podríamos utilizar los métodos <em>beforeInsert()</em> y <em>beforeUpdate()</em> de la siguiente forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">Todo</span> <span class="tok-o">{</span>
    <span class="tok-o">....</span>
    <span class="tok-n">User</span> <span class="tok-n">createdBy</span>
    <span class="tok-n">User</span> <span class="tok-n">lastModifiedBy</span>

    <span class="tok-kt">def</span> <span class="tok-n">beforeInsert</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
        <span class="tok-n">createdBy</span> <span class="tok-o">=</span> <span class="tok-n">session</span><span class="tok-o">?.</span><span class="tok-na">user</span>
        <span class="tok-n">lastModifiedBy</span> <span class="tok-o">=</span> <span class="tok-n">session</span><span class="tok-o">?.</span><span class="tok-na">user</span>
    <span class="tok-o">}</span>

    <span class="tok-kt">def</span> <span class="tok-n">beforeUpdate</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
        <span class="tok-n">lastModifiedBy</span> <span class="tok-o">=</span> <span class="tok-n">session</span><span class="tok-o">?.</span><span class="tok-na">user</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Además de estos dos métodos comentados, GORM también dispone de los métodos <em>beforeDelete()</em>, <em>beforeValidate()</em>, <em>afterInsert()</em>, <em>afterUpdate()</em>, <em>afterDelete()</em> y <em>onLoad()</em>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_fechas_automáticas">5.3.5. Fechas automáticas</h4>
<div class="paragraph">
<p>Grails además presenta una característica conocida como <em>automatic timestamping</em>. Con esta característica si queremos saber de una instancia de una determinada clase cuando se creo y cuando se modificó por última vez, simplemente debemos crear dos propiedades de tipo <em>Date</em> en la clase de dominio llamadas <em>dateCreated</em> y <em>lastUpdated</em> y Grails se encargará automáticamente de rellenar esta información por nosotros.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">Todo</span> <span class="tok-o">{</span>
    <span class="tok-o">....</span>
    <span class="tok-n">Date</span> <span class="tok-n">dateCreated</span>
    <span class="tok-n">Date</span> <span class="tok-n">lastUpdated</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si por cualquier motivo, deseamos tener estas dos propiedades pero desactivar el <em>automatic timestamping</em>, podemos hacerlo de la siguiente forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">static</span> <span class="tok-n">mapping</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
    <span class="tok-n">autoTimestamp</span> <span class="tok-kc">false</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_interactuar_con_la_base_de_datos">5.4. Interactuar con la base de datos</h3>
<div class="paragraph">
<p>Cuando interactuamos con una base de datos, lo primero que debemos conocer es como realizar las operaciones básicas en cualquier aplicación (CRUD). Si echamos un vistazo al código del controlador de la clase de dominio <em>Todo</em>, detectaremos la presencia de los métodos <em>delete()</em> y <em>save()</em>. También podemos comprobar como no existe ninguno de estos dos métodos implementados en la clase de dominio <em>Todo</em>. Entonces, ¿cómo es capaz Grails de persistir la información en la base de datos si ninguno de estos dos métodos existen?</p>
</div>
<div class="paragraph">
<p>En Grails tenemos varias formas de realizar consultas a la base de datos que son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Consultas dinámicas de GORM</p>
</li>
<li>
<p>Consultas HQL de Hibernate</p>
</li>
<li>
<p>Consultas Criteria de Hibernate</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_consultas_dinámicas_de_gorm">5.4.1. Consultas dinámicas de GORM</h4>
<div class="paragraph">
<p>Básicamente, la consultas dinámicas de GORM son muy similares a los métodos que habéis visto en el módulo de JPA con lo que únicamente veremos un resumen de las mismas.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 14%;">
<col style="width: 42%;">
<col style="width: 42%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Método</th>
<th class="tableblock halign-left valign-top">Descripción</th>
<th class="tableblock halign-left valign-top">Ejemplo</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>count()</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Devuelve el número total de registros de una determinada clase de dominio</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Todo.count()</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>countBy()</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Devuelve el número total de registros de una determinada clase de dominio que cumplan una serie de requisitos encadenados tras el nombre del método</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Todo.countByTitle('Pintar cocina')</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>findBy()</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Devuelve el primer registro encontrado de una determinada clase de dominio que cumpla una serie de requisitos encadenados tras el nombre del método</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Todo.findByTitle('Pintar cocina')</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>findWhere()</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Devuelve el primer registro encontrado de una determinada clase de dominio que cumpla una serie de requisitos pasados por parámetro en forma de mapa</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Todo.findWhere(["title":"Pintar cocina"])</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>findAllBy()</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Devuelve todos los registros encontrados de una determinada clase de dominio que cumplan una serie de requisitos encadenados tras el nombre del método</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Todo.findAllByTitleIlike('%cocina%')</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>findAllWhere()</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Devuelve todos los registros encontrados de una determinada clase de dominio que cumplan una serie de requisitos pasados por parámetro en forma de mapa</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Todo.findAllWhere(["title":"Pintar cocina"])</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>get()</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Devuelve el registro de una determinada clase de dominio cuyo identificador coincida con el pasado como parámetro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Todo.get(1)</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>getAll()</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Devuelve todos los registros de una determinada clase de dominio cuyo identificador coincida con cualquier de los pasados parámetro en forma de lista</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Todo.getAll([1,3])</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>list()</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Devuelve todos los registros de una determinada clase de dominio. Acepta los parámetros <em>max</em>, <em>offset</em>, <em>sort</em> y <em>order</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Todo.list(["max":10, "offset":0, "sort":"title", "order":"asc"])</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>listOrderBy()</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Devuelve todos los registros de una determinada clase de dominio ordenador por un criterio. Acepta los parámetros <em>max</em>, <em>offset</em> y <em>order</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Todo.listOrderByName(["max":10, "offset":0, "order":"asc"])</em></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Podemos además encadenar varias propiedades junto con el operador utilizado, como por ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">Todo</span><span class="tok-o">.</span><span class="tok-na">findAllByTitleAndDescriptionAndDone</span><span class="tok-o">(</span><span class="tok-s1">&#39;Pintar cocina&#39;</span><span class="tok-o">,</span><span class="tok-kc">null</span><span class="tok-o">,</span> <span class="tok-kc">false</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Seguido de la propiedad podemos indicar el método a seguir en la comparación de registros. En la siguiente tabla se muestra una tabla resumen de esos métodos que podemos utilizar en las comparaciones.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 14%;">
<col style="width: 42%;">
<col style="width: 42%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Método</th>
<th class="tableblock halign-left valign-top">Descripción</th>
<th class="tableblock halign-left valign-top">Ejemplo</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">InList</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Devuelve aquellos registros en los que el valor de la propiedad dada coincida con cualquiera de los elementos de la lista pasada por parámetro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Category.findAllByNameInList(["Hogar","Trabajo"])</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LessThan</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Devuelve aquellos registros en los que el valor de la propiedad dada sea menor que el valor pasado por parámetro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">House.findAllByPriceLessThan(150000)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LessThanEquals</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Devuelve aquellos registros en los que el valor de la propiedad dada sea menor o igual que el valor pasado por parámetro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">House.findAllByPriceLessThanEquals(150000)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GreaterThan</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Devuelve aquellos registros en los que el valor de la propiedad dada sea mayor que el valor pasado por parámetro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Car.findAllByPriceGreaterThan(25000)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GreaterThanEquals</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Devuelve aquellos registros en los que el valor de la propiedad dada sea mayor o igual que el valor pasado por parámetro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Car.findAllByPriceGreaterThanEquals(25000)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Like</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Es equivalente a una expresión <em>LIKE</em> en una sentencia SQL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Todo.findAllByTitleLike('%cocina%')</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ILike</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Similar al método <em>Like</em> salvo que en esta ocasión <em>case insensitive</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Todo.findAllByTitleIlike('%cocina%')</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NotEqual</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Devuelve aquellos registros en los que el valor de la propiedad dada no sea igual al valor pasado por parámetro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Todo.findAllByDoneNotEqual(true)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Between</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Devuelve aquellos registros en los que el valor de la propiedad dada se encuentre entre los dos valores pasados por parámetro. Necesita de dos parámetros.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Car.findAllByPriceBetween(10000,20000)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IsNotNull</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Devuelve aquellos registros en los que el valor de la propiedad dada no sea nula. No se necesita ningún argumento.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">User.findAllByDateOfBirthIsNotNull()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IsNull</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Devuelve aquellos registros en los que el valor de la propiedad dada sea nula</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">User.findAllByDateOfBirthIsNull()</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_consultas_hql_de_hibernate">5.4.2. Consultas HQL de Hibernate</h4>
<div class="paragraph">
<p>Otra forma de realizar consultas sobre la base de datos es mediante el lenguaje de consulta propio de Hibernate, HQL (Hibernate Query Language). Con los métodos dinámicos de GORM vimos que teníamos la posibilidad de ejecutar llamadas a métodos para obtener un registro o un conjunto. Con HQL vamos a tener también esta capacidad con los métodos <em>find()</em> y <em>findAll()</em> más uno nuevo llamado <em>executeQuery()</em>.</p>
</div>
<div class="paragraph">
<p>Con el método <em>find()</em> vamos a poder obtener el primer registro devuelto de la consulta HQL pasada por parámetro. El siguiente ejemplo, devuelve la primera tarea que encuentre en la clase de dominio <em>Todo</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">sentenciaHQL1</span> <span class="tok-o">=</span> <span class="tok-n">Todo</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-s2">&quot;From Todo as t&quot;</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pero lo habitual no es simplemente obtener el primer registro sino que normalmente necesitaremos obtener todos los registros que cumplan una serie de condiciones para posteriormente, actuar en consecuencia. Al igual que con los métodos dinámicos de GORM, HQL dispone también del método <em>findAll()</em> al cual debemos pasarle por parámetro la sentencia HQL correspondiente. En el siguiente ejemplo, vamos a ver tres formas diferentes de obtener determinadas tareas de nuestra aplicación.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">hqlsentence2</span> <span class="tok-o">=</span> <span class="tok-n">Todo</span><span class="tok-o">.</span><span class="tok-na">findAll</span><span class="tok-o">(</span><span class="tok-s2">&quot;from Todo as t where t.title=&#39;Pintar cocina&#39;&quot;</span><span class="tok-o">)</span>

<span class="tok-kt">def</span> <span class="tok-n">hqlsentence3</span> <span class="tok-o">=</span> <span class="tok-n">Todo</span><span class="tok-o">.</span><span class="tok-na">findAll</span><span class="tok-o">(</span><span class="tok-s2">&quot;from Todo as t where t.title=?&quot;</span><span class="tok-o">,</span> <span class="tok-o">[</span><span class="tok-s2">&quot;Escribir tests unitarios&quot;</span><span class="tok-o">])</span>

<span class="tok-kt">def</span> <span class="tok-n">hqlsentence4</span> <span class="tok-o">=</span> <span class="tok-n">Todo</span><span class="tok-o">.</span><span class="tok-na">findAll</span><span class="tok-o">(</span><span class="tok-s2">&quot;from Todo as t where t.title=:title&quot;</span><span class="tok-o">,</span> <span class="tok-o">[</span><span class="tok-nl">title:</span><span class="tok-s2">&quot;Cocinar pastel&quot;</span><span class="tok-o">])</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En la primera de ellas, la sentencia HQL se pasa como parámetro al método <em>findAll()</em> tal cual y sin utilizar ningún parámetro. También es posible pasar parámetros a la sentencia HQL tal y como se ha hecho en la segunda forma. Utilizando el caracter <em>?</em> le especificamos que es valor se pasará en forma de parámetro posicional, es decir, el primer caracter <em>?</em> encontrado en la sentencia HQL se referirá al primer parámetro pasado, el segundo <em>?</em> al segundo parámetro y así sucesivamente.</p>
</div>
<div class="paragraph">
<p>Otra forma posible de implementar sentencias HQL es pasando un mapa con las variables introducidas en la sentencia HQL. Para introducir una variable en una sentencia HQL basta con escribir el carácter <em>:</em> seguido del nombre de la variable que deseemos crear. En el ejemplo hemos creado la variable <em>title</em>, que posteriormente se rellenará en el mapa pasado como parámetro.</p>
</div>
<div class="paragraph">
<p>De igual forma que veíamos anteriormente con los métodos <em>list()</em> y <em>listOrderBy()</em>, HQL permite utilizar los parámetros <em>max</em>, <em>offset</em>, <em>sort</em> y <em>order</em> para afinar aún más la búsqueda.</p>
</div>
<div class="paragraph">
<p>Por último, el método <em>executeQuery()</em> es algo diferente a los métodos <em>find()</em> y <em>findAll()</em>. En estos dos métodos se devolvían todas las columnas de la tabla en cuestión, cosa que no siempre puede ser necesaria. El método <em>executeQuery()</em> permite seleccionar que columnas vamos a devolver. El siguiente ejemplo devuelve sólo la <em>fecha</em> de la tarea cuyo título sea "Pintar cocina".</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">Todo</span><span class="tok-o">.</span><span class="tok-na">executeQuery</span><span class="tok-o">(</span><span class="tok-s2">&quot;select date from Todo t where t.title=&#39;Pintar cocina&#39;&quot;</span><span class="tok-o">)</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_consultas_criteria_de_hibernate">5.4.3. Consultas Criteria de Hibernate</h4>
<div class="paragraph">
<p>El último método para realizar consultas a la base de datos se refiere a la utilización de <em>Criteria</em>, un API de Hibernate diseñado específicamente para la realización de consultas complejas. En Grails, Criteria está basado en un <em>Builder de Groovy</em> y el código mostrado a continuación es un ejemplo de utilización de éste. En este ejemplo vamos a ver como podríamos obtener un listado de las siguientes 15 tareas a realizar en los próximos 10 días ordenadas ascendentemente.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">void</span> <span class="tok-nf">nextTodos</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-kt">def</span> <span class="tok-n">c</span> <span class="tok-o">=</span> <span class="tok-n">Todo</span><span class="tok-o">.</span><span class="tok-na">createCriteria</span><span class="tok-o">()</span>
    <span class="tok-kt">def</span> <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-n">c</span><span class="tok-o">{</span>
        <span class="tok-n">between</span><span class="tok-o">(</span><span class="tok-s2">&quot;date&quot;</span><span class="tok-o">,</span><span class="tok-k">new</span> <span class="tok-n">Date</span><span class="tok-o">(),</span><span class="tok-k">new</span> <span class="tok-n">Date</span><span class="tok-o">()+</span><span class="tok-mi">10</span><span class="tok-o">)</span>
        <span class="tok-n">maxResults</span><span class="tok-o">(</span><span class="tok-mi">15</span><span class="tok-o">)</span>
        <span class="tok-n">order</span><span class="tok-o">(</span><span class="tok-s2">&quot;date&quot;</span><span class="tok-o">,</span><span class="tok-s2">&quot;asc&quot;</span><span class="tok-o">)</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Criteria dispone de una serie de <em>criterios</em> disponibles para ser utilizados en este tipo de consultas. En el ejemplo hemos utilizado <em>between</em>, <em>maxResults</em> y <em>order</em>, pero existen muchos más que vamos a ver en la siguiente tabla.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 14%;">
<col style="width: 42%;">
<col style="width: 42%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Criterio</th>
<th class="tableblock halign-left valign-top">Descripción</th>
<th class="tableblock halign-left valign-top">Ejemplo</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">between</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cuando el valor de la propiedad se encuentra entre dos valores</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>between("date",new Date()-10, new Date())</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">eq</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cuando el valor de una propiedad es igual al valor pasado por parámetro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>eq("make","volkswagen")</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">eqProperty</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cuando dos propiedades tienen el mismo valor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>eqProperty("startDate","endDate")</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">gt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cuando el valor de una propiedad es mayor que el valor pasado por parámetro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>gt("date",new Date()-5)</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">gtProperty</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cuando el valor de una propiedad es mayor que el valor de la propiedad pasada por parámetro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>gtProperty("startDate","endDate")</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ge</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cuando el valor de una propiedad es mayor o igual que el valor pasado por parámetro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>ge("date", new Date()-5)</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">geProperty</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cuando el valor de una propiedad es mayor o igual que el valor de la propiedad pasada por parámetro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>geProperty("startDate", "endDate")</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">idEq</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cuando el identificador de un objeto es igual al valor pasado por parámetro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>idEq(1)</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ilike</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">La sentencia SQL like, pero en modo <em>case insensitive</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>ilike("name", "fran%")</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">in</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cuando el valor de la propiedad es cualquiera de los valores pasados por parámetro. In es una palabra reservada en Groovy, así que debemos utilizar las comillas simples</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>'in'("age",[18..65])</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">isEmpty</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cuando la propiedad se encuentra vacía</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>isEmpty("description")</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">isNotEmpty</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cuando la propiedad no se encuentra vacía</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>isNotEmpty("description")</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">isNull</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cuando el valor de la propiedad es <em>null</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>isNull("description")</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">isNotNull</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cuando el valor de la propiedad no es <em>null</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>isNotNull("description")</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">lt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cuando el valor de una propiedad es menor que el valor pasado por parámetro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>lt("startDate",new Date()-5)</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ltProperty</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cuando el valor de una propiedad es menor que el valor de la propiedad pasada por parámetro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>ltProperty("startDate","endDate")</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">le</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cuando el valor de una propiedad es menor o igual que el valor pasado por parámetro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>le("startDate",new Date()-5)</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">leProperty</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cuando el valor de una propiedad es menor o igual que el valor de la propiedad pasada por parámetro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>leProperty("startDate","endDate")</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">like</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">La sentencia SQL like</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>like("name","Fran%")</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ne</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cuando el valor de una propiedad no es igual al valor pasado por parámetro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>ne("model","volkswagen")</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">neProperty</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cuando el valor de una propiedad no es igual al valor de la propiedad pasada por parámetro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>neProperty("startDate","endDate")</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">order</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ordena los resultados por la propiedad pasada por parámetro y en el orden especificado (asc o desc)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>order("name","asc")</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">rlike</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Similar a la sentencia SQL like, pero utilizando expresiones regulares. Sólo está disponible para Oracle y MySQL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>rlike("name",/Fran.+/)</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sizeEq</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cuando el tamaño del valor de una determinada propiedad es igual al pasado por parámetro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>sizeEq("name",10)</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sizeGt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cuando el tamaño del valor de una determinada propiedad es mayor al pasado por parámetro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>sizeGt("name",10)</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sizeGe</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cuando el tamaño del valor de una determinada propiedad es mayor o igual al pasado por parámetro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>sizeGe("name",10)</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sizeLt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cuando el tamaño del valor de una determinada propiedad es menor al pasado por parámetro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>sizeLt("name",10)</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sizeLe</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cuando el tamaño del valor de una determinada propiedad es menor o igual al pasado por parámetro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>sizeLe("name",10)</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sizeNe</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cuando el tamaño del valor de una determinada propiedad no es igual al pasado por parámetro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>sizeNe("name",10)</em></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Los criterios de búsqueda se pueden incluso agrupar en bloques lógicos. Estos bloques lógicos serán del tipo <em>AND</em>, <em>OR</em> y <em>NOT</em>. Veamos algunos ejemplos.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">and</span> <span class="tok-o">{</span>
    <span class="tok-n">between</span><span class="tok-o">(</span><span class="tok-s2">&quot;date&quot;</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-n">Date</span><span class="tok-o">()-</span><span class="tok-mi">10</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-n">Date</span><span class="tok-o">())</span>
    <span class="tok-n">ilike</span><span class="tok-o">(</span><span class="tok-s2">&quot;content&quot;</span><span class="tok-o">,</span> <span class="tok-s2">&quot;%texto%&quot;</span><span class="tok-o">)</span>
<span class="tok-o">}</span>

<span class="tok-n">or</span> <span class="tok-o">{</span>
    <span class="tok-n">between</span><span class="tok-o">(</span><span class="tok-s2">&quot;date&quot;</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-n">Date</span><span class="tok-o">()-</span><span class="tok-mi">10</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-n">Date</span><span class="tok-o">())</span>
    <span class="tok-n">ilike</span><span class="tok-o">(</span><span class="tok-s2">&quot;content&quot;</span><span class="tok-o">,</span> <span class="tok-s2">&quot;%texto%&quot;</span><span class="tok-o">)</span>
<span class="tok-o">}</span>

<span class="tok-n">not</span> <span class="tok-o">{</span>
    <span class="tok-n">between</span><span class="tok-o">(</span><span class="tok-s2">&quot;date&quot;</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-n">Date</span><span class="tok-o">()-</span><span class="tok-mi">10</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-n">Date</span><span class="tok-o">())</span>
    <span class="tok-n">ilike</span><span class="tok-o">(</span><span class="tok-s2">&quot;content&quot;</span><span class="tok-o">,</span> <span class="tok-s2">&quot;%texto%&quot;</span><span class="tok-o">)</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_servicios">5.5. Servicios</h3>
<div class="paragraph">
<p>En cualquier aplicación que utilice el patrón Modelo Vista Controlador, la capa de servicios debe ser la responsable de la lógica de negocio de nuestra aplicación. Si conseguimos esto, nuestra aplicación será fácil de mantener y evolucionará de forma sencilla y eficiente.</p>
</div>
<div class="paragraph">
<p>Cuando implementamos una aplicación siguiendo el patrón MVC, el principal error que se comete es acumular demasiado código en la capa de control. Si en lugar de hacer esto, implementásemos servicios encargados de esta tarea, nuestra aplicación sería más fácil de mantener. Pero, ¿qué son los servicios en Grails?.</p>
</div>
<div class="paragraph">
<p>Siguiendo el paradigma de <em>convención sobre configuración</em>, los servicios no son más que clases cuyo nombre termina en <em>Service</em> y que se ubican en el directorio <em>grails-app/services</em>.</p>
</div>
<div class="paragraph">
<p>En la aplicación que estamos desarrollando como ejemplo, vamos a crear un método en un servicio que devuelva aquellas tareas que estén planeadas para los próximas X días. Para ello, en primer lugar debemos crear el esqueleto del servicio con el comando <em>grails create-service es.ua.expertojava.todo.todo</em>. Este comando, además del servicio, también creará un test unitario. La clase de servicio que hemos creado tiene la siguiente estructura:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">es</span><span class="tok-o">.</span><span class="tok-na">ua</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">todo</span>

<span class="tok-kn">import</span> <span class="tok-nn">grails.transaction.Transactional</span>

<span class="tok-nd">@Transactional</span>
<span class="tok-kd">class</span> <span class="tok-nc">TodoService</span> <span class="tok-o">{</span>

    <span class="tok-kt">def</span> <span class="tok-nf">serviceMethod</span><span class="tok-o">()</span> <span class="tok-o">{</span>

    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Como vemos, la clase creada especifica la anotación <em>@Transactional</em> que indica que la clase completa con todos los métodos que añadamos serán transaccionales. Esto significa que si en algún método se produce algún error, las operaciones realizadas hasta el momento del error serán desechadas. Sin embargo, existe una forma de ser algo más selectivo e indicar que métodos serán transaccionales y cuales no. Esto se hace también con anotaciones y este es un ejemplo de lo que podríamos tener:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">import</span> <span class="tok-nn">grails.transaction.Transactional</span>

<span class="tok-kd">class</span> <span class="tok-nc">BookService</span> <span class="tok-o">{</span>

    <span class="tok-nd">@Transactional</span><span class="tok-o">(</span><span class="tok-n">readOnly</span> <span class="tok-o">=</span> <span class="tok-kc">true</span><span class="tok-o">)</span>
    <span class="tok-kt">def</span> <span class="tok-nf">listBooks</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">Book</span><span class="tok-o">.</span><span class="tok-na">list</span><span class="tok-o">()</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Transactional</span>
    <span class="tok-kt">def</span> <span class="tok-nf">updateBook</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-c1">// ...</span>
    <span class="tok-o">}</span>

    <span class="tok-kt">def</span> <span class="tok-nf">deleteBook</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-c1">// ...</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En el método <em>listBooks()</em>, le estamos especificando que el método será transaccional de solo lectura. Por otro lado, el método <em>updateBook()</em> será transaccional de lectura-escritura y por último, y que sirva únicamente como ejemplo, tenemos el método <em>deleteBook()</em> que al no indicarle nada, le estamos diciendo a Grails que no es transaccional (por supuesto, esta operación debería ser transaccional. Tómalo únicamente como un ejemplo).</p>
</div>
<div class="paragraph">
<p>Cuando creábamos el servicio <em>TodoService</em>, Grails generaba automáticamente un método vacío llamado <em>serviceMethod()</em> que ahora vamos a sustituir por uno propio que devuelva una serie de tareas comprendidas entre un par de fechas. El método recibirá una fecha inicio y fin y además, un mapa con una serie de parámetros que utilizaremos para paginar en caso de que sea necesario. El método devolverá una colección de instancias de la clase <em>Todo</em>. También crearemos un método que devuelva un contador de cuantas tareas coinciden con ese criterio.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">es</span><span class="tok-o">.</span><span class="tok-na">ua</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">todo</span>

<span class="tok-kn">import</span> <span class="tok-nn">grails.transaction.Transactional</span>

<span class="tok-kd">class</span> <span class="tok-nc">TodoService</span> <span class="tok-o">{</span>

    <span class="tok-kt">def</span> <span class="tok-nf">getNextTodos</span><span class="tok-o">(</span><span class="tok-n">Integer</span> <span class="tok-n">days</span><span class="tok-o">,</span> <span class="tok-n">params</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">Date</span> <span class="tok-n">now</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Date</span><span class="tok-o">(</span><span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">currentTimeMillis</span><span class="tok-o">())</span>
        <span class="tok-n">Date</span> <span class="tok-n">to</span> <span class="tok-o">=</span> <span class="tok-n">now</span> <span class="tok-o">+</span> <span class="tok-n">days</span>
        <span class="tok-n">Todo</span><span class="tok-o">.</span><span class="tok-na">findAllByDateBetween</span><span class="tok-o">(</span><span class="tok-n">now</span><span class="tok-o">,</span> <span class="tok-n">to</span><span class="tok-o">,</span> <span class="tok-n">params</span><span class="tok-o">)</span>
    <span class="tok-o">}</span>

    <span class="tok-kt">def</span> <span class="tok-nf">countNextTodos</span><span class="tok-o">(</span><span class="tok-n">Integer</span> <span class="tok-n">days</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">Date</span> <span class="tok-n">now</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Date</span><span class="tok-o">(</span><span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">currentTimeMillis</span><span class="tok-o">())</span>
        <span class="tok-n">Date</span> <span class="tok-n">to</span> <span class="tok-o">=</span> <span class="tok-n">now</span> <span class="tok-o">+</span> <span class="tok-n">days</span>
        <span class="tok-n">Todo</span><span class="tok-o">.</span><span class="tok-na">countByDateBetween</span><span class="tok-o">(</span><span class="tok-n">now</span><span class="tok-o">,</span> <span class="tok-n">to</span><span class="tok-o">)</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El siguiente paso, será modificar el controlador de la clase de dominio <em>Todo</em> para crear un nuevo método que utilice este servicio recien creado. El método lo vamos a llamar <em>listNextTodos()</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">TodoController</span> <span class="tok-o">{</span>
    <span class="tok-kt">def</span> <span class="tok-n">todoService</span>

    <span class="tok-o">....</span>

    <span class="tok-kt">def</span> <span class="tok-nf">listNextTodos</span><span class="tok-o">(</span><span class="tok-n">Integer</span> <span class="tok-n">days</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">respond</span> <span class="tok-n">todoService</span><span class="tok-o">.</span><span class="tok-na">getNextTodos</span><span class="tok-o">(</span><span class="tok-n">days</span><span class="tok-o">,</span> <span class="tok-n">params</span><span class="tok-o">),</span>
                <span class="tok-nl">model:</span><span class="tok-o">[</span><span class="tok-nl">todoInstanceCount:</span> <span class="tok-n">todoService</span><span class="tok-o">.</span><span class="tok-na">countNextTodos</span><span class="tok-o">(</span><span class="tok-n">days</span><span class="tok-o">)],</span>
                <span class="tok-nl">view:</span><span class="tok-s2">&quot;index&quot;</span>
    <span class="tok-o">}</span>

    <span class="tok-o">....</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Al inicio del controlador debemos crear también la variable <em>def todoService</em> para poder utilizar sus servicios. La convención es que esta variable debe llamarse igual que el servicio salvo que la primera letra será minúscula. De esta forma, una instancia del servicio correspondiente se inyectará convenientemente en nuestro controlador, con lo que no debemos preocuparnos por su ciclo de vida.</p>
</div>
<div class="paragraph">
<p>El método es muy similar al método <em>index()</em> con la excepción de que ahora le pasaremos el parámetro <em>view:"index"</em> para que cuando la petición se realice desde una aplicación web, esta sea renderizada en una página HTML.</p>
</div>
<div class="paragraph">
<p>Con esto tenemos que si accedemos a través del navegador a la url <em><a href="http://localhost:8080/todo/todo/listNextTodos?days=2" class="bare">http://localhost:8080/todo/todo/listNextTodos?days=2</a></em> la aplicación nos mostrará las tareas que tengamos que hacer en los próximos dos días. Si por otro lado ejecutamos desde la línea de comandos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">curl -v -H <span class="tok-s2">&quot;Accept: text/xml&quot;</span> -H <span class="tok-s2">&quot;Content-type: text/xml&quot;</span> -X GET  http://localhost:8080/todo/todo/listNextTodos?days<span class="tok-o">=</span>2</code></pre>
</div>
</div>
<div class="paragraph">
<p>el resultado será un xml con el contenido de las próximas tareas. En el caso en que necesitemos el resultado en formato JSON:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">curl -v -H <span class="tok-s2">&quot;Accept: application/json&quot;</span> -H <span class="tok-s2">&quot;Content-type: application/json&quot;</span> -X GET  http://localhost:8080/todo/todo/listNextTodos?days<span class="tok-o">=</span>2</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_Ámbito_de_los_servicios">5.5.1. Ámbito de los servicios</h4>
<div class="paragraph">
<p>Por defecto, todos los servicios en Grails son de tipo <em>singleton</em>, es decir, sólo existe una instancia de la clase que se inyecta en todos los artefactos que declaren la variable correspondiente. Esto puede servirnos para la mayoría de las situaciones, pero tiene un inconveniente y es que no es posible guardar información <em>privada</em> de una petición en el propio servicio puesto que todos los controladores verían la misma instancia y por lo tanto, el mismo valor. Para solucionar esto, podemos declarar una variable <em>scope</em> con cualquiera de los siguiente valores:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>prototype</em>: cada vez que se inyecta el servicio en otro artefacto se crea una nueva instancia</p>
</li>
<li>
<p><em>request</em>: se crea una nueva instancia para cada solicitud HTTP</p>
</li>
<li>
<p><em>flash</em>: cada instancia estará accesible para la solicitud HTTP actual y para la siguiente</p>
</li>
<li>
<p><em>flow</em>: cuando declaramos el servicio en un web flow, se creará una instancia nueva en cada flujo</p>
</li>
<li>
<p><em>conversation</em>: cuando declaramos el servicio en un web flow, la instancia será visible para el flujo actual y todos sus sub-flujos (conversación)</p>
</li>
<li>
<p><em>session</em>: se creará una instancia nueva del servicio para cada sesión de usuario</p>
</li>
<li>
<p><em>singleton</em>: sólo existe una instancia del servicio</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Por lo tanto, si queremos modificar el ámbito del servicio para que cada sesión de usuario tenga su propia instancia del servicio, debemos declararlos así:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">TodoService</span><span class="tok-o">{</span>
    <span class="tok-kd">static</span> <span class="tok-n">scope</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;session&#39;</span>
    <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_servicios_rest">5.5.2. Servicios REST</h4>
<div class="paragraph">
<p>Ya hemos visto durante las sesiones anteriores que es muy sencillo generar en Grails una aplicación que sepa responder a las distintas peticiones de una aplicación web, bien sea a través de una página web o bien desde una aplicación nativa utilizando REST. Pero, ¿qué es exactamente REST?</p>
</div>
<div class="paragraph">
<p>Los servicios web REST son algo más que devolver datos en formato XML o JSON sino que consiste en una forma de trabajar que en función del método HTTP utilizado en la petición se debe procesar mediante una acción u otra, tal y como se representa en la siguiente tabla.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Método</th>
<th class="tableblock halign-left valign-top">Acción</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">show()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">update()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">POST</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">save()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DELETE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">delete()</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>A partir de esta tabla, sólo necesitaríamos una url para poder realizar todas las operaciones sobre nuestras clases de dominio. Imagina por ejemplo las operaciones de tipo CRUD sobre los usuarios. Con REST, sólo deberíamos tener una posible url que sería <em><a href="http://localhost:8080/todo/todo/id_todo" class="bare">http://localhost:8080/todo/todo/id_todo</a></em>, donde el identificador de la tarea sería optativo.
Veamos en otra tabla como quedarían todas las posibles peticiones para realizar las operaciones del usuario.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33%;">
<col style="width: 33%;">
<col style="width: 33%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">URL</th>
<th class="tableblock halign-left valign-top">Método HTTP</th>
<th class="tableblock halign-left valign-top">Acción</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://localhost:8080/todo/todos" class="bare">http://localhost:8080/todo/todos</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>show()</em>,  debería mostrar un listado de las tareas</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://localhost:8080/todo/todos/4" class="bare">http://localhost:8080/todo/todos/4</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>show()</em>, debería mostrar los datos de la tarea con <em>id = 4</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://localhost:8080/todo/todos/4" class="bare">http://localhost:8080/todo/todos/4</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>update()</em>, debería actualizar los datos de la tarea con <em>id = 4</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://localhost:8080/todo/todos" class="bare">http://localhost:8080/todo/todos</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">POST</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>save()</em>, debería crear una nueva tarea con los datos pasados en el formulario</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://localhost:8080/todo/todos/4" class="bare">http://localhost:8080/todo/todos/4</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DELETE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>delete()</em>, debería eliminar la tarea con <em>id = 4</em></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>En Grails la forma más sencilla de exponer clases de dominio como servicios REST es mediante entradas en el archivo de configuración /conf/UrlMappings.groovy, que veremos más adelante en profundidad.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">UrlMappings</span> <span class="tok-o">{</span>

    <span class="tok-kd">static</span> <span class="tok-n">mappings</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
        <span class="tok-s2">&quot;/$controller/$action?/$id?(.$format)?&quot;</span><span class="tok-o">{</span>
            <span class="tok-n">constraints</span> <span class="tok-o">{</span>
                <span class="tok-c1">// apply constraints here</span>
            <span class="tok-o">}</span>
        <span class="tok-o">}</span>

        <span class="tok-s2">&quot;/api/todos&quot;</span><span class="tok-o">(</span><span class="tok-nl">resources:</span><span class="tok-s2">&quot;todo&quot;</span><span class="tok-o">)</span>
        <span class="tok-s2">&quot;/api/tags&quot;</span><span class="tok-o">(</span><span class="tok-nl">resources:</span><span class="tok-s2">&quot;tag&quot;</span><span class="tok-o">)</span>
        <span class="tok-s2">&quot;/api/categories&quot;</span><span class="tok-o">(</span><span class="tok-nl">resources:</span><span class="tok-s2">&quot;category&quot;</span><span class="tok-o">)</span>

        <span class="tok-s2">&quot;/&quot;</span><span class="tok-o">(</span><span class="tok-nl">view:</span><span class="tok-s2">&quot;/index&quot;</span><span class="tok-o">)</span>
        <span class="tok-s2">&quot;500&quot;</span><span class="tok-o">(</span><span class="tok-nl">view:</span><span class="tok-s1">&#39;/error&#39;</span><span class="tok-o">)</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>De esta forma estaremos exponiendo nuestras clases de dominio como recursos REST que podrán ser accedidos de la siguiente forma:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em><a href="http://localhost:8080/api/todos.json" class="bare">http://localhost:8080/api/todos.json</a></em></p>
</li>
<li>
<p><em><a href="http://localhost:8080/api/tags/1.json" class="bare">http://localhost:8080/api/tags/1.json</a></em></p>
</li>
<li>
<p><em><a href="http://localhost:8080/api/categories/3.json" class="bare">http://localhost:8080/api/categories/3.json</a></em></p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios_5">5.6. Ejercicios</h3>
<div class="sect3">
<h4 id="_construye_tus_propias_restricciones_0_25_puntos">5.6.1. Construye tus propias restricciones (0.25 puntos)</h4>
<div class="paragraph">
<p>En la clase de dominio de las tareas tenemos tanto una fecha para la tarea como una fecha de recuerdo. Vamos a imponer como restricción que la fecha para recordar la tarea deba ser siempre anterior a la fecha de realización de la misma. Crea para ello una restricción que nos permita conseguir esto.</p>
</div>
<div class="paragraph">
<p>Crea también una nueva propiedad en las etiquetas para especificar un color. Este color vendrá en formato RGB, que te recuerdo está especificado por el carácter <em>#</em> seguido de 6 caracteres hexadecimales, como por ejemplo #23FA8F. Define esta restricción globalmente con el nombre <em>rgbcolor</em> para que pueda ser reutilizada en cualquier otra propiedad de nuestra aplicación.</p>
</div>
</div>
<div class="sect3">
<h4 id="_asegurar_los_borrados_de_las_categorías_y_las_tareas_0_25_puntos">5.6.2. Asegurar los borrados de las categorías y las tareas (0.25 puntos)</h4>
<div class="paragraph">
<p>En la aplicación actualmente tenemos un problema que nos impide eliminar categorías por la relación con las tareas y la clave ajena que se genera a nivel de base de datos con lo que antes de proceder al borrado de la categoría, debemos asegurarnos que ésta no esté asignada a ninguna tarea.</p>
</div>
<div class="paragraph">
<p>Crea el servicio <em>CategoryService.groovy</em> y mueve el eliminado que ahora mismo se está realizando en el controlador <em>CategoryController.groovy</em> para que asigne a null todas las tareas de la categoría a eliminar.</p>
</div>
<div class="paragraph">
<p>Soluciona al mismo tiempo el problema existente a la hora de eliminar tareas por la relación existente entre ellas y las etiquetas. Mueve el borrado de las tareas a un método en el servicio adecuado.</p>
</div>
</div>
<div class="sect3">
<h4 id="_consultas_a_base_de_datos_0_25_puntos">5.6.3. Consultas a base de datos (0.25 puntos)</h4>
<div class="paragraph">
<p>Vamos a crear un nuevo informe en nuestra aplicación que nos permita listar todas las tareas ordenadas por fecha y cuya categoría coincida con las pasadas por parámetro. Necesitaremos crear una vista y su correspondiente método (<em>listByCategory()</em>) en el controlador <em>TodoController()</em> para poder seleccionar aquellas categorías de las que queramos listar sus tareas.</p>
</div>
<div class="paragraph">
<p>A continuación, deberás implementar un nuevo método en el controlador <em>TodoController()</em> que devuelva todas las tareas cuya categoría coincidan con aquellas que el usuario haya seleccionado en el paso anterior. En esta vista puedes mostrar todas las categorías junto a un checkbox para que el usuario pueda seleccionar varios al mismo tiempo.</p>
</div>
<div class="paragraph">
<p>Por último, edita los menús de navegación de la aplicación para añadir el nuevo informe que acabamos de generar en todas páginas relativas a las tareas.</p>
</div>
</div>
<div class="sect3">
<h4 id="__cuándo_han_sido_realizadas_las_tareas_0_50_puntos">5.6.4. ¿Cuándo han sido realizadas las tareas? (0.50 puntos)</h4>
<div class="paragraph">
<p>El autotimestamp es una característica de Grails que se suele utilizar para saber cuando se crean y actualizan las instancias de nuestras clases de dominio. En primer lugar vamos a añadir esta característica de Grails a las tareas.</p>
</div>
<div class="paragraph">
<p>A continuación, vamos a crear una nueva propiedad en las tareas que nos permite saber cuando se han realizado las tareas y llama a esta propiedad <em>dateDone</em>. Para rellenar esta propiedad vamos a crear un servicio que se encargue de esta lógica y a su vez, mover el guardado que se está realizando actualmente en el controlador.</p>
</div>
<div class="paragraph">
<p>Para ello añadiremos en el servicio <em>TodoService</em>  un nuevo método llamado <em>saveTodo(Todo todoInstance)</em> de tal forma que cuando la propiedad <em>done</em> sea cierta, completaremos con la fecha actual la nueva propiedad <em>dateDone</em>. Este método deberá ser utilizado tanto cuando se crea como cuando se actualiza una tarea.</p>
</div>
<div class="paragraph">
<p>A continuación, crearemos un nuevo método en el servicio <em>TodoService()</em> llamado <em>lastTodosDone(Integer hours)</em> que nos permitirá pasar como parámetro un número de horas y nos devuelva todas las últimas tareas realizadas en ese intervalo de tiempo, es decir, desde el momento actual hasta hace <em>hours</em> horas.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion06">6. Framework de test Spock.</h2>
<div class="sectionbody">
<div class="paragraph">
<p>En esta sesión veremos en profundidad como comprobar que nuestra aplicación desarrollada en Grails funciona tal y como esperamos y para ello utilizaremos un framework para la realización de tests llamado Spock. Empezaremos viendo conceptos generales tanto de tests como de Spock y terminaremos viendo su aplicación en una aplicación en Grails.</p>
</div>
<div class="sect2">
<h3 id="_introducción_a_los_tests">6.1. Introducción a los tests</h3>
<div class="sect3">
<h4 id="__qué_son_los_tests">6.1.1. ¿Qué son los tests?</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Definición</div>
<div class="paragraph">
<p>Los tests de software se pueden definir como el proceso empleado para comprobar la corrección de un programa informático y se puede considerar como una parte más en el proceso del control de calidad.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_tipos_de_tests_de_software">6.1.2. Tipos de tests de software</h4>
<div class="paragraph">
<p>Básicamente existen tres tipos de tests de software:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Tests unitarios</em>, que consisten en comprobar el funcionamiento de un determinado módulo sin tener en cuenta a los demás. En este tipo de pruebas tampoco se tiene acceso a recursos como bases de datos, sistemas de ficheros o recursos de red.</p>
</li>
<li>
<p><em>Tests de integración</em>, suponen un nivel por encima a los tests unitarios y en ellos se añaden recursos como bases de datos, sistemas de ficheros o recursos de red.</p>
</li>
<li>
<p><em>Tests funcionales</em>, consiste en comprobar que la funcionalidad de nuestra aplicación es la esperada. Básicamente este tipo de pruebas se basan en automatizar las típicas pruebas de rellenar datos en formularios, hacer clicks en botones y analizar la respuesta obtenida.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_otros_frameworks_de_tests">6.1.3. Otros frameworks de tests</h4>
<div class="paragraph">
<p>En Java disponemos de varias alternativas para el desarrollo de los tests, pero básicamente disponemos de dos que son las más conocidas y utilizadas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JUnit (<a href="http://junit.org" class="bare">http://junit.org</a>), posiblemente sea el framework más extendido entre la comunidad Java.</p>
</li>
<li>
<p>TestNG (<a href="http://testng.org" class="bare">http://testng.org</a>), es un framework que permite testear nuestra aplicación con pruebas unitarias, de integración y funcionales.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Sin embargo, en la comunidad Groovy cada vez se está extendiendo más el uso de un framework conocido como Spock (<a href="https://code.google.com/p/spock/" class="bare">https://code.google.com/p/spock/</a>). Spock surgió en el año 2009 y su creador es Peter Niederwieser (<a href="https://twitter.com/pniederw">@pniederw</a>) y sin duda alguna destaca entre el resto de frameworks por la expresividad de su lenguaje y su integración con Groovy y Java. Estas son algunas de las razones por las que vamos a utilizar Spock:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Fácil de aprender</p>
</li>
<li>
<p>Integración con Groovy</p>
</li>
<li>
<p>Eliminación aserciones innecesarias</p>
</li>
<li>
<p>Información detallada en las salidas de los tests</p>
</li>
<li>
<p>Diseñado desde el punto de vista del usuario</p>
</li>
<li>
<p>Independientemente de la teoria que sigas para desarrollar tus tests (TDD, BDD, etc), Spock se adaptará a tus necesidades</p>
</li>
<li>
<p>Lenguaje altamente expresivo</p>
</li>
<li>
<p>Compatible con JUnit</p>
</li>
<li>
<p>Combina lo mejor de otros conocidos frameworks como JUnit o jMock</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_framework_de_tests_spock">6.2. Framework de tests Spock</h3>
<div class="sect3">
<h4 id="_instalación_en_grails">6.2.1. Instalación en Grails</h4>
<div class="paragraph">
<p>Spock en Grails viene como un plugin con lo que únicamente tendremos que añadir el plugin en el archivo de configuración <em>BuildConfig.groovy</em>, tal y como se explica en la página del plugin (<a href="http://grails.org/plugin/spock" class="bare">http://grails.org/plugin/spock</a>) para versiones superiores a Grails 2.2</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">grails</span><span class="tok-o">.</span><span class="tok-na">project</span><span class="tok-o">.</span><span class="tok-na">dependency</span><span class="tok-o">.</span><span class="tok-na">resolution</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
  <span class="tok-n">repositories</span> <span class="tok-o">{</span>
    <span class="tok-n">grailsCentral</span><span class="tok-o">()</span>
    <span class="tok-n">mavenCentral</span><span class="tok-o">()</span>
  <span class="tok-o">}</span>
  <span class="tok-n">dependencies</span> <span class="tok-o">{</span>
    <span class="tok-n">test</span> <span class="tok-s2">&quot;org.spockframework:spock-grails-support:0.7-groovy-2.0&quot;</span>
  <span class="tok-o">}</span>
  <span class="tok-n">plugins</span> <span class="tok-o">{</span>
    <span class="tok-n">test</span><span class="tok-o">(</span><span class="tok-s2">&quot;:spock:0.7&quot;</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-n">exclude</span> <span class="tok-s2">&quot;spock-grails-support&quot;</span>
    <span class="tok-o">}</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para que el plugin sea instalado y el IDE reconozca las nuevas clases, necesitaremos lanzar algún <em>target</em> de Grails, como por ejemplo <em>grails test-app</em>. Una vez instalado el plugin, ya podremos empezar a desarrollar nuestros primeros tests.</p>
</div>
</div>
<div class="sect3">
<h4 id="_tests_en_spock">6.2.2. Tests en Spock</h4>
<div class="paragraph">
<p>Por defecto en Spock, todas las clases que creemos para nuestros tests deben extender la clase <em>spock.lang.Specification</em>, que inyectará una serie de métodos y utilidades en nuestra clase extendida.</p>
</div>
<div class="paragraph">
<p>A diferencia de otros frameworks de tests, Spock presenta una sintaxis muy sencilla de leer que se basa en la utilización de bloques de código. Este sería un ejemplo básico de test con Spock:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">es</span><span class="tok-o">.</span><span class="tok-na">ua</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">todo</span>

<span class="tok-kn">import</span> <span class="tok-nn">spock.lang.Specification</span>

<span class="tok-kd">class</span> <span class="tok-nc">MyFirstTest</span> <span class="tok-kd">extends</span> <span class="tok-n">Specification</span> <span class="tok-o">{</span>

    <span class="tok-kt">def</span> <span class="tok-s2">&quot;El operador suma funciona correctamente&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-nl">expect:</span>
            <span class="tok-mi">10</span> <span class="tok-o">==</span> <span class="tok-mi">2</span> <span class="tok-o">+</span> <span class="tok-mi">8</span>
        <span class="tok-nl">and:</span>
            <span class="tok-mi">10</span> <span class="tok-o">==</span> <span class="tok-mi">0</span> <span class="tok-o">+</span> <span class="tok-mi">10</span>
        <span class="tok-nl">and:</span>
            <span class="tok-mi">10</span> <span class="tok-o">==</span> <span class="tok-mi">10</span> <span class="tok-o">+</span> <span class="tok-mi">0</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Este formato de test en Spock podríamos decir que es el más sencillo de los que podemos encontrar y como puedes observar la sintaxis es muy sencilla de entender. Lo primero que cabe destacar aunque probablemente ya te hayas dado cuenta es el nombre de los métodos que están entrecomillados y podemos llamarlo como queramos y utilizar espacios o caracteres especiales (no ingleses) como acentos.</p>
</div>
<div class="paragraph">
<p>Destacar también que no es necesario utilizar aserciones dentro del bloque <em>expect</em>. Pero veamos otro ejemplo un poco más elaborado y que nos introducirá un nuevo formato de test en Spock.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-s2">&quot;El método plus de los números funciona correctamente&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-nl">when:</span>
        <span class="tok-kt">def</span> <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-mi">10</span><span class="tok-o">.</span><span class="tok-na">plus</span><span class="tok-o">(</span><span class="tok-mi">2</span><span class="tok-o">)</span>
    <span class="tok-nl">then:</span>
        <span class="tok-n">result</span> <span class="tok-o">==</span> <span class="tok-mi">12</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Este formato de spock sea posiblemente el más común en Spock y en él vemos un bloque <em>when</em> y un bloque <em>then</em>. El bloque <em>when</em> se utiliza habitualmente para lanzar el método a probar y en este caso también para almacenar el resultado, mientras que el bloque <em>then</em> se utiliza para comprobar que la respuesta proporcionada por el método es la correcta. De nuevo, en el bloque <em>then</em> no es necesario utilizar aserciones.</p>
</div>
<div class="paragraph">
<p>Pero, ¿qué pasa si queremos probar varios casos en la misma sentencia? Para este caso, Spock introduce el bloque <em>where</em> en donde con una sintaxis muy sencilla de entender en forma de tabla, vamos a poder comprobar varios al mismo tiempo. Veamos el anterior ejemplo mejorado:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-nd">@Unroll</span>
<span class="tok-kt">def</span> <span class="tok-s2">&quot;El método plus funciona con el sumador #sumador y el sumando #sumando&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-nl">when:</span>
        <span class="tok-kt">def</span> <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-n">sumador</span><span class="tok-o">.</span><span class="tok-na">plus</span><span class="tok-o">(</span><span class="tok-n">sumando</span><span class="tok-o">)</span>
    <span class="tok-nl">then:</span>
        <span class="tok-n">result</span> <span class="tok-o">==</span> <span class="tok-n">resultadoEsperado</span>
    <span class="tok-nl">where:</span>
        <span class="tok-n">sumador</span> <span class="tok-o">|</span>   <span class="tok-n">sumando</span>     <span class="tok-o">|</span>   <span class="tok-n">resultadoEsperado</span>
        <span class="tok-mi">0</span>       <span class="tok-o">|</span>   <span class="tok-mi">0</span>           <span class="tok-o">|</span>   <span class="tok-mi">0</span>
        <span class="tok-mi">0</span>       <span class="tok-o">|</span>   <span class="tok-mi">1</span>           <span class="tok-o">|</span>   <span class="tok-mi">1</span>
        <span class="tok-mi">1</span>       <span class="tok-o">|</span>   <span class="tok-mi">1</span>           <span class="tok-o">|</span>   <span class="tok-mi">2</span>
        <span class="tok-o">-</span><span class="tok-mi">1</span>      <span class="tok-o">|</span>   <span class="tok-mi">0</span>           <span class="tok-o">|</span>   <span class="tok-o">-</span><span class="tok-mi">1</span>
        <span class="tok-mi">0</span>       <span class="tok-o">|</span>   <span class="tok-o">-</span><span class="tok-mi">1</span>          <span class="tok-o">|</span>   <span class="tok-o">-</span><span class="tok-mi">1</span>
        <span class="tok-o">-</span><span class="tok-mi">1</span>      <span class="tok-o">|</span>   <span class="tok-o">-</span><span class="tok-mi">1</span>          <span class="tok-o">|</span>   <span class="tok-o">-</span><span class="tok-mi">2</span>
        <span class="tok-mi">2</span>       <span class="tok-o">|</span>   <span class="tok-mi">1</span>           <span class="tok-o">|</span>   <span class="tok-mi">3</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En este ejemplo vemos la forma en la que Spock crea variables dentro del bloque <em>where</em> sin definir su tipo o ni tan siquiera con la palabra reservada <em>def</em>. De esta forma, en un único test hemos podido comprobar el método <em>plus()</em> con varios valores en una única sentencia.</p>
</div>
<div class="paragraph">
<p>Por otro lado, vemos también como el nombre del test introduce los valores de las variables definidas dentro del bloque where de tal forma que cuando ejecutemos este test, si alguno falla veremos rápidamente que caso es el problemático.</p>
</div>
<div class="paragraph">
<p>Además, la anotación <em>@Unroll</em> nos permite que cada uno de los casos en el bloque where se despliegue como un nuevo test, lo cual de nuevo, facilita la detección rápida de los errores. Esta sería la salida producida en nuestro editor sin la anotación <em>@Unroll</em>:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/grails06/resultadotestsconbloquewheresinunroll.png" alt="Resultado de los tests sin la anotación @Unroll" width="50%">
</div>
</div>
<div class="paragraph">
<p>y esta es la producida con la anotación <em>@Unroll</em>:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/grails06/resultadotestsconbloquewhereconunroll.png" alt="Resultado de los tests con la anotación @Unroll" width="50%">
</div>
</div>
<div class="paragraph">
<p>Como puedes observar, la anotación <em>@Unroll</em> nos proporciona más información del resultado de los tests.</p>
</div>
<div class="paragraph">
<p>El siguiente ejemplo es idéntico al anterior pero en lugar de utilizar una tabla utilizamos listas con valores:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-nd">@Unroll</span>
<span class="tok-kt">def</span> <span class="tok-s2">&quot;El método plus funciona con el sumador #sumador y el sumando #sumando utilizando listas&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-nl">when:</span>
        <span class="tok-kt">def</span> <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-n">sumador</span><span class="tok-o">.</span><span class="tok-na">plus</span><span class="tok-o">(</span><span class="tok-n">sumando</span><span class="tok-o">)</span>
    <span class="tok-nl">then:</span>
        <span class="tok-n">result</span> <span class="tok-o">==</span> <span class="tok-n">resultadoEsperado</span>
    <span class="tok-nl">where:</span>
        <span class="tok-n">sumador</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-o">[</span><span class="tok-mi">0</span><span class="tok-o">,</span><span class="tok-mi">0</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,-</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">0</span><span class="tok-o">,-</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">]</span>
        <span class="tok-n">sumando</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-o">[</span><span class="tok-mi">0</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">0</span><span class="tok-o">,-</span><span class="tok-mi">1</span><span class="tok-o">,-</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">]</span>
        <span class="tok-n">resultadoEsperado</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-o">[</span><span class="tok-mi">0</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,-</span><span class="tok-mi">1</span><span class="tok-o">,-</span><span class="tok-mi">1</span><span class="tok-o">,-</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El último bloque de un test Spock que nos queda por ver es el primero de todos, el bloque <em>given</em>, que nos servirá para realizar todo lo necesario antes de ejecutar el método a testear. Este podría ser un ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-s2">&quot;El método para concatenar cadenas añade un signo + entre las cadenas concatenadas&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-nl">given:</span>
        <span class="tok-n">String</span><span class="tok-o">.</span><span class="tok-na">metaClass</span><span class="tok-o">.</span><span class="tok-na">concat</span> <span class="tok-o">=</span> <span class="tok-o">{</span> <span class="tok-n">String</span> <span class="tok-n">c</span> <span class="tok-o">-&gt;</span>
            <span class="tok-s2">&quot;${delegate}+${c}&quot;</span>
        <span class="tok-o">}</span>
    <span class="tok-nl">expect:</span>
        <span class="tok-s2">&quot;cadena1&quot;</span><span class="tok-o">.</span><span class="tok-na">concat</span><span class="tok-o">(</span><span class="tok-s2">&quot;cadena2&quot;</span><span class="tok-o">)</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;cadena1+cadena2&quot;</span>
    <span class="tok-nl">cleanup:</span>
        <span class="tok-n">String</span><span class="tok-o">.</span><span class="tok-na">metaClass</span> <span class="tok-o">=</span> <span class="tok-kc">null</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y como siempre, no olvides devolver la clase metaprogramada con <em>String.metaClass = null</em>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_spock_en_grails">6.3. Spock en Grails</h3>
<div class="paragraph">
<p>Una vez hemos visto los primeros ejemplos de tests con Spock en Groovy, vamos a ver ejemplos de como testear los diferentes artefactos en las aplicaciones desarrolladas con Grails. Pero antes de continuar, hay que comentar que en Spock disponemos de unos métodos que se ejecutan antes y después de cada tests o de cada clase Spock. Estos métodos son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>setupSpec()</em>: se ejecuta <strong>antes del primer test</strong> de una determinada clase de tests con Spock</p>
</li>
<li>
<p><em>cleanupSpec()</em>: se ejecuta <strong>después del último test</strong> de una determinada clase de tests con Spock</p>
</li>
<li>
<p><em>setup()</em>: se ejecuta <strong>antes de cada test</strong> de una determinada clase de tests con Spock</p>
</li>
<li>
<p><em>setupSpec()</em>: se ejecuta <strong>después de cada test</strong> de una determinada clase de tests con Spock</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_tests_con_spock_sobre_clases_de_dominio_en_grails">6.3.1. Tests con Spock sobre clases de dominio en Grails</h4>
<div class="paragraph">
<p>Empecemos pues con los tests sobre los artefactos de una aplicación Grails y lo haremos sobre las clases de dominio y más concretamente sobre las restricciones.</p>
</div>
<div class="paragraph">
<p>Partiendo de nuestra clase de dominio <em>Category</em>,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">es</span><span class="tok-o">.</span><span class="tok-na">ua</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">todo</span>

<span class="tok-kd">class</span> <span class="tok-nc">Category</span> <span class="tok-o">{</span>

    <span class="tok-n">String</span> <span class="tok-n">name</span>
    <span class="tok-n">String</span> <span class="tok-n">description</span>

    <span class="tok-kd">static</span> <span class="tok-n">hasMany</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-nl">todos:</span><span class="tok-n">Todo</span><span class="tok-o">]</span>

    <span class="tok-kd">static</span> <span class="tok-n">constraints</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
        <span class="tok-n">name</span><span class="tok-o">(</span><span class="tok-nl">blank:</span><span class="tok-kc">false</span><span class="tok-o">)</span>
        <span class="tok-n">description</span><span class="tok-o">(</span><span class="tok-nl">blank:</span><span class="tok-kc">true</span><span class="tok-o">,</span> <span class="tok-nl">nullable:</span><span class="tok-kc">true</span><span class="tok-o">,</span> <span class="tok-nl">maxSize:</span><span class="tok-mi">1000</span><span class="tok-o">)</span>
    <span class="tok-o">}</span>

    <span class="tok-n">String</span> <span class="tok-nf">toString</span><span class="tok-o">(){</span>
        <span class="tok-n">name</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Vamos a comprobar que las restricciones impuestas sobre las propiedades <em>name</em> y <em>description</em> se cumplen. Para ello, vamos a reutilizar un test unitario creado cuando generábamos las clases de dominio llamado <em>CategorySpec.groovy</em> dentro del paquete <em>es.ua.expertojava.todo</em>.</p>
</div>
<div class="paragraph">
<p>Lo ideal es que cada test unitario compruebe únicamente un aspecto, así que vamos a seguir este consejo y crearemos los siguientes tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">es</span><span class="tok-o">.</span><span class="tok-na">ua</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">todo</span>

<span class="tok-kn">import</span> <span class="tok-nn">grails.test.mixin.TestFor</span>
<span class="tok-kn">import</span> <span class="tok-nn">spock.lang.Specification</span>
<span class="tok-kn">import</span> <span class="tok-nn">spock.lang.Unroll</span>

<span class="tok-cm">/**</span>
<span class="tok-cm"> * See the API for {@link grails.test.mixin.domain.DomainClassUnitTestMixin} for usage instructions</span>
<span class="tok-cm"> */</span>
<span class="tok-nd">@TestFor</span><span class="tok-o">(</span><span class="tok-n">Category</span><span class="tok-o">)</span>
<span class="tok-kd">class</span> <span class="tok-nc">CategorySpec</span> <span class="tok-kd">extends</span> <span class="tok-n">Specification</span> <span class="tok-o">{</span>

    <span class="tok-kt">def</span> <span class="tok-nf">setup</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-o">}</span>

    <span class="tok-kt">def</span> <span class="tok-nf">cleanup</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-o">}</span>

    <span class="tok-kt">def</span> <span class="tok-s2">&quot;El nombre de la categoría no puede ser la cadena vacía&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-nl">given:</span>
            <span class="tok-kt">def</span> <span class="tok-n">c1</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Category</span><span class="tok-o">(</span><span class="tok-nl">name:</span><span class="tok-s2">&quot;&quot;</span><span class="tok-o">)</span>
        <span class="tok-nl">when:</span>
            <span class="tok-n">c1</span><span class="tok-o">.</span><span class="tok-na">validate</span><span class="tok-o">()</span>
        <span class="tok-nl">then:</span>
            <span class="tok-n">c1</span><span class="tok-o">?.</span><span class="tok-na">errors</span><span class="tok-o">[</span><span class="tok-s1">&#39;name&#39;</span><span class="tok-o">]</span>
    <span class="tok-o">}</span>

    <span class="tok-kt">def</span> <span class="tok-s2">&quot;Si el nombre no es la cadena vacía, este campo no dará problemas&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-nl">given:</span>
            <span class="tok-kt">def</span> <span class="tok-n">c1</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Category</span><span class="tok-o">(</span><span class="tok-nl">name:</span><span class="tok-s2">&quot;algo&quot;</span><span class="tok-o">)</span>
        <span class="tok-nl">when:</span>
            <span class="tok-n">c1</span><span class="tok-o">.</span><span class="tok-na">validate</span><span class="tok-o">()</span>
        <span class="tok-nl">then:</span>
            <span class="tok-o">!</span><span class="tok-n">c1</span><span class="tok-o">?.</span><span class="tok-na">errors</span><span class="tok-o">[</span><span class="tok-s1">&#39;name&#39;</span><span class="tok-o">]</span>
    <span class="tok-o">}</span>

    <span class="tok-kt">def</span> <span class="tok-s2">&quot;La descripción de la categoría puede ser la cadena vacía&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-nl">given:</span>
            <span class="tok-kt">def</span> <span class="tok-n">c1</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Category</span><span class="tok-o">(</span><span class="tok-nl">description:</span> <span class="tok-s2">&quot;&quot;</span><span class="tok-o">)</span>
        <span class="tok-nl">when:</span>
            <span class="tok-n">c1</span><span class="tok-o">.</span><span class="tok-na">validate</span><span class="tok-o">()</span>
        <span class="tok-nl">then:</span>
            <span class="tok-o">!</span><span class="tok-n">c1</span><span class="tok-o">?.</span><span class="tok-na">errors</span><span class="tok-o">[</span><span class="tok-s1">&#39;description&#39;</span><span class="tok-o">]</span>
    <span class="tok-o">}</span>

    <span class="tok-kt">def</span> <span class="tok-s2">&quot;Si la descripción es la cadena vacía, este campo no dará problemas&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-nl">given:</span>
            <span class="tok-kt">def</span> <span class="tok-n">c1</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Category</span><span class="tok-o">(</span><span class="tok-nl">description:</span><span class="tok-s2">&quot;&quot;</span><span class="tok-o">)</span>
        <span class="tok-nl">when:</span>
            <span class="tok-n">c1</span><span class="tok-o">.</span><span class="tok-na">validate</span><span class="tok-o">()</span>
        <span class="tok-nl">then:</span>
            <span class="tok-o">!</span><span class="tok-n">c1</span><span class="tok-o">?.</span><span class="tok-na">errors</span><span class="tok-o">[</span><span class="tok-s1">&#39;description&#39;</span><span class="tok-o">]</span>
    <span class="tok-o">}</span>

    <span class="tok-kt">def</span> <span class="tok-s2">&quot;La descripción de la categoría puede ser null&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-nl">given:</span>
            <span class="tok-kt">def</span> <span class="tok-n">c1</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Category</span><span class="tok-o">(</span><span class="tok-nl">description:</span> <span class="tok-kc">null</span><span class="tok-o">)</span>
        <span class="tok-nl">when:</span>
            <span class="tok-n">c1</span><span class="tok-o">.</span><span class="tok-na">validate</span><span class="tok-o">()</span>
        <span class="tok-nl">then:</span>
            <span class="tok-o">!</span><span class="tok-n">c1</span><span class="tok-o">?.</span><span class="tok-na">errors</span><span class="tok-o">[</span><span class="tok-s1">&#39;description&#39;</span><span class="tok-o">]</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Unroll</span>
    <span class="tok-kt">def</span> <span class="tok-s2">&quot;Si la descripción tiene menos de 1001 caracteres, no dará problemas&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-nl">given:</span>
            <span class="tok-kt">def</span> <span class="tok-n">c1</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Category</span><span class="tok-o">(</span><span class="tok-nl">description:</span> <span class="tok-s2">&quot;a&quot;</span><span class="tok-o">*</span><span class="tok-n">characters</span><span class="tok-o">)</span>
        <span class="tok-nl">when:</span>
            <span class="tok-n">c1</span><span class="tok-o">.</span><span class="tok-na">validate</span><span class="tok-o">()</span>
        <span class="tok-nl">then:</span>
            <span class="tok-o">!</span><span class="tok-n">c1</span><span class="tok-o">?.</span><span class="tok-na">errors</span><span class="tok-o">[</span><span class="tok-s1">&#39;description&#39;</span><span class="tok-o">]</span>
        <span class="tok-nl">where:</span>
            <span class="tok-n">characters</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-o">[</span><span class="tok-mi">0</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">999</span><span class="tok-o">,</span><span class="tok-mi">1000</span><span class="tok-o">]</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Unroll</span>
    <span class="tok-kt">def</span> <span class="tok-s2">&quot;Si la descripción tiene más 1000 caracteres, dará problemas&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-nl">given:</span>
            <span class="tok-kt">def</span> <span class="tok-n">c1</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Category</span><span class="tok-o">(</span><span class="tok-nl">description:</span> <span class="tok-s2">&quot;a&quot;</span><span class="tok-o">*</span><span class="tok-n">characters</span><span class="tok-o">)</span>
        <span class="tok-nl">when:</span>
            <span class="tok-n">c1</span><span class="tok-o">.</span><span class="tok-na">validate</span><span class="tok-o">()</span>
        <span class="tok-nl">then:</span>
            <span class="tok-n">c1</span><span class="tok-o">?.</span><span class="tok-na">errors</span><span class="tok-o">[</span><span class="tok-s1">&#39;description&#39;</span><span class="tok-o">]</span>
        <span class="tok-nl">where:</span>
            <span class="tok-n">characters</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-o">[</span><span class="tok-mi">1001</span><span class="tok-o">,</span><span class="tok-mi">1002</span><span class="tok-o">]</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Con esta batería de tests nos aseguraremos de que las instancias creadas para la clase de dominio Categoría cumplen los requisitos definidos en las restricciones. De igual forma, vamos a realizar un último test para comprobar que cuando se crea una instancia de Categoría correctamente, el valor devuelto por ésta coincide con la sobrecarga del método <em>toString()</em> que hayamos hecho en la clase de dominio.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">...</span>
    <span class="tok-kt">def</span> <span class="tok-s2">&quot;La instancia de Categoría devuelve su nombre por defecto&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-nl">expect:</span>
            <span class="tok-k">new</span> <span class="tok-nf">Category</span><span class="tok-o">(</span><span class="tok-nl">name:</span><span class="tok-s2">&quot;The category name&quot;</span><span class="tok-o">).</span><span class="tok-na">toString</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;The category name&quot;</span>
    <span class="tok-o">}</span>
<span class="tok-o">...</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_tests_con_spock_sobre_controladores_en_grails">6.3.2. Tests con Spock sobre controladores en Grails</h4>
<div class="paragraph">
<p>Una vez hemos visto como podemos testear nuestras clases de dominio, vamos a ver como podemos hacer lo mismo con los controladores y para ello vamos a basarnos en el código generado para el controlador <em>CategoryController.groovy</em>. Cuando creábamos este controlador, al mismo tiempo se creaba un test <em>CategoryControllerSpec.groovy</em> con código también generado, pero que nosotros necesitaremos completar, en este caso, con la información necesaria procedente de la clase de dominio <em>Category</em>.</p>
</div>
<div class="paragraph">
<p>Si abrimos el archivo <em>CategoryControllerSpec.groovy</em> con nuestro editor veremos como en la parte superior hay definido un método con un comentario de tipo <em>TODO</em> para avisarnos de que hay algo que debemos completar, que básicamente será la información necesaria para crear una instancia de tipo <em>Tag</em> de forma correcta.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">es</span><span class="tok-o">.</span><span class="tok-na">ua</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">todo</span>

<span class="tok-kn">import</span> <span class="tok-nn">grails.test.mixin.*</span>
<span class="tok-kn">import</span> <span class="tok-nn">spock.lang.*</span>

<span class="tok-nd">@TestFor</span><span class="tok-o">(</span><span class="tok-n">CategoryController</span><span class="tok-o">)</span>
<span class="tok-nd">@Mock</span><span class="tok-o">(</span><span class="tok-n">Category</span><span class="tok-o">)</span>
<span class="tok-kd">class</span> <span class="tok-nc">CategoryControllerSpec</span> <span class="tok-kd">extends</span> <span class="tok-n">Specification</span> <span class="tok-o">{</span>

    <span class="tok-kt">def</span> <span class="tok-nf">populateValidParams</span><span class="tok-o">(</span><span class="tok-n">params</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">assert</span> <span class="tok-n">params</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span>
        <span class="tok-c1">// TODO: Populate valid properties like...</span>
        <span class="tok-c1">//params[&quot;name&quot;] = &#39;someValidName&#39;</span>
    <span class="tok-o">}</span>
<span class="tok-o">...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En nuestro caso, sólo será necesario añadir la información referente al nombre, para que los tests se ejecuten de forma satisfactoria, con lo que podríamos tener algo así:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-nf">populateValidParams</span><span class="tok-o">(</span><span class="tok-n">params</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-k">assert</span> <span class="tok-n">params</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span>
    <span class="tok-n">params</span><span class="tok-o">[</span><span class="tok-s2">&quot;name&quot;</span><span class="tok-o">]</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;Category name&#39;</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si ahora ejecutamos en línea de comandos</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">grails <span class="tok-nb">test</span>-app CategoryControllerSpec unit:</code></pre>
</div>
</div>
<div class="paragraph">
<p>comprobaremos como todos los tests se han ejecutado correctamente. Veamos como quedaría el código del test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">es</span><span class="tok-o">.</span><span class="tok-na">ua</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">todo</span>

<span class="tok-kn">import</span> <span class="tok-nn">grails.test.mixin.*</span>
<span class="tok-kn">import</span> <span class="tok-nn">spock.lang.*</span>

<span class="tok-nd">@TestFor</span><span class="tok-o">(</span><span class="tok-n">CategoryController</span><span class="tok-o">)</span>
<span class="tok-nd">@Mock</span><span class="tok-o">(</span><span class="tok-n">Category</span><span class="tok-o">)</span>
<span class="tok-kd">class</span> <span class="tok-nc">CategoryControllerSpec</span> <span class="tok-kd">extends</span> <span class="tok-n">Specification</span> <span class="tok-o">{</span>

    <span class="tok-kt">def</span> <span class="tok-nf">populateValidParams</span><span class="tok-o">(</span><span class="tok-n">params</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">assert</span> <span class="tok-n">params</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span>
        <span class="tok-n">params</span><span class="tok-o">[</span><span class="tok-s2">&quot;name&quot;</span><span class="tok-o">]</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;Category name&#39;</span>
    <span class="tok-o">}</span>

    <span class="tok-kt">void</span> <span class="tok-s2">&quot;Test the index action returns the correct model&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span>

        <span class="tok-nl">when:</span><span class="tok-s2">&quot;The index action is executed&quot;</span>
            <span class="tok-n">controller</span><span class="tok-o">.</span><span class="tok-na">index</span><span class="tok-o">()</span>

        <span class="tok-nl">then:</span><span class="tok-s2">&quot;The model is correct&quot;</span>
            <span class="tok-o">!</span><span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-na">categoryInstanceList</span>
            <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-na">categoryInstanceCount</span> <span class="tok-o">==</span> <span class="tok-mi">0</span>
    <span class="tok-o">}</span>

    <span class="tok-kt">void</span> <span class="tok-s2">&quot;Test the create action returns the correct model&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-nl">when:</span><span class="tok-s2">&quot;The create action is executed&quot;</span>
            <span class="tok-n">controller</span><span class="tok-o">.</span><span class="tok-na">create</span><span class="tok-o">()</span>

        <span class="tok-nl">then:</span><span class="tok-s2">&quot;The model is correctly created&quot;</span>
            <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-na">categoryInstance</span><span class="tok-o">!=</span> <span class="tok-kc">null</span>
    <span class="tok-o">}</span>

    <span class="tok-kt">void</span> <span class="tok-s2">&quot;Test the save action correctly persists an instance&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span>

        <span class="tok-nl">when:</span><span class="tok-s2">&quot;The save action is executed with an invalid instance&quot;</span>
            <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">contentType</span> <span class="tok-o">=</span> <span class="tok-n">FORM_CONTENT_TYPE</span>
            <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">method</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;POST&#39;</span>
            <span class="tok-kt">def</span> <span class="tok-n">category</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Category</span><span class="tok-o">()</span>
            <span class="tok-n">category</span><span class="tok-o">.</span><span class="tok-na">validate</span><span class="tok-o">()</span>
            <span class="tok-n">controller</span><span class="tok-o">.</span><span class="tok-na">save</span><span class="tok-o">(</span><span class="tok-n">category</span><span class="tok-o">)</span>

        <span class="tok-nl">then:</span><span class="tok-s2">&quot;The create view is rendered again with the correct model&quot;</span>
            <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-na">categoryInstance</span><span class="tok-o">!=</span> <span class="tok-kc">null</span>
            <span class="tok-n">view</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;create&#39;</span>

        <span class="tok-nl">when:</span><span class="tok-s2">&quot;The save action is executed with a valid instance&quot;</span>
            <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">reset</span><span class="tok-o">()</span>
            <span class="tok-n">populateValidParams</span><span class="tok-o">(</span><span class="tok-n">params</span><span class="tok-o">)</span>
            <span class="tok-n">category</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Category</span><span class="tok-o">(</span><span class="tok-n">params</span><span class="tok-o">)</span>

            <span class="tok-n">controller</span><span class="tok-o">.</span><span class="tok-na">save</span><span class="tok-o">(</span><span class="tok-n">category</span><span class="tok-o">)</span>

        <span class="tok-nl">then:</span><span class="tok-s2">&quot;A redirect is issued to the show action&quot;</span>
            <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">redirectedUrl</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;/category/show/1&#39;</span>
            <span class="tok-n">controller</span><span class="tok-o">.</span><span class="tok-na">flash</span><span class="tok-o">.</span><span class="tok-na">message</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span>
            <span class="tok-n">Category</span><span class="tok-o">.</span><span class="tok-na">count</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-mi">1</span>
    <span class="tok-o">}</span>

    <span class="tok-kt">void</span> <span class="tok-s2">&quot;Test that the show action returns the correct model&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-nl">when:</span><span class="tok-s2">&quot;The show action is executed with a null domain&quot;</span>
            <span class="tok-n">controller</span><span class="tok-o">.</span><span class="tok-na">show</span><span class="tok-o">(</span><span class="tok-kc">null</span><span class="tok-o">)</span>

        <span class="tok-nl">then:</span><span class="tok-s2">&quot;A 404 error is returned&quot;</span>
            <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">status</span> <span class="tok-o">==</span> <span class="tok-mi">404</span>

        <span class="tok-nl">when:</span><span class="tok-s2">&quot;A domain instance is passed to the show action&quot;</span>
            <span class="tok-n">populateValidParams</span><span class="tok-o">(</span><span class="tok-n">params</span><span class="tok-o">)</span>
            <span class="tok-kt">def</span> <span class="tok-n">category</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Category</span><span class="tok-o">(</span><span class="tok-n">params</span><span class="tok-o">)</span>
            <span class="tok-n">controller</span><span class="tok-o">.</span><span class="tok-na">show</span><span class="tok-o">(</span><span class="tok-n">category</span><span class="tok-o">)</span>

        <span class="tok-nl">then:</span><span class="tok-s2">&quot;A model is populated containing the domain instance&quot;</span>
            <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-na">categoryInstance</span> <span class="tok-o">==</span> <span class="tok-n">category</span>
    <span class="tok-o">}</span>

    <span class="tok-kt">void</span> <span class="tok-s2">&quot;Test that the edit action returns the correct model&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-nl">when:</span><span class="tok-s2">&quot;The edit action is executed with a null domain&quot;</span>
            <span class="tok-n">controller</span><span class="tok-o">.</span><span class="tok-na">edit</span><span class="tok-o">(</span><span class="tok-kc">null</span><span class="tok-o">)</span>

        <span class="tok-nl">then:</span><span class="tok-s2">&quot;A 404 error is returned&quot;</span>
            <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">status</span> <span class="tok-o">==</span> <span class="tok-mi">404</span>

        <span class="tok-nl">when:</span><span class="tok-s2">&quot;A domain instance is passed to the edit action&quot;</span>
            <span class="tok-n">populateValidParams</span><span class="tok-o">(</span><span class="tok-n">params</span><span class="tok-o">)</span>
            <span class="tok-kt">def</span> <span class="tok-n">category</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Category</span><span class="tok-o">(</span><span class="tok-n">params</span><span class="tok-o">)</span>
            <span class="tok-n">controller</span><span class="tok-o">.</span><span class="tok-na">edit</span><span class="tok-o">(</span><span class="tok-n">category</span><span class="tok-o">)</span>

        <span class="tok-nl">then:</span><span class="tok-s2">&quot;A model is populated containing the domain instance&quot;</span>
            <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-na">categoryInstance</span> <span class="tok-o">==</span> <span class="tok-n">category</span>
    <span class="tok-o">}</span>

    <span class="tok-kt">void</span> <span class="tok-s2">&quot;Test the update action performs an update on a valid domain instance&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-nl">when:</span><span class="tok-s2">&quot;Update is called for a domain instance that doesn&#39;t exist&quot;</span>
            <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">contentType</span> <span class="tok-o">=</span> <span class="tok-n">FORM_CONTENT_TYPE</span>
            <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">method</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;PUT&#39;</span>
            <span class="tok-n">controller</span><span class="tok-o">.</span><span class="tok-na">update</span><span class="tok-o">(</span><span class="tok-kc">null</span><span class="tok-o">)</span>

        <span class="tok-nl">then:</span><span class="tok-s2">&quot;A 404 error is returned&quot;</span>
            <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">redirectedUrl</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;/category/index&#39;</span>
            <span class="tok-n">flash</span><span class="tok-o">.</span><span class="tok-na">message</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span>


        <span class="tok-nl">when:</span><span class="tok-s2">&quot;An invalid domain instance is passed to the update action&quot;</span>
            <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">reset</span><span class="tok-o">()</span>
            <span class="tok-kt">def</span> <span class="tok-n">category</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Category</span><span class="tok-o">()</span>
            <span class="tok-n">category</span><span class="tok-o">.</span><span class="tok-na">validate</span><span class="tok-o">()</span>
            <span class="tok-n">controller</span><span class="tok-o">.</span><span class="tok-na">update</span><span class="tok-o">(</span><span class="tok-n">category</span><span class="tok-o">)</span>

        <span class="tok-nl">then:</span><span class="tok-s2">&quot;The edit view is rendered again with the invalid instance&quot;</span>
            <span class="tok-n">view</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;edit&#39;</span>
            <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-na">categoryInstance</span> <span class="tok-o">==</span> <span class="tok-n">category</span>

        <span class="tok-nl">when:</span><span class="tok-s2">&quot;A valid domain instance is passed to the update action&quot;</span>
            <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">reset</span><span class="tok-o">()</span>
            <span class="tok-n">populateValidParams</span><span class="tok-o">(</span><span class="tok-n">params</span><span class="tok-o">)</span>
            <span class="tok-n">category</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Category</span><span class="tok-o">(</span><span class="tok-n">params</span><span class="tok-o">).</span><span class="tok-na">save</span><span class="tok-o">(</span><span class="tok-nl">flush:</span> <span class="tok-kc">true</span><span class="tok-o">)</span>
            <span class="tok-n">controller</span><span class="tok-o">.</span><span class="tok-na">update</span><span class="tok-o">(</span><span class="tok-n">category</span><span class="tok-o">)</span>

        <span class="tok-nl">then:</span><span class="tok-s2">&quot;A redirect is issues to the show action&quot;</span>
            <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">redirectedUrl</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;/category/show/$category.id&quot;</span>
            <span class="tok-n">flash</span><span class="tok-o">.</span><span class="tok-na">message</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span>
    <span class="tok-o">}</span>

    <span class="tok-kt">void</span> <span class="tok-s2">&quot;Test that the delete action deletes an instance if it exists&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-nl">when:</span><span class="tok-s2">&quot;The delete action is called for a null instance&quot;</span>
            <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">contentType</span> <span class="tok-o">=</span> <span class="tok-n">FORM_CONTENT_TYPE</span>
            <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">method</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;DELETE&#39;</span>
            <span class="tok-n">controller</span><span class="tok-o">.</span><span class="tok-na">delete</span><span class="tok-o">(</span><span class="tok-kc">null</span><span class="tok-o">)</span>

        <span class="tok-nl">then:</span><span class="tok-s2">&quot;A 404 is returned&quot;</span>
            <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">redirectedUrl</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;/category/index&#39;</span>
            <span class="tok-n">flash</span><span class="tok-o">.</span><span class="tok-na">message</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span>

        <span class="tok-nl">when:</span><span class="tok-s2">&quot;A domain instance is created&quot;</span>
            <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">reset</span><span class="tok-o">()</span>
            <span class="tok-n">populateValidParams</span><span class="tok-o">(</span><span class="tok-n">params</span><span class="tok-o">)</span>
            <span class="tok-kt">def</span> <span class="tok-n">category</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Category</span><span class="tok-o">(</span><span class="tok-n">params</span><span class="tok-o">).</span><span class="tok-na">save</span><span class="tok-o">(</span><span class="tok-nl">flush:</span> <span class="tok-kc">true</span><span class="tok-o">)</span>

        <span class="tok-nl">then:</span><span class="tok-s2">&quot;It exists&quot;</span>
            <span class="tok-n">Category</span><span class="tok-o">.</span><span class="tok-na">count</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-mi">1</span>

        <span class="tok-nl">when:</span><span class="tok-s2">&quot;The domain instance is passed to the delete action&quot;</span>
            <span class="tok-n">controller</span><span class="tok-o">.</span><span class="tok-na">delete</span><span class="tok-o">(</span><span class="tok-n">category</span><span class="tok-o">)</span>

        <span class="tok-nl">then:</span><span class="tok-s2">&quot;The instance is deleted&quot;</span>
            <span class="tok-n">Category</span><span class="tok-o">.</span><span class="tok-na">count</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-mi">0</span>
            <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">redirectedUrl</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;/category/index&#39;</span>
            <span class="tok-n">flash</span><span class="tok-o">.</span><span class="tok-na">message</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>¿Qué podemos extraer de estos tests generados?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Una serie de variables han sido automáticamente inyectadas en nuestro test como son <em>controller</em>, <em>model</em>, <em>view</em>, <em>response</em>, <em>request</em> y <em>flash</em>.</p>
</li>
<li>
<p>Se utiliza la anotación <em>@Mock()</em> para mockear el comportamiento de la clase de dominio pasada por parámetro. De esta forma se simula su almacenamiento.</p>
</li>
<li>
<p>Para invocar un método cualquiera del controlador simplemente debemos ejecutar <em>controller.method()</em></p>
</li>
<li>
<p>La variable <em>model</em> nos permitirá comprobar si el modelo que devolvemos es el esperado</p>
</li>
<li>
<p>Las redirecciones se pueden comprobar con la variable <em>response.redirectedUrl</em></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_tests_con_spock_sobre_librerías_de_etiquetas_vistas_y_plantillas_en_grails">6.3.3. Tests con Spock sobre librerías de etiquetas, vistas y plantillas en Grails</h4>
<div class="paragraph">
<p>Como siempre, cuando creábamos la librería de etiquetas <em>TodoTagLib.groovy</em>, se creaba automáticamente un esqueleto de test unitario:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">es</span><span class="tok-o">.</span><span class="tok-na">ua</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">todo</span>

<span class="tok-kn">import</span> <span class="tok-nn">grails.test.mixin.TestFor</span>
<span class="tok-kn">import</span> <span class="tok-nn">spock.lang.Specification</span>

<span class="tok-cm">/**</span>
<span class="tok-cm"> * See the API for {@link grails.test.mixin.web.GroovyPageUnitTestMixin} for usage instructions</span>
<span class="tok-cm"> */</span>
<span class="tok-nd">@TestFor</span><span class="tok-o">(</span><span class="tok-n">TodoTagLib</span><span class="tok-o">)</span>
<span class="tok-kd">class</span> <span class="tok-nc">TodoTagLibSpec</span> <span class="tok-kd">extends</span> <span class="tok-n">Specification</span> <span class="tok-o">{</span>

    <span class="tok-kt">def</span> <span class="tok-nf">setup</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-o">}</span>

    <span class="tok-kt">def</span> <span class="tok-nf">cleanup</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-o">}</span>

    <span class="tok-kt">void</span> <span class="tok-s2">&quot;test something&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Mediante la anotación <em>@TestFor(TodoTagLib)</em> la variable <em>tagLib</em> se inyecta automáticamente en nuestros tests. Si hacemos memoria, cuando hablábamos de las librerías de etiquetas poníamos como ejemplo</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">includeJs</span> <span class="tok-o">=</span> <span class="tok-o">{</span><span class="tok-n">attrs</span> <span class="tok-o">-&gt;</span>
    <span class="tok-n">out</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-s2">&quot;&lt;script src=&#39;scripts/${attrs[&#39;script&#39;]}.js&#39;&gt;&lt;/script&gt;&quot;</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Vamos a ver a continuación como podemos comprobar que esta etiqueta devuelve lo que pensamos.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">void</span> <span class="tok-s2">&quot;La etiqueta includeJs devuelve una referencia a la librería javascript pasada por parámetro&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-nl">expect:</span>
        <span class="tok-n">applyTemplate</span><span class="tok-o">(</span><span class="tok-s1">&#39;&lt;todo:includeJs script=&quot;&quot; /&gt;&#39;</span><span class="tok-o">)</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;&lt;script src=&#39;scripts/.js&#39;&gt;&lt;/script&gt;&quot;</span>
        <span class="tok-n">applyTemplate</span><span class="tok-o">(</span><span class="tok-s1">&#39;&lt;todo:includeJs script=&quot;myfile&quot; /&gt;&#39;</span><span class="tok-o">)</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;&lt;script src=&#39;scripts/myfile.js&#39;&gt;&lt;/script&gt;&quot;</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Además de testear las librerías de etiquetas, vamos a comprobar que las vistas y las plantillas devuelven lo que deben devolver. Si recordamos en la sesión de vistas y plantillas, creábamos una plantilla para pintar el pie de página. Vamos a poder comprobar que esta plantilla devuelve lo correcto mediante un test unitario:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">void</span> <span class="tok-s2">&quot;El pie de página se renderiza correctamente&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-nl">when:</span>
        <span class="tok-kt">def</span> <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-n">render</span><span class="tok-o">(</span><span class="tok-nl">template:</span> <span class="tok-s1">&#39;/common/footer&#39;</span><span class="tok-o">)</span>

    <span class="tok-nl">then:</span>
        <span class="tok-n">result</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;&lt;div class=\&quot;footer\&quot; role=\&quot;contentinfo\&quot;&gt;\n&quot;</span> <span class="tok-o">+</span>
            <span class="tok-s2">&quot;    &amp;copy; 2015 Experto en Desarrollo de Aplicaciones Web con JavaEE y Javascript&lt;br/&gt;\n&quot;</span> <span class="tok-o">+</span>
            <span class="tok-s2">&quot;    Aplicación Todo creada por Francisco José García Rico (21.542.334F)\n&quot;</span> <span class="tok-o">+</span>
            <span class="tok-s2">&quot;&lt;/div&gt;&quot;</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_tests_con_spock_sobre_servicios_en_grails">6.3.4. Tests con Spock sobre servicios en Grails</h4>
<div class="paragraph">
<p>Tal y como sucede con el resto de artefactos de una aplicación en Grails, cuando creamos un servicio nuevo automáticamente se genera también un test unitario que nos permitirá testear los métodos del servicio.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">es</span><span class="tok-o">.</span><span class="tok-na">ua</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">todo</span>

<span class="tok-kn">import</span> <span class="tok-nn">grails.test.mixin.TestFor</span>
<span class="tok-kn">import</span> <span class="tok-nn">spock.lang.Specification</span>

<span class="tok-cm">/**</span>
<span class="tok-cm"> * See the API for {@link grails.test.mixin.services.ServiceUnitTestMixin} for usage instructions</span>
<span class="tok-cm"> */</span>
<span class="tok-nd">@TestFor</span><span class="tok-o">(</span><span class="tok-n">TodoService</span><span class="tok-o">)</span>
<span class="tok-kd">class</span> <span class="tok-nc">TodoServiceSpec</span> <span class="tok-kd">extends</span> <span class="tok-n">Specification</span> <span class="tok-o">{</span>

    <span class="tok-kt">def</span> <span class="tok-nf">setup</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-o">}</span>

    <span class="tok-kt">def</span> <span class="tok-nf">cleanup</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-o">}</span>

    <span class="tok-kt">void</span> <span class="tok-s2">&quot;test something&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En su momento creábamos un método llamado <em>getNextTodos()</em> que nos devolvía las tareas programadas para los próximos días. Para poder testear este método, vamos a necesitar crear una serie de instancias de la clase de dominio <em>Todo</em>. Si recordamos el método en cuestión</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-nf">getNextTodos</span><span class="tok-o">(</span><span class="tok-n">Integer</span> <span class="tok-n">days</span><span class="tok-o">,</span> <span class="tok-n">params</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-n">Date</span> <span class="tok-n">now</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Date</span><span class="tok-o">(</span><span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">currentTimeMillis</span><span class="tok-o">())</span>
    <span class="tok-n">Date</span> <span class="tok-n">to</span> <span class="tok-o">=</span> <span class="tok-n">now</span> <span class="tok-o">+</span> <span class="tok-n">days</span>
    <span class="tok-n">Todo</span><span class="tok-o">.</span><span class="tok-na">findAllByDateBetween</span><span class="tok-o">(</span><span class="tok-n">now</span><span class="tok-o">,</span> <span class="tok-n">to</span><span class="tok-o">,</span> <span class="tok-n">params</span><span class="tok-o">)</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>vemos que se utiliza una llamada a un método dinámico de GORM, con lo que se se realizará una consulta a la base de datos. Pero, si recordamos la definición de tests unitarios que veíamos al inicio de esta sesión, se hacía mención a que los tests unitarios no tienen acceso a recursos externos tales como la base de datos, con lo que, ¿cómo vamos a poder solucionar este problema?</p>
</div>
<div class="paragraph">
<p>Podríamos optar por dos soluciones. Bien crear un test de integración para tener acceso a la base de datos o bien, <em>mockear</em> la creación de las clases de dominio necesarias. Nosotros optamos por la segunda solución, ya que en términos de velocidad de ejecución de los tests, los tests de integración son considerablemente más lentos que los tests unitarios.</p>
</div>
<div class="paragraph">
<p>Para <em>mockear</em> la creación de una serie de instancias de una determinada clase de dominio, vamos a utilizar el método llamado <em>mockDomain</em> al cual le podemos pasar que clase de domino queremos mockear y cuales son esas instancias. Con esto podríamos tener un test como éste para comprobar el método <em>getNextTodos()</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">void</span> <span class="tok-s2">&quot;El método getNextTodos devuelve los siguientes todos de los días pasado por parámetro&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-nl">given:</span>
        <span class="tok-kt">def</span> <span class="tok-n">todoDayBeforeYesterday</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Todo</span><span class="tok-o">(</span><span class="tok-nl">title:</span><span class="tok-s2">&quot;Todo day before yesterday&quot;</span><span class="tok-o">,</span> <span class="tok-nl">date:</span> <span class="tok-k">new</span> <span class="tok-n">Date</span><span class="tok-o">()</span> <span class="tok-o">-</span> <span class="tok-mi">2</span> <span class="tok-o">)</span>
        <span class="tok-kt">def</span> <span class="tok-n">todoYesterday</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Todo</span><span class="tok-o">(</span><span class="tok-nl">title:</span><span class="tok-s2">&quot;Todo yesterday&quot;</span><span class="tok-o">,</span> <span class="tok-nl">date:</span> <span class="tok-k">new</span> <span class="tok-n">Date</span><span class="tok-o">()</span> <span class="tok-o">-</span> <span class="tok-mi">1</span> <span class="tok-o">)</span>
        <span class="tok-kt">def</span> <span class="tok-n">todoToday</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Todo</span><span class="tok-o">(</span><span class="tok-nl">title:</span><span class="tok-s2">&quot;Todo today&quot;</span><span class="tok-o">,</span> <span class="tok-nl">date:</span> <span class="tok-k">new</span> <span class="tok-n">Date</span><span class="tok-o">())</span>
        <span class="tok-kt">def</span> <span class="tok-n">todoTomorrow</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Todo</span><span class="tok-o">(</span><span class="tok-nl">title:</span><span class="tok-s2">&quot;Todo tomorrow&quot;</span><span class="tok-o">,</span> <span class="tok-nl">date:</span> <span class="tok-k">new</span> <span class="tok-n">Date</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-mi">1</span> <span class="tok-o">)</span>
        <span class="tok-kt">def</span> <span class="tok-n">todoDayAfterTomorrow</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Todo</span><span class="tok-o">(</span><span class="tok-nl">title:</span><span class="tok-s2">&quot;Todo day after tomorrow&quot;</span><span class="tok-o">,</span> <span class="tok-nl">date:</span> <span class="tok-k">new</span> <span class="tok-n">Date</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-mi">2</span> <span class="tok-o">)</span>
        <span class="tok-kt">def</span> <span class="tok-n">todoDayAfterDayAfterTomorrow</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Todo</span><span class="tok-o">(</span><span class="tok-nl">title:</span><span class="tok-s2">&quot;Todo day after tomorrow&quot;</span><span class="tok-o">,</span> <span class="tok-nl">date:</span> <span class="tok-k">new</span> <span class="tok-n">Date</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-mi">3</span> <span class="tok-o">)</span>
    <span class="tok-nl">and:</span>
        <span class="tok-n">mockDomain</span><span class="tok-o">(</span><span class="tok-n">Todo</span><span class="tok-o">,[</span><span class="tok-n">todoDayBeforeYesterday</span><span class="tok-o">,</span> <span class="tok-n">todoYesterday</span><span class="tok-o">,</span> <span class="tok-n">todoToday</span><span class="tok-o">,</span> <span class="tok-n">todoTomorrow</span><span class="tok-o">,</span> <span class="tok-n">todoDayAfterTomorrow</span><span class="tok-o">,</span> <span class="tok-n">todoDayAfterDayAfterTomorrow</span><span class="tok-o">])</span>
    <span class="tok-nl">and:</span>
        <span class="tok-kt">def</span> <span class="tok-n">nextTodos</span> <span class="tok-o">=</span> <span class="tok-n">service</span><span class="tok-o">.</span><span class="tok-na">getNextTodos</span><span class="tok-o">(</span><span class="tok-mi">2</span><span class="tok-o">,[:])</span>
    <span class="tok-nl">expect:</span>
        <span class="tok-n">Todo</span><span class="tok-o">.</span><span class="tok-na">count</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-mi">6</span>
    <span class="tok-nl">and:</span>
        <span class="tok-n">nextTodos</span><span class="tok-o">.</span><span class="tok-na">containsAll</span><span class="tok-o">([</span><span class="tok-n">todoTomorrow</span><span class="tok-o">,</span> <span class="tok-n">todoDayAfterTomorrow</span><span class="tok-o">])</span>
        <span class="tok-n">nextTodos</span><span class="tok-o">.</span><span class="tok-na">size</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-mi">2</span>
    <span class="tok-nl">and:</span>
        <span class="tok-o">!</span><span class="tok-n">nextTodos</span><span class="tok-o">.</span><span class="tok-na">contains</span><span class="tok-o">(</span><span class="tok-n">todoDayBeforeYesterday</span><span class="tok-o">)</span>
        <span class="tok-o">!</span><span class="tok-n">nextTodos</span><span class="tok-o">.</span><span class="tok-na">contains</span><span class="tok-o">(</span><span class="tok-n">todoToday</span><span class="tok-o">)</span>
        <span class="tok-o">!</span><span class="tok-n">nextTodos</span><span class="tok-o">.</span><span class="tok-na">contains</span><span class="tok-o">(</span><span class="tok-n">todoYesterday</span><span class="tok-o">)</span>
        <span class="tok-o">!</span><span class="tok-n">nextTodos</span><span class="tok-o">.</span><span class="tok-na">contains</span><span class="tok-o">(</span><span class="tok-n">todoDayAfterDayAfterTomorrow</span><span class="tok-o">)</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En el test, en primer lugar creamos todas las instancias de la clase de dominio <em>Todo</em> que vamos a utilizar para realizar las comprobaciones. La primera comprobación que realizamos es comprobar que el contador de instancias de la clase <em>Todo</em> es igual al número de elementos creados.</p>
</div>
<div class="paragraph">
<p>A continuación, ya comprobamos el método <em>getNextTodos()</em> para comprobar que sólo devuelve aquellas instancias creadas que coincidan con el criterio de que sean tareas a realizar en el futuro. Esto significa que sólo las instancias <em>todoTomorrow</em> y <em>todoDayAfterTomorrow</em> serán devueltas.</p>
</div>
</div>
<div class="sect3">
<h4 id="_tests_con_spock_mockeando_objetos">6.3.5. Tests con Spock mockeando objetos</h4>
<div class="paragraph">
<p>Los tests unitarios se pueden complicar mucho cuando entran en funcionamiento otros objetos en el método que queremos probar. Por ejemplo, en la sesión sobre vistas y etiquetas planteábamos un ejercicio para escribir una etiqueta que nos imprimiera por pantalla un icono diferente en función de si el valor pasado por parámetro era cierto o falso. Esa etiqueta se aconsejaba utilizar a su vez la etiqueta <em>asset.image()</em> procedente del plugin <em>asset pipeline</em>.</p>
</div>
<div class="paragraph">
<p>Si pensamos en que test podríamos utilizar para comprobar el funcionamiento de la etiqueta <em>printIconFromBoolean</em>, podríamos pensar algo así:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-nd">@Unroll</span>
<span class="tok-kt">void</span> <span class="tok-s2">&quot;El método printIconFromBoolean devuelve una ruta a una imagen&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-nl">when:</span>
        <span class="tok-kt">def</span> <span class="tok-n">output</span> <span class="tok-o">=</span> <span class="tok-n">applyTemplate</span><span class="tok-o">(</span><span class="tok-s1">&#39;&lt;todo:printIconFromBoolean value=&quot;${value}&quot; /&gt;&#39;</span><span class="tok-o">,</span> <span class="tok-o">[</span><span class="tok-nl">value:</span><span class="tok-n">value</span><span class="tok-o">])</span>
    <span class="tok-nl">then:</span>
        <span class="tok-n">output</span> <span class="tok-o">==</span> <span class="tok-n">expectedOutput</span>
    <span class="tok-nl">where:</span>
        <span class="tok-n">value</span>   <span class="tok-o">|</span>   <span class="tok-n">expectedOutput</span>
        <span class="tok-kc">true</span>    <span class="tok-o">|</span>   <span class="tok-s2">&quot;icontrue.png&quot;</span>
        <span class="tok-kc">false</span>   <span class="tok-o">|</span>   <span class="tok-s2">&quot;iconfalse.png&quot;</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Sin embargo, si ejecutamos este test, veremos como el test no se ejecuta correctamente debido a que no sabe como ejecutar un método llamado <em>assetPath</em>. ¿assetPath? ¿De dónde viene la llamada a ese método?</p>
</div>
<div class="paragraph">
<p>Si analizamos el código del método <em>image</em> de la librería de etiquetas <em>AssetsTagLib</em> veremos como se realiza una llamada al método <em>assetPath</em> que queda fuera del contexto de nuestro test unitario con lo que no podemos acceder directamente a él. Para solucionar este problema, debemos <em>mockear</em> la llamada que nuestra etiqueta <em>printIconFromBoolean</em> realiza al método <em>image()</em> de la librería de etiquetas del plugin <em>asset pipeline</em>. De esta forma, podemos aislar nuestra prueba unitaria de las llamadas realizadas por otros objetos colaboradores y nos centraremos en la lógica de nuestro método.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-nd">@Unroll</span>
<span class="tok-kt">void</span> <span class="tok-s2">&quot;El método printIconFromBoolean devuelve una ruta a una imagen&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-nl">given:</span>
        <span class="tok-kt">def</span> <span class="tok-n">assetsTagLib</span> <span class="tok-o">=</span> <span class="tok-n">Mock</span><span class="tok-o">(</span><span class="tok-n">AssetsTagLib</span><span class="tok-o">)</span>
        <span class="tok-n">tagLib</span><span class="tok-o">.</span><span class="tok-na">metaClass</span><span class="tok-o">.</span><span class="tok-na">asset</span> <span class="tok-o">=</span> <span class="tok-n">assetsTagLib</span>
    <span class="tok-nl">when:</span>
        <span class="tok-kt">def</span> <span class="tok-n">output</span> <span class="tok-o">=</span> <span class="tok-n">applyTemplate</span><span class="tok-o">(</span><span class="tok-s1">&#39;&lt;todo:printIconFromBoolean value=&quot;${value}&quot; /&gt;&#39;</span><span class="tok-o">,</span> <span class="tok-o">[</span><span class="tok-nl">value:</span><span class="tok-n">value</span><span class="tok-o">])</span>
    <span class="tok-nl">then:</span>
        <span class="tok-n">output</span> <span class="tok-o">==</span> <span class="tok-n">expectedOutput</span>
    <span class="tok-nl">and:</span>
        <span class="tok-mi">1</span> <span class="tok-o">*</span> <span class="tok-n">assetsTagLib</span><span class="tok-o">.</span><span class="tok-na">image</span><span class="tok-o">(</span><span class="tok-n">_</span><span class="tok-o">)</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-o">{</span> <span class="tok-n">value</span> <span class="tok-o">?</span> <span class="tok-s2">&quot;icontrue.png&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;iconfalse.png&quot;</span> <span class="tok-o">}</span>
    <span class="tok-nl">where:</span>
        <span class="tok-n">value</span>   <span class="tok-o">|</span>   <span class="tok-n">expectedOutput</span>
        <span class="tok-kc">true</span>    <span class="tok-o">|</span>   <span class="tok-s2">&quot;icontrue.png&quot;</span>
        <span class="tok-kc">false</span>   <span class="tok-o">|</span>   <span class="tok-s2">&quot;iconfalse.png&quot;</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En primer lugar, debemos mockear la librería <em>AssetsTagLib</em> para poder devolver lo que nosotros queramos y que no sea necesario invocar al método <em>assetPath</em>. Además, debemos indicar una referencia al <em>namespace</em> asset que nuestra librería <em>TodoTagLib</em> va a utilizar como colaborador. Esto lo hacemos con algo de metaprogramación</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">tagLib</span><span class="tok-o">.</span><span class="tok-na">metaClass</span><span class="tok-o">.</span><span class="tok-na">asset</span> <span class="tok-o">=</span> <span class="tok-n">assetTagLib</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>y básicamente estamos creando una referencia entre el objeto <em>asset</em> en el contexto de la librería de etiquetas <em>TodoTagLib</em> y nuestro objecto mockeado con la librería <em>AssetsTagLib</em>. De esta forma, lo único que nos queda por hacer es sobrecargar el método <em>image()</em>.</p>
</div>
<div class="paragraph">
<p>Para sobrecargar este método utilizamos una técnica que nos permite incluso saber cuantas veces un método ha sido invocado y con que parámetros. Esta técnica se conoce como <em>Tests basados en interacciones</em>.</p>
</div>
<div class="paragraph">
<p>Para ello lo primero que hemos hecho ha sido generar ese objecto mockeado con</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">assetsTagLib</span> <span class="tok-o">=</span> <span class="tok-n">Mock</span><span class="tok-o">(</span><span class="tok-n">AssetsTagLib</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por último, debemos indicar cuantas interacciones vamos a realizar con el método del objeto mockeado y cual va a ser su salida.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-mi">1</span> <span class="tok-o">*</span> <span class="tok-n">assetsTagLib</span><span class="tok-o">.</span><span class="tok-na">image</span><span class="tok-o">(</span><span class="tok-n">_</span><span class="tok-o">)</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-o">{</span> <span class="tok-n">value</span> <span class="tok-o">?</span> <span class="tok-s2">&quot;icontrue.png&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;iconfalse.png&quot;</span> <span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Con esto estamos indicando que sólo se va a producir una llamada al método <em>image()</em> de la librería de etiquetas <em>AssetsTagLib</em> y que además, esta llamada se puede realizar con cualquier valor como primer (y único) parámetro (esto lo conseguimos utilizando el <em>placeholder _)</em>. Si quisiéramos asegurarnos de que los parámetros pasados son los correctos podríamos tener algo así:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-mi">1</span> <span class="tok-o">*</span> <span class="tok-n">assetsTagLib</span><span class="tok-o">.</span><span class="tok-na">image</span><span class="tok-o">([</span><span class="tok-nl">src:</span><span class="tok-n">expectedOutput</span><span class="tok-o">])</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-o">{</span> <span class="tok-n">value</span> <span class="tok-o">?</span> <span class="tok-s2">&quot;icontrue.png&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;iconfalse.png&quot;</span> <span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_algunas_anotaciones_interesantes">6.3.6. Algunas anotaciones interesantes</h4>
<div class="paragraph">
<p>Spock presenta una serie de anotaciones que nos servirán de apoyo para realizar nuestros tests.</p>
</div>
<div class="sect4">
<h5 id="_ignore">Ignore</h5>
<div class="paragraph">
<p>Esta anotación se puede utilizar a nivel de método o a nivel de clase y como su nombre indica sirve para indicar al proceso que ejecuta los tests que el método en cuestión o la clase no deben ser ejecutados.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-nd">@Ignore</span>
<span class="tok-kt">def</span> <span class="tok-s2">&quot;my feature&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-o">...</span> <span class="tok-o">}</span>

<span class="tok-nd">@Ignore</span>
<span class="tok-kd">class</span> <span class="tok-nc">MySpec</span> <span class="tok-kd">extends</span> <span class="tok-n">Specification</span> <span class="tok-o">{</span> <span class="tok-o">...</span> <span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Incluso podemos pasar como parámetro a la anotación un motivo por el cual este test no va a ser ejecutado.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-nd">@Ignore</span><span class="tok-o">(</span><span class="tok-n">reason</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;TODO&quot;</span><span class="tok-o">)</span>
<span class="tok-kt">def</span> <span class="tok-s2">&quot;my feature&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-o">...</span> <span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_ignorerest">IgnoreRest</h5>
<div class="paragraph">
<p>Esta anotación sólo se puede especificar a nivel de método y le indicará al proceso encargado de ejecutar los tests que sólo los métodos que proporcionen esta anotación deben ser ejecutados.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-s2">&quot;I&#39;ll be ignored&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-o">...</span> <span class="tok-o">}</span>

<span class="tok-nd">@IgnoreRest</span>
<span class="tok-kt">def</span> <span class="tok-s2">&quot;I&#39;ll run&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-o">...</span> <span class="tok-o">}</span>

<span class="tok-kt">def</span> <span class="tok-s2">&quot;I&#39;ll also be ignored&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-o">...</span> <span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_ignoreif">IgnoreIf</h5>
<div class="paragraph">
<p>Esta anotación indica que el método anotado sólo se ejecutará si se cumplen una serie de condiciones.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-nd">@IgnoreIf</span><span class="tok-o">({</span> <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">getProperty</span><span class="tok-o">(</span><span class="tok-s2">&quot;os.name&quot;</span><span class="tok-o">).</span><span class="tok-na">contains</span><span class="tok-o">(</span><span class="tok-s2">&quot;windows&quot;</span><span class="tok-o">)</span> <span class="tok-o">})</span>
<span class="tok-kt">def</span> <span class="tok-s2">&quot;I&#39;ll run everywhere but on Windows&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-o">...</span> <span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para facilitar la comprensión de la condición existen una serie de propiedades disponibles dentro del closure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>sys</em> Un mapa con todas las propiedades del sistema</p>
</li>
<li>
<p><em>env</em> Un mapa con todas las variables de entorno</p>
</li>
<li>
<p><em>os</em> Información acerca del sistema operativo (ver spock.util.environment.OperatingSystem)</p>
</li>
<li>
<p><em>jvm</em> Información sobre la máquina virtual de Java (ver spock.util.environment.Jvm)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Con lo que el ejemplo anterior puede ser reescrito de la siguiente forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-nd">@IgnoreIf</span><span class="tok-o">({</span> <span class="tok-n">os</span><span class="tok-o">.</span><span class="tok-na">windows</span> <span class="tok-o">})</span>
<span class="tok-kt">def</span> <span class="tok-s2">&quot;I&#39;ll run everywhere but on Windows&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-o">...</span> <span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_requires">Requires</h5>
<div class="paragraph">
<p>Es la anotación contraria a <em>@IgnoreIf</em>. Los métodos anotados con esta anotación sólo se ejecutarán bajo ciertas condiciones.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-nd">@Requires</span><span class="tok-o">({</span> <span class="tok-n">os</span><span class="tok-o">.</span><span class="tok-na">windows</span> <span class="tok-o">})</span>
<span class="tok-kt">def</span> <span class="tok-s2">&quot;I&#39;ll only run on Windows&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-o">...</span> <span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_stepwise">Stepwise</h5>
<div class="paragraph">
<p>Es conveniente que los tests no dependan unos de otros para su correcta ejecución, pero en ocasiones por rapidez, necesitaremos ejecutar los tests en un determinado orden. Esto lo podemos conseguir con la anotación <em>@Stepwise</em> que se utiliza a nivel de clase.</p>
</div>
<div class="paragraph">
<p>Imagina por ejemplo un test funcional con el que pretendemos comprobar que las 4 operaciones básicas sobre las tareas (creación, eliminación, actualización y borrado) se ejecutan correctamente. Lo ideal sería crear 4 tests distintos, uno para cada operación, pero, ¿qué pasaría si pretendemos eliminar una tarea que todavía ni siquiera ha sido creada? En este ejemplo, es necesario que todos los tests se ejecuten en un determinado orden.</p>
</div>
</div>
<div class="sect4">
<h5 id="_timeout">Timeout</h5>
<div class="paragraph">
<p>La anotación <em>@Timeout</em> se puede aplicar a nivel de clase o a nivel de método y nos permitirá especificar un tiempo máximo de ejecución de un test o de una clase de tests. La unidad por defecto será en segundos, pero vamos a poder modificar esta unidad.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-nd">@Timeout</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">)</span>
<span class="tok-kt">def</span> <span class="tok-s2">&quot;I fail if I run for more than five seconds&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-o">...</span> <span class="tok-o">}</span>

<span class="tok-nd">@Timeout</span><span class="tok-o">(</span><span class="tok-n">value</span> <span class="tok-o">=</span> <span class="tok-mi">100</span><span class="tok-o">,</span> <span class="tok-n">unit</span> <span class="tok-o">=</span> <span class="tok-n">TimeUnit</span><span class="tok-o">.</span><span class="tok-na">MILLISECONDS</span><span class="tok-o">)</span>
<span class="tok-kt">def</span> <span class="tok-s2">&quot;I better be quick&quot;</span> <span class="tok-o">{</span> <span class="tok-o">...</span> <span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si utilizamos la anotación a nivel de clase y a nivel de método, el método siempre sobreescribirá a lo especificado a nivel de clase.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-nd">@Timeout</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">)</span>
<span class="tok-kd">class</span> <span class="tok-nc">TimedSpec</span> <span class="tok-kd">extends</span> <span class="tok-n">Specification</span> <span class="tok-o">{</span>
  <span class="tok-kt">def</span> <span class="tok-s2">&quot;I fail after ten seconds&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-o">...</span> <span class="tok-o">}</span>
  <span class="tok-kt">def</span> <span class="tok-s2">&quot;Me too&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-o">...</span> <span class="tok-o">}</span>

  <span class="tok-nd">@Timeout</span><span class="tok-o">(</span><span class="tok-n">value</span> <span class="tok-o">=</span> <span class="tok-mi">250</span><span class="tok-o">,</span> <span class="tok-n">unit</span> <span class="tok-o">=</span> <span class="tok-n">MILLISECONDS</span><span class="tok-o">)</span>
  <span class="tok-kt">def</span> <span class="tok-s2">&quot;I fail much faster&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-o">...</span> <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_confinemetaclasschanges">ConfineMetaClassChanges</h5>
<div class="paragraph">
<p>Utilizar metaprogramación puede ser muy beneficioso en nuestros tests pero al mismo tiempo, puede llegar a ser algo peligroso, ya que necesitamos asegurarnos que las clases que han sido metaprogramadas no conservan esa metaprogramación más allá de donde sea imprescindible.</p>
</div>
<div class="paragraph">
<p>Para ello, bien asegurar de dejar la metaclase sin ninguna modificación con</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">Class</span><span class="tok-o">.</span><span class="tok-na">metaClass</span> <span class="tok-o">=</span> <span class="tok-kc">null</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>o bien, en los casos de los tests con Spock podemos utilizar la anotación <em>@ConfineMetaClassChanges</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-nd">@Stepwise</span>
<span class="tok-kd">class</span> <span class="tok-nc">FooSpec</span> <span class="tok-kd">extends</span> <span class="tok-n">Specification</span> <span class="tok-o">{</span>
  <span class="tok-nd">@ConfineMetaClassChanges</span>
  <span class="tok-kt">def</span> <span class="tok-s2">&quot;I run first&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-nl">when:</span>
    <span class="tok-n">String</span><span class="tok-o">.</span><span class="tok-na">metaClass</span><span class="tok-o">.</span><span class="tok-na">someMethod</span> <span class="tok-o">=</span> <span class="tok-o">{</span> <span class="tok-n">delegate</span> <span class="tok-o">}</span>

    <span class="tok-nl">then:</span>
    <span class="tok-n">String</span><span class="tok-o">.</span><span class="tok-na">metaClass</span><span class="tok-o">.</span><span class="tok-na">hasMetaMethod</span><span class="tok-o">(</span><span class="tok-s1">&#39;someMethod&#39;</span><span class="tok-o">)</span>
  <span class="tok-o">}</span>

  <span class="tok-kt">def</span> <span class="tok-s2">&quot;I run second&quot;</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-nl">when:</span>
    <span class="tok-s2">&quot;Foo&quot;</span><span class="tok-o">.</span><span class="tok-na">someMethod</span><span class="tok-o">()</span>

    <span class="tok-nl">then:</span>
    <span class="tok-n">thrown</span><span class="tok-o">(</span><span class="tok-n">MissingMethodException</span><span class="tok-o">)</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_title_y_narrative">Title y Narrative</h5>
<div class="paragraph">
<p>Podemos especificar lenguaje natural al nombre de nuestras clases con las anotaciones <em>@Title</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-nd">@Title</span><span class="tok-o">(</span><span class="tok-s2">&quot;This is easy to read&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">class</span> <span class="tok-nc">ThisIsHarderToReadSpec</span> <span class="tok-kd">extends</span> <span class="tok-n">Specification</span> <span class="tok-o">{</span>
  <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>y <em>@Narrative</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-nd">@Narrative</span><span class="tok-o">(</span><span class="tok-s2">&quot;&quot;&quot;&quot;</span>
<span class="tok-n">As</span> <span class="tok-n">a</span> <span class="tok-n">user</span>
<span class="tok-n">I</span> <span class="tok-n">want</span> <span class="tok-n">foo</span>
<span class="tok-n">So</span> <span class="tok-n">that</span> <span class="tok-n">bar</span>
<span class="tok-s2">&quot;&quot;</span><span class="tok-err">&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">class</span> <span class="tok-nf">GiveTheUserFooSpec</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-o">...</span> <span class="tok-o">}</span></code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios_6">6.4. Ejercicios</h3>
<div class="sect3">
<h4 id="_testeando_nuestra_propia_restricción_0_25_puntos">6.4.1. Testeando nuestra propia restricción (0.25 puntos)</h4>
<div class="paragraph">
<p>Realiza los tests necesarios para comprobar el correcto funcionamiento de la restricción que creaste en sesiones anteriores para que la fecha de recordatorio nunca pueda ser posterior a la fecha de la propia tarea.</p>
</div>
<div class="paragraph">
<p>Este test o tests los vamos a escribir en la clase <em>TodoSpec.groovy</em>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_testeando_la_clase_todocontroller_0_50_puntos">6.4.2. Testeando la clase TodoController (0.50 puntos)</h4>
<div class="paragraph">
<p>Escribe las modificaciones necesarias a la clase <em>TodoControllerSpec</em> para pasar los tests unitarios para la parte de scaffolding. Recuerda que estamos utilizando el servicio <em>todoService</em> en el controlador con lo que tendrás que inyectar el servicio en concreto en el controlador.</p>
</div>
<div class="paragraph">
<p>Además, realiza los tests unitarios necesarios para comprobar también el funcionamiento de los métodos <em>listNextTodos(Integer days)</em> y <em>showListByCategory()</em> (la vista que nos permite que categorías queremos filtrar en el listado de las tareas).</p>
</div>
<div class="paragraph">
<p>Estos tests los vamos a escribir en la clase <em>TodoControllerSpec.groovy</em>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_testeando_la_clase_todoservice_0_50_puntos">6.4.3. Testeando la clase TodoService (0.50 puntos)</h4>
<div class="paragraph">
<p>Para terminar con los tests, vamos a implementar un par de tests para testear el servicio <em>TodoService</em>. Estos dos métodos serán <em>countNextTodos()</em> y <em>saveTodo()</em> (que creamos en la sesión anterior).</p>
</div>
<div class="paragraph">
<p>El método <em>saveTodo()</em> se encarga de almacenar la nueva instancia pero además os recuerdo que debía almacenar la fecha de realización de la tarea si esta había sido realizada.</p>
</div>
<div class="paragraph">
<p>Estos tests los vamos a escribir en la clase <em>TodoServiceSpec.groovy</em>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Importante</div>
<div class="paragraph">
<p>Es absolutamente necesario que cuando presenteis el proyecto todos los tests se pasen correctamente. Así que antes de entregar el proyecto final, recuerda ejecutar el comando <em>grails test-app unit:</em> para comprobar que tus tests se ejecutan correctamente. Es decir, así debería terminar vuestro proyecto antes de ser entregado.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/grails06/allgreentests.png" alt="Todos los tests en verde" width="50%">
</div>
</div>
</td>
</tr>
</table>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion07">7. Seguridad con Spring Security plugin.</h2>
<div class="sectionbody">
<div class="paragraph">
<p>En esta séptima sesión del módulo de Groovy&amp;Grails veremos como podemos utilizar un plugin de Grails que nos permitirá descargar toda la implementación de la seguridad de nuestra aplicación en Spring Security.</p>
</div>
<div class="paragraph">
<p>Mediante este plugin podremos asignar determinados roles a usuarios y posteriormente crear algunos permisos que podrán ser asignados tanto a usuarios como a roles.</p>
</div>
<div class="sect2">
<h3 id="_instalación_del_plugin">7.1. Instalación del plugin</h3>
<div class="paragraph">
<p>En la introducción a Grails decíamos que, aquello que no está implementado en el núcleo de Grails, es muy probable que lo podamos encontrar entre los plugins, realizados tanto por la comunidad de usuarios como por la gente de Spring Source.</p>
</div>
<div class="paragraph">
<p>En este caso, el plugin es mantenido directamente por la gente de Spring Source, algo que nos garantiza su durabilidad y mantenimiento. Este plugin se llama <em>spring-security-core</em> y podemos encontrar toda la información relativa al mismo en la dirección <a href="http://grails.org/plugin/spring-security-core" class="bare">http://grails.org/plugin/spring-security-core</a>.</p>
</div>
<div class="paragraph">
<p>Tal y como se explica en la página del plugin, éste tiene una serie de plugins adicionales que permiten la autenticación mediante OpenID, LDAP o Kerberos (entre otras). Además, a esta lista se han añadido recientemente otros plugins que permiten la autenticación utilizando Facebook o Twitter.</p>
</div>
<div class="paragraph">
<p>El plugin de spring-security-core es uno de los mejor documentados de todos los desarrollados y podrás encontrar esta documentación en la dirección <a href="http://grails-plugins.github.io/grails-spring-security-core/guide/index.html" class="bare">http://grails-plugins.github.io/grails-spring-security-core/guide/index.html</a> y su autor, Burt Beckwith (<a href="https://www.twitter.com/burtbeckwith">@burtbeckwith</a>) uno de los <em>commiters</em> más activos de la comunidad.</p>
</div>
<div class="paragraph">
<p>En Grails, para instalar cualquier plugin tenemos el comando <em>grails install-plugin</em> con lo que para instalar el plugin de spring-security-core únicamente deberíamos ejecutar el comando <em>grails install-plugin spring-security-core</em>. Pero además, podemos editar el archivo <em>BuildConfig.groovy</em> y añadir una nueva línea en la parte dedicada a los plugins:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">plugins</span> <span class="tok-o">{</span>
	<span class="tok-o">...</span>
	<span class="tok-n">compile</span> <span class="tok-s2">&quot;:spring-security-core:2.0-RC6&quot;</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nosotros vamos a optar por esta segunda opción puesto que quedarán contemplados todos los plugins que instalemos en nuestra aplicación en un único archivo que luego vamos a poder compartir con el resto de desarrolladores de la aplicación.</p>
</div>
<div class="paragraph">
<p>Durante la instalación del plugin se realizará automáticamente la descarga de todas las dependencias del plugin. En algunos casos, la instalación de plugins supone la creación de nuevos comandos en Grails y éste es el caso de spring-security-core, en el que, tal y como nos indican una vez finalizada la instalación nos indica que podemos ejecutar el comando <em>grails s2-quickstart</em> que nos servirá para inicializar el plugin y crear las clases de dominio necesarias.</p>
</div>
<div class="paragraph">
<p>El nuevo comando instalado <em>s2-quickstart</em> necesita de una serie de parámetros que serán los siguientes</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>paquete</em> donde queremos crear las clases de dominio a generar</p>
</li>
<li>
<p><em>clase de dominio para los usuarios</em> que habitualmente se llamará User o Person</p>
</li>
<li>
<p><em>clase de dominio para los roles</em> que habitualmente se llamará Role o Authority</p>
</li>
<li>
<p><em>clase de dominio para el mapeo de peticiones</em> que habitualmente se llamará RequestMap. Este parámetro es opcional puesto que este mapeo podemos hacerlo directamente en el archivo de configuración <em>Config.groovy</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Nosotros ejecutaremos el comando <em>grails s2-quickstart es.ua.expertojava.todo Person Role RequestMap</em> que creará cuatro nuevas clases de dominio en nuestra aplicación en el paquete <em>es.ua.expertojava.todo</em> que son las siguientes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Person</p>
</li>
<li>
<p>PersonRole</p>
</li>
<li>
<p>Role</p>
</li>
<li>
<p>RequestMap</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_configuración_del_plugin">7.2. Configuración del plugin</h3>
<div class="paragraph">
<p>Toda la configuración del plugin se añade automáticamente en el archivo de configuración Config.groovy y básicamente lo que se indica en esta configuración es el nombre de cada una de las clases necesarias para el plugin así como el tipo de seguridad implementada.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Added by the Spring Security Core plugin:</span>
<span class="tok-n">grails</span><span class="tok-o">.</span><span class="tok-na">plugin</span><span class="tok-o">.</span><span class="tok-na">springsecurity</span><span class="tok-o">.</span><span class="tok-na">userLookup</span><span class="tok-o">.</span><span class="tok-na">userDomainClassName</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;es.ua.expertojava.todo.Person&#39;</span>
<span class="tok-n">grails</span><span class="tok-o">.</span><span class="tok-na">plugin</span><span class="tok-o">.</span><span class="tok-na">springsecurity</span><span class="tok-o">.</span><span class="tok-na">userLookup</span><span class="tok-o">.</span><span class="tok-na">authorityJoinClassName</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;es.ua.expertojava.todo.PersonRole&#39;</span>
<span class="tok-n">grails</span><span class="tok-o">.</span><span class="tok-na">plugin</span><span class="tok-o">.</span><span class="tok-na">springsecurity</span><span class="tok-o">.</span><span class="tok-na">authority</span><span class="tok-o">.</span><span class="tok-na">className</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;es.ua.expertojava.todo.Role&#39;</span>
<span class="tok-n">grails</span><span class="tok-o">.</span><span class="tok-na">plugin</span><span class="tok-o">.</span><span class="tok-na">springsecurity</span><span class="tok-o">.</span><span class="tok-na">requestMap</span><span class="tok-o">.</span><span class="tok-na">className</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;es.ua.expertojava.todo.RequestMap&#39;</span>
<span class="tok-n">grails</span><span class="tok-o">.</span><span class="tok-na">plugin</span><span class="tok-o">.</span><span class="tok-na">springsecurity</span><span class="tok-o">.</span><span class="tok-na">securityConfigType</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;Requestmap&#39;</span>
<span class="tok-n">grails</span><span class="tok-o">.</span><span class="tok-na">plugin</span><span class="tok-o">.</span><span class="tok-na">springsecurity</span><span class="tok-o">.</span><span class="tok-na">controllerAnnotations</span><span class="tok-o">.</span><span class="tok-na">staticRules</span> <span class="tok-o">=</span> <span class="tok-o">[</span>
	<span class="tok-s1">&#39;/&#39;</span><span class="tok-o">:</span>                              <span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">],</span>
	<span class="tok-s1">&#39;/index&#39;</span><span class="tok-o">:</span>                         <span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">],</span>
	<span class="tok-s1">&#39;/index.gsp&#39;</span><span class="tok-o">:</span>                     <span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">],</span>
	<span class="tok-s1">&#39;/assets/**&#39;</span><span class="tok-o">:</span>                     <span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">],</span>
	<span class="tok-s1">&#39;/**/js/**&#39;</span><span class="tok-o">:</span>                      <span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">],</span>
	<span class="tok-s1">&#39;/**/css/**&#39;</span><span class="tok-o">:</span>                     <span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">],</span>
	<span class="tok-s1">&#39;/**/images/**&#39;</span><span class="tok-o">:</span>                  <span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">],</span>
	<span class="tok-s1">&#39;/**/favicon.ico&#39;</span><span class="tok-o">:</span>                <span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">]</span>
<span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Como te habrás dado cuenta, todos los parámetros de configuración empiezan por <em>grails.plugin.springsecurity</em>. De esta forma podemos especificar por ejemplo que tipo de algoritmo queremos para encriptar la contraseña de los usuarios de la siguiente forma</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">grails</span><span class="tok-o">.</span><span class="tok-na">plugin</span><span class="tok-o">.</span><span class="tok-na">springsecurity</span><span class="tok-o">.</span><span class="tok-na">password</span><span class="tok-o">.</span><span class="tok-na">algorithm</span><span class="tok-o">=</span><span class="tok-s1">&#39;SHA-512&#39;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_clases_de_dominio">7.3. Clases de dominio</h3>
<div class="paragraph">
<p>Como comentábamos anteriormente, cuatro son las clases que se han creado al ejecutar el comando <em>grails s2-quickstart</em>, tres obligatorias (Person, Role y PersonRole) y una opcional (RequestMap). La clase PersonRole es una clase que relaciona que implementa la relación muchos-a-muchos entre la clase Person y la clase Role. Veamos cada una de estas clases en detalle:</p>
</div>
<div class="sect3">
<h4 id="_clase_de_dominio_person">7.3.1. Clase de dominio Person</h4>
<div class="paragraph">
<p>La clase de dominio Person es la clase encargada de almacenar los datos de todos los usuarios de la aplicación. Estos datos son los típicos que desearíamos almacenar de un usuario como son el nombre de usuario y la contraseña. Además, también tiene una serie de propiedades que nos indicará si el usuario está activo o no, si la cuenta ha expirado, si la cuenta está bloqueada o si la contraseña ha expirado.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">es</span><span class="tok-o">.</span><span class="tok-na">ua</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">todo</span>

<span class="tok-kd">class</span> <span class="tok-nc">Person</span> <span class="tok-o">{</span>

	<span class="tok-kd">transient</span> <span class="tok-n">springSecurityService</span>

	<span class="tok-n">String</span> <span class="tok-n">username</span>
	<span class="tok-n">String</span> <span class="tok-n">password</span>
	<span class="tok-kt">boolean</span> <span class="tok-n">enabled</span> <span class="tok-o">=</span> <span class="tok-kc">true</span>
	<span class="tok-kt">boolean</span> <span class="tok-n">accountExpired</span>
	<span class="tok-kt">boolean</span> <span class="tok-n">accountLocked</span>
	<span class="tok-kt">boolean</span> <span class="tok-n">passwordExpired</span>

	<span class="tok-kd">static</span> <span class="tok-n">transients</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-s1">&#39;springSecurityService&#39;</span><span class="tok-o">]</span>

	<span class="tok-kd">static</span> <span class="tok-n">constraints</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
		<span class="tok-n">username</span> <span class="tok-nl">blank:</span> <span class="tok-kc">false</span><span class="tok-o">,</span> <span class="tok-nl">unique:</span> <span class="tok-kc">true</span>
		<span class="tok-n">password</span> <span class="tok-nl">blank:</span> <span class="tok-kc">false</span>
	<span class="tok-o">}</span>

	<span class="tok-kd">static</span> <span class="tok-n">mapping</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
		<span class="tok-n">password</span> <span class="tok-nl">column:</span> <span class="tok-s1">&#39;`password`&#39;</span>
	<span class="tok-o">}</span>

	<span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Role</span><span class="tok-o">&gt;</span> <span class="tok-n">getAuthorities</span><span class="tok-o">()</span> <span class="tok-o">{</span>
		<span class="tok-n">PersonRole</span><span class="tok-o">.</span><span class="tok-na">findAllByPerson</span><span class="tok-o">(</span><span class="tok-k">this</span><span class="tok-o">).</span><span class="tok-na">collect</span> <span class="tok-o">{</span> <span class="tok-n">it</span><span class="tok-o">.</span><span class="tok-na">role</span> <span class="tok-o">}</span>
	<span class="tok-o">}</span>

	<span class="tok-kt">def</span> <span class="tok-nf">beforeInsert</span><span class="tok-o">()</span> <span class="tok-o">{</span>
		<span class="tok-n">encodePassword</span><span class="tok-o">()</span>
	<span class="tok-o">}</span>

	<span class="tok-kt">def</span> <span class="tok-nf">beforeUpdate</span><span class="tok-o">()</span> <span class="tok-o">{</span>
		<span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">isDirty</span><span class="tok-o">(</span><span class="tok-s1">&#39;password&#39;</span><span class="tok-o">))</span> <span class="tok-o">{</span>
			<span class="tok-n">encodePassword</span><span class="tok-o">()</span>
		<span class="tok-o">}</span>
	<span class="tok-o">}</span>

	<span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">encodePassword</span><span class="tok-o">()</span> <span class="tok-o">{</span>
		<span class="tok-n">password</span> <span class="tok-o">=</span> <span class="tok-n">springSecurityService</span><span class="tok-o">?.</span><span class="tok-na">passwordEncoder</span> <span class="tok-o">?</span> <span class="tok-n">springSecurityService</span><span class="tok-o">.</span><span class="tok-na">encodePassword</span><span class="tok-o">(</span><span class="tok-n">password</span><span class="tok-o">)</span> <span class="tok-o">:</span> <span class="tok-n">password</span>
	<span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Además, también se implementa un método llamado <em>getAuthorities()</em> que nos devolverá todos los roles que el usuario tenga asignados. Este método podíamos decir que es análogo a la definición <em>static hasMany = [authorities: Authority]</em> de la forma tradicional.</p>
</div>
<div class="paragraph">
<p>Esta clase podrá ser modificada a nuestro gusto para añadirle tantas propiedades como necesitemos, como por ejemplo, nombre, apellidos o email. Sin embargo, es más conveniente dejar esta clase tal cual está y extenderla utilizando una clase llamada por ejemplo <em>User</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">es</span><span class="tok-o">.</span><span class="tok-na">ua</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">todo</span>

<span class="tok-kd">class</span> <span class="tok-nc">User</span> <span class="tok-kd">extends</span> <span class="tok-n">Person</span><span class="tok-o">{</span>
	<span class="tok-n">String</span> <span class="tok-n">name</span>
	<span class="tok-n">String</span> <span class="tok-n">surnames</span>
	<span class="tok-n">String</span> <span class="tok-n">confirmPassword</span>
	<span class="tok-n">String</span> <span class="tok-n">email</span>
	<span class="tok-n">Date</span> <span class="tok-n">dateOfBirth</span>
	<span class="tok-n">String</span> <span class="tok-n">description</span>

	<span class="tok-kd">static</span> <span class="tok-n">hasMany</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-nl">todos:</span><span class="tok-n">Todo</span><span class="tok-o">]</span>

	<span class="tok-kd">static</span> <span class="tok-n">constraints</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
		<span class="tok-n">name</span><span class="tok-o">(</span><span class="tok-nl">blank:</span><span class="tok-kc">false</span><span class="tok-o">)</span>
		<span class="tok-n">surnames</span><span class="tok-o">(</span><span class="tok-nl">blank:</span><span class="tok-kc">false</span><span class="tok-o">)</span>
		<span class="tok-n">confirmPassword</span><span class="tok-o">(</span><span class="tok-nl">blank:</span><span class="tok-kc">false</span><span class="tok-o">,</span> <span class="tok-nl">password:</span><span class="tok-kc">true</span><span class="tok-o">)</span>
		<span class="tok-n">email</span><span class="tok-o">(</span><span class="tok-nl">blank:</span><span class="tok-kc">false</span><span class="tok-o">,</span> <span class="tok-nl">email:</span><span class="tok-kc">true</span><span class="tok-o">)</span>
		<span class="tok-n">dateOfBirth</span><span class="tok-o">(</span><span class="tok-nl">nullable:</span><span class="tok-kc">true</span><span class="tok-o">,</span> <span class="tok-nl">validator:</span> <span class="tok-o">{</span>
			<span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">it</span><span class="tok-o">?.</span><span class="tok-na">compareTo</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-n">Date</span><span class="tok-o">())</span> <span class="tok-o">&lt;</span> <span class="tok-mi">0</span><span class="tok-o">)</span>
				<span class="tok-k">return</span> <span class="tok-kc">true</span>
			<span class="tok-k">return</span> <span class="tok-kc">false</span>
		<span class="tok-o">})</span>
		<span class="tok-n">description</span><span class="tok-o">(</span><span class="tok-nl">maxSize:</span><span class="tok-mi">1000</span><span class="tok-o">,</span><span class="tok-nl">nullable:</span><span class="tok-kc">true</span><span class="tok-o">)</span>
	<span class="tok-o">}</span>

	<span class="tok-kd">static</span> <span class="tok-n">transients</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-s2">&quot;confirmPassword&quot;</span><span class="tok-o">]</span>

	<span class="tok-n">String</span> <span class="tok-nf">toString</span><span class="tok-o">(){</span>
		<span class="tok-s2">&quot;@${username}&quot;</span>
	<span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Date cuenta de la relación que hemos establecido entre los usuarios y las tareas con <em>static hasMany = [todos:Todo]</em> con lo que habrá también que modificar la clase de domninio <em>Todo</em> para establecer la otra parte de la relación.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">es</span><span class="tok-o">.</span><span class="tok-na">ua</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">todo</span>

<span class="tok-kd">class</span> <span class="tok-nc">Todo</span> <span class="tok-o">{</span>
	<span class="tok-o">...</span>

	<span class="tok-n">User</span> <span class="tok-n">user</span>

	<span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para facilitar la generación de usuarios desde la propia aplicación, vamos a generar las vistas y los controladores referentes a los usuarios con</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">grails</span> <span class="tok-n">generate</span><span class="tok-o">-</span><span class="tok-n">all</span> <span class="tok-n">es</span><span class="tok-o">.</span><span class="tok-na">ua</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">todo</span><span class="tok-o">.</span><span class="tok-na">User</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_clase_de_dominio_role">7.3.2. Clase de dominio Role</h4>
<div class="paragraph">
<p>El plugin spring-security-core necesita de una clase que implemente los diferentes roles que pueden coexistir en nuestra aplicación. Habitualmente, esta clase se encarga de restringir el acceso a determinadas URLs a aquellos usuarios que tengan los permisos adecuados. Un usuario puede tener varios roles asignados que indiquen diferentes niveles de acceso a la aplicación y por lo normal, cada usuario debería tener al menos un rol asignado.</p>
</div>
<div class="paragraph">
<p>También es posible que un usuario no tenga ningún rol asignado (aunque no es muy habitual). En estos casos, cuando un usuario sin ningún rol asignado se identifica en la aplicación, automáticamente se le asigna un rol <em>virtual</em> llamado <em>ROLE_NO_ROLES</em>. Este usuario, sólo podrá acceder a aquellos recursos que no estén <em>asegurados</em>.</p>
</div>
<div class="paragraph">
<p>La clase Role tiene una única propiedad llamada <em>authority</em> de tipo <em>String</em> que será el nombre dado al rol. Esta propiedad debe ser única, tal y como vemos en las restricciones de la clase.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">es</span><span class="tok-o">.</span><span class="tok-na">ua</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">todo</span>

<span class="tok-kd">class</span> <span class="tok-nc">Role</span> <span class="tok-o">{</span>

	<span class="tok-n">String</span> <span class="tok-n">authority</span>

	<span class="tok-kd">static</span> <span class="tok-n">mapping</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
		<span class="tok-n">cache</span> <span class="tok-kc">true</span>
	<span class="tok-o">}</span>

	<span class="tok-kd">static</span> <span class="tok-n">constraints</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
		<span class="tok-n">authority</span> <span class="tok-nl">blank:</span> <span class="tok-kc">false</span><span class="tok-o">,</span> <span class="tok-nl">unique:</span> <span class="tok-kc">true</span>
	<span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_clase_de_dominio_personrole">7.3.3. Clase de dominio PersonRole</h4>
<div class="paragraph">
<p>Para especificar la relación de muchos-a-muchos entre las clases de dominio Person y Role utilizamos una nueva clase llamada PersonRole. Esta clase tiene únicamente dos propiedades que serán las referidas a la clase de dominio Person y a la clase de dominio Role. Además, le especificaremos que la clave primaria de la clase será la composición de ambas propiedades y que no necesitamos almacenar la versión actual del objeto.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">es</span><span class="tok-o">.</span><span class="tok-na">ua</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">todo</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.apache.commons.lang.builder.HashCodeBuilder</span>

<span class="tok-kd">class</span> <span class="tok-nc">PersonRole</span> <span class="tok-kd">implements</span> <span class="tok-n">Serializable</span> <span class="tok-o">{</span>

	<span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-kd">final</span> <span class="tok-kt">long</span> <span class="tok-n">serialVersionUID</span> <span class="tok-o">=</span> <span class="tok-mi">1</span>

	<span class="tok-n">Person</span> <span class="tok-n">person</span>
	<span class="tok-n">Role</span> <span class="tok-n">role</span>

	<span class="tok-kt">boolean</span> <span class="tok-nf">equals</span><span class="tok-o">(</span><span class="tok-n">other</span><span class="tok-o">)</span> <span class="tok-o">{</span>
		<span class="tok-k">if</span> <span class="tok-o">(!(</span><span class="tok-n">other</span> <span class="tok-k">instanceof</span> <span class="tok-n">PersonRole</span><span class="tok-o">))</span> <span class="tok-o">{</span>
			<span class="tok-k">return</span> <span class="tok-kc">false</span>
		<span class="tok-o">}</span>

		<span class="tok-n">other</span><span class="tok-o">.</span><span class="tok-na">person</span><span class="tok-o">?.</span><span class="tok-na">id</span> <span class="tok-o">==</span> <span class="tok-n">person</span><span class="tok-o">?.</span><span class="tok-na">id</span> <span class="tok-o">&amp;&amp;</span>
		<span class="tok-n">other</span><span class="tok-o">.</span><span class="tok-na">role</span><span class="tok-o">?.</span><span class="tok-na">id</span> <span class="tok-o">==</span> <span class="tok-n">role</span><span class="tok-o">?.</span><span class="tok-na">id</span>
	<span class="tok-o">}</span>

	<span class="tok-kt">int</span> <span class="tok-nf">hashCode</span><span class="tok-o">()</span> <span class="tok-o">{</span>
		<span class="tok-kt">def</span> <span class="tok-n">builder</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">HashCodeBuilder</span><span class="tok-o">()</span>
		<span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">person</span><span class="tok-o">)</span> <span class="tok-n">builder</span><span class="tok-o">.</span><span class="tok-na">append</span><span class="tok-o">(</span><span class="tok-n">person</span><span class="tok-o">.</span><span class="tok-na">id</span><span class="tok-o">)</span>
		<span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">role</span><span class="tok-o">)</span> <span class="tok-n">builder</span><span class="tok-o">.</span><span class="tok-na">append</span><span class="tok-o">(</span><span class="tok-n">role</span><span class="tok-o">.</span><span class="tok-na">id</span><span class="tok-o">)</span>
		<span class="tok-n">builder</span><span class="tok-o">.</span><span class="tok-na">toHashCode</span><span class="tok-o">()</span>
	<span class="tok-o">}</span>

	<span class="tok-kd">static</span> <span class="tok-n">PersonRole</span> <span class="tok-nf">get</span><span class="tok-o">(</span><span class="tok-kt">long</span> <span class="tok-n">personId</span><span class="tok-o">,</span> <span class="tok-kt">long</span> <span class="tok-n">roleId</span><span class="tok-o">)</span> <span class="tok-o">{</span>
		<span class="tok-n">PersonRole</span><span class="tok-o">.</span><span class="tok-na">where</span> <span class="tok-o">{</span>
			<span class="tok-n">person</span> <span class="tok-o">==</span> <span class="tok-n">Person</span><span class="tok-o">.</span><span class="tok-na">load</span><span class="tok-o">(</span><span class="tok-n">personId</span><span class="tok-o">)</span> <span class="tok-o">&amp;&amp;</span>
			<span class="tok-n">role</span> <span class="tok-o">==</span> <span class="tok-n">Role</span><span class="tok-o">.</span><span class="tok-na">load</span><span class="tok-o">(</span><span class="tok-n">roleId</span><span class="tok-o">)</span>
		<span class="tok-o">}.</span><span class="tok-na">get</span><span class="tok-o">()</span>
	<span class="tok-o">}</span>

	<span class="tok-kd">static</span> <span class="tok-kt">boolean</span> <span class="tok-nf">exists</span><span class="tok-o">(</span><span class="tok-kt">long</span> <span class="tok-n">personId</span><span class="tok-o">,</span> <span class="tok-kt">long</span> <span class="tok-n">roleId</span><span class="tok-o">)</span> <span class="tok-o">{</span>
		<span class="tok-n">PersonRole</span><span class="tok-o">.</span><span class="tok-na">where</span> <span class="tok-o">{</span>
			<span class="tok-n">person</span> <span class="tok-o">==</span> <span class="tok-n">Person</span><span class="tok-o">.</span><span class="tok-na">load</span><span class="tok-o">(</span><span class="tok-n">personId</span><span class="tok-o">)</span> <span class="tok-o">&amp;&amp;</span>
			<span class="tok-n">role</span> <span class="tok-o">==</span> <span class="tok-n">Role</span><span class="tok-o">.</span><span class="tok-na">load</span><span class="tok-o">(</span><span class="tok-n">roleId</span><span class="tok-o">)</span>
		<span class="tok-o">}.</span><span class="tok-na">count</span><span class="tok-o">()</span> <span class="tok-o">&gt;</span> <span class="tok-mi">0</span>
	<span class="tok-o">}</span>

	<span class="tok-kd">static</span> <span class="tok-n">PersonRole</span> <span class="tok-nf">create</span><span class="tok-o">(</span><span class="tok-n">Person</span> <span class="tok-n">person</span><span class="tok-o">,</span> <span class="tok-n">Role</span> <span class="tok-n">role</span><span class="tok-o">,</span> <span class="tok-kt">boolean</span> <span class="tok-n">flush</span> <span class="tok-o">=</span> <span class="tok-kc">false</span><span class="tok-o">)</span> <span class="tok-o">{</span>
		<span class="tok-kt">def</span> <span class="tok-n">instance</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">PersonRole</span><span class="tok-o">(</span><span class="tok-nl">person:</span> <span class="tok-n">person</span><span class="tok-o">,</span> <span class="tok-nl">role:</span> <span class="tok-n">role</span><span class="tok-o">)</span>
		<span class="tok-n">instance</span><span class="tok-o">.</span><span class="tok-na">save</span><span class="tok-o">(</span><span class="tok-nl">flush:</span> <span class="tok-n">flush</span><span class="tok-o">,</span> <span class="tok-nl">insert:</span> <span class="tok-kc">true</span><span class="tok-o">)</span>
		<span class="tok-n">instance</span>
	<span class="tok-o">}</span>

	<span class="tok-kd">static</span> <span class="tok-kt">boolean</span> <span class="tok-nf">remove</span><span class="tok-o">(</span><span class="tok-n">Person</span> <span class="tok-n">u</span><span class="tok-o">,</span> <span class="tok-n">Role</span> <span class="tok-n">r</span><span class="tok-o">,</span> <span class="tok-kt">boolean</span> <span class="tok-n">flush</span> <span class="tok-o">=</span> <span class="tok-kc">false</span><span class="tok-o">)</span> <span class="tok-o">{</span>
		<span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">u</span> <span class="tok-o">==</span> <span class="tok-kc">null</span> <span class="tok-o">||</span> <span class="tok-n">r</span> <span class="tok-o">==</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-k">return</span> <span class="tok-kc">false</span>

		<span class="tok-kt">int</span> <span class="tok-n">rowCount</span> <span class="tok-o">=</span> <span class="tok-n">PersonRole</span><span class="tok-o">.</span><span class="tok-na">where</span> <span class="tok-o">{</span>
			<span class="tok-n">person</span> <span class="tok-o">==</span> <span class="tok-n">Person</span><span class="tok-o">.</span><span class="tok-na">load</span><span class="tok-o">(</span><span class="tok-n">u</span><span class="tok-o">.</span><span class="tok-na">id</span><span class="tok-o">)</span> <span class="tok-o">&amp;&amp;</span>
			<span class="tok-n">role</span> <span class="tok-o">==</span> <span class="tok-n">Role</span><span class="tok-o">.</span><span class="tok-na">load</span><span class="tok-o">(</span><span class="tok-n">r</span><span class="tok-o">.</span><span class="tok-na">id</span><span class="tok-o">)</span>
		<span class="tok-o">}.</span><span class="tok-na">deleteAll</span><span class="tok-o">()</span>

		<span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">flush</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-n">PersonRole</span><span class="tok-o">.</span><span class="tok-na">withSession</span> <span class="tok-o">{</span> <span class="tok-n">it</span><span class="tok-o">.</span><span class="tok-na">flush</span><span class="tok-o">()</span> <span class="tok-o">}</span> <span class="tok-o">}</span>

		<span class="tok-n">rowCount</span> <span class="tok-o">&gt;</span> <span class="tok-mi">0</span>
	<span class="tok-o">}</span>

	<span class="tok-kd">static</span> <span class="tok-kt">void</span> <span class="tok-nf">removeAll</span><span class="tok-o">(</span><span class="tok-n">Person</span> <span class="tok-n">u</span><span class="tok-o">,</span> <span class="tok-kt">boolean</span> <span class="tok-n">flush</span> <span class="tok-o">=</span> <span class="tok-kc">false</span><span class="tok-o">)</span> <span class="tok-o">{</span>
		<span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">u</span> <span class="tok-o">==</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-k">return</span>

		<span class="tok-n">PersonRole</span><span class="tok-o">.</span><span class="tok-na">where</span> <span class="tok-o">{</span>
			<span class="tok-n">person</span> <span class="tok-o">==</span> <span class="tok-n">Person</span><span class="tok-o">.</span><span class="tok-na">load</span><span class="tok-o">(</span><span class="tok-n">u</span><span class="tok-o">.</span><span class="tok-na">id</span><span class="tok-o">)</span>
		<span class="tok-o">}.</span><span class="tok-na">deleteAll</span><span class="tok-o">()</span>

		<span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">flush</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-n">PersonRole</span><span class="tok-o">.</span><span class="tok-na">withSession</span> <span class="tok-o">{</span> <span class="tok-n">it</span><span class="tok-o">.</span><span class="tok-na">flush</span><span class="tok-o">()</span> <span class="tok-o">}</span> <span class="tok-o">}</span>
	<span class="tok-o">}</span>

	<span class="tok-kd">static</span> <span class="tok-kt">void</span> <span class="tok-nf">removeAll</span><span class="tok-o">(</span><span class="tok-n">Role</span> <span class="tok-n">r</span><span class="tok-o">,</span> <span class="tok-kt">boolean</span> <span class="tok-n">flush</span> <span class="tok-o">=</span> <span class="tok-kc">false</span><span class="tok-o">)</span> <span class="tok-o">{</span>
		<span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">r</span> <span class="tok-o">==</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-k">return</span>

		<span class="tok-n">PersonRole</span><span class="tok-o">.</span><span class="tok-na">where</span> <span class="tok-o">{</span>
			<span class="tok-n">role</span> <span class="tok-o">==</span> <span class="tok-n">Role</span><span class="tok-o">.</span><span class="tok-na">load</span><span class="tok-o">(</span><span class="tok-n">r</span><span class="tok-o">.</span><span class="tok-na">id</span><span class="tok-o">)</span>
		<span class="tok-o">}.</span><span class="tok-na">deleteAll</span><span class="tok-o">()</span>

		<span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">flush</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-n">PersonRole</span><span class="tok-o">.</span><span class="tok-na">withSession</span> <span class="tok-o">{</span> <span class="tok-n">it</span><span class="tok-o">.</span><span class="tok-na">flush</span><span class="tok-o">()</span> <span class="tok-o">}</span> <span class="tok-o">}</span>
	<span class="tok-o">}</span>

	<span class="tok-kd">static</span> <span class="tok-n">constraints</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
		<span class="tok-n">role</span> <span class="tok-nl">validator:</span> <span class="tok-o">{</span> <span class="tok-n">Role</span> <span class="tok-n">r</span><span class="tok-o">,</span> <span class="tok-n">PersonRole</span> <span class="tok-n">ur</span> <span class="tok-o">-&gt;</span>
			<span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">ur</span><span class="tok-o">.</span><span class="tok-na">person</span> <span class="tok-o">==</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-k">return</span>
			<span class="tok-kt">boolean</span> <span class="tok-n">existing</span> <span class="tok-o">=</span> <span class="tok-kc">false</span>
			<span class="tok-n">PersonRole</span><span class="tok-o">.</span><span class="tok-na">withNewSession</span> <span class="tok-o">{</span>
				<span class="tok-n">existing</span> <span class="tok-o">=</span> <span class="tok-n">PersonRole</span><span class="tok-o">.</span><span class="tok-na">exists</span><span class="tok-o">(</span><span class="tok-n">ur</span><span class="tok-o">.</span><span class="tok-na">person</span><span class="tok-o">.</span><span class="tok-na">id</span><span class="tok-o">,</span> <span class="tok-n">r</span><span class="tok-o">.</span><span class="tok-na">id</span><span class="tok-o">)</span>
			<span class="tok-o">}</span>
			<span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">existing</span><span class="tok-o">)</span> <span class="tok-o">{</span>
				<span class="tok-k">return</span> <span class="tok-s1">&#39;userRole.exists&#39;</span>
			<span class="tok-o">}</span>
		<span class="tok-o">}</span>
	<span class="tok-o">}</span>

	<span class="tok-kd">static</span> <span class="tok-n">mapping</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
		<span class="tok-n">id</span> <span class="tok-nl">composite:</span> <span class="tok-o">[</span><span class="tok-s1">&#39;role&#39;</span><span class="tok-o">,</span> <span class="tok-s1">&#39;person&#39;</span><span class="tok-o">]</span>
		<span class="tok-n">version</span> <span class="tok-kc">false</span>
	<span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>También se han creado una serie de métodos que facilitan la asignación de roles a usuario así como la revocación. Con esto, suponiendo que ya tenemos creados un rol y un usuario, podemos asignar o revocar un rol a un usuario de la siguiente forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">User</span> <span class="tok-n">user</span> <span class="tok-o">=</span> <span class="tok-o">...</span>
<span class="tok-n">Role</span> <span class="tok-n">role</span> <span class="tok-o">=</span> <span class="tok-o">...</span>
<span class="tok-c1">//Asignación de rol a un usuario</span>
<span class="tok-n">UserRole</span><span class="tok-o">.</span><span class="tok-na">create</span> <span class="tok-n">user</span><span class="tok-o">,</span> <span class="tok-n">role</span>
<span class="tok-c1">//Asignación de rol a un usuario indicándole el atributo flush</span>
<span class="tok-n">UserRole</span><span class="tok-o">.</span><span class="tok-na">create</span> <span class="tok-n">user</span><span class="tok-o">,</span> <span class="tok-n">role</span><span class="tok-o">,</span> <span class="tok-kc">true</span>

<span class="tok-c1">//Revocación de un rol a un usuario</span>
<span class="tok-n">User</span> <span class="tok-n">user</span> <span class="tok-o">=</span> <span class="tok-o">...</span>
<span class="tok-n">Role</span> <span class="tok-n">role</span> <span class="tok-o">=</span> <span class="tok-o">...</span>
<span class="tok-n">UserRole</span><span class="tok-o">.</span><span class="tok-na">remove</span> <span class="tok-n">user</span><span class="tok-o">,</span> <span class="tok-n">role</span>
<span class="tok-c1">//Revocación de un rol a un usuario indicándole el atributo flush</span>
<span class="tok-n">UserRole</span><span class="tok-o">.</span><span class="tok-na">remove</span> <span class="tok-n">user</span><span class="tok-o">,</span> <span class="tok-n">role</span><span class="tok-o">,</span> <span class="tok-kc">true</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_clase_de_dominio_requestmap">7.3.4. Clase de dominio RequestMap</h4>
<div class="paragraph">
<p>La clase de dominio <em>RequestMap</em> es una clase opcional que nos permite registrar que peticiones queremos asegurar introduciéndolas en la base de datos en lugar de tener que especificarlo en el archivo de configuración <em>Config.groovy</em> o mediante anotaciones (lo veremos a continuación).</p>
</div>
<div class="paragraph">
<p>Esta opción nos permite configurar estas entradas en tiempo de ejecución y podremos añadir, modificar o eliminar entradas sin tener que reiniciar la aplicación. Esta es la clase generada:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">es</span><span class="tok-o">.</span><span class="tok-na">ua</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">todo</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.springframework.http.HttpMethod</span>

<span class="tok-kd">class</span> <span class="tok-nc">RequestMap</span> <span class="tok-o">{</span>

	<span class="tok-n">String</span> <span class="tok-n">url</span>
	<span class="tok-n">String</span> <span class="tok-n">configAttribute</span>
	<span class="tok-n">HttpMethod</span> <span class="tok-n">httpMethod</span>

	<span class="tok-kd">static</span> <span class="tok-n">mapping</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
		<span class="tok-n">cache</span> <span class="tok-kc">true</span>
	<span class="tok-o">}</span>

	<span class="tok-kd">static</span> <span class="tok-n">constraints</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
		<span class="tok-n">url</span> <span class="tok-nl">blank:</span> <span class="tok-kc">false</span><span class="tok-o">,</span> <span class="tok-nl">unique:</span> <span class="tok-s1">&#39;httpMethod&#39;</span>
		<span class="tok-n">configAttribute</span> <span class="tok-nl">blank:</span> <span class="tok-kc">false</span>
		<span class="tok-n">httpMethod</span> <span class="tok-nl">nullable:</span> <span class="tok-kc">true</span>
	<span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El campo <em>url</em> será la dirección accedida a asegurar mientras que el campo <em>configAttributeField</em> indicará los roles permitidos para acceder a esa dirección url. También podemos especificar que método HTTP vamos a permitir. Si no lo asignamos, significará que podemos utilizar cualquier método.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_asegurar_peticiones">7.4. Asegurar peticiones</h3>
<div class="paragraph">
<p>En esta sección vamos a ver las diversas formas que nos permite el plugin de Spring Security para configurar las diferentes peticiones que necesitemos asegurar en nuestra aplicación. Básicamente, tenemos cuatro formas de hacer esto, de las cuales debemos elegir sólo una para espeficar que direcciones queremos asegurar en nuestra aplicación:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Anotaciones</p>
</li>
<li>
<p>Archivo de configuración Config.groovy</p>
</li>
<li>
<p>Instancias de la clase RequestMap</p>
</li>
<li>
<p>Expresiones específicas</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Pero antes de ver cada una de estas formas, veamos unos cuantos aspectos interesantes. Habitualmente, las aplicaciones web son públicas con algunas páginas privadas que son las que aseguraremos. Sin embargo, si la mayor parte de nuestra aplicación es privada, podemos usar la aproximación pesimista para denegar el acceso a todas las urls que no tengan una regla configurada. Esto lo podemos hacer especificando en el archivo de configuración <em>Config.groovy</em> el siguiente valor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">grails</span><span class="tok-o">.</span><span class="tok-na">plugin</span><span class="tok-o">.</span><span class="tok-na">springsecurity</span><span class="tok-o">.</span><span class="tok-na">rejectIfNoRule</span> <span class="tok-o">=</span> <span class="tok-kc">true</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>De esta forma, cualquier url que no tenga una regla especificada, será denegada para cualquier usuario.</p>
</div>
<div class="paragraph">
<p>Cualquier dirección que necesitemos asegurar debe tener especificada una regla. Por ejemplo, podremos proteger la url <em>/todo/tag/**</em> para que sólo los usuarios con el rol <em>ROLE_ADMIN</em> puedan crear etiquetas. Pero además, estas entradas podemos combinarlas con una serie de tokens predefinidos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>IS_AUTHENTICATED_ANONYMOUSLY</em>, indica que cualquier usuario podría acceder a esa url.</p>
</li>
<li>
<p><em>IS_AUTHENTICATED_REMEMBERED</em>, indica que el usuario se ha autenticado en la aplicación con la opción de <em>remember me</em>.</p>
</li>
<li>
<p><em>IS_AUTHENTICATED_FULLY</em>, indica que el usuario se ha identificado completando el formulario de autenticación.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_anotaciones">7.4.1. Anotaciones</h4>
<div class="paragraph">
<p>Si queremos utilizar este método en nuestra aplicación, debemos especificar el siguiente parámetro en el archivo de configuración <em>Config.groovy</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">grails</span><span class="tok-o">.</span><span class="tok-na">plugin</span><span class="tok-o">.</span><span class="tok-na">springsecurity</span><span class="tok-o">.</span><span class="tok-na">securityConfigType</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;Annotation&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos especificar anotaciones tanto a nivel de clase como a nivel de método. En caso de que se especifiquen reglas tanto a nivel de clase como a nivel de método, serán estas últimas las que se apliquen.</p>
</div>
<div class="paragraph">
<p>En el siguiente ejemplo especificamos la seguridad a nivel de método:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">com</span><span class="tok-o">.</span><span class="tok-na">mycompany</span><span class="tok-o">.</span><span class="tok-na">myapp</span>
<span class="tok-kn">import</span> <span class="tok-nn">grails.plugin.springsecurity.annotation.Secured</span>

<span class="tok-kd">class</span> <span class="tok-nc">SecureAnnotatedController</span> <span class="tok-o">{</span>

   <span class="tok-nd">@Secured</span><span class="tok-o">([</span><span class="tok-s1">&#39;ROLE_ADMIN&#39;</span><span class="tok-o">])</span>
   <span class="tok-kt">def</span> <span class="tok-nf">index</span><span class="tok-o">()</span> <span class="tok-o">{</span>
      <span class="tok-n">render</span> <span class="tok-s1">&#39;you have ROLE_ADMIN&#39;</span>
   <span class="tok-o">}</span>

   <span class="tok-nd">@Secured</span><span class="tok-o">([</span><span class="tok-s1">&#39;ROLE_ADMIN&#39;</span><span class="tok-o">,</span> <span class="tok-s1">&#39;ROLE_SUPERUSER&#39;</span><span class="tok-o">])</span>
   <span class="tok-kt">def</span> <span class="tok-nf">adminEither</span><span class="tok-o">()</span> <span class="tok-o">{</span>
      <span class="tok-n">render</span> <span class="tok-s1">&#39;you have ROLE_ADMIN or SUPERUSER&#39;</span>
   <span class="tok-o">}</span>

   <span class="tok-kt">def</span> <span class="tok-nf">anybody</span><span class="tok-o">()</span> <span class="tok-o">{</span>
      <span class="tok-n">render</span> <span class="tok-s1">&#39;anyone can see this&#39;</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pero también podemos especificarlo a nivel de clase:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">com</span><span class="tok-o">.</span><span class="tok-na">mycompany</span><span class="tok-o">.</span><span class="tok-na">myapp</span>
<span class="tok-kn">import</span> <span class="tok-nn">grails.plugin.springsecurity.annotation.Secured</span>

<span class="tok-nd">@Secured</span><span class="tok-o">([</span><span class="tok-s1">&#39;ROLE_ADMIN&#39;</span><span class="tok-o">])</span>
<span class="tok-kd">class</span> <span class="tok-nc">SecureClassAnnotatedController</span> <span class="tok-o">{</span>

   <span class="tok-kt">def</span> <span class="tok-nf">index</span><span class="tok-o">()</span> <span class="tok-o">{</span>
      <span class="tok-n">render</span> <span class="tok-s1">&#39;index: you have ROLE_ADMIN&#39;</span>
   <span class="tok-o">}</span>

   <span class="tok-kt">def</span> <span class="tok-nf">otherAction</span><span class="tok-o">()</span> <span class="tok-o">{</span>
      <span class="tok-n">render</span> <span class="tok-s1">&#39;otherAction: you have ROLE_ADMIN&#39;</span>
   <span class="tok-o">}</span>

   <span class="tok-nd">@Secured</span><span class="tok-o">([</span><span class="tok-s1">&#39;ROLE_SUPERUSER&#39;</span><span class="tok-o">])</span>
   <span class="tok-kt">def</span> <span class="tok-nf">super</span><span class="tok-o">()</span> <span class="tok-o">{</span>
      <span class="tok-n">render</span> <span class="tok-s1">&#39;super: you have ROLE_SUPERUSER&#39;</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En ocasiones, necesitaremos incluso definir reglas para proteger el acceso a determinados directorios, como por ejemplo, los directorios de imágenes o los archivos javascript. Para esto, debemos especificar reglas estáticas en el archivo de configuración <em>Config.groovy</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">grails</span><span class="tok-o">.</span><span class="tok-na">plugin</span><span class="tok-o">.</span><span class="tok-na">springsecurity</span><span class="tok-o">.</span><span class="tok-na">controllerAnnotations</span><span class="tok-o">.</span><span class="tok-na">staticRules</span> <span class="tok-o">=</span> <span class="tok-o">[</span>
   <span class="tok-s1">&#39;/js/admin/**&#39;</span><span class="tok-o">:</span> <span class="tok-o">[</span><span class="tok-s1">&#39;ROLE_ADMIN&#39;</span><span class="tok-o">],</span>
   <span class="tok-s1">&#39;/images/**&#39;</span><span class="tok-o">:</span> <span class="tok-o">[</span><span class="tok-s1">&#39;ROLE_ADMIN&#39;</span><span class="tok-o">]</span>
<span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_archivo_de_configuración_config_groovy">7.4.2. Archivo de configuración Config.groovy</h4>
<div class="paragraph">
<p>Para poder utilizar este método, debemos especificar en el archivo de configuración <em>Config.groovy</em> el siguiente parámetro:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">grails</span><span class="tok-o">.</span><span class="tok-na">plugin</span><span class="tok-o">.</span><span class="tok-na">springsecurity</span><span class="tok-o">.</span><span class="tok-na">securityConfigType</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;InterceptUrlMap&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Posteriormente, lo único que debemos hacer es especificar en el archivo <em>Config.groovy</em> todas las reglas que necesitemos de la siguiente forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">grails</span><span class="tok-o">.</span><span class="tok-na">plugin</span><span class="tok-o">.</span><span class="tok-na">springsecurity</span><span class="tok-o">.</span><span class="tok-na">interceptUrlMap</span> <span class="tok-o">=</span> <span class="tok-o">[</span>
   <span class="tok-s1">&#39;/&#39;</span><span class="tok-o">:</span>                  <span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">],</span>
   <span class="tok-s1">&#39;/index&#39;</span><span class="tok-o">:</span>             <span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">],</span>
   <span class="tok-s1">&#39;/index.gsp&#39;</span><span class="tok-o">:</span>         <span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">],</span>
   <span class="tok-s1">&#39;/assets/**&#39;</span><span class="tok-o">:</span>         <span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">],</span>
   <span class="tok-s1">&#39;/**/js/**&#39;</span><span class="tok-o">:</span>          <span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">],</span>
   <span class="tok-s1">&#39;/**/css/**&#39;</span><span class="tok-o">:</span>         <span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">],</span>
   <span class="tok-s1">&#39;/**/images/**&#39;</span><span class="tok-o">:</span>      <span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">],</span>
   <span class="tok-s1">&#39;/**/favicon.ico&#39;</span><span class="tok-o">:</span>    <span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">],</span>
   <span class="tok-s1">&#39;/login/**&#39;</span><span class="tok-o">:</span>          <span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">],</span>
   <span class="tok-s1">&#39;/logout/**&#39;</span><span class="tok-o">:</span>         <span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">],</span>
   <span class="tok-s1">&#39;/secure/**&#39;</span><span class="tok-o">:</span>         <span class="tok-o">[</span><span class="tok-s1">&#39;ROLE_ADMIN&#39;</span><span class="tok-o">],</span>
   <span class="tok-s1">&#39;/finance/**&#39;</span><span class="tok-o">:</span>        <span class="tok-o">[</span><span class="tok-s1">&#39;ROLE_FINANCE&#39;</span><span class="tok-o">,</span> <span class="tok-s1">&#39;isFullyAuthenticated()&#39;</span><span class="tok-o">],</span>
<span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En este listado, es importante que especifiquemos las reglas en el orden correcto y esto se consigue siendo más específico para pasar posteriormente a ser más general. El siguiente ejemplo sería incorrecto, puesto que estaríamos dando permisos a los usuarios de tipo ROLE_ADMIN a las direcciones <em>/secure/reallysecure/**</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-s1">&#39;/secure/**&#39;</span><span class="tok-o">:</span>              <span class="tok-o">[</span><span class="tok-s1">&#39;ROLE_ADMIN&#39;</span><span class="tok-o">,</span> <span class="tok-s1">&#39;ROLE_SUPERUSER&#39;</span><span class="tok-o">],</span>
<span class="tok-s1">&#39;/secure/reallysecure/**&#39;</span><span class="tok-o">:</span> <span class="tok-o">[</span><span class="tok-s1">&#39;ROLE_SUPERUSER&#39;</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si un usuario de tipo ROLE_ADMIN intentase acceder a la dirección <em>/secure/reallysecure/list</em> se le daría acceso sin ningún problema puesto que casaría con la primera regla encontrada. La solución correcta sería la siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-s1">&#39;/secure/reallysecure/**&#39;</span><span class="tok-o">:</span> <span class="tok-o">[</span><span class="tok-s1">&#39;ROLE_SUPERUSER&#39;</span><span class="tok-o">]</span>
<span class="tok-s1">&#39;/secure/**&#39;</span><span class="tok-o">:</span>              <span class="tok-o">[</span><span class="tok-s1">&#39;ROLE_ADMIN&#39;</span><span class="tok-o">,</span> <span class="tok-s1">&#39;ROLE_SUPERUSER&#39;</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_instancias_de_la_clase_requestmap">7.4.3. Instancias de la clase RequestMap</h4>
<div class="paragraph">
<p>Con esta forma, almacenaremos en la base de datos todas las urls que queremos proteger junto con la regla que debe cumplir, de forma muy similar a como hemos visto en el anterior apartado.</p>
</div>
<div class="paragraph">
<p>Lo primero que debemos hacer es especificar que utilizaremos este método en el archivo de configuración <em>Config.groovy</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">grails</span><span class="tok-o">.</span><span class="tok-na">plugin</span><span class="tok-o">.</span><span class="tok-na">springsecurity</span><span class="tok-o">.</span><span class="tok-na">securityConfigType</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;Requestmap&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Posteriormente, podemos especificar estas urls junto con sus reglas en el archivo <em>BootStrap.groovy</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">url</span> <span class="tok-k">in</span> <span class="tok-o">[</span>
      <span class="tok-s1">&#39;/&#39;</span><span class="tok-o">,</span> <span class="tok-s1">&#39;/index&#39;</span><span class="tok-o">,</span> <span class="tok-s1">&#39;/index.gsp&#39;</span><span class="tok-o">,</span> <span class="tok-s1">&#39;/**/favicon.ico&#39;</span><span class="tok-o">,</span>
      <span class="tok-s1">&#39;/assets/**&#39;</span><span class="tok-o">,</span> <span class="tok-s1">&#39;/**/js/**&#39;</span><span class="tok-o">,</span> <span class="tok-s1">&#39;/**/css/**&#39;</span><span class="tok-o">,</span> <span class="tok-s1">&#39;/**/images/**&#39;</span><span class="tok-o">,</span>
      <span class="tok-s1">&#39;/login&#39;</span><span class="tok-o">,</span> <span class="tok-s1">&#39;/login.*&#39;</span><span class="tok-o">,</span> <span class="tok-s1">&#39;/login/*&#39;</span><span class="tok-o">,</span>
      <span class="tok-s1">&#39;/logout&#39;</span><span class="tok-o">,</span> <span class="tok-s1">&#39;/logout.*&#39;</span><span class="tok-o">,</span> <span class="tok-s1">&#39;/logout/*&#39;</span><span class="tok-o">])</span> <span class="tok-o">{</span>
   <span class="tok-k">new</span> <span class="tok-nf">Requestmap</span><span class="tok-o">(</span><span class="tok-nl">url:</span> <span class="tok-n">url</span><span class="tok-o">,</span> <span class="tok-nl">configAttribute:</span> <span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">).</span><span class="tok-na">save</span><span class="tok-o">()</span>
<span class="tok-o">}</span>
<span class="tok-k">new</span> <span class="tok-nf">Requestmap</span><span class="tok-o">(</span><span class="tok-nl">url:</span> <span class="tok-s1">&#39;/profile/**&#39;</span><span class="tok-o">,</span>    <span class="tok-nl">configAttribute:</span> <span class="tok-s1">&#39;ROLE_USER&#39;</span><span class="tok-o">).</span><span class="tok-na">save</span><span class="tok-o">()</span>
<span class="tok-k">new</span> <span class="tok-nf">Requestmap</span><span class="tok-o">(</span><span class="tok-nl">url:</span> <span class="tok-s1">&#39;/admin/**&#39;</span><span class="tok-o">,</span>      <span class="tok-nl">configAttribute:</span> <span class="tok-s1">&#39;ROLE_ADMIN&#39;</span><span class="tok-o">).</span><span class="tok-na">save</span><span class="tok-o">()</span>
<span class="tok-k">new</span> <span class="tok-nf">Requestmap</span><span class="tok-o">(</span><span class="tok-nl">url:</span> <span class="tok-s1">&#39;/admin/role/**&#39;</span><span class="tok-o">,</span> <span class="tok-nl">configAttribute:</span> <span class="tok-s1">&#39;ROLE_SUPERVISOR&#39;</span><span class="tok-o">).</span><span class="tok-na">save</span><span class="tok-o">()</span>
<span class="tok-k">new</span> <span class="tok-nf">Requestmap</span><span class="tok-o">(</span><span class="tok-nl">url:</span> <span class="tok-s1">&#39;/admin/user/**&#39;</span><span class="tok-o">,</span> <span class="tok-nl">configAttribute:</span> <span class="tok-s1">&#39;ROLE_ADMIN,ROLE_SUPERVISOR&#39;</span><span class="tok-o">).</span><span class="tok-na">save</span><span class="tok-o">()</span>
<span class="tok-k">new</span> <span class="tok-nf">Requestmap</span><span class="tok-o">(</span><span class="tok-nl">url:</span> <span class="tok-s1">&#39;/j_spring_security_switch_user&#39;</span><span class="tok-o">,</span>
               <span class="tok-nl">configAttribute:</span> <span class="tok-s1">&#39;ROLE_SWITCH_USER,isFullyAuthenticated()&#39;</span><span class="tok-o">).</span><span class="tok-na">save</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A diferencia del método anterior, en esta ocasión no es necesario que tengamos en cuenta el orden de las reglas, ya que será el propio plugin quien se encargue de calcular que regla es la más específica.</p>
</div>
<div class="paragraph">
<p>Por defecto, las reglas especificadas de esta forma son cacheadas en la aplicación, con lo que debemos tener en cuenta que cuando creemos, modifiquemos o eliminemos una regla, deberemos actualizar la caché para que se tengan en cuenta los cambios introducidos. Esto lo podemos hacer con el método <em>clearCachedRequestmaps()</em> del servicio <em>springSecurityService</em>, tal y como vemos en el siguiente ejemplo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">RequestmapController</span> <span class="tok-o">{</span>
   <span class="tok-kt">def</span> <span class="tok-n">springSecurityService</span>

   <span class="tok-o">...</span>

   <span class="tok-kt">def</span> <span class="tok-nf">save</span><span class="tok-o">()</span> <span class="tok-o">{</span>
      <span class="tok-kt">def</span> <span class="tok-n">requestmapInstance</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Requestmap</span><span class="tok-o">(</span><span class="tok-n">params</span><span class="tok-o">)</span>
      <span class="tok-k">if</span> <span class="tok-o">(!</span><span class="tok-n">requestmapInstance</span><span class="tok-o">.</span><span class="tok-na">save</span><span class="tok-o">(</span><span class="tok-nl">flush:</span> <span class="tok-kc">true</span><span class="tok-o">))</span> <span class="tok-o">{</span>
         <span class="tok-n">render</span> <span class="tok-nl">view:</span> <span class="tok-s1">&#39;create&#39;</span><span class="tok-o">,</span> <span class="tok-nl">model:</span> <span class="tok-o">[</span><span class="tok-nl">requestmapInstance:</span> <span class="tok-n">requestmapInstance</span><span class="tok-o">]</span>
         <span class="tok-k">return</span>
      <span class="tok-o">}</span>

      <span class="tok-n">springSecurityService</span><span class="tok-o">.</span><span class="tok-na">clearCachedRequestmaps</span><span class="tok-o">()</span>

      <span class="tok-n">flash</span><span class="tok-o">.</span><span class="tok-na">message</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;${message(code: &#39;default.created.message&#39;, args: [message(code: &#39;requestmap.label&#39;, default: &#39;Requestmap&#39;), requestmapInstance.id])}&quot;</span>
      <span class="tok-n">redirect</span> <span class="tok-nl">action:</span> <span class="tok-s1">&#39;show&#39;</span><span class="tok-o">,</span> <span class="tok-nl">id:</span> <span class="tok-n">requestmapInstance</span><span class="tok-o">.</span><span class="tok-na">id</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_expresiones_específicas">7.4.4. Expresiones específicas</h4>
<div class="paragraph">
<p>En Spring Security podemos utilizar también <em>Spring Expression Language (SpEL)</em> para especificar las reglas de acceso a determinadas partes de nuestra aplicación. Mediante este lenguaje, vamos a poder ser algo más específicos. Veamos el mismo ejemplo utilizando cualquiera de los métodos que acabamos de ver. Empecemos por las anotaciones:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">com</span><span class="tok-o">.</span><span class="tok-na">yourcompany</span><span class="tok-o">.</span><span class="tok-na">yourapp</span>
<span class="tok-kn">import</span> <span class="tok-nn">grails.plugin.springsecurity.annotation.Secured</span>

<span class="tok-kd">class</span> <span class="tok-nc">SecureController</span> <span class="tok-o">{</span>

   <span class="tok-nd">@Secured</span><span class="tok-o">([</span><span class="tok-s2">&quot;hasRole(&#39;ROLE_ADMIN&#39;)&quot;</span><span class="tok-o">])</span>
   <span class="tok-kt">def</span> <span class="tok-nf">someAction</span><span class="tok-o">()</span> <span class="tok-o">{</span>
      <span class="tok-o">...</span>
   <span class="tok-o">}</span>

   <span class="tok-nd">@Secured</span><span class="tok-o">([</span><span class="tok-s2">&quot;authentication.name == &#39;ralph&#39;&quot;</span><span class="tok-o">])</span>
   <span class="tok-kt">def</span> <span class="tok-nf">someOtherAction</span><span class="tok-o">()</span> <span class="tok-o">{</span>
      <span class="tok-o">...</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Sigamos con el método de almacenamiento de instancias de la clase RequestMap.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-k">new</span> <span class="tok-nf">Requestmap</span><span class="tok-o">(</span><span class="tok-nl">url:</span> <span class="tok-s2">&quot;/secure/someAction&quot;</span><span class="tok-o">,</span>
               <span class="tok-nl">configAttribute:</span> <span class="tok-s2">&quot;hasRole(&#39;ROLE_ADMIN&#39;)&quot;</span><span class="tok-o">).</span><span class="tok-na">save</span><span class="tok-o">()</span>
<span class="tok-k">new</span> <span class="tok-nf">Requestmap</span><span class="tok-o">(</span><span class="tok-nl">url:</span> <span class="tok-s2">&quot;/secure/someOtherAction&quot;</span><span class="tok-o">,</span>
               <span class="tok-nl">configAttribute:</span> <span class="tok-s2">&quot;authentication.name == &#39;ralph&#39;&quot;</span><span class="tok-o">).</span><span class="tok-na">save</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Terminemos por la modificación del archivo de configuración <em>Config.groovy</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">grails</span><span class="tok-o">.</span><span class="tok-na">plugin</span><span class="tok-o">.</span><span class="tok-na">springsecurity</span><span class="tok-o">.</span><span class="tok-na">interceptUrlMap</span> <span class="tok-o">=</span> <span class="tok-o">[</span>
   <span class="tok-s1">&#39;/secure/someAction&#39;</span><span class="tok-o">:</span>      <span class="tok-o">[</span><span class="tok-s2">&quot;hasRole(&#39;ROLE_ADMIN&#39;)&quot;</span><span class="tok-o">],</span>
   <span class="tok-s1">&#39;/secure/someOtherAction&#39;</span><span class="tok-o">:</span> <span class="tok-o">[</span><span class="tok-s2">&quot;authentication.name == &#39;ralph&#39;&quot;</span><span class="tok-o">]</span>
<span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Aquí tienes una tabla con las expresiones que podemos utilizar:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Expresión</th>
<th class="tableblock halign-left valign-top">Descripción</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">hasRole(role)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Devuelve cierto si el usuario tiene asignado este rol</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">hasAnyRole([role1,role2])</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Devuelve cierto si el usuario tiene asignado cualquiera de los roles pasados por parámetro</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">principal</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Devuelve los datos del usuario registrado</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">authentication</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Devuelve todos los datos relativos a la autenticación</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">permitAll</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Siempre devuelve cierto</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">denyAll</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Siempre devuelve falso</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">isAnonymous()</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Devuelve cierto si el usuario actual es anónimo</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">isRememberMe()</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Devuelve cierto si el usuario ha entrado con la opción <em>remember me</em></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">isAuthenticated()</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Devuelve cierto si el usuario no es anónimo</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">isFullyAuthenticated()</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Devuelve cierto si el usuario no es anónimo o no ha entrado con la opción <em>remember me</em></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">request</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">La petición HTTP, permitiendo expresiones como <em>isFullyAuthenticated() &amp;&amp; request.getMethod().equals('OPTIONS')</em></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>La siguiente tabla muestra las equivalencias si lo hacemos de forma tradicional o mediante las expresiones <em>SpEL</em>.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Modo tradicional</th>
<th class="tableblock halign-left valign-top">Expresión</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">ROLE_ADMIN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">hasRole('ROLE_ADMIN')</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">ROLE_USER, ROLE_ADMIN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">hasAnyRole('ROLE_USER','ROLE_ADMIN')</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">ROLE_ADMIN, IS_AUTHENTICATED_FULLY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">hasRole('ROLE_ADMIN') and isFullyAuthenticated()</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">IS_AUTHENTICATED_ANONYMOUSLY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">permitAll</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">IS_AUTHENTICATED_REMEMBERED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">isAnonymous() or isRememberMe()</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">IS_AUTHENTICATED_FULLY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">isFullyAuthenticated()</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_aspectos_importantes">7.4.5. Aspectos importantes</h4>
<div class="paragraph">
<p>Como veremos más adelante, el plugin utiliza dos controladores para gestionar el proceso de <em>login</em> y <em>logout</em> del sistema. Estos controladores se llaman <em>LoginController</em> y <em>LogoutController</em>. Cualquier método de estos dos controladores debe ser accesible por cualquer usuario. Además, también debemos de dar acceso global a determinados recursos de nuestra aplicación.</p>
</div>
<div class="paragraph">
<p>Teniendo esto en cuenta, en función del método escogido para proteger nuestra aplicación, deberemos añadir una serie de reglas en nuestro archivo de configuración <em>Config.groovy</em>.</p>
</div>
<div class="sect4">
<h5 id="_mediante_anotaciones">Mediante anotaciones</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">grails</span><span class="tok-o">.</span><span class="tok-na">plugin</span><span class="tok-o">.</span><span class="tok-na">springsecurity</span><span class="tok-o">.</span><span class="tok-na">securityConfigType</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;Annotation&#39;</span>
<span class="tok-n">grails</span><span class="tok-o">.</span><span class="tok-na">plugin</span><span class="tok-o">.</span><span class="tok-na">springsecurity</span><span class="tok-o">.</span><span class="tok-na">controllerAnnotations</span><span class="tok-o">.</span><span class="tok-na">staticRules</span> <span class="tok-o">=</span> <span class="tok-o">[</span>
	<span class="tok-s1">&#39;/&#39;</span><span class="tok-o">:</span>                              	<span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">],</span>
	<span class="tok-s1">&#39;/index&#39;</span><span class="tok-o">:</span>                         	<span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">],</span>
	<span class="tok-s1">&#39;/index.gsp&#39;</span><span class="tok-o">:</span>                     	<span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">],</span>
	<span class="tok-s1">&#39;/assets/**&#39;</span><span class="tok-o">:</span>                     	<span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">],</span>
	<span class="tok-s1">&#39;/**/js/**&#39;</span><span class="tok-o">:</span>                      	<span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">],</span>
	<span class="tok-s1">&#39;/**/css/**&#39;</span><span class="tok-o">:</span>                     	<span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">],</span>
	<span class="tok-s1">&#39;/**/images/**&#39;</span><span class="tok-o">:</span>                  	<span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">],</span>
	<span class="tok-s1">&#39;/**/favicon.ico&#39;</span><span class="tok-o">:</span>                	<span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">],</span>
	<span class="tok-s1">&#39;/login/**&#39;</span><span class="tok-o">:</span>						<span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">],</span>
	<span class="tok-s1">&#39;/logout/**&#39;</span><span class="tok-o">:</span>                		<span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">],</span>
	<span class="tok-s1">&#39;/dbconsole/**&#39;</span><span class="tok-o">:</span>               		<span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">]</span>
<span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_mediante_instancias_de_la_clase_de_dominio_requestmap">Mediante instancias de la clase de dominio RequestMap</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">grails</span><span class="tok-o">.</span><span class="tok-na">plugin</span><span class="tok-o">.</span><span class="tok-na">springsecurity</span><span class="tok-o">.</span><span class="tok-na">securityConfigType</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;Requestmap&#39;</span>

<span class="tok-cm">/* Esto debe ir en el archivo BootStrap.groovy */</span>
<span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">url</span> <span class="tok-k">in</span> <span class="tok-o">[</span>
      <span class="tok-s1">&#39;/&#39;</span><span class="tok-o">,</span> <span class="tok-s1">&#39;/index&#39;</span><span class="tok-o">,</span> <span class="tok-s1">&#39;/index.gsp&#39;</span><span class="tok-o">,</span> <span class="tok-s1">&#39;/assets/**&#39;</span><span class="tok-o">,</span>
      <span class="tok-s1">&#39;/**/js/**&#39;</span><span class="tok-o">,</span> <span class="tok-s1">&#39;/**/css/**&#39;</span><span class="tok-o">,</span> <span class="tok-s1">&#39;/**/images/**&#39;</span><span class="tok-o">,</span>
      <span class="tok-s1">&#39;/**/favicon.ico&#39;</span><span class="tok-o">,</span> <span class="tok-s1">&#39;/login/**&#39;</span><span class="tok-o">,</span> <span class="tok-s1">&#39;/logout/**&#39;</span><span class="tok-o">,</span> <span class="tok-s1">&#39;/dbconsole/**&#39;</span><span class="tok-o">])</span> <span class="tok-o">{</span>
   <span class="tok-k">new</span> <span class="tok-nf">RequestMap</span><span class="tok-o">(</span><span class="tok-nl">url:</span> <span class="tok-n">url</span><span class="tok-o">,</span> <span class="tok-nl">configAttribute:</span> <span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">).</span><span class="tok-na">save</span><span class="tok-o">()</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_mediante_reglas_en_el_archivo_config_groovy_con_intercepturlmap">Mediante reglas en el archivo Config.groovy con InterceptUrlMap</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">grails</span><span class="tok-o">.</span><span class="tok-na">plugin</span><span class="tok-o">.</span><span class="tok-na">springsecurity</span><span class="tok-o">.</span><span class="tok-na">securityConfigType</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;InterceptUrlMap&#39;</span>
<span class="tok-n">grails</span><span class="tok-o">.</span><span class="tok-na">plugin</span><span class="tok-o">.</span><span class="tok-na">springsecurity</span><span class="tok-o">.</span><span class="tok-na">interceptUrlMap</span> <span class="tok-o">=</span> <span class="tok-o">[</span>
   <span class="tok-s1">&#39;/&#39;</span><span class="tok-o">:</span>                  <span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">],</span>
   <span class="tok-s1">&#39;/index&#39;</span><span class="tok-o">:</span>             <span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">],</span>
   <span class="tok-s1">&#39;/index.gsp&#39;</span><span class="tok-o">:</span>         <span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">],</span>
   <span class="tok-s1">&#39;/assets/**&#39;</span><span class="tok-o">:</span>         <span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">],</span>
   <span class="tok-s1">&#39;/**/js/**&#39;</span><span class="tok-o">:</span>          <span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">],</span>
   <span class="tok-s1">&#39;/**/css/**&#39;</span><span class="tok-o">:</span>         <span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">],</span>
   <span class="tok-s1">&#39;/**/images/**&#39;</span><span class="tok-o">:</span>      <span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">],</span>
   <span class="tok-s1">&#39;/**/favicon.ico&#39;</span><span class="tok-o">:</span>    <span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">],</span>
   <span class="tok-s1">&#39;/login/**&#39;</span><span class="tok-o">:</span>          <span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">],</span>
   <span class="tok-s1">&#39;/logout/**&#39;</span><span class="tok-o">:</span>         <span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">],</span>
   <span class="tok-s1">&#39;/dbconsole/**&#39;</span><span class="tok-o">:</span>      <span class="tok-o">[</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">]</span>
<span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_controladores_2">7.5. Controladores</h3>
<div class="paragraph">
<p>Con el plugin de Grails tendremos acceso a un par de controladores, que aunque en un principio no vamos a tener que modificar, está bien que conozcamos de su existencia. Estos dos controladores son <em>LoginController</em> y <em>LogoutController</em> y este es su contenido:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">grails</span><span class="tok-o">.</span><span class="tok-na">plugin</span><span class="tok-o">.</span><span class="tok-na">springsecurity</span>

<span class="tok-kn">import</span> <span class="tok-nn">grails.converters.JSON</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.http.HttpServletResponse</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.springframework.security.access.annotation.Secured</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.springframework.security.authentication.AccountExpiredException</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.springframework.security.authentication.CredentialsExpiredException</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.springframework.security.authentication.DisabledException</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.springframework.security.authentication.LockedException</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.springframework.security.core.context.SecurityContextHolder</span> <span class="tok-k">as</span> <span class="tok-n">SCH</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.springframework.security.web.WebAttributes</span>

<span class="tok-nd">@Secured</span><span class="tok-o">(</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">)</span>
<span class="tok-kd">class</span> <span class="tok-nc">LoginController</span> <span class="tok-o">{</span>

	<span class="tok-cm">/**</span>
<span class="tok-cm">	 * Dependency injection for the authenticationTrustResolver.</span>
<span class="tok-cm">	 */</span>
	<span class="tok-kt">def</span> <span class="tok-n">authenticationTrustResolver</span>

	<span class="tok-cm">/**</span>
<span class="tok-cm">	 * Dependency injection for the springSecurityService.</span>
<span class="tok-cm">	 */</span>
	<span class="tok-kt">def</span> <span class="tok-n">springSecurityService</span>

	<span class="tok-cm">/**</span>
<span class="tok-cm">	 * Default action; redirects to &#39;defaultTargetUrl&#39; if logged in, /login/auth otherwise.</span>
<span class="tok-cm">	 */</span>
	<span class="tok-kt">def</span> <span class="tok-nf">index</span><span class="tok-o">()</span> <span class="tok-o">{</span>
		<span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">springSecurityService</span><span class="tok-o">.</span><span class="tok-na">isLoggedIn</span><span class="tok-o">())</span> <span class="tok-o">{</span>
			<span class="tok-n">redirect</span> <span class="tok-nl">uri:</span> <span class="tok-n">SpringSecurityUtils</span><span class="tok-o">.</span><span class="tok-na">securityConfig</span><span class="tok-o">.</span><span class="tok-na">successHandler</span><span class="tok-o">.</span><span class="tok-na">defaultTargetUrl</span>
		<span class="tok-o">}</span>
		<span class="tok-k">else</span> <span class="tok-o">{</span>
			<span class="tok-n">redirect</span> <span class="tok-nl">action:</span> <span class="tok-s1">&#39;auth&#39;</span><span class="tok-o">,</span> <span class="tok-nl">params:</span> <span class="tok-n">params</span>
		<span class="tok-o">}</span>
	<span class="tok-o">}</span>

	<span class="tok-cm">/**</span>
<span class="tok-cm">	 * Show the login page.</span>
<span class="tok-cm">	 */</span>
	<span class="tok-kt">def</span> <span class="tok-nf">auth</span><span class="tok-o">()</span> <span class="tok-o">{</span>

		<span class="tok-kt">def</span> <span class="tok-n">config</span> <span class="tok-o">=</span> <span class="tok-n">SpringSecurityUtils</span><span class="tok-o">.</span><span class="tok-na">securityConfig</span>

		<span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">springSecurityService</span><span class="tok-o">.</span><span class="tok-na">isLoggedIn</span><span class="tok-o">())</span> <span class="tok-o">{</span>
			<span class="tok-n">redirect</span> <span class="tok-nl">uri:</span> <span class="tok-n">config</span><span class="tok-o">.</span><span class="tok-na">successHandler</span><span class="tok-o">.</span><span class="tok-na">defaultTargetUrl</span>
			<span class="tok-k">return</span>
		<span class="tok-o">}</span>

		<span class="tok-n">String</span> <span class="tok-n">view</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;auth&#39;</span>
		<span class="tok-n">String</span> <span class="tok-n">postUrl</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;${request.contextPath}${config.apf.filterProcessesUrl}&quot;</span>
		<span class="tok-n">render</span> <span class="tok-nl">view:</span> <span class="tok-n">view</span><span class="tok-o">,</span> <span class="tok-nl">model:</span> <span class="tok-o">[</span><span class="tok-nl">postUrl:</span> <span class="tok-n">postUrl</span><span class="tok-o">,</span>
		                           <span class="tok-nl">rememberMeParameter:</span> <span class="tok-n">config</span><span class="tok-o">.</span><span class="tok-na">rememberMe</span><span class="tok-o">.</span><span class="tok-na">parameter</span><span class="tok-o">]</span>
	<span class="tok-o">}</span>

	<span class="tok-cm">/**</span>
<span class="tok-cm">	 * The redirect action for Ajax requests.</span>
<span class="tok-cm">	 */</span>
	<span class="tok-kt">def</span> <span class="tok-nf">authAjax</span><span class="tok-o">()</span> <span class="tok-o">{</span>
		<span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setHeader</span> <span class="tok-s1">&#39;Location&#39;</span><span class="tok-o">,</span> <span class="tok-n">SpringSecurityUtils</span><span class="tok-o">.</span><span class="tok-na">securityConfig</span><span class="tok-o">.</span><span class="tok-na">auth</span><span class="tok-o">.</span><span class="tok-na">ajaxLoginFormUrl</span>
		<span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">sendError</span> <span class="tok-n">HttpServletResponse</span><span class="tok-o">.</span><span class="tok-na">SC_UNAUTHORIZED</span>
	<span class="tok-o">}</span>

	<span class="tok-cm">/**</span>
<span class="tok-cm">	 * Show denied page.</span>
<span class="tok-cm">	 */</span>
	<span class="tok-kt">def</span> <span class="tok-nf">denied</span><span class="tok-o">()</span> <span class="tok-o">{</span>
		<span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">springSecurityService</span><span class="tok-o">.</span><span class="tok-na">isLoggedIn</span><span class="tok-o">()</span> <span class="tok-o">&amp;&amp;</span>
				<span class="tok-n">authenticationTrustResolver</span><span class="tok-o">.</span><span class="tok-na">isRememberMe</span><span class="tok-o">(</span><span class="tok-n">SCH</span><span class="tok-o">.</span><span class="tok-na">context</span><span class="tok-o">?.</span><span class="tok-na">authentication</span><span class="tok-o">))</span> <span class="tok-o">{</span>
			<span class="tok-c1">// have cookie but the page is guarded with IS_AUTHENTICATED_FULLY</span>
			<span class="tok-n">redirect</span> <span class="tok-nl">action:</span> <span class="tok-s1">&#39;full&#39;</span><span class="tok-o">,</span> <span class="tok-nl">params:</span> <span class="tok-n">params</span>
		<span class="tok-o">}</span>
	<span class="tok-o">}</span>

	<span class="tok-cm">/**</span>
<span class="tok-cm">	 * Login page for users with a remember-me cookie but accessing a IS_AUTHENTICATED_FULLY page.</span>
<span class="tok-cm">	 */</span>
	<span class="tok-kt">def</span> <span class="tok-nf">full</span><span class="tok-o">()</span> <span class="tok-o">{</span>
		<span class="tok-kt">def</span> <span class="tok-n">config</span> <span class="tok-o">=</span> <span class="tok-n">SpringSecurityUtils</span><span class="tok-o">.</span><span class="tok-na">securityConfig</span>
		<span class="tok-n">render</span> <span class="tok-nl">view:</span> <span class="tok-s1">&#39;auth&#39;</span><span class="tok-o">,</span> <span class="tok-nl">params:</span> <span class="tok-n">params</span><span class="tok-o">,</span>
			<span class="tok-nl">model:</span> <span class="tok-o">[</span><span class="tok-nl">hasCookie:</span> <span class="tok-n">authenticationTrustResolver</span><span class="tok-o">.</span><span class="tok-na">isRememberMe</span><span class="tok-o">(</span><span class="tok-n">SCH</span><span class="tok-o">.</span><span class="tok-na">context</span><span class="tok-o">?.</span><span class="tok-na">authentication</span><span class="tok-o">),</span>
			        <span class="tok-nl">postUrl:</span> <span class="tok-s2">&quot;${request.contextPath}${config.apf.filterProcessesUrl}&quot;</span><span class="tok-o">]</span>
	<span class="tok-o">}</span>

	<span class="tok-cm">/**</span>
<span class="tok-cm">	 * Callback after a failed login. Redirects to the auth page with a warning message.</span>
<span class="tok-cm">	 */</span>
	<span class="tok-kt">def</span> <span class="tok-nf">authfail</span><span class="tok-o">()</span> <span class="tok-o">{</span>

		<span class="tok-n">String</span> <span class="tok-n">msg</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;&#39;</span>
		<span class="tok-kt">def</span> <span class="tok-n">exception</span> <span class="tok-o">=</span> <span class="tok-n">session</span><span class="tok-o">[</span><span class="tok-n">WebAttributes</span><span class="tok-o">.</span><span class="tok-na">AUTHENTICATION_EXCEPTION</span><span class="tok-o">]</span>
		<span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">exception</span><span class="tok-o">)</span> <span class="tok-o">{</span>
			<span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">exception</span> <span class="tok-k">instanceof</span> <span class="tok-n">AccountExpiredException</span><span class="tok-o">)</span> <span class="tok-o">{</span>
				<span class="tok-n">msg</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">message</span><span class="tok-o">(</span><span class="tok-nl">code:</span> <span class="tok-s2">&quot;springSecurity.errors.login.expired&quot;</span><span class="tok-o">)</span>
			<span class="tok-o">}</span>
			<span class="tok-k">else</span> <span class="tok-nf">if</span> <span class="tok-o">(</span><span class="tok-n">exception</span> <span class="tok-k">instanceof</span> <span class="tok-n">CredentialsExpiredException</span><span class="tok-o">)</span> <span class="tok-o">{</span>
				<span class="tok-n">msg</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">message</span><span class="tok-o">(</span><span class="tok-nl">code:</span> <span class="tok-s2">&quot;springSecurity.errors.login.passwordExpired&quot;</span><span class="tok-o">)</span>
			<span class="tok-o">}</span>
			<span class="tok-k">else</span> <span class="tok-nf">if</span> <span class="tok-o">(</span><span class="tok-n">exception</span> <span class="tok-k">instanceof</span> <span class="tok-n">DisabledException</span><span class="tok-o">)</span> <span class="tok-o">{</span>
				<span class="tok-n">msg</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">message</span><span class="tok-o">(</span><span class="tok-nl">code:</span> <span class="tok-s2">&quot;springSecurity.errors.login.disabled&quot;</span><span class="tok-o">)</span>
			<span class="tok-o">}</span>
			<span class="tok-k">else</span> <span class="tok-nf">if</span> <span class="tok-o">(</span><span class="tok-n">exception</span> <span class="tok-k">instanceof</span> <span class="tok-n">LockedException</span><span class="tok-o">)</span> <span class="tok-o">{</span>
				<span class="tok-n">msg</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">message</span><span class="tok-o">(</span><span class="tok-nl">code:</span> <span class="tok-s2">&quot;springSecurity.errors.login.locked&quot;</span><span class="tok-o">)</span>
			<span class="tok-o">}</span>
			<span class="tok-k">else</span> <span class="tok-o">{</span>
				<span class="tok-n">msg</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">message</span><span class="tok-o">(</span><span class="tok-nl">code:</span> <span class="tok-s2">&quot;springSecurity.errors.login.fail&quot;</span><span class="tok-o">)</span>
			<span class="tok-o">}</span>
		<span class="tok-o">}</span>

		<span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">springSecurityService</span><span class="tok-o">.</span><span class="tok-na">isAjax</span><span class="tok-o">(</span><span class="tok-n">request</span><span class="tok-o">))</span> <span class="tok-o">{</span>
			<span class="tok-n">render</span><span class="tok-o">([</span><span class="tok-nl">error:</span> <span class="tok-n">msg</span><span class="tok-o">]</span> <span class="tok-k">as</span> <span class="tok-n">JSON</span><span class="tok-o">)</span>
		<span class="tok-o">}</span>
		<span class="tok-k">else</span> <span class="tok-o">{</span>
			<span class="tok-n">flash</span><span class="tok-o">.</span><span class="tok-na">message</span> <span class="tok-o">=</span> <span class="tok-n">msg</span>
			<span class="tok-n">redirect</span> <span class="tok-nl">action:</span> <span class="tok-s1">&#39;auth&#39;</span><span class="tok-o">,</span> <span class="tok-nl">params:</span> <span class="tok-n">params</span>
		<span class="tok-o">}</span>
	<span class="tok-o">}</span>

	<span class="tok-cm">/**</span>
<span class="tok-cm">	 * The Ajax success redirect url.</span>
<span class="tok-cm">	 */</span>
	<span class="tok-kt">def</span> <span class="tok-nf">ajaxSuccess</span><span class="tok-o">()</span> <span class="tok-o">{</span>
		<span class="tok-n">render</span><span class="tok-o">([</span><span class="tok-nl">success:</span> <span class="tok-kc">true</span><span class="tok-o">,</span> <span class="tok-nl">username:</span> <span class="tok-n">springSecurityService</span><span class="tok-o">.</span><span class="tok-na">authentication</span><span class="tok-o">.</span><span class="tok-na">name</span><span class="tok-o">]</span> <span class="tok-k">as</span> <span class="tok-n">JSON</span><span class="tok-o">)</span>
	<span class="tok-o">}</span>

	<span class="tok-cm">/**</span>
<span class="tok-cm">	 * The Ajax denied redirect url.</span>
<span class="tok-cm">	 */</span>
	<span class="tok-kt">def</span> <span class="tok-nf">ajaxDenied</span><span class="tok-o">()</span> <span class="tok-o">{</span>
		<span class="tok-n">render</span><span class="tok-o">([</span><span class="tok-nl">error:</span> <span class="tok-s1">&#39;access denied&#39;</span><span class="tok-o">]</span> <span class="tok-k">as</span> <span class="tok-n">JSON</span><span class="tok-o">)</span>
	<span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">grails</span><span class="tok-o">.</span><span class="tok-na">plugin</span><span class="tok-o">.</span><span class="tok-na">springsecurity</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.http.HttpServletResponse</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.springframework.security.access.annotation.Secured</span>

<span class="tok-nd">@Secured</span><span class="tok-o">(</span><span class="tok-s1">&#39;permitAll&#39;</span><span class="tok-o">)</span>
<span class="tok-kd">class</span> <span class="tok-nc">LogoutController</span> <span class="tok-o">{</span>

	<span class="tok-cm">/**</span>
<span class="tok-cm">	 * Index action. Redirects to the Spring security logout uri.</span>
<span class="tok-cm">	 */</span>
	<span class="tok-kt">def</span> <span class="tok-nf">index</span><span class="tok-o">()</span> <span class="tok-o">{</span>

		<span class="tok-k">if</span> <span class="tok-o">(!</span><span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">post</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-n">SpringSecurityUtils</span><span class="tok-o">.</span><span class="tok-na">getSecurityConfig</span><span class="tok-o">().</span><span class="tok-na">logout</span><span class="tok-o">.</span><span class="tok-na">postOnly</span><span class="tok-o">)</span> <span class="tok-o">{</span>
			<span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">sendError</span> <span class="tok-n">HttpServletResponse</span><span class="tok-o">.</span><span class="tok-na">SC_METHOD_NOT_ALLOWED</span> <span class="tok-c1">// 405</span>
			<span class="tok-k">return</span>
		<span class="tok-o">}</span>

		<span class="tok-c1">// TODO put any pre-logout code here</span>
		<span class="tok-n">redirect</span> <span class="tok-nl">uri:</span> <span class="tok-n">SpringSecurityUtils</span><span class="tok-o">.</span><span class="tok-na">securityConfig</span><span class="tok-o">.</span><span class="tok-na">logout</span><span class="tok-o">.</span><span class="tok-na">filterProcessesUrl</span> <span class="tok-c1">// &#39;/j_spring_security_logout&#39;</span>
	<span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_librerías_adicionales">7.6. Librerías adicionales</h3>
<div class="paragraph">
<p>El plugin de Spring Security viene además con una serie de librerías accesibles en forma de etiquetas o servicio. Veamos cada uno de ellos.</p>
</div>
<div class="sect3">
<h4 id="_librería_de_etiquetas_securitytaglib">7.6.1. Librería de etiquetas: SecurityTagLib</h4>
<div class="paragraph">
<p>Con esta librería podremos insertar en nuestros archivos GSPs comprobaciones del tipo, ¿el usuario está identificado? o ¿tiene los permisos necesarios para ver esto?</p>
</div>
<div class="sect4">
<h5 id="_ifloggedin">ifLoggedIn</h5>
<div class="paragraph">
<p>Muestra el contenido del cuerpo que pongamos dentro de esta etiqueta siempre que el usuario esté autenticado en el sistema.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">&lt;</span><span class="tok-nl">sec:</span><span class="tok-n">ifLoggedIn</span><span class="tok-o">&gt;</span>
	<span class="tok-n">Welcome</span> <span class="tok-n">Back</span><span class="tok-o">!</span>
<span class="tok-o">&lt;/</span><span class="tok-nl">sec:</span><span class="tok-n">ifLoggedIn</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_ifnotloggedin">ifNotLoggedIn</h5>
<div class="paragraph">
<p>Muestra el contenido del cuerpo que pongamos dentro de esta etiqueta siempre que el usuario no esté autenticado en el sistema.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">&lt;</span><span class="tok-nl">sec:</span><span class="tok-n">ifNotLoggedIn</span><span class="tok-o">&gt;</span>
	<span class="tok-o">&lt;</span><span class="tok-nl">g:</span><span class="tok-n">link</span> <span class="tok-n">controller</span><span class="tok-o">=</span><span class="tok-s1">&#39;login&#39;</span> <span class="tok-n">action</span><span class="tok-o">=</span><span class="tok-s1">&#39;auth&#39;</span><span class="tok-o">&gt;</span>
		<span class="tok-n">Login</span>
	<span class="tok-o">&lt;</span><span class="tok-s">/g:link&gt;</span>
<span class="tok-s">&lt;/</span><span class="tok-nl">sec:</span><span class="tok-n">ifNotLoggedIn</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_ifallgranted">ifAllGranted</h5>
<div class="paragraph">
<p>Muestra el contenido del cuerpo que pongamos dentro de esta etiqueta siempre que el usuario tenga todos los roles pasados por parámetro.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">&lt;</span><span class="tok-nl">sec:</span><span class="tok-n">ifAllGranted</span> <span class="tok-n">roles</span><span class="tok-o">=</span><span class="tok-s2">&quot;ROLE_ADMIN,ROLE_SUPERVISOR&quot;</span><span class="tok-o">&gt;</span><span class="tok-n">secure</span> <span class="tok-n">stuff</span> <span class="tok-n">here</span><span class="tok-o">&lt;/</span><span class="tok-nl">sec:</span><span class="tok-n">ifAllGranted</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_ifanygranted">ifAnyGranted</h5>
<div class="paragraph">
<p>Muestra el contenido del cuerpo que pongamos dentro de esta etiqueta siempre que el usuario tenga al menos uno de los roles pasados por parámetro.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">&lt;</span><span class="tok-nl">sec:</span><span class="tok-n">ifAnyGranted</span> <span class="tok-n">roles</span><span class="tok-o">=</span><span class="tok-s2">&quot;ROLE_ADMIN,ROLE_SUPERVISOR&quot;</span><span class="tok-o">&gt;</span><span class="tok-n">secure</span> <span class="tok-n">stuff</span> <span class="tok-n">here</span><span class="tok-o">&lt;/</span><span class="tok-nl">sec:</span><span class="tok-n">ifAnyGranted</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_ifnotgranted">ifNotGranted</h5>
<div class="paragraph">
<p>Muestra el contenido del cuerpo que pongamos dentro de esta etiqueta siempre que el usuario no tenga asignado ninguno de los roles pasados por parámetro.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">&lt;</span><span class="tok-nl">sec:</span><span class="tok-n">ifNotGranted</span> <span class="tok-n">roles</span><span class="tok-o">=</span><span class="tok-s2">&quot;ROLE_USER&quot;</span><span class="tok-o">&gt;</span><span class="tok-n">non</span><span class="tok-o">-</span><span class="tok-n">user</span> <span class="tok-n">stuff</span> <span class="tok-n">here</span><span class="tok-o">&lt;/</span><span class="tok-nl">sec:</span><span class="tok-n">ifNotGranted</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_loggedinuserinfo">loggedInUserInfo</h5>
<div class="paragraph">
<p>Muestra el valor del campo especificado por parámetro del usuario identificado en el sistema.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">&lt;</span><span class="tok-nl">sec:</span><span class="tok-n">loggedInUserInfo</span> <span class="tok-n">field</span><span class="tok-o">=</span><span class="tok-s2">&quot;username&quot;</span><span class="tok-o">/&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_username">username</h5>
<div class="paragraph">
<p>Muestra el nombre de usuario del usuario autenticado en el sistema</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">&lt;</span><span class="tok-nl">sec:</span><span class="tok-n">ifLoggedIn</span><span class="tok-o">&gt;</span>
	<span class="tok-n">Welcome</span> <span class="tok-n">Back</span> <span class="tok-o">&lt;</span><span class="tok-nl">sec:</span><span class="tok-n">username</span><span class="tok-s">/&gt;!</span>
<span class="tok-s">&lt;/</span><span class="tok-nl">sec:</span><span class="tok-n">ifLoggedIn</span><span class="tok-o">&gt;</span>
<span class="tok-o">&lt;</span><span class="tok-nl">sec:</span><span class="tok-n">ifNotLoggedIn</span><span class="tok-o">&gt;</span>
	<span class="tok-o">&lt;</span><span class="tok-nl">g:</span><span class="tok-n">link</span> <span class="tok-n">controller</span><span class="tok-o">=</span><span class="tok-s1">&#39;login&#39;</span> <span class="tok-n">action</span><span class="tok-o">=</span><span class="tok-s1">&#39;auth&#39;</span><span class="tok-o">&gt;</span><span class="tok-n">Login</span><span class="tok-o">&lt;</span><span class="tok-s">/g:link&gt;</span>
<span class="tok-s">&lt;/</span><span class="tok-nl">sec:</span><span class="tok-n">ifNotLoggedIn</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_access">access</h5>
<div class="paragraph">
<p>Muestra el contenido del cuerpo que pongamos dentro de esta etiqueta siempre que la expresión se evalúe a cierto o el usuario tenga acceso a la url pasada por parámetro.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">&lt;</span><span class="tok-nl">sec:</span><span class="tok-n">access</span> <span class="tok-n">expression</span><span class="tok-o">=</span><span class="tok-s2">&quot;hasRole(&#39;ROLE_USER&#39;)&quot;</span><span class="tok-o">&gt;</span>
	<span class="tok-n">You</span><span class="tok-s1">&#39;re a user</span>
<span class="tok-s1">&lt;/sec:access&gt;</span>

<span class="tok-s1">&lt;sec:access url=&quot;/admin/user&quot;&gt;</span>
<span class="tok-s1">	&lt;g:link controller=&#39;</span><span class="tok-n">admin</span><span class="tok-s1">&#39; action=&#39;</span><span class="tok-n">user</span><span class="tok-err">&#39;</span><span class="tok-o">&gt;</span><span class="tok-n">Manage</span> <span class="tok-n">Users</span><span class="tok-o">&lt;</span><span class="tok-s">/g:link&gt;</span>
<span class="tok-s">&lt;/</span><span class="tok-nl">sec:</span><span class="tok-n">access</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Incluso podemos especificar el controlador y la acción que queremos referenciar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">&lt;</span><span class="tok-nl">sec:</span><span class="tok-n">access</span> <span class="tok-n">controller</span><span class="tok-o">=</span><span class="tok-s1">&#39;admin&#39;</span> <span class="tok-n">action</span><span class="tok-o">=</span><span class="tok-s1">&#39;user&#39;</span><span class="tok-o">&gt;</span>
	<span class="tok-o">&lt;</span><span class="tok-nl">g:</span><span class="tok-n">link</span> <span class="tok-n">controller</span><span class="tok-o">=</span><span class="tok-s1">&#39;admin&#39;</span> <span class="tok-n">action</span><span class="tok-o">=</span><span class="tok-s1">&#39;user&#39;</span><span class="tok-o">&gt;</span>
		<span class="tok-n">Manage</span> <span class="tok-n">Users</span>
	<span class="tok-o">&lt;</span><span class="tok-s">/g:link&gt;</span>
<span class="tok-s">&lt;/</span><span class="tok-nl">sec:</span><span class="tok-n">access</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_noaccess">noAccess</h5>
<div class="paragraph">
<p>Muestra el contenido del cuerpo que pongamos dentro de esta etiqueta siempre que la expresión se evalúe a falso o el usuario no tenga acceso a la url pasada por parámetro.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">&lt;</span><span class="tok-nl">sec:</span><span class="tok-n">noAccess</span> <span class="tok-n">expression</span><span class="tok-o">=</span><span class="tok-s2">&quot;hasRole(&#39;ROLE_USER&#39;)&quot;</span><span class="tok-o">&gt;</span>
	<span class="tok-n">You</span><span class="tok-err">&#39;</span><span class="tok-n">re</span> <span class="tok-n">not</span> <span class="tok-n">a</span> <span class="tok-n">user</span>
<span class="tok-o">&lt;/</span><span class="tok-nl">sec:</span><span class="tok-n">noAccess</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_servicio_springsecurityservice">7.6.2. Servicio: SpringSecurityService</h4>
<div class="paragraph">
<p>El servicio <em>grails.plugin.springsecurity.SpringSecurityService</em> ofrece algunos métodos que podremos utilizar en los controladores u otros servicios simplemente inyectándolos debidamente.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">springSecurityService</span></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_getcurrentuser">getCurrentUser()</h5>
<div class="paragraph">
<p>Obtiene una instancia de las clase de dominio correspondiente al usuario autenticado en el sistema.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">SomeController</span> <span class="tok-o">{</span>
   <span class="tok-kt">def</span> <span class="tok-n">springSecurityService</span>

   <span class="tok-kt">def</span> <span class="tok-nf">someAction</span><span class="tok-o">()</span> <span class="tok-o">{</span>
      <span class="tok-kt">def</span> <span class="tok-n">user</span> <span class="tok-o">=</span> <span class="tok-n">springSecurityService</span><span class="tok-o">.</span><span class="tok-na">currentUser</span>
      <span class="tok-o">...</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_isloggedin">isLoggedIn()</h5>
<div class="paragraph">
<p>Comprueba si el usuario está autenticado en el sistema</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">SomeController</span> <span class="tok-o">{</span>
   <span class="tok-kt">def</span> <span class="tok-n">springSecurityService</span>

   <span class="tok-kt">def</span> <span class="tok-nf">someAction</span><span class="tok-o">()</span> <span class="tok-o">{</span>
      <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">springSecurityService</span><span class="tok-o">.</span><span class="tok-na">isLoggedIn</span><span class="tok-o">())</span> <span class="tok-o">{</span>
         <span class="tok-o">...</span>
      <span class="tok-o">}</span>
      <span class="tok-k">else</span> <span class="tok-o">{</span>
         <span class="tok-o">...</span>
      <span class="tok-o">}</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_getauthentication">getAuthentication()</h5>
<div class="paragraph">
<p>Obtiene los datos del usuario autenticado en el sistema</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">SomeController</span> <span class="tok-o">{</span>
   <span class="tok-kt">def</span> <span class="tok-n">springSecurityService</span>

   <span class="tok-kt">def</span> <span class="tok-nf">someAction</span><span class="tok-o">()</span> <span class="tok-o">{</span>
      <span class="tok-kt">def</span> <span class="tok-n">auth</span> <span class="tok-o">=</span> <span class="tok-n">springSecurityService</span><span class="tok-o">.</span><span class="tok-na">authentication</span>
      <span class="tok-n">String</span> <span class="tok-n">username</span> <span class="tok-o">=</span> <span class="tok-n">auth</span><span class="tok-o">.</span><span class="tok-na">username</span>
      <span class="tok-kt">def</span> <span class="tok-n">authorities</span> <span class="tok-o">=</span> <span class="tok-n">auth</span><span class="tok-o">.</span><span class="tok-na">authorities</span> <span class="tok-c1">// a Collection of GrantedAuthority</span>
      <span class="tok-kt">boolean</span> <span class="tok-n">authenticated</span> <span class="tok-o">=</span> <span class="tok-n">auth</span><span class="tok-o">.</span><span class="tok-na">authenticated</span>
      <span class="tok-o">...</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_getprincipal">getPrincipal()</h5>
<div class="paragraph">
<p>Obtiene los datos del usuario autenticado en el sistema</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">SomeController</span> <span class="tok-o">{</span>
   <span class="tok-kt">def</span> <span class="tok-n">springSecurityService</span>

   <span class="tok-kt">def</span> <span class="tok-nf">someAction</span><span class="tok-o">()</span> <span class="tok-o">{</span>
      <span class="tok-kt">def</span> <span class="tok-n">principal</span> <span class="tok-o">=</span> <span class="tok-n">springSecurityService</span><span class="tok-o">.</span><span class="tok-na">principal</span>
      <span class="tok-n">String</span> <span class="tok-n">username</span> <span class="tok-o">=</span> <span class="tok-n">principal</span><span class="tok-o">.</span><span class="tok-na">username</span>
      <span class="tok-kt">def</span> <span class="tok-n">authorities</span> <span class="tok-o">=</span> <span class="tok-n">principal</span><span class="tok-o">.</span><span class="tok-na">authorities</span> <span class="tok-c1">// a Collection of GrantedAuthority</span>
      <span class="tok-kt">boolean</span> <span class="tok-n">enabled</span> <span class="tok-o">=</span> <span class="tok-n">principal</span><span class="tok-o">.</span><span class="tok-na">enabled</span>
      <span class="tok-err">…</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_encodepassword">encodePassword()</h5>
<div class="paragraph">
<p>Codifica la contraseña a partir del esquema de encriptación configurado. Por defecto, se utiliza el método SHA-256, pero éste se puede modificar en el archivo de configuración <em>Config.groovy</em> especificando el parámetro <em>grails.plugin.springsecurity.password.algorithm</em>, pudiendo utilizar cualquiera de los valores comentados en esta página de Java: <a href="http://docs.oracle.com/javase/7/docs/technotes/guides/security/crypto/CryptoSpec.html#Architecture" class="bare">http://docs.oracle.com/javase/7/docs/technotes/guides/security/crypto/CryptoSpec.html#Architecture</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">PersonController</span> <span class="tok-o">{</span>
   <span class="tok-kt">def</span> <span class="tok-n">springSecurityService</span>

   <span class="tok-kt">def</span> <span class="tok-nf">updateAction</span><span class="tok-o">()</span> <span class="tok-o">{</span>
      <span class="tok-kt">def</span> <span class="tok-n">person</span> <span class="tok-o">=</span> <span class="tok-n">Person</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-n">params</span><span class="tok-o">.</span><span class="tok-na">id</span><span class="tok-o">)</span>

      <span class="tok-n">params</span><span class="tok-o">.</span><span class="tok-na">salt</span> <span class="tok-o">=</span> <span class="tok-n">person</span><span class="tok-o">.</span><span class="tok-na">salt</span>
      <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">person</span><span class="tok-o">.</span><span class="tok-na">password</span> <span class="tok-o">!=</span> <span class="tok-n">params</span><span class="tok-o">.</span><span class="tok-na">password</span><span class="tok-o">)</span> <span class="tok-o">{</span>
         <span class="tok-n">params</span><span class="tok-o">.</span><span class="tok-na">password</span> <span class="tok-o">=</span> <span class="tok-n">springSecurityService</span><span class="tok-o">.</span><span class="tok-na">encodePassword</span><span class="tok-o">(</span><span class="tok-n">password</span><span class="tok-o">,</span> <span class="tok-n">salt</span><span class="tok-o">)</span>
         <span class="tok-kt">def</span> <span class="tok-n">salt</span> <span class="tok-o">=</span> <span class="tok-err">…</span> <span class="tok-c1">// e.g. randomly generated using some utility method</span>
         <span class="tok-n">params</span><span class="tok-o">.</span><span class="tok-na">salt</span> <span class="tok-o">=</span> <span class="tok-n">salt</span>
      <span class="tok-o">}</span>
      <span class="tok-n">person</span><span class="tok-o">.</span><span class="tok-na">properties</span> <span class="tok-o">=</span> <span class="tok-n">params</span>
      <span class="tok-k">if</span> <span class="tok-o">(!</span><span class="tok-n">person</span><span class="tok-o">.</span><span class="tok-na">save</span><span class="tok-o">(</span><span class="tok-nl">flush:</span> <span class="tok-kc">true</span><span class="tok-o">))</span> <span class="tok-o">{</span>
         <span class="tok-n">render</span> <span class="tok-nl">view:</span> <span class="tok-s1">&#39;edit&#39;</span><span class="tok-o">,</span> <span class="tok-nl">model:</span> <span class="tok-o">[</span><span class="tok-nl">person:</span> <span class="tok-n">person</span><span class="tok-o">]</span>
         <span class="tok-k">return</span>
      <span class="tok-o">}</span>
      <span class="tok-n">redirect</span> <span class="tok-nl">action:</span> <span class="tok-s1">&#39;show&#39;</span><span class="tok-o">,</span> <span class="tok-nl">id:</span> <span class="tok-n">person</span><span class="tok-o">.</span><span class="tok-na">id</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_updaterole">updateRole()</h5>
<div class="paragraph">
<p>Actualiza un rol, y en caso de que estemos utilizando el método <em>RequestMap</em>, también actualizará el nombre del rol en todas las instancias de la base de datos.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">RoleController</span> <span class="tok-o">{</span>
   <span class="tok-kt">def</span> <span class="tok-n">springSecurityService</span>

   <span class="tok-kt">def</span> <span class="tok-nf">update</span><span class="tok-o">()</span> <span class="tok-o">{</span>
      <span class="tok-kt">def</span> <span class="tok-n">roleInstance</span> <span class="tok-o">=</span> <span class="tok-n">Role</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-n">params</span><span class="tok-o">.</span><span class="tok-na">id</span><span class="tok-o">)</span>
      <span class="tok-k">if</span> <span class="tok-o">(!</span><span class="tok-n">springSecurityService</span><span class="tok-o">.</span><span class="tok-na">updateRole</span><span class="tok-o">(</span><span class="tok-n">roleInstance</span><span class="tok-o">,</span> <span class="tok-n">params</span><span class="tok-o">))</span> <span class="tok-o">{</span>
         <span class="tok-n">render</span> <span class="tok-nl">view:</span> <span class="tok-s1">&#39;edit&#39;</span><span class="tok-o">,</span> <span class="tok-nl">model:</span> <span class="tok-o">[</span><span class="tok-nl">roleInstance:</span> <span class="tok-n">roleInstance</span><span class="tok-o">]</span>
         <span class="tok-k">return</span>
      <span class="tok-o">}</span>

      <span class="tok-n">flash</span><span class="tok-o">.</span><span class="tok-na">message</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;The role was updated&quot;</span>
      <span class="tok-n">redirect</span> <span class="tok-nl">action:</span> <span class="tok-n">show</span><span class="tok-o">,</span> <span class="tok-nl">id:</span> <span class="tok-n">roleInstance</span><span class="tok-o">.</span><span class="tok-na">id</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_deleterole">deleteRole()</h5>
<div class="paragraph">
<p>Elimina un rol, y en caso de que estemos utilizando el método <em>Requestmap</em>, también lo eliminará de aquellas instancias donde estuviera especificado.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">RoleController</span> <span class="tok-o">{</span>
   <span class="tok-kt">def</span> <span class="tok-n">springSecurityService</span>

   <span class="tok-kt">def</span> <span class="tok-nf">delete</span><span class="tok-o">()</span> <span class="tok-o">{</span>
      <span class="tok-kt">def</span> <span class="tok-n">roleInstance</span> <span class="tok-o">=</span> <span class="tok-n">Role</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-n">params</span><span class="tok-o">.</span><span class="tok-na">id</span><span class="tok-o">)</span>
      <span class="tok-k">try</span> <span class="tok-o">{</span>
         <span class="tok-n">springSecurityService</span><span class="tok-o">.</span><span class="tok-na">deleteRole</span> <span class="tok-o">(</span><span class="tok-n">roleInstance</span>
         <span class="tok-n">flash</span><span class="tok-o">.</span><span class="tok-na">message</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;The role was deleted&quot;</span>
         <span class="tok-n">redirect</span> <span class="tok-nl">action:</span> <span class="tok-n">list</span>
      <span class="tok-o">}</span>
      <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">DataIntegrityViolationException</span> <span class="tok-n">e</span><span class="tok-o">)</span> <span class="tok-o">{</span>
         <span class="tok-n">flash</span><span class="tok-o">.</span><span class="tok-na">message</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;Unable to delete the role&quot;</span>
         <span class="tok-n">redirect</span> <span class="tok-nl">action:</span> <span class="tok-n">show</span><span class="tok-o">,</span> <span class="tok-nl">id:</span> <span class="tok-n">params</span><span class="tok-o">.</span><span class="tok-na">id</span>
      <span class="tok-o">}</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_clearcachedrequestmaps">clearCachedRequestmaps()</h5>
<div class="paragraph">
<p>Este método fuerza una actualización de toda la caché referente al sistema de autenticación de nuestra aplicación. Siempre que creemos, modifiquemos o eliminemos una instancia de la clase <em>RequestMap</em> debemos invocar este método. En los métodos <em>updateRole()</em> y <em>deleteRole()</em> ya se llama automáticamente al método <em>clearCachedRequestmaps()</em> para que nosotros no tengamos que preocuparnos.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">RequestmapController</span> <span class="tok-o">{</span>
   <span class="tok-kt">def</span> <span class="tok-n">springSecurityService</span>

   <span class="tok-kt">def</span> <span class="tok-nf">save</span><span class="tok-o">()</span> <span class="tok-o">{</span>
      <span class="tok-kt">def</span> <span class="tok-n">requestmapInstance</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Requestmap</span><span class="tok-o">(</span><span class="tok-n">params</span><span class="tok-o">)</span>
      <span class="tok-k">if</span> <span class="tok-o">(!</span><span class="tok-n">requestmapInstance</span><span class="tok-o">.</span><span class="tok-na">save</span><span class="tok-o">(</span><span class="tok-nl">flush:</span> <span class="tok-kc">true</span><span class="tok-o">))</span> <span class="tok-o">{</span>
         <span class="tok-n">render</span> <span class="tok-nl">view:</span> <span class="tok-s1">&#39;create&#39;</span><span class="tok-o">,</span> <span class="tok-nl">model:</span> <span class="tok-o">[</span><span class="tok-nl">requestmapInstance:</span> <span class="tok-n">requestmapInstance</span><span class="tok-o">]</span>
         <span class="tok-k">return</span>
      <span class="tok-o">}</span>

      <span class="tok-n">springSecurityService</span><span class="tok-o">.</span><span class="tok-na">clearCachedRequestmaps</span><span class="tok-o">()</span>
      <span class="tok-n">flash</span><span class="tok-o">.</span><span class="tok-na">message</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;Requestmap created&quot;</span>
      <span class="tok-n">redirect</span> <span class="tok-nl">action:</span> <span class="tok-n">show</span><span class="tok-o">,</span> <span class="tok-nl">id:</span> <span class="tok-n">requestmapInstance</span><span class="tok-o">.</span><span class="tok-na">id</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_reauthenticate">reauthenticate()</h5>
<div class="paragraph">
<p>Este método renueva los datos de la autenticación del usuario. Esto se debe hacer después de que se actualicen los roles de un usuario.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">UserController</span> <span class="tok-o">{</span>
   <span class="tok-kt">def</span> <span class="tok-n">springSecurityService</span>

   <span class="tok-kt">def</span> <span class="tok-nf">update</span><span class="tok-o">()</span> <span class="tok-o">{</span>
      <span class="tok-kt">def</span> <span class="tok-n">userInstance</span> <span class="tok-o">=</span> <span class="tok-n">User</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-n">params</span><span class="tok-o">.</span><span class="tok-na">id</span><span class="tok-o">)</span>

      <span class="tok-n">params</span><span class="tok-o">.</span><span class="tok-na">salt</span> <span class="tok-o">=</span> <span class="tok-n">person</span><span class="tok-o">.</span><span class="tok-na">salt</span>
      <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">params</span><span class="tok-o">.</span><span class="tok-na">password</span><span class="tok-o">)</span> <span class="tok-o">{</span>
         <span class="tok-n">params</span><span class="tok-o">.</span><span class="tok-na">password</span> <span class="tok-o">=</span> <span class="tok-n">springSecurityService</span><span class="tok-o">.</span><span class="tok-na">encodePassword</span><span class="tok-o">(</span><span class="tok-n">params</span><span class="tok-o">.</span><span class="tok-na">password</span><span class="tok-o">,</span> <span class="tok-n">salt</span><span class="tok-o">)</span>
         <span class="tok-kt">def</span> <span class="tok-n">salt</span> <span class="tok-o">=</span> <span class="tok-err">…</span> <span class="tok-c1">// e.g. randomly generated using some utility method</span>
         <span class="tok-n">params</span><span class="tok-o">.</span><span class="tok-na">salt</span> <span class="tok-o">=</span> <span class="tok-n">salt</span>
      <span class="tok-o">}</span>
      <span class="tok-n">userInstance</span><span class="tok-o">.</span><span class="tok-na">properties</span> <span class="tok-o">=</span> <span class="tok-n">params</span>
      <span class="tok-k">if</span> <span class="tok-o">(!</span><span class="tok-n">userInstance</span><span class="tok-o">.</span><span class="tok-na">save</span><span class="tok-o">(</span><span class="tok-nl">flush:</span> <span class="tok-kc">true</span><span class="tok-o">))</span> <span class="tok-o">{</span>
         <span class="tok-n">render</span> <span class="tok-nl">view:</span> <span class="tok-s1">&#39;edit&#39;</span><span class="tok-o">,</span> <span class="tok-nl">model:</span> <span class="tok-o">[</span><span class="tok-nl">userInstance:</span> <span class="tok-n">userInstance</span><span class="tok-o">]</span>
         <span class="tok-k">return</span>
      <span class="tok-o">}</span>

      <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">springSecurityService</span><span class="tok-o">.</span><span class="tok-na">loggedIn</span> <span class="tok-o">&amp;&amp;</span>
             <span class="tok-n">springSecurityService</span><span class="tok-o">.</span><span class="tok-na">principal</span><span class="tok-o">.</span><span class="tok-na">username</span> <span class="tok-o">==</span> <span class="tok-n">userInstance</span><span class="tok-o">.</span><span class="tok-na">username</span><span class="tok-o">)</span> <span class="tok-o">{</span>
         <span class="tok-n">springSecurityService</span><span class="tok-o">.</span><span class="tok-na">reauthenticate</span> <span class="tok-n">userInstance</span><span class="tok-o">.</span><span class="tok-na">username</span>
      <span class="tok-o">}</span>

      <span class="tok-n">flash</span><span class="tok-o">.</span><span class="tok-na">message</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;The user was updated&quot;</span>
      <span class="tok-n">redirect</span> <span class="tok-nl">action:</span> <span class="tok-n">show</span><span class="tok-o">,</span> <span class="tok-nl">id:</span> <span class="tok-n">userInstance</span><span class="tok-o">.</span><span class="tok-na">id</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_otros_aspectos_interesantes_de_spring_security">7.7. Otros aspectos interesantes de Spring Security</h3>
<div class="paragraph">
<p>El plugin de Spring Security es sin duda uno de los más completos de Grails y en la documentación oficial encontrarás otros detalles del mismo. Sin embargo, aquí vamos a resaltar un par de ellos como son las restricciones por IP o la internacionalización del plugin.</p>
</div>
<div class="sect3">
<h4 id="_restricciones_por_ip">7.7.1. Restricciones por IP</h4>
<div class="paragraph">
<p>En ocasiones nos puede interesar proporcionar una serie de restricciones por IP de tal forma que únicamente las peticiones que vengan de esta IP podrán acceder al recurso. Esto lo debemos hacer en el archivo <em>Config.groovy</em> y este sería un ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">grails</span><span class="tok-o">.</span><span class="tok-na">plugin</span><span class="tok-o">.</span><span class="tok-na">springsecurity</span><span class="tok-o">.</span><span class="tok-na">ipRestrictions</span> <span class="tok-o">=</span> <span class="tok-o">[</span>
   <span class="tok-s1">&#39;/pattern1/**&#39;</span><span class="tok-o">:</span> <span class="tok-s1">&#39;123.234.345.456&#39;</span><span class="tok-o">,</span>
   <span class="tok-s1">&#39;/pattern2/**&#39;</span><span class="tok-o">:</span> <span class="tok-s1">&#39;10.0.0.0/8&#39;</span><span class="tok-o">,</span>
   <span class="tok-s1">&#39;/pattern3/**&#39;</span><span class="tok-o">:</span> <span class="tok-o">[</span><span class="tok-s1">&#39;10.10.200.42&#39;</span><span class="tok-o">,</span> <span class="tok-s1">&#39;10.10.200.63&#39;</span><span class="tok-o">]</span>
<span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_internacionalización">7.7.2. Internacionalización</h4>
<div class="paragraph">
<p>El plugin de Spring Security viene traducido al inglés y al francés (entre otros idiomas), así que si necesitamos traducirlo al castellano por ejemplo, debemos crear las siguientes propiedades en el archivo de literales correspondiente:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Propiedad</th>
<th class="tableblock halign-left valign-top">Valor por defecto en inglés</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">springSecurity.errors.login.expired</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sorry, your account has expired</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">springSecurity.errors.login.passwordExpired</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sorry, your password has expired.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">springSecurity.errors.login.disabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sorry, your password is disabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">springSecurity.errors.login.locked</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sorry, your account is locked.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">springSecurity.errors.login.fail</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sorry, we were not able to find a user with that username and password.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">springSecurity.login.title</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Login</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">springSecurity.login.header</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Please Login..</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">springSecurity.login.button</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Login</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">springSecurity.login.username.label</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Username</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">springSecurity.login.password.label</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">springSecurity.login.remember.me.label</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Remember me</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">springSecurity.denied.title</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Denied</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">springSecurity.denied.message</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sorry, you&#8217;re not authorized to view this page.</p></td>
</tr>
</tbody>
</table>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios_7">7.8. Ejercicios</h3>
<div class="sect3">
<h4 id="_roles_y_usuarios_0_50_puntos">7.8.1. Roles y usuarios (0.50 puntos)</h4>
<div class="paragraph">
<p>En nuestra aplicación vamos a introducir dos tipos de usuarios: los administradores y los usuarios básicos. Los administradores serán capaces de crear nuevos usuarios, etiquetas y categorías mientras que los usuarios básicos simplemente podrán gestionar sus propias tareas.</p>
</div>
<div class="paragraph">
<p>Para ello introduce en el <em>Bootstrap.groovy</em> la creación de:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Dos roles (ROLE_ADMIN, ROLE_BASIC)</p>
</li>
<li>
<p>Un usuario administrador con nombre de usuario y contraseña "admin"</p>
</li>
<li>
<p>Un par de usuarios básicos con nombres de usuario y contraseñas "usuario1" y "usuario2"</p>
</li>
<li>
<p>Asigna varias tareas a ambos usuarios básicos</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_modificar_plantillas_y_vistas_0_25_puntos">7.8.2. Modificar plantillas y vistas (0.25 puntos)</h4>
<div class="paragraph">
<p>En su momento creábamos una plantilla llamada <em>header.gsp</em> que se renderiza en la parte superior de la aplicación y que básicamente <em>pinta</em> un enlace para que el usuario se pueda identificar en el sistema.</p>
</div>
<div class="paragraph">
<p>En este ejercicio vamos a modificar esta plantilla para especificar los enlaces correctos <em>/login/auth</em> para identificarse en el sistema y <em>/logout/index</em> para abandonar el mismo. Una cosa que debes tener en cuenta es que para abandonar el sistema, el plugin Spring Security sólo acepta el método POST, con lo que tendrás que crear un botón dentro de un formulario para enviar esta petición utilizando el método adecuado. No olvides también imprimir en la cabecera el nombre de usuario de la persona identificada en el sistema.</p>
</div>
<div class="paragraph">
<p>Por otro lado, vamos a modificar la pantalla inicial de la aplicación para mostrar el contenido de la misma en función del tipo de usuario identificado, es decir, los administradores verán varios enlaces para mantener usuarios, etiquetas y categorías mientras que los usuarios básicos sólo podrán mantener sus tareas.</p>
</div>
</div>
<div class="sect3">
<h4 id="_diferente_rol_diferentes_reglas_0_25_punto">7.8.3. Diferente rol, diferentes reglas (0.25 punto)</h4>
<div class="paragraph">
<p>Por último, ahora que la aplicación soporta varios roles, deberemos distinguir que rol tiene acceso a que partes de la aplicación. Como comentábamos en el primer ejercicio, los administradores serán los encargados de gestionar usuarios, etiquetas y categorías, mientras que los usuarios básicos sólo podrán acceder a sus tareas. No olvides añadir reglas para los endpoints que añadíamos cuando hablamos sobre servicios REST.</p>
</div>
<div class="paragraph">
<p>Tendremos que realizar una serie de cambios en nuestra aplicación para que al crear una tarea, ésta sea asignada automáticamente al usuario identificado en el sistema. Deberemos proceder de la misma forma con el listado de las tareas para que sólo se muestren al usuario sus propias tareas.</p>
</div>
<div class="paragraph">
<p>Además, deberemos eliminar cualquier enlace presente en la aplicación que enlace a alguna parte que el usuario no deba tener acceso, como por ejemplo, la posibilidad de crear etiquetas desde la página de creación de tareas.</p>
</div>
</div>
<div class="sect3">
<h4 id="_modificar_los_tests_unitarios_0_25_puntos">7.8.4. Modificar los tests unitarios (0.25 puntos)</h4>
<div class="paragraph">
<p>Si volvemos a ejecutar los tests unitarios, nos daremos cuenta de que acabamos de romper aquellos que creaban tareas y ésto ha sido provocado por la introducción de la relación entre las tareas y los usuarios.</p>
</div>
<div class="paragraph">
<p>Soluciona estos problemas en los tests <em>TodoSpec.groovy</em>, <em>TodoServiceSpec.groovy</em> y <em>TodoControllerSpec.groovy</em>.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion08">8. Configuración de aplicaciones. Plugins interesantes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>En esta última sesión de Grails analizaremos los diferentes aspectos de configuración de nuestra aplicación y posteriormente instalaremos algunos plugins interesantes desarrollados por la comunidad de usuarios de Grails.</p>
</div>
<div class="sect2">
<h3 id="_configuración_de_aplicaciones">8.1. Configuración de aplicaciones</h3>
<div class="sect3">
<h4 id="_el_archivo_config_groovy">8.1.1. El archivo Config.groovy</h4>
<div class="paragraph">
<p>El archivo <em>grails-app/conf/Config.groovy</em> contiene los parámetros de configuración general de nuestra aplicación. En este archivo se pueden declarar variables que estarán disponibles en cualquier artefacto de nuestra aplicación a través del objeto global <em>grailsApplication.config</em>. Por ejemplo si definimos la siguiente variable <em>es.ua.expertojava.todo.miParametro = "dato"</em>, ésta va a ser accesible desde cualquier controlador, vista, servicio, etc. mediante la expresión <em>grailsApplication.config.es.ua.expertojava.todo.miParametro</em>.</p>
</div>
<div class="paragraph">
<p>Además de poder declarar nuevas variables globales, el archivo <em>Config.groovy</em> utiliza una serie de variables definidas que tienen el siguiente significado:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>grails.config.locations</em>: ubicaciones donde encontrar otros archivos de configuración que se fundirán con el principal <em>Config.groovy</em>. Esta variable está comentada por defecto con lo que sólo se tendrá en cuenta el archivo <em>Config.groovy</em>.</p>
</li>
<li>
<p><em>grails.project.groupId</em>: nombre por defecto del paquete en el que se crean todos los artefactos de la aplicación. Por defecto tenemos que este paquete coincidirá con el nombre de la aplicación. Lo podríamos modificar por ejemplo a "es.ua.expertojava.todo" para no ahorrarnos tener que especificar el paquete cada vez que creamos un nuevo artefacto.</p>
</li>
<li>
<p><em>grails.views.default.codec</em>: especifica el formato por defecto de nuestras páginas GSPs. Puede tomar el valor 'none', 'html', o 'base64'. Por defecto se utiliza el valor html.</p>
</li>
<li>
<p><em>grails.controllers.defaultScope</em>: el <em>scope</em> por defecto de los controladores, en principio <em>singleton</em>.</p>
</li>
<li>
<p><em>grails.views.gsp</em>: un mapa de configuración de como se van a renderizar nuestras páginas GSP.</p>
</li>
<li>
<p><em>grails.converters.encoding</em>: codificación de los convertidores</p>
</li>
<li>
<p><em>grails.scaffolding.templates.domainSuffix</em>: el sufijo añadido a las instancias de nuestras clases de dominio en el plugin <em>scaffolding</em>.</p>
</li>
<li>
<p><em>grails.mime.types</em>: indica un mapa con los posibles tipos mime soportados en nuestra aplicación</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_sistema_de_logs">8.1.2. Sistema de logs</h4>
<div class="paragraph">
<p>Grails utiliza la librería <em>log4j</em> para implementar todo el sistema de logs. Podemos configurar estos logs de nuestras aplicaciones en el propio archivo <em>Config.groovy</em>. Aquí encontraremos una variable llamada <em>log4j</em> que ya viene con algunas reglas.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">log4j</span><span class="tok-o">.</span><span class="tok-na">main</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
    <span class="tok-n">error</span>  <span class="tok-s1">&#39;org.codehaus.groovy.grails.web.servlet&#39;</span><span class="tok-o">,</span>  <span class="tok-c1">//  controllers</span>
           <span class="tok-s1">&#39;org.codehaus.groovy.grails.web.pages&#39;</span><span class="tok-o">,</span> <span class="tok-c1">//  GSP</span>
           <span class="tok-s1">&#39;org.codehaus.groovy.grails.web.sitemesh&#39;</span><span class="tok-o">,</span> <span class="tok-c1">//  layouts</span>
           <span class="tok-s1">&#39;org.codehaus.groovy.grails.web.mapping.filter&#39;</span><span class="tok-o">,</span> <span class="tok-c1">// URL mapping</span>
           <span class="tok-s1">&#39;org.codehaus.groovy.grails.web.mapping&#39;</span><span class="tok-o">,</span> <span class="tok-c1">// URL mapping</span>
           <span class="tok-s1">&#39;org.codehaus.groovy.grails.commons&#39;</span><span class="tok-o">,</span> <span class="tok-c1">// core / classloading</span>
           <span class="tok-s1">&#39;org.codehaus.groovy.grails.plugins&#39;</span><span class="tok-o">,</span> <span class="tok-c1">// plugins</span>
           <span class="tok-s1">&#39;org.codehaus.groovy.grails.orm.hibernate&#39;</span><span class="tok-o">,</span> <span class="tok-c1">// hibernate integration</span>
           <span class="tok-s1">&#39;org.springframework&#39;</span><span class="tok-o">,</span>
           <span class="tok-s1">&#39;org.hibernate&#39;</span><span class="tok-o">,</span>
           <span class="tok-s1">&#39;net.sf.ehcache.hibernate&#39;</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En esta configuración se especifica que aquellos problemas surgidos a nivel <em>error</em> serán añadidos al archivo de logs. Habitualmente tenemos ocho niveles estándar de logs.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>off</p>
</li>
<li>
<p>fatal</p>
</li>
<li>
<p>error</p>
</li>
<li>
<p>warn</p>
</li>
<li>
<p>info</p>
</li>
<li>
<p>debug</p>
</li>
<li>
<p>trace</p>
</li>
<li>
<p>all</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Esto significa que si por ejemplo especificamos <em>warn 'org.example.domain'</em>, todos los problemas surgidos de tipo <em>warn</em>, <em>error</em> o <em>fatal</em> serán impresos en el archivo. Los otros niveles serán ignorados.</p>
</div>
<div class="paragraph">
<p>Lo habitual es que necesitemos generar logs en controladores, servicios y otros artefactos. Estos artefactos se encuentran en el paquete <em>grails.app.&lt;tipo_de_artefacto&gt;.&lt;nombre_de_clase&gt;</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">log4j</span><span class="tok-o">.</span><span class="tok-na">main</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
  <span class="tok-c1">// Establecemos el nivel info para todos los artefactos de la aplicación</span>
  <span class="tok-n">info</span> <span class="tok-s2">&quot;grails.app&quot;</span>

  <span class="tok-c1">// Especificamos el nivel debug para el controlador de la clase Tag</span>
  <span class="tok-n">debug</span> <span class="tok-s2">&quot;grails.app.controllers.es.ua.expertojava.todo.TagController&quot;</span>

  <span class="tok-c1">// Especificamos el nivel error para el servicio de la clase Todo</span>
  <span class="tok-n">error</span> <span class="tok-s2">&quot;grails.app.services.es.ua.expertojava.todo.TodoService&quot;</span>

  <span class="tok-c1">// Especificamos el nivel para todas las librerías de etiquetas</span>
  <span class="tok-n">info</span> <span class="tok-s2">&quot;grails.app.taglib&quot;</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Los tipos de artefactos pueden ser los siguientes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>conf</em>: para todo lo que esté en el directorio de configuración <em>grails-app/con</em></p>
</li>
<li>
<p><em>filters</em>: para los filtros</p>
</li>
<li>
<p><em>taglib</em>: para las librerías de etiquetas</p>
</li>
<li>
<p><em>services</em>: para los servicios</p>
</li>
<li>
<p><em>controllers</em>: para los controladores</p>
</li>
<li>
<p><em>domain</em>: para las clases de dominio</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Vamos a implementar un pequeño ejemplo en nuestra aplicación. En primer lugar, vamos a crear un appender, que no es más que un objeto en el cual especificamos como y donde queremos escribir los mensajes de log. En nuestro caso lo haremos escribiendo en un archivo de logs, aunque también podríamos haber optado por enviarlo a un correo electrónico o bien almacenarlo en una base de datos.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">log4j</span><span class="tok-o">.</span><span class="tok-na">main</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
  <span class="tok-n">appenders</span> <span class="tok-o">{</span>
    <span class="tok-n">file</span> <span class="tok-nl">name:</span><span class="tok-s1">&#39;file&#39;</span><span class="tok-o">,</span> <span class="tok-nl">file:</span><span class="tok-s1">&#39;mylog.log&#39;</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A continuación, vamos a indicarle a nuestra aplicación que queremos utilizar este appender en el controlador de la clase <em>Category</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">trace</span> <span class="tok-nl">file:</span> <span class="tok-s2">&quot;grails.app.controllers.es.ua.expertojava.todo.CategoryController&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por último, añadiremos una línea en el método <em>index()</em> del controlador <em>CategoryController</em> para escribir un mensaje de prueba.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-nf">index</span><span class="tok-o">()</span> <span class="tok-o">{</span>
  <span class="tok-n">log</span><span class="tok-o">.</span><span class="tok-na">trace</span><span class="tok-o">(</span><span class="tok-s2">&quot;Método index del controlador CategoryController&quot;</span><span class="tok-o">)</span>
  <span class="tok-n">params</span><span class="tok-o">.</span><span class="tok-na">max</span> <span class="tok-o">=</span> <span class="tok-n">Math</span><span class="tok-o">.</span><span class="tok-na">min</span><span class="tok-o">(</span><span class="tok-n">max</span> <span class="tok-o">?:</span> <span class="tok-mi">10</span><span class="tok-o">,</span> <span class="tok-mi">100</span><span class="tok-o">)</span>
  <span class="tok-n">respond</span> <span class="tok-n">Category</span><span class="tok-o">.</span><span class="tok-na">list</span><span class="tok-o">(</span><span class="tok-n">params</span><span class="tok-o">),</span> <span class="tok-nl">model:</span><span class="tok-o">[</span><span class="tok-nl">categoryInstanceCount:</span> <span class="tok-n">Category</span><span class="tok-o">.</span><span class="tok-na">count</span><span class="tok-o">()]</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si todo ha ido bien, tendremos un archivo en la raíz de nuestra aplicación llamado <em>mylog.log</em> y que añadirá el mensaje que hemos creado cada vez que se muestre el listado de usuarios.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-mi">2015</span><span class="tok-o">-</span><span class="tok-mi">03</span><span class="tok-o">-</span><span class="tok-mi">28</span> <span class="tok-mi">12</span><span class="tok-o">:</span><span class="tok-mi">05</span><span class="tok-o">:</span><span class="tok-mi">08</span><span class="tok-o">,</span><span class="tok-mi">549</span> <span class="tok-o">[</span><span class="tok-s2">&quot;http-bio-8080&quot;</span><span class="tok-o">-</span><span class="tok-n">exec</span><span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-o">]</span> <span class="tok-n">TRACE</span> <span class="tok-n">es</span><span class="tok-o">.</span><span class="tok-na">ua</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">todo</span><span class="tok-o">.</span><span class="tok-na">CategoryController</span>  <span class="tok-o">-</span>
<span class="tok-n">M</span><span class="tok-err">é</span><span class="tok-n">todo</span> <span class="tok-n">index</span> <span class="tok-n">del</span> <span class="tok-n">controlador</span> <span class="tok-n">CategoryController</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_el_archivo_buildconfig_groovy">8.1.3. El archivo BuildConfig.groovy</h4>
<div class="paragraph">
<p>Además del archivo <em>Config.groovy</em>, todos los aspectos relativos a la configuración de la generación del proyecto se encuentran en el archivo <em>conf/BuildConfig.groovy</em>. En este archivo podemos encontrar las siguientes variables definidas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>grails.servlet.version</em>: indicamos la especificación de Servlets. Por defecto utilizaremos la versión 3.0.</p>
</li>
<li>
<p><em>grails.project.class.dir</em>: especificamos el directorio donde se alojarán todos los archivos compilados del proyecto. Por defecto se alojarán en el directorio <em>target/classes</em></p>
</li>
<li>
<p><em>grails.project.test.class.dir</em>: especificamos el directorio donde se compilarán los tests de nuestros proyectos. Por defecto se alojarán en el directorio <em>target/test-classes</em></p>
</li>
<li>
<p><em>grails.project.test.reports.dir</em>: especificamos el directorio donde se alojarán los informes de las ejecuciones de los tests. Por defecto los tendremos en <em>target/test-reports</em></p>
</li>
<li>
<p><em>grails.project.target.level</em>: especificamos la versión de la máquina virtual de java. Por defecto será la 1.6</p>
</li>
<li>
<p><em>grails.project.war.file</em>: especificamos el nombre y la ubicación del archivo war que se generará. Por defecto, se alojarán en el directorio <em>target</em> y se llamará con el nombre de la aplicación seguido de la versión, empezando por la <em>0.1</em></p>
</li>
<li>
<p><em>grails.project.fork</em>: parámetros de configuración de la máquina virtual de Java utilizada en cada entorno de ejecución.</p>
</li>
<li>
<p><em>grails.project.dependency.resolution</em>: especificamos como se resuelven las dependencias de los archivos JAR de nuestros proyectos.</p>
</li>
<li>
<p><em>grails.project.dependency.resolution.plugins</em>: un listado de los plugins utilizados en nuestra aplicación.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_el_archivo_datasource_groovy">8.1.4. El archivo DataSource.groovy</h4>
<div class="paragraph">
<p>Muchas empresas disponen de varios entornos que las aplicaciones deben superar para finalmente pasar a disposición de los usuarios finales. Los entornos más habituales son el <em>entorno de desarrollo</em> que se refiere al entorno propio del desarrollador, con su propio servidor local instalado en su ordenador, el <em>entorno de tests</em> en el que otras personas se encargan de comprobar que la aplicación funciona tal y como se espera de ella y por último, el <em>entorno de producción</em>, que es donde aparecen en escena los usuarios finales, que son quienes realmente "probarán" el buen funcionamiento de la aplicación.</p>
</div>
<div class="paragraph">
<p>En cada uno de estos entornos, lo habitual es tener una configuración de base de datos diferente para cada uno, puesto que los requerimientos serán distintos. Por ejemplo, en un entorno de desarrollo posiblemente nos sea suficiente utilizar una base de datos en memoria como H2, pero este tipo de base de datos será insuficiente para los entornos de test y producción con lo que deberemos utilizar un servidor de base de datos como por ejemplo MySQL.</p>
</div>
<div class="paragraph">
<p>Como no podía ser menos, Grails lo tiene todo preparado para realizar esta diferenciación sin problemas. El archivo <em>grails-app/conf/DataSource.groovy</em> se encarga de todo mediante la creación por defecto de tres entornos de desarrollo: <em>desarrollo, test y producción</em>, tal y como puedes comprobar en el siguiente ejemplo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">dataSource</span> <span class="tok-o">{</span>
    <span class="tok-n">pooled</span> <span class="tok-o">=</span> <span class="tok-kc">true</span>
    <span class="tok-n">jmxExport</span> <span class="tok-o">=</span> <span class="tok-kc">true</span>
    <span class="tok-n">driverClassName</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;org.h2.Driver&quot;</span>
    <span class="tok-n">username</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;sa&quot;</span>
    <span class="tok-n">password</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;&quot;</span>
<span class="tok-o">}</span>
<span class="tok-n">hibernate</span> <span class="tok-o">{</span>
    <span class="tok-n">cache</span><span class="tok-o">.</span><span class="tok-na">use_second_level_cache</span> <span class="tok-o">=</span> <span class="tok-kc">true</span>
    <span class="tok-n">cache</span><span class="tok-o">.</span><span class="tok-na">use_query_cache</span> <span class="tok-o">=</span> <span class="tok-kc">false</span>
<span class="tok-c1">//    cache.region.factory_class = &#39;net.sf.ehcache.hibernate.EhCacheRegionFactory&#39; // Hibernate 3</span>
    <span class="tok-n">cache</span><span class="tok-o">.</span><span class="tok-na">region</span><span class="tok-o">.</span><span class="tok-na">factory_class</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;org.hibernate.cache.ehcache.EhCacheRegionFactory&#39;</span> <span class="tok-c1">// Hibernate 4</span>
    <span class="tok-n">singleSession</span> <span class="tok-o">=</span> <span class="tok-kc">true</span> <span class="tok-c1">// configure OSIV singleSession mode</span>
    <span class="tok-n">flush</span><span class="tok-o">.</span><span class="tok-na">mode</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;manual&#39;</span> <span class="tok-c1">// OSIV session flush mode outside of transactional context</span>
<span class="tok-o">}</span>

<span class="tok-c1">// environment specific settings</span>
<span class="tok-n">environments</span> <span class="tok-o">{</span>
    <span class="tok-n">development</span> <span class="tok-o">{</span>
        <span class="tok-n">dataSource</span> <span class="tok-o">{</span>
            <span class="tok-n">dbCreate</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;create-drop&quot;</span> <span class="tok-c1">// one of &#39;create&#39;, &#39;create-drop&#39;, &#39;update&#39;, &#39;validate&#39;, &#39;&#39;</span>
            <span class="tok-n">url</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;jdbc:h2:mem:devDb;MVCC=TRUE;LOCK_TIMEOUT=10000;DB_CLOSE_ON_EXIT=FALSE&quot;</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>
    <span class="tok-n">test</span> <span class="tok-o">{</span>
        <span class="tok-n">dataSource</span> <span class="tok-o">{</span>
            <span class="tok-n">dbCreate</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;update&quot;</span>
            <span class="tok-n">url</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;jdbc:h2:mem:testDb;MVCC=TRUE;LOCK_TIMEOUT=10000;DB_CLOSE_ON_EXIT=FALSE&quot;</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>
    <span class="tok-n">production</span> <span class="tok-o">{</span>
        <span class="tok-n">dataSource</span> <span class="tok-o">{</span>
            <span class="tok-n">dbCreate</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;update&quot;</span>
            <span class="tok-n">url</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;jdbc:h2:prodDb;MVCC=TRUE;LOCK_TIMEOUT=10000;DB_CLOSE_ON_EXIT=FALSE&quot;</span>
            <span class="tok-n">properties</span> <span class="tok-o">{</span>
               <span class="tok-c1">// See http://grails.org/doc/latest/guide/conf.html#dataSource for documentation</span>
               <span class="tok-n">jmxEnabled</span> <span class="tok-o">=</span> <span class="tok-kc">true</span>
               <span class="tok-n">initialSize</span> <span class="tok-o">=</span> <span class="tok-mi">5</span>
               <span class="tok-n">maxActive</span> <span class="tok-o">=</span> <span class="tok-mi">50</span>
               <span class="tok-n">minIdle</span> <span class="tok-o">=</span> <span class="tok-mi">5</span>
               <span class="tok-n">maxIdle</span> <span class="tok-o">=</span> <span class="tok-mi">25</span>
               <span class="tok-n">maxWait</span> <span class="tok-o">=</span> <span class="tok-mi">10000</span>
               <span class="tok-n">maxAge</span> <span class="tok-o">=</span> <span class="tok-mi">10</span> <span class="tok-o">*</span> <span class="tok-mi">60000</span>
               <span class="tok-n">timeBetweenEvictionRunsMillis</span> <span class="tok-o">=</span> <span class="tok-mi">5000</span>
               <span class="tok-n">minEvictableIdleTimeMillis</span> <span class="tok-o">=</span> <span class="tok-mi">60000</span>
               <span class="tok-n">validationQuery</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;SELECT 1&quot;</span>
               <span class="tok-n">validationQueryTimeout</span> <span class="tok-o">=</span> <span class="tok-mi">3</span>
               <span class="tok-n">validationInterval</span> <span class="tok-o">=</span> <span class="tok-mi">15000</span>
               <span class="tok-n">testOnBorrow</span> <span class="tok-o">=</span> <span class="tok-kc">true</span>
               <span class="tok-n">testWhileIdle</span> <span class="tok-o">=</span> <span class="tok-kc">true</span>
               <span class="tok-n">testOnReturn</span> <span class="tok-o">=</span> <span class="tok-kc">false</span>
               <span class="tok-n">jdbcInterceptors</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;ConnectionState&quot;</span>
               <span class="tok-n">defaultTransactionIsolation</span> <span class="tok-o">=</span> <span class="tok-n">java</span><span class="tok-o">.</span><span class="tok-na">sql</span><span class="tok-o">.</span><span class="tok-na">Connection</span><span class="tok-o">.</span><span class="tok-na">TRANSACTION_READ_COMMITTED</span>
            <span class="tok-o">}</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En el primer bloque <em>dataSource</em> se definen una serie de valores genéricos, que posteriormente podremos sobreescribir en cada uno de los entornos. El bloque <em>hibernate</em> se refiere a parámetros de configuración del propio hibernate, mientras que el último bloque de <em>environments</em> es el que nos va a permitir diferenciar cada uno de los entornos.</p>
</div>
<div class="paragraph">
<p>Por defecto Grails crea los tres entornos de los que hablábamos anteriormente. Con el comando <em>grails run-app</em> que hemos utilizado hasta ahora, la aplicación se ejecuta en el entorno de desarrollo, que es el utilizado por defecto, pero si quisiéramos utilizar otro entorno podríamos ejecutar los comandos de la siguiente tabla:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Entorno</th>
<th class="tableblock halign-left valign-top">Comando</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">Desarrollo</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>grails dev run-app</em> o <em>grails run-app</em></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">Test</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>grails test run-app</em></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">Producción</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>grails prod run-app</em></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>En el fichero <em>DataSource.groovy</em> se puede comprobar las tres configuraciones para cada uno de los entornos. Para los entornos de desarrollo y test se va a utilizar una base de datos en memoria como H2, eso si, diferente para cada uno de ellos (<em>devDB</em> y <em>testDb</em>).</p>
</div>
<div class="paragraph">
<p>Para el entorno de producción deberíamos utilizar una base de datos más robusta y propia de entornos de producción como es MySQL. Para ello le especificamos la URI de la base de datos, así como el controlador, el nombre de usuario y la contraseña de acceso a la misma.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">production</span> <span class="tok-o">{</span>
        <span class="tok-n">dataSource</span> <span class="tok-o">{</span>
            <span class="tok-n">dbCreate</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;update&quot;</span>
            <span class="tok-n">url</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;jdbc:mysql://localhost:3306/todo?useUnicode=true&amp;characterEncoding=UTF-8&quot;</span>
            <span class="tok-n">username</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;userprod&quot;</span>
            <span class="tok-n">password</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;pwdprod&quot;</span>
            <span class="tok-n">properties</span> <span class="tok-o">{</span>
               <span class="tok-c1">// See http://grails.org/doc/latest/guide/conf.html#dataSource for documentation</span>
               <span class="tok-n">jmxEnabled</span> <span class="tok-o">=</span> <span class="tok-kc">true</span>
               <span class="tok-n">initialSize</span> <span class="tok-o">=</span> <span class="tok-mi">5</span>
               <span class="tok-n">maxActive</span> <span class="tok-o">=</span> <span class="tok-mi">50</span>
               <span class="tok-n">minIdle</span> <span class="tok-o">=</span> <span class="tok-mi">5</span>
               <span class="tok-n">maxIdle</span> <span class="tok-o">=</span> <span class="tok-mi">25</span>
               <span class="tok-n">maxWait</span> <span class="tok-o">=</span> <span class="tok-mi">10000</span>
               <span class="tok-n">maxAge</span> <span class="tok-o">=</span> <span class="tok-mi">10</span> <span class="tok-o">*</span> <span class="tok-mi">60000</span>
               <span class="tok-n">timeBetweenEvictionRunsMillis</span> <span class="tok-o">=</span> <span class="tok-mi">5000</span>
               <span class="tok-n">minEvictableIdleTimeMillis</span> <span class="tok-o">=</span> <span class="tok-mi">60000</span>
               <span class="tok-n">validationQuery</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;SELECT 1&quot;</span>
               <span class="tok-n">validationQueryTimeout</span> <span class="tok-o">=</span> <span class="tok-mi">3</span>
               <span class="tok-n">validationInterval</span> <span class="tok-o">=</span> <span class="tok-mi">15000</span>
               <span class="tok-n">testOnBorrow</span> <span class="tok-o">=</span> <span class="tok-kc">true</span>
               <span class="tok-n">testWhileIdle</span> <span class="tok-o">=</span> <span class="tok-kc">true</span>
               <span class="tok-n">testOnReturn</span> <span class="tok-o">=</span> <span class="tok-kc">false</span>
               <span class="tok-n">jdbcInterceptors</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;ConnectionState&quot;</span>
               <span class="tok-n">defaultTransactionIsolation</span> <span class="tok-o">=</span> <span class="tok-n">java</span><span class="tok-o">.</span><span class="tok-na">sql</span><span class="tok-o">.</span><span class="tok-na">Connection</span><span class="tok-o">.</span><span class="tok-na">TRANSACTION_READ_COMMITTED</span>
            <span class="tok-o">}</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Además, deberíamos disponer del driver correspondiente de MySQL (<a href="http://www.mysql.com/downloads/connector/j/" class="bare">http://www.mysql.com/downloads/connector/j/</a>) y copiarlo en el directorio <em>lib</em> de la aplicación o bien especificarlo en las dependencias en el archivo <em>BuildConfig.groovy</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">grails</span><span class="tok-o">.</span><span class="tok-na">project</span><span class="tok-o">.</span><span class="tok-na">dependency</span><span class="tok-o">.</span><span class="tok-na">resolution</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
  <span class="tok-o">...</span>

  <span class="tok-n">dependencies</span> <span class="tok-o">{</span>
    <span class="tok-n">runtime</span> <span class="tok-s1">&#39;mysql:mysql-connector-java:5.1.34&#39;</span>
  <span class="tok-o">}</span>
  <span class="tok-o">....</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Además, mediante el parámetro <em>dbCreate</em> podemos especificar la forma en la que Grails debe generar el esquema de la base de datos a partir de la definición de las clases de dominio. Este parámetro puede tomar tres valores diferentes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>create-drop</em>. El esquema de la base de datos se creará cada vez que arranquemos la aplicación en el entorno dado, y será destruido al interrumpir su ejecución.</p>
</li>
<li>
<p><em>create</em>. Crea el esquema de la base de datos, en caso de que el éste no exista, pero no modifica el esquema existente, aunque si borrará todos los datos almacenados en la misma.</p>
</li>
<li>
<p><em>update</em>. Crea la base de datos si no existe, y actualiza las tablas si detecta que se han añadido entidades nuevas o campos a los ya existentes. Estas modificaciones no incluirán la eliminación o modificación de nada en la base de datos, con lo que hay que tener cuidado con este tipo de cambios en las clases de dominio y que luego no se ven reflejados automáticamente en la base de datos.</p>
</li>
<li>
<p><em>validate</em>. Simplemente compara nuestro esquema actual con la base de datos especificada para enviarnos algún que otro aviso de diferencia.</p>
</li>
<li>
<p><em>cualquier otro valor</em>. Si especificamos cualquier otro valor, Grails no hará nada por nosotros. No debemos especificar ningún valor a la variable <em>dbCreate</em> si nos encargaremos de la base de datos nosotros mismos mediante una herramienta externa.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_el_archivo_bootstrap_groovy">8.1.5. El archivo BootStrap.groovy</h4>
<div class="paragraph">
<p>A lo largo de las sesiones relativas a Grails, hemos utilizado el archivo de configuración <em>BootStrap.groovy</em> para insertar ciertos datos de ejemplo en nuestra aplicación que nos han servido para comprobar su funcionamiento.</p>
</div>
<div class="paragraph">
<p>El archivo define dos closures, <em>init</em> y <em>destroy</em>. El primero de ellos se ejecutará cada vez que ejecutemos la aplicación mediante el comando <em>grails run-app</em> en cualquiera de los entornos de ejecución recientemente comentados. Mientras que el closure <em>destroy</em> se ejecutará cuando paremos la ejecución de la aplicación.</p>
</div>
<div class="paragraph">
<p>Hasta el momento, cuando hemos insertado los datos en la base de datos, lo hacíamos independientemente del entorno de ejecución en el que estuviéramos, algo que no será lo habitual, puesto que para los entornos de test y producción, es más que probable que los datos ya estén almacenados en la base de datos o bien se inserten mediante una batería de pruebas en el caso del entorno de tests.</p>
</div>
<div class="paragraph">
<p>Teniendo en cuesta esto, necesitaremos diferenciar en cada momento el entorno de ejecución de nuestra aplicación para insertar datos o no. Para ello, Grails dispone de la clase <em>grails.util.Environment</em> y la variable <em>current</em> que nos indica cual es el entorno de ejecución actual. El siguiente código de ejemplo, muestra como realizar esta distinción a la hora de insertar datos en diferentes entornos.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">import</span> <span class="tok-nn">grails.util.Environment</span>

<span class="tok-kd">class</span> <span class="tok-nc">BootStrap</span> <span class="tok-o">{</span>
  <span class="tok-kt">def</span> <span class="tok-n">init</span> <span class="tok-o">=</span> <span class="tok-o">{</span> <span class="tok-n">servletContext</span> <span class="tok-o">-&gt;</span>
    <span class="tok-k">switch</span> <span class="tok-o">(</span><span class="tok-n">Environment</span><span class="tok-o">.</span><span class="tok-na">current</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-k">case</span> <span class="tok-n">Environment</span><span class="tok-o">.</span><span class="tok-na">DEVELOPMENT</span><span class="tok-o">:</span>
        <span class="tok-n">configuracionDesarrollo</span><span class="tok-o">()</span>
        <span class="tok-k">break</span>
      <span class="tok-k">case</span> <span class="tok-n">Environment</span><span class="tok-o">.</span><span class="tok-na">PRODUCTION</span><span class="tok-o">:</span>
        <span class="tok-n">configuracionProduccion</span><span class="tok-o">()</span>
        <span class="tok-k">break</span>
      <span class="tok-k">case</span> <span class="tok-n">Environment</span><span class="tok-o">.</span><span class="tok-na">TEST</span><span class="tok-o">:</span>
        <span class="tok-n">configuracionTest</span><span class="tok-o">()</span>
        <span class="tok-k">break</span>
    <span class="tok-o">}</span>
  <span class="tok-o">}</span>
  <span class="tok-kt">def</span> <span class="tok-n">destroy</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
    <span class="tok-k">switch</span> <span class="tok-o">(</span><span class="tok-n">Environment</span><span class="tok-o">.</span><span class="tok-na">current</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-k">case</span> <span class="tok-n">Environment</span><span class="tok-o">.</span><span class="tok-na">DEVELOPMENT</span><span class="tok-o">:</span>
        <span class="tok-n">salirDesarrollo</span><span class="tok-o">()</span>
        <span class="tok-k">break</span>
      <span class="tok-k">case</span> <span class="tok-n">Environment</span><span class="tok-o">.</span><span class="tok-na">PRODUCTION</span><span class="tok-o">:</span>
        <span class="tok-n">salirProduccion</span><span class="tok-o">()</span>
        <span class="tok-k">break</span>
      <span class="tok-k">case</span> <span class="tok-n">Environment</span><span class="tok-o">.</span><span class="tok-na">TEST</span><span class="tok-o">:</span>
        <span class="tok-n">salirTest</span><span class="tok-o">()</span>
        <span class="tok-k">break</span>
    <span class="tok-o">}</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_el_archivo_urlmappings_groovy">8.1.6. El archivo UrlMappings.groovy</h4>
<div class="paragraph">
<p>Otro de los archivos interesantes en la configuración de una aplicación Grails es <em>UrlMappings.groovy</em>. Gracias a este archivo vamos a poder definir nuevas relaciones entre las URLs y los controladores.</p>
</div>
<div class="paragraph">
<p>Por defecto, este archivo indica que el primer parámetro que sigue al nombre de la aplicación se refiere al controlador, el segundo a la acción y el tercero al identificador de la instancia de la clase de dominio que estamos tratando. Además, en reciente versiones de Grails se ha añadido un nuevo parámetro que indica el formato de la petición, por ejemplo, json o xml.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">class</span> <span class="tok-nc">UrlMappings</span> <span class="tok-o">{</span>

  <span class="tok-kd">static</span> <span class="tok-n">mappings</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
        <span class="tok-s2">&quot;/$controller/$action?/$id?(.$format)?&quot;</span><span class="tok-o">{</span>
            <span class="tok-n">constraints</span> <span class="tok-o">{</span>
                <span class="tok-c1">// apply constraints here</span>
            <span class="tok-o">}</span>
        <span class="tok-o">}</span>

        <span class="tok-s2">&quot;/&quot;</span><span class="tok-o">(</span><span class="tok-nl">view:</span><span class="tok-s2">&quot;/index&quot;</span><span class="tok-o">)</span>
        <span class="tok-s2">&quot;500&quot;</span><span class="tok-o">(</span><span class="tok-nl">view:</span><span class="tok-s1">&#39;/error&#39;</span><span class="tok-o">)</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Un ejemplo típico del uso del mapeo de URLs es modificar este comportamiento para permitir otras URLs más limpias. Por ejemplo, como administradores de la aplicación estaría bien poder ver las tareas de los usuarios a partir de su nombre de usuario, algo como <a href="http://localhost:8080/todo/usuario1" class="bare">http://localhost:8080/todo/usuario1</a>.</p>
</div>
<div class="paragraph">
<p>Para ello, podemos introducir una nueva regla en el archivo <em>UrlMappings.groovy</em> para que la aplicación sepa como actuar cuando le llegue una petición con una URL del estilo de la comentada. La siguiente regla se encargaría de este redireccionamiento encubierto.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-s2">&quot;/todos/$username&quot;</span><span class="tok-o">(</span><span class="tok-nl">controller:</span><span class="tok-s2">&quot;todo&quot;</span><span class="tok-o">,</span><span class="tok-nl">action:</span><span class="tok-s2">&quot;showTodosByUser&quot;</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>O bien podemos optar por una sintaxis diferente.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-s2">&quot;/$username&quot;</span><span class="tok-o">{</span>
      <span class="tok-n">controller</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;todo&quot;</span>
      <span class="tok-n">action</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;showtodosbyuser&quot;</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En primer lugar le especificamos la parte de la URL a partir del nombre de la aplicación que necesitamos que concuerde y después definimos que controlador y que acción se deben encargar de procesar esta petición. En ambas opciones tendremos acceso al valor del nombre de usuario a través de la variable <em>params.username</em>.</p>
</div>
<div class="paragraph">
<p>Posteriormente, deberíamos implementar un método en el controlador <em>TodoController</em> llamado <em>showTodosByUser()</em> que nos devolviera aquellos tareas que pertenezcan al usuario cuyo nombre de usuario coincida con el pasado en la url.</p>
</div>
<div class="paragraph">
<p>Otra posible utilidad del mapeo de URLs es la internacionalización de las URLs. Por ejemplo, en nuestra aplicación hemos definido las clases de dominio en inglés y por lo tanto las URLs se muestran también en inglés. Si deseamos que estas URLs se muestren también en castellano, podemos crear una serie de reglas en el archivo <em>UrlMappings.groovy</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-s2">&quot;/tarea/$action?/$id?(.$format)?&quot;</span><span class="tok-o">{</span>
      <span class="tok-n">controller</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;tarea&quot;</span>
<span class="tok-o">}</span>

<span class="tok-s2">&quot;/usuario/$action?/$id?(.$format)?&quot;</span><span class="tok-o">{</span>
      <span class="tok-n">controller</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;user&quot;</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Las reglas de mapeo también permiten la introducción de restricciones que deben cumplir las partes de la URL. Por ejemplo, si quisiéramos obtener un listado con todos las tareas creadas un determinado día podríamos tener la siguiente url <a href="http://localhost:8080/todo/2015/03/28" class="bare">http://localhost:8080/todo/2015/03/28</a>. Las restricciones que debe cumplir la URL son que el año debe ser una cifra de cuatro dígitos mientras que el mes debe estar compuesta por dos números y el día por otras dos. Para que la aplicación supiera que hacer con este tipo de direcciones debemos introducir la siguiente regla de mapeo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-s2">&quot;/$year/$month/$day&quot;</span> <span class="tok-o">{</span>
  <span class="tok-n">controller</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;todo&quot;</span>
  <span class="tok-n">action</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;showtodosbyday&quot;</span>
  <span class="tok-n">constraints</span> <span class="tok-o">{</span>
    <span class="tok-n">year</span><span class="tok-o">(</span><span class="tok-nl">matches:</span><span class="tok-s">/\d{4}/</span><span class="tok-o">)</span>
    <span class="tok-n">month</span><span class="tok-o">(</span><span class="tok-nl">matches:</span><span class="tok-s">/\d{2}/</span><span class="tok-o">)</span>
    <span class="tok-n">day</span><span class="tok-o">(</span><span class="tok-nl">matches:</span><span class="tok-s">/\d{2}/</span><span class="tok-o">)</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Otro aspecto interesante del mapeo de URLs puede ser la captura de los códigos de error que se producen en el acceso a una aplicación web, como por ejemplo el típico error 404 cuando la página solicitada no existe. En este tipo de casos, estaría bien modificar la típica pantalla de este tipo de errores, por otra en que se mostrará información sobre nuestra aplicación, como por ejemplo un mapa de todas las opciones de la aplicación.</p>
</div>
<div class="paragraph">
<p>Para controlar la información mostrada al producirse estos errores, podemos añadir lo siguiente en el archivo <em>UrlMapping.groovy</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-s2">&quot;404&quot;</span><span class="tok-o">(</span><span class="tok-nl">view:</span><span class="tok-s1">&#39;/error&#39;</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>para que sea una página GSP quien se encargue de esta gestión o bien</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-s2">&quot;404&quot;</span><span class="tok-o">(</span><span class="tok-nl">controller:</span><span class="tok-s1">&#39;error&#39;</span><span class="tok-o">,</span> <span class="tok-nl">action:</span><span class="tok-s1">&#39;notFound&#39;</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>para que sea un controlador quien haga este trabajo.</p>
</div>
<div class="paragraph">
<p>Por último, también es muy interesante ver como Grails es capaz de reescribir los enlaces que generamos en nuestra aplicación. Imagina por ejemplo que tenemos la siguiente regla en nuestro archivo <em>UrlMappings.groovy</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">static</span> <span class="tok-n">mappings</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
   <span class="tok-s2">&quot;/$blog/$year?/$month?/$day?/$id?&quot;</span><span class="tok-o">(</span><span class="tok-nl">controller:</span><span class="tok-s2">&quot;blog&quot;</span><span class="tok-o">,</span> <span class="tok-nl">action:</span><span class="tok-s2">&quot;show&quot;</span><span class="tok-o">)</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y que en una página GSP tenemos el siguiente código</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">&lt;</span><span class="tok-nl">g:</span><span class="tok-n">link</span> <span class="tok-n">controller</span><span class="tok-o">=</span><span class="tok-s2">&quot;blog&quot;</span> <span class="tok-n">action</span><span class="tok-o">=</span><span class="tok-s2">&quot;show&quot;</span> <span class="tok-n">params</span><span class="tok-o">=</span><span class="tok-s2">&quot;[blog:&#39;fred&#39;, year:2014]&quot;</span><span class="tok-o">&gt;</span>
    <span class="tok-n">My</span> <span class="tok-n">Blog</span>
<span class="tok-o">&lt;</span><span class="tok-s">/g:link&gt;</span>

<span class="tok-s">&lt;g:link controller=&quot;blog&quot; action=&quot;show&quot; params=&quot;[blog:&#39;fred&#39;, year:2014, month:10]&quot;&gt;</span>
<span class="tok-s">My Blog - October 2014 Posts</span>
<span class="tok-s">&lt;/</span><span class="tok-nl">g:</span><span class="tok-n">link</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lo que Grails convertiría en lo siguiente</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">&lt;</span><span class="tok-n">a</span> <span class="tok-n">href</span><span class="tok-o">=</span><span class="tok-s2">&quot;/fred/2014&quot;</span><span class="tok-o">&gt;</span><span class="tok-n">My</span> <span class="tok-n">Blog</span><span class="tok-o">&lt;</span><span class="tok-s">/a&gt;</span>
<span class="tok-s">&lt;a href=&quot;/</span><span class="tok-n">fred</span><span class="tok-s">/2014/</span><span class="tok-mi">10</span><span class="tok-err">&quot;</span><span class="tok-o">&gt;</span><span class="tok-n">My</span> <span class="tok-n">Blog</span> <span class="tok-o">-</span> <span class="tok-n">October</span> <span class="tok-mi">2014</span> <span class="tok-n">Posts</span><span class="tok-o">&lt;/</span><span class="tok-n">a</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_empaquetamiento_de_aplicaciones">8.2. Empaquetamiento de aplicaciones</h3>
<div class="paragraph">
<p>Al terminar una nueva funcionalidad de una aplicación o una nueva versión de la misma, necesitamos generar el paquete <em>WAR</em> correspondiente a la nueva versión para desplegarla en el servidor de destino.</p>
</div>
<div class="paragraph">
<p>La generación del archivo <em>WAR</em> se realiza simplemente ejecutando el comando <em>grails war</em>, el cual nos generará un archivo con extensión <em>.war</em> con el nombre de la aplicación, en nuestro caso <em>todo</em>, seguido de la versión de la aplicación. En nuestro caso, la primera vez que ejecutemos el comando <em>grails war</em> el fichero generado se llamará <em>todo-0.1.war</em>.</p>
</div>
<div class="paragraph">
<p>Esto sería lo más básico para generar el archivo <em>WAR</em> de la aplicación, sin embargo, lo habitual es hacer alguna cosa más, tal y como se muestra en el siguiente listado.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Actualizar el código fuente del repositorio de control de versiones para asegurarse de que todas las partes del proyecto están actualizadas.</p>
</li>
<li>
<p>Ejecutar los tests de integración, unitarios y funcionales que hayamos implementado para comprobar que todo funciona tal y como esperamos.</p>
</li>
<li>
<p>Incrementar la variable <em>app.version</em> del archivo <em>application.properties</em> manualmente o bien mediante el comando <em>grails set-version 0.2</em>.</p>
</li>
<li>
<p>Limpiar el proyecto de archivos temporales mediante el comando <em>grails clean</em>.</p>
</li>
<li>
<p>Generar el archivo <em>WAR</em> indicándole el entorno donde queremos desplegar este <em>WAR</em>. Por ejemplo, el comando <em>grails prod war</em> crearía un archivo <em>WAR</em> para ser desplegado en nuestro entorno de producción.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Una aplicación Grails empaquetada como un archivo <em>WAR</em> puede ser desplegada en servidores de aplicaciones JAVA EE tales como JBoss (<a href="http://www.jboss.org/" class="bare">http://www.jboss.org/</a>), GlassFish (<a href="https://glassfish.dev.java.net/" class="bare">https://glassfish.dev.java.net/</a>), Apache Geronimo (<a href="http://geronimo.apache.org" class="bare">http://geronimo.apache.org</a>), BEA WebLogic (<a href="http://www.bea.com" class="bare">http://www.bea.com</a>) o IBM WebSphere (<a href="http://www.ibm.com/software/websphere" class="bare">http://www.ibm.com/software/websphere</a>) o incluso en un contenedor web como Apache Tomcat (<a href="http://tomcat.apache.org" class="bare">http://tomcat.apache.org</a>) o Jetty (<a href="http://www.mortbay.com" class="bare">http://www.mortbay.com</a>).</p>
</div>
<div class="paragraph">
<p>Cada uno de estos servidores o contenedores tendrán su propia especificación y forma de desplegar los archivos <em>WAR</em> generados. Unos mediante unos directorios especiales donde copiar los <em>WAR</em>, otros mediante una consola basada en web, otros por línea de comandos e incluso mediante tareas de tipo Ant. En la sección Deployment (<a href="http://www.grails.org/Deployment" class="bare">http://www.grails.org/Deployment</a>) de la web oficial de Grails puedes encontrar información sobre como desplegar los archivos <em>WAR</em> en varios servidores.</p>
</div>
</div>
<div class="sect2">
<h3 id="_otros_comandos_interesantes_de_grails">8.3. Otros comandos interesantes de Grails</h3>
<div class="paragraph">
<p>Durante este módulo dedicado a Grails, han ido apareciendo varios de los comandos más habituales que utilizaremos cuando creemos aplicaciones con Grails. Sin embargo, los comandos vistos hasta ahora no son los únicos y es ahora cuando veremos algunos de ellos. Ten en cuenta también que cuando instalamos plugins, es posible que también se añadan nuevos comandos.</p>
</div>
<div class="paragraph">
<p>Si ejecutamos el comando <em>grails help</em> veremos un listado con todos los posibles comandos que tenemos disponibles en nuestra instalación de Grails. La siguiente tabla muestra los comandos más interesantes que no hemos visto hasta ahora.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Comando</th>
<th class="tableblock halign-left valign-top">Descripción</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock"><em>grails bug-report</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Genera un archivo comprimido en ZIP con los archivos fuente de nuestro proyecto para el caso de que queramos informar de un bug</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock"><em>grails clean</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Limpia el directorio <em>tmp</em> de nuestra aplicación. Este comando puede ser combinado con otros comandos como por ejemplo <em>grails clean run-app</em></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock"><em>grails console</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nos muestra la consola de Groovy que veíamos en la parte del módulo dedicada a este lenguaje de programación.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock"><em>grails doc</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Genera la documentación completa de nuestro proyecto.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock"><em>grails help</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Muestra un listado de comandos disponibles en Grails. Si le pasamos como parámetro uno de esos posibles comandos, nos mostrará información adicional sobre el comando dado. Por ejemplo <em>grails help doc</em></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock"><em>grails list-plugins</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Muestra un listado completo tanto de los plugins disponibles como de los ya instalados en la aplicación.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock"><em>grails plugin-info</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Muestra la información completa del plugin pasado como parámetro al comando.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock"><em>grails run-app -https</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ejecuta el comando <em>grails run-app</em> utilizando como servidor Tomcat pero sobre un servidor seguro <em>https</em>. El puerto por defecto es 8443 y puede ser modificado añadiendo al comando <em>-Dserver.port.https=&lt;numero_puerto&gt;</em></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock"><em>grails schema-export</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Genera un fichero con las sentencias SQL necesarias para exportar la base de datos.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock"><em>grails set-version</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Establece la versión de la aplicación. Por ejemplo <em>grails set-version 1.0.4</em></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock"><em>grails stats</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nos muestra una serie de datos referentes a nuestro proyecto, con respecto al número de controladores, clases de dominio, servicios, librerías de etiquetas, tests de integración, etc. y al número de líneas totales en cada apartado.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock"><em>grails uninstall-plugin</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Desinstala el plugin pasado como parámetro de la aplicación.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_plugins_2">8.4. Plugins</h3>
<div class="paragraph">
<p>La comunidad de usuarios de Grails es cada vez mayor y eso hace que, cuando una característica no ha sido desarrollada en el núcleo de Grails, sean los propios usuarios quienes se encarguen de desarrollarla como un plugin externo. En el momento en que se escribieron estos apuntes eran casi 1200 los plugins desarrollados por la comunidad (<a href="http://www.grails.org/plugins/" class="bare">http://www.grails.org/plugins/</a>).</p>
</div>
<div class="paragraph">
<p>Estos plugins abarcan aspectos tan diversos como la seguridad como el plugin de Spring Security (<a href="http://www.grails.org/plugin/spring-security-core" class="bare">http://www.grails.org/plugin/spring-security-core</a>), el desarrollo de interfaces gráficas ricas como Rich UI (<a href="http://www.grails.org/plugin/richui" class="bare">http://www.grails.org/plugin/richui</a>) o la exportación de datos a otros formatos con el plugin Export (<a href="http://www.grails.org/plugin/export" class="bare">http://www.grails.org/plugin/export</a>).</p>
</div>
<div class="paragraph">
<p>Para ver el funcionamiento de los plugins en Grails, nosotros vamos a utilizar un plugin que nos permitirá buscar contenido en las clases de dominio de nuestra aplicación sin prácticamente esfuerzo alguno. También utilizaremos el plugin export para exportar la información de nuestras clases de dominio a otros formatos. Pero para empezar, veamos un plugin que nos permitirá utilizar una consola a través de nuestra aplicación para poder realizar todo tipo de operaciones.</p>
</div>
<div class="sect3">
<h4 id="_plugin_console">8.4.1. Plugin console</h4>
<div class="paragraph">
<p>El plugin console no es más un plugin que permite la ejecución en línea de comandos. Desde esta consola tendremos acceso a determinados contextos como pueden ser la propia aplicación o las clases de dominio. Es muy útil cuando queremos realizar operaciones sobre las clases de dominio y no podemos o no queremos tocar la aplicación para esto.</p>
</div>
<div class="paragraph">
<p>La instalación del plugin se realiza con el comando <em>grails install-plugin console</em> o bien editando el archivo de configuración <em>BuildConfig.groovy</em> para añadir el plugin correspondiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">grails</span><span class="tok-o">.</span><span class="tok-na">project</span><span class="tok-o">.</span><span class="tok-na">dependency</span><span class="tok-o">.</span><span class="tok-na">resolution</span> <span class="tok-o">{</span>
  <span class="tok-o">...</span>
  <span class="tok-n">plugins</span> <span class="tok-o">{</span>
    <span class="tok-o">...</span>
    <span class="tok-n">compile</span> <span class="tok-s2">&quot;:console:1.5.6&quot;</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Una vez instalado el plugin y con la aplicación en funcionamiento, podremos acceder a esta consola desde la dirección <em><a href="http://localhost:8080/todo/console" class="bare">http://localhost:8080/todo/console</a></em>.</p>
</div>
<div class="paragraph">
<p>Sin embargo, es probable que, debido a la configuración segura de nuestra aplicación, necesites actualizar las reglas de seguridad para que por ejemplo permita el acceso a esta url a los administradores de la misma.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">grails</span><span class="tok-o">.</span><span class="tok-na">plugin</span><span class="tok-o">.</span><span class="tok-na">springsecurity</span><span class="tok-o">.</span><span class="tok-na">controllerAnnotations</span><span class="tok-o">.</span><span class="tok-na">staticRules</span> <span class="tok-o">=</span> <span class="tok-o">[</span>
    <span class="tok-s2">&quot;/console/**&quot;</span><span class="tok-o">:</span>          <span class="tok-o">[</span><span class="tok-s1">&#39;ROLE_ADMIN&#39;</span><span class="tok-o">],</span>
    <span class="tok-s2">&quot;/plugins/console*/**&quot;</span><span class="tok-o">:</span> <span class="tok-o">[</span><span class="tok-s1">&#39;ROLE_ADMIN&#39;</span><span class="tok-o">]</span>
<span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ten en cuenta que este ejemplo considera que estamos utilizando el método de Spring Security <em>Annotation</em>.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/grails08/console.png" alt="Plugin Console" width="100%">
</div>
</div>
<div class="paragraph">
<p>Con el ejemplo mostrado en la imagen podríamos obtener todos las tareas de nuestra aplicación e imprimirlos por pantalla. Pero además podemos acceder a cualquier artefacto de nuestra aplicación incluidos los servicios, tal y como si estuviéramos ejecutando este código dentro de nuestra aplicación.</p>
</div>
<div class="paragraph">
<p>Las siguientes variables son accesible desde esta consola:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ctx - el contexto de la aplicación Spring</p>
</li>
<li>
<p>grailsApplication - la instancia de la aplicación Grails</p>
</li>
<li>
<p>config - la configuración Grails</p>
</li>
<li>
<p>request - la petición HTTP actual</p>
</li>
<li>
<p>session - la sesión HTTP actual</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>El objeto <em>ctx</em> sin duda es el más interesante puesto que nos va a permitir acceder al contexto de la aplicación y por consiguiente a varios artefactos como pueden ser los servicios de forma muy sencilla y por ejemplo eliminar tareas directamente.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">Todo</span> <span class="tok-n">todo</span> <span class="tok-o">=</span> <span class="tok-n">es</span><span class="tok-o">.</span><span class="tok-na">ua</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">todo</span><span class="tok-o">.</span><span class="tok-na">Todo</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)</span>

<span class="tok-n">ctx</span><span class="tok-o">.</span><span class="tok-na">todoService</span><span class="tok-o">.</span><span class="tok-na">deleteTodo</span><span class="tok-o">(</span><span class="tok-n">todo</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Este plugin es una forma rápida de probar determinadas funcionalidades de nuestra aplicación.</p>
</div>
</div>
<div class="sect3">
<h4 id="_plugin_para_la_búsqueda_de_contenido_searchable">8.4.2. Plugin para la búsqueda de contenido: Searchable</h4>
<div class="paragraph">
<p>Para esta tarea de búsqueda, Grails cuenta con un plugin llamado <em>Searchable</em> que nos va a facilitar muchísimo esta labor. Este plugin además, está basado en el framework OpenSymphony Compass Search Engine (<a href="http://www.opensymphony.com/compass/" class="bare">http://www.opensymphony.com/compass/</a>) y que tiene por detrás a Apache Lucene, con lo que el plugin cuenta con mucho respaldo.</p>
</div>
<div class="paragraph">
<p>Para la instalación de plugin en Grails, debemos modificar el archivo de configuración de configuración <em>BuildConfig.groovy</em> y seguir las instrucciones que vienen en la página del plugin <em><a href="http://grails.org/plugin/searchable" class="bare">http://grails.org/plugin/searchable</a></em>.</p>
</div>
<div class="paragraph">
<p>Estas instrucciones pasan por añadir un nuevo repositorio maven y añadir el plugin en cuestión.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">grails</span><span class="tok-o">.</span><span class="tok-na">project</span><span class="tok-o">.</span><span class="tok-na">dependency</span><span class="tok-o">.</span><span class="tok-na">resolution</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
  <span class="tok-o">...</span>

  <span class="tok-n">repositories</span> <span class="tok-o">{</span>
    <span class="tok-o">...</span>
    <span class="tok-n">mavenRepo</span> <span class="tok-s2">&quot;http://repo.grails.org/grails/core&quot;</span>
  <span class="tok-o">}</span>

  <span class="tok-n">plugins</span> <span class="tok-o">{</span>
    <span class="tok-o">...</span>
    <span class="tok-n">compile</span> <span class="tok-s2">&quot;:searchable:0.6.9&quot;</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Una vez instalado, podemos comprobar que en la dirección <a href="http://localhost:8080/todo/searchable" class="bare">http://localhost:8080/todo/searchable</a> (habrá que añadir también esta dirección en la configuración segura de nuestra aplicación), tenemos un buscador que se ha generado automáticamente. Sin embargo, si probamos a hacer alguna búsqueda, el buscador nos dirá que no ha encontrada nada. Esto es porque todavía no le hemos dicho al plugin donde debe buscar la información.</p>
</div>
<div class="paragraph">
<p>Si pensamos donde podemos añadir un buscador en nuestra aplicación encontraremos que los usuarios de nuestro aplicación querrán buscar tareas, con lo que debemos indicar en la clases de dominio <em>Todo</em> que necesitamos que nuestro plugin searchable sea capaz de buscar en ella.</p>
</div>
<div class="paragraph">
<p>Para que el plugin <em>searchable</em> sea capaz de encontrar tareas que contengan un determinado texto, necesitamos modificar la clase de dominio <em>Todo</em> y añadirle una nueva propiedad llamada <em>searchable</em>. Esta propiedad es <em>static</em> y debe contener un valor booleano indicando si permitimos la búsqueda o no, con lo que la clase de dominio <em>Todo</em> quedarían así:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">es</span><span class="tok-o">.</span><span class="tok-na">ua</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">todo</span>

<span class="tok-kd">class</span> <span class="tok-nc">Todo</span> <span class="tok-o">{</span>
    <span class="tok-n">String</span> <span class="tok-n">title</span>
    <span class="tok-n">String</span> <span class="tok-n">description</span>
    <span class="tok-n">Date</span> <span class="tok-n">date</span>
    <span class="tok-n">Date</span> <span class="tok-n">reminderDate</span>
    <span class="tok-n">String</span> <span class="tok-n">url</span>
    <span class="tok-n">Boolean</span> <span class="tok-n">done</span> <span class="tok-o">=</span> <span class="tok-kc">false</span>
    <span class="tok-n">Category</span> <span class="tok-n">category</span>

    <span class="tok-n">Date</span> <span class="tok-n">dateCreated</span>
    <span class="tok-n">Date</span> <span class="tok-n">lastUpdated</span>

    <span class="tok-n">Date</span> <span class="tok-n">dateDone</span>

    <span class="tok-n">User</span> <span class="tok-n">user</span>

    <span class="tok-kd">static</span> <span class="tok-n">searchable</span> <span class="tok-o">=</span> <span class="tok-kc">true</span>

    <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si ahora realizamos alguna búsqueda de prueba, Searchable nos devolverá los resultados encontrados en todas las propiedades de las clases de dominio <em>Todo</em>. Ahora bien, estamos permitiendo que se busque el término de búsqueda en todas las propiedades de las clases de dominio implicadas, algo que no siempre será lo deseado. Para ello, el plugin permite la utilización de dos variables con las que le indicaremos al sistema donde puede buscar o donde no.</p>
</div>
<div class="paragraph">
<p>Estas dos variables son <em>only</em> y <em>except</em> y podemos definirlas de la siguiente forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">static</span> <span class="tok-n">searchable</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-nl">only:</span> <span class="tok-o">[</span><span class="tok-s1">&#39;title&#39;</span><span class="tok-o">,</span> <span class="tok-s1">&#39;description&#39;</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>para indicarle que debe buscar en las propiedades <em>title</em> y <em>description</em> o bien mediante:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">static</span> <span class="tok-n">searchable</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-nl">except:</span> <span class="tok-s1">&#39;date&#39;</span><span class="tok-o">,</span> <span class="tok-s1">&#39;reminderDate&#39;</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>si lo que queremos es indicarle sólo aquellas propiedades en las que no debemos realizar la búsqueda. En este último caso, buscaremos en todas las propiedades de la clase de dominio <em>Todo</em> excepto en <em>date</em> y <em>reminderDate</em>.</p>
</div>
<div class="paragraph">
<p>En el momento de escribir estos apuntes el plugin tenía un problema para funcionar con Hibernate 4 con lo que vamos a tener que actualizar un par de ficheros para utilizar en su lugar Hibernate 3. Si abrimos el archivo de configuración <em>BuildConfig.groovy</em> veremos como hay una línea indicando</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">runtime</span> <span class="tok-s2">&quot;:hibernate4:4.3.10&quot;</span> <span class="tok-c1">// or &quot;:hibernate:3.6.10.18&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>que vamos a tener que modificar para utilizar Hibernate 3. Además, en el archivo de configuración <em>DataSource.groovy</em> encontraremos</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">//cache.region.factory_class = &#39;org.hibernate.cache.SingletonEhCacheRegionFactory&#39; // Hibernate 3</span>
<span class="tok-n">cache</span><span class="tok-o">.</span><span class="tok-na">region</span><span class="tok-o">.</span><span class="tok-na">factory_class</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;org.hibernate.cache.ehcache.SingletonEhCacheRegionFactory&#39;</span> <span class="tok-c1">// Hibernate 4</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>y de igual forma, vamos a tener que modificar para utilizar Hibernate 3 en lugar de Hibernate 4.</p>
</div>
<div class="paragraph">
<p>Con estas modificaciones, si ahora intentamos de nuevo realizar una búsqueda en <em><a href="http://localhost:8080/todo/searchable" class="bare">http://localhost:8080/todo/searchable</a></em> veremos como ya empieza a buscar en los campos <em>title</em> y <em>description</em> de la clase de dominio <em>Todo</em>.</p>
</div>
<div class="paragraph">
<p>Pero si esto se nos queda corto (y posiblemente sea así), podemos utilizar el servicio <em>SearchableService</em>. Además, los métodos de este servicio también están disponibles en las clases de dominio "anotadas" con la variable <em>searchable</em>. Estos son los métodos de los que disponemos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://grails.org/Searchable+Plugin+-+Methods+-+search"><em>search</em></a>: encuentra objetos que cumplen una determinada consulta.</p>
</li>
<li>
<p><a href="https://grails.org/Searchable+Plugin+-+Methods+-+countHits"><em>countHits</em></a>: encuentra el número de objetos que cumplen una determinada consulta.</p>
</li>
<li>
<p><a href="https://grails.org/Searchable+Plugin+-+Methods+-+moreLikeThis"><em>moreLikeThis</em></a>: encuentra objetos similares a la instancia pasada por parámetro.</p>
</li>
<li>
<p><a href="https://grails.org/Searchable+Plugin+-+Methods+-+suggestQuery"><em>suggestQuery</em></a>: sugiere una nueva consulta a partir de la consultada pasada por parámetro.</p>
</li>
<li>
<p><a href="https://grails.org/Searchable+Plugin+-+Methods+-+termFreqs"><em>termsFreqs</em></a>: devuelve la frecuencia para los términos en el índice.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Un ejemplo para buscar en las tareas de nuestra aplicación podría ser el siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">searchResult</span> <span class="tok-o">=</span> <span class="tok-n">searchableService</span><span class="tok-o">.</span><span class="tok-na">search</span><span class="tok-o">(</span>
    <span class="tok-s2">&quot;Tests&quot;</span><span class="tok-o">,</span>
    <span class="tok-o">[</span><span class="tok-nl">offset:</span> <span class="tok-mi">0</span><span class="tok-o">,</span> <span class="tok-nl">max:</span> <span class="tok-mi">20</span><span class="tok-o">]</span>
<span class="tok-o">)</span>
<span class="tok-n">println</span> <span class="tok-s2">&quot;${searchResult.total} hits:&quot;</span>
<span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">i</span> <span class="tok-k">in</span> <span class="tok-mi">0</span><span class="tok-o">..&lt;</span><span class="tok-n">searchResult</span><span class="tok-o">.</span><span class="tok-na">results</span><span class="tok-o">.</span><span class="tok-na">size</span><span class="tok-o">())</span> <span class="tok-o">{</span>
    <span class="tok-n">println</span> <span class="tok-s2">&quot;${searchResult.offset + i + 1}: &quot;</span> <span class="tok-o">+</span>
        <span class="tok-s2">&quot;${searchResult.results[i].toString()} &quot;</span> <span class="tok-o">+</span>
        <span class="tok-s2">&quot;(score ${searchResult.scores[i]})&quot;</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>o bien, también podemos buscar directamente en la clase de dominio en cuestión.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">//Devuelve un único objeto de tipo Todo</span>
<span class="tok-c1">//que coincidan con la búsqueda realizada</span>
<span class="tok-kt">def</span> <span class="tok-n">todo</span> <span class="tok-o">=</span> <span class="tok-n">Todo</span><span class="tok-o">.</span><span class="tok-na">search</span><span class="tok-o">(</span>
    <span class="tok-s2">&quot;Tests&quot;</span><span class="tok-o">,</span>
    <span class="tok-o">[</span><span class="tok-nl">result:</span> <span class="tok-s1">&#39;top&#39;</span><span class="tok-o">]</span>
<span class="tok-o">)</span>
<span class="tok-k">assert</span> <span class="tok-n">todo</span> <span class="tok-k">instanceof</span> <span class="tok-n">Todo</span>

<span class="tok-c1">//Devuelve todos los objetos de tipo Todo</span>
<span class="tok-c1">//que coincidan con la búsqueda realizada</span>
<span class="tok-kt">def</span> <span class="tok-n">todos</span> <span class="tok-o">=</span> <span class="tok-n">Todo</span><span class="tok-o">.</span><span class="tok-na">search</span><span class="tok-o">(</span>
    <span class="tok-s2">&quot;Tests&quot;</span><span class="tok-o">,</span>
    <span class="tok-o">[</span><span class="tok-nl">reload:</span> <span class="tok-kc">true</span><span class="tok-o">,</span> <span class="tok-nl">result:</span> <span class="tok-s1">&#39;every&#39;</span><span class="tok-o">]</span>
<span class="tok-o">)</span>
<span class="tok-k">assert</span> <span class="tok-n">todos</span><span class="tok-o">.</span><span class="tok-na">each</span> <span class="tok-o">{</span> <span class="tok-n">it</span> <span class="tok-k">instanceof</span> <span class="tok-n">Todo</span> <span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos comprobar estos ejemplos directamente en la consola vista en el plugin anterior.</p>
</div>
<div class="paragraph">
<p>En ocasiones es probable que necesitemos filtrar los resultados de una búsqueda por un determinado parámetro. Por ejemplo, en nuestra aplicación si quisiéramos buscar aquellas tareas que pertenezcan a la categoría "Hogar", deberíamos tener algo así:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">todos</span> <span class="tok-o">=</span> <span class="tok-n">Todo</span><span class="tok-o">.</span><span class="tok-na">search</span><span class="tok-o">([</span><span class="tok-nl">result:</span><span class="tok-s1">&#39;every&#39;</span><span class="tok-o">])</span> <span class="tok-o">{</span>
    <span class="tok-n">must</span><span class="tok-o">(</span><span class="tok-n">queryString</span><span class="tok-o">(</span><span class="tok-n">params</span><span class="tok-o">.</span><span class="tok-na">q</span><span class="tok-o">))</span>
    <span class="tok-n">must</span><span class="tok-o">(</span><span class="tok-n">term</span><span class="tok-o">(</span><span class="tok-s1">&#39;$/Todo/category/id&#39;</span><span class="tok-o">,</span><span class="tok-n">Category</span><span class="tok-o">.</span><span class="tok-na">findByName</span><span class="tok-o">(</span><span class="tok-s2">&quot;Hogar&quot;</span><span class="tok-o">)?.</span><span class="tok-na">id</span><span class="tok-o">))</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Debemos también especificar que entre las propiedades a buscar en la clase de dominio Todo se encuentra la propiedad <em>category</em> y la clase <em>Category</em> también tendrá la propiedad estática <em>searchable</em> a cierto para que nos permitan buscar en las instancias de esta clase.</p>
</div>
</div>
<div class="sect3">
<h4 id="_plugin_para_exportar_a_otros_formatos_export">8.4.3. Plugin para exportar a otros formatos: Export</h4>
<div class="paragraph">
<p>Hoy en día, cualquier aplicación que se precie debe ser capaz de exportar sus datos a otros formatos para que el usuario tenga la comodidad de elegir como quiere utilizar los datos. Los formatos más comunes a exportar la información de nuestra aplicación será <em>pdf</em>, <em>hojas de cálculo excel</em>, <em>csv (datos separados por comas)</em> u <em>ods (la hoja de cálculo de OpenOffice)</em>.</p>
</div>
<div class="paragraph">
<p>Esta tarea que en otros sistemas se vuelve complicada y pesada, en Grails podemos solucionarla utilizando un plugin disponible llamado <em>export</em>. Como siempre, lo primero que vamos a hacer es instalarlo añadiendo la siguiente línea a nuestro archivo <em>BuildConfig.groovy</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">grails</span><span class="tok-o">.</span><span class="tok-na">project</span><span class="tok-o">.</span><span class="tok-na">dependency</span><span class="tok-o">.</span><span class="tok-na">resolution</span> <span class="tok-o">=</span> <span class="tok-o">{</span>
  <span class="tok-o">...</span>

  <span class="tok-n">repositories</span> <span class="tok-o">{</span>
    <span class="tok-o">...</span>
    <span class="tok-n">mavenRepo</span> <span class="tok-s2">&quot;http://repo.grails.org/grails/core&quot;</span>
  <span class="tok-o">}</span>

  <span class="tok-n">dependencies</span> <span class="tok-o">{</span>
    <span class="tok-o">...</span>
    <span class="tok-n">compile</span> <span class="tok-s1">&#39;commons-beanutils:commons-beanutils:1.8.3&#39;</span>
  <span class="tok-o">}</span>
  <span class="tok-n">plugins</span> <span class="tok-o">{</span>
    <span class="tok-o">...</span>
    <span class="tok-n">compile</span> <span class="tok-s2">&quot;:export:1.7-SNAPSHOT&quot;</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Una vez instalado el plugin <em>export</em> debemos añadir algunos <em>mime types</em> en la variable <em>grails.mime.types</em> del archivo <em>Config.groovy</em>. Los nuevos <em>mime types</em> serán los relativos a <em>csv</em>, <em>excel</em>, <em>pdf</em> y <em>ods</em>. La variable <em>grails.mime.types</em> quedaría así:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">grails</span><span class="tok-o">.</span><span class="tok-na">mime</span><span class="tok-o">.</span><span class="tok-na">types</span> <span class="tok-o">=</span> <span class="tok-o">[</span>
    <span class="tok-nl">all:</span>           <span class="tok-s1">&#39;*/*&#39;</span><span class="tok-o">,</span>
    <span class="tok-nl">atom:</span>          <span class="tok-s1">&#39;application/atom+xml&#39;</span><span class="tok-o">,</span>
    <span class="tok-nl">css:</span>           <span class="tok-s1">&#39;text/css&#39;</span><span class="tok-o">,</span>
    <span class="tok-nl">csv:</span>           <span class="tok-s1">&#39;text/csv&#39;</span><span class="tok-o">,</span>
    <span class="tok-nl">pdf:</span>           <span class="tok-s1">&#39;application/pdf&#39;</span><span class="tok-o">,</span>
    <span class="tok-nl">excel:</span>         <span class="tok-s1">&#39;application/vnd.ms-excel&#39;</span><span class="tok-o">,</span>
    <span class="tok-nl">ods:</span>           <span class="tok-s1">&#39;application/vnd.oasis.opendocument.spreadsheet&#39;</span><span class="tok-o">,</span>
    <span class="tok-nl">form:</span>          <span class="tok-s1">&#39;application/x-www-form-urlencoded&#39;</span><span class="tok-o">,</span>
    <span class="tok-nl">html:</span>          <span class="tok-o">[</span><span class="tok-s1">&#39;text/html&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;application/xhtml+xml&#39;</span><span class="tok-o">],</span>
    <span class="tok-nl">js:</span>            <span class="tok-s1">&#39;text/javascript&#39;</span><span class="tok-o">,</span>
    <span class="tok-nl">json:</span>          <span class="tok-o">[</span><span class="tok-s1">&#39;application/json&#39;</span><span class="tok-o">,</span> <span class="tok-s1">&#39;text/json&#39;</span><span class="tok-o">],</span>
    <span class="tok-nl">multipartForm:</span> <span class="tok-s1">&#39;multipart/form-data&#39;</span><span class="tok-o">,</span>
    <span class="tok-nl">rss:</span>           <span class="tok-s1">&#39;application/rss+xml&#39;</span><span class="tok-o">,</span>
    <span class="tok-nl">text:</span>          <span class="tok-s1">&#39;text/plain&#39;</span><span class="tok-o">,</span>
    <span class="tok-nl">hal:</span>           <span class="tok-o">[</span><span class="tok-s1">&#39;application/hal+json&#39;</span><span class="tok-o">,</span><span class="tok-s1">&#39;application/hal+xml&#39;</span><span class="tok-o">],</span>
    <span class="tok-nl">xml:</span>           <span class="tok-o">[</span><span class="tok-s1">&#39;text/xml&#39;</span><span class="tok-o">,</span> <span class="tok-s1">&#39;application/xml&#39;</span><span class="tok-o">]</span>
<span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para empezar a utilizar el plugin, debemos incluir la etiqueta <em>&lt;export:resource/&gt;</em> en la cabecera del archivo GSP donde queramos incluir las opciones para exportar. Esto incluirá los archivos CSS necesarios para crear una barra de herramientas con las opciones para exportar la página actual.</p>
</div>
<div class="paragraph">
<p>El siguiente paso consistirá en incluir la barra de herramientas necesaria para exportar la página HTML generada a algún formato de los ya comentados. Para esto el plugin pone a nuestra disposición una nueva etiqueta <em>&lt;export:formats /&gt;</em>, la cual acepta como parámetro un listado de los formatos a los que queremos exportar la página, como por ejemplo <em>&lt;export:formats formats="['csv','excel','ods','pdf','xml']"/&gt;</em>.</p>
</div>
<div class="paragraph">
<p>Si queremos añadir por ejemplo en la página que contiene el listado de las tareas una barra para exportar dicho listado, podríamos tener algo así en la página <em>grails-app/views/todo/index.gsp</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">&lt;</span><span class="tok-n">html</span><span class="tok-o">&gt;</span>
  <span class="tok-o">&lt;</span><span class="tok-n">head</span><span class="tok-o">&gt;</span>
    <span class="tok-o">...</span>
    <span class="tok-o">&lt;</span><span class="tok-nl">export:</span><span class="tok-n">resource</span><span class="tok-s">/&gt;</span>
<span class="tok-s">  &lt;/</span><span class="tok-n">head</span><span class="tok-o">&gt;</span>
  <span class="tok-o">&lt;</span><span class="tok-n">body</span><span class="tok-o">&gt;</span>
    <span class="tok-o">...</span>
      <span class="tok-o">&lt;</span><span class="tok-n">h1</span><span class="tok-o">&gt;&lt;</span><span class="tok-nl">g:</span><span class="tok-n">message</span> <span class="tok-n">code</span><span class="tok-o">=</span><span class="tok-s2">&quot;default.list.label&quot;</span> <span class="tok-n">args</span><span class="tok-o">=</span><span class="tok-s2">&quot;[entityName]&quot;</span> <span class="tok-s">/&gt;&lt;/</span><span class="tok-n">h1</span><span class="tok-o">&gt;</span>
      <span class="tok-o">&lt;</span><span class="tok-nl">g:</span><span class="tok-k">if</span> <span class="tok-n">test</span><span class="tok-o">=</span><span class="tok-s2">&quot;${flash.message}&quot;</span><span class="tok-o">&gt;</span>
        <span class="tok-o">&lt;</span><span class="tok-n">div</span> <span class="tok-n">class</span><span class="tok-o">=</span><span class="tok-s2">&quot;message&quot;</span> <span class="tok-n">role</span><span class="tok-o">=</span><span class="tok-s2">&quot;status&quot;</span><span class="tok-o">&gt;</span><span class="tok-n">$</span><span class="tok-o">{</span><span class="tok-n">flash</span><span class="tok-o">.</span><span class="tok-na">message</span><span class="tok-o">}&lt;</span><span class="tok-s">/div&gt;</span>
<span class="tok-s">      &lt;/</span><span class="tok-nl">g:</span><span class="tok-k">if</span><span class="tok-o">&gt;</span>
      <span class="tok-o">&lt;</span><span class="tok-nl">export:</span><span class="tok-n">formats</span> <span class="tok-n">formats</span><span class="tok-o">=</span><span class="tok-s2">&quot;[&#39;csv&#39;, &#39;excel&#39;, &#39;ods&#39;, &#39;pdf&#39;, &#39;xml&#39;]&quot;</span> <span class="tok-s">/&gt;</span>
<span class="tok-s">    ...</span>
<span class="tok-s">  &lt;/</span><span class="tok-n">body</span><span class="tok-o">&gt;</span>
<span class="tok-o">&lt;/</span><span class="tok-n">html</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si echamos un vistazo al listado de tareas comprobaremos como en la parte superior de los mismos aparecerá una barra con los formatos a los que podamos exportar dicho listado.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/grails08/exportbar.png" alt="Barra para exportar a varios formatos" width="50%">
</div>
</div>
<div class="paragraph">
<p>Sin embargo, si intentamos exportar el listado a cualquier de los formatos utilizados, veremos como no sucede nada nuevo y la aplicación vuelve a mostrarnos el listado tal y como ha aparecido siempre, es decir, en formato HTML. Para que la aplicación pueda exportar a los nuevos formatos, debemos modificar el controlador de la clase de dominio <em>Todo</em> y más en concreto el método <em>index()</em> para que acepte los nuevos formatos.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">package</span> <span class="tok-n">es</span><span class="tok-o">.</span><span class="tok-na">ua</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">todo</span>



<span class="tok-kn">import</span> <span class="tok-nn">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">springframework</span><span class="tok-o">.</span><span class="tok-na">http</span><span class="tok-o">.</span><span class="tok-na">HttpStatus</span><span class="tok-o">.*</span>
<span class="tok-kn">import</span> <span class="tok-nn">grails.transaction.Transactional</span>

<span class="tok-nd">@Transactional</span><span class="tok-o">(</span><span class="tok-n">readOnly</span> <span class="tok-o">=</span> <span class="tok-kc">true</span><span class="tok-o">)</span>
<span class="tok-kd">class</span> <span class="tok-nc">TodoController</span> <span class="tok-o">{</span>

    <span class="tok-kt">def</span> <span class="tok-n">todoService</span>
    <span class="tok-kt">def</span> <span class="tok-n">springSecurityService</span>
    <span class="tok-kt">def</span> <span class="tok-n">exportService</span>

    <span class="tok-kd">static</span> <span class="tok-n">allowedMethods</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-nl">save:</span> <span class="tok-s2">&quot;POST&quot;</span><span class="tok-o">,</span> <span class="tok-nl">update:</span> <span class="tok-s2">&quot;PUT&quot;</span><span class="tok-o">,</span> <span class="tok-nl">delete:</span> <span class="tok-s2">&quot;DELETE&quot;</span><span class="tok-o">]</span>

    <span class="tok-kt">def</span> <span class="tok-nf">index</span><span class="tok-o">(</span><span class="tok-n">Integer</span> <span class="tok-n">max</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">params</span><span class="tok-o">.</span><span class="tok-na">max</span> <span class="tok-o">=</span> <span class="tok-n">Math</span><span class="tok-o">.</span><span class="tok-na">min</span><span class="tok-o">(</span><span class="tok-n">max</span> <span class="tok-o">?:</span> <span class="tok-mi">10</span><span class="tok-o">,</span> <span class="tok-mi">100</span><span class="tok-o">)</span>
        <span class="tok-k">if</span><span class="tok-o">(</span><span class="tok-n">params</span><span class="tok-o">?.</span><span class="tok-na">f</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-n">params</span><span class="tok-o">.</span><span class="tok-na">f</span> <span class="tok-o">!=</span> <span class="tok-s2">&quot;html&quot;</span><span class="tok-o">){</span>
            <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">contentType</span> <span class="tok-o">=</span> <span class="tok-n">grailsApplication</span><span class="tok-o">.</span><span class="tok-na">config</span><span class="tok-o">.</span><span class="tok-na">grails</span><span class="tok-o">.</span><span class="tok-na">mime</span><span class="tok-o">.</span><span class="tok-na">types</span><span class="tok-o">[</span><span class="tok-n">params</span><span class="tok-o">.</span><span class="tok-na">f</span><span class="tok-o">]</span>
            <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setHeader</span><span class="tok-o">(</span><span class="tok-s2">&quot;Content-disposition&quot;</span><span class="tok-o">,</span> <span class="tok-s2">&quot;attachment; filename=todos.${params.extension}&quot;</span><span class="tok-o">)</span>
            <span class="tok-n">exportService</span><span class="tok-o">.</span><span class="tok-na">export</span><span class="tok-o">(</span><span class="tok-n">params</span><span class="tok-o">.</span><span class="tok-na">f</span><span class="tok-o">,</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">outputStream</span><span class="tok-o">,</span> <span class="tok-n">Todo</span><span class="tok-o">.</span><span class="tok-na">findAllByUser</span><span class="tok-o">(</span><span class="tok-n">springSecurityService</span><span class="tok-o">.</span><span class="tok-na">currentUser</span><span class="tok-o">,</span> <span class="tok-n">params</span><span class="tok-o">),</span> <span class="tok-o">[:],</span> <span class="tok-o">[:])</span>
        <span class="tok-o">}</span>
        <span class="tok-n">respond</span> <span class="tok-n">Todo</span><span class="tok-o">.</span><span class="tok-na">findAllByUser</span><span class="tok-o">(</span><span class="tok-n">springSecurityService</span><span class="tok-o">.</span><span class="tok-na">currentUser</span><span class="tok-o">,</span> <span class="tok-n">params</span><span class="tok-o">),</span> <span class="tok-nl">model:</span><span class="tok-o">[</span><span class="tok-nl">todoInstanceCount:</span> <span class="tok-n">Todo</span><span class="tok-o">.</span><span class="tok-na">countByUser</span><span class="tok-o">(</span><span class="tok-n">springSecurityService</span><span class="tok-o">.</span><span class="tok-na">currentUser</span><span class="tok-o">)]</span>
    <span class="tok-o">}</span>
  <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora nuestra aplicación sí va a ser capaz de exportar a otros formatos para que el usuario final elija cual de ellos utilizar en cada ocasión. Sin embargo, si echamos un vistazo por ejemplo al formato en PDF, comprobaremos como el listado que aparece muestra todas las propiedades de la clase <em>Todo</em>, a excepción de la propiedad <em>version</em>, lo cual no va a ser aconsejable.</p>
</div>
<div class="paragraph">
<p>Para mejorar esto, el plugin permite especificar que propiedades queremos mostrar e incluso la etiqueta que queremos que aparezca en la fila de encabezados de la tabla. Para conseguir esto, necesitamos completar los dos últimos parámetros del método <em>export()</em> que anteriormente dejábamos vacíos. Además, también necesitaremos indicarle el formato de como deseamos las propiedades de los usuarios y un mapa de parámetros para el fichero exportado. Así quedaría el método <em>index()</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-nf">index</span><span class="tok-o">(</span><span class="tok-n">Integer</span> <span class="tok-n">max</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-n">params</span><span class="tok-o">.</span><span class="tok-na">max</span> <span class="tok-o">=</span> <span class="tok-n">Math</span><span class="tok-o">.</span><span class="tok-na">min</span><span class="tok-o">(</span><span class="tok-n">max</span> <span class="tok-o">?:</span> <span class="tok-mi">10</span><span class="tok-o">,</span> <span class="tok-mi">100</span><span class="tok-o">)</span>
    <span class="tok-k">if</span><span class="tok-o">(</span><span class="tok-n">params</span><span class="tok-o">?.</span><span class="tok-na">f</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-n">params</span><span class="tok-o">.</span><span class="tok-na">f</span> <span class="tok-o">!=</span> <span class="tok-s2">&quot;html&quot;</span><span class="tok-o">){</span>
        <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">contentType</span> <span class="tok-o">=</span> <span class="tok-n">grailsApplication</span><span class="tok-o">.</span><span class="tok-na">config</span><span class="tok-o">.</span><span class="tok-na">grails</span><span class="tok-o">.</span><span class="tok-na">mime</span><span class="tok-o">.</span><span class="tok-na">types</span><span class="tok-o">[</span><span class="tok-n">params</span><span class="tok-o">.</span><span class="tok-na">f</span><span class="tok-o">]</span>
        <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setHeader</span><span class="tok-o">(</span><span class="tok-s2">&quot;Content-disposition&quot;</span><span class="tok-o">,</span> <span class="tok-s2">&quot;attachment; filename=todos.${params.extension}&quot;</span><span class="tok-o">)</span>

        <span class="tok-n">List</span> <span class="tok-n">props</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-s2">&quot;title&quot;</span><span class="tok-o">,</span> <span class="tok-s2">&quot;description&quot;</span><span class="tok-o">,</span> <span class="tok-s2">&quot;date&quot;</span><span class="tok-o">,</span> <span class="tok-s2">&quot;url&quot;</span><span class="tok-o">,</span> <span class="tok-s2">&quot;done&quot;</span><span class="tok-o">]</span>
        <span class="tok-n">Map</span> <span class="tok-n">tags</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-s2">&quot;title&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;Título&quot;</span><span class="tok-o">,</span>
                     <span class="tok-s2">&quot;description&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;Descripción&quot;</span><span class="tok-o">,</span>
                     <span class="tok-s2">&quot;date&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;Fecha&quot;</span><span class="tok-o">,</span>
                     <span class="tok-s2">&quot;url&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;URL&quot;</span><span class="tok-o">,</span>
                     <span class="tok-s2">&quot;done&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;Hecho&quot;</span><span class="tok-o">]</span>

        <span class="tok-c1">// Closure formateador</span>
        <span class="tok-kt">def</span> <span class="tok-n">uppercase</span> <span class="tok-o">=</span> <span class="tok-o">{</span> <span class="tok-n">domain</span><span class="tok-o">,</span> <span class="tok-n">value</span> <span class="tok-o">-&gt;</span>  <span class="tok-k">return</span> <span class="tok-n">value</span><span class="tok-o">.</span><span class="tok-na">toUpperCase</span><span class="tok-o">()</span> <span class="tok-o">}</span>

        <span class="tok-n">Map</span> <span class="tok-n">formatters</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-nl">title:</span> <span class="tok-n">uppercase</span><span class="tok-o">]</span>
        <span class="tok-n">Map</span> <span class="tok-n">parameters</span> <span class="tok-o">=</span> <span class="tok-o">[</span><span class="tok-nl">title:</span> <span class="tok-s2">&quot;LISTADO DE USUARIOS&quot;</span><span class="tok-o">]</span>

        <span class="tok-n">exportService</span><span class="tok-o">.</span><span class="tok-na">export</span><span class="tok-o">(</span><span class="tok-n">params</span><span class="tok-o">.</span><span class="tok-na">f</span><span class="tok-o">,</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">outputStream</span><span class="tok-o">,</span>
            <span class="tok-n">Todo</span><span class="tok-o">.</span><span class="tok-na">findAllByUser</span><span class="tok-o">(</span><span class="tok-n">springSecurityService</span><span class="tok-o">.</span><span class="tok-na">currentUser</span><span class="tok-o">,</span> <span class="tok-n">params</span><span class="tok-o">),</span> <span class="tok-n">props</span><span class="tok-o">,</span> <span class="tok-n">tags</span><span class="tok-o">,</span>
            <span class="tok-n">formatters</span><span class="tok-o">,</span> <span class="tok-n">parameters</span><span class="tok-o">)</span>
    <span class="tok-o">}</span>
    <span class="tok-n">respond</span> <span class="tok-n">Todo</span><span class="tok-o">.</span><span class="tok-na">findAllByUser</span><span class="tok-o">(</span><span class="tok-n">springSecurityService</span><span class="tok-o">.</span><span class="tok-na">currentUser</span><span class="tok-o">,</span> <span class="tok-n">params</span><span class="tok-o">),</span> <span class="tok-nl">model:</span><span class="tok-o">[</span><span class="tok-nl">todoInstanceCount:</span> <span class="tok-n">Todo</span><span class="tok-o">.</span><span class="tok-na">countByUser</span><span class="tok-o">(</span><span class="tok-n">springSecurityService</span><span class="tok-o">.</span><span class="tok-na">currentUser</span><span class="tok-o">)]</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por último, comentar también que podemos cambiar los textos asociados a cada uno de los formatos que aparecen en la barra para exportar. Simplemente debemos crear nuevas entradas en el archivo <em>grails-app/i18n/messages.properties</em> correspondientes, tal y como aparece en el siguiente fragmento de código.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-k">default</span><span class="tok-o">.</span><span class="tok-na">csv</span> <span class="tok-o">=</span> <span class="tok-n">CSV</span>
<span class="tok-k">default</span><span class="tok-o">.</span><span class="tok-na">excel</span> <span class="tok-o">=</span> <span class="tok-n">EXCEL</span>
<span class="tok-k">default</span><span class="tok-o">.</span><span class="tok-na">pdf</span> <span class="tok-o">=</span> <span class="tok-n">PDF</span>
<span class="tok-k">default</span><span class="tok-o">.</span><span class="tok-na">xml</span> <span class="tok-o">=</span> <span class="tok-n">XML</span>
<span class="tok-k">default</span><span class="tok-o">.</span><span class="tok-na">ods</span> <span class="tok-o">=</span> <span class="tok-n">ODS</span></code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios_8">8.5. Ejercicios</h3>
<div class="sect3">
<h4 id="_log_de_acceso_a_controladores_0_25_puntos">8.5.1. Log de acceso a controladores (0.25 puntos)</h4>
<div class="paragraph">
<p>Con lo visto en esta sesión sobre la configuración de los logs y lo visto en la sesión 4 de los filtros que se pueden crear en los controladores, genera logs de tipo <em>trace</em> en todos los métodos de los controladores de nuestra aplicación (sin incluir los controladores <em>login</em> y <em>logout</em> del plugin spring security) para saber el usuario, controlador, método y modelo utilizados en la petición.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">2015-03-28 11:13:15,863 <span class="tok-o">[</span>http-bio-8080-exec-9<span class="tok-o">]</span> TRACE todo.LogFilters  - User admin - Controlador category - Accion index - Modelo <span class="tok-o">[</span>categoryInstanceCount:2, categoryInstanceList:<span class="tok-o">[</span>Hogar, Trabajo<span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Estos logs deberán ser almacenados en un archivo llamados <em>logs/filters.log</em>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_url_limpia_y_pública_para_las_tareas_de_los_usuarios_0_50_puntos">8.5.2. URL limpia y pública para las tareas de los usuarios (0.50 puntos)</h4>
<div class="paragraph">
<p>Crea una url del tipo <em>/todos/$username</em> como la vista en la parte de teoría que muestre todas las tareas del usuario pasado por parámetro en la URL. Este listado de tareas sólo podrá ser accesible por los usuarios de tipo administrador.</p>
</div>
<div class="paragraph">
<p>Modifica también el listado de usuarios que pueden ver los administradores para mostrar un enlace en cada usuario para que les permita ver este listado de tareas. Además, este enlace sólo debe ser mostrado para los usuarios que puedan tener tareas, no para los administradores.</p>
</div>
</div>
<div class="sect3">
<h4 id="_buscador_de_tareas_integrado_0_50_puntos">8.5.3. Buscador de tareas integrado (0.50 puntos)</h4>
<div class="paragraph">
<p>El listado de tareas pide a gritos un buscador integrado. Impleméntalo utilizando el plugin <em>searchable</em> y muéstralo en la parte superior del listado de las tareas. Date cuenta que las tareas están ahora asignadas a un usuario y que por lo tanto, el buscador sólo deberá buscar aquellas tareas que pertenezcan al usuario autenticado.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Estoy seguro que no hace falta que te lo recuerde, pero antes de entregar el proyecto ejecuta <em>grails test-app unit:</em> para comprobar que no hayas <em>roto</em> tus tests haciendo otras tareas.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2015-01-16 20:36:35 CET
</div>
</div>
</body>
</html>