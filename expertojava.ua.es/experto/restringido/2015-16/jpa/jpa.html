<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.2">
<meta name="author" content="Domingo Gallardo">
<title>Frameworks de persistencia - JPA</title>
<style>/*! normalize.css v2.1.2 | MIT License | git.io/normalize */
/* ========================================================================== HTML5 display definitions ========================================================================== */
/** Correct `block` display not defined in IE 8/9. */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }

/** Correct `inline-block` display not defined in IE 8/9. */
audio, canvas, video { display: inline-block; }

/** Prevent modern browsers from displaying `audio` without controls. Remove excess height in iOS 5 devices. */
audio:not([controls]) { display: none; height: 0; }

/** Address `[hidden]` styling not present in IE 8/9. Hide the `template` element in IE, Safari, and Firefox < 22. */
[hidden], template { display: none; }

script { display: none !important; }

/* ========================================================================== Base ========================================================================== */
/** 1. Set default font family to sans-serif. 2. Prevent iOS text size adjust after orientation change, without disabling user zoom. */
html { font-family: sans-serif; /* 1 */ -ms-text-size-adjust: 100%; /* 2 */ -webkit-text-size-adjust: 100%; /* 2 */ }

/** Remove default margin. */
body { margin: 0; }

/* ========================================================================== Links ========================================================================== */
/** Remove the gray background color from active links in IE 10. */
a { background: transparent; }

/** Address `outline` inconsistency between Chrome and other browsers. */
a:focus { outline: thin dotted; }

/** Improve readability when focused and also mouse hovered in all browsers. */
a:active, a:hover { outline: 0; }

/* ========================================================================== Typography ========================================================================== */
/** Address variable `h1` font-size and margin within `section` and `article` contexts in Firefox 4+, Safari 5, and Chrome. */
h1 { font-size: 2em; margin: 0.67em 0; }

/** Address styling not present in IE 8/9, Safari 5, and Chrome. */
abbr[title] { border-bottom: 1px dotted; }

/** Address style set to `bolder` in Firefox 4+, Safari 5, and Chrome. */
b, strong { font-weight: bold; }

/** Address styling not present in Safari 5 and Chrome. */
dfn { font-style: italic; }

/** Address differences between Firefox and other browsers. */
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }

/** Address styling not present in IE 8/9. */
mark { background: #ff0; color: #000; }

/** Correct font family set oddly in Safari 5 and Chrome. */
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }

/** Improve readability of pre-formatted text in all browsers. */
pre { white-space: pre-wrap; }

/** Set consistent quote types. */
q { quotes: "\201C" "\201D" "\2018" "\2019"; }

/** Address inconsistent and variable font size in all browsers. */
small { font-size: 80%; }

/** Prevent `sub` and `sup` affecting `line-height` in all browsers. */
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }

sup { top: -0.5em; }

sub { bottom: -0.25em; }

/* ========================================================================== Embedded content ========================================================================== */
/** Remove border when inside `a` element in IE 8/9. */
img { border: 0; }

/** Correct overflow displayed oddly in IE 9. */
svg:not(:root) { overflow: hidden; }

/* ========================================================================== Figures ========================================================================== */
/** Address margin not present in IE 8/9 and Safari 5. */
figure { margin: 0; }

/* ========================================================================== Forms ========================================================================== */
/** Define consistent border, margin, and padding. */
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }

/** 1. Correct `color` not being inherited in IE 8/9. 2. Remove padding so people aren't caught out if they zero out fieldsets. */
legend { border: 0; /* 1 */ padding: 0; /* 2 */ }

/** 1. Correct font family not being inherited in all browsers. 2. Correct font size not being inherited in all browsers. 3. Address margins set differently in Firefox 4+, Safari 5, and Chrome. */
button, input, select, textarea { font-family: inherit; /* 1 */ font-size: 100%; /* 2 */ margin: 0; /* 3 */ }

/** Address Firefox 4+ setting `line-height` on `input` using `!important` in the UA stylesheet. */
button, input { line-height: normal; }

/** Address inconsistent `text-transform` inheritance for `button` and `select`. All other form control elements do not inherit `text-transform` values. Correct `button` style inheritance in Chrome, Safari 5+, and IE 8+. Correct `select` style inheritance in Firefox 4+ and Opera. */
button, select { text-transform: none; }

/** 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio` and `video` controls. 2. Correct inability to style clickable `input` types in iOS. 3. Improve usability and consistency of cursor style between image-type `input` and others. */
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; /* 2 */ cursor: pointer; /* 3 */ }

/** Re-set default cursor for disabled elements. */
button[disabled], html input[disabled] { cursor: default; }

/** 1. Address box sizing set to `content-box` in IE 8/9. 2. Remove excess padding in IE 8/9. */
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; /* 1 */ padding: 0; /* 2 */ }

/** 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome. 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome (include `-moz` to future-proof). */
input[type="search"] { -webkit-appearance: textfield; /* 1 */ -moz-box-sizing: content-box; -webkit-box-sizing: content-box; /* 2 */ box-sizing: content-box; }

/** Remove inner padding and search cancel button in Safari 5 and Chrome on OS X. */
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }

/** Remove inner padding and border in Firefox 4+. */
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }

/** 1. Remove default vertical scrollbar in IE 8/9. 2. Improve readability and alignment in all browsers. */
textarea { overflow: auto; /* 1 */ vertical-align: top; /* 2 */ }

/* ========================================================================== Tables ========================================================================== */
/** Remove most spacing between table cells. */
table { border-collapse: collapse; border-spacing: 0; }

meta.foundation-mq-small { font-family: "only screen and (min-width: 768px)"; width: 768px; }

meta.foundation-mq-medium { font-family: "only screen and (min-width:1280px)"; width: 1280px; }

meta.foundation-mq-large { font-family: "only screen and (min-width:1440px)"; width: 1440px; }

*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }

html, body { font-size: 97%; }

body { background: white; color: #222222; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }

a:hover { cursor: pointer; }

img, object, embed { max-width: 100%; height: auto; }

object, embed { height: 100%; }

img { -ms-interpolation-mode: bicubic; }

#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }

.left { float: left !important; }

.right { float: right !important; }

.text-left { text-align: left !important; }

.text-right { text-align: right !important; }

.text-center { text-align: center !important; }

.text-justify { text-align: justify !important; }

.hide { display: none; }

.antialiased, body { -webkit-font-smoothing: antialiased; }

img { display: inline-block; vertical-align: middle; }

textarea { height: auto; min-height: 50px; }

select { width: 100%; }

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }

.subheader, .admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { line-height: 1.4; color: #6f6f6f; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }

/* Typography resets */
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }

/* Default Link Styles */
a { color: #1164be; text-decoration: none; line-height: inherit; }
a img { border: none; }

/* Default paragraph styles */
p { font-family: inherit; font-weight: normal; font-size: 1em; line-height: 1.4; margin-bottom: 1em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }

/* Default header styles */
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: bold; font-style: normal; color: #1c355e; text-rendering: optimizeLegibility; margin-top: 1em; margin-bottom: 0.5em; line-height: 1.2125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #6f6f6f; line-height: 0; }

h1 { font-size: 2.125em; }

h2 { font-size: 1.6875em; }

h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }

h4 { font-size: 1.125em; }

h5 { font-size: 1.125em; }

h6 { font-size: 1em; }

hr { border: solid #dddddd; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }

/* Helpful Typography Defaults */
em, i { font-style: italic; line-height: inherit; }

strong, b { font-weight: bold; line-height: inherit; }

small { font-size: 60%; line-height: inherit; }

code { font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: bold; }

/* Lists */
ul, ol, dl { font-size: 1em; line-height: 1.4; margin-bottom: 1.25em; list-style-position: outside; font-family: inherit; }

ul, ol { margin-left: 2.5em; }
ul.no-bullet, ol.no-bullet { margin-left: 1.5em; }

/* Unordered Lists */
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; /* Override nested font-size change */ }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }

/* Ordered Lists */
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }

/* Definition Lists */
dl dt { margin-bottom: 0.3125em; font-weight: bold; }
dl dd { margin-bottom: 1.25em; }

/* Abbreviations */
abbr, acronym { text-transform: uppercase; font-size: 90%; color: #222222; border-bottom: 1px dotted #dddddd; cursor: help; }

abbr { text-transform: none; }

/* Blockquotes */
blockquote { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
blockquote cite { display: block; font-size: 0.8125em; color: #555555; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #555555; }

blockquote, blockquote p { line-height: 1.6; color: #6f6f6f; }

/* Microformats */
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #dddddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }

.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }

/*@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.6875em; }
  h4 { font-size: 1.4375em; } }*/
/* Tables */
table { background: white; margin-bottom: 1.25em; border: solid 1px #dddddd; }
table thead, table tfoot { background: whitesmoke; font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: #222222; text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: #222222; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #f9f9f9; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.4; }

h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; border-bottom: 1px solid #dddddd }

.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }

*:not(pre) > code { font-size: inherit; font-style: normal !important; letter-spacing: 0; padding: 3px 2px 1px 2px; background-color: #eeeeee; border: 1px solid #dddddd; -webkit-border-radius: 0; border-radius: 0; line-height: inherit; font-weight: normal; }

pre, pre > code { line-height: 1.4; color: black; font-family: monospace, serif; font-weight: normal; }

.keyseq { color: #555555; }

kbd { display: inline-block; color: #222222; font-size: 0.75em; line-height: 1.4; background-color: #f7f7f7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; margin: -0.15em 0.15em 0 0.15em; padding: 0.2em 0.6em 0.2em 0.5em; vertical-align: middle; white-space: nowrap; }

.keyseq kbd:first-child { margin-left: 0; }

.keyseq kbd:last-child { margin-right: 0; }

.menuseq, .menu { color: #090909; }

b.button:before, b.button:after { position: relative; top: -1px; font-weight: normal; }

b.button:before { content: "["; padding: 0 3px 0 2px; }

b.button:after { content: "]"; padding: 0 2px 0 3px; }

#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 0.9375em; padding-right: 0.9375em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }

#content { margin-top: 1.25em; }

#content:before { content: none; }

#header > h1:first-child { color: black; margin-top: 2.25rem; margin-bottom: 0; }
#header > h1:first-child + #toc { margin-top: 8px; border-top: 1px solid #dddddd; }
#header > h1:only-child, body.toc2 #header > h1:nth-last-child(2) { border-bottom: 1px solid #dddddd; padding-bottom: 8px; }
#header .details { border-bottom: 1px solid #dddddd; line-height: 1.45; padding-top: 0.25em; padding-bottom: 0.25em; padding-left: 0.25em; color: #555555; display: -ms-flexbox; display: -webkit-flex; display: flex; -ms-flex-flow: row wrap; -webkit-flex-flow: row wrap; flex-flow: row wrap; }
#header .details span:first-child { margin-left: -0.125em; }
#header .details span.email a { color: #6f6f6f; }
#header .details br { display: none; }
#header .details br + span:before { content: "\00a0\2013\00a0"; }
#header .details br + span.author:before { content: "\00a0\22c5\00a0"; color: #6f6f6f; }
#header .details br + span#revremark:before { content: "\00a0|\00a0"; }
#header #revnumber { text-transform: capitalize; }
#header #revnumber:after { content: "\00a0"; }

#content > h1:first-child:not([class]) { color: black; border-bottom: 1px solid #dddddd; padding-bottom: 8px; margin-top: 0; padding-top: 1rem; margin-bottom: 1.25rem; }

#floating {
  position: fixed;
  z-index: 1000;
  padding: 0.5em;
  right: 0;
  top: 0;
  background: white;
  box-shadow: 0 0 1em #777777;
  -webkit-box-shadow: 0 0 1em #777777;
  -moz-box-shadow: 0 0 1em #777777;
  -webkit-border-bottom-left-radius: 5px;
  -moz-border-radius-bottomleft: 5px;
  max-height: 80%;
  overflow: auto;
}

#floating #full { display: none; } /* Hide the full TOC by default */

#floating:hover #full{
  display: block; /* Show it on hover */
}


#toc { border-bottom: 1px solid #dddddd; padding-bottom: 0.5em; }
#toc > ul { margin-left: 0.125em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin: 0.5em 0; }
#toc ul { font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; list-style-type: none; }
#toc a { text-decoration: none; }
#toc a:active { text-decoration: underline; }

#toctitle { color: #6f6f6f; font-size: 1.2em; }

@media only screen and (min-width: 768px) { #toctitle { font-size: 1.375em; }
  body.toc2 { padding-left: 15em; padding-right: 0; }
  #toc.toc2 { margin-top: 0 !important; background-color: #f2f2f2; position: fixed; width: 15em; left: 0; top: 0; border-right: 1px solid #dddddd; border-top-width: 0 !important; border-bottom-width: 0 !important; z-index: 1000; padding: 1.25em 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; font-size: 1.2em; }
  #toc.toc2 > ul { font-size: 0.9em; margin-bottom: 0; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 15em; }
  body.toc2.toc-right #toc.toc2 { border-right-width: 0; border-left: 1px solid #dddddd; left: auto; right: 0; } }
@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; padding-right: 0; }
  #toc.toc2 { width: 20em; }
  #toc.toc2 #toctitle { font-size: 1.375em; }
  #toc.toc2 > ul { font-size: 0.95em; }
  #toc.toc2 ul ul { padding-left: 1.25em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; } }
#content #toc { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 0; border-radius: 0; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }

#footer { max-width: 100%; background-color: #222222; padding: 1.25em; }

#footer-text { color: #dddddd; line-height: 1.44; }

.sect1 { padding-bottom: 0.625em; }

@media only screen and (min-width: 768px) { .sect1 { padding-bottom: 1.25em; } }
.sect1 + .sect1 { border-top: 1px solid #dddddd; }

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; z-index: 1001; width: 1.5ex; margin-left: -1.5ex; display: block; text-decoration: none !important; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: "\00A7"; font-size: 0.85em; display: block; padding-top: 0.1em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #222222; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #151515; }

.audioblock, .imageblock, .literalblock, .listingblock, .stemblock, .videoblock { margin-bottom: 1.25em; }

.admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-rendering: optimizeLegibility; text-align: left; }

table.tableblock > caption.title { white-space: nowrap; overflow: visible; max-width: 0; }

.paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { color: black; }

table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }

.admonitionblock > table { border-collapse: separate; border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #dddddd; color: #555555; }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }

.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 0; border-radius: 0; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }

.sidebarblock { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 0; border-radius: 0; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock > .content > .title { color: #6f6f6f; margin-top: 0; }

.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }

.literalblock pre, .listingblock pre:not(.highlight), .listingblock pre[class="highlight"], .listingblock pre[class^="highlight "], .listingblock pre.CodeRay, .listingblock pre.prettyprint { background: #eeeeee; }
.sidebarblock .literalblock pre, .sidebarblock .listingblock pre:not(.highlight), .sidebarblock .listingblock pre[class="highlight"], .sidebarblock .listingblock pre[class^="highlight "], .sidebarblock .listingblock pre.CodeRay, .sidebarblock .listingblock pre.prettyprint { background: #f2f1f1; }

.literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { border: 1px solid #cccccc; -webkit-border-radius: 0; border-radius: 0; word-wrap: break-word; padding: 0.8em 0.8em 0.65em 0.8em; font-size: 0.8125em; }
.literalblock pre.nowrap, .literalblock pre[class].nowrap, .listingblock pre.nowrap, .listingblock pre[class].nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
@media only screen and (min-width: 768px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 0.90625em; } }
@media only screen and (min-width: 1280px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 1em; } }

.literalblock.output pre { color: #eeeeee; background-color: black; }

.listingblock pre.highlightjs { padding: 0; }
.listingblock pre.highlightjs > code { padding: 0.8em 0.8em 0.65em 0.8em; -webkit-border-radius: 0; border-radius: 0; }

.listingblock > .content { position: relative; }

.listingblock code[data-lang]:before { display: none; content: attr(data-lang); position: absolute; font-size: 0.75em; top: 0.425rem; right: 0.5rem; line-height: 1; text-transform: uppercase; color: #999; }

.listingblock:hover code[data-lang]:before { display: block; }

.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }

.listingblock.terminal pre .command:not([data-prompt]):before { content: "$"; }

table.pyhltable { border-collapse: separate; border: 0; margin-bottom: 0; background: none; }

table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; }

table.pyhltable td.code { padding-left: .75em; padding-right: 0; }

pre.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #dddddd; }

pre.pygments .lineno { display: inline-block; margin-right: .25em; }

table.pyhltable .linenodiv { background: none !important; padding-right: 0 !important; }

.quoteblock { margin: 0 1em 1.25em 1.5em; display: table; }
.quoteblock > .title { margin-left: -1.5em; margin-bottom: 0.75em; }
.quoteblock blockquote, .quoteblock blockquote p { color: #6f6f6f; font-size: 1.15rem; line-height: 1.75; word-spacing: 0.1em; letter-spacing: 0; font-style: italic; text-align: justify; }
.quoteblock blockquote { margin: 0; padding: 0; border: 0; }
.quoteblock blockquote:before { content: "\201c"; float: left; font-size: 2.75em; font-weight: bold; line-height: 0.6em; margin-left: -0.6em; color: #6f6f6f; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: 0.5em; margin-right: 0.5ex; text-align: right; }
.quoteblock .quoteblock { margin-left: 0; margin-right: 0; padding: 0.5em 0; border-left: 3px solid #555555; }
.quoteblock .quoteblock blockquote { padding: 0 0 0 0.75em; }
.quoteblock .quoteblock blockquote:before { display: none; }

.verseblock { margin: 0 1em 1.25em 1em; }
.verseblock pre { font-family: "Open Sans", "DejaVu Sans", sans; font-size: 1.15rem; color: #6f6f6f; font-weight: 300; text-rendering: optimizeLegibility; }
.verseblock pre strong { font-weight: 400; }
.verseblock .attribution { margin-top: 1.25rem; margin-left: 0.5ex; }

.quoteblock .attribution, .verseblock .attribution { font-size: 0.8125em; line-height: 1.45; font-style: italic; }
.quoteblock .attribution br, .verseblock .attribution br { display: none; }
.quoteblock .attribution cite, .verseblock .attribution cite { display: block; letter-spacing: -0.05em; color: #555555; }

.quoteblock.abstract { margin: 0 0 1.25em 0; display: block; }
.quoteblock.abstract blockquote, .quoteblock.abstract blockquote p { text-align: left; word-spacing: 0; }
.quoteblock.abstract blockquote:before, .quoteblock.abstract blockquote p:first-of-type:before { display: none; }

table.tableblock { max-width: 100%; border-collapse: separate; }
table.tableblock td > .paragraph:last-child p > p:last-child, table.tableblock th > p:last-child, table.tableblock td > p:last-child { margin-bottom: 0; }

table.spread { width: 100%; }

table.tableblock, th.tableblock, td.tableblock { border: 0 solid #dddddd; }

table.grid-all th.tableblock, table.grid-all td.tableblock { border-width: 0 1px 1px 0; }

table.grid-all tfoot > tr > th.tableblock, table.grid-all tfoot > tr > td.tableblock { border-width: 1px 1px 0 0; }

table.grid-cols th.tableblock, table.grid-cols td.tableblock { border-width: 0 1px 0 0; }

table.grid-all * > tr > .tableblock:last-child, table.grid-cols * > tr > .tableblock:last-child { border-right-width: 0; }

table.grid-rows th.tableblock, table.grid-rows td.tableblock { border-width: 0 0 1px 0; }

table.grid-all tbody > tr:last-child > th.tableblock, table.grid-all tbody > tr:last-child > td.tableblock, table.grid-all thead:last-child > tr > th.tableblock, table.grid-rows tbody > tr:last-child > th.tableblock, table.grid-rows tbody > tr:last-child > td.tableblock, table.grid-rows thead:last-child > tr > th.tableblock { border-bottom-width: 0; }

table.grid-rows tfoot > tr > th.tableblock, table.grid-rows tfoot > tr > td.tableblock { border-width: 1px 0 0 0; }

table.frame-all { border-width: 1px; }

table.frame-sides { border-width: 0 1px; }

table.frame-topbot { border-width: 1px 0; }

th.halign-left, td.halign-left { text-align: left; }

th.halign-right, td.halign-right { text-align: right; }

th.halign-center, td.halign-center { text-align: center; }

th.valign-top, td.valign-top { vertical-align: top; }

th.valign-bottom, td.valign-bottom { vertical-align: bottom; }

th.valign-middle, td.valign-middle { vertical-align: middle; }

table thead th, table tfoot th { font-weight: bold; }

tbody tr th { display: table-cell; line-height: 1.4; background: whitesmoke; }

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p { color: #222222; font-weight: bold; }

p.tableblock > code:only-child { background: none; padding: 0; }

p.tableblock { font-size: 1em; }

td > div.verse { white-space: pre; }

ol { margin-left: 2.5em; }

ul li ol { margin-left: 1.5em; }

dl dd { margin-left: 1.125em; }

dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }

ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.625em; }

ul.unstyled, ol.unnumbered, ul.checklist, ul.none { list-style-type: none; }

ul.unstyled, ol.unnumbered, ul.checklist { margin-left: 0.625em; }

ul.checklist li > p:first-child > .fa-check-square-o:first-child, ul.checklist li > p:first-child > input[type="checkbox"]:first-child { margin-right: 0.25em; }

ul.checklist li > p:first-child > input[type="checkbox"]:first-child { position: relative; top: 1px; }

ul.inline { margin: 0 auto 0.625em auto; margin-left: -1.375em; margin-right: 0; padding: 0; list-style: none; overflow: hidden; }
ul.inline > li { list-style: none; float: left; margin-left: 1.375em; display: block; }
ul.inline > li > * { display: block; }

.unstyled dl dt { font-weight: normal; font-style: normal; }

ol.arabic { list-style-type: decimal; }

ol.decimal { list-style-type: decimal-leading-zero; }

ol.loweralpha { list-style-type: lower-alpha; }

ol.upperalpha { list-style-type: upper-alpha; }

ol.lowerroman { list-style-type: lower-roman; }

ol.upperroman { list-style-type: upper-roman; }

ol.lowergreek { list-style-type: lower-greek; }

.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }

td.hdlist1 { padding-right: .75em; font-weight: bold; }

td.hdlist1, td.hdlist2 { vertical-align: top; }

.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }

.colist > table tr > td:first-of-type { padding: 0 0.75em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.25em 0; }

.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: 0 0 0 1px #dddddd; box-shadow: 0 0 0 1px #dddddd; }

.imageblock.left, .imageblock[style*="float: left"] { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }

.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }

a.image { text-decoration: none; }

span.footnote, span.footnoteref { vertical-align: super; font-size: 0.875em; }
span.footnote a, span.footnoteref a { text-decoration: none; }
span.footnote a:active, span.footnoteref a:active { text-decoration: underline; }

#footnotes { padding-top: 0.75em; padding-bottom: 0.75em; margin-bottom: 0.625em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -.25em 0 .75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.375em; line-height: 1.3; font-size: 0.875em; margin-left: 1.2em; text-indent: -1.2em; margin-bottom: .2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }

#content #footnotes { margin-top: -0.625em; margin-bottom: 0; padding: 0.75em 0; }

.gist .file-data > table { border: 0; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }

div.unbreakable { page-break-inside: avoid; }

.big { font-size: larger; }

.small { font-size: smaller; }

.underline { text-decoration: underline; }

.overline { text-decoration: overline; }

.line-through { text-decoration: line-through; }

.aqua { color: #00bfbf; }

.aqua-background { background-color: #00fafa; }

.black { color: black; }

.black-background { background-color: black; }

.blue { color: #0000bf; }

.blue-background { background-color: #0000fa; }

.fuchsia { color: #bf00bf; }

.fuchsia-background { background-color: #fa00fa; }

.gray { color: #606060; }

.gray-background { background-color: #7d7d7d; }

.green { color: #006000; }

.green-background { background-color: #007d00; }

.lime { color: #00bf00; }

.lime-background { background-color: #00fa00; }

.maroon { color: #600000; }

.maroon-background { background-color: #7d0000; }

.navy { color: #000060; }

.navy-background { background-color: #00007d; }

.olive { color: #606000; }

.olive-background { background-color: #7d7d00; }

.purple { color: #600060; }

.purple-background { background-color: #7d007d; }

.red { color: #bf0000; }

.red-background { background-color: #fa0000; }

.silver { color: #909090; }

.silver-background { background-color: #bcbcbc; }

.teal { color: #006060; }

.teal-background { background-color: #007d7d; }

.white { color: #bfbfbf; }

.white-background { background-color: #fafafa; }

.yellow { color: #bfbf00; }

.yellow-background { background-color: #fafa00; }

span.icon > .fa { cursor: default; }

.admonitionblock td.icon [class^="fa icon-"] { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #207c98; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }

.conum[data-value] { display: inline-block; color: #fff !important; background-color: #222222; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; font-size: 0.75em; width: 1.67em; height: 1.67em; line-height: 1.67em; font-family: "Open Sans", "DejaVu Sans", sans-serif; font-style: normal; font-weight: bold; }
.conum[data-value] * { color: #fff !important; }
.conum[data-value] + b { display: none; }
.conum[data-value]:after { content: attr(data-value); }
pre .conum[data-value] { position: relative; top: -0.125em; }

b.conum * { color: inherit !important; }

.conum:not([data-value]):empty { display: none; }

.literalblock pre, .listingblock pre { background: #eeeeee; }

</style>
<style>.listingblock .pygments .hll { background-color: #ffffcc }
.listingblock .pygments  { background: #f8f8f8; }
.listingblock .pygments .tok-c { color: #408080; font-style: italic } /* Comment */
.listingblock .pygments .tok-err { border: 1px solid #FF0000 } /* Error */
.listingblock .pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
.listingblock .pygments .tok-o { color: #666666 } /* Operator */
.listingblock .pygments .tok-cm { color: #408080; font-style: italic } /* Comment.Multiline */
.listingblock .pygments .tok-cp { color: #BC7A00 } /* Comment.Preproc */
.listingblock .pygments .tok-c1 { color: #408080; font-style: italic } /* Comment.Single */
.listingblock .pygments .tok-cs { color: #408080; font-style: italic } /* Comment.Special */
.listingblock .pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
.listingblock .pygments .tok-ge { font-style: italic } /* Generic.Emph */
.listingblock .pygments .tok-gr { color: #FF0000 } /* Generic.Error */
.listingblock .pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
.listingblock .pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
.listingblock .pygments .tok-go { color: #888888 } /* Generic.Output */
.listingblock .pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.listingblock .pygments .tok-gs { font-weight: bold } /* Generic.Strong */
.listingblock .pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.listingblock .pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
.listingblock .pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.listingblock .pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.listingblock .pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.listingblock .pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
.listingblock .pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.listingblock .pygments .tok-kt { color: #B00040 } /* Keyword.Type */
.listingblock .pygments .tok-m { color: #666666 } /* Literal.Number */
.listingblock .pygments .tok-s { color: #BA2121 } /* Literal.String */
.listingblock .pygments .tok-na { color: #7D9029 } /* Name.Attribute */
.listingblock .pygments .tok-nb { color: #008000 } /* Name.Builtin */
.listingblock .pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
.listingblock .pygments .tok-no { color: #880000 } /* Name.Constant */
.listingblock .pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
.listingblock .pygments .tok-ni { color: #999999; font-weight: bold } /* Name.Entity */
.listingblock .pygments .tok-ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.listingblock .pygments .tok-nf { color: #0000FF } /* Name.Function */
.listingblock .pygments .tok-nl { color: #A0A000 } /* Name.Label */
.listingblock .pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.listingblock .pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
.listingblock .pygments .tok-nv { color: #19177C } /* Name.Variable */
.listingblock .pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.listingblock .pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
.listingblock .pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
.listingblock .pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
.listingblock .pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
.listingblock .pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
.listingblock .pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
.listingblock .pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
.listingblock .pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
.listingblock .pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.listingblock .pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
.listingblock .pygments .tok-se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.listingblock .pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
.listingblock .pygments .tok-si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.listingblock .pygments .tok-sx { color: #008000 } /* Literal.String.Other */
.listingblock .pygments .tok-sr { color: #BB6688 } /* Literal.String.Regex */
.listingblock .pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
.listingblock .pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
.listingblock .pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
.listingblock .pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
.listingblock .pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
.listingblock .pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
.listingblock .pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Frameworks de persistencia - JPA</h1>
<div class="details">
<span id="author" class="author">Domingo Gallardo</span><br>
<span id="email" class="email"><a href="mailto:domingo.gallardo@ua.es">domingo.gallardo@ua.es</a></span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Índice de contenidos</div>
<ul class="sectlevel1">
<li><a href="#_primer_contacto_con_jpa">1. Primer contacto con JPA</a>
<ul class="sectlevel2">
<li><a href="#_introducci%C3%B3n_a_jpa">1.1. Introducción a JPA</a>
<ul class="sectlevel3">
<li><a href="#_los_or%C3%ADgenes_de_jpa">1.1.1. Los orígenes de JPA</a></li>
<li><a href="#_java_persistence_api">1.1.2. Java Persistence API</a></li>
<li><a href="#_implementaciones_de_jpa">1.1.3. Implementaciones de JPA</a></li>
<li><a href="#_para_saber_m%C3%A1s">1.1.4. Para saber más</a></li>
</ul>
</li>
<li><a href="#_ejemplo_pr%C3%A1ctico_una_sencilla_aplicaci%C3%B3n_jpa">1.2. Ejemplo práctico: una sencilla aplicación JPA</a>
<ul class="sectlevel3">
<li><a href="#_configuraci%C3%B3n_del_proyecto_maven">1.2.1. Configuración del proyecto Maven</a></li>
<li><a href="#_configuraci%C3%B3n_de_la_conexi%C3%B3n_a_la_bd_de_intellij">1.2.2. Configuración de la conexión a la BD de IntelliJ</a></li>
<li><a href="#_clases_entidad">1.2.3. Clases entidad</a></li>
<li><a href="#_el_fichero_persistence_xml_y_la_base_de_datos">1.2.4. El fichero persistence.xml y la base de datos</a></li>
<li><a href="#_ficheros_de_configuraci%C3%B3n_de_logging">1.2.5. Ficheros de configuración de logging</a></li>
<li><a href="#_programas_java_em_standalone_em_que_trabajan_con_jpa">1.2.6. Programas Java <em>standalone</em> que trabajan con JPA</a></li>
<li><a href="#_definici%C3%B3n_de_tests_con_dbunit">1.2.7. Definición de tests con DbUnit</a></li>
</ul>
</li>
<li><a href="#_ejercicios">1.3. Ejercicios</a>
<ul class="sectlevel3">
<li><a href="#__0_5_puntos_construir_el_m%C3%B3dulo_mensajes">1.3.1. (0,5 puntos) Construir el módulo mensajes</a></li>
<li><a href="#__1_5_puntos_contruir_el_m%C3%B3dulo_filmoteca">1.3.2. (1,5 puntos) Contruir el módulo filmoteca</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sesion02">2. Entity Manager y contexto de persistencia</a>
<ul class="sectlevel2">
<li><a href="#_introducci%C3%B3n">2.1. Introducción</a>
<ul class="sectlevel3">
<li><a href="#_entidades_gestionadas_y_desconectadas">2.1.1. Entidades gestionadas y desconectadas</a></li>
<li><a href="#_apis_de_java_ee_7">2.1.2. APIs de Java EE 7</a></li>
<li><a href="#_obtenci%C3%B3n_del_entity_manager_factory_y_de_los_entity_manager">2.1.3. Obtención del entity manager factory y de los entity manager</a></li>
<li><a href="#_transacciones">2.1.4. Transacciones</a></li>
</ul>
</li>
<li><a href="#_operaciones_crud_del_entity_manager">2.2. Operaciones CRUD del entity manager</a>
<ul class="sectlevel3">
<li><a href="#_persist_para_hacer_persistente_una_entidad">2.2.1. Persist para hacer persistente una entidad</a></li>
<li><a href="#_find_para_buscar_entidades_por_clave_primaria">2.2.2. Find para buscar entidades por clave primaria</a></li>
<li><a href="#_actualizaci%C3%B3n_de_entidades">2.2.3. Actualización de entidades</a></li>
<li><a href="#_remove_para_borrar_entidades">2.2.4. Remove para borrar entidades</a></li>
</ul>
</li>
<li><a href="#_operaciones_en_cascada">2.3. Operaciones en cascada</a>
<ul class="sectlevel3">
<li><a href="#_persist_en_cascada">2.3.1. Persist en cascada</a></li>
<li><a href="#_borrado_en_cascada">2.3.2. Borrado en cascada</a></li>
</ul>
</li>
<li><a href="#_queries">2.4. Queries</a></li>
<li><a href="#_operaciones_sobre_el_contexto_de_persistencia">2.5. Operaciones sobre el contexto de persistencia</a>
<ul class="sectlevel3">
<li><a href="#_sincronizaci%C3%B3n_con_la_base_de_datos_con_code_flush_code">2.5.1. Sincronización con la base de datos con <code>flush</code></a></li>
<li><a href="#_desconexi%C3%B3n_de_entidades">2.5.2. Desconexión de entidades</a></li>
<li><a href="#_merge">2.5.3. Merge</a></li>
<li><a href="#_actualizaci%C3%B3n_de_las_colecciones_en_las_relaciones_a_muchos">2.5.4. Actualización de las colecciones en las relaciones a-muchos</a></li>
</ul>
</li>
<li><a href="#_implementaci%C3%B3n_de_un_dao_con_jpa">2.6. Implementación de un DAO con JPA</a></li>
<li><a href="#_ejercicios_2">2.7. Ejercicios</a>
<ul class="sectlevel3">
<li><a href="#__0_5_puntos_contexto_de_persistencia">2.7.1. (0,5 puntos) Contexto de persistencia</a></li>
<li><a href="#__0_5_puntos_clases_dao_del_m%C3%B3dulo_code_filmoteca_code">2.7.2. (0,5 puntos) Clases DAO del módulo <code>filmoteca</code></a></li>
<li><a href="#__0_5_puntos_clase_code_peliculaservicio_code">2.7.3. (0,5 puntos) Clase <code>PeliculaServicio</code></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sesion03">3. Mapeado entidad-relación: tablas</a>
<ul class="sectlevel2">
<li><a href="#_acceso_al_estado_de_la_entidad">3.1. Acceso al estado de la entidad</a>
<ul class="sectlevel3">
<li><a href="#_acceso_por_campo">3.1.1. Acceso por campo</a></li>
<li><a href="#_acceso_por_propiedad">3.1.2. Acceso por propiedad</a></li>
</ul>
</li>
<li><a href="#_mapeado_de_entidades">3.2. Mapeado de entidades</a></li>
<li><a href="#_mapeado_de_tipos">3.3. Mapeado de tipos</a>
<ul class="sectlevel3">
<li><a href="#_mapeo_de_columnas">3.3.1. Mapeo de columnas</a></li>
<li><a href="#_recuperaci%C3%B3n_perezosa">3.3.2. Recuperación perezosa</a></li>
<li><a href="#_lobs">3.3.3. LOBs</a></li>
<li><a href="#_tipos_enumerados">3.3.4. Tipos enumerados</a></li>
<li><a href="#_tipos_temporales">3.3.5. Tipos temporales</a></li>
<li><a href="#_estado_transitorio">3.3.6. Estado transitorio</a></li>
</ul>
</li>
<li><a href="#_objetos_embebidos">3.4. Objetos embebidos</a></li>
<li><a href="#_mapeo_de_la_clave_primaria">3.5. Mapeo de la clave primaria</a>
<ul class="sectlevel3">
<li><a href="#_generaci%C3%B3n_del_identificador">3.5.1. Generación del identificador</a></li>
<li><a href="#_clave_primaria_compuesta">3.5.2. Clave primaria compuesta</a></li>
<li><a href="#_clave_ajena_compuesta">3.5.3. Clave ajena compuesta</a></li>
</ul>
</li>
<li><a href="#_mapeado_de_las_relaciones_de_herencia">3.6. Mapeado de las relaciones de herencia</a></li>
<li><a href="#_bean_validation">3.7. Bean Validation</a>
<ul class="sectlevel3">
<li><a href="#_configuraci%C3%B3n_de_maven_y_jpa">3.7.1. Configuración de Maven y JPA</a></li>
<li><a href="#_anotaciones_de_validaci%C3%B3n_predefinidas">3.7.2. Anotaciones de validación predefinidas</a></li>
<li><a href="#_proceso_de_validaci%C3%B3n">3.7.3. Proceso de validación</a></li>
</ul>
</li>
<li><a href="#_ejercicios_3">3.8. Ejercicios</a>
<ul class="sectlevel3">
<li><a href="#__0_5_puntos_mapeado_de_tablas_y_campos_y_restricciones_em_bean_validation_em">3.8.1. (0,5 puntos) Mapeado de tablas y campos y restricciones <em>Bean Validation</em></a></li>
<li><a href="#__0_5_puntos_relaci%C3%B3n_de_herencia_en_code_pelicula_code">3.8.2. (0,5 puntos) Relación de herencia en <code>Pelicula</code></a></li>
<li><a href="#__0_5_puntos_restricciones_code_bean_validation_code">3.8.3. (0,5 puntos) Restricciones <code>Bean Validation</code></a></li>
<li><a href="#__0_5_puntos_clase_de_servicio">3.8.4. (0,5 puntos) Clase de servicio</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sesion04">4. Mapeo entidad-relación: relaciones</a>
<ul class="sectlevel2">
<li><a href="#_conceptos_previos">4.1. Conceptos previos</a>
<ul class="sectlevel3">
<li><a href="#_direccionalidad">4.1.1. Direccionalidad</a></li>
<li><a href="#_cardinalidad">4.1.2. Cardinalidad</a></li>
<li><a href="#_entidad_propietaria_de_la_relaci%C3%B3n">4.1.3. Entidad propietaria de la relación</a></li>
<li><a href="#_actualizaci%C3%B3n_de_la_relaci%C3%B3n">4.1.4. Actualización de la relación</a></li>
</ul>
</li>
<li><a href="#_definici%C3%B3n_de_relaciones">4.2. Definición de relaciones</a>
<ul class="sectlevel3">
<li><a href="#_relaci%C3%B3n_uno_a_uno_unidireccional">4.2.1. Relación uno-a-uno unidireccional</a></li>
<li><a href="#_relaci%C3%B3n_uno_a_uno_bidireccional">4.2.2. Relación uno-a-uno bidireccional</a></li>
<li><a href="#_relaci%C3%B3n_uno_a_muchos_muchos_a_uno_bidireccional">4.2.3. Relación uno-a-muchos/muchos-a-uno bidireccional</a></li>
<li><a href="#_relaci%C3%B3n_muchos_a_uno_unidireccional">4.2.4. Relación muchos-a-uno unidireccional</a></li>
<li><a href="#_relaci%C3%B3n_muchos_a_muchos_bidireccional">4.2.5. Relación muchos-a-muchos bidireccional</a></li>
<li><a href="#_relaci%C3%B3n_muchos_a_muchos_unidireccional">4.2.6. Relación muchos-a-muchos unidireccional</a></li>
<li><a href="#_columnas_adicionales_en_la_tabla_join">4.2.7. Columnas adicionales en la tabla join</a></li>
</ul>
</li>
<li><a href="#_carga_perezosa">4.3. Carga perezosa</a></li>
<li><a href="#_referencias_e_informaci%C3%B3n_adicional">4.4. Referencias e información adicional</a></li>
<li><a href="#_ejercicios_4">4.5. Ejercicios</a>
<ul class="sectlevel3">
<li><a href="#__0_75_punto_relaci%C3%B3n_muchos_a_muchos_entre_code_pelicula_code_y_code_actor_code">4.5.1. (0,75 punto) Relación muchos-a-muchos entre <code>Pelicula</code> y <code>Actor</code></a></li>
<li><a href="#__0_75_puntos_daos_code_actordao_code_y_code_criticadao_code">4.5.2. (0,75 puntos) DAOs <code>ActorDao</code> y <code>CriticaDao</code></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sesion05">5. Consultas</a>
<ul class="sectlevel2">
<li><a href="#_definici%C3%B3n_de_clases">5.1. Definición de clases</a></li>
<li><a href="#_definici%C3%B3n_de_consultas_jpql">5.2. Definición de consultas JPQL</a>
<ul class="sectlevel3">
<li><a href="#_par%C3%A1metros_de_las_consultas">5.2.1. Parámetros de las consultas</a></li>
<li><a href="#_consultas_din%C3%A1micas">5.2.2. Consultas dinámicas</a></li>
<li><a href="#_consultas_con_nombre">5.2.3. Consultas con nombre</a></li>
<li><a href="#_ejecuci%C3%B3n_de_consultas">5.2.4. Ejecución de consultas</a></li>
</ul>
</li>
<li><a href="#_java_persistence_query_language">5.3. Java Persistence Query Language</a>
<ul class="sectlevel3">
<li><a href="#_consultas_b%C3%A1sicas">5.3.1. Consultas básicas</a></li>
<li><a href="#_filtrando_los_resultados">5.3.2. Filtrando los resultados</a></li>
<li><a href="#_proyectando_los_resultados">5.3.3. Proyectando los resultados</a></li>
<li><a href="#_joins_entre_entidades">5.3.4. Joins entre entidades</a></li>
<li><a href="#_paginaci%C3%B3n_de_resultados">5.3.5. Paginación de resultados</a></li>
<li><a href="#_subqueries">5.3.6. Subqueries</a></li>
<li><a href="#_valores_nulos_y_colecciones_vac%C3%ADas">5.3.7. Valores nulos y colecciones vacías</a></li>
<li><a href="#_funciones">5.3.8. Funciones</a></li>
<li><a href="#_pattern_matching">5.3.9. Pattern matching</a></li>
<li><a href="#_agrupaciones">5.3.10. Agrupaciones</a></li>
<li><a href="#_order_by">5.3.11. Order by</a></li>
</ul>
</li>
<li><a href="#_api_criteria">5.4. API Criteria</a>
<ul class="sectlevel3">
<li><a href="#_ejemplos">5.4.1. Ejemplos</a></li>
</ul>
</li>
<li><a href="#_organizaci%C3%B3n_de_las_queries_en_daos">5.5. Organización de las queries en DAOs</a></li>
<li><a href="#_ejercicios_5">5.6. Ejercicios</a>
<ul class="sectlevel3">
<li><a href="#__0_75_puntos_definici%C3%B3n_de_consultas_en_peliculadao">5.6.1. (0,75 puntos) Definición de consultas en PeliculaDao</a></li>
<li><a href="#__0_75_puntos_definici%C3%B3n_de_consultas_en_actordao">5.6.2. (0,75 puntos) Definición de consultas en ActorDao</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sesion06">6. Transacciones y JPA en aplicaciones Java EE</a>
<ul class="sectlevel2">
<li><a href="#_transacciones_2">6.1. Transacciones</a>
<ul class="sectlevel3">
<li><a href="#_atomicidad">6.1.1. Atomicidad</a></li>
<li><a href="#_transacciones_jta">6.1.2. Transacciones JTA</a></li>
<li><a href="#_concurrencia_y_niveles_de_aislamiento">6.1.3. Concurrencia y niveles de aislamiento</a></li>
<li><a href="#_gesti%C3%B3n_concurrencia_con_jpa">6.1.4. Gestión concurrencia con JPA</a></li>
</ul>
</li>
<li><a href="#_jpa_en_aplicaciones_java_ee">6.2. JPA en aplicaciones Java EE</a>
<ul class="sectlevel3">
<li><a href="#_jpa_gestionado_por_el_contenedor">6.2.1. JPA gestionado por el contenedor</a></li>
<li><a href="#_configuraci%C3%B3n_de_la_fuente_de_datos_mysql_en_wildfly">6.2.2. Configuración de la fuente de datos MySQL en WildFly</a></li>
<li><a href="#_dependencias_maven_en_el_code_pom_xml_code">6.2.3. Dependencias Maven en el <code>pom.xml</code></a></li>
<li><a href="#_persistence_xml">6.2.4. Persistence.xml</a></li>
<li><a href="#_inyecci%C3%B3n_de_entity_managers_y_recursos_gestionados_por_el_contenedor">6.2.5. Inyección de entity managers y recursos gestionados por el contenedor</a></li>
</ul>
</li>
<li><a href="#_ejercicios_6">6.3. Ejercicios</a>
<ul class="sectlevel3">
<li><a href="#__0_5_puntos_ejercicios_sobre_transacciones">6.3.1. (0,5 puntos) Ejercicios sobre transacciones</a></li>
<li><a href="#__1_punto_aplicaci%C3%B3n_b%C3%A1sica_jpa_en_web">6.3.2. (1 punto) Aplicación básica JPA en web</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_primer_contacto_con_jpa">1. Primer contacto con JPA</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introducción_a_jpa">1.1. Introducción a JPA</h3>
<div class="paragraph">
<p>En la primera sesión del módulo de Java Persistence API (JPA) vamos a tratar una introducción a esta nueva tecnología Java que permite trabajar con entidades persistentes conectadas a una base de datos. Introduciremos los conceptos principales de JPA que iremos desarrollando en posteriores sesiones y proporcionaremos un ejemplo completo en el que describiremos la instalación básica de JPA en aplicaciones Java standalone (Java SE) usando Maven, IntelliJ IDEA como entorno de desarrollo y Hibernate como implementación de JPA. Veremos por último cómo realizar tests en los que intervienen el acceso a una base de datos usando DbUnit. Este ejemplo será la base de algunos ejercicios de la sesión.</p>
</div>
<div class="paragraph">
<p>Entre los conceptos principales que trataremos sobre JPA destacamos los siguientes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>uso de anotaciones para especificar propiedades</p>
</li>
<li>
<p>entidades persistentes y relaciones entre entidades</p>
</li>
<li>
<p>mapeado objeto-relacional</p>
</li>
<li>
<p>gestión de contextos de persistencia y de transacciones</p>
</li>
<li>
<p>diferencias entre JPA gestionado por la aplicación y gestionado por el contenedor</p>
</li>
<li>
<p>lenguaje de <em>queries</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Estudiaremos estos conceptos en profundidad a lo largo del módulo. En la sesión de hoy realizaremos una introducción basándonos en un ejemplo práctico.</p>
</div>
<div class="sect3">
<h4 id="_los_orígenes_de_jpa">1.1.1. Los orígenes de JPA</h4>
<div class="paragraph">
<p>JPA (Java Persistence API) tiene su origen en el framework Hibernate, un conjunto de librerías que implementan un mapeado ORM (Mapeado Objeto-Relacional) desarrollado por Gavin King y un grupo de colaboradores a finales de 2001. Al principio Hibernate no era parte del estándar Java soportado por Sun, sino que se desarrolló de forma independiente como un proyecto Java open source. Pronto ganó popularidad y aceptación. El grupo de desarrolladores fue contratado por JBoss, integrando el producto en el servidor de aplicaciones de la compañía. En la actualidad JBoss ha sido adquirido por RedHat, que ha incorporado el servidor de aplicaciones en algunas de sus distribuciones de Linux y Gavin King continua trabajando allí.</p>
</div>
<div class="paragraph">
<p>En paralelo al desarrollo y popularización de Hibernate, la especificación oficial de Java EE también intentó definir <em>entidades persistentes</em>. En concreto, se definieron los <em>entity beans</em>, un tipo de componentes EJB distribuidos gestionados por contenedores. Junto a ellos, Sun también apoyó la especificación de JDO (Java Data Objects), otro framework alternativo de gestión de entidades persistentes que no requiere el uso de contenedores EJB. Ninguno de los dos frameworks tuvo demasiado éxito. Los EJB de entidad siempre fueron denostados por ser muy poco eficientes y complejos de utilizar. JDO, por otra parte, tardó bastante en ser implementado de una forma robusta y sencilla de manejar.</p>
</div>
<div class="paragraph">
<p>En este contexto se creó en mayo de 2003 el grupo de trabajo que iba a definir la siguiente especificación de EJB (EJB 3.0). Sun propuso a Gavin King formar parte del grupo. Cuando llegó el momento de decidir el modelo de gestión de entidades persistentes se decidió apostar por la solución que ya había adoptado de hecho la comunidad: el enfoque basado en POJOs de Hibernate. Tras tres años de trabajo, en abril de 2006 se realizó la votación que apruebó la nueva especificación y ésta se incorporó a la especificación oficial de Java EE 5 con el nombre de JPA. En declaraciones de Gavin King, la especificación de JPA recoge el 95% de las funcionalidades de Hibernate. Desde entonces JPA como estándar e Hibernate como implementación han ido evolucionando de la mano en las posteriores especificaciones Java EE6 y Java EE 7.</p>
</div>
</div>
<div class="sect3">
<h4 id="_java_persistence_api">1.1.2. Java Persistence API</h4>
<div class="paragraph">
<p>Java Persistence API (JPA) es la tecnología estándar de Java para gestionar <em>entidades persistentes</em> que se incluye en Java EE desde la versión 5. La versión 1.0 de la especificación se concluyó en mayo de 2006, como parte de Java EE 5. La versión 2.0 fue lanzada en diciembre de 2009, junto con Java EE 6. La versión 2.1 fue lanzada en abril de 2013, junto con Java EE 7.</p>
</div>
<div class="paragraph">
<p>La descripción oficial de la última versión del estándar está definida en el <a href="https://jcp.org/en/jsr/detail?id=338">JSR 338</a> en el que se especifica la versión 2.1 de JPA. Como la mayoría de los documentos que especifican las JSR, es un documento bastante legible, muy bien estructurado, muy conciso y con bastante ejemplos. Además, por ser la especificación original, es completo. Cualquier característica de JPA debe estar reflejada en este documento. Aconsejamos, por tanto, tenerlo a mano, echearle un vistazo inicial (después de haber leído los apuntes de este módulo, por supuesto) y utilices como referencia ante dudas serias.</p>
</div>
<div class="paragraph">
<p>Es posible utilizar JPA no sólo como parte de aplicaciones Java EE que corren en un servidor de aplicaciones, sino también como una librería de acceso a datos en una aplicación Java aislada (<em>standalone</em>). Lo haremos así en esta primera sesión de la asignatura.</p>
</div>
<div class="paragraph">
<p>La idea de trabajar con entidades persistentes ha estado presente en la Programación Orientada a Objetos desde sus comienzos. Este enfoque intenta aplicar las ideas de la POO a las bases de datos, de forma que las clases y los objetos de una aplicación puedan ser almacenados, modificados y buscados de forma eficiente en unidades de persistencia. Sin embargo, aunque desde comienzos de los 80 hubo aplicaciones que implementaban bases de datos orientadas a objetos de forma nativa, la idea nunca terminó de cuajar. La tecnología dominante en lo referente a bases de datos siempre han sido los sistemas de gestión de bases de datos relacionales (RDBMS). De ahí que la solución propuesta por muchas tecnologías para conseguir entidades persistentes haya sido realizar un <em>mapeado</em> del modelo de objetos al modelo relacional. JPA es una de estas tecnologías. El motor de JPA realiza una transformación en tiempo de compilación de las clases Java a tablas de la base de datos y viceversa. El <em>framework</em> también debe realizar transformaciones en tiempo de ejecución, convirtiendo actualizaciones y consultas realizadas sobre clases y objetos en sentencias SQL que ejecuta sobre la base de datos.</p>
</div>
<div class="paragraph">
<p>Una de las características principales de JPA es su simplicidad. JPA utiliza anotaciones y <em>configuración por defecto</em>, de forma que el desarrollador sólo tiene que especificar aquellas características que necesita que sean distintas de las de por defecto. Por ejemplo, JPA mapea una clase Java con una tabla de la base de datos usando la anotación <code>@Entity</code>. Por defecto el nombre de la tabla coincidirá con el nombre de la clase. Ahora bien, podemos modificar ese nombre utilizando anotaciones adicionales. En este caso <code>table(name="nombre-de-tabla")</code>.</p>
</div>
<div class="paragraph">
<p>JPA permite realizar el mapeo entre el esquema de datos y las clases Java de dos formas. Una es partir de un esquema de datos ya existente y construir las clases Java a partir de él. La otra es hacerlo al revés, definir las relaciones entre las clases Java mediante anotaciones y generar el esquema de la base de datos a partir de ellas. Para un proyecto nuevo es recomendable utilizar este último enfoque, ya que el modelo de clases es más restrictivo que los esquemas SQL y si lo hacemos al revés podemos encontrar algunas relaciones en SQL difíciles de expresar con JPA.</p>
</div>
<div class="paragraph">
<p>Las distintas versiones de JPA han ido haciendo cada vez más potente esta tecnología. Por ejemplo, JPA 2.0 incluyó:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Extensión de las opciones del mapeo objeto-relacional</p>
</li>
<li>
<p>Soporte para colecciones de objetos embebidos</p>
</li>
<li>
<p>Listas ordenadas</p>
</li>
<li>
<p>Combinación de tipos de acceso</p>
</li>
<li>
<p>API Criteria para la construcción de consultas</p>
</li>
<li>
<p>Metadata adicional para la generación de DDL (<em>Data Definition Language</em>)</p>
</li>
<li>
<p>Soporte para validación</p>
</li>
<li>
<p>Soporte para cache de objetos compartidos</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Y la última especificación JPA 2.1 ha incluido:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Conversores que permiten customizar el código de conversión entre los tipos de las clases java y los de la base de datos</p>
</li>
<li>
<p>Actualizaciones y borrados en bloque mediante el API Criteria</p>
</li>
<li>
<p>Consultas que ejecutan procedimientos almacenados en la base de datos</p>
</li>
<li>
<p>Generación del esquema</p>
</li>
<li>
<p>Grafos de entidades que permiten la recuperación o la mezcla parcial de objetos en memoria</p>
</li>
<li>
<p>Mejoras en el lenguaje de consultas JPQL/Criteria: subconsultas aritméticas, funciones genéricas de base de datos, cláusula <code>Join ON</code></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_implementaciones_de_jpa">1.1.3. Implementaciones de JPA</h4>
<div class="paragraph">
<p>JPA es un estándar aprobado en un JSR que necesita ser implementado por desarrolladores o empresas. Al ser una especificación incluida en Java EE cualquier servidor de aplicaciones compatible con Java EE debe proporcionar una implementación de este estándar.</p>
</div>
<div class="paragraph">
<p>Sólo las implementaciones más avanzadas han implementado a fecha de hoy la última versión 2.1 de la especificación. Las implementaciones más populares son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://hibernate.org/orm/documentation/">Hibernate</a> (JPA 2.1, usado por JBoss/WildFly - RedHat)</p>
</li>
<li>
<p><a href="http://www.eclipse.org/eclipselink/releases/2.5.php">EclipseLink</a> (JPA 2.1, usado por GlassFish - Oracle)</p>
</li>
<li>
<p><a href="http://openjpa.apache.org">OpenJPA</a> (JPA 2.0)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Vamos a usar la implementación de Hibernate, que es la utilizada en el servidor de aplicaciones WildFly y JBoss de RedHat. La gran aceptación de Hibernate en la comunidad de desarrolladores Java se refleja en que en la actualidad hay muchas empresas que utilizan Hibernate como capa de persistencia y no han dado todavía el salto a JPA. Es previsible que lo hagan próximamente.</p>
</div>
</div>
<div class="sect3">
<h4 id="_para_saber_más">1.1.4. Para saber más</h4>
<div class="paragraph">
<p>Las siguientes referencias proporcionan un complemento en profundidad de los conceptos vistos en estos apuntes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://www.hibernate.org/docs">Documentación de Hibernate</a>: Documentación en profundidad de Hibernate y JPA que incluye la <a href="http://docs.jboss.org/hibernate/orm/4.3/manual/en-US/html/">documentación de la versión 4.3.7 Final</a> que es compatible con JPA 2.1.</p>
</li>
<li>
<p><a href="https://jcp.org/en/jsr/detail?id=338">Especificación JPA 2.1</a>. Documento que especifica el estándar JPA 2.1. Contiene bastante código de ejemplo y no es difícil de leer.</p>
</li>
<li>
<p><a href="http://www.manning.com/bauer3/">Java Persistence with Hibernate, second edition</a>: Christian Bauer y Gavin King. Ed. Manning, 2015. Libro de referencia de JPA (2.1), con numerosos ejemplos tanto del estándar como de la implementación de Hibernate.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ejemplo_práctico_una_sencilla_aplicación_jpa">1.2. Ejemplo práctico: una sencilla aplicación JPA</h3>
<div class="paragraph">
<p>Vamos a presentar un primer ejemplo de aplicación JPA, que nos va a servir para introducir los conceptos principales de la librería. El ejemplo es muy sencillo, unos programas Java (aplicaciones <em>standalone</em> Java SE) que gestionan <strong>mensajes</strong> creados por <strong>autores</strong>. En la siguiente sesión implementaremos una sencilla versión web y explicaremos cómo utilizar JPA en aplicaciones web Java EE.</p>
</div>
<div class="paragraph">
<p>Definimos dos entidades JPA, <code>Autor</code> y <code>Mensaje</code> que se deben mapear con dos tablas de la base de datos. Deberemos representar la relación uno-a-muchos entre autor y mensajes. Un autor va a estar relacionado con todos los mensajes que ha creado. Todos los mensajes tendrán obligatoriamente un autor. Las entidades tendrán la siguiente información:</p>
</div>
<div class="paragraph">
<p>La entidad <code>Autor</code> almacena información de los autores de los mensajes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Long id</code>: identificador del autor</p>
</li>
<li>
<p><code>String correo</code>: correo electrónico del autor, que funcionará también como identificador</p>
</li>
<li>
<p><code>String nombre</code>: nombre del autor</p>
</li>
<li>
<p><code>Set&lt;Mensaje&gt; mensajes</code>: conjunto de mensajes que ha creado el autor</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La entidad <code>Mensaje</code> almacena la siguiente información:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Long id</code>: identificador del mensaje</p>
</li>
<li>
<p><code>Integer num</code>: número de mensaje del autor</p>
</li>
<li>
<p><code>String texto</code>: texto del mensaje</p>
</li>
<li>
<p><code>Date fecha</code>: fecha de creación del mensaje</p>
</li>
<li>
<p><code>Autor autor</code>: autor del mensaje</p>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa01/clases.png" alt="Entidades" width="50%">
</div>
</div>
<div class="paragraph">
<p>Al definir esta relación en JPA se realizará automáticamente un mapeo de estas entidades en dos tablas en la base de datos: <code>Autores</code> y <code>Mensajes</code>:</p>
</div>
<div class="paragraph">
<p>La tabla <code>Autores</code> contiene las siguientes columnas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>autor_id bigint not null</code>: clave primaria de la tabla, autoincrementada</p>
</li>
<li>
<p><code>correo varchar(255) not null</code></p>
</li>
<li>
<p><code>nombre varchar(255)</code>: nombre</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La tabla <code>Mensajes</code> contiene las siguientes columnas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>mensaje_id bigint not null</code>: clave primaria de la tabla, autoincrementada</p>
</li>
<li>
<p><code>texto varchar(255) not null</code></p>
</li>
<li>
<p><code>fecha datetime</code></p>
</li>
<li>
<p><code>autor bigint not null</code>: autor del mensaje, clave ajena que apunta a la columna email de la tabla de autores</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La siguiente figura muestra gráficamente las clases Java (<em>entidades</em>) y las tablas asociadas:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa01/tablas.png" alt="Tablas" width="50%">
</div>
</div>
<div class="paragraph">
<p>A continuación vamos a crear paso a paso todos los elementos del proyecto. Definiremos también algunos programas ejemplo para ilustrar el funcionamiento de distintos usos de JPA: creación de entidades, modificación, borrado y consulta. Todo ello en el proyecto llamado <code>mensajes</code>.</p>
</div>
<div class="sect3">
<h4 id="_configuración_del_proyecto_maven">1.2.1. Configuración del proyecto Maven</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/note.png" alt="Note">
</td>
<td class="content">
Para entregar los ejercicios de la asignatura tienes que crear todos los proyectos en un único repositorio git que mantendrás sincronizado con Bitbucket. Para eso deberás hacer un <em>fork</em> del proyecto principal en el que se guardarán todos los <em>subproyectos</em> (módulos en la terminología de IntelliJ). En el apartado de ejercicios comentaremos paso a paso cómo hacerlo.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Este primer subproyecto (o módulo) lo crearemos con las siguientes coordenadas Maven:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>groupId: <code>org.expertojava.jpa</code></p>
</li>
<li>
<p>artifactId: <code>mensajes</code></p>
</li>
<li>
<p>packaging: <code>jar</code></p>
</li>
<li>
<p>name: <code>mensajes</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Las librerías necesarias para trabajar con Maven se pueden comprobar en el fichero POM del proyecto. Todas las versiones de todas las dependencias están actualizadas a la última versión disponible.</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tok-nt">&lt;project</span> <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://maven.apache.org/POM/4.0.0&quot;</span>
         <span class="tok-na">xmlns:xsi=</span><span class="tok-s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
         <span class="tok-na">xsi:schemaLocation=</span><span class="tok-s">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;modelVersion&gt;</span>4.0.0<span class="tok-nt">&lt;/modelVersion&gt;</span>

    <span class="tok-nt">&lt;groupId&gt;</span>org.expertojava.jpa<span class="tok-nt">&lt;/groupId&gt;</span>
    <span class="tok-nt">&lt;artifactId&gt;</span>mensajes<span class="tok-nt">&lt;/artifactId&gt;</span>
    <span class="tok-nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="tok-nt">&lt;/version&gt;</span>
    <span class="tok-nt">&lt;packaging&gt;</span>jar<span class="tok-nt">&lt;/packaging&gt;</span>

    <span class="tok-nt">&lt;name&gt;</span>mensajes<span class="tok-nt">&lt;/name&gt;</span>

    <span class="tok-nt">&lt;properties&gt;</span>
        <span class="tok-nt">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span class="tok-nt">&lt;/project.build.sourceEncoding&gt;</span>
    <span class="tok-nt">&lt;/properties&gt;</span>

    <span class="tok-nt">&lt;dependencies&gt;</span>

        <span class="tok-c">&lt;!-- Hibernate JPA --&gt;</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1">

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.hibernate.javax.persistence<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>hibernate-jpa-2.1-api<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>1.0.0.Final<span class="tok-nt">&lt;/version&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.hibernate<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>hibernate-entitymanager<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>4.3.7.Final<span class="tok-nt">&lt;/version&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-c">&lt;!-- DbUnit --&gt;</span>    <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/2.png" alt="2">

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.dbunit<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>dbunit<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>2.5.0<span class="tok-nt">&lt;/version&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-c">&lt;!-- Driver MySQL --&gt;</span>    <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/3.png" alt="3">

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>mysql<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>5.1.33<span class="tok-nt">&lt;/version&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-c">&lt;!-- Logging --&gt;</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/4.png" alt="4">

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.slf4j<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>slf4j-simple<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>1.7.12<span class="tok-nt">&lt;/version&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>log4j<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>log4j<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>1.2.17<span class="tok-nt">&lt;/version&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>commons-logging<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>commons-logging<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>1.2<span class="tok-nt">&lt;/version&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-c">&lt;!-- Hibernate validator --&gt;</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/5.png" alt="5">

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.hibernate<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>hibernate-validator<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>5.1.3.Final<span class="tok-nt">&lt;/version&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>
        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>javax.el<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>javax.el-api<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>2.2.4<span class="tok-nt">&lt;/version&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>
        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.glassfish.web<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>el-impl<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>2.2<span class="tok-nt">&lt;/version&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>
    <span class="tok-nt">&lt;/dependencies&gt;</span>
    <span class="tok-nt">&lt;/dependencies&gt;</span>

    <span class="tok-nt">&lt;build&gt;</span>
        <span class="tok-nt">&lt;finalName&gt;</span>${project.name}<span class="tok-nt">&lt;/finalName&gt;</span>
        <span class="tok-nt">&lt;plugins&gt;</span>
            <span class="tok-nt">&lt;plugin&gt;</span>
                <span class="tok-nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="tok-nt">&lt;/groupId&gt;</span>
                <span class="tok-nt">&lt;artifactId&gt;</span>maven-compiler-plugin<span class="tok-nt">&lt;/artifactId&gt;</span>
                <span class="tok-nt">&lt;version&gt;</span>3.1<span class="tok-nt">&lt;/version&gt;</span>
                <span class="tok-nt">&lt;configuration&gt;</span>
                    <span class="tok-nt">&lt;source&gt;</span>1.7<span class="tok-nt">&lt;/source&gt;</span>
                    <span class="tok-nt">&lt;target&gt;</span>1.7<span class="tok-nt">&lt;/target&gt;</span>
                <span class="tok-nt">&lt;/configuration&gt;</span>
            <span class="tok-nt">&lt;/plugin&gt;</span>
        <span class="tok-nt">&lt;/plugins&gt;</span>
    <span class="tok-nt">&lt;/build&gt;</span>

<span class="tok-nt">&lt;/project&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1"></td>
<td>Hibernate JPA: librerías para usar Hibernate como una implementación de JPA y librería de log <code>slf4j-api</code> necesaria para Hibernate.</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/2.png" alt="2"></td>
<td>DbUnit: librería <code>dbunit:2.5.0</code>, carga automáticamente la librería <code>junit:4.11</code> que necesita.</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/3.png" alt="3"></td>
<td><em>Driver</em> MySQL para acceder a la base de datos MySQL desde JPA y desde DbUnit.</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/4.png" alt="4"></td>
<td>Hibernate necesita el fichero de logging <code>slf4j-simple.jar</code>, sobre el que definimos una configuración de logging basada en log4j.</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/5.png" alt="5"></td>
<td>Hibernate validator implementa la validación <em>Bean Validation</em> de las clases entidad.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En la siguiente imagen se muestran todas las librerías que finalmente se descarga Maven. Son librerías necesarias para que las anteriores librerías puedan funcionar:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa01/proyecto-jpa-mensajes.png" alt="Librerías Maven" width="50%">
</div>
</div>
<div class="paragraph">
<p>En la pestaña <em>Dependency Hierarchy</em> del POM podemos explorar las relaciones entre las distintas librerías.</p>
</div>
</div>
<div class="sect3">
<h4 id="_configuración_de_la_conexión_a_la_bd_de_intellij">1.2.2. Configuración de la conexión a la BD de IntelliJ</h4>
<div class="paragraph">
<p>JPA puede trabajar con cualquier gestor de bases de datos. En nuestro caso, hemos instalado en la máquina virtual el servidor MySQL configurado con el usuario <code>root</code> y la contraseña <code>expertojava</code>.</p>
</div>
<div class="paragraph">
<p>IntelliJ tiene un conjunto de herramientas muy útiles para trabajar con bases de datos. Se accede a ellas desde el panel <em>Database</em> situado en el lateral derecho:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Abre el panel <em>Database</em> en la parte derecha.</p>
</li>
<li>
<p>Crea una nueva conexión con la base de datos MySQL con la opción <em>+ &gt; Data Source &gt; MySQL</em></p>
</li>
<li>
<p>Inicializa los parámetros de la conexión, sólo tienes que indicar el usuario <code>root</code> y la contraseña <code>expertojava</code>. Aparecerá también un aviso indicando que no está descargado el driver de acceso a MySQL, pincha el enlace y lo descargará e instalará.</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa01/intellij-datasources.png" alt="" width="100%">
</div>
</div>
<div class="paragraph">
<p>Una vez configurada la conexión, vamos a utilizarla para crear la base de datos <code>jpa_mensajes</code> que vamos a utilizar en las primeras aplicaciones ejemplo que vamos a programar con JPA. En el panel de base de datos podremos ver un desplegable con las bases de datos existentes. Para crear la nueva base de datos abre la consola SQL pulsando el icono correspondiente del panel de base de datos:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa01/panel-base-datos.png" alt="" width="50%">
</div>
</div>
<div class="paragraph">
<p>Y ejecuta el comando:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-k">CREATE</span> <span class="tok-k">DATABASE</span> <span class="tok-n">jpa_mensajes</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Verás que se ha creado una base de datos con ese nombre bajo las ya existentes por defecto en MySQL. Con esto es suficiente para que podamos empezar a trabajar con JPA.</p>
</div>
</li>
<li>
<p>Por último, para que aparezca la base de datos recién creada bajo el icono de la fuente de datos MySQL es necesario seleccionarla en la pantalla de propiedades. Pulsa en el botón de propiedades de la fuente de datos (o selecciona con el botón derecho la opcion <em>Properties</em>) y entrarás en la ventana de configuración de la fuente de datos. Selecciona la pestaña <em>Schemas &amp; Tables</em> y escoge la base de datos <code>jpa_mensajes</code>:</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa01/database-jpa-mensajes.png" alt="" width="50%">
</div>
</div>
<div class="paragraph">
<p>Ahora ya podrás ver la base de datos (por ahora sin ninguna tabla) bajo el icono de la conexión a la fuente de datos:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa01/database-jpa-mensajes-icono.png" alt="" width="33%">
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Otra forma de crear la base de datos es hacerlo desde línea de comando:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> <span class="tok-nb">echo</span> <span class="tok-s2">&quot;CREATE DATABASE jpa_mensajes&quot;</span> &gt; create.sql
<span class="tok-gp">$</span> mysql -u root -p<span class="tok-s2">&quot;expertojava&quot;</span> &lt; create.sql</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_clases_entidad">1.2.3. Clases entidad</h4>
<div class="paragraph">
<p>Las clases de entidad (<em>entity classes</em>) se codifican como clases Java con campos, <em>getters</em>, <em>setters</em> y con los métodos <code>equals</code> y <code>hashcode</code> basados en claves propias naturales a los que se añaden anotaciones JPA para especificar el mapeado con las tablas correspondientes de la base de datos. Vamos a ver un primer ejemplo con las clases <code>Autor</code> y <code>Mensaje</code> y la relación una-a-muchos definida entre ellos. En las sesiones siguientes entraremos más a fondo a explicar las distintas anotaciones.</p>
</div>
<div class="sect4">
<h5 id="_autor">Autor</h5>
<div class="paragraph">
<p>Veamos la primera clase, <code>Autor</code>, que contiene alguna información sobre los autores que escriben los mensajes.</p>
</div>
<div class="paragraph">
<p>Debemos etiquetar la clase con la anotación <code>@Entity</code> para indicarle a JPA que se debe mapear con una tabla. Todos los atributos de la entidad se mapearán automáticamente con columnas de la tabla SQL. En esos atributos podemos añadir otras anotaciones que permiten configurar las distintas características de las columnas SQL. Estas anotaciones se pueden definir sobre el atributo o sobre los métodos <em>getters</em>. Una forma curiosa de organizar la estructura de una clase entidad es la que utilizan en la documentación de <a href="http://docs.jboss.org/hibernate/orm/4.3/manual/en-US/html_single/#mapping-declaration">Hibernate</a>, en la que agrupan atributo, <em>getter</em> y <em>setter</em>.</p>
</div>
<div class="paragraph">
<p>Definimos la clase en la paquete <code>org.expertojava.jpa.mensajes.modelo</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/expertojava/jpa/mensajes/modelo/Autor.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jpa</span><span class="tok-o">.</span><span class="tok-na">mensajes</span><span class="tok-o">.</span><span class="tok-na">modelo</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.HashSet</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.Set</span><span class="tok-o">;</span>

<span class="tok-nd">@Entity</span>  <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1">
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Autor</span> <span class="tok-o">{</span>

    <span class="tok-nd">@Id</span>  <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/2.png" alt="2">
    <span class="tok-nd">@GeneratedValue</span>  <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/3.png" alt="3">
    <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s">&quot;autor_id&quot;</span><span class="tok-o">)</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/4.png" alt="4">
    <span class="tok-n">Long</span> <span class="tok-n">id</span><span class="tok-o">;</span>
    <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;email&quot;</span><span class="tok-o">,</span> <span class="tok-n">nullable</span> <span class="tok-o">=</span> <span class="tok-kc">false</span><span class="tok-o">,</span> <span class="tok-n">unique</span> <span class="tok-o">=</span> <span class="tok-kc">true</span><span class="tok-o">)</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/5.png" alt="5">
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">correo</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">;</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/6.png" alt="6">
    <span class="tok-nd">@OneToMany</span><span class="tok-o">(</span><span class="tok-n">mappedBy</span> <span class="tok-o">=</span> <span class="tok-s">&quot;autor&quot;</span><span class="tok-o">,</span> <span class="tok-n">cascade</span> <span class="tok-o">=</span> <span class="tok-n">CascadeType</span><span class="tok-o">.</span><span class="tok-na">ALL</span><span class="tok-o">,</span> <span class="tok-n">fetch</span> <span class="tok-o">=</span> <span class="tok-n">FetchType</span><span class="tok-o">.</span><span class="tok-na">EAGER</span><span class="tok-o">)</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/7.png" alt="7">
    <span class="tok-kd">private</span> <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Mensaje</span><span class="tok-o">&gt;</span> <span class="tok-n">mensajes</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">HashSet</span><span class="tok-o">&lt;</span><span class="tok-n">Mensaje</span><span class="tok-o">&gt;();</span>
    <span class="tok-nd">@Version</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/8.png" alt="8">
    <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">version</span><span class="tok-o">;</span>

    <span class="tok-kd">public</span> <span class="tok-n">Long</span> <span class="tok-nf">getId</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">id</span><span class="tok-o">;</span> <span class="tok-o">}</span>
    <span class="tok-kd">private</span> <span class="tok-kt">void</span> <span class="tok-nf">setId</span><span class="tok-o">(</span><span class="tok-n">Long</span> <span class="tok-n">id</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">id</span> <span class="tok-o">=</span> <span class="tok-n">id</span><span class="tok-o">;</span> <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getCorreo</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">correo</span><span class="tok-o">;</span> <span class="tok-o">}</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setCorreo</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">correo</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">correo</span> <span class="tok-o">=</span> <span class="tok-n">correo</span><span class="tok-o">;</span> <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getNombre</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">nombre</span><span class="tok-o">;</span> <span class="tok-o">}</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setNombre</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">nombre</span> <span class="tok-o">=</span> <span class="tok-n">nombre</span><span class="tok-o">;</span> <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Mensaje</span><span class="tok-o">&gt;</span> <span class="tok-nf">getMensajes</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">mensajes</span><span class="tok-o">;</span> <span class="tok-o">}</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setMensajes</span><span class="tok-o">(</span><span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Mensaje</span><span class="tok-o">&gt;</span> <span class="tok-n">mensajes</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">mensajes</span> <span class="tok-o">=</span> <span class="tok-n">mensajes</span><span class="tok-o">;</span> <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-nf">Autor</span><span class="tok-o">()</span> <span class="tok-o">{</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/9.png" alt="9">
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-nf">Autor</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">,</span> <span class="tok-n">String</span> <span class="tok-n">correo</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">nombre</span> <span class="tok-o">=</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">correo</span> <span class="tok-o">=</span> <span class="tok-n">correo</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-kt">boolean</span> <span class="tok-nf">equals</span><span class="tok-o">(</span><span class="tok-n">Object</span> <span class="tok-n">o</span><span class="tok-o">)</span> <span class="tok-o">{</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/10.png" alt="10">
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-k">this</span> <span class="tok-o">==</span> <span class="tok-n">o</span><span class="tok-o">)</span> <span class="tok-k">return</span> <span class="tok-kc">true</span><span class="tok-o">;</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">o</span> <span class="tok-o">==</span> <span class="tok-kc">null</span> <span class="tok-o">||</span> <span class="tok-n">getClass</span><span class="tok-o">()</span> <span class="tok-o">!=</span> <span class="tok-n">o</span><span class="tok-o">.</span><span class="tok-na">getClass</span><span class="tok-o">())</span> <span class="tok-k">return</span> <span class="tok-kc">false</span><span class="tok-o">;</span>

        <span class="tok-n">Autor</span> <span class="tok-n">autor</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-n">Autor</span><span class="tok-o">)</span> <span class="tok-n">o</span><span class="tok-o">;</span>

        <span class="tok-k">return</span> <span class="tok-o">!(</span><span class="tok-n">id</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span> <span class="tok-o">?</span> <span class="tok-o">!</span><span class="tok-n">id</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">id</span><span class="tok-o">)</span> <span class="tok-o">:</span> <span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">id</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">);</span>

    <span class="tok-o">}</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-kt">int</span> <span class="tok-nf">hashCode</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">id</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span> <span class="tok-o">?</span> <span class="tok-n">id</span><span class="tok-o">.</span><span class="tok-na">hashCode</span><span class="tok-o">()</span> <span class="tok-o">:</span> <span class="tok-mi">0</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">toString</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-s">&quot;Autor{&quot;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;id=&quot;</span> <span class="tok-o">+</span> <span class="tok-n">id</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, correo=&#39;&quot;</span> <span class="tok-o">+</span> <span class="tok-n">correo</span> <span class="tok-o">+</span> <span class="tok-sc">&#39;\&#39;&#39;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, nombre=&#39;&quot;</span> <span class="tok-o">+</span> <span class="tok-n">nombre</span> <span class="tok-o">+</span> <span class="tok-sc">&#39;\&#39;&#39;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, mensajes=&quot;</span> <span class="tok-o">+</span> <span class="tok-n">mensajes</span> <span class="tok-o">+</span>
                <span class="tok-sc">&#39;}&#39;</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1"></td>
<td><code>@Entity</code>: La clase es una entidad que se va a mapear con una tabla de la base de datos. Los campos de la clase se mapearán con columnas de la base de datos. Por defecto el nombre de la tabla será el nombre de la clase Java. Se puede modificar usando la anotación <code>@Table</code>.</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/2.png" alt="2"></td>
<td><code>@Id</code>: indica que el campo anotado (en nuestro caso <code>Long id</code>) va a ser el identificador de la entidad. La columna con la que se mapea en la base de datos es la clave primaria de la tabla.</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/3.png" alt="3"></td>
<td><code>@GeneratedValue</code>: El identificador se genera automáticamente por parte de la base de datos cuando la entidad se hace persistente.</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/4.png" alt="4"></td>
<td><code>@Column</code>: Sirve para indicar características del esquema de la columna en la que se mapea el campo. El elemento <code>name</code> sirve para indicar el nombre de la columna en el mapeo. Si no estuviera, con un una columna con el nombre del atributo de la clase Java.</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/5.png" alt="5"></td>
<td>En este caso, obligamos a que no la columna no sea <code>null</code>. Veremos que la columna <code>correo</code> de la tabla tendrá el modificador <code>NOT NULL</code>.</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/6.png" alt="6"></td>
<td>Todos los atributos se mapean con campos de la tabla. En el caso de no utilizar la anotación <code>@Column</code> se mapea con un campo con el mismo nombre que el atributo.</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/7.png" alt="7"></td>
<td><code>@OneToMany</code>: Sirve para definir una relación uno-a-muchos entre <code>Autor</code> y <code>Mensaje</code>. La anotación <code>cascade</code> indica que las acciones de borrado, <em>persist</em> y <em>merge</em> se propagan en cascada a los mensajes. La anotación <code>@mappedBy</code> indica el atributo que define la clave ajena en el otro lado de la relación. Y la anotación <code>EAGER</code> indica que traeremos a memoria todos los mensajes con los que está relacionado el autor. Los veremos más adelante.</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/8.png" alt="8"></td>
<td><code>@Version</code>: Un atributo versión que usa JPA para implementar la gestión optimista de la concurrencia. Lo veremos en la última sesión.</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/9.png" alt="9"></td>
<td>Constructor vacío, necesario para JPA.</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/10.png" alt="10"></td>
<td>Métodos <code>equals</code> y <code>hashCode</code> basados en el identificador autogenerado.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Vemos que se trata de una clase normal Java con cuatro campos (<code>id</code>, <code>correo</code>, <code>nombre</code> y <code>mensajes</code>) y los métodos <em>get</em> y <em>set</em>. JPA mapea esta clase en una tabla de la base de datos utilizando las anotaciones comentadas anteriormente.</p>
</div>
<div class="paragraph">
<p>La implementación de Hibernate obliga a definir una pareja de métodos <code>get</code> y <code>set</code> para cada atributo. En el caso de la clave primaria, al ser generada automáticamente por la base de datos, definimos el método <code>set</code> como privado para que no pueda ser actualizado desde fuera de la clase. Los métodos <code>get</code> sirven para recuperar la información de un atributo de un objeto. Los métodos <code>set</code> sirven para actualizarlo. Cuando JPA sincronice el estado del objeto con la base de datos escribirá en ella los cambios realizados.</p>
</div>
<div class="paragraph">
<p>Hibernate obliga también a definir un constructor vacío en todas las entidades. Si no lo hacemos muestra un mensaje de error.</p>
</div>
<div class="paragraph">
<p>Además es necesario definir los métodos <code>equals</code> y <code>hashCode</code>, a parte del conveniente <code>toString</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_mensaje">Mensaje</h5>
<div class="paragraph">
<p>Veamos ahora la otra clase, <code>Mensaje</code>, con la información de los mensajes que crean los usuarios (identificador del mensaje, texto, fecha y usuario propietario del mensaje).</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/expertojava/jpa/mensajes/modelo/Autor.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jpa</span><span class="tok-o">.</span><span class="tok-na">mensajes</span><span class="tok-o">.</span><span class="tok-na">modelo</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.Date</span><span class="tok-o">;</span>

<span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Mensaje</span> <span class="tok-o">{</span>

    <span class="tok-nd">@Id</span>
    <span class="tok-nd">@GeneratedValue</span>
    <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s">&quot;mensaje_id&quot;</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">Long</span> <span class="tok-n">id</span><span class="tok-o">;</span>

    <span class="tok-nd">@NotNull</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1">
    <span class="tok-nd">@Size</span><span class="tok-o">(</span><span class="tok-n">min</span><span class="tok-o">=</span><span class="tok-mi">3</span><span class="tok-o">)</span>
    <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">nullable</span> <span class="tok-o">=</span> <span class="tok-kc">false</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">texto</span><span class="tok-o">;</span>

    <span class="tok-kd">private</span> <span class="tok-n">Date</span> <span class="tok-n">fecha</span><span class="tok-o">;</span>

    <span class="tok-nd">@ManyToOne</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/2.png" alt="2">
    <span class="tok-kd">private</span> <span class="tok-n">Autor</span> <span class="tok-n">autor</span><span class="tok-o">;</span>

    <span class="tok-nd">@Version</span>
    <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">version</span><span class="tok-o">;</span>

    <span class="tok-kd">public</span> <span class="tok-n">Long</span> <span class="tok-nf">getId</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">id</span><span class="tok-o">;</span> <span class="tok-o">}</span>
    <span class="tok-kd">private</span> <span class="tok-kt">void</span> <span class="tok-nf">setId</span><span class="tok-o">(</span><span class="tok-n">Long</span> <span class="tok-n">id</span><span class="tok-o">)</span> <span class="tok-o">{</span><span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">id</span> <span class="tok-o">=</span> <span class="tok-n">id</span><span class="tok-o">;}</span>

    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getTexto</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">texto</span><span class="tok-o">;</span> <span class="tok-o">}</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setTexto</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">texto</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">texto</span> <span class="tok-o">=</span> <span class="tok-n">texto</span><span class="tok-o">;</span> <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">Date</span> <span class="tok-nf">getFecha</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">fecha</span><span class="tok-o">;</span> <span class="tok-o">}</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setFecha</span><span class="tok-o">(</span><span class="tok-n">Date</span> <span class="tok-n">fecha</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">fecha</span> <span class="tok-o">=</span> <span class="tok-n">fecha</span><span class="tok-o">;</span> <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">Autor</span> <span class="tok-nf">getAutor</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">autor</span><span class="tok-o">;</span> <span class="tok-o">}</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setAutor</span><span class="tok-o">(</span><span class="tok-n">Autor</span> <span class="tok-n">autor</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">autor</span> <span class="tok-o">=</span> <span class="tok-n">autor</span><span class="tok-o">;</span> <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-nf">Mensaje</span><span class="tok-o">()</span> <span class="tok-o">{}</span>

    <span class="tok-kd">public</span> <span class="tok-nf">Mensaje</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">texto</span><span class="tok-o">,</span> <span class="tok-n">Autor</span> <span class="tok-n">autor</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">texto</span> <span class="tok-o">=</span> <span class="tok-n">texto</span><span class="tok-o">;</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">autor</span> <span class="tok-o">=</span> <span class="tok-n">autor</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>


    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">toString</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-s">&quot;Mensaje{&quot;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;id=&quot;</span> <span class="tok-o">+</span> <span class="tok-n">id</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, texto=&#39;&quot;</span> <span class="tok-o">+</span> <span class="tok-n">texto</span> <span class="tok-o">+</span> <span class="tok-sc">&#39;\&#39;&#39;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, fecha=&quot;</span> <span class="tok-o">+</span> <span class="tok-n">fecha</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, autor=&quot;</span> <span class="tok-o">+</span> <span class="tok-n">autor</span> <span class="tok-o">+</span>
                <span class="tok-sc">&#39;}&#39;</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1"></td>
<td><code>@NotNull</code> y <code>@Size</code> son dos anotaciones de <em>Bean Validation</em> que definen restricciones en el contenido del atributo. Ambas restricciones son mantenidas por JPA, lanzando excepciones si se produce una creación o actualización de una entidad que no las cumple.</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/2.png" alt="2"></td>
<td><code>@ManyToOne</code>: Relación inversa que etiqueta un atributo de tipo <code>Autor</code>. El atributo se mapea en una columna de la tabla <code>Mensaje</code> en la que se guarda la clave ajena al autor asociado.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El fichero <code>Mensaje.java</code> define la clase entidad <code>Mensaje</code>. La entidad tiene los atributos <code>id</code> (identificador único del mensaje), <code>texto</code> (el texto del mensaje) y <code>autor</code> (el autor del mensaje, una instancia entidad de tipo <code>Autor</code> con la que se define la relación inversa a la definida en autor).</p>
</div>
<div class="paragraph">
<p>En el ejemplo estamos definiendo una relación uno a muchos entre autor y mensajes. Estas relaciones se definen en JPA definiendo campos del tipo de la otra entidad y anotándolos según el tipo de relación (uno-a-uno, uno-a-muchos o muchos-a-muchos). En nuestro ejemplo relacionamos un mensaje con el autor que lo ha escrito y el autor con todos sus mensajes. La definición de estas relaciones facilita mucho la programación porque evita la realización explícita de muchas consultas SQL. Por ejemplo, si en una consulta recuperamos una colección de mensajes, JPA recuperará al mismo tiempo el autor asociado y lo guardará en el campo <code>autor</code>. De esta forma podremos utilizarlo inmediatamente sin tener que realizar ninguna consulta adicional. Veremos un ejemplo.</p>
</div>
<div class="paragraph">
<p>La cardinalidad de la relación la definimos con la anotación <code>OneToMany</code> en el campo <code>mensajes</code> de <code>Autor</code> (un autor tiene una colección de mensajes) y su relación inversa <code>ManyToOne</code> en el campo <code>autor</code> de <code>Mensaje</code> (muchos mensajes pueden tener el mismo autor). Estas anotaciones sirven para realizar el mapeo de la relación a las tablas. En este caso se crea una clave ajena en la tabla de mensajes que apunta al autor de cada mensaje. Esto lo indicamos con la anotación <code>mappedBy</code> en el campo <code>mensajes</code> de la clase <code>Autor</code>. Si nos fijamos en el esquema SQL de la tabla de autores veremos que no hay ninguna columna mensajes en ella. La colección con los mensajes de un autor dado la construye JPA con una consulta SQL sobre la tabla de mensajes y utilizando la clave ajena definida por la anotación <code>mappedBy</code> (en este caso el campo <code>autor</code>).</p>
</div>
<div class="paragraph">
<p>La anotación <code>@ManyToOne</code> se coloca en el campo <code>autor</code> que contiene la relación inversa y que hace de clave ajena a la tabla de autores. En el mapeo con la base de datos, se el nombre de la columna asociada al campo se forma con el nombre del campo actual y el nombre de la columna referenciada (<code>autor_id</code>, la clave primaria de la tabla <code>Autor</code>). En este caso el nombre del campo es <code>autor_autor_id</code>.</p>
</div>
<div class="paragraph">
<p>En la clase <code>Mensaje</code> utilizamos la anotación <code>@ManyToOne</code> en el campo <code>autor</code>, indicando que muchos mensajes pueden pertenecer al mismo autor.</p>
</div>
<div class="paragraph">
<p>Veremos que para actualizar una relación uno a muchos como esta y añadir un mensaje a un autor hay que actualizar el atributo de la entidad que se mapea con al tabla que contiene la clave ajena. En este caso se trata de la entidad <code>Mensaje</code>, cuyo campo <code>autor</code> se mapea con la columna de la clave ajena de la tabla. Al crear un nuevo mensaje y hacerlo persistente ya estamos añadiendo un elemento nuevo a la relación y las consultas que se realicen sobre los mensajes de un autor devolverán el nuevo mensaje. Veremos que es necesario también actualizar en memoria la colección de mensajes del autor (JPA no lo hace automáticamente), para mantener consistente las relaciones entre entidades en memoria con la base de datos.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_el_fichero_persistence_xml_y_la_base_de_datos">1.2.4. El fichero persistence.xml y la base de datos</h4>
<div class="paragraph">
<p>El fichero <code>persistence.xml</code> es el fichero de configuración de JPA. En él se define, en un elemento denominado <code>persistence-unit</code> (unidad de persistencia), las clases de entidad que JPA debe mapear en la base de datos. En nuestro caso se trata de las clases <code>org.expertojava.jpa.mensajes.modelo.Autor</code> y <code>org.expertojava.jpa.mensajes.modelo.Mensaje</code>. También se especifica la conexión con la base de datos: el driver SQL que se utiliza, la URL, el gestor de base de datos (MySQL), así como el usuario y contraseña de acceso.</p>
</div>
<div class="paragraph">
<p>Este fichero de configuración debe encontrarse en el directorio <code>META-INF</code> dentro del <em>classpath</em> de la aplicación que se ejecuta. En nuestro caso, como estamos trabajando con una configuración de directorios definida por Maven, utilizaremos el directorio <code>recursos</code> de las clases de aplicación. Podríamos definir una configuración de test diferente añadiendo otro <code>persistence.xml</code> en el directorio de recursos de las clases de test.</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/persistence.xml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;persistence</span> <span class="tok-na">version=</span><span class="tok-s">&quot;2.1&quot;</span>
             <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://xmlns.jcp.org/xml/ns/persistence&quot;</span>
             <span class="tok-na">xmlns:xsi=</span><span class="tok-s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
             <span class="tok-na">xsi:schemaLocation=</span><span class="tok-s">&quot;http://xmlns.jcp.org/xml/ns/persistence&quot;</span><span class="tok-nt">&gt;</span>

    <span class="tok-nt">&lt;persistence-unit</span> <span class="tok-na">name=</span><span class="tok-s">&quot;mensajes-mysql&quot;</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1">
    		      <span class="tok-na">transaction-type=</span><span class="tok-s">&quot;RESOURCE_LOCAL&quot;</span><span class="tok-nt">&gt;</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/2.png" alt="2">

        <span class="tok-nt">&lt;provider&gt;</span>org.hibernate.jpa.HibernatePersistenceProvider<span class="tok-nt">&lt;/provider&gt;</span>
        <span class="tok-nt">&lt;class&gt;</span>org.expertojava.jpa.mensajes.modelo.Autor<span class="tok-nt">&lt;/class&gt;</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/3.png" alt="3">
        <span class="tok-nt">&lt;class&gt;</span>org.expertojava.jpa.mensajes.modelo.Mensaje<span class="tok-nt">&lt;/class&gt;</span>

        <span class="tok-nt">&lt;validation-mode&gt;</span>CALLBACK<span class="tok-nt">&lt;/validation-mode&gt;</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/4.png" alt="4">

        <span class="tok-nt">&lt;properties&gt;</span>

            <span class="tok-c">&lt;!-- JPA properties --&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;javax.persistence.jdbc.driver&quot;</span>
                      <span class="tok-na">value=</span><span class="tok-s">&quot;com.mysql.jdbc.Driver&quot;</span><span class="tok-nt">/&gt;</span>  <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/5.png" alt="5">
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;javax.persistence.jdbc.url&quot;</span>
                      <span class="tok-na">value=</span><span class="tok-s">&quot;jdbc:mysql://localhost:3306/jpa_mensajes&quot;</span><span class="tok-nt">/&gt;</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/6.png" alt="6">
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;javax.persistence.jdbc.user&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;root&quot;</span><span class="tok-nt">/&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;javax.persistence.jdbc.password&quot;</span>
                      <span class="tok-na">value=</span><span class="tok-s">&quot;expertojava&quot;</span><span class="tok-nt">/&gt;</span>

            <span class="tok-c">&lt;!-- Hibernate properties --&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.dialect&quot;</span>
                      <span class="tok-na">value=</span><span class="tok-s">&quot;org.hibernate.dialect.MySQLDialect&quot;</span><span class="tok-nt">/&gt;</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/7.png" alt="7">
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.show_sql&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;true&quot;</span><span class="tok-nt">/&gt;</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/8.png" alt="8">
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.format_sql&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;false&quot;</span><span class="tok-nt">/&gt;</span>

            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.hbm2ddl.auto&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;update&quot;</span><span class="tok-nt">/&gt;</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/9.png" alt="9">
        <span class="tok-nt">&lt;/properties&gt;</span>
    <span class="tok-nt">&lt;/persistence-unit&gt;</span>
<span class="tok-nt">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1"></td>
<td>Nombre de la unidad de persistencia, necesario para cargarla desde la aplicación.</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/2.png" alt="2"></td>
<td>Estrategia de gestión de la transacción. En este caso <code>RESOURCE_LOCAL</code> que indica que utilizaremos la gestión de transacciones de la propia base de datos (lo veremos más adelante: por defecto en JPA el <code>AUTOCOMMIT</code> se define como <code>false</code> y hay que gestionar las transacciones de forma explícita).</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/3.png" alt="3"></td>
<td>Clases que van a hacerse persistentes en forma de tablas.</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/4.png" alt="4"></td>
<td>En el modo <code>CALLBACK</code> debe estar presente un proveedor de persistencia que realice la validación de las restricciones <em>Bean Validation</em>. Si no, se genera un error. Otros modos son: <code>AUTO</code> (se realiza la validación si el proveedor de persistencia tiene esa capacidad) o <code>NONE</code> (no se realiza validación). El proveedor de persistencia que estamos usando, Hibernate, sí que implementa la validación.</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/5.png" alt="5"></td>
<td>Clase Java que define el conector con la BD,  el conector JDBC <code>com.mysql.jdbc.Driver</code>.</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/6.png" alt="6"></td>
<td>URL de la conexión a la BD y base de datos a la que conectarnos, en nuestro caso la base de datos creada anteriormente <code>jpa_mensajes</code> a la que se accede con la conexión <code>jdbc:mysql://localhost:3306/jpa_mensajes</code>. A continuación se especifican el usuario y contraseña para la conexión.</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/7.png" alt="7"></td>
<td>Dialecto SQL, necesario para optimizar las sentencias SQL con las que Hibernate gestiona los datos.</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/8.png" alt="8"></td>
<td>Parámetro que activa o desactiva el <em>logeo</em> de las sentencias SQL que va realizando Hibernate.</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/9.png" alt="9"></td>
<td>Parámetro que indica la forma de actualizar las tablas cuando se pone en marcha JPA. Se explica a continuación.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El parámetro <code>hibernate.hbm2ddl.auto</code> es muy importante. Determina cómo se van a actualizar las tablas de la base de datos cuando Hibernate intente mapearlas con las clases Java. Los posibles valores son los siguientes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>update</code>: se actualiza el esquema de las tablas si ha habido algún cambio en las clases Java. Si no existen, se crean.</p>
</li>
<li>
<p><code>validate</code>: se valida que el esquema se puede mapear correctamente con las clases Java. No se cambia nada de la base de datos.</p>
</li>
<li>
<p><code>create</code>: se crea el esquema, destruyendo los datos previos.</p>
</li>
<li>
<p><code>create-drop</code>: se crea el esquema y se elimina al final de la sesión.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/note.png" alt="Note">
</td>
<td class="content">
Es aconsejable utilizar el valor <code>create</code> en entornos de test, <code>update</code> en desarrollo y el <code>validate</code> en producción. Inicialmente, antes de ejecutar el primer programa, lo vamos a definir como <code>update</code> para probar a crear las tablas y comprobar cuál es el esquema de datos generado.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_generación_del_esquema_de_datos_con_intellij">Generación del esquema de datos con IntelliJ</h5>
<div class="paragraph">
<p>Para probar el mapeo de las clases entidad con las tablas de la base de datos podemos ejecutar un sencillo programa Java que cargue la unidad de persistencia. Como el parámetro <code>hibernate.hbm2ddl.auto</code> está en modo <code>update</code> si la base de datos está vacía, creará todas las tablas definidas, en este caso <code>Autor</code> y <code>Mensajes</code>.</p>
</div>
<div class="paragraph">
<p>Para eso vamos a hacer un pequeño test. En <code>src/test/java/</code> podemos crear la clase <code>org.expertojava.jpa.mensajes.TestEmf</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/org/expertojava/jpa/mensajes/TestEmf.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jpa</span><span class="tok-o">.</span><span class="tok-na">mensajes</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.junit.Test</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManager</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManagerFactory</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.Persistence</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">junit</span><span class="tok-o">.</span><span class="tok-na">Assert</span><span class="tok-o">.*;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">TestEmf</span> <span class="tok-o">{</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">createEntityManagerTest</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">EntityManagerFactory</span> <span class="tok-n">emf</span> <span class="tok-o">=</span>
                <span class="tok-n">Persistence</span><span class="tok-o">.</span><span class="tok-na">createEntityManagerFactory</span><span class="tok-o">(</span><span class="tok-s">&quot;mensajes-mysql&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">assertNotNull</span><span class="tok-o">(</span><span class="tok-n">em</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El test pasa correctamente y en el método <code>createEntityManagerFactory</code> se crean en la base de datos las tablas definidas en la unidad de persistencia. Podemos comprobarlo en el panel <em>Database</em>, refrescando la fuente de datos y desplegando el menú de la base de datos <code>jpa_mensajes</code>:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa01/tablas-base-datos.png" alt="" width="33%">
</div>
</div>
<div class="paragraph">
<p>Podemos generar el esquema de datos desde el panel <em>Database</em> de IntelliJ. Hay que pulsar el botón derecho sobre la base de datos y seleccionar la opción <em>Copy DDL</em> para copiar el esquema de datos al portapapeles. En nuestro caso es el siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-k">CREATE</span> <span class="tok-k">TABLE</span> <span class="tok-n">Autor</span>
<span class="tok-p">(</span>
    <span class="tok-n">autor_id</span> <span class="tok-nb">BIGINT</span> <span class="tok-k">PRIMARY</span> <span class="tok-k">KEY</span> <span class="tok-k">NOT</span> <span class="tok-k">NULL</span> <span class="tok-n">AUTO_INCREMENT</span><span class="tok-p">,</span>
    <span class="tok-n">email</span> <span class="tok-nb">VARCHAR</span><span class="tok-p">(</span><span class="tok-mi">255</span><span class="tok-p">)</span> <span class="tok-k">NOT</span> <span class="tok-k">NULL</span><span class="tok-p">,</span>
    <span class="tok-n">nombre</span> <span class="tok-nb">VARCHAR</span><span class="tok-p">(</span><span class="tok-mi">255</span><span class="tok-p">),</span>
    <span class="tok-k">version</span> <span class="tok-nb">INT</span> <span class="tok-k">NOT</span> <span class="tok-k">NULL</span>
<span class="tok-p">);</span>
<span class="tok-k">CREATE</span> <span class="tok-k">TABLE</span> <span class="tok-n">Mensaje</span>
<span class="tok-p">(</span>
    <span class="tok-n">mensaje_id</span> <span class="tok-nb">BIGINT</span> <span class="tok-k">PRIMARY</span> <span class="tok-k">KEY</span> <span class="tok-k">NOT</span> <span class="tok-k">NULL</span> <span class="tok-n">AUTO_INCREMENT</span><span class="tok-p">,</span>
    <span class="tok-n">fecha</span> <span class="tok-n">DATETIME</span><span class="tok-p">,</span>
    <span class="tok-n">texto</span> <span class="tok-nb">VARCHAR</span><span class="tok-p">(</span><span class="tok-mi">255</span><span class="tok-p">)</span> <span class="tok-k">NOT</span> <span class="tok-k">NULL</span><span class="tok-p">,</span>
    <span class="tok-k">version</span> <span class="tok-nb">INT</span> <span class="tok-k">NOT</span> <span class="tok-k">NULL</span><span class="tok-p">,</span>
    <span class="tok-n">autor</span> <span class="tok-nb">BIGINT</span> <span class="tok-k">NOT</span> <span class="tok-k">NULL</span>
<span class="tok-p">);</span>
<span class="tok-k">CREATE</span> <span class="tok-k">UNIQUE</span> <span class="tok-k">INDEX</span> <span class="tok-n">UK_b9rqydwsclpsfivfgus4rq227</span> <span class="tok-k">ON</span> <span class="tok-n">Autor</span> <span class="tok-p">(</span><span class="tok-n">email</span><span class="tok-p">);</span>
<span class="tok-k">ALTER</span> <span class="tok-k">TABLE</span> <span class="tok-n">Mensaje</span> <span class="tok-k">ADD</span> <span class="tok-k">FOREIGN</span> <span class="tok-k">KEY</span> <span class="tok-p">(</span><span class="tok-n">autor</span><span class="tok-p">)</span> <span class="tok-k">REFERENCES</span> <span class="tok-n">Autor</span> <span class="tok-p">(</span><span class="tok-n">autor_id</span><span class="tok-p">);</span>
<span class="tok-k">CREATE</span> <span class="tok-k">INDEX</span> <span class="tok-n">FK_1n8x4ku41yquct34o1yjs5ud0</span> <span class="tok-k">ON</span> <span class="tok-n">Mensaje</span> <span class="tok-p">(</span><span class="tok-n">autor</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por último, para evitar mensajes de error de IntelliJ, debemos asegurarnos de actualizar la <em>faceta</em> JPA y de asociarle la fuente de datos recién creada:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Seleccionamos <em>Project Structure</em> y nos aseguramos de que la faceta JPA está configurada en el módulo que estamos usando y que está correctamente definida la ruta del fichero <code>persistence.xml</code>:</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa01/jpa-facet.png" alt="" width="100%">
</div>
</div>
</li>
<li>
<p>Y asociamos la fuente de datos recién creada a la configuración de JPA, usando el panel <code>persistence</code>, seleccionando el módulo y la opción <em>Assign Data Sources&#8230;&#8203;</em>:</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa01/panel-persistencia.png" alt="" width="66%">
</div>
</div>
<div class="paragraph">
<p>Y añadimos después la fuente de datos recién creada a la unidad de persistencia <code>mensajes-mysql</code>:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa01/assign-data-sources.png" alt="" width="50%">
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ficheros_de_configuración_de_logging">1.2.5. Ficheros de configuración de logging</h4>
<div class="paragraph">
<p>Los siguientes ficheros definen la configuración del log. Definen como librería de logging <code>Log4JLogger</code> y configuran los logs para que se muestren los niveles de log <code>INFO</code> en adelante (se pueden cambiar a <code>ERROR</code> o <code>DEBUG</code> si se quiere menos o más mensajes).</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/commons-logging.properties</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="properties"><span class="tok-na">org.apache.commons.logging.Log</span><span class="tok-o">=</span><span class="tok-s">org.apache.commons.logging.impl.Log4JLogger</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/resources/log4j.properties</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="properties"><span class="tok-c"># Coloca el nivel root del logger en INFO (muestra mensajes de INFO hacia arriba)</span>
<span class="tok-na">log4j.rootLogger</span><span class="tok-o">=</span><span class="tok-s">INFO, A1</span>

<span class="tok-c"># A1 se redirige a la consola</span>
<span class="tok-na">log4j.appender.A1</span><span class="tok-o">=</span><span class="tok-s">org.apache.log4j.ConsoleAppender</span>
<span class="tok-na">log4j.appender.stdout.Target</span><span class="tok-o">=</span><span class="tok-s">System.out</span>
<span class="tok-na">log4j.appender.A1.layout</span><span class="tok-o">=</span><span class="tok-s">org.apache.log4j.PatternLayout</span>
<span class="tok-na">log4j.appender.A1.layout.ConversionPattern</span><span class="tok-o">=</span><span class="tok-s">%d{dd/MM/yyyy HH:mm:ss} - %p - %m %n</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_programas_java_em_standalone_em_que_trabajan_con_jpa">1.2.6. Programas Java <em>standalone</em> que trabajan con JPA</h4>
<div class="paragraph">
<p>Vamos a ver cuatro ejemplos de programas Java <em>standalone</em> que muestran el funcionamiento básico de una aplicación JPA:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Programa <code>NuevoAutorMensaje</code>: programa que pide por la consola un nuevo autor y un nuevo mensaje y que crea esos nuevo registros en la bD</p>
</li>
<li>
<p>Programa <code>NuevoMensaje</code>: programa que pide por la consola un identificador de autor ya creado y un nuevo mensaje, y añade el mensaje al autor</p>
</li>
<li>
<p>Programa <code>MensajesAutor</code>: programa que lista todos los mensajes de un autor</p>
</li>
<li>
<p>Programa <code>BuscaMensajes</code>: programa que realiza una consulta buscando aquellos mensajes que contienen una cadena que se introduce por la consola</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_programa_nuevoautormensaje">Programa NuevoAutorMensaje</h5>
<div class="paragraph">
<p>Veamos el primer ejemplo de programa Java que usa las clases definidas anteriormente. En él comprobaremos las sentencias JPA necesarias para crear nuevas instancias de entidad y hacerlas persistentes en la base de datos.</p>
</div>
<div class="paragraph">
<p>En primer lugar vamos a ver la clase <code>org.expertojava.jpa.main.NuevoAutorMensaje</code> que pide un correo electrónico (identificador del autor) por la entrada estándar, busca la entidad asociada y si la encuentra solicita un mensaje y lo añade. En el caso en que el autor no existiera se crea un autor nuevo.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/expertojava/jpa/mensajes/main/NuevoAutorMensaje.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jpa</span><span class="tok-o">.</span><span class="tok-na">mensajes</span><span class="tok-o">.</span><span class="tok-na">main</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jpa.mensajes.modelo.Autor</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jpa.mensajes.modelo.Mensaje</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManager</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManagerFactory</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.Persistence</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.io.BufferedReader</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.io.IOException</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.io.InputStreamReader</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.Date</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">NuevoAutorMensaje</span> <span class="tok-o">{</span>

    <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-kt">void</span> <span class="tok-nf">main</span><span class="tok-o">(</span><span class="tok-n">String</span><span class="tok-o">[]</span> <span class="tok-n">args</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">Autor</span> <span class="tok-n">autor</span><span class="tok-o">;</span>

        <span class="tok-n">EntityManagerFactory</span> <span class="tok-n">emf</span> <span class="tok-o">=</span> <span class="tok-n">Persistence</span>
                <span class="tok-o">.</span><span class="tok-na">createEntityManagerFactory</span><span class="tok-o">(</span><span class="tok-s">&quot;mensajes-mysql&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>

        <span class="tok-k">try</span> <span class="tok-o">{</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">begin</span><span class="tok-o">();</span>

            <span class="tok-n">String</span> <span class="tok-n">email</span> <span class="tok-o">=</span> <span class="tok-n">leerTexto</span><span class="tok-o">(</span><span class="tok-s">&quot;Introduce el correo electrónico: &quot;</span><span class="tok-o">);</span>
            <span class="tok-n">String</span> <span class="tok-n">nombre</span> <span class="tok-o">=</span> <span class="tok-n">leerTexto</span><span class="tok-o">(</span><span class="tok-s">&quot;Introduce nombre: &quot;</span><span class="tok-o">);</span>

            <span class="tok-n">autor</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Autor</span><span class="tok-o">(</span><span class="tok-n">nombre</span><span class="tok-o">,</span> <span class="tok-n">email</span><span class="tok-o">);</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">persist</span><span class="tok-o">(</span><span class="tok-n">autor</span><span class="tok-o">);</span>
            <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;Identificador del autor: &quot;</span> <span class="tok-o">+</span> <span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">getId</span><span class="tok-o">());</span>

            <span class="tok-n">String</span> <span class="tok-n">mensajeStr</span> <span class="tok-o">=</span> <span class="tok-n">leerTexto</span><span class="tok-o">(</span><span class="tok-s">&quot;Introduce mensaje: &quot;</span><span class="tok-o">);</span>

            <span class="tok-n">Mensaje</span> <span class="tok-n">mens</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Mensaje</span><span class="tok-o">(</span><span class="tok-n">mensajeStr</span><span class="tok-o">,</span> <span class="tok-n">autor</span><span class="tok-o">);</span>
            <span class="tok-n">mens</span><span class="tok-o">.</span><span class="tok-na">setFecha</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">Date</span><span class="tok-o">());</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">persist</span><span class="tok-o">(</span><span class="tok-n">mens</span><span class="tok-o">);</span>
            <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;Identificador del mensaje: &quot;</span> <span class="tok-o">+</span> <span class="tok-n">mens</span><span class="tok-o">.</span><span class="tok-na">getId</span><span class="tok-o">());</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">();</span>
        <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">Exception</span> <span class="tok-n">ex</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">rollback</span><span class="tok-o">();</span>
            <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;Error: &quot;</span> <span class="tok-o">+</span> <span class="tok-n">ex</span><span class="tok-o">.</span><span class="tok-na">getMessage</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-s">&quot;\n\n&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">ex</span><span class="tok-o">.</span><span class="tok-na">printStackTrace</span><span class="tok-o">();</span>
        <span class="tok-o">}</span> <span class="tok-k">finally</span> <span class="tok-o">{</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
            <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">static</span> <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-nf">leerTexto</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">mensaje</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">String</span> <span class="tok-n">texto</span><span class="tok-o">;</span>
        <span class="tok-k">try</span> <span class="tok-o">{</span>
            <span class="tok-n">BufferedReader</span> <span class="tok-n">in</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">BufferedReader</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">InputStreamReader</span><span class="tok-o">(</span>
                    <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">in</span><span class="tok-o">));</span>
            <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">print</span><span class="tok-o">(</span><span class="tok-n">mensaje</span><span class="tok-o">);</span>
            <span class="tok-n">texto</span> <span class="tok-o">=</span> <span class="tok-n">in</span><span class="tok-o">.</span><span class="tok-na">readLine</span><span class="tok-o">();</span>
        <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">IOException</span> <span class="tok-n">e</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">texto</span> <span class="tok-o">=</span> <span class="tok-s">&quot;Error&quot;</span><span class="tok-o">;</span>
        <span class="tok-o">}</span>
        <span class="tok-k">return</span> <span class="tok-n">texto</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Se comienza creando un <code>EntityManagerFactory</code> que carga la unidad de persistencia. Esto es bastante costoso y debería hacerse sólo una vez, al arrancar la aplicación.</p>
</div>
<div class="paragraph">
<p>A partir del <code>EntityManagerFactory</code> se crea un <code>EntityManager</code>, el objeto de JPA que gestiona las entidades, los contextos de persistencia y las transacciones. Un contexto de persistencia es similar a una conexión a la base de datos. Es muy barato de obtener a partir del <code>EntityManagerFactory</code>.</p>
</div>
<div class="paragraph">
<p>La unidad de trabajo habitual en JPA con Java SE consiste en:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crear un <em>entity manager</em> a partir del <em>EntityManagerFactory</em>.</p>
</li>
<li>
<p>Marcar el comienzo de la transacción.</p>
</li>
<li>
<p>Realizar operaciones sobre las entidades.</p>
</li>
<li>
<p>Cerrar la transacción y el <em>entity manager</em>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Todas las entidades que se crean en un <em>entity manager</em> son gestionadas por él y viven en su <em>contexto de persistencia</em>. Cuando el entity manager se cierra, las entidades siguen existiendo como objetos Java, pero a partir de ese momento se encuentran desconectadas (<em>detached</em>) de la base de datos.</p>
</div>
<div class="paragraph">
<p>Cuando están gestionadas por el <em>entity manager</em>, JPA gestiona los cambios que se producen en las entidades, utiliza el proveedor de persistencia para generar las sentencias SQL asociadas a los cambios y vuelca (<em>flush</em>) esas sentencias en la base de datos.</p>
</div>
<div class="paragraph">
<p>El ejecución de los comandos SQL en la base de datos se realizan dependiendo del modo de actualización del <em>entity manager</em>. Por defecto el modo es <code>AUTO</code> y es el proveedor de persistencia (en nuestro caso, Hibernate) el que decide cuándo ejecutar los comandos en la base de datos. En el caso de Hibernate, se hace de forma inmediata. Puedes comprobarlo si está activado el log que muestra las sentencias SQL. Si está en modo <code>COMMIT</code> las sentencias se envían a la base de datos al realizar el commit de la transacción.</p>
</div>
<div class="paragraph">
<p>Podemos comprobar también en el ejemplo que el <em>entity manager</em> es quien proporciona los métodos para trabajar con la base de datos, añadiendo nuevos objetos, ejecutando consultas, etc. Por ejemplo, el método <code>persist</code> hace persistente en la base de datos el objeto que se le pasa como parámetro.</p>
</div>
<div class="paragraph">
<p>Podemos ejecutar el programa desde IntelliJ o desde línea de comandos usando el plugin <code>exec</code> de Maven:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bahs session">$ cd jpa-expertojava/mensajes
$ mvn install
$ mvn exec:java -Dexec.mainClass=org.expertojava.jpa.main.NuevoAutorMensaje</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_programa_nuevomensaje">Programa NuevoMensaje</h5>
<div class="paragraph">
<p>A continuación vemos un programa en el que se muestra cómo añadir un mensaje a un autor ya existente. Es un ejemplo de utilización de la recuperación de entidades por clave primaria.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/expertojava/jpa/mensajes/main/NuevoMensaje.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jpa</span><span class="tok-o">.</span><span class="tok-na">mensajes</span><span class="tok-o">.</span><span class="tok-na">main</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jpa.mensajes.modelo.Autor</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jpa.mensajes.modelo.Mensaje</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManager</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManagerFactory</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.Persistence</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.io.BufferedReader</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.io.IOException</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.io.InputStreamReader</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.Date</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">NuevoMensaje</span> <span class="tok-o">{</span>
    <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-kt">void</span> <span class="tok-nf">main</span><span class="tok-o">(</span><span class="tok-n">String</span><span class="tok-o">[]</span> <span class="tok-n">args</span><span class="tok-o">)</span> <span class="tok-o">{</span>

        <span class="tok-n">EntityManagerFactory</span> <span class="tok-n">emf</span> <span class="tok-o">=</span> <span class="tok-n">Persistence</span>
                <span class="tok-o">.</span><span class="tok-na">createEntityManagerFactory</span><span class="tok-o">(</span><span class="tok-s">&quot;mensajes-mysql&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">begin</span><span class="tok-o">();</span>

        <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;--Añadiendo mensaje a un usuario&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">Long</span> <span class="tok-n">idAutor</span> <span class="tok-o">=</span> <span class="tok-n">Long</span>
                <span class="tok-o">.</span><span class="tok-na">valueOf</span><span class="tok-o">(</span>
                        <span class="tok-n">leerTexto</span><span class="tok-o">(</span><span class="tok-s">&quot;Introduce identificador de usuario: &quot;</span><span class="tok-o">));</span>
        <span class="tok-n">Autor</span> <span class="tok-n">autor</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Autor</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-n">idAutor</span><span class="tok-o">);</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">autor</span> <span class="tok-o">==</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;Usuario no existente&quot;</span><span class="tok-o">);</span>
        <span class="tok-o">}</span> <span class="tok-k">else</span> <span class="tok-o">{</span>
            <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;Usuario &quot;</span> <span class="tok-o">+</span> <span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">getNombre</span><span class="tok-o">());</span>
            <span class="tok-n">String</span> <span class="tok-n">mensajeStr</span> <span class="tok-o">=</span> <span class="tok-n">leerTexto</span><span class="tok-o">(</span><span class="tok-s">&quot;Introduce mensaje: &quot;</span><span class="tok-o">);</span>
            <span class="tok-n">Mensaje</span> <span class="tok-n">mens</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Mensaje</span><span class="tok-o">(</span><span class="tok-n">mensajeStr</span><span class="tok-o">,</span> <span class="tok-n">autor</span><span class="tok-o">);</span>
            <span class="tok-n">mens</span><span class="tok-o">.</span><span class="tok-na">setFecha</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">Date</span><span class="tok-o">());</span>
            <span class="tok-n">mens</span><span class="tok-o">.</span><span class="tok-na">setAutor</span><span class="tok-o">(</span><span class="tok-n">autor</span><span class="tok-o">);</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">persist</span><span class="tok-o">(</span><span class="tok-n">mens</span><span class="tok-o">);</span>
            <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span>
                    <span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;Identificador del mensaje: &quot;</span> <span class="tok-o">+</span> <span class="tok-n">mens</span><span class="tok-o">.</span><span class="tok-na">getId</span><span class="tok-o">());</span>
        <span class="tok-o">}</span>

        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">();</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
        <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">static</span> <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-nf">leerTexto</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">mensaje</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">String</span> <span class="tok-n">texto</span><span class="tok-o">;</span>
        <span class="tok-k">try</span> <span class="tok-o">{</span>
            <span class="tok-n">BufferedReader</span> <span class="tok-n">in</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">BufferedReader</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">InputStreamReader</span><span class="tok-o">(</span>
                    <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">in</span><span class="tok-o">));</span>
            <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">print</span><span class="tok-o">(</span><span class="tok-n">mensaje</span><span class="tok-o">);</span>
            <span class="tok-n">texto</span> <span class="tok-o">=</span> <span class="tok-n">in</span><span class="tok-o">.</span><span class="tok-na">readLine</span><span class="tok-o">();</span>
        <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">IOException</span> <span class="tok-n">e</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">texto</span> <span class="tok-o">=</span> <span class="tok-s">&quot;Error&quot;</span><span class="tok-o">;</span>
        <span class="tok-o">}</span>
        <span class="tok-k">return</span> <span class="tok-n">texto</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Vemos que la recuperación de un autor a partir de su clave primaria se hace con el método <code>find</code> del entity manager, pasando como parámetro la clase de entidad que queremos recuperar y el valor de la clave primaria. El método devuelve <code>null</code> si no existe esa entidad.</p>
</div>
</div>
<div class="sect4">
<h5 id="_programa_mensajesautor">Programa MensajesAutor</h5>
<div class="paragraph">
<p>A continuación presentamos el programa que lista los mensajes añadidos a un determinado autor. Es un ejemplo de utilización de la relación a-muchos que hemos definido entre un autor y sus mensajes.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/expertojava/jpa/mensajes/main/MensajesAutor.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jpa</span><span class="tok-o">.</span><span class="tok-na">mensajes</span><span class="tok-o">.</span><span class="tok-na">main</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jpa.mensajes.modelo.Autor</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jpa.mensajes.modelo.Mensaje</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManager</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManagerFactory</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.Persistence</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.io.BufferedReader</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.io.IOException</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.io.InputStreamReader</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">MensajesAutor</span> <span class="tok-o">{</span>
    <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-kt">void</span> <span class="tok-nf">main</span><span class="tok-o">(</span><span class="tok-n">String</span><span class="tok-o">[]</span> <span class="tok-n">args</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">EntityManagerFactory</span> <span class="tok-n">emf</span> <span class="tok-o">=</span> <span class="tok-n">Persistence</span>
                <span class="tok-o">.</span><span class="tok-na">createEntityManagerFactory</span><span class="tok-o">(</span><span class="tok-s">&quot;mensajes-mysql&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-k">try</span> <span class="tok-o">{</span>
            <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;--Buscando mensajes de autor&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">Long</span> <span class="tok-n">idAutor</span> <span class="tok-o">=</span> <span class="tok-n">Long</span>
                    <span class="tok-o">.</span><span class="tok-na">valueOf</span><span class="tok-o">(</span>
                            <span class="tok-n">leerTexto</span><span class="tok-o">(</span><span class="tok-s">&quot;Introduce identificador de autor: &quot;</span><span class="tok-o">));</span>
            <span class="tok-n">Autor</span> <span class="tok-n">autor</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Autor</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-n">idAutor</span><span class="tok-o">);</span>
            <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">autor</span> <span class="tok-o">==</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
                <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;No existe ese autor&quot;</span><span class="tok-o">);</span>
            <span class="tok-o">}</span> <span class="tok-k">else</span> <span class="tok-o">{</span>
                <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">Mensaje</span> <span class="tok-n">mensaje</span> <span class="tok-o">:</span> <span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">getMensajes</span><span class="tok-o">())</span> <span class="tok-o">{</span>
                    <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">mensaje</span><span class="tok-o">.</span><span class="tok-na">toString</span><span class="tok-o">());</span>
                <span class="tok-o">}</span>
            <span class="tok-o">}</span>
        <span class="tok-o">}</span>
        <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">Exception</span> <span class="tok-n">e</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">e</span><span class="tok-o">.</span><span class="tok-na">printStackTrace</span><span class="tok-o">();</span>
        <span class="tok-o">}</span>
        <span class="tok-k">finally</span> <span class="tok-o">{</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
            <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">static</span> <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-nf">leerTexto</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">mensaje</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">String</span> <span class="tok-n">texto</span><span class="tok-o">;</span>
        <span class="tok-k">try</span> <span class="tok-o">{</span>
            <span class="tok-n">BufferedReader</span> <span class="tok-n">in</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">BufferedReader</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">InputStreamReader</span><span class="tok-o">(</span>
                    <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">in</span><span class="tok-o">));</span>
            <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">print</span><span class="tok-o">(</span><span class="tok-n">mensaje</span><span class="tok-o">);</span>
            <span class="tok-n">texto</span> <span class="tok-o">=</span> <span class="tok-n">in</span><span class="tok-o">.</span><span class="tok-na">readLine</span><span class="tok-o">();</span>
        <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">IOException</span> <span class="tok-n">e</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">texto</span> <span class="tok-o">=</span> <span class="tok-s">&quot;Error&quot;</span><span class="tok-o">;</span>
        <span class="tok-o">}</span>
        <span class="tok-k">return</span> <span class="tok-n">texto</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si miramos en la consola los mensajes SQL que se generan, veremos que el <code>find</code> que recupera el autor también genera un <code>select</code> que recupera toda la colección de mensajes. Después, basta con recorrer esta colección de mensajes que ya tenemos en memoria.</p>
</div>
</div>
<div class="sect4">
<h5 id="_programa_buscamensajes">Programa BuscaMensajes</h5>
<div class="paragraph">
<p>JPA tiene su propio lenguaje de consultas llamado JP-QL. Lo veremos en una próxima sesión. El siguiente ejemplo ejecuta la consulta en la que se busca un patrón de texto en las entidades <code>Mensaje</code>.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/expertojava/jpa/mensajes/main/BuscaMensajes.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jpa</span><span class="tok-o">.</span><span class="tok-na">mensajes</span><span class="tok-o">.</span><span class="tok-na">main</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">java.io.BufferedReader</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.io.IOException</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.io.InputStreamReader</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.List</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManager</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManagerFactory</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.Persistence</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.Query</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jpa.mensajes.Mensaje</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">BuscaMensajes</span> <span class="tok-o">{</span>

   <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-kd">final</span> <span class="tok-n">String</span> <span class="tok-n">QUERY_BUSCA_MENSAJES</span> <span class="tok-o">=</span> <span class="tok-s">&quot;SELECT m &quot;</span>
         <span class="tok-o">+</span> <span class="tok-s">&quot;FROM Mensaje m &quot;</span> <span class="tok-o">+</span> <span class="tok-s">&quot;WHERE m.texto LIKE :patron&quot;</span><span class="tok-o">;</span>

   <span class="tok-nd">@SuppressWarnings</span><span class="tok-o">(</span><span class="tok-s">&quot;unchecked&quot;</span><span class="tok-o">)</span>
   <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-kt">void</span> <span class="tok-nf">main</span><span class="tok-o">(</span><span class="tok-n">String</span><span class="tok-o">[]</span> <span class="tok-n">args</span><span class="tok-o">)</span> <span class="tok-o">{</span>

      <span class="tok-n">EntityManagerFactory</span> <span class="tok-n">emf</span> <span class="tok-o">=</span> <span class="tok-n">Persistence</span>
            <span class="tok-o">.</span><span class="tok-na">createEntityManagerFactory</span><span class="tok-o">(</span><span class="tok-s">&quot;mensajes&quot;</span><span class="tok-o">);</span>
      <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
      <span class="tok-c1">// No necesitamos crear una transacción</span>
      <span class="tok-c1">// No modificamos datos y no hay problemas de bloqueos</span>
      <span class="tok-c1">// em.getTransaction().begin();</span>

      <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;--Buscando en los mensajes&quot;</span><span class="tok-o">);</span>
      <span class="tok-n">String</span> <span class="tok-n">palabra</span> <span class="tok-o">=</span> <span class="tok-n">leerTexto</span><span class="tok-o">(</span><span class="tok-s">&quot;Introduce una palabra: &quot;</span><span class="tok-o">);</span>

      <span class="tok-n">String</span> <span class="tok-n">patron</span> <span class="tok-o">=</span> <span class="tok-s">&quot;%&quot;</span> <span class="tok-o">+</span> <span class="tok-n">palabra</span> <span class="tok-o">+</span> <span class="tok-s">&quot;%&quot;</span><span class="tok-o">;</span>

      <span class="tok-n">Query</span> <span class="tok-n">query</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">createQuery</span><span class="tok-o">(</span><span class="tok-n">QUERY_BUSCA_MENSAJES</span><span class="tok-o">);</span>
      <span class="tok-n">query</span><span class="tok-o">.</span><span class="tok-na">setParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;patron&quot;</span><span class="tok-o">,</span> <span class="tok-n">patron</span><span class="tok-o">);</span>

      <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Mensaje</span><span class="tok-o">&gt;</span> <span class="tok-n">mensajes</span> <span class="tok-o">=</span> <span class="tok-n">query</span><span class="tok-o">.</span><span class="tok-na">getResultList</span><span class="tok-o">();</span>
      <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">mensajes</span><span class="tok-o">.</span><span class="tok-na">isEmpty</span><span class="tok-o">())</span> <span class="tok-o">{</span>
         <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;No se han encontrado mensajes&quot;</span><span class="tok-o">);</span>
      <span class="tok-o">}</span> <span class="tok-k">else</span>
         <span class="tok-nf">for</span> <span class="tok-o">(</span><span class="tok-n">Mensaje</span> <span class="tok-n">mensaje</span> <span class="tok-o">:</span> <span class="tok-n">mensajes</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">mensaje</span><span class="tok-o">.</span><span class="tok-na">getTexto</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-s">&quot; -- &quot;</span>
                  <span class="tok-o">+</span> <span class="tok-n">mensaje</span><span class="tok-o">.</span><span class="tok-na">getAutor</span><span class="tok-o">().</span><span class="tok-na">getNombre</span><span class="tok-o">());</span>
         <span class="tok-o">}</span>

      <span class="tok-c1">// em.getTransaction().commit();</span>
      <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
      <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
   <span class="tok-o">}</span>

   <span class="tok-kd">static</span> <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-nf">leerTexto</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">mensaje</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-o">...</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos comprobar en el ejemplo que una vez recuperados los mensajes tenemos disponibles sus autores. JPA ha guardado en cada mensaje su <code>autor</code>. Esto sólo se hace por defecto con las relaciones "a-uno". En las relaciones "a-muchos" JPA guarda un <em>proxy</em> en lugar de la colección y JPA debe realizar una consulta SQL cuando se accede a la colección. Lo veremos con más detalle en la sesión en la que hablemos del mapeo de relaciones entre entidades.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_definición_de_tests_con_dbunit">1.2.7. Definición de tests con DbUnit</h4>
<div class="paragraph">
<p>La definición de tests se hace igual que siempre, en el directorio de tests de Maven <code>src/test/java</code>. Ya hemos visto el ejemplo del test que comprueba que funciona correctamente la inicialización de la unidad de persistencia.</p>
</div>
<div class="paragraph">
<p>Los ficheros de recursos guardados en el directorio <code>src/test/resources</code> tienen preferencia sobre los del directorio <code>main</code> cuando se ejecutan los tests. Por ejemplo, podemos guardar ahí un fichero <code>META-INF/persistence.xml</code> para que los tests se lancen sobre una base de datos distinta, o para que la base de datos se inicialice cada vez que se van a lanzar los tests. Esto es lo que hacemos en el siguiente listado, modificando el valor de la propiedad <code>hibernate.hbm2ddl.auto</code> a <code>create</code>. De esta forma cada vez que se lancen los tests se volverán a crear las tablas y estarán inicialmente vacías de elementos.</p>
</div>
<div class="listingblock">
<div class="title">src/test/resources/META-INF/persistence.xml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="xml">...
   <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.hbm2ddl.auto&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;create&quot;</span><span class="tok-nt">/&gt;</span>
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Vamos a ver rápidamente cómo usar DbUnit para poblar de datos las tablas sobre las que se realizan los tests. Con DbUnit podemos definir un conjunto de datos asociados a cada clase de tests y lanzar todos los tests de esa clase sobre esos mismos datos. La forma de hacerlo es limpiando las tablas a las que pertenecen los datos e insertándolos a continuación (tantas veces como tests haya que pasar).</p>
</div>
<div class="paragraph">
<p>El siguiente fichero muestra cómo construir un <em>dataset</em> de prueba usando XML para rellenar las tablas:</p>
</div>
<div class="listingblock">
<div class="title">src/test/resources/dbunit/dataset1.xml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;?xml version=&#39;1.0&#39; encoding=&#39;UTF-8&#39;?&gt;</span>
<span class="tok-nt">&lt;dataset&gt;</span>
    <span class="tok-nt">&lt;Autor</span> <span class="tok-na">autor_id=</span><span class="tok-s">&quot;1&quot;</span> <span class="tok-na">correo=</span><span class="tok-s">&quot;antonio.martinez@ua.es&quot;</span> <span class="tok-na">nombre=</span><span class="tok-s">&quot;Antonio Martinez&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;Mensaje</span> <span class="tok-na">mensaje_id=</span><span class="tok-s">&quot;1&quot;</span> <span class="tok-na">fecha=</span><span class="tok-s">&quot;2014-11-09&quot;</span> <span class="tok-na">texto=</span><span class="tok-s">&quot;Hola, colega&quot;</span> <span class="tok-na">autor=</span><span class="tok-s">&quot;1&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;Mensaje</span> <span class="tok-na">mensaje_id=</span><span class="tok-s">&quot;2&quot;</span> <span class="tok-na">fecha=</span><span class="tok-s">&quot;2014-11-09&quot;</span> <span class="tok-na">texto=</span><span class="tok-s">&quot;Este es mi segundo mensaje&quot;</span> <span class="tok-na">autor=</span><span class="tok-s">&quot;1&quot;</span><span class="tok-nt">/&gt;</span>
<span class="tok-nt">&lt;/dataset&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y a continuación el fichero en el que se definen los tests:</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/org.expertojava.jpa.mensajes.modelo.TestMensajes</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jpa</span><span class="tok-o">.</span><span class="tok-na">mensajes</span><span class="tok-o">.</span><span class="tok-na">modelo</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.dbunit.database.DatabaseConnection</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.dbunit.database.IDatabaseConnection</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.dbunit.dataset.IDataSet</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.dbunit.dataset.xml.FlatXmlDataSetBuilder</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.dbunit.operation.DatabaseOperation</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.junit.AfterClass</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.junit.Before</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.junit.BeforeClass</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.junit.Test</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManager</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManagerFactory</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.Persistence</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.sql.Connection</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.sql.DriverManager</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">junit</span><span class="tok-o">.</span><span class="tok-na">Assert</span><span class="tok-o">.</span><span class="tok-na">assertNotNull</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">junit</span><span class="tok-o">.</span><span class="tok-na">Assert</span><span class="tok-o">.</span><span class="tok-na">assertTrue</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">junit</span><span class="tok-o">.</span><span class="tok-na">Assert</span><span class="tok-o">.</span><span class="tok-na">fail</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">TestMensajes</span> <span class="tok-o">{</span>
    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">EntityManagerFactory</span> <span class="tok-n">emf</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">IDatabaseConnection</span> <span class="tok-n">connection</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">IDataSet</span> <span class="tok-n">dataset</span><span class="tok-o">;</span>


    <span class="tok-c1">// Se ejecuta una vez antes de todos los tests</span>
    <span class="tok-nd">@BeforeClass</span>
    <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-kt">void</span> <span class="tok-nf">initDatabaseTest</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">try</span> <span class="tok-o">{</span>
            <span class="tok-c1">// Inicializamos sólo una vez el emf antes de todos los tests</span>
            <span class="tok-n">emf</span> <span class="tok-o">=</span> <span class="tok-n">Persistence</span><span class="tok-o">.</span><span class="tok-na">createEntityManagerFactory</span><span class="tok-o">(</span><span class="tok-s">&quot;mensajes&quot;</span><span class="tok-o">);</span>

            <span class="tok-c1">// Inicializamos la conexión a la BD necesaria para </span><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1">
            <span class="tok-c1">// que DBUnit cargue los datos de los tests</span>
            <span class="tok-n">Class</span><span class="tok-o">.</span><span class="tok-na">forName</span><span class="tok-o">(</span><span class="tok-s">&quot;com.mysql.jdbc.Driver&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">Connection</span> <span class="tok-n">jdbcConnection</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-n">Connection</span><span class="tok-o">)</span> <span class="tok-n">DriverManager</span>
                    <span class="tok-o">.</span><span class="tok-na">getConnection</span><span class="tok-o">(</span>
                            <span class="tok-s">&quot;jdbc:mysql://localhost:3306/jpa_mensajes&quot;</span><span class="tok-o">,</span>
                            <span class="tok-s">&quot;root&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;expertojava&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">connection</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">DatabaseConnection</span><span class="tok-o">(</span><span class="tok-n">jdbcConnection</span><span class="tok-o">);</span>
            <span class="tok-n">FlatXmlDataSetBuilder</span> <span class="tok-n">flatXmlDataSetBuilder</span> <span class="tok-o">=</span>
                    <span class="tok-k">new</span> <span class="tok-nf">FlatXmlDataSetBuilder</span><span class="tok-o">();</span>
            <span class="tok-n">flatXmlDataSetBuilder</span><span class="tok-o">.</span><span class="tok-na">setColumnSensing</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">);</span>
            <span class="tok-n">dataset</span> <span class="tok-o">=</span> <span class="tok-n">flatXmlDataSetBuilder</span><span class="tok-o">.</span><span class="tok-na">build</span><span class="tok-o">(</span><span class="tok-n">Thread</span><span class="tok-o">.</span><span class="tok-na">currentThread</span><span class="tok-o">()</span>
                    <span class="tok-o">.</span><span class="tok-na">getContextClassLoader</span><span class="tok-o">()</span>
                    <span class="tok-o">.</span><span class="tok-na">getResourceAsStream</span><span class="tok-o">(</span><span class="tok-s">&quot;dbunit/dataset1.xml&quot;</span><span class="tok-o">));</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/2.png" alt="2">
        <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">Exception</span> <span class="tok-n">ex</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">ex</span><span class="tok-o">.</span><span class="tok-na">printStackTrace</span><span class="tok-o">();</span>
            <span class="tok-n">fail</span><span class="tok-o">(</span><span class="tok-s">&quot;Excepción al inicializar el emf y DbUnit&quot;</span><span class="tok-o">);</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>

    <span class="tok-c1">// Se ejecuta antes de cada test</span>
    <span class="tok-nd">@Before</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">cleanDB</span><span class="tok-o">()</span> <span class="tok-kd">throws</span> <span class="tok-n">Exception</span> <span class="tok-o">{</span>
        <span class="tok-c1">// Se hace un &quot;clean insert&quot; de los datos de prueba</span>
        <span class="tok-c1">// definidos en el fichero XML. El &quot;clean insert&quot; vacía las</span>
        <span class="tok-c1">// tablas de los datos de prueba y después inserta los datos</span>
        <span class="tok-n">DatabaseOperation</span><span class="tok-o">.</span><span class="tok-na">CLEAN_INSERT</span><span class="tok-o">.</span><span class="tok-na">execute</span><span class="tok-o">(</span><span class="tok-n">connection</span><span class="tok-o">,</span> <span class="tok-n">dataset</span><span class="tok-o">);</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/3.png" alt="3">
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">persistAñadeUnNuevoAutor</span><span class="tok-o">()</span> <span class="tok-o">{</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/4.png" alt="4">
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">begin</span><span class="tok-o">();</span>
        <span class="tok-n">Autor</span> <span class="tok-n">autor</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Autor</span><span class="tok-o">(</span><span class="tok-s">&quot;Antonio Martínez&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;antonio.martinez@ua.es&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">persist</span><span class="tok-o">(</span><span class="tok-n">autor</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">();</span>
        <span class="tok-n">Long</span> <span class="tok-n">id</span> <span class="tok-o">=</span> <span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">id</span><span class="tok-o">;</span>
        <span class="tok-n">Autor</span> <span class="tok-n">autor2</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Autor</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-n">id</span><span class="tok-o">);</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">autor2</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">autor</span><span class="tok-o">));</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">createEntityManagerTest</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">assertNotNull</span><span class="tok-o">(</span><span class="tok-n">em</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">findDevuelveAutor</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">Autor</span> <span class="tok-n">autor</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Autor</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">1L</span><span class="tok-o">);</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">getCorreo</span><span class="tok-o">().</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-s">&quot;antonio.martinez@ua.es&quot;</span><span class="tok-o">));</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">findDevuelveAutorConMensajes</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">Autor</span> <span class="tok-n">autor</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Autor</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">1L</span><span class="tok-o">);</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">getMensajes</span><span class="tok-o">().</span><span class="tok-na">size</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-mi">2</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>

    <span class="tok-c1">// Se ejecuta una vez después de todos los tests</span>
    <span class="tok-nd">@AfterClass</span>
    <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-kt">void</span> <span class="tok-nf">closeEntityManagerFactory</span><span class="tok-o">()</span> <span class="tok-kd">throws</span> <span class="tok-n">Exception</span> <span class="tok-o">{</span>
        <span class="tok-c1">// Borramos todos los datos y cerramos la conexión</span>
        <span class="tok-n">DatabaseOperation</span><span class="tok-o">.</span><span class="tok-na">DELETE_ALL</span><span class="tok-o">.</span><span class="tok-na">execute</span><span class="tok-o">(</span><span class="tok-n">connection</span><span class="tok-o">,</span> <span class="tok-n">dataset</span><span class="tok-o">);</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/5.png" alt="5">
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">emf</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">)</span>
            <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1"></td>
<td>Se obtiene una conexión JDBC a la base de datos para que DbUnit inserte los datos de pruebas</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/2.png" alt="2"></td>
<td>Se cargan los datos de prueba en memoria a partir del fichero <code>dbunit/dataset1.xml</code></td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/3.png" alt="3"></td>
<td>Antes de cada test se realiza una llamada al método <code>CLEAN_INSERT</code> de DbUnit con el que se vacían las tablas a las que pertenecen los datos del dataset y se insertan. De esta forma, antes de comenzar cualquier test las tablas se encuentran en el estado conocido definido por los datos cargados.</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/4.png" alt="4"></td>
<td>Se realizan tests de forma idéntica a cómo los hacíamos con JUnit</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/5.png" alt="5"></td>
<td>Al terminar todos los tests se borran todos los datos de la base de datos y se cierra el <code>EntityManagerFactory</code></td>
</tr>
</table>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios">1.3. Ejercicios</h3>
<div class="paragraph">
<p>Para crear los proyectos haz un <em>fork</em> del repositorio <code>java_ua/ejercicios-jpa</code> y descargarlo después en tu máquina:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ git clone https://&lt;usuario&gt;@bitbucket.org/&lt;usuario&gt;/ejercicios-jpa</pre>
</div>
</div>
<div class="paragraph">
<p>Lo único que contiene el repositorio es un proyecto IntelliJ vacío con el fichero <code>.gitignore</code>. En este repositorio vas a crear los distintos <em>módulos</em> que vamos a ir desarrollando en las sesiones de ejercicios.</p>
</div>
<div class="paragraph">
<p>Abre el proyecto con IntelliJ y empezamos con los ejercicios de esta sesión.</p>
</div>
<div class="sect3">
<h4 id="__0_5_puntos_construir_el_módulo_mensajes">1.3.1. (0,5 puntos) Construir el módulo mensajes</h4>
<div class="paragraph">
<p>Debes construir el proyecto <code>mensajes</code> tal y como se ha presentado en teoría:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Una vez que has abierto el proyecto <code>jpa-expertojava</code>, crea un primer módulo dentro de él. Utiliza el asistente para crear un módulo Maven vacío desde el panel de <em>Project Structure</em>, que puedes abrir con la opción <em>File &gt; Project Structure</em>:</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa01/anyadir-modulo.png" alt="" width="50%">
</div>
</div>
<div class="paragraph">
<p>Define las coordenadas del proyecto:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>groupId</code>:`org.expertojava.jpa`</p>
</li>
<li>
<p><code>artifactId</code>: <code>mensajes</code></p>
</li>
<li>
<p><code>version</code>: la que aparece por defecto (<code>1.0-SNAPSHOT</code>)</p>
</li>
<li>
<p><code>packaging</code>: jar</p>
<div class="paragraph">
<p>Y ubica el módulo en el directorio <code>mensajes</code> dentro del proyecto principal</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Cuando se abra el nuevo proyecto en IntelliJ recuerda activar los menús del control de versiones Git con la opción <em>VCS &gt; Enable Version Control Integration &gt; Git</em>. Ahora ya podrás usar Git desde IntelliJ.</p>
</li>
<li>
<p>Crea las clases Java de entidad y el fichero <code>persistence.xml</code></p>
</li>
<li>
<p>Crea los tests</p>
</li>
<li>
<p>Crea las clases main</p>
</li>
<li>
<p>Ejecuta algunos ejemplos y comprueba que los datos se han añadido en la base de datos</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Puedes encontrar el código del ejemplo, aparte de en estos apuntes, en el repositorio <code>java_ua/ejemplos-jpa</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="__1_5_puntos_contruir_el_módulo_filmoteca">1.3.2. (1,5 puntos) Contruir el módulo filmoteca</h4>
<div class="paragraph">
<p>Construye en IntelliJ el módulo Maven <code>filmoteca</code> con los siguientes parámetros:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>groupId</code>: org.expertojava.jpa</p>
</li>
<li>
<p><code>artifactId</code>: filmoteca</p>
</li>
<li>
<p><code>version</code>: 0.0.1-SNAPSHOT</p>
</li>
<li>
<p><code>packaging</code>: jar</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Modifica el fichero POM para incluir las librerías necesarias para trabajar con JPA. Crea una base de datos nueva llamada <code>jpa_filmoteca</code> y el fichero de configuración de JPA <code>persistence.xml</code>. Crea en el <code>persistence.xml</code> una unidad de persistencia sin clases con el nombre <code>filmoteca</code>. Crea por último el <em>singleton</em> que obtiene el <code>entityManagerFactory</code>.</p>
</div>
<div class="paragraph">
<p>Para probar todo lo anterior, crea una clase de test como hemos anteriormente para probar que se obtiene correctamente el entity manager. Lanza el test y comprueba que funciona correctamente.</p>
</div>
<div class="sect4">
<h5 id="_creación_de_entidades">Creación de entidades</h5>
<div class="paragraph">
<p>Crea las siguientes entidades en el paquete org.expertojava.jpa.filmoteca.modelo:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Pelicula</code>, con un identificador autogenerado como clave primaria (tipo <code>Long</code>) y los campos:</p>
<div class="ulist">
<ul>
<li>
<p><code>titulo</code> (<code>String</code>)</p>
</li>
<li>
<p><code>estreno (`Date</code>)</p>
</li>
<li>
<p><code>presupuesto</code> (<code>Double</code>): presupuesto de la película en miles de euros</p>
</li>
<li>
<p><code>recaudación</code> (<code>Double</code>): recaudación de la película en miles de euros</p>
</li>
<li>
<p><code>pais</code> (<code>String</code>)</p>
</li>
<li>
<p>Relación a-muchos con la entidad <code>Critica</code></p>
</li>
</ul>
</div>
</li>
<li>
<p><code>Critica</code>, con un identificador autogenerado como clave primaria (tipo <code>Long</code>) y los campos:</p>
<div class="ulist">
<ul>
<li>
<p><code>critico</code> (<code>String</code>)</p>
</li>
<li>
<p><code>texto</code> (<code>String</code>)</p>
</li>
<li>
<p><code>valoracion</code> (<code>Integer</code>): número del 1 al 10</p>
</li>
<li>
<p>relación a-uno con <code>Pelicula</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Lanza el test anterior y comprueba que las tablas se han creado correctamente en la BD.</p>
</div>
</div>
<div class="sect4">
<h5 id="_programas_de_prueba_de_las_entidades">Programas de prueba de las entidades</h5>
<div class="paragraph">
<p>Siguiendo los ejemplos vistos en la sesión de teoría, escribe dos clases <code>main</code> en el paquete org.expertojava.jpa.filmoteca.main:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>NuevaPelicula</code>: Añade una nueva película, introduciendo por la entrada estándar su título, su fecha de estreno, su presupuesto y su recaudación. Imprime por la salida estándar el código de la película.</p>
</li>
<li>
<p><code>NuevaCritica</code>: Añade una nueva crítica, introduciendo por la entrada estándar el nombre del crítico, el texto de la crítica, la valoración y el código de la película.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Puedes ejecutar los programas desde IntelliJ o desde línea de comando utilizando el plugin exec de Maven:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> mvn <span class="tok-nb">exec</span>:java -Dexec.mainClass<span class="tok-o">=</span>org.expertojava.jpa.filmoteca.main.NuevaPelicula</code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion02">2. Entity Manager y contexto de persistencia</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introducción">2.1. Introducción</h3>
<div class="paragraph">
<p>En JPA todas las operaciones relacionadas con la persistencia de las entidades y el mapeado de estas entidades con la base de datos subyacente se realizan a través de un <em>gestor de entidades</em> (<em>entity manager</em> en inglés). El <em>entity manager</em> tiene dos responsabilidad fundamentales:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Define una conexión transaccional con la base de datos que debemos abrir y mantener abierta mientras estamos realizado operaciones. En este sentido realiza funciones similares a las de una conexión JDBC.</p>
</li>
<li>
<p>Además, mantiene en memoria una caché con las entidades que gestiona y es responsable de sincronizarlas correctamente con la base de datos cuando se realiza un <em>flush</em>. El conjunto de entidades que gestiona un <em>entity manager</em> se denomina su <em>contexto de persistencia</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>El <em>entity manager</em> se obtiene a través de una factoría del tipo <code>EntityManagerFactory</code>, que se configura mediante la especificación de una <em>unidad de persistencia</em> (<em>persistence unit</em> en inglés) definida en el fichero XML <code>persistence.xml</code>. En el fichero pueden haber definidas más de una unidad de persistencia, cada una con un nombre distinto. El nombre de la unidad de persistencia escogida se pasa a la factoría. La unidad de persistencia define las características concretas de la base de datos con la que van a trabajar todos los <em>entity managers</em> obtenidos a partir de esa factoría y queda asociada a ella en el momento de su creación. Existe, por tanto, una relación uno-a-uno entre una unidad de persistencia y su <code>EntityManagerFactory</code> concreto. Para obtener una factoría <code>EntityManagerFactory</code> debemos llamar a un método estático de la clase <code>Persistence</code> .</p>
</div>
<div class="paragraph">
<p>Las relaciones entre las clases que intervienen en la configuración y en la creación de <em>entity managers</em> se muestran en la siguiente figura.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa02/entity-manager.png" alt="Clases EntityManager" width="66%">
</div>
</div>
<div class="sect3">
<h4 id="_entidades_gestionadas_y_desconectadas">2.1.1. Entidades gestionadas y desconectadas</h4>
<div class="paragraph">
<p>Una vez creado el <em>entity manager</em> lo utilizaremos para realizar todas las operaciones de recuperación, consulta y actualización de entidades. Cuando un <em>entity manager</em> obtiene una referencia a una entidad, se dice que la entidad está <strong>gestionada</strong> (una <em>managed entity</em> en inglés) por él. El <em>entity manager</em> guarda internamente todas las entidades que gestiona y las utiliza como una caché de los datos en la base de datos. Por ejemplo, cuando va a recuperar una entidad por su clave primaria, lo primero que hace es consultar en su caché si esta entidad ya la ha recuperado previamente. Si es así, no necesita hacer la búsqueda en la base de datos y devuelve la propia referencia que mantiene. Al conjunto de entidades gestionadas por un <em>entity manager</em> se le denomina su <em>contexto de persistencia</em> (<em>persistence context</em> en inglés).</p>
</div>
<div class="paragraph">
<p>En un determinado momento, el <em>entity manager</em> debe volcar a la base de datos todos los cambios que se han realizado sobre las entidades. También debe ejecutar las consultas JPQL definidas. Para ello el <em>entity manager</em> utiliza un <em>proveedor de persistencia</em> (<em>persistence provider</em> en inglés) que es el responsable de generar todo el código SQL compatible con la base de datos.</p>
</div>
<div class="paragraph">
<p>En esta sesión estudiaremos las distintas operaciones que realiza el entity manager, así como el concepto de <em>contexto de persistencia</em> y las distintas problemáticas relacionadas con la gestión de esta caché de objetos persistentes y la sincronización con la base de datos subyacente.</p>
</div>
<div class="paragraph">
<p>Una vez que se cierra la transacción y se cierra el <em>entity manager</em>, éste desaparece pero las entidades gestionadas siguen estando en memoria, pero ahora en estado <strong>desconectado</strong> (<em>detached</em> en inglés). Podrían volverse a gestionar por un <em>entity manager</em> usando el método <code>merge</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_apis_de_java_ee_7">2.1.2. APIs de Java EE 7</h4>
<div class="paragraph">
<p>Veremos una parte de la completa APIs de Java EE 7 sobre estas clases. Los siguientes métodos de la interfaz <code>EntityManager</code> son los más importantes y los estudiaremos en detalle en los siguientes apartados:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>void clear()</code>: borra el contexto de persistencia, desconectando todas sus entidades</p>
</li>
<li>
<p><code>boolean contains(Object entity)</code>: comprueba si una entidad está gestionada en el contexto de persistencia</p>
</li>
<li>
<p><code>Query createNamedQuery(String name)</code>: obtiene una consulta JPQL precompilada</p>
</li>
<li>
<p><code>void detach(Object entity)</code>: elimina la entidad del contexto de persistencia, dejándola desconectada de la base de datos</p>
</li>
<li>
<p><code>&lt;T&gt; T find(Class&lt;T&gt;, Object key)</code>: busca por clave primaria</p>
</li>
<li>
<p><code>void flush()</code>: sincroniza el contexto de persistencia con la base de datos</p>
</li>
<li>
<p><code>&lt;T&gt; T getReference(Class&lt;T&gt;, Object key)</code>: obtiene una referencia a una entidad, que puede haber sido recuperada de forma <em>lazy</em></p>
</li>
<li>
<p><code>EntityTransaction getTransaction()</code>: devuelve la transacción actual</p>
</li>
<li>
<p><code>&lt;T&gt; T merge(T entity)</code>: incorpora una entidad al contexto de persistencia, haciéndola gestionada</p>
</li>
<li>
<p><code>void persist(Object entity)</code>: hace una entidad persistente y gestionada</p>
</li>
<li>
<p><code>void refresh(Object entity)</code>: refresca el estado de la entidad con los valores de la base de datos, sobreescribiendo los cambios que se hayan podido realizar en ella</p>
</li>
<li>
<p><code>void remove(Object entity)</code>: elimina la entidad</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Puedes consultar el API completo de estas clases en los siguientes enlaces:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.oracle.com/javaee/7/api/javax/persistence/EntityManager.html">javax.persistence.EntityManager</a></p>
</li>
<li>
<p><a href="https://docs.oracle.com/javaee/7/api/javax/persistence/EntityManagerFactory.html">java.persistence.EntityManagerFactory</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_obtención_del_entity_manager_factory_y_de_los_entity_manager">2.1.3. Obtención del entity manager factory y de los entity manager</h4>
<div class="paragraph">
<p>La forma de obtener un <em>entity manager</em> o un <em>entity manager factory</em> varía dependiendo de si estamos utilizando JPA desde una aplicación <em>standalone</em> (lo que se denomina <em>JPA gestionado por la aplicación</em>) o desde un servidor de aplicaciones Java EE (en lo que se denomina JPA gestionado por el contenedor). En el segundo caso se obtienen mediante <em>inyección de dependencias</em>, siendo el servidor el responsable de obtener el <em>entity manager</em> e <em>inyectarlo</em> en una variable que tiene una determinada anotación. En el caso de JPA gestionado por la aplicación, es el programador el que debe llamar de forma explícita a las instrucciones para obtener estos objetos.</p>
</div>
<div class="sect4">
<h5 id="_obtención_del_entity_manager_factory">Obtención del entity manager factory</h5>
<div class="paragraph">
<p>En el primer caso, cuando estamos usando JPA gestionado por la aplicación, lo primero que debemos hacer es crear un <code>EntityManagerFactory</code>, para lo que hay que invocar al método <code>createEntityManagerFactory()</code> pasando por parámetro el nombre de la unidad de persistencia definida en el fichero <code>persistence.xml</code>. En este fichero, como ya hemos visto, se especifican los parámetros de configuración de la conexión con la base de datos (URL de la conexión, nombre de la base de datos, usuario, contraseña, gestor de base de datos, características del <em>pool</em> de conexiones, etc.). Por ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">EntityManagerFactory</span> <span class="tok-n">emf</span> <span class="tok-o">=</span>
   <span class="tok-n">Persistence</span><span class="tok-o">.</span><span class="tok-na">createEntityManagerFactory</span><span class="tok-o">(</span><span class="tok-s">&quot;mensajes-mysql&quot;</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Esta creación es un proceso costoso, ya que incluye el procesamiento de todas las anotaciones de las clases de entidad declaradas en el <code>persistence.xml</code>, la generación del esquema de datos asociados para compararlo con el existente en la base de datos con la que se realiza la conexión y bastantes otros procesos relacionados con el mapeo de las entidades con la base de datos.</p>
</div>
<div class="paragraph">
<p>Es conveniente llamar al método sólo una vez y guardar el <code>entityManagerFactory</code> resultante en una variable estática o en un <em>singleton</em> para reusar la misma factoría durante el tiempo de vida de la aplicación. Por ejemplo, el siguiente código define un <em>singleton</em> que inicializa el <em>entityManagerFactory</em> sólo una vez. Lo llamamos <code>EmfSingleton</code> y lo definimos en el paquete <code>org.expertojava.jpa.mensajes.persistencia</code>:</p>
</div>
<div class="listingblock">
<div class="title">EmfSingleton</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jpa</span><span class="tok-o">.</span><span class="tok-na">mensajes</span><span class="tok-o">.</span><span class="tok-na">persistencia</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManagerFactory</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.Persistence</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">EmfSingleton</span> <span class="tok-o">{</span>
    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">EmfSingleton</span> <span class="tok-n">ourInstance</span> <span class="tok-o">=</span>
            <span class="tok-k">new</span> <span class="tok-nf">EmfSingleton</span><span class="tok-o">();</span>
    <span class="tok-kd">static</span> <span class="tok-kd">private</span> <span class="tok-kd">final</span> <span class="tok-n">String</span> <span class="tok-n">PERSISTENCE_UNIT_NAME</span> <span class="tok-o">=</span> <span class="tok-s">&quot;mensajes-mysql&quot;</span><span class="tok-o">;</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1">
    <span class="tok-kd">private</span> <span class="tok-n">EntityManagerFactory</span> <span class="tok-n">emf</span> <span class="tok-o">=</span> <span class="tok-kc">null</span><span class="tok-o">;</span>

    <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-n">EmfSingleton</span> <span class="tok-nf">getInstance</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">ourInstance</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">private</span> <span class="tok-nf">EmfSingleton</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">EntityManagerFactory</span> <span class="tok-nf">getEmf</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">emf</span> <span class="tok-o">==</span> <span class="tok-kc">null</span><span class="tok-o">)</span>
            <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">emf</span> <span class="tok-o">=</span> <span class="tok-n">Persistence</span>
                    <span class="tok-o">.</span><span class="tok-na">createEntityManagerFactory</span><span class="tok-o">(</span><span class="tok-n">PERSISTENCE_UNIT_NAME</span><span class="tok-o">);</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/2.png" alt="2">
        <span class="tok-k">return</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">emf</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1"></td>
<td>Constante con el nombre de la unidad de persistencia</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/2.png" alt="2"></td>
<td>Creación de la factoría. Sólo se hace una vez, la primera vez que se llama al método.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Una vez definido el <em>singleton</em> anterior podemos acceder a la factoría con el siguiente código:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">EntityManagerFactory</span> <span class="tok-n">emf</span> <span class="tok-o">=</span> <span class="tok-n">EmfSingleton</span><span class="tok-o">.</span><span class="tok-na">getInstance</span><span class="tok-o">().</span><span class="tok-na">getEmf</span><span class="tok-o">()</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_obtención_de_los_entitymanager">Obtención de los entityManager</h5>
<div class="paragraph">
<p>Los <code>entityManager</code> se obtienen a partir del <code>entityManagerFactory</code> mediante el método <code>createEntityManager()</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lo normal es que no necesitemos trabajar con la factoría de y que llamemos directamente al objeto que nos devuelve el <em>singleton</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">EmfSingleton</span><span class="tok-o">.</span><span class="tok-na">getInstance</span><span class="tok-o">().</span><span class="tok-na">getEmf</span><span class="tok-o">().</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Esta llamada no es nada costosa, ya que las implementaciones de JPA (como Hibernate) implementan <em>pools</em> de entity managers. El método <code>createEntityManager</code> no realiza ninguna reserva de memoria ni de otros recursos sino que simplemente devuelve alguno de los entity managers disponibles.</p>
</div>
<div class="paragraph">
<p>Repetimos a continuación un ejemplo típico de uso que ya hemos visto previamente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">EjemploUnidadDeTrabajoJPA</span> <span class="tok-o">{</span>
   <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-kt">void</span> <span class="tok-nf">main</span><span class="tok-o">(</span><span class="tok-n">String</span><span class="tok-o">[]</span> <span class="tok-n">args</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-n">EntityManagerFactory</span> <span class="tok-n">emf</span> <span class="tok-o">=</span>
          <span class="tok-n">EmfSingleton</span><span class="tok-o">.</span><span class="tok-na">getInstance</span><span class="tok-o">().</span><span class="tok-na">getEmf</span><span class="tok-o">();</span>
      <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>

      <span class="tok-c1">// Abrimos una transacción</span>
      <span class="tok-n">EntityTransaction</span> <span class="tok-n">tx</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">();</span>
      <span class="tok-n">tx</span><span class="tok-o">.</span><span class="tok-na">begin</span><span class="tok-o">();</span>

      <span class="tok-c1">// El em realiza operaciones sobre las entidades</span>

      <span class="tok-c1">// Cerramos la transacción, el em</span>
      <span class="tok-n">tx</span><span class="tok-o">.</span><span class="tok-na">commit</span><span class="tok-o">();</span>
      <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>

      <span class="tok-c1">// Cerramos el emf cuando se termina la aplicación</span>
      <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Es muy importante considerar que los objetos <code>EntityManager</code> no son <em>thread-safe</em>, no pueden ser compartidos por más de un <em>thread</em>. Cuando los utilicemos en servlets, por ejemplo, deberemos crearlos en cada petición HTTP. De esta forma se evita que distintas sesiones accedan al mismo contexto de persistencia.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_transacciones">2.1.4. Transacciones</h4>
<div class="paragraph">
<p>Cualquier operación que conlleve una creación, modificación o borrado de entidades debe hacerse dentro de una transacción. En JPA las transacciones se gestionan de forma distinta dependiendo de si estamos en un entorno Java SE o en un entorno Java EE. La diferencia fundamental entre ambos casos es que en un entorno Java EE las transacciones se manejan con JTA (Java Transaction API), un API que implementa el <em>two face commit</em> y que permite gestionar operaciones sobre múltiples recursos transaccionales o múltiples operaciones transaccionales sobre el mismo recurso. En el caso de Java SE las transacciones se implementan con el gestor de transacciones propio del recurso local (la base de datos) y se especifican en la interfaz <code>EntityTransaction</code>.</p>
</div>
<div class="paragraph">
<p>El gestor de transacciones locales se obtiene con la llamada <code>getTransaction()</code> al <code>EntityManager</code>. Una vez obtenido, podemos pedirle cualquiera de los métodos definidos en la interfaz: <code>begin()</code> para comenzar la transacción, <code>commit()</code> para actualizar los cambios en la base de datos (en ese momento JPA vuelca las sentencias SQL en la base de datos) o <code>rollback()</code> para deshacer la transacción actual.</p>
</div>
<div class="paragraph">
<p>El siguiente listado muestra un ejemplo de uso de una transacción:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">begin</span><span class="tok-o">();</span>
<span class="tok-n">createEmpleado</span><span class="tok-o">(</span><span class="tok-s">&quot;Juan Garcia&quot;</span><span class="tok-o">,</span> <span class="tok-mi">30000</span><span class="tok-o">);</span>
<span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">();</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_operaciones_crud_del_entity_manager">2.2. Operaciones CRUD del entity manager</h3>
<div class="paragraph">
<p>Vamos a ver con más detalle las operaciones básicas relacionadas con entidades que podemos hacer con un <em>entity manager</em>. Veremos las siguientes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>persist()</code> para almacenar una entidad en la base de datos</p>
</li>
<li>
<p><code>find()</code> para buscar entidades por clave primaria</p>
</li>
<li>
<p>actualización de entidades con los <em>setters</em></p>
</li>
<li>
<p><code>remove()</code> para borrar entidades</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_persist_para_hacer_persistente_una_entidad">2.2.1. Persist para hacer persistente una entidad</h4>
<div class="paragraph">
<p>El método <code>persist()</code> del <code>EntityManager</code> acepta una nueva instancia de entidad y la convierte en gestionada. Si la entidad que se pasa como parámetro ya está gestionada en el contexto de persistencia, la llamada se ignora. La operación <code>contains()</code> puede usarse para comprobar si una entidad está gestionada.</p>
</div>
<div class="paragraph">
<p>El hecho de convertir una entidad en gestionada no la hace persistir inmediatamente en la base de datos. La verdadera llamada a SQL para crear los datos relacionales no se generará hasta que el contexto de persistencia se sincronice con la base de datos. Lo más normal es que esto suceda cuando se realiza un commit de la transacción. En el momento en que la entidad se convierte en gestionada, los cambios que se realizan sobre ella afectan al contexto de persistencia. Y en el momento en que la transacción termina, el estado en el que se encuentra la entidad es volcado en la base de datos.</p>
</div>
<div class="paragraph">
<p>Si se llama a <code>persist()</code> fuera de una transacción la entidad se incluirá en el contexto de persistencia, pero no se realizará ninguna acción hasta que la transacción comience y el contexto de persistencia se sincronice con la base de datos.</p>
</div>
<div class="paragraph">
<p>La operación <code>persist()</code> se utiliza con entidades nuevas que no existen en la base de datos. Si se le pasa una instancia con un identificador que ya existe en la base de datos el proveedor de persistencia puede detectarlo y lanzar una excepción <code>EntityExistsException</code>. Si no lo hace, entonces se lanzará la excepción cuando se sincronice el conexto de persistencia con la base de datos, al encontrar una clave primaria duplicada.</p>
</div>
<div class="paragraph">
<p>Un ejemplo completo de utilización de <code>persist()</code>, en el que también se realiza una actualización de una relación a-muchos, es el siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
<span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">begin</span><span class="tok-o">();</span>

<span class="tok-c1">// Añadimos un nuevo empleado al departamento 1</span>
<span class="tok-n">Departamento</span> <span class="tok-n">depto</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Departamento</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">1L</span><span class="tok-o">);</span>
<span class="tok-n">Empleado</span> <span class="tok-n">empleado</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Empleado</span><span class="tok-o">();</span>
<span class="tok-n">empleado</span><span class="tok-o">.</span><span class="tok-na">setNombre</span><span class="tok-o">(</span><span class="tok-s">&quot;Pedro&quot;</span><span class="tok-o">);</span>
<span class="tok-n">empleado</span><span class="tok-o">.</span><span class="tok-na">setSueldo</span><span class="tok-o">(</span><span class="tok-mf">38000.0</span><span class="tok-o">);</span>
<span class="tok-n">empleado</span><span class="tok-o">.</span><span class="tok-na">setDepartamento</span><span class="tok-o">(</span><span class="tok-n">depto</span><span class="tok-o">);</span>
<span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">persist</span><span class="tok-o">(</span><span class="tok-n">empleado</span><span class="tok-o">);</span>

<span class="tok-c1">// Actualizamos la colección en memoria de empleados del departamento</span>
<span class="tok-n">depto</span><span class="tok-o">.</span><span class="tok-na">getEmpleados</span><span class="tok-o">().</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-n">empleado</span><span class="tok-o">);</span>

<span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">();</span>
<span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En el ejemplo comenzamos obteniendo una instancia que ya existe en la base de datos de la entidad <code>Departamento</code>. Se crea una nueva instancia de <code>Empleado</code>, proporcionando algún atributo. Después asignamos el empleado al departamento, llamando al método <code>setDepartamento()</code> del empleado y pasándole la instancia de <code>Departamento</code> que habíamos recuperado. Después realizamos la llamada al método <code>persist()</code> que convierte la entidad en gestionada. Cuando el contexto de persistencia se sincroniza con la base de datos, se añade el nuevo empleado en la tabla y se actualiza su id. En la columna <code>departmento_id</code> se guarda la clave ajena al departamento al que está asignado. Hay que hacer notar que sólo se actualiza la tabla de <code>Empleado</code>, que es la propietaria de la relación y la que contiene la clave ajena a <code>Departamento</code>.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa02/tabla-empleados.png" alt="Clases EntityManager" width="66%">
</div>
</div>
<div class="paragraph">
<p>Por último actualizamos en memoria el otro lado de la relación llamando al método <code>add()</code> de la colección. Esto no es necesario para actualizar la base de datos, sólo para actualizar la relación en memoria. Es importante tener siempre presente que JPA no actualiza las colecciones en memoria de las relaciones uno-a-muchos.</p>
</div>
<div class="paragraph">
<p>Una cuestión muy importante a tener en cuenta es que si el identificador del empleado es una clave primaria generada por la base de datos no estará disponible hasta que el contexto de persistencia realice la ejecución de los comandos SQL. Hay que tener cuidado y no realizar el <code>add</code> en la colección con el identificador a null. Con Hibernate no hay problema, porque realiza la actualización en la base de datos de inmediantamente y tenemos el <code>id</code> actualizado justo después de ejecutar el <code>persist</code> (si el <code>flush()</code> está puesto a <code>AUTO</code>). Pero tenemos que tener cuidado, y comprobar el comportamiento de cada proveedor de persistencia.</p>
</div>
<div class="paragraph">
<p>Si queremos asegurarnos de que el identificador se carga en la entidad podemos utilizar las siguientes sentencias:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">persist</span><span class="tok-o">(</span><span class="tok-n">empleado</span><span class="tok-o">);</span>
<span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">flush</span><span class="tok-o">(</span><span class="tok-n">empleado</span><span class="tok-o">);</span>
<span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">refresh</span><span class="tok-o">(</span><span class="tok-n">empleado</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La llamada a <code>flush</code> asegura que se ejecuta el <code>insert</code> en la BD y la llamada a <code>refresh</code> asegura que el identificador se carga en la instancia. Esto es válido para cualquier proveedor de persistencia.</p>
</div>
</div>
<div class="sect3">
<h4 id="_find_para_buscar_entidades_por_clave_primaria">2.2.2. Find para buscar entidades por clave primaria</h4>
<div class="paragraph">
<p>Una vez que la entidad está en la base de datos, lo siguiente que podemos hacer es recuperarla de nuevo. Para ello basta con escribir una línea de código:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">Empeado</span> <span class="tok-n">empleado</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Empleado</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">4L</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pasamos la clase de la entidad que estamos buscando (en el ejemplo estamos buscando una instancia de la clase <code>Empleado</code>) y el identificador o clave primaria que identifica la entidad. El entity manager buscará esa entidad en la base de datos y devolverá la instancia buscada. La entidad devuelta será una entidad gestionada que existirá en el contexto de persistencia actual asociado al entity manager.</p>
</div>
<div class="paragraph">
<p>En el caso en que no existiera ninguna entidad con ese identificador, se devolvería simplemente <code>null</code>.</p>
</div>
<div class="paragraph">
<p>La llamada a <code>find</code> puede devolver dos posibles excepciones de tiempo de ejecución, ambas de la clase <code>PersistenceException</code>: <code>IllegalStateException</code> si el entitiy manager ha sido previamente cerrado o <code>IllegalArgumentException</code> si el primer argumento no contiene una clase entidad o el segundo no es el tipo correcto de la clave primaria de la entidad.</p>
</div>
<div class="paragraph">
<p>Existe una versión especial de <code>find()</code> que sólo recupera <strong>una referencia</strong> (técnicamente, un <em>proxy</em>) a la entidad, sin obtener los datos de los campos de la base de datos. Se trata del método <code>getReference()</code>. Es últil cuando se quiere añadir un objeto con una clave primaria conocida a una relación. Ya que únicamente estamos creando una relación, no es necesario cargar todo el objeto de la base de datos. Sólo se necesita su clave primaria. Veamos la nueva versión del ejemplo anterior:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">Departamento</span> <span class="tok-n">depto</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getReference</span><span class="tok-o">(</span><span class="tok-n">Departamento</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">1L</span><span class="tok-o">);</span>
<span class="tok-n">Empleado</span> <span class="tok-n">empleado</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Empleado</span><span class="tok-o">();</span>
<span class="tok-n">empleado</span><span class="tok-o">.</span><span class="tok-na">setNombre</span><span class="tok-o">(</span><span class="tok-s">&quot;Pedro&quot;</span><span class="tok-o">);</span>
<span class="tok-n">empleado</span><span class="tok-o">.</span><span class="tok-na">setSueldo</span><span class="tok-o">(</span><span class="tok-mf">38000.0</span><span class="tok-o">);</span>
<span class="tok-n">empleado</span><span class="tok-o">.</span><span class="tok-na">setDepartamento</span><span class="tok-o">(</span><span class="tok-n">depto</span><span class="tok-o">);</span>
<span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">persist</span><span class="tok-o">(</span><span class="tok-n">empleado</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Esta versión es más eficiente que la anterior porque no se realiza ningún <code>SELECT</code> en la base de datos para buscar la instancia del <code>Departamento</code>. Cuando se llama a <code>getReference()</code>, el proveedor devolverá un <em>proxy</em> al <code>Departamento</code> sin recuperarlo realmente de la base de datos. En tanto que sólo se acceda a la clave primaria, no se recuperará ningún dato. Y cuando se haga persistente el <code>Empleado</code>, se guardará en la clave ajena correspondiente el valor de la clave primaria del <code>Departamento</code>.</p>
</div>
<div class="paragraph">
<p>Un posible problema de este método es que, a diferencia de <code>find()</code> no devuelve <code>null</code> si la instancia no existe, ya que realmente no realiza la búsqueda en la base de datos. Únicamente se debe utilizar el método cuando estamos seguros de que la instancia existe en la base de datos. En caso contrario estaremos guardando en la variable <code>dept</code> una referencia (clave primaria) de una entidad que no existe, y cuando se haga persistente el empleado se generará una excepción porque el <code>Empleado</code> estará haciendo referencia a una entidad no existente.</p>
</div>
<div class="paragraph">
<p>En general, la mayoría de las veces llamaremos al método <code>find()</code> directamente. Las implementaciones de JPA hacen un buen trabajo con las cachés y si ya tenemos la entidad en el contexto de persistencia no se realiza la consulta a la base de datos.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, el siguiente código sólo generaría un <code>SELECT</code> sobre la base de datos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">Departamento</span> <span class="tok-n">depto1</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Departamento</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">1L</span><span class="tok-o">);</span>
<span class="tok-n">Departamento</span> <span class="tok-n">depto2</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Departamento</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">1L</span><span class="tok-o">);</span>
<span class="tok-n">Departamento</span> <span class="tok-n">depto3</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Departamento</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">1L</span><span class="tok-o">);</span>
<span class="tok-n">Departamento</span> <span class="tok-n">depto4</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Departamento</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">1L</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La única sentencia SQL generada es:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-n">Hibernate</span><span class="tok-p">:</span> <span class="tok-k">select</span> <span class="tok-n">departamen0_</span><span class="tok-p">.</span><span class="tok-n">id</span> <span class="tok-k">as</span> <span class="tok-n">id1_0_0_</span><span class="tok-p">,</span> <span class="tok-n">departamen0_</span><span class="tok-p">.</span><span class="tok-n">campus</span> <span class="tok-k">as</span> <span class="tok-n">campus2_0_0_</span><span class="tok-p">,</span>
<span class="tok-n">departamen0_</span><span class="tok-p">.</span><span class="tok-n">edificio</span> <span class="tok-k">as</span> <span class="tok-n">edificio3_0_0_</span><span class="tok-p">,</span> <span class="tok-n">departamen0_</span><span class="tok-p">.</span><span class="tok-n">nombre</span> <span class="tok-k">as</span> <span class="tok-n">nombre4_0_0_</span>
<span class="tok-k">from</span> <span class="tok-n">Departamento</span> <span class="tok-n">departamen0_</span> <span class="tok-k">where</span> <span class="tok-n">departamen0_</span><span class="tok-p">.</span><span class="tok-n">id</span><span class="tok-o">=?</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_actualización_de_entidades">2.2.3. Actualización de entidades</h4>
<div class="paragraph">
<p>Para actualizar una entidad, primero debemos obtenerla para convertirla en gestionada. Después podremos colocar los nuevos valores en sus atributos utilizando los métodos <code>set</code> de la entidad. Por ejemplo, supongamos que queremos subir el sueldo del empleado 146 en 1.000 euros. Tendríamos que hacer lo siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">begin</span><span class="tok-o">();</span>
<span class="tok-n">Empleado</span> <span class="tok-n">empleado</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Empleado</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">2L</span><span class="tok-o">);</span>
<span class="tok-kt">double</span> <span class="tok-n">sueldo</span> <span class="tok-o">=</span> <span class="tok-n">empleado</span><span class="tok-o">.</span><span class="tok-na">getSueldo</span><span class="tok-o">();</span>
<span class="tok-n">empleado</span><span class="tok-o">.</span><span class="tok-na">setSueldo</span><span class="tok-o">(</span><span class="tok-n">sueldo</span> <span class="tok-o">+</span> <span class="tok-mf">1000.0</span><span class="tok-o">);</span>
<span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">();</span>
<span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nótese la diferencia con las operaciones anteriores, en las que el <code>EntityManager</code> era el responsable de realizar la operación directamente. Aquí no llamamos al <code>EntityManager</code> sino a la propia entidad. Estamos, por así decirlo, trabajando con una caché de los datos de la base de datos. Posteriormente, cuando se finalice la transacción, el <code>EntityManager</code> hará persistentes los cambios mediante las correspondientes sentencias SQL.</p>
</div>
<div class="paragraph">
<p>La otra forma de actualizar una entidad es con el método <code>merge()</code> del <code>EntityManager</code>. A este método se le pasa como parámetro una entidad no gestionada. El <code>EntityManager</code> busca la entidad en su contexto de persistencia (utilizando su identificador) y actualiza los valores del contexto de persistencia con los de la entidad no gestionada. En el caso en que la entidad no existiera en el contexto de persistencia, se crea con los valores que lleva la entidad no gestionada.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
<span class="tok-n">Empleado</span> <span class="tok-n">empleado</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Empleado</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">2L</span><span class="tok-o">);</span>
<span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>

<span class="tok-n">empleado</span><span class="tok-o">.</span><span class="tok-na">setNombre</span><span class="tok-o">(</span><span class="tok-s">&quot;Pepito Pérez&quot;</span><span class="tok-o">);</span>

<span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
<span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">begin</span><span class="tok-o">();</span>
<span class="tok-n">empleado</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">merge</span><span class="tok-o">(</span><span class="tok-n">empleado</span><span class="tok-o">);</span>
<span class="tok-n">empleado</span><span class="tok-o">.</span><span class="tok-na">setSueldo</span><span class="tok-o">(</span><span class="tok-mf">20000.0</span><span class="tok-o">);</span>
<span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">();</span>
<span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Es muy importante notar que no está permitido modificar la clave primaria de una entidad gestionada. Si intentamos hacerlo, en el momento de hacer un commit la transacción lanzará una excepción <code>RollbackException</code>. Para reforzar esta idea, es conveniente definir las entidades sin un método <code>set</code> de la clave primaria. En el caso de aquellas entidades con una generación automática de la clave primaria, ésta se generará en tiempo de creación de la entidad. Y en el caso en que la aplicación tenga que proporcionar la clave primaria, lo puede hacer en el constructor.</p>
</div>
</div>
<div class="sect3">
<h4 id="_remove_para_borrar_entidades">2.2.4. Remove para borrar entidades</h4>
<div class="paragraph">
<p>Un borrado de una entidad realiza una sentencia <code>DELETE</code> en la base de datos. Esta acción no es demasiado frecuente, ya que las aplicaciones de gestión normalmente conservan todos los datos obtenidos y marcan como no activos aquellos que quieren dejar fuera de vista de los casos de uso. Se suele utilizar para eliminar datos que se han introducido por error en la base de datos o para trasladar de una tabla a otra los datos (se borra el dato de una y se inserta en la otra). En el caso de entidades esto último sería equivalente a un cambio de tipo de una entidad.</p>
</div>
<div class="paragraph">
<p>Para eliminar una entidad, la entidad debe estar gestionada, esto es, debe existir en el contexto de persistencia. Esto significa que la aplicación debe obtener la entidad antes de eliminarla. Un ejemplo sencillo es:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">Empleado</span> <span class="tok-n">empleado</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Empleado</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">1L</span><span class="tok-o">);</span>
<span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">remove</span><span class="tok-o">(</span><span class="tok-n">emp</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La llamada a <code>remove</code> asume que el empleado existe. En el caso de no existir se lanzaría una excepción.</p>
</div>
<div class="paragraph">
<p>Borrar una entidad no es una tarea compleja, pero puede requerir algunos pasos, dependiendo del número de relaciones en la entidad que vamos a borrar. En su forma más simple, el borrado de una entidad se realiza pasando la entidad como parámetro del método <code>remove()</code> del entity manager que la gestiona. En el momento en que el contexto de persistencia se sincroniza con una transacción y se realiza un commit, la entidad se borra. Hay que tener cuidado, sin embargo, con las relaciones en las que participa la entidad para no comprometer la integridad de la base de datos.</p>
</div>
<div class="paragraph">
<p>Veamos un sencillo ejemplo. Consideremos las entidades <code>Empleado</code> y <code>Despacho</code> y supongamos una relación unidireccional uno-a-uno entre <code>Empleado</code> y <code>Despacho</code> que se mapea utilizando una clave ajena en la tabla <code>EMPLEADO</code> hacia la tabla <code>DESPACHO</code> (lo veremos en la sesión siguiente).  Supongamos el siguiente código dentro de una transacción en el que borramos el despacho de un empleado:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">Empleado</span> <span class="tok-n">emp</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Empleado</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">1L</span><span class="tok-o">);</span>
<span class="tok-n">Despacho</span> <span class="tok-n">desp</span> <span class="tok-o">=</span> <span class="tok-n">emp</span><span class="tok-o">.</span><span class="tok-na">getDespacho</span><span class="tok-o">();</span>
<span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">remove</span><span class="tok-o">(</span><span class="tok-n">desp</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cuando se realice un commit de la transacción veremos una sentencia <code>DELETE</code> en la tabla <code>DESPACHO</code>, pero en ese momento obtendremos una excepción con un error de la base de datos referido a que hemos violado una restricción de la clave ajena. Esto se debe a que existe una restricción de integridad referencial entre la tabla <code>EMPLEADO</code> y la tabla <code>DESPACHO</code>. Se ha borrado una fila de la tabla <code>DESPACHO</code> pero la clave ajena correspondiente en la tabla <code>EMPLEADO</code> no se ha puesto a <code>NULL</code>. Para corregir el problema, debemos poner explícitamente a <code>null</code> el atributo <code>despacho</code> de la entidad <code>Empleado</code> antes de que la transacción finalice:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">Empleado</span> <span class="tok-n">empleado</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Empleado</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">3L</span><span class="tok-o">);</span>
<span class="tok-n">Despacho</span> <span class="tok-n">desp</span> <span class="tok-o">=</span> <span class="tok-n">empleado</span><span class="tok-o">.</span><span class="tok-na">getDespacho</span><span class="tok-o">();</span>
<span class="tok-n">empleado</span><span class="tok-o">.</span><span class="tok-na">setDespacho</span><span class="tok-o">(</span><span class="tok-kc">null</span><span class="tok-o">);</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1">
<span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">remove</span><span class="tok-o">(</span><span class="tok-n">desp</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1"></td>
<td>Eliminamos la clave ajena hacia el despacho poniendo un <code>null</code> en el atributo.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El mantenimiento de las relaciones es una responsabilidad de la aplicación. Casi todos los problemas que suceden en los borrados de entidades tienen relación con este aspecto. Si la entidad que se va a borrar es el objetivo de una clave ajena en otras tablas, entonces debemos limpiar esas claves ajenas antes de borrar la entidad.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_operaciones_en_cascada">2.3. Operaciones en cascada</h3>
<div class="paragraph">
<p>Por defecto, las operaciones del entity manager se aplican únicamente a las entidades proporcionadas como argumento. La operación no se propagará a otras entidades que tienen relación con la entidad que se está modificando. Lo hemos visto antes con la llamada a <code>remove()</code>. Pero no sucede lo mismo con operaciones como <code>persist()</code>. Es bastante probable que si tenemos una entidad nueva y tiene una relación con otra entidad, las dos deben persistir juntas.</p>
</div>
<div class="paragraph">
<p>Consideremos la secuencia de operaciones del siguiente códgo que muestran cómo se crea un nuevo <code>Empleado</code> con una entidad <code>Direccion</code> asociada y cómo se hacen los dos persistentes. La segunda llamada a <code>persist()</code> sobre la <code>Direccion</code> es algo redundante. Una entidad <code>Direccion</code> se acopla a la entidad <code>Empleado</code> que la almacena y tiene sentido que siempre que se cree un nuevo <code>Empleado</code>, se propague en cascada la llamada a <code>persist()</code> para la <code>Direccion</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">Empleado</span> <span class="tok-n">emp</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Empleado</span><span class="tok-o">(</span><span class="tok-mi">12</span><span class="tok-o">,</span> <span class="tok-s">&quot;Rob&quot;</span><span class="tok-o">);</span>
<span class="tok-n">Direccion</span> <span class="tok-n">dir</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Direccion</span><span class="tok-o">(</span><span class="tok-s">&quot;Alicante&quot;</span><span class="tok-o">);</span>
<span class="tok-n">emp</span><span class="tok-o">.</span><span class="tok-na">setDireccion</span><span class="tok-o">(</span><span class="tok-n">dir</span><span class="tok-o">);</span>
<span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">persist</span><span class="tok-o">(</span><span class="tok-n">emp</span><span class="tok-o">);</span>
<span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">persist</span><span class="tok-o">(</span><span class="tok-n">dir</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El API JPA proporciona un mecanismo para definir cuándo operaciones como <code>persist()</code> deben propagarse en cascada. Para ello se define el elemento <code>cascade</code> en todas las anotaciones de relaciones (<code>@OneToOne</code>, <code>@OneToMany</code>, <code>@ManyToOne</code> y <code>@ManyToMany</code>).</p>
</div>
<div class="paragraph">
<p>Las operaciones a las que hay que aplicar la propagación se identifican utilizando el tipo enumerado <code>CasacadeType</code>, que puede tener como valor <code>PERSIST</code>, <code>REFRESH</code>, <code>REMOVE</code>, <code>MERGE</code> y <code>ALL</code>.</p>
</div>
<div class="sect3">
<h4 id="_persist_en_cascada">2.3.1. Persist en cascada</h4>
<div class="paragraph">
<p>Para activar la propagación de la persistencia en cascada debemos añadir el elemento <code>cascade=CascadeType.PERSIST</code> en la declaración de la relación. Por ejemplo, en el caso anterior, si hemos definido una relación muchos-a-uno entre <code>Empleado</code> y <code>Direccion</code>, podemos escribir el siguiente código:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
   <span class="tok-o">...</span>
   <span class="tok-nd">@ManyToOne</span><span class="tok-o">(</span><span class="tok-n">cascadeCascdeType</span><span class="tok-o">.</span><span class="tok-na">PERSIST</span><span class="tok-o">)</span>
   <span class="tok-n">Direccion</span> <span class="tok-n">direccion</span><span class="tok-o">;</span>
   <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para invocar la persistencia en cascada sólo nos tenemos que asegurar de que la nueva entidad <code>Direccion</code> se ha puesto en el atributo <code>direccion</code> del <code>Empleado</code> antes de llamar a <code>persist()</code> con él. La definición de la operación en cascada es unidireccional, y tenemos que tener en cuenta quién es el propietario de la relación y dónde se va a actualizar la misma antes de tomar la decisión de poner el elemento en ambos lados. Por ejemplo, en el caso anterior cuando definamos un nuevo empleado y una nueva dirección pondremos la dirección en el empleado, por lo que el elemento <code>cascade</code> tendremos que definirlo únicamente en la relación anterior.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/note.png" alt="Note">
</td>
<td class="content">
Aunque JPA define esta forma de crear y hacer persistentes en cascada las entidades, no es una característica demasiado utilizada. La mayoría de las ocasiones tendremos ya las entidades hechas persistentes por una llamada previa al método persist.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_borrado_en_cascada">2.3.2. Borrado en cascada</h4>
<div class="paragraph">
<p>A primera vista, la utilización de un borrado en cascada puede parecer atractiva. Dependiendo de la cardinalidad de la relación podría eliminar la necesidad de eliminar múltiples instancias de entidad. Sin embargo, aunque es un elemento muy interesante, debe utilizarse con cierto cuidado. Hay sólo dos situaciones en las que un <code>remove()</code> en cascada se puede usar sin problemas: relaciones uno-a-uno y uno-a-muchos en donde hay una clara relación de propiedad y la eliminación de la instancia propietaria debe causar la eliminación de sus instancias dependientes. No puede aplicarse ciegamente a todas las relaciones uno-a-uno o uno-a-muchos porque las entidades dependientes podrían también estar participando en otras relaciones o podrían tener que continuar en la base de datos como entidades aisladas.</p>
</div>
<div class="paragraph">
<p>Habiendo realizado el aviso, veamos qué sucede cuando se realiza una operación de <code>remove()</code> en cascada. Si una entidad <code>Empleado</code> se elimina, no tiene sentido eliminar el despacho (seguirá existiendo) pero sí sus cuentas de correo (suponiendo que le corresponde más de una). El siguiente código muestra cómo definimos este comportamiento:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
   <span class="tok-o">...</span>
   <span class="tok-nd">@OneToOne</span><span class="tok-o">(</span><span class="tok-n">cascade</span><span class="tok-o">={</span><span class="tok-n">CascadeType</span><span class="tok-o">.</span><span class="tok-na">PERSIST</span><span class="tok-o">})</span>
   <span class="tok-n">Despacho</span> <span class="tok-n">despacho</span><span class="tok-o">;</span>
   <span class="tok-nd">@OneToMany</span><span class="tok-o">(</span><span class="tok-n">mappedBy</span><span class="tok-o">=</span><span class="tok-s">&quot;empleado&quot;</span><span class="tok-o">,</span>
             <span class="tok-n">cascade</span><span class="tok-o">={</span><span class="tok-n">CascadeType</span><span class="tok-o">.</span><span class="tok-na">PERSIST</span><span class="tok-o">,</span> <span class="tok-n">CascadeType</span><span class="tok-o">.</span><span class="tok-na">REMOVE</span><span class="tok-o">})</span>
   <span class="tok-n">Collection</span><span class="tok-o">&lt;</span><span class="tok-n">CuentaCorreo</span><span class="tok-o">&gt;</span> <span class="tok-n">cuentasCorreo</span><span class="tok-o">;</span>
   <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cuando se llama al método <code>remove()</code> el entity manager navegará por las relaciones entre el empleado y sus cuentas de correo e irá eliminando todas las instancias asociadas al empleado.</p>
</div>
<div class="paragraph">
<p>Hay que hacer notar que este borrado en cascada afecta sólo a la base de datos y que no tiene ningún efecto en las relaciones en memoria entre las instancias en el contexto de persistencia. Cuando la instancia de <code>Empleado</code> se desconecte de la base de datos, su colección de cuentas de correo contendrá las mismas instancias de <code>CuentaCorreo</code> que tenía antes de llamar a la operación <code>remove()</code>. Incluso la misma instancia de <code>Empleado</code> seguirá existiendo, pero desconectada del contexto de persistencia.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_queries">2.4. Queries</h3>
<div class="paragraph">
<p>Uno de los aspectos fundamentales de JPA es la posibilidad de realizar consultas sobre las entidades, muy similares a las consultas SQL. El lenguaje en el que se realizan las consultas se denomina <em>Java Persistence Query Language</em> (JPQL). Desde la versión 2.0 de JPA es posible también utilizar el API Criteria que permite la detección de errores de sintaxis en la construcción de las consultas. Lo veremos más adelante.</p>
</div>
<div class="paragraph">
<p>Una consulta se implementa mediante un objeto <code>Query</code>. Los objetos <code>Query</code> se construyen utilizando el <code>EntityManager</code> como una factoría. La interfaz <code>EntityManager</code> proporciona un conjunto de métodos que devuelven un objeto <code>Query</code> nuevo. Veremos algún ejemplo ahora, pero profundizaremos en el tema más adelante.</p>
</div>
<div class="paragraph">
<p>Una consulta puede ser estática o dinámica. Las consultas estáticas se definen con metadatos en forma de anotaciones o XML, y deben incluir la consulta propiamente dicha y un nombre asignado por el usuario. Este tipo de consulta se denomina una consulta con nombre (<em>named query</em> en inglés). El nombre se utiliza en tiempo de ejecución para recuperar la consulta.</p>
</div>
<div class="paragraph">
<p>Una consulta dinámica puede lanzarse en tiempo de ejecución y no es necesario darle un nombre, sino especificar únicamente las condiciones. Son un poco más costosas de ejecutar, porque el proveedor de persistencia (el gestor de base de datos) no puede realizar ninguna preparación, pero son muy útiles y versátiles porque pueden construirse en función de la lógica del programa, o incluso de los datos proporcionados por el usuario.</p>
</div>
<div class="paragraph">
<p>El siguiente código muestra un ejemplo de consulta dinámica:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">Query</span> <span class="tok-n">query</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">createQuery</span><span class="tok-o">(</span><span class="tok-s">&quot;SELECT e FROM Empleado e &quot;</span> <span class="tok-o">+</span>
                             <span class="tok-s">&quot;WHERE e.sueldo &gt; :sueldo&quot;</span><span class="tok-o">);</span>
<span class="tok-n">query</span><span class="tok-o">.</span><span class="tok-na">setParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;sueldo&quot;</span><span class="tok-o">,</span> <span class="tok-mi">20000</span><span class="tok-o">);</span>
<span class="tok-n">List</span> <span class="tok-n">emps</span> <span class="tok-o">=</span> <span class="tok-n">query</span><span class="tok-o">.</span><span class="tok-na">getResultList</span><span class="tok-o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En el ejemplo vemos que, al igual que en JDBC, es posible especificar consultas con parámetros y posteriormente especificar esos parámetros con el método <code>setParameter()</code>. Una vez definida la consulta, el método <code>getResultList()</code> devuelve la lista de entidades que cumplen la condición. Este método devuelve un objeto que implementa la interfaz <code>List</code>, una subinterfaz de <code>Collection</code> que soporta ordenación. Hay que notar que no se devuelve una <code>List&lt;Empleado&gt;</code> ya que no se pasa ninguna clase en la llamada y no es posible parametrizar el tipo devuelto. Sí que podemos hacer un casting en los valores devueltos por los métodos que implementan las búsquedas, como muestra el siguiente código:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Empleado</span><span class="tok-o">&gt;</span> <span class="tok-nf">findEmpleadosSueldo</span><span class="tok-o">(</span><span class="tok-kt">long</span> <span class="tok-n">sueldo</span><span class="tok-o">)</span> <span class="tok-o">{</span>
   <span class="tok-n">Query</span> <span class="tok-n">query</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">createQuery</span><span class="tok-o">(</span><span class="tok-s">&quot;SELECT e FROM Empleado e &quot;</span> <span class="tok-o">+</span>
                             <span class="tok-s">&quot;WHERE e.sueldo &gt; :sueldo&quot;</span><span class="tok-o">);</span>
   <span class="tok-n">query</span><span class="tok-o">.</span><span class="tok-na">setParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;sueldo&quot;</span><span class="tok-o">,</span> <span class="tok-mi">20000</span><span class="tok-o">);</span>
   <span class="tok-k">return</span> <span class="tok-o">(</span><span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Empleado</span><span class="tok-o">&gt;)</span> <span class="tok-n">query</span><span class="tok-o">.</span><span class="tok-na">getResultList</span><span class="tok-o">();</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_operaciones_sobre_el_contexto_de_persistencia">2.5. Operaciones sobre el contexto de persistencia</h3>
<div class="paragraph">
<p>Una cuestión muy importante para entender el funcionamiento del <em>entity manager</em> es comprender el funcionamiento de las operaciones que gestionan el contexto de persistencia. Hemos dicho que el contexto de persistencia es la colección de entidades gestionadas por el <em>entity manager</em>, entidades que están conectadas y sincronizadas con la base de datos. Cuando el <em>entity manager</em> cierra una transacción, genera las sentencias SQL necesarias para que el estado de estas entidades se vuelque a la base de datos. Es fundamental entender que el contexto de persistencia hace el papel de <em>caché</em> de las entidades que están en la base de datos. Cuando actualizamos una instancia en el contexto de persistencia estamos actualizando una caché, una copia que sólo se hace persistente en la base de datos cuando el entity manager realiza un <em>flush</em> de las instancias en la base de datos.</p>
</div>
<div class="paragraph">
<p>Simplificando bastante, el entity manager realiza el siguiente proceso para todas las entidades:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Si la aplicación solicita una entidad (mediante un <code>find</code>, o accediendo a un atributo de otra entidad en una relación), se comprueba si ya se encuentra en el contexto de persistencia. Si es así, se devuelve su referencia. Si no se ha recuperado previamente, se obtiene la instancia de la entidad de la base de datos.</p>
</li>
<li>
<p>La aplicación utiliza las entidades del contexto de persistencia, accediendo a sus atributos y (posiblemente) modificándolos. Todas las modificaciones se realizan en la memoria, en el contexto de persistencia.</p>
</li>
<li>
<p>En un momento dado (cuando termina la transacción, se ejecuta una query o se hace una llamada al método <code>flush</code>) el entity manager comprueba qué entidades han sido modificadas y vuelca los cambios a la base de datos.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Es muy importante darse cuenta de la diferencia entre el contexto de persistencia y la base de datos propiamente dicha. La sincronización no se realiza hasta que el entity manager vuelca los cambios a la base de datos. La aplicación debe ser consciente de esto y utilizar razonablemente los contextos de persistencia.</p>
</div>
<div class="paragraph">
<p>Vamos a ver con algún detalle las operaciones del <em>entity manager</em> relacionadas con el contexto de persistencia:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>flush()</code> sincroniza el contexto de persistencia con la base de datos</p>
</li>
<li>
<p><code>detach()</code> desconecta una entidad del contexto de persistencia</p>
</li>
<li>
<p><code>merge()</code> mezcla una entidad desconectada en el contexto de persistencia actual</p>
</li>
<li>
<p><code>refresh()</code> refresca el estado de una entidad con los valores de la base de datos, sobreescribiendo sus cambios en memoria</p>
</li>
<li>
<p><code>clear()</code> y <code>close()</code> vacían el contexto de persistencia y lo desconectan de la base de datos</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_sincronización_con_la_base_de_datos_con_code_flush_code">2.5.1. Sincronización con la base de datos con <code>flush</code></h4>
<div class="paragraph">
<p>Cada vez que el proveedor de persistencia genera sentencias SQL y las escribe en la base de datos a través de una conexión JDBC, decimos que se ha volcado (<em>flush</em>) el contexto de persistencia. Todos los cambios pendientes que requieren que se ejecute una sentencia SQL en la transacción se escriben en la base de datos cuando ésta realiza un commit. Esto significa que cualquier operación SQL que tenga lugar después de haberse realizado el volcado ya incorporará estos cambios. Esto es particularmente importante para consultas SQL que se ejecutan en una transacción que también está realizando cambios en los datos de la entidad.</p>
</div>
<div class="paragraph">
<p>¿Qué sucede exactamente cuando se realiza un volcado del contexto de persistencia? Un volcado consiste básicamente en tres componentes: entidades nuevas que necesitan hacerse persistentes, entidades modificadas que necesitan ser actualizadas y entidades borradas que deben ser eliminadas de la base de datos. Toda esta información es gestionada por el contexto de persistencia.</p>
</div>
<div class="paragraph">
<p>Cuando ocurre un volcado, el entity manager itera primero sobre las entidades gestionadas y busca nuevas entidades que se han añadido a las relaciones y que tienen activada la opción de persistencia en cascada. Esto es equivalente lógicamente a invocar a <code>persist()</code> con cada una de las entidades gestionadas antes de que se realice el volcado. El entity manager también comprueba la integridad de todas las relaciones. Si una entidad apunta a otra que no está gestionada o que ha sido eliminada, entonces se puede lanzar una excepción.</p>
</div>
<div class="paragraph">
<p>Si en el proceso de volcado alguno de los objetos a los que apunta la instancia que estamos haciendo persistente no está gestionado, no tiene el atributo de persistencia en cascada y no está incluido en una relación uno-a-uno o muchos-a-uno entonces se lanzará una excepción <code>IllegalStateException</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_desconexión_de_entidades">2.5.2. Desconexión de entidades</h4>
<div class="paragraph">
<p>Como resultado de una consulta o de una relación, obtendremos una colección de entidades que deberemos tratar, pasar a otras capas de la aplicación y, en una aplicación web, mostrar en una página JSP o JSF. En este apartado vamos a ver cómo trabajar con las entidades obtenidas y vamos a reflexionar sobre su desconexión del contexto de persistencia.</p>
</div>
<div class="paragraph">
<p>Una entidad desconectada (<em>detached entity</em> en inglés) es una entidad que ya no está asociada a un contexto de persistencia. En algún momento estuvo gestionada, pero el contexto de persistencia puede haber terminado, o la entidad puede haberse transformado de forma que ha perdido su asociación con el contexto de persistencia que la gestionaba. Cualquier cambio que se realice en el estado de la entidad no se hará persistente en la base de datos, pero todo el estado que estaba en la entidad antes de desconectarse sigue estando ahí para ser usado por la aplicación.</p>
</div>
<div class="paragraph">
<p>Hay dos formas de ver la desconexión de entidades. Por una parte, es una herramienta poderosa que puede utilizarse por las aplicaciones para trabajar con aplicaciones remotas o para soportar el acceso a los datos de la entidad mucho después de que la transacción ha concluido. Además, son objetos que pueden hacer el papel de DTOs (<em>Data Transfer Objets</em>) y ser devueltos por la capa de lógica de negocio y utilizados por la capa de presentación. La otra posible interpretación es que puede ser una fuente de problemas frustrantes cuando las entidades contienen una gran cantidad de atributos que se cargan de forma perezosa y los clientes que usan estas entidades desconectadas necesitan acceder a esta información.</p>
</div>
<div class="paragraph">
<p>Existen muchas condiciones en las que una entidad se convierte en desconectada. Cada una de las situaciones siguientes generarán entidades desconectadas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Cuando el contexto de persistencia se cierra con una llamada a <code>close()</code> del entity manager</p>
</li>
<li>
<p>Cuando se llama al método <code>clear()</code> del entity manager</p>
</li>
<li>
<p>Cuando se produce un rollback de la transacción</p>
</li>
<li>
<p>Cuando una entidad se serializa</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Todos los casos se refieren a contextos de persistencias gestionados por la aplicación (Java SE y aplicaciones web sin contenedor de EJB).</p>
</div>
<div class="sect4">
<h5 id="_recuperación_lazy_y_eager_de_las_entidades_relacionadas">Recuperación LAZY y EAGER de las entidades relacionadas</h5>
<div class="paragraph">
<p>Una característica que hace muy cómoda la programación con JPA es la recuperación de todo el grafo de relaciones asociado a una entidad. Cuando el <em>entity manager</em> trae a memoria entidades (como resultado de una consulta o de una llamada a <code>find</code>) también trae todas aquellas entidades relacionadas. De esta forma podemos acceder a las entidades relacionadas a través de llamadas a los <em>getters</em>. Sin embargo, no todas las entidades relacionadas se traen realmente a memoria. En muchos casos, por motivos de eficiencia, lo que JPA guarda en el <em>getter</em> no es la propia entidad sino un <em>proxy</em> que generará una consulta a la base de datos cuando se acceda a él. Es lo que se denomina <em>carga perezosa</em> (<em>lazy loading</em>).</p>
</div>
<div class="paragraph">
<p>Podemos definir el tipo de carga que queremos marcando las relaciones con los atributos <code>EAGER</code> o <code>LAZY</code>. Por defecto las relaciones a-uno son de tipo <em>eager</em> y las a-muchos de tipo <em>lazy</em>.</p>
</div>
<div class="paragraph">
<p>Es fundamental saber si un atributo se ha traído a memoria o si está cargado de forma perezosa cuando se realiza una desconexión del contexto de persistencia, por ejemplo cuando se cierra el <em>entity manager</em>. Veamos un ejemplo. Supongamos que tenemos la siguiente definición de <code>Empleado</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
    <span class="tok-nd">@Id</span>
    <span class="tok-nd">@GeneratedValue</span>
    <span class="tok-kd">private</span> <span class="tok-n">Long</span> <span class="tok-n">id</span><span class="tok-o">;</span>

    <span class="tok-o">...</span>

    <span class="tok-nd">@OneToMany</span><span class="tok-o">(</span><span class="tok-n">mappedBy</span> <span class="tok-o">=</span> <span class="tok-s">&quot;empleado&quot;</span><span class="tok-o">,</span> <span class="tok-n">fetch</span> <span class="tok-o">=</span> <span class="tok-n">FetchType</span><span class="tok-o">.</span><span class="tok-na">EAGER</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">CuentaCorreo</span><span class="tok-o">&gt;</span> <span class="tok-n">correos</span><span class="tok-o">;</span>

   <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Todos los elementos de la relación <code>correos</code> se cargarán en memoria al recupar un empleado, aunque no accedamos a ellos. De esta forma, si el entity manager se cierra, tendremos acceso a la colección:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-c1">// Cargamos una entidad y cerramos la conexión</span>
<span class="tok-c1">// del entity manager</span>
<span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
<span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">begin</span><span class="tok-o">();</span>
<span class="tok-n">Empleado</span> <span class="tok-n">empleado</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Empleado</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">1L</span><span class="tok-o">);</span>
<span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">();</span>
<span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>

<span class="tok-c1">// Comprobamos que los correos se han cargado en memoria</span>
<span class="tok-c1">// por ser el tipo Eager Fetch</span>

<span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">empleado</span><span class="tok-o">.</span><span class="tok-na">getCorreos</span><span class="tok-o">().</span><span class="tok-na">size</span><span class="tok-o">()==</span><span class="tok-mi">2</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El comportamento del acceso a atributos no cargados cuando la entidad está desconectada no está definido en la especificación. Algunas implemenentaciones pueden intentar resolver la relación, mientras que otros simplemente lanzan una excepción y dejan el atributo sin inicializar. En el caso de Hibernate, se lanza una excepción de tipo <code>org.hibernate.LazyInitializationException</code>. Si la entidad ha sido desconectada debido a una serialización entonces no hay virtualmente ninguna esperanza de resolver la relación. La única forma portable de gestionar estos casos es no utilizando estos atributos.</p>
</div>
<div class="paragraph">
<p>En el caso en el que las entidades no tengan atributos de carga perezosa, no debe haber demasiados problemas con la desconexión. Todo el estado de la entidad estará todavía disponible para su uso en la entidad.</p>
</div>
<div class="paragraph">
<p>Si las relaciones a-muchos no tienen un número demasiado elevado de elementos es recomendable definirlas de tipo <code>EAGER</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_merge">2.5.3. Merge</h4>
<div class="paragraph">
<p>El método merge() permite volver a incorporar en el contexto de persistencia del entity manager una entidad que había sido desconectada. Debemos pasar como parámetro la entidad que queremos incluir. Hay que tener cuidado con su utilización, porque el objeto que se pasa como parámetro no pasa a ser gestionado. Hay que usar el objeto que devuelve el método. Un ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">subeSueldo</span><span class="tok-o">(</span><span class="tok-n">Empleado</span> <span class="tok-n">emp</span><span class="tok-o">,</span> <span class="tok-kt">long</span> <span class="tok-n">inc</span><span class="tok-o">)</span>
   <span class="tok-n">Empleado</span> <span class="tok-n">empGestionado</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">merge</span><span class="tok-o">(</span><span class="tok-n">emp</span><span class="tok-o">);</span>
   <span class="tok-n">empGestionado</span><span class="tok-o">.</span><span class="tok-na">setSueldo</span><span class="tok-o">(</span><span class="tok-n">empGestionado</span><span class="tok-o">.</span><span class="tok-na">getSueldo</span><span class="tok-o">()+</span><span class="tok-n">inc</span><span class="tok-o">);</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si una entidad con el mismo identificador que <code>emp</code> existe en el contexto de persistencia, se devuelve como resultado y se actualizan sus atributos. Si el objeto que se le pasa a <code>merge()</code> es un objeto nuevo, se comporta igual que <code>persist()</code>, con la única diferencia de que la entidad gestionada es la devuelta como resultado de la llamada.</p>
</div>
<div class="sect4">
<h5 id="_clear">Clear</h5>
<div class="paragraph">
<p>En ocasiones puede ser necesario limpiar (<code>clear</code>) contexto de persistencia y vaciar las entidades gestiondas. Esto puede suceder, por ejemplo, en conextos extendidos gestionados por la aplicación que han crecido demasiado. Por ejemplo, consideremos el caso de un entity manager gestionado por la aplicación que lanza una consulta que devuelve varios cientos de instancias entidad. Una vez que ya hemos realizado los cambios a unas cuantas de esas instancias y la transacción se termina, se quedan en memoria cientos de objetos que no tenemos intención de cambiar más. Si no queremos cerrar el contexto de persistencia en ese momento, entonces tendremos que limpiar de alguna forma las instancias gestionadas, o el contexto de persistencia irá creciendo cada vez más.</p>
</div>
<div class="paragraph">
<p>El método <code>clear()</code> del interfaz <code>EntityManager</code> se utiliza para limpiar el contexto de persistencia. En muchos sentidos su funcionamiento es similar a un rollback de una transacción en memoria. Todas las instancias gestionadas por el contexto e persistencia se desconectan del contexto y quedan con el estado previo a la llamada a <code>clear()</code>. La operación <code>clear()</code> es del tipo todo o nada. No es posible cancelar selectivamente la gestión de una instancia particular cuando el contexto de persistencia está abierto.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_actualización_de_las_colecciones_en_las_relaciones_a_muchos">2.5.4. Actualización de las colecciones en las relaciones a-muchos</h4>
<div class="paragraph">
<p>En una relación uno-a-muchos el campo que mantiene la colección es un <em>proxy</em> que nos permite acceder a los elementos propiamente dichos, pero sólo si la entidad está gestionada. Hay que tener cuidado porque si la parte inversa de la relación se actualiza con un nuevo elemento, JPA no tiene forma de saberlo por si solo. La aplicación debe actualizar la colección también.</p>
</div>
<div class="paragraph">
<p>Veamos un ejemplo. Supongamos que tenemos la relación uno-a-muchos entre <code>AutorEntity</code> y <code>MensajeEntity</code> definida en la sesión anterior, que la entidad <code>MensajeEntity</code> contiene la clave ajena hacia <code>AutorEntity</code> y que la aplicación ejecuta el siguiente código para añadir un mensaje a un autor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">begin</span><span class="tok-o">();</span>
<span class="tok-n">AutorEntity</span> <span class="tok-n">autor</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">AutorEntity</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">1L</span><span class="tok-o">);</span>
<span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">getNombre</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-s">&quot; ha escrito &quot;</span> <span class="tok-o">+</span>
                <span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">getMensajes</span><span class="tok-o">().</span><span class="tok-na">size</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-s">&quot; mensajes&quot;</span><span class="tok-o">);</span>
<span class="tok-n">Mensaje</span> <span class="tok-n">mens</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Mensaje</span><span class="tok-o">(</span><span class="tok-s">&quot;Nuevo mensaje&quot;</span><span class="tok-o">);</span>
<span class="tok-n">mens</span><span class="tok-o">.</span><span class="tok-na">setAutor</span><span class="tok-o">(</span><span class="tok-n">autor</span><span class="tok-o">);</span>
<span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">persist</span><span class="tok-o">(</span><span class="tok-n">mens</span><span class="tok-o">);</span>
<span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">();</span>
<span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">getNombre</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-s">&quot; ha escrito &quot;</span> <span class="tok-o">+</span>
                <span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">getMensajes</span><span class="tok-o">().</span><span class="tok-na">size</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-s">&quot; mensajes&quot;</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si comprobamos qué sucede veremos que no aparecerá ningún cambio entre el primer mensaje de la aplicación y el segundo, ambos mostrarán el mismo número de mensajes. ¿Por qué? ¿Es que no se ha actualizado el nuevo mensaje del autor en la base de datos?. Si miramos en la base de datos, comprobamos que la transacción sí que se ha completado correctamente. Sin embargo cuando llamamos al método <code>getMensajes()</code> en la colección resultante no aparece el nuevo mensaje que acabamos de añadir.</p>
</div>
<div class="paragraph">
<p>Este es un ejemplo del tipo de errores que podemos cometer por trabajar con contextos de persistencia pensando que estamos conectados directamente con la BD. El problema se encuentra en que la primera llamada a <code>getMensajes()</code> (antes de crear el nuevo mensaje) ha generado la consulta a la base de datos y ha cargado el resultado en memoria. Cuando hacemos una segunda llamada, el proveedor detecta que esa información ya la tiene en la caché y no la vuelve a consultar.</p>
</div>
<div class="paragraph">
<p>La aplicación es la responsable de actualizar las relaciones en memoria. Por eso hay que añadir manualmente el mensaje a la colección. Hay que hacerlo una vez que se ha hecho persistente el mensaje, para que su identicador autogenerado esté actualizado. Lo haríamos añadiendo al código anterior la línea que actualiza la colección:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">begin</span><span class="tok-o">();</span>
<span class="tok-n">Autor</span> <span class="tok-n">autor</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Autor</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">1L</span><span class="tok-o">);</span>
<span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">getNombre</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-s">&quot; ha escrito &quot;</span> <span class="tok-o">+</span>
                   <span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">getMensajes</span><span class="tok-o">().</span><span class="tok-na">size</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-s">&quot; mensajes&quot;</span><span class="tok-o">);</span>
<span class="tok-n">Mensaje</span> <span class="tok-n">mens</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Mensaje</span><span class="tok-o">(</span><span class="tok-s">&quot;Nuevo mensaje&quot;</span><span class="tok-o">);</span>
<span class="tok-n">mens</span><span class="tok-o">.</span><span class="tok-na">setAutor</span><span class="tok-o">(</span><span class="tok-n">autor</span><span class="tok-o">);</span>
<span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">persist</span><span class="tok-o">(</span><span class="tok-n">mens</span><span class="tok-o">);</span>
<span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">();</span>
<span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">getMensajes</span><span class="tok-o">().</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-n">mens</span><span class="tok-o">);</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1">
<span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">getNombre</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-s">&quot; ha escrito &quot;</span> <span class="tok-o">+</span>
                <span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">getMensajes</span><span class="tok-o">().</span><span class="tok-na">size</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-s">&quot; mensajes&quot;</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1"></td>
<td>La llamada al método <code>add()</code> de la colección añade un mensaje nuevo a la colección de mensajes del autor existente en el contexto de persistencia. De esta forma estamos reflejando en memoria lo que hemos realizado en la base de datos.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Otra posible solución (menos recomendable) es obligar al entity manager a que sincronice la entidad y la base de datos. Para ello podemos llamar al método <code>refresh()</code> del entity manager:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">begin</span><span class="tok-o">();</span>
<span class="tok-c1">// ... añado un mensaje al autor</span>
<span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">refresh</span><span class="tok-o">(</span><span class="tok-n">autor</span><span class="tok-o">);</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1">
<span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">();</span>
<span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">getNombre</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-s">&quot; ha escrito &quot;</span> <span class="tok-o">+</span>
                   <span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">getMensajes</span><span class="tok-o">().</span><span class="tok-na">size</span><span class="tok-o">()</span> <span class="tok-o">+</span>
                   <span class="tok-s">&quot; mensajes&quot;</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1"></td>
<td>La llamada al método <code>refresh</code> obliga a JPA a volver a hacer un <code>SELECT</code> la siguiente vez que se pida la colección <code>autor.getMensajes()</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Estos ejemplos ponen en evidencia que para trabajar bien con JPA es fundamental entender que el contexto de persistencia es una caché de la base de datos propiamente dicha.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_implementación_de_un_dao_con_jpa">2.6. Implementación de un DAO con JPA</h3>
<div class="paragraph">
<p>El patrón DAO (<em>Data Access Object</em>) se ha utilizado históricamente para ocultar los detalles de implementación de la capa de persistencia y ofrecer una interfaz más sencilla a otras partes de la aplicación. Esto es necesario cuando se trabaja con un API de persistencia de bajo nivel, como JDBC, en la que las operaciones sobre la base de datos conlleva la utilización de sentencias SQL que queremos aislar de otras capas de la aplicación.</p>
</div>
<div class="paragraph">
<p>Sin embargo, en desarrollos en los que utilizamos un API de persistencia de mayor nivel como JPA, la utilización de un patrón DAO no es tan necesaria. Muchos argumentan incluso que se trata de un <em>antipatrón</em>, un patrón que conviene evitar. No creemos que sea así, porque un patrón DAO bien diseñado y adaptado a JPA permite eliminar errores derivados de la mala utilización del contexto de persistencia y agrupar en una única clase todas las consultas relacionadas con una misma clase de dominio.</p>
</div>
<div class="paragraph">
<p>Presentamos a continuación una adaptación del <a href="http://kenai.com/projects/javaee-patterns/sources/hg/show/DAOPattern?rev=454">patrón DAO</a> propuesto por <a href="http://www.adam-bien.com">Adam Bien</a>, uno de los autores y expertos sobre Java EE más importantes en la actualidad.</p>
</div>
<div class="paragraph">
<p>Cada clase de entidad definirá una clase DAO en la que se definen los métodos CRUD sobre la entidad (<em>Create</em>, <em>Read</em>, <em>Update</em> y <em>Delete</em>), así como el <em>find</em> que devuelve la entidad a partir de su clave primaria. También definirán las consultas JPQL.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, el DAO de la clase <code>Autor</code> definiría los siguientes métodos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>create (Autor autor)</code>: recibe una variable <code>autor</code> no gestionada y devuelve una variable gestionada con la clave primaria actualizada</p>
</li>
<li>
<p><code>update (Autor autor)</code>: recibe una variable <code>autor</code> que puede no estar gestionada (pero ya está en la base de datos) y actualiza el valor de la base de datos con los valores de la variable</p>
</li>
<li>
<p><code>delete (Autor autor)</code>: borra la entidad <code>autor</code> de la base de datos</p>
</li>
<li>
<p><code>find (Long id)</code>: devuelve una entidad gestionada correspondiente a la clave primaria que se pasa como parámetro.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Todos estos métodos se deben implementar a través de un <em>entity manager</em> que habremos creado al comienzo del trabajo con los DAOs y le habremos pasado a los DAO en su creación. O sea que los DAO trabajarán con un <em>entity manager</em> y una transacción abierta, de forma que podremos englobar distintas operaciones de distintos DAOs en una misma transacción y un mismo contexto de persistencia.</p>
</div>
<div class="paragraph">
<p>La capa responsable de abrir la transacción y el <em>entity manager</em> será la capa que utiliza los DAO, la que implementa la lógica de negocio. Si se intenta llamar a cualquiera de los métodos del DAO sin que se haya abierto una transacción en el <em>entity manager</em> se deberá lanzar una excepción.</p>
</div>
<div class="paragraph">
<p>Vamos a definir todas las clases DAO en el paquete <code>persistencia</code> y las clases que usan los DAO para implementar la lógica de negocio en el paquete <code>service</code>.</p>
</div>
<div class="paragraph">
<p>La implementación concreta se especifica a continuación. Agrupamos todas las funciones CRUD comunes a todos los DAO en una clase abstracta genérica, que tiene como parámetro la entidad que va a gestionar y el tipo de su clave primaria de la entidad. En las aplicaciones JPA que utilicen este patrón se definirá una clase DAO específica por cada entidad que definamos.</p>
</div>
<div class="paragraph">
<p>Clase DAO genérica:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jpa</span><span class="tok-o">.</span><span class="tok-na">empleados</span><span class="tok-o">.</span><span class="tok-na">persistencia</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManager</span><span class="tok-o">;</span>

<span class="tok-kd">abstract</span> <span class="tok-kd">class</span> <span class="tok-nc">Dao</span><span class="tok-o">&lt;</span><span class="tok-n">T</span><span class="tok-o">,</span> <span class="tok-n">K</span><span class="tok-o">&gt;</span> <span class="tok-o">{</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1">
   <span class="tok-n">EntityManager</span> <span class="tok-n">em</span><span class="tok-o">;</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/2.png" alt="2">

   <span class="tok-kd">public</span> <span class="tok-nf">Dao</span><span class="tok-o">(</span><span class="tok-n">EntityManager</span> <span class="tok-n">em</span><span class="tok-o">)</span> <span class="tok-o">{</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/3.png" alt="3">
      <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">em</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">;</span>
   <span class="tok-o">}</span>

   <span class="tok-kd">public</span> <span class="tok-n">EntityManager</span> <span class="tok-nf">getEntityManager</span><span class="tok-o">()</span> <span class="tok-o">{</span>
      <span class="tok-k">return</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">em</span><span class="tok-o">;</span>
   <span class="tok-o">}</span>

   <span class="tok-kd">public</span> <span class="tok-n">T</span> <span class="tok-nf">create</span><span class="tok-o">(</span><span class="tok-n">T</span> <span class="tok-n">t</span><span class="tok-o">)</span> <span class="tok-o">{</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/4.png" alt="4">
      <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">persist</span><span class="tok-o">(</span><span class="tok-n">t</span><span class="tok-o">);</span>
      <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">flush</span><span class="tok-o">();</span>
      <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">refresh</span><span class="tok-o">(</span><span class="tok-n">t</span><span class="tok-o">);</span>
      <span class="tok-k">return</span> <span class="tok-n">t</span><span class="tok-o">;</span>
   <span class="tok-o">}</span>

   <span class="tok-kd">public</span> <span class="tok-n">T</span> <span class="tok-nf">update</span><span class="tok-o">(</span><span class="tok-n">T</span> <span class="tok-n">t</span><span class="tok-o">)</span> <span class="tok-o">{</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/5.png" alt="5">
      <span class="tok-k">return</span> <span class="tok-o">(</span><span class="tok-n">T</span><span class="tok-o">)</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">merge</span><span class="tok-o">(</span><span class="tok-n">t</span><span class="tok-o">);</span>
   <span class="tok-o">}</span>

   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">delete</span><span class="tok-o">(</span><span class="tok-n">T</span> <span class="tok-n">t</span><span class="tok-o">)</span> <span class="tok-o">{</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/6.png" alt="6">
      <span class="tok-n">t</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">merge</span><span class="tok-o">(</span><span class="tok-n">t</span><span class="tok-o">);</span>
      <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">remove</span><span class="tok-o">(</span><span class="tok-n">t</span><span class="tok-o">);</span>
   <span class="tok-o">}</span>

   <span class="tok-kd">public</span> <span class="tok-kd">abstract</span> <span class="tok-n">T</span> <span class="tok-nf">find</span><span class="tok-o">(</span><span class="tok-n">K</span> <span class="tok-n">id</span><span class="tok-o">);</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/7.png" alt="7">

<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1"></td>
<td>Definición de la clase abstracta genérica. Las clases <code>T</code> y <code>K</code> se corresponden con la clase de la entidad y la clase de la clave primaria.</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/2.png" alt="2"></td>
<td>Variable de instancia con el <em>entity manager</em> en el que vamos a utilizar el DAO</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/3.png" alt="3"></td>
<td>Creación del DAO en el que se le pasa el <em>entity manager</em> en el se van a realizar todas las operaciones</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/4.png" alt="4"></td>
<td><code>create</code>: se recibe un objeto entidad creado con los datos a hacer persistente y se llama a <code>persist()</code>, <code>flush()</code> y <code>refresh()</code> para hacer persistente la entidad y actualizar su clave primaria. Se devuelve la entidad gestionada.</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/5.png" alt="5"></td>
<td><code>update</code>: de realiza un <code>merge</code> de la entidad y se devuelve la entidad resultante, ya gestionada</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/6.png" alt="6"></td>
<td><code>delete</code>: se hace un <code>merge</code> (la entidad que se pasa puede estar desconectada) y se hace un <code>remove</code></td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/7.png" alt="7"></td>
<td><code>find</code>: se define como un método abstracto que se implementará en los DAOs concretos que extiendan esta clase abstracta genérica. Se define el perfil de la función: se devuelve la entidad con la clave primaria que buscamos o <code>null</code> si no la encuentra.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para cada clase entidad definiremos una clase DAO que extiende la clase anterior genérica. En esta clase DAO concreta se implementan también todas las consultas relacionadas con la entidad. Por ejemplo, a continuación vemos el ejemplo concreto de DAO <code>EmpleadoDao</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jpa</span><span class="tok-o">.</span><span class="tok-na">empleados</span><span class="tok-o">.</span><span class="tok-na">persistencia</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jpa.empleados.modelo.Empleado</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jpa.empleados.modelo.Proyecto</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManager</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.Query</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.List</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">EmpleadoDao</span> <span class="tok-kd">extends</span> <span class="tok-n">Dao</span><span class="tok-o">&lt;</span><span class="tok-n">Empleado</span><span class="tok-o">,</span> <span class="tok-n">Long</span><span class="tok-o">&gt;</span> <span class="tok-o">{</span>
    <span class="tok-n">String</span> <span class="tok-n">FIND_ALL_EMPLEADOS</span> <span class="tok-o">=</span> <span class="tok-s">&quot;SELECT e FROM Empleado e &quot;</span><span class="tok-o">;</span>

    <span class="tok-kd">public</span> <span class="tok-nf">EmpleadoDao</span><span class="tok-o">(</span><span class="tok-n">EntityManager</span> <span class="tok-n">em</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-kd">super</span><span class="tok-o">(</span><span class="tok-n">em</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-n">Empleado</span> <span class="tok-nf">find</span><span class="tok-o">(</span><span class="tok-n">Long</span> <span class="tok-n">id</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">getEntityManager</span><span class="tok-o">();</span>
        <span class="tok-k">return</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Empleado</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-n">id</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Empleado</span><span class="tok-o">&gt;</span> <span class="tok-nf">listAllEmpleados</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">getEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">Query</span> <span class="tok-n">query</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">createQuery</span><span class="tok-o">(</span><span class="tok-n">FIND_ALL_EMPLEADOS</span><span class="tok-o">);</span>
        <span class="tok-k">return</span> <span class="tok-o">(</span><span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Empleado</span><span class="tok-o">&gt;)</span> <span class="tok-n">query</span><span class="tok-o">.</span><span class="tok-na">getResultList</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Los DAO proporcionan métodos de un grano muy fino, un CRUD básico sobre las entidades de cada clase. Trabajan con entidades gestionadas por un mismo entorno de persistencia y en el código llamador hay que gestionar la transacción y el entity manager.</p>
</div>
<div class="paragraph">
<p>Es habitual definir clases de más nivel que contienen las operaciones de negocio en un paquete <code>servicio</code>. Las operaciones de negocio se definen como métodos de estas clases en los que se encapsulan las llamadas a los DAOs y todo el trabajo de las entidades gestionadas. Los métodos reciben identificadores y datos planos y devuelven objetos entidad <strong>desconectados de la base de datos</strong></p>
</div>
<div class="paragraph">
<p>Por ejemplo, podemos definir la clase <code>EmpleadoServicio</code> con los métodos de negocio:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>findPorId(Long idEmpleado)</code>: devuelve un empleadl</p>
</li>
<li>
<p><code>intercambiaDespachos(Long idEmpleado1, Long idEmpleado2)</code>: intercambia los despachos de dos empleados</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jpa.empleados.modelo.Despacho</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jpa.empleados.modelo.Empleado</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jpa.empleados.persistencia.EmpleadoDao</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManager</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManagerFactory</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">EmpleadoServicio</span> <span class="tok-o">{</span>

    <span class="tok-kd">private</span> <span class="tok-n">EntityManagerFactory</span> <span class="tok-n">emf</span><span class="tok-o">;</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setEmf</span><span class="tok-o">(</span><span class="tok-n">EntityManagerFactory</span> <span class="tok-n">emf</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">emf</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">Empleado</span> <span class="tok-nf">findPorId</span><span class="tok-o">(</span><span class="tok-n">Long</span> <span class="tok-n">idEmpleado</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">Empleado</span> <span class="tok-n">empleado</span> <span class="tok-o">=</span> <span class="tok-kc">null</span><span class="tok-o">;</span>
        <span class="tok-n">EmpleadoDao</span> <span class="tok-n">empleadoDao</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">EmpleadoDao</span><span class="tok-o">(</span><span class="tok-n">em</span><span class="tok-o">);</span>
        <span class="tok-k">try</span> <span class="tok-o">{</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">begin</span><span class="tok-o">();</span>
            <span class="tok-n">empleado</span> <span class="tok-o">=</span> <span class="tok-n">empleadoDao</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">idEmpleado</span><span class="tok-o">);</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">();</span>
        <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">Exception</span> <span class="tok-n">e</span><span class="tok-o">){</span>
            <span class="tok-n">e</span><span class="tok-o">.</span><span class="tok-na">printStackTrace</span><span class="tok-o">();</span>
        <span class="tok-o">}</span> <span class="tok-k">finally</span> <span class="tok-o">{</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
        <span class="tok-o">}</span>
        <span class="tok-k">return</span> <span class="tok-n">empleado</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">intercambiaDespachos</span><span class="tok-o">(</span><span class="tok-n">Long</span> <span class="tok-n">idEmpleado1</span><span class="tok-o">,</span> <span class="tok-n">Long</span> <span class="tok-n">idEmpleado2</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">EmpleadoDao</span> <span class="tok-n">empleadoDao</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">EmpleadoDao</span><span class="tok-o">(</span><span class="tok-n">em</span><span class="tok-o">);</span>
        <span class="tok-k">try</span> <span class="tok-o">{</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">begin</span><span class="tok-o">();</span>
            <span class="tok-n">Empleado</span> <span class="tok-n">emp1</span> <span class="tok-o">=</span> <span class="tok-n">empleadoDao</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">idEmpleado1</span><span class="tok-o">);</span>
            <span class="tok-n">Empleado</span> <span class="tok-n">emp2</span> <span class="tok-o">=</span> <span class="tok-n">empleadoDao</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">idEmpleado2</span><span class="tok-o">);</span>
            <span class="tok-n">Despacho</span> <span class="tok-n">despachoAux</span> <span class="tok-o">=</span> <span class="tok-n">emp1</span><span class="tok-o">.</span><span class="tok-na">getDespacho</span><span class="tok-o">();</span>
            <span class="tok-n">emp1</span><span class="tok-o">.</span><span class="tok-na">setDespacho</span><span class="tok-o">(</span><span class="tok-n">emp2</span><span class="tok-o">.</span><span class="tok-na">getDespacho</span><span class="tok-o">());</span>
            <span class="tok-n">emp2</span><span class="tok-o">.</span><span class="tok-na">setDespacho</span><span class="tok-o">(</span><span class="tok-n">despachoAux</span><span class="tok-o">);</span>
            <span class="tok-n">empleadoDao</span><span class="tok-o">.</span><span class="tok-na">update</span><span class="tok-o">(</span><span class="tok-n">emp1</span><span class="tok-o">);</span>
            <span class="tok-n">empleadoDao</span><span class="tok-o">.</span><span class="tok-na">update</span><span class="tok-o">(</span><span class="tok-n">emp2</span><span class="tok-o">);</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">();</span>
        <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">Exception</span> <span class="tok-n">e</span><span class="tok-o">){</span>
            <span class="tok-n">e</span><span class="tok-o">.</span><span class="tok-na">printStackTrace</span><span class="tok-o">();</span>
        <span class="tok-o">}</span> <span class="tok-k">finally</span> <span class="tok-o">{</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Todos los métodos de lógica de negocio son utilizados desde otras capas de la aplicación. Por ejemplo, la capa de servicio. A diferencia de los métodos de los DAO, que toman y devuelven entidades gestionadas, los métodos de negocio toman y devuelven objetos planos, desconectados de cualquier transacción o gestor de persistencia. Son métodos atómicos. Cuando terminan podemos estar seguros de que se ha realizado la operación. En el caso en que haya algún problema, la operación no se realizará en absoluto (el estado de los objetos quedará como estaba antes de llamar a la operación) y se lanzará una excepción runtime.</p>
</div>
<div class="paragraph">
<p>Todos los métodos de negocio tienen la misma estructura:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Se obtiene un <em>entity manager</em> y se abre la transacción si se va a hacer algún cambio en las entidades. No es necesario abrir una transacción cuando se va a hacer sólo una consulta.</p>
</li>
<li>
<p>Se obtienen los DAO de las entidades que intervienen en la operación.</p>
</li>
<li>
<p>Se realizan las consultas y modificaciones de las entidades que participan en la operación, actualizando su estado en la base de datos mediante los DAO.</p>
</li>
<li>
<p>Se realiza el commit de la transacción y se cierra el <em>entity manager</em>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Presentamos a continuación un ejemplo de test en el que se prueba el método de intercambiar los despachos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Test</span>
<span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">testServicioActualizaDespacho</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-n">EmpleadoServicio</span> <span class="tok-n">empleadoServicio</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">EmpleadoServicio</span><span class="tok-o">();</span>
    <span class="tok-n">empleadoServicio</span><span class="tok-o">.</span><span class="tok-na">setEmf</span><span class="tok-o">(</span><span class="tok-n">emf</span><span class="tok-o">);</span>

    <span class="tok-n">Empleado</span> <span class="tok-n">emp1</span> <span class="tok-o">=</span> <span class="tok-n">empleadoServicio</span><span class="tok-o">.</span><span class="tok-na">findPorId</span><span class="tok-o">(</span><span class="tok-mi">1L</span><span class="tok-o">);</span>
    <span class="tok-n">Empleado</span> <span class="tok-n">emp2</span> <span class="tok-o">=</span> <span class="tok-n">empleadoServicio</span><span class="tok-o">.</span><span class="tok-na">findPorId</span><span class="tok-o">(</span><span class="tok-mi">2L</span><span class="tok-o">);</span>
    <span class="tok-n">Despacho</span> <span class="tok-n">desp1</span> <span class="tok-o">=</span> <span class="tok-n">emp1</span><span class="tok-o">.</span><span class="tok-na">getDespacho</span><span class="tok-o">();</span>
    <span class="tok-n">Despacho</span> <span class="tok-n">desp2</span> <span class="tok-o">=</span> <span class="tok-n">emp2</span><span class="tok-o">.</span><span class="tok-na">getDespacho</span><span class="tok-o">();</span>

    <span class="tok-n">empleadoServicio</span><span class="tok-o">.</span><span class="tok-na">intercambiaDespachos</span><span class="tok-o">(</span><span class="tok-mi">1L</span><span class="tok-o">,</span><span class="tok-mi">2L</span><span class="tok-o">);</span>

    <span class="tok-n">emp1</span> <span class="tok-o">=</span> <span class="tok-n">empleadoServicio</span><span class="tok-o">.</span><span class="tok-na">findPorId</span><span class="tok-o">(</span><span class="tok-mi">1L</span><span class="tok-o">);</span>
    <span class="tok-n">emp2</span> <span class="tok-o">=</span> <span class="tok-n">empleadoServicio</span><span class="tok-o">.</span><span class="tok-na">findPorId</span><span class="tok-o">(</span><span class="tok-mi">2L</span><span class="tok-o">);</span>

    <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">emp1</span><span class="tok-o">.</span><span class="tok-na">getDespacho</span><span class="tok-o">().</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">desp2</span><span class="tok-o">));</span>
    <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">emp2</span><span class="tok-o">.</span><span class="tok-na">getDespacho</span><span class="tok-o">().</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">desp1</span><span class="tok-o">));</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="_ejercicios_2">2.7. Ejercicios</h3>
<div class="sect3">
<h4 id="__0_5_puntos_contexto_de_persistencia">2.7.1. (0,5 puntos) Contexto de persistencia</h4>
<div class="paragraph">
<p>En el módulo <code>mensajes</code> escribe nuevos tests que comprueben errores generados por manejar incorrectamente el contexto de persistencia:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Comprobación de que se lanza una excepción al intenta acceder a un atributo <em>lazy</em> después de cerrar el contexto de persistencia</p>
</li>
<li>
<p>Comprobación del error en el manejo de las colecciones en las relaciones a muchos (apartado 2.5.4)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Explica los errores en comentarios en los propios tests.</p>
</div>
</div>
<div class="sect3">
<h4 id="__0_5_puntos_clases_dao_del_módulo_code_filmoteca_code">2.7.2. (0,5 puntos) Clases DAO del módulo <code>filmoteca</code></h4>
<div class="paragraph">
<p>En el módulo <code>filmoteca</code> crea en el paquete org.expertojava.jpa.filmoteca.persistencia las clases DAO correspondiente a las entidades Pelicula y Critica siguiendo el patrón visto en la sesión de teoría.</p>
</div>
</div>
<div class="sect3">
<h4 id="__0_5_puntos_clase_code_peliculaservicio_code">2.7.3. (0,5 puntos) Clase <code>PeliculaServicio</code></h4>
<div class="paragraph">
<p>Crea en el paquete <code>org.expertojava.jpa.filmoteca.servicio</code> la clase <code>PeliculaServicio</code> con los siguientes métodos de negocio:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Long creaPelicula(String titulo, Date fechaEstreno, String pais, Double presupuesto)</code>: crea una película y devuelve su identificador.</p>
</li>
<li>
<p><code>void actualizaRecaudacionPelicula(Long idPelicula, Double recaudacion)</code>: actualiza la recaudación de una película.</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion03">3. Mapeado entidad-relación: tablas</h2>
<div class="sectionbody">
<div class="paragraph">
<p>En este tema vamos a tratar en profundidad el mapeado entidad-relación  (ORM, <em>Object-Relational Mapping</em> en inglés), uno de los aspectos principales del API de persistencia. Veremos los aspectos referidos al mapeo de entidades en tablas: cómo acceder a los atributos de una entidad, como se mapea la entidad en una tabla, como se mapean los distintos tipos simples de Java en tipos de la base de datos, cómo se maneja el identificador de la identidad y se mapea en la clave primaria de la tabla. Introduciremos las caracaterísticas básicas del API Bean Validation, que permite restringir los valores a introducir en los atributos de las entidades. Y terminaremos introduciendo un par de conceptos avanzados, los objetos embebidos y la herencia.</p>
</div>
<div class="paragraph">
<p>El mapado entidad-relación permite independizar la aplicación del sistema de base de datos utilizado. El proveedor de persistencia (en nuestro caso Hibernate) se encarga de transformar las anotaciones estándar de JPA al lenguaje SQL específico que necesitemos y hacer totalmente portable nuestra aplicación.</p>
</div>
<div class="paragraph">
<p>Como hemos comentado en temas anteriores, la especificación del ORM se realiza mediante anotaciones. JPA continua soportando además el formato de anotaciones basadas en ficheros XML. Podemos consultar la lista de anotaciones definidas por JPA en la última parte de la página del <a href="https://docs.oracle.com/javaee/7/api/javax/persistence/package-summary.html">API de javax.persistence</a>.</p>
</div>
<div class="sect2">
<h3 id="_acceso_al_estado_de_la_entidad">3.1. Acceso al estado de la entidad</h3>
<div class="paragraph">
<p>Existen dos formas diferentes con las que podemos anotar una clase Java para convertirla en entidad: podemos anotar los campos de la entidad o anotar sus propiedades (métodos JavaBean <em>getters</em> y <em>setters</em>). La forma de implementar el acceso al estado de una entidad en el <em>entity manager</em> para acceder al estado dependerá entonces del tipo de anotación utilizada. En el primer caso, el proveedor leerá y establecerá los campos de la entidad utilizando reflexión. Si las anotaciones se realizan en las propiedades, entonces el proveedor utilizará estos métodos para acceder al estado.</p>
</div>
<div class="sect3">
<h4 id="_acceso_por_campo">3.1.1. Acceso por campo</h4>
<div class="paragraph">
<p>Si anotamos los campos de una entidad, el proveedor accederá a estos campos mediante reflexión (aunque estén declarados como privados). A esta forma de acceder a la entidad por parte del proveedor se denomina <em>acceso por campo</em>. Los métodos <em>getters</em> y <em>setters</em> serán ignorados por el proveedor. Todos los campos deben declararse como <code>protected</code> o <code>private</code>. Se desaconseja siempre el uso de campos públicos, porque podrían accederse directamente desde otras clases. Este acceso público podría incluso estropear el funcionamiento del proveedor.</p>
</div>
<div class="paragraph">
<p>El ejemplo siguiente muestra el uso de las anotaciones en los campos. La anotación <code>@Id</code> indica no sólo que el campo <code>id</code> es el identificador o clave primaria de la entidad, sino también que se va a utilizar un acceso por campo. Los campos <code>nombre</code> y <code>sueldo</code> son hechos persistentes en columnas con el mismo nombre.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
<span class="tok-nd">@Id</span> <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">id</span><span class="tok-o">;</span>
<span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;nom&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
<span class="tok-kd">private</span> <span class="tok-n">Long</span> <span class="tok-n">sueldo</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-nf">Empleado</span><span class="tok-o">()</span> <span class="tok-o">{}</span>

<span class="tok-kd">public</span> <span class="tok-kt">int</span> <span class="tok-nf">getId</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">id</span><span class="tok-o">;</span> <span class="tok-o">}</span>
<span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setId</span><span class="tok-o">(</span><span class="tok-kt">int</span> <span class="tok-n">id</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">id</span> <span class="tok-o">=</span> <span class="tok-n">id</span><span class="tok-o">;</span> <span class="tok-o">}</span>
<span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getNombre</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">nombre</span><span class="tok-o">;</span> <span class="tok-o">}</span>
<span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setNombre</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">nombre</span> <span class="tok-o">=</span> <span class="tok-n">nombre</span><span class="tok-o">;</span> <span class="tok-o">}</span>
<span class="tok-kd">public</span> <span class="tok-n">Long</span> <span class="tok-nf">getSueldo</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">sueldo</span><span class="tok-o">;</span> <span class="tok-o">}</span>
<span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setSueldo</span><span class="tok-o">(</span><span class="tok-n">Long</span> <span class="tok-n">sueldo</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">sueldo</span> <span class="tok-o">=</span> <span class="tok-n">sueldo</span><span class="tok-o">;</span> <span class="tok-o">}}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_acceso_por_propiedad">3.1.2. Acceso por propiedad</h4>
<div class="paragraph">
<p>La otra forma de anotar una entidad es colocando las anotaciones en sus métodos getters. Se dice en este caso que estamos anotando las propiedades. Cuando anotamos las propiedades, se aplican las mismas condiciones que cuando se define un JavaBean, y debe haber <em>getters</em> y <em>setters</em> para las propiedades que queremos hacer persistentes. En este caso se dice que el proveedor utiliza un acceso por propiedad a la entidad. El tipo de la propiedad viene determinado por el tipo devuelto por el método <em>getter</em> y debe ser el mismo que el único parámetro pasado al método <em>setter</em>. Ambos métodos deben tener visibilidad <code>public</code> o <code>protected</code>. La anotación de mapeado debe realizarse en el método <em>getter</em>.</p>
</div>
<div class="paragraph">
<p>En el código siguiente, la clase <code>Empleado</code> tiene una anotación <code>@Id</code> en el método <em>getter</em> <code>getId()</code>, por lo que el proveedor podrá utilizar el acceso a la propiedad <code>id</code> para obtener y establecer el estado de la entidad. Las propiedades <code>nombre</code> y <code>sueldo</code> se hacen persistentes también automáticamente y se mapearán en columnas con el nombre <code>nom</code> (por haberlo especificado con la anotación <code>@column</code>) y <code>sueldo</code>. Nótese que es posible utilizar nombres distintos para los campos. En el ejemplo, la propiedad <code>sueldo</code> está respaldada por el campo <code>paga</code>. El proveedor ignora esta diferencia, ya que únicamente utiliza los <em>getters</em> y <em>setters</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
<span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">id</span><span class="tok-o">;</span>
<span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
<span class="tok-kd">private</span> <span class="tok-n">Long</span> <span class="tok-n">paga</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-n">Empleado</span> <span class="tok-o">{}</span>

<span class="tok-nd">@Id</span> <span class="tok-kd">public</span> <span class="tok-kt">int</span> <span class="tok-nf">getId</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">id</span><span class="tok-o">;</span> <span class="tok-o">}</span>
<span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setId</span><span class="tok-o">(</span><span class="tok-kt">int</span> <span class="tok-n">id</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">id</span> <span class="tok-o">=</span> <span class="tok-n">id</span><span class="tok-o">;</span> <span class="tok-o">}</span>
<span class="tok-nd">@Column</span> <span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;nom&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getNombre</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">nombre</span><span class="tok-o">;</span> <span class="tok-o">}</span>
<span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setNombre</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">nombre</span> <span class="tok-o">=</span> <span class="tok-n">nombre</span><span class="tok-o">;</span> <span class="tok-o">}</span>
<span class="tok-kd">public</span> <span class="tok-n">Long</span> <span class="tok-nf">getSueldo</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">paga</span><span class="tok-o">;</span> <span class="tok-o">}</span>
<span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setSueldo</span><span class="tok-o">(</span><span class="tok-n">Long</span> <span class="tok-n">sueldo</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">sueldo</span> <span class="tok-o">=</span> <span class="tok-n">sueldo</span><span class="tok-o">;</span> <span class="tok-o">}}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_mapeado_de_entidades">3.2. Mapeado de entidades</h3>
<div class="paragraph">
<p>Ya hemos visto en el tema anterior que es muy sencillo mapear entidades en tablas. Sólo se necesitan las anotaciones <code>@Entity</code> y <code>@Id</code> para crear y mapear una entidad en una tabla de la base de datos.</p>
</div>
<div class="paragraph">
<p>En esos casos el nombre que se utiliza para la tabla es el propio nombre de la entidad. Podría darse el caso de que necesitáramos especificar un nombre distinto para la tabla, por ejemplo si no estamos desarrollando la aplicación desde cero y partimos de un modelo de datos ya creado. Podemos hacerlo con la anotación <code>@Table</code> en la que incluimos el nombre de la tabla. El siguiente código muestra un ejemplo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-nd">@Table</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;EMP&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span> <span class="tok-o">...</span> <span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Los nombres por defecto son los nombres de las clases, que en Java comienzan por mayúscula y continúan con minúscula. ¿Cómo se mapean las mayúsculas y minúsculas en la base de datos? Depende de la base de datos. Muchas bases de datos no distinguen mayúsculas y minúsculas, por lo que en estos casos el nombre se convierte en mayúsculas. En el caso de <em>MySQL</em>, sí que se distinguen entre mayúsculas y minúsculas, por lo que el nomre de las tablas será idéntico al de las clases.</p>
</div>
<div class="paragraph">
<p>La anotación <code>@Table</code> proporciona la posibilidad no sólo de nombrar la tabla, sino de especificar un esquema o catálogo de la base de datos. El nombre del esquema se utiliza normalmente para diferenciar un conjunto de tablas de otro y se indica en la anotación con el elemento <code>schema</code>. Se muestra en el siguiente ejemplo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-nd">@Table</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;EMP&quot;</span><span class="tok-o">,</span> <span class="tok-n">schema</span><span class="tok-o">=</span><span class="tok-s">&quot;IT&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span> <span class="tok-o">...</span> <span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cuando se especifica de esta forma, el proveedor colocará el nombre del esquema como prefijo del de la tabla cuando acceda a los datos. En este caso, los accesos se harán a la tabla <code>IT.EMP</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_mapeado_de_tipos">3.3. Mapeado de tipos</h3>
<div class="paragraph">
<p>La especificación de JPA define un gran número de tipos Java que pueden ser hechos persistentes. Son los siguientes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Tipos primitivos Java</strong>: <code>byte</code>, <code>int</code>, <code>short</code>, <code>long</code>, <code>boolean</code>, <code>char</code>, <code>float</code>, <code>double</code></p>
</li>
<li>
<p><strong>Clases <em>wrapper</em> de los tipos primitivos</strong>: <code>Byte</code>, <code>Integer</code>, <code>Short</code>, <code>Long</code>, <code>Boolean</code>, <code>Character</code>, <code>Float</code>, <code>Double</code></p>
</li>
<li>
<p><strong>Arrays de bytes y char</strong>: <code>byte[]</code>, <code>Byte[]</code>, <code>char[]</code>, <code>Character[]</code></p>
</li>
<li>
<p><strong>Tipos numéricos largos</strong>: <code>java.math.BigInteger</code>, <code>java.math.BigDecimal</code></p>
</li>
<li>
<p><strong>Strings</strong>: <code>java.lang.String</code></p>
</li>
<li>
<p><strong>Tipos temporales de Java</strong>: <code>java.util.Date</code>, <code>java.util.Calendar</code></p>
</li>
<li>
<p><strong>Tipos temporales de JDBC</strong>: <code>java.sql.Date</code>, <code>java.sql.Time</code>, <code>java.sql.Timestamp</code></p>
</li>
<li>
<p><strong>Tipos enumerados</strong>: cualquier tipo enumerado del sistema o definido por el usuario</p>
</li>
<li>
<p><strong>Objetos serializables</strong>: cualquier tipo serializable del sistema o definido por el usuario</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>En algunos casos el tipo de la columna que está siendo mapeada no es exactamente el mismo que el tipo Java. En casi todos los casos, el runtime del proveedor puede convertir el tipo devuelto por la consulta JDBC en el tipo Java correcto del atributo. Si el tipo de la capa JDBC no puede convertirse en el tipo Java del campo o la propiedad se lanza una excepción.</p>
</div>
<div class="paragraph">
<p>Cuando se hace persistente un campo o una propiedad, el proveedor comprueba que su tipo es uno de los que está en la lista anterior. Si lo está, el proveedor lo transformará en el tipo JDBC apropiado y lo pasará al driver JDBC.</p>
</div>
<div class="paragraph">
<p>Se puede usar la anotación opcional <code>@Basic</code> en el campo o la propiedad para marcarlos como persistentes. Esta anotación se utiliza únicamente para efectos de documentación o para especificar algún detalle sobre la persistencia (lo veremos más adelante).</p>
</div>
<div class="paragraph">
<p>Ahora que hemos comprobados que los campos (definidos en las variables de instancia) y las propiedades (definidas en los <em>getters</em> y <em>setters</em>) son equivalentes en términos de persistencia, los llamaremos de ahora en adelante <em>atributos</em>. Consideramos <em>atributo</em> un campo o una propiedad de una clase estilo JavaBean.</p>
</div>
<div class="sect3">
<h4 id="_mapeo_de_columnas">3.3.1. Mapeo de columnas</h4>
<div class="paragraph">
<p>Es posible anotar las características físicas de la columna de la base de datos en la que se mapea un atributo utilizando la anotación <code>@Column</code>. Aunque es posible especificar bastantes elementos, vamos a comentar sólo alguno de ellos (consultar la <a href="https://docs.oracle.com/javaee/7/api/javax/persistence/package-summary.html">especificación de JPA</a> para obtener más información).</p>
</div>
<div class="paragraph">
<p>La primera característica que hay que mencionar es el nombre de la columna. Al igual que con las tablas, es posible especificar los nombres de las columnas con las que se va a mapear cada atributo. El siguiente código muestra un ejemplo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
   <span class="tok-nd">@Id</span>
   <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;EMP_ID&quot;</span><span class="tok-o">)</span>
   <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">id</span><span class="tok-o">;</span>
   <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
   <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-n">SAL</span><span class="tok-o">)</span>
   <span class="tok-kd">private</span> <span class="tok-n">Long</span> <span class="tok-n">sueldo</span><span class="tok-o">;</span>
   <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-n">COM</span><span class="tok-o">)</span>
   <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">comentario</span><span class="tok-o">;</span>
   <span class="tok-c1">// ...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La tabla resultante del mapeo se llamaría <code>EMPLEADO</code> y tendría como columnas <code>EMP_ID</code>, <code>NOMBRE</code>, <code>SAL</code> y <code>COM</code>. La primera columna sería la clave primaria de la tabla. La siguiente figura muestra la tabla resultante en la base de datos.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa03/tabla.png" alt="Empleado" width="15%">
</div>
</div>
<div class="paragraph">
<p>Es posible también obligar a que un atributo no pueda dejarse a <code>null</code> utilizando el elemento <code>nullable=false</code>. En la columna de la tabla se incluiría la restricción SQL <code>NOT NULL</code>. Por ejemplo en el siguiente código obligaríamos a que el nombre del empleado nunca pudiera ser <code>null</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
   <span class="tok-nd">@Id</span> <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">id</span><span class="tok-o">;</span>
   <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">nullable</span><span class="tok-o">=</span><span class="tok-kc">false</span><span class="tok-o">)</span>
   <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
   <span class="tok-c1">// ...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Otra parámetro muy útil es el que nos permite generar la restricción <code>UNIQUE</code> sobre un campo de la base de datos. Por ejemplo, podemos obligar a que el <code>login</code> se único así:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
   <span class="tok-nd">@Id</span> <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">id</span><span class="tok-o">;</span>
   <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">nullable</span><span class="tok-o">=</span><span class="tok-kc">false</span><span class="tok-o">,</span> <span class="tok-n">unique</span><span class="tok-o">=</span><span class="tok-kc">true</span><span class="tok-o">)</span>
   <span class="tok-n">String</span> <span class="tok-n">login</span>
   <span class="tok-c1">// ...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cuando no se especifica la longitud de una columna que almacena cadenas (<code>String</code>, <code>char[]</code> o <code>Character[]</code>), el valor por defecto es 255. Para definir otro tamaño hay que utilizar el elemento <code>length</code>, como en el siguiente ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
   <span class="tok-nd">@Id</span> <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">id</span><span class="tok-o">;</span>
   <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">length</span><span class="tok-o">=</span><span class="tok-mi">40</span><span class="tok-o">)</span>
   <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
   <span class="tok-c1">// ...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Otros posibles parámetros de la anotación son: <code>columnDefinition</code>, <code>insertable</code>, <code>precision</code>, <code>scale</code> o <code>updatable</code> (consultar la <a href="https://docs.oracle.com/javaee/7/api/javax/persistence/Column.html">especificación de la anotación Column</a>).</p>
</div>
</div>
<div class="sect3">
<h4 id="_recuperación_perezosa">3.3.2. Recuperación perezosa</h4>
<div class="paragraph">
<p>El concepto de recuperación perezosa (<em>lazy fetching</em> en inglés) es muy importante para gestionar de forma eficiente la base de datos. Ya veremos más adelante que también se aplica a las relaciones entre entidades.</p>
</div>
<div class="paragraph">
<p>En ocasiones, sabemos que hay algunos atributos de la entidad a los que se accede con muy poca frecuencia. En este caso podemos optimizar el rendimiento de los accesos a la base de datos obteniendo sólo los datos que vamos a necesitar con frecuencia. Existen muchos nombres para esta idea, entre los que se incluyen (en inglés) <em>lazy loading</em>, <em>lazy fetching</em>, <em>on-demand fetching</em> o <em>indirection</em>. Todos significan lo mismo, que es que algunos datos no se cargan en el objeto cuando éste es leído inicialmente de la base de datos sino que serán recuperados sólo cuando sean referenciados o accedidos.</p>
</div>
<div class="paragraph">
<p>El comportamiento de un atributo de la entidad se puede especificar con el elemento <code>fetch</code> de la anotación <code>@Basic</code>. El tipo enumerado <code>FetchType</code> especifica los posibles valores de este elemento, que pueden ser <code>EAGER</code> (ávido, recupera el dato cuando se obtiene la entidad de la base de datos) o <code>LAZY</code> (perezoso, recupera el dato cuando se accede al atributo). El comportamiento por defecto es el primero.</p>
</div>
<div class="paragraph">
<p>El siguiente código muestra un ejemplo, en el que el atributo <code>comentario</code> se define con un mapeo de recuperación perezosa:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
   <span class="tok-c1">// ...</span>
   <span class="tok-nd">@Basic</span><span class="tok-o">(</span><span class="tok-n">fetch</span><span class="tok-o">=</span><span class="tok-n">FetchType</span><span class="tok-o">.</span><span class="tok-na">LAZY</span><span class="tok-o">)</span>
   <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-n">COM</span><span class="tok-o">)</span>
   <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">comentario</span><span class="tok-o">;</span>
   <span class="tok-c1">// ...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Antes de usar esta característica se debería tener claro unos cuantos aspectos. Lo primero es que la declaración de un atributo como de recuperación perezosa no obliga a nada al proveedor de persistencia. Sólo es una indicación para que pueda agilizar ciertas acciones sobre la base de datos. El proveedor no está obligado a respetar la petición, ya que el comportamiento de la entidad no queda comprometido haga una cosa u otra el proveedor.</p>
</div>
<div class="paragraph">
<p>Segundo, aunque en principio pueda parecer interesante definir ciertos atributos como de carga perezosa, en la práctica no es correcto hacerlo con tipos simples (no relaciones a otras entidades). La razón es que se gana poco haciendo que la base de datos devuelva parte de una fila. Únicamente se gana algo y debería considerarse la recuperación perezosa cuando tenemos muchas (decenas o cientos) columnas o cuando algunas columnas ocupan mucho (por ejemplo, cadenas muy largas o <em>lobs</em>).</p>
</div>
<div class="paragraph">
<p>La recuperación perezosa sí que es muy importante cuando hablemos de mapeo de relaciones, como veremos más adelante.</p>
</div>
</div>
<div class="sect3">
<h4 id="_lobs">3.3.3. LOBs</h4>
<div class="paragraph">
<p>El nombre que habitualmente se les da en base de datos a los objetos de tipo byte o caracter que son muy grandes es el de <em>large object</em> o <em>LOB</em> como abreviatura. Las columnas de la base de datos que almacenan estos tipos de objetos se deben acceder desde Java con llamadas JDBC especiales. Para indicarle al proveedor que debería usar métodos de tipo LOB en el driver de JDBC para acceder a ciertas columnas se debe utilizar la anotación <code>@Lob</code>.</p>
</div>
<div class="paragraph">
<p>En la base de datos se pueden encontrar dos tipos de LOBs: objetos grandes de tipo carácter, llamados <em>CLOBs</em> y objetos grandes de tipo binario, llamados <em>BLOBs</em>. Como su nombre indica, una columna CLOB guarda una larga secuencia de caracteres, mientras que un BLOB guarda una larga secuencia de bytes no formateados. Los tipos Java que se mapean con columnas CLOB son <code>String</code>, <code>char[]</code> y <code>Character[]</code>, mientras que <code>byte[]</code>, <code>Byte[]</code> y <code>Serializable</code> se mapean con columnas de tipo BLOB.</p>
</div>
<div class="paragraph">
<p>El siguiente código muestra el ejemplo de mapeo de una columna con un BLOB imagen. Suponemos que la columna PIC guarda una imagen del empleado, que se mapea en el atributo <code>foto</code> de tipo <code>byte[]</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
   <span class="tok-nd">@Id</span> <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">id</span><span class="tok-o">;</span>
   <span class="tok-nd">@Basic</span><span class="tok-o">(</span><span class="tok-n">fetch</span><span class="tok-o">=</span><span class="tok-n">FetchType</span><span class="tok-o">.</span><span class="tok-na">LAZY</span><span class="tok-o">)</span>
   <span class="tok-nd">@Lob</span> <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;PIC&quot;</span><span class="tok-o">)</span>
   <span class="tok-kd">private</span> <span class="tok-kt">byte</span><span class="tok-o">[]</span> <span class="tok-n">foto</span><span class="tok-o">;</span>
   <span class="tok-c1">// ...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_tipos_enumerados">3.3.4. Tipos enumerados</h4>
<div class="paragraph">
<p>Otro tipo Java que puede ser mapeado en la base de datos es cualquier tipo enumerado del sistema o definido por el usuario.</p>
</div>
<div class="paragraph">
<p>Al igual que en otros lenguajes de programación, a los valores de los tipos enumerados en Java se les asigna un ordinal implícito que depende del orden de creación. Este ordinal no puede ser modificado en tiempo de ejecución y es el que se utiliza para representar y almacenar el valor del tipo enumerado. El proveedor, por tanto, mapeará un tipo enumerado en una columna de tipo entero y sus valores en números enteros específicos.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, consideremos el siguiente tipo enumerado:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kd">enum</span> <span class="tok-n">TipoEmpleado</span> <span class="tok-o">{</span>
   <span class="tok-n">EMPLEADO_TIEMPO_PARCIAL</span><span class="tok-o">,</span>
   <span class="tok-n">EMPLEADO_TIEMPO_COMPLETO</span><span class="tok-o">,</span>
   <span class="tok-n">EMPLEADO_EXTERNO</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Los ordinales asignados en tiempo de compilación a los valores de este tipo enumerado son 0 para <code>EMPLEADO_TIEMPO_PARCIAL</code>, 1 para <code>EMPLEADO_TIEMPO_COMPLETO</code> y 2 para <code>EMPLEADO_EXTERNO</code>. El siguiente código utiliza este tipo para definir un atributo de la entidad:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
   <span class="tok-nd">@Id</span> <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">id</span><span class="tok-o">;</span>
   <span class="tok-kd">private</span> <span class="tok-n">TipoEmpleado</span> <span class="tok-n">tipo</span><span class="tok-o">;</span>
   <span class="tok-c1">// ...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos ver que el mapeado es trivial, ya que no hay que hacer nada especial y el proveedor se encarga de realizar la transformación del tipo enumerado al tipo entero de la base de datos.</p>
</div>
<div class="paragraph">
<p>Sin embargo, hay que tener cuidado con una cosa. Si en algún momento cambiamos el tipo enumerado podemos tener problemas, ya que puede cambiar el orden de los valores en el tipo enumerado y no corresponderse con los ya existentes en la base de datos. Por ejemplo, supongamos que necesitamos añadir un nuevo tipo de empleado a tiempo completo: <code>EMPLEADO_TIEMPO_COMPLETO_EXCEDENCIA</code> y supongamos que lo añadimos justo después de <code>EMPLEADO_TIEMPO_COMPLETO</code>. Esto causaría un cambio en el ordinal asociado a <code>EMPLEADO_EXTERNO</code>, que pasaría de 2 a 3. Los empleados existentes en la base de datos, sin embargo, no cambiarían y los datos grabados con el ordinal 2 pasarían de ser <code>EMPLEADO_EXTERNO</code> a ser <code>EMPLEADO_TIEMPO_COMPLETO_EXCEDENCIA</code>.</p>
</div>
<div class="paragraph">
<p>Podríamos modificar la base de datos y ajustar todos las entidades, pero si los ordinales se utilizan en algún otro lugar tendríamos que arreglarlo también. No es una buena política de mantenimiento.</p>
</div>
<div class="paragraph">
<p>Una solución mejor sería almacenar el nombre del valor como una cadena en lugar de almacenar el ordinal. Esto nos aislaría de los cambios en la declaración y nos permitiría añadir nuevos tipos sin tener que preocuparnos sobre los datos existentes. Podemos hacer esto añadiendo una anotación <code>@Enumerated</code> en el atributo y especificando un valor de <code>STRING</code>. El siguiente código muestra cómo hacerlo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
   <span class="tok-nd">@Id</span> <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">id</span><span class="tok-o">;</span>
   <span class="tok-nd">@Enumerated</span><span class="tok-o">(</span><span class="tok-n">EnumType</span><span class="tok-o">.</span><span class="tok-na">STRING</span><span class="tok-o">)</span>
   <span class="tok-kd">private</span> <span class="tok-n">TipoEmpleado</span> <span class="tok-n">tipo</span><span class="tok-o">;</span>
   <span class="tok-c1">// ...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Hay que hacer notar de esta forma no arreglamos el problema completamente. Ahora en la base de datos se guardan las cadenas <code>EMPLEADO_TIEMPO_COMPLETO</code> y demás. Si en algún momento modificamos el nombre de los valores del tipo enumerado también deberíamos cambiar los datos de la base de datos. Pero esto es menos frecuente, ya que un cambio en los valores de un tipo enumerado nos obliga a cambiar todo el código en el que aparezcan los valores, y esto es bastante más serio que cambiar los datos de una columna de la base de datos.</p>
</div>
<div class="paragraph">
<p>En general, definir el tipo enumerado como un ordinal es la forma más eficiente de trabajar, pero siempre que no sea probable tener que añadir nuevos valores en medio de los ya existentes.</p>
</div>
</div>
<div class="sect3">
<h4 id="_tipos_temporales">3.3.5. Tipos temporales</h4>
<div class="paragraph">
<p>Los tipos temporales son el conjunto de tipos basados en tiempo que pueden usarse en el mapeo entidad-relación. La lista de tipos temporales soportados incluye los tres tipos <code>java.sql</code> <code>java.sql.Date</code>, <code>java.sql.Time</code> y <code>java.sql.Timestamp</code>, e incluye también los tipos <code>java.util</code> <code>java.util.Date</code> y <code>java.util.Calendar</code>.</p>
</div>
<div class="paragraph">
<p>El mapeo de los tipos <code>java.sql</code> no plantea ningún problema en absoluto y se almacenan en la base de datos sin cambios. Los dos tipos <code>java.util</code> necesitan metadatos adicionales, para indicar qué tipo JDBC <code>java.sql</code> hay que usar cuando el proveedor haga persistente la entidad. Esto se consigue anotándolos con la anotación <code>@Temporal</code> y especificando el valor del tipo JDBC utilizando el valor correspondiente del tipo enumerado <code>TemporalType</code>. Hay tres valores enumerados: <code>DATE</code>, <code>TIME</code> y <code>TIMESTAMP</code> que representan cada uno de los tipos <code>java.sql</code>.</p>
</div>
<div class="paragraph">
<p>EL código siguiente muestra cómo <code>java.util.Date</code> y <code>java.util.Calendar</code> pueden mapearse a columnas de la base de datos.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
   <span class="tok-nd">@Id</span> <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">id</span><span class="tok-o">;</span>
   <span class="tok-nd">@Temporal</span><span class="tok-o">(</span><span class="tok-n">TemporalType</span><span class="tok-o">.</span><span class="tok-na">DATE</span><span class="tok-o">)</span>
   <span class="tok-kd">private</span> <span class="tok-n">java</span><span class="tok-o">.</span><span class="tok-na">util</span><span class="tok-o">.</span><span class="tok-na">Date</span> <span class="tok-n">fechaNacimiento</span><span class="tok-o">;</span>
   <span class="tok-nd">@Temporal</span><span class="tok-o">(</span><span class="tok-n">TemporalType</span><span class="tok-o">.</span><span class="tok-na">TIMESTAMP</span><span class="tok-o">)</span>
   <span class="tok-kd">private</span> <span class="tok-n">java</span><span class="tok-o">.</span><span class="tok-na">util</span><span class="tok-o">.</span><span class="tok-na">Date</span> <span class="tok-n">horaSalida</span><span class="tok-o">;</span>
   <span class="tok-c1">// ...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_estado_transitorio">3.3.6. Estado transitorio</h4>
<div class="paragraph">
<p>Es posible definir en la entidad atributos que no se hacen persistentes utilizando la palabra clave de Java <code>transient</code> o el atributo <code>@Transient</code>. Si se especifica alguna de estas propiedades, el proveedor no aplicará las reglas por defecto al atributo marcado.</p>
</div>
<div class="paragraph">
<p>Los campos transitorios son útiles, por ejemplo, para cachear un estado en memoria que no queremos recalcular o reinicializar. En el ejemplo siguiente usamos el campo transitorio <code>traduccion</code> para guardar la traducción de la palabra "Empleado" en el locale actual, de forma que se imprima correctamente el nombre. El uso del modificador Java <code>transient</code> hace que el atributo sea temporal no sólo para la persistencia sino también para la máquina virtual. Si el <code>Empleado</code> se serializa y se envía desde una MV a otra el valor del atributo <code>traduccion</code> no se enviaría.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
   <span class="tok-nd">@Id</span> <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">id</span><span class="tok-o">;</span>
   <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
   <span class="tok-kd">private</span> <span class="tok-n">Long</span> <span class="tok-n">sueldo</span><span class="tok-o">;</span>
   <span class="tok-kd">transient</span> <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">traduccion</span><span class="tok-o">;</span>
   <span class="tok-c1">// ...</span>

   <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">toString</span><span class="tok-o">()</span> <span class="tok-o">{</span>
      <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">traduccion</span> <span class="tok-o">==</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
         <span class="tok-n">traduccion</span> <span class="tok-o">=</span>
            <span class="tok-n">ResourceBundle</span><span class="tok-o">.</span><span class="tok-na">getBundle</span><span class="tok-o">(</span><span class="tok-s">&quot;EmpResources&quot;</span><span class="tok-o">).</span><span class="tok-na">getString</span><span class="tok-o">(</span><span class="tok-s">&quot;Empleado&quot;</span><span class="tok-o">);</span>
      <span class="tok-o">}</span>
      <span class="tok-k">return</span> <span class="tok-n">traduccion</span> <span class="tok-o">+</span> <span class="tok-s">&quot;: &quot;</span> <span class="tok-o">+</span> <span class="tok-n">id</span> <span class="tok-o">+</span> <span class="tok-s">&quot; &quot;</span> <span class="tok-o">+</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_objetos_embebidos">3.4. Objetos embebidos</h3>
<div class="paragraph">
<p>Un <em>objeto embebido</em> es uno que no tiene identidad propia, y que está ligado a una entidad. Es meramente una parte de una entidad que ha sido separada y almacenada en un objeto Java independiente para adaptar mejor el modelo de datos al dominio. En la definición de la entidad aparece un atributo con un tipo no básico. A primera vista parecería que se está definiendo una relación con otra entidad. Sin embargo, el tipo embebido no tiene entidad suficiente como para definir una entidad persistente por él mismo. Sus datos se almacenan con el resto de la entidad en la misma fila de la base de datos.</p>
</div>
<div class="paragraph">
<p>Un ejemplo muy común es el tipo <code>Direccion</code>. Puede ser que en nuestro dominio una dirección no tenga las características que le hagan definir una entidad persistente (no vamos a hacer búsquedas por direcciones, ni identificadores de direcciones). Sin embargo, queremos guardar los datos que forman la dirección como un atributo del empleado. Y además obtener los beneficios del modelo de objetos considerándolos uno único dato.</p>
</div>
<div class="paragraph">
<p>Las ventajas de agrupar un conjunto de campos en un nuevo tipo de datos Java son múltiples. En primer lugar, abstraemos el modelo físico (representación en la tabla de la base de datos) y obtenemos una representación más cercana al dominio de la aplicación. Podremos utilizar objetos <code>Direccion</code> en distintas partes de la lógica de negocio. En segundo lugar, podemos reutilizar este tipo en más de una entidad, dando consistencia a nuestro modelo físico. Por último, es una forma muy portable de conseguir una características de SQL que nunca se ha llegado a estandarizar: el uso de tipos definidos por el usuario.</p>
</div>
<div class="paragraph">
<p>Vamos a ver el ejemplo con más detalle. La siguiente figura muestra una tabla <code>EMPLEADO</code> que contiene una mezcla de información propia del empleado y de columnas que definen su dirección:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa03/tabla-extendida.png" alt="Empleado" width="15%">
</div>
</div>
<div class="paragraph">
<p>Las columnas <code>CALLE</code>, <code>CIUDAD</code>, <code>PROVINCIA</code> y <code>COD_POSTAL</code> se combinan lógicamente para formar la dirección. En el modelo de objetos podríamos perfectamente abstraer esta información en tipo embebido <code>Direccion</code>. La clase entidad tendría entonces una atributo <code>direccion</code> que referenciaría un objeto embebido de tipo <code>Direccion</code>. La siguiente figura muestra la relación entre <code>Empleado</code> y <code>Direccion</code>. Utilizamos la asociación UML <strong>composición</strong> (en la que se utiliza un rombo como punto de origen de la flecha) para denotar que el <code>Empleado</code> posee completamente la <code>Direccion</code> y que una instancia de <code>Direccion</code> no debe ser compartida con ningún otro objeto salvo la instancia de <code>Empleado</code> que lo posee.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa03/direccion.png" alt="Relación" width="50%">
</div>
</div>
<div class="paragraph">
<p>Con esta representación, no sólo la información de la dirección se encapsula de forma limpia dentro de un objeto, sino que otras entidades como <code>Empresa</code> pueden también utilizar el tipo y tener sus propios atributos de con objetos embebidos de tipo <code>Direccion</code>.</p>
</div>
<div class="paragraph">
<p>Para definir el tipo embebido debemos utilizar la anotación <code>@Embeddable</code> en la definición de la clase. Esta anotación sirve para diferenciar la clase de otras clases normales Java. Una vez que la clase ha sido definida como embebible, sus atributos se harán persistentes como parte de la entidad. Los atributos de mapeo de columnas <code>@Basic</code>, <code>@Temporal</code>, <code>@Enumerado</code>, <code>@Lob</code> y <code>@Column</code> pueden añadirse a los atributos de la clase embebida. El código siguiente muestra un ejemplo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Embeddable</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Direccion</span> <span class="tok-o">{</span>
   <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">calle</span><span class="tok-o">;</span>
   <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">ciudad</span><span class="tok-o">;</span>
   <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">provincia</span><span class="tok-o">;</span>
   <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;COD_POSTAL&quot;</span><span class="tok-o">)</span>
   <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">codigoPostal</span><span class="tok-o">;</span>
   <span class="tok-c1">// ...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para usar esta clase en una entidad hay que declararla con la anotación <code>@Embedded</code>. Se muestra a continuación.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
   <span class="tok-nd">@Id</span> <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">id</span><span class="tok-o">;</span>
   <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
   <span class="tok-kd">private</span> <span class="tok-n">Long</span> <span class="tok-n">sueldo</span><span class="tok-o">;</span>
   <span class="tok-nd">@Embedded</span> <span class="tok-kd">private</span> <span class="tok-n">Direccion</span> <span class="tok-n">direccion</span><span class="tok-o">;</span>
   <span class="tok-c1">// ...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cuando el proveedor realice la persistencia de una instancia de <code>Empleado</code> accederá a los atributos del objeto <code>Direccion</code> como si estuvieran presentes en la propia instancia. El mapeado de las columnas del tipo <code>Direccion</code> se realiza realmente en la tabla <code>EMPLEADO</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_mapeo_de_la_clave_primaria">3.5. Mapeo de la clave primaria</h3>
<div class="paragraph">
<p>Aunque muchas bases de datos heredadas (<em>legacy</em>) utilizan claves primarias naturales, la práctica recomendable es trabajar con claves primarias generadas de forma automática y sin ningún significado fuera del ámbito de la propia gestión de la base de datos. Una clave natural es una clave primaria con un significado de negocio. Por ejemplo, el NIF o el login de un usuario. Por otra parte, una clave generada (también llamada clave subrogada, del inglés <em>surrogate key</em>) no tiene ningún significado propio en el modelo de negocio, sino que únicamente garantiza la unicidad de los datos almacenados en la tabla.</p>
</div>
<div class="paragraph">
<p>Es una buena práctica el utilizar siempre claves primarias generadas. La utilización de claves naturales termina causando problemas. Una clave primaria tiene que ser única, constante y no vacía. Es muy difícil encontrar estas características en los atributos del modelo de negocio. Incluso si los encontramos, es muy frecuente que a lo largo de la vida de la base de datos suceda algún cambio en el negocio que obligue a modificarlos. Por ejemplo, un NIF erróneo que hay que modificar o un nombre de usuario que antes era inmutable y ahora nos piden que sea modificable.</p>
</div>
<div class="paragraph">
<p>La utilización de claves primarias generadas en todas las tablas de nuestra base de datos también proporciona una gran consistencia a la aplicación y permite procedimientos unificados en la gestión de claves ajenas y referencias.</p>
</div>
<div class="paragraph">
<p>Por último, en un modelo orientado a objetos como el de JPA, el uso de claves primarias autogeneradas refuerza la idea de que las entidades son objetos. La clave de una entidad es similar a la dirección de memoria de un objeto. Los objetos mantienen referencias a otros objetos de la misma forma que las entidades guardan claves ajenas a otras entidades. Referencias y claves se utilizan para definir grafos de objetos relacionados entre si. Tanto las claves como las referencias son internas de la aplicación y el usuario no debe conocerlas ni utilizarlas directamente.</p>
</div>
<div class="paragraph">
<p>Aun así, hay muchas bases de datos heredadas para las que será necesario utilizar claves primarias ya existentes. Por ejemplo, es usual la utilización de claves primarias compuestas para asegurarse la unicidad. JPA permite también el mapeo de este tipo de claves primarias.</p>
</div>
<div class="paragraph">
<p>Veremos en primer lugar las estrategias de JPA para implementar claves primarias autogeneradas y después pasaremos a la gestión de claves compuestas para trabajar con bases de datos heredadas.</p>
</div>
<div class="paragraph">
<p>En general, JPA permite utilizar como clave primaria los siguientes tipos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Tipos Java primitivos</strong>: <code>byte</code>, <code>int</code>, <code>short</code>, <code>long</code>, <code>char</code></p>
</li>
<li>
<p><strong>Clases wrapper de tipos primitivos</strong>: <code>Byte</code>, <code>Integer</code>, <code>Short</code>, <code>Long</code>, <code>Character</code></p>
</li>
<li>
<p><strong>Arrays de tipos primitivos o de clases wrappers</strong></p>
</li>
<li>
<p><strong>Cadenas</strong>: <code>java.lang.String</code></p>
</li>
<li>
<p><strong>Tipos numéricos grandes</strong>: <code>java.math.BigInteger</code></p>
</li>
<li>
<p><strong>Tipos temporales</strong>: <code>java.util.Date</code>, <code>java.sql.Date</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Igual que con los mapeos básicos, la anotación <code>@Column</code> puede utilizarse para modificar el nombre con el que el atributo identificador se hace persistente. Si no se utiliza sucede igual que con los mapeos básicos y el campo se guarda en la columna con el mismo nombre.</p>
</div>
<div class="sect3">
<h4 id="_generación_del_identificador">3.5.1. Generación del identificador</h4>
<div class="paragraph">
<p>Se utiliza la anotación <code>@GeneratedValue</code> para definir una clave primaria única generada de forma automática.</p>
</div>
<div class="paragraph">
<p>Es importante tener en cuenta que en este caso el identificador de la entidad puede ser que no esté disponible hasta que se haya realizado la inserción en la base de datos. Esto no significa que no lo podamos utilizar. Podríamos por ejemplo, asignarlo a otra entidad en una relación entre entidades o modificar sus atributos. Cuando se realiza un <em>flush</em> es cuando nos podemos asegurar que se actualiza automáticamente esta clava primaria.</p>
</div>
<div class="paragraph">
<p>Existen cuatro estrategias de generación de id que se seleccionan mediante el elemento <code>strategy</code> de la anotación. Son <code>AUTO</code>, <code>IDENTITY</code>, <code>SEQUENCE</code> o <code>TABLE</code>. Para definir el tipo de estrategia se utilizan los valores enumerados del tipo <code>GenerationType</code>.</p>
</div>
<div class="paragraph">
<p>Con la opción AUTO dejamos que sea el proveedor de persistencia el que se ocupe de cómo generar los identificadores. El siguiente código muestra un ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
   <span class="tok-nd">@Id</span> <span class="tok-nd">@GeneratedValue</span><span class="tok-o">(</span><span class="tok-n">strategy</span><span class="tok-o">=</span><span class="tok-n">GenerationType</span><span class="tok-o">.</span><span class="tok-na">AUTO</span><span class="tok-o">)</span>
   <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">id</span><span class="tok-o">;</span>
   <span class="tok-c1">// ...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Esta estrategia es muy portable, ya que se mapea a los distintos sistemas de generación de identidades usados por los sistemas de gestión de base de datos, como <em>identity</em>, <em>sequence</em> o <em>HiLo</em>.</p>
</div>
<div class="paragraph">
<p>En la estrategia IDENTITY se definen columnas que utilizan la estrategia <em>identity</em> de DB2, MySQL, MS SQL Server, Sybase, y HypersonicSQL. El identificador devuelto es de tipo <code>long</code>, <code>short</code>, <code>int</code>.</p>
</div>
<div class="paragraph">
<p>En la estrategia SEQUENCE crea una secuencia en DB2, PostgreSQL, Oracle, SAP DB; o un generador en InterBase. El tipo devuelto es también <code>long</code>, <code>short</code>, <code>int</code>.</p>
</div>
<div class="paragraph">
<p>Por último, en la estrategia TABLE se usa una tabla de la base de datos que guarda las últimas claves primarias generadas. Cada fila de la tabla corresponde a una clave primaria. La tabla tiene dos columnas: <code>pkColumnName</code> y <code>valueColumnName</code>. La columna <code>pkColumnValue</code> define el generador de clave primaria y la columna valor guarda la última generada.</p>
</div>
</div>
<div class="sect3">
<h4 id="_clave_primaria_compuesta">3.5.2. Clave primaria compuesta</h4>
<div class="paragraph">
<p>En ocasiones tenemos que mapear a JPA bases de datos heredadas con múltiples configuraciones y características. Una de las más frecuentes es el uso de las claves primarias compuestas, en las que dos columnas de la tabla forman una única clave primaria.</p>
</div>
<div class="paragraph">
<p>La especificación de JPA permite utilizar hasta tres estrategias distintas para manejar claves compuestas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Encapsular los atributos de la clave compuesta en una clase separada y marcarla como <code>@Embeddable</code> como un componente normal. Usar un atributo de esta clase como clave compuesta anotándolo con el atributo <code>@Id</code> como siempre.</p>
</li>
<li>
<p>Encapsular los atributos de la clave compuesta en una clase separada sin ninguna anotación. Usar un atributo de esta clase como clave compuesta anotándolo con <code>@EmbeddedId</code>.</p>
</li>
<li>
<p>Incluir la anotación <code>@IdClass</code> referenciando la clase que implementa la clave compuesta y declarar explícitamente todos los atributos que forman la clave compuesta.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>En todas las estrategias hay que definir una clase con los atributos de la clave compuesta. Lo que cambia es la forma de utilizar esa clase. Veamos un ejemplo. Supongamos que queremos mapear una tabla <code>USUARIOS</code> con una clave primaria compuesta formada por <code>USUARIO</code> y <code>DEPTO</code>, ambos <code>VARCHAR</code>. Usando la primera opción, que debemos crear una clase <code>UsuarioId</code> con la anotación <code>@Embeddable</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Embeddable</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">UsuarioId</span> <span class="tok-kd">implements</span> <span class="tok-n">Serializable</span> <span class="tok-o">{</span>
   <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">username</span><span class="tok-o">;</span>
   <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">departamento</span><span class="tok-o">;</span>

   <span class="tok-o">...</span>

   <span class="tok-kd">public</span> <span class="tok-kt">boolean</span> <span class="tok-nf">equals</span><span class="tok-o">(</span><span class="tok-n">Object</span> <span class="tok-n">o</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">o</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-n">o</span> <span class="tok-k">instanceof</span> <span class="tok-n">UsuarioId</span><span class="tok-o">)</span> <span class="tok-o">{</span>
         <span class="tok-n">Id</span> <span class="tok-n">that</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-n">Id</span><span class="tok-o">)</span> <span class="tok-n">o</span><span class="tok-o">;</span>
         <span class="tok-k">return</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">username</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">that</span><span class="tok-o">.</span><span class="tok-na">username</span><span class="tok-o">)</span> <span class="tok-o">&amp;&amp;</span>
                <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">departamento</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">that</span><span class="tok-o">.</span><span class="tok-na">departamento</span><span class="tok-o">);</span>
         <span class="tok-o">}</span> <span class="tok-k">else</span> <span class="tok-o">{</span>
            <span class="tok-k">return</span> <span class="tok-kc">false</span><span class="tok-o">;</span>
         <span class="tok-o">}</span>
      <span class="tok-o">}</span>

   <span class="tok-kd">public</span> <span class="tok-kt">int</span> <span class="tok-nf">hashCode</span><span class="tok-o">()</span> <span class="tok-o">{</span>
      <span class="tok-k">return</span> <span class="tok-n">username</span><span class="tok-o">.</span><span class="tok-na">hashCode</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-n">departamento</span><span class="tok-o">.</span><span class="tok-na">hashCode</span><span class="tok-o">();</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y en la entidad principal utilizamos esta clase como clave primaria, indicando los nombres de las columnas con la anotación <code>@AttributeOverride</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-nd">@Table</span><span class="tok-o">(</span><span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s">&quot;USUARIOS&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Usuario</span> <span class="tok-o">{</span>
   <span class="tok-nd">@Id</span>
   <span class="tok-nd">@AttributeOverrides</span><span class="tok-o">({</span>
      <span class="tok-nd">@AttributeOverride</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;username&quot;</span><span class="tok-o">,</span> <span class="tok-n">column</span><span class="tok-o">=</span><span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;USUARIO&quot;</span><span class="tok-o">)),</span>
      <span class="tok-nd">@AttributeOverride</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;depto&quot;</span><span class="tok-o">,</span> <span class="tok-n">column</span><span class="tok-o">=</span><span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;DEPTO&quot;</span><span class="tok-o">))</span>
   <span class="tok-o">})</span>
   <span class="tok-kd">private</span> <span class="tok-n">UsuarioId</span> <span class="tok-n">usuarioId</span><span class="tok-o">;</span>
   <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En la segunda estrategia creamos la clase <code>UsuarioId</code> pero sin la anotación <code>@Embeddable</code>. Después declaramos la clave primaria compuesta igual que antes, pero utilizando la anotación <code>@EmbeddedId</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-nd">@Table</span><span class="tok-o">(</span><span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s">&quot;USUARIOS&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Usuario</span> <span class="tok-o">{</span>
   <span class="tok-nd">@EmbeddedId</span>
   <span class="tok-nd">@AttributeOverrides</span><span class="tok-o">({</span>
      <span class="tok-nd">@AttributeOverride</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;username&quot;</span><span class="tok-o">,</span> <span class="tok-n">column</span><span class="tok-o">=</span><span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;USUARIO&quot;</span><span class="tok-o">)),</span>
      <span class="tok-nd">@AttributeOverride</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;depto&quot;</span><span class="tok-o">,</span> <span class="tok-n">column</span><span class="tok-o">=</span><span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;DEPTO&quot;</span><span class="tok-o">))</span>
   <span class="tok-o">})</span>
   <span class="tok-kd">private</span> <span class="tok-n">UsuarioId</span> <span class="tok-n">usuarioId</span><span class="tok-o">;</span>
  <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_clave_ajena_compuesta">3.5.3. Clave ajena compuesta</h4>
<div class="paragraph">
<p>Por último, también entidads posible utilizar la nueva clave primaria compuesta como una clave ajena. Supongamos una entidad <code>Item</code> que tiene una relación muchos-a-uno con <code>Usuario</code>. Primero mapeamos la asociación de <code>Item</code> a <code>Usuario</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@ManyToOne</span>
<span class="tok-nd">@JoinColumns</span><span class="tok-o">({</span>
  <span class="tok-nd">@JoinColumn</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;USUARIO&quot;</span><span class="tok-o">,</span> <span class="tok-n">referencedColumnName</span> <span class="tok-o">=</span> <span class="tok-s">&quot;USUARIO&quot;</span><span class="tok-o">),</span>
  <span class="tok-nd">@JoinColumn</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;DEPTO&quot;</span><span class="tok-o">,</span> <span class="tok-n">referencedColumnName</span> <span class="tok-o">=</span> <span class="tok-s">&quot;DEPTO&quot;</span><span class="tok-o">)</span>
<span class="tok-o">})</span>
<span class="tok-kd">private</span> <span class="tok-n">Usuario</span> <span class="tok-n">vendedor</span><span class="tok-o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La diferencia principal con un mapeo normal <code>@ManyToOne</code> es el número de columnas usadas. Si no se usara la anotación <code>referencedColumnName</code> habría que tener cuidado en definir las columnas en el mismo orden en el que se declaran en la clase de la clave primaria.</p>
</div>
<div class="paragraph">
<p>El mapeo inverso de <code>Usuario</code> a <code>Item</code> es aun mas sencillo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@OneToMany</span><span class="tok-o">(</span><span class="tok-n">mappedBy</span> <span class="tok-o">=</span> <span class="tok-s">&quot;seller&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">private</span> <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Item</span><span class="tok-o">&gt;</span> <span class="tok-n">itemsForAuction</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">HashSet</span><span class="tok-o">&lt;</span><span class="tok-n">Item</span><span class="tok-o">&gt;();</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_mapeado_de_las_relaciones_de_herencia">3.6. Mapeado de las relaciones de herencia</h3>
<div class="paragraph">
<p>Una de las diferencias fundamentales entre un modelo orientado a objetos y un modelo relacional es la existencia en el primero de herencia entre clases o entidades. La definición de herencia es algo muy natural y útil en modelos orientados a objetos. Por ejemplo, siguiendo con nuestro ejemplo de <code>Empleado</code>, supongamos que queremos definir dos tipos de empleado: <code>EmpleadoContratado</code> y <code>EmpleadoBecario</code>, cada uno de ellos con sus propios atributos adicionales. Supongamos también que cualquier empleado deba ser de uno de los subtipos, de forma que no se permita crear instancias del tipo padre. Para ello, en programación OO deberíamos definir la clase <code>Empleado</code> como <em>abstracta</em> y las dos clases deberían ser subclases de ella.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa03/jpa-herencia.png" alt="Relaciones de herencia" width="50%">
</div>
</div>
<div class="paragraph">
<p>JPA permite mapear estas relaciones de herencia en tablas de la base de datos. Existen tres posibles estrategias para realizar este mapeo:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Tabla única</p>
</li>
<li>
<p>Tablas join</p>
</li>
<li>
<p>Una tabla por clase</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Vamos a ver la estrategia más común, la de tabla única.</p>
</div>
<div class="paragraph">
<p>En la estrategia de tabla única, todas las clases en la jerarquía de herencia se mapean en una única tabla. Esta tabla contiene almacenadas todas las instancias de todos los posibles subtipos. Los distintos objetos en la jerarquía OO se identifican utilizando una columna especial denominada columna discriminante (<em>disriminator column</em>). Esta columna contiene un valor distinto según la clase a la que pertenezca el objeto. Además, las columnas que no se correspondan con atributos de un tipo dado se rellenan con NULL.</p>
</div>
<div class="paragraph">
<p>Supongamos que un <code>EmpleadoBecario</code> tiene un atributo <code>SeguroMedico</code> de tipo <code>Long</code> con la aportación que debe realizar la empresa para el seguro del empleado. Y el <code>EmpleadoContratado</code> tienen un atributo <code>PlanPensiones</code> de tipo <code>Long</code> con la aportación para el plan de pensiones.</p>
</div>
<div class="paragraph">
<p>En la figura siguiente aparece la tabla única que guardaría entidades de ambos tipos. La columna discriminante es la columna <code>Tipo</code>. La tabla contiene todos los registros. Los registros que se corresponden con empleados contratados tienen el valor <code>Contrato</code> en la columna discriminante y los empleados becarios <code>Beca</code>. Las columnas que no se correspondan con el tipo de entidad están a NULL.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa03/jpa-herencia-tabla.png" alt="Tabla herencia" width="66%">
</div>
</div>
<div class="paragraph">
<p>Para implementar la herencia en JPA se utiliza la anotación <code>@Inheritance</code> en la clase padre. En esta anotación hay que indicar la estrategia de mapeado utilizada con el elemento <code>strategy</code>. También hay que añadir a la clase padre la anotación <code>@DiscriminatorValue</code> que indica la columna discriminante. El tipo de la columna discriminante se define con el elemento <code>discriminatorType</code> que puede tomar como valor las constantes <code>DiscriminatorType.STRING</code>, <code>DiscriminatorType.INTEGER</code> o <code>DiscriminatorType.CHAR</code>.</p>
</div>
<div class="paragraph">
<p>El siguiente código muestra cómo sería la definición de la clase <code>Empleado</code>. En este caso la estamos definiendo como <code>abstract</code> para impedir crear instancias y obligar a que las instancias sean de las clases hijas. No es obligatorio hacerlo así, podría darse el caso de que nos interesara también tener instancias de la clase padre sin especificar el tipo de empleado.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-nd">@Inheritance</span><span class="tok-o">(</span><span class="tok-n">strategy</span><span class="tok-o">=</span><span class="tok-n">InheritanceType</span><span class="tok-o">.</span><span class="tok-na">SINGLE_TABLE</span><span class="tok-o">)</span>
<span class="tok-nd">@DiscriminatorColumn</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;Tipo&quot;</span><span class="tok-o">,</span> <span class="tok-n">discriminatorType</span><span class="tok-o">=</span><span class="tok-n">DiscriminatorType</span><span class="tok-o">.</span><span class="tok-na">STRING</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">abstract</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
   <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Las subclases de la jerarquía se definen igual que en Java estándar (recordemos que las entidades son clases Java normales) con la palabra clave <code>extends</code>. Lo único que hay que añadir es el valor en la columna discriminante que se le asigna a esta clase. Para ello se utiliza la anotación <code>DiscriminatorValue</code> y su atributo <code>value</code>. Por ejemplo, si el <code>EmpleadoBecario</code> va a tener como valor la cadena <code>Beca</code>, hay que indicar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@DiscriminatorValue</span><span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-s">&quot;Beca&quot;</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Las definiciones de las subclases las mostramos a continuación. Primero la clase <code>EmpleadoContratado</code>, que se asocia al valor <code>Contrato</code> de la columna discriminante. En la nueva clase se define al atributo específico <code>Long planPensiones</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.*</span><span class="tok-o">;</span>

<span class="tok-nd">@Entity</span>
<span class="tok-nd">@DiscriminatorValue</span><span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-s">&quot;Contrato&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">EmpleadoContratado</span> <span class="tok-kd">extends</span> <span class="tok-n">Empleado</span> <span class="tok-o">{</span>
   <span class="tok-kd">private</span> <span class="tok-n">Long</span> <span class="tok-n">planPensiones</span><span class="tok-o">;</span>

   <span class="tok-kd">public</span> <span class="tok-n">Long</span> <span class="tok-nf">getPlanPensiones</span><span class="tok-o">()</span> <span class="tok-o">{</span>
      <span class="tok-k">return</span> <span class="tok-n">planPensiones</span><span class="tok-o">;</span>
   <span class="tok-o">}</span>

   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setPlanPensiones</span><span class="tok-o">(</span><span class="tok-n">Long</span> <span class="tok-n">planPensiones</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">planPensiones</span> <span class="tok-o">=</span> <span class="tok-n">planPensiones</span><span class="tok-o">;</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por último, la clase <code>EmpleadoBecario</code> se distingue por el valor <code>Beca</code>. En la clase se define el nuevo atributo <code>Long seguroMedico</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-nd">@DiscriminatorValue</span><span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-s">&quot;Beca&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">EmpleadoBecario</span> <span class="tok-kd">extends</span> <span class="tok-n">Empleado</span> <span class="tok-o">{</span>
   <span class="tok-kd">private</span> <span class="tok-n">Long</span> <span class="tok-n">seguroMedico</span><span class="tok-o">;</span>

   <span class="tok-kd">public</span> <span class="tok-n">Long</span> <span class="tok-nf">getSeguroMedico</span><span class="tok-o">()</span> <span class="tok-o">{</span>
      <span class="tok-k">return</span> <span class="tok-n">seguroMedico</span><span class="tok-o">;</span>
   <span class="tok-o">}</span>

   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setSeguroMedico</span><span class="tok-o">(</span><span class="tok-n">Long</span> <span class="tok-n">seguroMedico</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">seguroMedico</span> <span class="tok-o">=</span> <span class="tok-n">seguroMedico</span><span class="tok-o">;</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En las clases hijas no se define la clave primaria. Debe estar definida en la clase padre. Lo mismo sucede con los método <code>equals()</code> y <code>hashCode()</code>, los debemos definir en la clase padre. En la comprobación de igualdad se debe utilizar la comprobación de identidad de clase para identificar como distintos objetos de distintas subclases (podemos usar el asistente de Eclipse para generar el método).</p>
</div>
<div class="paragraph">
<p>Con esto es suficiente. Una vez definidas, las entidades se usan como clases Java normales:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">Empleado</span> <span class="tok-n">emp</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">EmpleadoContratado</span><span class="tok-o">();</span>
<span class="tok-n">emp</span><span class="tok-o">.</span><span class="tok-na">setId</span><span class="tok-o">(</span><span class="tok-n">id</span><span class="tok-o">);</span>
<span class="tok-n">emp</span><span class="tok-o">.</span><span class="tok-na">setNombre</span><span class="tok-o">(</span><span class="tok-n">nombre</span><span class="tok-o">);</span>
<span class="tok-n">emp</span><span class="tok-o">.</span><span class="tok-na">setSueldo</span><span class="tok-o">(</span><span class="tok-n">sueldo</span><span class="tok-o">);</span>
<span class="tok-n">emp</span><span class="tok-o">.</span><span class="tok-na">setPlanPensiones</span><span class="tok-o">(</span><span class="tok-n">sueldo</span><span class="tok-o">/</span><span class="tok-mi">10</span><span class="tok-o">);</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_bean_validation">3.7. Bean Validation</h3>
<div class="paragraph">
<p><em>Bean Validation</em> es un API de la especificación Java EE con el que es posible definir restricciones a los posibles valores de los atributos de cualquier clase Java definida en forma de <em>JavaBean</em> utilizando anotaciones. Existen unas restricciones predefinidas y es posible definir validaciones <em>custom</em>. En la última versión 1.1 de la especificación se incluye también la posibilidad de validad los parámetros y los valores devueltos en cualquier método Java.</p>
</div>
<div class="paragraph">
<p>El API se puede aplicar a cualquier clase Java, no está limitada a entidades JPA. De hecho es muy útil para validar datos que se reciben en las peticiones a los servicios antes de crear las propias entidades. Sin embargo en los ejemplos que mostramos a continuación sólo utilizamos el API para anotar atributos de entidades JPA.</p>
</div>
<div class="paragraph">
<p>Al igual que JPA, <em>Bean Validation</em> es parte de la especificación Java EE pero puede utilizarse en aplicaciones Java <em>standalone</em> Java SE, junto con JPA. El propio gestor de persistencia detecta las anotaciones y se encarga de asegurar las restricciones antes de actualizar los datos en la base de datos. Para usar <em>Bean Validation</em> en una aplicación Java <em>standalone</em> basta con incluir las librerías necesarias en el classpath (en nuestro caso, actualizaando el POM de Maven).</p>
</div>
<div class="paragraph">
<p>La última especificación aprobada es la <a href="https://www.jcp.org/en/jsr/detail?id=349">JSR 349</a> correspondiente a Bean Validation 1.1. Puedes consultar en el siguiente enlace el <a href="https://docs.oracle.com/javaee/7/api/javax/validation/package-summary.html">API completo de Bean Validation</a>. El líder de la especificación es Emmanuel Bernard, de Red Hat. Mantiene <a href="http://beanvalidation.org">una página sobre el API</a> en la que también publica novedades y noticias.</p>
</div>
<div class="sect3">
<h4 id="_configuración_de_maven_y_jpa">3.7.1. Configuración de Maven y JPA</h4>
<div class="paragraph">
<p>La activación de <em>Bean Validation</em> es automática si utilizamos JPA. Hay que incluir las siguiente dependencias en el <code>pom.xml</code>. La primera es la implementación de Hibernate del API de validación, y las otras dos son dos librerías necesarias que hay que incluir sólo si estamos ejecutando una aplicación <em>standalone</em>. En el caso de una aplicación web, las proporciona el servidor de aplicaciones.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;dependency&gt;</span>
    <span class="tok-nt">&lt;groupId&gt;</span>org.hibernate<span class="tok-nt">&lt;/groupId&gt;</span>
    <span class="tok-nt">&lt;artifactId&gt;</span>hibernate-validator<span class="tok-nt">&lt;/artifactId&gt;</span>
    <span class="tok-nt">&lt;version&gt;</span>5.1.3.Final<span class="tok-nt">&lt;/version&gt;</span>
<span class="tok-nt">&lt;/dependency&gt;</span>
    <span class="tok-nt">&lt;dependency&gt;</span>
    <span class="tok-nt">&lt;groupId&gt;</span>javax.el<span class="tok-nt">&lt;/groupId&gt;</span>
    <span class="tok-nt">&lt;artifactId&gt;</span>javax.el-api<span class="tok-nt">&lt;/artifactId&gt;</span>
    <span class="tok-nt">&lt;version&gt;</span>2.2.4<span class="tok-nt">&lt;/version&gt;</span>
<span class="tok-nt">&lt;/dependency&gt;</span>
    <span class="tok-nt">&lt;dependency&gt;</span>
    <span class="tok-nt">&lt;groupId&gt;</span>org.glassfish.web<span class="tok-nt">&lt;/groupId&gt;</span>
    <span class="tok-nt">&lt;artifactId&gt;</span>el-impl<span class="tok-nt">&lt;/artifactId&gt;</span>
    <span class="tok-nt">&lt;version&gt;</span>2.2<span class="tok-nt">&lt;/version&gt;</span>
<span class="tok-nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por defecto, el <em>entity manager</em> de JPA realiza la comprobación de las restricciones <em>Bean Validation</em> si el JAR se encuentra en el classpath. Se puede definir el comportamiento en el fichero <code>persistence.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;persistence</span> <span class="tok-na">version=</span><span class="tok-s">&quot;2.1&quot;</span>
             <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://xmlns.jcp.org/xml/ns/persistence&quot;</span>
             <span class="tok-na">xmlns:xsi=</span><span class="tok-s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
             <span class="tok-na">xsi:schemaLocation=</span><span class="tok-s">&quot;http://xmlns.jcp.org/xml/ns/persistence&quot;</span><span class="tok-nt">&gt;</span>

    <span class="tok-nt">&lt;persistence-unit</span> <span class="tok-na">name=</span><span class="tok-s">&quot;mensajes&quot;</span> <span class="tok-na">transaction-type=</span><span class="tok-s">&quot;RESOURCE_LOCAL&quot;</span><span class="tok-nt">&gt;</span>

        <span class="tok-nt">&lt;provider&gt;</span>org.hibernate.jpa.HibernatePersistenceProvider<span class="tok-nt">&lt;/provider&gt;</span>
        <span class="tok-nt">&lt;class&gt;</span>org.expertojava.jpa.mensajes.modelo.Autor<span class="tok-nt">&lt;/class&gt;</span>
        <span class="tok-nt">&lt;class&gt;</span>org.expertojava.jpa.mensajes.modelo.Mensaje<span class="tok-nt">&lt;/class&gt;</span>

        <span class="tok-nt">&lt;validation-mode&gt;</span>CALLBACK<span class="tok-nt">&lt;/validation-mode&gt;</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1">

        <span class="tok-nt">&lt;properties&gt;</span>

            <span class="tok-c">&lt;!-- JPA properties --&gt;</span>

            <span class="tok-c">&lt;!-- Hibernate properties --&gt;</span>

	<span class="tok-nt">&lt;/properties&gt;</span>
    <span class="tok-nt">&lt;/persistence-unit&gt;</span>
<span class="tok-nt">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1"></td>
<td>Configuración de la validación <em>Bean Validation</em></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Los posibles valores del campo <code>validation-mode</code> son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>AUTO</code>: Si el JAR de <em>Bean Validation</em> se encuentra en el classpath se activa el modo <code>CALLBACK</code>, si no no pasa nada</p>
</li>
<li>
<p><code>CALLBACK</code>: Se validan las entidades usando <em>Bean Validation</em> en el momento de creación, actualización y borrado. Si el JAR de validación no se encuentra en el classpath se lanza una excepción.</p>
</li>
<li>
<p><code>NONE</code>: No se realiza la validación de <em>Bean Validation</em></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_anotaciones_de_validación_predefinidas">3.7.2. Anotaciones de validación predefinidas</h4>
<div class="paragraph">
<p>Mediante las anotaciones predefinidas en el <a href="https://docs.oracle.com/javaee/7/api/javax/validation/constraints/package-summary.html">paquete javax.validation.constraints</a> podemos restringir los valores que pueden tomar atributos de un JavaBean (clase Java en la que se definen atributos y <em>getters</em> y <em>setters</em>). Las entidades JPA son JavaBeans, por lo que podemos utilizar este API para restringir los valores de sus campos.</p>
</div>
<div class="paragraph">
<p>Las restricciones definidas por <em>Bean Validation</em> son independientes de las definidas por las anotaciones JPA, se validan y comprueban en memoria y no generan ninguna anotación adicional en el esquema de base de datos.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, la siguiente definición de la entidad <code>Empleado</code> obliga a que el nombre y los apellidos no sean <code>null</code> (en memoria), que el tamaño de la cadena no sea mayor de 25 caracteres y que el sueldo no sea mayor de 50.000.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">import</span> <span class="tok-nn">javax.validation.constraints.NotNull</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.validation.constraints.Size</span><span class="tok-o">;</span>

<span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
    <span class="tok-nd">@Id</span>
    <span class="tok-nd">@GeneratedValue</span><span class="tok-o">(</span><span class="tok-n">strategy</span><span class="tok-o">=</span><span class="tok-n">GenerationType</span><span class="tok-o">.</span><span class="tok-na">AUTO</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">idEmpleado</span><span class="tok-o">;</span>

    <span class="tok-nd">@NotNull</span>
    <span class="tok-nd">@Size</span><span class="tok-o">(</span><span class="tok-n">max</span> <span class="tok-o">=</span> <span class="tok-mi">25</span><span class="tok-o">)</span>
    <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">nullable</span> <span class="tok-o">=</span> <span class="tok-kc">false</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>

    <span class="tok-nd">@NotNull</span>
    <span class="tok-nd">@Size</span><span class="tok-o">(</span><span class="tok-n">max</span> <span class="tok-o">=</span> <span class="tok-mi">25</span><span class="tok-o">)</span>
    <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">nullable</span> <span class="tok-o">=</span> <span class="tok-kc">false</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">apellidos</span><span class="tok-o">;</span>

    <span class="tok-nd">@NotNull</span>
    <span class="tok-nd">@DecimalMax</span><span class="tok-o">(</span><span class="tok-n">value</span> <span class="tok-o">=</span> <span class="tok-s">&quot;50000.00&quot;</span><span class="tok-o">)</span>
    <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">nullable</span> <span class="tok-o">=</span> <span class="tok-kc">false</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">Double</span> <span class="tok-n">sueldo</span><span class="tok-o">;</span>

    <span class="tok-kd">public</span> <span class="tok-nf">Empleado</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">,</span> <span class="tok-n">String</span> <span class="tok-n">apellidos</span><span class="tok-o">,</span> <span class="tok-n">Double</span> <span class="tok-n">sueldo</span><span class="tok-o">)</span> <span class="tok-o">{</span>
       <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">nombre</span> <span class="tok-o">=</span> <span class="tok-n">numbre</span><span class="tok-o">;</span>
       <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">apellidos</span> <span class="tok-o">=</span> <span class="tok-n">apellidos</span><span class="tok-o">;</span>
       <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">sueldo</span> <span class="tok-o">=</span> <span class="tok-n">sueldo</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">int</span> <span class="tok-nf">getIdEmpleado</span><span class="tok-o">()</span> <span class="tok-o">{</span>
       <span class="tok-k">return</span> <span class="tok-n">idEmployee</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">private</span> <span class="tok-kt">void</span> <span class="tok-nf">setIdEmpleado</span><span class="tok-o">(</span><span class="tok-kt">int</span> <span class="tok-n">idEmpleado</span><span class="tok-o">)</span> <span class="tok-o">{</span>
       <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">idEmpleado</span> <span class="tok-o">=</span> <span class="tok-n">idEmpleado</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getNombre</span><span class="tok-o">()</span> <span class="tok-o">{</span>
       <span class="tok-k">return</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setNombre</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">)</span> <span class="tok-o">{</span>
       <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">nombre</span> <span class="tok-o">=</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getApellidos</span><span class="tok-o">()</span> <span class="tok-o">{</span>
      <span class="tok-k">return</span> <span class="tok-n">apellidos</span><span class="tok-o">;</span>
   <span class="tok-o">}</span>

   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setApellidos</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">apellidos</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">apellidos</span> <span class="tok-o">=</span> <span class="tok-n">apellidos</span><span class="tok-o">;</span>
   <span class="tok-o">}</span>

   <span class="tok-kd">public</span> <span class="tok-n">Double</span> <span class="tok-nf">getSueldo</span><span class="tok-o">()</span> <span class="tok-o">{</span>
      <span class="tok-k">return</span> <span class="tok-n">sueldo</span><span class="tok-o">;</span>
   <span class="tok-o">}</span>

   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setSueldo</span><span class="tok-o">(</span><span class="tok-n">Double</span> <span class="tok-n">sueldo</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">sueldo</span> <span class="tok-o">=</span> <span class="tok-n">sueldo</span><span class="tok-o">;</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La lista de restricciones estándar que proporciona el API es la siguiente:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33%;">
<col style="width: 33%;">
<col style="width: 33%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Anotación</th>
<th class="tableblock halign-left valign-top">Descripción</th>
<th class="tableblock halign-left valign-top">Ejemplo</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@AssertFalse</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">El valor debe ser <code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@AssertFalse</code><br>
<code>boolean noSoportado;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@AssertTrue</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">El valor debe ser <code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@AssertTrue</code><br>
<code>boolean siempreActivo;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@DecimalMax</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">El valor debe ser un valor decimal menor o igual que el número especificado</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@DecimalMax("30.00")</code><br>
<code>BigDecimal descuento;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@DecimalMin</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">El valor debe ser un valor decimal mayor o igual que el número especificado</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@DecimalMin("5.00")</code><br>
<code>BigDecimal descuento;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Digits</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">El valor debe ser un número dentro de un rango especificado. El elemento <code>integer</code> especifica el máximo número de dígitos enteros y el elemento <code>fraction</code> el número máximo de dígitos fraccionales.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Digits(integer=6, fraction=2)</code><br>
<code>BigDecimal precio;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Future</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">El valor debe ser una fecha en el futuro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Future</code><br>
<code>Date eventoFuturo;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Max</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">El valor debe ser menor o igual que el número especificado</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Max(10)</code><br>
<code>int cantidad;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Min</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">El valor debe ser mayor o igual que el número especificado</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Min(5)</code><br>
<code>int cantidad;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@NotNull</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">El valor no debe ser <code>null</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@NotNull</code>+
<code>String username;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Null</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">El valor debe ser <code>null</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Null</code><br>
<code>String cadenaNoUsada;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Past</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">El valor debe ser una fecha en el pasado</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Past</code><br>
`Date birthday;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Pattern</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">El valor debe ser una cadena que cumple la expresión regular definida en el elemento <code>regexp</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Pattern(regexp="\\(\\d{3}\\)\\d{3}-\\d{4}")</code><br>
<code>String numeroTelefono;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Size</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Se evalúa el tamaño del atributo y se comprueba si cumple la dimensión especificada. Se puede aplicar a <code>String</code>, <code>Collection</code>, <code>Map</code> o <code>Array</code>. Se pueden utilizar los elementos opcionales <code>min</code> y <code>max</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Size(min=2, max=240)</code><br>
<code>String mensajeCorto;</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_proceso_de_validación">3.7.3. Proceso de validación</h4>
<div class="paragraph">
<p>Si algún valor no cumple la restricción, se lanza una excepción <em>unchecked</em> (de tiempo de ejecución) de tipo <code>javax.validation.ConstraintViolationException</code>. El momento en que se hace la validación depende de la implementación del API. Hibernate valida todas las restricciones cuando hace un <em>flush</em> a la base de datos. Otros proveedores de persistencia (EclipseLink, por ejemplo) lo hacen en el propio método <code>persist</code> o <code>merge</code>.</p>
</div>
<div class="paragraph">
<p>En todas las operaciones de la capa de servicio se deben capturar las excepciones y cerrar la transacción y el <em>entity manager</em> de forma correcta. Vamos a actualizar el código de una de las operaciones que vimos en la sesión anterior con el manejo de las excepciones. La llamada <code>em.flush</code> justo antes de realizar el commit de la transacción asegura que el proveedor (en nuestro caso Hibernate) realiza la validación de las restricciones antes y que se lanza la excepción <code>ConstraintViolationException</code>. En el caso de Hibernate, si no lo pusiéramos, la excepción se lanzaría dentro del <code>tx.commit()</code> y sería envuelta por una excepción de tipo <code>RollbackException</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">PeliculaServicio</span> <span class="tok-o">{</span>

   <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">Log</span> <span class="tok-n">logger</span> <span class="tok-o">=</span> <span class="tok-n">LogFactory</span><span class="tok-o">.</span><span class="tok-na">getLog</span><span class="tok-o">(</span><span class="tok-n">BibliotecaBR</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>

   <span class="tok-c1">//</span>
   <span class="tok-c1">// Hay que actualizar todos los métodos de negocio hay para que capturen</span>
   <span class="tok-c1">// las excepciones producidas por la capa de validación y de datos</span>
   <span class="tok-c1">//</span>

   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">actualizaRecaudacionPelicula</span><span class="tok-o">(</span>
         <span class="tok-n">Long</span> <span class="tok-n">idPelicula</span><span class="tok-o">,</span>
	 <span class="tok-n">Double</span> <span class="tok-n">recaudacion</span><span class="tok-o">)</span> <span class="tok-o">{</span>

   <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">EmfSingleton</span><span class="tok-o">.</span><span class="tok-na">getInstance</span><span class="tok-o">().</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
   <span class="tok-n">EntityTransaction</span> <span class="tok-n">tx</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">();</span>
   <span class="tok-k">try</span> <span class="tok-o">{</span>                        <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1">
      <span class="tok-n">tx</span><span class="tok-o">.</span><span class="tok-na">begin</span><span class="tok-o">();</span>
      <span class="tok-n">PeliculaDao</span> <span class="tok-n">daoPelicula</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">PeliculaDao</span><span class="tok-o">(</span><span class="tok-n">em</span><span class="tok-o">);</span>
      <span class="tok-n">Pelicula</span> <span class="tok-n">pelicula</span> <span class="tok-o">=</span> <span class="tok-n">daoPelicula</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">idPelicula</span><span class="tok-o">);</span>
      <span class="tok-n">pelicula</span><span class="tok-o">.</span><span class="tok-na">setRecaudacion</span><span class="tok-o">(</span><span class="tok-n">recaudacion</span><span class="tok-o">);</span>
      <span class="tok-n">daoPelicula</span><span class="tok-o">.</span><span class="tok-na">update</span><span class="tok-o">(</span><span class="tok-n">pelicula</span><span class="tok-o">);</span>
      <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">flush</span><span class="tok-o">();</span>	<img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/2.png" alt="2">
      <span class="tok-n">tx</span><span class="tok-o">.</span><span class="tok-na">commit</span><span class="tok-o">();</span>              <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/3.png" alt="3">
   <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">Exception</span> <span class="tok-n">ex</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-n">tx</span><span class="tok-o">.</span><span class="tok-na">rollback</span><span class="tok-o">();</span>            <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/4.png" alt="4">
      <span class="tok-n">String</span> <span class="tok-n">mensaje</span> <span class="tok-o">=</span> <span class="tok-s">&quot;Error al actualizar la pelicula &quot;</span>
                       <span class="tok-o">+</span> <span class="tok-n">id</span> <span class="tok-o">+</span> <span class="tok-s">&quot; con la recaudación &quot;</span> <span class="tok-o">+</span> <span class="tok-n">recaudacion</span><span class="tok-o">;</span>
      <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-na">error</span><span class="tok-o">(</span><span class="tok-n">mensaje</span><span class="tok-o">,</span> <span class="tok-n">ex</span><span class="tok-o">);</span>
      <span class="tok-k">throw</span><span class="tok-o">(</span><span class="tok-n">ex</span><span class="tok-o">)</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/5.png" alt="5">
   <span class="tok-o">}</span> <span class="tok-k">finally</span> <span class="tok-o">{</span>
      <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/6.png" alt="6">
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1"></td>
<td>Todas las operaciones de actualización de la base de datos se hacen dentro de un <code>try</code></td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/2.png" alt="2"></td>
<td>Se fuerza que Hibernate compruebe las restricciones llamando un <code>flush()</code></td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/3.png" alt="3"></td>
<td>Si todo ha ido bien, se hace un commit de la transacción</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/4.png" alt="4"></td>
<td>Se hace un rollback cuando se ha producido una excepción</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/5.png" alt="5"></td>
<td>Se logea un mensaje con el problema y se lanza de nuevo la excepción</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/6.png" alt="6"></td>
<td>Se cierra la conexión del <em>entity manager</em></td>
</tr>
</table>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios_3">3.8. Ejercicios</h3>
<div class="paragraph">
<p>En esta sesión de ejercicios vamos a continuar con el proyecto <code>filmoteca</code>, en concreto vamos a añadir lo aprendido en esta sesión a la clase <code>Pelicula</code>.</p>
</div>
<div class="sect3">
<h4 id="__0_5_puntos_mapeado_de_tablas_y_campos_y_restricciones_em_bean_validation_em">3.8.1. (0,5 puntos) Mapeado de tablas y campos y restricciones <em>Bean Validation</em></h4>
<div class="paragraph">
<p>Modifica los campos da la entidad <code>Pelicula</code> utilizando alguna de las anotaciones y de las restricciones <em>Bean Validation</em> vistas en la clase de hoy:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>titulo</code>: 70 caracteres como máximo, no nulo</p>
</li>
<li>
<p><code>duracion</code> (<code>Integer</code>): minutos. Minimo 0 y máximo 999.</p>
</li>
<li>
<p><code>sinopsis</code> (<code>String</code>): 255 caracteres como máximo, puede ser <code>null</code></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="__0_5_puntos_relación_de_herencia_en_code_pelicula_code">3.8.2. (0,5 puntos) Relación de herencia en <code>Pelicula</code></h4>
<div class="paragraph">
<p>Haz que <code>Película</code> sea una clase abstracta y define las 3 clases concretas que sean hijas suyas. Por ejemplo: <code>Largometraje</code>, <code>Corto</code> y <code>Documental</code></p>
</div>
</div>
<div class="sect3">
<h4 id="__0_5_puntos_restricciones_code_bean_validation_code">3.8.3. (0,5 puntos) Restricciones <code>Bean Validation</code></h4>
<div class="paragraph">
<p>Comprueba que las validaciones funcionan correctamente con algún test</p>
</div>
</div>
<div class="sect3">
<h4 id="__0_5_puntos_clase_de_servicio">3.8.4. (0,5 puntos) Clase de servicio</h4>
<div class="ulist">
<ul>
<li>
<p>Crea la clase de excepciones de negocio <code>FilmotecaException</code>.</p>
</li>
<li>
<p>Actualiza los métodos de la clase de servicio con la gestión de las excepciones para capturar errores de validación y genera un error del tipo anterior cuando ha sucedido algo</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion04">4. Mapeo entidad-relación: relaciones</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_conceptos_previos">4.1. Conceptos previos</h3>
<div class="paragraph">
<p>Antes de comenzar a detallar los aspectos del mapeo de las relaciones entre entidades vamos a repasar algunos conceptos básicos y alguna terminología. Es muy importante tener claro estos conceptos antes de intentar entender los entresijos a los que nos vamos a enfrentar más adelante.</p>
</div>
<div class="paragraph">
<p>Vamos a ilustrar estos conceptos con la relación que vimos en la sesión 1. Allí definíamos dos entidades, <code>Autor</code> y <code>Mensaje</code> y una relación muchos-a-uno bidireccional de <code>Mensaje</code> a <code>Autor</code>. Un autor puede escribir muchos mensajes.</p>
</div>
<div class="paragraph">
<p>La relación la representamos con la figura siguiente, en donde se muestran las dos entidades unidas con una flecha con dos puntas que indica que la relación es bidireccional y con la anotación de la cardinalidad de cada entidad bajo la flecha. La flecha presupone un atributo con el mismo nombre y cardinalidad de la entidad a la que se apunta:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>En la entidad <code>Mensaje</code> un atributo que define un <code>Autor</code></p>
</li>
<li>
<p>En la entidad <code>Autor</code> un atributo que define una colección de entidades <code>Mensaje</code></p>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa04/mensaje-autor-entidad.png" alt="Relación" width="50%">
</div>
</div>
<div class="paragraph">
<p>El modelo físico que se genera con el mapeado es el que se muestra en la siguiente figura. La tabla <code>MENSAJE</code> contiene una clave ajena hacia la tabla <code>AUTOR</code>, en su columna <code>AUTOR</code>. Los valores de esta columna guardan claves primarias de autores. De esta forma relacionamos cada mensaje con el autor que lo ha escrito. Cuando queramos obtener todos los mensajes de un determinado autor se deberá hacer un <code>SELECT</code> en la tabla <code>MENSAJE</code> buscando todas las filas que tengan como clave ajena el autor que buscamos.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa04/mensaje-autor-tabla.png" alt="Tablas relación" width="50%">
</div>
</div>
<div class="paragraph">
<p>Vamos a ver las distintas características que hay que definir para especificar completamente una relación en el modelo de entidades, utilizando como ejemplo esta relación entre <code>Mensaje</code> y <code>Autor</code>.</p>
</div>
<div class="sect3">
<h4 id="_direccionalidad">4.1.1. Direccionalidad</h4>
<div class="paragraph">
<p>En primer lugar debemos considerar la <em>direccionalidad</em> de la relación. Nos indica si desde una entidad podemos obtener la otra. Una relación puede ser <em>unidireccional</em> cuando desde la <em>entidad origen</em> se puede obtener la <em>entidad destino</em> o <em>bidireccional</em>, como es el caso del ejemplo, cuando desde ambas partes de la relación se puede obtener la otra parte.</p>
</div>
<div class="paragraph">
<p>En un diagrama UML, la direccionalidad viene indicada por la dirección de la flecha. En el caso del ejemplo anterior tenemos una relación bidireccional. Podemos pedirle a una instancia de <code>Mensaje</code> que nos diga con que <code>Autor</code> está relacionado. En la entidad de <code>Mensaje</code> habrá un método que devuelve el autor. Y al ser la relación bidireccional podemos hacer lo mismo al revés, podemos pedirle a un <code>Autor</code> que nos diga con qué <code>Mensajes</code> está relacionado. En la entidad <code>Autor</code> hay un método que devuelve una colección de mensajes. Por tanto, los métodos definidos por la relación son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>En la entidad <code>Mensaje</code>: <code>public Autor getAutor()</code></p>
</li>
<li>
<p>En la entidad <code>Autor</code>: <code>public Set&lt;Mensaje&gt; getMensajes()</code></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_cardinalidad">4.1.2. Cardinalidad</h4>
<div class="paragraph">
<p>La cardinalidad de una relación define el número de instancias de una entidad que pueden estar relacionada con otras. Atendiendo a la cardinalidad, una relación puede ser <em>uno-a-uno</em>, <em>uno-a-muchos</em>, <em>muchos-a-uno</em> o <em>muchos-a-muchos</em>.</p>
</div>
<div class="paragraph">
<p>En el caso del ejemplo tenemos una relación muchos-a-uno entre <code>Mensaje</code> y <code>Autor</code>. Al ser una relación bidireccional, también podríamos considerar esta relación como una relación uno-a-muchos entre <code>Autor</code> y <code>Mensaje</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_entidad_propietaria_de_la_relación">4.1.3. Entidad propietaria de la relación</h4>
<div class="paragraph">
<p>¿Cómo se realiza el mapeo de una relación? La forma más habitual es definir una columna adicional en la tabla asociada a una de las entidades con la clave primaria de la otra tabla con la que está relacionada. Esta columna hace de <em>clave ajena</em> hacia la otra tabla. Decimos que esta entidad cuya tabla contiene la clave ajena hacia la otra es la <em>propietaria</em> de la relación.</p>
</div>
<div class="paragraph">
<p>En el ejemplo visto, la relación se mapea haciendo que la tabla <code>MENSAJE</code> contenga una clave ajena hacia la tabla <code>AUTOR</code>, como hemos visto en la figura. Decimos entonces que la entidad <code>Mensaje</code> es la propietaria de la relación.</p>
</div>
<div class="paragraph">
<p>Para especificar las columnas que son claves ajenas en una relación se utilizan las anotaciones <code>@JoinColumn</code> y <code>mappedBy</code>. La primera identifica la entidad propietaria de la relación y permite definir el nombre de la columna que define la clave ajena (equivalente a la anotación <code>@Column</code> en otros atributos). Su uso es opcional, aunque es recomendable, ya que hace el mapeo más fácil de enteder. La segunda anotación es obligatoria se usa en el atributo de la entidad no propietaria que no se mapea en ninguna columna de la tabla. Como veremos más adelante, este elemento debe indicar el nombre del atributo que representa la clave ajena en la otra entidad.</p>
</div>
<div class="paragraph">
<p>También es posible mapear una relación utilizando una <em>tabla join</em>, una tabla auxiliar con dos claves ajenas hacia las tablas de la relación. No nos da tiempo en este tema de explicar cómo hacerlo. Si estás interesado puedes consultar en la especificación de JPA.</p>
</div>
</div>
<div class="sect3">
<h4 id="_actualización_de_la_relación">4.1.4. Actualización de la relación</h4>
<div class="paragraph">
<p>Ya hemos comentado previamente que una de las características fundamentales del funcionamiento de JPA es que las instancias de las entidades viven en el contexto de persistencia asociado al entity manager hasta que se realiza una operación de <em>flush</em> sobre la base de datos. Normalmente esto sucede cuando se cierra la transacción. En ese momento es cuando el proveedor de persistencia consulta las instancias del contexto y genera las sentencias SQL que actualizan la base de datos. Es interesante tener activo el debug de Hibernate que muestra las sentencias generadas para comprobar en qué momento se realizan y cuáles son.</p>
</div>
<div class="paragraph">
<p>En el caso de las relaciones, la especificación de JPA avisa literalmente de lo siguiente (el énfasis es del documento original):</p>
</div>
<div class="paragraph">
<p><em>Es particularmente importante asegurarse de que los cambios en el lado inverso de una relación se actualizan de forma apropiada en el lado propietario, para asegurarse de que los cambios no se pierden cuando se sincronizan en la base de datos.</em></p>
</div>
<div class="paragraph">
<p>Esto es, para que una relación se sincronice correctamente en la base de datos, se debe actualizar la instancia a la que se refiere en la parte propietaria de la relación. En el caso del ejemplo, para añadir una relación entre un <code>Mensaje</code> y un <code>Autor</code>, lo imprescindible a efectos de actualización de la base de datos es la sentencia en la que se añade el autor asociado al mensaje (el <code>Mensaje</code> es la clase propietaria de la relación, la que contiene la clave ajena). JPA no actualiza automáticamente la relación en memoria. Si está definida la relación inversa (la colección de mensajes de un autor) tenemos que actualizarla a mano en el programa, añadiendo el mensaje a la colección. Todo esto se hace con dos líneas de código:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-c1">// añadimos un mensaje a un autor</span>
<span class="tok-c1">// se actualiza el campo autor del mensaje</span>
<span class="tok-c1">// imprescindible para actualizar la BD</span>
<span class="tok-n">mensaje</span><span class="tok-o">.</span><span class="tok-na">setAutor</span><span class="tok-o">(</span><span class="tok-n">autor</span><span class="tok-o">);</span>
<span class="tok-c1">// actualizamos la relación inversa en memoria</span>
<span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">getMensajes</span><span class="tok-o">().</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-n">mensaje</span><span class="tok-o">);</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_definición_de_relaciones">4.2. Definición de relaciones</h3>
<div class="paragraph">
<p>Detallamos a continuación cómo se especifican las relaciones utilizando anotaciones.</p>
</div>
<div class="sect3">
<h4 id="_relación_uno_a_uno_unidireccional">4.2.1. Relación uno-a-uno unidireccional</h4>
<div class="paragraph">
<p>En una relación uno-a-uno unidireccional entre la entidad A y la entidad B, una instancia de la entidad A referencia una instancia de la entidad B. En la relación A pondremos la anotación <code>@OneToOne</code> en el atributo referente. En la entidad B no hay que añadir ninguna anotación.</p>
</div>
<div class="paragraph">
<p>Un ejemplo podría ser la relación entre un <code>Empleado</code> y un <code>Despacho</code> (asumiendo que <code>Despacho</code> es una entidad, y no un objeto embebido). El código sería el siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
   <span class="tok-c1">// ...</span>
   <span class="tok-nd">@OneToOne</span>
   <span class="tok-kd">private</span> <span class="tok-n">despacho</span> <span class="tok-n">Despacho</span><span class="tok-o">;</span>
   <span class="tok-c1">// ...</span>

   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setDespacho</span><span class="tok-o">(</span><span class="tok-n">Despacho</span> <span class="tok-n">despacho</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">despacho</span> <span class="tok-o">=</span> <span class="tok-n">despacho</span><span class="tok-o">;</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span>

<span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Despacho</span> <span class="tok-o">{</span>
    <span class="tok-c1">// ...</span>
    <span class="tok-nd">@OneToOne</span><span class="tok-o">(</span><span class="tok-n">mappedBy</span> <span class="tok-o">=</span> <span class="tok-s">&quot;despacho&quot;</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">Empleado</span> <span class="tok-n">empleado</span><span class="tok-o">;</span>
    <span class="tok-c1">// ...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La entidad <code>Empleado</code> es la propietaria de la relación y en su tabla hay una clave ajena (en la columna <code>despacho</code>) que apunta a la otra tabla. Se puede especificar esta clave ajena con la anotación <code>@JoinColumn</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
	<span class="tok-c1">// ...</span>
    <span class="tok-nd">@OneToOne</span>
    <span class="tok-nd">@JoinColumn</span><span class="tok-o">(</span><span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s">&quot;despacho_id&quot;</span><span class="tok-o">,</span> <span class="tok-n">unique</span> <span class="tok-o">=</span> <span class="tok-kc">true</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">Despacho</span> <span class="tok-n">despacho</span><span class="tok-o">;</span>
    <span class="tok-c1">//...</span>

    <span class="tok-kd">public</span> <span class="tok-n">Despacho</span> <span class="tok-nf">getDespacho</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">despacho</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setDespacho</span><span class="tok-o">(</span><span class="tok-n">Despacho</span> <span class="tok-n">despacho</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">despacho</span> <span class="tok-o">=</span> <span class="tok-n">despacho</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En esta anotación <code>@JoinColumn</code> se especifica el nombre de la columna en la tabla <code>Empleado</code> (<code>despacho</code>), el nombre de la columna con la clave primaria en la tabla a la que se apunta (<code>idDespacho</code>).</p>
</div>
<div class="paragraph">
<p>En el caso de no utilizar la anotación, JPA realizará el mapeo utilizando como nombre de columna el nombre del atributo que guarda la otra entidad y el nombre de la columna con la clave primaria en la otra entidad, uniéndolas con un subrayado ("_"). En este caso, se llamaría <code>empleado_idDespacho</code>.</p>
</div>
<div class="paragraph">
<p>Nos aseguramos de que la relación es uno-a-uno, añadiendo una restricción de <code>unique = true</code> que existirá en la columna correspondiente de la base de datos. Esa restricción la mantiene la base de datos.</p>
</div>
<div class="paragraph">
<p>Para actualizar la relación, basta con llamar al método <code>setDespacho()</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTrasaction</span><span class="tok-o">().</span><span class="tok-na">begin</span><span class="tok-o">();</span>
<span class="tok-n">Empleado</span> <span class="tok-n">empleado</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Empleado</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">1L</span><span class="tok-o">);</span>
<span class="tok-n">Despacho</span> <span class="tok-n">despacho</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Despacho</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">3L</span><span class="tok-o">);</span>
<span class="tok-n">empleado</span><span class="tok-o">.</span><span class="tok-na">setDespacho</span><span class="tok-o">(</span><span class="tok-n">despacho</span><span class="tok-o">);</span>
<span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">();</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_relación_uno_a_uno_bidireccional">4.2.2. Relación uno-a-uno bidireccional</h4>
<div class="paragraph">
<p>Supongamos que necesitamos modificar la relación anterior para que podamos obtener el empleado a partir de su despacho. Basta con hacer que la relación anterior sea bidireccional. Para ello, debemos añadir el atributo <code>empleado</code> en la entidad <code>Despacho</code> y anotarlo con <code>@OneToOne(mappedBy="despacho")</code>. De esta forma estamos indicando que la entidad <code>Empleado</code> es la propietaria de la relación y que contiene la clave ajena en el atributo <code>despacho</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Empleado</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
    <span class="tok-c1">// ...</span>
    <span class="tok-nd">@OneToOne</span>
    <span class="tok-nd">@JoinColumn</span><span class="tok-o">(</span><span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s">&quot;despacho_id&quot;</span><span class="tok-o">,</span> <span class="tok-n">unique</span> <span class="tok-o">=</span> <span class="tok-kc">true</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">despacho</span> <span class="tok-n">Despacho</span><span class="tok-o">;</span>
    <span class="tok-c1">// ...</span>
<span class="tok-o">}</span>

<span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Despacho</span> <span class="tok-o">{</span>
    <span class="tok-c1">// ...</span>
    <span class="tok-nd">@OneToOne</span><span class="tok-o">(</span><span class="tok-n">mappedBy</span><span class="tok-o">=</span><span class="tok-s">&quot;despacho&quot;</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">empleado</span> <span class="tok-n">Empleado</span><span class="tok-o">;</span>
    <span class="tok-c1">// ...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Hay que destacar la utilización del elemento <code>mappedBy</code> en el atributo <code>despacho</code>. Con ese elemento estamos indicando al proveedor de persistencia cuál es la clave ajena en la entidad <code>Empleado</code>. En la tabla asociada a la entidad <code>despacho</code> no existe ninguna columna que se refiere al empleado, sino que el <em>get</em> se obtiene haciendo una <code>SELECT</code> en la otra tabla (la propietaria de la relación). En el elemento <code>mappedBy</code> en una entidad B hay que especificar el nombre <strong>del atributo</strong> que en la otra entidad A guarda la referencia a B.</p>
</div>
<div class="paragraph">
<p>Veamos ahora los métodos de actualización de la entidad <code>Empleado</code>. Definimos un método auxiliar <code>quitaDespacho()</code> en lugar de llamar a <code>setDespacho</code> con <code>null</code> para hacer consistentes estos métodos con los métodos de las relaciones a muchos y para evitar usar <code>null</code> como parámetro en un método en el que se pasa un <code>Despacho</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
    <span class="tok-o">....</span>
    <span class="tok-kd">public</span> <span class="tok-n">Despacho</span> <span class="tok-nf">getDespacho</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">despacho</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setDespacho</span><span class="tok-o">(</span><span class="tok-n">Despacho</span> <span class="tok-n">despacho</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">despacho</span> <span class="tok-o">=</span> <span class="tok-n">despacho</span><span class="tok-o">;</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">despacho</span><span class="tok-o">.</span><span class="tok-na">getEmpleado</span><span class="tok-o">()</span> <span class="tok-o">!=</span> <span class="tok-k">this</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">despacho</span><span class="tok-o">.</span><span class="tok-na">setEmpleado</span><span class="tok-o">(</span><span class="tok-k">this</span><span class="tok-o">);</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1">
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">quitaDespacho</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">getDespacho</span><span class="tok-o">()</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">getDespacho</span><span class="tok-o">().</span><span class="tok-na">quitaEmpleado</span><span class="tok-o">();</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1">
            <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">despacho</span> <span class="tok-o">=</span> <span class="tok-kc">null</span><span class="tok-o">;</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>
    <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1"></td>
<td>Se actualiza relación inversa en memoria.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Esta vez permitimos actualizar la relación en el otro lado. Al ser el lado no propietario de la relación, debemos llamar a la actualización del otro lado:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Despacho</span> <span class="tok-o">{</span>
    <span class="tok-o">...</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setEmpleado</span><span class="tok-o">(</span><span class="tok-n">Empleado</span> <span class="tok-n">empleado</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">empleado</span> <span class="tok-o">=</span> <span class="tok-n">empleado</span><span class="tok-o">;</span>
        <span class="tok-n">empleado</span><span class="tok-o">.</span><span class="tok-na">setDespacho</span><span class="tok-o">(</span><span class="tok-k">this</span><span class="tok-o">);</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1">
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">quitaEmpleado</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">empleado</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">empleado</span><span class="tok-o">.</span><span class="tok-na">quitaDepartamento</span><span class="tok-o">();</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1">
        <span class="tok-o">}</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">empleado</span> <span class="tok-o">=</span> <span class="tok-kc">null</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
    <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1"></td>
<td>Se actualiza la relación inversa en memoria y la base de datos, por ser la clase <code>Empleado</code> la propietaria de la relación.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Un ejemplo de uso de las funciones anteriores para poner el despacho de un empleado a otro empleado (dejando sin despacho al primero):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-c1">// El empleado1 está en el despacho1. Ponemos en el despacho del empleado 1</span>
<span class="tok-c1">// al empleado 3 (dejando sin despacho al empleado 1)</span>

<span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">begin</span><span class="tok-o">();</span>
<span class="tok-n">Empleado</span> <span class="tok-n">empleado1</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Empleado</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">1L</span><span class="tok-o">);</span>
<span class="tok-n">Despacho</span> <span class="tok-n">despacho1</span> <span class="tok-o">=</span> <span class="tok-n">empleado1</span><span class="tok-o">.</span><span class="tok-na">getDespacho</span><span class="tok-o">();</span>
<span class="tok-n">Empleado</span> <span class="tok-n">empleado3</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Empleado</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">3L</span><span class="tok-o">);</span>
<span class="tok-n">empleado1</span><span class="tok-o">.</span><span class="tok-na">quitaDespacho</span><span class="tok-o">();</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1">
<span class="tok-n">empleado3</span><span class="tok-o">.</span><span class="tok-na">setDespacho</span><span class="tok-o">(</span><span class="tok-n">despacho1</span><span class="tok-o">);</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/2.png" alt="2">
<span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">();</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1"></td>
<td>Al poner primero a <code>null</code> el despacho del empleado1 nos aseguramos de que no haya un error de integridad en la base de datos que sucedería si se cambiara primero el despacho del empleado3, antes de cambiar el despacho del empleado1. El valor de la columna <code>departamento_id</code> no sería único.</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/2.png" alt="2"></td>
<td>El nuevo despacho del empleado3 es el despacho1 (y también se actualiza automáticamente el otro lado de la relación en memoria: el nuevo empleado del despacho1 es el empleado3).</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_relación_uno_a_muchos_muchos_a_uno_bidireccional">4.2.3. Relación uno-a-muchos/muchos-a-uno bidireccional</h4>
<div class="paragraph">
<p>En una relación uno-a-muchos bidireccional entre la entidad A y la B, una instancia de la entidad A referencia a una colección de instancias de B y una instancia de B referencia a una instancia de A. Por ejemplo la relación entre <code>Departamento</code> (entidad A) y <code>Empleado</code> (entidad B). Un <code>departamento</code> tiene una colección de <code>empleados</code>, y un <code>empleado</code> pertenece a un <code>departamento</code>. La entidad B (en este caso, <code>Empleado</code>) debe ser la propietaria de la relación, y contener una columna con la clave ajena a la entidad A (<code>Departamento</code>).</p>
</div>
<div class="paragraph">
<p>En la entidad <code>Empleado</code> se define un atributo del tipo de la entidad <code>Departamento</code>, con la anotación <code>@ManyToOne</code>. En la entidad <code>Departamento</code> se define un atributo del tipo <code>Set&lt;Empleado&gt;</code> con la anotación <code>@OneToMany(mappedBy="departamento")</code> que indica el nombre de la clave ajena.</p>
</div>
<div class="paragraph">
<p>El ejemplo que presentamos al comienzo del capítulo es de este tipo. Otro ejemplo podría ser el de la relación entre un departamento y los empleados. Un <code>Departamento</code> está relacionado con muchos <code>Empleado`s. Y un `Empleado</code> pertenece a un único <code>Departamento</code>. De esta forma el <code>Empleado</code> hace el papel de propietario de la relación y es quien llevará la clave ajena hacia <code>Departamento</code>. Lo vemos en el siguiente código:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
   <span class="tok-o">...</span>
   <span class="tok-nd">@ManyToOne</span>
   <span class="tok-nd">@JoinColumn</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;departamento_id&quot;</span><span class="tok-o">)</span>
   <span class="tok-kd">private</span> <span class="tok-n">departamento</span> <span class="tok-n">Departamento</span><span class="tok-o">;</span>
   <span class="tok-o">...</span>
<span class="tok-o">}</span>

<span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Departamento</span> <span class="tok-o">{</span>
   <span class="tok-o">...</span>
   <span class="tok-nd">@OneToMany</span><span class="tok-o">(</span><span class="tok-n">mappedBy</span><span class="tok-o">=</span><span class="tok-s">&quot;departamento&quot;</span><span class="tok-o">)</span>
   <span class="tok-kd">private</span> <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Empleado</span><span class="tok-o">&gt;</span> <span class="tok-n">empleados</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">HashSet</span><span class="tok-o">();</span>
   <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En la declaración se podría eliminar la anotación <code>@JoinColumn</code> y el nombre de la columna con la clave ajena se obtendría de la misma forma que hemos visto en la relación uno-a-uno.</p>
</div>
<div class="paragraph">
<p>Definimos en las entidades los siguientes métodos de actualización de las relaciones. En la clase <code>Empleado</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
    <span class="tok-o">...</span>

    <span class="tok-kd">public</span> <span class="tok-n">Departamento</span> <span class="tok-nf">getDepartamento</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">departamento</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setDepartamento</span><span class="tok-o">(</span><span class="tok-n">Departamento</span> <span class="tok-n">departamento</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">departamento</span> <span class="tok-o">=</span> <span class="tok-n">departamento</span><span class="tok-o">;</span>
        <span class="tok-n">departamento</span><span class="tok-o">.</span><span class="tok-na">getEmpleados</span><span class="tok-o">().</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-k">this</span><span class="tok-o">);</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1">
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">quitaDepartamento</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">Departamento</span> <span class="tok-n">departamento</span> <span class="tok-o">=</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">getDepartamento</span><span class="tok-o">();</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">departamento</span> <span class="tok-o">=</span> <span class="tok-kc">null</span><span class="tok-o">;</span>
        <span class="tok-n">departamento</span><span class="tok-o">.</span><span class="tok-na">getEmpleados</span><span class="tok-o">().</span><span class="tok-na">remove</span><span class="tok-o">(</span><span class="tok-k">this</span><span class="tok-o">);</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1">
    <span class="tok-o">}</span>
    <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1"></td>
<td>Se actualiza la relación en memoria.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Como también hemos dicho anteriormente, la relación se actualiza insertando el nuevo <code>Departamento</code> en la instancia <code>Empleado</code> (la propietaria de la relación) con el método <code>setDepartamento()</code>, de esta forma nos aseguraremos que la relación se guarda en la base de datos. Sin embargo, también es importante actualizar la colección en el otro lado de la relación. La llamada a <code>getEmpleados()</code> es sobreescrita por JPA y es implementada por una consulta a la base de datos, pero si queremos utilizar inmediatamente la colección de empleados, debemos actualizar su contenido en memoria.</p>
</div>
<div class="paragraph">
<p>En la clase <code>Departamento</code> podemos definir también métodos auxiliares que llamen a los anteriores. Haremos esto sólo si es  desde el punto de vista de la lógica de negocio.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Departamento</span> <span class="tok-o">{</span>
    <span class="tok-o">...</span>

    <span class="tok-kd">public</span> <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Empleado</span><span class="tok-o">&gt;</span> <span class="tok-nf">getEmpleados</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">empleados</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">añadeEmpleado</span><span class="tok-o">(</span><span class="tok-n">Empleado</span> <span class="tok-n">empleado</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">getEmpleados</span><span class="tok-o">().</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-n">empleado</span><span class="tok-o">);</span>
        <span class="tok-n">empleado</span><span class="tok-o">.</span><span class="tok-na">setDepartamento</span><span class="tok-o">(</span><span class="tok-k">this</span><span class="tok-o">);</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1">
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">quitaEmpleado</span><span class="tok-o">(</span><span class="tok-n">Empleado</span> <span class="tok-n">empleado</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">getEmpleados</span><span class="tok-o">().</span><span class="tok-na">remove</span><span class="tok-o">(</span><span class="tok-n">empleado</span><span class="tok-o">);</span>
        <span class="tok-n">empleado</span><span class="tok-o">.</span><span class="tok-na">quitaDepartamento</span><span class="tok-o">();</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1">
    <span class="tok-o">}</span>
    <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1"></td>
<td>Se actualiza la relación inversa y la base de datos.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Veamos varios ejemplos de uso de estas relaciones.</p>
</div>
<div class="paragraph">
<p>Actualización del departamento de un empleado, usuando los métodos <code>quitaDepartamento()</code> y <code>setDepartamento()</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-c1">// El empleado1 pertenece al departamento1. Lo cambiamos al departamento2.</span>

<span class="tok-n">Departamento</span> <span class="tok-n">depto1</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Departamento</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">1L</span><span class="tok-o">);</span>
<span class="tok-n">Departamento</span> <span class="tok-n">depto2</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Departamento</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">2L</span><span class="tok-o">);</span>
<span class="tok-n">Empleado</span> <span class="tok-n">empleado1</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Empleado</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">1L</span><span class="tok-o">);</span>
<span class="tok-n">empleado1</span><span class="tok-o">.</span><span class="tok-na">quitaDepartamento</span><span class="tok-o">();</span>
<span class="tok-n">empleado1</span><span class="tok-o">.</span><span class="tok-na">setDepartamento</span><span class="tok-o">(</span><span class="tok-n">depto2</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>También podríamos hacer la misma actualización usando los métodos de la entidad <code>Departamento</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-c1">// El empleado1 pertenece al departamento1. Lo cambiamos al departamento2.</span>

<span class="tok-n">Departamento</span> <span class="tok-n">depto1</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Departamento</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">1L</span><span class="tok-o">);</span>
<span class="tok-n">Departamento</span> <span class="tok-n">depto2</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Departamento</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">2L</span><span class="tok-o">);</span>
<span class="tok-n">Empleado</span> <span class="tok-n">empleado1</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Empleado</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">1L</span><span class="tok-o">);</span>
<span class="tok-n">depto1</span><span class="tok-o">.</span><span class="tok-na">quitaEmpleado</span><span class="tok-o">(</span><span class="tok-n">empleado1</span><span class="tok-o">);</span>
<span class="tok-n">depto2</span><span class="tok-o">.</span><span class="tok-na">añadeEmpleado</span><span class="tok-o">(</span><span class="tok-n">empleado1</span><span class="tok-o">);</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_relación_muchos_a_uno_unidireccional">4.2.4. Relación muchos-a-uno unidireccional</h4>
<div class="paragraph">
<p>En una relación muchos-a-uno unidireccional entre las entidades A y B, una instancia de A está relacionada con una instancia de B (que puede ser la misma para distintas instancias de A), pero la relación inversa que devolvería una colección de B a partir de A no está definida. Por ejemplo, sería el tipo de relación entre <code>Empleado</code> (A) y <code>Categoria</code> (B), en el caso en que no quisiéramos obtener los empleados de una determinada categoría, sino sólo saber de qué categoría es un empleado. Para definir la relación hay que definir en la entidad propietaria <code>Empleado</code> (A) un atributo que define la clave ajena hacia la entidad <code>Categoría</code> (B). Al ser una relación unidireccional no obtendremos desde la entidad B su entidad relacionada A, no definiendo ningún atributo adicional:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Empleado</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
   <span class="tok-o">...</span>
   <span class="tok-nd">@ManyToOne</span>
   <span class="tok-nd">@JoinColumn</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;categoria_id&quot;</span><span class="tok-o">)</span>
   <span class="tok-kd">private</span> <span class="tok-n">categoria</span> <span class="tok-n">Categoria</span><span class="tok-o">;</span>
   <span class="tok-o">...</span>

<span class="tok-o">}</span>

<span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Categoria</span> <span class="tok-o">{</span>
   <span class="tok-c1">// ...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_relación_muchos_a_muchos_bidireccional">4.2.5. Relación muchos-a-muchos bidireccional</h4>
<div class="paragraph">
<p>En una relación muchos-a-muchos bidireccional entre la entidad A y la entidad B, una instancia de A está relacionada con una o muchas instancias de B (que pueden ser las mismas para distintas instancias de A). Por ejemplo, un <code>Empleado</code> (A) puede participar en más de un <code>Proyecto</code> (B). Dado un empleado se puede obtener la lista de proyectos en los que participa y dado un proyecto podemos obtener la lista de empleados asignados a él.</p>
</div>
<div class="paragraph">
<p>Se implementa con las siguientes anotaciones:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
    <span class="tok-nd">@Id</span>
    <span class="tok-nd">@GeneratedValue</span>
    <span class="tok-kd">private</span> <span class="tok-n">Long</span> <span class="tok-n">id</span><span class="tok-o">;</span>
    <span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
    <span class="tok-nd">@ManyToMany</span>
    <span class="tok-kd">private</span> <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Projecto</span><span class="tok-o">&gt;</span> <span class="tok-n">proyectos</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">HashSet</span><span class="tok-o">();</span>
    <span class="tok-o">...</span>

    <span class="tok-kd">public</span> <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Proyecto</span><span class="tok-o">&gt;</span> <span class="tok-nf">getProyectos</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">proyectos</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-o">...</span>
<span class="tok-o">}</span>

<span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Proyecto</span> <span class="tok-o">{</span>
    <span class="tok-nd">@Id</span>
    <span class="tok-nd">@GeneratedValue</span>
    <span class="tok-kd">private</span> <span class="tok-n">Long</span> <span class="tok-n">id</span><span class="tok-o">;</span>
    <span class="tok-n">String</span> <span class="tok-n">codigo</span><span class="tok-o">;</span>
    <span class="tok-nd">@ManyToMany</span><span class="tok-o">(</span><span class="tok-n">mappedBy</span><span class="tok-o">=</span><span class="tok-s">&quot;proyectos&quot;</span><span class="tok-o">);</span>
    <span class="tok-kd">private</span> <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Empleado</span><span class="tok-o">&gt;</span> <span class="tok-n">empleados</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">HashSet</span><span class="tok-o">();</span>
    <span class="tok-o">...</span>

    <span class="tok-kd">public</span> <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Empleado</span><span class="tok-o">&gt;</span> <span class="tok-nf">getEmpleados</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">empleados</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
    <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La anotación <code>mappedBy</code> apunta a la entidad propietaria de la relación. En este caso es la entidad <code>Empleado</code>.</p>
</div>
<div class="paragraph">
<p>La relación se mapea, a diferencia de los casos anteriores, utilizando una <em>tabla join</em> que construye JPA automáticamente utilizando los nombres de las dos entidades. Es una tabla con dos columnas que contienen claves ajenas a las tablas de las entidades. La primera columna apunta a la tabla propietaria de la relación y la segunda a la otra tabla. La siguiente imagen representa el mapeo de la relación anterior.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa04/relacion-muchos-a-muchos.png" alt="Relación muchos a muchos" width="66%">
</div>
</div>
<div class="paragraph">
<p>En el caso de ya existir la tabla join, o de necesitar un nombre específico para sus elementos, podríamos utilizar la anotación <code>@JoinTable</code> de la siguiente forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
    <span class="tok-o">...</span>
    <span class="tok-nd">@ManyToMany</span>
    <span class="tok-nd">@JoinTable</span><span class="tok-o">(</span>
        <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s">&quot;EMPLEADO_PROYECTO&quot;</span><span class="tok-o">,</span>
        <span class="tok-n">joinColumns</span> <span class="tok-o">=</span> <span class="tok-o">{</span><span class="tok-nd">@JoinColumn</span><span class="tok-o">(</span><span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s">&quot;EMPLEADO_NOMBRE&quot;</span><span class="tok-o">)},</span>
        <span class="tok-n">inverseJoinColumns</span> <span class="tok-o">=</span> <span class="tok-o">{</span><span class="tok-nd">@JoinColumn</span><span class="tok-o">(</span><span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s">&quot;PROYECTO_CODIGO&quot;</span><span class="tok-o">)}</span>
    <span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Projecto</span><span class="tok-o">&gt;</span> <span class="tok-n">proyectos</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">HashSet</span><span class="tok-o">&lt;</span><span class="tok-n">Projecto</span><span class="tok-o">&gt;();</span>
    <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La anotación <code>joinColumns</code> hace referencia a la columna de la tabla join que contiene el identificador (o identificadores, en el caso de una clave compuesta) a la propia entidad (<code>Empleado</code> en este caso). La anotación <code>inverseJoinColumns</code> identifica la columna que hace referencia a la otra entidad (<code>Proyecto</code>).</p>
</div>
<div class="paragraph">
<p>En el otro lado de la relación no hace falta declarar la tabla join:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@ManyToMany</span><span class="tok-o">(</span><span class="tok-n">mappedBy</span> <span class="tok-o">=</span> <span class="tok-s">&quot;proyectos&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">private</span> <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Empleado</span><span class="tok-o">&gt;</span> <span class="tok-n">empleados</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">HashSet</span><span class="tok-o">&lt;</span><span class="tok-n">Proyecto</span><span class="tok-o">&gt;();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A la hora de actualizar la relación es muy importante tener en cuenta qué entidad es la propietaria de la relación, la que se sincronizará con la base de datos. En este caso, en el lado propietario (<code>Empleado</code>) tenemos una colección de proyectos. Para añadir un nuevo empleado a un proyecto debemos obtener la referencia a la colección de proyectos en los que participa el empleado (con el método <code>getProyectos()</code>) y añadir el nuevo proyecto con el método <code>add()</code> de la colección. Por ejemplo, para añadir el empleado 1 al proyecto 2, debemos añadir el proyecto 2 a los proyectos del empleado 1. También hay que actualizar el otro lado de la relación, para mantener correctamente la relación en memoria.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">begin</span><span class="tok-o">();</span>

<span class="tok-n">Proyecto</span> <span class="tok-n">proyecto2</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Proyecto</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">2L</span><span class="tok-o">);</span>
<span class="tok-n">Empleado</span> <span class="tok-n">empleado1</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Empleado</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">1L</span><span class="tok-o">);</span>
<span class="tok-n">empleado1</span><span class="tok-o">.</span><span class="tok-na">getProyectos</span><span class="tok-o">().</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-n">proyecto2</span><span class="tok-o">);</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1">
<span class="tok-n">proyecto2</span><span class="tok-o">.</span><span class="tok-na">getEmpleados</span><span class="tok-o">().</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-n">empleado1</span><span class="tok-o">);</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/2.png" alt="2">

<span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">();</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1"></td>
<td>Se actualiza el lado propietario de la relación para actualizar la relación en la base de datos.</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/2.png" alt="2"></td>
<td>Se actualiza el otro lado de la relación para actualizar la relación en memoria.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para borrar un empleado de un proyecto también hay que modificar la relación en el lado de propietario de la relación para actualizar la base de datos, y el otro lado para actualizar la relación en memoria:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">Proyecto</span> <span class="tok-n">proyecto2</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Proyecto</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">2L</span><span class="tok-o">);</span>
<span class="tok-n">Empleado</span> <span class="tok-n">empleado3</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Empleado</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">3L</span><span class="tok-o">);</span>
<span class="tok-n">empleado3</span><span class="tok-o">.</span><span class="tok-na">getProyectos</span><span class="tok-o">().</span><span class="tok-na">remove</span><span class="tok-o">(</span><span class="tok-n">proyecto2</span><span class="tok-o">);</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1">
<span class="tok-n">proyecto2</span><span class="tok-o">.</span><span class="tok-na">getEmpleados</span><span class="tok-o">().</span><span class="tok-na">remove</span><span class="tok-o">(</span><span class="tok-n">empleado3</span><span class="tok-o">);</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/2.png" alt="2"></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1"></td>
<td>Se actualiza el lado propietario de la relación para actualizar la relación en la base de datos</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/2.png" alt="2"></td>
<td>Se actualiza el otro lado de la relación para actualizar la relación en memoria</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Es conveniente definir estas actualizaciones <strong>en métodos auxiliares</strong> en las entidades. En la clase <code>Empleado</code> (propietaria de la relación):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
    <span class="tok-o">...</span>
    <span class="tok-kd">public</span> <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Proyecto</span><span class="tok-o">&gt;</span> <span class="tok-nf">getProyectos</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">proyectos</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">añadeProyecto</span><span class="tok-o">(</span><span class="tok-n">Proyecto</span> <span class="tok-n">proyecto</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">getProyectos</span><span class="tok-o">().</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-n">proyecto</span><span class="tok-o">);</span>
        <span class="tok-n">proyecto</span><span class="tok-o">.</span><span class="tok-na">getEmpleados</span><span class="tok-o">().</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-k">this</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">quitaProyecto</span><span class="tok-o">(</span><span class="tok-n">Proyecto</span> <span class="tok-n">proyecto</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">getProyectos</span><span class="tok-o">().</span><span class="tok-na">remove</span><span class="tok-o">(</span><span class="tok-n">proyecto</span><span class="tok-o">);</span>
        <span class="tok-n">proyecto</span><span class="tok-o">.</span><span class="tok-na">getEmpleados</span><span class="tok-o">().</span><span class="tok-na">remove</span><span class="tok-o">(</span><span class="tok-k">this</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En la clase <code>Proyecto</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Proyecto</span> <span class="tok-o">{</span>
    <span class="tok-o">...</span>
    <span class="tok-kd">public</span> <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Empleado</span><span class="tok-o">&gt;</span> <span class="tok-nf">getEmpleados</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">empleados</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">añadeEmpleado</span><span class="tok-o">(</span><span class="tok-n">Empleado</span> <span class="tok-n">empleado</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">empleado</span><span class="tok-o">.</span><span class="tok-na">getProyectos</span><span class="tok-o">().</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-k">this</span><span class="tok-o">);</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">getEmpleados</span><span class="tok-o">().</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-n">empleado</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">quitaEmpleado</span><span class="tok-o">(</span><span class="tok-n">Empleado</span> <span class="tok-n">empleado</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">empleado</span><span class="tok-o">.</span><span class="tok-na">getProyectos</span><span class="tok-o">().</span><span class="tok-na">remove</span><span class="tok-o">(</span><span class="tok-k">this</span><span class="tok-o">);</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">getEmpleados</span><span class="tok-o">().</span><span class="tok-na">remove</span><span class="tok-o">(</span><span class="tok-n">empleado</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>
   <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Un ejemplo de uso de los métodos auxiliares para añadir un empleado a un proyecto</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-c1">// Empleados proyecto2 = {empleado2, empleado3}</span>
<span class="tok-c1">// Proyectos empleado1 = {proyecto1}</span>
<span class="tok-c1">// Añadimos el empleado 1 al proyecto 2 usando los métodos auxiliares</span>

<span class="tok-n">Proyecto</span> <span class="tok-n">proyecto2</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Proyecto</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">2L</span><span class="tok-o">);</span>
<span class="tok-n">Empleado</span> <span class="tok-n">empleado1</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Empleado</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">1L</span><span class="tok-o">);</span>
<span class="tok-n">empleado1</span><span class="tok-o">.</span><span class="tok-na">añadeProyecto</span><span class="tok-o">(</span><span class="tok-n">proyecto2</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y un ejemplo para eliminar un empleado de un proyecto:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">Proyecto</span> <span class="tok-n">proyecto2</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Proyecto</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">2L</span><span class="tok-o">);</span>
<span class="tok-n">Empleado</span> <span class="tok-n">empleado3</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Empleado</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">3L</span><span class="tok-o">);</span>
<span class="tok-n">empleado3</span><span class="tok-o">.</span><span class="tok-na">quitaProyecto</span><span class="tok-o">(</span><span class="tok-n">proyecto2</span><span class="tok-o">);</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_relación_muchos_a_muchos_unidireccional">4.2.6. Relación muchos-a-muchos unidireccional</h4>
<div class="paragraph">
<p>En una relación muchos-a-muchos unidireccional entre una entidad A y otra entidad B, cada instancia de la entidad A está relacionada con una o muchas instancias de B (que pueden ser las mismas para distintas instancias de A). Al ser una relación unidireccional, dada una instancia de B no nos interesa saber la instancia de A con la que está relacionada.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, un <code>Empleado</code> tiene una colección de <code>Patentes</code> que ha desarrollado. Distintos empleados pueden participar en la misma patente. Pero no nos interesa guardar la información de qué empleados han desarrollado una patente determinada. La forma de especificarlo es:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
   <span class="tok-nd">@Id</span> <span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
   <span class="tok-nd">@ManyToMany</span>
   <span class="tok-kd">private</span> <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Patentes</span><span class="tok-o">&gt;</span> <span class="tok-n">patentes</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">HashSet</span><span class="tok-o">();</span>

   <span class="tok-kd">public</span> <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Patentes</span><span class="tok-o">&gt;</span> <span class="tok-nf">getPatentes</span><span class="tok-o">()</span> <span class="tok-o">{</span>
      <span class="tok-k">return</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">patentes</span><span class="tok-o">;</span>
   <span class="tok-o">}</span>

   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setPatentes</span><span class="tok-o">(</span><span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Patentes</span><span class="tok-o">&gt;</span> <span class="tok-n">patentes</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">patentes</span> <span class="tok-o">=</span> <span class="tok-n">patentes</span><span class="tok-o">;</span>
   <span class="tok-o">}</span>

   <span class="tok-c1">// ...</span>
<span class="tok-o">}</span>

<span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Patente</span> <span class="tok-o">{</span>
   <span class="tok-c1">// ...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En el mapeo de la relación se crea una tabla join llamada <code>EMPLEADO_PATENTE</code> con las dos claves ajenas hacia <code>EMPLEADO</code> y <code>PATENTE</code>.</p>
</div>
<div class="paragraph">
<p>La forma de actualizar la relación es la misma que en la relación bidireccional.</p>
</div>
</div>
<div class="sect3">
<h4 id="_columnas_adicionales_en_la_tabla_join">4.2.7. Columnas adicionales en la tabla join</h4>
<div class="paragraph">
<p>Es bastante usual encontrar columnas adicionales en las tablas join, además de las dos columnas ajenas. Imaginemos, por ejemplo, que necesitamos almacenar alguna información cada vez que añadimos un <code>Proyecto</code> a una <code>Empleado</code>. Por ejemplo, la fecha en la que el empleado entra en el proyecto y el cargo en el mismo. Lo vemos en la siguiente figura.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa04/join-con-columnas.png" alt="Columnas adicionales" width="66%">
</div>
</div>
<div class="paragraph">
<p>Una forma de mapearlo a JPA es creando una entidad nueva en la que se mapea la tabla. Llamamos a la entidad <code>ProyectoEmpleado</code>. Tiene como clave primaria la pareja de claves ajenas a las tablas de empleados y proyectos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-nd">@Table</span><span class="tok-o">(</span><span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s">&quot;PROYECTO_EMPLEADO&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">ProyectoEmpleado</span> <span class="tok-o">{</span>
    <span class="tok-nd">@Embeddable</span>
    <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-kd">class</span> <span class="tok-nc">Id</span> <span class="tok-kd">implements</span> <span class="tok-n">Serializable</span> <span class="tok-o">{</span>

        <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s">&quot;PROYECTO_ID&quot;</span><span class="tok-o">)</span>
        <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">proyectoId</span><span class="tok-o">;</span>

        <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s">&quot;EMPLEADO_ID&quot;</span><span class="tok-o">)</span>
        <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">empleadoId</span><span class="tok-o">;</span>

        <span class="tok-kd">public</span> <span class="tok-nf">Id</span><span class="tok-o">()</span> <span class="tok-o">{}</span>

        <span class="tok-kd">public</span> <span class="tok-nf">Id</span><span class="tok-o">(</span><span class="tok-kt">int</span> <span class="tok-n">proyectoId</span><span class="tok-o">,</span> <span class="tok-kt">int</span> <span class="tok-n">empleadoId</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">proyectoId</span> <span class="tok-o">=</span> <span class="tok-n">proyectoId</span><span class="tok-o">;</span>
            <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">empleadoId</span> <span class="tok-o">=</span> <span class="tok-n">empleadoId</span><span class="tok-o">;</span>
        <span class="tok-o">}</span>
        <span class="tok-kd">public</span> <span class="tok-kt">boolean</span> <span class="tok-nf">equals</span><span class="tok-o">(</span><span class="tok-n">Object</span> <span class="tok-n">o</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">o</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-n">o</span> <span class="tok-k">instanceof</span> <span class="tok-n">Id</span><span class="tok-o">)</span> <span class="tok-o">{</span>
                <span class="tok-n">Id</span> <span class="tok-n">that</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-n">Id</span><span class="tok-o">)</span> <span class="tok-n">o</span><span class="tok-o">;</span>
                <span class="tok-k">return</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">proyectoId</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">that</span><span class="tok-o">.</span><span class="tok-na">proyectoId</span><span class="tok-o">)</span> <span class="tok-o">&amp;&amp;</span>
                       <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">empleadoId</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">that</span><span class="tok-o">.</span><span class="tok-na">empleadoId</span><span class="tok-o">);</span>
            <span class="tok-o">}</span> <span class="tok-k">else</span> <span class="tok-o">{</span>
                <span class="tok-k">return</span> <span class="tok-kc">false</span><span class="tok-o">;</span>
            <span class="tok-o">}</span>
        <span class="tok-o">}</span>

        <span class="tok-kd">public</span> <span class="tok-kt">int</span> <span class="tok-nf">hashCode</span><span class="tok-o">()</span> <span class="tok-o">{</span>
            <span class="tok-k">return</span> <span class="tok-n">proyectoId</span><span class="tok-o">.</span><span class="tok-na">hashCode</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-n">empleadoId</span><span class="tok-o">.</span><span class="tok-na">hashCode</span><span class="tok-o">();</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@EmbeddedId</span>
    <span class="tok-kd">private</span> <span class="tok-n">Id</span> <span class="tok-n">id</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Id</span><span class="tok-o">();</span>

    <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s">&quot;FECHA&quot;</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">Date</span> <span class="tok-n">fecha</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Date</span><span class="tok-o">();</span>

    <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s">&quot;CARGO&quot;</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">cargo</span><span class="tok-o">;</span>

    <span class="tok-nd">@ManyToOne</span>
    <span class="tok-nd">@JoinColumn</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;PROYECTO_ID&quot;</span><span class="tok-o">,</span>
                <span class="tok-n">insertable</span> <span class="tok-o">=</span> <span class="tok-kc">false</span><span class="tok-o">,</span>
                <span class="tok-n">updatable</span> <span class="tok-o">=</span> <span class="tok-kc">false</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">Proyecto</span> <span class="tok-n">proyecto</span><span class="tok-o">;</span>

    <span class="tok-nd">@ManyToOne</span>
    <span class="tok-nd">@JoinColumn</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;EMPLEADO_ID&quot;</span><span class="tok-o">,</span>
                <span class="tok-n">insertable</span> <span class="tok-o">=</span> <span class="tok-kc">false</span><span class="tok-o">,</span>
                <span class="tok-n">updatable</span> <span class="tok-o">=</span> <span class="tok-kc">false</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">Empleado</span> <span class="tok-n">empleado</span><span class="tok-o">;</span>

    <span class="tok-kd">public</span> <span class="tok-nf">ProyectoEmpleado</span><span class="tok-o">()</span> <span class="tok-o">{}</span>

    <span class="tok-kd">public</span> <span class="tok-nf">ProyectoEmpleado</span><span class="tok-o">(</span><span class="tok-n">Proyecto</span> <span class="tok-n">proyecto</span><span class="tok-o">,</span>
                            <span class="tok-n">Empleado</span> <span class="tok-n">emplado</span><span class="tok-o">,</span>
                            <span class="tok-n">String</span> <span class="tok-n">cargo</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">proyecto</span> <span class="tok-o">=</span> <span class="tok-n">proyecto</span><span class="tok-o">;</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">empleado</span> <span class="tok-o">=</span> <span class="tok-n">empleado</span><span class="tok-o">;</span>
        <span class="tok-k">this</span> <span class="tok-n">cargo</span> <span class="tok-o">=</span> <span class="tok-n">cargo</span><span class="tok-o">;</span>

        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">id</span><span class="tok-o">.</span><span class="tok-na">proyectoId</span> <span class="tok-o">=</span> <span class="tok-n">proyecto</span><span class="tok-o">.</span><span class="tok-na">getId</span><span class="tok-o">();</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">id</span><span class="tok-o">.</span><span class="tok-na">empleadoId</span> <span class="tok-o">=</span> <span class="tok-n">empleado</span><span class="tok-o">.</span><span class="tok-na">getId</span><span class="tok-o">();</span>

        <span class="tok-c1">// Garantizamos la actualización en memoria</span>
        <span class="tok-n">proyecto</span><span class="tok-o">.</span><span class="tok-na">getProyectoEmpleados</span><span class="tok-o">().</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-k">this</span><span class="tok-o">);</span>
        <span class="tok-n">empleado</span><span class="tok-o">.</span><span class="tok-na">getProyectoEmpleados</span><span class="tok-o">().</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-k">this</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-c1">// Getters y setters</span>
    <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Este es un buen ejemplo para terminar el apartado, porque se utilizan en él múltiples elementos que hemos ido viendo en las dos últimas sesiones. Se utiliza como clave primaria de la nueva entidad una clave compuesta con las columnas <code>PROYECTO_ID</code> y <code>EMPLEADO_ID</code>. Hemos utilizado la estrategia de clase estática anidada para definirla. En el constructor se actualizan los valores de la clave primaria con las claves primarias del proyecto y el empleado. También se actualizan las propiedades que definen la relación a-muchos (<code>proyecto</code> y <code>empleado</code>) y se actualizan las relaciones inversas para asegurar la integridad referencial en memoria.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_carga_perezosa">4.3. Carga perezosa</h3>
<div class="paragraph">
<p>Hemos comentado que una de las características de JPA es la <em>carga perezosa</em> (<em>lazy fetching</em> en inglés). Este concepto es de especial importancia cuando estamos trabajando con relaciones.</p>
</div>
<div class="paragraph">
<p>Supongamos los ejemplos anteriores, con la relación uno-a-muchos entre <code>Departamento</code> y <code>Empleado</code> y la relación muchos-a-muchos entre <code>Empleado</code> y <code>Proyecto</code>. Cuando recuperamos un departamento de la base ese departamento está relacionado con un conjunto de empleados, que a su vez están relacionados cada uno de ellos con un conjunto de proyectos. La carga perezosa consiste en que no se cargan todos los objetos en el contexto de persistencia, sino sólo la referencia al departamento que se ha recuperado. Es cuando se realiza una llamada al método <code>getEmpleados()</code> cuando se recuperan de la base de datos todas las instancias de <code>Empleado</code> con las que ese departamento está relacionado. Pero sólo los empleados. Los proyectos de cada empleado no se cargan hasta que no se llama al método <code>getProyectos()</code> del empleado que nos interese.</p>
</div>
<div class="paragraph">
<p>Esta funcionalidad hace que la carga de instancias sea muy eficiente, pero hay que saber utilizarla correctamente. Un posible problema puede surgir cuando la instancia original (el <code>Departamento</code>) queda desconectada (<em>detached</em>) del <em>EntityManager</em> (lo veremos en el tema siguiente). Entonces ya no podremos acceder a ningún atributo que no se haya cargado.</p>
</div>
<div class="paragraph">
<p>Es posible que quereamos desactivar la propiedad por defecto de la carga perezosa. Para ello debemos definir la opción <code>fetch=FetchType.EAGER</code> en la anotación que define el tipo de relación:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
   <span class="tok-nd">@Id</span> <span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
   <span class="tok-nd">@ManyToMany</span><span class="tok-o">(</span><span class="tok-n">fetch</span><span class="tok-o">=</span><span class="tok-n">FetchType</span><span class="tok-o">.</span><span class="tok-na">EAGER</span><span class="tok-o">)</span>
   <span class="tok-kd">private</span> <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Patentes</span><span class="tok-o">&gt;</span> <span class="tok-n">patentes</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">HashSet</span><span class="tok-o">();</span>
   <span class="tok-c1">// ...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_referencias_e_información_adicional">4.4. Referencias e información adicional</h3>
<div class="paragraph">
<p>Puedes encontrar más información sobre las relaciones entre entidades JPA en la <a href="http://docs.jboss.org/hibernate/orm/4.3/manual/en-US/html_single/#collections">documentación de Hibernate</a> que incluye muchos ejemplos de distintos tipos de mapeado, incluyendo características no estándar en JPA.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="_ejercicios_4">4.5. Ejercicios</h3>
<div class="paragraph">
<p>Continuamos con el proyecto <code>filmoteca</code>.</p>
</div>
<div class="sect3">
<h4 id="__0_75_punto_relación_muchos_a_muchos_entre_code_pelicula_code_y_code_actor_code">4.5.1. (0,75 punto) Relación muchos-a-muchos entre <code>Pelicula</code> y <code>Actor</code></h4>
<div class="paragraph">
<p>Crea la clase <code>Actor</code> con los siguientes campos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Identificador autogenerado como clave primaria (<code>Long</code>)</p>
</li>
<li>
<p><code>nombre</code> (<code>String</code>)</p>
</li>
<li>
<p><code>fechaNacimiento</code> (<code>Date</code>)</p>
</li>
<li>
<p><code>Sexo</code> (Enumerado: <code>hombre</code> o <code>mujer</code>)</p>
</li>
<li>
<p><code>Biografia</code>(<code>String</code>)</p>
</li>
<li>
<p>relación muchos-a-muchos con <code>Pelicula</code></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="__0_75_puntos_daos_code_actordao_code_y_code_criticadao_code">4.5.2. (0,75 puntos) DAOs <code>ActorDao</code> y <code>CriticaDao</code></h4>
<div class="paragraph">
<p>Crea los DAO <code>ActorDao</code> y <code>CriticaDao</code>. Crea la clase <code>ActorServicio</code> con los métodos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Long nuevoActor(String nombre, Date fechaNacimiento, Sexo sexo, String biografia)</code>: añade un actor</p>
</li>
<li>
<p><code>void añadePeliculaActor(Long idActor, Long idPelicula)</code>: añade un actor a una película ya existente</p>
</li>
<li>
<p><code>List&lt;Actor&gt; buscaActorNombre(String nombre)</code>: devuelve una lista de actores que tienen el nombre que le pasamos como parámetro</p>
</li>
<li>
<p><code>List&lt;Pelicula&gt; peliculasActor(Long idActor)</code>: devuelve la lista completa de películas en las que ha participado un actor</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion05">5. Consultas</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hasta ahora hemos explicado cómo se realiza la definición de entidades y relaciones en JPA. En esta sesión vamos a explicar el lenguaje de consultas JPQL, el API que utiliza JPA para realizar consultas sobre esas tablas definidas. Explicaremos las sentencias principales de este API, sin entrar en demasiados detalles sobre la estructura de clases en las que se van a guardar estas consultas. Lo haremos en la próxima sesión, donde explicaremos cómo definir las clases DAO y Service que trabajan con entidades y proporcionan la capa de negocio de la aplicación.</p>
</div>
<div class="sect2">
<h3 id="_definición_de_clases">5.1. Definición de clases</h3>
<div class="paragraph">
<p>Vamos a definir las consultas sobre las clases <code>Empleado</code>, <code>Proyecto</code> y <code>CuentaCorreo</code>, definidas como sigue (todas con identificador autogenerado de tipo <code>Long</code>):</p>
</div>
<div class="paragraph">
<p><code>Empleado</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>nombre</code>: <code>String</code></p>
</li>
<li>
<p><code>sueldo</code>: <code>Float</code></p>
</li>
<li>
<p><code>direccion</code>: <code>Direccion</code>, clase embebida</p>
</li>
<li>
<p><code>departamento</code>: <code>Departamento</code>, relación muchos-a-uno (departamento de un empleado)</p>
</li>
<li>
<p><code>proyectos</code>: <code>Set&lt;Proyecto&gt;</code>, relación muchos-a-muchos (proyectos de un empleado)</p>
</li>
<li>
<p><code>facturas</code>: <code>Set&lt;FacturaGasto&gt;</code>, relación uno-a-muchos (gastos de un empleado)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>Departamento</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>nombre</code>: <code>String</code></p>
</li>
<li>
<p><code>empleados</code>: <code>Set&lt;Empleado&gt;</code>, relación a-muchos (empleados de un departamento)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>Proyecto</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>nombre</code>: <code>String</code></p>
</li>
<li>
<p><code>empleados</code>: <code>Set&lt;Empleado&gt;</code>, relación a-muchos (empleados que trabajan en el proyecto)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>FacturaGasto</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>concepto</code>: <code>String</code></p>
</li>
<li>
<p><code>cantidad</code>: <code>Double</code></p>
</li>
<li>
<p><code>fecha</code>: <code>Date</code></p>
</li>
<li>
<p><code>empleado</code>: <code>Empleado</code>, relación a-uno (empleado asociado a la cuenta de correo)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>Direccion</code> (Clase embebida):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>campus</code>: <code>String</code></p>
</li>
<li>
<p><code>edificio</code>: <code>String</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Código JPA de estas clases:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
    <span class="tok-nd">@Id</span>
    <span class="tok-kd">private</span> <span class="tok-n">Long</span> <span class="tok-n">id</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-n">Double</span> <span class="tok-n">sueldo</span><span class="tok-o">;</span>
    <span class="tok-nd">@ManyToOne</span>
    <span class="tok-kd">private</span> <span class="tok-n">Departamento</span> <span class="tok-n">departamento</span><span class="tok-o">;</span>
    <span class="tok-nd">@ManyToMany</span>
    <span class="tok-kd">private</span> <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Proyecto</span><span class="tok-o">&gt;</span> <span class="tok-n">proyectos</span><span class="tok-o">;</span>
    <span class="tok-nd">@OneToMany</span><span class="tok-o">(</span><span class="tok-n">mappedBy</span> <span class="tok-o">=</span> <span class="tok-s">&quot;empleado&quot;</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">FacturaGasto</span><span class="tok-o">&gt;</span> <span class="tok-n">gastos</span><span class="tok-o">;</span>

    <span class="tok-o">...</span>
<span class="tok-o">}</span>

<span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Departamento</span> <span class="tok-o">{</span>
    <span class="tok-nd">@Id</span>
    <span class="tok-kd">private</span> <span class="tok-n">Long</span> <span class="tok-n">id</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
    <span class="tok-nd">@Embedded</span>
    <span class="tok-kd">private</span> <span class="tok-n">Direccion</span> <span class="tok-n">direccion</span><span class="tok-o">;</span>
    <span class="tok-nd">@OneToMany</span><span class="tok-o">(</span><span class="tok-n">mappedBy</span> <span class="tok-o">=</span> <span class="tok-s">&quot;departamento&quot;</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Empleado</span><span class="tok-o">&gt;</span> <span class="tok-n">empleados</span><span class="tok-o">;</span>

    <span class="tok-o">...</span>
<span class="tok-o">}</span>

<span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Proyecto</span> <span class="tok-o">{</span>
    <span class="tok-nd">@Id</span>
    <span class="tok-kd">private</span> <span class="tok-n">Long</span> <span class="tok-n">id</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
    <span class="tok-nd">@ManyToMany</span><span class="tok-o">(</span><span class="tok-n">mappedBy</span> <span class="tok-o">=</span> <span class="tok-s">&quot;proyectos&quot;</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Empleado</span><span class="tok-o">&gt;</span> <span class="tok-n">empleados</span><span class="tok-o">;</span>

    <span class="tok-o">...</span>
<span class="tok-o">}</span>

<span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">FacturaGasto</span> <span class="tok-o">{</span>
    <span class="tok-nd">@Id</span>
    <span class="tok-kd">private</span> <span class="tok-n">Long</span> <span class="tok-n">id</span><span class="tok-o">;</span>
    <span class="tok-nd">@ManyToOne</span>
    <span class="tok-kd">private</span> <span class="tok-n">Empleado</span> <span class="tok-n">empleado</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">concepto</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-n">Double</span> <span class="tok-n">cantidad</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-n">Date</span> <span class="tok-n">fecha</span><span class="tok-o">;</span>

    <span class="tok-o">...</span>
<span class="tok-o">}</span>


<span class="tok-nd">@Embeddable</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Direccion</span> <span class="tok-o">{</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">campus</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">edificio</span><span class="tok-o">;</span>

    <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El diagrama de clases que genera IntelliJ con estas entidades es el siguiente:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa05/diagrama-clases-queries.png" alt="Diagrama clases" width="66%">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_definición_de_consultas_jpql">5.2. Definición de consultas JPQL</h3>
<div class="paragraph">
<p>El API JPA proporciona la interfaz <code>Query</code> para configurar y ejecutar consultas. Podemos obtener una instancia que implemente esa interfaz mediante un dos de métodos del entity manager: <code>createQuery()</code> y <code>createNamedQuery()</code>. El primer método se utilizar para crear una consulta dinámica y el segundo una consulta con nombre.</p>
</div>
<div class="paragraph">
<p>Una vez obtenida la consulta podemos pasarle los parámetros con <code>setParameter()</code> y ejecutarla. Se definen dos métodos para ejecutar consultas: el método <code>getSingleResult()</code> que devuelve un <code>Object</code> que es la única instancia resultante de la consulta y el método <code>getResultList()</code> que devuelve una lista de instancias resultantes de la consulta.</p>
</div>
<div class="sect3">
<h4 id="_parámetros_de_las_consultas">5.2.1. Parámetros de las consultas</h4>
<div class="paragraph">
<p>JPQL soporta dos tipos de sintaxis para la ligadura (<em>binding</em>) de parámetros: posicional y por nombre. Vemos un ejemplo del primer caso:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">QUERY</span> <span class="tok-o">=</span> <span class="tok-s">&quot;SELECT e</span>
<span class="tok-s">   FROM Empleado e</span>
<span class="tok-s">   WHERE e.departamento = ?1 AND</span>
<span class="tok-s">        e.salario &gt; ?2&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La segunda forma de definir parámetros es por nombre:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">QUERY</span> <span class="tok-o">=</span> <span class="tok-s">&quot;SELECT  e</span>
<span class="tok-s">   FROM Empleado e</span>
<span class="tok-s">   WHERE e.departamento = :dept AND</span>
<span class="tok-s">         e.salario &gt; :sal&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Veremos en el siguiente apartado ejemplos en los que se liga parámetros determinados a esas posiciones o nombres.</p>
</div>
</div>
<div class="sect3">
<h4 id="_consultas_dinámicas">5.2.2. Consultas dinámicas</h4>
<div class="paragraph">
<p>Se puede crear una consulta dinámica pasándole al entity manager la cadena con la consulta al método <code>createQuery</code>. JPA transforma en ese momento la consulta en el código SQL que se ejecutará en la base de datos.</p>
</div>
<div class="paragraph">
<p>Veamos un ejemplo de consulta, que utiliza el paso de parámetros por nombre visto anteriormente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kt">double</span> <span class="tok-nf">salarioPorDeptoNombre</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombreDepto</span><span class="tok-o">,</span> <span class="tok-n">String</span> <span class="tok-n">nombreEmpleado</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-kd">final</span> <span class="tok-n">String</span> <span class="tok-n">SALARIO_POR_DEPTO_NOMBRE</span> <span class="tok-o">=</span> <span class="tok-s">&quot;SELECT e.sueldo &quot;</span> <span class="tok-o">+</span>
            <span class="tok-s">&quot;FROM Empleado e &quot;</span> <span class="tok-o">+</span>
            <span class="tok-s">&quot;WHERE e.departamento.nombre = :deptNombre AND &quot;</span> <span class="tok-o">+</span>
            <span class="tok-s">&quot;      e.nombre = :empNombre&quot;</span><span class="tok-o">;</span>
    <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
    <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">begin</span><span class="tok-o">();</span>

    <span class="tok-n">TypedQuery</span><span class="tok-o">&lt;</span><span class="tok-n">Double</span><span class="tok-o">&gt;</span> <span class="tok-n">query</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">createQuery</span><span class="tok-o">(</span><span class="tok-n">SALARIO_POR_DEPTO_NOMBRE</span><span class="tok-o">,</span> <span class="tok-n">Double</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">)</span>
            <span class="tok-o">.</span><span class="tok-na">setParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;deptNombre&quot;</span><span class="tok-o">,</span> <span class="tok-n">nombreDepto</span><span class="tok-o">)</span>
            <span class="tok-o">.</span><span class="tok-na">setParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;empNombre&quot;</span><span class="tok-o">,</span> <span class="tok-n">nombreEmpleado</span><span class="tok-o">);</span>
    <span class="tok-kt">double</span> <span class="tok-n">sueldo</span> <span class="tok-o">=</span> <span class="tok-n">query</span><span class="tok-o">.</span><span class="tok-na">getSingleResult</span><span class="tok-o">();</span>
    <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">sueldo</span><span class="tok-o">);</span>
    <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">();</span>
    <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-k">return</span> <span class="tok-n">sueldo</span><span class="tok-o">;</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La clase <code>TypedQuery</code> se introdujo en el API JPA 2.0 y es recomendble usarlo. Se construye la query pasando al método <code>createQuery</code> un segundo parámetro con la clase del tipo devuelto por la query. De esta forma se evita tener que hacer un casting de lo que devuelve <code>query.getSingleResult()</code>.</p>
</div>
<div class="paragraph">
<p>Un inconveniente de las consultas dinámicas es que se procesan en tiempo de ejecución de la aplicación, con la consiguiente pérdida de rendimiento. Su ventaja principal es que se pueden definir con mucha comodidad.</p>
</div>
</div>
<div class="sect3">
<h4 id="_consultas_con_nombre">5.2.3. Consultas con nombre</h4>
<div class="paragraph">
<p>Las consultas con nombre se definen junto con alguna entidad, utilizando la anotación <code>@NamedQuery</code>. Mejoran el rendimiento con respecto a las consultas dinámicas, ya que son procesadas una única vez. El siguiente código muestra un ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-nd">@NamedQuery</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;Empleado.salarioPorNombreDepartamento&quot;</span><span class="tok-o">,</span>
            <span class="tok-n">query</span><span class="tok-o">=</span><span class="tok-s">&quot;SELECT e.sueldo &quot;</span> <span class="tok-o">+</span>
                  <span class="tok-s">&quot;FROM Empleado e &quot;</span> <span class="tok-o">+</span>
                  <span class="tok-s">&quot;WHERE e.departamento.nombre = : deptNombre AND &quot;</span> <span class="tok-o">+</span>
                  <span class="tok-s">&quot;      e.nombre = : empNombre&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-kd">implements</span> <span class="tok-n">Serializable</span> <span class="tok-o">{</span>
   <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El nombre de la consulta es una cadena única. Utilizamos el convenio de colocar el nombre de la clase al comienzo de la cadena, separado por un punto del resto. Las consultas pueden definirse en cualquier clase de entidad y este convenio permite que sea la definición de la consulta sea fácil de localizar.</p>
</div>
<div class="paragraph">
<p>Si se necesita más de una consulta para una entidad, deben incluirse en la anotación <code>@NamedQueries</code>, que acepta una array de una o más anotaciones <code>@NamedQuery</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-nd">@NamedQueries</span><span class="tok-o">({</span>
   <span class="tok-nd">@NamedQuery</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;Empleado.findAll&quot;</span><span class="tok-o">,</span>
               <span class="tok-n">query</span><span class="tok-o">=</span><span class="tok-s">&quot;SELECT e FROM Empleado e&quot;</span><span class="tok-o">),</span>
   <span class="tok-nd">@NamedQuery</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;Empleado.findById&quot;</span><span class="tok-o">,</span>
               <span class="tok-n">query</span><span class="tok-o">=</span><span class="tok-s">&quot;SELECT e FROM Empleado e WHERE e.id = :id&quot;</span><span class="tok-o">),</span>
   <span class="tok-nd">@NamedQuery</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;Empleado.findByNombre&quot;</span><span class="tok-o">,</span>
               <span class="tok-n">query</span><span class="tok-o">=</span><span class="tok-s">&quot;SELECT e FROM Empleado e WHERE e.nombre = :nombre&quot;</span><span class="tok-o">)</span>
<span class="tok-o">})</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-kd">implements</span> <span class="tok-n">Serializable</span> <span class="tok-o">{</span>
   <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para ejecutar la consulta hay que llamar al método <code>createNamedQuery</code> pasándole como parámetro el nombre de la consulta. El siguiente código muestra dos ejemplos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-n">Empleado</span> <span class="tok-nf">findEmpleadoPorNombre</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombreEmpleado</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
    <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">begin</span><span class="tok-o">();</span>
    <span class="tok-n">TypedQuery</span><span class="tok-o">&lt;</span><span class="tok-n">Empleado</span><span class="tok-o">&gt;</span> <span class="tok-n">queryEmpleado</span> <span class="tok-o">=</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">createNamedQuery</span><span class="tok-o">(</span><span class="tok-s">&quot;Empleado.findByNombre&quot;</span><span class="tok-o">,</span> <span class="tok-n">Empleado</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">)</span>
                    <span class="tok-o">.</span><span class="tok-na">setParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;nombre&quot;</span><span class="tok-o">,</span> <span class="tok-n">nombreEmpleado</span><span class="tok-o">);</span>
    <span class="tok-n">Empleado</span> <span class="tok-n">empleado</span> <span class="tok-o">=</span> <span class="tok-n">queryEmpleado</span><span class="tok-o">.</span><span class="tok-na">getSingleResult</span><span class="tok-o">();</span>
    <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">();</span>
    <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-k">return</span> <span class="tok-n">empleado</span><span class="tok-o">;</span>
<span class="tok-o">}</span>


<span class="tok-kd">public</span> <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Empleado</span><span class="tok-o">&gt;</span> <span class="tok-nf">findAllEmpleados</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
    <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">begin</span><span class="tok-o">();</span>
    <span class="tok-n">TypedQuery</span><span class="tok-o">&lt;</span><span class="tok-n">Empleado</span><span class="tok-o">&gt;</span> <span class="tok-n">queryListaEmpleados</span> <span class="tok-o">=</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">createNamedQuery</span><span class="tok-o">(</span><span class="tok-s">&quot;Empleado.findAll&quot;</span><span class="tok-o">,</span> <span class="tok-n">Empleado</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>
    <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Empleado</span><span class="tok-o">&gt;</span> <span class="tok-n">empleados</span> <span class="tok-o">=</span> <span class="tok-n">queryListaEmpleados</span><span class="tok-o">.</span><span class="tok-na">getResultList</span><span class="tok-o">();</span>
    <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">();</span>
    <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-k">return</span> <span class="tok-n">empleados</span><span class="tok-o">;</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ejecución_de_consultas">5.2.4. Ejecución de consultas</h4>
<div class="paragraph">
<p>Veamos por último los métodos del interfaz <code>Query</code> para ejecutar las consultas definidas. Son los métodos <code>getSingleResult()</code> y <code>getResultList()</code>.</p>
</div>
<div class="paragraph">
<p>Ambos métodos se deben lanzar sobre una <code>Query</code> ya construida y en la que se han introducido los parámetros. El método <code>getSingleResult()</code> se utiliza con consultas que devuelven un único resultado. Devuelve un <code>Object</code> que contiene el resultado de la consulta. Después de llamarlo conviene hacer un casting al tipo (entidad o tipo básico) que esperamos. Puede suceder que la consulta ejecutada no devuelva ningún resultado o devuelva más de uno. En el primer caso se genera la excepción <code>NoResultException</code> y en el segundo <code>NonUniqueResultException</code>.</p>
</div>
<div class="paragraph">
<p>Si no tenemos seguridad de una consulta vaya a devolver un único valor deberíamos llamar a <code>getResultList()</code>. Este método devuelve una <code>List</code> de <code>Object</code>. La utilización de la interfaz <code>List</code> en lugar de <code>Collection</code> es para soportar la devolución de colecciones ordenadas. En el caso en que la consulta no obtenga resultados, se devuelve una lista vacía. El siguiente código muestra un ejemplo de utilización de una consulta:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">imprimeEmpleadosProyecto</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Empleado</span><span class="tok-o">&gt;</span> <span class="tok-n">empleados</span> <span class="tok-o">=</span> <span class="tok-n">findEmpleadosProyecto</span><span class="tok-o">(</span><span class="tok-s">&quot;Reconocimiento de caras&quot;</span><span class="tok-o">);</span>
    <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">Empleado</span> <span class="tok-n">empleado</span> <span class="tok-o">:</span> <span class="tok-n">empleados</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">empleado</span><span class="tok-o">.</span><span class="tok-na">getNombre</span><span class="tok-o">());</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span>

<span class="tok-kd">private</span> <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Empleado</span><span class="tok-o">&gt;</span> <span class="tok-nf">findEmpleadosProyecto</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombreProyecto</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
    <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">begin</span><span class="tok-o">();</span>
    <span class="tok-n">TypedQuery</span><span class="tok-o">&lt;</span><span class="tok-n">Empleado</span><span class="tok-o">&gt;</span> <span class="tok-n">queryEmpleadosProyecto</span> <span class="tok-o">=</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">createQuery</span><span class="tok-o">(</span>
                    <span class="tok-s">&quot;SELECT e &quot;</span> <span class="tok-o">+</span>
                            <span class="tok-s">&quot;FROM Proyecto p JOIN p.empleados e &quot;</span> <span class="tok-o">+</span>
                            <span class="tok-s">&quot;WHERE p.nombre = ?1&quot;</span><span class="tok-o">,</span> <span class="tok-n">Empleado</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>

    <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Empleado</span><span class="tok-o">&gt;</span> <span class="tok-n">empleados</span> <span class="tok-o">=</span> <span class="tok-n">queryEmpleadosProyecto</span>
            <span class="tok-o">.</span><span class="tok-na">setParameter</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">,</span> <span class="tok-n">nombreProyecto</span><span class="tok-o">)</span>
            <span class="tok-o">.</span><span class="tok-na">getResultList</span><span class="tok-o">();</span>
    <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">();</span>
    <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-k">return</span> <span class="tok-n">empleados</span><span class="tok-o">;</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_java_persistence_query_language">5.3. Java Persistence Query Language</h3>
<div class="paragraph">
<p>JPQL es el lenguaje en el que se construyen las queries en JPA. Aunque en apariencia es muy similar a SQL, en la realidad operan en mundos totalmente distintos. En JPQL las preguntas se construyen sobre clases y entidades, mientras que SQL opera sobre tablas, columnas y filas en la base de datos.</p>
</div>
<div class="paragraph">
<p>Una consulta JPQL puede contener los siguientes elementos</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-k">SELECT</span> <span class="tok-k">c</span>
<span class="tok-k">FROM</span> <span class="tok-n">Category</span> <span class="tok-k">c</span>
<span class="tok-k">WHERE</span> <span class="tok-k">c</span><span class="tok-p">.</span><span class="tok-n">categoryName</span> <span class="tok-k">LIKE</span> <span class="tok-p">:</span><span class="tok-n">categoryName</span>
<span class="tok-k">ORDER</span> <span class="tok-k">BY</span> <span class="tok-k">c</span><span class="tok-p">.</span><span class="tok-n">categoryId</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Una cláusula <code>SELECT</code> que especifica el tipo de entidades o valores que se recuperan</p>
</li>
<li>
<p>Una cláusula <code>FROM</code> que especifica una declaración de entidad que es usada por otras cláusulas</p>
</li>
<li>
<p>Una cláusula opcional <code>WHERE</code> para filtrar los resultados devueltos por la query</p>
</li>
<li>
<p>Una cláusula opcional <code>ORDER</code> BY para ordenar los resultados devueltos por la query</p>
</li>
<li>
<p>Una cláusula opcional <code>GROUP BY</code> para realizar agregación</p>
</li>
<li>
<p>Una cláusula opcional <code>HAVING</code> para realizar un filtrado en conjunción con la agregación</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_consultas_básicas">5.3.1. Consultas básicas</h4>
<div class="paragraph">
<p>La consulta más sencilla en JPQL es la que selecciona todas las instancias de un único tipo de entidad:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-k">SELECT</span> <span class="tok-n">e</span> <span class="tok-k">FROM</span> <span class="tok-n">Empleado</span> <span class="tok-n">e</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La sintaxis de JPQL es similar a la de SQL. De esta forma los desarrolladores con experiencia en SQL pueden comenzar a utilizarlo rápidamente. La diferencia principal es que en SQL se seleccionan filas de una tabla mientras que en JPQL se seleccionan instancias de un tipo de entidad del modelo del dominio. La cláusula <code>SELECT</code> es ligeramente distinta a la de SQL listando sólo el alias <code>e</code> del <code>Empleado</code>. Este tipo indica el tipo de datos que va a devolver la consulta, una lista de cero o más instancias <code>Empleado</code>.</p>
</div>
<div class="paragraph">
<p>Código que ejecuta la consulta:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">final</span> <span class="tok-n">String</span> <span class="tok-n">FIND_ALL_EMPLEADOS</span> <span class="tok-o">=</span> <span class="tok-s">&quot;SELECT e FROM Empleado e &quot;</span><span class="tok-o">;</span>

<span class="tok-n">TypedQuery</span><span class="tok-o">&lt;</span><span class="tok-n">Empleado</span><span class="tok-o">&gt;</span> <span class="tok-n">query</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">createQuery</span><span class="tok-o">(</span><span class="tok-n">FIND_ALL_EMPLEADOS</span><span class="tok-o">,</span> <span class="tok-n">Empleado</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>

<span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Empleado</span><span class="tok-o">&gt;</span> <span class="tok-n">empleados</span> <span class="tok-o">=</span> <span class="tok-n">query</span><span class="tok-o">.</span><span class="tok-na">getResultList</span><span class="tok-o">();</span>
<span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">empleados</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">Empleado</span> <span class="tok-n">empleado</span> <span class="tok-o">:</span> <span class="tok-n">empleados</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">empleado</span><span class="tok-o">.</span><span class="tok-na">getNombre</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-s">&quot; - &quot;</span> <span class="tok-o">+</span>
                <span class="tok-n">empleado</span><span class="tok-o">.</span><span class="tok-na">getDespacho</span><span class="tok-o">().</span><span class="tok-na">getCodigoDespacho</span><span class="tok-o">());</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La consulta devuelve una colección de entidades, junto con sus grafos de objetos relacionados cargados en memoria (de aquellas relaciones que sean EAGER). Por ejemplo cada empleado contiene también su despacho y todas las entidades con las que está relacionado.</p>
</div>
<div class="paragraph">
<p>Podemos restringir el tipo de dato devuelto. Por ejemplo, si sólo queremos los sueldos de los empleados podemos definir la siguiente consulta:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-k">SELECT</span> <span class="tok-n">e</span><span class="tok-p">.</span><span class="tok-n">sueldo</span> <span class="tok-k">FROM</span> <span class="tok-n">Empleado</span> <span class="tok-n">e</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Código que ejecuta la consulta:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">final</span> <span class="tok-n">String</span> <span class="tok-n">FIND_ALL_SUELDOS_EMPLEADOS</span> <span class="tok-o">=</span> <span class="tok-s">&quot;SELECT e.sueldo FROM Empleado e &quot;</span><span class="tok-o">;</span>

<span class="tok-n">TypedQuery</span><span class="tok-o">&lt;</span><span class="tok-n">Double</span><span class="tok-o">&gt;</span> <span class="tok-n">query</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">createQuery</span><span class="tok-o">(</span><span class="tok-n">FIND_ALL_SUELDOS_EMPLEADOS</span><span class="tok-o">,</span> <span class="tok-n">Double</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>

<span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Double</span><span class="tok-o">&gt;</span> <span class="tok-n">sueldosEmpleados</span> <span class="tok-o">=</span> <span class="tok-n">query</span><span class="tok-o">.</span><span class="tok-na">getResultList</span><span class="tok-o">();</span>

<span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">sueldosEmpleados</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-kt">double</span> <span class="tok-n">sueldoEmpleado</span> <span class="tok-o">:</span> <span class="tok-n">sueldosEmpleados</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">sueldoEmpleado</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos también seleccionar una entidad cuyo tipo no listamos en la cláusula <code>SELECT</code>, utilizando los atributos relación. Por ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-k">SELECT</span> <span class="tok-n">e</span><span class="tok-p">.</span><span class="tok-n">departamento</span> <span class="tok-k">FROM</span> <span class="tok-n">Empleado</span> <span class="tok-n">e</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>EL código que ejecuta la consulta:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">final</span> <span class="tok-n">String</span> <span class="tok-n">FIND_ALL_DEPARTAMENTOS</span> <span class="tok-o">=</span> <span class="tok-s">&quot;SELECT e.departamento FROM Empleado e &quot;</span><span class="tok-o">;</span>

<span class="tok-n">TypedQuery</span><span class="tok-o">&lt;</span><span class="tok-n">Departamento</span><span class="tok-o">&gt;</span> <span class="tok-n">query</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">createQuery</span><span class="tok-o">(</span><span class="tok-n">FIND_ALL_DEPARTAMENTOS</span><span class="tok-o">,</span> <span class="tok-n">Departamento</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>

<span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Departamento</span><span class="tok-o">&gt;</span> <span class="tok-n">departamentos</span> <span class="tok-o">=</span> <span class="tok-n">query</span><span class="tok-o">.</span><span class="tok-na">getResultList</span><span class="tok-o">();</span>

<span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">departamentos</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">Departamento</span> <span class="tok-n">departamento</span> <span class="tok-o">:</span> <span class="tok-n">departamentos</span><span class="tok-o">)</span> <span class="tok-o">{</span>
         <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">departamento</span><span class="tok-o">.</span><span class="tok-na">getNombre</span><span class="tok-o">());</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Debido a la relación muchos-a-uno entre <code>Empleado</code> y <code>Departamento</code> la consulta devolverá una lista de instancias de tipo <code>Departamento</code>. La consulta devuelve una lista con tantos elementos como empleados hayan definidos, con los departamentos repetidos.</p>
</div>
</div>
<div class="sect3">
<h4 id="_filtrando_los_resultados">5.3.2. Filtrando los resultados</h4>
<div class="paragraph">
<p>Igual que SQL, JPQL contiene una cláusula <code>WHERE</code> para especificar condiciones que deben cumplir los datos que se devuelven. La mayoría de los operadores disponibles en SQL están en JPQL, incluyendo las operaciones básicas de comparación: <code>IN</code>, <code>LIKE</code> y <code>BETWEEN</code>, funciones como <code>SUBSTRING</code> o <code>LENGTH</code> y subqueries. Igual que antes, la diferencia fundamental es que se utilizan expresiones sobre entidades y no sobre columnas. El siguiente código muestra un ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-k">SELECT</span> <span class="tok-n">e</span>
   <span class="tok-k">FROM</span> <span class="tok-n">Empleado</span> <span class="tok-n">e</span>
      <span class="tok-k">WHERE</span> <span class="tok-n">e</span><span class="tok-p">.</span><span class="tok-n">departamento</span><span class="tok-p">.</span><span class="tok-n">nombre</span> <span class="tok-k">LIKE</span> <span class="tok-s1">&#39;%IA&#39;</span> <span class="tok-k">AND</span>
      <span class="tok-n">e</span><span class="tok-p">.</span><span class="tok-n">sueldo</span> <span class="tok-k">BETWEEN</span> <span class="tok-mi">2000</span> <span class="tok-k">AND</span> <span class="tok-mi">2500</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El código Java es el siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">final</span> <span class="tok-n">String</span> <span class="tok-n">FIND_ALL_EMPLEADOS_WHERE</span> <span class="tok-o">=</span> <span class="tok-s">&quot;SELECT e FROM Empleado e &quot;</span> <span class="tok-o">+</span>
        <span class="tok-s">&quot;WHERE e.departamento.nombre LIKE &#39;%IA&#39; AND&quot;</span> <span class="tok-o">+</span>
        <span class="tok-s">&quot; e.sueldo BETWEEN 2000 AND 2500&quot;</span><span class="tok-o">;</span>

<span class="tok-n">TypedQuery</span><span class="tok-o">&lt;</span><span class="tok-n">Empleado</span><span class="tok-o">&gt;</span> <span class="tok-n">query</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">createQuery</span><span class="tok-o">(</span><span class="tok-n">FIND_ALL_EMPLEADOS_WHERE</span><span class="tok-o">,</span> <span class="tok-n">Empleado</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>

<span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Empleado</span><span class="tok-o">&gt;</span> <span class="tok-n">empleados</span> <span class="tok-o">=</span> <span class="tok-n">query</span><span class="tok-o">.</span><span class="tok-na">getResultList</span><span class="tok-o">();</span>

<span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">empleados</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">Empleado</span> <span class="tok-n">empleado</span> <span class="tok-o">:</span> <span class="tok-n">empleados</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">empleado</span><span class="tok-o">.</span><span class="tok-na">getNombre</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-s">&quot; - &quot;</span> <span class="tok-o">+</span>
                    <span class="tok-n">empleado</span><span class="tok-o">.</span><span class="tok-na">getSueldo</span><span class="tok-o">();</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_proyectando_los_resultados">5.3.3. Proyectando los resultados</h4>
<div class="paragraph">
<p>Es posible recuperar un conjunto de atributos de las instancias, sin que formen una entidad. Esto es útil cuando tenemos una gran cantidad de atributos (columnas) y sólo vamos a necesitar listar algunos. Por ejemplo, la siguiente consulta selecciona sólo el nombre y el salario de los empleados:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-k">SELECT</span> <span class="tok-n">e</span><span class="tok-p">.</span><span class="tok-n">nombre</span><span class="tok-p">,</span> <span class="tok-n">e</span><span class="tok-p">.</span><span class="tok-n">sueldo</span>
   <span class="tok-k">FROM</span> <span class="tok-n">Empleado</span> <span class="tok-n">e</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El resultado será una colección de cero o más instancias de arrays de tipo <code>Object</code>. Cada array contiene dos elementos, el primero un <code>String</code> y el segundo un <code>Double</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">final</span> <span class="tok-n">String</span> <span class="tok-n">FIND_NOMBRE_SUELDO</span> <span class="tok-o">=</span> <span class="tok-s">&quot;SELECT e.nombre, e.sueldo FROM Empleado e&quot;</span><span class="tok-o">;</span>

<span class="tok-n">TypedQuery</span><span class="tok-o">&lt;</span><span class="tok-n">Object</span><span class="tok-o">[]&gt;</span> <span class="tok-n">query</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">createQuery</span><span class="tok-o">(</span><span class="tok-n">FIND_NOMBRE_SUELDO</span><span class="tok-o">,</span> <span class="tok-n">Object</span><span class="tok-o">[].</span><span class="tok-na">class</span><span class="tok-o">);</span>

<span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Object</span><span class="tok-o">[]&gt;</span> <span class="tok-n">tuplas</span> <span class="tok-o">=</span> <span class="tok-n">query</span><span class="tok-o">.</span><span class="tok-na">getResultList</span><span class="tok-o">();</span>

<span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">tuplas</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">Object</span><span class="tok-o">[]</span> <span class="tok-n">tupla</span> <span class="tok-o">:</span> <span class="tok-n">tuplas</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">String</span> <span class="tok-n">nombre</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-n">String</span><span class="tok-o">)</span> <span class="tok-n">tupla</span><span class="tok-o">[</span><span class="tok-mi">0</span><span class="tok-o">];</span>
        <span class="tok-n">Double</span> <span class="tok-n">sueldo</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-n">Double</span><span class="tok-o">)</span> <span class="tok-n">tupla</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">];</span>
        <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">nombre</span> <span class="tok-o">+</span> <span class="tok-s">&quot; - &quot;</span> <span class="tok-o">+</span> <span class="tok-n">sueldo</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_joins_entre_entidades">5.3.4. Joins entre entidades</h4>
<div class="paragraph">
<p>Al igual que en SQL es posible definir consultas que realicen una selección en el resultado de unir (<em>join</em>) entidades entre las que se ha establecido una relación a-muchos. Es posible hacerlo sin necesidad de escribir explícitamente la sentencia <code>JOIN</code>. Por ejemplo, el siguiente código busca los gastos de todos los empleados del departamento <code>DCCIA</code> y devuelve el <code>String</code> <code>concepto</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-k">SELECT</span> <span class="tok-n">f</span><span class="tok-p">.</span><span class="tok-n">concepto</span>
   <span class="tok-k">FROM</span> <span class="tok-n">Empleado</span> <span class="tok-n">e</span><span class="tok-p">,</span> <span class="tok-n">FacturaGasto</span> <span class="tok-n">f</span>
   <span class="tok-k">WHERE</span> <span class="tok-n">e</span> <span class="tok-o">=</span> <span class="tok-n">f</span><span class="tok-p">.</span><span class="tok-n">empleado</span> <span class="tok-k">AND</span>
         <span class="tok-n">e</span><span class="tok-p">.</span><span class="tok-n">departamento</span><span class="tok-p">.</span><span class="tok-n">nombre</span><span class="tok-o">=</span><span class="tok-s1">&#39;DCCIA&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Código Java:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">final</span> <span class="tok-n">String</span> <span class="tok-n">FIND_GASTOS_DCCIA</span> <span class="tok-o">=</span> <span class="tok-s">&quot;SELECT f.concepto&quot;</span> <span class="tok-o">+</span>
         <span class="tok-s">&quot;   FROM Empleado e, FacturaGasto f&quot;</span> <span class="tok-o">+</span>
         <span class="tok-s">&quot;   WHERE e = f.empleado AND&quot;</span> <span class="tok-o">+</span>
         <span class="tok-s">&quot;         e.departamento.nombre=&#39;DCCIA&#39;&quot;</span><span class="tok-o">;</span>

<span class="tok-n">TypedQuery</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-o">&gt;</span> <span class="tok-n">query</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">createQuery</span><span class="tok-o">(</span><span class="tok-n">FIND_GASTOS_DCCIA</span><span class="tok-o">,</span> <span class="tok-n">String</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>

<span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-o">&gt;</span> <span class="tok-n">conceptos</span> <span class="tok-o">=</span> <span class="tok-n">query</span><span class="tok-o">.</span><span class="tok-na">getResultList</span><span class="tok-o">();</span>

<span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">conceptos</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">concepto</span> <span class="tok-o">:</span> <span class="tok-n">conceptos</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">concepto</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>También es posible especificar joins en la cláusula <code>FROM</code> utilizando el operador <code>JOIN</code>. Una ventaja de este operador es que el join puede especificarse en términos de la propia asociación y que el motor de consultas proporcionará automáticamente el criterio de join necesario cuando genere el SQL. El siguiente código muestra la misma consulta reescrita para utilizar este operador:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-k">SELECT</span> <span class="tok-n">f</span><span class="tok-p">.</span><span class="tok-n">concepto</span>
   <span class="tok-k">FROM</span> <span class="tok-n">Empleado</span> <span class="tok-n">e</span> <span class="tok-k">JOIN</span> <span class="tok-n">e</span><span class="tok-p">.</span><span class="tok-n">gastos</span> <span class="tok-n">f</span>
   <span class="tok-k">WHERE</span> <span class="tok-n">e</span><span class="tok-p">.</span><span class="tok-n">departamento</span><span class="tok-p">.</span><span class="tok-n">nombre</span><span class="tok-o">=</span><span class="tok-s1">&#39;DCCIA&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para especificar el <code>JOIN</code> hay que indicar la entidad que tiene la relación a-muchos, el atributo que define la relación a-muchos y el alias que instancia los registros de la otra entidad.</p>
</div>
<div class="paragraph">
<p>JPQL soporta múltiples tipos de joins, incluyendo inner y outer joins, left joins y una técnica denominada fetch joins para cargar datos asociados a las entidades que no se devuelven directamente. No tenemos tiempo de detallar todos ellos. Vamos a ver algunos ejemplos más, para tener una idea de la potencia de la sintaxis.</p>
</div>
<div class="paragraph">
<p>Selecciona todos los departamentos distintos asociados a empleados (sin el operador <code>JOIN</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-k">SELECT</span> <span class="tok-k">DISTINCT</span> <span class="tok-n">e</span><span class="tok-p">.</span><span class="tok-n">departamento</span> <span class="tok-k">FROM</span> <span class="tok-n">Empleado</span> <span class="tok-n">e</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Otra forma de hacer la misma consulta utilizando el operador <code>JOIN</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-k">SELECT</span> <span class="tok-k">DISTINCT</span> <span class="tok-n">d</span> <span class="tok-k">FROM</span> <span class="tok-n">Empleado</span> <span class="tok-n">e</span> <span class="tok-k">JOIN</span> <span class="tok-n">e</span><span class="tok-p">.</span><span class="tok-n">departamento</span> <span class="tok-n">d</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Selecciona los proyectos distintos que pertenecen a empleados del departamento <code>DLSI</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-k">SELECT</span> <span class="tok-k">DISTINCT</span> <span class="tok-n">p</span>
   <span class="tok-k">FROM</span> <span class="tok-n">Departamento</span> <span class="tok-n">d</span> <span class="tok-k">JOIN</span> <span class="tok-n">d</span><span class="tok-p">.</span><span class="tok-n">empleados</span> <span class="tok-n">e</span> <span class="tok-k">JOIN</span> <span class="tok-n">e</span><span class="tok-p">.</span><span class="tok-n">proyectos</span> <span class="tok-n">p</span>
   <span class="tok-k">WHERE</span> <span class="tok-n">d</span><span class="tok-p">.</span><span class="tok-n">nombre</span><span class="tok-o">=</span><span class="tok-s1">&#39;DLSI&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Otro ejemplo algo más complicado. Selecciona los departamentos en el campus <code>UA</code> en donde trabajan empleados que participan en el proyecto <code>Reconocimiento de caras</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-k">SELECT</span> <span class="tok-k">DISTINCT</span> <span class="tok-n">d</span>
   <span class="tok-k">FROM</span> <span class="tok-n">Empleado</span> <span class="tok-n">e</span> <span class="tok-k">JOIN</span> <span class="tok-n">e</span><span class="tok-p">.</span><span class="tok-n">departamento</span> <span class="tok-n">d</span> <span class="tok-k">JOIN</span> <span class="tok-n">e</span><span class="tok-p">.</span><span class="tok-n">proyectos</span> <span class="tok-n">p</span>
   <span class="tok-k">WHERE</span> <span class="tok-n">d</span><span class="tok-p">.</span><span class="tok-n">direccion</span><span class="tok-p">.</span><span class="tok-n">campus</span><span class="tok-o">=</span><span class="tok-s1">&#39;UA&#39;</span> <span class="tok-k">AND</span>
   	 <span class="tok-n">p</span><span class="tok-p">.</span><span class="tok-n">nombre</span><span class="tok-o">=</span><span class="tok-s1">&#39;Reconocimiento de caras&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si cambiáramos en <code>Empleado</code> el tipo de recuperación de <code>departamento</code> a <code>LAZY</code>, la siguiente query recuperaría forzaría la recuperación:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-k">SELECT</span> <span class="tok-n">e</span> <span class="tok-k">FROM</span> <span class="tok-n">Empleado</span> <span class="tok-n">e</span> <span class="tok-k">JOIN</span> <span class="tok-k">FETCH</span> <span class="tok-n">e</span><span class="tok-p">.</span><span class="tok-n">departamento</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Podríamos comprobar el funcionamiento de este último ejemplo con el siguiente código.</p>
</div>
<div class="paragraph">
<p>En la clase <code>Empleado</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
   <span class="tok-o">...</span>
   <span class="tok-nd">@ManyToOne</span><span class="tok-o">(</span><span class="tok-n">fetch</span> <span class="tok-o">=</span> <span class="tok-n">FetchType</span><span class="tok-o">.</span><span class="tok-na">LAZY</span><span class="tok-o">)</span>
   <span class="tok-kd">private</span> <span class="tok-n">Departamento</span> <span class="tok-n">departamento</span><span class="tok-o">;</span>
   <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El código que ejecuta la consulta:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-kd">final</span> <span class="tok-n">String</span> <span class="tok-n">JOIN_FETCH</span> <span class="tok-o">=</span>
                <span class="tok-s">&quot;SELECT e FROM Empleado e JOIN FETCH e.departamento&quot;</span><span class="tok-o">;</span>

<span class="tok-n">query</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">createQuery</span><span class="tok-o">(</span><span class="tok-n">JOIN_FETCH</span><span class="tok-o">);</span>

<span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Empleado</span><span class="tok-o">&gt;</span> <span class="tok-n">empleados</span> <span class="tok-o">=</span> <span class="tok-n">query</span><span class="tok-o">.</span><span class="tok-na">getResultList</span><span class="tok-o">();</span>

<span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1">

<span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">empleados</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
   <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">Empleado</span> <span class="tok-n">empleado</span> <span class="tok-o">:</span> <span class="tok-n">empleados</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">empleado</span><span class="tok-o">.</span><span class="tok-na">getDepartamento</span><span class="tok-o">().</span><span class="tok-na">getDireccion</span><span class="tok-o">().</span><span class="tok-na">getEdificio</span><span class="tok-o">());</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1"></td>
<td>Se cierra el entity manager para comprobar que se han cargado la relación <code>LAZY</code> definida con <code>Departamento</code> y que se recupera en <code>empleado.getDepartamento()</code></td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_paginación_de_resultados">5.3.5. Paginación de resultados</h4>
<div class="paragraph">
<p>Es posible realizar un paginado de los resultados, definiendo un número máximo de instancias a devolver en la consulta y un número de instancia a partir del que se construye la lista:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">Query</span> <span class="tok-n">q</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">createQuery</span><span class="tok-o">(</span><span class="tok-s">&quot;SELECT e FROM Empleado e&quot;</span><span class="tok-o">);</span>
<span class="tok-n">q</span><span class="tok-o">.</span><span class="tok-na">setFirstResult</span><span class="tok-o">(</span><span class="tok-mi">20</span><span class="tok-o">);</span>
<span class="tok-n">q</span><span class="tok-o">.</span><span class="tok-na">setMaxResults</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">);</span>
<span class="tok-n">List</span> <span class="tok-n">empleados</span> <span class="tok-o">=</span> <span class="tok-n">q</span><span class="tok-o">.</span><span class="tok-na">getResultList</span><span class="tok-o">();</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_subqueries">5.3.6. Subqueries</h4>
<div class="paragraph">
<p>Es posible anidar múltiples queries. Podemos utilizar el operador <code>IN</code> para obtener las instancias que se encuentran en el resultado de la subquery. Por ejemplo, la siguiente expresión devuelve los empleados que participan en proyectos de tipo 'A'.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">SELECT</span> <span class="tok-n">e</span> <span class="tok-n">FROM</span> <span class="tok-n">Empleado</span> <span class="tok-n">e</span>
<span class="tok-n">WHERE</span> <span class="tok-n">e</span><span class="tok-o">.</span><span class="tok-na">proyecto</span> <span class="tok-nf">IN</span> <span class="tok-o">(</span><span class="tok-n">SELECT</span> <span class="tok-n">p</span>
   <span class="tok-n">FROM</span> <span class="tok-n">Proyecto</span> <span class="tok-n">p</span>
   <span class="tok-n">WHERE</span> <span class="tok-n">p</span><span class="tok-o">.</span><span class="tok-na">tipo</span> <span class="tok-o">=</span> <span class="tok-sc">&#39;A&#39;</span><span class="tok-o">)</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_valores_nulos_y_colecciones_vacías">5.3.7. Valores nulos y colecciones vacías</h4>
<div class="paragraph">
<p>Es posible utilizar los operadores <code>IS NULL</code> o <code>IS NOT NULL</code> para chequear si un atributo es o no nulo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-k">WHERE</span> <span class="tok-n">e</span><span class="tok-p">.</span><span class="tok-n">departamento</span> <span class="tok-k">IS</span> <span class="tok-k">NOT</span> <span class="tok-k">NULL</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En el caso de colecciones hay que utilizar los operadores <code>IS EMPTY</code> o <code>IS NOT EMPTY</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-k">WHERE</span> <span class="tok-n">e</span><span class="tok-p">.</span><span class="tok-n">proyectos</span> <span class="tok-k">IS</span> <span class="tok-n">EMPTY</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_funciones">5.3.8. Funciones</h4>
<div class="paragraph">
<p>Es posible utilizar llamadas a funciones predefinidas en JPQL. Veamos unos cuantos ejemplos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>CONCAT</code> concatena dos cadenas</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>CONCAT(string1, string2)</pre>
</div>
</div>
<div class="paragraph">
<p>Por ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-k">WHERE</span> <span class="tok-n">CONCAT</span><span class="tok-p">(</span><span class="tok-n">e</span><span class="tok-p">.</span><span class="tok-n">nombre</span><span class="tok-p">,</span> <span class="tok-n">e</span><span class="tok-p">.</span><span class="tok-n">apellido</span><span class="tok-p">)</span> <span class="tok-k">LIKE</span> <span class="tok-s1">&#39;Ju%cia&#39;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>SUBSTRING</code> extra una subcadena</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-k">SUBSTRING</span><span class="tok-p">(</span><span class="tok-n">string</span><span class="tok-p">,</span> <span class="tok-k">position</span><span class="tok-p">,</span> <span class="tok-k">length</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</li>
<li>
<p><code>LOWER</code> devuelve los caracteres de una cadena convertidos en minúsculas</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-k">LOWER</span><span class="tok-p">(</span><span class="tok-n">string</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</li>
<li>
<p><code>UPPER</code> devuelve los caracteres de una cadena convertidos en mayúsculas</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-k">UPPER</span><span class="tok-p">(</span><span class="tok-n">string</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</li>
<li>
<p><code>LENGTH</code> devuelve la longitud de una cadena</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-k">LENGTH</span><span class="tok-p">(</span><span class="tok-n">string</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</li>
<li>
<p><code>SIZE</code> devuelve el tamaño de una colección</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>WHERE SIZE (e.proyectos) &gt; 4</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>CURRENT_TIME</code>, <code>CURRENT_DATE</code>, <code>CURRENT_TIMESTAMP</code> devuelven el tiempo del momento actual</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_pattern_matching">5.3.9. Pattern matching</h4>
<div class="literalblock">
<div class="content">
<pre>Veamos el conjunto de funciones y operadores que permiten introducir _pattern matching_ sobre campos de texto en las búsquedas.</pre>
</div>
</div>
<div class="sect4">
<h5 id="_like">LIKE</h5>
<div class="paragraph">
<p>El operador <code>LIKE</code> permite buscar un patrón en un texto y comprueba si una cadena especificada cumple un patrón especificado. Si se precede con el operador <code>NOT</code> devuelve aquellos valores que no cumplen el patrón. El patrón puede incluir cualquier carácter y los siguientes caracteres libres:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>El carácter tanto por ciento (%) empareja con 0 o más caracteres cualesquiera</p>
</li>
<li>
<p>El carácter subrayado (_) empareja un único carácter cualquiera</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>El operando izquierdo es siempre la cadena que se comprueba y el derecho el patrón. Ejemplos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>c.name LIKE '_r%'</code> es <code>TRUE</code> para 'Brasil' and FALSE for 'Dinamarca'</p>
</li>
<li>
<p><code>c.name LIKE '%'</code> es siempre <code>TRUE</code></p>
</li>
<li>
<p><code>c.name NOT LIKE '%'</code> es siempre <code>FALSE</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Para emparejar un carácter subrayado o tanto por ciento tiene que ir precedido por un carácter de escape. Por ejemplo:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>'100%' LIKE '%\%' ESCAPE '\'</code> se evalua a <code>TRUE</code>.</p>
</li>
<li>
<p><code>'100' LIKE '%\%' ESCAPE '\'</code> se evalua a <code>FALSE</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>En las expresiones de arriba sólo el primer carácter tanto por ciento (%) representa un carácter libre. El segundo (que aparece tras el carácter de escape) representa un carácter <code>%</code> real %.</p>
</div>
</div>
<div class="sect4">
<h5 id="_locate">LOCATE</h5>
<div class="paragraph">
<p>El operador <code>LOCATE(str, substr [, start])</code> busca una subcadena y devuelve su posición (comenzando a contar por 1). El tercer argumento, si está presente, especifica la posición a partir de la que comienza la búsqueda. Se devuelve 0 si no se encuentra la subcadena. Por ejemplo:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>LOCATE('India', 'a')</code> devuelve 5</p>
</li>
<li>
<p><code>LOCATE('Alicante', 'a', 3)</code> devuelve 5</p>
</li>
<li>
<p><code>LOCATE('Mejico', 'a')</code> devuelve 0</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_trim">TRIM</h5>
<div class="paragraph">
<p>El operador TRIM([[LEADING|TRAILING|BOTH] [char] FROM] str) devuelve una cadena después de haber eliminado los caracteres del comienzo (<em>LEADING</em>), del final (<em>TRAILING</em>) o ambos (<em>BOTH</em>). Si no se especifica el carácter, se considera el espacio en blanco. Ejemplos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>TRIM(' UK ')</code> devuelve 'UK'</p>
</li>
<li>
<p><code>TRIM(LEADING FROM ' UK ')</code> devuelve 'UK '</p>
</li>
<li>
<p><code>TRIM(TRAILING FROM ' UK ')</code> devuelve ' UK'</p>
</li>
<li>
<p><code>TRIM(BOTH FROM ' UK ')</code> devuelve 'UK'</p>
</li>
<li>
<p><code>TRIM('A' FROM 'ARGENTINA')</code> devuelve 'RGENTIN'</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_substring">SUBSTRING</h5>
<div class="paragraph">
<p>El operador <code>SUBSTRING(str, pos [, long])</code> devuelve una subcadena de una cadena específica a partir de la posición <code>pos</code> y con el número de caracteres <code>long</code> (opcional). Si no se especifica el número de caracteres se devuelve la cadena completa. Las posiciones comienzan en 1, a diferencia de Java en donde el comienzo de la cadena viene indicado por el 0.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>SUBSTRING('Italia', 3)</code> devuelve 'aly'</p>
</li>
<li>
<p><code>SUBSTRING('Italia', 3, 2)</code> devuelve 'al'</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_agrupaciones">5.3.10. Agrupaciones</h4>
<div class="paragraph">
<p>JPQL proporciona las siguientes funciones de agrupación: <code>AVG</code>,<code>COUNT</code>,<code>MAX</code>,<code>MIN</code>,<code>SUM</code> que pueden ser aplicadas a un número de valores. El tipo devuelto por las funciones es <code>Long</code> o <code>Double</code>, dependiendo de los valores implicados en la operación.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, para obtener el mayor sueldo de un conjunto de empleados:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">SELECT</span> <span class="tok-nf">MAX</span><span class="tok-o">(</span><span class="tok-n">e</span><span class="tok-o">.</span><span class="tok-na">sueldo</span><span class="tok-o">)</span>
<span class="tok-n">FROM</span> <span class="tok-n">Empleado</span> <span class="tok-n">e</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para obtener el número de elementos que cumplen una condición:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">SELECT</span> <span class="tok-nf">COUNT</span><span class="tok-o">(</span><span class="tok-n">e</span><span class="tok-o">)</span>
<span class="tok-n">FROM</span> <span class="tok-n">Empleado</span> <span class="tok-n">e</span>
<span class="tok-n">WHERE</span> <span class="tok-o">...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos realizar consultas más complicadas utilizando <code>GROUP BY</code> y <code>HAVING</code>. Por ejemplo, podemos obtener los empleados y el número de proyectos en los que participan de la siguiente forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">SELECT</span> <span class="tok-n">p</span><span class="tok-o">.</span><span class="tok-na">empleado</span><span class="tok-o">,</span> <span class="tok-n">COUNT</span><span class="tok-o">(</span><span class="tok-n">p</span><span class="tok-o">)</span>
<span class="tok-n">FROM</span> <span class="tok-n">Proyecto</span> <span class="tok-n">p</span>
<span class="tok-n">GROUP</span> <span class="tok-n">BY</span> <span class="tok-n">p</span><span class="tok-o">.</span><span class="tok-na">empleado</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El código para recorrer la lista resultante sería el siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">List</span> <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">createQuery</span><span class="tok-o">(</span><span class="tok-s">&quot;SELECT p.empleado, COUNT(p)&quot;</span> <span class="tok-o">+</span>
<span class="tok-s">&quot;FROM Proyecto p GROUP BY p.empleado&quot;</span><span class="tok-o">).</span><span class="tok-na">getResultList</span><span class="tok-o">();</span>
<span class="tok-n">Iterator</span> <span class="tok-n">res</span> <span class="tok-o">=</span> <span class="tok-n">result</span><span class="tok-o">.</span><span class="tok-na">iterator</span><span class="tok-o">();</span>
<span class="tok-k">while</span> <span class="tok-o">(</span><span class="tok-n">res</span><span class="tok-o">.</span><span class="tok-na">hasNext</span><span class="tok-o">())</span> <span class="tok-o">{</span>
  <span class="tok-n">Object</span><span class="tok-o">[]</span> <span class="tok-n">tupla</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-n">Object</span><span class="tok-o">[])</span> <span class="tok-n">res</span><span class="tok-o">.</span><span class="tok-na">next</span><span class="tok-o">();</span>
  <span class="tok-n">Empleado</span> <span class="tok-n">emp</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-n">Empleado</span><span class="tok-o">)</span> <span class="tok-n">tupla</span><span class="tok-o">[</span><span class="tok-mi">0</span><span class="tok-o">];</span>
  <span class="tok-kt">long</span> <span class="tok-n">count</span> <span class="tok-o">=</span> <span class="tok-o">((</span><span class="tok-n">Long</span><span class="tok-o">)</span> <span class="tok-n">tupla</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">]).</span><span class="tok-na">longValue</span><span class="tok-o">();</span>
  <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La siguiente consulta combina todos los elementos. Primero se filtrarían los resultados con la cláusula <code>WHERE</code>, después los resultados son agrupados y por último se comprueba la cláusula <code>HAVING</code>. Devuelve los empleados que participan en más de 5 proyectos creados entre dos fechas dadas.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">SELECT</span> <span class="tok-n">p</span><span class="tok-o">.</span><span class="tok-na">empleado</span><span class="tok-o">,</span> <span class="tok-n">COUNT</span><span class="tok-o">(</span><span class="tok-n">p</span><span class="tok-o">)</span>
<span class="tok-n">FROM</span> <span class="tok-n">Proyecto</span> <span class="tok-n">p</span>
<span class="tok-n">WHERE</span> <span class="tok-n">p</span><span class="tok-o">.</span><span class="tok-na">fechaCreacion</span> <span class="tok-n">is</span> <span class="tok-n">BETWEEN</span> <span class="tok-o">:</span><span class="tok-n">date1</span> <span class="tok-n">and</span> <span class="tok-o">:</span><span class="tok-n">date2</span>
<span class="tok-n">GROUP</span> <span class="tok-n">BY</span> <span class="tok-n">p</span><span class="tok-o">.</span><span class="tok-na">empleado</span>
<span class="tok-n">HAVING</span> <span class="tok-nf">COUNT</span><span class="tok-o">(</span><span class="tok-n">p</span><span class="tok-o">)</span> <span class="tok-o">&gt;</span> <span class="tok-mi">5</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_order_by">5.3.11. Order by</h4>
<div class="paragraph">
<p>Es posible ordenar la lista resultante de la consulta por alguno de los campos usando la directiva <code>ORDER BY</code>. Un ejemplo de su uso:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">muestraEmpleadosProyecto</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombreProyecto</span><span class="tok-o">)</span> <span class="tok-o">{</span>
   <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Empleado</span><span class="tok-o">&gt;</span> <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">createQuery</span><span class="tok-o">(</span>
                             <span class="tok-s">&quot;SELECT e &quot;</span> <span class="tok-o">+</span>
                             <span class="tok-s">&quot;FROM Proyecto p JOIN p.empleados e &quot;</span> <span class="tok-o">+</span>
                             <span class="tok-s">&quot;WHERE p.nombre = ?1 &quot;</span> <span class="tok-o">+</span>
                             <span class="tok-s">&quot;ORDER BY e.name&quot;</span><span class="tok-o">)</span>
                             <span class="tok-o">.</span><span class="tok-na">setParameter</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">,</span> <span class="tok-n">nombreProyecto</span><span class="tok-o">)</span>
                             <span class="tok-o">.</span><span class="tok-na">getResultList</span><span class="tok-o">();</span>
   <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">empleado</span> <span class="tok-o">:</span> <span class="tok-n">result</span><span class="tok-o">)</span> <span class="tok-o">{</span>
	      <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">empleado</span><span class="tok-o">.</span><span class="tok-na">nombre</span><span class="tok-o">);</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_api_criteria">5.4. API Criteria</h3>
<div class="paragraph">
<p>El API Criteria de JPA se introdujo en la especificación 2.0 de JPA y permite la definición de consultas dinámicas mediante en tiempo de ejecución de objetos y métodos específicos que permiten configurar la query. Al construirse las queries paso a paso de forma programativa mediante llamadas a interfaces estrictas, es posible detectar errores en su construcción en tiempo de compilación. Esto supone una importante ventaja con respecto a JPQL, en donde la construcción de una query se hace a través del parseo de la cadena con la expresión JPQL y sólo se puede detectar el error en el momento de la ejecución.</p>
</div>
<div class="paragraph">
<p>Las queries del API criteria son dinámicas y no pueden ser compiladas por lo que no pueden beneficiarse de la pre-compilación realizada por algunos proveedores de JPA.</p>
</div>
<div class="paragraph">
<p>El API es bastante avanzado y necesitaríamos una sesión completa para introducir sus elementos básicos. Vamos a ver sólo un par de ejemplos muy sencillos para comprobar el aspecto del API.</p>
</div>
<div class="sect3">
<h4 id="_ejemplos">5.4.1. Ejemplos</h4>
<div class="paragraph">
<p>Consulta que devuelve todos los empleados:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">CriteriaBuilder</span> <span class="tok-n">cb</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getCriteriaBuilder</span><span class="tok-o">();</span>
<span class="tok-n">CriteriaQuery</span><span class="tok-o">&lt;</span><span class="tok-n">Empleado</span><span class="tok-o">&gt;</span> <span class="tok-n">cq</span> <span class="tok-o">=</span> <span class="tok-n">cb</span><span class="tok-o">.</span><span class="tok-na">createQuery</span><span class="tok-o">(</span><span class="tok-n">Empleado</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>
<span class="tok-n">Root</span><span class="tok-o">&lt;</span><span class="tok-n">Empleado</span><span class="tok-o">&gt;</span> <span class="tok-n">e</span> <span class="tok-o">=</span> <span class="tok-n">cq</span><span class="tok-o">.</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-n">Empleado</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>
<span class="tok-n">cq</span><span class="tok-o">.</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-n">e</span><span class="tok-o">);</span>
<span class="tok-n">query</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">createQuery</span><span class="tok-o">(</span><span class="tok-n">cq</span><span class="tok-o">);</span>
<span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Empleado</span><span class="tok-o">&gt;</span> <span class="tok-n">empleados</span> <span class="tok-o">=</span> <span class="tok-n">query</span><span class="tok-o">.</span><span class="tok-na">getResultList</span><span class="tok-o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Consulta que devuelve todos los empleados con sueldo mayor de 2000:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">CriteriaBuilder</span> <span class="tok-n">cb</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getCriteriaBuilder</span><span class="tok-o">();</span>
<span class="tok-n">CriteriaQuery</span><span class="tok-o">&lt;</span><span class="tok-n">Empleado</span><span class="tok-o">&gt;</span> <span class="tok-n">cq</span> <span class="tok-o">=</span> <span class="tok-n">cb</span><span class="tok-o">.</span><span class="tok-na">createQuery</span><span class="tok-o">(</span><span class="tok-n">Empleado</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>
<span class="tok-n">Root</span><span class="tok-o">&lt;</span><span class="tok-n">Empleado</span><span class="tok-o">&gt;</span> <span class="tok-n">e</span> <span class="tok-o">=</span> <span class="tok-n">cq</span><span class="tok-o">.</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-n">Empleado</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>
<span class="tok-n">cq</span><span class="tok-o">.</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-n">e</span><span class="tok-o">);</span>
<span class="tok-n">cq</span><span class="tok-o">.</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-n">cb</span><span class="tok-o">.</span><span class="tok-na">greaterThan</span><span class="tok-o">(</span><span class="tok-n">e</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-s">&quot;sueldo&quot;</span><span class="tok-o">),</span> <span class="tok-mf">2500.0</span><span class="tok-o">));</span>
<span class="tok-n">Query</span> <span class="tok-n">query</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">createQuery</span><span class="tok-o">(</span><span class="tok-n">cq</span><span class="tok-o">);</span>
<span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Empleado</span><span class="tok-o">&gt;</span> <span class="tok-n">emps</span> <span class="tok-o">=</span> <span class="tok-n">query</span><span class="tok-o">.</span><span class="tok-na">getResultList</span><span class="tok-o">();</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_organización_de_las_queries_en_daos">5.5. Organización de las queries en DAOs</h3>
<div class="paragraph">
<p>Una forma de ordenar las queries es incluyéndolas en los DAO que gestionan los distintos tipos de entidades. En cada DAO declararemos las queries relacionadas. Por ejemplo, en el siguiente código de <code>EmpleadoDao</code> se incluyen algunas de las consultas vistas anteriormente.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">EmpleadoDao</span> <span class="tok-kd">extends</span> <span class="tok-n">Dao</span><span class="tok-o">&lt;</span><span class="tok-n">Empleado</span><span class="tok-o">,</span> <span class="tok-n">Long</span><span class="tok-o">&gt;</span> <span class="tok-o">{</span>
    <span class="tok-n">String</span> <span class="tok-n">FIND_ALL_EMPLEADOS</span> <span class="tok-o">=</span> <span class="tok-s">&quot;SELECT e FROM Empleado e &quot;</span><span class="tok-o">;</span>

    <span class="tok-n">String</span> <span class="tok-n">FIND_ALL_SUELDOS_EMPLEADOS</span> <span class="tok-o">=</span>
            <span class="tok-s">&quot;SELECT e.sueldo FROM Empleado e&quot;</span><span class="tok-o">;</span>

    <span class="tok-n">String</span> <span class="tok-n">FIND_PROJECTOS_EMPLEADOS_DEPARTAMENTO</span> <span class="tok-o">=</span> <span class="tok-s">&quot;SELECT DISTINCT p&quot;</span> <span class="tok-o">+</span>
            <span class="tok-s">&quot; FROM Departamento d JOIN d.empleados e JOIN e.proyectos p&quot;</span> <span class="tok-o">+</span>
            <span class="tok-s">&quot; WHERE d.nombre=&#39;DLSI&#39;&quot;</span><span class="tok-o">;</span>

    <span class="tok-kd">public</span> <span class="tok-nf">EmpleadoDao</span><span class="tok-o">(</span><span class="tok-n">EntityManager</span> <span class="tok-n">em</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-kd">super</span><span class="tok-o">(</span><span class="tok-n">em</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-n">Empleado</span> <span class="tok-nf">find</span><span class="tok-o">(</span><span class="tok-n">Long</span> <span class="tok-n">id</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">getEntityManager</span><span class="tok-o">();</span>
        <span class="tok-k">return</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Empleado</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-n">id</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Empleado</span><span class="tok-o">&gt;</span> <span class="tok-nf">listAllEmpleados</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">getEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">TypedQuery</span><span class="tok-o">&lt;</span><span class="tok-n">Empleado</span><span class="tok-o">&gt;</span> <span class="tok-n">query</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">createQuery</span><span class="tok-o">(</span><span class="tok-n">FIND_ALL_EMPLEADOS</span><span class="tok-o">,</span> <span class="tok-n">Empleado</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>
        <span class="tok-k">return</span> <span class="tok-n">query</span><span class="tok-o">.</span><span class="tok-na">getResultList</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Double</span><span class="tok-o">&gt;</span> <span class="tok-nf">listAllSueldosEmpleados</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">getEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">TypedQuery</span><span class="tok-o">&lt;</span><span class="tok-n">Double</span><span class="tok-o">&gt;</span> <span class="tok-n">query</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">createQuery</span><span class="tok-o">(</span><span class="tok-n">FIND_ALL_SUELDOS_EMPLEADOS</span><span class="tok-o">,</span> <span class="tok-n">Double</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>
        <span class="tok-k">return</span> <span class="tok-n">query</span><span class="tok-o">.</span><span class="tok-na">getResultList</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Proyecto</span><span class="tok-o">&gt;</span> <span class="tok-nf">listAllProyectosEmpleadosDepartamento</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombreDepto</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">getEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">TypedQuery</span><span class="tok-o">&lt;</span><span class="tok-n">Proyecto</span><span class="tok-o">&gt;</span> <span class="tok-n">query</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">createQuery</span><span class="tok-o">(</span><span class="tok-n">FIND_PROJECTOS_EMPLEADOS_DEPARTAMENTO</span><span class="tok-o">,</span> <span class="tok-n">Proyecto</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>
        <span class="tok-k">return</span> <span class="tok-n">query</span><span class="tok-o">.</span><span class="tok-na">getResultList</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="_ejercicios_5">5.6. Ejercicios</h3>
<div class="paragraph">
<p>Vamos a trabajar con el proyecto <code>filmoteca</code>. Define las siguientes consultas en <code>PeliculaDao</code> y <code>ActorDao</code>. Para cada una de ellas escribe un programa main que compruebe su funcionamiento. Cada consulta se puntúa con 0,25 puntos.</p>
</div>
<div class="sect3">
<h4 id="__0_75_puntos_definición_de_consultas_en_peliculadao">5.6.1. (0,75 puntos) Definición de consultas en PeliculaDao</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">Consulta 1</dt>
<dd>
<p><code>List&lt;Pelicula&gt; peliculaPorNombre(String nombre)</code>, que tiene como parámetro el nombre de una película y devuelve una lista de películas que contienen ese nombre.</p>
</dd>
<dt class="hdlist1">Consulta 2</dt>
<dd>
<p><code>Double puntuacionMediaCriticas(Long idPeliculas)</code>, que tiene como parámetro el identificador de la película y devuelve la puntuación media de todas las críticas de esa película.</p>
</dd>
<dt class="hdlist1">Consulta 3</dt>
<dd>
<p><code>List&lt;NumActoresPelicula&gt; peliculasNumActores()</code>, sin ningún parámetro que devuelve una colección de <code>NumActoresPelicula</code> (un objeto que contiene un identificador de película, un nombre de película y un entero que representa el número de actores que intervienen en la película), ordenado de mayor número de actores a menor. La clase <code>NumActoresPelicula</code> está definida en el mismo paquete que el Dao.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="__0_75_puntos_definición_de_consultas_en_actordao">5.6.2. (0,75 puntos) Definición de consultas en ActorDao</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">Consulta 1</dt>
<dd>
<p><code>List&lt;Actor&gt; actorPorNombre(String nombre)</code>, que tiene como parámetro el nombre de un actor y devuelve el una lista de actores que contienen ese nombre.</p>
</dd>
<dt class="hdlist1">Consulta 2</dt>
<dd>
<p><code>List&lt;Pelicula&gt; peliculasConActor(Long idActor)</code>, que tiene como parámetro el identificador de un actor y devuelve todas las películas en las que participa.</p>
</dd>
<dt class="hdlist1">Consulta 3</dt>
<dd>
<p><code>List&lt;Critica&gt; criticasActor(Long idActor)</code>, que tiene como parámetro el identificador de un actor y devuelve todas las críticas de las películas en las que aparece el actor.</p>
</dd>
<dt class="hdlist1">Consulta 4</dt>
<dd>
<p><code>List&lt;Actor&gt; actoresConMasPeliculasDe(int n)</code>, que tiene como parámetro un número y devuelve una colección con todos los actores que han participado en más de <em>n</em> películas.</p>
</dd>
</dl>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion06">6. Transacciones y JPA en aplicaciones Java EE</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_transacciones_2">6.1. Transacciones</h3>
<div class="paragraph">
<p>La gestión de transacciones es fundamental en cualquier aplicación que trabaja con de datos. Idealmente, una transacción define una <em>unidad de trabajo</em> que debe cumplir los criterios ACID: Atomicidad, Consistencia, Aislamiento (la "I" viene del inglés <em>Isolation</em>) y Durabilidad. La consistencia la debe proporcionar el programador, realizando operaciones que lleven los datos de un estado consistente a otro. La durabilidad la proporciona el hecho de que usemos un sistema de bases de datos. Las dos características restantes, la <em>atomicidad</em> y el <em>aislamiento</em> son las más interesantes, y las que vienen determinadas por el sistema de gestión de persistencia que usemos. Veámoslas con más detalle.</p>
</div>
<div class="paragraph">
<p>Una transacción debe ser atómica. Esto es, todas las operaciones de una transacción deben terminar con exito o la transacción debe abortar completamente, dejando el sistema en el mismo estado que antes de comenzar la transacción. En el primer caso se dice que la transacción ha realizado un commit y en el segundo que ha efectuado un rollback. Por esta propiedad, una transacción se debe tratar como una unidad de computación.</p>
</div>
<div class="paragraph">
<p>Para garantizar la atomicidad en JDBC se llama al método <code>setAutoCommit(false)</code> de la conexión para demarcar el comienzo de la transacción y a <code>commit()</code> o <code>rollback()</code> al final de la transacción para confirmar los cambios o deshacerlos. Veremos que JPA que utiliza una demarcación explícita de las transacciones, marcando su comienzo con una llamada a un método <code>begin()</code> y su final también con llamadas a <code>commit()</code> o <code>rollback()</code>. Siempre debemos tener muy presente que JPA (cuando no utilizamos un servidor de aplicaciones) se basará completamente en la implementación de JDBC para tratar con la base de datos.</p>
</div>
<div class="paragraph">
<p>Un transacción también debe ejecutarse de forma aislada. Esto es, no se deben exponer a otras transacciones concurrentes datos que todavía no se han consolidado con un commit. La concurrencia de acceso a los recursos afectados en una transacción hace muy complicado mantener esta propiedad. Veremos que JPA proporciona un enfoque moderno basado en <em>bloqueos optimistas</em> (<em>optimistic locking</em>) para tratar la concurrencia entre transacciones.</p>
</div>
<div class="sect3">
<h4 id="_atomicidad">6.1.1. Atomicidad</h4>
<div class="paragraph">
<p>El <em>entity manager</em> de JPA define la interfaz <code>EntityTransaction</code> para gestionar las transacciones. Esta interfaz intenta imitar el API de Java para gestión de transacciones distribuidas: JTA. Pero tengamos siempre en cuenta que para su implementación se utiliza el propio sistema de transacciones de la base de datos definida en la unidad de persistencia, utilizando los métodos de transacciones de la interfaz <code>Connection</code> de JDBC. Estas transacciones son locales (no distribuidas) y no se pueden anidar ni extender.</p>
</div>
<div class="paragraph">
<p>Estas transacciones locales se usan cuando estamos trabajando con JPA en aplicaciones Java SE. Cuando desarrollamos aplicaciones JPA en entornos web debemos utilizar el estándar de transacciones JTA, que hace que la transacción la controle el propio servidor de aplicaciones.</p>
</div>
<div class="paragraph">
<p>Para definir una transacción local hay que obtener un <code>EntityTransaction</code> a partir del entity manager. El método del entity manager que se utiliza para ello es <code>getTransaction()</code>. Una vez obtenida la transacción, podemos utilizar uno de los métodos de su interfaz:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kd">interface</span> <span class="tok-nc">EntityTransaction</span> <span class="tok-o">{</span>
   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">begin</span><span class="tok-o">();</span>
   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">commit</span><span class="tok-o">();</span>
   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">rollback</span><span class="tok-o">();</span>
   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setRollbackOnly</span><span class="tok-o">();</span>
   <span class="tok-kd">public</span> <span class="tok-kt">boolean</span> <span class="tok-nf">getRollbackOnly</span><span class="tok-o">();</span>
   <span class="tok-kd">public</span> <span class="tok-kt">boolean</span> <span class="tok-nf">isActive</span><span class="tok-o">();}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Sólo hay seis métodos en la interfaz <code>EntityTransaction</code>. El método <code>begin()</code> comienza una nueva transacción en el recurso. Si la transacción está activa, <code>isActive()</code> devolverá <code>true</code>. Si se intenta comenzar una nueva transacción cuando ya hay una activa se genera una excepción <code>IllegalStateException</code>. Una vez activa, la transacción puede finalizarse invocando a <code>commit()</code> o deshacerse invocando a <code>rollback()</code>. Ambas operaciones fallan con una <code>IllegalStateException</code> si no hay ninguna transacción activa. El método <code>setRollbackOnly()</code> marca una transacción para que su único final posible sea un <code>rollback()</code>.</p>
</div>
<div class="paragraph">
<p>Se lanzará una <code>PersistenceException</code> si ocurre un error durante el rollback y se lanzará una <code>RollbackException</code> (un subtipo de <code>PersistenceException</code>) si falla el commit. Tanto <code>PersistenceException</code> como <code>IllegalException</code> son excepciones de tipo <code>RuntimeException</code>.</p>
</div>
<div class="paragraph">
<p>El método <code>setRollbackOnly()</code> se utiliza para marcar la transacción actual como inválida y obligar a realizar un rollback cuando se ejecuta JPA con transacciones gestionadas por el contenedor de EJB (CMT: <em>Containter Managed Transactions</em>). En ese caso la aplicación no define explícitamente las transacciones, sino que es el propio componente EJB el que abre y cierra una transacción en cada método.</p>
</div>
<div class="paragraph">
<p>Hemos comentado que en JPA todas las excepciones son de tipo <code>RunTimeException</code>. Esto es debido a que son fatales y casi nunca se puede hacer nada para recuperarlas. En muchas ocasiones ni siquiera se capturan en el fragmento de código en el que se originan, sino en el único lugar de la aplicación en el que se capturan las excepciones de este tipo.</p>
</div>
<div class="paragraph">
<p>La forma habitual de definir las transacciones en JPA es la definida en el siguiente código:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">EntityManagerFactory</span> <span class="tok-n">emf</span> <span class="tok-o">=</span> <span class="tok-n">Persistence</span>
            <span class="tok-o">.</span><span class="tok-na">createEntityManagerFactory</span><span class="tok-o">(</span><span class="tok-s">&quot;empleados-mysql&quot;</span><span class="tok-o">);</span>
<span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
<span class="tok-n">EntityTransaction</span> <span class="tok-n">tx</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">();</span>
<span class="tok-k">try</span> <span class="tok-o">{</span>
    <span class="tok-n">tx</span><span class="tok-o">.</span><span class="tok-na">begin</span><span class="tok-o">();</span>
    <span class="tok-c1">// Operaciones sobre entidades</span>
    <span class="tok-n">tx</span><span class="tok-o">.</span><span class="tok-na">commit</span><span class="tok-o">();</span>
<span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">RuntimeException</span> <span class="tok-n">ex</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-k">try</span> <span class="tok-o">{</span>
        <span class="tok-n">tx</span><span class="tok-o">.</span><span class="tok-na">rollback</span><span class="tok-o">();</span>
        <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-na">error</span><span class="tok-o">(</span><span class="tok-s">&quot;Transacción deshecha&quot;</span><span class="tok-o">,</span> <span class="tok-n">ex</span><span class="tok-o">);</span>
    <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">RuntimeException</span> <span class="tok-n">rbEx</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-na">error</span><span class="tok-o">(</span><span class="tok-s">&quot;No se ha podido deshacer la transacción&quot;</span><span class="tok-o">,</span> <span class="tok-n">rbEx</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>
    <span class="tok-k">throw</span> <span class="tok-n">ex</span><span class="tok-o">;</span>
<span class="tok-o">}</span> <span class="tok-k">finally</span> <span class="tok-o">{</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
        <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Primero se obtiene la transacción y se llama al método <code>begin()</code>. Después se realizan todas las operaciones dentro de la transacción y se realiza un <code>commit()</code>. Todo ello se engloba en un bloque de <code>try/catch</code>. Si alguna operación falla lanza una excepción que se captura y se ejecuta el <code>rollback()</code>. Un último <code>try/catch</code> captura una posible excepción en el caso en que el rollback produzca alguna excepción. En cualquier caso se cierra el entity manager.</p>
</div>
<div class="paragraph">
<p>Cuando se deshace una transacción en la base de datos todos los cambios realizados durante la transacción se deshacen también. La base de datos vuelve al estado previo al comienzo de la transacción. Sin embargo, el modelo de memoria de Java no es transaccional. No hay forma de obtener una instantánea de un objeto y revertir su estado a ese momento si algo va mal. Una de las cuestiones más complicadas de un mapeo entidad-relación es que mientras que podemos utilizar una semántica transaccional para decidir qué cambios se realizan en la base de datos, no podemos aplicar las mismas técnicas en el contexto de persistencia en el que viven las instancias de entidades.</p>
</div>
<div class="paragraph">
<p>Siempre que tenemos cambios que deben sincronizarse en una base de datos, estamos trabajado con un contexto de persistencia sincronizado con una transacción. En un momento dado durante la vida de la transacción, normalmente justo antes de que se realice un commit, esos cambios se traducirán en sentencias SQL y se enviarán a la base de datos.</p>
</div>
<div class="paragraph">
<p>Si la transacción hace un rollback pasarán entonces dos cosas. Lo primero es que la transacción en la base de datos será deshecha. Lo siguiente que sucederá será que el contexto de persistencia se limpiará (<em>clear</em>), desconectando todas las entidades que se gestionaban. Tendremos entonces un montón de entidades desconectadas de la base de datos con un estado no sincronizado con la base de datos.</p>
</div>
<div class="paragraph">
<p>Un ejemplo del código anterior es el siguiente programa, en el que se suma 1000.0 al sueldo de un empleado. Se pide una entrada de texto para provocar una excepción y deshacer la transacción:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">SubeSueldo</span> <span class="tok-o">{</span>

    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">Log</span> <span class="tok-n">logger</span> <span class="tok-o">=</span> <span class="tok-n">LogFactory</span><span class="tok-o">.</span><span class="tok-na">getLog</span><span class="tok-o">(</span><span class="tok-n">SubeSueldo</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>

    <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-kt">void</span> <span class="tok-nf">main</span><span class="tok-o">(</span><span class="tok-n">String</span><span class="tok-o">[]</span> <span class="tok-n">args</span><span class="tok-o">)</span> <span class="tok-o">{</span>

        <span class="tok-n">EntityManagerFactory</span> <span class="tok-n">emf</span> <span class="tok-o">=</span> <span class="tok-n">Persistence</span>
                <span class="tok-o">.</span><span class="tok-na">createEntityManagerFactory</span><span class="tok-o">(</span><span class="tok-s">&quot;empleados-mysql&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">EntityTransaction</span> <span class="tok-n">tx</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">();</span>
        <span class="tok-n">EmpleadoDao</span> <span class="tok-n">empleadoDao</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">EmpleadoDao</span><span class="tok-o">(</span><span class="tok-n">em</span><span class="tok-o">);</span>

        <span class="tok-k">try</span> <span class="tok-o">{</span>
            <span class="tok-n">tx</span><span class="tok-o">.</span><span class="tok-na">begin</span><span class="tok-o">();</span>
            <span class="tok-n">Empleado</span> <span class="tok-n">emp1</span> <span class="tok-o">=</span> <span class="tok-n">empleadoDao</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-mi">1L</span><span class="tok-o">);</span>
            <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;Sueldo antiguo: &quot;</span> <span class="tok-o">+</span> <span class="tok-n">emp1</span><span class="tok-o">.</span><span class="tok-na">getSueldo</span><span class="tok-o">());</span>
            <span class="tok-n">emp1</span><span class="tok-o">.</span><span class="tok-na">setSueldo</span><span class="tok-o">(</span><span class="tok-n">emp1</span><span class="tok-o">.</span><span class="tok-na">getSueldo</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-mf">1000.0</span><span class="tok-o">);</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">flush</span><span class="tok-o">();</span>
            <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;Sueldo nuevo: &quot;</span> <span class="tok-o">+</span> <span class="tok-n">emp1</span><span class="tok-o">.</span><span class="tok-na">getSueldo</span><span class="tok-o">());</span>
            <span class="tok-n">String</span> <span class="tok-n">excepcion</span> <span class="tok-o">=</span> <span class="tok-n">leerTexto</span><span class="tok-o">(</span><span class="tok-s">&quot;¿Proovocamos excepción? (s/n)&quot;</span><span class="tok-o">);</span>
            <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">excepcion</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-s">&quot;s&quot;</span><span class="tok-o">))</span> <span class="tok-o">{</span>
                <span class="tok-k">throw</span> <span class="tok-k">new</span> <span class="tok-nf">RuntimeException</span><span class="tok-o">(</span><span class="tok-s">&quot;Runtime exception&quot;</span><span class="tok-o">);</span>
            <span class="tok-o">}</span>
            <span class="tok-n">tx</span><span class="tok-o">.</span><span class="tok-na">commit</span><span class="tok-o">();</span>
        <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">RuntimeException</span> <span class="tok-n">ex</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-k">try</span> <span class="tok-o">{</span>
                <span class="tok-n">tx</span><span class="tok-o">.</span><span class="tok-na">rollback</span><span class="tok-o">();</span>
                <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-na">error</span><span class="tok-o">(</span><span class="tok-s">&quot;Transacción deshecha&quot;</span><span class="tok-o">,</span> <span class="tok-n">ex</span><span class="tok-o">);</span>
            <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">RuntimeException</span> <span class="tok-n">rbEx</span><span class="tok-o">)</span> <span class="tok-o">{</span>
                <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-na">error</span><span class="tok-o">(</span><span class="tok-s">&quot;No se ha podido deshacer la transacción&quot;</span><span class="tok-o">,</span> <span class="tok-n">rbEx</span><span class="tok-o">);</span>
            <span class="tok-o">}</span>
            <span class="tok-k">throw</span> <span class="tok-n">ex</span><span class="tok-o">;</span>
        <span class="tok-o">}</span> <span class="tok-k">finally</span> <span class="tok-o">{</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
            <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">static</span> <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-nf">leerTexto</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">mensaje</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">String</span> <span class="tok-n">texto</span><span class="tok-o">;</span>
        <span class="tok-k">try</span> <span class="tok-o">{</span>
            <span class="tok-n">BufferedReader</span> <span class="tok-n">in</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">BufferedReader</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">InputStreamReader</span><span class="tok-o">(</span>
                    <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">in</span><span class="tok-o">));</span>
            <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">print</span><span class="tok-o">(</span><span class="tok-n">mensaje</span><span class="tok-o">);</span>
            <span class="tok-n">texto</span> <span class="tok-o">=</span> <span class="tok-n">in</span><span class="tok-o">.</span><span class="tok-na">readLine</span><span class="tok-o">();</span>
        <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">IOException</span> <span class="tok-n">e</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">texto</span> <span class="tok-o">=</span> <span class="tok-s">&quot;Error&quot;</span><span class="tok-o">;</span>
        <span class="tok-o">}</span>
        <span class="tok-k">return</span> <span class="tok-n">texto</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_transacciones_jta">6.1.2. Transacciones JTA</h4>
<div class="paragraph">
<p>JTA (<em>Java Transaction API</em>) es el estándar propuesto por Java EE para gestionar transacciones distribuidas y transacciones dentro del servidor de aplicaciones. Es posible utilizar JTA en componentes del servidor de aplicaciones (servlets, enterprise beans y clientes enterprise).</p>
</div>
<div class="paragraph">
<p>El API JTA tiene su origen en el protocolo <em>two-phase commit</em> (2PC) para gestionar transacciones distribuidas.</p>
</div>
<div class="paragraph">
<p>La especificación JTA define una arquitectura para la construcción de servidores de aplicaciones transaccionales y define un conjunto de 	interfaces para los componentes de esta arquitectura. Los componentes son los mismos que se define en el protocolo 2PC: la aplicación, los gestores de recursos, el gestor de transacciones y el gestor de comunicaciones. De esta forma se define una arquitectura que posibilita la definición de transacciones distribuidas utilizando el algoritmo.</p>
</div>
<div class="paragraph">
<p>Un requisito fundamental para que un recurso pueda incorporarse a las transacciones JTA es que las conexiones con el recurso sean de tipo <code>XAConnection</code>. Para ello, en el caso de una base de datos JDBC, es necesario un driver JDBC que implemente las interfaces <code>javax.sql.XADataSource</code>, <code>javax.sql.XAConnection</code> y <code>javax.sql.XAResource</code>. Es necesario también configurar
una fuente de datos XA con el servidor de aplicaciones y darle un nombre JNDI.</p>
</div>
<div class="sect4">
<h5 id="_gestión_de_la_transacción">Gestión de la transacción</h5>
<div class="paragraph">
<p>Para gestionar una transacción deberemos en primer lugar obtener del servidor de aplicaciones el objeto <code>javax.transacion.UserTransaction</code>. Este es un recurso CDI que puede inyectarse en cualquier recurso gestionado por el servidor de aplicaciones (servlet, ejb, backing bean):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Resource</span> <span class="tok-n">UserTransaction</span> <span class="tok-n">utx</span><span class="tok-o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Una vez obtenido el objeto <code>UserTransaction</code> podemos usar los métodos de la interfaz para demarcar la transacción:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>public void begin()</code></p>
</li>
<li>
<p><code>public void commit()</code></p>
</li>
<li>
<p><code>public void rollback()</code></p>
</li>
<li>
<p><code>public int getStatus()</code></p>
</li>
<li>
<p><code>public void setRollbackOnly()</code></p>
</li>
<li>
<p><code>public void setTransactionTimeout(int segundos)</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Para comenzar una transacción la aplicación se debe llamar a <code>begin()</code>. Para finalizarla, la transacción debe llamar o bien a <code>commit()</code> o bien a <code>rollback()</code>.</p>
</div>
<div class="paragraph">
<p>El método <code>setRollbackOnly()</code> modifica la transacción actual de forma que el único resultado posible de la misma sea de rollback (falllo).</p>
</div>
<div class="paragraph">
<p>El método <code>setTransactionTimeout(int segundos)</code> permite modificar el timeout asociado con la transacción actual. El parámetro determina la duración del timeout en segundos. Si se le pasa como valor cero, el timeout de la transacción es el definido por defecto.</p>
</div>
<div class="paragraph">
<p>El siguiente ejemplo muestra el uso de JTA en un sencillo servlet que utiliza un Dao para acceder a las entidades. Este es sólo un ejemplo rápido para comprobar el funcionamiento de JTA. La forma final de definir las capas de nuestra aplicación será utilizando componentes EJB para implementar la capa de servicios. Lo veremos en el siguiente módulo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@WebServlet</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;holamundo&quot;</span><span class="tok-o">,</span> <span class="tok-n">urlPatterns</span><span class="tok-o">=</span><span class="tok-s">&quot;/holamundo&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">HolaMundo</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span> <span class="tok-o">{</span>

    <span class="tok-nd">@PersistenceUnit</span><span class="tok-o">(</span><span class="tok-n">unitName</span> <span class="tok-o">=</span> <span class="tok-s">&quot;mensajes&quot;</span><span class="tok-o">)</span>
    <span class="tok-n">EntityManagerFactory</span> <span class="tok-n">emf</span><span class="tok-o">;</span>
    <span class="tok-nd">@Resource</span>
    <span class="tok-n">UserTransaction</span> <span class="tok-n">tx</span><span class="tok-o">;</span>

    <span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span> <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
        <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-k">try</span> <span class="tok-o">{</span>
            <span class="tok-n">tx</span><span class="tok-o">.</span><span class="tok-na">begin</span><span class="tok-o">();</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1">
            <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setContentType</span><span class="tok-o">(</span><span class="tok-s">&quot;text/html&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">PrintWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;!DOCTYPE HTML PUBLIC \&quot;&quot;</span> <span class="tok-o">+</span>
                    <span class="tok-s">&quot;-//W3C//DTD HTML 4.0 &quot;</span> <span class="tok-o">+</span>
                    <span class="tok-s">&quot;Transitional//EN\&quot;&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;HTML&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;BODY&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;h1&gt;Lista&lt;/h1&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;ul&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">AutorDao</span> <span class="tok-n">autorDao</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">AutorDao</span><span class="tok-o">(</span><span class="tok-n">em</span><span class="tok-o">);</span>
            <span class="tok-n">Autor</span> <span class="tok-n">autor</span> <span class="tok-o">=</span> <span class="tok-n">autorDao</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-mi">1L</span><span class="tok-o">);</span>
            <span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">setNombre</span><span class="tok-o">(</span><span class="tok-s">&quot;Nuevo Nombre&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Autor</span><span class="tok-o">&gt;</span> <span class="tok-n">lista</span> <span class="tok-o">=</span> <span class="tok-n">autorDao</span><span class="tok-o">.</span><span class="tok-na">listAllAutores</span><span class="tok-o">();</span>
            <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">Autor</span> <span class="tok-nl">a:</span> <span class="tok-n">lista</span><span class="tok-o">)</span> <span class="tok-o">{</span>
                <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;li&gt; &quot;</span> <span class="tok-o">+</span> <span class="tok-n">a</span><span class="tok-o">.</span><span class="tok-na">getNombre</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-s">&quot;&lt;/li&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-o">}</span>
	    <span class="tok-n">tx</span><span class="tok-o">.</span><span class="tok-na">commit</span><span class="tok-o">();</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/2.png" alt="2">
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/ul&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/BODY&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/HTML&quot;</span><span class="tok-o">);</span>
        <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">Exception</span> <span class="tok-n">e</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-k">try</span> <span class="tok-o">{</span>
                <span class="tok-n">tx</span><span class="tok-o">.</span><span class="tok-na">rollback</span><span class="tok-o">();</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/3.png" alt="3">
            <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">javax</span><span class="tok-o">.</span><span class="tok-na">transaction</span><span class="tok-o">.</span><span class="tok-na">SystemException</span> <span class="tok-n">e1</span><span class="tok-o">)</span> <span class="tok-o">{</span>
                <span class="tok-n">e1</span><span class="tok-o">.</span><span class="tok-na">printStackTrace</span><span class="tok-o">();</span>
                <span class="tok-k">throw</span> <span class="tok-k">new</span> <span class="tok-nf">ServletException</span><span class="tok-o">(</span><span class="tok-n">e1</span><span class="tok-o">);</span>
            <span class="tok-o">}</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1"></td>
<td>Comienzo de la transacción</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/2.png" alt="2"></td>
<td>Commit para confirmar los cambios</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/3.png" alt="3"></td>
<td>Si ha habido un error se captura la excepción y se hace un <em>rollback</em></td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_concurrencia_y_niveles_de_aislamiento">6.1.3. Concurrencia y niveles de aislamiento</h4>
<div class="paragraph">
<p>La gestión de la concurrencia en transacciones es un problema complejo. Por ejemplo, supongamos un sistema de reservas de vuelos. Sería fatal que se vendiera el mismo asiento de un vuelo a dos personas distintas por el hecho de que se han realizado dos accesos concurrentes al siguiente método:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">reservaAsiento</span><span class="tok-o">(</span><span class="tok-n">Pasajero</span> <span class="tok-n">pasajero</span><span class="tok-o">,</span> <span class="tok-kt">int</span> <span class="tok-n">numAsiento</span><span class="tok-o">,</span> <span class="tok-kt">long</span> <span class="tok-n">numVuelo</span><span class="tok-o">)</span> <span class="tok-o">{</span>
   <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
   <span class="tok-n">AsientoKey</span> <span class="tok-n">key</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">AsientoKey</span><span class="tok-o">(</span><span class="tok-n">numAsiento</span><span class="tok-o">,</span> <span class="tok-n">numVuelo</span><span class="tok-o">);</span>
   <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">begin</span><span class="tok-o">();</span>
   <span class="tok-n">Asiento</span> <span class="tok-n">asiento</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Asiento</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-n">key</span><span class="tok-o">);</span>
   <span class="tok-k">if</span> <span class="tok-o">(!</span> <span class="tok-n">asiento</span><span class="tok-o">.</span><span class="tok-na">getOcupado</span><span class="tok-o">())</span> <span class="tok-o">{</span>
      <span class="tok-n">asiento</span><span class="tok-o">.</span><span class="tok-na">setOcupado</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">);</span>
      <span class="tok-n">asiento</span><span class="tok-o">.</span><span class="tok-na">setPasajero</span><span class="tok-o">(</span><span class="tok-n">pasajero</span><span class="tok-o">);</span>
      <span class="tok-n">pasajero</span><span class="tok-o">.</span><span class="tok-na">setAsiento</span><span class="tok-o">(</span><span class="tok-n">asiento</span><span class="tok-o">);</span>
   <span class="tok-o">}</span>
   <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">();</span>
   <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si no se controlara el acceso concurrente de las transacciones a la tabla de asientos, podría suceder que dos transacciones concurrentes accedieran al estado del asiento a la misma vez (antes de haberse realizado el UPDATE de su atributo <code>ocupado</code>), lo vieran libre y se lo asignaran a un pasajero y después a otro. Uno de los pasajeros se quedaría sin billete.</p>
</div>
<div class="paragraph">
<p>Se han propuesto múltiples soluciones para resolver el acceso concurrente a los datos. El estándar SQL define los llamados <em>niveles de aislamiento</em> (isolation levels) que tratan este problema. Los niveles más bajos solucionan los problemas más comunes y permiten al mismo tiempo que la aplicación responda sin generar bloqueos. El nivel más alto alto garantiza que todas las transacciones son serilizables, pero obliga a que se definan un número excesivo de bloqueos.</p>
</div>
</div>
<div class="sect3">
<h4 id="_gestión_concurrencia_con_jpa">6.1.4. Gestión concurrencia con JPA</h4>
<div class="paragraph">
<p>Existe concurrencia cuando múltiples aplicaciones acceden al mismo tiempo a las mismas entidades. La gestión de la concurrencia asegura que la integridad subyacente de la base de datos se preserva a pesar del acceso concurrente.</p>
</div>
<div class="paragraph">
<p>Una configuración habitual a la hora de trabajar con transacciones es mantener bloqueos de lectura de corta duración y bloqueos de escritura de larga duración. Debido a esto la mayoría de los proveedores de persistencia retrasan la escritura en la base de datos hasta el final de la transacción, excepto cuando se llama explícitamente a <code>flush</code> o se realiza una query.</p>
</div>
<div class="paragraph">
<p>Por defecto, los proveedores de persistencia utilizan un bloqueo optimista en el que, antes de realizar un commit que modifique los datos, se comprueba que ninguna otra transacción ha modificado o borrado el dato desde que fue leído. Esto se consigue definiendo una columna <code>versión</code> en la tabla de la base de datos, con su correspondiente atributo en la entidad. Cuando una fila se modifica, el valor de versión se incrementa. La transacción original comprueba si la versión ha sido modificada por otra transacción y si es así se lanza una excepción <code>javax.persistence.OptimisticLockException</code> y la transacción se deshace.</p>
</div>
<div class="paragraph">
<p>El bloqueo pesimista va más allá que el optimista. El proveedor de persistencia crea una transacción que obtiene un bloqueo de larga duración sobre los datos hasta que la transacción se completa. Este bloque previene a otras transacciones de modificar o borrar los datos hasta que el bloque termina. El bloque pesimista es una estrategia mejor que el optimista cuando los datos se acceden frecuentemente y son modificados simultáneamente por múltiples transacciones. Sin embargo, el uso de bloqueos pesimistas en entidades a las que no se accede frecuentemente puede causar una caída en el rendimiento de la aplicación.</p>
</div>
<div class="sect4">
<h5 id="_control_optimista_de_la_concurrencia">Control optimista de la concurrencia</h5>
<div class="paragraph">
<p>El control optimista supone que todo irá bien y que van a existir pocos conflictos en la modificación de datos. El control optimista de la concurrencia lanza un error sólo al final de una unidad de trabajo, cuando se escriben los datos.</p>
</div>
<div class="paragraph">
<p>Para que JPA pueda trabajar con versiones es necesario que los objetos tengan un atributo marcado con la anotación <code>@Version</code>. Este atributo puede ser del tipo <code>int</code>, <code>Integer</code>, <code>short</code>, <code>Short</code>, <code>long</code>, <code>Long</code> y <code>java.sql.Timestamp</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Autor</span> <span class="tok-o">{</span>
   <span class="tok-nd">@Id</span>
   <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
   <span class="tok-nd">@Version</span>
   <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">version</span><span class="tok-o">;</span>
   <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">correo</span><span class="tok-o">;</span>
   <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Aunque el estándar no lo permite, en Hibernate es posible definir un comportamiento optimista en entidades que no definen una columna de versión. Para ello basta con definir la entidad de la siguiente forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-nd">@org.hibernate.annotations.Entity</span> <span class="tok-o">(</span>
   <span class="tok-n">optimisticLock</span> <span class="tok-o">=</span> <span class="tok-n">OptimisticLockType</span><span class="tok-o">.</span><span class="tok-na">ALL</span><span class="tok-o">,</span>
   <span class="tok-n">dynamicUpdate</span> <span class="tok-o">=</span> <span class="tok-kc">true</span>
<span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Autor</span> <span class="tok-o">{</span>
   <span class="tok-nd">@Id</span>
   <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
   <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">correo</span><span class="tok-o">;</span>
   <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_modos_de_bloqueo">Modos de bloqueo</h5>
<div class="paragraph">
<p>En la última versión de JPA es posible especificar el modo de bloqueo aplicado a una entidad usando una llamada al método <code>lock</code> o al método <code>find</code> del <em>entity manager</em>. Por ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-o">...;</span>
<span class="tok-n">Person</span> <span class="tok-n">person</span> <span class="tok-o">=</span> <span class="tok-o">...;</span>
<span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">lock</span><span class="tok-o">(</span><span class="tok-n">person</span><span class="tok-o">,</span> <span class="tok-n">LockModeType</span><span class="tok-o">.</span><span class="tok-na">OPTIMISTIC</span><span class="tok-o">);</span>
<span class="tok-n">String</span> <span class="tok-n">personPK</span> <span class="tok-o">=</span> <span class="tok-o">...;</span>
<span class="tok-n">Person</span> <span class="tok-n">person</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Person</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-n">personPK</span><span class="tok-o">,</span>
    <span class="tok-n">LockModeType</span><span class="tok-o">.</span><span class="tok-na">PESSIMISTIC_WRITE</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El tipo de bloqueo puede ser uno de los siguientes:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Tipo de bloque</th>
<th class="tableblock halign-left valign-top">Descripción</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OPTIMISTIC</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Obtiene un bloqueo de lectura optimista en la entidad si tiene un atributo de versión</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OPTIMISTIC_FORCE_INCREMENT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Obtiene un bloqueo de lectura optimista en la entidad si tiene un atributo de versión e incrementa el valor de versión del atributo</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PESSIMISTIC_READ</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Obtiene un bloqueo de lectura de larga duración sobre un dato para prevenir que sea borrado o modificado. Otras transacciones pueden leer los datos mientras que se mantiene el bloque, pero no pueden modificarlo o borrarlo.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PESSIMISTIC_WRITE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Obtiene un bloque de escritura de larga duración sobre un dato para prevenir que sea leído, modificado o borrado.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PESSIMISTIC_FORCE_INCREMENT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Obtiene un bloqueo e incrementa el atributo de versión</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>READ</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sinónimo de <code>OPTIMISTIC</code>. Es preferible utilizar este último.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>WRITE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sinónimo de <code>OPTIMISTIC_FORCE_INCREMENT</code>. Es preferible usar este último.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NONE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No se realiza ningún bloqueo sobre los datos.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Por ejemplo, si se quisiera evitar el problema del asiento del vuelo bloqueando explícitamente el registro, podríamos escribir el siguiente código:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">reservaAsiento</span><span class="tok-o">(</span><span class="tok-n">Pasajero</span> <span class="tok-n">pasajero</span><span class="tok-o">,</span> <span class="tok-kt">int</span> <span class="tok-n">numAsiento</span><span class="tok-o">,</span> <span class="tok-kt">long</span> <span class="tok-n">numVuelo</span><span class="tok-o">)</span> <span class="tok-o">{</span>
   <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
   <span class="tok-n">AsientoKey</span> <span class="tok-n">key</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">AsientoKey</span><span class="tok-o">(</span><span class="tok-n">numAsiento</span><span class="tok-o">,</span> <span class="tok-n">numVuelo</span><span class="tok-o">);</span>
   <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">begin</span><span class="tok-o">();</span>
   <span class="tok-n">Asiento</span> <span class="tok-n">asiento</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Asiento</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-n">key</span><span class="tok-o">);</span>
   <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">lock</span><span class="tok-o">(</span><span class="tok-n">asiento</span><span class="tok-o">,</span><span class="tok-n">LockType</span><span class="tok-o">.</span><span class="tok-na">READ</span><span class="tok-o">);</span>
   <span class="tok-k">if</span> <span class="tok-o">(!</span> <span class="tok-n">asiento</span><span class="tok-o">.</span><span class="tok-na">getOcupado</span><span class="tok-o">())</span> <span class="tok-o">{</span>
      <span class="tok-n">asiento</span><span class="tok-o">.</span><span class="tok-na">setOcupado</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">);</span>
      <span class="tok-n">asiento</span><span class="tok-o">.</span><span class="tok-na">setPasajero</span><span class="tok-o">(</span><span class="tok-n">pasajero</span><span class="tok-o">);</span>
      <span class="tok-n">pasajero</span><span class="tok-o">.</span><span class="tok-na">setAsiento</span><span class="tok-o">(</span><span class="tok-n">asiento</span><span class="tok-o">);</span>
   <span class="tok-o">}</span>
   <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">();</span>
   <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Un problema del estándar JPA es que el funcionamiento correcto de estos bloqueos es dependiente del proveedor de persistencia y del <em>nivel de aislamiento</em> definido en la conexión de la base de datos. El nivel de aislamiento se puede configurar en JPA en la unidad de persistencia, en el fichero <code>persistence.xml</code> y es dependiente del proveedor de persistencia. En el caso de Hibernate, se define con la propiedad <code>hibernate.connection.isolation</code>, que puede tener los siguientes valores. El valor por defecto de MySQL es 4.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Valor</th>
<th class="tableblock halign-left valign-top">Descripción</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRANSACTION_READ_UNCOMMITTED</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRANSACTION_READ_COMMITTED</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRANSACTION_REPEATABLE_READ</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRANSACTION_SERIALIZABLE</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_jpa_en_aplicaciones_java_ee">6.2. JPA en aplicaciones Java EE</h3>
<div class="paragraph">
<p>En las sesiones anteriores hemos descrito el funcionamiento de JPA <em>gestionado por la aplicación</em>. En este modo las clases de la aplicación se encargan de obtener el entity manager y de gestionar las transacciones. La forma de obtener el entity manager es llamando explícitamente al método <code>createEntityManager()</code> de la unidad de persistencia. Después hay que comprobar en los DAO si las transacciones están correctamente abiertas y controlar con cuidado su rollback.</p>
</div>
<div class="paragraph">
<p>Además, la unidad de persistencia debe configurarse en la propia aplicación, describiendo sus características en el fichero <code>persistence.xml</code></p>
</div>
<div class="sect3">
<h4 id="_jpa_gestionado_por_el_contenedor">6.2.1. JPA gestionado por el contenedor</h4>
<div class="paragraph">
<p>A diferencia de las aplicaciones <em>standalone</em> Java SE, en las aplicaciones web el código de la aplicación (servlets, páginas JSP, clases Java, etc.) se ejecuta dentro de un contenedor. Es el contenedor quien llama al servlet, o a las clases Java cuando lo determina el ciclo de vida de la aplicación.</p>
</div>
<div class="paragraph">
<p>Lo mismo sucede con los recursos. El contenedor se encarga de comunicarse y gestionar los recursos externos, no la aplicación. Le da nombre a esos recursos y la aplicación los utiliza. En el caso de una conexión con la base de datos, se debe definir en el contenedor una <em>fuente de datos</em> y darle un nombre. El contenedor será el responsable de gestionar las peticiones a la fuente de datos. Por ejemplo, construirá un pool de conexiones que hará mucho más eficiente la conexión.</p>
</div>
<div class="paragraph">
<p>También habrá diferencia con la gestión de transacciones. Se trabajará con transacciones JTA gestionadas por el servidor de aplicaciones, no por la propia base de datos. Debido a esto ya no crearemos la transacciones a partir del <em>entity manager</em>, sino que utilizaremos objetos <code>UserTransaction</code> inyectados por el servidor de aplicaciones. Además en los DAO ya no comprobaremos si estamos dentro de una transacción porque el método del <em>entity manager</em> sólo funciona cuando se trata de transacciones locales no JTA.</p>
</div>
</div>
<div class="sect3">
<h4 id="_configuración_de_la_fuente_de_datos_mysql_en_wildfly">6.2.2. Configuración de la fuente de datos MySQL en WildFly</h4>
<div class="paragraph">
<p>Cuando estamos trabajando con JPA en una aplicación web el acceso a la base de datos hay que hacerlo a través de una <strong>fuente de datos</strong> creada y gestionada por el servidor de aplicaciones.</p>
</div>
<div class="paragraph">
<p>Vamos a ver cómo configurar una fuente de datos MySQL en WildFly.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>En primer lugar localiza el driver MySQL <code>mysql-connector-java-5.1.33.jar</code> (lo puedes encontrar en el repositorio local de Maven <code>.m2/repository/mysql/mysql-connector-java/5.1.33/</code> y copialo a alguna carpeta que no esté oculta:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell">$ cp /home/expertojava/.m2/repository/mysql/mysql-connector-java/5.1.33/mysql-connector-java-5.1.33.jar $HOME/Escritorio</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Conéctate a la consola de administración de WildFly y selecciona la opción <em>Deployments &gt; Add</em></p>
</li>
</ol>
</div>
<div class="paragraph">
<p><em>Runtime &gt; Manage Deployments &gt; Add</em> y añade el JAR. Ponle como nombre <em>mysql_connector</em> (no es importante) y activa la opción <em>Enable</em></p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa06/datasource01.png" alt="" width="50%">
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>En <em>Configuration &gt; Connector &gt; Datasources</em> pulsa en la pestaña <em>XA DATASOURCES</em> para crear una nueva fuente de datos de tipo XA. Pulsa el botón <em>Add</em> e introduce los siguientes nombres:</p>
<div class="ulist">
<ul>
<li>
<p><em>Name</em>: <code>MensajesDS</code></p>
</li>
<li>
<p><em>JNDI Name</em>: <code>java:/datasources/MensajesDS</code></p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa06/datasource02.png" alt="" width="50%">
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Selecciona el driver que acabamos de añadir y escribe como nombre de clase XA DataSource: <code>com.mysql.jdbc.jdbc2.optional.MysqlXADataSource</code>:</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa06/datasource03.png" alt="" width="50%">
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Añade la propiedad <code>URL</code> y el valor <code>jdbc:mysql://localhost:3306/jpa_mensajes</code></p>
</li>
<li>
<p>Y en la última pantalla define el usuario y la contraseña de la conexión</p>
<div class="ulist">
<ul>
<li>
<p><em>Username</em>: <code>root</code></p>
</li>
<li>
<p><em>Password</em>: <code>expertojava</code></p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Y prueba la conexión pulsando el botón.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Por último activamos la fuente de datos:</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa06/datasource04.png" alt="" width="66%">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_dependencias_maven_en_el_code_pom_xml_code">6.2.3. Dependencias Maven en el <code>pom.xml</code></h4>
<div class="paragraph">
<p>Todas las librerías necesarias para implementar JPA ya las tiene el servidor de aplicaciones. La única dependencia necesaria para evitar los errores de compilación es la siguiente, que incluye todas las librerías de Java EE:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;groupId&gt;</span>javax<span class="tok-nt">&lt;/groupId&gt;</span>
   <span class="tok-nt">&lt;artifactId&gt;</span>javaee-web-api<span class="tok-nt">&lt;/artifactId&gt;</span>
   <span class="tok-nt">&lt;version&gt;</span>7.0<span class="tok-nt">&lt;/version&gt;</span>
   <span class="tok-nt">&lt;scope&gt;</span>provided<span class="tok-nt">&lt;/scope&gt;</span>
<span class="tok-nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Sí que necesitamos las librerías de implementación de JPA para ejecutar los tests, por lo que podemos cambiar su <code>scope</code> a <code>test</code>. El POM completo es el siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tok-nt">&lt;project</span> <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="tok-na">xmlns:xsi=</span><span class="tok-s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="tok-na">xsi:schemaLocation=</span><span class="tok-s">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;modelVersion&gt;</span>4.0.0<span class="tok-nt">&lt;/modelVersion&gt;</span>

    <span class="tok-nt">&lt;groupId&gt;</span>org.expertojava.jpa<span class="tok-nt">&lt;/groupId&gt;</span>
    <span class="tok-nt">&lt;artifactId&gt;</span>mensajes-web<span class="tok-nt">&lt;/artifactId&gt;</span>
    <span class="tok-nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="tok-nt">&lt;/version&gt;</span>
    <span class="tok-nt">&lt;packaging&gt;</span>war<span class="tok-nt">&lt;/packaging&gt;</span>

    <span class="tok-nt">&lt;name&gt;</span>mensajes-web<span class="tok-nt">&lt;/name&gt;</span>

    <span class="tok-nt">&lt;properties&gt;</span>
        <span class="tok-nt">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span class="tok-nt">&lt;/project.build.sourceEncoding&gt;</span>
    <span class="tok-nt">&lt;/properties&gt;</span>

    <span class="tok-nt">&lt;dependencies&gt;</span>
        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>javax<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>javaee-web-api<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>7.0<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>provided<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-c">&lt;!-- Test --&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.dbunit<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>dbunit<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>2.5.0<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>mysql<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>5.1.33<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.hibernate.javax.persistence<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>hibernate-jpa-2.1-api<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>1.0.0.Final<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.hibernate<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>hibernate-entitymanager<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>4.3.7.Final<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.slf4j<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>slf4j-api<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>1.7.7<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-c">&lt;!-- Hibernate validator --&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.hibernate<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>hibernate-validator<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>5.1.3.Final<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>javax.el<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>javax.el-api<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>2.2.4<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.glassfish.web<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>el-impl<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>2.2<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

    <span class="tok-nt">&lt;/dependencies&gt;</span>

    <span class="tok-nt">&lt;build&gt;</span>
        <span class="tok-nt">&lt;finalName&gt;</span>${project.name}<span class="tok-nt">&lt;/finalName&gt;</span>
        <span class="tok-nt">&lt;plugins&gt;</span>
            <span class="tok-nt">&lt;plugin&gt;</span>
                <span class="tok-nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="tok-nt">&lt;/groupId&gt;</span>
                <span class="tok-nt">&lt;artifactId&gt;</span>maven-compiler-plugin<span class="tok-nt">&lt;/artifactId&gt;</span>
                <span class="tok-nt">&lt;version&gt;</span>3.1<span class="tok-nt">&lt;/version&gt;</span>
                <span class="tok-nt">&lt;configuration&gt;</span>
                    <span class="tok-nt">&lt;source&gt;</span>1.7<span class="tok-nt">&lt;/source&gt;</span>
                    <span class="tok-nt">&lt;target&gt;</span>1.7<span class="tok-nt">&lt;/target&gt;</span>
                <span class="tok-nt">&lt;/configuration&gt;</span>
            <span class="tok-nt">&lt;/plugin&gt;</span>
            <span class="tok-nt">&lt;plugin&gt;</span>
                <span class="tok-nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="tok-nt">&lt;/groupId&gt;</span>
                <span class="tok-nt">&lt;artifactId&gt;</span>maven-war-plugin<span class="tok-nt">&lt;/artifactId&gt;</span>
                <span class="tok-nt">&lt;version&gt;</span>2.3<span class="tok-nt">&lt;/version&gt;</span>
                <span class="tok-nt">&lt;configuration&gt;</span>
                    <span class="tok-nt">&lt;failOnMissingWebXml&gt;</span>false<span class="tok-nt">&lt;/failOnMissingWebXml&gt;</span>
                <span class="tok-nt">&lt;/configuration&gt;</span>
            <span class="tok-nt">&lt;/plugin&gt;</span>
            <span class="tok-nt">&lt;plugin&gt;</span>
                <span class="tok-nt">&lt;groupId&gt;</span>org.wildfly.plugins<span class="tok-nt">&lt;/groupId&gt;</span>
                <span class="tok-nt">&lt;artifactId&gt;</span>wildfly-maven-plugin<span class="tok-nt">&lt;/artifactId&gt;</span>
                <span class="tok-nt">&lt;version&gt;</span>1.0.2.Final<span class="tok-nt">&lt;/version&gt;</span>
                <span class="tok-nt">&lt;configuration&gt;</span>
                    <span class="tok-nt">&lt;hostname&gt;</span>localhost<span class="tok-nt">&lt;/hostname&gt;</span>
                    <span class="tok-nt">&lt;port&gt;</span>9990<span class="tok-nt">&lt;/port&gt;</span>
                <span class="tok-nt">&lt;/configuration&gt;</span>
            <span class="tok-nt">&lt;/plugin&gt;</span>
        <span class="tok-nt">&lt;/plugins&gt;</span>
    <span class="tok-nt">&lt;/build&gt;</span>
<span class="tok-nt">&lt;/project&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_persistence_xml">6.2.4. Persistence.xml</h4>
<div class="paragraph">
<p>Una vez creada la fuente de datos y configurado su nombre JNDI basta con referenciarlo en el fichero <code>META-INF/persistence.xml</code> (dentro del directorio <code>resources</code>)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tok-nt">&lt;persistence</span> <span class="tok-na">version=</span><span class="tok-s">&quot;2.0&quot;</span>
   <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://java.sun.com/xml/ns/persistence&quot;</span> <span class="tok-na">xmlns:xsi=</span><span class="tok-s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
   <span class="tok-na">xsi:schemaLocation=</span><span class="tok-s">&quot;</span>
<span class="tok-s">        http://java.sun.com/xml/ns/persistence</span>
<span class="tok-s">        http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd&quot;</span><span class="tok-nt">&gt;</span>
   <span class="tok-nt">&lt;persistence-unit</span> <span class="tok-na">name=</span><span class="tok-s">&quot;mensajes&quot;</span><span class="tok-nt">&gt;</span>
      <span class="tok-nt">&lt;jta-data-source&gt;</span>java:/datasources/MensajesDS<span class="tok-nt">&lt;/jta-data-source&gt;</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1">
      <span class="tok-nt">&lt;properties&gt;</span>
         <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.dialect&quot;</span>
                   <span class="tok-na">value=</span><span class="tok-s">&quot;org.hibernate.dialect.MySQLDialect&quot;</span><span class="tok-nt">/&gt;</span>
          <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.id.new_generator_mappings&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;false&quot;</span><span class="tok-nt">/&gt;</span> <img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/2.png" alt="2">
          <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.hbm2ddl.auto&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;update&quot;</span> <span class="tok-nt">/&gt;</span>
         <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.show_sql&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;true&quot;</span> <span class="tok-nt">/&gt;</span>
      <span class="tok-nt">&lt;/properties&gt;</span>
   <span class="tok-nt">&lt;/persistence-unit&gt;</span>
<span class="tok-nt">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/1.png" alt="1"></td>
<td>Nombre de la fuente de datos</td>
</tr>
<tr>
<td><img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/callouts/2.png" alt="2"></td>
<td>Necesario para que la generación automática de claves primarias funcione sin crear una tabla adicional. Si no se define esta propiedad, Hibernate crea una nueva tabla llamda <code>sequence_generator</code> donde guarda la secuencia de claves primarias.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_inyección_de_entity_managers_y_recursos_gestionados_por_el_contenedor">6.2.5. Inyección de entity managers y recursos gestionados por el contenedor</h4>
<div class="paragraph">
<p>La forma de obtener entity managers también cambia, ya que la aplicación no puede crear explícitamente contextos de persistencia sino
que es el contenedor el que se encarga de gestionarlos y proporcionarlos a los objetos de la aplicación. Esta forma de
trabajar con JPA se llama <em>persistencia gestionada por el contenedor</em>.</p>
</div>
<div class="paragraph">
<p>La forma más sencilla de obtener los recursos es utilizando la inyección de dependencias. El contenedor se encarga de
crear el recurso y de configurarlo según se haya indicado en el fichero de configuración del servidor de aplicaciones.
Una vez listo, lo inyecta en la variable que hayamos definido como <em>punto de inyección</em> utilizando la anotación propia del recurso. Por ejemplo, para usar un entity manager, basta con declararlo y anotarlo de forma apropiada:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@PersistenceContext</span><span class="tok-o">(</span><span class="tok-n">unitName</span><span class="tok-o">=</span><span class="tok-s">&quot;mensajes&quot;</span><span class="tok-o">)</span>
<span class="tok-n">EntityManager</span> <span class="tok-n">em</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La especificación CDI define los siguientes tipos de recursos que pueden inyectarse en componentes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Fuentes de datos JDBC, colas JMS, tópicos y factorías de conexiones (<em>ConenectionFactorys</em>), sesiones JavaMail y otros recursos transaccionales que incluyen conectores JCA</p>
</li>
<li>
<p>Entity managers (<em>EntityManagers</em>) y factorías de entity managers (<em>EntityManagerFactorys</em>) JPA</p>
</li>
<li>
<p>Componentes EJB locales y remotos</p>
</li>
<li>
<p>Servicios web RESTful</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Recordemos que en JPA se definen dos tipos de recursos, entity managers y factorías de entity managers. Se definen las anotaciones
<code>@PersistenceContext</code> y <code>@PersistenceUnit</code> para inyectar estos recursos.</p>
</div>
<div class="paragraph">
<p>La anotación <code>@PersistenceContext</code> puede tener los siguientes elementos adicionales:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>unitName</code>: el nombre de la unidad de persistencia (definido en el fichero de configuración <code>persistence.xml</code>)</p>
</li>
<li>
<p><code>type</code>: tipo de contexto de persistencia: <code>PersistenceContextType.TRANSACTION</code> (valor por defecto) o <code>PersistenceContextType.EXTENDED</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>El tipo de contexto de persistencia (<code>TRANSACTION</code> o <code>EXTENDED</code>) define el ámbito (<em>scope</em>) del entity manager, la extensión de su ciclo de vida. En JPA gestionado por el contenedor el programador no tiene que llamar explícitamente al método <code>close()</code> para cerrar el entity manager. Se encarga de ello el contenedor dependiendo del alcance definido.</p>
</div>
<div class="paragraph">
<p>Si el ámbito es tipo <code>TRANSACTION</code>, el entity manager tiene la misma vida que la transacción. Cuando comienza una
transacción se crea y se cierra cuando la transacción termina. Al final de la transacción las entidades quedan desconectadas.</p>
</div>
<div class="paragraph">
<p>El ámbito de tipo <code>EXTENDED</code> se utiliza en beans de sesión con estado, que extienden su vida a lo largo de múltiples
transacciones. En este caso las entidades continúan gestionadas una vez ha terminado la transacción. Lo veremos con más detalle en el módulo de EJB.</p>
</div>
<div class="paragraph">
<p>Además, JPA define desde la especificación 2.1 la anotación <code>@Transactional</code> con la que podemos anotar métodos o nombres de clases.</p>
</div>
<div class="paragraph">
<p>Utilizando CDIs podemos además inyectar los DAOs y la clase de servicios, quedando un código muy limpio. El servidor de aplicaciones se encarga de instanciar los DAOs e inyectarles el <em>entity manager</em> correcto.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<img src="http://expertojava.ua.es/experto/restringido/2015-16/jpa/images/icons/caution.png" alt="Caution">
</td>
<td class="content">
Recuerda que para trabajar con CDIs tienes que crear el fichero <code>beans.xml</code> en <code>webapp/WEB-INF/beans.xml</code>. Puedes hacerlo pulsando el botón derecho sobre la carpeta <code>WEB-INF</code> y seleccionando <em>New &gt; XML Configuration file &gt; beans.xml</em>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Copiamos a continuación todo el código del ejemplo <code>mensajes-web</code> que puedes encontrar en el repositorio <code>ejemplos-jpa</code>, dentro del directorio <code>mensajes-web</code>.</p>
</div>
<div class="sect4">
<h5 id="_página_jsp_y_configuración">Página JSP y configuración</h5>
<div class="listingblock">
<div class="title">src/main/webapp/index.jsp</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="jsp"><span class="tok-cp">&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.0 Transitional//EN&quot;&gt;</span>
<span class="tok-nt">&lt;html&gt;</span>
    <span class="tok-nt">&lt;head&gt;</span>
        <span class="tok-nt">&lt;title&gt;</span>Start Page<span class="tok-nt">&lt;/title&gt;</span>
        <span class="tok-nt">&lt;meta</span> <span class="tok-na">http-equiv=</span><span class="tok-s">&quot;Content-Type&quot;</span> <span class="tok-na">content=</span><span class="tok-s">&quot;text/html; charset=UTF-8&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;/head&gt;</span>
    <span class="tok-nt">&lt;body&gt;</span>
        <span class="tok-nt">&lt;h1&gt;</span>Hello World!<span class="tok-nt">&lt;/h1&gt;</span>
        <span class="tok-nt">&lt;h2&gt;</span>Nuevo mensaje<span class="tok-nt">&lt;/h2&gt;</span>
        <span class="tok-nt">&lt;form</span> <span class="tok-na">action=</span><span class="tok-s">&quot;</span><span class="tok-k">&lt;%=</span><span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getContextPath</span><span class="tok-o">()</span><span class="tok-k">%&gt;</span><span class="tok-s">/nuevoAutorMensaje&quot;</span><span class="tok-nt">&gt;</span>
        <span class="tok-nt">&lt;p&gt;</span>Introduce tu login: <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;login&quot;</span><span class="tok-nt">&gt;&lt;br/&gt;</span>
        Introduce tu mensaje: <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;mensaje&quot;</span><span class="tok-nt">&gt;&lt;/p&gt;</span>
        <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;submit&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;Enviar&quot;</span><span class="tok-nt">&gt;</span>
        <span class="tok-nt">&lt;/form&gt;</span>
    <span class="tok-nt">&lt;h2&gt;</span>Acciones<span class="tok-nt">&lt;/h2&gt;</span>
    <span class="tok-nt">&lt;ul&gt;</span>
        <span class="tok-nt">&lt;li&gt;&lt;a</span> <span class="tok-na">href=</span><span class="tok-s">&quot;</span><span class="tok-k">&lt;%=</span><span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getContextPath</span><span class="tok-o">()</span><span class="tok-k">%&gt;</span><span class="tok-s">/listaAutores&quot;</span><span class="tok-nt">&gt;</span>Listar autores<span class="tok-nt">&lt;/a&gt;&lt;/li&gt;</span>
    <span class="tok-nt">&lt;/ul&gt;</span>
    <span class="tok-nt">&lt;/body&gt;</span>
<span class="tok-nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/WEB-INF/beans.xml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tok-nt">&lt;beans</span>
        <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span>
        <span class="tok-na">xmlns:xsi=</span><span class="tok-s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
        <span class="tok-na">xsi:schemaLocation=</span><span class="tok-s">&quot;http://xmlns.jcp.org/xml/ns/javaee</span>
<span class="tok-s">                      http://xmlns.jcp.org/xml/ns/javaee/beans_1_1.xsd&quot;</span>
        <span class="tok-na">bean-discovery-mode=</span><span class="tok-s">&quot;all&quot;</span><span class="tok-nt">&gt;</span>
<span class="tok-nt">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/persistence.xml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tok-nt">&lt;persistence</span> <span class="tok-na">version=</span><span class="tok-s">&quot;2.0&quot;</span>
   <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://java.sun.com/xml/ns/persistence&quot;</span> <span class="tok-na">xmlns:xsi=</span><span class="tok-s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
   <span class="tok-na">xsi:schemaLocation=</span><span class="tok-s">&quot;</span>
<span class="tok-s">        http://java.sun.com/xml/ns/persistence</span>
<span class="tok-s">        http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd&quot;</span><span class="tok-nt">&gt;</span>
   <span class="tok-nt">&lt;persistence-unit</span> <span class="tok-na">name=</span><span class="tok-s">&quot;mensajes&quot;</span><span class="tok-nt">&gt;</span>
      <span class="tok-nt">&lt;jta-data-source&gt;</span>java:/datasources/MensajesDS<span class="tok-nt">&lt;/jta-data-source&gt;</span>
      <span class="tok-nt">&lt;properties&gt;</span>
         <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.dialect&quot;</span>
                   <span class="tok-na">value=</span><span class="tok-s">&quot;org.hibernate.dialect.MySQLDialect&quot;</span><span class="tok-nt">/&gt;</span>
          <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.id.new_generator_mappings&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;false&quot;</span><span class="tok-nt">/&gt;</span>
         <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.hbm2ddl.auto&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;update&quot;</span> <span class="tok-nt">/&gt;</span>
         <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.show_sql&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;true&quot;</span> <span class="tok-nt">/&gt;</span>
      <span class="tok-nt">&lt;/properties&gt;</span>
   <span class="tok-nt">&lt;/persistence-unit&gt;</span>
<span class="tok-nt">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_servlets">Servlets</h5>
<div class="listingblock">
<div class="title">src/main/java/org/expertojava/jpa/mensajes/servlets/ListaAutores.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jpa</span><span class="tok-o">.</span><span class="tok-na">mensajes</span><span class="tok-o">.</span><span class="tok-na">servlets</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jpa.mensajes.modelo.Autor</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jpa.mensajes.servicio.AutorServicio</span><span class="tok-o">;</span>


<span class="tok-kn">import</span> <span class="tok-nn">javax.inject.Inject</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.ServletException</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.annotation.WebServlet</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.http.HttpServlet</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.http.HttpServletRequest</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.http.HttpServletResponse</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.io.IOException</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.io.PrintWriter</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.List</span><span class="tok-o">;</span>

<span class="tok-nd">@WebServlet</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;listaAutores&quot;</span><span class="tok-o">,</span> <span class="tok-n">urlPatterns</span><span class="tok-o">=</span><span class="tok-s">&quot;/listaAutores&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">ListaAutores</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span> <span class="tok-o">{</span>

    <span class="tok-nd">@Inject</span>
    <span class="tok-n">AutorServicio</span> <span class="tok-n">autorServicio</span><span class="tok-o">;</span>

    <span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">doPost</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span> <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span> <span class="tok-kd">throws</span>
            <span class="tok-n">ServletException</span><span class="tok-o">,</span>
            <span class="tok-n">IOException</span> <span class="tok-o">{</span>

    <span class="tok-o">}</span>

    <span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span> <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span> <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
        <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setContentType</span><span class="tok-o">(</span><span class="tok-s">&quot;text/html&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">PrintWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;!DOCTYPE HTML PUBLIC \&quot;&quot;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;-//W3C//DTD HTML 4.0 &quot;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;Transitional//EN\&quot;&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;HTML&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;BODY&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;h1&gt;Lista de autores&lt;/h1&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;ul&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Autor</span><span class="tok-o">&gt;</span> <span class="tok-n">lista</span> <span class="tok-o">=</span> <span class="tok-n">autorServicio</span><span class="tok-o">.</span><span class="tok-na">listAllAutores</span><span class="tok-o">();</span>
        <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">Autor</span> <span class="tok-n">a</span> <span class="tok-o">:</span> <span class="tok-n">lista</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;li&gt; &quot;</span> <span class="tok-o">+</span> <span class="tok-n">a</span><span class="tok-o">.</span><span class="tok-na">getNombre</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-s">&quot;&lt;/li&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-o">}</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/ul&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/BODY&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/HTML&quot;</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/expertojava/jpa/mensajes/servlets/NuevoAutorMensaje.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jpa</span><span class="tok-o">.</span><span class="tok-na">mensajes</span><span class="tok-o">.</span><span class="tok-na">servlets</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jpa.mensajes.modelo.Autor</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jpa.mensajes.servicio.AutorServicio</span><span class="tok-o">;</span>


<span class="tok-kn">import</span> <span class="tok-nn">javax.inject.Inject</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.ServletException</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.annotation.WebServlet</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.http.HttpServlet</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.http.HttpServletRequest</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.http.HttpServletResponse</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.io.IOException</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.io.PrintWriter</span><span class="tok-o">;</span>

<span class="tok-nd">@WebServlet</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;nuevoAutorMensaje&quot;</span><span class="tok-o">,</span> <span class="tok-n">urlPatterns</span><span class="tok-o">=</span><span class="tok-s">&quot;/nuevoAutorMensaje&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">NuevoAutorMensaje</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span> <span class="tok-o">{</span>

    <span class="tok-nd">@Inject</span>
    <span class="tok-n">AutorServicio</span> <span class="tok-n">autorServicio</span><span class="tok-o">;</span>

    <span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">doPost</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span> <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span> <span class="tok-kd">throws</span>
            <span class="tok-n">ServletException</span><span class="tok-o">,</span>
            <span class="tok-n">IOException</span> <span class="tok-o">{</span>

    <span class="tok-o">}</span>

    <span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span> <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span> <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
        <span class="tok-n">String</span> <span class="tok-n">login</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;login&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">String</span> <span class="tok-n">mensaje</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;mensaje&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">login</span><span class="tok-o">);</span>
        <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">mensaje</span><span class="tok-o">);</span>

        <span class="tok-n">autorServicio</span><span class="tok-o">.</span><span class="tok-na">createAutorMensaje</span><span class="tok-o">(</span><span class="tok-n">login</span><span class="tok-o">,</span> <span class="tok-n">login</span><span class="tok-o">,</span> <span class="tok-n">mensaje</span><span class="tok-o">);</span>

        <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setContentType</span><span class="tok-o">(</span><span class="tok-s">&quot;text/html&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">PrintWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;!DOCTYPE HTML PUBLIC \&quot;&quot;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;-//W3C//DTD HTML 4.0 &quot;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;Transitional//EN\&quot;&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;HTML&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;BODY&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;h3&gt;Autor y mensaje correctos&lt;/h3&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/BODY&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/HTML&quot;</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_servicio">Servicio</h5>
<div class="listingblock">
<div class="title">src/main/java/org/expertojava/jpa/mensajes/servicio/AutorServicio.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jpa</span><span class="tok-o">.</span><span class="tok-na">mensajes</span><span class="tok-o">.</span><span class="tok-na">servicio</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jpa.mensajes.modelo.Autor</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jpa.mensajes.modelo.Mensaje</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jpa.mensajes.persistencia.AutorDao</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jpa.mensajes.persistencia.MensajeDao</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.inject.Inject</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManager</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.PersistenceContext</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.transaction.Transactional</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.List</span><span class="tok-o">;</span>

<span class="tok-nd">@Transactional</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">AutorServicio</span> <span class="tok-o">{</span>

    <span class="tok-nd">@Inject</span>
    <span class="tok-n">AutorDao</span> <span class="tok-n">autorDao</span><span class="tok-o">;</span>
    <span class="tok-nd">@Inject</span>
    <span class="tok-n">MensajeDao</span> <span class="tok-n">mensajeDao</span><span class="tok-o">;</span>

    <span class="tok-kd">public</span> <span class="tok-n">Autor</span> <span class="tok-nf">createAutorMensaje</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">,</span>
                                    <span class="tok-n">String</span> <span class="tok-n">correo</span><span class="tok-o">,</span>
                                    <span class="tok-n">String</span> <span class="tok-n">texto</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">Autor</span> <span class="tok-n">autor</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Autor</span><span class="tok-o">(</span><span class="tok-n">nombre</span><span class="tok-o">,</span> <span class="tok-n">correo</span><span class="tok-o">);</span>
        <span class="tok-n">autor</span> <span class="tok-o">=</span> <span class="tok-n">autorDao</span><span class="tok-o">.</span><span class="tok-na">create</span><span class="tok-o">(</span><span class="tok-n">autor</span><span class="tok-o">);</span>
        <span class="tok-n">Mensaje</span> <span class="tok-n">mensaje</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Mensaje</span><span class="tok-o">(</span><span class="tok-n">texto</span><span class="tok-o">,</span> <span class="tok-n">autor</span><span class="tok-o">);</span>
        <span class="tok-n">mensaje</span> <span class="tok-o">=</span> <span class="tok-n">mensajeDao</span><span class="tok-o">.</span><span class="tok-na">create</span><span class="tok-o">(</span><span class="tok-n">mensaje</span><span class="tok-o">);</span>
        <span class="tok-k">return</span> <span class="tok-n">autor</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Autor</span><span class="tok-o">&gt;</span> <span class="tok-nf">listAllAutores</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Autor</span><span class="tok-o">&gt;</span> <span class="tok-n">autores</span> <span class="tok-o">=</span> <span class="tok-n">autorDao</span><span class="tok-o">.</span><span class="tok-na">listAllAutores</span><span class="tok-o">();</span>
        <span class="tok-k">return</span> <span class="tok-n">autores</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_daos">DAOs</h5>
<div class="listingblock">
<div class="title">src/main/java/org/expertojava/jpa/mensajes/persistencia/Dao.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jpa</span><span class="tok-o">.</span><span class="tok-na">mensajes</span><span class="tok-o">.</span><span class="tok-na">persistencia</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManager</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.PersistenceContext</span><span class="tok-o">;</span>

<span class="tok-kd">abstract</span> <span class="tok-kd">class</span> <span class="tok-nc">Dao</span><span class="tok-o">&lt;</span><span class="tok-n">T</span><span class="tok-o">,</span> <span class="tok-n">K</span><span class="tok-o">&gt;</span> <span class="tok-o">{</span>

    <span class="tok-nd">@PersistenceContext</span><span class="tok-o">(</span><span class="tok-n">unitName</span> <span class="tok-o">=</span> <span class="tok-s">&quot;mensajes&quot;</span><span class="tok-o">)</span>
    <span class="tok-n">EntityManager</span> <span class="tok-n">em</span><span class="tok-o">;</span>

    <span class="tok-kd">public</span> <span class="tok-n">T</span> <span class="tok-nf">create</span><span class="tok-o">(</span><span class="tok-n">T</span> <span class="tok-n">t</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">persist</span><span class="tok-o">(</span><span class="tok-n">t</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">flush</span><span class="tok-o">();</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">refresh</span><span class="tok-o">(</span><span class="tok-n">t</span><span class="tok-o">);</span>
        <span class="tok-k">return</span> <span class="tok-n">t</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">T</span> <span class="tok-nf">update</span><span class="tok-o">(</span><span class="tok-n">T</span> <span class="tok-n">t</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-o">(</span><span class="tok-n">T</span><span class="tok-o">)</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">merge</span><span class="tok-o">(</span><span class="tok-n">t</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">delete</span><span class="tok-o">(</span><span class="tok-n">T</span> <span class="tok-n">t</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">t</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">merge</span><span class="tok-o">(</span><span class="tok-n">t</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">remove</span><span class="tok-o">(</span><span class="tok-n">t</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kd">abstract</span> <span class="tok-n">T</span> <span class="tok-nf">find</span><span class="tok-o">(</span><span class="tok-n">K</span> <span class="tok-n">id</span><span class="tok-o">);</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/expertojava/jpa/mensajes/persistencia/AutorDao.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jpa</span><span class="tok-o">.</span><span class="tok-na">mensajes</span><span class="tok-o">.</span><span class="tok-na">persistencia</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jpa.mensajes.modelo.Autor</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.Query</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.List</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">AutorDao</span> <span class="tok-kd">extends</span> <span class="tok-n">Dao</span><span class="tok-o">&lt;</span><span class="tok-n">Autor</span><span class="tok-o">,</span> <span class="tok-n">Long</span><span class="tok-o">&gt;</span> <span class="tok-o">{</span>
    <span class="tok-n">String</span> <span class="tok-n">FIND_ALL_AUTORES</span> <span class="tok-o">=</span> <span class="tok-s">&quot;SELECT a FROM Autor a &quot;</span><span class="tok-o">;</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-n">Autor</span> <span class="tok-nf">find</span><span class="tok-o">(</span><span class="tok-n">Long</span> <span class="tok-n">id</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Autor</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-n">id</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Autor</span><span class="tok-o">&gt;</span> <span class="tok-nf">listAllAutores</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">Query</span> <span class="tok-n">query</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">createQuery</span><span class="tok-o">(</span><span class="tok-n">FIND_ALL_AUTORES</span><span class="tok-o">);</span>
        <span class="tok-k">return</span> <span class="tok-o">(</span><span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Autor</span><span class="tok-o">&gt;)</span> <span class="tok-n">query</span><span class="tok-o">.</span><span class="tok-na">getResultList</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/expertojava/jpa/mensajes/persistencia/AutorDao.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jpa</span><span class="tok-o">.</span><span class="tok-na">mensajes</span><span class="tok-o">.</span><span class="tok-na">persistencia</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jpa.mensajes.modelo.Mensaje</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.Query</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.List</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">MensajeDao</span> <span class="tok-kd">extends</span> <span class="tok-n">Dao</span><span class="tok-o">&lt;</span><span class="tok-n">Mensaje</span><span class="tok-o">,</span> <span class="tok-n">Long</span><span class="tok-o">&gt;</span> <span class="tok-o">{</span>
    <span class="tok-n">String</span> <span class="tok-n">FIND_ALL_MENSAJES</span> <span class="tok-o">=</span> <span class="tok-s">&quot;SELECT m FROM Mensaje m&quot;</span><span class="tok-o">;</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-n">Mensaje</span> <span class="tok-nf">find</span><span class="tok-o">(</span><span class="tok-n">Long</span> <span class="tok-n">id</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Mensaje</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-n">id</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Mensaje</span><span class="tok-o">&gt;</span> <span class="tok-nf">listAllMensajes</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">Query</span> <span class="tok-n">query</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">createQuery</span><span class="tok-o">(</span><span class="tok-n">FIND_ALL_MENSAJES</span><span class="tok-o">);</span>
        <span class="tok-k">return</span> <span class="tok-o">(</span><span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Mensaje</span><span class="tok-o">&gt;)</span> <span class="tok-n">query</span><span class="tok-o">.</span><span class="tok-na">getResultList</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios_6">6.3. Ejercicios</h3>
<div class="sect3">
<h4 id="__0_5_puntos_ejercicios_sobre_transacciones">6.3.1. (0,5 puntos) Ejercicios sobre transacciones</h4>
<div class="paragraph">
<p>Escribe en el módulo <code>mensajes</code> uno o varios programas que permitan probar el funcionamiento de al menos dos de los distintos modos de bloqueos vistos en la sesión de teoría. Prueba a ejecutar concurrentemente el programa lanzando varios procesos desde IntelliJ.</p>
</div>
<div class="paragraph">
<p>Puedes parar la ejecución del programa cuando te interese, llamando por ejemplo a la siguiente función que se queda a la espera de una entrada del usuario.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-kt">void</span> <span class="tok-nf">pulsaIntro</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">msg</span><span class="tok-o">)</span> <span class="tok-o">{</span>
   <span class="tok-k">try</span> <span class="tok-o">{</span>
      <span class="tok-n">BufferedReader</span> <span class="tok-n">in</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">BufferedReader</span><span class="tok-o">(</span>
            <span class="tok-k">new</span> <span class="tok-nf">InputStreamReader</span><span class="tok-o">(</span><span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">in</span><span class="tok-o">));</span>
      <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">msg</span><span class="tok-o">);</span>
      <span class="tok-n">in</span><span class="tok-o">.</span><span class="tok-na">readLine</span><span class="tok-o">();</span>
   <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">IOException</span> <span class="tok-n">e</span><span class="tok-o">)</span> <span class="tok-o">{</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Escribe un pequeño informe con las conclusiones que hayas encontrado en el fichero <code>ejercicio6.txt</code> en la raíz del repositorio.</p>
</div>
</div>
<div class="sect3">
<h4 id="__1_punto_aplicación_básica_jpa_en_web">6.3.2. (1 punto) Aplicación básica JPA en web</h4>
<div class="paragraph">
<p>Crea en el proyecto de ejercicios un nuevo módulo Maven llamado <code>mensajes-web</code> con las siguientes coordenadas:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;groupId&gt;</span>org.expertojava.jpa<span class="tok-nt">&lt;/groupId&gt;</span>
<span class="tok-nt">&lt;artifactId&gt;</span>mensajes-web<span class="tok-nt">&lt;artifactId&gt;</span>
<span class="tok-nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="tok-nt">&lt;/version&gt;</span>
<span class="tok-nt">&lt;packaging&gt;</span>war<span class="tok-nt">&lt;/packaging&gt;</span>

<span class="tok-nt">&lt;name&gt;</span>mensajes-web<span class="tok-nt">&lt;/name&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y crea en él la aplicación ejemplo <code>mensajes-web</code> que puedes encontrar en el repositorio <code>ejemplos-jpa</code> de Bitbucket.</p>
</div>
<div class="paragraph">
<p>Comprueba que todo funciona correctamente, y añade como mínimo 2 nuevos métodos de negocio en la clase <code>AutorServicio</code> (o puedes también crear otra clase de servicio sobre mensajes). Añade los servlets asociados y completa la página principal de la aplicación para poder invocarlos.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2015-09-27 10:43:29 CEST
</div>
</div>
</body>
</html>