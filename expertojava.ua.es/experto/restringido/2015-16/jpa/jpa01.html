<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.2">
<meta name="author" content="Domingo Gallardo">
<title>Frameworks de persistencia - JPA</title>
<style>/*! normalize.css v2.1.2 | MIT License | git.io/normalize */
/* ========================================================================== HTML5 display definitions ========================================================================== */
/** Correct `block` display not defined in IE 8/9. */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }

/** Correct `inline-block` display not defined in IE 8/9. */
audio, canvas, video { display: inline-block; }

/** Prevent modern browsers from displaying `audio` without controls. Remove excess height in iOS 5 devices. */
audio:not([controls]) { display: none; height: 0; }

/** Address `[hidden]` styling not present in IE 8/9. Hide the `template` element in IE, Safari, and Firefox < 22. */
[hidden], template { display: none; }

script { display: none !important; }

/* ========================================================================== Base ========================================================================== */
/** 1. Set default font family to sans-serif. 2. Prevent iOS text size adjust after orientation change, without disabling user zoom. */
html { font-family: sans-serif; /* 1 */ -ms-text-size-adjust: 100%; /* 2 */ -webkit-text-size-adjust: 100%; /* 2 */ }

/** Remove default margin. */
body { margin: 0; }

/* ========================================================================== Links ========================================================================== */
/** Remove the gray background color from active links in IE 10. */
a { background: transparent; }

/** Address `outline` inconsistency between Chrome and other browsers. */
a:focus { outline: thin dotted; }

/** Improve readability when focused and also mouse hovered in all browsers. */
a:active, a:hover { outline: 0; }

/* ========================================================================== Typography ========================================================================== */
/** Address variable `h1` font-size and margin within `section` and `article` contexts in Firefox 4+, Safari 5, and Chrome. */
h1 { font-size: 2em; margin: 0.67em 0; }

/** Address styling not present in IE 8/9, Safari 5, and Chrome. */
abbr[title] { border-bottom: 1px dotted; }

/** Address style set to `bolder` in Firefox 4+, Safari 5, and Chrome. */
b, strong { font-weight: bold; }

/** Address styling not present in Safari 5 and Chrome. */
dfn { font-style: italic; }

/** Address differences between Firefox and other browsers. */
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }

/** Address styling not present in IE 8/9. */
mark { background: #ff0; color: #000; }

/** Correct font family set oddly in Safari 5 and Chrome. */
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }

/** Improve readability of pre-formatted text in all browsers. */
pre { white-space: pre-wrap; }

/** Set consistent quote types. */
q { quotes: "\201C" "\201D" "\2018" "\2019"; }

/** Address inconsistent and variable font size in all browsers. */
small { font-size: 80%; }

/** Prevent `sub` and `sup` affecting `line-height` in all browsers. */
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }

sup { top: -0.5em; }

sub { bottom: -0.25em; }

/* ========================================================================== Embedded content ========================================================================== */
/** Remove border when inside `a` element in IE 8/9. */
img { border: 0; }

/** Correct overflow displayed oddly in IE 9. */
svg:not(:root) { overflow: hidden; }

/* ========================================================================== Figures ========================================================================== */
/** Address margin not present in IE 8/9 and Safari 5. */
figure { margin: 0; }

/* ========================================================================== Forms ========================================================================== */
/** Define consistent border, margin, and padding. */
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }

/** 1. Correct `color` not being inherited in IE 8/9. 2. Remove padding so people aren't caught out if they zero out fieldsets. */
legend { border: 0; /* 1 */ padding: 0; /* 2 */ }

/** 1. Correct font family not being inherited in all browsers. 2. Correct font size not being inherited in all browsers. 3. Address margins set differently in Firefox 4+, Safari 5, and Chrome. */
button, input, select, textarea { font-family: inherit; /* 1 */ font-size: 100%; /* 2 */ margin: 0; /* 3 */ }

/** Address Firefox 4+ setting `line-height` on `input` using `!important` in the UA stylesheet. */
button, input { line-height: normal; }

/** Address inconsistent `text-transform` inheritance for `button` and `select`. All other form control elements do not inherit `text-transform` values. Correct `button` style inheritance in Chrome, Safari 5+, and IE 8+. Correct `select` style inheritance in Firefox 4+ and Opera. */
button, select { text-transform: none; }

/** 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio` and `video` controls. 2. Correct inability to style clickable `input` types in iOS. 3. Improve usability and consistency of cursor style between image-type `input` and others. */
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; /* 2 */ cursor: pointer; /* 3 */ }

/** Re-set default cursor for disabled elements. */
button[disabled], html input[disabled] { cursor: default; }

/** 1. Address box sizing set to `content-box` in IE 8/9. 2. Remove excess padding in IE 8/9. */
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; /* 1 */ padding: 0; /* 2 */ }

/** 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome. 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome (include `-moz` to future-proof). */
input[type="search"] { -webkit-appearance: textfield; /* 1 */ -moz-box-sizing: content-box; -webkit-box-sizing: content-box; /* 2 */ box-sizing: content-box; }

/** Remove inner padding and search cancel button in Safari 5 and Chrome on OS X. */
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }

/** Remove inner padding and border in Firefox 4+. */
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }

/** 1. Remove default vertical scrollbar in IE 8/9. 2. Improve readability and alignment in all browsers. */
textarea { overflow: auto; /* 1 */ vertical-align: top; /* 2 */ }

/* ========================================================================== Tables ========================================================================== */
/** Remove most spacing between table cells. */
table { border-collapse: collapse; border-spacing: 0; }

meta.foundation-mq-small { font-family: "only screen and (min-width: 768px)"; width: 768px; }

meta.foundation-mq-medium { font-family: "only screen and (min-width:1280px)"; width: 1280px; }

meta.foundation-mq-large { font-family: "only screen and (min-width:1440px)"; width: 1440px; }

*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }

html, body { font-size: 97%; }

body { background: white; color: #222222; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }

a:hover { cursor: pointer; }

img, object, embed { max-width: 100%; height: auto; }

object, embed { height: 100%; }

img { -ms-interpolation-mode: bicubic; }

#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }

.left { float: left !important; }

.right { float: right !important; }

.text-left { text-align: left !important; }

.text-right { text-align: right !important; }

.text-center { text-align: center !important; }

.text-justify { text-align: justify !important; }

.hide { display: none; }

.antialiased, body { -webkit-font-smoothing: antialiased; }

img { display: inline-block; vertical-align: middle; }

textarea { height: auto; min-height: 50px; }

select { width: 100%; }

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }

.subheader, .admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { line-height: 1.4; color: #6f6f6f; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }

/* Typography resets */
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }

/* Default Link Styles */
a { color: #1164be; text-decoration: none; line-height: inherit; }
a img { border: none; }

/* Default paragraph styles */
p { font-family: inherit; font-weight: normal; font-size: 1em; line-height: 1.4; margin-bottom: 1em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }

/* Default header styles */
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: bold; font-style: normal; color: #1c355e; text-rendering: optimizeLegibility; margin-top: 1em; margin-bottom: 0.5em; line-height: 1.2125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #6f6f6f; line-height: 0; }

h1 { font-size: 2.125em; }

h2 { font-size: 1.6875em; }

h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }

h4 { font-size: 1.125em; }

h5 { font-size: 1.125em; }

h6 { font-size: 1em; }

hr { border: solid #dddddd; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }

/* Helpful Typography Defaults */
em, i { font-style: italic; line-height: inherit; }

strong, b { font-weight: bold; line-height: inherit; }

small { font-size: 60%; line-height: inherit; }

code { font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: bold; }

/* Lists */
ul, ol, dl { font-size: 1em; line-height: 1.4; margin-bottom: 1.25em; list-style-position: outside; font-family: inherit; }

ul, ol { margin-left: 2.5em; }
ul.no-bullet, ol.no-bullet { margin-left: 1.5em; }

/* Unordered Lists */
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; /* Override nested font-size change */ }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }

/* Ordered Lists */
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }

/* Definition Lists */
dl dt { margin-bottom: 0.3125em; font-weight: bold; }
dl dd { margin-bottom: 1.25em; }

/* Abbreviations */
abbr, acronym { text-transform: uppercase; font-size: 90%; color: #222222; border-bottom: 1px dotted #dddddd; cursor: help; }

abbr { text-transform: none; }

/* Blockquotes */
blockquote { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
blockquote cite { display: block; font-size: 0.8125em; color: #555555; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #555555; }

blockquote, blockquote p { line-height: 1.6; color: #6f6f6f; }

/* Microformats */
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #dddddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }

.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }

/*@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.6875em; }
  h4 { font-size: 1.4375em; } }*/
/* Tables */
table { background: white; margin-bottom: 1.25em; border: solid 1px #dddddd; }
table thead, table tfoot { background: whitesmoke; font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: #222222; text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: #222222; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #f9f9f9; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.4; }

h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; border-bottom: 1px solid #dddddd }

.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }

*:not(pre) > code { font-size: inherit; font-style: normal !important; letter-spacing: 0; padding: 3px 2px 1px 2px; background-color: #eeeeee; border: 1px solid #dddddd; -webkit-border-radius: 0; border-radius: 0; line-height: inherit; font-weight: normal; }

pre, pre > code { line-height: 1.4; color: black; font-family: monospace, serif; font-weight: normal; }

.keyseq { color: #555555; }

kbd { display: inline-block; color: #222222; font-size: 0.75em; line-height: 1.4; background-color: #f7f7f7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; margin: -0.15em 0.15em 0 0.15em; padding: 0.2em 0.6em 0.2em 0.5em; vertical-align: middle; white-space: nowrap; }

.keyseq kbd:first-child { margin-left: 0; }

.keyseq kbd:last-child { margin-right: 0; }

.menuseq, .menu { color: #090909; }

b.button:before, b.button:after { position: relative; top: -1px; font-weight: normal; }

b.button:before { content: "["; padding: 0 3px 0 2px; }

b.button:after { content: "]"; padding: 0 2px 0 3px; }

#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 0.9375em; padding-right: 0.9375em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }

#content { margin-top: 1.25em; }

#content:before { content: none; }

#header > h1:first-child { color: black; margin-top: 2.25rem; margin-bottom: 0; }
#header > h1:first-child + #toc { margin-top: 8px; border-top: 1px solid #dddddd; }
#header > h1:only-child, body.toc2 #header > h1:nth-last-child(2) { border-bottom: 1px solid #dddddd; padding-bottom: 8px; }
#header .details { border-bottom: 1px solid #dddddd; line-height: 1.45; padding-top: 0.25em; padding-bottom: 0.25em; padding-left: 0.25em; color: #555555; display: -ms-flexbox; display: -webkit-flex; display: flex; -ms-flex-flow: row wrap; -webkit-flex-flow: row wrap; flex-flow: row wrap; }
#header .details span:first-child { margin-left: -0.125em; }
#header .details span.email a { color: #6f6f6f; }
#header .details br { display: none; }
#header .details br + span:before { content: "\00a0\2013\00a0"; }
#header .details br + span.author:before { content: "\00a0\22c5\00a0"; color: #6f6f6f; }
#header .details br + span#revremark:before { content: "\00a0|\00a0"; }
#header #revnumber { text-transform: capitalize; }
#header #revnumber:after { content: "\00a0"; }

#content > h1:first-child:not([class]) { color: black; border-bottom: 1px solid #dddddd; padding-bottom: 8px; margin-top: 0; padding-top: 1rem; margin-bottom: 1.25rem; }

#floating {
  position: fixed;
  z-index: 1000;
  padding: 0.5em;
  right: 0;
  top: 0;
  background: white;
  box-shadow: 0 0 1em #777777;
  -webkit-box-shadow: 0 0 1em #777777;
  -moz-box-shadow: 0 0 1em #777777;
  -webkit-border-bottom-left-radius: 5px;
  -moz-border-radius-bottomleft: 5px;
  max-height: 80%;
  overflow: auto;
}

#floating #full { display: none; } /* Hide the full TOC by default */

#floating:hover #full{
  display: block; /* Show it on hover */
}


#toc { border-bottom: 1px solid #dddddd; padding-bottom: 0.5em; }
#toc > ul { margin-left: 0.125em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin: 0.5em 0; }
#toc ul { font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; list-style-type: none; }
#toc a { text-decoration: none; }
#toc a:active { text-decoration: underline; }

#toctitle { color: #6f6f6f; font-size: 1.2em; }

@media only screen and (min-width: 768px) { #toctitle { font-size: 1.375em; }
  body.toc2 { padding-left: 15em; padding-right: 0; }
  #toc.toc2 { margin-top: 0 !important; background-color: #f2f2f2; position: fixed; width: 15em; left: 0; top: 0; border-right: 1px solid #dddddd; border-top-width: 0 !important; border-bottom-width: 0 !important; z-index: 1000; padding: 1.25em 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; font-size: 1.2em; }
  #toc.toc2 > ul { font-size: 0.9em; margin-bottom: 0; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 15em; }
  body.toc2.toc-right #toc.toc2 { border-right-width: 0; border-left: 1px solid #dddddd; left: auto; right: 0; } }
@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; padding-right: 0; }
  #toc.toc2 { width: 20em; }
  #toc.toc2 #toctitle { font-size: 1.375em; }
  #toc.toc2 > ul { font-size: 0.95em; }
  #toc.toc2 ul ul { padding-left: 1.25em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; } }
#content #toc { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 0; border-radius: 0; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }

#footer { max-width: 100%; background-color: #222222; padding: 1.25em; }

#footer-text { color: #dddddd; line-height: 1.44; }

.sect1 { padding-bottom: 0.625em; }

@media only screen and (min-width: 768px) { .sect1 { padding-bottom: 1.25em; } }
.sect1 + .sect1 { border-top: 1px solid #dddddd; }

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; z-index: 1001; width: 1.5ex; margin-left: -1.5ex; display: block; text-decoration: none !important; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: "\00A7"; font-size: 0.85em; display: block; padding-top: 0.1em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #222222; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #151515; }

.audioblock, .imageblock, .literalblock, .listingblock, .stemblock, .videoblock { margin-bottom: 1.25em; }

.admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-rendering: optimizeLegibility; text-align: left; }

table.tableblock > caption.title { white-space: nowrap; overflow: visible; max-width: 0; }

.paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { color: black; }

table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }

.admonitionblock > table { border-collapse: separate; border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #dddddd; color: #555555; }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }

.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 0; border-radius: 0; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }

.sidebarblock { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 0; border-radius: 0; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock > .content > .title { color: #6f6f6f; margin-top: 0; }

.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }

.literalblock pre, .listingblock pre:not(.highlight), .listingblock pre[class="highlight"], .listingblock pre[class^="highlight "], .listingblock pre.CodeRay, .listingblock pre.prettyprint { background: #eeeeee; }
.sidebarblock .literalblock pre, .sidebarblock .listingblock pre:not(.highlight), .sidebarblock .listingblock pre[class="highlight"], .sidebarblock .listingblock pre[class^="highlight "], .sidebarblock .listingblock pre.CodeRay, .sidebarblock .listingblock pre.prettyprint { background: #f2f1f1; }

.literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { border: 1px solid #cccccc; -webkit-border-radius: 0; border-radius: 0; word-wrap: break-word; padding: 0.8em 0.8em 0.65em 0.8em; font-size: 0.8125em; }
.literalblock pre.nowrap, .literalblock pre[class].nowrap, .listingblock pre.nowrap, .listingblock pre[class].nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
@media only screen and (min-width: 768px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 0.90625em; } }
@media only screen and (min-width: 1280px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 1em; } }

.literalblock.output pre { color: #eeeeee; background-color: black; }

.listingblock pre.highlightjs { padding: 0; }
.listingblock pre.highlightjs > code { padding: 0.8em 0.8em 0.65em 0.8em; -webkit-border-radius: 0; border-radius: 0; }

.listingblock > .content { position: relative; }

.listingblock code[data-lang]:before { display: none; content: attr(data-lang); position: absolute; font-size: 0.75em; top: 0.425rem; right: 0.5rem; line-height: 1; text-transform: uppercase; color: #999; }

.listingblock:hover code[data-lang]:before { display: block; }

.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }

.listingblock.terminal pre .command:not([data-prompt]):before { content: "$"; }

table.pyhltable { border-collapse: separate; border: 0; margin-bottom: 0; background: none; }

table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; }

table.pyhltable td.code { padding-left: .75em; padding-right: 0; }

pre.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #dddddd; }

pre.pygments .lineno { display: inline-block; margin-right: .25em; }

table.pyhltable .linenodiv { background: none !important; padding-right: 0 !important; }

.quoteblock { margin: 0 1em 1.25em 1.5em; display: table; }
.quoteblock > .title { margin-left: -1.5em; margin-bottom: 0.75em; }
.quoteblock blockquote, .quoteblock blockquote p { color: #6f6f6f; font-size: 1.15rem; line-height: 1.75; word-spacing: 0.1em; letter-spacing: 0; font-style: italic; text-align: justify; }
.quoteblock blockquote { margin: 0; padding: 0; border: 0; }
.quoteblock blockquote:before { content: "\201c"; float: left; font-size: 2.75em; font-weight: bold; line-height: 0.6em; margin-left: -0.6em; color: #6f6f6f; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: 0.5em; margin-right: 0.5ex; text-align: right; }
.quoteblock .quoteblock { margin-left: 0; margin-right: 0; padding: 0.5em 0; border-left: 3px solid #555555; }
.quoteblock .quoteblock blockquote { padding: 0 0 0 0.75em; }
.quoteblock .quoteblock blockquote:before { display: none; }

.verseblock { margin: 0 1em 1.25em 1em; }
.verseblock pre { font-family: "Open Sans", "DejaVu Sans", sans; font-size: 1.15rem; color: #6f6f6f; font-weight: 300; text-rendering: optimizeLegibility; }
.verseblock pre strong { font-weight: 400; }
.verseblock .attribution { margin-top: 1.25rem; margin-left: 0.5ex; }

.quoteblock .attribution, .verseblock .attribution { font-size: 0.8125em; line-height: 1.45; font-style: italic; }
.quoteblock .attribution br, .verseblock .attribution br { display: none; }
.quoteblock .attribution cite, .verseblock .attribution cite { display: block; letter-spacing: -0.05em; color: #555555; }

.quoteblock.abstract { margin: 0 0 1.25em 0; display: block; }
.quoteblock.abstract blockquote, .quoteblock.abstract blockquote p { text-align: left; word-spacing: 0; }
.quoteblock.abstract blockquote:before, .quoteblock.abstract blockquote p:first-of-type:before { display: none; }

table.tableblock { max-width: 100%; border-collapse: separate; }
table.tableblock td > .paragraph:last-child p > p:last-child, table.tableblock th > p:last-child, table.tableblock td > p:last-child { margin-bottom: 0; }

table.spread { width: 100%; }

table.tableblock, th.tableblock, td.tableblock { border: 0 solid #dddddd; }

table.grid-all th.tableblock, table.grid-all td.tableblock { border-width: 0 1px 1px 0; }

table.grid-all tfoot > tr > th.tableblock, table.grid-all tfoot > tr > td.tableblock { border-width: 1px 1px 0 0; }

table.grid-cols th.tableblock, table.grid-cols td.tableblock { border-width: 0 1px 0 0; }

table.grid-all * > tr > .tableblock:last-child, table.grid-cols * > tr > .tableblock:last-child { border-right-width: 0; }

table.grid-rows th.tableblock, table.grid-rows td.tableblock { border-width: 0 0 1px 0; }

table.grid-all tbody > tr:last-child > th.tableblock, table.grid-all tbody > tr:last-child > td.tableblock, table.grid-all thead:last-child > tr > th.tableblock, table.grid-rows tbody > tr:last-child > th.tableblock, table.grid-rows tbody > tr:last-child > td.tableblock, table.grid-rows thead:last-child > tr > th.tableblock { border-bottom-width: 0; }

table.grid-rows tfoot > tr > th.tableblock, table.grid-rows tfoot > tr > td.tableblock { border-width: 1px 0 0 0; }

table.frame-all { border-width: 1px; }

table.frame-sides { border-width: 0 1px; }

table.frame-topbot { border-width: 1px 0; }

th.halign-left, td.halign-left { text-align: left; }

th.halign-right, td.halign-right { text-align: right; }

th.halign-center, td.halign-center { text-align: center; }

th.valign-top, td.valign-top { vertical-align: top; }

th.valign-bottom, td.valign-bottom { vertical-align: bottom; }

th.valign-middle, td.valign-middle { vertical-align: middle; }

table thead th, table tfoot th { font-weight: bold; }

tbody tr th { display: table-cell; line-height: 1.4; background: whitesmoke; }

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p { color: #222222; font-weight: bold; }

p.tableblock > code:only-child { background: none; padding: 0; }

p.tableblock { font-size: 1em; }

td > div.verse { white-space: pre; }

ol { margin-left: 2.5em; }

ul li ol { margin-left: 1.5em; }

dl dd { margin-left: 1.125em; }

dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }

ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.625em; }

ul.unstyled, ol.unnumbered, ul.checklist, ul.none { list-style-type: none; }

ul.unstyled, ol.unnumbered, ul.checklist { margin-left: 0.625em; }

ul.checklist li > p:first-child > .fa-check-square-o:first-child, ul.checklist li > p:first-child > input[type="checkbox"]:first-child { margin-right: 0.25em; }

ul.checklist li > p:first-child > input[type="checkbox"]:first-child { position: relative; top: 1px; }

ul.inline { margin: 0 auto 0.625em auto; margin-left: -1.375em; margin-right: 0; padding: 0; list-style: none; overflow: hidden; }
ul.inline > li { list-style: none; float: left; margin-left: 1.375em; display: block; }
ul.inline > li > * { display: block; }

.unstyled dl dt { font-weight: normal; font-style: normal; }

ol.arabic { list-style-type: decimal; }

ol.decimal { list-style-type: decimal-leading-zero; }

ol.loweralpha { list-style-type: lower-alpha; }

ol.upperalpha { list-style-type: upper-alpha; }

ol.lowerroman { list-style-type: lower-roman; }

ol.upperroman { list-style-type: upper-roman; }

ol.lowergreek { list-style-type: lower-greek; }

.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }

td.hdlist1 { padding-right: .75em; font-weight: bold; }

td.hdlist1, td.hdlist2 { vertical-align: top; }

.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }

.colist > table tr > td:first-of-type { padding: 0 0.75em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.25em 0; }

.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: 0 0 0 1px #dddddd; box-shadow: 0 0 0 1px #dddddd; }

.imageblock.left, .imageblock[style*="float: left"] { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }

.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }

a.image { text-decoration: none; }

span.footnote, span.footnoteref { vertical-align: super; font-size: 0.875em; }
span.footnote a, span.footnoteref a { text-decoration: none; }
span.footnote a:active, span.footnoteref a:active { text-decoration: underline; }

#footnotes { padding-top: 0.75em; padding-bottom: 0.75em; margin-bottom: 0.625em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -.25em 0 .75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.375em; line-height: 1.3; font-size: 0.875em; margin-left: 1.2em; text-indent: -1.2em; margin-bottom: .2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }

#content #footnotes { margin-top: -0.625em; margin-bottom: 0; padding: 0.75em 0; }

.gist .file-data > table { border: 0; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }

div.unbreakable { page-break-inside: avoid; }

.big { font-size: larger; }

.small { font-size: smaller; }

.underline { text-decoration: underline; }

.overline { text-decoration: overline; }

.line-through { text-decoration: line-through; }

.aqua { color: #00bfbf; }

.aqua-background { background-color: #00fafa; }

.black { color: black; }

.black-background { background-color: black; }

.blue { color: #0000bf; }

.blue-background { background-color: #0000fa; }

.fuchsia { color: #bf00bf; }

.fuchsia-background { background-color: #fa00fa; }

.gray { color: #606060; }

.gray-background { background-color: #7d7d7d; }

.green { color: #006000; }

.green-background { background-color: #007d00; }

.lime { color: #00bf00; }

.lime-background { background-color: #00fa00; }

.maroon { color: #600000; }

.maroon-background { background-color: #7d0000; }

.navy { color: #000060; }

.navy-background { background-color: #00007d; }

.olive { color: #606000; }

.olive-background { background-color: #7d7d00; }

.purple { color: #600060; }

.purple-background { background-color: #7d007d; }

.red { color: #bf0000; }

.red-background { background-color: #fa0000; }

.silver { color: #909090; }

.silver-background { background-color: #bcbcbc; }

.teal { color: #006060; }

.teal-background { background-color: #007d7d; }

.white { color: #bfbfbf; }

.white-background { background-color: #fafafa; }

.yellow { color: #bfbf00; }

.yellow-background { background-color: #fafa00; }

span.icon > .fa { cursor: default; }

.admonitionblock td.icon [class^="fa icon-"] { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #207c98; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }

.conum[data-value] { display: inline-block; color: #fff !important; background-color: #222222; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; font-size: 0.75em; width: 1.67em; height: 1.67em; line-height: 1.67em; font-family: "Open Sans", "DejaVu Sans", sans-serif; font-style: normal; font-weight: bold; }
.conum[data-value] * { color: #fff !important; }
.conum[data-value] + b { display: none; }
.conum[data-value]:after { content: attr(data-value); }
pre .conum[data-value] { position: relative; top: -0.125em; }

b.conum * { color: inherit !important; }

.conum:not([data-value]):empty { display: none; }

.literalblock pre, .listingblock pre { background: #eeeeee; }

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.min.css">
<style>.listingblock .pygments .hll { background-color: #ffffcc }
.listingblock .pygments  { background: #f8f8f8; }
.listingblock .pygments .tok-c { color: #408080; font-style: italic } /* Comment */
.listingblock .pygments .tok-err { border: 1px solid #FF0000 } /* Error */
.listingblock .pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
.listingblock .pygments .tok-o { color: #666666 } /* Operator */
.listingblock .pygments .tok-cm { color: #408080; font-style: italic } /* Comment.Multiline */
.listingblock .pygments .tok-cp { color: #BC7A00 } /* Comment.Preproc */
.listingblock .pygments .tok-c1 { color: #408080; font-style: italic } /* Comment.Single */
.listingblock .pygments .tok-cs { color: #408080; font-style: italic } /* Comment.Special */
.listingblock .pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
.listingblock .pygments .tok-ge { font-style: italic } /* Generic.Emph */
.listingblock .pygments .tok-gr { color: #FF0000 } /* Generic.Error */
.listingblock .pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
.listingblock .pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
.listingblock .pygments .tok-go { color: #888888 } /* Generic.Output */
.listingblock .pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.listingblock .pygments .tok-gs { font-weight: bold } /* Generic.Strong */
.listingblock .pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.listingblock .pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
.listingblock .pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.listingblock .pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.listingblock .pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.listingblock .pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
.listingblock .pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.listingblock .pygments .tok-kt { color: #B00040 } /* Keyword.Type */
.listingblock .pygments .tok-m { color: #666666 } /* Literal.Number */
.listingblock .pygments .tok-s { color: #BA2121 } /* Literal.String */
.listingblock .pygments .tok-na { color: #7D9029 } /* Name.Attribute */
.listingblock .pygments .tok-nb { color: #008000 } /* Name.Builtin */
.listingblock .pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
.listingblock .pygments .tok-no { color: #880000 } /* Name.Constant */
.listingblock .pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
.listingblock .pygments .tok-ni { color: #999999; font-weight: bold } /* Name.Entity */
.listingblock .pygments .tok-ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.listingblock .pygments .tok-nf { color: #0000FF } /* Name.Function */
.listingblock .pygments .tok-nl { color: #A0A000 } /* Name.Label */
.listingblock .pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.listingblock .pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
.listingblock .pygments .tok-nv { color: #19177C } /* Name.Variable */
.listingblock .pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.listingblock .pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
.listingblock .pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
.listingblock .pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
.listingblock .pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
.listingblock .pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
.listingblock .pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
.listingblock .pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
.listingblock .pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
.listingblock .pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.listingblock .pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
.listingblock .pygments .tok-se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.listingblock .pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
.listingblock .pygments .tok-si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.listingblock .pygments .tok-sx { color: #008000 } /* Literal.String.Other */
.listingblock .pygments .tok-sr { color: #BB6688 } /* Literal.String.Regex */
.listingblock .pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
.listingblock .pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
.listingblock .pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
.listingblock .pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
.listingblock .pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
.listingblock .pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
.listingblock .pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Frameworks de persistencia - JPA</h1>
<div class="details">
<span id="author" class="author">Domingo Gallardo</span><br>
<span id="email" class="email"><a href="mailto:domingo.gallardo@ua.es">domingo.gallardo@ua.es</a></span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Índice de contenidos</div>
<ul class="sectlevel1">
<li><a href="#_primer_contacto_con_jpa">1. Primer contacto con JPA</a>
<ul class="sectlevel2">
<li><a href="#_introducci%C3%B3n_a_jpa">1.1. Introducción a JPA</a>
<ul class="sectlevel3">
<li><a href="#_los_or%C3%ADgenes_de_jpa">1.1.1. Los orígenes de JPA</a></li>
<li><a href="#_java_persistence_api">1.1.2. Java Persistence API</a></li>
<li><a href="#_implementaciones_de_jpa">1.1.3. Implementaciones de JPA</a></li>
<li><a href="#_para_saber_m%C3%A1s">1.1.4. Para saber más</a></li>
</ul>
</li>
<li><a href="#_ejemplo_pr%C3%A1ctico_una_sencilla_aplicaci%C3%B3n_jpa">1.2. Ejemplo práctico: una sencilla aplicación JPA</a>
<ul class="sectlevel3">
<li><a href="#_configuraci%C3%B3n_del_proyecto_maven">1.2.1. Configuración del proyecto Maven</a></li>
<li><a href="#_configuraci%C3%B3n_de_la_conexi%C3%B3n_a_la_bd_de_intellij">1.2.2. Configuración de la conexión a la BD de IntelliJ</a></li>
<li><a href="#_clases_entidad">1.2.3. Clases entidad</a></li>
<li><a href="#_el_fichero_persistence_xml_y_la_base_de_datos">1.2.4. El fichero persistence.xml y la base de datos</a></li>
<li><a href="#_ficheros_de_configuraci%C3%B3n_de_logging">1.2.5. Ficheros de configuración de logging</a></li>
<li><a href="#_programas_java_em_standalone_em_que_trabajan_con_jpa">1.2.6. Programas Java <em>standalone</em> que trabajan con JPA</a></li>
<li><a href="#_definici%C3%B3n_de_tests_con_dbunit">1.2.7. Definición de tests con DbUnit</a></li>
</ul>
</li>
<li><a href="#_ejercicios">1.3. Ejercicios</a>
<ul class="sectlevel3">
<li><a href="#__0_5_puntos_construir_el_m%C3%B3dulo_mensajes">1.3.1. (0,5 puntos) Construir el módulo mensajes</a></li>
<li><a href="#__1_5_puntos_contruir_el_m%C3%B3dulo_filmoteca">1.3.2. (1,5 puntos) Contruir el módulo filmoteca</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_primer_contacto_con_jpa">1. Primer contacto con JPA</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introducción_a_jpa">1.1. Introducción a JPA</h3>
<div class="paragraph">
<p>En la primera sesión del módulo de Java Persistence API (JPA) vamos a tratar una introducción a esta nueva tecnología Java que permite trabajar con entidades persistentes conectadas a una base de datos. Introduciremos los conceptos principales de JPA que iremos desarrollando en posteriores sesiones y proporcionaremos un ejemplo completo en el que describiremos la instalación básica de JPA en aplicaciones Java standalone (Java SE) usando Maven, IntelliJ IDEA como entorno de desarrollo y Hibernate como implementación de JPA. Veremos por último cómo realizar tests en los que intervienen el acceso a una base de datos usando DbUnit. Este ejemplo será la base de algunos ejercicios de la sesión.</p>
</div>
<div class="paragraph">
<p>Entre los conceptos principales que trataremos sobre JPA destacamos los siguientes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>uso de anotaciones para especificar propiedades</p>
</li>
<li>
<p>entidades persistentes y relaciones entre entidades</p>
</li>
<li>
<p>mapeado objeto-relacional</p>
</li>
<li>
<p>gestión de contextos de persistencia y de transacciones</p>
</li>
<li>
<p>diferencias entre JPA gestionado por la aplicación y gestionado por el contenedor</p>
</li>
<li>
<p>lenguaje de <em>queries</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Estudiaremos estos conceptos en profundidad a lo largo del módulo. En la sesión de hoy realizaremos una introducción basándonos en un ejemplo práctico.</p>
</div>
<div class="sect3">
<h4 id="_los_orígenes_de_jpa">1.1.1. Los orígenes de JPA</h4>
<div class="paragraph">
<p>JPA (Java Persistence API) tiene su origen en el framework Hibernate, un conjunto de librerías que implementan un mapeado ORM (Mapeado Objeto-Relacional) desarrollado por Gavin King y un grupo de colaboradores a finales de 2001. Al principio Hibernate no era parte del estándar Java soportado por Sun, sino que se desarrolló de forma independiente como un proyecto Java open source. Pronto ganó popularidad y aceptación. El grupo de desarrolladores fue contratado por JBoss, integrando el producto en el servidor de aplicaciones de la compañía. En la actualidad JBoss ha sido adquirido por RedHat, que ha incorporado el servidor de aplicaciones en algunas de sus distribuciones de Linux y Gavin King continua trabajando allí.</p>
</div>
<div class="paragraph">
<p>En paralelo al desarrollo y popularización de Hibernate, la especificación oficial de Java EE también intentó definir <em>entidades persistentes</em>. En concreto, se definieron los <em>entity beans</em>, un tipo de componentes EJB distribuidos gestionados por contenedores. Junto a ellos, Sun también apoyó la especificación de JDO (Java Data Objects), otro framework alternativo de gestión de entidades persistentes que no requiere el uso de contenedores EJB. Ninguno de los dos frameworks tuvo demasiado éxito. Los EJB de entidad siempre fueron denostados por ser muy poco eficientes y complejos de utilizar. JDO, por otra parte, tardó bastante en ser implementado de una forma robusta y sencilla de manejar.</p>
</div>
<div class="paragraph">
<p>En este contexto se creó en mayo de 2003 el grupo de trabajo que iba a definir la siguiente especificación de EJB (EJB 3.0). Sun propuso a Gavin King formar parte del grupo. Cuando llegó el momento de decidir el modelo de gestión de entidades persistentes se decidió apostar por la solución que ya había adoptado de hecho la comunidad: el enfoque basado en POJOs de Hibernate. Tras tres años de trabajo, en abril de 2006 se realizó la votación que apruebó la nueva especificación y ésta se incorporó a la especificación oficial de Java EE 5 con el nombre de JPA. En declaraciones de Gavin King, la especificación de JPA recoge el 95% de las funcionalidades de Hibernate. Desde entonces JPA como estándar e Hibernate como implementación han ido evolucionando de la mano en las posteriores especificaciones Java EE6 y Java EE 7.</p>
</div>
</div>
<div class="sect3">
<h4 id="_java_persistence_api">1.1.2. Java Persistence API</h4>
<div class="paragraph">
<p>Java Persistence API (JPA) es la tecnología estándar de Java para gestionar <em>entidades persistentes</em> que se incluye en Java EE desde la versión 5. La versión 1.0 de la especificación se concluyó en mayo de 2006, como parte de Java EE 5. La versión 2.0 fue lanzada en diciembre de 2009, junto con Java EE 6. La versión 2.1 fue lanzada en abril de 2013, junto con Java EE 7.</p>
</div>
<div class="paragraph">
<p>La descripción oficial de la última versión del estándar está definida en el <a href="https://jcp.org/en/jsr/detail?id=338">JSR 338</a> en el que se especifica la versión 2.1 de JPA. Como la mayoría de los documentos que especifican las JSR, es un documento bastante legible, muy bien estructurado, muy conciso y con bastante ejemplos. Además, por ser la especificación original, es completo. Cualquier característica de JPA debe estar reflejada en este documento. Aconsejamos, por tanto, tenerlo a mano, echearle un vistazo inicial (después de haber leído los apuntes de este módulo, por supuesto) y utilices como referencia ante dudas serias.</p>
</div>
<div class="paragraph">
<p>Es posible utilizar JPA no sólo como parte de aplicaciones Java EE que corren en un servidor de aplicaciones, sino también como una librería de acceso a datos en una aplicación Java aislada (<em>standalone</em>). Lo haremos así en esta primera sesión de la asignatura.</p>
</div>
<div class="paragraph">
<p>La idea de trabajar con entidades persistentes ha estado presente en la Programación Orientada a Objetos desde sus comienzos. Este enfoque intenta aplicar las ideas de la POO a las bases de datos, de forma que las clases y los objetos de una aplicación puedan ser almacenados, modificados y buscados de forma eficiente en unidades de persistencia. Sin embargo, aunque desde comienzos de los 80 hubo aplicaciones que implementaban bases de datos orientadas a objetos de forma nativa, la idea nunca terminó de cuajar. La tecnología dominante en lo referente a bases de datos siempre han sido los sistemas de gestión de bases de datos relacionales (RDBMS). De ahí que la solución propuesta por muchas tecnologías para conseguir entidades persistentes haya sido realizar un <em>mapeado</em> del modelo de objetos al modelo relacional. JPA es una de estas tecnologías. El motor de JPA realiza una transformación en tiempo de compilación de las clases Java a tablas de la base de datos y viceversa. El <em>framework</em> también debe realizar transformaciones en tiempo de ejecución, convirtiendo actualizaciones y consultas realizadas sobre clases y objetos en sentencias SQL que ejecuta sobre la base de datos.</p>
</div>
<div class="paragraph">
<p>Una de las características principales de JPA es su simplicidad. JPA utiliza anotaciones y <em>configuración por defecto</em>, de forma que el desarrollador sólo tiene que especificar aquellas características que necesita que sean distintas de las de por defecto. Por ejemplo, JPA mapea una clase Java con una tabla de la base de datos usando la anotación <code>@Entity</code>. Por defecto el nombre de la tabla coincidirá con el nombre de la clase. Ahora bien, podemos modificar ese nombre utilizando anotaciones adicionales. En este caso <code>table(name="nombre-de-tabla")</code>.</p>
</div>
<div class="paragraph">
<p>JPA permite realizar el mapeo entre el esquema de datos y las clases Java de dos formas. Una es partir de un esquema de datos ya existente y construir las clases Java a partir de él. La otra es hacerlo al revés, definir las relaciones entre las clases Java mediante anotaciones y generar el esquema de la base de datos a partir de ellas. Para un proyecto nuevo es recomendable utilizar este último enfoque, ya que el modelo de clases es más restrictivo que los esquemas SQL y si lo hacemos al revés podemos encontrar algunas relaciones en SQL difíciles de expresar con JPA.</p>
</div>
<div class="paragraph">
<p>Las distintas versiones de JPA han ido haciendo cada vez más potente esta tecnología. Por ejemplo, JPA 2.0 incluyó:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Extensión de las opciones del mapeo objeto-relacional</p>
</li>
<li>
<p>Soporte para colecciones de objetos embebidos</p>
</li>
<li>
<p>Listas ordenadas</p>
</li>
<li>
<p>Combinación de tipos de acceso</p>
</li>
<li>
<p>API Criteria para la construcción de consultas</p>
</li>
<li>
<p>Metadata adicional para la generación de DDL (<em>Data Definition Language</em>)</p>
</li>
<li>
<p>Soporte para validación</p>
</li>
<li>
<p>Soporte para cache de objetos compartidos</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Y la última especificación JPA 2.1 ha incluido:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Conversores que permiten customizar el código de conversión entre los tipos de las clases java y los de la base de datos</p>
</li>
<li>
<p>Actualizaciones y borrados en bloque mediante el API Criteria</p>
</li>
<li>
<p>Consultas que ejecutan procedimientos almacenados en la base de datos</p>
</li>
<li>
<p>Generación del esquema</p>
</li>
<li>
<p>Grafos de entidades que permiten la recuperación o la mezcla parcial de objetos en memoria</p>
</li>
<li>
<p>Mejoras en el lenguaje de consultas JPQL/Criteria: subconsultas aritméticas, funciones genéricas de base de datos, cláusula <code>Join ON</code></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_implementaciones_de_jpa">1.1.3. Implementaciones de JPA</h4>
<div class="paragraph">
<p>JPA es un estándar aprobado en un JSR que necesita ser implementado por desarrolladores o empresas. Al ser una especificación incluida en Java EE cualquier servidor de aplicaciones compatible con Java EE debe proporcionar una implementación de este estándar.</p>
</div>
<div class="paragraph">
<p>Sólo las implementaciones más avanzadas han implementado a fecha de hoy la última versión 2.1 de la especificación. Las implementaciones más populares son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://hibernate.org/orm/documentation/">Hibernate</a> (JPA 2.1, usado por JBoss/WildFly - RedHat)</p>
</li>
<li>
<p><a href="http://www.eclipse.org/eclipselink/releases/2.5.php">EclipseLink</a> (JPA 2.1, usado por GlassFish - Oracle)</p>
</li>
<li>
<p><a href="http://openjpa.apache.org">OpenJPA</a> (JPA 2.0)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Vamos a usar la implementación de Hibernate, que es la utilizada en el servidor de aplicaciones WildFly y JBoss de RedHat. La gran aceptación de Hibernate en la comunidad de desarrolladores Java se refleja en que en la actualidad hay muchas empresas que utilizan Hibernate como capa de persistencia y no han dado todavía el salto a JPA. Es previsible que lo hagan próximamente.</p>
</div>
</div>
<div class="sect3">
<h4 id="_para_saber_más">1.1.4. Para saber más</h4>
<div class="paragraph">
<p>Las siguientes referencias proporcionan un complemento en profundidad de los conceptos vistos en estos apuntes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://www.hibernate.org/docs">Documentación de Hibernate</a>: Documentación en profundidad de Hibernate y JPA que incluye la <a href="http://docs.jboss.org/hibernate/orm/4.3/manual/en-US/html/">documentación de la versión 4.3.7 Final</a> que es compatible con JPA 2.1.</p>
</li>
<li>
<p><a href="https://jcp.org/en/jsr/detail?id=338">Especificación JPA 2.1</a>. Documento que especifica el estándar JPA 2.1. Contiene bastante código de ejemplo y no es difícil de leer.</p>
</li>
<li>
<p><a href="http://www.manning.com/bauer3/">Java Persistence with Hibernate, second edition</a>: Christian Bauer y Gavin King. Ed. Manning, 2015. Libro de referencia de JPA (2.1), con numerosos ejemplos tanto del estándar como de la implementación de Hibernate.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ejemplo_práctico_una_sencilla_aplicación_jpa">1.2. Ejemplo práctico: una sencilla aplicación JPA</h3>
<div class="paragraph">
<p>Vamos a presentar un primer ejemplo de aplicación JPA, que nos va a servir para introducir los conceptos principales de la librería. El ejemplo es muy sencillo, unos programas Java (aplicaciones <em>standalone</em> Java SE) que gestionan <strong>mensajes</strong> creados por <strong>autores</strong>. En la siguiente sesión implementaremos una sencilla versión web y explicaremos cómo utilizar JPA en aplicaciones web Java EE.</p>
</div>
<div class="paragraph">
<p>Definimos dos entidades JPA, <code>Autor</code> y <code>Mensaje</code> que se deben mapear con dos tablas de la base de datos. Deberemos representar la relación uno-a-muchos entre autor y mensajes. Un autor va a estar relacionado con todos los mensajes que ha creado. Todos los mensajes tendrán obligatoriamente un autor. Las entidades tendrán la siguiente información:</p>
</div>
<div class="paragraph">
<p>La entidad <code>Autor</code> almacena información de los autores de los mensajes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Long id</code>: identificador del autor</p>
</li>
<li>
<p><code>String correo</code>: correo electrónico del autor, que funcionará también como identificador</p>
</li>
<li>
<p><code>String nombre</code>: nombre del autor</p>
</li>
<li>
<p><code>Set&lt;Mensaje&gt; mensajes</code>: conjunto de mensajes que ha creado el autor</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La entidad <code>Mensaje</code> almacena la siguiente información:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Long id</code>: identificador del mensaje</p>
</li>
<li>
<p><code>Integer num</code>: número de mensaje del autor</p>
</li>
<li>
<p><code>String texto</code>: texto del mensaje</p>
</li>
<li>
<p><code>Date fecha</code>: fecha de creación del mensaje</p>
</li>
<li>
<p><code>Autor autor</code>: autor del mensaje</p>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa01/clases.png" alt="Entidades" width="50%">
</div>
</div>
<div class="paragraph">
<p>Al definir esta relación en JPA se realizará automáticamente un mapeo de estas entidades en dos tablas en la base de datos: <code>Autores</code> y <code>Mensajes</code>:</p>
</div>
<div class="paragraph">
<p>La tabla <code>Autores</code> contiene las siguientes columnas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>autor_id bigint not null</code>: clave primaria de la tabla, autoincrementada</p>
</li>
<li>
<p><code>correo varchar(255) not null</code></p>
</li>
<li>
<p><code>nombre varchar(255)</code>: nombre</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La tabla <code>Mensajes</code> contiene las siguientes columnas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>mensaje_id bigint not null</code>: clave primaria de la tabla, autoincrementada</p>
</li>
<li>
<p><code>texto varchar(255) not null</code></p>
</li>
<li>
<p><code>fecha datetime</code></p>
</li>
<li>
<p><code>autor bigint not null</code>: autor del mensaje, clave ajena que apunta a la columna email de la tabla de autores</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La siguiente figura muestra gráficamente las clases Java (<em>entidades</em>) y las tablas asociadas:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa01/tablas.png" alt="Tablas" width="50%">
</div>
</div>
<div class="paragraph">
<p>A continuación vamos a crear paso a paso todos los elementos del proyecto. Definiremos también algunos programas ejemplo para ilustrar el funcionamiento de distintos usos de JPA: creación de entidades, modificación, borrado y consulta. Todo ello en el proyecto llamado <code>mensajes</code>.</p>
</div>
<div class="sect3">
<h4 id="_configuración_del_proyecto_maven">1.2.1. Configuración del proyecto Maven</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Para entregar los ejercicios de la asignatura tienes que crear todos los proyectos en un único repositorio git que mantendrás sincronizado con Bitbucket. Para eso deberás hacer un <em>fork</em> del proyecto principal en el que se guardarán todos los <em>subproyectos</em> (módulos en la terminología de IntelliJ). En el apartado de ejercicios comentaremos paso a paso cómo hacerlo.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Este primer subproyecto (o módulo) lo crearemos con las siguientes coordenadas Maven:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>groupId: <code>org.expertojava.jpa</code></p>
</li>
<li>
<p>artifactId: <code>mensajes</code></p>
</li>
<li>
<p>packaging: <code>jar</code></p>
</li>
<li>
<p>name: <code>mensajes</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Las librerías necesarias para trabajar con Maven se pueden comprobar en el fichero POM del proyecto. Todas las versiones de todas las dependencias están actualizadas a la última versión disponible.</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tok-nt">&lt;project</span> <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://maven.apache.org/POM/4.0.0&quot;</span>
         <span class="tok-na">xmlns:xsi=</span><span class="tok-s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
         <span class="tok-na">xsi:schemaLocation=</span><span class="tok-s">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;modelVersion&gt;</span>4.0.0<span class="tok-nt">&lt;/modelVersion&gt;</span>

    <span class="tok-nt">&lt;groupId&gt;</span>org.expertojava.jpa<span class="tok-nt">&lt;/groupId&gt;</span>
    <span class="tok-nt">&lt;artifactId&gt;</span>mensajes<span class="tok-nt">&lt;/artifactId&gt;</span>
    <span class="tok-nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="tok-nt">&lt;/version&gt;</span>
    <span class="tok-nt">&lt;packaging&gt;</span>jar<span class="tok-nt">&lt;/packaging&gt;</span>

    <span class="tok-nt">&lt;name&gt;</span>mensajes<span class="tok-nt">&lt;/name&gt;</span>

    <span class="tok-nt">&lt;properties&gt;</span>
        <span class="tok-nt">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span class="tok-nt">&lt;/project.build.sourceEncoding&gt;</span>
    <span class="tok-nt">&lt;/properties&gt;</span>

    <span class="tok-nt">&lt;dependencies&gt;</span>

        <span class="tok-c">&lt;!-- Hibernate JPA --&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.hibernate.javax.persistence<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>hibernate-jpa-2.1-api<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>1.0.0.Final<span class="tok-nt">&lt;/version&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.hibernate<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>hibernate-entitymanager<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>4.3.7.Final<span class="tok-nt">&lt;/version&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-c">&lt;!-- DbUnit --&gt;</span>    <i class="conum" data-value="2"></i><b>(2)</b>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.dbunit<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>dbunit<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>2.5.0<span class="tok-nt">&lt;/version&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-c">&lt;!-- Driver MySQL --&gt;</span>    <i class="conum" data-value="3"></i><b>(3)</b>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>mysql<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>5.1.33<span class="tok-nt">&lt;/version&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-c">&lt;!-- Logging --&gt;</span> <i class="conum" data-value="4"></i><b>(4)</b>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.slf4j<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>slf4j-simple<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>1.7.12<span class="tok-nt">&lt;/version&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>log4j<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>log4j<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>1.2.17<span class="tok-nt">&lt;/version&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>commons-logging<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>commons-logging<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>1.2<span class="tok-nt">&lt;/version&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-c">&lt;!-- Hibernate validator --&gt;</span> <i class="conum" data-value="5"></i><b>(5)</b>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.hibernate<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>hibernate-validator<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>5.1.3.Final<span class="tok-nt">&lt;/version&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>
        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>javax.el<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>javax.el-api<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>2.2.4<span class="tok-nt">&lt;/version&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>
        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.glassfish.web<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>el-impl<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>2.2<span class="tok-nt">&lt;/version&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>
    <span class="tok-nt">&lt;/dependencies&gt;</span>
    <span class="tok-nt">&lt;/dependencies&gt;</span>

    <span class="tok-nt">&lt;build&gt;</span>
        <span class="tok-nt">&lt;finalName&gt;</span>${project.name}<span class="tok-nt">&lt;/finalName&gt;</span>
        <span class="tok-nt">&lt;plugins&gt;</span>
            <span class="tok-nt">&lt;plugin&gt;</span>
                <span class="tok-nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="tok-nt">&lt;/groupId&gt;</span>
                <span class="tok-nt">&lt;artifactId&gt;</span>maven-compiler-plugin<span class="tok-nt">&lt;/artifactId&gt;</span>
                <span class="tok-nt">&lt;version&gt;</span>3.1<span class="tok-nt">&lt;/version&gt;</span>
                <span class="tok-nt">&lt;configuration&gt;</span>
                    <span class="tok-nt">&lt;source&gt;</span>1.7<span class="tok-nt">&lt;/source&gt;</span>
                    <span class="tok-nt">&lt;target&gt;</span>1.7<span class="tok-nt">&lt;/target&gt;</span>
                <span class="tok-nt">&lt;/configuration&gt;</span>
            <span class="tok-nt">&lt;/plugin&gt;</span>
        <span class="tok-nt">&lt;/plugins&gt;</span>
    <span class="tok-nt">&lt;/build&gt;</span>

<span class="tok-nt">&lt;/project&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Hibernate JPA: librerías para usar Hibernate como una implementación de JPA y librería de log <code>slf4j-api</code> necesaria para Hibernate.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>DbUnit: librería <code>dbunit:2.5.0</code>, carga automáticamente la librería <code>junit:4.11</code> que necesita.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><em>Driver</em> MySQL para acceder a la base de datos MySQL desde JPA y desde DbUnit.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Hibernate necesita el fichero de logging <code>slf4j-simple.jar</code>, sobre el que definimos una configuración de logging basada en log4j.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Hibernate validator implementa la validación <em>Bean Validation</em> de las clases entidad.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En la siguiente imagen se muestran todas las librerías que finalmente se descarga Maven. Son librerías necesarias para que las anteriores librerías puedan funcionar:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa01/proyecto-jpa-mensajes.png" alt="Librerías Maven" width="50%">
</div>
</div>
<div class="paragraph">
<p>En la pestaña <em>Dependency Hierarchy</em> del POM podemos explorar las relaciones entre las distintas librerías.</p>
</div>
</div>
<div class="sect3">
<h4 id="_configuración_de_la_conexión_a_la_bd_de_intellij">1.2.2. Configuración de la conexión a la BD de IntelliJ</h4>
<div class="paragraph">
<p>JPA puede trabajar con cualquier gestor de bases de datos. En nuestro caso, hemos instalado en la máquina virtual el servidor MySQL configurado con el usuario <code>root</code> y la contraseña <code>expertojava</code>.</p>
</div>
<div class="paragraph">
<p>IntelliJ tiene un conjunto de herramientas muy útiles para trabajar con bases de datos. Se accede a ellas desde el panel <em>Database</em> situado en el lateral derecho:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Abre el panel <em>Database</em> en la parte derecha.</p>
</li>
<li>
<p>Crea una nueva conexión con la base de datos MySQL con la opción <em>+ &gt; Data Source &gt; MySQL</em></p>
</li>
<li>
<p>Inicializa los parámetros de la conexión, sólo tienes que indicar el usuario <code>root</code> y la contraseña <code>expertojava</code>. Aparecerá también un aviso indicando que no está descargado el driver de acceso a MySQL, pincha el enlace y lo descargará e instalará.</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa01/intellij-datasources.png" alt="" width="100%">
</div>
</div>
<div class="paragraph">
<p>Una vez configurada la conexión, vamos a utilizarla para crear la base de datos <code>jpa_mensajes</code> que vamos a utilizar en las primeras aplicaciones ejemplo que vamos a programar con JPA. En el panel de base de datos podremos ver un desplegable con las bases de datos existentes. Para crear la nueva base de datos abre la consola SQL pulsando el icono correspondiente del panel de base de datos:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa01/panel-base-datos.png" alt="" width="50%">
</div>
</div>
<div class="paragraph">
<p>Y ejecuta el comando:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-k">CREATE</span> <span class="tok-k">DATABASE</span> <span class="tok-n">jpa_mensajes</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Verás que se ha creado una base de datos con ese nombre bajo las ya existentes por defecto en MySQL. Con esto es suficiente para que podamos empezar a trabajar con JPA.</p>
</div>
</li>
<li>
<p>Por último, para que aparezca la base de datos recién creada bajo el icono de la fuente de datos MySQL es necesario seleccionarla en la pantalla de propiedades. Pulsa en el botón de propiedades de la fuente de datos (o selecciona con el botón derecho la opcion <em>Properties</em>) y entrarás en la ventana de configuración de la fuente de datos. Selecciona la pestaña <em>Schemas &amp; Tables</em> y escoge la base de datos <code>jpa_mensajes</code>:</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa01/database-jpa-mensajes.png" alt="" width="50%">
</div>
</div>
<div class="paragraph">
<p>Ahora ya podrás ver la base de datos (por ahora sin ninguna tabla) bajo el icono de la conexión a la fuente de datos:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa01/database-jpa-mensajes-icono.png" alt="" width="33%">
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Otra forma de crear la base de datos es hacerlo desde línea de comando:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> <span class="tok-nb">echo</span> <span class="tok-s2">&quot;CREATE DATABASE jpa_mensajes&quot;</span> &gt; create.sql
<span class="tok-gp">$</span> mysql -u root -p<span class="tok-s2">&quot;expertojava&quot;</span> &lt; create.sql</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_clases_entidad">1.2.3. Clases entidad</h4>
<div class="paragraph">
<p>Las clases de entidad (<em>entity classes</em>) se codifican como clases Java con campos, <em>getters</em>, <em>setters</em> y con los métodos <code>equals</code> y <code>hashcode</code> basados en claves propias naturales a los que se añaden anotaciones JPA para especificar el mapeado con las tablas correspondientes de la base de datos. Vamos a ver un primer ejemplo con las clases <code>Autor</code> y <code>Mensaje</code> y la relación una-a-muchos definida entre ellos. En las sesiones siguientes entraremos más a fondo a explicar las distintas anotaciones.</p>
</div>
<div class="sect4">
<h5 id="_autor">Autor</h5>
<div class="paragraph">
<p>Veamos la primera clase, <code>Autor</code>, que contiene alguna información sobre los autores que escriben los mensajes.</p>
</div>
<div class="paragraph">
<p>Debemos etiquetar la clase con la anotación <code>@Entity</code> para indicarle a JPA que se debe mapear con una tabla. Todos los atributos de la entidad se mapearán automáticamente con columnas de la tabla SQL. En esos atributos podemos añadir otras anotaciones que permiten configurar las distintas características de las columnas SQL. Estas anotaciones se pueden definir sobre el atributo o sobre los métodos <em>getters</em>. Una forma curiosa de organizar la estructura de una clase entidad es la que utilizan en la documentación de <a href="http://docs.jboss.org/hibernate/orm/4.3/manual/en-US/html_single/#mapping-declaration">Hibernate</a>, en la que agrupan atributo, <em>getter</em> y <em>setter</em>.</p>
</div>
<div class="paragraph">
<p>Definimos la clase en la paquete <code>org.expertojava.jpa.mensajes.modelo</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/expertojava/jpa/mensajes/modelo/Autor.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jpa</span><span class="tok-o">.</span><span class="tok-na">mensajes</span><span class="tok-o">.</span><span class="tok-na">modelo</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.HashSet</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.Set</span><span class="tok-o">;</span>

<span class="tok-nd">@Entity</span>  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Autor</span> <span class="tok-o">{</span>

    <span class="tok-nd">@Id</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-nd">@GeneratedValue</span>  <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s">&quot;autor_id&quot;</span><span class="tok-o">)</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="tok-n">Long</span> <span class="tok-n">id</span><span class="tok-o">;</span>
    <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;email&quot;</span><span class="tok-o">,</span> <span class="tok-n">nullable</span> <span class="tok-o">=</span> <span class="tok-kc">false</span><span class="tok-o">,</span> <span class="tok-n">unique</span> <span class="tok-o">=</span> <span class="tok-kc">true</span><span class="tok-o">)</span> <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">correo</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">;</span> <i class="conum" data-value="6"></i><b>(6)</b>
    <span class="tok-nd">@OneToMany</span><span class="tok-o">(</span><span class="tok-n">mappedBy</span> <span class="tok-o">=</span> <span class="tok-s">&quot;autor&quot;</span><span class="tok-o">,</span> <span class="tok-n">cascade</span> <span class="tok-o">=</span> <span class="tok-n">CascadeType</span><span class="tok-o">.</span><span class="tok-na">ALL</span><span class="tok-o">,</span> <span class="tok-n">fetch</span> <span class="tok-o">=</span> <span class="tok-n">FetchType</span><span class="tok-o">.</span><span class="tok-na">EAGER</span><span class="tok-o">)</span> <i class="conum" data-value="7"></i><b>(7)</b>
    <span class="tok-kd">private</span> <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Mensaje</span><span class="tok-o">&gt;</span> <span class="tok-n">mensajes</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">HashSet</span><span class="tok-o">&lt;</span><span class="tok-n">Mensaje</span><span class="tok-o">&gt;();</span>
    <span class="tok-nd">@Version</span> <i class="conum" data-value="8"></i><b>(8)</b>
    <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">version</span><span class="tok-o">;</span>

    <span class="tok-kd">public</span> <span class="tok-n">Long</span> <span class="tok-nf">getId</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">id</span><span class="tok-o">;</span> <span class="tok-o">}</span>
    <span class="tok-kd">private</span> <span class="tok-kt">void</span> <span class="tok-nf">setId</span><span class="tok-o">(</span><span class="tok-n">Long</span> <span class="tok-n">id</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">id</span> <span class="tok-o">=</span> <span class="tok-n">id</span><span class="tok-o">;</span> <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getCorreo</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">correo</span><span class="tok-o">;</span> <span class="tok-o">}</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setCorreo</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">correo</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">correo</span> <span class="tok-o">=</span> <span class="tok-n">correo</span><span class="tok-o">;</span> <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getNombre</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">nombre</span><span class="tok-o">;</span> <span class="tok-o">}</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setNombre</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">nombre</span> <span class="tok-o">=</span> <span class="tok-n">nombre</span><span class="tok-o">;</span> <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Mensaje</span><span class="tok-o">&gt;</span> <span class="tok-nf">getMensajes</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">mensajes</span><span class="tok-o">;</span> <span class="tok-o">}</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setMensajes</span><span class="tok-o">(</span><span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Mensaje</span><span class="tok-o">&gt;</span> <span class="tok-n">mensajes</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">mensajes</span> <span class="tok-o">=</span> <span class="tok-n">mensajes</span><span class="tok-o">;</span> <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-nf">Autor</span><span class="tok-o">()</span> <span class="tok-o">{</span> <i class="conum" data-value="9"></i><b>(9)</b>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-nf">Autor</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">,</span> <span class="tok-n">String</span> <span class="tok-n">correo</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">nombre</span> <span class="tok-o">=</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">correo</span> <span class="tok-o">=</span> <span class="tok-n">correo</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-kt">boolean</span> <span class="tok-nf">equals</span><span class="tok-o">(</span><span class="tok-n">Object</span> <span class="tok-n">o</span><span class="tok-o">)</span> <span class="tok-o">{</span> <i class="conum" data-value="10"></i><b>(10)</b>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-k">this</span> <span class="tok-o">==</span> <span class="tok-n">o</span><span class="tok-o">)</span> <span class="tok-k">return</span> <span class="tok-kc">true</span><span class="tok-o">;</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">o</span> <span class="tok-o">==</span> <span class="tok-kc">null</span> <span class="tok-o">||</span> <span class="tok-n">getClass</span><span class="tok-o">()</span> <span class="tok-o">!=</span> <span class="tok-n">o</span><span class="tok-o">.</span><span class="tok-na">getClass</span><span class="tok-o">())</span> <span class="tok-k">return</span> <span class="tok-kc">false</span><span class="tok-o">;</span>

        <span class="tok-n">Autor</span> <span class="tok-n">autor</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-n">Autor</span><span class="tok-o">)</span> <span class="tok-n">o</span><span class="tok-o">;</span>

        <span class="tok-k">return</span> <span class="tok-o">!(</span><span class="tok-n">id</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span> <span class="tok-o">?</span> <span class="tok-o">!</span><span class="tok-n">id</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">id</span><span class="tok-o">)</span> <span class="tok-o">:</span> <span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">id</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">);</span>

    <span class="tok-o">}</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-kt">int</span> <span class="tok-nf">hashCode</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">id</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span> <span class="tok-o">?</span> <span class="tok-n">id</span><span class="tok-o">.</span><span class="tok-na">hashCode</span><span class="tok-o">()</span> <span class="tok-o">:</span> <span class="tok-mi">0</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">toString</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-s">&quot;Autor{&quot;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;id=&quot;</span> <span class="tok-o">+</span> <span class="tok-n">id</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, correo=&#39;&quot;</span> <span class="tok-o">+</span> <span class="tok-n">correo</span> <span class="tok-o">+</span> <span class="tok-sc">&#39;\&#39;&#39;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, nombre=&#39;&quot;</span> <span class="tok-o">+</span> <span class="tok-n">nombre</span> <span class="tok-o">+</span> <span class="tok-sc">&#39;\&#39;&#39;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, mensajes=&quot;</span> <span class="tok-o">+</span> <span class="tok-n">mensajes</span> <span class="tok-o">+</span>
                <span class="tok-sc">&#39;}&#39;</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>@Entity</code>: La clase es una entidad que se va a mapear con una tabla de la base de datos. Los campos de la clase se mapearán con columnas de la base de datos. Por defecto el nombre de la tabla será el nombre de la clase Java. Se puede modificar usando la anotación <code>@Table</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>@Id</code>: indica que el campo anotado (en nuestro caso <code>Long id</code>) va a ser el identificador de la entidad. La columna con la que se mapea en la base de datos es la clave primaria de la tabla.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>@GeneratedValue</code>: El identificador se genera automáticamente por parte de la base de datos cuando la entidad se hace persistente.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>@Column</code>: Sirve para indicar características del esquema de la columna en la que se mapea el campo. El elemento <code>name</code> sirve para indicar el nombre de la columna en el mapeo. Si no estuviera, con un una columna con el nombre del atributo de la clase Java.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>En este caso, obligamos a que no la columna no sea <code>null</code>. Veremos que la columna <code>correo</code> de la tabla tendrá el modificador <code>NOT NULL</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Todos los atributos se mapean con campos de la tabla. En el caso de no utilizar la anotación <code>@Column</code> se mapea con un campo con el mismo nombre que el atributo.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td><code>@OneToMany</code>: Sirve para definir una relación uno-a-muchos entre <code>Autor</code> y <code>Mensaje</code>. La anotación <code>cascade</code> indica que las acciones de borrado, <em>persist</em> y <em>merge</em> se propagan en cascada a los mensajes. La anotación <code>@mappedBy</code> indica el atributo que define la clave ajena en el otro lado de la relación. Y la anotación <code>EAGER</code> indica que traeremos a memoria todos los mensajes con los que está relacionado el autor. Los veremos más adelante.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td><code>@Version</code>: Un atributo versión que usa JPA para implementar la gestión optimista de la concurrencia. Lo veremos en la última sesión.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Constructor vacío, necesario para JPA.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Métodos <code>equals</code> y <code>hashCode</code> basados en el identificador autogenerado.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Vemos que se trata de una clase normal Java con cuatro campos (<code>id</code>, <code>correo</code>, <code>nombre</code> y <code>mensajes</code>) y los métodos <em>get</em> y <em>set</em>. JPA mapea esta clase en una tabla de la base de datos utilizando las anotaciones comentadas anteriormente.</p>
</div>
<div class="paragraph">
<p>La implementación de Hibernate obliga a definir una pareja de métodos <code>get</code> y <code>set</code> para cada atributo. En el caso de la clave primaria, al ser generada automáticamente por la base de datos, definimos el método <code>set</code> como privado para que no pueda ser actualizado desde fuera de la clase. Los métodos <code>get</code> sirven para recuperar la información de un atributo de un objeto. Los métodos <code>set</code> sirven para actualizarlo. Cuando JPA sincronice el estado del objeto con la base de datos escribirá en ella los cambios realizados.</p>
</div>
<div class="paragraph">
<p>Hibernate obliga también a definir un constructor vacío en todas las entidades. Si no lo hacemos muestra un mensaje de error.</p>
</div>
<div class="paragraph">
<p>Además es necesario definir los métodos <code>equals</code> y <code>hashCode</code>, a parte del conveniente <code>toString</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_mensaje">Mensaje</h5>
<div class="paragraph">
<p>Veamos ahora la otra clase, <code>Mensaje</code>, con la información de los mensajes que crean los usuarios (identificador del mensaje, texto, fecha y usuario propietario del mensaje).</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/expertojava/jpa/mensajes/modelo/Autor.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jpa</span><span class="tok-o">.</span><span class="tok-na">mensajes</span><span class="tok-o">.</span><span class="tok-na">modelo</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.Date</span><span class="tok-o">;</span>

<span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Mensaje</span> <span class="tok-o">{</span>

    <span class="tok-nd">@Id</span>
    <span class="tok-nd">@GeneratedValue</span>
    <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s">&quot;mensaje_id&quot;</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">Long</span> <span class="tok-n">id</span><span class="tok-o">;</span>

    <span class="tok-nd">@NotNull</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-nd">@Size</span><span class="tok-o">(</span><span class="tok-n">min</span><span class="tok-o">=</span><span class="tok-mi">3</span><span class="tok-o">)</span>
    <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">nullable</span> <span class="tok-o">=</span> <span class="tok-kc">false</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">texto</span><span class="tok-o">;</span>

    <span class="tok-kd">private</span> <span class="tok-n">Date</span> <span class="tok-n">fecha</span><span class="tok-o">;</span>

    <span class="tok-nd">@ManyToOne</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-kd">private</span> <span class="tok-n">Autor</span> <span class="tok-n">autor</span><span class="tok-o">;</span>

    <span class="tok-nd">@Version</span>
    <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">version</span><span class="tok-o">;</span>

    <span class="tok-kd">public</span> <span class="tok-n">Long</span> <span class="tok-nf">getId</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">id</span><span class="tok-o">;</span> <span class="tok-o">}</span>
    <span class="tok-kd">private</span> <span class="tok-kt">void</span> <span class="tok-nf">setId</span><span class="tok-o">(</span><span class="tok-n">Long</span> <span class="tok-n">id</span><span class="tok-o">)</span> <span class="tok-o">{</span><span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">id</span> <span class="tok-o">=</span> <span class="tok-n">id</span><span class="tok-o">;}</span>

    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getTexto</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">texto</span><span class="tok-o">;</span> <span class="tok-o">}</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setTexto</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">texto</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">texto</span> <span class="tok-o">=</span> <span class="tok-n">texto</span><span class="tok-o">;</span> <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">Date</span> <span class="tok-nf">getFecha</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">fecha</span><span class="tok-o">;</span> <span class="tok-o">}</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setFecha</span><span class="tok-o">(</span><span class="tok-n">Date</span> <span class="tok-n">fecha</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">fecha</span> <span class="tok-o">=</span> <span class="tok-n">fecha</span><span class="tok-o">;</span> <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">Autor</span> <span class="tok-nf">getAutor</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">autor</span><span class="tok-o">;</span> <span class="tok-o">}</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setAutor</span><span class="tok-o">(</span><span class="tok-n">Autor</span> <span class="tok-n">autor</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">autor</span> <span class="tok-o">=</span> <span class="tok-n">autor</span><span class="tok-o">;</span> <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-nf">Mensaje</span><span class="tok-o">()</span> <span class="tok-o">{}</span>

    <span class="tok-kd">public</span> <span class="tok-nf">Mensaje</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">texto</span><span class="tok-o">,</span> <span class="tok-n">Autor</span> <span class="tok-n">autor</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">texto</span> <span class="tok-o">=</span> <span class="tok-n">texto</span><span class="tok-o">;</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">autor</span> <span class="tok-o">=</span> <span class="tok-n">autor</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>


    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">toString</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-s">&quot;Mensaje{&quot;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;id=&quot;</span> <span class="tok-o">+</span> <span class="tok-n">id</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, texto=&#39;&quot;</span> <span class="tok-o">+</span> <span class="tok-n">texto</span> <span class="tok-o">+</span> <span class="tok-sc">&#39;\&#39;&#39;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, fecha=&quot;</span> <span class="tok-o">+</span> <span class="tok-n">fecha</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, autor=&quot;</span> <span class="tok-o">+</span> <span class="tok-n">autor</span> <span class="tok-o">+</span>
                <span class="tok-sc">&#39;}&#39;</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>@NotNull</code> y <code>@Size</code> son dos anotaciones de <em>Bean Validation</em> que definen restricciones en el contenido del atributo. Ambas restricciones son mantenidas por JPA, lanzando excepciones si se produce una creación o actualización de una entidad que no las cumple.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>@ManyToOne</code>: Relación inversa que etiqueta un atributo de tipo <code>Autor</code>. El atributo se mapea en una columna de la tabla <code>Mensaje</code> en la que se guarda la clave ajena al autor asociado.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El fichero <code>Mensaje.java</code> define la clase entidad <code>Mensaje</code>. La entidad tiene los atributos <code>id</code> (identificador único del mensaje), <code>texto</code> (el texto del mensaje) y <code>autor</code> (el autor del mensaje, una instancia entidad de tipo <code>Autor</code> con la que se define la relación inversa a la definida en autor).</p>
</div>
<div class="paragraph">
<p>En el ejemplo estamos definiendo una relación uno a muchos entre autor y mensajes. Estas relaciones se definen en JPA definiendo campos del tipo de la otra entidad y anotándolos según el tipo de relación (uno-a-uno, uno-a-muchos o muchos-a-muchos). En nuestro ejemplo relacionamos un mensaje con el autor que lo ha escrito y el autor con todos sus mensajes. La definición de estas relaciones facilita mucho la programación porque evita la realización explícita de muchas consultas SQL. Por ejemplo, si en una consulta recuperamos una colección de mensajes, JPA recuperará al mismo tiempo el autor asociado y lo guardará en el campo <code>autor</code>. De esta forma podremos utilizarlo inmediatamente sin tener que realizar ninguna consulta adicional. Veremos un ejemplo.</p>
</div>
<div class="paragraph">
<p>La cardinalidad de la relación la definimos con la anotación <code>OneToMany</code> en el campo <code>mensajes</code> de <code>Autor</code> (un autor tiene una colección de mensajes) y su relación inversa <code>ManyToOne</code> en el campo <code>autor</code> de <code>Mensaje</code> (muchos mensajes pueden tener el mismo autor). Estas anotaciones sirven para realizar el mapeo de la relación a las tablas. En este caso se crea una clave ajena en la tabla de mensajes que apunta al autor de cada mensaje. Esto lo indicamos con la anotación <code>mappedBy</code> en el campo <code>mensajes</code> de la clase <code>Autor</code>. Si nos fijamos en el esquema SQL de la tabla de autores veremos que no hay ninguna columna mensajes en ella. La colección con los mensajes de un autor dado la construye JPA con una consulta SQL sobre la tabla de mensajes y utilizando la clave ajena definida por la anotación <code>mappedBy</code> (en este caso el campo <code>autor</code>).</p>
</div>
<div class="paragraph">
<p>La anotación <code>@ManyToOne</code> se coloca en el campo <code>autor</code> que contiene la relación inversa y que hace de clave ajena a la tabla de autores. En el mapeo con la base de datos, se el nombre de la columna asociada al campo se forma con el nombre del campo actual y el nombre de la columna referenciada (<code>autor_id</code>, la clave primaria de la tabla <code>Autor</code>). En este caso el nombre del campo es <code>autor_autor_id</code>.</p>
</div>
<div class="paragraph">
<p>En la clase <code>Mensaje</code> utilizamos la anotación <code>@ManyToOne</code> en el campo <code>autor</code>, indicando que muchos mensajes pueden pertenecer al mismo autor.</p>
</div>
<div class="paragraph">
<p>Veremos que para actualizar una relación uno a muchos como esta y añadir un mensaje a un autor hay que actualizar el atributo de la entidad que se mapea con al tabla que contiene la clave ajena. En este caso se trata de la entidad <code>Mensaje</code>, cuyo campo <code>autor</code> se mapea con la columna de la clave ajena de la tabla. Al crear un nuevo mensaje y hacerlo persistente ya estamos añadiendo un elemento nuevo a la relación y las consultas que se realicen sobre los mensajes de un autor devolverán el nuevo mensaje. Veremos que es necesario también actualizar en memoria la colección de mensajes del autor (JPA no lo hace automáticamente), para mantener consistente las relaciones entre entidades en memoria con la base de datos.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_el_fichero_persistence_xml_y_la_base_de_datos">1.2.4. El fichero persistence.xml y la base de datos</h4>
<div class="paragraph">
<p>El fichero <code>persistence.xml</code> es el fichero de configuración de JPA. En él se define, en un elemento denominado <code>persistence-unit</code> (unidad de persistencia), las clases de entidad que JPA debe mapear en la base de datos. En nuestro caso se trata de las clases <code>org.expertojava.jpa.mensajes.modelo.Autor</code> y <code>org.expertojava.jpa.mensajes.modelo.Mensaje</code>. También se especifica la conexión con la base de datos: el driver SQL que se utiliza, la URL, el gestor de base de datos (MySQL), así como el usuario y contraseña de acceso.</p>
</div>
<div class="paragraph">
<p>Este fichero de configuración debe encontrarse en el directorio <code>META-INF</code> dentro del <em>classpath</em> de la aplicación que se ejecuta. En nuestro caso, como estamos trabajando con una configuración de directorios definida por Maven, utilizaremos el directorio <code>recursos</code> de las clases de aplicación. Podríamos definir una configuración de test diferente añadiendo otro <code>persistence.xml</code> en el directorio de recursos de las clases de test.</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/persistence.xml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;persistence</span> <span class="tok-na">version=</span><span class="tok-s">&quot;2.1&quot;</span>
             <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://xmlns.jcp.org/xml/ns/persistence&quot;</span>
             <span class="tok-na">xmlns:xsi=</span><span class="tok-s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
             <span class="tok-na">xsi:schemaLocation=</span><span class="tok-s">&quot;http://xmlns.jcp.org/xml/ns/persistence&quot;</span><span class="tok-nt">&gt;</span>

    <span class="tok-nt">&lt;persistence-unit</span> <span class="tok-na">name=</span><span class="tok-s">&quot;mensajes-mysql&quot;</span> <i class="conum" data-value="1"></i><b>(1)</b>
    		      <span class="tok-na">transaction-type=</span><span class="tok-s">&quot;RESOURCE_LOCAL&quot;</span><span class="tok-nt">&gt;</span> <i class="conum" data-value="2"></i><b>(2)</b>

        <span class="tok-nt">&lt;provider&gt;</span>org.hibernate.jpa.HibernatePersistenceProvider<span class="tok-nt">&lt;/provider&gt;</span>
        <span class="tok-nt">&lt;class&gt;</span>org.expertojava.jpa.mensajes.modelo.Autor<span class="tok-nt">&lt;/class&gt;</span> <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-nt">&lt;class&gt;</span>org.expertojava.jpa.mensajes.modelo.Mensaje<span class="tok-nt">&lt;/class&gt;</span>

        <span class="tok-nt">&lt;validation-mode&gt;</span>CALLBACK<span class="tok-nt">&lt;/validation-mode&gt;</span> <i class="conum" data-value="4"></i><b>(4)</b>

        <span class="tok-nt">&lt;properties&gt;</span>

            <span class="tok-c">&lt;!-- JPA properties --&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;javax.persistence.jdbc.driver&quot;</span>
                      <span class="tok-na">value=</span><span class="tok-s">&quot;com.mysql.jdbc.Driver&quot;</span><span class="tok-nt">/&gt;</span>  <i class="conum" data-value="5"></i><b>(5)</b>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;javax.persistence.jdbc.url&quot;</span>
                      <span class="tok-na">value=</span><span class="tok-s">&quot;jdbc:mysql://localhost:3306/jpa_mensajes&quot;</span><span class="tok-nt">/&gt;</span> <i class="conum" data-value="6"></i><b>(6)</b>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;javax.persistence.jdbc.user&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;root&quot;</span><span class="tok-nt">/&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;javax.persistence.jdbc.password&quot;</span>
                      <span class="tok-na">value=</span><span class="tok-s">&quot;expertojava&quot;</span><span class="tok-nt">/&gt;</span>

            <span class="tok-c">&lt;!-- Hibernate properties --&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.dialect&quot;</span>
                      <span class="tok-na">value=</span><span class="tok-s">&quot;org.hibernate.dialect.MySQLDialect&quot;</span><span class="tok-nt">/&gt;</span> <i class="conum" data-value="7"></i><b>(7)</b>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.show_sql&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;true&quot;</span><span class="tok-nt">/&gt;</span> <i class="conum" data-value="8"></i><b>(8)</b>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.format_sql&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;false&quot;</span><span class="tok-nt">/&gt;</span>

            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.hbm2ddl.auto&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;update&quot;</span><span class="tok-nt">/&gt;</span> <i class="conum" data-value="9"></i><b>(9)</b>
        <span class="tok-nt">&lt;/properties&gt;</span>
    <span class="tok-nt">&lt;/persistence-unit&gt;</span>
<span class="tok-nt">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Nombre de la unidad de persistencia, necesario para cargarla desde la aplicación.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Estrategia de gestión de la transacción. En este caso <code>RESOURCE_LOCAL</code> que indica que utilizaremos la gestión de transacciones de la propia base de datos (lo veremos más adelante: por defecto en JPA el <code>AUTOCOMMIT</code> se define como <code>false</code> y hay que gestionar las transacciones de forma explícita).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Clases que van a hacerse persistentes en forma de tablas.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>En el modo <code>CALLBACK</code> debe estar presente un proveedor de persistencia que realice la validación de las restricciones <em>Bean Validation</em>. Si no, se genera un error. Otros modos son: <code>AUTO</code> (se realiza la validación si el proveedor de persistencia tiene esa capacidad) o <code>NONE</code> (no se realiza validación). El proveedor de persistencia que estamos usando, Hibernate, sí que implementa la validación.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Clase Java que define el conector con la BD,  el conector JDBC <code>com.mysql.jdbc.Driver</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>URL de la conexión a la BD y base de datos a la que conectarnos, en nuestro caso la base de datos creada anteriormente <code>jpa_mensajes</code> a la que se accede con la conexión <code>jdbc:mysql://localhost:3306/jpa_mensajes</code>. A continuación se especifican el usuario y contraseña para la conexión.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Dialecto SQL, necesario para optimizar las sentencias SQL con las que Hibernate gestiona los datos.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Parámetro que activa o desactiva el <em>logeo</em> de las sentencias SQL que va realizando Hibernate.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Parámetro que indica la forma de actualizar las tablas cuando se pone en marcha JPA. Se explica a continuación.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El parámetro <code>hibernate.hbm2ddl.auto</code> es muy importante. Determina cómo se van a actualizar las tablas de la base de datos cuando Hibernate intente mapearlas con las clases Java. Los posibles valores son los siguientes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>update</code>: se actualiza el esquema de las tablas si ha habido algún cambio en las clases Java. Si no existen, se crean.</p>
</li>
<li>
<p><code>validate</code>: se valida que el esquema se puede mapear correctamente con las clases Java. No se cambia nada de la base de datos.</p>
</li>
<li>
<p><code>create</code>: se crea el esquema, destruyendo los datos previos.</p>
</li>
<li>
<p><code>create-drop</code>: se crea el esquema y se elimina al final de la sesión.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Es aconsejable utilizar el valor <code>create</code> en entornos de test, <code>update</code> en desarrollo y el <code>validate</code> en producción. Inicialmente, antes de ejecutar el primer programa, lo vamos a definir como <code>update</code> para probar a crear las tablas y comprobar cuál es el esquema de datos generado.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_generación_del_esquema_de_datos_con_intellij">Generación del esquema de datos con IntelliJ</h5>
<div class="paragraph">
<p>Para probar el mapeo de las clases entidad con las tablas de la base de datos podemos ejecutar un sencillo programa Java que cargue la unidad de persistencia. Como el parámetro <code>hibernate.hbm2ddl.auto</code> está en modo <code>update</code> si la base de datos está vacía, creará todas las tablas definidas, en este caso <code>Autor</code> y <code>Mensajes</code>.</p>
</div>
<div class="paragraph">
<p>Para eso vamos a hacer un pequeño test. En <code>src/test/java/</code> podemos crear la clase <code>org.expertojava.jpa.mensajes.TestEmf</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/org/expertojava/jpa/mensajes/TestEmf.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jpa</span><span class="tok-o">.</span><span class="tok-na">mensajes</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.junit.Test</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManager</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManagerFactory</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.Persistence</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">junit</span><span class="tok-o">.</span><span class="tok-na">Assert</span><span class="tok-o">.*;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">TestEmf</span> <span class="tok-o">{</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">createEntityManagerTest</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">EntityManagerFactory</span> <span class="tok-n">emf</span> <span class="tok-o">=</span>
                <span class="tok-n">Persistence</span><span class="tok-o">.</span><span class="tok-na">createEntityManagerFactory</span><span class="tok-o">(</span><span class="tok-s">&quot;mensajes-mysql&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">assertNotNull</span><span class="tok-o">(</span><span class="tok-n">em</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El test pasa correctamente y en el método <code>createEntityManagerFactory</code> se crean en la base de datos las tablas definidas en la unidad de persistencia. Podemos comprobarlo en el panel <em>Database</em>, refrescando la fuente de datos y desplegando el menú de la base de datos <code>jpa_mensajes</code>:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa01/tablas-base-datos.png" alt="" width="33%">
</div>
</div>
<div class="paragraph">
<p>Podemos generar el esquema de datos desde el panel <em>Database</em> de IntelliJ. Hay que pulsar el botón derecho sobre la base de datos y seleccionar la opción <em>Copy DDL</em> para copiar el esquema de datos al portapapeles. En nuestro caso es el siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-k">CREATE</span> <span class="tok-k">TABLE</span> <span class="tok-n">Autor</span>
<span class="tok-p">(</span>
    <span class="tok-n">autor_id</span> <span class="tok-nb">BIGINT</span> <span class="tok-k">PRIMARY</span> <span class="tok-k">KEY</span> <span class="tok-k">NOT</span> <span class="tok-k">NULL</span> <span class="tok-n">AUTO_INCREMENT</span><span class="tok-p">,</span>
    <span class="tok-n">email</span> <span class="tok-nb">VARCHAR</span><span class="tok-p">(</span><span class="tok-mi">255</span><span class="tok-p">)</span> <span class="tok-k">NOT</span> <span class="tok-k">NULL</span><span class="tok-p">,</span>
    <span class="tok-n">nombre</span> <span class="tok-nb">VARCHAR</span><span class="tok-p">(</span><span class="tok-mi">255</span><span class="tok-p">),</span>
    <span class="tok-k">version</span> <span class="tok-nb">INT</span> <span class="tok-k">NOT</span> <span class="tok-k">NULL</span>
<span class="tok-p">);</span>
<span class="tok-k">CREATE</span> <span class="tok-k">TABLE</span> <span class="tok-n">Mensaje</span>
<span class="tok-p">(</span>
    <span class="tok-n">mensaje_id</span> <span class="tok-nb">BIGINT</span> <span class="tok-k">PRIMARY</span> <span class="tok-k">KEY</span> <span class="tok-k">NOT</span> <span class="tok-k">NULL</span> <span class="tok-n">AUTO_INCREMENT</span><span class="tok-p">,</span>
    <span class="tok-n">fecha</span> <span class="tok-n">DATETIME</span><span class="tok-p">,</span>
    <span class="tok-n">texto</span> <span class="tok-nb">VARCHAR</span><span class="tok-p">(</span><span class="tok-mi">255</span><span class="tok-p">)</span> <span class="tok-k">NOT</span> <span class="tok-k">NULL</span><span class="tok-p">,</span>
    <span class="tok-k">version</span> <span class="tok-nb">INT</span> <span class="tok-k">NOT</span> <span class="tok-k">NULL</span><span class="tok-p">,</span>
    <span class="tok-n">autor</span> <span class="tok-nb">BIGINT</span> <span class="tok-k">NOT</span> <span class="tok-k">NULL</span>
<span class="tok-p">);</span>
<span class="tok-k">CREATE</span> <span class="tok-k">UNIQUE</span> <span class="tok-k">INDEX</span> <span class="tok-n">UK_b9rqydwsclpsfivfgus4rq227</span> <span class="tok-k">ON</span> <span class="tok-n">Autor</span> <span class="tok-p">(</span><span class="tok-n">email</span><span class="tok-p">);</span>
<span class="tok-k">ALTER</span> <span class="tok-k">TABLE</span> <span class="tok-n">Mensaje</span> <span class="tok-k">ADD</span> <span class="tok-k">FOREIGN</span> <span class="tok-k">KEY</span> <span class="tok-p">(</span><span class="tok-n">autor</span><span class="tok-p">)</span> <span class="tok-k">REFERENCES</span> <span class="tok-n">Autor</span> <span class="tok-p">(</span><span class="tok-n">autor_id</span><span class="tok-p">);</span>
<span class="tok-k">CREATE</span> <span class="tok-k">INDEX</span> <span class="tok-n">FK_1n8x4ku41yquct34o1yjs5ud0</span> <span class="tok-k">ON</span> <span class="tok-n">Mensaje</span> <span class="tok-p">(</span><span class="tok-n">autor</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por último, para evitar mensajes de error de IntelliJ, debemos asegurarnos de actualizar la <em>faceta</em> JPA y de asociarle la fuente de datos recién creada:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Seleccionamos <em>Project Structure</em> y nos aseguramos de que la faceta JPA está configurada en el módulo que estamos usando y que está correctamente definida la ruta del fichero <code>persistence.xml</code>:</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa01/jpa-facet.png" alt="" width="100%">
</div>
</div>
</li>
<li>
<p>Y asociamos la fuente de datos recién creada a la configuración de JPA, usando el panel <code>persistence</code>, seleccionando el módulo y la opción <em>Assign Data Sources&#8230;&#8203;</em>:</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa01/panel-persistencia.png" alt="" width="66%">
</div>
</div>
<div class="paragraph">
<p>Y añadimos después la fuente de datos recién creada a la unidad de persistencia <code>mensajes-mysql</code>:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa01/assign-data-sources.png" alt="" width="50%">
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ficheros_de_configuración_de_logging">1.2.5. Ficheros de configuración de logging</h4>
<div class="paragraph">
<p>Los siguientes ficheros definen la configuración del log. Definen como librería de logging <code>Log4JLogger</code> y configuran los logs para que se muestren los niveles de log <code>INFO</code> en adelante (se pueden cambiar a <code>ERROR</code> o <code>DEBUG</code> si se quiere menos o más mensajes).</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/commons-logging.properties</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="properties"><span class="tok-na">org.apache.commons.logging.Log</span><span class="tok-o">=</span><span class="tok-s">org.apache.commons.logging.impl.Log4JLogger</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/resources/log4j.properties</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="properties"><span class="tok-c"># Coloca el nivel root del logger en INFO (muestra mensajes de INFO hacia arriba)</span>
<span class="tok-na">log4j.rootLogger</span><span class="tok-o">=</span><span class="tok-s">INFO, A1</span>

<span class="tok-c"># A1 se redirige a la consola</span>
<span class="tok-na">log4j.appender.A1</span><span class="tok-o">=</span><span class="tok-s">org.apache.log4j.ConsoleAppender</span>
<span class="tok-na">log4j.appender.stdout.Target</span><span class="tok-o">=</span><span class="tok-s">System.out</span>
<span class="tok-na">log4j.appender.A1.layout</span><span class="tok-o">=</span><span class="tok-s">org.apache.log4j.PatternLayout</span>
<span class="tok-na">log4j.appender.A1.layout.ConversionPattern</span><span class="tok-o">=</span><span class="tok-s">%d{dd/MM/yyyy HH:mm:ss} - %p - %m %n</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_programas_java_em_standalone_em_que_trabajan_con_jpa">1.2.6. Programas Java <em>standalone</em> que trabajan con JPA</h4>
<div class="paragraph">
<p>Vamos a ver cuatro ejemplos de programas Java <em>standalone</em> que muestran el funcionamiento básico de una aplicación JPA:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Programa <code>NuevoAutorMensaje</code>: programa que pide por la consola un nuevo autor y un nuevo mensaje y que crea esos nuevo registros en la bD</p>
</li>
<li>
<p>Programa <code>NuevoMensaje</code>: programa que pide por la consola un identificador de autor ya creado y un nuevo mensaje, y añade el mensaje al autor</p>
</li>
<li>
<p>Programa <code>MensajesAutor</code>: programa que lista todos los mensajes de un autor</p>
</li>
<li>
<p>Programa <code>BuscaMensajes</code>: programa que realiza una consulta buscando aquellos mensajes que contienen una cadena que se introduce por la consola</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_programa_nuevoautormensaje">Programa NuevoAutorMensaje</h5>
<div class="paragraph">
<p>Veamos el primer ejemplo de programa Java que usa las clases definidas anteriormente. En él comprobaremos las sentencias JPA necesarias para crear nuevas instancias de entidad y hacerlas persistentes en la base de datos.</p>
</div>
<div class="paragraph">
<p>En primer lugar vamos a ver la clase <code>org.expertojava.jpa.main.NuevoAutorMensaje</code> que pide un correo electrónico (identificador del autor) por la entrada estándar, busca la entidad asociada y si la encuentra solicita un mensaje y lo añade. En el caso en que el autor no existiera se crea un autor nuevo.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/expertojava/jpa/mensajes/main/NuevoAutorMensaje.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jpa</span><span class="tok-o">.</span><span class="tok-na">mensajes</span><span class="tok-o">.</span><span class="tok-na">main</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jpa.mensajes.modelo.Autor</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jpa.mensajes.modelo.Mensaje</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManager</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManagerFactory</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.Persistence</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.io.BufferedReader</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.io.IOException</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.io.InputStreamReader</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.Date</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">NuevoAutorMensaje</span> <span class="tok-o">{</span>

    <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-kt">void</span> <span class="tok-nf">main</span><span class="tok-o">(</span><span class="tok-n">String</span><span class="tok-o">[]</span> <span class="tok-n">args</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">Autor</span> <span class="tok-n">autor</span><span class="tok-o">;</span>

        <span class="tok-n">EntityManagerFactory</span> <span class="tok-n">emf</span> <span class="tok-o">=</span> <span class="tok-n">Persistence</span>
                <span class="tok-o">.</span><span class="tok-na">createEntityManagerFactory</span><span class="tok-o">(</span><span class="tok-s">&quot;mensajes-mysql&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>

        <span class="tok-k">try</span> <span class="tok-o">{</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">begin</span><span class="tok-o">();</span>

            <span class="tok-n">String</span> <span class="tok-n">email</span> <span class="tok-o">=</span> <span class="tok-n">leerTexto</span><span class="tok-o">(</span><span class="tok-s">&quot;Introduce el correo electrónico: &quot;</span><span class="tok-o">);</span>
            <span class="tok-n">String</span> <span class="tok-n">nombre</span> <span class="tok-o">=</span> <span class="tok-n">leerTexto</span><span class="tok-o">(</span><span class="tok-s">&quot;Introduce nombre: &quot;</span><span class="tok-o">);</span>

            <span class="tok-n">autor</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Autor</span><span class="tok-o">(</span><span class="tok-n">nombre</span><span class="tok-o">,</span> <span class="tok-n">email</span><span class="tok-o">);</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">persist</span><span class="tok-o">(</span><span class="tok-n">autor</span><span class="tok-o">);</span>
            <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;Identificador del autor: &quot;</span> <span class="tok-o">+</span> <span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">getId</span><span class="tok-o">());</span>

            <span class="tok-n">String</span> <span class="tok-n">mensajeStr</span> <span class="tok-o">=</span> <span class="tok-n">leerTexto</span><span class="tok-o">(</span><span class="tok-s">&quot;Introduce mensaje: &quot;</span><span class="tok-o">);</span>

            <span class="tok-n">Mensaje</span> <span class="tok-n">mens</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Mensaje</span><span class="tok-o">(</span><span class="tok-n">mensajeStr</span><span class="tok-o">,</span> <span class="tok-n">autor</span><span class="tok-o">);</span>
            <span class="tok-n">mens</span><span class="tok-o">.</span><span class="tok-na">setFecha</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">Date</span><span class="tok-o">());</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">persist</span><span class="tok-o">(</span><span class="tok-n">mens</span><span class="tok-o">);</span>
            <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;Identificador del mensaje: &quot;</span> <span class="tok-o">+</span> <span class="tok-n">mens</span><span class="tok-o">.</span><span class="tok-na">getId</span><span class="tok-o">());</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">();</span>
        <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">Exception</span> <span class="tok-n">ex</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">rollback</span><span class="tok-o">();</span>
            <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;Error: &quot;</span> <span class="tok-o">+</span> <span class="tok-n">ex</span><span class="tok-o">.</span><span class="tok-na">getMessage</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-s">&quot;\n\n&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">ex</span><span class="tok-o">.</span><span class="tok-na">printStackTrace</span><span class="tok-o">();</span>
        <span class="tok-o">}</span> <span class="tok-k">finally</span> <span class="tok-o">{</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
            <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">static</span> <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-nf">leerTexto</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">mensaje</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">String</span> <span class="tok-n">texto</span><span class="tok-o">;</span>
        <span class="tok-k">try</span> <span class="tok-o">{</span>
            <span class="tok-n">BufferedReader</span> <span class="tok-n">in</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">BufferedReader</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">InputStreamReader</span><span class="tok-o">(</span>
                    <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">in</span><span class="tok-o">));</span>
            <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">print</span><span class="tok-o">(</span><span class="tok-n">mensaje</span><span class="tok-o">);</span>
            <span class="tok-n">texto</span> <span class="tok-o">=</span> <span class="tok-n">in</span><span class="tok-o">.</span><span class="tok-na">readLine</span><span class="tok-o">();</span>
        <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">IOException</span> <span class="tok-n">e</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">texto</span> <span class="tok-o">=</span> <span class="tok-s">&quot;Error&quot;</span><span class="tok-o">;</span>
        <span class="tok-o">}</span>
        <span class="tok-k">return</span> <span class="tok-n">texto</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Se comienza creando un <code>EntityManagerFactory</code> que carga la unidad de persistencia. Esto es bastante costoso y debería hacerse sólo una vez, al arrancar la aplicación.</p>
</div>
<div class="paragraph">
<p>A partir del <code>EntityManagerFactory</code> se crea un <code>EntityManager</code>, el objeto de JPA que gestiona las entidades, los contextos de persistencia y las transacciones. Un contexto de persistencia es similar a una conexión a la base de datos. Es muy barato de obtener a partir del <code>EntityManagerFactory</code>.</p>
</div>
<div class="paragraph">
<p>La unidad de trabajo habitual en JPA con Java SE consiste en:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crear un <em>entity manager</em> a partir del <em>EntityManagerFactory</em>.</p>
</li>
<li>
<p>Marcar el comienzo de la transacción.</p>
</li>
<li>
<p>Realizar operaciones sobre las entidades.</p>
</li>
<li>
<p>Cerrar la transacción y el <em>entity manager</em>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Todas las entidades que se crean en un <em>entity manager</em> son gestionadas por él y viven en su <em>contexto de persistencia</em>. Cuando el entity manager se cierra, las entidades siguen existiendo como objetos Java, pero a partir de ese momento se encuentran desconectadas (<em>detached</em>) de la base de datos.</p>
</div>
<div class="paragraph">
<p>Cuando están gestionadas por el <em>entity manager</em>, JPA gestiona los cambios que se producen en las entidades, utiliza el proveedor de persistencia para generar las sentencias SQL asociadas a los cambios y vuelca (<em>flush</em>) esas sentencias en la base de datos.</p>
</div>
<div class="paragraph">
<p>El ejecución de los comandos SQL en la base de datos se realizan dependiendo del modo de actualización del <em>entity manager</em>. Por defecto el modo es <code>AUTO</code> y es el proveedor de persistencia (en nuestro caso, Hibernate) el que decide cuándo ejecutar los comandos en la base de datos. En el caso de Hibernate, se hace de forma inmediata. Puedes comprobarlo si está activado el log que muestra las sentencias SQL. Si está en modo <code>COMMIT</code> las sentencias se envían a la base de datos al realizar el commit de la transacción.</p>
</div>
<div class="paragraph">
<p>Podemos comprobar también en el ejemplo que el <em>entity manager</em> es quien proporciona los métodos para trabajar con la base de datos, añadiendo nuevos objetos, ejecutando consultas, etc. Por ejemplo, el método <code>persist</code> hace persistente en la base de datos el objeto que se le pasa como parámetro.</p>
</div>
<div class="paragraph">
<p>Podemos ejecutar el programa desde IntelliJ o desde línea de comandos usando el plugin <code>exec</code> de Maven:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bahs session">$ cd jpa-expertojava/mensajes
$ mvn install
$ mvn exec:java -Dexec.mainClass=org.expertojava.jpa.main.NuevoAutorMensaje</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_programa_nuevomensaje">Programa NuevoMensaje</h5>
<div class="paragraph">
<p>A continuación vemos un programa en el que se muestra cómo añadir un mensaje a un autor ya existente. Es un ejemplo de utilización de la recuperación de entidades por clave primaria.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/expertojava/jpa/mensajes/main/NuevoMensaje.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jpa</span><span class="tok-o">.</span><span class="tok-na">mensajes</span><span class="tok-o">.</span><span class="tok-na">main</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jpa.mensajes.modelo.Autor</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jpa.mensajes.modelo.Mensaje</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManager</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManagerFactory</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.Persistence</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.io.BufferedReader</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.io.IOException</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.io.InputStreamReader</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.Date</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">NuevoMensaje</span> <span class="tok-o">{</span>
    <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-kt">void</span> <span class="tok-nf">main</span><span class="tok-o">(</span><span class="tok-n">String</span><span class="tok-o">[]</span> <span class="tok-n">args</span><span class="tok-o">)</span> <span class="tok-o">{</span>

        <span class="tok-n">EntityManagerFactory</span> <span class="tok-n">emf</span> <span class="tok-o">=</span> <span class="tok-n">Persistence</span>
                <span class="tok-o">.</span><span class="tok-na">createEntityManagerFactory</span><span class="tok-o">(</span><span class="tok-s">&quot;mensajes-mysql&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">begin</span><span class="tok-o">();</span>

        <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;--Añadiendo mensaje a un usuario&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">Long</span> <span class="tok-n">idAutor</span> <span class="tok-o">=</span> <span class="tok-n">Long</span>
                <span class="tok-o">.</span><span class="tok-na">valueOf</span><span class="tok-o">(</span>
                        <span class="tok-n">leerTexto</span><span class="tok-o">(</span><span class="tok-s">&quot;Introduce identificador de usuario: &quot;</span><span class="tok-o">));</span>
        <span class="tok-n">Autor</span> <span class="tok-n">autor</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Autor</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-n">idAutor</span><span class="tok-o">);</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">autor</span> <span class="tok-o">==</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;Usuario no existente&quot;</span><span class="tok-o">);</span>
        <span class="tok-o">}</span> <span class="tok-k">else</span> <span class="tok-o">{</span>
            <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;Usuario &quot;</span> <span class="tok-o">+</span> <span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">getNombre</span><span class="tok-o">());</span>
            <span class="tok-n">String</span> <span class="tok-n">mensajeStr</span> <span class="tok-o">=</span> <span class="tok-n">leerTexto</span><span class="tok-o">(</span><span class="tok-s">&quot;Introduce mensaje: &quot;</span><span class="tok-o">);</span>
            <span class="tok-n">Mensaje</span> <span class="tok-n">mens</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Mensaje</span><span class="tok-o">(</span><span class="tok-n">mensajeStr</span><span class="tok-o">,</span> <span class="tok-n">autor</span><span class="tok-o">);</span>
            <span class="tok-n">mens</span><span class="tok-o">.</span><span class="tok-na">setFecha</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">Date</span><span class="tok-o">());</span>
            <span class="tok-n">mens</span><span class="tok-o">.</span><span class="tok-na">setAutor</span><span class="tok-o">(</span><span class="tok-n">autor</span><span class="tok-o">);</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">persist</span><span class="tok-o">(</span><span class="tok-n">mens</span><span class="tok-o">);</span>
            <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span>
                    <span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;Identificador del mensaje: &quot;</span> <span class="tok-o">+</span> <span class="tok-n">mens</span><span class="tok-o">.</span><span class="tok-na">getId</span><span class="tok-o">());</span>
        <span class="tok-o">}</span>

        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">();</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
        <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">static</span> <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-nf">leerTexto</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">mensaje</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">String</span> <span class="tok-n">texto</span><span class="tok-o">;</span>
        <span class="tok-k">try</span> <span class="tok-o">{</span>
            <span class="tok-n">BufferedReader</span> <span class="tok-n">in</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">BufferedReader</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">InputStreamReader</span><span class="tok-o">(</span>
                    <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">in</span><span class="tok-o">));</span>
            <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">print</span><span class="tok-o">(</span><span class="tok-n">mensaje</span><span class="tok-o">);</span>
            <span class="tok-n">texto</span> <span class="tok-o">=</span> <span class="tok-n">in</span><span class="tok-o">.</span><span class="tok-na">readLine</span><span class="tok-o">();</span>
        <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">IOException</span> <span class="tok-n">e</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">texto</span> <span class="tok-o">=</span> <span class="tok-s">&quot;Error&quot;</span><span class="tok-o">;</span>
        <span class="tok-o">}</span>
        <span class="tok-k">return</span> <span class="tok-n">texto</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Vemos que la recuperación de un autor a partir de su clave primaria se hace con el método <code>find</code> del entity manager, pasando como parámetro la clase de entidad que queremos recuperar y el valor de la clave primaria. El método devuelve <code>null</code> si no existe esa entidad.</p>
</div>
</div>
<div class="sect4">
<h5 id="_programa_mensajesautor">Programa MensajesAutor</h5>
<div class="paragraph">
<p>A continuación presentamos el programa que lista los mensajes añadidos a un determinado autor. Es un ejemplo de utilización de la relación a-muchos que hemos definido entre un autor y sus mensajes.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/expertojava/jpa/mensajes/main/MensajesAutor.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jpa</span><span class="tok-o">.</span><span class="tok-na">mensajes</span><span class="tok-o">.</span><span class="tok-na">main</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jpa.mensajes.modelo.Autor</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jpa.mensajes.modelo.Mensaje</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManager</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManagerFactory</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.Persistence</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.io.BufferedReader</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.io.IOException</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.io.InputStreamReader</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">MensajesAutor</span> <span class="tok-o">{</span>
    <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-kt">void</span> <span class="tok-nf">main</span><span class="tok-o">(</span><span class="tok-n">String</span><span class="tok-o">[]</span> <span class="tok-n">args</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">EntityManagerFactory</span> <span class="tok-n">emf</span> <span class="tok-o">=</span> <span class="tok-n">Persistence</span>
                <span class="tok-o">.</span><span class="tok-na">createEntityManagerFactory</span><span class="tok-o">(</span><span class="tok-s">&quot;mensajes-mysql&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-k">try</span> <span class="tok-o">{</span>
            <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;--Buscando mensajes de autor&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">Long</span> <span class="tok-n">idAutor</span> <span class="tok-o">=</span> <span class="tok-n">Long</span>
                    <span class="tok-o">.</span><span class="tok-na">valueOf</span><span class="tok-o">(</span>
                            <span class="tok-n">leerTexto</span><span class="tok-o">(</span><span class="tok-s">&quot;Introduce identificador de autor: &quot;</span><span class="tok-o">));</span>
            <span class="tok-n">Autor</span> <span class="tok-n">autor</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Autor</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-n">idAutor</span><span class="tok-o">);</span>
            <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">autor</span> <span class="tok-o">==</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
                <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;No existe ese autor&quot;</span><span class="tok-o">);</span>
            <span class="tok-o">}</span> <span class="tok-k">else</span> <span class="tok-o">{</span>
                <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">Mensaje</span> <span class="tok-n">mensaje</span> <span class="tok-o">:</span> <span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">getMensajes</span><span class="tok-o">())</span> <span class="tok-o">{</span>
                    <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">mensaje</span><span class="tok-o">.</span><span class="tok-na">toString</span><span class="tok-o">());</span>
                <span class="tok-o">}</span>
            <span class="tok-o">}</span>
        <span class="tok-o">}</span>
        <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">Exception</span> <span class="tok-n">e</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">e</span><span class="tok-o">.</span><span class="tok-na">printStackTrace</span><span class="tok-o">();</span>
        <span class="tok-o">}</span>
        <span class="tok-k">finally</span> <span class="tok-o">{</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
            <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">static</span> <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-nf">leerTexto</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">mensaje</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">String</span> <span class="tok-n">texto</span><span class="tok-o">;</span>
        <span class="tok-k">try</span> <span class="tok-o">{</span>
            <span class="tok-n">BufferedReader</span> <span class="tok-n">in</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">BufferedReader</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">InputStreamReader</span><span class="tok-o">(</span>
                    <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">in</span><span class="tok-o">));</span>
            <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">print</span><span class="tok-o">(</span><span class="tok-n">mensaje</span><span class="tok-o">);</span>
            <span class="tok-n">texto</span> <span class="tok-o">=</span> <span class="tok-n">in</span><span class="tok-o">.</span><span class="tok-na">readLine</span><span class="tok-o">();</span>
        <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">IOException</span> <span class="tok-n">e</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">texto</span> <span class="tok-o">=</span> <span class="tok-s">&quot;Error&quot;</span><span class="tok-o">;</span>
        <span class="tok-o">}</span>
        <span class="tok-k">return</span> <span class="tok-n">texto</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si miramos en la consola los mensajes SQL que se generan, veremos que el <code>find</code> que recupera el autor también genera un <code>select</code> que recupera toda la colección de mensajes. Después, basta con recorrer esta colección de mensajes que ya tenemos en memoria.</p>
</div>
</div>
<div class="sect4">
<h5 id="_programa_buscamensajes">Programa BuscaMensajes</h5>
<div class="paragraph">
<p>JPA tiene su propio lenguaje de consultas llamado JP-QL. Lo veremos en una próxima sesión. El siguiente ejemplo ejecuta la consulta en la que se busca un patrón de texto en las entidades <code>Mensaje</code>.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/expertojava/jpa/mensajes/main/BuscaMensajes.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jpa</span><span class="tok-o">.</span><span class="tok-na">mensajes</span><span class="tok-o">.</span><span class="tok-na">main</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">java.io.BufferedReader</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.io.IOException</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.io.InputStreamReader</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.List</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManager</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManagerFactory</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.Persistence</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.Query</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jpa.mensajes.Mensaje</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">BuscaMensajes</span> <span class="tok-o">{</span>

   <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-kd">final</span> <span class="tok-n">String</span> <span class="tok-n">QUERY_BUSCA_MENSAJES</span> <span class="tok-o">=</span> <span class="tok-s">&quot;SELECT m &quot;</span>
         <span class="tok-o">+</span> <span class="tok-s">&quot;FROM Mensaje m &quot;</span> <span class="tok-o">+</span> <span class="tok-s">&quot;WHERE m.texto LIKE :patron&quot;</span><span class="tok-o">;</span>

   <span class="tok-nd">@SuppressWarnings</span><span class="tok-o">(</span><span class="tok-s">&quot;unchecked&quot;</span><span class="tok-o">)</span>
   <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-kt">void</span> <span class="tok-nf">main</span><span class="tok-o">(</span><span class="tok-n">String</span><span class="tok-o">[]</span> <span class="tok-n">args</span><span class="tok-o">)</span> <span class="tok-o">{</span>

      <span class="tok-n">EntityManagerFactory</span> <span class="tok-n">emf</span> <span class="tok-o">=</span> <span class="tok-n">Persistence</span>
            <span class="tok-o">.</span><span class="tok-na">createEntityManagerFactory</span><span class="tok-o">(</span><span class="tok-s">&quot;mensajes&quot;</span><span class="tok-o">);</span>
      <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
      <span class="tok-c1">// No necesitamos crear una transacción</span>
      <span class="tok-c1">// No modificamos datos y no hay problemas de bloqueos</span>
      <span class="tok-c1">// em.getTransaction().begin();</span>

      <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;--Buscando en los mensajes&quot;</span><span class="tok-o">);</span>
      <span class="tok-n">String</span> <span class="tok-n">palabra</span> <span class="tok-o">=</span> <span class="tok-n">leerTexto</span><span class="tok-o">(</span><span class="tok-s">&quot;Introduce una palabra: &quot;</span><span class="tok-o">);</span>

      <span class="tok-n">String</span> <span class="tok-n">patron</span> <span class="tok-o">=</span> <span class="tok-s">&quot;%&quot;</span> <span class="tok-o">+</span> <span class="tok-n">palabra</span> <span class="tok-o">+</span> <span class="tok-s">&quot;%&quot;</span><span class="tok-o">;</span>

      <span class="tok-n">Query</span> <span class="tok-n">query</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">createQuery</span><span class="tok-o">(</span><span class="tok-n">QUERY_BUSCA_MENSAJES</span><span class="tok-o">);</span>
      <span class="tok-n">query</span><span class="tok-o">.</span><span class="tok-na">setParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;patron&quot;</span><span class="tok-o">,</span> <span class="tok-n">patron</span><span class="tok-o">);</span>

      <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Mensaje</span><span class="tok-o">&gt;</span> <span class="tok-n">mensajes</span> <span class="tok-o">=</span> <span class="tok-n">query</span><span class="tok-o">.</span><span class="tok-na">getResultList</span><span class="tok-o">();</span>
      <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">mensajes</span><span class="tok-o">.</span><span class="tok-na">isEmpty</span><span class="tok-o">())</span> <span class="tok-o">{</span>
         <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;No se han encontrado mensajes&quot;</span><span class="tok-o">);</span>
      <span class="tok-o">}</span> <span class="tok-k">else</span>
         <span class="tok-nf">for</span> <span class="tok-o">(</span><span class="tok-n">Mensaje</span> <span class="tok-n">mensaje</span> <span class="tok-o">:</span> <span class="tok-n">mensajes</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">mensaje</span><span class="tok-o">.</span><span class="tok-na">getTexto</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-s">&quot; -- &quot;</span>
                  <span class="tok-o">+</span> <span class="tok-n">mensaje</span><span class="tok-o">.</span><span class="tok-na">getAutor</span><span class="tok-o">().</span><span class="tok-na">getNombre</span><span class="tok-o">());</span>
         <span class="tok-o">}</span>

      <span class="tok-c1">// em.getTransaction().commit();</span>
      <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
      <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
   <span class="tok-o">}</span>

   <span class="tok-kd">static</span> <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-nf">leerTexto</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">mensaje</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-o">...</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos comprobar en el ejemplo que una vez recuperados los mensajes tenemos disponibles sus autores. JPA ha guardado en cada mensaje su <code>autor</code>. Esto sólo se hace por defecto con las relaciones "a-uno". En las relaciones "a-muchos" JPA guarda un <em>proxy</em> en lugar de la colección y JPA debe realizar una consulta SQL cuando se accede a la colección. Lo veremos con más detalle en la sesión en la que hablemos del mapeo de relaciones entre entidades.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_definición_de_tests_con_dbunit">1.2.7. Definición de tests con DbUnit</h4>
<div class="paragraph">
<p>La definición de tests se hace igual que siempre, en el directorio de tests de Maven <code>src/test/java</code>. Ya hemos visto el ejemplo del test que comprueba que funciona correctamente la inicialización de la unidad de persistencia.</p>
</div>
<div class="paragraph">
<p>Los ficheros de recursos guardados en el directorio <code>src/test/resources</code> tienen preferencia sobre los del directorio <code>main</code> cuando se ejecutan los tests. Por ejemplo, podemos guardar ahí un fichero <code>META-INF/persistence.xml</code> para que los tests se lancen sobre una base de datos distinta, o para que la base de datos se inicialice cada vez que se van a lanzar los tests. Esto es lo que hacemos en el siguiente listado, modificando el valor de la propiedad <code>hibernate.hbm2ddl.auto</code> a <code>create</code>. De esta forma cada vez que se lancen los tests se volverán a crear las tablas y estarán inicialmente vacías de elementos.</p>
</div>
<div class="listingblock">
<div class="title">src/test/resources/META-INF/persistence.xml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="xml">...
   <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.hbm2ddl.auto&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;create&quot;</span><span class="tok-nt">/&gt;</span>
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Vamos a ver rápidamente cómo usar DbUnit para poblar de datos las tablas sobre las que se realizan los tests. Con DbUnit podemos definir un conjunto de datos asociados a cada clase de tests y lanzar todos los tests de esa clase sobre esos mismos datos. La forma de hacerlo es limpiando las tablas a las que pertenecen los datos e insertándolos a continuación (tantas veces como tests haya que pasar).</p>
</div>
<div class="paragraph">
<p>El siguiente fichero muestra cómo construir un <em>dataset</em> de prueba usando XML para rellenar las tablas:</p>
</div>
<div class="listingblock">
<div class="title">src/test/resources/dbunit/dataset1.xml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;?xml version=&#39;1.0&#39; encoding=&#39;UTF-8&#39;?&gt;</span>
<span class="tok-nt">&lt;dataset&gt;</span>
    <span class="tok-nt">&lt;Autor</span> <span class="tok-na">autor_id=</span><span class="tok-s">&quot;1&quot;</span> <span class="tok-na">correo=</span><span class="tok-s">&quot;antonio.martinez@ua.es&quot;</span> <span class="tok-na">nombre=</span><span class="tok-s">&quot;Antonio Martinez&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;Mensaje</span> <span class="tok-na">mensaje_id=</span><span class="tok-s">&quot;1&quot;</span> <span class="tok-na">fecha=</span><span class="tok-s">&quot;2014-11-09&quot;</span> <span class="tok-na">texto=</span><span class="tok-s">&quot;Hola, colega&quot;</span> <span class="tok-na">autor=</span><span class="tok-s">&quot;1&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;Mensaje</span> <span class="tok-na">mensaje_id=</span><span class="tok-s">&quot;2&quot;</span> <span class="tok-na">fecha=</span><span class="tok-s">&quot;2014-11-09&quot;</span> <span class="tok-na">texto=</span><span class="tok-s">&quot;Este es mi segundo mensaje&quot;</span> <span class="tok-na">autor=</span><span class="tok-s">&quot;1&quot;</span><span class="tok-nt">/&gt;</span>
<span class="tok-nt">&lt;/dataset&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y a continuación el fichero en el que se definen los tests:</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/org.expertojava.jpa.mensajes.modelo.TestMensajes</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jpa</span><span class="tok-o">.</span><span class="tok-na">mensajes</span><span class="tok-o">.</span><span class="tok-na">modelo</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.dbunit.database.DatabaseConnection</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.dbunit.database.IDatabaseConnection</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.dbunit.dataset.IDataSet</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.dbunit.dataset.xml.FlatXmlDataSetBuilder</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.dbunit.operation.DatabaseOperation</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.junit.AfterClass</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.junit.Before</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.junit.BeforeClass</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.junit.Test</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManager</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManagerFactory</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.Persistence</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.sql.Connection</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.sql.DriverManager</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">junit</span><span class="tok-o">.</span><span class="tok-na">Assert</span><span class="tok-o">.</span><span class="tok-na">assertNotNull</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">junit</span><span class="tok-o">.</span><span class="tok-na">Assert</span><span class="tok-o">.</span><span class="tok-na">assertTrue</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">junit</span><span class="tok-o">.</span><span class="tok-na">Assert</span><span class="tok-o">.</span><span class="tok-na">fail</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">TestMensajes</span> <span class="tok-o">{</span>
    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">EntityManagerFactory</span> <span class="tok-n">emf</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">IDatabaseConnection</span> <span class="tok-n">connection</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">IDataSet</span> <span class="tok-n">dataset</span><span class="tok-o">;</span>


    <span class="tok-c1">// Se ejecuta una vez antes de todos los tests</span>
    <span class="tok-nd">@BeforeClass</span>
    <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-kt">void</span> <span class="tok-nf">initDatabaseTest</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">try</span> <span class="tok-o">{</span>
            <span class="tok-c1">// Inicializamos sólo una vez el emf antes de todos los tests</span>
            <span class="tok-n">emf</span> <span class="tok-o">=</span> <span class="tok-n">Persistence</span><span class="tok-o">.</span><span class="tok-na">createEntityManagerFactory</span><span class="tok-o">(</span><span class="tok-s">&quot;mensajes&quot;</span><span class="tok-o">);</span>

            <span class="tok-c1">// Inicializamos la conexión a la BD necesaria para </span><i class="conum" data-value="1"></i><b>(1)</b>
            <span class="tok-c1">// que DBUnit cargue los datos de los tests</span>
            <span class="tok-n">Class</span><span class="tok-o">.</span><span class="tok-na">forName</span><span class="tok-o">(</span><span class="tok-s">&quot;com.mysql.jdbc.Driver&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">Connection</span> <span class="tok-n">jdbcConnection</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-n">Connection</span><span class="tok-o">)</span> <span class="tok-n">DriverManager</span>
                    <span class="tok-o">.</span><span class="tok-na">getConnection</span><span class="tok-o">(</span>
                            <span class="tok-s">&quot;jdbc:mysql://localhost:3306/jpa_mensajes&quot;</span><span class="tok-o">,</span>
                            <span class="tok-s">&quot;root&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;expertojava&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">connection</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">DatabaseConnection</span><span class="tok-o">(</span><span class="tok-n">jdbcConnection</span><span class="tok-o">);</span>
            <span class="tok-n">FlatXmlDataSetBuilder</span> <span class="tok-n">flatXmlDataSetBuilder</span> <span class="tok-o">=</span>
                    <span class="tok-k">new</span> <span class="tok-nf">FlatXmlDataSetBuilder</span><span class="tok-o">();</span>
            <span class="tok-n">flatXmlDataSetBuilder</span><span class="tok-o">.</span><span class="tok-na">setColumnSensing</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">);</span>
            <span class="tok-n">dataset</span> <span class="tok-o">=</span> <span class="tok-n">flatXmlDataSetBuilder</span><span class="tok-o">.</span><span class="tok-na">build</span><span class="tok-o">(</span><span class="tok-n">Thread</span><span class="tok-o">.</span><span class="tok-na">currentThread</span><span class="tok-o">()</span>
                    <span class="tok-o">.</span><span class="tok-na">getContextClassLoader</span><span class="tok-o">()</span>
                    <span class="tok-o">.</span><span class="tok-na">getResourceAsStream</span><span class="tok-o">(</span><span class="tok-s">&quot;dbunit/dataset1.xml&quot;</span><span class="tok-o">));</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">Exception</span> <span class="tok-n">ex</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">ex</span><span class="tok-o">.</span><span class="tok-na">printStackTrace</span><span class="tok-o">();</span>
            <span class="tok-n">fail</span><span class="tok-o">(</span><span class="tok-s">&quot;Excepción al inicializar el emf y DbUnit&quot;</span><span class="tok-o">);</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>

    <span class="tok-c1">// Se ejecuta antes de cada test</span>
    <span class="tok-nd">@Before</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">cleanDB</span><span class="tok-o">()</span> <span class="tok-kd">throws</span> <span class="tok-n">Exception</span> <span class="tok-o">{</span>
        <span class="tok-c1">// Se hace un &quot;clean insert&quot; de los datos de prueba</span>
        <span class="tok-c1">// definidos en el fichero XML. El &quot;clean insert&quot; vacía las</span>
        <span class="tok-c1">// tablas de los datos de prueba y después inserta los datos</span>
        <span class="tok-n">DatabaseOperation</span><span class="tok-o">.</span><span class="tok-na">CLEAN_INSERT</span><span class="tok-o">.</span><span class="tok-na">execute</span><span class="tok-o">(</span><span class="tok-n">connection</span><span class="tok-o">,</span> <span class="tok-n">dataset</span><span class="tok-o">);</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">persistAñadeUnNuevoAutor</span><span class="tok-o">()</span> <span class="tok-o">{</span> <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">begin</span><span class="tok-o">();</span>
        <span class="tok-n">Autor</span> <span class="tok-n">autor</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Autor</span><span class="tok-o">(</span><span class="tok-s">&quot;Antonio Martínez&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;antonio.martinez@ua.es&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">persist</span><span class="tok-o">(</span><span class="tok-n">autor</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">();</span>
        <span class="tok-n">Long</span> <span class="tok-n">id</span> <span class="tok-o">=</span> <span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">id</span><span class="tok-o">;</span>
        <span class="tok-n">Autor</span> <span class="tok-n">autor2</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Autor</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-n">id</span><span class="tok-o">);</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">autor2</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">autor</span><span class="tok-o">));</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">createEntityManagerTest</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">assertNotNull</span><span class="tok-o">(</span><span class="tok-n">em</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">findDevuelveAutor</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">Autor</span> <span class="tok-n">autor</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Autor</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">1L</span><span class="tok-o">);</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">getCorreo</span><span class="tok-o">().</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-s">&quot;antonio.martinez@ua.es&quot;</span><span class="tok-o">));</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">findDevuelveAutorConMensajes</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">Autor</span> <span class="tok-n">autor</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Autor</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">1L</span><span class="tok-o">);</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">autor</span><span class="tok-o">.</span><span class="tok-na">getMensajes</span><span class="tok-o">().</span><span class="tok-na">size</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-mi">2</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>

    <span class="tok-c1">// Se ejecuta una vez después de todos los tests</span>
    <span class="tok-nd">@AfterClass</span>
    <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-kt">void</span> <span class="tok-nf">closeEntityManagerFactory</span><span class="tok-o">()</span> <span class="tok-kd">throws</span> <span class="tok-n">Exception</span> <span class="tok-o">{</span>
        <span class="tok-c1">// Borramos todos los datos y cerramos la conexión</span>
        <span class="tok-n">DatabaseOperation</span><span class="tok-o">.</span><span class="tok-na">DELETE_ALL</span><span class="tok-o">.</span><span class="tok-na">execute</span><span class="tok-o">(</span><span class="tok-n">connection</span><span class="tok-o">,</span> <span class="tok-n">dataset</span><span class="tok-o">);</span> <i class="conum" data-value="5"></i><b>(5)</b>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">emf</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">)</span>
            <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Se obtiene una conexión JDBC a la base de datos para que DbUnit inserte los datos de pruebas</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Se cargan los datos de prueba en memoria a partir del fichero <code>dbunit/dataset1.xml</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Antes de cada test se realiza una llamada al método <code>CLEAN_INSERT</code> de DbUnit con el que se vacían las tablas a las que pertenecen los datos del dataset y se insertan. De esta forma, antes de comenzar cualquier test las tablas se encuentran en el estado conocido definido por los datos cargados.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Se realizan tests de forma idéntica a cómo los hacíamos con JUnit</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Al terminar todos los tests se borran todos los datos de la base de datos y se cierra el <code>EntityManagerFactory</code></td>
</tr>
</table>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios">1.3. Ejercicios</h3>
<div class="paragraph">
<p>Para crear los proyectos haz un <em>fork</em> del repositorio <code>java_ua/ejercicios-jpa</code> y descargarlo después en tu máquina:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ git clone https://&lt;usuario&gt;@bitbucket.org/&lt;usuario&gt;/ejercicios-jpa</pre>
</div>
</div>
<div class="paragraph">
<p>Lo único que contiene el repositorio es un proyecto IntelliJ vacío con el fichero <code>.gitignore</code>. En este repositorio vas a crear los distintos <em>módulos</em> que vamos a ir desarrollando en las sesiones de ejercicios.</p>
</div>
<div class="paragraph">
<p>Abre el proyecto con IntelliJ y empezamos con los ejercicios de esta sesión.</p>
</div>
<div class="sect3">
<h4 id="__0_5_puntos_construir_el_módulo_mensajes">1.3.1. (0,5 puntos) Construir el módulo mensajes</h4>
<div class="paragraph">
<p>Debes construir el proyecto <code>mensajes</code> tal y como se ha presentado en teoría:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Una vez que has abierto el proyecto <code>jpa-expertojava</code>, crea un primer módulo dentro de él. Utiliza el asistente para crear un módulo Maven vacío desde el panel de <em>Project Structure</em>, que puedes abrir con la opción <em>File &gt; Project Structure</em>:</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa01/anyadir-modulo.png" alt="" width="50%">
</div>
</div>
<div class="paragraph">
<p>Define las coordenadas del proyecto:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>groupId</code>:`org.expertojava.jpa`</p>
</li>
<li>
<p><code>artifactId</code>: <code>mensajes</code></p>
</li>
<li>
<p><code>version</code>: la que aparece por defecto (<code>1.0-SNAPSHOT</code>)</p>
</li>
<li>
<p><code>packaging</code>: jar</p>
<div class="paragraph">
<p>Y ubica el módulo en el directorio <code>mensajes</code> dentro del proyecto principal</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Cuando se abra el nuevo proyecto en IntelliJ recuerda activar los menús del control de versiones Git con la opción <em>VCS &gt; Enable Version Control Integration &gt; Git</em>. Ahora ya podrás usar Git desde IntelliJ.</p>
</li>
<li>
<p>Crea las clases Java de entidad y el fichero <code>persistence.xml</code></p>
</li>
<li>
<p>Crea los tests</p>
</li>
<li>
<p>Crea las clases main</p>
</li>
<li>
<p>Ejecuta algunos ejemplos y comprueba que los datos se han añadido en la base de datos</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Puedes encontrar el código del ejemplo, aparte de en estos apuntes, en el repositorio <code>java_ua/ejemplos-jpa</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="__1_5_puntos_contruir_el_módulo_filmoteca">1.3.2. (1,5 puntos) Contruir el módulo filmoteca</h4>
<div class="paragraph">
<p>Construye en IntelliJ el módulo Maven <code>filmoteca</code> con los siguientes parámetros:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>groupId</code>: org.expertojava.jpa</p>
</li>
<li>
<p><code>artifactId</code>: filmoteca</p>
</li>
<li>
<p><code>version</code>: 0.0.1-SNAPSHOT</p>
</li>
<li>
<p><code>packaging</code>: jar</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Modifica el fichero POM para incluir las librerías necesarias para trabajar con JPA. Crea una base de datos nueva llamada <code>jpa_filmoteca</code> y el fichero de configuración de JPA <code>persistence.xml</code>. Crea en el <code>persistence.xml</code> una unidad de persistencia sin clases con el nombre <code>filmoteca</code>. Crea por último el <em>singleton</em> que obtiene el <code>entityManagerFactory</code>.</p>
</div>
<div class="paragraph">
<p>Para probar todo lo anterior, crea una clase de test como hemos anteriormente para probar que se obtiene correctamente el entity manager. Lanza el test y comprueba que funciona correctamente.</p>
</div>
<div class="sect4">
<h5 id="_creación_de_entidades">Creación de entidades</h5>
<div class="paragraph">
<p>Crea las siguientes entidades en el paquete org.expertojava.jpa.filmoteca.modelo:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Pelicula</code>, con un identificador autogenerado como clave primaria (tipo <code>Long</code>) y los campos:</p>
<div class="ulist">
<ul>
<li>
<p><code>titulo</code> (<code>String</code>)</p>
</li>
<li>
<p><code>estreno (`Date</code>)</p>
</li>
<li>
<p><code>presupuesto</code> (<code>Double</code>): presupuesto de la película en miles de euros</p>
</li>
<li>
<p><code>recaudación</code> (<code>Double</code>): recaudación de la película en miles de euros</p>
</li>
<li>
<p><code>pais</code> (<code>String</code>)</p>
</li>
<li>
<p>Relación a-muchos con la entidad <code>Critica</code></p>
</li>
</ul>
</div>
</li>
<li>
<p><code>Critica</code>, con un identificador autogenerado como clave primaria (tipo <code>Long</code>) y los campos:</p>
<div class="ulist">
<ul>
<li>
<p><code>critico</code> (<code>String</code>)</p>
</li>
<li>
<p><code>texto</code> (<code>String</code>)</p>
</li>
<li>
<p><code>valoracion</code> (<code>Integer</code>): número del 1 al 10</p>
</li>
<li>
<p>relación a-uno con <code>Pelicula</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Lanza el test anterior y comprueba que las tablas se han creado correctamente en la BD.</p>
</div>
</div>
<div class="sect4">
<h5 id="_programas_de_prueba_de_las_entidades">Programas de prueba de las entidades</h5>
<div class="paragraph">
<p>Siguiendo los ejemplos vistos en la sesión de teoría, escribe dos clases <code>main</code> en el paquete org.expertojava.jpa.filmoteca.main:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>NuevaPelicula</code>: Añade una nueva película, introduciendo por la entrada estándar su título, su fecha de estreno, su presupuesto y su recaudación. Imprime por la salida estándar el código de la película.</p>
</li>
<li>
<p><code>NuevaCritica</code>: Añade una nueva crítica, introduciendo por la entrada estándar el nombre del crítico, el texto de la crítica, la valoración y el código de la película.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Puedes ejecutar los programas desde IntelliJ o desde línea de comando utilizando el plugin exec de Maven:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> mvn <span class="tok-nb">exec</span>:java -Dexec.mainClass<span class="tok-o">=</span>org.expertojava.jpa.filmoteca.main.NuevaPelicula</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2015-09-25 07:54:21 CEST
</div>
</div>
</body>
</html>