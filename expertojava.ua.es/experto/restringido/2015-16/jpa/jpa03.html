<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.2">
<meta name="author" content="Domingo Gallardo">
<title>Frameworks de persistencia - JPA</title>
<style>/*! normalize.css v2.1.2 | MIT License | git.io/normalize */
/* ========================================================================== HTML5 display definitions ========================================================================== */
/** Correct `block` display not defined in IE 8/9. */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }

/** Correct `inline-block` display not defined in IE 8/9. */
audio, canvas, video { display: inline-block; }

/** Prevent modern browsers from displaying `audio` without controls. Remove excess height in iOS 5 devices. */
audio:not([controls]) { display: none; height: 0; }

/** Address `[hidden]` styling not present in IE 8/9. Hide the `template` element in IE, Safari, and Firefox < 22. */
[hidden], template { display: none; }

script { display: none !important; }

/* ========================================================================== Base ========================================================================== */
/** 1. Set default font family to sans-serif. 2. Prevent iOS text size adjust after orientation change, without disabling user zoom. */
html { font-family: sans-serif; /* 1 */ -ms-text-size-adjust: 100%; /* 2 */ -webkit-text-size-adjust: 100%; /* 2 */ }

/** Remove default margin. */
body { margin: 0; }

/* ========================================================================== Links ========================================================================== */
/** Remove the gray background color from active links in IE 10. */
a { background: transparent; }

/** Address `outline` inconsistency between Chrome and other browsers. */
a:focus { outline: thin dotted; }

/** Improve readability when focused and also mouse hovered in all browsers. */
a:active, a:hover { outline: 0; }

/* ========================================================================== Typography ========================================================================== */
/** Address variable `h1` font-size and margin within `section` and `article` contexts in Firefox 4+, Safari 5, and Chrome. */
h1 { font-size: 2em; margin: 0.67em 0; }

/** Address styling not present in IE 8/9, Safari 5, and Chrome. */
abbr[title] { border-bottom: 1px dotted; }

/** Address style set to `bolder` in Firefox 4+, Safari 5, and Chrome. */
b, strong { font-weight: bold; }

/** Address styling not present in Safari 5 and Chrome. */
dfn { font-style: italic; }

/** Address differences between Firefox and other browsers. */
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }

/** Address styling not present in IE 8/9. */
mark { background: #ff0; color: #000; }

/** Correct font family set oddly in Safari 5 and Chrome. */
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }

/** Improve readability of pre-formatted text in all browsers. */
pre { white-space: pre-wrap; }

/** Set consistent quote types. */
q { quotes: "\201C" "\201D" "\2018" "\2019"; }

/** Address inconsistent and variable font size in all browsers. */
small { font-size: 80%; }

/** Prevent `sub` and `sup` affecting `line-height` in all browsers. */
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }

sup { top: -0.5em; }

sub { bottom: -0.25em; }

/* ========================================================================== Embedded content ========================================================================== */
/** Remove border when inside `a` element in IE 8/9. */
img { border: 0; }

/** Correct overflow displayed oddly in IE 9. */
svg:not(:root) { overflow: hidden; }

/* ========================================================================== Figures ========================================================================== */
/** Address margin not present in IE 8/9 and Safari 5. */
figure { margin: 0; }

/* ========================================================================== Forms ========================================================================== */
/** Define consistent border, margin, and padding. */
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }

/** 1. Correct `color` not being inherited in IE 8/9. 2. Remove padding so people aren't caught out if they zero out fieldsets. */
legend { border: 0; /* 1 */ padding: 0; /* 2 */ }

/** 1. Correct font family not being inherited in all browsers. 2. Correct font size not being inherited in all browsers. 3. Address margins set differently in Firefox 4+, Safari 5, and Chrome. */
button, input, select, textarea { font-family: inherit; /* 1 */ font-size: 100%; /* 2 */ margin: 0; /* 3 */ }

/** Address Firefox 4+ setting `line-height` on `input` using `!important` in the UA stylesheet. */
button, input { line-height: normal; }

/** Address inconsistent `text-transform` inheritance for `button` and `select`. All other form control elements do not inherit `text-transform` values. Correct `button` style inheritance in Chrome, Safari 5+, and IE 8+. Correct `select` style inheritance in Firefox 4+ and Opera. */
button, select { text-transform: none; }

/** 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio` and `video` controls. 2. Correct inability to style clickable `input` types in iOS. 3. Improve usability and consistency of cursor style between image-type `input` and others. */
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; /* 2 */ cursor: pointer; /* 3 */ }

/** Re-set default cursor for disabled elements. */
button[disabled], html input[disabled] { cursor: default; }

/** 1. Address box sizing set to `content-box` in IE 8/9. 2. Remove excess padding in IE 8/9. */
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; /* 1 */ padding: 0; /* 2 */ }

/** 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome. 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome (include `-moz` to future-proof). */
input[type="search"] { -webkit-appearance: textfield; /* 1 */ -moz-box-sizing: content-box; -webkit-box-sizing: content-box; /* 2 */ box-sizing: content-box; }

/** Remove inner padding and search cancel button in Safari 5 and Chrome on OS X. */
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }

/** Remove inner padding and border in Firefox 4+. */
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }

/** 1. Remove default vertical scrollbar in IE 8/9. 2. Improve readability and alignment in all browsers. */
textarea { overflow: auto; /* 1 */ vertical-align: top; /* 2 */ }

/* ========================================================================== Tables ========================================================================== */
/** Remove most spacing between table cells. */
table { border-collapse: collapse; border-spacing: 0; }

meta.foundation-mq-small { font-family: "only screen and (min-width: 768px)"; width: 768px; }

meta.foundation-mq-medium { font-family: "only screen and (min-width:1280px)"; width: 1280px; }

meta.foundation-mq-large { font-family: "only screen and (min-width:1440px)"; width: 1440px; }

*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }

html, body { font-size: 97%; }

body { background: white; color: #222222; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }

a:hover { cursor: pointer; }

img, object, embed { max-width: 100%; height: auto; }

object, embed { height: 100%; }

img { -ms-interpolation-mode: bicubic; }

#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }

.left { float: left !important; }

.right { float: right !important; }

.text-left { text-align: left !important; }

.text-right { text-align: right !important; }

.text-center { text-align: center !important; }

.text-justify { text-align: justify !important; }

.hide { display: none; }

.antialiased, body { -webkit-font-smoothing: antialiased; }

img { display: inline-block; vertical-align: middle; }

textarea { height: auto; min-height: 50px; }

select { width: 100%; }

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }

.subheader, .admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { line-height: 1.4; color: #6f6f6f; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }

/* Typography resets */
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }

/* Default Link Styles */
a { color: #1164be; text-decoration: none; line-height: inherit; }
a img { border: none; }

/* Default paragraph styles */
p { font-family: inherit; font-weight: normal; font-size: 1em; line-height: 1.4; margin-bottom: 1em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }

/* Default header styles */
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: bold; font-style: normal; color: #1c355e; text-rendering: optimizeLegibility; margin-top: 1em; margin-bottom: 0.5em; line-height: 1.2125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #6f6f6f; line-height: 0; }

h1 { font-size: 2.125em; }

h2 { font-size: 1.6875em; }

h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }

h4 { font-size: 1.125em; }

h5 { font-size: 1.125em; }

h6 { font-size: 1em; }

hr { border: solid #dddddd; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }

/* Helpful Typography Defaults */
em, i { font-style: italic; line-height: inherit; }

strong, b { font-weight: bold; line-height: inherit; }

small { font-size: 60%; line-height: inherit; }

code { font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: bold; }

/* Lists */
ul, ol, dl { font-size: 1em; line-height: 1.4; margin-bottom: 1.25em; list-style-position: outside; font-family: inherit; }

ul, ol { margin-left: 2.5em; }
ul.no-bullet, ol.no-bullet { margin-left: 1.5em; }

/* Unordered Lists */
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; /* Override nested font-size change */ }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }

/* Ordered Lists */
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }

/* Definition Lists */
dl dt { margin-bottom: 0.3125em; font-weight: bold; }
dl dd { margin-bottom: 1.25em; }

/* Abbreviations */
abbr, acronym { text-transform: uppercase; font-size: 90%; color: #222222; border-bottom: 1px dotted #dddddd; cursor: help; }

abbr { text-transform: none; }

/* Blockquotes */
blockquote { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
blockquote cite { display: block; font-size: 0.8125em; color: #555555; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #555555; }

blockquote, blockquote p { line-height: 1.6; color: #6f6f6f; }

/* Microformats */
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #dddddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }

.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }

/*@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.6875em; }
  h4 { font-size: 1.4375em; } }*/
/* Tables */
table { background: white; margin-bottom: 1.25em; border: solid 1px #dddddd; }
table thead, table tfoot { background: whitesmoke; font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: #222222; text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: #222222; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #f9f9f9; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.4; }

h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; border-bottom: 1px solid #dddddd }

.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }

*:not(pre) > code { font-size: inherit; font-style: normal !important; letter-spacing: 0; padding: 3px 2px 1px 2px; background-color: #eeeeee; border: 1px solid #dddddd; -webkit-border-radius: 0; border-radius: 0; line-height: inherit; font-weight: normal; }

pre, pre > code { line-height: 1.4; color: black; font-family: monospace, serif; font-weight: normal; }

.keyseq { color: #555555; }

kbd { display: inline-block; color: #222222; font-size: 0.75em; line-height: 1.4; background-color: #f7f7f7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; margin: -0.15em 0.15em 0 0.15em; padding: 0.2em 0.6em 0.2em 0.5em; vertical-align: middle; white-space: nowrap; }

.keyseq kbd:first-child { margin-left: 0; }

.keyseq kbd:last-child { margin-right: 0; }

.menuseq, .menu { color: #090909; }

b.button:before, b.button:after { position: relative; top: -1px; font-weight: normal; }

b.button:before { content: "["; padding: 0 3px 0 2px; }

b.button:after { content: "]"; padding: 0 2px 0 3px; }

#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 0.9375em; padding-right: 0.9375em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }

#content { margin-top: 1.25em; }

#content:before { content: none; }

#header > h1:first-child { color: black; margin-top: 2.25rem; margin-bottom: 0; }
#header > h1:first-child + #toc { margin-top: 8px; border-top: 1px solid #dddddd; }
#header > h1:only-child, body.toc2 #header > h1:nth-last-child(2) { border-bottom: 1px solid #dddddd; padding-bottom: 8px; }
#header .details { border-bottom: 1px solid #dddddd; line-height: 1.45; padding-top: 0.25em; padding-bottom: 0.25em; padding-left: 0.25em; color: #555555; display: -ms-flexbox; display: -webkit-flex; display: flex; -ms-flex-flow: row wrap; -webkit-flex-flow: row wrap; flex-flow: row wrap; }
#header .details span:first-child { margin-left: -0.125em; }
#header .details span.email a { color: #6f6f6f; }
#header .details br { display: none; }
#header .details br + span:before { content: "\00a0\2013\00a0"; }
#header .details br + span.author:before { content: "\00a0\22c5\00a0"; color: #6f6f6f; }
#header .details br + span#revremark:before { content: "\00a0|\00a0"; }
#header #revnumber { text-transform: capitalize; }
#header #revnumber:after { content: "\00a0"; }

#content > h1:first-child:not([class]) { color: black; border-bottom: 1px solid #dddddd; padding-bottom: 8px; margin-top: 0; padding-top: 1rem; margin-bottom: 1.25rem; }

#floating {
  position: fixed;
  z-index: 1000;
  padding: 0.5em;
  right: 0;
  top: 0;
  background: white;
  box-shadow: 0 0 1em #777777;
  -webkit-box-shadow: 0 0 1em #777777;
  -moz-box-shadow: 0 0 1em #777777;
  -webkit-border-bottom-left-radius: 5px;
  -moz-border-radius-bottomleft: 5px;
  max-height: 80%;
  overflow: auto;
}

#floating #full { display: none; } /* Hide the full TOC by default */

#floating:hover #full{
  display: block; /* Show it on hover */
}


#toc { border-bottom: 1px solid #dddddd; padding-bottom: 0.5em; }
#toc > ul { margin-left: 0.125em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin: 0.5em 0; }
#toc ul { font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; list-style-type: none; }
#toc a { text-decoration: none; }
#toc a:active { text-decoration: underline; }

#toctitle { color: #6f6f6f; font-size: 1.2em; }

@media only screen and (min-width: 768px) { #toctitle { font-size: 1.375em; }
  body.toc2 { padding-left: 15em; padding-right: 0; }
  #toc.toc2 { margin-top: 0 !important; background-color: #f2f2f2; position: fixed; width: 15em; left: 0; top: 0; border-right: 1px solid #dddddd; border-top-width: 0 !important; border-bottom-width: 0 !important; z-index: 1000; padding: 1.25em 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; font-size: 1.2em; }
  #toc.toc2 > ul { font-size: 0.9em; margin-bottom: 0; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 15em; }
  body.toc2.toc-right #toc.toc2 { border-right-width: 0; border-left: 1px solid #dddddd; left: auto; right: 0; } }
@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; padding-right: 0; }
  #toc.toc2 { width: 20em; }
  #toc.toc2 #toctitle { font-size: 1.375em; }
  #toc.toc2 > ul { font-size: 0.95em; }
  #toc.toc2 ul ul { padding-left: 1.25em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; } }
#content #toc { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 0; border-radius: 0; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }

#footer { max-width: 100%; background-color: #222222; padding: 1.25em; }

#footer-text { color: #dddddd; line-height: 1.44; }

.sect1 { padding-bottom: 0.625em; }

@media only screen and (min-width: 768px) { .sect1 { padding-bottom: 1.25em; } }
.sect1 + .sect1 { border-top: 1px solid #dddddd; }

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; z-index: 1001; width: 1.5ex; margin-left: -1.5ex; display: block; text-decoration: none !important; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: "\00A7"; font-size: 0.85em; display: block; padding-top: 0.1em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #222222; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #151515; }

.audioblock, .imageblock, .literalblock, .listingblock, .stemblock, .videoblock { margin-bottom: 1.25em; }

.admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-rendering: optimizeLegibility; text-align: left; }

table.tableblock > caption.title { white-space: nowrap; overflow: visible; max-width: 0; }

.paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { color: black; }

table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }

.admonitionblock > table { border-collapse: separate; border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #dddddd; color: #555555; }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }

.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 0; border-radius: 0; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }

.sidebarblock { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 0; border-radius: 0; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock > .content > .title { color: #6f6f6f; margin-top: 0; }

.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }

.literalblock pre, .listingblock pre:not(.highlight), .listingblock pre[class="highlight"], .listingblock pre[class^="highlight "], .listingblock pre.CodeRay, .listingblock pre.prettyprint { background: #eeeeee; }
.sidebarblock .literalblock pre, .sidebarblock .listingblock pre:not(.highlight), .sidebarblock .listingblock pre[class="highlight"], .sidebarblock .listingblock pre[class^="highlight "], .sidebarblock .listingblock pre.CodeRay, .sidebarblock .listingblock pre.prettyprint { background: #f2f1f1; }

.literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { border: 1px solid #cccccc; -webkit-border-radius: 0; border-radius: 0; word-wrap: break-word; padding: 0.8em 0.8em 0.65em 0.8em; font-size: 0.8125em; }
.literalblock pre.nowrap, .literalblock pre[class].nowrap, .listingblock pre.nowrap, .listingblock pre[class].nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
@media only screen and (min-width: 768px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 0.90625em; } }
@media only screen and (min-width: 1280px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 1em; } }

.literalblock.output pre { color: #eeeeee; background-color: black; }

.listingblock pre.highlightjs { padding: 0; }
.listingblock pre.highlightjs > code { padding: 0.8em 0.8em 0.65em 0.8em; -webkit-border-radius: 0; border-radius: 0; }

.listingblock > .content { position: relative; }

.listingblock code[data-lang]:before { display: none; content: attr(data-lang); position: absolute; font-size: 0.75em; top: 0.425rem; right: 0.5rem; line-height: 1; text-transform: uppercase; color: #999; }

.listingblock:hover code[data-lang]:before { display: block; }

.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }

.listingblock.terminal pre .command:not([data-prompt]):before { content: "$"; }

table.pyhltable { border-collapse: separate; border: 0; margin-bottom: 0; background: none; }

table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; }

table.pyhltable td.code { padding-left: .75em; padding-right: 0; }

pre.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #dddddd; }

pre.pygments .lineno { display: inline-block; margin-right: .25em; }

table.pyhltable .linenodiv { background: none !important; padding-right: 0 !important; }

.quoteblock { margin: 0 1em 1.25em 1.5em; display: table; }
.quoteblock > .title { margin-left: -1.5em; margin-bottom: 0.75em; }
.quoteblock blockquote, .quoteblock blockquote p { color: #6f6f6f; font-size: 1.15rem; line-height: 1.75; word-spacing: 0.1em; letter-spacing: 0; font-style: italic; text-align: justify; }
.quoteblock blockquote { margin: 0; padding: 0; border: 0; }
.quoteblock blockquote:before { content: "\201c"; float: left; font-size: 2.75em; font-weight: bold; line-height: 0.6em; margin-left: -0.6em; color: #6f6f6f; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: 0.5em; margin-right: 0.5ex; text-align: right; }
.quoteblock .quoteblock { margin-left: 0; margin-right: 0; padding: 0.5em 0; border-left: 3px solid #555555; }
.quoteblock .quoteblock blockquote { padding: 0 0 0 0.75em; }
.quoteblock .quoteblock blockquote:before { display: none; }

.verseblock { margin: 0 1em 1.25em 1em; }
.verseblock pre { font-family: "Open Sans", "DejaVu Sans", sans; font-size: 1.15rem; color: #6f6f6f; font-weight: 300; text-rendering: optimizeLegibility; }
.verseblock pre strong { font-weight: 400; }
.verseblock .attribution { margin-top: 1.25rem; margin-left: 0.5ex; }

.quoteblock .attribution, .verseblock .attribution { font-size: 0.8125em; line-height: 1.45; font-style: italic; }
.quoteblock .attribution br, .verseblock .attribution br { display: none; }
.quoteblock .attribution cite, .verseblock .attribution cite { display: block; letter-spacing: -0.05em; color: #555555; }

.quoteblock.abstract { margin: 0 0 1.25em 0; display: block; }
.quoteblock.abstract blockquote, .quoteblock.abstract blockquote p { text-align: left; word-spacing: 0; }
.quoteblock.abstract blockquote:before, .quoteblock.abstract blockquote p:first-of-type:before { display: none; }

table.tableblock { max-width: 100%; border-collapse: separate; }
table.tableblock td > .paragraph:last-child p > p:last-child, table.tableblock th > p:last-child, table.tableblock td > p:last-child { margin-bottom: 0; }

table.spread { width: 100%; }

table.tableblock, th.tableblock, td.tableblock { border: 0 solid #dddddd; }

table.grid-all th.tableblock, table.grid-all td.tableblock { border-width: 0 1px 1px 0; }

table.grid-all tfoot > tr > th.tableblock, table.grid-all tfoot > tr > td.tableblock { border-width: 1px 1px 0 0; }

table.grid-cols th.tableblock, table.grid-cols td.tableblock { border-width: 0 1px 0 0; }

table.grid-all * > tr > .tableblock:last-child, table.grid-cols * > tr > .tableblock:last-child { border-right-width: 0; }

table.grid-rows th.tableblock, table.grid-rows td.tableblock { border-width: 0 0 1px 0; }

table.grid-all tbody > tr:last-child > th.tableblock, table.grid-all tbody > tr:last-child > td.tableblock, table.grid-all thead:last-child > tr > th.tableblock, table.grid-rows tbody > tr:last-child > th.tableblock, table.grid-rows tbody > tr:last-child > td.tableblock, table.grid-rows thead:last-child > tr > th.tableblock { border-bottom-width: 0; }

table.grid-rows tfoot > tr > th.tableblock, table.grid-rows tfoot > tr > td.tableblock { border-width: 1px 0 0 0; }

table.frame-all { border-width: 1px; }

table.frame-sides { border-width: 0 1px; }

table.frame-topbot { border-width: 1px 0; }

th.halign-left, td.halign-left { text-align: left; }

th.halign-right, td.halign-right { text-align: right; }

th.halign-center, td.halign-center { text-align: center; }

th.valign-top, td.valign-top { vertical-align: top; }

th.valign-bottom, td.valign-bottom { vertical-align: bottom; }

th.valign-middle, td.valign-middle { vertical-align: middle; }

table thead th, table tfoot th { font-weight: bold; }

tbody tr th { display: table-cell; line-height: 1.4; background: whitesmoke; }

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p { color: #222222; font-weight: bold; }

p.tableblock > code:only-child { background: none; padding: 0; }

p.tableblock { font-size: 1em; }

td > div.verse { white-space: pre; }

ol { margin-left: 2.5em; }

ul li ol { margin-left: 1.5em; }

dl dd { margin-left: 1.125em; }

dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }

ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.625em; }

ul.unstyled, ol.unnumbered, ul.checklist, ul.none { list-style-type: none; }

ul.unstyled, ol.unnumbered, ul.checklist { margin-left: 0.625em; }

ul.checklist li > p:first-child > .fa-check-square-o:first-child, ul.checklist li > p:first-child > input[type="checkbox"]:first-child { margin-right: 0.25em; }

ul.checklist li > p:first-child > input[type="checkbox"]:first-child { position: relative; top: 1px; }

ul.inline { margin: 0 auto 0.625em auto; margin-left: -1.375em; margin-right: 0; padding: 0; list-style: none; overflow: hidden; }
ul.inline > li { list-style: none; float: left; margin-left: 1.375em; display: block; }
ul.inline > li > * { display: block; }

.unstyled dl dt { font-weight: normal; font-style: normal; }

ol.arabic { list-style-type: decimal; }

ol.decimal { list-style-type: decimal-leading-zero; }

ol.loweralpha { list-style-type: lower-alpha; }

ol.upperalpha { list-style-type: upper-alpha; }

ol.lowerroman { list-style-type: lower-roman; }

ol.upperroman { list-style-type: upper-roman; }

ol.lowergreek { list-style-type: lower-greek; }

.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }

td.hdlist1 { padding-right: .75em; font-weight: bold; }

td.hdlist1, td.hdlist2 { vertical-align: top; }

.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }

.colist > table tr > td:first-of-type { padding: 0 0.75em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.25em 0; }

.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: 0 0 0 1px #dddddd; box-shadow: 0 0 0 1px #dddddd; }

.imageblock.left, .imageblock[style*="float: left"] { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }

.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }

a.image { text-decoration: none; }

span.footnote, span.footnoteref { vertical-align: super; font-size: 0.875em; }
span.footnote a, span.footnoteref a { text-decoration: none; }
span.footnote a:active, span.footnoteref a:active { text-decoration: underline; }

#footnotes { padding-top: 0.75em; padding-bottom: 0.75em; margin-bottom: 0.625em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -.25em 0 .75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.375em; line-height: 1.3; font-size: 0.875em; margin-left: 1.2em; text-indent: -1.2em; margin-bottom: .2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }

#content #footnotes { margin-top: -0.625em; margin-bottom: 0; padding: 0.75em 0; }

.gist .file-data > table { border: 0; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }

div.unbreakable { page-break-inside: avoid; }

.big { font-size: larger; }

.small { font-size: smaller; }

.underline { text-decoration: underline; }

.overline { text-decoration: overline; }

.line-through { text-decoration: line-through; }

.aqua { color: #00bfbf; }

.aqua-background { background-color: #00fafa; }

.black { color: black; }

.black-background { background-color: black; }

.blue { color: #0000bf; }

.blue-background { background-color: #0000fa; }

.fuchsia { color: #bf00bf; }

.fuchsia-background { background-color: #fa00fa; }

.gray { color: #606060; }

.gray-background { background-color: #7d7d7d; }

.green { color: #006000; }

.green-background { background-color: #007d00; }

.lime { color: #00bf00; }

.lime-background { background-color: #00fa00; }

.maroon { color: #600000; }

.maroon-background { background-color: #7d0000; }

.navy { color: #000060; }

.navy-background { background-color: #00007d; }

.olive { color: #606000; }

.olive-background { background-color: #7d7d00; }

.purple { color: #600060; }

.purple-background { background-color: #7d007d; }

.red { color: #bf0000; }

.red-background { background-color: #fa0000; }

.silver { color: #909090; }

.silver-background { background-color: #bcbcbc; }

.teal { color: #006060; }

.teal-background { background-color: #007d7d; }

.white { color: #bfbfbf; }

.white-background { background-color: #fafafa; }

.yellow { color: #bfbf00; }

.yellow-background { background-color: #fafa00; }

span.icon > .fa { cursor: default; }

.admonitionblock td.icon [class^="fa icon-"] { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #207c98; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }

.conum[data-value] { display: inline-block; color: #fff !important; background-color: #222222; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; font-size: 0.75em; width: 1.67em; height: 1.67em; line-height: 1.67em; font-family: "Open Sans", "DejaVu Sans", sans-serif; font-style: normal; font-weight: bold; }
.conum[data-value] * { color: #fff !important; }
.conum[data-value] + b { display: none; }
.conum[data-value]:after { content: attr(data-value); }
pre .conum[data-value] { position: relative; top: -0.125em; }

b.conum * { color: inherit !important; }

.conum:not([data-value]):empty { display: none; }

.literalblock pre, .listingblock pre { background: #eeeeee; }

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.min.css">
<style>.listingblock .pygments .hll { background-color: #ffffcc }
.listingblock .pygments  { background: #f8f8f8; }
.listingblock .pygments .tok-c { color: #408080; font-style: italic } /* Comment */
.listingblock .pygments .tok-err { border: 1px solid #FF0000 } /* Error */
.listingblock .pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
.listingblock .pygments .tok-o { color: #666666 } /* Operator */
.listingblock .pygments .tok-cm { color: #408080; font-style: italic } /* Comment.Multiline */
.listingblock .pygments .tok-cp { color: #BC7A00 } /* Comment.Preproc */
.listingblock .pygments .tok-c1 { color: #408080; font-style: italic } /* Comment.Single */
.listingblock .pygments .tok-cs { color: #408080; font-style: italic } /* Comment.Special */
.listingblock .pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
.listingblock .pygments .tok-ge { font-style: italic } /* Generic.Emph */
.listingblock .pygments .tok-gr { color: #FF0000 } /* Generic.Error */
.listingblock .pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
.listingblock .pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
.listingblock .pygments .tok-go { color: #888888 } /* Generic.Output */
.listingblock .pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.listingblock .pygments .tok-gs { font-weight: bold } /* Generic.Strong */
.listingblock .pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.listingblock .pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
.listingblock .pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.listingblock .pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.listingblock .pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.listingblock .pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
.listingblock .pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.listingblock .pygments .tok-kt { color: #B00040 } /* Keyword.Type */
.listingblock .pygments .tok-m { color: #666666 } /* Literal.Number */
.listingblock .pygments .tok-s { color: #BA2121 } /* Literal.String */
.listingblock .pygments .tok-na { color: #7D9029 } /* Name.Attribute */
.listingblock .pygments .tok-nb { color: #008000 } /* Name.Builtin */
.listingblock .pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
.listingblock .pygments .tok-no { color: #880000 } /* Name.Constant */
.listingblock .pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
.listingblock .pygments .tok-ni { color: #999999; font-weight: bold } /* Name.Entity */
.listingblock .pygments .tok-ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.listingblock .pygments .tok-nf { color: #0000FF } /* Name.Function */
.listingblock .pygments .tok-nl { color: #A0A000 } /* Name.Label */
.listingblock .pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.listingblock .pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
.listingblock .pygments .tok-nv { color: #19177C } /* Name.Variable */
.listingblock .pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.listingblock .pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
.listingblock .pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
.listingblock .pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
.listingblock .pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
.listingblock .pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
.listingblock .pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
.listingblock .pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
.listingblock .pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
.listingblock .pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.listingblock .pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
.listingblock .pygments .tok-se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.listingblock .pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
.listingblock .pygments .tok-si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.listingblock .pygments .tok-sx { color: #008000 } /* Literal.String.Other */
.listingblock .pygments .tok-sr { color: #BB6688 } /* Literal.String.Regex */
.listingblock .pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
.listingblock .pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
.listingblock .pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
.listingblock .pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
.listingblock .pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
.listingblock .pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
.listingblock .pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Frameworks de persistencia - JPA</h1>
<div class="details">
<span id="author" class="author">Domingo Gallardo</span><br>
<span id="email" class="email"><a href="mailto:domingo.gallardo@ua.es">domingo.gallardo@ua.es</a></span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Índice de contenidos</div>
<ul class="sectlevel1">
<li><a href="#sesion03">3. Mapeado entidad-relación: tablas</a>
<ul class="sectlevel2">
<li><a href="#_acceso_al_estado_de_la_entidad">3.1. Acceso al estado de la entidad</a>
<ul class="sectlevel3">
<li><a href="#_acceso_por_campo">3.1.1. Acceso por campo</a></li>
<li><a href="#_acceso_por_propiedad">3.1.2. Acceso por propiedad</a></li>
</ul>
</li>
<li><a href="#_mapeado_de_entidades">3.2. Mapeado de entidades</a></li>
<li><a href="#_mapeado_de_tipos">3.3. Mapeado de tipos</a>
<ul class="sectlevel3">
<li><a href="#_mapeo_de_columnas">3.3.1. Mapeo de columnas</a></li>
<li><a href="#_recuperaci%C3%B3n_perezosa">3.3.2. Recuperación perezosa</a></li>
<li><a href="#_lobs">3.3.3. LOBs</a></li>
<li><a href="#_tipos_enumerados">3.3.4. Tipos enumerados</a></li>
<li><a href="#_tipos_temporales">3.3.5. Tipos temporales</a></li>
<li><a href="#_estado_transitorio">3.3.6. Estado transitorio</a></li>
</ul>
</li>
<li><a href="#_objetos_embebidos">3.4. Objetos embebidos</a></li>
<li><a href="#_mapeo_de_la_clave_primaria">3.5. Mapeo de la clave primaria</a>
<ul class="sectlevel3">
<li><a href="#_generaci%C3%B3n_del_identificador">3.5.1. Generación del identificador</a></li>
<li><a href="#_clave_primaria_compuesta">3.5.2. Clave primaria compuesta</a></li>
<li><a href="#_clave_ajena_compuesta">3.5.3. Clave ajena compuesta</a></li>
</ul>
</li>
<li><a href="#_mapeado_de_las_relaciones_de_herencia">3.6. Mapeado de las relaciones de herencia</a></li>
<li><a href="#_bean_validation">3.7. Bean Validation</a>
<ul class="sectlevel3">
<li><a href="#_configuraci%C3%B3n_de_maven_y_jpa">3.7.1. Configuración de Maven y JPA</a></li>
<li><a href="#_anotaciones_de_validaci%C3%B3n_predefinidas">3.7.2. Anotaciones de validación predefinidas</a></li>
<li><a href="#_proceso_de_validaci%C3%B3n">3.7.3. Proceso de validación</a></li>
</ul>
</li>
<li><a href="#_ejercicios">3.8. Ejercicios</a>
<ul class="sectlevel3">
<li><a href="#__0_5_puntos_mapeado_de_tablas_y_campos_y_restricciones_em_bean_validation_em">3.8.1. (0,5 puntos) Mapeado de tablas y campos y restricciones <em>Bean Validation</em></a></li>
<li><a href="#__0_5_puntos_relaci%C3%B3n_de_herencia_en_code_pelicula_code">3.8.2. (0,5 puntos) Relación de herencia en <code>Pelicula</code></a></li>
<li><a href="#__0_5_puntos_restricciones_code_bean_validation_code">3.8.3. (0,5 puntos) Restricciones <code>Bean Validation</code></a></li>
<li><a href="#__0_5_puntos_clase_de_servicio">3.8.4. (0,5 puntos) Clase de servicio</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="sesion03">3. Mapeado entidad-relación: tablas</h2>
<div class="sectionbody">
<div class="paragraph">
<p>En este tema vamos a tratar en profundidad el mapeado entidad-relación  (ORM, <em>Object-Relational Mapping</em> en inglés), uno de los aspectos principales del API de persistencia. Veremos los aspectos referidos al mapeo de entidades en tablas: cómo acceder a los atributos de una entidad, como se mapea la entidad en una tabla, como se mapean los distintos tipos simples de Java en tipos de la base de datos, cómo se maneja el identificador de la identidad y se mapea en la clave primaria de la tabla. Introduciremos las caracaterísticas básicas del API Bean Validation, que permite restringir los valores a introducir en los atributos de las entidades. Y terminaremos introduciendo un par de conceptos avanzados, los objetos embebidos y la herencia.</p>
</div>
<div class="paragraph">
<p>El mapado entidad-relación permite independizar la aplicación del sistema de base de datos utilizado. El proveedor de persistencia (en nuestro caso Hibernate) se encarga de transformar las anotaciones estándar de JPA al lenguaje SQL específico que necesitemos y hacer totalmente portable nuestra aplicación.</p>
</div>
<div class="paragraph">
<p>Como hemos comentado en temas anteriores, la especificación del ORM se realiza mediante anotaciones. JPA continua soportando además el formato de anotaciones basadas en ficheros XML. Podemos consultar la lista de anotaciones definidas por JPA en la última parte de la página del <a href="https://docs.oracle.com/javaee/7/api/javax/persistence/package-summary.html">API de javax.persistence</a>.</p>
</div>
<div class="sect2">
<h3 id="_acceso_al_estado_de_la_entidad">3.1. Acceso al estado de la entidad</h3>
<div class="paragraph">
<p>Existen dos formas diferentes con las que podemos anotar una clase Java para convertirla en entidad: podemos anotar los campos de la entidad o anotar sus propiedades (métodos JavaBean <em>getters</em> y <em>setters</em>). La forma de implementar el acceso al estado de una entidad en el <em>entity manager</em> para acceder al estado dependerá entonces del tipo de anotación utilizada. En el primer caso, el proveedor leerá y establecerá los campos de la entidad utilizando reflexión. Si las anotaciones se realizan en las propiedades, entonces el proveedor utilizará estos métodos para acceder al estado.</p>
</div>
<div class="sect3">
<h4 id="_acceso_por_campo">3.1.1. Acceso por campo</h4>
<div class="paragraph">
<p>Si anotamos los campos de una entidad, el proveedor accederá a estos campos mediante reflexión (aunque estén declarados como privados). A esta forma de acceder a la entidad por parte del proveedor se denomina <em>acceso por campo</em>. Los métodos <em>getters</em> y <em>setters</em> serán ignorados por el proveedor. Todos los campos deben declararse como <code>protected</code> o <code>private</code>. Se desaconseja siempre el uso de campos públicos, porque podrían accederse directamente desde otras clases. Este acceso público podría incluso estropear el funcionamiento del proveedor.</p>
</div>
<div class="paragraph">
<p>El ejemplo siguiente muestra el uso de las anotaciones en los campos. La anotación <code>@Id</code> indica no sólo que el campo <code>id</code> es el identificador o clave primaria de la entidad, sino también que se va a utilizar un acceso por campo. Los campos <code>nombre</code> y <code>sueldo</code> son hechos persistentes en columnas con el mismo nombre.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
<span class="tok-nd">@Id</span> <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">id</span><span class="tok-o">;</span>
<span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;nom&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
<span class="tok-kd">private</span> <span class="tok-n">Long</span> <span class="tok-n">sueldo</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-nf">Empleado</span><span class="tok-o">()</span> <span class="tok-o">{}</span>

<span class="tok-kd">public</span> <span class="tok-kt">int</span> <span class="tok-nf">getId</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">id</span><span class="tok-o">;</span> <span class="tok-o">}</span>
<span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setId</span><span class="tok-o">(</span><span class="tok-kt">int</span> <span class="tok-n">id</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">id</span> <span class="tok-o">=</span> <span class="tok-n">id</span><span class="tok-o">;</span> <span class="tok-o">}</span>
<span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getNombre</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">nombre</span><span class="tok-o">;</span> <span class="tok-o">}</span>
<span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setNombre</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">nombre</span> <span class="tok-o">=</span> <span class="tok-n">nombre</span><span class="tok-o">;</span> <span class="tok-o">}</span>
<span class="tok-kd">public</span> <span class="tok-n">Long</span> <span class="tok-nf">getSueldo</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">sueldo</span><span class="tok-o">;</span> <span class="tok-o">}</span>
<span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setSueldo</span><span class="tok-o">(</span><span class="tok-n">Long</span> <span class="tok-n">sueldo</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">sueldo</span> <span class="tok-o">=</span> <span class="tok-n">sueldo</span><span class="tok-o">;</span> <span class="tok-o">}}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_acceso_por_propiedad">3.1.2. Acceso por propiedad</h4>
<div class="paragraph">
<p>La otra forma de anotar una entidad es colocando las anotaciones en sus métodos getters. Se dice en este caso que estamos anotando las propiedades. Cuando anotamos las propiedades, se aplican las mismas condiciones que cuando se define un JavaBean, y debe haber <em>getters</em> y <em>setters</em> para las propiedades que queremos hacer persistentes. En este caso se dice que el proveedor utiliza un acceso por propiedad a la entidad. El tipo de la propiedad viene determinado por el tipo devuelto por el método <em>getter</em> y debe ser el mismo que el único parámetro pasado al método <em>setter</em>. Ambos métodos deben tener visibilidad <code>public</code> o <code>protected</code>. La anotación de mapeado debe realizarse en el método <em>getter</em>.</p>
</div>
<div class="paragraph">
<p>En el código siguiente, la clase <code>Empleado</code> tiene una anotación <code>@Id</code> en el método <em>getter</em> <code>getId()</code>, por lo que el proveedor podrá utilizar el acceso a la propiedad <code>id</code> para obtener y establecer el estado de la entidad. Las propiedades <code>nombre</code> y <code>sueldo</code> se hacen persistentes también automáticamente y se mapearán en columnas con el nombre <code>nom</code> (por haberlo especificado con la anotación <code>@column</code>) y <code>sueldo</code>. Nótese que es posible utilizar nombres distintos para los campos. En el ejemplo, la propiedad <code>sueldo</code> está respaldada por el campo <code>paga</code>. El proveedor ignora esta diferencia, ya que únicamente utiliza los <em>getters</em> y <em>setters</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
<span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">id</span><span class="tok-o">;</span>
<span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
<span class="tok-kd">private</span> <span class="tok-n">Long</span> <span class="tok-n">paga</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-n">Empleado</span> <span class="tok-o">{}</span>

<span class="tok-nd">@Id</span> <span class="tok-kd">public</span> <span class="tok-kt">int</span> <span class="tok-nf">getId</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">id</span><span class="tok-o">;</span> <span class="tok-o">}</span>
<span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setId</span><span class="tok-o">(</span><span class="tok-kt">int</span> <span class="tok-n">id</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">id</span> <span class="tok-o">=</span> <span class="tok-n">id</span><span class="tok-o">;</span> <span class="tok-o">}</span>
<span class="tok-nd">@Column</span> <span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;nom&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getNombre</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">nombre</span><span class="tok-o">;</span> <span class="tok-o">}</span>
<span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setNombre</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">nombre</span> <span class="tok-o">=</span> <span class="tok-n">nombre</span><span class="tok-o">;</span> <span class="tok-o">}</span>
<span class="tok-kd">public</span> <span class="tok-n">Long</span> <span class="tok-nf">getSueldo</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">paga</span><span class="tok-o">;</span> <span class="tok-o">}</span>
<span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setSueldo</span><span class="tok-o">(</span><span class="tok-n">Long</span> <span class="tok-n">sueldo</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">sueldo</span> <span class="tok-o">=</span> <span class="tok-n">sueldo</span><span class="tok-o">;</span> <span class="tok-o">}}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_mapeado_de_entidades">3.2. Mapeado de entidades</h3>
<div class="paragraph">
<p>Ya hemos visto en el tema anterior que es muy sencillo mapear entidades en tablas. Sólo se necesitan las anotaciones <code>@Entity</code> y <code>@Id</code> para crear y mapear una entidad en una tabla de la base de datos.</p>
</div>
<div class="paragraph">
<p>En esos casos el nombre que se utiliza para la tabla es el propio nombre de la entidad. Podría darse el caso de que necesitáramos especificar un nombre distinto para la tabla, por ejemplo si no estamos desarrollando la aplicación desde cero y partimos de un modelo de datos ya creado. Podemos hacerlo con la anotación <code>@Table</code> en la que incluimos el nombre de la tabla. El siguiente código muestra un ejemplo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-nd">@Table</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;EMP&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span> <span class="tok-o">...</span> <span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Los nombres por defecto son los nombres de las clases, que en Java comienzan por mayúscula y continúan con minúscula. ¿Cómo se mapean las mayúsculas y minúsculas en la base de datos? Depende de la base de datos. Muchas bases de datos no distinguen mayúsculas y minúsculas, por lo que en estos casos el nombre se convierte en mayúsculas. En el caso de <em>MySQL</em>, sí que se distinguen entre mayúsculas y minúsculas, por lo que el nomre de las tablas será idéntico al de las clases.</p>
</div>
<div class="paragraph">
<p>La anotación <code>@Table</code> proporciona la posibilidad no sólo de nombrar la tabla, sino de especificar un esquema o catálogo de la base de datos. El nombre del esquema se utiliza normalmente para diferenciar un conjunto de tablas de otro y se indica en la anotación con el elemento <code>schema</code>. Se muestra en el siguiente ejemplo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-nd">@Table</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;EMP&quot;</span><span class="tok-o">,</span> <span class="tok-n">schema</span><span class="tok-o">=</span><span class="tok-s">&quot;IT&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span> <span class="tok-o">...</span> <span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cuando se especifica de esta forma, el proveedor colocará el nombre del esquema como prefijo del de la tabla cuando acceda a los datos. En este caso, los accesos se harán a la tabla <code>IT.EMP</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_mapeado_de_tipos">3.3. Mapeado de tipos</h3>
<div class="paragraph">
<p>La especificación de JPA define un gran número de tipos Java que pueden ser hechos persistentes. Son los siguientes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Tipos primitivos Java</strong>: <code>byte</code>, <code>int</code>, <code>short</code>, <code>long</code>, <code>boolean</code>, <code>char</code>, <code>float</code>, <code>double</code></p>
</li>
<li>
<p><strong>Clases <em>wrapper</em> de los tipos primitivos</strong>: <code>Byte</code>, <code>Integer</code>, <code>Short</code>, <code>Long</code>, <code>Boolean</code>, <code>Character</code>, <code>Float</code>, <code>Double</code></p>
</li>
<li>
<p><strong>Arrays de bytes y char</strong>: <code>byte[]</code>, <code>Byte[]</code>, <code>char[]</code>, <code>Character[]</code></p>
</li>
<li>
<p><strong>Tipos numéricos largos</strong>: <code>java.math.BigInteger</code>, <code>java.math.BigDecimal</code></p>
</li>
<li>
<p><strong>Strings</strong>: <code>java.lang.String</code></p>
</li>
<li>
<p><strong>Tipos temporales de Java</strong>: <code>java.util.Date</code>, <code>java.util.Calendar</code></p>
</li>
<li>
<p><strong>Tipos temporales de JDBC</strong>: <code>java.sql.Date</code>, <code>java.sql.Time</code>, <code>java.sql.Timestamp</code></p>
</li>
<li>
<p><strong>Tipos enumerados</strong>: cualquier tipo enumerado del sistema o definido por el usuario</p>
</li>
<li>
<p><strong>Objetos serializables</strong>: cualquier tipo serializable del sistema o definido por el usuario</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>En algunos casos el tipo de la columna que está siendo mapeada no es exactamente el mismo que el tipo Java. En casi todos los casos, el runtime del proveedor puede convertir el tipo devuelto por la consulta JDBC en el tipo Java correcto del atributo. Si el tipo de la capa JDBC no puede convertirse en el tipo Java del campo o la propiedad se lanza una excepción.</p>
</div>
<div class="paragraph">
<p>Cuando se hace persistente un campo o una propiedad, el proveedor comprueba que su tipo es uno de los que está en la lista anterior. Si lo está, el proveedor lo transformará en el tipo JDBC apropiado y lo pasará al driver JDBC.</p>
</div>
<div class="paragraph">
<p>Se puede usar la anotación opcional <code>@Basic</code> en el campo o la propiedad para marcarlos como persistentes. Esta anotación se utiliza únicamente para efectos de documentación o para especificar algún detalle sobre la persistencia (lo veremos más adelante).</p>
</div>
<div class="paragraph">
<p>Ahora que hemos comprobados que los campos (definidos en las variables de instancia) y las propiedades (definidas en los <em>getters</em> y <em>setters</em>) son equivalentes en términos de persistencia, los llamaremos de ahora en adelante <em>atributos</em>. Consideramos <em>atributo</em> un campo o una propiedad de una clase estilo JavaBean.</p>
</div>
<div class="sect3">
<h4 id="_mapeo_de_columnas">3.3.1. Mapeo de columnas</h4>
<div class="paragraph">
<p>Es posible anotar las características físicas de la columna de la base de datos en la que se mapea un atributo utilizando la anotación <code>@Column</code>. Aunque es posible especificar bastantes elementos, vamos a comentar sólo alguno de ellos (consultar la <a href="https://docs.oracle.com/javaee/7/api/javax/persistence/package-summary.html">especificación de JPA</a> para obtener más información).</p>
</div>
<div class="paragraph">
<p>La primera característica que hay que mencionar es el nombre de la columna. Al igual que con las tablas, es posible especificar los nombres de las columnas con las que se va a mapear cada atributo. El siguiente código muestra un ejemplo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
   <span class="tok-nd">@Id</span>
   <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;EMP_ID&quot;</span><span class="tok-o">)</span>
   <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">id</span><span class="tok-o">;</span>
   <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
   <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-n">SAL</span><span class="tok-o">)</span>
   <span class="tok-kd">private</span> <span class="tok-n">Long</span> <span class="tok-n">sueldo</span><span class="tok-o">;</span>
   <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-n">COM</span><span class="tok-o">)</span>
   <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">comentario</span><span class="tok-o">;</span>
   <span class="tok-c1">// ...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La tabla resultante del mapeo se llamaría <code>EMPLEADO</code> y tendría como columnas <code>EMP_ID</code>, <code>NOMBRE</code>, <code>SAL</code> y <code>COM</code>. La primera columna sería la clave primaria de la tabla. La siguiente figura muestra la tabla resultante en la base de datos.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa03/tabla.png" alt="Empleado" width="15%">
</div>
</div>
<div class="paragraph">
<p>Es posible también obligar a que un atributo no pueda dejarse a <code>null</code> utilizando el elemento <code>nullable=false</code>. En la columna de la tabla se incluiría la restricción SQL <code>NOT NULL</code>. Por ejemplo en el siguiente código obligaríamos a que el nombre del empleado nunca pudiera ser <code>null</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
   <span class="tok-nd">@Id</span> <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">id</span><span class="tok-o">;</span>
   <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">nullable</span><span class="tok-o">=</span><span class="tok-kc">false</span><span class="tok-o">)</span>
   <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
   <span class="tok-c1">// ...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Otra parámetro muy útil es el que nos permite generar la restricción <code>UNIQUE</code> sobre un campo de la base de datos. Por ejemplo, podemos obligar a que el <code>login</code> se único así:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
   <span class="tok-nd">@Id</span> <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">id</span><span class="tok-o">;</span>
   <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">nullable</span><span class="tok-o">=</span><span class="tok-kc">false</span><span class="tok-o">,</span> <span class="tok-n">unique</span><span class="tok-o">=</span><span class="tok-kc">true</span><span class="tok-o">)</span>
   <span class="tok-n">String</span> <span class="tok-n">login</span>
   <span class="tok-c1">// ...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cuando no se especifica la longitud de una columna que almacena cadenas (<code>String</code>, <code>char[]</code> o <code>Character[]</code>), el valor por defecto es 255. Para definir otro tamaño hay que utilizar el elemento <code>length</code>, como en el siguiente ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
   <span class="tok-nd">@Id</span> <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">id</span><span class="tok-o">;</span>
   <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">length</span><span class="tok-o">=</span><span class="tok-mi">40</span><span class="tok-o">)</span>
   <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
   <span class="tok-c1">// ...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Otros posibles parámetros de la anotación son: <code>columnDefinition</code>, <code>insertable</code>, <code>precision</code>, <code>scale</code> o <code>updatable</code> (consultar la <a href="https://docs.oracle.com/javaee/7/api/javax/persistence/Column.html">especificación de la anotación Column</a>).</p>
</div>
</div>
<div class="sect3">
<h4 id="_recuperación_perezosa">3.3.2. Recuperación perezosa</h4>
<div class="paragraph">
<p>El concepto de recuperación perezosa (<em>lazy fetching</em> en inglés) es muy importante para gestionar de forma eficiente la base de datos. Ya veremos más adelante que también se aplica a las relaciones entre entidades.</p>
</div>
<div class="paragraph">
<p>En ocasiones, sabemos que hay algunos atributos de la entidad a los que se accede con muy poca frecuencia. En este caso podemos optimizar el rendimiento de los accesos a la base de datos obteniendo sólo los datos que vamos a necesitar con frecuencia. Existen muchos nombres para esta idea, entre los que se incluyen (en inglés) <em>lazy loading</em>, <em>lazy fetching</em>, <em>on-demand fetching</em> o <em>indirection</em>. Todos significan lo mismo, que es que algunos datos no se cargan en el objeto cuando éste es leído inicialmente de la base de datos sino que serán recuperados sólo cuando sean referenciados o accedidos.</p>
</div>
<div class="paragraph">
<p>El comportamiento de un atributo de la entidad se puede especificar con el elemento <code>fetch</code> de la anotación <code>@Basic</code>. El tipo enumerado <code>FetchType</code> especifica los posibles valores de este elemento, que pueden ser <code>EAGER</code> (ávido, recupera el dato cuando se obtiene la entidad de la base de datos) o <code>LAZY</code> (perezoso, recupera el dato cuando se accede al atributo). El comportamiento por defecto es el primero.</p>
</div>
<div class="paragraph">
<p>El siguiente código muestra un ejemplo, en el que el atributo <code>comentario</code> se define con un mapeo de recuperación perezosa:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
   <span class="tok-c1">// ...</span>
   <span class="tok-nd">@Basic</span><span class="tok-o">(</span><span class="tok-n">fetch</span><span class="tok-o">=</span><span class="tok-n">FetchType</span><span class="tok-o">.</span><span class="tok-na">LAZY</span><span class="tok-o">)</span>
   <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-n">COM</span><span class="tok-o">)</span>
   <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">comentario</span><span class="tok-o">;</span>
   <span class="tok-c1">// ...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Antes de usar esta característica se debería tener claro unos cuantos aspectos. Lo primero es que la declaración de un atributo como de recuperación perezosa no obliga a nada al proveedor de persistencia. Sólo es una indicación para que pueda agilizar ciertas acciones sobre la base de datos. El proveedor no está obligado a respetar la petición, ya que el comportamiento de la entidad no queda comprometido haga una cosa u otra el proveedor.</p>
</div>
<div class="paragraph">
<p>Segundo, aunque en principio pueda parecer interesante definir ciertos atributos como de carga perezosa, en la práctica no es correcto hacerlo con tipos simples (no relaciones a otras entidades). La razón es que se gana poco haciendo que la base de datos devuelva parte de una fila. Únicamente se gana algo y debería considerarse la recuperación perezosa cuando tenemos muchas (decenas o cientos) columnas o cuando algunas columnas ocupan mucho (por ejemplo, cadenas muy largas o <em>lobs</em>).</p>
</div>
<div class="paragraph">
<p>La recuperación perezosa sí que es muy importante cuando hablemos de mapeo de relaciones, como veremos más adelante.</p>
</div>
</div>
<div class="sect3">
<h4 id="_lobs">3.3.3. LOBs</h4>
<div class="paragraph">
<p>El nombre que habitualmente se les da en base de datos a los objetos de tipo byte o caracter que son muy grandes es el de <em>large object</em> o <em>LOB</em> como abreviatura. Las columnas de la base de datos que almacenan estos tipos de objetos se deben acceder desde Java con llamadas JDBC especiales. Para indicarle al proveedor que debería usar métodos de tipo LOB en el driver de JDBC para acceder a ciertas columnas se debe utilizar la anotación <code>@Lob</code>.</p>
</div>
<div class="paragraph">
<p>En la base de datos se pueden encontrar dos tipos de LOBs: objetos grandes de tipo carácter, llamados <em>CLOBs</em> y objetos grandes de tipo binario, llamados <em>BLOBs</em>. Como su nombre indica, una columna CLOB guarda una larga secuencia de caracteres, mientras que un BLOB guarda una larga secuencia de bytes no formateados. Los tipos Java que se mapean con columnas CLOB son <code>String</code>, <code>char[]</code> y <code>Character[]</code>, mientras que <code>byte[]</code>, <code>Byte[]</code> y <code>Serializable</code> se mapean con columnas de tipo BLOB.</p>
</div>
<div class="paragraph">
<p>El siguiente código muestra el ejemplo de mapeo de una columna con un BLOB imagen. Suponemos que la columna PIC guarda una imagen del empleado, que se mapea en el atributo <code>foto</code> de tipo <code>byte[]</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
   <span class="tok-nd">@Id</span> <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">id</span><span class="tok-o">;</span>
   <span class="tok-nd">@Basic</span><span class="tok-o">(</span><span class="tok-n">fetch</span><span class="tok-o">=</span><span class="tok-n">FetchType</span><span class="tok-o">.</span><span class="tok-na">LAZY</span><span class="tok-o">)</span>
   <span class="tok-nd">@Lob</span> <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;PIC&quot;</span><span class="tok-o">)</span>
   <span class="tok-kd">private</span> <span class="tok-kt">byte</span><span class="tok-o">[]</span> <span class="tok-n">foto</span><span class="tok-o">;</span>
   <span class="tok-c1">// ...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_tipos_enumerados">3.3.4. Tipos enumerados</h4>
<div class="paragraph">
<p>Otro tipo Java que puede ser mapeado en la base de datos es cualquier tipo enumerado del sistema o definido por el usuario.</p>
</div>
<div class="paragraph">
<p>Al igual que en otros lenguajes de programación, a los valores de los tipos enumerados en Java se les asigna un ordinal implícito que depende del orden de creación. Este ordinal no puede ser modificado en tiempo de ejecución y es el que se utiliza para representar y almacenar el valor del tipo enumerado. El proveedor, por tanto, mapeará un tipo enumerado en una columna de tipo entero y sus valores en números enteros específicos.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, consideremos el siguiente tipo enumerado:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kd">enum</span> <span class="tok-n">TipoEmpleado</span> <span class="tok-o">{</span>
   <span class="tok-n">EMPLEADO_TIEMPO_PARCIAL</span><span class="tok-o">,</span>
   <span class="tok-n">EMPLEADO_TIEMPO_COMPLETO</span><span class="tok-o">,</span>
   <span class="tok-n">EMPLEADO_EXTERNO</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Los ordinales asignados en tiempo de compilación a los valores de este tipo enumerado son 0 para <code>EMPLEADO_TIEMPO_PARCIAL</code>, 1 para <code>EMPLEADO_TIEMPO_COMPLETO</code> y 2 para <code>EMPLEADO_EXTERNO</code>. El siguiente código utiliza este tipo para definir un atributo de la entidad:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
   <span class="tok-nd">@Id</span> <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">id</span><span class="tok-o">;</span>
   <span class="tok-kd">private</span> <span class="tok-n">TipoEmpleado</span> <span class="tok-n">tipo</span><span class="tok-o">;</span>
   <span class="tok-c1">// ...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos ver que el mapeado es trivial, ya que no hay que hacer nada especial y el proveedor se encarga de realizar la transformación del tipo enumerado al tipo entero de la base de datos.</p>
</div>
<div class="paragraph">
<p>Sin embargo, hay que tener cuidado con una cosa. Si en algún momento cambiamos el tipo enumerado podemos tener problemas, ya que puede cambiar el orden de los valores en el tipo enumerado y no corresponderse con los ya existentes en la base de datos. Por ejemplo, supongamos que necesitamos añadir un nuevo tipo de empleado a tiempo completo: <code>EMPLEADO_TIEMPO_COMPLETO_EXCEDENCIA</code> y supongamos que lo añadimos justo después de <code>EMPLEADO_TIEMPO_COMPLETO</code>. Esto causaría un cambio en el ordinal asociado a <code>EMPLEADO_EXTERNO</code>, que pasaría de 2 a 3. Los empleados existentes en la base de datos, sin embargo, no cambiarían y los datos grabados con el ordinal 2 pasarían de ser <code>EMPLEADO_EXTERNO</code> a ser <code>EMPLEADO_TIEMPO_COMPLETO_EXCEDENCIA</code>.</p>
</div>
<div class="paragraph">
<p>Podríamos modificar la base de datos y ajustar todos las entidades, pero si los ordinales se utilizan en algún otro lugar tendríamos que arreglarlo también. No es una buena política de mantenimiento.</p>
</div>
<div class="paragraph">
<p>Una solución mejor sería almacenar el nombre del valor como una cadena en lugar de almacenar el ordinal. Esto nos aislaría de los cambios en la declaración y nos permitiría añadir nuevos tipos sin tener que preocuparnos sobre los datos existentes. Podemos hacer esto añadiendo una anotación <code>@Enumerated</code> en el atributo y especificando un valor de <code>STRING</code>. El siguiente código muestra cómo hacerlo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
   <span class="tok-nd">@Id</span> <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">id</span><span class="tok-o">;</span>
   <span class="tok-nd">@Enumerated</span><span class="tok-o">(</span><span class="tok-n">EnumType</span><span class="tok-o">.</span><span class="tok-na">STRING</span><span class="tok-o">)</span>
   <span class="tok-kd">private</span> <span class="tok-n">TipoEmpleado</span> <span class="tok-n">tipo</span><span class="tok-o">;</span>
   <span class="tok-c1">// ...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Hay que hacer notar de esta forma no arreglamos el problema completamente. Ahora en la base de datos se guardan las cadenas <code>EMPLEADO_TIEMPO_COMPLETO</code> y demás. Si en algún momento modificamos el nombre de los valores del tipo enumerado también deberíamos cambiar los datos de la base de datos. Pero esto es menos frecuente, ya que un cambio en los valores de un tipo enumerado nos obliga a cambiar todo el código en el que aparezcan los valores, y esto es bastante más serio que cambiar los datos de una columna de la base de datos.</p>
</div>
<div class="paragraph">
<p>En general, definir el tipo enumerado como un ordinal es la forma más eficiente de trabajar, pero siempre que no sea probable tener que añadir nuevos valores en medio de los ya existentes.</p>
</div>
</div>
<div class="sect3">
<h4 id="_tipos_temporales">3.3.5. Tipos temporales</h4>
<div class="paragraph">
<p>Los tipos temporales son el conjunto de tipos basados en tiempo que pueden usarse en el mapeo entidad-relación. La lista de tipos temporales soportados incluye los tres tipos <code>java.sql</code> <code>java.sql.Date</code>, <code>java.sql.Time</code> y <code>java.sql.Timestamp</code>, e incluye también los tipos <code>java.util</code> <code>java.util.Date</code> y <code>java.util.Calendar</code>.</p>
</div>
<div class="paragraph">
<p>El mapeo de los tipos <code>java.sql</code> no plantea ningún problema en absoluto y se almacenan en la base de datos sin cambios. Los dos tipos <code>java.util</code> necesitan metadatos adicionales, para indicar qué tipo JDBC <code>java.sql</code> hay que usar cuando el proveedor haga persistente la entidad. Esto se consigue anotándolos con la anotación <code>@Temporal</code> y especificando el valor del tipo JDBC utilizando el valor correspondiente del tipo enumerado <code>TemporalType</code>. Hay tres valores enumerados: <code>DATE</code>, <code>TIME</code> y <code>TIMESTAMP</code> que representan cada uno de los tipos <code>java.sql</code>.</p>
</div>
<div class="paragraph">
<p>EL código siguiente muestra cómo <code>java.util.Date</code> y <code>java.util.Calendar</code> pueden mapearse a columnas de la base de datos.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
   <span class="tok-nd">@Id</span> <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">id</span><span class="tok-o">;</span>
   <span class="tok-nd">@Temporal</span><span class="tok-o">(</span><span class="tok-n">TemporalType</span><span class="tok-o">.</span><span class="tok-na">DATE</span><span class="tok-o">)</span>
   <span class="tok-kd">private</span> <span class="tok-n">java</span><span class="tok-o">.</span><span class="tok-na">util</span><span class="tok-o">.</span><span class="tok-na">Date</span> <span class="tok-n">fechaNacimiento</span><span class="tok-o">;</span>
   <span class="tok-nd">@Temporal</span><span class="tok-o">(</span><span class="tok-n">TemporalType</span><span class="tok-o">.</span><span class="tok-na">TIMESTAMP</span><span class="tok-o">)</span>
   <span class="tok-kd">private</span> <span class="tok-n">java</span><span class="tok-o">.</span><span class="tok-na">util</span><span class="tok-o">.</span><span class="tok-na">Date</span> <span class="tok-n">horaSalida</span><span class="tok-o">;</span>
   <span class="tok-c1">// ...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_estado_transitorio">3.3.6. Estado transitorio</h4>
<div class="paragraph">
<p>Es posible definir en la entidad atributos que no se hacen persistentes utilizando la palabra clave de Java <code>transient</code> o el atributo <code>@Transient</code>. Si se especifica alguna de estas propiedades, el proveedor no aplicará las reglas por defecto al atributo marcado.</p>
</div>
<div class="paragraph">
<p>Los campos transitorios son útiles, por ejemplo, para cachear un estado en memoria que no queremos recalcular o reinicializar. En el ejemplo siguiente usamos el campo transitorio <code>traduccion</code> para guardar la traducción de la palabra "Empleado" en el locale actual, de forma que se imprima correctamente el nombre. El uso del modificador Java <code>transient</code> hace que el atributo sea temporal no sólo para la persistencia sino también para la máquina virtual. Si el <code>Empleado</code> se serializa y se envía desde una MV a otra el valor del atributo <code>traduccion</code> no se enviaría.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
   <span class="tok-nd">@Id</span> <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">id</span><span class="tok-o">;</span>
   <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
   <span class="tok-kd">private</span> <span class="tok-n">Long</span> <span class="tok-n">sueldo</span><span class="tok-o">;</span>
   <span class="tok-kd">transient</span> <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">traduccion</span><span class="tok-o">;</span>
   <span class="tok-c1">// ...</span>

   <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">toString</span><span class="tok-o">()</span> <span class="tok-o">{</span>
      <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">traduccion</span> <span class="tok-o">==</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
         <span class="tok-n">traduccion</span> <span class="tok-o">=</span>
            <span class="tok-n">ResourceBundle</span><span class="tok-o">.</span><span class="tok-na">getBundle</span><span class="tok-o">(</span><span class="tok-s">&quot;EmpResources&quot;</span><span class="tok-o">).</span><span class="tok-na">getString</span><span class="tok-o">(</span><span class="tok-s">&quot;Empleado&quot;</span><span class="tok-o">);</span>
      <span class="tok-o">}</span>
      <span class="tok-k">return</span> <span class="tok-n">traduccion</span> <span class="tok-o">+</span> <span class="tok-s">&quot;: &quot;</span> <span class="tok-o">+</span> <span class="tok-n">id</span> <span class="tok-o">+</span> <span class="tok-s">&quot; &quot;</span> <span class="tok-o">+</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_objetos_embebidos">3.4. Objetos embebidos</h3>
<div class="paragraph">
<p>Un <em>objeto embebido</em> es uno que no tiene identidad propia, y que está ligado a una entidad. Es meramente una parte de una entidad que ha sido separada y almacenada en un objeto Java independiente para adaptar mejor el modelo de datos al dominio. En la definición de la entidad aparece un atributo con un tipo no básico. A primera vista parecería que se está definiendo una relación con otra entidad. Sin embargo, el tipo embebido no tiene entidad suficiente como para definir una entidad persistente por él mismo. Sus datos se almacenan con el resto de la entidad en la misma fila de la base de datos.</p>
</div>
<div class="paragraph">
<p>Un ejemplo muy común es el tipo <code>Direccion</code>. Puede ser que en nuestro dominio una dirección no tenga las características que le hagan definir una entidad persistente (no vamos a hacer búsquedas por direcciones, ni identificadores de direcciones). Sin embargo, queremos guardar los datos que forman la dirección como un atributo del empleado. Y además obtener los beneficios del modelo de objetos considerándolos uno único dato.</p>
</div>
<div class="paragraph">
<p>Las ventajas de agrupar un conjunto de campos en un nuevo tipo de datos Java son múltiples. En primer lugar, abstraemos el modelo físico (representación en la tabla de la base de datos) y obtenemos una representación más cercana al dominio de la aplicación. Podremos utilizar objetos <code>Direccion</code> en distintas partes de la lógica de negocio. En segundo lugar, podemos reutilizar este tipo en más de una entidad, dando consistencia a nuestro modelo físico. Por último, es una forma muy portable de conseguir una características de SQL que nunca se ha llegado a estandarizar: el uso de tipos definidos por el usuario.</p>
</div>
<div class="paragraph">
<p>Vamos a ver el ejemplo con más detalle. La siguiente figura muestra una tabla <code>EMPLEADO</code> que contiene una mezcla de información propia del empleado y de columnas que definen su dirección:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa03/tabla-extendida.png" alt="Empleado" width="15%">
</div>
</div>
<div class="paragraph">
<p>Las columnas <code>CALLE</code>, <code>CIUDAD</code>, <code>PROVINCIA</code> y <code>COD_POSTAL</code> se combinan lógicamente para formar la dirección. En el modelo de objetos podríamos perfectamente abstraer esta información en tipo embebido <code>Direccion</code>. La clase entidad tendría entonces una atributo <code>direccion</code> que referenciaría un objeto embebido de tipo <code>Direccion</code>. La siguiente figura muestra la relación entre <code>Empleado</code> y <code>Direccion</code>. Utilizamos la asociación UML <strong>composición</strong> (en la que se utiliza un rombo como punto de origen de la flecha) para denotar que el <code>Empleado</code> posee completamente la <code>Direccion</code> y que una instancia de <code>Direccion</code> no debe ser compartida con ningún otro objeto salvo la instancia de <code>Empleado</code> que lo posee.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa03/direccion.png" alt="Relación" width="50%">
</div>
</div>
<div class="paragraph">
<p>Con esta representación, no sólo la información de la dirección se encapsula de forma limpia dentro de un objeto, sino que otras entidades como <code>Empresa</code> pueden también utilizar el tipo y tener sus propios atributos de con objetos embebidos de tipo <code>Direccion</code>.</p>
</div>
<div class="paragraph">
<p>Para definir el tipo embebido debemos utilizar la anotación <code>@Embeddable</code> en la definición de la clase. Esta anotación sirve para diferenciar la clase de otras clases normales Java. Una vez que la clase ha sido definida como embebible, sus atributos se harán persistentes como parte de la entidad. Los atributos de mapeo de columnas <code>@Basic</code>, <code>@Temporal</code>, <code>@Enumerado</code>, <code>@Lob</code> y <code>@Column</code> pueden añadirse a los atributos de la clase embebida. El código siguiente muestra un ejemplo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Embeddable</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Direccion</span> <span class="tok-o">{</span>
   <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">calle</span><span class="tok-o">;</span>
   <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">ciudad</span><span class="tok-o">;</span>
   <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">provincia</span><span class="tok-o">;</span>
   <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;COD_POSTAL&quot;</span><span class="tok-o">)</span>
   <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">codigoPostal</span><span class="tok-o">;</span>
   <span class="tok-c1">// ...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para usar esta clase en una entidad hay que declararla con la anotación <code>@Embedded</code>. Se muestra a continuación.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
   <span class="tok-nd">@Id</span> <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">id</span><span class="tok-o">;</span>
   <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
   <span class="tok-kd">private</span> <span class="tok-n">Long</span> <span class="tok-n">sueldo</span><span class="tok-o">;</span>
   <span class="tok-nd">@Embedded</span> <span class="tok-kd">private</span> <span class="tok-n">Direccion</span> <span class="tok-n">direccion</span><span class="tok-o">;</span>
   <span class="tok-c1">// ...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cuando el proveedor realice la persistencia de una instancia de <code>Empleado</code> accederá a los atributos del objeto <code>Direccion</code> como si estuvieran presentes en la propia instancia. El mapeado de las columnas del tipo <code>Direccion</code> se realiza realmente en la tabla <code>EMPLEADO</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_mapeo_de_la_clave_primaria">3.5. Mapeo de la clave primaria</h3>
<div class="paragraph">
<p>Aunque muchas bases de datos heredadas (<em>legacy</em>) utilizan claves primarias naturales, la práctica recomendable es trabajar con claves primarias generadas de forma automática y sin ningún significado fuera del ámbito de la propia gestión de la base de datos. Una clave natural es una clave primaria con un significado de negocio. Por ejemplo, el NIF o el login de un usuario. Por otra parte, una clave generada (también llamada clave subrogada, del inglés <em>surrogate key</em>) no tiene ningún significado propio en el modelo de negocio, sino que únicamente garantiza la unicidad de los datos almacenados en la tabla.</p>
</div>
<div class="paragraph">
<p>Es una buena práctica el utilizar siempre claves primarias generadas. La utilización de claves naturales termina causando problemas. Una clave primaria tiene que ser única, constante y no vacía. Es muy difícil encontrar estas características en los atributos del modelo de negocio. Incluso si los encontramos, es muy frecuente que a lo largo de la vida de la base de datos suceda algún cambio en el negocio que obligue a modificarlos. Por ejemplo, un NIF erróneo que hay que modificar o un nombre de usuario que antes era inmutable y ahora nos piden que sea modificable.</p>
</div>
<div class="paragraph">
<p>La utilización de claves primarias generadas en todas las tablas de nuestra base de datos también proporciona una gran consistencia a la aplicación y permite procedimientos unificados en la gestión de claves ajenas y referencias.</p>
</div>
<div class="paragraph">
<p>Por último, en un modelo orientado a objetos como el de JPA, el uso de claves primarias autogeneradas refuerza la idea de que las entidades son objetos. La clave de una entidad es similar a la dirección de memoria de un objeto. Los objetos mantienen referencias a otros objetos de la misma forma que las entidades guardan claves ajenas a otras entidades. Referencias y claves se utilizan para definir grafos de objetos relacionados entre si. Tanto las claves como las referencias son internas de la aplicación y el usuario no debe conocerlas ni utilizarlas directamente.</p>
</div>
<div class="paragraph">
<p>Aun así, hay muchas bases de datos heredadas para las que será necesario utilizar claves primarias ya existentes. Por ejemplo, es usual la utilización de claves primarias compuestas para asegurarse la unicidad. JPA permite también el mapeo de este tipo de claves primarias.</p>
</div>
<div class="paragraph">
<p>Veremos en primer lugar las estrategias de JPA para implementar claves primarias autogeneradas y después pasaremos a la gestión de claves compuestas para trabajar con bases de datos heredadas.</p>
</div>
<div class="paragraph">
<p>En general, JPA permite utilizar como clave primaria los siguientes tipos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Tipos Java primitivos</strong>: <code>byte</code>, <code>int</code>, <code>short</code>, <code>long</code>, <code>char</code></p>
</li>
<li>
<p><strong>Clases wrapper de tipos primitivos</strong>: <code>Byte</code>, <code>Integer</code>, <code>Short</code>, <code>Long</code>, <code>Character</code></p>
</li>
<li>
<p><strong>Arrays de tipos primitivos o de clases wrappers</strong></p>
</li>
<li>
<p><strong>Cadenas</strong>: <code>java.lang.String</code></p>
</li>
<li>
<p><strong>Tipos numéricos grandes</strong>: <code>java.math.BigInteger</code></p>
</li>
<li>
<p><strong>Tipos temporales</strong>: <code>java.util.Date</code>, <code>java.sql.Date</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Igual que con los mapeos básicos, la anotación <code>@Column</code> puede utilizarse para modificar el nombre con el que el atributo identificador se hace persistente. Si no se utiliza sucede igual que con los mapeos básicos y el campo se guarda en la columna con el mismo nombre.</p>
</div>
<div class="sect3">
<h4 id="_generación_del_identificador">3.5.1. Generación del identificador</h4>
<div class="paragraph">
<p>Se utiliza la anotación <code>@GeneratedValue</code> para definir una clave primaria única generada de forma automática.</p>
</div>
<div class="paragraph">
<p>Es importante tener en cuenta que en este caso el identificador de la entidad puede ser que no esté disponible hasta que se haya realizado la inserción en la base de datos. Esto no significa que no lo podamos utilizar. Podríamos por ejemplo, asignarlo a otra entidad en una relación entre entidades o modificar sus atributos. Cuando se realiza un <em>flush</em> es cuando nos podemos asegurar que se actualiza automáticamente esta clava primaria.</p>
</div>
<div class="paragraph">
<p>Existen cuatro estrategias de generación de id que se seleccionan mediante el elemento <code>strategy</code> de la anotación. Son <code>AUTO</code>, <code>IDENTITY</code>, <code>SEQUENCE</code> o <code>TABLE</code>. Para definir el tipo de estrategia se utilizan los valores enumerados del tipo <code>GenerationType</code>.</p>
</div>
<div class="paragraph">
<p>Con la opción AUTO dejamos que sea el proveedor de persistencia el que se ocupe de cómo generar los identificadores. El siguiente código muestra un ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
   <span class="tok-nd">@Id</span> <span class="tok-nd">@GeneratedValue</span><span class="tok-o">(</span><span class="tok-n">strategy</span><span class="tok-o">=</span><span class="tok-n">GenerationType</span><span class="tok-o">.</span><span class="tok-na">AUTO</span><span class="tok-o">)</span>
   <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">id</span><span class="tok-o">;</span>
   <span class="tok-c1">// ...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Esta estrategia es muy portable, ya que se mapea a los distintos sistemas de generación de identidades usados por los sistemas de gestión de base de datos, como <em>identity</em>, <em>sequence</em> o <em>HiLo</em>.</p>
</div>
<div class="paragraph">
<p>En la estrategia IDENTITY se definen columnas que utilizan la estrategia <em>identity</em> de DB2, MySQL, MS SQL Server, Sybase, y HypersonicSQL. El identificador devuelto es de tipo <code>long</code>, <code>short</code>, <code>int</code>.</p>
</div>
<div class="paragraph">
<p>En la estrategia SEQUENCE crea una secuencia en DB2, PostgreSQL, Oracle, SAP DB; o un generador en InterBase. El tipo devuelto es también <code>long</code>, <code>short</code>, <code>int</code>.</p>
</div>
<div class="paragraph">
<p>Por último, en la estrategia TABLE se usa una tabla de la base de datos que guarda las últimas claves primarias generadas. Cada fila de la tabla corresponde a una clave primaria. La tabla tiene dos columnas: <code>pkColumnName</code> y <code>valueColumnName</code>. La columna <code>pkColumnValue</code> define el generador de clave primaria y la columna valor guarda la última generada.</p>
</div>
</div>
<div class="sect3">
<h4 id="_clave_primaria_compuesta">3.5.2. Clave primaria compuesta</h4>
<div class="paragraph">
<p>En ocasiones tenemos que mapear a JPA bases de datos heredadas con múltiples configuraciones y características. Una de las más frecuentes es el uso de las claves primarias compuestas, en las que dos columnas de la tabla forman una única clave primaria.</p>
</div>
<div class="paragraph">
<p>La especificación de JPA permite utilizar hasta tres estrategias distintas para manejar claves compuestas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Encapsular los atributos de la clave compuesta en una clase separada y marcarla como <code>@Embeddable</code> como un componente normal. Usar un atributo de esta clase como clave compuesta anotándolo con el atributo <code>@Id</code> como siempre.</p>
</li>
<li>
<p>Encapsular los atributos de la clave compuesta en una clase separada sin ninguna anotación. Usar un atributo de esta clase como clave compuesta anotándolo con <code>@EmbeddedId</code>.</p>
</li>
<li>
<p>Incluir la anotación <code>@IdClass</code> referenciando la clase que implementa la clave compuesta y declarar explícitamente todos los atributos que forman la clave compuesta.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>En todas las estrategias hay que definir una clase con los atributos de la clave compuesta. Lo que cambia es la forma de utilizar esa clase. Veamos un ejemplo. Supongamos que queremos mapear una tabla <code>USUARIOS</code> con una clave primaria compuesta formada por <code>USUARIO</code> y <code>DEPTO</code>, ambos <code>VARCHAR</code>. Usando la primera opción, que debemos crear una clase <code>UsuarioId</code> con la anotación <code>@Embeddable</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Embeddable</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">UsuarioId</span> <span class="tok-kd">implements</span> <span class="tok-n">Serializable</span> <span class="tok-o">{</span>
   <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">username</span><span class="tok-o">;</span>
   <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">departamento</span><span class="tok-o">;</span>

   <span class="tok-o">...</span>

   <span class="tok-kd">public</span> <span class="tok-kt">boolean</span> <span class="tok-nf">equals</span><span class="tok-o">(</span><span class="tok-n">Object</span> <span class="tok-n">o</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">o</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-n">o</span> <span class="tok-k">instanceof</span> <span class="tok-n">UsuarioId</span><span class="tok-o">)</span> <span class="tok-o">{</span>
         <span class="tok-n">Id</span> <span class="tok-n">that</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-n">Id</span><span class="tok-o">)</span> <span class="tok-n">o</span><span class="tok-o">;</span>
         <span class="tok-k">return</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">username</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">that</span><span class="tok-o">.</span><span class="tok-na">username</span><span class="tok-o">)</span> <span class="tok-o">&amp;&amp;</span>
                <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">departamento</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">that</span><span class="tok-o">.</span><span class="tok-na">departamento</span><span class="tok-o">);</span>
         <span class="tok-o">}</span> <span class="tok-k">else</span> <span class="tok-o">{</span>
            <span class="tok-k">return</span> <span class="tok-kc">false</span><span class="tok-o">;</span>
         <span class="tok-o">}</span>
      <span class="tok-o">}</span>

   <span class="tok-kd">public</span> <span class="tok-kt">int</span> <span class="tok-nf">hashCode</span><span class="tok-o">()</span> <span class="tok-o">{</span>
      <span class="tok-k">return</span> <span class="tok-n">username</span><span class="tok-o">.</span><span class="tok-na">hashCode</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-n">departamento</span><span class="tok-o">.</span><span class="tok-na">hashCode</span><span class="tok-o">();</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y en la entidad principal utilizamos esta clase como clave primaria, indicando los nombres de las columnas con la anotación <code>@AttributeOverride</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-nd">@Table</span><span class="tok-o">(</span><span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s">&quot;USUARIOS&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Usuario</span> <span class="tok-o">{</span>
   <span class="tok-nd">@Id</span>
   <span class="tok-nd">@AttributeOverrides</span><span class="tok-o">({</span>
      <span class="tok-nd">@AttributeOverride</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;username&quot;</span><span class="tok-o">,</span> <span class="tok-n">column</span><span class="tok-o">=</span><span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;USUARIO&quot;</span><span class="tok-o">)),</span>
      <span class="tok-nd">@AttributeOverride</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;depto&quot;</span><span class="tok-o">,</span> <span class="tok-n">column</span><span class="tok-o">=</span><span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;DEPTO&quot;</span><span class="tok-o">))</span>
   <span class="tok-o">})</span>
   <span class="tok-kd">private</span> <span class="tok-n">UsuarioId</span> <span class="tok-n">usuarioId</span><span class="tok-o">;</span>
   <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En la segunda estrategia creamos la clase <code>UsuarioId</code> pero sin la anotación <code>@Embeddable</code>. Después declaramos la clave primaria compuesta igual que antes, pero utilizando la anotación <code>@EmbeddedId</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-nd">@Table</span><span class="tok-o">(</span><span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s">&quot;USUARIOS&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Usuario</span> <span class="tok-o">{</span>
   <span class="tok-nd">@EmbeddedId</span>
   <span class="tok-nd">@AttributeOverrides</span><span class="tok-o">({</span>
      <span class="tok-nd">@AttributeOverride</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;username&quot;</span><span class="tok-o">,</span> <span class="tok-n">column</span><span class="tok-o">=</span><span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;USUARIO&quot;</span><span class="tok-o">)),</span>
      <span class="tok-nd">@AttributeOverride</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;depto&quot;</span><span class="tok-o">,</span> <span class="tok-n">column</span><span class="tok-o">=</span><span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;DEPTO&quot;</span><span class="tok-o">))</span>
   <span class="tok-o">})</span>
   <span class="tok-kd">private</span> <span class="tok-n">UsuarioId</span> <span class="tok-n">usuarioId</span><span class="tok-o">;</span>
  <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_clave_ajena_compuesta">3.5.3. Clave ajena compuesta</h4>
<div class="paragraph">
<p>Por último, también entidads posible utilizar la nueva clave primaria compuesta como una clave ajena. Supongamos una entidad <code>Item</code> que tiene una relación muchos-a-uno con <code>Usuario</code>. Primero mapeamos la asociación de <code>Item</code> a <code>Usuario</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@ManyToOne</span>
<span class="tok-nd">@JoinColumns</span><span class="tok-o">({</span>
  <span class="tok-nd">@JoinColumn</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;USUARIO&quot;</span><span class="tok-o">,</span> <span class="tok-n">referencedColumnName</span> <span class="tok-o">=</span> <span class="tok-s">&quot;USUARIO&quot;</span><span class="tok-o">),</span>
  <span class="tok-nd">@JoinColumn</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;DEPTO&quot;</span><span class="tok-o">,</span> <span class="tok-n">referencedColumnName</span> <span class="tok-o">=</span> <span class="tok-s">&quot;DEPTO&quot;</span><span class="tok-o">)</span>
<span class="tok-o">})</span>
<span class="tok-kd">private</span> <span class="tok-n">Usuario</span> <span class="tok-n">vendedor</span><span class="tok-o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La diferencia principal con un mapeo normal <code>@ManyToOne</code> es el número de columnas usadas. Si no se usara la anotación <code>referencedColumnName</code> habría que tener cuidado en definir las columnas en el mismo orden en el que se declaran en la clase de la clave primaria.</p>
</div>
<div class="paragraph">
<p>El mapeo inverso de <code>Usuario</code> a <code>Item</code> es aun mas sencillo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@OneToMany</span><span class="tok-o">(</span><span class="tok-n">mappedBy</span> <span class="tok-o">=</span> <span class="tok-s">&quot;seller&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">private</span> <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Item</span><span class="tok-o">&gt;</span> <span class="tok-n">itemsForAuction</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">HashSet</span><span class="tok-o">&lt;</span><span class="tok-n">Item</span><span class="tok-o">&gt;();</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_mapeado_de_las_relaciones_de_herencia">3.6. Mapeado de las relaciones de herencia</h3>
<div class="paragraph">
<p>Una de las diferencias fundamentales entre un modelo orientado a objetos y un modelo relacional es la existencia en el primero de herencia entre clases o entidades. La definición de herencia es algo muy natural y útil en modelos orientados a objetos. Por ejemplo, siguiendo con nuestro ejemplo de <code>Empleado</code>, supongamos que queremos definir dos tipos de empleado: <code>EmpleadoContratado</code> y <code>EmpleadoBecario</code>, cada uno de ellos con sus propios atributos adicionales. Supongamos también que cualquier empleado deba ser de uno de los subtipos, de forma que no se permita crear instancias del tipo padre. Para ello, en programación OO deberíamos definir la clase <code>Empleado</code> como <em>abstracta</em> y las dos clases deberían ser subclases de ella.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa03/jpa-herencia.png" alt="Relaciones de herencia" width="50%">
</div>
</div>
<div class="paragraph">
<p>JPA permite mapear estas relaciones de herencia en tablas de la base de datos. Existen tres posibles estrategias para realizar este mapeo:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Tabla única</p>
</li>
<li>
<p>Tablas join</p>
</li>
<li>
<p>Una tabla por clase</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Vamos a ver la estrategia más común, la de tabla única.</p>
</div>
<div class="paragraph">
<p>En la estrategia de tabla única, todas las clases en la jerarquía de herencia se mapean en una única tabla. Esta tabla contiene almacenadas todas las instancias de todos los posibles subtipos. Los distintos objetos en la jerarquía OO se identifican utilizando una columna especial denominada columna discriminante (<em>disriminator column</em>). Esta columna contiene un valor distinto según la clase a la que pertenezca el objeto. Además, las columnas que no se correspondan con atributos de un tipo dado se rellenan con NULL.</p>
</div>
<div class="paragraph">
<p>Supongamos que un <code>EmpleadoBecario</code> tiene un atributo <code>SeguroMedico</code> de tipo <code>Long</code> con la aportación que debe realizar la empresa para el seguro del empleado. Y el <code>EmpleadoContratado</code> tienen un atributo <code>PlanPensiones</code> de tipo <code>Long</code> con la aportación para el plan de pensiones.</p>
</div>
<div class="paragraph">
<p>En la figura siguiente aparece la tabla única que guardaría entidades de ambos tipos. La columna discriminante es la columna <code>Tipo</code>. La tabla contiene todos los registros. Los registros que se corresponden con empleados contratados tienen el valor <code>Contrato</code> en la columna discriminante y los empleados becarios <code>Beca</code>. Las columnas que no se correspondan con el tipo de entidad están a NULL.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/jpa03/jpa-herencia-tabla.png" alt="Tabla herencia" width="66%">
</div>
</div>
<div class="paragraph">
<p>Para implementar la herencia en JPA se utiliza la anotación <code>@Inheritance</code> en la clase padre. En esta anotación hay que indicar la estrategia de mapeado utilizada con el elemento <code>strategy</code>. También hay que añadir a la clase padre la anotación <code>@DiscriminatorValue</code> que indica la columna discriminante. El tipo de la columna discriminante se define con el elemento <code>discriminatorType</code> que puede tomar como valor las constantes <code>DiscriminatorType.STRING</code>, <code>DiscriminatorType.INTEGER</code> o <code>DiscriminatorType.CHAR</code>.</p>
</div>
<div class="paragraph">
<p>El siguiente código muestra cómo sería la definición de la clase <code>Empleado</code>. En este caso la estamos definiendo como <code>abstract</code> para impedir crear instancias y obligar a que las instancias sean de las clases hijas. No es obligatorio hacerlo así, podría darse el caso de que nos interesara también tener instancias de la clase padre sin especificar el tipo de empleado.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-nd">@Inheritance</span><span class="tok-o">(</span><span class="tok-n">strategy</span><span class="tok-o">=</span><span class="tok-n">InheritanceType</span><span class="tok-o">.</span><span class="tok-na">SINGLE_TABLE</span><span class="tok-o">)</span>
<span class="tok-nd">@DiscriminatorColumn</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;Tipo&quot;</span><span class="tok-o">,</span> <span class="tok-n">discriminatorType</span><span class="tok-o">=</span><span class="tok-n">DiscriminatorType</span><span class="tok-o">.</span><span class="tok-na">STRING</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">abstract</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
   <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Las subclases de la jerarquía se definen igual que en Java estándar (recordemos que las entidades son clases Java normales) con la palabra clave <code>extends</code>. Lo único que hay que añadir es el valor en la columna discriminante que se le asigna a esta clase. Para ello se utiliza la anotación <code>DiscriminatorValue</code> y su atributo <code>value</code>. Por ejemplo, si el <code>EmpleadoBecario</code> va a tener como valor la cadena <code>Beca</code>, hay que indicar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@DiscriminatorValue</span><span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-s">&quot;Beca&quot;</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Las definiciones de las subclases las mostramos a continuación. Primero la clase <code>EmpleadoContratado</code>, que se asocia al valor <code>Contrato</code> de la columna discriminante. En la nueva clase se define al atributo específico <code>Long planPensiones</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.*</span><span class="tok-o">;</span>

<span class="tok-nd">@Entity</span>
<span class="tok-nd">@DiscriminatorValue</span><span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-s">&quot;Contrato&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">EmpleadoContratado</span> <span class="tok-kd">extends</span> <span class="tok-n">Empleado</span> <span class="tok-o">{</span>
   <span class="tok-kd">private</span> <span class="tok-n">Long</span> <span class="tok-n">planPensiones</span><span class="tok-o">;</span>

   <span class="tok-kd">public</span> <span class="tok-n">Long</span> <span class="tok-nf">getPlanPensiones</span><span class="tok-o">()</span> <span class="tok-o">{</span>
      <span class="tok-k">return</span> <span class="tok-n">planPensiones</span><span class="tok-o">;</span>
   <span class="tok-o">}</span>

   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setPlanPensiones</span><span class="tok-o">(</span><span class="tok-n">Long</span> <span class="tok-n">planPensiones</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">planPensiones</span> <span class="tok-o">=</span> <span class="tok-n">planPensiones</span><span class="tok-o">;</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por último, la clase <code>EmpleadoBecario</code> se distingue por el valor <code>Beca</code>. En la clase se define el nuevo atributo <code>Long seguroMedico</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Entity</span>
<span class="tok-nd">@DiscriminatorValue</span><span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-s">&quot;Beca&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">EmpleadoBecario</span> <span class="tok-kd">extends</span> <span class="tok-n">Empleado</span> <span class="tok-o">{</span>
   <span class="tok-kd">private</span> <span class="tok-n">Long</span> <span class="tok-n">seguroMedico</span><span class="tok-o">;</span>

   <span class="tok-kd">public</span> <span class="tok-n">Long</span> <span class="tok-nf">getSeguroMedico</span><span class="tok-o">()</span> <span class="tok-o">{</span>
      <span class="tok-k">return</span> <span class="tok-n">seguroMedico</span><span class="tok-o">;</span>
   <span class="tok-o">}</span>

   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setSeguroMedico</span><span class="tok-o">(</span><span class="tok-n">Long</span> <span class="tok-n">seguroMedico</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">seguroMedico</span> <span class="tok-o">=</span> <span class="tok-n">seguroMedico</span><span class="tok-o">;</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En las clases hijas no se define la clave primaria. Debe estar definida en la clase padre. Lo mismo sucede con los método <code>equals()</code> y <code>hashCode()</code>, los debemos definir en la clase padre. En la comprobación de igualdad se debe utilizar la comprobación de identidad de clase para identificar como distintos objetos de distintas subclases (podemos usar el asistente de Eclipse para generar el método).</p>
</div>
<div class="paragraph">
<p>Con esto es suficiente. Una vez definidas, las entidades se usan como clases Java normales:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">Empleado</span> <span class="tok-n">emp</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">EmpleadoContratado</span><span class="tok-o">();</span>
<span class="tok-n">emp</span><span class="tok-o">.</span><span class="tok-na">setId</span><span class="tok-o">(</span><span class="tok-n">id</span><span class="tok-o">);</span>
<span class="tok-n">emp</span><span class="tok-o">.</span><span class="tok-na">setNombre</span><span class="tok-o">(</span><span class="tok-n">nombre</span><span class="tok-o">);</span>
<span class="tok-n">emp</span><span class="tok-o">.</span><span class="tok-na">setSueldo</span><span class="tok-o">(</span><span class="tok-n">sueldo</span><span class="tok-o">);</span>
<span class="tok-n">emp</span><span class="tok-o">.</span><span class="tok-na">setPlanPensiones</span><span class="tok-o">(</span><span class="tok-n">sueldo</span><span class="tok-o">/</span><span class="tok-mi">10</span><span class="tok-o">);</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_bean_validation">3.7. Bean Validation</h3>
<div class="paragraph">
<p><em>Bean Validation</em> es un API de la especificación Java EE con el que es posible definir restricciones a los posibles valores de los atributos de cualquier clase Java definida en forma de <em>JavaBean</em> utilizando anotaciones. Existen unas restricciones predefinidas y es posible definir validaciones <em>custom</em>. En la última versión 1.1 de la especificación se incluye también la posibilidad de validad los parámetros y los valores devueltos en cualquier método Java.</p>
</div>
<div class="paragraph">
<p>El API se puede aplicar a cualquier clase Java, no está limitada a entidades JPA. De hecho es muy útil para validar datos que se reciben en las peticiones a los servicios antes de crear las propias entidades. Sin embargo en los ejemplos que mostramos a continuación sólo utilizamos el API para anotar atributos de entidades JPA.</p>
</div>
<div class="paragraph">
<p>Al igual que JPA, <em>Bean Validation</em> es parte de la especificación Java EE pero puede utilizarse en aplicaciones Java <em>standalone</em> Java SE, junto con JPA. El propio gestor de persistencia detecta las anotaciones y se encarga de asegurar las restricciones antes de actualizar los datos en la base de datos. Para usar <em>Bean Validation</em> en una aplicación Java <em>standalone</em> basta con incluir las librerías necesarias en el classpath (en nuestro caso, actualizaando el POM de Maven).</p>
</div>
<div class="paragraph">
<p>La última especificación aprobada es la <a href="https://www.jcp.org/en/jsr/detail?id=349">JSR 349</a> correspondiente a Bean Validation 1.1. Puedes consultar en el siguiente enlace el <a href="https://docs.oracle.com/javaee/7/api/javax/validation/package-summary.html">API completo de Bean Validation</a>. El líder de la especificación es Emmanuel Bernard, de Red Hat. Mantiene <a href="http://beanvalidation.org">una página sobre el API</a> en la que también publica novedades y noticias.</p>
</div>
<div class="sect3">
<h4 id="_configuración_de_maven_y_jpa">3.7.1. Configuración de Maven y JPA</h4>
<div class="paragraph">
<p>La activación de <em>Bean Validation</em> es automática si utilizamos JPA. Hay que incluir las siguiente dependencias en el <code>pom.xml</code>. La primera es la implementación de Hibernate del API de validación, y las otras dos son dos librerías necesarias que hay que incluir sólo si estamos ejecutando una aplicación <em>standalone</em>. En el caso de una aplicación web, las proporciona el servidor de aplicaciones.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;dependency&gt;</span>
    <span class="tok-nt">&lt;groupId&gt;</span>org.hibernate<span class="tok-nt">&lt;/groupId&gt;</span>
    <span class="tok-nt">&lt;artifactId&gt;</span>hibernate-validator<span class="tok-nt">&lt;/artifactId&gt;</span>
    <span class="tok-nt">&lt;version&gt;</span>5.1.3.Final<span class="tok-nt">&lt;/version&gt;</span>
<span class="tok-nt">&lt;/dependency&gt;</span>
    <span class="tok-nt">&lt;dependency&gt;</span>
    <span class="tok-nt">&lt;groupId&gt;</span>javax.el<span class="tok-nt">&lt;/groupId&gt;</span>
    <span class="tok-nt">&lt;artifactId&gt;</span>javax.el-api<span class="tok-nt">&lt;/artifactId&gt;</span>
    <span class="tok-nt">&lt;version&gt;</span>2.2.4<span class="tok-nt">&lt;/version&gt;</span>
<span class="tok-nt">&lt;/dependency&gt;</span>
    <span class="tok-nt">&lt;dependency&gt;</span>
    <span class="tok-nt">&lt;groupId&gt;</span>org.glassfish.web<span class="tok-nt">&lt;/groupId&gt;</span>
    <span class="tok-nt">&lt;artifactId&gt;</span>el-impl<span class="tok-nt">&lt;/artifactId&gt;</span>
    <span class="tok-nt">&lt;version&gt;</span>2.2<span class="tok-nt">&lt;/version&gt;</span>
<span class="tok-nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por defecto, el <em>entity manager</em> de JPA realiza la comprobación de las restricciones <em>Bean Validation</em> si el JAR se encuentra en el classpath. Se puede definir el comportamiento en el fichero <code>persistence.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;persistence</span> <span class="tok-na">version=</span><span class="tok-s">&quot;2.1&quot;</span>
             <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://xmlns.jcp.org/xml/ns/persistence&quot;</span>
             <span class="tok-na">xmlns:xsi=</span><span class="tok-s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
             <span class="tok-na">xsi:schemaLocation=</span><span class="tok-s">&quot;http://xmlns.jcp.org/xml/ns/persistence&quot;</span><span class="tok-nt">&gt;</span>

    <span class="tok-nt">&lt;persistence-unit</span> <span class="tok-na">name=</span><span class="tok-s">&quot;mensajes&quot;</span> <span class="tok-na">transaction-type=</span><span class="tok-s">&quot;RESOURCE_LOCAL&quot;</span><span class="tok-nt">&gt;</span>

        <span class="tok-nt">&lt;provider&gt;</span>org.hibernate.jpa.HibernatePersistenceProvider<span class="tok-nt">&lt;/provider&gt;</span>
        <span class="tok-nt">&lt;class&gt;</span>org.expertojava.jpa.mensajes.modelo.Autor<span class="tok-nt">&lt;/class&gt;</span>
        <span class="tok-nt">&lt;class&gt;</span>org.expertojava.jpa.mensajes.modelo.Mensaje<span class="tok-nt">&lt;/class&gt;</span>

        <span class="tok-nt">&lt;validation-mode&gt;</span>CALLBACK<span class="tok-nt">&lt;/validation-mode&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>

        <span class="tok-nt">&lt;properties&gt;</span>

            <span class="tok-c">&lt;!-- JPA properties --&gt;</span>

            <span class="tok-c">&lt;!-- Hibernate properties --&gt;</span>

	<span class="tok-nt">&lt;/properties&gt;</span>
    <span class="tok-nt">&lt;/persistence-unit&gt;</span>
<span class="tok-nt">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configuración de la validación <em>Bean Validation</em></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Los posibles valores del campo <code>validation-mode</code> son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>AUTO</code>: Si el JAR de <em>Bean Validation</em> se encuentra en el classpath se activa el modo <code>CALLBACK</code>, si no no pasa nada</p>
</li>
<li>
<p><code>CALLBACK</code>: Se validan las entidades usando <em>Bean Validation</em> en el momento de creación, actualización y borrado. Si el JAR de validación no se encuentra en el classpath se lanza una excepción.</p>
</li>
<li>
<p><code>NONE</code>: No se realiza la validación de <em>Bean Validation</em></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_anotaciones_de_validación_predefinidas">3.7.2. Anotaciones de validación predefinidas</h4>
<div class="paragraph">
<p>Mediante las anotaciones predefinidas en el <a href="https://docs.oracle.com/javaee/7/api/javax/validation/constraints/package-summary.html">paquete javax.validation.constraints</a> podemos restringir los valores que pueden tomar atributos de un JavaBean (clase Java en la que se definen atributos y <em>getters</em> y <em>setters</em>). Las entidades JPA son JavaBeans, por lo que podemos utilizar este API para restringir los valores de sus campos.</p>
</div>
<div class="paragraph">
<p>Las restricciones definidas por <em>Bean Validation</em> son independientes de las definidas por las anotaciones JPA, se validan y comprueban en memoria y no generan ninguna anotación adicional en el esquema de base de datos.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, la siguiente definición de la entidad <code>Empleado</code> obliga a que el nombre y los apellidos no sean <code>null</code> (en memoria), que el tamaño de la cadena no sea mayor de 25 caracteres y que el sueldo no sea mayor de 50.000.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">import</span> <span class="tok-nn">javax.validation.constraints.NotNull</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.validation.constraints.Size</span><span class="tok-o">;</span>

<span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Empleado</span> <span class="tok-o">{</span>
    <span class="tok-nd">@Id</span>
    <span class="tok-nd">@GeneratedValue</span><span class="tok-o">(</span><span class="tok-n">strategy</span><span class="tok-o">=</span><span class="tok-n">GenerationType</span><span class="tok-o">.</span><span class="tok-na">AUTO</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-kt">int</span> <span class="tok-n">idEmpleado</span><span class="tok-o">;</span>

    <span class="tok-nd">@NotNull</span>
    <span class="tok-nd">@Size</span><span class="tok-o">(</span><span class="tok-n">max</span> <span class="tok-o">=</span> <span class="tok-mi">25</span><span class="tok-o">)</span>
    <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">nullable</span> <span class="tok-o">=</span> <span class="tok-kc">false</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>

    <span class="tok-nd">@NotNull</span>
    <span class="tok-nd">@Size</span><span class="tok-o">(</span><span class="tok-n">max</span> <span class="tok-o">=</span> <span class="tok-mi">25</span><span class="tok-o">)</span>
    <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">nullable</span> <span class="tok-o">=</span> <span class="tok-kc">false</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">apellidos</span><span class="tok-o">;</span>

    <span class="tok-nd">@NotNull</span>
    <span class="tok-nd">@DecimalMax</span><span class="tok-o">(</span><span class="tok-n">value</span> <span class="tok-o">=</span> <span class="tok-s">&quot;50000.00&quot;</span><span class="tok-o">)</span>
    <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">nullable</span> <span class="tok-o">=</span> <span class="tok-kc">false</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">Double</span> <span class="tok-n">sueldo</span><span class="tok-o">;</span>

    <span class="tok-kd">public</span> <span class="tok-nf">Empleado</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">,</span> <span class="tok-n">String</span> <span class="tok-n">apellidos</span><span class="tok-o">,</span> <span class="tok-n">Double</span> <span class="tok-n">sueldo</span><span class="tok-o">)</span> <span class="tok-o">{</span>
       <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">nombre</span> <span class="tok-o">=</span> <span class="tok-n">numbre</span><span class="tok-o">;</span>
       <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">apellidos</span> <span class="tok-o">=</span> <span class="tok-n">apellidos</span><span class="tok-o">;</span>
       <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">sueldo</span> <span class="tok-o">=</span> <span class="tok-n">sueldo</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">int</span> <span class="tok-nf">getIdEmpleado</span><span class="tok-o">()</span> <span class="tok-o">{</span>
       <span class="tok-k">return</span> <span class="tok-n">idEmployee</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">private</span> <span class="tok-kt">void</span> <span class="tok-nf">setIdEmpleado</span><span class="tok-o">(</span><span class="tok-kt">int</span> <span class="tok-n">idEmpleado</span><span class="tok-o">)</span> <span class="tok-o">{</span>
       <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">idEmpleado</span> <span class="tok-o">=</span> <span class="tok-n">idEmpleado</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getNombre</span><span class="tok-o">()</span> <span class="tok-o">{</span>
       <span class="tok-k">return</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setNombre</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span><span class="tok-o">)</span> <span class="tok-o">{</span>
       <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">nombre</span> <span class="tok-o">=</span> <span class="tok-n">nombre</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getApellidos</span><span class="tok-o">()</span> <span class="tok-o">{</span>
      <span class="tok-k">return</span> <span class="tok-n">apellidos</span><span class="tok-o">;</span>
   <span class="tok-o">}</span>

   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setApellidos</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">apellidos</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">apellidos</span> <span class="tok-o">=</span> <span class="tok-n">apellidos</span><span class="tok-o">;</span>
   <span class="tok-o">}</span>

   <span class="tok-kd">public</span> <span class="tok-n">Double</span> <span class="tok-nf">getSueldo</span><span class="tok-o">()</span> <span class="tok-o">{</span>
      <span class="tok-k">return</span> <span class="tok-n">sueldo</span><span class="tok-o">;</span>
   <span class="tok-o">}</span>

   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setSueldo</span><span class="tok-o">(</span><span class="tok-n">Double</span> <span class="tok-n">sueldo</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">sueldo</span> <span class="tok-o">=</span> <span class="tok-n">sueldo</span><span class="tok-o">;</span>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La lista de restricciones estándar que proporciona el API es la siguiente:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33%;">
<col style="width: 33%;">
<col style="width: 33%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Anotación</th>
<th class="tableblock halign-left valign-top">Descripción</th>
<th class="tableblock halign-left valign-top">Ejemplo</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@AssertFalse</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">El valor debe ser <code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@AssertFalse</code><br>
<code>boolean noSoportado;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@AssertTrue</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">El valor debe ser <code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@AssertTrue</code><br>
<code>boolean siempreActivo;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@DecimalMax</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">El valor debe ser un valor decimal menor o igual que el número especificado</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@DecimalMax("30.00")</code><br>
<code>BigDecimal descuento;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@DecimalMin</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">El valor debe ser un valor decimal mayor o igual que el número especificado</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@DecimalMin("5.00")</code><br>
<code>BigDecimal descuento;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Digits</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">El valor debe ser un número dentro de un rango especificado. El elemento <code>integer</code> especifica el máximo número de dígitos enteros y el elemento <code>fraction</code> el número máximo de dígitos fraccionales.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Digits(integer=6, fraction=2)</code><br>
<code>BigDecimal precio;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Future</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">El valor debe ser una fecha en el futuro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Future</code><br>
<code>Date eventoFuturo;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Max</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">El valor debe ser menor o igual que el número especificado</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Max(10)</code><br>
<code>int cantidad;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Min</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">El valor debe ser mayor o igual que el número especificado</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Min(5)</code><br>
<code>int cantidad;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@NotNull</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">El valor no debe ser <code>null</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@NotNull</code>+
<code>String username;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Null</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">El valor debe ser <code>null</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Null</code><br>
<code>String cadenaNoUsada;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Past</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">El valor debe ser una fecha en el pasado</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Past</code><br>
`Date birthday;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Pattern</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">El valor debe ser una cadena que cumple la expresión regular definida en el elemento <code>regexp</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Pattern(regexp="\\(\\d{3}\\)\\d{3}-\\d{4}")</code><br>
<code>String numeroTelefono;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Size</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Se evalúa el tamaño del atributo y se comprueba si cumple la dimensión especificada. Se puede aplicar a <code>String</code>, <code>Collection</code>, <code>Map</code> o <code>Array</code>. Se pueden utilizar los elementos opcionales <code>min</code> y <code>max</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Size(min=2, max=240)</code><br>
<code>String mensajeCorto;</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_proceso_de_validación">3.7.3. Proceso de validación</h4>
<div class="paragraph">
<p>Si algún valor no cumple la restricción, se lanza una excepción <em>unchecked</em> (de tiempo de ejecución) de tipo <code>javax.validation.ConstraintViolationException</code>. El momento en que se hace la validación depende de la implementación del API. Hibernate valida todas las restricciones cuando hace un <em>flush</em> a la base de datos. Otros proveedores de persistencia (EclipseLink, por ejemplo) lo hacen en el propio método <code>persist</code> o <code>merge</code>.</p>
</div>
<div class="paragraph">
<p>En todas las operaciones de la capa de servicio se deben capturar las excepciones y cerrar la transacción y el <em>entity manager</em> de forma correcta. Vamos a actualizar el código de una de las operaciones que vimos en la sesión anterior con el manejo de las excepciones. La llamada <code>em.flush</code> justo antes de realizar el commit de la transacción asegura que el proveedor (en nuestro caso Hibernate) realiza la validación de las restricciones antes y que se lanza la excepción <code>ConstraintViolationException</code>. En el caso de Hibernate, si no lo pusiéramos, la excepción se lanzaría dentro del <code>tx.commit()</code> y sería envuelta por una excepción de tipo <code>RollbackException</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">PeliculaServicio</span> <span class="tok-o">{</span>

   <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">Log</span> <span class="tok-n">logger</span> <span class="tok-o">=</span> <span class="tok-n">LogFactory</span><span class="tok-o">.</span><span class="tok-na">getLog</span><span class="tok-o">(</span><span class="tok-n">BibliotecaBR</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>

   <span class="tok-c1">//</span>
   <span class="tok-c1">// Hay que actualizar todos los métodos de negocio hay para que capturen</span>
   <span class="tok-c1">// las excepciones producidas por la capa de validación y de datos</span>
   <span class="tok-c1">//</span>

   <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">actualizaRecaudacionPelicula</span><span class="tok-o">(</span>
         <span class="tok-n">Long</span> <span class="tok-n">idPelicula</span><span class="tok-o">,</span>
	 <span class="tok-n">Double</span> <span class="tok-n">recaudacion</span><span class="tok-o">)</span> <span class="tok-o">{</span>

   <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">EmfSingleton</span><span class="tok-o">.</span><span class="tok-na">getInstance</span><span class="tok-o">().</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
   <span class="tok-n">EntityTransaction</span> <span class="tok-n">tx</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">();</span>
   <span class="tok-k">try</span> <span class="tok-o">{</span>                        <i class="conum" data-value="1"></i><b>(1)</b>
      <span class="tok-n">tx</span><span class="tok-o">.</span><span class="tok-na">begin</span><span class="tok-o">();</span>
      <span class="tok-n">PeliculaDao</span> <span class="tok-n">daoPelicula</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">PeliculaDao</span><span class="tok-o">(</span><span class="tok-n">em</span><span class="tok-o">);</span>
      <span class="tok-n">Pelicula</span> <span class="tok-n">pelicula</span> <span class="tok-o">=</span> <span class="tok-n">daoPelicula</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">idPelicula</span><span class="tok-o">);</span>
      <span class="tok-n">pelicula</span><span class="tok-o">.</span><span class="tok-na">setRecaudacion</span><span class="tok-o">(</span><span class="tok-n">recaudacion</span><span class="tok-o">);</span>
      <span class="tok-n">daoPelicula</span><span class="tok-o">.</span><span class="tok-na">update</span><span class="tok-o">(</span><span class="tok-n">pelicula</span><span class="tok-o">);</span>
      <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">flush</span><span class="tok-o">();</span>	<i class="conum" data-value="2"></i><b>(2)</b>
      <span class="tok-n">tx</span><span class="tok-o">.</span><span class="tok-na">commit</span><span class="tok-o">();</span>              <i class="conum" data-value="3"></i><b>(3)</b>
   <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">Exception</span> <span class="tok-n">ex</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-n">tx</span><span class="tok-o">.</span><span class="tok-na">rollback</span><span class="tok-o">();</span>            <i class="conum" data-value="4"></i><b>(4)</b>
      <span class="tok-n">String</span> <span class="tok-n">mensaje</span> <span class="tok-o">=</span> <span class="tok-s">&quot;Error al actualizar la pelicula &quot;</span>
                       <span class="tok-o">+</span> <span class="tok-n">id</span> <span class="tok-o">+</span> <span class="tok-s">&quot; con la recaudación &quot;</span> <span class="tok-o">+</span> <span class="tok-n">recaudacion</span><span class="tok-o">;</span>
      <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-na">error</span><span class="tok-o">(</span><span class="tok-n">mensaje</span><span class="tok-o">,</span> <span class="tok-n">ex</span><span class="tok-o">);</span>
      <span class="tok-k">throw</span><span class="tok-o">(</span><span class="tok-n">ex</span><span class="tok-o">)</span> <i class="conum" data-value="5"></i><b>(5)</b>
   <span class="tok-o">}</span> <span class="tok-k">finally</span> <span class="tok-o">{</span>
      <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span> <i class="conum" data-value="6"></i><b>(6)</b>
   <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Todas las operaciones de actualización de la base de datos se hacen dentro de un <code>try</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Se fuerza que Hibernate compruebe las restricciones llamando un <code>flush()</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Si todo ha ido bien, se hace un commit de la transacción</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Se hace un rollback cuando se ha producido una excepción</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Se logea un mensaje con el problema y se lanza de nuevo la excepción</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Se cierra la conexión del <em>entity manager</em></td>
</tr>
</table>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios">3.8. Ejercicios</h3>
<div class="paragraph">
<p>En esta sesión de ejercicios vamos a continuar con el proyecto <code>filmoteca</code>, en concreto vamos a añadir lo aprendido en esta sesión a la clase <code>Pelicula</code>.</p>
</div>
<div class="sect3">
<h4 id="__0_5_puntos_mapeado_de_tablas_y_campos_y_restricciones_em_bean_validation_em">3.8.1. (0,5 puntos) Mapeado de tablas y campos y restricciones <em>Bean Validation</em></h4>
<div class="paragraph">
<p>Modifica los campos da la entidad <code>Pelicula</code> utilizando alguna de las anotaciones y de las restricciones <em>Bean Validation</em> vistas en la clase de hoy:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>titulo</code>: 70 caracteres como máximo, no nulo</p>
</li>
<li>
<p><code>duracion</code> (<code>Integer</code>): minutos. Minimo 0 y máximo 999.</p>
</li>
<li>
<p><code>sinopsis</code> (<code>String</code>): 255 caracteres como máximo, puede ser <code>null</code></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="__0_5_puntos_relación_de_herencia_en_code_pelicula_code">3.8.2. (0,5 puntos) Relación de herencia en <code>Pelicula</code></h4>
<div class="paragraph">
<p>Haz que <code>Película</code> sea una clase abstracta y define las 3 clases concretas que sean hijas suyas. Por ejemplo: <code>Largometraje</code>, <code>Corto</code> y <code>Documental</code></p>
</div>
</div>
<div class="sect3">
<h4 id="__0_5_puntos_restricciones_code_bean_validation_code">3.8.3. (0,5 puntos) Restricciones <code>Bean Validation</code></h4>
<div class="paragraph">
<p>Comprueba que las validaciones funcionan correctamente con algún test</p>
</div>
</div>
<div class="sect3">
<h4 id="__0_5_puntos_clase_de_servicio">3.8.4. (0,5 puntos) Clase de servicio</h4>
<div class="ulist">
<ul>
<li>
<p>Crea la clase de excepciones de negocio <code>FilmotecaException</code>.</p>
</li>
<li>
<p>Actualiza los métodos de la clase de servicio con la gestión de las excepciones para capturar errores de validación y genera un error del tipo anterior cuando ha sucedido algo</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2015-09-25 07:54:21 CEST
</div>
</div>
</body>
</html>