<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.2">
<meta name="author" content="Aitor Medrano">
<title>JavaScript</title>
<style>/*! normalize.css v2.1.2 | MIT License | git.io/normalize */
/* ========================================================================== HTML5 display definitions ========================================================================== */
/** Correct `block` display not defined in IE 8/9. */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }

/** Correct `inline-block` display not defined in IE 8/9. */
audio, canvas, video { display: inline-block; }

/** Prevent modern browsers from displaying `audio` without controls. Remove excess height in iOS 5 devices. */
audio:not([controls]) { display: none; height: 0; }

/** Address `[hidden]` styling not present in IE 8/9. Hide the `template` element in IE, Safari, and Firefox < 22. */
[hidden], template { display: none; }

script { display: none !important; }

/* ========================================================================== Base ========================================================================== */
/** 1. Set default font family to sans-serif. 2. Prevent iOS text size adjust after orientation change, without disabling user zoom. */
html { font-family: sans-serif; /* 1 */ -ms-text-size-adjust: 100%; /* 2 */ -webkit-text-size-adjust: 100%; /* 2 */ }

/** Remove default margin. */
body { margin: 0; }

/* ========================================================================== Links ========================================================================== */
/** Remove the gray background color from active links in IE 10. */
a { background: transparent; }

/** Address `outline` inconsistency between Chrome and other browsers. */
a:focus { outline: thin dotted; }

/** Improve readability when focused and also mouse hovered in all browsers. */
a:active, a:hover { outline: 0; }

/* ========================================================================== Typography ========================================================================== */
/** Address variable `h1` font-size and margin within `section` and `article` contexts in Firefox 4+, Safari 5, and Chrome. */
h1 { font-size: 2em; margin: 0.67em 0; }

/** Address styling not present in IE 8/9, Safari 5, and Chrome. */
abbr[title] { border-bottom: 1px dotted; }

/** Address style set to `bolder` in Firefox 4+, Safari 5, and Chrome. */
b, strong { font-weight: bold; }

/** Address styling not present in Safari 5 and Chrome. */
dfn { font-style: italic; }

/** Address differences between Firefox and other browsers. */
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }

/** Address styling not present in IE 8/9. */
mark { background: #ff0; color: #000; }

/** Correct font family set oddly in Safari 5 and Chrome. */
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }

/** Improve readability of pre-formatted text in all browsers. */
pre { white-space: pre-wrap; }

/** Set consistent quote types. */
q { quotes: "\201C" "\201D" "\2018" "\2019"; }

/** Address inconsistent and variable font size in all browsers. */
small { font-size: 80%; }

/** Prevent `sub` and `sup` affecting `line-height` in all browsers. */
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }

sup { top: -0.5em; }

sub { bottom: -0.25em; }

/* ========================================================================== Embedded content ========================================================================== */
/** Remove border when inside `a` element in IE 8/9. */
img { border: 0; }

/** Correct overflow displayed oddly in IE 9. */
svg:not(:root) { overflow: hidden; }

/* ========================================================================== Figures ========================================================================== */
/** Address margin not present in IE 8/9 and Safari 5. */
figure { margin: 0; }

/* ========================================================================== Forms ========================================================================== */
/** Define consistent border, margin, and padding. */
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }

/** 1. Correct `color` not being inherited in IE 8/9. 2. Remove padding so people aren't caught out if they zero out fieldsets. */
legend { border: 0; /* 1 */ padding: 0; /* 2 */ }

/** 1. Correct font family not being inherited in all browsers. 2. Correct font size not being inherited in all browsers. 3. Address margins set differently in Firefox 4+, Safari 5, and Chrome. */
button, input, select, textarea { font-family: inherit; /* 1 */ font-size: 100%; /* 2 */ margin: 0; /* 3 */ }

/** Address Firefox 4+ setting `line-height` on `input` using `!important` in the UA stylesheet. */
button, input { line-height: normal; }

/** Address inconsistent `text-transform` inheritance for `button` and `select`. All other form control elements do not inherit `text-transform` values. Correct `button` style inheritance in Chrome, Safari 5+, and IE 8+. Correct `select` style inheritance in Firefox 4+ and Opera. */
button, select { text-transform: none; }

/** 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio` and `video` controls. 2. Correct inability to style clickable `input` types in iOS. 3. Improve usability and consistency of cursor style between image-type `input` and others. */
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; /* 2 */ cursor: pointer; /* 3 */ }

/** Re-set default cursor for disabled elements. */
button[disabled], html input[disabled] { cursor: default; }

/** 1. Address box sizing set to `content-box` in IE 8/9. 2. Remove excess padding in IE 8/9. */
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; /* 1 */ padding: 0; /* 2 */ }

/** 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome. 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome (include `-moz` to future-proof). */
input[type="search"] { -webkit-appearance: textfield; /* 1 */ -moz-box-sizing: content-box; -webkit-box-sizing: content-box; /* 2 */ box-sizing: content-box; }

/** Remove inner padding and search cancel button in Safari 5 and Chrome on OS X. */
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }

/** Remove inner padding and border in Firefox 4+. */
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }

/** 1. Remove default vertical scrollbar in IE 8/9. 2. Improve readability and alignment in all browsers. */
textarea { overflow: auto; /* 1 */ vertical-align: top; /* 2 */ }

/* ========================================================================== Tables ========================================================================== */
/** Remove most spacing between table cells. */
table { border-collapse: collapse; border-spacing: 0; }

meta.foundation-mq-small { font-family: "only screen and (min-width: 768px)"; width: 768px; }

meta.foundation-mq-medium { font-family: "only screen and (min-width:1280px)"; width: 1280px; }

meta.foundation-mq-large { font-family: "only screen and (min-width:1440px)"; width: 1440px; }

*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }

html, body { font-size: 97%; }

body { background: white; color: #222222; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }

a:hover { cursor: pointer; }

img, object, embed { max-width: 100%; height: auto; }

object, embed { height: 100%; }

img { -ms-interpolation-mode: bicubic; }

#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }

.left { float: left !important; }

.right { float: right !important; }

.text-left { text-align: left !important; }

.text-right { text-align: right !important; }

.text-center { text-align: center !important; }

.text-justify { text-align: justify !important; }

.hide { display: none; }

.antialiased, body { -webkit-font-smoothing: antialiased; }

img { display: inline-block; vertical-align: middle; }

textarea { height: auto; min-height: 50px; }

select { width: 100%; }

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }

.subheader, .admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { line-height: 1.4; color: #6f6f6f; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }

/* Typography resets */
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }

/* Default Link Styles */
a { color: #1164be; text-decoration: none; line-height: inherit; }
a img { border: none; }

/* Default paragraph styles */
p { font-family: inherit; font-weight: normal; font-size: 1em; line-height: 1.4; margin-bottom: 1em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }

/* Default header styles */
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: bold; font-style: normal; color: #1c355e; text-rendering: optimizeLegibility; margin-top: 1em; margin-bottom: 0.5em; line-height: 1.2125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #6f6f6f; line-height: 0; }

h1 { font-size: 2.125em; }

h2 { font-size: 1.6875em; }

h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }

h4 { font-size: 1.125em; }

h5 { font-size: 1.125em; }

h6 { font-size: 1em; }

hr { border: solid #dddddd; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }

/* Helpful Typography Defaults */
em, i { font-style: italic; line-height: inherit; }

strong, b { font-weight: bold; line-height: inherit; }

small { font-size: 60%; line-height: inherit; }

code { font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: bold; }

/* Lists */
ul, ol, dl { font-size: 1em; line-height: 1.4; margin-bottom: 1.25em; list-style-position: outside; font-family: inherit; }

ul, ol { margin-left: 2.5em; }
ul.no-bullet, ol.no-bullet { margin-left: 1.5em; }

/* Unordered Lists */
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; /* Override nested font-size change */ }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }

/* Ordered Lists */
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }

/* Definition Lists */
dl dt { margin-bottom: 0.3125em; font-weight: bold; }
dl dd { margin-bottom: 1.25em; }

/* Abbreviations */
abbr, acronym { text-transform: uppercase; font-size: 90%; color: #222222; border-bottom: 1px dotted #dddddd; cursor: help; }

abbr { text-transform: none; }

/* Blockquotes */
blockquote { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
blockquote cite { display: block; font-size: 0.8125em; color: #555555; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #555555; }

blockquote, blockquote p { line-height: 1.6; color: #6f6f6f; }

/* Microformats */
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #dddddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }

.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }

/*@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.6875em; }
  h4 { font-size: 1.4375em; } }*/
/* Tables */
table { background: white; margin-bottom: 1.25em; border: solid 1px #dddddd; }
table thead, table tfoot { background: whitesmoke; font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: #222222; text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: #222222; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #f9f9f9; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.4; }

h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; border-bottom: 1px solid #dddddd }

.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }

*:not(pre) > code { font-size: inherit; font-style: normal !important; letter-spacing: 0; padding: 3px 2px 1px 2px; background-color: #eeeeee; border: 1px solid #dddddd; -webkit-border-radius: 0; border-radius: 0; line-height: inherit; font-weight: normal; }

pre, pre > code { line-height: 1.4; color: black; font-family: monospace, serif; font-weight: normal; }

.keyseq { color: #555555; }

kbd { display: inline-block; color: #222222; font-size: 0.75em; line-height: 1.4; background-color: #f7f7f7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; margin: -0.15em 0.15em 0 0.15em; padding: 0.2em 0.6em 0.2em 0.5em; vertical-align: middle; white-space: nowrap; }

.keyseq kbd:first-child { margin-left: 0; }

.keyseq kbd:last-child { margin-right: 0; }

.menuseq, .menu { color: #090909; }

b.button:before, b.button:after { position: relative; top: -1px; font-weight: normal; }

b.button:before { content: "["; padding: 0 3px 0 2px; }

b.button:after { content: "]"; padding: 0 2px 0 3px; }

#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 0.9375em; padding-right: 0.9375em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }

#content { margin-top: 1.25em; }

#content:before { content: none; }

#header > h1:first-child { color: black; margin-top: 2.25rem; margin-bottom: 0; }
#header > h1:first-child + #toc { margin-top: 8px; border-top: 1px solid #dddddd; }
#header > h1:only-child, body.toc2 #header > h1:nth-last-child(2) { border-bottom: 1px solid #dddddd; padding-bottom: 8px; }
#header .details { border-bottom: 1px solid #dddddd; line-height: 1.45; padding-top: 0.25em; padding-bottom: 0.25em; padding-left: 0.25em; color: #555555; display: -ms-flexbox; display: -webkit-flex; display: flex; -ms-flex-flow: row wrap; -webkit-flex-flow: row wrap; flex-flow: row wrap; }
#header .details span:first-child { margin-left: -0.125em; }
#header .details span.email a { color: #6f6f6f; }
#header .details br { display: none; }
#header .details br + span:before { content: "\00a0\2013\00a0"; }
#header .details br + span.author:before { content: "\00a0\22c5\00a0"; color: #6f6f6f; }
#header .details br + span#revremark:before { content: "\00a0|\00a0"; }
#header #revnumber { text-transform: capitalize; }
#header #revnumber:after { content: "\00a0"; }

#content > h1:first-child:not([class]) { color: black; border-bottom: 1px solid #dddddd; padding-bottom: 8px; margin-top: 0; padding-top: 1rem; margin-bottom: 1.25rem; }

#floating {
  position: fixed;
  z-index: 1000;
  padding: 0.5em;
  right: 0;
  top: 0;
  background: white;
  box-shadow: 0 0 1em #777777;
  -webkit-box-shadow: 0 0 1em #777777;
  -moz-box-shadow: 0 0 1em #777777;
  -webkit-border-bottom-left-radius: 5px;
  -moz-border-radius-bottomleft: 5px;
  max-height: 80%;
  overflow: auto;
}

#floating #full { display: none; } /* Hide the full TOC by default */

#floating:hover #full{
  display: block; /* Show it on hover */
}


#toc { border-bottom: 1px solid #dddddd; padding-bottom: 0.5em; }
#toc > ul { margin-left: 0.125em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin: 0.5em 0; }
#toc ul { font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; list-style-type: none; }
#toc a { text-decoration: none; }
#toc a:active { text-decoration: underline; }

#toctitle { color: #6f6f6f; font-size: 1.2em; }

@media only screen and (min-width: 768px) { #toctitle { font-size: 1.375em; }
  body.toc2 { padding-left: 15em; padding-right: 0; }
  #toc.toc2 { margin-top: 0 !important; background-color: #f2f2f2; position: fixed; width: 15em; left: 0; top: 0; border-right: 1px solid #dddddd; border-top-width: 0 !important; border-bottom-width: 0 !important; z-index: 1000; padding: 1.25em 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; font-size: 1.2em; }
  #toc.toc2 > ul { font-size: 0.9em; margin-bottom: 0; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 15em; }
  body.toc2.toc-right #toc.toc2 { border-right-width: 0; border-left: 1px solid #dddddd; left: auto; right: 0; } }
@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; padding-right: 0; }
  #toc.toc2 { width: 20em; }
  #toc.toc2 #toctitle { font-size: 1.375em; }
  #toc.toc2 > ul { font-size: 0.95em; }
  #toc.toc2 ul ul { padding-left: 1.25em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; } }
#content #toc { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 0; border-radius: 0; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }

#footer { max-width: 100%; background-color: #222222; padding: 1.25em; }

#footer-text { color: #dddddd; line-height: 1.44; }

.sect1 { padding-bottom: 0.625em; }

@media only screen and (min-width: 768px) { .sect1 { padding-bottom: 1.25em; } }
.sect1 + .sect1 { border-top: 1px solid #dddddd; }

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; z-index: 1001; width: 1.5ex; margin-left: -1.5ex; display: block; text-decoration: none !important; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: "\00A7"; font-size: 0.85em; display: block; padding-top: 0.1em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #222222; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #151515; }

.audioblock, .imageblock, .literalblock, .listingblock, .stemblock, .videoblock { margin-bottom: 1.25em; }

.admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-rendering: optimizeLegibility; text-align: left; }

table.tableblock > caption.title { white-space: nowrap; overflow: visible; max-width: 0; }

.paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { color: black; }

table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }

.admonitionblock > table { border-collapse: separate; border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #dddddd; color: #555555; }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }

.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 0; border-radius: 0; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }

.sidebarblock { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 0; border-radius: 0; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock > .content > .title { color: #6f6f6f; margin-top: 0; }

.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }

.literalblock pre, .listingblock pre:not(.highlight), .listingblock pre[class="highlight"], .listingblock pre[class^="highlight "], .listingblock pre.CodeRay, .listingblock pre.prettyprint { background: #eeeeee; }
.sidebarblock .literalblock pre, .sidebarblock .listingblock pre:not(.highlight), .sidebarblock .listingblock pre[class="highlight"], .sidebarblock .listingblock pre[class^="highlight "], .sidebarblock .listingblock pre.CodeRay, .sidebarblock .listingblock pre.prettyprint { background: #f2f1f1; }

.literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { border: 1px solid #cccccc; -webkit-border-radius: 0; border-radius: 0; word-wrap: break-word; padding: 0.8em 0.8em 0.65em 0.8em; font-size: 0.8125em; }
.literalblock pre.nowrap, .literalblock pre[class].nowrap, .listingblock pre.nowrap, .listingblock pre[class].nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
@media only screen and (min-width: 768px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 0.90625em; } }
@media only screen and (min-width: 1280px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 1em; } }

.literalblock.output pre { color: #eeeeee; background-color: black; }

.listingblock pre.highlightjs { padding: 0; }
.listingblock pre.highlightjs > code { padding: 0.8em 0.8em 0.65em 0.8em; -webkit-border-radius: 0; border-radius: 0; }

.listingblock > .content { position: relative; }

.listingblock code[data-lang]:before { display: none; content: attr(data-lang); position: absolute; font-size: 0.75em; top: 0.425rem; right: 0.5rem; line-height: 1; text-transform: uppercase; color: #999; }

.listingblock:hover code[data-lang]:before { display: block; }

.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }

.listingblock.terminal pre .command:not([data-prompt]):before { content: "$"; }

table.pyhltable { border-collapse: separate; border: 0; margin-bottom: 0; background: none; }

table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; }

table.pyhltable td.code { padding-left: .75em; padding-right: 0; }

pre.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #dddddd; }

pre.pygments .lineno { display: inline-block; margin-right: .25em; }

table.pyhltable .linenodiv { background: none !important; padding-right: 0 !important; }

.quoteblock { margin: 0 1em 1.25em 1.5em; display: table; }
.quoteblock > .title { margin-left: -1.5em; margin-bottom: 0.75em; }
.quoteblock blockquote, .quoteblock blockquote p { color: #6f6f6f; font-size: 1.15rem; line-height: 1.75; word-spacing: 0.1em; letter-spacing: 0; font-style: italic; text-align: justify; }
.quoteblock blockquote { margin: 0; padding: 0; border: 0; }
.quoteblock blockquote:before { content: "\201c"; float: left; font-size: 2.75em; font-weight: bold; line-height: 0.6em; margin-left: -0.6em; color: #6f6f6f; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: 0.5em; margin-right: 0.5ex; text-align: right; }
.quoteblock .quoteblock { margin-left: 0; margin-right: 0; padding: 0.5em 0; border-left: 3px solid #555555; }
.quoteblock .quoteblock blockquote { padding: 0 0 0 0.75em; }
.quoteblock .quoteblock blockquote:before { display: none; }

.verseblock { margin: 0 1em 1.25em 1em; }
.verseblock pre { font-family: "Open Sans", "DejaVu Sans", sans; font-size: 1.15rem; color: #6f6f6f; font-weight: 300; text-rendering: optimizeLegibility; }
.verseblock pre strong { font-weight: 400; }
.verseblock .attribution { margin-top: 1.25rem; margin-left: 0.5ex; }

.quoteblock .attribution, .verseblock .attribution { font-size: 0.8125em; line-height: 1.45; font-style: italic; }
.quoteblock .attribution br, .verseblock .attribution br { display: none; }
.quoteblock .attribution cite, .verseblock .attribution cite { display: block; letter-spacing: -0.05em; color: #555555; }

.quoteblock.abstract { margin: 0 0 1.25em 0; display: block; }
.quoteblock.abstract blockquote, .quoteblock.abstract blockquote p { text-align: left; word-spacing: 0; }
.quoteblock.abstract blockquote:before, .quoteblock.abstract blockquote p:first-of-type:before { display: none; }

table.tableblock { max-width: 100%; border-collapse: separate; }
table.tableblock td > .paragraph:last-child p > p:last-child, table.tableblock th > p:last-child, table.tableblock td > p:last-child { margin-bottom: 0; }

table.spread { width: 100%; }

table.tableblock, th.tableblock, td.tableblock { border: 0 solid #dddddd; }

table.grid-all th.tableblock, table.grid-all td.tableblock { border-width: 0 1px 1px 0; }

table.grid-all tfoot > tr > th.tableblock, table.grid-all tfoot > tr > td.tableblock { border-width: 1px 1px 0 0; }

table.grid-cols th.tableblock, table.grid-cols td.tableblock { border-width: 0 1px 0 0; }

table.grid-all * > tr > .tableblock:last-child, table.grid-cols * > tr > .tableblock:last-child { border-right-width: 0; }

table.grid-rows th.tableblock, table.grid-rows td.tableblock { border-width: 0 0 1px 0; }

table.grid-all tbody > tr:last-child > th.tableblock, table.grid-all tbody > tr:last-child > td.tableblock, table.grid-all thead:last-child > tr > th.tableblock, table.grid-rows tbody > tr:last-child > th.tableblock, table.grid-rows tbody > tr:last-child > td.tableblock, table.grid-rows thead:last-child > tr > th.tableblock { border-bottom-width: 0; }

table.grid-rows tfoot > tr > th.tableblock, table.grid-rows tfoot > tr > td.tableblock { border-width: 1px 0 0 0; }

table.frame-all { border-width: 1px; }

table.frame-sides { border-width: 0 1px; }

table.frame-topbot { border-width: 1px 0; }

th.halign-left, td.halign-left { text-align: left; }

th.halign-right, td.halign-right { text-align: right; }

th.halign-center, td.halign-center { text-align: center; }

th.valign-top, td.valign-top { vertical-align: top; }

th.valign-bottom, td.valign-bottom { vertical-align: bottom; }

th.valign-middle, td.valign-middle { vertical-align: middle; }

table thead th, table tfoot th { font-weight: bold; }

tbody tr th { display: table-cell; line-height: 1.4; background: whitesmoke; }

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p { color: #222222; font-weight: bold; }

p.tableblock > code:only-child { background: none; padding: 0; }

p.tableblock { font-size: 1em; }

td > div.verse { white-space: pre; }

ol { margin-left: 2.5em; }

ul li ol { margin-left: 1.5em; }

dl dd { margin-left: 1.125em; }

dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }

ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.625em; }

ul.unstyled, ol.unnumbered, ul.checklist, ul.none { list-style-type: none; }

ul.unstyled, ol.unnumbered, ul.checklist { margin-left: 0.625em; }

ul.checklist li > p:first-child > .fa-check-square-o:first-child, ul.checklist li > p:first-child > input[type="checkbox"]:first-child { margin-right: 0.25em; }

ul.checklist li > p:first-child > input[type="checkbox"]:first-child { position: relative; top: 1px; }

ul.inline { margin: 0 auto 0.625em auto; margin-left: -1.375em; margin-right: 0; padding: 0; list-style: none; overflow: hidden; }
ul.inline > li { list-style: none; float: left; margin-left: 1.375em; display: block; }
ul.inline > li > * { display: block; }

.unstyled dl dt { font-weight: normal; font-style: normal; }

ol.arabic { list-style-type: decimal; }

ol.decimal { list-style-type: decimal-leading-zero; }

ol.loweralpha { list-style-type: lower-alpha; }

ol.upperalpha { list-style-type: upper-alpha; }

ol.lowerroman { list-style-type: lower-roman; }

ol.upperroman { list-style-type: upper-roman; }

ol.lowergreek { list-style-type: lower-greek; }

.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }

td.hdlist1 { padding-right: .75em; font-weight: bold; }

td.hdlist1, td.hdlist2 { vertical-align: top; }

.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }

.colist > table tr > td:first-of-type { padding: 0 0.75em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.25em 0; }

.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: 0 0 0 1px #dddddd; box-shadow: 0 0 0 1px #dddddd; }

.imageblock.left, .imageblock[style*="float: left"] { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }

.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }

a.image { text-decoration: none; }

span.footnote, span.footnoteref { vertical-align: super; font-size: 0.875em; }
span.footnote a, span.footnoteref a { text-decoration: none; }
span.footnote a:active, span.footnoteref a:active { text-decoration: underline; }

#footnotes { padding-top: 0.75em; padding-bottom: 0.75em; margin-bottom: 0.625em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -.25em 0 .75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.375em; line-height: 1.3; font-size: 0.875em; margin-left: 1.2em; text-indent: -1.2em; margin-bottom: .2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }

#content #footnotes { margin-top: -0.625em; margin-bottom: 0; padding: 0.75em 0; }

.gist .file-data > table { border: 0; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }

div.unbreakable { page-break-inside: avoid; }

.big { font-size: larger; }

.small { font-size: smaller; }

.underline { text-decoration: underline; }

.overline { text-decoration: overline; }

.line-through { text-decoration: line-through; }

.aqua { color: #00bfbf; }

.aqua-background { background-color: #00fafa; }

.black { color: black; }

.black-background { background-color: black; }

.blue { color: #0000bf; }

.blue-background { background-color: #0000fa; }

.fuchsia { color: #bf00bf; }

.fuchsia-background { background-color: #fa00fa; }

.gray { color: #606060; }

.gray-background { background-color: #7d7d7d; }

.green { color: #006000; }

.green-background { background-color: #007d00; }

.lime { color: #00bf00; }

.lime-background { background-color: #00fa00; }

.maroon { color: #600000; }

.maroon-background { background-color: #7d0000; }

.navy { color: #000060; }

.navy-background { background-color: #00007d; }

.olive { color: #606000; }

.olive-background { background-color: #7d7d00; }

.purple { color: #600060; }

.purple-background { background-color: #7d007d; }

.red { color: #bf0000; }

.red-background { background-color: #fa0000; }

.silver { color: #909090; }

.silver-background { background-color: #bcbcbc; }

.teal { color: #006060; }

.teal-background { background-color: #007d7d; }

.white { color: #bfbfbf; }

.white-background { background-color: #fafafa; }

.yellow { color: #bfbf00; }

.yellow-background { background-color: #fafa00; }

span.icon > .fa { cursor: default; }

.admonitionblock td.icon [class^="fa icon-"] { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #207c98; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }

.conum[data-value] { display: inline-block; color: #fff !important; background-color: #222222; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; font-size: 0.75em; width: 1.67em; height: 1.67em; line-height: 1.67em; font-family: "Open Sans", "DejaVu Sans", sans-serif; font-style: normal; font-weight: bold; }
.conum[data-value] * { color: #fff !important; }
.conum[data-value] + b { display: none; }
.conum[data-value]:after { content: attr(data-value); }
pre .conum[data-value] { position: relative; top: -0.125em; }

b.conum * { color: inherit !important; }

.conum:not([data-value]):empty { display: none; }

.literalblock pre, .listingblock pre { background: #eeeeee; }

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.min.css">
<style>.listingblock .pygments .hll { background-color: #ffffcc }
.listingblock .pygments  { background: #f8f8f8; }
.listingblock .pygments .tok-c { color: #408080; font-style: italic } /* Comment */
.listingblock .pygments .tok-err { border: 1px solid #FF0000 } /* Error */
.listingblock .pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
.listingblock .pygments .tok-o { color: #666666 } /* Operator */
.listingblock .pygments .tok-cm { color: #408080; font-style: italic } /* Comment.Multiline */
.listingblock .pygments .tok-cp { color: #BC7A00 } /* Comment.Preproc */
.listingblock .pygments .tok-c1 { color: #408080; font-style: italic } /* Comment.Single */
.listingblock .pygments .tok-cs { color: #408080; font-style: italic } /* Comment.Special */
.listingblock .pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
.listingblock .pygments .tok-ge { font-style: italic } /* Generic.Emph */
.listingblock .pygments .tok-gr { color: #FF0000 } /* Generic.Error */
.listingblock .pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
.listingblock .pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
.listingblock .pygments .tok-go { color: #888888 } /* Generic.Output */
.listingblock .pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.listingblock .pygments .tok-gs { font-weight: bold } /* Generic.Strong */
.listingblock .pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.listingblock .pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
.listingblock .pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.listingblock .pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.listingblock .pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.listingblock .pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
.listingblock .pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.listingblock .pygments .tok-kt { color: #B00040 } /* Keyword.Type */
.listingblock .pygments .tok-m { color: #666666 } /* Literal.Number */
.listingblock .pygments .tok-s { color: #BA2121 } /* Literal.String */
.listingblock .pygments .tok-na { color: #7D9029 } /* Name.Attribute */
.listingblock .pygments .tok-nb { color: #008000 } /* Name.Builtin */
.listingblock .pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
.listingblock .pygments .tok-no { color: #880000 } /* Name.Constant */
.listingblock .pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
.listingblock .pygments .tok-ni { color: #999999; font-weight: bold } /* Name.Entity */
.listingblock .pygments .tok-ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.listingblock .pygments .tok-nf { color: #0000FF } /* Name.Function */
.listingblock .pygments .tok-nl { color: #A0A000 } /* Name.Label */
.listingblock .pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.listingblock .pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
.listingblock .pygments .tok-nv { color: #19177C } /* Name.Variable */
.listingblock .pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.listingblock .pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
.listingblock .pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
.listingblock .pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
.listingblock .pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
.listingblock .pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
.listingblock .pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
.listingblock .pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
.listingblock .pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
.listingblock .pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.listingblock .pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
.listingblock .pygments .tok-se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.listingblock .pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
.listingblock .pygments .tok-si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.listingblock .pygments .tok-sx { color: #008000 } /* Literal.String.Other */
.listingblock .pygments .tok-sr { color: #BB6688 } /* Literal.String.Regex */
.listingblock .pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
.listingblock .pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
.listingblock .pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
.listingblock .pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
.listingblock .pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
.listingblock .pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
.listingblock .pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>JavaScript</h1>
<div class="details">
<span id="author" class="author">Aitor Medrano</span><br>
<span id="email" class="email">&lt;<a href="mailto:aitor.medrano@ua.es">aitor.medrano@ua.es</a>&gt;</span><br>
<span id="revnumber">version 1.1</span>
<br><span id="revremark">añadido 'Bucle de eventos', 'FormData'</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Índice de contenidos</div>
<ul class="sectlevel1">
<li><a href="#sesion05">5. JavaScript y el navegador</a>
<ul class="sectlevel2">
<li><a href="#_ajax">5.1. AJAX</a>
<ul class="sectlevel3">
<li><a href="#_ajax_s%C3%ADncrono">5.1.1. AJAX síncrono</a></li>
<li><a href="#_ajax_as%C3%ADncrono">5.1.2. AJAX asíncrono</a></li>
<li><a href="#_enviando_datos">5.1.3. Enviando datos</a></li>
<li><a href="#_eventos">5.1.4. Eventos</a></li>
<li><a href="#_respuesta_http">5.1.5. Respuesta HTTP</a></li>
</ul>
</li>
<li><a href="#_json">5.2. JSON</a>
<ul class="sectlevel3">
<li><a href="#_filtrando_campos">5.2.1. Filtrando campos</a></li>
<li><a href="#_ejemplo_omdb">5.2.2. Ejemplo OMDB</a></li>
<li><a href="#_cross_domain">5.2.3. Cross-Domain</a></li>
<li><a href="#_jsonp">5.2.4. JSONP</a></li>
<li><a href="#_testing">5.2.5. Testing</a></li>
</ul>
</li>
<li><a href="#_html_5">5.3. HTML 5</a>
<ul class="sectlevel3">
<li><a href="#_detecci%C3%B3n_de_caracter%C3%ADsticas_em_modernizr_em">5.3.1. Detección de características. <em>Modernizr</em></a></li>
<li><a href="#_polyfills">5.3.2. Polyfills</a></li>
</ul>
</li>
<li><a href="#_almacenando_informaci%C3%B3n">5.4. Almacenando información</a>
<ul class="sectlevel3">
<li><a href="#_cookies">5.4.1. Cookies</a></li>
<li><a href="#_localstorage">5.4.2. LocalStorage</a></li>
<li><a href="#_sessionstorage">5.4.3. SessionStorage</a></li>
<li><a href="#_indexeddb">5.4.4. IndexedDB</a></li>
</ul>
</li>
<li><a href="#_web_workers">5.5. Web Workers</a>
<ul class="sectlevel3">
<li><a href="#_hilo_padre">5.5.1. Hilo padre</a></li>
<li><a href="#__em_worker_em_hijo">5.5.2. <em>Worker</em> hijo</a></li>
<li><a href="#_finalizando_los_em_workers_em">5.5.3. Finalizando los <em>workers</em></a></li>
<li><a href="#_seguridad_y_restricciones">5.5.4. Seguridad y restricciones</a></li>
<li><a href="#_gesti%C3%B3n_de_errores">5.5.5. Gestión de errores</a></li>
<li><a href="#_casos_de_uso">5.5.6. Casos de uso</a></li>
<li><a href="#__em_shared_workers_em">5.5.7. <em>Shared workers</em></a></li>
</ul>
</li>
<li><a href="#_websockets">5.6. WebSockets</a>
<ul class="sectlevel3">
<li><a href="#_eventos_2">5.6.1. Eventos</a></li>
<li><a href="#_ejemplo_chat">5.6.2. Ejemplo chat</a></li>
</ul>
</li>
<li><a href="#_rendimiento">5.7. Rendimiento</a>
<ul class="sectlevel3">
<li><a href="#_identificar_los_problemas">5.7.1. Identificar los problemas</a></li>
<li><a href="#_reglas">5.7.2. Reglas</a></li>
</ul>
</li>
<li><a href="#_ejercicios">5.8. Ejercicios</a>
<ul class="sectlevel3">
<li><a href="#__0_6_ptos_ejercicio_51_em_star_wars_em">5.8.1. (0.6 ptos) Ejercicio 51. <em>Star Wars</em></a></li>
<li><a href="#__0_5_ptos_ejercicio_52_em_almac%C3%A9n_em">5.8.2. (0.5 ptos) Ejercicio 52. <em>Almacén</em></a></li>
<li><a href="#__0_5_ptos_ejercicio_53_em_web_workers_em">5.8.3. (0.5 ptos) Ejercicio 53. <em>Web Workers</em></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="sesion05">5. JavaScript y el navegador</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_ajax">5.1. AJAX</h3>
<div class="paragraph">
<p>Uno de los usos más comunes en <em>JavaScript</em> es AJAX (<em>Asynchronous JavaScript And XML</em>), técnica (que no lenguaje) que permite realizar peticiones HTTP al servidor desde <em>JavaScript</em>, y recibir la respuesta sin recargar la página ni cambiar a otra página distinta. La información que se recibe se inserta mediante el API DOM que vimos en la sesión anterior.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Al igual que al abrir ventanas, el navegador restringe las peticiones al servidor para que sólo se puedan realizar sobre el mismo dominio al que pertenece la página que realiza la petición. Es decir, una página que desarrollamos en <em>localhost</em> no puede hacer una petición a <em>Twitter</em>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para usar AJAX, hemos de emplear el objeto <code>XMLHttpRequest</code> para lanzar una petición HTTP al servidor con el método <code>open(getPost, recurso, esAsync)</code> donde:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>getPost</code>: cadena con el valor <code>GET</code> o <code>POST</code> dependiendo del protocolo deseado</p>
</li>
<li>
<p><code>recurso</code>: URI del recurso que se solicita</p>
</li>
<li>
<p><code>esAsync</code>: booleano donde <code>true</code> indica que la petición en asíncrona</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Posteriormente se recibe la respuesta mediante la propiedad <code>responseText</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Aunque en sus inicios era original de IE, posteriormente fue adoptado por todos los navegadores.
</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Vamos a dejar de lado IE8 y anteriores que en vez de usar el objeto <code>XMLHttpRequest</code> necesitan crear un objeto <code>ActiveXObject("Microsoft.XMLHTTP")</code>. Para trabajar con AJAX en versiones de navegadores antiguos se recomienda hacerlo mediante <em>jQuery</em>.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_ajax_síncrono">5.1.1. AJAX síncrono</h4>
<div class="paragraph">
<p>Para comenzar vamos a basarnos en un ejemplo con llamadas síncronas (sí, parece extraño, es como si usáramos <em>SJAX</em>), ya que el código es un poco más sencillo. El siguiente fragmento realiza una petición a un archivo del servidor <code>fichero.txt</code>, y tras recibirlo, lo muestra mediante un diálogo de alerta.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">xhr</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">XMLHttpRequest</span><span class="tok-p">();</span>
<span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">open</span><span class="tok-p">(</span><span class="tok-s2">&quot;GET&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;fichero.txt&quot;</span><span class="tok-p">,</span> <span class="tok-kc">false</span><span class="tok-p">);</span>  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">send</span><span class="tok-p">(</span><span class="tok-kc">null</span><span class="tok-p">);</span>  <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-nx">alert</span><span class="tok-p">(</span><span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">responseText</span><span class="tok-p">);</span> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Tras crear el objeto, se crea una conexión donde le indicamos el método de acceso (<code>GET</code> o <code>POST</code>), el nombre el recurso al que accedemos (<code>fichero.txt</code>) y finalmente si la llamada es asíncrona (<code>true</code>) o síncrona (<code>false</code>).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Se envía la petición, en este caso sin parámetros (<code>null</code>)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Recuperamos la respuesta con la propiedad <code>responseText</code>. Si el contenido del archivo hubiese estado en formato <em>XML</em>, usaríamos la propiedad <code>responseXML</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A modo de esquema, el siguiente gráfico representa las llamadas realizadas mediante una petición síncrona:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/js05/ajaxCicloSync.jpg" alt="Ciclo de llamadas síncrono en AJAX" width="50%">
</div>
<div class="title">Figure 1. Ciclo de llamadas síncrono en AJAX</div>
</div>
</div>
<div class="sect3">
<h4 id="_ajax_asíncrono">5.1.2. AJAX asíncrono</h4>
<div class="paragraph">
<p>Al realizar una petición síncrona, AJAX bloquea el navegador y se queda a la espera de la respuesta. Para evitar este bloqueo, usaremos el modo <strong>asíncrono</strong>. De este modo, tras realizar la petición, el control vuelve al navegador inmediatamente. El problema que tenemos ahora es averiguar si el recurso solicitado ya esta disponible. Para ello, tenemos la propiedad <code>readyState</code>, la cual tenemos que consultar para conocer el estado de la petición. Pero si la consultamos inmediatamente, nos dirá que no ha finalizado. Para evitar tener que crear un bucle infinito de consulta de la propiedad, siguiente el esquema de eventos, usaremos el manejador que ofrece la propiedad <code>onreadystatechange</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">xhr</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">XMLHttpRequest</span><span class="tok-p">();</span>
<span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">open</span><span class="tok-p">(</span><span class="tok-s2">&quot;GET&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;fichero.txt&quot;</span><span class="tok-p">,</span> <span class="tok-kc">true</span><span class="tok-p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">onreadystatechange</span> <span class="tok-o">=</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>  <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">readyState</span> <span class="tok-o">===</span> <span class="tok-mi">4</span><span class="tok-p">)</span> <span class="tok-p">{</span>  <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-nx">alert</span><span class="tok-p">(</span><span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">responseText</span><span class="tok-p">);</span>
  <span class="tok-p">}</span>
<span class="tok-p">};</span>
<span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">send</span><span class="tok-p">(</span><span class="tok-kc">null</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Ahora realizamos la petición de manera asíncrona indicándolo con <code>true</code> en el tercer parámetro</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Asociamos una función <em>callback</em> al evento de cambio de estado</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Comprobamos mediante el estado si la petición ha fallado (1), si ha cargado sólo las cabeceras HTTP (2), si está cargándose (3) o si ya esta completa (4).</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Además de comprobar el estado de la conexión, debemos comprobar el estado de la respuesta HTTP, para averiguar si realmente hemos obtenido la respuesta que solicitábamos. Para ello, la propiedad <code>status</code>
nos devolverá el código correspondiente (200 OK, 304 no ha cambiado desde la última petición, 404 no encontrado).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">onreadystatechange</span> <span class="tok-o">=</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">readyState</span> <span class="tok-o">===</span>  <span class="tok-mi">4</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kd">var</span> <span class="tok-nx">status</span> <span class="tok-o">=</span> <span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">status</span><span class="tok-p">;</span>
    <span class="tok-k">if</span> <span class="tok-p">((</span><span class="tok-nx">status</span> <span class="tok-o">&gt;=</span> <span class="tok-mi">200</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-nx">status</span> <span class="tok-o">&lt;</span> <span class="tok-mi">300</span><span class="tok-p">)</span> <span class="tok-o">||</span> <span class="tok-p">(</span><span class="tok-nx">status</span> <span class="tok-o">===</span> <span class="tok-mi">304</span><span class="tok-p">))</span> <span class="tok-p">{</span>
      <span class="tok-nx">alert</span><span class="tok-p">(</span><span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">responseText</span><span class="tok-p">);</span>
    <span class="tok-p">}</span> <span class="tok-k">else</span> <span class="tok-p">{</span>
      <span class="tok-nx">alert</span><span class="tok-p">(</span><span class="tok-s2">&quot;Houston, tenemos un problema&quot;</span><span class="tok-p">);</span>
    <span class="tok-p">}</span>
  <span class="tok-p">}</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A modo de esquema, el siguiente gráfico representa las llamadas realizadas mediante una petición asíncrona:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/js05/ajaxCicloAsync.jpg" alt="Ciclo de llamadas asíncrono en AJAX" width="50%">
</div>
<div class="title">Figure 2. Ciclo de llamadas asíncrono en AJAX</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Bucle de Eventos</div>
<div class="paragraph">
<p>En la primera sesión comentamos que <em>JavaScript</em> es un lenguaje mono-hilo. ¿Cómo se gestionan las peticiones HTTP asíncronas?</p>
</div>
<div class="paragraph">
<p>Todo el código <em>JavaScript</em> corre en un único hilo, mientras que el código que implementa tareas asíncronas no forma parte de <em>JavaScript</em> y por tanto es libre de ejecutarse en un hilo separado. Una vez la tarea asíncrona finaliza, el <em>callback</em> se sitúa en una cola para devolverle el contenido al hilo principal.</p>
</div>
<div class="paragraph">
<p>Tras añadir el <em>callback</em> a la cola, no hay ninguna garantía de cuanto va a tener que esperar. La cola puede contener sucesos tales como clicks de ratón, teclas pulsadas, respuestas HTTP o cualquier otra tarea asíncrona. El <em>runtime</em> de <em>JavaScript</em> ejecuta  un bucle infinito consistente en llevar el primer elemento de la cola, ejecutar el código que lanza el elemento y volver a comprobar la cola. Este ciclo se conoce como el <strong>bucle de eventos</strong>.</p>
</div>
<div class="paragraph">
<p>Más información en <a href="https://thomashunter.name/blog/the-javascript-event-loop-presentation/" class="bare">https://thomashunter.name/blog/the-javascript-event-loop-presentation/</a></p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_enviando_datos">5.1.3. Enviando datos</h4>
<div class="paragraph">
<p>Cuando vamos a enviar datos, el primer paso es serializarlos. Para ello, debemos considerar qué datos vamos a enviar, ya sean parejas de variable/valor o ficheros, si vamos a emplear el protocolo GET o POST y el formato de los datos a enviar.</p>
</div>
<div class="paragraph">
<p>HTML5 introduce el objeto <code>FormData</code> para serializar los datos y convertir la información a <code>multipart/form-data</code>. Se trata de un objeto similar a un mapa, el cual se puede inicializar con un formulario (pasándole al constructor el elemento DOM del formulario) o crearlo en blanco y añadirle valores mediante el método <code>append()</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">formDataObj</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">FormData</span><span class="tok-p">();</span>

<span class="tok-nx">formDataObj</span><span class="tok-p">.</span><span class="tok-nx">append</span><span class="tok-p">(</span><span class="tok-s1">&#39;uno&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;JavaScript&#39;</span><span class="tok-p">);</span>
<span class="tok-nx">formDataObj</span><span class="tok-p">.</span><span class="tok-nx">append</span><span class="tok-p">(</span><span class="tok-s1">&#39;dos&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;jQuery&#39;</span><span class="tok-p">);</span>
<span class="tok-nx">formDataObj</span><span class="tok-p">.</span><span class="tok-nx">append</span><span class="tok-p">(</span><span class="tok-s1">&#39;tres&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;HTML5&#39;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Más información en <a href="https://developer.mozilla.org/es/docs/Web/Guide/Usando_Objetos_FormData" class="bare">https://developer.mozilla.org/es/docs/Web/Guide/Usando_Objetos_FormData</a></p>
</div>
<div class="sect4">
<h5 id="_envío_mediante_get">Envío mediante GET</h5>
<div class="paragraph">
<p>A la hora de hacer el envío, mediante el método <code>send()</code> de la petición le podemos pasar una cadena compuesta por pares de <code>variable=valor</code>, separadas por <code>&amp;</code>, con los valores codificados mediante la función <code>encodeURIComponent</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">valor</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;Somos la Ñ&quot;</span><span class="tok-p">;</span>
<span class="tok-kd">var</span> <span class="tok-nx">datos</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;uno=JavaScript&amp;cuatro=&quot;</span> <span class="tok-o">+</span> <span class="tok-nb">encodeURIComponent</span><span class="tok-p">(</span><span class="tok-nx">valor</span><span class="tok-p">);</span>
<span class="tok-c1">// uno=JavaScript&amp;cuatro=Somos%20la%20%C3%91</span>

<span class="tok-kd">var</span> <span class="tok-nx">xhr</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">XMLHttpRequest</span><span class="tok-p">();</span>
<span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">open</span><span class="tok-p">(</span><span class="tok-s2">&quot;GET&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;fichero.txt&quot;</span><span class="tok-p">,</span> <span class="tok-kc">true</span><span class="tok-p">);</span>
<span class="tok-c1">// resto de código AJAX</span>
<span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">send</span><span class="tok-p">(</span><span class="tok-nx">datos</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_envío_mediante_post">Envío mediante POST</h5>
<div class="paragraph">
<p>Para poder enviar datos con POST, a la hora de abrir la conexión le indicaremos el método de envío mediante <code>xhr.setRequestHeader(
'Content-Type', 'application/x-www-form-urlencoded')</code> o el tipo de contenido deseado (<code>multipart/form-data</code>, <code>text/xml</code>, <code>application/json</code>, &#8230;&#8203;).</p>
</div>
<div class="paragraph">
<p>Tras esto, al enviar la petición los datos como una cadena o mediante un objeto <code>FormData</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">xhr</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">XMLHttpRequest</span><span class="tok-p">();</span>
<span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">open</span><span class="tok-p">(</span><span class="tok-s2">&quot;POST&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;fichero.txt&quot;</span><span class="tok-p">,</span> <span class="tok-kc">true</span><span class="tok-p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">setRequestHeader</span><span class="tok-p">(</span><span class="tok-s2">&quot;Content-Type&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;application/x-www-form-urlencoded&quot;</span><span class="tok-p">);</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-c1">// Resto de código AJAX</span>
<span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">send</span><span class="tok-p">(</span><span class="tok-s2">&quot;heroe=Batman&quot;</span><span class="tok-p">);</span> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Primer parámetro a <code>POST</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Indicamos el tipo de contenido que envía el formulario</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Le adjuntamos datos de envío como una cadena, o un objeto <code>FormData</code></td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_eventos">5.1.4. Eventos</h4>
<div class="paragraph">
<p>Toda petición AJAX lanza una serie de eventos conforme se realiza y completa la comunicación, ya sea al descargar datos del servidor como al enviarlos. Los eventos que podemos gestionar y el motivo de su lanzamiento son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>loadstart</code>: se lanza al iniciarse la petición</p>
</li>
<li>
<p><code>progress</code>: se lanza múltiples veces conforme se transfiere la información</p>
</li>
<li>
<p><code>load</code>: al completarse la transferencia</p>
</li>
<li>
<p><code>error</code>: se produce un error</p>
</li>
<li>
<p><code>abort</code>: el usuario cancela la petición</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Todos estos eventos se tienen que añadir antes de abrir la petición.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">xhr</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">XMLHttpRequest</span><span class="tok-p">();</span>
<span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">addEventListener</span><span class="tok-p">(</span><span class="tok-s1">&#39;loadstart&#39;</span><span class="tok-p">,</span> <span class="tok-nx">onLoadStart</span><span class="tok-p">,</span> <span class="tok-kc">false</span><span class="tok-p">);</span>
<span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">addEventListener</span><span class="tok-p">(</span><span class="tok-s1">&#39;progress&#39;</span><span class="tok-p">,</span> <span class="tok-nx">onProgress</span><span class="tok-p">,</span> <span class="tok-kc">false</span><span class="tok-p">);</span>
<span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">addEventListener</span><span class="tok-p">(</span><span class="tok-s1">&#39;load&#39;</span><span class="tok-p">,</span> <span class="tok-nx">onLoad</span><span class="tok-p">,</span> <span class="tok-kc">false</span><span class="tok-p">);</span>
<span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">addEventListener</span><span class="tok-p">(</span><span class="tok-s1">&#39;error&#39;</span><span class="tok-p">,</span> <span class="tok-nx">onError</span><span class="tok-p">,</span> <span class="tok-kc">false</span><span class="tok-p">);</span>
<span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">addEventListener</span><span class="tok-p">(</span><span class="tok-s1">&#39;abort&#39;</span><span class="tok-p">,</span> <span class="tok-nx">onAbort</span><span class="tok-p">,</span> <span class="tok-kc">false</span><span class="tok-p">);</span>

<span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">open</span><span class="tok-p">(</span><span class="tok-s1">&#39;GET&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;http://www.omdbapi.com/?s=batman&#39;</span><span class="tok-p">);</span>

<span class="tok-kd">function</span> <span class="tok-nx">onLoadStart</span><span class="tok-p">(</span><span class="tok-nx">evt</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;Iniciando la petición&#39;</span><span class="tok-p">);</span>
<span class="tok-p">}</span>

<span class="tok-kd">function</span> <span class="tok-nx">onProgress</span><span class="tok-p">(</span><span class="tok-nx">evt</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-kd">var</span> <span class="tok-nx">porcentajeActual</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-nx">evt</span><span class="tok-p">.</span><span class="tok-nx">loaded</span> <span class="tok-o">/</span> <span class="tok-nx">evt</span><span class="tok-p">.</span><span class="tok-nx">total</span><span class="tok-p">)</span> <span class="tok-o">*</span> <span class="tok-mi">100</span><span class="tok-p">;</span>   <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">porcentajeActual</span><span class="tok-p">);</span>
<span class="tok-p">}</span>

<span class="tok-kd">function</span> <span class="tok-nx">onLoad</span><span class="tok-p">(</span><span class="tok-nx">evt</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;Transferencia completada&#39;</span><span class="tok-p">);</span>
<span class="tok-p">}</span>

<span class="tok-kd">function</span> <span class="tok-nx">onError</span><span class="tok-p">(</span><span class="tok-nx">evt</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">error</span><span class="tok-p">(</span><span class="tok-s1">&#39;Error durante la transferenciaº&#39;</span><span class="tok-p">);</span>
<span class="tok-p">}</span>

<span class="tok-kd">function</span> <span class="tok-nx">onAbort</span><span class="tok-p">(</span><span class="tok-nx">evt</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">error</span><span class="tok-p">(</span><span class="tok-s1">&#39;El usuario ha cancelado la petición&#39;</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Mediante las propiedades <code>loaded</code> y <code>total</code> del evento, podemos obtener el porcentaje del archivo descargado.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_respuesta_http">5.1.5. Respuesta HTTP</h4>
<div class="paragraph">
<p>Si el tipo de datos obtenido de una petición no es una cadena, podemos indicarlo mediante el atributo <code>responseType</code>, el cual puede contener los siguientes valores: <code>text</code>, <code>arraybuffer</code>, <code>document</code> (para documentos XML o HTML), <code>blob</code> o <code>json</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">xhr</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">XMLHttpRequest</span><span class="tok-p">();</span>
<span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">open</span><span class="tok-p">(</span><span class="tok-s1">&#39;GET&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;http://expertojava.ua.es/experto/publico/imagenes/logo-completo.png&#39;</span><span class="tok-p">,</span> <span class="tok-kc">true</span><span class="tok-p">);</span>

<span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">responseType</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;blob&#39;</span><span class="tok-p">;</span> <i class="conum" data-value="1"></i><b>(1)</b>

<span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">addEventListener</span><span class="tok-p">(</span><span class="tok-s1">&#39;load&#39;</span><span class="tok-p">,</span> <span class="tok-nx">finDescarga</span><span class="tok-p">,</span> <span class="tok-kc">false</span><span class="tok-p">);</span>
<span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">send</span><span class="tok-p">();</span>

<span class="tok-kd">function</span> <span class="tok-nx">finDescarga</span><span class="tok-p">(</span><span class="tok-nx">evt</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">status</span> <span class="tok-o">==</span> <span class="tok-mi">200</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kd">var</span> <span class="tok-nx">blob</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Blob</span><span class="tok-p">([</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">response</span><span class="tok-p">],</span> <span class="tok-p">{</span><span class="tok-nx">type</span><span class="tok-o">:</span> <span class="tok-s1">&#39;img/png&#39;</span><span class="tok-p">});</span>
    <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s2">&quot;datos&quot;</span><span class="tok-p">).</span><span class="tok-nx">src</span> <span class="tok-o">=</span> <span class="tok-nx">blob</span><span class="tok-p">;</span>
  <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Indicamos que el tipo de la imagen es un <em>blob</em></td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_json">5.2. JSON</h3>
<div class="paragraph">
<p>Tal como vimos en el módulo de Servicios <em>REST</em>, <em>JSON</em> es un formato de texto que almacena datos reconocibles como objetos por <em>JavaScript</em>. Pese a que <em>AJAX</em> nació de la mano de <em>XML</em> como el formato idóneo de intercambio de datos, <em>JSON</em> se ha convertido en el estándar de facto para el intercambio de datos entre navegador y servidor, ya que se trata de un formato más eficiente y con una sintaxis de acceso a las propiedades más sencilla.</p>
</div>
<div class="paragraph">
<p>Supongamos que tenemos un archivo de texto (<code>heroes.json</code>) con información representada en <em>JSON</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span>
  <span class="tok-s2">&quot;nombre&quot;</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Batman&quot;</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;email&quot;</span><span class="tok-o">:</span> <span class="tok-s2">&quot;batman@heroes.com&quot;</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;gadgets&quot;</span><span class="tok-o">:</span> <span class="tok-p">[</span><span class="tok-s2">&quot;batmovil&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;batarang&quot;</span><span class="tok-p">],</span>
  <span class="tok-s2">&quot;amigos&quot;</span><span class="tok-o">:</span> <span class="tok-p">[</span>
    <span class="tok-p">{</span> <span class="tok-s2">&quot;nombre&quot;</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Robin&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;email&quot;</span><span class="tok-o">:</span> <span class="tok-s2">&quot;robin@heroes.com&quot;</span><span class="tok-p">},</span>
    <span class="tok-p">{</span> <span class="tok-s2">&quot;nombre&quot;</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Cat Woman&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;email&quot;</span><span class="tok-o">:</span> <span class="tok-s2">&quot;catwoman@heroes.com&quot;</span><span class="tok-p">}</span>
  <span class="tok-p">]</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si queremos recuperarla mediante <em>AJAX</em>, una vez recuperada la información del servidor, desde <em>ES5</em> podemos usar el objeto <code>JSON</code> para interactuar con el texto. Este objeto ofrece los siguientes métodos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>JSON.stringify(<em>objeto</em>)</code> obtiene la representación <em>JSON</em> de un <em>objeto</em> como una cadena, es decir, serializa el objeto, omitiendo todas las funciones, las propiedades con valores <code>undefined</code> y propiedades del prototipo.</p>
</li>
<li>
<p><code>JSON.parse(<em>cadena</em>)</code> parsea una <em>cadena</em> <em>JSON</em> en un objeto <em>JavaScript</em>.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">batman</span> <span class="tok-o">=</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;nombre&quot;</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Batman&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;email&quot;</span><span class="tok-o">:</span> <span class="tok-s2">&quot;batman@heroes.com&quot;</span> <span class="tok-p">};</span>
<span class="tok-kd">var</span> <span class="tok-nx">batmanTexto</span> <span class="tok-o">=</span> <span class="tok-nx">JSON</span><span class="tok-p">.</span><span class="tok-nx">stringify</span><span class="tok-p">(</span><span class="tok-nx">batman</span><span class="tok-p">);</span>
<span class="tok-kd">var</span> <span class="tok-nx">batmanOBjeto</span> <span class="tok-o">=</span> <span class="tok-nx">JSON</span><span class="tok-p">.</span><span class="tok-nx">parse</span><span class="tok-p">(</span><span class="tok-nx">batmanTexto</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Así pues, volvamos al código AJAX. Una vez recuperada la información del servidor, la transformamos a un objeto mediante <code>JSON.parse()</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">xhr</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">XMLHttpRequest</span><span class="tok-p">();</span>
<span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">open</span><span class="tok-p">(</span><span class="tok-s2">&quot;GET&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;heroes.json&quot;</span><span class="tok-p">,</span> <span class="tok-kc">true</span><span class="tok-p">);</span>
<span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">onreadystatechange</span> <span class="tok-o">=</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">readyState</span> <span class="tok-o">===</span> <span class="tok-mi">4</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kd">var</span> <span class="tok-nx">respuesta</span> <span class="tok-o">=</span> <span class="tok-nx">JSON</span><span class="tok-p">.</span><span class="tok-nx">parse</span><span class="tok-p">(</span><span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">responseText</span><span class="tok-p">);</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-nx">alert</span><span class="tok-p">(</span><span class="tok-nx">respuesta</span><span class="tok-p">.</span><span class="tok-nx">nombre</span><span class="tok-p">);</span>  <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="tok-p">}</span>
<span class="tok-p">};</span>
<span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">send</span><span class="tok-p">(</span><span class="tok-kc">null</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Con el texto recibido, lo deserializamos en un objeto respuesta</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Si hiciéramos un alert de <code>resp</code> tendríamos un objeto, por lo que podemos acceder a las propiedades.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si quisiéramos enviar datos al servidor en formato JSON, realizaremos una petición POST indicándole como tipo de contenido <code>application/json</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">xhr</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">XMLHttpRequest</span><span class="tok-p">();</span>
<span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">open</span><span class="tok-p">(</span><span class="tok-s2">&quot;POST&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;fichero.txt&quot;</span><span class="tok-p">,</span> <span class="tok-kc">true</span><span class="tok-p">);</span>
<span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">setRequestHeader</span><span class="tok-p">(</span><span class="tok-s2">&quot;Content-Type&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;application/json&quot;</span><span class="tok-p">);</span>
<span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">onreadystatechange</span> <span class="tok-o">=</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-c1">// código del manejador</span>
<span class="tok-p">};</span>
<span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">send</span><span class="tok-p">(</span><span class="tok-nx">JSON</span><span class="tok-p">.</span><span class="tok-nx">stringify</span><span class="tok-p">(</span><span class="tok-nx">objeto</span><span class="tok-p">));</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">eval</div>
<div class="paragraph">
<p>Si el navegador no soporta ES5, podemos usar la función <code>eval(codigo)</code> que evalúa una cadena como código <em>JavaScript</em>. Así pues, podríamos hacer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">textoRespuesta</span> <span class="tok-o">=</span> <span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">responseText</span><span class="tok-p">;</span>
<span class="tok-kd">var</span> <span class="tok-nx">objRespuesta</span> <span class="tok-o">=</span> <span class="tok-nb">eval</span><span class="tok-p">(</span> <span class="tok-s2">&quot;(&quot;</span> <span class="tok-o">+</span> <span class="tok-nx">textoRespuesta</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;)&quot;</span> <span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El problema de <code>eval</code> es que además de evaluar <em>JSON</em>, también puede evaluar código malicioso, con lo que su uso no se recomienda.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_filtrando_campos">5.2.1. Filtrando campos</h4>
<div class="paragraph">
<p>Al serializar un objeto mediante <code>stringify</code> podemos indicar tanto los campos que queremos incluir como el número de espacios utilizados como sangría del código.</p>
</div>
<div class="paragraph">
<p>Primero nos centraremos en el filtrado de campos. El segundo parámetro de <code>stringify</code> puede ser:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>un <em>array</em> con los campos que se incluirán al serializar</p>
</li>
<li>
<p>una función que recibe una clave y una propiedad, y que permite modificar el comportamiento de la operación. Si para un campo devuelve <code>undefined</code> dicho campo no se serializará.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">heroe</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
  <span class="tok-nx">nombre</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Batman&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">email</span><span class="tok-o">:</span> <span class="tok-s2">&quot;batman@heroes.com&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">gadgets</span><span class="tok-o">:</span> <span class="tok-p">[</span><span class="tok-s2">&quot;batmovil&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;batarang&quot;</span><span class="tok-p">],</span>
  <span class="tok-nx">amigos</span><span class="tok-o">:</span> <span class="tok-p">[</span>
    <span class="tok-p">{</span> <span class="tok-nx">nombre</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Robin&quot;</span><span class="tok-p">,</span> <span class="tok-nx">email</span><span class="tok-o">:</span> <span class="tok-s2">&quot;robin@heroes.com&quot;</span><span class="tok-p">},</span>
    <span class="tok-p">{</span> <span class="tok-nx">nombre</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Cat Woman&quot;</span><span class="tok-p">,</span> <span class="tok-nx">email</span><span class="tok-o">:</span> <span class="tok-s2">&quot;catwoman@heroes.com&quot;</span><span class="tok-p">}</span>
  <span class="tok-p">]</span>
<span class="tok-p">};</span>

<span class="tok-kd">var</span> <span class="tok-nx">nomEmail</span> <span class="tok-o">=</span> <span class="tok-nx">JSON</span><span class="tok-p">.</span><span class="tok-nx">stringify</span><span class="tok-p">(</span><span class="tok-nx">heroe</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-s2">&quot;nombre&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;email&quot;</span><span class="tok-p">]);</span>
<span class="tok-kd">var</span> <span class="tok-nx">joker</span> <span class="tok-o">=</span> <span class="tok-nx">JSON</span><span class="tok-p">.</span><span class="tok-nx">stringify</span><span class="tok-p">(</span><span class="tok-nx">heroe</span><span class="tok-p">,</span> <span class="tok-kd">function</span> <span class="tok-p">(</span><span class="tok-nx">clave</span><span class="tok-p">,</span> <span class="tok-nx">valor</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-k">switch</span> <span class="tok-p">(</span><span class="tok-nx">clave</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-k">case</span> <span class="tok-s2">&quot;nombre&quot;</span><span class="tok-o">:</span>
      <span class="tok-k">return</span> <span class="tok-s2">&quot;Joker&quot;</span><span class="tok-p">;</span>
    <span class="tok-k">case</span> <span class="tok-s2">&quot;email&quot;</span><span class="tok-o">:</span>
      <span class="tok-k">return</span> <span class="tok-s2">&quot;joker_&quot;</span> <span class="tok-o">+</span> <span class="tok-nx">valor</span><span class="tok-p">;</span>
    <span class="tok-k">case</span> <span class="tok-s2">&quot;gadgets&quot;</span><span class="tok-o">:</span>
      <span class="tok-k">return</span> <span class="tok-nx">valor</span><span class="tok-p">.</span><span class="tok-nx">join</span><span class="tok-p">(</span><span class="tok-s2">&quot; y &quot;</span><span class="tok-p">);</span>
    <span class="tok-k">default</span><span class="tok-o">:</span>
      <span class="tok-k">return</span> <span class="tok-nx">valor</span><span class="tok-p">;</span>
  <span class="tok-p">}</span>
<span class="tok-p">});</span>

<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">nomEmail</span><span class="tok-p">);</span> <span class="tok-c1">// {&quot;nombre&quot;:&quot;Batman&quot;,&quot;email&quot;:&quot;batman@heroes.com&quot;}</span>
<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">joker</span><span class="tok-p">);</span> <span class="tok-c1">// {&quot;nombre&quot;:&quot;Joker&quot;,&quot;email&quot;:&quot;joker_batman@heroes.com&quot;,&quot;gadgets&quot;:&quot;batmovil y batarang&quot;,&quot;amigos&quot;:[{&quot;nombre&quot;:&quot;Joker&quot;,&quot;email&quot;:&quot;joker_robin@heroes.com&quot;},{&quot;nombre&quot;:&quot;Joker&quot;,&quot;email&quot;:&quot;joker_catwoman@heroes.com&quot;}]}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En el caso de querer indentar el código, con el tercer parámetro le indicamos con un número (entre 1 y 10) la cantidad de espacios utilizados como sangría, y en el caso de pasarle un carácter, será el elemento utilizado como separador.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">JSON</span><span class="tok-p">.</span><span class="tok-nx">stringify</span><span class="tok-p">(</span><span class="tok-nx">heroe</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-s2">&quot;nombre&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;email&quot;</span><span class="tok-p">]));</span>
<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">JSON</span><span class="tok-p">.</span><span class="tok-nx">stringify</span><span class="tok-p">(</span><span class="tok-nx">heroe</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-s2">&quot;nombre&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;email&quot;</span><span class="tok-p">],</span> <span class="tok-mi">4</span><span class="tok-p">));</span>
<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">JSON</span><span class="tok-p">.</span><span class="tok-nx">stringify</span><span class="tok-p">(</span><span class="tok-nx">heroe</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-s2">&quot;nombre&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;email&quot;</span><span class="tok-p">],</span> <span class="tok-s2">&quot;&lt;-&gt;&quot;</span><span class="tok-p">));</span></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/js05/jsonStringify.jpg" alt="Personalizando la serialización de JSON">
</div>
<div class="title">Figure 3. Personalizando la serialización de JSON</div>
</div>
</div>
<div class="sect3">
<h4 id="_ejemplo_omdb">5.2.2. Ejemplo OMDB</h4>
<div class="paragraph">
<p>Una vez que sabemos como parsear una respuesta JSON, vamos a mostrar un ejemplo completo de una petición AJAX al servidor de OMDB para obtener los datos de una película. Al realizar una petición de búsqueda con <a href="http://www.omdbapi.com/?s=batman" class="bare">http://www.omdbapi.com/?s=batman</a>, en OMDB, obtendremos una respuesta tal que así:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="json"><span class="tok-p">{</span><span class="tok-nt">&quot;Search&quot;</span><span class="tok-p">:[</span>
  <span class="tok-p">{</span><span class="tok-nt">&quot;Title&quot;</span><span class="tok-p">:</span><span class="tok-s2">&quot;Batman Begins&quot;</span><span class="tok-p">,</span><span class="tok-nt">&quot;Year&quot;</span><span class="tok-p">:</span><span class="tok-s2">&quot;2005&quot;</span><span class="tok-p">,</span><span class="tok-nt">&quot;imdbID&quot;</span><span class="tok-p">:</span><span class="tok-s2">&quot;tt0372784&quot;</span><span class="tok-p">,</span><span class="tok-nt">&quot;Type&quot;</span><span class="tok-p">:</span><span class="tok-s2">&quot;movie&quot;</span><span class="tok-p">,</span><span class="tok-nt">&quot;Poster&quot;</span><span class="tok-p">:</span><span class="tok-s2">&quot;http://ia.media-imdb.com/images/M/MV5BNTM3OTc0MzM2OV5BMl5BanBnXkFtZTYwNzUwMTI3._V1_SX300.jpg&quot;</span><span class="tok-p">},</span>
  <span class="tok-p">{</span><span class="tok-nt">&quot;Title&quot;</span><span class="tok-p">:</span><span class="tok-s2">&quot;Batman&quot;</span><span class="tok-p">,</span><span class="tok-nt">&quot;Year&quot;</span><span class="tok-p">:</span><span class="tok-s2">&quot;1989&quot;</span><span class="tok-p">,</span><span class="tok-nt">&quot;imdbID&quot;</span><span class="tok-p">:</span><span class="tok-s2">&quot;tt0096895&quot;</span><span class="tok-p">,</span><span class="tok-nt">&quot;Type&quot;</span><span class="tok-p">:</span><span class="tok-s2">&quot;movie&quot;</span><span class="tok-p">,</span><span class="tok-nt">&quot;Poster&quot;</span><span class="tok-p">:</span><span class="tok-s2">&quot;http://ia.media-imdb.com/images/M/MV5BMTYwNjAyODIyMF5BMl5BanBnXkFtZTYwNDMwMDk2._V1_SX300.jpg&quot;</span><span class="tok-p">},</span>
  <span class="tok-p">{</span><span class="tok-nt">&quot;Title&quot;</span><span class="tok-p">:</span><span class="tok-s2">&quot;Batman Returns&quot;</span><span class="tok-p">,</span><span class="tok-nt">&quot;Year&quot;</span><span class="tok-p">:</span><span class="tok-s2">&quot;1992&quot;</span><span class="tok-p">,</span><span class="tok-nt">&quot;imdbID&quot;</span><span class="tok-p">:</span><span class="tok-s2">&quot;tt0103776&quot;</span><span class="tok-p">,</span><span class="tok-nt">&quot;Type&quot;</span><span class="tok-p">:</span><span class="tok-s2">&quot;movie&quot;</span><span class="tok-p">,</span><span class="tok-nt">&quot;Poster&quot;</span><span class="tok-p">:</span><span class="tok-s2">&quot;http://ia.media-imdb.com/images/M/MV5BODM2OTc0Njg2OF5BMl5BanBnXkFtZTgwMDA4NjQxMTE@._V1_SX300.jpg&quot;</span><span class="tok-p">},</span>
  <span class="tok-err">...</span>
<span class="tok-p">]}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por lo tanto, para mostrar el título y el año de las peliculas encontradas haremos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">xhr</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">XMLHttpRequest</span><span class="tok-p">();</span>
<span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">open</span><span class="tok-p">(</span><span class="tok-s1">&#39;GET&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;http://www.omdbapi.com/?s=batman&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;true&#39;</span><span class="tok-p">);</span>
<span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">onreadystatechange</span> <span class="tok-o">=</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">readyState</span> <span class="tok-o">===</span> <span class="tok-mi">4</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-nx">mostrarPelicula</span><span class="tok-p">(</span><span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">responseText</span><span class="tok-p">);</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-p">}</span>
<span class="tok-p">};</span>
<span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">send</span><span class="tok-p">(</span><span class="tok-kc">null</span><span class="tok-p">);</span>

<span class="tok-kd">function</span> <span class="tok-nx">mostrarPelicula</span><span class="tok-p">(</span><span class="tok-nx">datos</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kd">var</span> <span class="tok-nx">o</span> <span class="tok-o">=</span> <span class="tok-nx">JSON</span><span class="tok-p">.</span><span class="tok-nx">parse</span><span class="tok-p">(</span><span class="tok-nx">datos</span><span class="tok-p">);</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-kd">var</span> <span class="tok-nx">pelis</span> <span class="tok-o">=</span> <span class="tok-nx">o</span><span class="tok-p">.</span><span class="tok-nx">Search</span><span class="tok-p">;</span>
    <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-nx">numPeli</span> <span class="tok-k">in</span> <span class="tok-nx">pelis</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">pelis</span><span class="tok-p">[</span><span class="tok-nx">numPeli</span><span class="tok-p">].</span><span class="tok-nx">Title</span> <span class="tok-o">+</span> <span class="tok-s2">&quot; - &quot;</span> <span class="tok-o">+</span> <span class="tok-nx">pelis</span><span class="tok-p">[</span><span class="tok-nx">numPeli</span><span class="tok-p">].</span><span class="tok-nx">Year</span><span class="tok-p">);</span>
    <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Una vez recibida la respuesta, desacoplamos la petición del tratamiento de la respuesta</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Transformamos los datos recibidos como JSON en un objeto para facilitar su manejo</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_cross_domain">5.2.3. Cross-Domain</h4>
<div class="paragraph">
<p>Sabemos que el navegador funciona como <em>sandbox</em> y restringe las peticiones <em>AJAX</em>, de modo que sólo permite realizar peticiones a recursos que se encuentren en el mismo dominio.</p>
</div>
<div class="paragraph">
<p>Esta restricción de conoce como <em>Same-Origin Policy</em>, y para ello las peticiones tienen que compartir protocolo, servidor y puerto. Esta política también fija que desde un dominio A se puede realizar una petición a un dominio B, pero no se puede obtener ninguna información de la petición hacia B, ni la respuesta ni siquiera el código de respuesta.</p>
</div>
<div class="paragraph">
<p>El uso de <em>cross-domain AJAX</em> permite romper esta política bajo ciertas circunstancias, dependiendo de la técnica utilizada:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Proxy</strong> en el servidor: creamos un servicio en nuestro servidor que <em>retransmita</em> la petición al host al que queremos llegar. Como las peticiones desde el lado del servidor no están restringidas, no habrá ningún problema.</p>
<div class="imageblock">
<div class="content">
<img src="images/js05/ajaxProxyYahoo.gif" alt="Proxy en el servidor">
</div>
<div class="title">Figure 4. Proxy en el Servidor</div>
</div>
</li>
<li>
<p><strong>CORS</strong> (<em>Cross-Origin Resource Sharing</em>): Si el servidor al que le haces la petición la permite (enviando la cabecera <code>Access-Control-Allow-Origin</code>), el navegador también dejará que se realice. Para ello, los servidores tienen que especificar que permiten peticiones de otros dominios.</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="conf">Access-Control-Allow-Credentials:<span class="tok-w"> </span>true<span class="tok-w"></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Además, en el código del cliente, hemos de comprobar si la conexión se ha realizado con credenciales (el objeto <code>XMLHttpRequest</code> contiene la propiedad <code>withCredentials</code> a <code>true</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">xhr</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">XMLHttpRequest</span><span class="tok-p">();</span>
<span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-s2">&quot;withCredentials&quot;</span> <span class="tok-k">in</span> <span class="tok-nx">xhr</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-c1">// CORS Habilitado</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La realidad es que pocos dominios permiten su uso (algunos son <a href="http://bit.ly" class="bare">http://bit.ly</a> o <a href="http://twitpic.com" class="bare">http://twitpic.com</a>).</p>
</div>
<div class="paragraph">
<p>Si queremos evitarnos configurar el servidor con la cabecera, podemos hacer uso de <a href="http://www.corsproxy.com" class="bare">http://www.corsproxy.com</a>, el cual fusiona tanto la técnica <em>CORS</em> como el uso de un proxy.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Un artículo muy completo sobre el uso de <em>CORS</em>: <a href="http://www.html5rocks.com/en/tutorials/cors" class="bare">http://www.html5rocks.com/en/tutorials/cors</a>
</td>
</tr>
</table>
</div>
</li>
<li>
<p><strong>JSONP</strong> (<em>JSON with Padding</em>): Las restricciones de seguridad no se aplican a la etiqueta <code>&lt;script&gt;</code>. Con ella podemos cargar (¡y ejecutar!) código <em>JavaScript</em> de cualquier origen mediante una petición <em>GET</em>, con lo que podríamos cargar en un punto del documento la respuesta del servidor en formato <em>JSON</em>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_jsonp">5.2.4. JSONP</h4>
<div class="paragraph">
<p>Estudiemos en más detalle esta técnica. Supongamos que realizamos la siguiente petición:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;script </span><span class="tok-na">src=</span><span class="tok-s">&quot;http://www.omdbapi.com/?s=batman&quot;</span><span class="tok-nt">&gt;&lt;/script&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Esto no sirve de mucho, ya que sólo inserta en ese punto del documento el objeto en formato <em>JSON</em>, pero no hace nada con esa información.</p>
</div>
<div class="paragraph">
<p>Lo que <em>JSONP</em> permite es definir una función (que es nuestra) y que recibirá como parámetro el <em>JSON</em> que envía el servidor. Los servicios que admiten <em>JSONP</em> reciben un parámetro en la petición, (normalmente llamado <em>callback</em>) que especifica el nombre de la función a llamar.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="url">http://www.omdbapi.com/?s=batman?callback=miFuncion</code></pre>
</div>
</div>
<div class="paragraph">
<p>El servidor nos devolverá un <em>JavaScript</em> del estilo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">miFuncion</span><span class="tok-p">(</span><span class="tok-nx">respuestaEnJSON</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Es decir, tras la llamada, se ejecutará <code>miFuncion</code> recibiendo como argumento el <em>JSON</em>. En <code>miFuncion</code> procesaríamos los datos y los mostraríamos en la página.</p>
</div>
<div class="paragraph">
<p>Si queremos que la petición se realice al producirse un evento, hemos de crear la etiqueta <code>&lt;script&gt;</code> de manera dinámica:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo JSONP - <a href="http://jsbin.com/riruc/1/edit?html,js,output" class="bare">http://jsbin.com/riruc/1/edit?html,js,output</a></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;body&gt;</span>
<span class="tok-nt">&lt;script&gt;</span>
  <span class="tok-kd">function</span> <span class="tok-nx">llamarServicio</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-kd">var</span> <span class="tok-nx">s</span> <span class="tok-o">=</span> <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">createElement</span><span class="tok-p">(</span><span class="tok-s2">&quot;script&quot;</span><span class="tok-p">);</span>
    <span class="tok-nx">s</span><span class="tok-p">.</span><span class="tok-nx">src</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;http://www.omdbapi.com/?s=batman?callback=miFuncion&quot;</span><span class="tok-p">;</span>
    <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">body</span><span class="tok-p">.</span><span class="tok-nx">appendChild</span><span class="tok-p">(</span><span class="tok-nx">s</span><span class="tok-p">);</span>
  <span class="tok-p">}</span>
  <span class="tok-kd">function</span> <span class="tok-nx">miFuncion</span><span class="tok-p">(</span><span class="tok-nx">json</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s2">&quot;resultado&quot;</span><span class="tok-p">).</span><span class="tok-nx">innerHTML</span> <span class="tok-o">=</span> <span class="tok-nx">JSON</span><span class="tok-p">.</span><span class="tok-nx">stringify</span><span class="tok-p">(</span><span class="tok-nx">json</span><span class="tok-p">);</span>
  <span class="tok-p">}</span>
<span class="tok-nt">&lt;/script&gt;</span>
<span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;button&quot;</span> <span class="tok-na">onclick=</span><span class="tok-s">&quot;llamarServicio()&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;JSONP&quot;</span><span class="tok-nt">&gt;</span>
<span class="tok-nt">&lt;div</span> <span class="tok-na">id=</span><span class="tok-s">&quot;resultado&quot;</span><span class="tok-nt">&gt;&lt;/div&gt;</span>
<span class="tok-nt">&lt;/body&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Esta técnica se restringe a peticiones <em>GET</em>, con lo que si queremos hacer otro tipo de petición (<em>POST</em>, <em>PUT</em> o <em>DELETE</em>), no podremos usar <em>JSONP</em>. Además, requiere que el servidor sea de confianza, ya que el servicio podría devolver código malicioso que se ejecutará en el contexto de nuestra página (lo que le da acceso a las <em>cookies</em>, almacenamiento local, etc&#8230;&#8203;). Para reducir los riesgos se pueden usar <em>frames</em> y <code>window.postMessage</code> para aislar las peticiones <em>JSONP</em>.</p>
</div>
<div class="paragraph">
<p>Trabajaremos más ejemplos de <em>AJAX</em> mediante <em>jQuery</em> en siguientes sesiones, el cual facilita mucho el acceso a contenido remoto desde el cliente.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Podemos consultar un ejemplo completo de <em>JSONP</em> con código <em>jQuery</em> en el cliente y <em>Java</em> en el servidor en <a href="http://www.mysamplecode.com/2012/05/jquery-cross-domain-ajax-request.html" class="bare">http://www.mysamplecode.com/2012/05/jquery-cross-domain-ajax-request.html</a>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_testing">5.2.5. Testing</h4>
<div class="paragraph">
<p>En la unidad anterior ya vimos como hacer pruebas de código asíncrono mediante <em>QUnit</em>. Veamos un ejemplo que pruebe código AJAX:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">QUnit</span><span class="tok-p">.</span><span class="tok-nx">asyncTest</span><span class="tok-p">(</span><span class="tok-s1">&#39;ajaxHeroes&#39;</span><span class="tok-p">,</span> <span class="tok-kd">function</span> <span class="tok-p">(</span><span class="tok-nx">assert</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nx">expect</span><span class="tok-p">(</span><span class="tok-mi">2</span><span class="tok-p">);</span>  <i class="conum" data-value="1"></i><b>(1)</b>

  <span class="tok-kd">var</span> <span class="tok-nx">xhr</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">XMLHttpRequest</span><span class="tok-p">();</span>
  <span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">open</span><span class="tok-p">(</span><span class="tok-s2">&quot;GET&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;heroes.json&quot;</span><span class="tok-p">,</span> <span class="tok-kc">true</span><span class="tok-p">);</span>
  <span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">onreadystatechange</span> <span class="tok-o">=</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">readyState</span> <span class="tok-o">===</span> <span class="tok-mi">4</span><span class="tok-p">)</span> <span class="tok-p">{</span>
      <span class="tok-kd">var</span> <span class="tok-nx">respuesta</span> <span class="tok-o">=</span> <span class="tok-nx">JSON</span><span class="tok-p">.</span><span class="tok-nx">parse</span><span class="tok-p">(</span><span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">responseText</span><span class="tok-p">);</span>
      <span class="tok-nx">assert</span><span class="tok-p">.</span><span class="tok-nx">equal</span><span class="tok-p">(</span><span class="tok-nx">respuesta</span><span class="tok-p">.</span><span class="tok-nx">nombre</span><span class="tok-p">,</span> <span class="tok-s2">&quot;Batman&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;Atributo de archivo json&quot;</span><span class="tok-p">);</span>
      <span class="tok-nx">assert</span><span class="tok-p">.</span><span class="tok-nx">equal</span><span class="tok-p">(</span><span class="tok-nx">respuesta</span><span class="tok-p">.</span><span class="tok-nx">amigos</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">].</span><span class="tok-nx">nombre</span><span class="tok-p">,</span> <span class="tok-s2">&quot;Robin&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;Atributo de un hijo que es array&quot;</span><span class="tok-p">);</span>
      <span class="tok-nx">QUnit</span><span class="tok-p">.</span><span class="tok-nx">start</span><span class="tok-p">();</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-p">}</span>
  <span class="tok-p">};</span>
  <span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">send</span><span class="tok-p">(</span><span class="tok-kc">null</span><span class="tok-p">);</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Le indicamos a la prueba que vamos a realizar dos aserciones</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Una vez indicadas las aserciones, le indicamos a QUnit que lance la petición AJAX</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_html_5">5.3. HTML 5</h3>
<div class="paragraph">
<p>Las principales características que ofrece HTML 5 y que se están incorporando a los navegadores de manera progresiva son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Soporte de vídeo, mediante <code>&lt;video&gt;</code> (operaciones <code>.play()</code>, <code>.pause()</code>, <code>currentTime = 0</code>; evento <code>ended</code>, <code>play</code>, <code>pause</code>, &#8230;&#8203;)</p>
</li>
<li>
<p>Soporte de audio</p>
</li>
<li>
<p>Elemento <code>canvas</code> para la generación de gráficos en 2D, similar a SVG.</p>
</li>
<li>
<p>Almacenamiento local y/o <em>offline</em>, mediante el objeto <code>localStorage</code> que estudiaremos más adelante.</p>
</li>
<li>
<p>Nuevos elementos de formulario, como tipos <code>email</code>, <code>date</code>, <code>number</code>, &#8230;&#8203;</p>
</li>
<li>
<p>Arrastrar y soltar (Drag-and-drop)</p>
</li>
<li>
<p>Geolocalización</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La implementación de cada una de estas prestaciones viene determinada por el navegador y la versión empleada. Si queremos consultar alguna característica concreta, podemos comprobar en <a href="http://caniuse.com" class="bare">http://caniuse.com</a> que navegadores la soportan.</p>
</div>
<div class="paragraph">
<p>Cada una de las características vistas anteriormente (vídeo, audio, geolocalización) tienen sus métodos y eventos propios, que se salen del alcance del módulo.</p>
</div>
<div class="paragraph">
<p>En cuanto a <em>JavaScript</em>, la única característica que viene de la mano de <em>ECMAScript 5</em> es la selección de elementos mediante la clase CSS, mediante el método <code>getElementsByClassName(claseCSS)</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">c1</span> <span class="tok-o">=</span> <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementsByClassName</span><span class="tok-p">(</span><span class="tok-s2">&quot;clase1&quot;</span><span class="tok-p">)</span>
<span class="tok-kd">var</span> <span class="tok-nx">c12</span> <span class="tok-o">=</span> <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementsByClassName</span><span class="tok-p">(</span><span class="tok-s2">&quot;clase1 clase2&quot;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_detección_de_características_em_modernizr_em">5.3.1. Detección de características. <em>Modernizr</em></h4>
<div class="paragraph">
<p>Si a nivel programativo queremos averiguar si el navegador que empleamos soporta una determinada característica para así emplearla, necesitamos realizar una detección de la misma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementsByClassName</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-c1">// existe, por lo que el navegador lo soporta</span>
<span class="tok-p">}</span> <span class="tok-k">else</span> <span class="tok-p">{</span>
  <span class="tok-c1">// no existe, con lo que el navegador no lo soporta</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="title">Detección del navegador</div>
<div class="paragraph">
<p>Hace años se programaba detectando el navegador con el que se conectaba el usuario:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">navigator</span><span class="tok-p">.</span><span class="tok-nx">userAgent</span><span class="tok-p">.</span><span class="tok-nx">indexOf</span><span class="tok-p">(</span><span class="tok-s2">&quot;Netscape&quot;</span><span class="tok-p">))</span> <span class="tok-p">{</span> <span class="tok-c1">/// }</span>
<span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">navigator</span><span class="tok-p">.</span><span class="tok-nx">appName</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;Microsoft Internet Explorer&quot;</span><span class="tok-p">)</span> <span class="tok-p">{</span> <span class="tok-c1">/// }</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Este tipo de desarrollo es muy peligroso, por las continuas actualizaciones del navegador y el costoso mantenimiento del código. Es mucho mejor detectar la característica en la que estamos interesados o usar un framework como <em>jQuery</em> para implementar código <em>cross-browser</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para ayudarnos a detectar las características que ofrece nuestro navegador, podemos usar la famosa librería <strong><em>Modernizr</em></strong> (<a href="http://www.modernizr.com" class="bare">http://www.modernizr.com</a>). Esta librería ofrece el objeto <code>Modernizr</code> que contiene propiedades booleanas con las prestaciones soportadas, por ejemplo, <code>Modernizr.video</code> o <code>Modernizr.localStorage</code>. Así pues, una vez incluida la librería, para detectar si el navegador soporta la etiqueta <code>video</code> de HTML5 haríamos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">Modernizr</span><span class="tok-p">.</span><span class="tok-nx">video</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-c1">// usamos el vídeo de HTML5</span>
<span class="tok-p">}</span> <span class="tok-k">else</span> <span class="tok-p">{</span>
  <span class="tok-c1">// usamos el vídeo Flash</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_polyfills">5.3.2. Polyfills</h4>
<div class="paragraph">
<p>Si nuestro navegador no soporta la característica deseada, podemos usar <em>HTML shims</em> o <em>polyfills</em> que reproducen la funcionalidad del navegador.</p>
</div>
<div class="paragraph">
<p>Un <strong><em>shim</em></strong> es una librería que ofrece una nueva API a un entorno antiguo mediante los medios que ofrece el entorno.</p>
</div>
<div class="paragraph">
<p>Un <strong><em>polyfill</em></strong> es un fragmento de código (o <em>plugin</em>) que ofrece la tecnología que esperamos que el navegador ofrezca de manera nativa. Con lo que un <em>polyfill</em> es un <em>shim</em> para el API del navegador.</p>
</div>
<div class="paragraph">
<p>Lo que nosotros haremos es comprobar mediante <em>Modernizr</em> si el navegador soporta un API, y en caso negativo, cargar un <em>polyfill</em>.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, si nuestra aplicación tiene que soportar navegadores  antiguos, podemos usar el <em>polyfill</em> <strong>html5shiv</strong> (<a href="https://github.com/aFarkas/html5shiv" class="bare">https://github.com/aFarkas/html5shiv</a>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-c">&lt;!--[if lt IE 9]&gt;</span>
<span class="tok-c">&lt;script src=&quot;html5shiv.js&quot;&gt;&lt;/script&gt;</span>
<span class="tok-c">&lt;![endif]--&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si estamos interesados en una funcionalidad concreta de HTML5, en la página de <em>Modernizr</em> tienen un catálogo extenso de <em>polyfills</em>: <a href="https://github.com/Modernizr/Modernizr/wiki/HTML5-Cross-Browser-Polyfills" class="bare">https://github.com/Modernizr/Modernizr/wiki/HTML5-Cross-Browser-Polyfills</a></p>
</div>
<div class="paragraph">
<p>En <a href="http://html5please.com" class="bare">http://html5please.com</a> tenemos un listado de las características de HTML y su estado, con recomendaciones de <em>polyfills</em> e implementaciones para facilitar la decisión de usar o no dichas características.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_almacenando_información">5.4. Almacenando información</h3>
<div class="paragraph">
<p>Una manera de almacenar información en el navegador es mediante <em>cookies</em>, aunque su gestión mediante <em>JavaScript</em> sea muy laboriosa.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Todos los almacenes que vamos a estudiar a continuación se pueden visualizar dentro de las <em>DevTools</em> en la pestaña <em>Resources</em>.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_cookies">5.4.1. Cookies</h4>
<div class="paragraph">
<p>Para almacenar una <em>cookie</em> podemos acceder a la propiedad <code>document.cookie</code> asignándole un valor o consultándola para recuperar el valor almacenado.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">cookie</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;nombre=Batman&quot;</span><span class="tok-p">;</span>
<span class="tok-kd">var</span> <span class="tok-nx">info</span> <span class="tok-o">=</span> <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">cookie</span><span class="tok-p">;</span>
<span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">cookie</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;amigo=Robin&quot;</span><span class="tok-p">;</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>crea la cookie para <code>amigo</code>, sin eliminar la de <code>nombre</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Por defecto las <em>cookies</em> se eliminan al cerrar el navegador. Si queremos que no sea así, podemos indicar su fecha de expiración mediante el atributo <code>expires</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">cookie</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;nombre=Batman; expires=Thu Dec 31 2015 00:00:00 GMT+0100 (CET)&quot;</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para eliminar una <em>cookie</em> hay que poner el atributo <code>expires</code> con una fecha del pasado y no pasarle ningún valor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">cookie</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;nombre=; expires=Thu Jan 01 1970 00:00:00 GMT+0100 (CET)&quot;</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Más ejemplos en <a href="https://developer.mozilla.org/en-US/docs/Web/API/document.cookie" class="bare">https://developer.mozilla.org/en-US/docs/Web/API/document.cookie</a></p>
</div>
<div class="paragraph">
<p>La principal ventaja de usar <em>cookies</em> es que tanto el servidor con <em>Java</em> (o cualquier otro lenguaje) como el navegador mediante <em>JavaScript</em> pueden acceder a la información almacenada.</p>
</div>
<div class="paragraph">
<p>Pero también tiene sus inconvenientes, ya que:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>sólo pueden almacenar hasta 4KB (normalmente guardan una clave <em>hash</em> que identifica la vista)</p>
</li>
<li>
<p>se envían y vuelven a recibir con cada petición</p>
</li>
<li>
<p>caducan</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_localstorage">5.4.2. LocalStorage</h4>
<div class="paragraph">
<p>En cambio, si nos centramos en <em>LocalStorage</em>, sólo podemos usarlo mediante <em>JavaScript</em>, aunque como veremos a continuación, su uso es muy sencillo y potente:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>puede almacenar entre 5 y 10 MB</p>
</li>
<li>
<p>la información almacenada no se envía al servidor con cada petición</p>
</li>
<li>
<p>no caduca</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>El almacenamiento local aparece de la mano de HTML5 y se basa en un mapa de claves/valor donde podemos almacenar todo el contenido que deseemos. Para ello, hemos de usar el objeto global <code>localStorage</code> y asociarle valores a sus propiedades. También podemos usar los métodos <code>.setItem(clave)</code> y <code>.getItem(clave)</code> para acceder a las propiedades de manera dinámica.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Las propiedades son sensibles a las mayúsculas, con lo que <code>.nombre</code> y <code>.Nombre</code> son propiedades distintas.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">localStorage</span><span class="tok-p">.</span><span class="tok-nx">nombre</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;Aitor&quot;</span><span class="tok-p">;</span>
<span class="tok-nx">localStorage</span><span class="tok-p">.</span><span class="tok-nx">setItem</span><span class="tok-p">(</span><span class="tok-s2">&quot;apellido1&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;Medrano&quot;</span><span class="tok-p">);</span>

<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">localStorage</span><span class="tok-p">.</span><span class="tok-nx">nombre</span><span class="tok-p">);</span>
<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">localStorage</span><span class="tok-p">.</span><span class="tok-nx">getItem</span><span class="tok-p">(</span><span class="tok-s2">&quot;apellido1&quot;</span><span class="tok-p">));</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
MDN recomienda usar los métodos <code>getItem</code> y <code>setItem</code> en vez del uso de las propiedades
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si queremos comprobar o modificar lo que hay en almacenado en el almacén del navegador, podemos abrir las <em>Dev-Tools</em> y acceder a la pestaña <em>Resources</em>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/js05/localStorageDevTools.jpg" alt="LocalStorage en DevTools" width="66%">
</div>
<div class="title">Figure 5. LocalStorage en DevTools</div>
</div>
<div class="paragraph">
<p>Si en algún momento queremos saber cuantos elementos tenemos almacenados, podemos usar la propiedad <code>length</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">localStorage</span><span class="tok-p">.</span><span class="tok-nx">length</span><span class="tok-p">);</span> <span class="tok-c1">// 2</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si queremos eliminar una propiedad, usaremos el método <code>removeItem(clave)</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">localStorage</span><span class="tok-p">.</span><span class="tok-nx">removeItem</span><span class="tok-p">(</span><span class="tok-nx">apellido1</span><span class="tok-p">);</span>
<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">localStorage</span><span class="tok-p">.</span><span class="tok-nx">getItem</span><span class="tok-p">(</span><span class="tok-s2">&quot;apellido1&quot;</span><span class="tok-p">));</span> <span class="tok-c1">// undefined</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finalmente, si queremos limpiar el almacenamiento local, podemos hacer un <code>clear()</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">localStorage</span><span class="tok-p">.</span><span class="tok-nx">clear</span><span class="tok-p">();</span>
<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">localStorage</span><span class="tok-p">.</span><span class="tok-nx">getItem</span><span class="tok-p">(</span><span class="tok-s2">&quot;nombre&quot;</span><span class="tok-p">));</span> <span class="tok-c1">// undefined</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
En los navegadores <em>Safari</em>, <em>Safari iOS</em> y <em>Android</em>, al usar la navegación privada, no se permite el uso de <code>localStorage</code>. En el resto, al salir de la navegación privada, la base de datos se vacía.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Cabe destacar que los datos se almacenan todos como cadenas, ya que antes de almacenar se ejecuta el método <code>.toString</code> por lo que si insertamos un dato como número, deberemos volver al parsearlo al recuperarlo del almacenamiento.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">localStorage</span><span class="tok-p">.</span><span class="tok-nx">edad</span> <span class="tok-o">=</span> <span class="tok-mi">35</span><span class="tok-p">;</span>
<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-k">typeof</span> <span class="tok-nx">localStorage</span><span class="tok-p">.</span><span class="tok-nx">getItem</span><span class="tok-p">(</span><span class="tok-s2">&quot;edad&quot;</span><span class="tok-p">));</span> <span class="tok-c1">// &quot;string&quot;</span>
<span class="tok-kd">var</span> <span class="tok-nx">edad</span> <span class="tok-o">=</span> <span class="tok-nb">parseInt</span><span class="tok-p">(</span><span class="tok-nx">localStorage</span><span class="tok-p">.</span><span class="tok-nx">getItem</span><span class="tok-p">(</span><span class="tok-s2">&quot;edad&quot;</span><span class="tok-p">),</span> <span class="tok-mi">10</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_almacenando_un_objeto">Almacenando un objeto</h5>
<div class="paragraph">
<p>Si lo que queremos almacenar es un objeto, realmente se almacenará una cadena indicando que se trata de un objeto.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">persona</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
  <span class="tok-nx">nombre</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Aitor&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">apellido1</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Medrano&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">edad</span> <span class="tok-o">:</span> <span class="tok-mi">35</span>
<span class="tok-p">};</span>

<span class="tok-nx">localStorage</span><span class="tok-p">.</span><span class="tok-nx">setItem</span><span class="tok-p">(</span><span class="tok-s2">&quot;persona&quot;</span><span class="tok-p">,</span> <span class="tok-nx">persona</span><span class="tok-p">);</span>
<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">localStorage</span><span class="tok-p">.</span><span class="tok-nx">getItem</span><span class="tok-p">(</span><span class="tok-s2">&quot;persona&quot;</span><span class="tok-p">));</span> <span class="tok-c1">// [object Object]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para solucionar esto, lo mejor es usar las librerías JSON que acabamos de estudiar para crear una representación del objeto mediante <code>JSON.stringify(objeto)</code> y posteriormente recuperarlo con <code>JSON.parse(objetoLS)</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">persona</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
  <span class="tok-nx">nombre</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Aitor&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">apellido1</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Medrano&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">edad</span> <span class="tok-o">:</span> <span class="tok-mi">18</span>
<span class="tok-p">};</span>

<span class="tok-nx">localStorage</span><span class="tok-p">.</span><span class="tok-nx">setItem</span><span class="tok-p">(</span><span class="tok-s2">&quot;persona&quot;</span><span class="tok-p">,</span> <span class="tok-nx">JSON</span><span class="tok-p">.</span><span class="tok-nx">stringify</span><span class="tok-p">(</span><span class="tok-nx">persona</span><span class="tok-p">));</span>
<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">localStorage</span><span class="tok-p">.</span><span class="tok-nx">getItem</span><span class="tok-p">(</span><span class="tok-s2">&quot;persona&quot;</span><span class="tok-p">));</span> <span class="tok-c1">// &quot;{\&quot;nombre\&quot;:\&quot;Aitor\&quot;, \&quot;apellido1\&quot;:\&quot;Medrano\&quot;, \&quot;edad\&quot;:18}&quot;</span>
<span class="tok-kd">var</span> <span class="tok-nx">personaRecuperada</span> <span class="tok-o">=</span> <span class="tok-nx">JSON</span><span class="tok-p">.</span><span class="tok-nx">parse</span><span class="tok-p">(</span><span class="tok-nx">localStorage</span><span class="tok-p">.</span><span class="tok-nx">getItem</span><span class="tok-p">(</span><span class="tok-s2">&quot;persona&quot;</span><span class="tok-p">));</span>
<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">personaRecuperada</span><span class="tok-p">);</span> <span class="tok-cm">/* [object Object] {</span>
<span class="tok-cm">  apellido1: &quot;Medrano&quot;,</span>
<span class="tok-cm">  edad: 18,</span>
<span class="tok-cm">  nombre: &quot;Aitor&quot;</span>
<span class="tok-cm">} */</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El uso del almacenamiento local sigue el planteamiento de <em>sandbox</em>, con lo que queda restringido su uso al dominio activo, con lo que no podremos acceder a propiedades del almacenamiento local creadas desde un dominio distinto.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_sessionstorage">5.4.3. SessionStorage</h4>
<div class="paragraph">
<p>De manera similar a <code>localStorage</code>, podemos usar el objeto <code>sessionStorage</code> para almacenar la información con un ciclo de vida asociado a la sesión del navegador. Es decir, al cerrar el navegador, el almacenamiento se vaciará.</p>
</div>
<div class="paragraph">
<p>Un caso partícular es que se produzca un cierre inesperado por fallo del navegador. En dicho caso, los datos se restablecen como si no hubiésemos cerrado la sesión.</p>
</div>
<div class="paragraph">
<p>Ambos objetos heredan del interfaz <code>Storage</code> por lo que el código de uso es similar.</p>
</div>
</div>
<div class="sect3">
<h4 id="_indexeddb">5.4.4. IndexedDB</h4>
<div class="paragraph">
<p>Además del almacenamiento local, el navegador permite almacenar la información en una estructura más compleja similar a una BBDD.</p>
</div>
<div class="paragraph">
<p>Existen 2 posibilidades:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>WebSQL DB</strong>: <em>wrapper</em> sobre <em>SQLite</em> que permite interactuar con lo datos mediante un interfaz <em>SQL</em>, con lo que podemos ejecutar sentencias <em>select</em>, <em>insert</em>, <em>update</em> o <em>delete</em>. El problema viene de que al tratarse de un estándar, y no haber más de una implementación, la especificación se ha congelado y ha pasado a un estado de <em>deprecated</em>. En la actualidad la soportan la mayor parte de los navegadores excepto <em>Firefox</em> e <em>IE</em> (ver <a href="http://caniuse.com/#feat=sql-storage" class="bare">http://caniuse.com/#feat=sql-storage</a>).</p>
</li>
<li>
<p><strong>IndexedDB</strong>: expone un <em>API</em> como un almacén de objetos, el cual comparte muchos conceptos con una <em>BBDD SQL</em>, tales como base de datos, registro, campo o transacción. La principal diferencia es que no se interactúa mediante el lenguaje <em>SQL</em>, sino que se utilizan métodos del mismo modo que se hace mediante <em>JPA</em> o <em>Hibernate</em>. Su soporte es completo en <em>Firefox</em>, <em>Chrome</em> y <em>Opera</em>, pero parcial en el resto (<a href="http://caniuse.com/#search=IndexedDB" class="bare">http://caniuse.com/#search=IndexedDB</a>)</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Un artículo muy interesante donde comparan con código estos enfoques es <em>Client-Side Storage</em>:
<a href="http://www.html5rocks.com/en/tutorials/offline/storage/" class="bare">http://www.html5rocks.com/en/tutorials/offline/storage/</a>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_web_workers">5.5. Web Workers</h3>
<div class="paragraph">
<p>El modelo mono-hilo de <em>JavaScript</em> provoca que el desarrollador utilice las llamadas asíncronas <em>AJAX</em> y los <em>timers</em> mediante <code>setTimeout()</code> y <code>setInterval()</code> como triquiñuelas para no bloquear el hilo de ejecución, por ejemplo, mediante la manipulación del DOM, la cual es quizás la tarea más costosa que podemos realizar con <em>JavaScript</em>.</p>
</div>
<div class="paragraph">
<p><em>HTML5</em> introduce los <em>Web Workers</em> como una solución a la ejecución mono-hilo de JavaScript. De este modo, vamos a poder crear hilos de ejecución que se ejecutan en  <em>background</em> que corren al mismo tiempo (más o menos) y que pueden llegar a aprovechar las arquitecturas multi-núcleo que ofrece el hardware.</p>
</div>
<div class="paragraph">
<p>Al crear un <em>web worker</em>, éste correrá en <em>background</em> mientras que el hilo principal procesa los eventos del interfaz de usuario, incluso si el hilo del <em>worker</em> esta ocupado procesando gran cantidad de datos. Por ejemplo, un <em>worker</em> puede procesar una estructura JSON para extraer la información útil a mostrar en el  interfaz de usuario.</p>
</div>
<div class="sect3">
<h4 id="_hilo_padre">5.5.1. Hilo padre</h4>
<div class="paragraph">
<p>El código que pertenece a un <em>web worker</em> reside en un archivo <em>JavaScript</em> aparte. El hilo padre crea el nuevo <em>worker</em> indicando la URI del <em>script</em> en el constructor de <code>Worker</code>, el cual lo carga de manera asíncrona y lo ejecuta.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-c1">// archivo JS padre</span>
<span class="tok-kd">var</span> <span class="tok-nx">worker</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Worker</span><span class="tok-p">(</span><span class="tok-s2">&quot;otroFichero.js&quot;</span><span class="tok-p">);</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Creamos un <em>web worker</em> en el hijo padre que referencia al código que reside en <code>otroFichero.js</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para lanzar el <em>worker</em>, el hilo padre le envía un mensaje al hijo mediante el método <code>postMessage(<em>mensaje</em>)</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">worker</span><span class="tok-p">.</span><span class="tok-nx">postMessage</span><span class="tok-p">(</span><span class="tok-s2">&quot;contenido&quot;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La página padre puede comunicarse con los <em>workers</em> mediante el API <code>postMessage</code>, el cual también se envía para que los <em>workers</em> envíen mensajes al padre. Además de poder enviar datos de tipos primitivos (cadena, número, booleano, <code>null</code> o <code>undefined</code>), podemos enviar estructuras JSON mediante arrays y objetos. Lo que no se puede enviar son funciones ya que pueden contener referencias al DOM.</p>
</div>
<div class="paragraph">
<p>Los hilos del padre y de los <em>workers</em> tienen su propio espacio en memoria, con lo que los mensajes enviados desde y hacia se pasan por copia, no por referencia, con lo cual se realiza un proceso de serialización y deserialización de la información. Por este motivo, se desaconseja enviar grandes cantidades de información al <em>worker</em>.</p>
</div>
<div class="paragraph">
<p>Además de enviar información, el padre puede registrar un <em>callback</em> que quede a la espera de recibir un mensaje una vez que el <em>worker</em> haya finalizado su trabajo. Este permite al hilo del padre utilizar la respuesta del hijo, como por ejemplo, modificar el DOM con la información procesada por el <em>worker</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">worker</span><span class="tok-p">.</span><span class="tok-nx">onmessage</span> <span class="tok-o">=</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">evt</span><span class="tok-p">)</span> <span class="tok-p">{</span>  <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;El worker me ha contestado!&quot;</span><span class="tok-p">);</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;Y me ha enviado &quot;</span> <span class="tok-o">+</span> <span class="tok-nx">evt</span><span class="tok-p">.</span><span class="tok-nx">data</span><span class="tok-p">);</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>También podemos registrar el evento mediante <code>worker.addEventListener('message', function(evt) {</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>El objeto <code>evt</code> contiene la información de la respuesta</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El <em>callback</em> recibe como parámetro un objeto <code>evt</code>, el cual contiene las propiedades:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>target</code>: identifica al <em>worker</em> que envió el mensaje, por lo que se usa cuando tener un entorno con múltiples <em>workers</em></p>
</li>
<li>
<p><code>data</code>: contiene el mensaje enviado por el <em>worker</em> de vuelta a su padre</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>En resumen, el código del padre será:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">worker</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Worker</span><span class="tok-p">(</span><span class="tok-s2">&quot;otroFichero.js&quot;</span><span class="tok-p">);</span>

<span class="tok-nx">worker</span><span class="tok-p">.</span><span class="tok-nx">onmessage</span> <span class="tok-o">=</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">evt</span><span class="tok-p">)</span> <span class="tok-p">{</span>  <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;El worker me ha contestado!&quot;</span><span class="tok-p">);</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;Y me ha enviado &quot;</span> <span class="tok-o">+</span> <span class="tok-nx">evt</span><span class="tok-p">.</span><span class="tok-nx">data</span><span class="tok-p">);</span>
<span class="tok-p">};</span>

<span class="tok-nx">worker</span><span class="tok-p">.</span><span class="tok-nx">postMessage</span><span class="tok-p">(</span><span class="tok-s2">&quot;contenido&quot;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="__em_worker_em_hijo">5.5.2. <em>Worker</em> hijo</h4>
<div class="paragraph">
<p>El <em>worker</em> en sí se coloca en un archivo <code>.js</code> aparte, que en el ejemplo anterior hemos nombrado como <code>otroFichero.js</code>.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, en su ejemplo más sencillo si queremos que devuelva el mensaje recibido y le salude haríamos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">self</span><span class="tok-p">.</span><span class="tok-nx">addEventListener</span><span class="tok-p">(</span><span class="tok-s1">&#39;message&#39;</span><span class="tok-p">,</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">evt</span><span class="tok-p">)</span> <span class="tok-p">{</span>  <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="tok-kd">var</span> <span class="tok-nx">mensaje</span> <span class="tok-o">=</span> <span class="tok-nx">evt</span><span class="tok-p">.</span><span class="tok-nx">data</span><span class="tok-p">;</span> <i class="conum" data-value="2"></i><b>(2)</b>

  <span class="tok-nx">self</span><span class="tok-p">.</span><span class="tok-nx">postMessage</span><span class="tok-p">(</span><span class="tok-s2">&quot;Hola &quot;</span> <span class="tok-o">+</span> <span class="tok-nx">mensaje</span><span class="tok-p">);</span>  <i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>El <em>worker</em> también registra un manejador de evento para los mensajes que recibe de su padre. Este manejador también se podía haber añadido mediante la propiedad <code>onmessage</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>De manera similar al padre, extraemos la información a partir de la propiedad <code>data</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Para volver a enviar un mensaje al padre también utiliza el método <code>postMessage</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En el contexto de un <em>worker</em>, tanto <code>self</code> como <code>this</code> referencian al alcance global.</p>
</div>
</div>
<div class="sect3">
<h4 id="_finalizando_los_em_workers_em">5.5.3. Finalizando los <em>workers</em></h4>
<div class="paragraph">
<p>Los <em>workers</em> consumen muchos recursos, ya que son hilos a nivel de sistema operativo. Por lo tanto, no conviene crear un gran número de hilos y deberíamos terminar el <em>web worker</em> una vez ha finalizado su trabajo.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Aunque es común tener múltiples hilos <em>workers</em> para dividir el trabajo entre ellos, hay que ir con mucho cuidado, ya que tienen un gran coste de rendimiento al arrancar y consumen mucha memoria por cada instancia.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para que un <em>worker</em> termine por sí mismo y deseche cualquier tarea pendiente usaremos el método <code>close</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">self</span><span class="tok-p">.</span><span class="tok-nx">close</span><span class="tok-p">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>O si un padre quiere finalizar a un <em>worker</em> hijo mediante el método <code>terminate</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">worker</span><span class="tok-p">.</span><span class="tok-nx">terminate</span><span class="tok-p">();</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_seguridad_y_restricciones">5.5.4. Seguridad y restricciones</h4>
<div class="paragraph">
<p>Como los web workers trabajan de manera independiente del hilo de interfaz del navegador, dentro de un <em>worker</em> no tenemos acceso a muchos objetos JavaScript como <code>document</code>, <code>window</code> (variables globales), <code>console</code>, <code>parent</code> ni, el más importante, al DOM.
El hecho de no tener acceso al DOM y no poder modificar la página puede parecer muy restrictivo, pero es una importante decisión sobre la seguridad. ¿Qué podría pasar si múltiples hilos intentaran modificar el mismo elemento? Por ello los <em>web workers</em> funcionan en un entorno restringido y de mono-hilo.</p>
</div>
<div class="paragraph">
<p>Dicho esto, podemos usar los <em>workers</em> para procesar datos y devolver el resultado al hilo principal, el cual sí que puede modificar el DOM. Aunque tiene reducido el número de objetos que pueden usar, desde un worker si que tenemos acceso a algunas funciones como <code>setTimeout()/clearTimeout()</code>, <code>setInterval()/clearInterval()</code>, <code>navigator</code>, etc&#8230;&#8203; También podemos usar los objetos <code>XMLHttpRequest</code> y <code>localStorage</code> dentro de un <em>worker</em>, e incluso importar otros workers.</p>
</div>
<div class="paragraph">
<p>Ya hemos comentado que en su contexto, tanto <code>self</code> como <code>this</code> referencian al alcance global.</p>
</div>
<div class="paragraph">
<p>Otra restricción de los <em>web workers</em> es que siguen la política de <em>Same-Origin Policy</em>. Por ejemplo, un script hospedado en <a href="http://www.ejemplo.com" class="bare">http://www.ejemplo.com</a> no puede acceder a otro en <a href="https://www.ejemplo.com" class="bare">https://www.ejemplo.com</a>. Incluso con nombres de dominio idénticos, la política fuerza que el protocolo sea el mismo. Esto no suele ser un problema ya que suelen residir en el mismo dominio, siempre es bueno recordarlo.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Carga de archivos</div>
<div class="paragraph">
<p>Dentro de un worker podemos cargar otros archivos JavaScript mediante <code>importScripts()</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">importScripts</span><span class="tok-p">(</span><span class="tok-s2">&quot;script1.js&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;script2.js&quot;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_gestión_de_errores">5.5.5. Gestión de errores</h4>
<div class="paragraph">
<p>Al no tener acceso a la consola, el proceso de depuración y gestión de errores se complica un poco. Por suerte, las <em>Dev-Tools</em> nos permiten depurar el código del <em>worker</em> como si se tratase de cualquier otro código <em>JavaScript</em></p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/js05/webWorkerDebug.jpg" alt="Debug de un Web Worker en Chrome" width="66%">
</div>
<div class="title">Figure 6. Debug de un Web Worker</div>
</div>
<div class="paragraph">
<p>Para gestionar los errores lanzados por un <em>web workers</em>, el padre puede asignar un manejador de eventos sobre el evento <code>error</code>, el cual propaga un objeto <code>ErrorEvent</code>, el cual se desglosa en tres propiedades:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>filename</code>: nombre del <em>script</em> que provocó el error.</p>
</li>
<li>
<p><code>lineno</code>: línea del error.</p>
</li>
<li>
<p><code>message</code>: descripción del error.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Por ejemplo, en el código de padre podemos añadir el evento de la siguiente manera:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">worker</span><span class="tok-p">.</span><span class="tok-nx">addEventListener</span><span class="tok-p">(</span><span class="tok-s1">&#39;error&#39;</span><span class="tok-p">,</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">error</span><span class="tok-p">){</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;Error provocado por el worker: &#39;</span> <span class="tok-o">+</span> <span class="tok-nx">error</span><span class="tok-p">.</span><span class="tok-nx">filename</span>
    <span class="tok-o">+</span> <span class="tok-s1">&#39; en la linea: &#39;</span> <span class="tok-o">+</span> <span class="tok-nx">error</span><span class="tok-p">.</span><span class="tok-nx">lineno</span>
    <span class="tok-o">+</span> <span class="tok-s1">&#39; con el mensaje: &#39;</span> <span class="tok-o">+</span> <span class="tok-nx">error</span><span class="tok-p">.</span><span class="tok-nx">message</span><span class="tok-p">);</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_casos_de_uso">5.5.6. Casos de uso</h4>
<div class="paragraph">
<p>Ya hemos comentado que los web workers no están pensados para usarse en grandes cantidades debido a su alto coste de inicio y el gran coste de memoria por instancia.</p>
</div>
<div class="paragraph">
<p>Un caso de uso real puede ser cuando tenemos que trabajar con una librería de terceros con un API síncrona que provoca que el hilo principal tenga que esperar al resultado antes de continuar con la siguiente sentencia. En este caso, podemos delegar la tarea a un nuevo worker para beneficiarnos de la capacidad asíncrona.</p>
</div>
<div class="paragraph">
<p>También funcionan muy bien en situaciones de checkeo (<em>polling</em>) continuo a un destino en <em>background</em> y envío de mensaje al hilo principal cuando llega algún dato.</p>
</div>
<div class="paragraph">
<p>Si necesitamos procesar una gran cantidad de información devuelta por el servidor, es mejor crear varios <em>workers</em> para procesar los datos en porciones que no se solapen.</p>
</div>
<div class="paragraph">
<p>Finalmente, también se emplea para analizar fuentes de video o audio con la ayuda de múltiples web workers, cada uno trabajando en una parte predefinida del problema</p>
</div>
<div class="paragraph">
<p>Aunque se trate de una tecnología que no esta completamente implantada, en un futuro abrirá nuevas posibilidades una vez los navegadores la implementes y ofrezcan herramientas de depuración.</p>
</div>
</div>
<div class="sect3">
<h4 id="__em_shared_workers_em">5.5.7. <em>Shared workers</em></h4>
<div class="paragraph">
<p>La especificación de HTML5 define dos tipos de <em>workers</em>, los dedicados y los compartidos (<em>shared</em>). Los dedicados son los que hemos estudiado, ya que existe una relación directa entre el creador del worker y el propio <em>worker</em> mediante una relación 1:1.</p>
</div>
<div class="paragraph">
<p>En cambio, un <em>shared worker</em> puede compartirse entre todas las páginas de un mismo origen, por ejemplo, todas las páginas o <em>scripts</em> de un mismo dominio pueden comunicarse con un único <em>shared worker</em>.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Hay que tener en cuenta que a día de hoy ni <em>Internet Explorer</em> ni <em>Safari</em> los soportan, estando disponibles únicamente en <em>Firefox</em>, <em>Chrome</em> y <em>Opera</em> (<a href="http://caniuse.com/#feat=sharedworkers" class="bare">http://caniuse.com/#feat=sharedworkers</a>).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La principal diferencia en el modo de usar los <em>workers</em> compartidos es que se asocian a un puerto mediante la propiedad <code>port</code>, para mantener el contacto con el <em>script</em> padre que accede a ellos.</p>
</div>
<div class="paragraph">
<p>Para crear un <em>worker</em> compartido le pasaremos la URL del script o el nombre del <em>worker</em> al constructor de <code>SharedWorker</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">sharedWorker</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">SharedWorker</span><span class="tok-p">(</span><span class="tok-s1">&#39;otroScript.js&#39;</span><span class="tok-p">);</span>
<span class="tok-nx">sharedWorker</span><span class="tok-p">.</span><span class="tok-nx">port</span><span class="tok-p">.</span><span class="tok-nx">onmessage</span> <span class="tok-o">=</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">evt</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-c1">// recibimos los datos del hijo compartido</span>
<span class="tok-p">}</span>

<span class="tok-nx">sharedWorker</span><span class="tok-p">.</span><span class="tok-nx">port</span><span class="tok-p">.</span><span class="tok-nx">start</span><span class="tok-p">();</span>  <i class="conum" data-value="1"></i><b>(1)</b>

<span class="tok-nx">sharedWorker</span><span class="tok-p">.</span><span class="tok-nx">port</span><span class="tok-p">.</span><span class="tok-nx">postMessage</span><span class="tok-p">(</span><span class="tok-s1">&#39;datos que queremos enviar&#39;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Antes de poder enviar mensajes, necesitamos arrancar el puerto mediante el método <code>start()</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>De manera similar, un <em>worker</em> puede escuchar el evento <code>connect</code>, el cual se lanza cuando un nuevo cliente intenta conectarse al <em>worker</em>. Una vez conectado, sobre el puerto activo, añadiremos un manejador sobre el evento <code>message</code>, dentro del cual normalmente contestaremos al hilo padre:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">self</span><span class="tok-p">.</span><span class="tok-nx">onconnect</span> <span class="tok-o">=</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">evento</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-kd">var</span> <span class="tok-nx">clientePuerto</span> <span class="tok-o">=</span> <span class="tok-nx">event</span><span class="tok-p">.</span><span class="tok-nx">source</span><span class="tok-p">;</span>  <i class="conum" data-value="1"></i><b>(1)</b>

  <span class="tok-nx">clientePuerto</span><span class="tok-p">.</span><span class="tok-nx">onmessage</span> <span class="tok-o">=</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">evento</span><span class="tok-p">)</span> <span class="tok-p">{</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-kd">var</span> <span class="tok-nx">datos</span> <span class="tok-o">=</span> <span class="tok-nx">evento</span><span class="tok-p">.</span><span class="tok-nx">data</span><span class="tok-p">;</span>  <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-c1">// ... procesamos los datos</span>
    <span class="tok-nx">clientePuerto</span><span class="tok-p">.</span><span class="tok-nx">postMessage</span><span class="tok-p">(</span><span class="tok-s1">&#39;datos de respuesta&#39;</span><span class="tok-p">);</span> <i class="conum" data-value="4"></i><b>(4)</b>
  <span class="tok-p">}</span>

  <span class="tok-nx">clientePuerto</span><span class="tok-p">.</span><span class="tok-nx">start</span><span class="tok-p">();</span>  <i class="conum" data-value="5"></i><b>(5)</b>
<span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>evento.source</code> contiene la referencia al puerto del cliente</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>escucha cualquier mensaje enviado por este cliente</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>evento.data</code> contiene el mensaje enviado por el cliente</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>tras procesar los datos, se envía la respuesta al padre</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>tras asignar el manejador, le indicamos al puerto que ya estamos listos para escuchar y enviar mensajes mediante el método <code>start()</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Un caso de uso de los <em>shared workers</em> es que, debido a su naturaleza compartida, permite mantener el mismo estado en diferentes pestañas de la misma aplicación, ya que las páginas utilizan el mismo <em>script</em> de <em>worker</em> compartido para mantener e informar del estado.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_websockets">5.6. WebSockets</h3>
<div class="paragraph">
<p>Una de las características más novedosas de HTML5 son los <em>WebSockets</em>, los cuales permiten comunicar un cliente con el servidor sin necesidad de peticiones AJAX.</p>
</div>
<div class="paragraph">
<p>Así pues, son una técnica de comunicación bidireccional sobre un socket TCP, un tipo de tecnología PUSH.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
En el módulo de Componentes Web ya estudiamos como trabajar con WebSockets, pero desde el punto de vista del servidor mediante Servlets. Ahora vamos a centrarnos en el lado del cliente.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para utilizar <em>WebSockets</em> necesitamos crear un objeto <code>WebSocket</code>, el cual automáticamente abrirá un conexión temporal al servidor.</p>
</div>
<div class="paragraph">
<p>Su constructor recibe un parámetro con la URL que vamos a conectar y otro opcional con información sobre los protocolos a emplear:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">ejemploWS</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">WebSocket</span><span class="tok-p">(</span><span class="tok-s2">&quot;ws://www.ejemplo.com/servidorSockets&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;json&quot;</span><span class="tok-p">);</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>los esquemas URL <code>ws</code> y <code>wss</code> referencias a conexiones con websockets y websockets seguros, respectivamente</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
No podemos usar <em>WebSockets</em> entre contextos seguros y no seguros, ya que se mantiene <em>Same-Origin Policy</em>, con lo que no podemos abrir una conexión no segura desde una página cargada mediante HTTPS o viceversa.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Una vez creada la conexión, podemos consultar el estado de la misma mediante la propiedad <code>status</code>, cuyos valores pueden ser:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>0</code>: conectando</p>
</li>
<li>
<p><code>1</code>: abierto</p>
</li>
<li>
<p><code>2</code>: cerrado</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Una vez conectados, ya podemos enviar datos al servidor mediante el método <code>send()</code> cada vez que queramos enviar un mensaje:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">ejemploWS</span><span class="tok-p">.</span><span class="tok-nx">send</span><span class="tok-p">(</span><span class="tok-s2">&quot;Texto para el servidor&quot;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Los datos que podemos enviar son del tipo <code>String</code> (en UTF8), <code>Blob</code> o <code>ArrayBuffer</code></p>
</div>
<div class="paragraph">
<p>Cuando hayamos finalizado la conexión <em>WebSocket</em>, llamaremos al método <code>close()</code> del objeto <code>WebSocket</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">ejemploWS</span><span class="tok-p">.</span><span class="tok-nx">close</span><span class="tok-p">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Antes de cerrar la conexión puede ser necesario comprobar el valor del atributo <code>bufferedAmount</code> para verificar que se ha transmitido toda la información.</p>
</div>
<div class="sect3">
<h4 id="_eventos_2">5.6.1. Eventos</h4>
<div class="paragraph">
<p>Al tratarse de una conexión asíncrona, no hay garantía de poder llamar al método <code>send()</code> inmediatamente después de haber creado el objeto <code>WebSocket</code>.</p>
</div>
<div class="paragraph">
<p>Por ello, todos los mecanismos de comunicación y gestión de la conexión se realizan mediante eventos.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/js05/webSocketEvents.jpg" alt="Eventos con WebSocket" width="50%">
</div>
<div class="title">Figure 7. Eventos con WebSocket</div>
</div>
<div class="paragraph">
<p>Para enviar información, previamente hemos de asegurarnos que la conexión se ha abierto exitosamente mediante el evento <code>onopen</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">ejemploWS</span><span class="tok-p">.</span><span class="tok-nx">onopen</span> <span class="tok-o">=</span> <span class="tok-kd">function</span> <span class="tok-p">(</span><span class="tok-nx">evt</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nx">ejemploWS</span><span class="tok-p">.</span><span class="tok-nx">send</span><span class="tok-p">(</span><span class="tok-s2">&quot;Texto para el servidor&quot;</span><span class="tok-p">);</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para tratar la respuesta del servidor hay que utilizar el evento <code>onmessage</code> el cual saltará al recibir un mensaje:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">ejemploWS</span><span class="tok-p">.</span><span class="tok-nx">onmessage</span> <span class="tok-o">=</span> <span class="tok-kd">function</span> <span class="tok-p">(</span><span class="tok-nx">evt</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">evt</span><span class="tok-p">.</span><span class="tok-nx">data</span><span class="tok-p">);</span>  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Para extraer la información del mensaje, hay que acceder a la propiedad <code>data</code> del objeto recibido.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finalmente, para comprobar si ha sucedido algún error, le asignaremos un manejador al evento <code>onerror</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">ejemploWS</span><span class="tok-p">.</span><span class="tok-nx">onerror</span> <span class="tok-o">=</span> <span class="tok-kd">function</span> <span class="tok-p">(</span><span class="tok-nx">evt</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;Error:&quot;</span> <span class="tok-o">+</span> <span class="tok-nx">evt</span><span class="tok-p">);</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Los casos de uso principales de los <em>WebSockets</em> se centran en:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Actualización en tiempo real en las aplicaciones de redes sociales</p>
</li>
<li>
<p>Juegos multi-jugador mediante <em>HTML5</em></p>
</li>
<li>
<p>Aplicaciones de chat online</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_ejemplo_chat">5.6.2. Ejemplo chat</h4>
<div class="paragraph">
<p>Si ahora revisamos el código de la sala de chat que vimos en el módulo de Componentes Web, podemos comprobar como se creaba la conexión y la manera en que gestionábamos los eventos de los mensajes recibidos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">websocket</span><span class="tok-p">;</span>

<span class="tok-kd">function</span> <span class="tok-nx">connect</span><span class="tok-p">(</span><span class="tok-nx">nick</span><span class="tok-p">,</span> <span class="tok-nx">sala</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">sala</span> <span class="tok-o">==</span> <span class="tok-kc">undefined</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nx">websocket</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">WebSocket</span><span class="tok-p">(</span><span class="tok-s2">&quot;ws://localhost:8080/cweb-chat/ChatWS&quot;</span><span class="tok-p">);</span>
  <span class="tok-p">}</span> <span class="tok-k">else</span> <span class="tok-p">{</span>
    <span class="tok-nx">websocket</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">WebSocket</span><span class="tok-p">(</span><span class="tok-s2">&quot;ws://localhost:8080/cweb-chat/ChatWS/&quot;</span> <span class="tok-o">+</span> <span class="tok-nx">sala</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;?nick=&quot;</span> <span class="tok-o">+</span> <span class="tok-nx">nick</span><span class="tok-p">);</span>
  <span class="tok-p">}</span>

  <span class="tok-nx">websocket</span><span class="tok-p">.</span><span class="tok-nx">onmessage</span> <span class="tok-o">=</span> <span class="tok-nx">onMessage</span><span class="tok-p">;</span>  <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="tok-nx">websocket</span><span class="tok-p">.</span><span class="tok-nx">onopen</span> <span class="tok-o">=</span> <span class="tok-nx">onOpen</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-kd">function</span> <span class="tok-nx">onOpen</span><span class="tok-p">(</span><span class="tok-nx">event</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s2">&quot;chat&quot;</span><span class="tok-p">).</span><span class="tok-nx">style</span><span class="tok-p">.</span><span class="tok-nx">display</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;block&#39;</span><span class="tok-p">;</span>
  <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s2">&quot;login&quot;</span><span class="tok-p">).</span><span class="tok-nx">style</span><span class="tok-p">.</span><span class="tok-nx">display</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;none&#39;</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-kd">function</span> <span class="tok-nx">onMessage</span><span class="tok-p">(</span><span class="tok-nx">event</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nx">items</span> <span class="tok-o">=</span> <span class="tok-nx">event</span><span class="tok-p">.</span><span class="tok-nx">data</span><span class="tok-p">.</span><span class="tok-nx">split</span><span class="tok-p">(</span><span class="tok-s2">&quot;;&quot;</span><span class="tok-p">);</span>  <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s2">&quot;mensajes&quot;</span><span class="tok-p">).</span><span class="tok-nx">innerHTML</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;&lt;p&gt;&lt;strong&gt;&amp;lt;&quot;</span> <span class="tok-o">+</span> <span class="tok-nx">items</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;&amp;gt;&lt;/strong&gt; &quot;</span> <span class="tok-o">+</span> <span class="tok-nx">items</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;&lt;/p&gt;&quot;</span> <span class="tok-o">+</span> <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s2">&quot;mensajes&quot;</span><span class="tok-p">).</span><span class="tok-nx">innerHTML</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-kd">function</span> <span class="tok-nx">send</span><span class="tok-p">(</span><span class="tok-nx">texto</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nx">websocket</span><span class="tok-p">.</span><span class="tok-nx">send</span><span class="tok-p">(</span><span class="tok-nx">texto</span><span class="tok-p">);</span>
<span class="tok-p">}</span>

<span class="tok-c1">// Eliminar esta linea para implementar nick y sala</span>
<span class="tok-nb">window</span><span class="tok-p">.</span><span class="tok-nx">addEventListener</span><span class="tok-p">(</span><span class="tok-s2">&quot;load&quot;</span><span class="tok-p">,</span> <span class="tok-nx">connect</span><span class="tok-p">,</span> <span class="tok-kc">false</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Asociamos las funciones a los eventos de mensaje y apertura de la conexión</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Al recibir un mensaje, separa los datos por el carácter <code>;</code></td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_rendimiento">5.7. Rendimiento</h3>
<div class="paragraph">
<p>Un elemento a tener en cuenta desde el mismo momento que empezar a codificar es el rendimiento.</p>
</div>
<div class="sect3">
<h4 id="_identificar_los_problemas">5.7.1. Identificar los problemas</h4>
<div class="paragraph">
<p>Antes de optimizar cualquier código, debemos averiguar que parte es la que provoca los cuellos de botella o que funcionan lentamente.</p>
</div>
<div class="paragraph">
<p>Para ello, podemos hacer uso de:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Herramientas de <strong>Profiling</strong>: Las <em>Dev-Tools</em> incluyen este tipo de herramientas, las cuales podemos usar desde:</p>
<div class="ulist">
<ul>
<li>
<p>el botón/pestaña de <em>Profile</em></p>
</li>
<li>
<p>la consola, mediante las funciones <code>profile()</code> y <code>profileEnd()</code></p>
</li>
<li>
<p>el código de aplicación, mediante <code>console.profile()</code> y <code>console.profileEnd()</code></p>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Más información sobre el <em>profiler CPU</em> en <a href="https://developer.chrome.com/devtools/docs/cpu-profiling" class="bare">https://developer.chrome.com/devtools/docs/cpu-profiling</a> o sobre el <em>profiler</em> de pila en <a href="https://developer.chrome.com/devtools/docs/heap-profiling" class="bare">https://developer.chrome.com/devtools/docs/heap-profiling</a>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Timers</strong> manuales: en el código de aplicación, mediante <code>console.time()</code> y <code>console.timeEnd()</code></p>
</li>
<li>
<p>Herramientas de <strong>Análisis de peticiones</strong>, por ejemplo, mediante las <em>DevTools</em> y la pestaña <em>Network</em>, donde podemos visualizar todos los recursos (<code>.html</code>, <code>.js</code>, <code>.css</code>, imágenes, etc..) que utiliza nuestra página, con su tipo y tamaño, los detalles de las respuestas del servidor, o un <em>timeline</em> con las peticiones de red.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Para ello, primero hemos de abrir la pestaña <em>Network</em> de las <em>Dev-Tools</em> y posteriormente acceder al recurso que queremos analizar. Por ejemplo, si accedemos a la web del experto <a href="../../../../index.html" class="bare">http://expertojava.ua.es/</a> obtendremos el siguiente análisis:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/js05/devToolsNetwork.jpg" alt="Análisis de Peticiones con DevTools" width="100%">
</div>
<div class="title">Figure 8. Análisis de Peticiones con DevTools</div>
</div>
<div class="paragraph">
<p>Del gráfico podemos deducir que pese a que los recursos que más ocupan son las librerías y hojas de estilo de <em>Bootstrap</em> y <em>jQuery</em> las cuales se cachean en posteriores visitas. Si volvemos a cargar la página tendremos que el tiempo de carga de las librerías es 0 y se obtienen desde la caché del navegador:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/js05/devToolsNetworkCache.jpg" alt="Análisis de Peticiones con DevTools con recursos cacheados" width="100%">
</div>
<div class="title">Figure 9. Análisis de Peticiones con DevTools con recursos cacheados</div>
</div>
<div class="paragraph">
<p>Podemos observar como el recurso <code>publico</code> de tipo <code>html</code> tiene un código de estado 304, lo que indica que este recurso ya se ha descargado previamente y que no ha sido modificado desde entonces, y por ello se han descargado 123 B en vez de 3,9 KB, es decir, la cabecera HTTP del recurso.</p>
</div>
<div class="paragraph">
<p>Si comprobamos la barra de estado inferior podemos ver como hemos pasado de 227KB a 123B de información transferida, y de 381ms a 246ms. Además, el tiempo necesario para la carga de la página y del DOM también se ha reducido.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Si queremos que el navegador realice una carga completa de la página ignorando los recursos cacheado, podemos usar <em>CTRL</em> + <em>F5</em> o <em>SHIFT</em> + botón de actualizar.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Más información sobre el análisis de la red en <a href="https://developer.chrome.com/devtools/docs/network" class="bare">https://developer.chrome.com/devtools/docs/network</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_reglas">5.7.2. Reglas</h4>
<div class="paragraph">
<p>Una serie de reglas a tomar dentro de JavaScript son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Minificar</strong> el código (eliminado espacios y comentarios) para reducir el tamaño de los archivos, mediante herramientas como:</p>
<div class="ulist">
<ul>
<li>
<p><em>Google Closure Compiler</em> (<a href="https://developers.google.com/closure/compiler/" class="bare">https://developers.google.com/closure/compiler/</a>)</p>
</li>
<li>
<p><em>YUI Compressor</em> (<a href="http://yui.github.io/yuicompressor/" class="bare">http://yui.github.io/yuicompressor/</a>)</p>
</li>
<li>
<p><em>UglifyJS2</em> (<a href="https://github.com/mishoo/UglifyJS2" class="bare">https://github.com/mishoo/UglifyJS2</a>)
Relacionado con la minificación está la <strong>ofuscación</strong>, la cual además de eliminar contenido innecesario, renombra las variables y funciones, lo que a su vez también reduce todavía más el tamaño del código. Aunque es conveniente tener en cuenta que minificar es menos arriesgado.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Reducir el número de archivos <em>JavaScript</em></strong> que contiene nuestra página, ya que el navegador tiene un número determinado de peticiones simultaneas que puede realizar. Para ello, podemos combinar nuestras librerías en una sola, por ejemplo, mediante <em>Google Closure Compiler</em> en <a href="http://closure-compiler.appspot.com/home" class="bare">http://closure-compiler.appspot.com/home</a>. Se recomienda tres tipos de enlace a las librerías JavaScript:</p>
<div class="ulist">
<ul>
<li>
<p>mediante CDN a las librerías famosas (<em>jQuery</em>, <em>Bootstrap</em>, ..)</p>
</li>
<li>
<p>dejar a solas la librería de nuestra aplicación, ya que si la modificamos cada semana no tenemos que estar combinándola con las librerías de terceros</p>
</li>
<li>
<p>combinar el resto de librerías de terceros.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Comprobar la <strong>calidad del código</strong> mediante herramientas de validación como:</p>
<div class="ulist">
<ul>
<li>
<p>JSLint (<a href="http://jslint.com" class="bare">http://jslint.com</a>)</p>
</li>
<li>
<p>JSHint (<a href="http://jshint.com" class="bare">http://jshint.com</a>)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Colocar los enlaces a las hojas de estilo antes de los archivos <em>JavaScript</em>, para que la página se renderice antes.</p>
</li>
<li>
<p>Colocar los enlaces a código <em>JavaScript</em> al final de la página, para que primero se cargue todo el contenido <em>DOM</em>, o realizar la carga de la librería <em>JavaScript</em> de manera asíncrona incluyendo el atributo <code><strong>async</strong></code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;script </span><span class="tok-na">src=</span><span class="tok-s">&quot;miLibreriaJS.js&quot;</span> <span class="tok-na">async</span><span class="tok-nt">&gt;&lt;/script&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Utilizar funciones con nombre en vez de anónimas, para que aparezcan en el <em>Profiler</em></p>
</li>
<li>
<p>Aislar las llamadas <em>AJAX</em> y <em>HTTP</em> para centrarse en el código <em>JavaScript</em>. Para ello, es conveniente crear objetos <em>mock</em> que eviten el tráfico de red.</p>
</li>
<li>
<p>Dominar la herramienta <em>Profiler</em> que usemos en nuestro entorno de trabajo.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>También podemos instalar el plugin de <em>Google Chrome</em> denominado <strong>PageSpeed</strong> o acceder la web del proyecto (<a href="https://developers.google.com/speed/pagespeed/" class="bare">https://developers.google.com/speed/pagespeed/</a>) donde podemos indicarle qué página queremos analizar. Por ejemplo, si probamos con <a href="../../../../index.html" class="bare">http://expertojava.ua.es</a> tendremos el siguiente resultado:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/js05/pageSpeed.jpg" alt="Análisis de Rendimiento con PageSpeed" width="66%">
</div>
<div class="title">Figure 10. Análisis de Rendimiento con PageSpeed</div>
</div>
<div class="paragraph">
<p>Además de <em>Google</em>, el equipo de <em>Yahoo</em> tiene un artículo imprescindible donde explica el conjunto de reglas (<a href="https://developer.yahoo.com/performance/rules.html" class="bare">https://developer.yahoo.com/performance/rules.html</a>) que siguen ellos para evaluar el rendimiento de una aplicación web y el plugin <strong>YSlow</strong> (<a href="http://yslow.org/" class="bare">http://yslow.org/</a>) para cualquier navegador que evalúa estas reglas.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios">5.8. Ejercicios</h3>
<div class="sect3">
<h4 id="__0_6_ptos_ejercicio_51_em_star_wars_em">5.8.1. (0.6 ptos) Ejercicio 51. <em>Star Wars</em></h4>
<div class="paragraph">
<p>Vamos a crear una aplicación que muestre información sobre <em>Star Wars</em>. Para ello, vamos a utilizar el API REST que ofrece <em>'The Star Wars API'</em> en <a href="http://swapi.co" class="bare">http://swapi.co</a>, la cual permite su acceso mediante CORS (sin necesidad de usar JSONP).</p>
</div>
<div class="paragraph">
<p>Para ello, al cargar la página, vamos a mostrar un listado con las películas de <em>Star Wars</em>.</p>
</div>
<div class="paragraph">
<p>Al pulsar sobre el título de una película, se mostrará la sinopsis de la misma y un listado con un máximo de 10 personajes que aparecen en la misma.</p>
</div>
<div class="paragraph">
<p>Para ello, nos basaremos en la siguiente página:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-cp">&lt;!DOCTYPE html&gt;</span>
<span class="tok-nt">&lt;html&gt;</span>
<span class="tok-nt">&lt;head&gt;</span>
<span class="tok-nt">&lt;title&gt;</span>Ejercicio 51<span class="tok-nt">&lt;/title&gt;</span>
<span class="tok-nt">&lt;meta</span> <span class="tok-na">charset=</span><span class="tok-s">&quot;utf-8&quot;</span> <span class="tok-nt">/&gt;</span>
<span class="tok-nt">&lt;/head&gt;</span>
<span class="tok-nt">&lt;body&gt;</span>
  <span class="tok-nt">&lt;h1&gt;</span>Star War API<span class="tok-nt">&lt;/h1&gt;</span>
  <span class="tok-nt">&lt;h2&gt;</span>Películas - <span class="tok-nt">&lt;span</span> <span class="tok-na">id=</span><span class="tok-s">&quot;total&quot;</span><span class="tok-nt">&gt;&lt;/span&gt;&lt;/h2&gt;</span>
  <span class="tok-nt">&lt;ul</span> <span class="tok-na">id=</span><span class="tok-s">&quot;peliculas&quot;</span><span class="tok-nt">&gt;&lt;/ul&gt;</span>

  <span class="tok-nt">&lt;h2&gt;</span>Sinopsis<span class="tok-nt">&lt;/h2&gt;</span>
  <span class="tok-nt">&lt;div</span> <span class="tok-na">id=</span><span class="tok-s">&quot;sinopsis&quot;</span><span class="tok-nt">&gt;&lt;/div&gt;</span>

  <span class="tok-nt">&lt;h2&gt;</span>Personajes<span class="tok-nt">&lt;/h2&gt;</span>
  <span class="tok-nt">&lt;ul</span> <span class="tok-na">id=</span><span class="tok-s">&quot;personajes&quot;</span><span class="tok-nt">&gt;&lt;/ul&gt;</span>
  <span class="tok-nt">&lt;script </span><span class="tok-na">src=</span><span class="tok-s">&quot;ej51.js&quot;</span><span class="tok-nt">&gt;&lt;/script&gt;</span>
<span class="tok-nt">&lt;/body&gt;</span>
<span class="tok-nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y haciendo uso de <em>AJAX</em> y <em>JSON</em>, obtendremos un resultado similar al siguiente:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/js05/ej51.jpg" alt="Resultado de SWAPI" width="66%">
</div>
<div class="title">Figure 11. Resultado de SWAPI</div>
</div>
<div class="paragraph">
<p>Todo el código <em>JavaScript</em> se almacenará en una archivo denominado <code>ej51.js</code>:</p>
</div>
</div>
<div class="sect3">
<h4 id="__0_5_ptos_ejercicio_52_em_almacén_em">5.8.2. (0.5 ptos) Ejercicio 52. <em>Almacén</em></h4>
<div class="paragraph">
<p>Supongamos que tenemos un formulario de registro acceso a una aplicación con el usuario:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-cp">&lt;!DOCTYPE html&gt;</span>
<span class="tok-nt">&lt;html&gt;</span>
<span class="tok-nt">&lt;head&gt;</span>
  <span class="tok-nt">&lt;title&gt;</span>Ejercicio 52<span class="tok-nt">&lt;/title&gt;</span>
  <span class="tok-nt">&lt;meta</span> <span class="tok-na">charset=</span><span class="tok-s">&quot;utf-8&quot;</span> <span class="tok-nt">/&gt;</span>
<span class="tok-nt">&lt;/head&gt;</span>
<span class="tok-nt">&lt;body&gt;</span>
  <span class="tok-nt">&lt;form</span> <span class="tok-na">id=</span><span class="tok-s">&quot;miForm&quot;</span><span class="tok-nt">&gt;</span>
    Usuario: <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;usuario&quot;</span> <span class="tok-na">id=</span><span class="tok-s">&quot;inputUsuario&quot;</span> <span class="tok-nt">/&gt;&lt;br/&gt;</span>
    <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;submit&quot;</span> <span class="tok-na">id=</span><span class="tok-s">&quot;btnSubmit&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;Enviar&quot;</span> <span class="tok-nt">/&gt;</span>
  <span class="tok-nt">&lt;/form&gt;</span>
  Visitas usuario: <span class="tok-nt">&lt;span</span> <span class="tok-na">id=</span><span class="tok-s">&quot;visitas&quot;</span><span class="tok-nt">&gt;&lt;/span&gt;</span> <span class="tok-nt">&lt;br</span> <span class="tok-nt">/&gt;</span>
  Total visitas: <span class="tok-nt">&lt;span</span> <span class="tok-na">id=</span><span class="tok-s">&quot;total&quot;</span><span class="tok-nt">&gt;&lt;/span&gt;</span>
  <span class="tok-nt">&lt;script </span><span class="tok-na">src=</span><span class="tok-s">&quot;ej52.js&quot;</span><span class="tok-nt">&gt;&lt;/script&gt;</span>
<span class="tok-nt">&lt;/body&gt;</span>
<span class="tok-nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Tras introducir los datos del usuario, las capas de <code>visitas</code> y <code>total</code> se actualizarán automáticamente con el número de visitas del usuario y con el total de visitas realizadas desde el navegador, independientemente del usuario rellenado.</p>
</div>
<div class="paragraph">
<p>Para ello, guardar en el almacén local:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>una entrada con el total de visitas</p>
</li>
<li>
<p>una entrada por cada usuario para contar el número de visitas</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Todo el código <em>JavaScript</em> se almacenará en una archivo denominado <code>ej52.js</code>:</p>
</div>
</div>
<div class="sect3">
<h4 id="__0_5_ptos_ejercicio_53_em_web_workers_em">5.8.3. (0.5 ptos) Ejercicio 53. <em>Web Workers</em></h4>
<div class="paragraph">
<p>A partir del API de <em>Star Wars</em>, vamos a crear una aplicación que nos indique cuantos elementos contiene cada una de las categorías.</p>
</div>
<div class="paragraph">
<p>Para ello, mediante <a href="http://swapi.co/api/" class="bare">http://swapi.co/api/</a> obtendremos un objeto JSON con las propiedades y las URLs de los recursos disponibles.</p>
</div>
<div class="paragraph">
<p>Para cada uno de estos recursos, hemos de crear un Web Worker que realice la petición AJAX y obtenga el número de elementos que contiene, es decir, cada uno de los hijos realizará una petición REST a una categoría. Una vez obtenido el resultado, devolverá el número de elementos de dicha categoría al padre.</p>
</div>
<div class="paragraph">
<p>La plantilla HTML será similar a la siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-cp">&lt;!DOCTYPE html&gt;</span>
<span class="tok-nt">&lt;html&gt;</span>
<span class="tok-nt">&lt;head</span> <span class="tok-na">lang=</span><span class="tok-s">&quot;es&quot;</span><span class="tok-nt">&gt;</span>
<span class="tok-nt">&lt;meta</span> <span class="tok-na">charset=</span><span class="tok-s">&quot;UTF-8&quot;</span><span class="tok-nt">&gt;</span>
<span class="tok-nt">&lt;title&gt;</span>Ejercicio 53<span class="tok-nt">&lt;/title&gt;</span>
<span class="tok-nt">&lt;/head&gt;</span>
<span class="tok-nt">&lt;body&gt;</span>
<span class="tok-nt">&lt;h1&gt;</span>Star War API - Workers<span class="tok-nt">&lt;/h1&gt;</span>
<span class="tok-nt">&lt;h2&gt;</span>Elementos - <span class="tok-nt">&lt;span</span> <span class="tok-na">id=</span><span class="tok-s">&quot;total&quot;</span><span class="tok-nt">&gt;&lt;/span&gt;&lt;/h2&gt;</span>
<span class="tok-nt">&lt;ul</span> <span class="tok-na">id=</span><span class="tok-s">&quot;elementos&quot;</span><span class="tok-nt">&gt;&lt;/ul&gt;</span>

<span class="tok-nt">&lt;script </span><span class="tok-na">src=</span><span class="tok-s">&quot;ej53.js&quot;</span><span class="tok-nt">&gt;&lt;/script&gt;</span>
<span class="tok-nt">&lt;/body&gt;</span>
<span class="tok-nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y el resultado a la siguiente imagen:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/js05/ej53.jpg" alt="Resultado de SWAPI Workers" width="33%">
</div>
<div class="title">Figure 12. Resultado de SWAPI Workers</div>
</div>
<div class="paragraph">
<p>Todo el código <em>JavaScript</em> se almacenará en:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>un archivo denominado <code>ej53.js</code>, con el código necesario para obtener las categorías y sus urls, y la creación y comunicación con el <em>web worker</em>.</p>
</li>
<li>
<p>un archivo denominado <code>ej53worker.js</code>, con el código necesario para obtener la cantidad de elementos de una determinada categoría/url.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.1<br>
Last updated 2016-02-23 21:54:11 CET
</div>
</div>
</body>
</html>