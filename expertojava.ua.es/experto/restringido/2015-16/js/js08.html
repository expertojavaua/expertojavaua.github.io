<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.2">
<meta name="author" content="Aitor Medrano">
<title>JavaScript</title>
<style>/*! normalize.css v2.1.2 | MIT License | git.io/normalize */
/* ========================================================================== HTML5 display definitions ========================================================================== */
/** Correct `block` display not defined in IE 8/9. */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }

/** Correct `inline-block` display not defined in IE 8/9. */
audio, canvas, video { display: inline-block; }

/** Prevent modern browsers from displaying `audio` without controls. Remove excess height in iOS 5 devices. */
audio:not([controls]) { display: none; height: 0; }

/** Address `[hidden]` styling not present in IE 8/9. Hide the `template` element in IE, Safari, and Firefox < 22. */
[hidden], template { display: none; }

script { display: none !important; }

/* ========================================================================== Base ========================================================================== */
/** 1. Set default font family to sans-serif. 2. Prevent iOS text size adjust after orientation change, without disabling user zoom. */
html { font-family: sans-serif; /* 1 */ -ms-text-size-adjust: 100%; /* 2 */ -webkit-text-size-adjust: 100%; /* 2 */ }

/** Remove default margin. */
body { margin: 0; }

/* ========================================================================== Links ========================================================================== */
/** Remove the gray background color from active links in IE 10. */
a { background: transparent; }

/** Address `outline` inconsistency between Chrome and other browsers. */
a:focus { outline: thin dotted; }

/** Improve readability when focused and also mouse hovered in all browsers. */
a:active, a:hover { outline: 0; }

/* ========================================================================== Typography ========================================================================== */
/** Address variable `h1` font-size and margin within `section` and `article` contexts in Firefox 4+, Safari 5, and Chrome. */
h1 { font-size: 2em; margin: 0.67em 0; }

/** Address styling not present in IE 8/9, Safari 5, and Chrome. */
abbr[title] { border-bottom: 1px dotted; }

/** Address style set to `bolder` in Firefox 4+, Safari 5, and Chrome. */
b, strong { font-weight: bold; }

/** Address styling not present in Safari 5 and Chrome. */
dfn { font-style: italic; }

/** Address differences between Firefox and other browsers. */
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }

/** Address styling not present in IE 8/9. */
mark { background: #ff0; color: #000; }

/** Correct font family set oddly in Safari 5 and Chrome. */
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }

/** Improve readability of pre-formatted text in all browsers. */
pre { white-space: pre-wrap; }

/** Set consistent quote types. */
q { quotes: "\201C" "\201D" "\2018" "\2019"; }

/** Address inconsistent and variable font size in all browsers. */
small { font-size: 80%; }

/** Prevent `sub` and `sup` affecting `line-height` in all browsers. */
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }

sup { top: -0.5em; }

sub { bottom: -0.25em; }

/* ========================================================================== Embedded content ========================================================================== */
/** Remove border when inside `a` element in IE 8/9. */
img { border: 0; }

/** Correct overflow displayed oddly in IE 9. */
svg:not(:root) { overflow: hidden; }

/* ========================================================================== Figures ========================================================================== */
/** Address margin not present in IE 8/9 and Safari 5. */
figure { margin: 0; }

/* ========================================================================== Forms ========================================================================== */
/** Define consistent border, margin, and padding. */
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }

/** 1. Correct `color` not being inherited in IE 8/9. 2. Remove padding so people aren't caught out if they zero out fieldsets. */
legend { border: 0; /* 1 */ padding: 0; /* 2 */ }

/** 1. Correct font family not being inherited in all browsers. 2. Correct font size not being inherited in all browsers. 3. Address margins set differently in Firefox 4+, Safari 5, and Chrome. */
button, input, select, textarea { font-family: inherit; /* 1 */ font-size: 100%; /* 2 */ margin: 0; /* 3 */ }

/** Address Firefox 4+ setting `line-height` on `input` using `!important` in the UA stylesheet. */
button, input { line-height: normal; }

/** Address inconsistent `text-transform` inheritance for `button` and `select`. All other form control elements do not inherit `text-transform` values. Correct `button` style inheritance in Chrome, Safari 5+, and IE 8+. Correct `select` style inheritance in Firefox 4+ and Opera. */
button, select { text-transform: none; }

/** 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio` and `video` controls. 2. Correct inability to style clickable `input` types in iOS. 3. Improve usability and consistency of cursor style between image-type `input` and others. */
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; /* 2 */ cursor: pointer; /* 3 */ }

/** Re-set default cursor for disabled elements. */
button[disabled], html input[disabled] { cursor: default; }

/** 1. Address box sizing set to `content-box` in IE 8/9. 2. Remove excess padding in IE 8/9. */
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; /* 1 */ padding: 0; /* 2 */ }

/** 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome. 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome (include `-moz` to future-proof). */
input[type="search"] { -webkit-appearance: textfield; /* 1 */ -moz-box-sizing: content-box; -webkit-box-sizing: content-box; /* 2 */ box-sizing: content-box; }

/** Remove inner padding and search cancel button in Safari 5 and Chrome on OS X. */
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }

/** Remove inner padding and border in Firefox 4+. */
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }

/** 1. Remove default vertical scrollbar in IE 8/9. 2. Improve readability and alignment in all browsers. */
textarea { overflow: auto; /* 1 */ vertical-align: top; /* 2 */ }

/* ========================================================================== Tables ========================================================================== */
/** Remove most spacing between table cells. */
table { border-collapse: collapse; border-spacing: 0; }

meta.foundation-mq-small { font-family: "only screen and (min-width: 768px)"; width: 768px; }

meta.foundation-mq-medium { font-family: "only screen and (min-width:1280px)"; width: 1280px; }

meta.foundation-mq-large { font-family: "only screen and (min-width:1440px)"; width: 1440px; }

*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }

html, body { font-size: 97%; }

body { background: white; color: #222222; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }

a:hover { cursor: pointer; }

img, object, embed { max-width: 100%; height: auto; }

object, embed { height: 100%; }

img { -ms-interpolation-mode: bicubic; }

#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }

.left { float: left !important; }

.right { float: right !important; }

.text-left { text-align: left !important; }

.text-right { text-align: right !important; }

.text-center { text-align: center !important; }

.text-justify { text-align: justify !important; }

.hide { display: none; }

.antialiased, body { -webkit-font-smoothing: antialiased; }

img { display: inline-block; vertical-align: middle; }

textarea { height: auto; min-height: 50px; }

select { width: 100%; }

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }

.subheader, .admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { line-height: 1.4; color: #6f6f6f; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }

/* Typography resets */
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }

/* Default Link Styles */
a { color: #1164be; text-decoration: none; line-height: inherit; }
a img { border: none; }

/* Default paragraph styles */
p { font-family: inherit; font-weight: normal; font-size: 1em; line-height: 1.4; margin-bottom: 1em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }

/* Default header styles */
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: bold; font-style: normal; color: #1c355e; text-rendering: optimizeLegibility; margin-top: 1em; margin-bottom: 0.5em; line-height: 1.2125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #6f6f6f; line-height: 0; }

h1 { font-size: 2.125em; }

h2 { font-size: 1.6875em; }

h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }

h4 { font-size: 1.125em; }

h5 { font-size: 1.125em; }

h6 { font-size: 1em; }

hr { border: solid #dddddd; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }

/* Helpful Typography Defaults */
em, i { font-style: italic; line-height: inherit; }

strong, b { font-weight: bold; line-height: inherit; }

small { font-size: 60%; line-height: inherit; }

code { font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: bold; }

/* Lists */
ul, ol, dl { font-size: 1em; line-height: 1.4; margin-bottom: 1.25em; list-style-position: outside; font-family: inherit; }

ul, ol { margin-left: 2.5em; }
ul.no-bullet, ol.no-bullet { margin-left: 1.5em; }

/* Unordered Lists */
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; /* Override nested font-size change */ }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }

/* Ordered Lists */
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }

/* Definition Lists */
dl dt { margin-bottom: 0.3125em; font-weight: bold; }
dl dd { margin-bottom: 1.25em; }

/* Abbreviations */
abbr, acronym { text-transform: uppercase; font-size: 90%; color: #222222; border-bottom: 1px dotted #dddddd; cursor: help; }

abbr { text-transform: none; }

/* Blockquotes */
blockquote { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
blockquote cite { display: block; font-size: 0.8125em; color: #555555; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #555555; }

blockquote, blockquote p { line-height: 1.6; color: #6f6f6f; }

/* Microformats */
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #dddddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }

.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }

/*@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.6875em; }
  h4 { font-size: 1.4375em; } }*/
/* Tables */
table { background: white; margin-bottom: 1.25em; border: solid 1px #dddddd; }
table thead, table tfoot { background: whitesmoke; font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: #222222; text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: #222222; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #f9f9f9; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.4; }

h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; border-bottom: 1px solid #dddddd }

.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }

*:not(pre) > code { font-size: inherit; font-style: normal !important; letter-spacing: 0; padding: 3px 2px 1px 2px; background-color: #eeeeee; border: 1px solid #dddddd; -webkit-border-radius: 0; border-radius: 0; line-height: inherit; font-weight: normal; }

pre, pre > code { line-height: 1.4; color: black; font-family: monospace, serif; font-weight: normal; }

.keyseq { color: #555555; }

kbd { display: inline-block; color: #222222; font-size: 0.75em; line-height: 1.4; background-color: #f7f7f7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; margin: -0.15em 0.15em 0 0.15em; padding: 0.2em 0.6em 0.2em 0.5em; vertical-align: middle; white-space: nowrap; }

.keyseq kbd:first-child { margin-left: 0; }

.keyseq kbd:last-child { margin-right: 0; }

.menuseq, .menu { color: #090909; }

b.button:before, b.button:after { position: relative; top: -1px; font-weight: normal; }

b.button:before { content: "["; padding: 0 3px 0 2px; }

b.button:after { content: "]"; padding: 0 2px 0 3px; }

#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 0.9375em; padding-right: 0.9375em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }

#content { margin-top: 1.25em; }

#content:before { content: none; }

#header > h1:first-child { color: black; margin-top: 2.25rem; margin-bottom: 0; }
#header > h1:first-child + #toc { margin-top: 8px; border-top: 1px solid #dddddd; }
#header > h1:only-child, body.toc2 #header > h1:nth-last-child(2) { border-bottom: 1px solid #dddddd; padding-bottom: 8px; }
#header .details { border-bottom: 1px solid #dddddd; line-height: 1.45; padding-top: 0.25em; padding-bottom: 0.25em; padding-left: 0.25em; color: #555555; display: -ms-flexbox; display: -webkit-flex; display: flex; -ms-flex-flow: row wrap; -webkit-flex-flow: row wrap; flex-flow: row wrap; }
#header .details span:first-child { margin-left: -0.125em; }
#header .details span.email a { color: #6f6f6f; }
#header .details br { display: none; }
#header .details br + span:before { content: "\00a0\2013\00a0"; }
#header .details br + span.author:before { content: "\00a0\22c5\00a0"; color: #6f6f6f; }
#header .details br + span#revremark:before { content: "\00a0|\00a0"; }
#header #revnumber { text-transform: capitalize; }
#header #revnumber:after { content: "\00a0"; }

#content > h1:first-child:not([class]) { color: black; border-bottom: 1px solid #dddddd; padding-bottom: 8px; margin-top: 0; padding-top: 1rem; margin-bottom: 1.25rem; }

#floating {
  position: fixed;
  z-index: 1000;
  padding: 0.5em;
  right: 0;
  top: 0;
  background: white;
  box-shadow: 0 0 1em #777777;
  -webkit-box-shadow: 0 0 1em #777777;
  -moz-box-shadow: 0 0 1em #777777;
  -webkit-border-bottom-left-radius: 5px;
  -moz-border-radius-bottomleft: 5px;
  max-height: 80%;
  overflow: auto;
}

#floating #full { display: none; } /* Hide the full TOC by default */

#floating:hover #full{
  display: block; /* Show it on hover */
}


#toc { border-bottom: 1px solid #dddddd; padding-bottom: 0.5em; }
#toc > ul { margin-left: 0.125em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin: 0.5em 0; }
#toc ul { font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; list-style-type: none; }
#toc a { text-decoration: none; }
#toc a:active { text-decoration: underline; }

#toctitle { color: #6f6f6f; font-size: 1.2em; }

@media only screen and (min-width: 768px) { #toctitle { font-size: 1.375em; }
  body.toc2 { padding-left: 15em; padding-right: 0; }
  #toc.toc2 { margin-top: 0 !important; background-color: #f2f2f2; position: fixed; width: 15em; left: 0; top: 0; border-right: 1px solid #dddddd; border-top-width: 0 !important; border-bottom-width: 0 !important; z-index: 1000; padding: 1.25em 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; font-size: 1.2em; }
  #toc.toc2 > ul { font-size: 0.9em; margin-bottom: 0; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 15em; }
  body.toc2.toc-right #toc.toc2 { border-right-width: 0; border-left: 1px solid #dddddd; left: auto; right: 0; } }
@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; padding-right: 0; }
  #toc.toc2 { width: 20em; }
  #toc.toc2 #toctitle { font-size: 1.375em; }
  #toc.toc2 > ul { font-size: 0.95em; }
  #toc.toc2 ul ul { padding-left: 1.25em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; } }
#content #toc { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 0; border-radius: 0; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }

#footer { max-width: 100%; background-color: #222222; padding: 1.25em; }

#footer-text { color: #dddddd; line-height: 1.44; }

.sect1 { padding-bottom: 0.625em; }

@media only screen and (min-width: 768px) { .sect1 { padding-bottom: 1.25em; } }
.sect1 + .sect1 { border-top: 1px solid #dddddd; }

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; z-index: 1001; width: 1.5ex; margin-left: -1.5ex; display: block; text-decoration: none !important; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: "\00A7"; font-size: 0.85em; display: block; padding-top: 0.1em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #222222; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #151515; }

.audioblock, .imageblock, .literalblock, .listingblock, .stemblock, .videoblock { margin-bottom: 1.25em; }

.admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-rendering: optimizeLegibility; text-align: left; }

table.tableblock > caption.title { white-space: nowrap; overflow: visible; max-width: 0; }

.paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { color: black; }

table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }

.admonitionblock > table { border-collapse: separate; border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #dddddd; color: #555555; }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }

.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 0; border-radius: 0; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }

.sidebarblock { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 0; border-radius: 0; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock > .content > .title { color: #6f6f6f; margin-top: 0; }

.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }

.literalblock pre, .listingblock pre:not(.highlight), .listingblock pre[class="highlight"], .listingblock pre[class^="highlight "], .listingblock pre.CodeRay, .listingblock pre.prettyprint { background: #eeeeee; }
.sidebarblock .literalblock pre, .sidebarblock .listingblock pre:not(.highlight), .sidebarblock .listingblock pre[class="highlight"], .sidebarblock .listingblock pre[class^="highlight "], .sidebarblock .listingblock pre.CodeRay, .sidebarblock .listingblock pre.prettyprint { background: #f2f1f1; }

.literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { border: 1px solid #cccccc; -webkit-border-radius: 0; border-radius: 0; word-wrap: break-word; padding: 0.8em 0.8em 0.65em 0.8em; font-size: 0.8125em; }
.literalblock pre.nowrap, .literalblock pre[class].nowrap, .listingblock pre.nowrap, .listingblock pre[class].nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
@media only screen and (min-width: 768px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 0.90625em; } }
@media only screen and (min-width: 1280px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 1em; } }

.literalblock.output pre { color: #eeeeee; background-color: black; }

.listingblock pre.highlightjs { padding: 0; }
.listingblock pre.highlightjs > code { padding: 0.8em 0.8em 0.65em 0.8em; -webkit-border-radius: 0; border-radius: 0; }

.listingblock > .content { position: relative; }

.listingblock code[data-lang]:before { display: none; content: attr(data-lang); position: absolute; font-size: 0.75em; top: 0.425rem; right: 0.5rem; line-height: 1; text-transform: uppercase; color: #999; }

.listingblock:hover code[data-lang]:before { display: block; }

.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }

.listingblock.terminal pre .command:not([data-prompt]):before { content: "$"; }

table.pyhltable { border-collapse: separate; border: 0; margin-bottom: 0; background: none; }

table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; }

table.pyhltable td.code { padding-left: .75em; padding-right: 0; }

pre.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #dddddd; }

pre.pygments .lineno { display: inline-block; margin-right: .25em; }

table.pyhltable .linenodiv { background: none !important; padding-right: 0 !important; }

.quoteblock { margin: 0 1em 1.25em 1.5em; display: table; }
.quoteblock > .title { margin-left: -1.5em; margin-bottom: 0.75em; }
.quoteblock blockquote, .quoteblock blockquote p { color: #6f6f6f; font-size: 1.15rem; line-height: 1.75; word-spacing: 0.1em; letter-spacing: 0; font-style: italic; text-align: justify; }
.quoteblock blockquote { margin: 0; padding: 0; border: 0; }
.quoteblock blockquote:before { content: "\201c"; float: left; font-size: 2.75em; font-weight: bold; line-height: 0.6em; margin-left: -0.6em; color: #6f6f6f; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: 0.5em; margin-right: 0.5ex; text-align: right; }
.quoteblock .quoteblock { margin-left: 0; margin-right: 0; padding: 0.5em 0; border-left: 3px solid #555555; }
.quoteblock .quoteblock blockquote { padding: 0 0 0 0.75em; }
.quoteblock .quoteblock blockquote:before { display: none; }

.verseblock { margin: 0 1em 1.25em 1em; }
.verseblock pre { font-family: "Open Sans", "DejaVu Sans", sans; font-size: 1.15rem; color: #6f6f6f; font-weight: 300; text-rendering: optimizeLegibility; }
.verseblock pre strong { font-weight: 400; }
.verseblock .attribution { margin-top: 1.25rem; margin-left: 0.5ex; }

.quoteblock .attribution, .verseblock .attribution { font-size: 0.8125em; line-height: 1.45; font-style: italic; }
.quoteblock .attribution br, .verseblock .attribution br { display: none; }
.quoteblock .attribution cite, .verseblock .attribution cite { display: block; letter-spacing: -0.05em; color: #555555; }

.quoteblock.abstract { margin: 0 0 1.25em 0; display: block; }
.quoteblock.abstract blockquote, .quoteblock.abstract blockquote p { text-align: left; word-spacing: 0; }
.quoteblock.abstract blockquote:before, .quoteblock.abstract blockquote p:first-of-type:before { display: none; }

table.tableblock { max-width: 100%; border-collapse: separate; }
table.tableblock td > .paragraph:last-child p > p:last-child, table.tableblock th > p:last-child, table.tableblock td > p:last-child { margin-bottom: 0; }

table.spread { width: 100%; }

table.tableblock, th.tableblock, td.tableblock { border: 0 solid #dddddd; }

table.grid-all th.tableblock, table.grid-all td.tableblock { border-width: 0 1px 1px 0; }

table.grid-all tfoot > tr > th.tableblock, table.grid-all tfoot > tr > td.tableblock { border-width: 1px 1px 0 0; }

table.grid-cols th.tableblock, table.grid-cols td.tableblock { border-width: 0 1px 0 0; }

table.grid-all * > tr > .tableblock:last-child, table.grid-cols * > tr > .tableblock:last-child { border-right-width: 0; }

table.grid-rows th.tableblock, table.grid-rows td.tableblock { border-width: 0 0 1px 0; }

table.grid-all tbody > tr:last-child > th.tableblock, table.grid-all tbody > tr:last-child > td.tableblock, table.grid-all thead:last-child > tr > th.tableblock, table.grid-rows tbody > tr:last-child > th.tableblock, table.grid-rows tbody > tr:last-child > td.tableblock, table.grid-rows thead:last-child > tr > th.tableblock { border-bottom-width: 0; }

table.grid-rows tfoot > tr > th.tableblock, table.grid-rows tfoot > tr > td.tableblock { border-width: 1px 0 0 0; }

table.frame-all { border-width: 1px; }

table.frame-sides { border-width: 0 1px; }

table.frame-topbot { border-width: 1px 0; }

th.halign-left, td.halign-left { text-align: left; }

th.halign-right, td.halign-right { text-align: right; }

th.halign-center, td.halign-center { text-align: center; }

th.valign-top, td.valign-top { vertical-align: top; }

th.valign-bottom, td.valign-bottom { vertical-align: bottom; }

th.valign-middle, td.valign-middle { vertical-align: middle; }

table thead th, table tfoot th { font-weight: bold; }

tbody tr th { display: table-cell; line-height: 1.4; background: whitesmoke; }

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p { color: #222222; font-weight: bold; }

p.tableblock > code:only-child { background: none; padding: 0; }

p.tableblock { font-size: 1em; }

td > div.verse { white-space: pre; }

ol { margin-left: 2.5em; }

ul li ol { margin-left: 1.5em; }

dl dd { margin-left: 1.125em; }

dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }

ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.625em; }

ul.unstyled, ol.unnumbered, ul.checklist, ul.none { list-style-type: none; }

ul.unstyled, ol.unnumbered, ul.checklist { margin-left: 0.625em; }

ul.checklist li > p:first-child > .fa-check-square-o:first-child, ul.checklist li > p:first-child > input[type="checkbox"]:first-child { margin-right: 0.25em; }

ul.checklist li > p:first-child > input[type="checkbox"]:first-child { position: relative; top: 1px; }

ul.inline { margin: 0 auto 0.625em auto; margin-left: -1.375em; margin-right: 0; padding: 0; list-style: none; overflow: hidden; }
ul.inline > li { list-style: none; float: left; margin-left: 1.375em; display: block; }
ul.inline > li > * { display: block; }

.unstyled dl dt { font-weight: normal; font-style: normal; }

ol.arabic { list-style-type: decimal; }

ol.decimal { list-style-type: decimal-leading-zero; }

ol.loweralpha { list-style-type: lower-alpha; }

ol.upperalpha { list-style-type: upper-alpha; }

ol.lowerroman { list-style-type: lower-roman; }

ol.upperroman { list-style-type: upper-roman; }

ol.lowergreek { list-style-type: lower-greek; }

.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }

td.hdlist1 { padding-right: .75em; font-weight: bold; }

td.hdlist1, td.hdlist2 { vertical-align: top; }

.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }

.colist > table tr > td:first-of-type { padding: 0 0.75em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.25em 0; }

.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: 0 0 0 1px #dddddd; box-shadow: 0 0 0 1px #dddddd; }

.imageblock.left, .imageblock[style*="float: left"] { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }

.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }

a.image { text-decoration: none; }

span.footnote, span.footnoteref { vertical-align: super; font-size: 0.875em; }
span.footnote a, span.footnoteref a { text-decoration: none; }
span.footnote a:active, span.footnoteref a:active { text-decoration: underline; }

#footnotes { padding-top: 0.75em; padding-bottom: 0.75em; margin-bottom: 0.625em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -.25em 0 .75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.375em; line-height: 1.3; font-size: 0.875em; margin-left: 1.2em; text-indent: -1.2em; margin-bottom: .2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }

#content #footnotes { margin-top: -0.625em; margin-bottom: 0; padding: 0.75em 0; }

.gist .file-data > table { border: 0; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }

div.unbreakable { page-break-inside: avoid; }

.big { font-size: larger; }

.small { font-size: smaller; }

.underline { text-decoration: underline; }

.overline { text-decoration: overline; }

.line-through { text-decoration: line-through; }

.aqua { color: #00bfbf; }

.aqua-background { background-color: #00fafa; }

.black { color: black; }

.black-background { background-color: black; }

.blue { color: #0000bf; }

.blue-background { background-color: #0000fa; }

.fuchsia { color: #bf00bf; }

.fuchsia-background { background-color: #fa00fa; }

.gray { color: #606060; }

.gray-background { background-color: #7d7d7d; }

.green { color: #006000; }

.green-background { background-color: #007d00; }

.lime { color: #00bf00; }

.lime-background { background-color: #00fa00; }

.maroon { color: #600000; }

.maroon-background { background-color: #7d0000; }

.navy { color: #000060; }

.navy-background { background-color: #00007d; }

.olive { color: #606000; }

.olive-background { background-color: #7d7d00; }

.purple { color: #600060; }

.purple-background { background-color: #7d007d; }

.red { color: #bf0000; }

.red-background { background-color: #fa0000; }

.silver { color: #909090; }

.silver-background { background-color: #bcbcbc; }

.teal { color: #006060; }

.teal-background { background-color: #007d7d; }

.white { color: #bfbfbf; }

.white-background { background-color: #fafafa; }

.yellow { color: #bfbf00; }

.yellow-background { background-color: #fafa00; }

span.icon > .fa { cursor: default; }

.admonitionblock td.icon [class^="fa icon-"] { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #207c98; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }

.conum[data-value] { display: inline-block; color: #fff !important; background-color: #222222; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; font-size: 0.75em; width: 1.67em; height: 1.67em; line-height: 1.67em; font-family: "Open Sans", "DejaVu Sans", sans-serif; font-style: normal; font-weight: bold; }
.conum[data-value] * { color: #fff !important; }
.conum[data-value] + b { display: none; }
.conum[data-value]:after { content: attr(data-value); }
pre .conum[data-value] { position: relative; top: -0.125em; }

b.conum * { color: inherit !important; }

.conum:not([data-value]):empty { display: none; }

.literalblock pre, .listingblock pre { background: #eeeeee; }

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.min.css">
<style>.listingblock .pygments .hll { background-color: #ffffcc }
.listingblock .pygments  { background: #f8f8f8; }
.listingblock .pygments .tok-c { color: #408080; font-style: italic } /* Comment */
.listingblock .pygments .tok-err { border: 1px solid #FF0000 } /* Error */
.listingblock .pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
.listingblock .pygments .tok-o { color: #666666 } /* Operator */
.listingblock .pygments .tok-cm { color: #408080; font-style: italic } /* Comment.Multiline */
.listingblock .pygments .tok-cp { color: #BC7A00 } /* Comment.Preproc */
.listingblock .pygments .tok-c1 { color: #408080; font-style: italic } /* Comment.Single */
.listingblock .pygments .tok-cs { color: #408080; font-style: italic } /* Comment.Special */
.listingblock .pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
.listingblock .pygments .tok-ge { font-style: italic } /* Generic.Emph */
.listingblock .pygments .tok-gr { color: #FF0000 } /* Generic.Error */
.listingblock .pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
.listingblock .pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
.listingblock .pygments .tok-go { color: #888888 } /* Generic.Output */
.listingblock .pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.listingblock .pygments .tok-gs { font-weight: bold } /* Generic.Strong */
.listingblock .pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.listingblock .pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
.listingblock .pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.listingblock .pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.listingblock .pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.listingblock .pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
.listingblock .pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.listingblock .pygments .tok-kt { color: #B00040 } /* Keyword.Type */
.listingblock .pygments .tok-m { color: #666666 } /* Literal.Number */
.listingblock .pygments .tok-s { color: #BA2121 } /* Literal.String */
.listingblock .pygments .tok-na { color: #7D9029 } /* Name.Attribute */
.listingblock .pygments .tok-nb { color: #008000 } /* Name.Builtin */
.listingblock .pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
.listingblock .pygments .tok-no { color: #880000 } /* Name.Constant */
.listingblock .pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
.listingblock .pygments .tok-ni { color: #999999; font-weight: bold } /* Name.Entity */
.listingblock .pygments .tok-ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.listingblock .pygments .tok-nf { color: #0000FF } /* Name.Function */
.listingblock .pygments .tok-nl { color: #A0A000 } /* Name.Label */
.listingblock .pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.listingblock .pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
.listingblock .pygments .tok-nv { color: #19177C } /* Name.Variable */
.listingblock .pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.listingblock .pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
.listingblock .pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
.listingblock .pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
.listingblock .pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
.listingblock .pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
.listingblock .pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
.listingblock .pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
.listingblock .pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
.listingblock .pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.listingblock .pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
.listingblock .pygments .tok-se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.listingblock .pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
.listingblock .pygments .tok-si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.listingblock .pygments .tok-sx { color: #008000 } /* Literal.String.Other */
.listingblock .pygments .tok-sr { color: #BB6688 } /* Literal.String.Regex */
.listingblock .pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
.listingblock .pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
.listingblock .pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
.listingblock .pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
.listingblock .pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
.listingblock .pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
.listingblock .pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>JavaScript</h1>
<div class="details">
<span id="author" class="author">Aitor Medrano</span><br>
<span id="email" class="email">&lt;<a href="mailto:aitor.medrano@ua.es">aitor.medrano@ua.es</a>&gt;</span><br>
<span id="revnumber">version 1.1</span>
<br><span id="revremark">añadida Fetch API</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Índice de contenidos</div>
<ul class="sectlevel1">
<li><a href="#sesion08">8. Promesas</a>
<ul class="sectlevel2">
<li><a href="#__qu%C3%A9_es_una_promesa">8.1. ¿Qué es una promesa?</a></li>
<li><a href="#_promise_api">8.2. Promise API</a>
<ul class="sectlevel3">
<li><a href="#_hola_promesa">8.2.1. Hola Promesa</a></li>
<li><a href="#_uso_b%C3%A1sico">8.2.2. Uso básico</a></li>
<li><a href="#_estados_de_una_promesa">8.2.3. Estados de una promesa</a></li>
<li><a href="#_consumiendo_promesas">8.2.4. Consumiendo promesas</a></li>
<li><a href="#_prometiendo_code_xmlhttprequest_code">8.2.5. Prometiendo <code>XMLHttpRequest</code></a></li>
<li><a href="#_encadenando_promesas">8.2.6. Encadenando promesas</a></li>
<li><a href="#_orden_de_ejecuci%C3%B3n_de_em_callbacks_em">8.2.7. Orden de ejecución de <em>callbacks</em></a></li>
<li><a href="#_gesti%C3%B3n_de_errores">8.2.8. Gestión de errores</a></li>
<li><a href="#_promesas_en_paralelo">8.2.9. Promesas en paralelo</a></li>
<li><a href="#_promesas_en_secuencia">8.2.10. Promesas en secuencia</a></li>
<li><a href="#_carrera_de_promesas">8.2.11. Carrera de promesas</a></li>
</ul>
</li>
<li><a href="#_fetch_api">8.3. Fetch API</a>
<ul class="sectlevel3">
<li><a href="#_hola_em_fetch_em">8.3.1. Hola <em>Fetch</em></a></li>
<li><a href="#_cabeceras">8.3.2. Cabeceras</a></li>
<li><a href="#_petici%C3%B3n">8.3.3. Petición</a></li>
<li><a href="#_respuesta">8.3.4. Respuesta</a></li>
</ul>
</li>
<li><a href="#_jquery_deferreds">8.4. jQuery Deferreds</a>
<ul class="sectlevel3">
<li><a href="#__code_deferred_code">8.4.1. <code>$.Deferred()</code></a></li>
<li><a href="#_manejadores_de_promesas">8.4.2. Manejadores de promesas</a></li>
<li><a href="#_encadenando_promesas_2">8.4.3. Encadenando promesas</a></li>
<li><a href="#_modelando_con_promesas">8.4.4. Modelando con promesas</a></li>
<li><a href="#_prestando_promesas_del_futuro">8.4.5. Prestando promesas del futuro</a></li>
<li><a href="#_deferreds_y_ajax">8.4.6. Deferreds y AJAX</a></li>
</ul>
</li>
<li><a href="#_ejercicios">8.5. Ejercicios</a>
<ul class="sectlevel3">
<li><a href="#__0_5_ptos_ejercicio_81_star_wars_fetch">8.5.1. (0.5 ptos) Ejercicio 81. Star Wars Fetch</a></li>
<li><a href="#__0_3_ptos_ejercicio_82_star_wars_deferreds">8.5.2. (0.3 ptos) Ejercicio 82. Star Wars Deferreds</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="sesion08">8. Promesas</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Las promesas son una característica novedosa para gestionar los eventos asíncronos, permitiendo escribir código más sencillo, <em>callbacks</em> más cortos, y mantener la lógica de la aplicación de alto nivel separada de los comportamientos de bajo nivel.</p>
</div>
<div class="paragraph">
<p>Al utilizar promesas, podemos usar <em>callbacks</em> en cualquier situación, y no solo con eventos. Además ofrecen un mecanismo estándar para indicar la finalización de tareas.</p>
</div>
<div class="sect2">
<h3 id="__qué_es_una_promesa">8.1. ¿Qué es una promesa?</h3>
<div class="paragraph">
<p>Una promesa es un objeto que representa un evento único, normalmente como resultado de una tarea asíncrona como una llamada <em>AJAX</em>. Almacenan un valor futuro, ya sea el resultado de una petición HTTP o la lectura de un fichero desde disco.</p>
</div>
<div class="paragraph">
<p>En la vida real, cuando vamos a un restaurante de comida rápida y pedimos un menú con hamburguesa con bacón y patatas fritas, estamos obteniendo una promesa con el número del pedido, porque primero lo pagamos y esperamos recibir nuestra comida, pero es un proceso asíncrono el cual inicia una transacción. Mientras esperamos a que nos llamen con nuestra sabrosa hamburguesa, podemos realizar otras acciones, como decirle a nuestra pareja que busque una mesa o preparar un tuit con lo rica que está nuestra hamburguesa. Estas acciones se traducen en <em>callbacks</em>, los cuales se ejecutarán una vez se finalice la operación. Una vez nuestro pedido está preparado, nos llaman con el número del mismo y nuestra deseada comida. O inesperadamente, se ha acabado el bacón y nuestra promesa se cumple pero erroneamente. Así pues, un valor futuro puede finalizar correctamente o fallar, pero en ambos casos, finalizar.</p>
</div>
</div>
<div class="sect2">
<h3 id="_promise_api">8.2. Promise API</h3>
<div class="paragraph">
<p>Las promesas forman parte del API de <em>JavaScript</em> desde <em>ECMAScript</em> 6, con lo cual es una tecnología novedosa que puede no estar disponible en todos los navegadores. Aún así, las últimas versiones de los navegadores ya lo soportan: <a href="http://caniuse.com/#feat=promises" class="bare">http://caniuse.com/#feat=promises</a></p>
</div>
<div class="paragraph">
<p>Además de la implementación del estándar ECMAScript 6, <em>jQuery</em> implementa las promesas mediante los <em>Deferreds</em>, y existen librerías de terceros como <strong>BlueBird</strong> (<a href="https://github.com/petkaantonov/bluebird" class="bare">https://github.com/petkaantonov/bluebird</a>) o <strong>Q</strong> (<a href="https://github.com/kriskowal/q" class="bare">https://github.com/kriskowal/q</a>) que cumplen el estándard.</p>
</div>
<div class="sect3">
<h4 id="_hola_promesa">8.2.1. Hola Promesa</h4>
<div class="paragraph">
<p>Para crear una promesa, utilizaremos el contructor <code>Promise()</code>, el cual recibe como argumento un callback con dos parámetros, <code>resolver</code> y <code>rechazar</code>. Este callback se ejecuta inmediatamente.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Para facilitar la lectura del código, las funciones <code>resolver</code> y <code>rechazar</code> están traducidas. El API de promesas utiliza <code>resolve</code> y <code>reject</code> como alternativa, y además, ofrece métodos auxiliares para realizar estas acciones con dicha nomenclatura.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Dentro de la promesa, realizaremos las acciones deseadas y si todo funciona como esperamos llamaremos a <code>resolver</code>. Sino, llamaremos a <code>rechazar</code> (mejor pasándole un objeto <code>Error</code> para capturar la pila de llamadas)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">promesa</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Promise</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">resolver</span><span class="tok-p">,</span> <span class="tok-nx">rechazar</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-kd">var</span> <span class="tok-nx">ok</span><span class="tok-p">;</span>

  <span class="tok-c1">// código con la llamada async</span>

  <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">ok</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nx">resolver</span><span class="tok-p">(</span><span class="tok-s2">&quot;Ha funcionado&quot;</span><span class="tok-p">);</span> <span class="tok-c1">// resuelve p</span>
  <span class="tok-p">}</span> <span class="tok-k">else</span> <span class="tok-p">{</span>
    <span class="tok-nx">rechazar</span><span class="tok-p">(</span><span class="tok-nb">Error</span><span class="tok-p">(</span><span class="tok-s2">&quot;Ha fallado&quot;</span><span class="tok-p">));</span> <span class="tok-c1">// rechaza p</span>
  <span class="tok-p">}</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Así pues, los parámetros <code>resolver</code> y <code>rechazar</code> tienen la capacidad de manipular el estado interno de la instancia de promesa <code>p</code>. Esto se conoce como el patrón <em>Revealing Constructor</em> (<a href="http://blog.domenic.me/the-revealing-constructor-pattern/" class="bare">http://blog.domenic.me/the-revealing-constructor-pattern/</a>), ya que el constructor revela sus entrañas pero solo al código que lo construye, el cual es el único que puede resolver o rechazar la promesa. Por ello, cuando le pasamos la promesa a cualquier otro método, éste solo podrá añadir callbacks sobre la misma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">hacerCosasCon</span><span class="tok-p">(</span><span class="tok-nx">promesa</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_uso_básico">8.2.2. Uso básico</h4>
<div class="paragraph">
<p>Una vez tenemos nuestra promesa, independientemente del estado en el que se encuentre, mediante <code>then(callbackResuelta, callbackRechazada)</code> podremos actuar en consecuencia dependiendo del <em>callback</em> que se dispare:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">promesa</span><span class="tok-p">.</span><span class="tok-nx">then</span><span class="tok-p">(</span>
  <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">resultado</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">resultado</span><span class="tok-p">);</span> <span class="tok-c1">// &quot;Ha funcionado&quot;</span>
  <span class="tok-p">},</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">err</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">error</span><span class="tok-p">(</span><span class="tok-nx">err</span><span class="tok-p">);</span> <span class="tok-c1">// Error: &quot;Ha fallado&quot;</span>
  <span class="tok-p">}</span>
<span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El primer <em>callback</em> es para el caso completado, y el segundo para el rechazado. Ambos son opcionales, con lo que podemos añadir un <em>callback</em> para únicamente el caso completado o rechazado.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
La especificación describe el término <strong>thenable</strong> para aquelos objetos que son similares a una promesa, ya que contienen un método <strong>then</strong>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Uno de los ejemplos más sencillos es una petición AJAX mediante jQuery:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">p</span> <span class="tok-o">=</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-s2">&quot;http://www.omdbapi.com/?t=Interstellar&amp;r=json&quot;</span><span class="tok-p">);</span>

<span class="tok-nx">p</span><span class="tok-p">.</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">resultado</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">resultado</span><span class="tok-p">);</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_estados_de_una_promesa">8.2.3. Estados de una promesa</h4>
<div class="paragraph">
<p>Nada más comenzar, una promesa está en un estado pendiente (<em>pending</em>). Al finalizar, su estado será <strong>completada</strong> (<em>fulfilled</em>), lo que implica que la tarea se ha realizado/resuelto, o <strong>rechazada</strong> (<em>rejected</em>), si la tarea no se completó.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/js08/js08estados.jpg" alt="Estados de una promesa">
</div>
<div class="title">Figure 1. Estados de una Promesa</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
No hay que confundir completada con éxito, ya que una promesa se puede completar pero contener un error (por ejemplo, el usuario solicitado no existe), o puede no completarse porque el usuario cancelase la petición incluso sin ocurrir ningún error.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Una vez que una promesa se completa o se rechaza, se mantendrá en dicho estado para siempre (conocido como <em>settled</em>), y sus <em>callbacks</em> nunca se volverán a disparar. Tanto el estado como cualquier valor dado como resultado no se pueden modificar.</p>
</div>
<div class="paragraph">
<p>Dicho de otro modo, una promesa sólo puede completarse o rechazarse una vez. No puede hacerlo dos veces, ni cambiar de un estado completado a rechazado, o viceversa.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Autoevaluación</div>
<div class="paragraph">
<p>A partir del siguiente código anterior, ¿Qué mensajes saldrán por pantalla? <span class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnote_1" title="View footnote.">1</a>]</span></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">promesa</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Promise</span><span class="tok-p">(</span><span class="tok-kd">function</span> <span class="tok-p">(</span><span class="tok-nx">resolver</span><span class="tok-p">,</span> <span class="tok-nx">rechazar</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nx">resolver</span><span class="tok-p">(</span><span class="tok-nb">Math</span><span class="tok-p">.</span><span class="tok-nx">PI</span><span class="tok-p">);</span>
  <span class="tok-nx">rechazar</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">);</span>
  <span class="tok-nx">resolver</span><span class="tok-p">(</span><span class="tok-nb">Math</span><span class="tok-p">.</span><span class="tok-nx">sqrt</span><span class="tok-p">(</span><span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">));</span>
<span class="tok-p">});</span>

<span class="tok-nx">promesa</span><span class="tok-p">.</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span> <span class="tok-p">(</span><span class="tok-nx">num</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;El número es &quot;</span> <span class="tok-o">+</span> <span class="tok-nx">num</span><span class="tok-p">)</span>
<span class="tok-p">})</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Es decir, se queda en un estado inmutable, el cual se puede observar tantas veces como queramos. Por ello, una vez resuelta, podemos pasar tranquilamente la promesa a cualquier otra función, ya que nadie va a poder modificar su estado.</p>
</div>
<div class="paragraph">
<p>Y ahora viene la pregunta del millón: Si la función rechazar pasa una promesa al estado rechazado, ¿por qué la función resolver no pasa la promesa al estado resuelta en vez de al estado completada? La respuesta corta es que resolver una promesa no es lo mismo que completarla. La larga es que cuando a la función <code>resolver</code> se le pasa un valor, la promesa se completa automáticamente. En cambio, cuando se le pasa otra promesa (por ejemplo <code>promesa.resolver(otraPromesa)</code>), las promesas se unen para crear una única promesa, de manera que cuando se resuelve la 2ª promesa (<code>otraPromesa</code>), ambas promesas se resolverán. Del mismo modo, si se rechaza la 2ª promesa, las dos promesas se rechazarán.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
El argumento que se pasa a <code>resolver</code> decide el destino de la promesa. Si es un valor, se completa. Si es una promesa, su estado depende de ésta última.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Tanto <code>resolver</code> como <code>rechazar</code> se pueden llamar sin argumentos, en cuyo caso el valor de la promesa será <code>undefined</code>.</p>
</div>
<div class="paragraph">
<p>Finalmente, si queremos crear una promesa que inmediatamente se resuelva o rechace, podemos emplear los métodos <code>Promise.resolve()</code> o <code>Promise.reject()</code>:</p>
</div>
<div class="listingblock">
<div class="title">Funciones equivalentes para resolver y rechazar</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-k">new</span> <span class="tok-nx">Promise</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">resolver</span><span class="tok-p">,</span> <span class="tok-nx">rechazar</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nx">resolver</span><span class="tok-p">(</span><span class="tok-s2">&quot;forma larga&quot;</span><span class="tok-p">);</span>
<span class="tok-p">});</span>
<span class="tok-nx">Promise</span><span class="tok-p">.</span><span class="tok-nx">resolve</span><span class="tok-p">(</span><span class="tok-s2">&quot;forma corta&quot;</span><span class="tok-p">);</span>

<span class="tok-k">new</span> <span class="tok-nx">Promise</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">resolver</span><span class="tok-p">,</span> <span class="tok-nx">rechazar</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nx">reject</span><span class="tok-p">(</span><span class="tok-s2">&quot;rechazo larga&quot;</span><span class="tok-p">);</span>
<span class="tok-p">});</span>
<span class="tok-nx">Promise</span><span class="tok-p">.</span><span class="tok-nx">reject</span><span class="tok-p">(</span><span class="tok-s2">&quot;rechazo corta&quot;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Estos métodos son útiles cuando ya tienes el elemento que debería resolver o rechazar la promesa.</p>
</div>
</div>
<div class="sect3">
<h4 id="_consumiendo_promesas">8.2.4. Consumiendo promesas</h4>
<div class="paragraph">
<p>Una gran ventaja de emplear promesas es que podemos adjuntar tantos <em>callbacks</em> a una promesa como queramos, los cuales se ejecutarán una vez que la promesa se resuelva o rechace. Es decir, una promesa la pueden consumir varios consumidores.</p>
</div>
<div class="paragraph">
<p>Veamos un ejemplo completo. Supongamos que al entrar a una aplicación, queremos mostrar la información del usuario tanto en la barra de navegación como en el titulo de la página.</p>
</div>
<div class="paragraph">
<p>Si no empleasemos promesas, el código sería similar a:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">usuario</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
  <span class="tok-nx">perfilUsuario</span><span class="tok-o">:</span> <span class="tok-kc">null</span><span class="tok-p">,</span>

  <span class="tok-nx">obtenerPerfil</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">perfilUsuario</span><span class="tok-p">)</span> <span class="tok-p">{</span>
      <span class="tok-kd">var</span> <span class="tok-nx">xhr</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">XMLHttpRequest</span><span class="tok-p">();</span>
      <span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">open</span><span class="tok-p">(</span><span class="tok-s2">&quot;GET&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;usuario.json&quot;</span><span class="tok-p">,</span> <span class="tok-kc">true</span><span class="tok-p">);</span>
      <span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">onreadystatechange</span> <span class="tok-o">=</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
        <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">readyState</span> <span class="tok-o">===</span>  <span class="tok-mi">4</span><span class="tok-p">)</span> <span class="tok-p">{</span>
          <span class="tok-nx">perfilUsuario</span> <span class="tok-o">=</span> <span class="tok-nx">JSON</span><span class="tok-p">.</span><span class="tok-nx">parse</span><span class="tok-p">(</span><span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">responseText</span><span class="tok-p">);</span>
        <span class="tok-p">}</span>
      <span class="tok-p">};</span>
      <span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">send</span><span class="tok-p">(</span><span class="tok-kc">null</span><span class="tok-p">);</span>
    <span class="tok-p">}</span>
  <span class="tok-p">}</span>
<span class="tok-p">};</span>

<span class="tok-nx">usuario</span><span class="tok-p">.</span><span class="tok-nx">obtenerPerfil</span><span class="tok-p">();</span>
<span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">usuario</span><span class="tok-p">.</span><span class="tok-nx">perfilUsuario</span><span class="tok-p">)</span> <span class="tok-p">{</span>  <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s2">&quot;navbar&quot;</span><span class="tok-p">).</span><span class="tok-nx">innerHTML</span> <span class="tok-o">=</span> <span class="tok-nx">usuario</span><span class="tok-p">.</span><span class="tok-nx">login</span><span class="tok-p">;</span>
  <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s2">&quot;titulo&quot;</span><span class="tok-p">).</span><span class="tok-nx">innerHTML</span> <span class="tok-o">=</span> <span class="tok-nx">usuario</span><span class="tok-p">.</span><span class="tok-nx">nombre</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Pese a parecer que este código funciona, nunca se rellenarán los datos porque al ser una llamada asíncrona, la variable <code>perfilUsuario</code> estará a null.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para que funcione correctamente, el código de rellenar la página se tiene que acoplar con la petición AJAX:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">usuario</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
  <span class="tok-nx">perfilUsuario</span><span class="tok-o">:</span> <span class="tok-kc">null</span><span class="tok-p">,</span>

  <span class="tok-nx">obtenerPerfil</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">perfilUsuario</span><span class="tok-p">)</span> <span class="tok-p">{</span>
      <span class="tok-kd">var</span> <span class="tok-nx">xhr</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">XMLHttpRequest</span><span class="tok-p">();</span>
      <span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">open</span><span class="tok-p">(</span><span class="tok-s2">&quot;GET&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;usuario.json&quot;</span><span class="tok-p">,</span> <span class="tok-kc">true</span><span class="tok-p">);</span>
      <span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">onreadystatechange</span> <span class="tok-o">=</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
        <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">readyState</span> <span class="tok-o">===</span>  <span class="tok-mi">4</span><span class="tok-p">)</span> <span class="tok-p">{</span>
          <span class="tok-nx">perfilUsuario</span> <span class="tok-o">=</span> <span class="tok-nx">JSON</span><span class="tok-p">.</span><span class="tok-nx">parse</span><span class="tok-p">(</span><span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">responseText</span><span class="tok-p">);</span>
          <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s2">&quot;navbar&quot;</span><span class="tok-p">).</span><span class="tok-nx">innerHTML</span> <span class="tok-o">=</span> <span class="tok-nx">perfilUsuario</span><span class="tok-p">.</span><span class="tok-nx">login</span><span class="tok-p">;</span> <i class="conum" data-value="1"></i><b>(1)</b>
          <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s2">&quot;titulo&quot;</span><span class="tok-p">).</span><span class="tok-nx">innerHTML</span> <span class="tok-o">=</span> <span class="tok-nx">perfilUsuario</span><span class="tok-p">.</span><span class="tok-nx">nombre</span><span class="tok-p">;</span>
        <span class="tok-p">}</span>
      <span class="tok-p">};</span>
      <span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">send</span><span class="tok-p">(</span><span class="tok-kc">null</span><span class="tok-p">);</span>
    <span class="tok-p">}</span>
  <span class="tok-p">}</span>
<span class="tok-p">};</span>

<span class="tok-nx">usuario</span><span class="tok-p">.</span><span class="tok-nx">obtenerPerfil</span><span class="tok-p">();</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Ahora pintamos los datos tras recibirlos de manera asíncrona</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_prometiendo_ajax">Prometiendo AJAX</h5>
<div class="paragraph">
<p>En cambio, si al obtener los datos AJAX, los envolvemos en una promesa, el código queda más legible y ahora sí que podemos desacoplar la petición AJAX del dibujado HTML:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">usuario</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
  <span class="tok-nx">promesaUsuario</span><span class="tok-o">:</span> <span class="tok-kc">null</span><span class="tok-p">,</span>

  <span class="tok-nx">obtenerPerfil</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">promesaUsuario</span><span class="tok-p">)</span> <span class="tok-p">{</span>
      <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">promesaUsuario</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Promise</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">resolver</span><span class="tok-p">,</span> <span class="tok-nx">rechazar</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-kd">var</span> <span class="tok-nx">xhr</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">XMLHttpRequest</span><span class="tok-p">();</span>
        <span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">open</span><span class="tok-p">(</span><span class="tok-s2">&quot;GET&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;usuario.json&quot;</span><span class="tok-p">,</span> <span class="tok-kc">true</span><span class="tok-p">);</span>
        <span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">onreadystatechange</span> <span class="tok-o">=</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
          <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">readyState</span> <span class="tok-o">===</span>  <span class="tok-mi">4</span><span class="tok-p">)</span> <span class="tok-p">{</span>
            <span class="tok-nx">resolver</span><span class="tok-p">(</span><span class="tok-nx">JSON</span><span class="tok-p">.</span><span class="tok-nx">parse</span><span class="tok-p">(</span><span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">responseText</span><span class="tok-p">));</span>
          <span class="tok-p">}</span>
        <span class="tok-p">};</span>
        <span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">onerror</span> <span class="tok-o">=</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
          <span class="tok-nx">rechazar</span><span class="tok-p">(</span><span class="tok-nb">Error</span><span class="tok-p">(</span><span class="tok-s2">&quot;Error al obtener usuario&quot;</span><span class="tok-p">));</span>
        <span class="tok-p">};</span>
        <span class="tok-nx">xhr</span><span class="tok-p">.</span><span class="tok-nx">send</span><span class="tok-p">(</span><span class="tok-kc">null</span><span class="tok-p">);</span>
      <span class="tok-p">});</span>
    <span class="tok-p">}</span>
    <span class="tok-k">return</span> <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-nx">promesaUsuario</span><span class="tok-p">;</span>
  <span class="tok-p">}</span>
<span class="tok-p">};</span>

<span class="tok-kd">var</span> <span class="tok-nx">navbar</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
  <span class="tok-nx">mostrar</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">usuario</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nx">usuario</span><span class="tok-p">.</span><span class="tok-nx">obtenerPerfil</span><span class="tok-p">().</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">perfil</span><span class="tok-p">)</span> <span class="tok-p">{</span>
      <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s2">&quot;navbar&quot;</span><span class="tok-p">).</span><span class="tok-nx">innerHTML</span> <span class="tok-o">=</span> <span class="tok-nx">perfil</span><span class="tok-p">.</span><span class="tok-nx">login</span><span class="tok-p">;</span>
    <span class="tok-p">});</span>
  <span class="tok-p">}</span>
<span class="tok-p">}</span>

<span class="tok-kd">var</span> <span class="tok-nx">titulo</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
  <span class="tok-nx">mostrar</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">usuario</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nx">usuario</span><span class="tok-p">.</span><span class="tok-nx">obtenerPerfil</span><span class="tok-p">().</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">perfil</span><span class="tok-p">)</span> <span class="tok-p">{</span>
      <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s2">&quot;titulo&quot;</span><span class="tok-p">).</span><span class="tok-nx">innerHTML</span> <span class="tok-o">=</span> <span class="tok-nx">perfil</span><span class="tok-p">.</span><span class="tok-nx">nombre</span><span class="tok-p">;</span>
    <span class="tok-p">});</span>
  <span class="tok-p">}</span>
<span class="tok-p">}</span>

<span class="tok-nx">navbar</span><span class="tok-p">.</span><span class="tok-nx">mostrar</span><span class="tok-p">(</span><span class="tok-nx">usuario</span><span class="tok-p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-nx">titulo</span><span class="tok-p">.</span><span class="tok-nx">mostrar</span><span class="tok-p">(</span><span class="tok-nx">usuario</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Da igual si se ha obtenido el usuario. Como se obtiene una promesa, cuando se resuelva será cuando se dibujen los datos</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Así pues, podemos añadir tanto consumidores a una misma promesa conforme necesitamos, los cuales se ejecutarán una vez de resuelva la misma.</p>
</div>
<div class="paragraph">
<p>Además, podemos añadir más <em>callback</em> cuando queramos, incluso si la promesa ya ha sido resuelta o rechazada (en dicho caso, se ejecutarán inmediatamente).</p>
</div>
</div>
<div class="sect4">
<h5 id="_devolviendo_promesas">Devolviendo promesas</h5>
<div class="paragraph">
<p>¿Y si queremos realizar una acción tras mostrar los datos del usuario? Al tratarse de una tarea asíncrona, necesitamos a su vez, que las operaciones de mostrar los datos también devuelvan una promesa.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Cualquier función que utilice una promesa debería devolver una nueva promesa
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Ahora nuestro código quedará así:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-c1">// ...</span>
<span class="tok-kd">var</span> <span class="tok-nx">titulo</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
  <span class="tok-nx">mostrar</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">usuario</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-k">return</span> <span class="tok-nx">usuario</span><span class="tok-p">.</span><span class="tok-nx">obtenerPerfil</span><span class="tok-p">().</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">perfil</span><span class="tok-p">)</span> <span class="tok-p">{</span>  <i class="conum" data-value="1"></i><b>(1)</b>
      <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s2">&quot;titulo&quot;</span><span class="tok-p">).</span><span class="tok-nx">innerHTML</span> <span class="tok-o">=</span> <span class="tok-nx">perfil</span><span class="tok-p">.</span><span class="tok-nx">nombre</span><span class="tok-p">;</span>
    <span class="tok-p">});</span>
  <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Como <code>then</code> devuelve una promesa, a su vez, hacemos que <code>mostrar</code> la  propague</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_prometiendo_code_xmlhttprequest_code">8.2.5. Prometiendo <code>XMLHttpRequest</code></h4>
<div class="paragraph">
<p>A día de hoy <code>XMLHttpRequest</code> no devuelve una promesa. Siendo, probablemente, la operación asíncrona más empleada por su uso en AJAX, el hecho de que devuelva una promesa va a simplicar las peticiones AJAX. Para ello, podemos crear una función que devuelve una promesa del siguiente modo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">function</span> <span class="tok-nx">ajaxUA</span><span class="tok-p">(</span><span class="tok-nx">url</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-k">return</span> <span class="tok-k">new</span> <span class="tok-nx">Promise</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">resolver</span><span class="tok-p">,</span> <span class="tok-nx">rechazar</span><span class="tok-p">)</span> <span class="tok-p">{</span>	<i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-kd">var</span> <span class="tok-nx">req</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">XMLHttpRequest</span><span class="tok-p">();</span>
    <span class="tok-nx">req</span><span class="tok-p">.</span><span class="tok-nx">open</span><span class="tok-p">(</span><span class="tok-s1">&#39;GET&#39;</span><span class="tok-p">,</span> <span class="tok-nx">url</span><span class="tok-p">);</span>

    <span class="tok-nx">req</span><span class="tok-p">.</span><span class="tok-nx">onload</span> <span class="tok-o">=</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
      <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">req</span><span class="tok-p">.</span><span class="tok-nx">status</span> <span class="tok-o">==</span> <span class="tok-mi">200</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-nx">resolver</span><span class="tok-p">(</span><span class="tok-nx">req</span><span class="tok-p">.</span><span class="tok-nx">response</span><span class="tok-p">);</span>	<i class="conum" data-value="2"></i><b>(2)</b>
      <span class="tok-p">}</span> <span class="tok-k">else</span> <span class="tok-p">{</span>
        <span class="tok-nx">rechazar</span><span class="tok-p">(</span><span class="tok-nb">Error</span><span class="tok-p">(</span><span class="tok-nx">req</span><span class="tok-p">.</span><span class="tok-nx">statusText</span><span class="tok-p">));</span>	<i class="conum" data-value="3"></i><b>(3)</b>
      <span class="tok-p">}</span>
    <span class="tok-p">};</span>

    <span class="tok-nx">req</span><span class="tok-p">.</span><span class="tok-nx">onerror</span> <span class="tok-o">=</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>	<i class="conum" data-value="4"></i><b>(4)</b>
      <span class="tok-nx">reject</span><span class="tok-p">(</span><span class="tok-nb">Error</span><span class="tok-p">(</span><span class="tok-s2">&quot;Error de Red&quot;</span><span class="tok-p">));</span>
    <span class="tok-p">};</span>

    <span class="tok-nx">req</span><span class="tok-p">.</span><span class="tok-nx">send</span><span class="tok-p">();</span>
  <span class="tok-p">});</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Devolvemos una promesa</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Si la petición ha ido bien, resolvemos la promesa</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>En cambio, si ha fallado, la rechazamos</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Controlamos los posibles errores de red</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Hecho esto, podemos realizar las peticiones del siguiente modo:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo <code>then</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">ajaxUA</span><span class="tok-p">(</span><span class="tok-s1">&#39;heroes.json&#39;</span><span class="tok-p">).</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">response</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;¡Bien!&quot;</span><span class="tok-p">,</span> <span class="tok-nx">response</span><span class="tok-p">);</span>
<span class="tok-p">},</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">error</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">error</span><span class="tok-p">(</span><span class="tok-s2">&quot;¡Mal!&quot;</span><span class="tok-p">,</span> <span class="tok-nx">error</span><span class="tok-p">);</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Gracias al encadenamiento de promesas, podemos obtener el texto de una petición AJAX del siguiente modo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">ajaxUA</span><span class="tok-p">(</span><span class="tok-s1">&#39;heroes.json&#39;</span><span class="tok-p">).</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">response</span><span class="tok-p">)</span> <span class="tok-p">{</span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="tok-k">return</span> <span class="tok-nx">JSON</span><span class="tok-p">.</span><span class="tok-nx">parse</span><span class="tok-p">(</span><span class="tok-nx">response</span><span class="tok-p">);</span>
<span class="tok-p">}).</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">response</span><span class="tok-p">)</span> <span class="tok-p">{</span>  <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;JSON de Heroes:&quot;</span><span class="tok-p">,</span> <span class="tok-nx">response</span><span class="tok-p">);</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Recibe la respuesta JSON</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Recibe el objeto JavaScript parseado</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Además, como <code>JSON.parse</code> recibe un único argumento y devuelve el texto transformado, podemos simplicarlo del siguiente modo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">ajaxUA</span><span class="tok-p">(</span><span class="tok-s1">&#39;heroes.json&#39;</span><span class="tok-p">).</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-nx">JSON</span><span class="tok-p">.</span><span class="tok-nx">parse</span><span class="tok-p">).</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">response</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;JSON de Heroes:&quot;</span><span class="tok-p">,</span> <span class="tok-nx">response</span><span class="tok-p">);</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_encadenando_promesas">8.2.6. Encadenando promesas</h4>
<div class="paragraph">
<p>Acabamos de ver que tanto <code>then</code> como <code>catch</code> devuelven una promesa, lo que facilita su encadenamiento, aunque no devuelven una referencia a la misma promesa. Cada vez que se llama a uno de estos métodos se crea una nueva promesa y se devuelve, siendo estas dos promesas diferentes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">p1</span><span class="tok-p">,</span><span class="tok-nx">p2</span><span class="tok-p">;</span>

<span class="tok-nx">p1</span> <span class="tok-o">=</span> <span class="tok-nx">Promise</span><span class="tok-p">.</span><span class="tok-nx">resolve</span><span class="tok-p">();</span>
<span class="tok-nx">p2</span> <span class="tok-o">=</span> <span class="tok-nx">p1</span><span class="tok-p">.</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-c1">// ....</span>
<span class="tok-p">});</span>
<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">p1</span> <span class="tok-o">!==</span> <span class="tok-nx">p2</span><span class="tok-p">);</span>  <span class="tok-c1">// true</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Gracias a esto podemos encadenar promesas con el resultado de un paso anterior:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">paso1</span><span class="tok-p">().</span><span class="tok-nx">then</span><span class="tok-p">(</span>
  <span class="tok-kd">function</span> <span class="tok-nx">paso2</span><span class="tok-p">(</span><span class="tok-nx">resultadoPaso1</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-c1">// Acciones paso 2</span>
  <span class="tok-p">}</span>
<span class="tok-p">).</span><span class="tok-nx">then</span><span class="tok-p">(</span>
  <span class="tok-kd">function</span> <span class="tok-nx">paso3</span><span class="tok-p">(</span><span class="tok-nx">resultadoPaso2</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-c1">// Acciones paso 3</span>
  <span class="tok-p">}</span>
<span class="tok-p">).</span><span class="tok-nx">then</span><span class="tok-p">(</span>
  <span class="tok-kd">function</span> <span class="tok-nx">paso4</span><span class="tok-p">(</span><span class="tok-nx">resultadoPaso3</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-c1">// Acciones paso 3</span>
  <span class="tok-p">}</span>
<span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cada llamada a <code>then</code> devuelve una nueva promesa que podemos emplear para adjuntarla a otro <em>callback</em>. Sea cual sea el valor que devuelve el <em>callback</em> resuelve la nueva promesa. Mediante este patrón podemos hacer que cada paso envíe su valor devuelto al siguiente paso.</p>
</div>
<div class="paragraph">
<p>Si un paso devuelve una promesa en vez de un valor, el siguiente paso recibe el valor empleado para completar la promesa. Veamos este caso mediante un ejemplo:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo Encadenado de Promesas: <a href="http://jsbin.com/pibahakawi/edit?js,console" class="bare">http://jsbin.com/pibahakawi/edit?js,console</a></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">Promise</span><span class="tok-p">.</span><span class="tok-nx">resolve</span><span class="tok-p">(</span><span class="tok-s1">&#39;Hola!&#39;</span><span class="tok-p">).</span><span class="tok-nx">then</span><span class="tok-p">(</span>
  <span class="tok-kd">function</span> <span class="tok-nx">paso2</span><span class="tok-p">(</span><span class="tok-nx">resultado</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;Recibido paso 2: &#39;</span> <span class="tok-o">+</span> <span class="tok-nx">resultado</span><span class="tok-p">);</span>
    <span class="tok-k">return</span> <span class="tok-s1">&#39;Saludos desde el paso 2&#39;</span><span class="tok-p">;</span>               <span class="tok-c1">// Devolvemos un valor</span>
  <span class="tok-p">}</span>
<span class="tok-p">).</span><span class="tok-nx">then</span><span class="tok-p">(</span>
  <span class="tok-kd">function</span> <span class="tok-nx">paso3</span><span class="tok-p">(</span><span class="tok-nx">resultado</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;Recibido paso 3: &#39;</span> <span class="tok-o">+</span> <span class="tok-nx">resultado</span><span class="tok-p">);</span>     <span class="tok-c1">// No devolvemos nada</span>
  <span class="tok-p">}</span>
<span class="tok-p">).</span><span class="tok-nx">then</span><span class="tok-p">(</span>
  <span class="tok-kd">function</span> <span class="tok-nx">paso4</span><span class="tok-p">(</span><span class="tok-nx">resultado</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;Recibido paso 4: &#39;</span> <span class="tok-o">+</span> <span class="tok-nx">resultado</span><span class="tok-p">);</span>
    <span class="tok-k">return</span> <span class="tok-nx">Promise</span><span class="tok-p">.</span><span class="tok-nx">resolve</span><span class="tok-p">(</span><span class="tok-s1">&#39;Valor completado&#39;</span><span class="tok-p">);</span>    <span class="tok-c1">// Devuelve una promesa</span>
  <span class="tok-p">}</span>
<span class="tok-p">).</span><span class="tok-nx">then</span><span class="tok-p">(</span>
  <span class="tok-kd">function</span> <span class="tok-nx">paso5</span><span class="tok-p">(</span><span class="tok-nx">resultado</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s1">&#39;Recibido paso 5: &#39;</span> <span class="tok-o">+</span> <span class="tok-nx">resultado</span><span class="tok-p">);</span>
  <span class="tok-p">}</span>
<span class="tok-p">);</span>

<span class="tok-c1">// Consola</span>
<span class="tok-c1">// &quot;Recibido paso 2: Hola!&quot;</span>
<span class="tok-c1">// &quot;Recibido paso 3: Saludos desde el paso 2&quot;</span>
<span class="tok-c1">// &quot;Recibido paso 4: undefined&quot;</span>
<span class="tok-c1">// &quot;Recibido paso 5: Valor completado&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Al devolver un valor de manera explícita como en el paso dos, la promesa se resuelve. Como el paso 3 no devuelve ningún valor, la promesa se completa con <code>undefined</code>. Y el valor devuelto por el paso 4 completa la promesa que envuelve el paso 4.</p>
</div>
</div>
<div class="sect3">
<h4 id="_orden_de_ejecución_de_em_callbacks_em">8.2.7. Orden de ejecución de <em>callbacks</em></h4>
<div class="paragraph">
<p>Los promesas permiten gestionar el orden en el que se ejecuta el codigo respecto a otras tareas. Hay que distinguir bien entre qué elementos se ejecutan de manera síncrona, y cuales asíncronos.</p>
</div>
<div class="paragraph">
<p>La función <code>resolver</code> que se le pasa al constructor de <code>Promise</code> se ejecuta de manera síncrona. En cambio, todos los <em>callbacks</em> que se le pasan a <code>then</code> y a <code>catch</code> se invocan de manera asíncrona.</p>
</div>
<div class="paragraph">
<p>Veamoslo con un ejemplo:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo orden de ejecución</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">promesa</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Promise</span><span class="tok-p">(</span><span class="tok-kd">function</span> <span class="tok-p">(</span><span class="tok-nx">resolver</span><span class="tok-p">,</span> <span class="tok-nx">rechazar</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;Antes de la funcion resolver&quot;</span><span class="tok-p">);</span>
  <span class="tok-nx">resolver</span><span class="tok-p">();</span>
<span class="tok-p">});</span>

<span class="tok-nx">promesa</span><span class="tok-p">.</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;Dentro del callback de completado&quot;</span><span class="tok-p">);</span>
<span class="tok-p">});</span>

<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;Fin de la cita&quot;</span><span class="tok-p">);</span>

<span class="tok-c1">// Consola</span>
<span class="tok-c1">// Antes de la funcion resolver</span>
<span class="tok-c1">// Fin de la cita</span>
<span class="tok-c1">// Dentro del callback de completado</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_gestión_de_errores">8.2.8. Gestión de errores</h4>
<div class="paragraph">
<p>Los rechazos y los errores se propagan a través de la cadena de promesas. Cuando se rechaza una promesa, todas las siguientes promesas de la cadena se rechazan como si fuera un dominó. Para detener el efecto dominó, debemos capturar el rechazo.</p>
</div>
<div class="paragraph">
<p>Para ello, además de utilizar el método <code>then</code> y pasar como segundo argumento la función para gestionar los errores, el API nos ofrece el método <code>catch</code>:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo <code>catch</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">ajaxUA</span><span class="tok-p">(</span><span class="tok-s1">&#39;heroes.json&#39;</span><span class="tok-p">).</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">response</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;¡Bien!&quot;</span><span class="tok-p">,</span> <span class="tok-nx">response</span><span class="tok-p">);</span>
<span class="tok-p">}).</span><span class="tok-k">catch</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">error</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">error</span><span class="tok-p">(</span><span class="tok-s2">&quot;¡Mal!&quot;</span><span class="tok-p">,</span> <span class="tok-nx">error</span><span class="tok-p">);</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
En la práctica, se utiliza un método <code>catch</code> al final de la cadena para manejar todos los rechazos.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Veamos como utilizar un <code>catch</code> al final de una cadena de promesas:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo <code>catch</code> al final de una cadena de promesas</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">Promise</span><span class="tok-p">.</span><span class="tok-nx">reject</span><span class="tok-p">(</span><span class="tok-nb">Error</span><span class="tok-p">(</span><span class="tok-s2">&quot;Algo ha ido mal&quot;</span><span class="tok-p">)).</span><span class="tok-nx">then</span><span class="tok-p">(</span>  <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="tok-kd">function</span> <span class="tok-nx">paso2</span><span class="tok-p">()</span> <span class="tok-p">{</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;Por aquí no pasaré&quot;</span><span class="tok-p">);</span>
  <span class="tok-p">}</span>
<span class="tok-p">).</span><span class="tok-nx">then</span><span class="tok-p">(</span>
  <span class="tok-kd">function</span> <span class="tok-nx">paso3</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;Y por aquí tampoco&quot;</span><span class="tok-p">);</span>
  <span class="tok-p">}</span>
<span class="tok-p">).</span><span class="tok-k">catch</span><span class="tok-p">(</span>  <i class="conum" data-value="3"></i><b>(3)</b>
  <span class="tok-kd">function</span> <span class="tok-p">(</span><span class="tok-nx">err</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">error</span><span class="tok-p">(</span><span class="tok-s2">&quot;Algo ha fallado por el camino&quot;</span><span class="tok-p">);</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">error</span><span class="tok-p">(</span><span class="tok-nx">err</span><span class="tok-p">);</span>
  <span class="tok-p">}</span>
<span class="tok-p">);</span>

<span class="tok-c1">// Consola</span>
<span class="tok-c1">// Algo ha fallado por el camino</span>
<span class="tok-c1">// Error: Algo ha ido mal</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Creamos una promesa rechazada</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>No se ejectuan ni el paso 2, ni el 3, ya que la promesa no se ha cumplido</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>En cambio, si lo hace el manejador del error.</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_excepciones_y_promesas">Excepciones y promesas</h5>
<div class="paragraph">
<p>Una promesa se rechaza si se hace de manera explicita mediante la función <code>rechazar</code> del constructor, con <code>Promise.reject</code> o si el <em>callback</em> pasado a <code>then</code> lanza un error:</p>
</div>
<div class="paragraph">
<p>Vamos a repetir el ejemplo, pero lanzando un <code>Error</code> en el constructor de la promesa:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo <code>catch</code> con <code>Error</code> lanzado por el constructor</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">rechazarCon</span><span class="tok-p">(</span><span class="tok-s2">&quot;¡Malas noticias!&quot;</span><span class="tok-p">).</span><span class="tok-nx">then</span><span class="tok-p">(</span>
  <span class="tok-kd">function</span> <span class="tok-nx">paso2</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;Por aquí no pasaré&quot;</span><span class="tok-p">)</span>
  <span class="tok-p">}</span>
<span class="tok-p">).</span><span class="tok-k">catch</span><span class="tok-p">(</span>
  <span class="tok-kd">function</span> <span class="tok-p">(</span><span class="tok-nx">err</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">error</span><span class="tok-p">(</span><span class="tok-s2">&quot;Y vuelve a fallar&quot;</span><span class="tok-p">);</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">error</span><span class="tok-p">(</span><span class="tok-nx">err</span><span class="tok-p">);</span>
  <span class="tok-p">}</span>
<span class="tok-p">);</span>

<span class="tok-kd">function</span> <span class="tok-nx">rechazarCon</span><span class="tok-p">(</span><span class="tok-nx">cadena</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-k">return</span> <span class="tok-k">new</span> <span class="tok-nx">Promise</span><span class="tok-p">(</span><span class="tok-kd">function</span> <span class="tok-p">(</span><span class="tok-nx">resolver</span><span class="tok-p">,</span> <span class="tok-nx">rechazar</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-k">throw</span> <span class="tok-nb">Error</span><span class="tok-p">(</span><span class="tok-nx">cadena</span><span class="tok-p">);</span>
    <span class="tok-nx">resolver</span><span class="tok-p">(</span><span class="tok-s2">&quot;No se utiliza&quot;</span><span class="tok-p">);</span>
  <span class="tok-p">});</span>
<span class="tok-p">}</span>
<span class="tok-c1">// Consola</span>
<span class="tok-c1">// Y vuelve a fallar</span>
<span class="tok-c1">// Error: ¡Malas noticias!</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Este comportamiento resalta la ventaja de realizar todo el trabajo relacionado con la promesa dentro del callback del constructor, para que los errores se capturen automáticamente y se conviertan en rechazos.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Al lanzar el objeto <code>Error</code> para rechazar una promesa, la pila de llamadas se captura, lo que facilita el manejo del error en el manejador <code>catch</code>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Autoevaluación</div>
<div class="paragraph">
<p>A partir del siguiente código anterior, ¿Qué mensajes saldrán por pantalla? <span class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnote_2" title="View footnote.">2</a>]</span></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">promesaJSON</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Promise</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">resolver</span><span class="tok-p">,</span> <span class="tok-nx">rechazar</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nx">resolver</span><span class="tok-p">(</span><span class="tok-nx">JSON</span><span class="tok-p">.</span><span class="tok-nx">parse</span><span class="tok-p">(</span><span class="tok-s2">&quot;Esto no es JSON&quot;</span><span class="tok-p">));</span>
<span class="tok-p">});</span>

<span class="tok-nx">promesaJSON</span><span class="tok-p">.</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">datos</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;¡Bien!&quot;</span><span class="tok-p">,</span> <span class="tok-nx">datos</span><span class="tok-p">);</span>
<span class="tok-p">}).</span><span class="tok-k">catch</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">err</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">error</span><span class="tok-p">(</span><span class="tok-s2">&quot;¡Mal!&quot;</span><span class="tok-p">,</span> <span class="tok-nx">err</span><span class="tok-p">);</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="__code_catch_code_vs_code_then_undefined_función_code"><code>catch</code> vs <code>then(undefined, función)</code></h5>
<div class="paragraph">
<p>El método <code>catch</code> es similar a emplear <code>then(undefined, función)</code>, pero más legible. Por lo tanto, el anterior fragmento (Ejemplo <code>catch</code>) es equivalente a este:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo <code>then(undefined, función)</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">ajaxUA</span><span class="tok-p">(</span><span class="tok-s1">&#39;heroes.json&#39;</span><span class="tok-p">).</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">response</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;¡Bien!&quot;</span><span class="tok-p">,</span> <span class="tok-nx">response</span><span class="tok-p">);</span>
<span class="tok-p">}).</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kc">undefined</span><span class="tok-p">,</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">error</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">error</span><span class="tok-p">(</span><span class="tok-s2">&quot;¡Mal!&quot;</span><span class="tok-p">,</span> <span class="tok-nx">error</span><span class="tok-p">);</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pero que sean similares no significan que sean iguales. Hay una sutil diferencia entre encadenar dos funciones <code>then</code> a hacerlo con una sola. Al rechazar una promesa se pasa al siguiente <code>then</code> con un callback de rechazo (o <code>catch</code>, ya que son equivalentes). Es decir, con <code>then(func1, func2)</code>, se llamará a <em>func1</em> o a <em>func2</em>, nunca a las dos. Pero con
<code>then(func1).catch(func2)</code>, se llamarán a ambas si <em>func1</em> rechaza la promesa, ya que son pasos separados de la cadena.</p>
</div>
<div class="paragraph">
<p>Veamoslo con otro ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">paso1</span><span class="tok-p">().</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-k">return</span> <span class="tok-nx">paso2</span><span class="tok-p">();</span>
<span class="tok-p">}).</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-k">return</span> <span class="tok-nx">paso3</span><span class="tok-p">();</span>
<span class="tok-p">}).</span><span class="tok-k">catch</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">err</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-k">return</span> <span class="tok-nx">recuperacion1</span><span class="tok-p">();</span>
<span class="tok-p">}).</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-k">return</span> <span class="tok-nx">paso4</span><span class="tok-p">();</span>
  <span class="tok-p">},</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">err</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-k">return</span> <span class="tok-nx">recuperacion2</span><span class="tok-p">();</span>
<span class="tok-p">}).</span><span class="tok-k">catch</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">err</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">error</span><span class="tok-p">(</span><span class="tok-s2">&quot;No me importa nada&quot;</span><span class="tok-p">);</span>
<span class="tok-p">}).</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;¡Finiquitado!&quot;</span><span class="tok-p">);</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Este flujo de llamadas es muy similar a emplear <em>try/catch</em> en el lenguaje estandard de manera que los errores que suceden dentro de un <code>try</code> saltan inmediatamanete al bloque <code>catch</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_promesas_en_paralelo">8.2.9. Promesas en paralelo</h4>
<div class="paragraph">
<p>Si tenemos un conjunto de promesas que queremos ejecutar, y lo hacemos mediante un bucle, se ejecutarán en paralelo, en un orden indeterminado finalizando cada una conforme al tiempo necesario por cada tarea.</p>
</div>
<div class="paragraph">
<p>Supongamos que tenemos una aplicación bancaria en la cual tenemos varias cuentas, de manera que cuando el usuario entra en la aplicación, se le muestra el saldo de cada una de ellas:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo promesas en paralelo</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">cuentas</span> <span class="tok-o">=</span> <span class="tok-p">[</span><span class="tok-s2">&quot;/banco1/12345678&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;/banco2/13572468&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;/banco3/87654321&quot;</span><span class="tok-p">];</span>

<span class="tok-nx">cuentas</span><span class="tok-p">.</span><span class="tok-nx">forEach</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">cuenta</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nx">ajaxUA</span><span class="tok-p">(</span><span class="tok-nx">cuenta</span><span class="tok-p">).</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">balance</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">cuenta</span> <span class="tok-o">+</span> <span class="tok-s2">&quot; Balance -&gt; &quot;</span> <span class="tok-o">+</span> <span class="tok-nx">balance</span><span class="tok-p">);</span>
  <span class="tok-p">});</span>
<span class="tok-p">});</span>

<span class="tok-c1">// Consola</span>
<span class="tok-c1">// Banco 1 Balance -&gt; 234</span>
<span class="tok-c1">// Banco 3 Balance -&gt; 1546</span>
<span class="tok-c1">// Banco 2 Balance -&gt; 789</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si además queremos mostrar un mensaje cuando se hayan consultado todas las cuentas, necesitamos consolidar todas las promesas en una nueva. Para ello, mediante el método <code>Promise.all</code>, podemos escribir código de finalización de tareas paralelas, del tipo "<em>Cuando todas estas cosas hayan finalizado, haz esta otra</em>".</p>
</div>
<div class="paragraph">
<p>El comportamiento de <code>Promise.all(arrayDePromesas).then(function(arrayDeResultados)</code> es el siguiente: devuelve una nueva promesa que se cumplirá cuando lo hayan hecho todas las promesas recibidas. Si alguna se rechaza, la nueva promesa también se rechazará. El resultado es un array de resultados que siguen el mismo orden de las promesas recibidas.</p>
</div>
<div class="paragraph">
<p>Así pues, reescribimos el ejemplo y tendremos:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo promesas en paralelo, finalización única</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">cuentas</span> <span class="tok-o">=</span> <span class="tok-p">[</span><span class="tok-s2">&quot;/banco1/12345678&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;/banco2/13572468&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;/banco3/87654321&quot;</span><span class="tok-p">];</span>

<span class="tok-kd">var</span> <span class="tok-nx">peticiones</span> <span class="tok-o">=</span> <span class="tok-nx">cuentas</span><span class="tok-p">.</span><span class="tok-nx">map</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">cuenta</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-k">return</span> <span class="tok-nx">ajaxUA</span><span class="tok-p">(</span><span class="tok-nx">cuenta</span><span class="tok-p">);</span>
<span class="tok-p">});</span>

<span class="tok-nx">Promise</span><span class="tok-p">.</span><span class="tok-nx">all</span><span class="tok-p">(</span><span class="tok-nx">peticiones</span><span class="tok-p">).</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span> <span class="tok-p">(</span><span class="tok-nx">balances</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;Los &quot;</span> <span class="tok-o">+</span> <span class="tok-nx">balances</span><span class="tok-p">.</span><span class="tok-nx">length</span> <span class="tok-o">+</span> <span class="tok-s2">&quot; han sido actualizados&quot;</span><span class="tok-p">);</span>
<span class="tok-p">}).</span><span class="tok-k">catch</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">err</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">error</span><span class="tok-p">(</span><span class="tok-s2">&quot;Error al recuperar los balances&quot;</span><span class="tok-p">,</span> <span class="tok-nx">err</span><span class="tok-p">);</span>
<span class="tok-p">})</span>
<span class="tok-c1">// Consola</span>
<span class="tok-c1">// Los 3 balances han sido actualizados</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_promesas_en_secuencia">8.2.10. Promesas en secuencia</h4>
<div class="paragraph">
<p>Cuando hemos estudiado como encadenar promesas, hemos visto como podemos codificar que una promesa se ejecute cuando ha finalizado la anterior. Para ello, de antemano tenemos que saber las promesas que vamos a gestionar.</p>
</div>
<div class="paragraph">
<p>¿Y si el número de promesas es indeterminado? Es decir, si tenemos un array con las promesas que se tienen que ejecutar secuancialmente ¿Cómo puedo hacerlo?</p>
</div>
<div class="paragraph">
<p>Una solución es hacerlo mediante un bucle iterativo:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo promesas en secuencia, mediante <code>reduce</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">function</span> <span class="tok-nx">secuencia</span><span class="tok-p">(</span><span class="tok-nx">array</span><span class="tok-p">,</span> <span class="tok-nx">callback</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-kd">var</span> <span class="tok-nx">seq</span> <span class="tok-o">=</span> <span class="tok-nx">Promise</span><span class="tok-p">.</span><span class="tok-nx">resolve</span><span class="tok-p">();</span>

  <span class="tok-nx">array</span><span class="tok-p">.</span><span class="tok-nx">forEach</span><span class="tok-p">(</span><span class="tok-kd">function</span> <span class="tok-p">(</span><span class="tok-nx">elem</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nx">seq</span> <span class="tok-o">=</span> <span class="tok-nx">seq</span><span class="tok-p">.</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span> <i class="conum" data-value="1"></i><b>(1)</b>
      <span class="tok-k">return</span> <span class="tok-nx">callback</span><span class="tok-p">(</span><span class="tok-nx">elem</span><span class="tok-p">);</span>
    <span class="tok-p">});</span>
  <span class="tok-p">});</span>
<span class="tok-p">}</span>

<span class="tok-nx">secuencia</span><span class="tok-p">(</span><span class="tok-nx">cuentas</span><span class="tok-p">,</span> <span class="tok-kd">function</span> <span class="tok-p">(</span><span class="tok-nx">cuenta</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-k">return</span> <span class="tok-nx">ajaxUA</span><span class="tok-p">(</span><span class="tok-nx">cuenta</span><span class="tok-p">).</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">balance</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">cuenta</span> <span class="tok-o">+</span> <span class="tok-s2">&quot; Balance -&gt; &quot;</span> <span class="tok-o">+</span> <span class="tok-nx">balance</span><span class="tok-p">);</span>
  <span class="tok-p">});</span>
<span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>en cada iteración, <code>seq</code> contiene el valor de la secuencia anterior hasta que se resuelve y almacena la nueva promesa</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si empleamos la función <code>reduce</code>, el código se reduce al ahorrarnos la variable <code>seq</code>:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo promesas en secuencia, mediante <code>reduce</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">function</span> <span class="tok-nx">secuencia</span><span class="tok-p">(</span><span class="tok-nx">array</span><span class="tok-p">,</span> <span class="tok-nx">callback</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-k">return</span> <span class="tok-nx">array</span><span class="tok-p">.</span><span class="tok-nx">reduce</span><span class="tok-p">(</span><span class="tok-kd">function</span> <span class="tok-nx">cadena</span><span class="tok-p">(</span><span class="tok-nx">promesa</span><span class="tok-p">,</span> <span class="tok-nx">elem</span><span class="tok-p">)</span> <span class="tok-p">{</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-k">return</span> <span class="tok-nx">promesa</span><span class="tok-p">.</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
      <span class="tok-k">return</span> <span class="tok-nx">callback</span><span class="tok-p">(</span><span class="tok-nx">elem</span><span class="tok-p">);</span>
    <span class="tok-p">});</span>
  <span class="tok-p">},</span> <span class="tok-nx">Promise</span><span class="tok-p">.</span><span class="tok-nx">resolve</span><span class="tok-p">());</span>  <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>La variable <code>promesa</code> almacena el valor anterior. La función <code>cadena</code> siempre devuelve una promesa que resuelve el <code>callback</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>El array se reduce hasta finalizarlo y devolver la última promesa de la cadena</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En cambio, mediante código recursivo, pese a que pensemos que podemos desbordar la pila, cada llamada se coloca encima de la pila, de manera que el bucle de eventos la resuelve en primer lugar:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo promesas en secuencia, mediante recursión</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">function</span> <span class="tok-nx">secuencia</span><span class="tok-p">(</span><span class="tok-nx">array</span><span class="tok-p">,</span> <span class="tok-nx">callback</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-kd">function</span> <span class="tok-nx">cadena</span><span class="tok-p">(</span><span class="tok-nx">array</span><span class="tok-p">,</span> <span class="tok-nx">indice</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">indice</span> <span class="tok-o">===</span> <span class="tok-nx">array</span><span class="tok-p">.</span><span class="tok-nx">length</span><span class="tok-p">)</span> <span class="tok-p">{</span>
      <span class="tok-k">return</span> <span class="tok-nx">Promise</span><span class="tok-p">.</span><span class="tok-nx">resolve</span><span class="tok-p">();</span>
    <span class="tok-p">}</span> <span class="tok-k">else</span> <span class="tok-p">{</span>
      <span class="tok-k">return</span> <span class="tok-nx">Promise</span><span class="tok-p">.</span><span class="tok-nx">resolve</span><span class="tok-p">(</span><span class="tok-nx">callback</span><span class="tok-p">(</span><span class="tok-nx">array</span><span class="tok-p">[</span><span class="tok-nx">indice</span><span class="tok-p">])).</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
        <span class="tok-k">return</span> <span class="tok-nx">cadena</span><span class="tok-p">(</span><span class="tok-nx">array</span><span class="tok-p">,</span> <span class="tok-nx">indice</span> <span class="tok-o">+</span> <span class="tok-mi">1</span><span class="tok-p">);</span>
      <span class="tok-p">});</span>
    <span class="tok-p">}</span>
  <span class="tok-p">}</span>
  <span class="tok-k">return</span> <span class="tok-nx">cadena</span><span class="tok-p">(</span><span class="tok-nx">array</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Aunque ambos planteamientos obtengan el mismo resultado, los dos enfoques tienen sus diferencias. Mientras que mediante el bucle se contruye la cadena entera de promesas sin esperar a que se resuelvan, mediante el planteamiento recursivo, las promesas se añaden bajo demanda tras resolver la promesa anterior. Así pues, el enfoque recursivo permite decidir si continuar o romper la cadena en base al resultado de una promesa anterior.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Las librerías de terceros que permiten gestionar las promesas ofrecen funciones auxiliares para trabajar con promesas en secuencia o de manera paralela.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_carrera_de_promesas">8.2.11. Carrera de promesas</h4>
<div class="paragraph">
<p>En ocasiones vamos a realizar diferentes peticiones que realizan la misma acción a diferentes servicios, pero sólo nos interesará el que nos devuelve el resultado más rápidamente.</p>
</div>
<div class="paragraph">
<p>Para ello, el API ofrece el método <code>Promise.race(arrayDePromesas)</code>, la cual reduce el array de promesas y devuelve una nueva promesa con el primer valor disponible. Es decir, se examina cada promesa hasta que una de ellas finaliza, ya sea resuelta o rechazada, la cual se devuelve.</p>
</div>
<div class="paragraph">
<p>Mediante esta operación, podemos crear un mecanismo para gestionar la latencia de una petición a servidor, de manera que si tarda más de X segundos, acceda a una caché. En el caso de que falle la cache, el mecanismo fallará.</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo de carrera de promesas</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">function</span> <span class="tok-nx">obtenerDatos</span><span class="tok-p">(</span><span class="tok-nx">url</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-kd">var</span> <span class="tok-nx">tiempo</span> <span class="tok-o">=</span> <span class="tok-mi">500</span><span class="tok-p">;</span>  <span class="tok-c1">// ms</span>
  <span class="tok-kd">var</span> <span class="tok-nx">caduca</span> <span class="tok-o">=</span> <span class="tok-nb">Date</span><span class="tok-p">.</span><span class="tok-nx">now</span><span class="tok-p">()</span> <span class="tok-o">+</span> <span class="tok-nx">tiempo</span><span class="tok-p">;</span>

  <span class="tok-kd">var</span> <span class="tok-nx">datosServer</span> <span class="tok-o">=</span> <span class="tok-nx">ajaxUA</span><span class="tok-p">(</span><span class="tok-nx">url</span><span class="tok-p">);</span>

  <span class="tok-kd">var</span> <span class="tok-nx">datosCache</span> <span class="tok-o">=</span> <span class="tok-nx">buscarEnCache</span><span class="tok-p">(</span><span class="tok-nx">url</span><span class="tok-p">).</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span> <span class="tok-p">(</span><span class="tok-nx">datos</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-k">return</span> <span class="tok-k">new</span> <span class="tok-nx">Promise</span><span class="tok-p">(</span><span class="tok-kd">function</span> <span class="tok-p">(</span><span class="tok-nx">resolver</span><span class="tok-p">,</span> <span class="tok-nx">rechazar</span><span class="tok-p">)</span> <span class="tok-p">{</span>
      <span class="tok-kd">var</span> <span class="tok-nx">lapso</span> <span class="tok-o">=</span> <span class="tok-nb">Math</span><span class="tok-p">.</span><span class="tok-nx">max</span><span class="tok-p">(</span><span class="tok-nx">caduca</span><span class="tok-o">:</span> <span class="tok-nb">Date</span><span class="tok-p">.</span><span class="tok-nx">now</span><span class="tok-p">(),</span> <span class="tok-mi">0</span><span class="tok-p">);</span>
      <span class="tok-nx">setTimeout</span><span class="tok-p">(</span><span class="tok-kd">function</span> <span class="tok-p">()</span> <span class="tok-p">{</span>
        <span class="tok-nx">resolver</span><span class="tok-p">(</span><span class="tok-nx">datos</span><span class="tok-p">);</span>
      <span class="tok-p">},</span> <span class="tok-nx">lapso</span><span class="tok-p">);</span>
    <span class="tok-p">})</span>
  <span class="tok-p">});</span>

  <span class="tok-kd">var</span> <span class="tok-nx">fallo</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Promise</span><span class="tok-p">(</span><span class="tok-kd">function</span> <span class="tok-p">(</span><span class="tok-nx">resolver</span><span class="tok-p">,</span> <span class="tok-nx">rechazar</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nx">setTimeout</span><span class="tok-p">(</span><span class="tok-kd">function</span> <span class="tok-p">()</span> <span class="tok-p">{</span>
      <span class="tok-nx">rechazar</span><span class="tok-p">(</span><span class="tok-k">new</span> <span class="tok-nb">Error</span><span class="tok-p">(</span><span class="tok-s2">&quot;No se ha podido recuperar los datos de &quot;</span> <span class="tok-o">+</span> <span class="tok-nx">url</span><span class="tok-p">));</span>
    <span class="tok-p">},</span> <span class="tok-nx">tiempo</span><span class="tok-p">);</span>
  <span class="tok-p">});</span>

  <span class="tok-k">return</span> <span class="tok-nx">Promse</span><span class="tok-p">.</span><span class="tok-nx">race</span><span class="tok-p">([</span><span class="tok-nx">datosServer</span><span class="tok-p">,</span> <span class="tok-nx">datosCache</span><span class="tok-p">,</span> <span class="tok-nx">fallo</span><span class="tok-p">]);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Se trata de una solución simplificada, donde se ha omitido el código de <code>buscarEnCache</code>, y no se han planteado todos los escenarios posibles.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Autoevaluación</div>
<div class="paragraph">
<p>¿Qué pasaría se la petición a los datos del servidor falla inmediatamente debido a un fallo de red? <span class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnote_3" title="View footnote.">3</a>]</span></p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Librerías de programación reactiva como RxJS, Bacon.js y Kefir.js están diseñadas especificamente para estos escenarios
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_fetch_api">8.3. Fetch API</h3>
<div class="paragraph">
<p>Aprovechando las promesas, ES6 ofrece el Fetch API para realizar peticiones AJAX que directamente devuelvan un promesa. Es decir, ya no se emplea el objeto <code>XMLHttpRequest</code>, el cual no se creó con AJAX en mente, sino una serie de métodos y objetos diseñados para tal fin. Al emplear promesas, el código es más sencillo y limpio, evitando los <em>callbacks</em> anidados.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Actualmente, el API lo soportan tanto <em>Google Chrome</em> como <em>Mozilla Firefox</em>. Podéis comprobar el resto de navegadores en <a href="http://caniuse.com/#search=fetch" class="bare">http://caniuse.com/#search=fetch</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El objeto <code>window</code> ofrece el método <code>fetch</code>, con un primer argumento con la URL de la petición, y un segundo opcional con un objeto literal que permite configurar la petición:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo Fetch API</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-c1">// url (obligatorio), opciones (opcional)</span>
<span class="tok-nx">fetch</span><span class="tok-p">(</span><span class="tok-s1">&#39;/ruta/url&#39;</span><span class="tok-p">,</span> <span class="tok-p">{</span>
	<span class="tok-nx">method</span><span class="tok-o">:</span> <span class="tok-s1">&#39;get&#39;</span>
<span class="tok-p">}).</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">respuesta</span><span class="tok-p">)</span> <span class="tok-p">{</span>

<span class="tok-p">}).</span><span class="tok-k">catch</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">err</span><span class="tok-p">)</span> <span class="tok-p">{</span>
	<span class="tok-c1">// Error :(</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_hola_em_fetch_em">8.3.1. Hola <em>Fetch</em></h4>
<div class="paragraph">
<p>A modo de ejemplo, vamos a reescibir el ejemplo de la sesión 5 que hacíamos uso de AJAX, pero ahora con la <em>Fetch API</em>. De esta manera, el código queda mucho más concreto:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">fetch</span><span class="tok-p">(</span><span class="tok-s1">&#39;http://www.omdbapi.com/?s=batman&#39;</span><span class="tok-p">,</span> <span class="tok-p">{</span>
    <span class="tok-nx">method</span><span class="tok-o">:</span> <span class="tok-s1">&#39;get&#39;</span>
<span class="tok-p">}).</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">respuesta</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-nx">respuesta</span><span class="tok-p">.</span><span class="tok-nx">ok</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-k">throw</span> <span class="tok-nb">Error</span><span class="tok-p">(</span><span class="tok-nx">respuesta</span><span class="tok-p">.</span><span class="tok-nx">statusText</span><span class="tok-p">);</span>
  <span class="tok-p">}</span>
  <span class="tok-k">return</span> <span class="tok-nx">respuesta</span><span class="tok-p">.</span><span class="tok-nx">json</span><span class="tok-p">();</span>
<span class="tok-p">}).</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">datos</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kd">var</span> <span class="tok-nx">pelis</span> <span class="tok-o">=</span> <span class="tok-nx">datos</span><span class="tok-p">.</span><span class="tok-nx">Search</span><span class="tok-p">;</span>
    <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-kd">var</span> <span class="tok-nx">numPeli</span> <span class="tok-k">in</span> <span class="tok-nx">pelis</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">pelis</span><span class="tok-p">[</span><span class="tok-nx">numPeli</span><span class="tok-p">].</span><span class="tok-nx">Title</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;: &quot;</span> <span class="tok-o">+</span> <span class="tok-nx">pelis</span><span class="tok-p">[</span><span class="tok-nx">numPeli</span><span class="tok-p">].</span><span class="tok-nx">Year</span><span class="tok-p">);</span>
    <span class="tok-p">}</span>
<span class="tok-p">}).</span><span class="tok-k">catch</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">err</span><span class="tok-p">)</span> <span class="tok-p">{</span>
	<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">error</span><span class="tok-p">(</span><span class="tok-s2">&quot;Error en Fetch de películas de Batman&quot;</span><span class="tok-p">,</span> <span class="tok-nx">err</span><span class="tok-p">);</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Como podemos observar, haciendo uso de las promesas, podemos encadenarlas y en el último paso comprobar los errores.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, podemos refactorizar el control de estado y extraelo a una función:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">function</span> <span class="tok-nx">estado</span><span class="tok-p">(</span><span class="tok-nx">respuesta</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">respuesta</span><span class="tok-p">.</span><span class="tok-nx">ok</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-k">return</span> <span class="tok-nx">Promise</span><span class="tok-p">.</span><span class="tok-nx">resolve</span><span class="tok-p">(</span><span class="tok-nx">respuesta</span><span class="tok-p">);</span>
  <span class="tok-p">}</span> <span class="tok-k">else</span> <span class="tok-p">{</span>
    <span class="tok-k">return</span> <span class="tok-nx">Promise</span><span class="tok-p">.</span><span class="tok-nx">reject</span><span class="tok-p">(</span><span class="tok-k">new</span> <span class="tok-nb">Error</span><span class="tok-p">(</span><span class="tok-nx">respuesta</span><span class="tok-p">.</span><span class="tok-nx">statusText</span><span class="tok-p">));</span>
  <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>De este modo, nuestro código quedaría así:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">fetch</span><span class="tok-p">(</span><span class="tok-s1">&#39;http://www.omdbapi.com/?s=batman&#39;</span><span class="tok-p">,</span> <span class="tok-p">{</span>
  <span class="tok-nx">method</span><span class="tok-o">:</span> <span class="tok-s1">&#39;get&#39;</span>
<span class="tok-p">}).</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-nx">estado</span><span class="tok-p">)</span>
<span class="tok-p">.</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span> <span class="tok-p">(</span><span class="tok-nx">respuesta</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-k">return</span> <span class="tok-nx">respuesta</span><span class="tok-p">.</span><span class="tok-nx">json</span><span class="tok-p">();</span>
<span class="tok-p">}).</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">datos</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-kd">var</span> <span class="tok-nx">pelis</span> <span class="tok-o">=</span> <span class="tok-nx">datos</span><span class="tok-p">.</span><span class="tok-nx">Search</span><span class="tok-p">;</span>
  <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-kd">var</span> <span class="tok-nx">numPeli</span> <span class="tok-k">in</span> <span class="tok-nx">pelis</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">pelis</span><span class="tok-p">[</span><span class="tok-nx">numPeli</span><span class="tok-p">].</span><span class="tok-nx">Title</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;: &quot;</span> <span class="tok-o">+</span> <span class="tok-nx">pelis</span><span class="tok-p">[</span><span class="tok-nx">numPeli</span><span class="tok-p">].</span><span class="tok-nx">Year</span><span class="tok-p">);</span>
  <span class="tok-p">}</span>
<span class="tok-p">}).</span><span class="tok-k">catch</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">err</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">error</span><span class="tok-p">(</span><span class="tok-s2">&quot;Error en Fetch de películas de Batman&quot;</span><span class="tok-p">,</span> <span class="tok-nx">err</span><span class="tok-p">);</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_cabeceras">8.3.2. Cabeceras</h4>
<div class="paragraph">
<p>Una ventaja de este API es la posibilidad de asignar las cabeceras de las peticiones mediante el objeto <code>Headers()</code>, el cual tiene una estructura similar a una mapa. A continuación se muestra un ejemplo de como acceder y manipular las cabeceras mediante los métodos <code>append</code>, <code>has</code>, <code>get</code>, <code>set</code> y <code>delete</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">headers</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Headers</span><span class="tok-p">();</span>

<span class="tok-nx">headers</span><span class="tok-p">.</span><span class="tok-nx">append</span><span class="tok-p">(</span><span class="tok-s1">&#39;Content-Type&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;text/plain&#39;</span><span class="tok-p">);</span>
<span class="tok-nx">headers</span><span class="tok-p">.</span><span class="tok-nx">append</span><span class="tok-p">(</span><span class="tok-s1">&#39;Mi-Cabecera-Personalizada&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;cualquierValor&#39;</span><span class="tok-p">);</span>

<span class="tok-nx">headers</span><span class="tok-p">.</span><span class="tok-nx">has</span><span class="tok-p">(</span><span class="tok-s1">&#39;Content-Type&#39;</span><span class="tok-p">);</span> <span class="tok-c1">// true</span>
<span class="tok-nx">headers</span><span class="tok-p">.</span><span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-s1">&#39;Content-Type&#39;</span><span class="tok-p">);</span> <span class="tok-c1">// &quot;text/plain&quot;</span>
<span class="tok-nx">headers</span><span class="tok-p">.</span><span class="tok-nx">set</span><span class="tok-p">(</span><span class="tok-s1">&#39;Content-Type&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;application/json&#39;</span><span class="tok-p">);</span>

<span class="tok-nx">headers</span><span class="tok-p">.</span><span class="tok-k">delete</span><span class="tok-p">(</span><span class="tok-s1">&#39;Mi-Cabecera-Personalizada&#39;</span><span class="tok-p">);</span>

<span class="tok-c1">// Add initial values</span>
<span class="tok-kd">var</span> <span class="tok-nx">headers</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Headers</span><span class="tok-p">({</span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="tok-s1">&#39;Content-Type&#39;</span><span class="tok-o">:</span> <span class="tok-s1">&#39;text/plain&#39;</span><span class="tok-p">,</span>
  <span class="tok-s1">&#39;Mi-Cabecera-Personalizada&#39;</span><span class="tok-o">:</span> <span class="tok-s1">&#39;cualquierValor&#39;</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para usar las cabeceras, las pasaremos como parámetro de creación de una petición mediante una instancia de <code>Request</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">peticion</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Request</span><span class="tok-p">(</span><span class="tok-s1">&#39;/url-peticion&#39;</span><span class="tok-p">,</span> <span class="tok-p">{</span>
  <span class="tok-nx">headers</span><span class="tok-o">:</span> <span class="tok-k">new</span> <span class="tok-nx">Headers</span><span class="tok-p">({</span>
    <span class="tok-s1">&#39;Content-Type&#39;</span><span class="tok-o">:</span> <span class="tok-s1">&#39;text/plain&#39;</span>
  <span class="tok-p">})</span>
<span class="tok-p">});</span>

<span class="tok-nx">fetch</span><span class="tok-p">(</span><span class="tok-nx">peticion</span><span class="tok-p">).</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span> <span class="tok-cm">/* manejar la respuesta */</span> <span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_petición">8.3.3. Petición</h4>
<div class="paragraph">
<p>Para poder configurar toda la información que representa una petición se emplea el objeto <code>Request</code>. Este objeto puede contener las siguientes propiedades:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>method</code>: <code>GET</code>, <code>POST</code>, <code>PUT</code>, <code>DELETE</code>, <code>HEAD</code></p>
</li>
<li>
<p><code>url</code>: URL de la petición</p>
</li>
<li>
<p><code>headers</code>: objeto Headers con las cabeceras asociadas</p>
</li>
<li>
<p><code>body</code>: datos a enviar con la petición</p>
</li>
<li>
<p><code>referrer</code>: <em>referrer</em> de la petición</p>
</li>
<li>
<p><code>mode</code>: <code>cors</code>, <code>no-cors</code>, <code>same-origin</code></p>
</li>
<li>
<p><code>credentials</code>: indica si se envian <em>cookies</em> con la petición: <code>include</code>, <code>omit</code>, <code>same-origin</code></p>
</li>
<li>
<p><code>redirect</code>: <code>follow</code>, <code>error</code>, <code>manual</code></p>
</li>
<li>
<p><code>integrity</code>: valor integridad del subrecurso</p>
</li>
<li>
<p><code>cache</code>: tipo de cache (<code>default</code>, <code>reload</code>, <code>no-cache</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Con estos parámetros, una petición puede quedar así:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">request</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Request</span><span class="tok-p">(</span><span class="tok-s1">&#39;/heroes.json&#39;</span><span class="tok-p">,</span> <span class="tok-p">{</span>
  <span class="tok-nx">method</span><span class="tok-o">:</span> <span class="tok-s1">&#39;get&#39;</span><span class="tok-p">,</span>
  <span class="tok-nx">mode</span><span class="tok-o">:</span> <span class="tok-s1">&#39;cors&#39;</span><span class="tok-p">,</span>
  <span class="tok-nx">headers</span><span class="tok-o">:</span> <span class="tok-k">new</span> <span class="tok-nx">Headers</span><span class="tok-p">({</span>
    <span class="tok-s1">&#39;Content-Type&#39;</span><span class="tok-o">:</span> <span class="tok-s1">&#39;text/plain&#39;</span>
  <span class="tok-p">})</span>
<span class="tok-p">});</span>

<span class="tok-nx">fetch</span><span class="tok-p">(</span><span class="tok-nx">request</span><span class="tok-p">).</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span> <span class="tok-cm">/* manejar la respuesta */</span> <span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Realmente, el método <code>fetch</code> recibe una URL a la que se envía una petición, y un objeto literal con la configuración de la petición, por lo que el código queda mejor así:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">fetch</span><span class="tok-p">(</span><span class="tok-s1">&#39;/heroes.json&#39;</span><span class="tok-p">,</span> <span class="tok-p">{</span>
  <span class="tok-nx">method</span><span class="tok-o">:</span> <span class="tok-s1">&#39;GET&#39;</span><span class="tok-p">,</span>
  <span class="tok-nx">mode</span><span class="tok-o">:</span> <span class="tok-s1">&#39;cors&#39;</span><span class="tok-p">,</span>
  <span class="tok-nx">headers</span><span class="tok-o">:</span> <span class="tok-k">new</span> <span class="tok-nx">Headers</span><span class="tok-p">({</span>
    <span class="tok-s1">&#39;Content-Type&#39;</span><span class="tok-o">:</span> <span class="tok-s1">&#39;text/plain&#39;</span>
  <span class="tok-p">})</span>
<span class="tok-p">}).</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span> <span class="tok-cm">/* manejar la respuesta */</span> <span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_enviando_datos">Enviando datos</h5>
<div class="paragraph">
<p>Ya sabemos que un caso muy común es enviar la información de un formulario vía AJAX.</p>
</div>
<div class="paragraph">
<p>Para ello, además de configurar que la petición sea <code>POST</code>, le asociaremos en la propiedad <code>body</code> un <code>FormData</code> creado a partir del identificador del elemento del formulario:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">fetch</span><span class="tok-p">(</span><span class="tok-s1">&#39;/submit&#39;</span><span class="tok-p">,</span> <span class="tok-p">{</span>
  <span class="tok-nx">method</span><span class="tok-o">:</span> <span class="tok-s1">&#39;post&#39;</span><span class="tok-p">,</span>
  <span class="tok-nx">body</span><span class="tok-o">:</span> <span class="tok-k">new</span> <span class="tok-nx">FormData</span><span class="tok-p">(</span><span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s1">&#39;formulario-cliente&#39;</span><span class="tok-p">))</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si lo que queremos es enviar JSON al servidor, en la misma propiedad, le asociamos un nuevo objeto JSON:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">fetch</span><span class="tok-p">(</span><span class="tok-s1">&#39;/submit-json&#39;</span><span class="tok-p">,</span> <span class="tok-p">{</span>
  <span class="tok-nx">method</span><span class="tok-o">:</span> <span class="tok-s1">&#39;post&#39;</span><span class="tok-p">,</span>
  <span class="tok-nx">body</span><span class="tok-o">:</span> <span class="tok-nx">JSON</span><span class="tok-p">.</span><span class="tok-nx">stringify</span><span class="tok-p">({</span>
    <span class="tok-nx">email</span><span class="tok-o">:</span> <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s1">&#39;email&#39;</span><span class="tok-p">).</span><span class="tok-nx">value</span>
    <span class="tok-nx">comentarios</span><span class="tok-o">:</span> <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s1">&#39;comentarios&#39;</span><span class="tok-p">).</span><span class="tok-nx">value</span>
  <span class="tok-p">})</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>O si queremos enviar información en formato URL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">fetch</span><span class="tok-p">(</span><span class="tok-s1">&#39;/submit-urlencoded&#39;</span><span class="tok-p">,</span> <span class="tok-p">{</span>
  <span class="tok-nx">method</span><span class="tok-o">:</span> <span class="tok-s1">&#39;post&#39;</span><span class="tok-p">,</span>
  <span class="tok-nx">headers</span><span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-s2">&quot;Content-type&quot;</span><span class="tok-o">:</span> <span class="tok-s2">&quot;application/x-www-form-urlencoded; charset=UTF-8&quot;</span>
  <span class="tok-p">},</span>
  <span class="tok-nx">body</span><span class="tok-o">:</span> <span class="tok-s1">&#39;heroe=Batman&amp;nombre=Bruce+Wayne&#39;</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_respuesta">8.3.4. Respuesta</h4>
<div class="paragraph">
<p>Una vez realizada la petición, dentro del manejador, reciberemos un objeto <code>Response</code>, compuesto de una serie de propiedades que representan la respuesta del servidor, de las cuales extraremos la información:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>type</code>: indican el origen de la petición. Dependiendo del tipo, podremos consultar diferente información:</p>
<div class="ulist">
<ul>
<li>
<p><code>basic</code>: proviene del mismo origen, sin restricciones.</p>
</li>
<li>
<p><code>cors</code>: acceso permitido a origen externo. Las cabeceras que se pueden consultar son <code>Cache-Control</code>, <code>Content-Language</code>, <code>Content-Type</code>, <code>Expires</code>, <code>Last-Modified</code>, y <code>Pragma</code></p>
</li>
<li>
<p><code>opaque</code>: origen externo que no devuelve cabeceras CORS, con lo que no podemos leer los datos ni visualizar el estado de la petición.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>status</code>: código de estado (200, 404, etc.)</p>
</li>
<li>
<p><code>ok</code>: Booleano que indica si la respuesta fue exitosa (en el rango 200-299 de estado)</p>
</li>
<li>
<p><code>statusText</code>: código de estado (<code>OK</code>)</p>
</li>
<li>
<p><code>headers</code>: objeto Headers asociado a la respuesta.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Además, el objeto <code>Response</code> ofrece los siguientes métodos para crear nuevas respuestas con diferente código de estado o a un destino distino:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>clone()</code>: clona el objeto <em>Response</em></p>
</li>
<li>
<p><code>error()</code>: devuelve un nuevo objeto <em>Response</em> asociado con un error de red.</p>
</li>
<li>
<p><code>redirect()</code>: crea una nueva respuesta con una URL diferente</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Finalmente, para transformar la respuesta a una promesa con un tipo de dato del cual extraer la información de la petición, tenemos los siguientes métodos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>arrayBuffer()</code>: Devuelve una promesa que se resuelve con un <em>ArrayBuffer</em>.</p>
</li>
<li>
<p><code>blob()</code>: Devuelve una promesa que se resuelve con un <em>Blob</em>.</p>
</li>
<li>
<p><code>formData()</code>: Devuelve una promesa que se resuelve con un objeto <em>FormData</em>.</p>
</li>
<li>
<p><code>json()</code>: Devuelve una promesa que se resuelve con un objeto <em>JSON</em>.</p>
</li>
<li>
<p><code>text()</code>: Devuelve una promesa que se resuelve con un texto (<em>USVString</em>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Veamos estos métodos en funcionamiento.</p>
</div>
<div class="sect4">
<h5 id="_parseando_la_respuesta">Parseando la respuesta</h5>
<div class="paragraph">
<p>A día de hoy, el estandar es emplear el formato JSON para las respuestas. En vez de utilizar <code>JSON.parse(cadena)</code> para transformar la cadena de respuesta en un objeto, podemos utilizar el método <code>json()</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">fetch</span><span class="tok-p">(</span><span class="tok-s1">&#39;heroes.json&#39;</span><span class="tok-p">).</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">response</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-k">return</span> <span class="tok-nx">response</span><span class="tok-p">.</span><span class="tok-nx">json</span><span class="tok-p">();</span>
<span class="tok-p">}).</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">datos</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">datos</span><span class="tok-p">);</span> <span class="tok-c1">// datos es un objeto JavaScript</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si la información, viene en texto plano o como documento HTML, podemos emplear <code>text()</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">fetch</span><span class="tok-p">(</span><span class="tok-s1">&#39;/siguientePagina&#39;</span><span class="tok-p">).</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">response</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-k">return</span> <span class="tok-nx">response</span><span class="tok-p">.</span><span class="tok-nx">text</span><span class="tok-p">();</span>
<span class="tok-p">}).</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">texto</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-c1">// &lt;!DOCTYPE ....</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">texto</span><span class="tok-p">);</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finalmente, si recibimos una imagen o archivo en binario, hemos de emplear <code>blob()</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">fetch</span><span class="tok-p">(</span><span class="tok-s1">&#39;paisaje.jpg&#39;</span><span class="tok-p">).</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">response</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-k">return</span> <span class="tok-nx">response</span><span class="tok-p">.</span><span class="tok-nx">blob</span><span class="tok-p">();</span>
<span class="tok-p">})</span>
<span class="tok-p">.</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">blobImagen</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">querySelector</span><span class="tok-p">(</span><span class="tok-s1">&#39;img&#39;</span><span class="tok-p">).</span><span class="tok-nx">src</span> <span class="tok-o">=</span> <span class="tok-nx">URL</span><span class="tok-p">.</span><span class="tok-nx">createObjectURL</span><span class="tok-p">(</span><span class="tok-nx">blobImagen</span><span class="tok-p">);</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Más ejemplos en <a href="https://blog.gospodarets.com/fetch_in_action/" class="bare">https://blog.gospodarets.com/fetch_in_action/</a></p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_jquery_deferreds">8.4. jQuery Deferreds</h3>
<div class="paragraph">
<p>Los <em>Deferreds</em> son la implementación que hace <em>jQuery</em> de las promesas, ofreciendo una implementación de las promesas independiente de la versión de <em>ECMAScript</em> que tenga nuestro navegador.</p>
</div>
<div class="sect3">
<h4 id="__code_deferred_code">8.4.1. <code>$.Deferred()</code></h4>
<div class="paragraph">
<p>Cada promesa de <em>jQuery</em> comienza con un <code>Deferred</code>.
Un <code>Deferred</code> es solo una promesa con métodos que permiten a su propietario resolverla o rechazarla. Todas las otras promesas son de sólo lectura.</p>
</div>
<div class="paragraph">
<p>Para crear un <code>Deferred</code>, usaremos el constructor <code>$.Deferred()</code>. Una vez creada una promesa podemos invocar los siguientes métodos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>state()</code>: devuelve el estado</p>
</li>
<li>
<p><code>resolve()</code>: resuelve la promesa</p>
</li>
<li>
<p><code>reject()</code>: rechaza la promesa</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">deferred</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">Deferred</span><span class="tok-p">();</span>

<span class="tok-nx">deferred</span><span class="tok-p">.</span><span class="tok-nx">state</span><span class="tok-p">();</span>  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-nx">deferred</span><span class="tok-p">.</span><span class="tok-nx">resolve</span><span class="tok-p">();</span>	<i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-nx">deferred</span><span class="tok-p">.</span><span class="tok-nx">state</span><span class="tok-p">();</span>  <i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-nx">deferred</span><span class="tok-p">.</span><span class="tok-nx">reject</span><span class="tok-p">();</span> <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Devuelve el estado de la promesa. Nada más creada su estado es <code>pending</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Le indicamos a la promesa que ha finalizado la acción que queremos controlar.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Volvemos a obtener el estado, pero ahora ya es <code>resolved</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Permite rechazar la promesa. En este ejemplo no tiene efecto, ya que la promesa se ha resuelto.</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Mucho cuidado con diseñar una aplicación que se base en comprobar el estado de una promesa para actuar en consecuencia. El único momento que tiene sentido actuar dependiendo de su valor es cuando tras un <em>callback</em> de <code>done()</code> querramos averiguar si hemos llegado tras resolver o rechazar la promesa.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si al método constructor le pasamos una función, ésta se ejecutará tan pronto como el objete se cree, y la función recibe como parámetro el nuevo objeto <em>deferred</em>. Mediante esta característica podemos crear un envoltorio que realiza una tarea asíncrona y que dispare un <em>callback</em> cuando haya finalizado:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">function</span> <span class="tok-nx">realizarTarea</span><span class="tok-p">()</span> <span class="tok-p">{</span>
	<span class="tok-k">return</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">Deferred</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">def</span><span class="tok-p">)</span> <span class="tok-p">{</span>
		<span class="tok-c1">// tarea async que dispara un callback al acabar</span>
	<span class="tok-p">});</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos obtener una promesa "pura" a partir del método <code>promise()</code>. El resultado es similar a <code>Deferred</code>, excepto que faltan los métodos de <code>resolve()</code> y <code>reject()</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">deferred</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">Deferred</span><span class="tok-p">();</span>
<span class="tok-kd">var</span> <span class="tok-nx">promise</span> <span class="tok-o">=</span> <span class="tok-nx">deferred</span><span class="tok-p">.</span><span class="tok-nx">promise</span><span class="tok-p">();</span>

<span class="tok-nx">promise</span><span class="tok-p">.</span><span class="tok-nx">state</span><span class="tok-p">();</span>  <span class="tok-c1">// &quot;pending&quot;</span>
<span class="tok-nx">deferred</span><span class="tok-p">.</span><span class="tok-nx">reject</span><span class="tok-p">();</span>
<span class="tok-nx">promise</span><span class="tok-p">.</span><span class="tok-nx">state</span><span class="tok-p">();</span>  <span class="tok-c1">// &quot;rejected&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El método <code>promise()</code> existe principalmente para dar soporte a la encapsulación: si una función devuelve un <code>Deferred</code>, puede ser resuelta o rechazada por el programa que la invoca. En cambio, si sólo devolvemos la promesa pura correspondiente al <code>Deferred</code>, el programa que la invoca sólo puede leer su estado y añadir <em>callbacks</em>. La propia <em>jQuery</em> sigue este enfoque al devolver promesas puras desde sus métodos AJAX:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">obteniendoProductos</span> <span class="tok-o">=</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-s2">&quot;/products&quot;</span><span class="tok-p">);</span>

<span class="tok-nx">obteniendoProductos</span><span class="tok-p">.</span><span class="tok-nx">state</span><span class="tok-p">();</span>  <span class="tok-c1">// &quot;pending&quot;</span>
<span class="tok-nx">obteniendoProductos</span><span class="tok-p">.</span><span class="tok-nx">resolve</span><span class="tok-p">;</span>  <span class="tok-c1">// undefined</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Las promesas se suelen nombrar con gerundios para indicar que representan un proceso
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_manejadores_de_promesas">8.4.2. Manejadores de promesas</h4>
<div class="paragraph">
<p>Una vez tenemos una promesa, podemos adjuntarle tantos <em>callbacks</em> como queremos mediante los métodos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>done()</code>: se lanza cuando la promesa se resuelve. correctamente, mediante <code>resolve()</code>∫</p>
</li>
<li>
<p><code>fail()</code>: se lanza cuando la promesa se rechaza, mediante <code>reject()</code></p>
</li>
<li>
<p><code>always()</code>: se lanza cuando se completa la promesa, independientemente que su estado sea resuelta o rechazada</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Por ejemplo:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo Deferreds: <a href="http://jsbin.com/qixaza/2/edit?html,js,console,output" class="bare">http://jsbin.com/qixaza/2/edit?html,js,console,output</a></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">promesa</span> <span class="tok-o">=</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">Deferred</span><span class="tok-p">();</span>
<span class="tok-nx">promesa</span><span class="tok-p">.</span><span class="tok-nx">done</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;Se ejecutará cuando la promesa se resuelva.&quot;</span><span class="tok-p">);</span>
<span class="tok-p">});</span>

<span class="tok-nx">promesa</span><span class="tok-p">.</span><span class="tok-nx">fail</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;Se ejecutará cuando la promesa se rechace.&quot;</span><span class="tok-p">);</span>
<span class="tok-p">});</span>

<span class="tok-nx">promesa</span><span class="tok-p">.</span><span class="tok-nx">always</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;Se ejecutará en cualquier caso.&quot;</span><span class="tok-p">);</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por ejemplo, supongamos que tenemos tres botones que modifican la promesa:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo Deferreds: <a href="http://jsbin.com/qixaza/2/edit?html,js,console,output" class="bare">http://jsbin.com/qixaza/2/edit?html,js,console,output</a></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;button</span> <span class="tok-na">id=</span><span class="tok-s">&quot;btnResuelve&quot;</span><span class="tok-nt">&gt;</span>Resolver<span class="tok-nt">&lt;/button&gt;</span>
<span class="tok-nt">&lt;button</span> <span class="tok-na">id=</span><span class="tok-s">&quot;btnRechaza&quot;</span><span class="tok-nt">&gt;</span>Rechazar<span class="tok-nt">&lt;/button&gt;</span>
<span class="tok-nt">&lt;button</span> <span class="tok-na">id=</span><span class="tok-s">&quot;btnEstado&quot;</span><span class="tok-nt">&gt;</span>¿Estado?<span class="tok-nt">&lt;/button&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y si capturamos los eventos <em>click</em> para que modifiquen la promesa, tendremos:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo Deferreds: <a href="http://jsbin.com/qixaza/2/edit?html,js,console,output" class="bare">http://jsbin.com/qixaza/2/edit?html,js,console,output</a></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s2">&quot;#btnResuelve&quot;</span><span class="tok-p">).</span><span class="tok-nx">click</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-nx">promesa</span><span class="tok-p">.</span><span class="tok-nx">resolve</span><span class="tok-p">();</span>
<span class="tok-p">});</span>
<span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s2">&quot;#btnRechaza&quot;</span><span class="tok-p">).</span><span class="tok-nx">click</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-nx">promesa</span><span class="tok-p">.</span><span class="tok-nx">reject</span><span class="tok-p">();</span>
<span class="tok-p">});</span>
<span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s2">&quot;#btnEstado&quot;</span><span class="tok-p">).</span><span class="tok-nx">click</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">promesa</span><span class="tok-p">.</span><span class="tok-nx">state</span><span class="tok-p">());</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_encadenando_promesas_2">8.4.3. Encadenando promesas</h4>
<div class="paragraph">
<p>Los métodos de los objetos <code>Deferred</code> se pueden encadenar, de manera que cada método devuelve a su vez un objeto <code>Deferred</code> donde poder volver a llamar a otros métodos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">promesa</span><span class="tok-p">.</span><span class="tok-nx">done</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;Se ejecutará cuando la promesa se resuelva.&quot;</span><span class="tok-p">);</span>
<span class="tok-p">}).</span><span class="tok-nx">fail</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;Se ejecutará cuando la promesa se rechace.&quot;</span><span class="tok-p">);</span>
<span class="tok-p">}).</span><span class="tok-nx">always</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;Se ejecutará en cualquier caso.&quot;</span><span class="tok-p">);</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Mediante el método <code>then()</code> podemos agrupar los tres <em>callbacks</em> de una sola vez:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">promesa</span><span class="tok-p">.</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-nx">doneCallback</span><span class="tok-p">,</span> <span class="tok-nx">failCallback</span><span class="tok-p">,</span> <span class="tok-nx">alwaysCallback</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Con lo que si reescribimos el ejemplo tendríamos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">promesa</span><span class="tok-p">.</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;Se ejecutará cuando la promesa se resuelva.&quot;</span><span class="tok-p">);</span>
<span class="tok-p">},</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;Se ejecutará cuando la promesa se rechace.&quot;</span><span class="tok-p">);</span>
<span class="tok-p">},</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;Se ejecutará en cualquier caso.&quot;</span><span class="tok-p">);</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Además, el orden en el que se adjuntan los <em>callbacks</em> definen su orden de ejecución. Por ejemplo, si duplicamos los <em>callbacks</em> y volvemos a añadirlos, tendremos:</p>
</div>
<div class="paragraph">
<p>Supongamos que reescribimos el ejemplo anterior con el siguiente fragmento para manejar las promesas:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo Orden Deferreds: <a href="http://jsbin.com/wanavo/1/edit?html,js,console,output" class="bare">http://jsbin.com/wanavo/1/edit?html,js,console,output</a></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">promesa</span> <span class="tok-o">=</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">Deferred</span><span class="tok-p">();</span>
<span class="tok-nx">promesa</span><span class="tok-p">.</span><span class="tok-nx">done</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;Primer callback.&quot;</span><span class="tok-p">);</span>
<span class="tok-p">}).</span><span class="tok-nx">done</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;Segundo callback.&quot;</span><span class="tok-p">);</span>
<span class="tok-p">}).</span><span class="tok-nx">done</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;Tercer callback.&quot;</span><span class="tok-p">);</span>
<span class="tok-p">});</span>

<span class="tok-nx">promesa</span><span class="tok-p">.</span><span class="tok-nx">fail</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;Houston! Tenemos un problema&quot;</span><span class="tok-p">);</span>
<span class="tok-p">});</span>

<span class="tok-nx">promesa</span><span class="tok-p">.</span><span class="tok-nx">always</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;Dentro del always&quot;</span><span class="tok-p">);</span>
<span class="tok-p">}).</span><span class="tok-nx">done</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;Y un cuarto callback si todo ha ido bien&quot;</span><span class="tok-p">);</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si probamos a resolver la promesa, la salida por consola será la siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">&quot;Primer callback.&quot;</span>
<span class="tok-go">&quot;Segundo callback.&quot;</span>
<span class="tok-go">&quot;Tercer callback.&quot;</span>
<span class="tok-go">&quot;Dentro del always&quot;</span>
<span class="tok-go">&quot;Y un cuarto callback si todo ha ido bien&quot;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_modelando_con_promesas">8.4.4. Modelando con promesas</h4>
<div class="paragraph">
<p>Veamos en detalle un caso de uso de promesas para representar una serie de acciones que puede realizar el usuario a partir de un formulario básico con AJAX que contiene un campo de texto con observaciones.</p>
</div>
<div class="paragraph">
<p>Queremos asegurarnos que el formularios solo se envia una vez y que el usuario recibe una confirmación cuando envía las observaciones. Además, queremos separar el código que describe el comportamiento de la aplicación del código que trabaja el contenido de la página. Esto facilita el <em>testing</em> y minimiza la cantidad de código necesario que necesitaríamos modificar si cambiamo la disposición de la página.</p>
</div>
<div class="paragraph">
<p>Así pues, separamos la lógica de aplicación mediante promesas:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">enviandoObservaciones</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">Deferred</span><span class="tok-p">();</span>

<span class="tok-nx">enviandoObservaciones</span><span class="tok-p">.</span><span class="tok-nx">done</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">input</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">post</span><span class="tok-p">(</span><span class="tok-s2">&quot;/observaciones&quot;</span><span class="tok-p">,</span> <span class="tok-nx">input</span><span class="tok-p">);</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y la interacción DOM se encarga de modificar el estado de la promesa:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s2">&quot;#observaciones&quot;</span><span class="tok-p">).</span><span class="tok-nx">submit</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-nx">enviandoObservaciones</span><span class="tok-p">.</span><span class="tok-nx">resolve</span><span class="tok-p">(</span><span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s2">&quot;textarea&quot;</span><span class="tok-p">,</span> <span class="tok-k">this</span><span class="tok-p">).</span><span class="tok-nx">val</span><span class="tok-p">());</span>	<i class="conum" data-value="1"></i><b>(1)</b>

  <span class="tok-k">return</span> <span class="tok-kc">false</span><span class="tok-p">;</span>  <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-p">});</span>

<span class="tok-nx">enviandoObservaciones</span><span class="tok-p">.</span><span class="tok-nx">done</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s2">&quot;#contenido&quot;</span><span class="tok-p">).</span><span class="tok-nx">append</span><span class="tok-p">(</span><span class="tok-s2">&quot;&lt;p&gt;¡Gracias por las observaciones!&lt;/p&gt;&quot;</span><span class="tok-p">);</span>	<i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Cuando el usuario pulsa sobre enviar, se resuelve la promesa. Si le pasamos un parámetro a un método de promesa (ya sea ), el parámetro se reenvía al callback correspondiente.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Prevenimos el comportamiento por defecto del navegador.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Le añadimos un segundo manejador que nos permite separar el código de aplicación del tratamiento del DOM.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_prestando_promesas_del_futuro">8.4.5. Prestando promesas del futuro</h4>
<div class="paragraph">
<p>Si queremos mejorar nuestro formulario, más que asumir de manera optimista que nuestro POST funcionará correctamente, deberíamos primero indicar que el formulario se ha enviado, por ejemplo, mediante una barra de progreso, y posteriormente indicarle al usuario si el envío ha sido exitoso o fallido cuando el servidor responda.</p>
</div>
<div class="paragraph">
<p>Para ello, podemos adjuntar <em>callbacks</em> a la promesa que devuelve <code>$.post</code>. El problema viene cuando tenemos que manipular el DOM desde esos <em>callbacks</em>, y hemos planteado usar promesas para separar el código de aplicación del de manipulación del DOM.</p>
</div>
<div class="paragraph">
<p>Una manera de separar la creación de una promesa del <em>callback</em> de lógica de aplicación es reenviar los eventos de <code>resolve</code>/<code>reject</code> desde la promesa POST a una promesa que se encuentre fuera de nuestro alcance. En vez de necesitar varias líneas con código anidado del tipo <code>promesa1.done(promesa2.resolve);..</code>, lo haremos mediante <code>then()</code> (antes de <em>jQuery 1.8</em> mediante <code>pipe()</code>).</p>
</div>
<div class="paragraph">
<p>Para ello, <code>then()</code> devuelve una nueva promesa que permite filtrar el estado y los valores de una promesa mediante una función, lo que la convierte en una ventana al futuro, permitiendo adjuntar comportamiento a una promesa que todavía no existe.</p>
</div>
<div class="paragraph">
<p>Si ahora mejoramos el código del formulario haciendo que nuestra promesa POST se encole en una nueva promesa llamada <code>guardandoObservaciones</code>, tendremos que el código de aplicación quede así:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">enviandoObservaciones</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">Deferred</span><span class="tok-p">();</span>
<span class="tok-kd">var</span> <span class="tok-nx">guardandoObservaciones</span> <span class="tok-o">=</span> <span class="tok-nx">enviandoObservaciones</span><span class="tok-p">.</span><span class="tok-nx">pipe</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">input</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-k">return</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">post</span><span class="tok-p">(</span><span class="tok-s2">&quot;/observaciones&quot;</span><span class="tok-p">,</span> <span class="tok-nx">input</span><span class="tok-p">);</span>	<i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Encolamos la promesa de guardado tras el envío</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Con lo que la manipulación del DOM queda del siguiente modo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s2">&quot;#observaciones&quot;</span><span class="tok-p">).</span><span class="tok-nx">submit</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-nx">enviandoObservaciones</span><span class="tok-p">.</span><span class="tok-nx">resolve</span><span class="tok-p">(</span><span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s2">&quot;textarea&quot;</span><span class="tok-p">,</span> <span class="tok-k">this</span><span class="tok-p">).</span><span class="tok-nx">val</span><span class="tok-p">());</span>
  <span class="tok-k">return</span> <span class="tok-kc">false</span><span class="tok-p">;</span>
<span class="tok-p">});</span>

<span class="tok-nx">enviandoObservaciones</span><span class="tok-p">.</span><span class="tok-nx">done</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s2">&quot;#contenido&quot;</span><span class="tok-p">).</span><span class="tok-nx">append</span><span class="tok-p">(</span><span class="tok-s2">&quot;&lt;div class=&#39;spinner&#39;&gt;&quot;</span><span class="tok-p">);</span>	<i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-p">});</span>

<span class="tok-nx">guardandoObservaciones</span><span class="tok-p">.</span><span class="tok-nx">then</span><span class="tok-p">(</span>
  <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>	<span class="tok-c1">// done</span>
    <span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s2">&quot;#contenido&quot;</span><span class="tok-p">).</span><span class="tok-nx">append</span><span class="tok-p">(</span><span class="tok-s2">&quot;&lt;p&gt;¡Gracias por las observaciones!&lt;/p&gt;&quot;</span><span class="tok-p">);</span>
  <span class="tok-p">},</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>	<span class="tok-c1">// fail</span>
    <span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s2">&quot;#contenido&quot;</span><span class="tok-p">).</span><span class="tok-nx">append</span><span class="tok-p">(</span><span class="tok-s2">&quot;&lt;p&gt;Se ha producido un error al contactar con el servidor.&lt;/p&gt;&quot;</span><span class="tok-p">);</span>
  <span class="tok-p">},</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>	<span class="tok-c1">// always</span>
    <span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s2">&quot;#contenido&quot;</span><span class="tok-p">).</span><span class="tok-nx">remove</span><span class="tok-p">(</span><span class="tok-s2">&quot;.spinner&quot;</span><span class="tok-p">);</span>	<i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Al enviar los datos creamos la barra de progreso</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Cuando finaliza el guardado, quitamos la barra de progreso</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_intersección_de_promesas">Intersección de promesas</h5>
<div class="paragraph">
<p>Parte de la magia de las promesas es su naturaleza binaria. Como solo tienen dos estados, se pueden combinar igual que si fuesen <em>booleanos</em> (aunque todavía no sepamos que valores tendrán).</p>
</div>
<div class="paragraph">
<p>De la misma manera que tenemos <code>Promise.all</code>, jQuery ofrece el método <code>$.when()</code>  como operador equivalente a la intersección (Y).</p>
</div>
<div class="paragraph">
<p>Así pues, dada una lista de promesas, <code>when()</code> devuelve una nueva promesa como resultado de otras promesas y que cumple estas reglas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Cuando todas las promesas recibidas se resuelven, la nueva promesa estará resuelta.</p>
</li>
<li>
<p>Cuando alguna de las promesas recibidas se rechaza, la nueva promesa se rechaza.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Por ello, cuando estemos esperando que múltiples eventos desordenados ocurran y necesitamos realizar una acción cuando todos hayan finalizado deberemos utilizar <code>when()</code>. Por ejemplo, el caso de uso más común es al realizar varias llamadas AJAX simultáneas:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s2">&quot;#contenido&quot;</span><span class="tok-p">).</span><span class="tok-nx">append</span><span class="tok-p">(</span><span class="tok-s2">&quot;&lt;div class=&#39;spinner&#39;&gt;&quot;</span><span class="tok-p">);</span>
<span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">when</span><span class="tok-p">(</span>	<span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-s2">&quot;/datosEncriptados&quot;</span><span class="tok-p">),</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">get</span><span class="tok-p">(</span><span class="tok-s2">&quot;/claveEncriptacion&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">.</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>	<span class="tok-c1">// done</span>
    <span class="tok-c1">// ambas llamadas han funcionado</span>
  <span class="tok-p">},</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>	<span class="tok-c1">// fail</span>
    <span class="tok-c1">// una de las llamadas ha fallado</span>
  <span class="tok-p">},</span> <span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>	<span class="tok-c1">// always</span>
    <span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s2">&quot;#contenido&quot;</span><span class="tok-p">).</span><span class="tok-nx">remove</span><span class="tok-p">(</span><span class="tok-s2">&quot;.spinner&quot;</span><span class="tok-p">);</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si las dos promesas se resuelven, entonces la promesa agregada también se resuelve, y se llamará la función del primer <em>callback</em> (<code>done()</code>). Sin embargo, en cuanto una de las promesas se rechace, la promesa agregada se rechazará también, disparando el <em>callback</em> de <code>fail()</code>.</p>
</div>
<div class="paragraph">
<p>Otro caso de uso es permitir al usuario solicitar un recurso que puede o no estar disponible. Por ejemplo, supongamos un <em>widget</em> de un chat que cargamos con <em>YepNope</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">cargandoChat</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">Deferred</span><span class="tok-p">();</span>
<span class="tok-nx">yepnope</span><span class="tok-p">({</span>
  <span class="tok-nx">load</span><span class="tok-o">:</span> <span class="tok-s2">&quot;recursos/chat.js&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">complete</span><span class="tok-o">:</span> <span class="tok-nx">cargandoChat</span><span class="tok-p">.</span><span class="tok-nx">resolve</span>
<span class="tok-p">});</span>

<span class="tok-kd">var</span> <span class="tok-nx">lanzandoChat</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">Deferred</span><span class="tok-p">();</span>
<span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s2">&quot;#lanzarChat&quot;</span><span class="tok-p">).</span><span class="tok-nx">click</span><span class="tok-p">(</span><span class="tok-nx">lanzandoChat</span><span class="tok-p">.</span><span class="tok-nx">resolve</span><span class="tok-p">);</span>
<span class="tok-nx">lanzandoChat</span><span class="tok-p">.</span><span class="tok-nx">done</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s2">&quot;#contenidoChat&quot;</span><span class="tok-p">).</span><span class="tok-nx">append</span><span class="tok-p">(</span><span class="tok-s2">&quot;&lt;div class=&#39;spinner&#39;&gt;&quot;</span><span class="tok-p">);</span>
<span class="tok-p">});</span>

<span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">when</span><span class="tok-p">(</span><span class="tok-nx">cargandoChat</span><span class="tok-p">,</span> <span class="tok-nx">lanzandoChat</span><span class="tok-p">).</span><span class="tok-nx">done</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s2">&quot;#contenidoChat&quot;</span><span class="tok-p">).</span><span class="tok-nx">remove</span><span class="tok-p">(</span><span class="tok-s2">&quot;.spinner&quot;</span><span class="tok-p">);</span>
  <span class="tok-c1">// comienza el chat</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_deferreds_y_ajax">8.4.6. Deferreds y AJAX</h4>
<div class="paragraph">
<p>Las promesas facilitan mucho el trabajo con AJAX y el trabajo con acceso simultáneos a recursos remotos.</p>
</div>
<div class="paragraph">
<p>El objeto <code>jxXHR</code> que se obtiene de los métodos AJAX como <code>$.ajax()</code> o <code>$.getJSON()</code> implementan el interfaz <code>Promise</code>, por lo que vamos a poder utilizar los métodos <code>done</code>, <code>fail</code>, <code>then</code>, <code>always</code> y <code>when</code>.</p>
</div>
<div class="paragraph">
<p>Así pues, vamos a poder escribir código similar al siguiente, donde tras hacer la petición vamos a poder utilizar los <em>callbacks</em> que ofrecen las promesas:</p>
</div>
<div class="paragraph">
<p>Ejemplo AJAX y Deferreds: <a href="http://jsbin.com/ponaca/edit?html,js,console,output" class="bare">http://jsbin.com/ponaca/edit?html,js,console,output</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">function</span> <span class="tok-nx">getDatos</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-kd">var</span> <span class="tok-nx">peticion</span> <span class="tok-o">=</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">getJSON</span><span class="tok-p">(</span><span class="tok-s2">&quot;http://www.omdbapi.com/?s=batman&amp;callback=?&quot;</span><span class="tok-p">);</span>
  <span class="tok-nx">peticion</span><span class="tok-p">.</span><span class="tok-nx">done</span><span class="tok-p">(</span><span class="tok-nx">todoOk</span><span class="tok-p">).</span><span class="tok-nx">fail</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;Algo ha fallado&quot;</span><span class="tok-p">);</span>
  <span class="tok-p">});</span>
  <span class="tok-nx">peticion</span><span class="tok-p">.</span><span class="tok-nx">always</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;Final, bien o mal&quot;</span><span class="tok-p">);</span>
  <span class="tok-p">});</span>
<span class="tok-p">}</span>

<span class="tok-kd">function</span> <span class="tok-nx">todoOk</span><span class="tok-p">(</span><span class="tok-nx">datos</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-s2">&quot;Datos recibidos y adjuntándolos a resultado&quot;</span><span class="tok-p">);</span>
  <span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s2">&quot;#resultado&quot;</span><span class="tok-p">).</span><span class="tok-nx">append</span><span class="tok-p">(</span><span class="tok-nx">JSON</span><span class="tok-p">.</span><span class="tok-nx">stringify</span><span class="tok-p">(</span><span class="tok-nx">datos</span><span class="tok-p">));</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En resumen, el uso de promesas simplifica la gestión de eventos asíncronos evitando múltiples condiciones anidadas. Ya veremos en el módulo de <em>Angular</em> como dicho <em>framework</em> hace un uso extenso de las promesas.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios">8.5. Ejercicios</h3>
<div class="sect3">
<h4 id="__0_5_ptos_ejercicio_81_star_wars_fetch">8.5.1. (0.5 ptos) Ejercicio 81. Star Wars Fetch</h4>
<div class="paragraph">
<p>A partir del ejercicio 72 sobre <em>Star Wars API</em>, vamos a reescribir el contenido mediante <em>Fetch API</em> y el uso de promesas para reducir el código y simplificar la lógica de las llamadas.</p>
</div>
<div class="paragraph">
<p>En este caso, el listado de películas se tiene que pintar en el DOM de una sola vez, no conforme se reciben los títulos de las películas con cada petición AJAX.</p>
</div>
<div class="paragraph">
<p>Todo el código estará incluido en el archivo <code>ej81.js</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="__0_3_ptos_ejercicio_82_star_wars_deferreds">8.5.2. (0.3 ptos) Ejercicio 82. Star Wars Deferreds</h4>
<div class="paragraph">
<p>A partir del ejercicio 72 sobre <em>Star Wars API</em>, se pide reescribir el contenido para hacer uso de <em>Deferreds</em>.</p>
</div>
<div class="paragraph">
<p>De igual manera que el ejercicio anterior, el listado de películas se tiene que pintar en el DOM de una sola vez, no conforme se reciben los títulos de las películas con cada petición AJAX.</p>
</div>
<div class="paragraph">
<p>Todo el código estará incluido en el archivo <code>ej82.js</code>.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnote_1">
<a href="#_footnoteref_1">1</a>. Sólo el valor de PI, ya que una vez resuelta, la promesa no puede tomar otro valor
</div>
<div class="footnote" id="_footnote_2">
<a href="#_footnoteref_2">2</a>. ¡Mal! y el error de parseo de JSON inválido, ya que se lanza una excepción en el constructor y por tanto no se resuelve la promesa
</div>
<div class="footnote" id="_footnote_3">
<a href="#_footnoteref_3">3</a>. La promesa <code>datosServer</code> se rechazaría y por consiguiente no se comprobaría la caché
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.1<br>
Last updated 2016-02-23 21:54:11 CET
</div>
</div>
</body>
</html>