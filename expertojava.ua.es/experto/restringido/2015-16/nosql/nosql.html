<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.2">
<meta name="author" content="Aitor Medrano">
<title>NoSQL</title>
<style>/*! normalize.css v2.1.2 | MIT License | git.io/normalize */
/* ========================================================================== HTML5 display definitions ========================================================================== */
/** Correct `block` display not defined in IE 8/9. */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }

/** Correct `inline-block` display not defined in IE 8/9. */
audio, canvas, video { display: inline-block; }

/** Prevent modern browsers from displaying `audio` without controls. Remove excess height in iOS 5 devices. */
audio:not([controls]) { display: none; height: 0; }

/** Address `[hidden]` styling not present in IE 8/9. Hide the `template` element in IE, Safari, and Firefox < 22. */
[hidden], template { display: none; }

script { display: none !important; }

/* ========================================================================== Base ========================================================================== */
/** 1. Set default font family to sans-serif. 2. Prevent iOS text size adjust after orientation change, without disabling user zoom. */
html { font-family: sans-serif; /* 1 */ -ms-text-size-adjust: 100%; /* 2 */ -webkit-text-size-adjust: 100%; /* 2 */ }

/** Remove default margin. */
body { margin: 0; }

/* ========================================================================== Links ========================================================================== */
/** Remove the gray background color from active links in IE 10. */
a { background: transparent; }

/** Address `outline` inconsistency between Chrome and other browsers. */
a:focus { outline: thin dotted; }

/** Improve readability when focused and also mouse hovered in all browsers. */
a:active, a:hover { outline: 0; }

/* ========================================================================== Typography ========================================================================== */
/** Address variable `h1` font-size and margin within `section` and `article` contexts in Firefox 4+, Safari 5, and Chrome. */
h1 { font-size: 2em; margin: 0.67em 0; }

/** Address styling not present in IE 8/9, Safari 5, and Chrome. */
abbr[title] { border-bottom: 1px dotted; }

/** Address style set to `bolder` in Firefox 4+, Safari 5, and Chrome. */
b, strong { font-weight: bold; }

/** Address styling not present in Safari 5 and Chrome. */
dfn { font-style: italic; }

/** Address differences between Firefox and other browsers. */
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }

/** Address styling not present in IE 8/9. */
mark { background: #ff0; color: #000; }

/** Correct font family set oddly in Safari 5 and Chrome. */
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }

/** Improve readability of pre-formatted text in all browsers. */
pre { white-space: pre-wrap; }

/** Set consistent quote types. */
q { quotes: "\201C" "\201D" "\2018" "\2019"; }

/** Address inconsistent and variable font size in all browsers. */
small { font-size: 80%; }

/** Prevent `sub` and `sup` affecting `line-height` in all browsers. */
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }

sup { top: -0.5em; }

sub { bottom: -0.25em; }

/* ========================================================================== Embedded content ========================================================================== */
/** Remove border when inside `a` element in IE 8/9. */
img { border: 0; }

/** Correct overflow displayed oddly in IE 9. */
svg:not(:root) { overflow: hidden; }

/* ========================================================================== Figures ========================================================================== */
/** Address margin not present in IE 8/9 and Safari 5. */
figure { margin: 0; }

/* ========================================================================== Forms ========================================================================== */
/** Define consistent border, margin, and padding. */
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }

/** 1. Correct `color` not being inherited in IE 8/9. 2. Remove padding so people aren't caught out if they zero out fieldsets. */
legend { border: 0; /* 1 */ padding: 0; /* 2 */ }

/** 1. Correct font family not being inherited in all browsers. 2. Correct font size not being inherited in all browsers. 3. Address margins set differently in Firefox 4+, Safari 5, and Chrome. */
button, input, select, textarea { font-family: inherit; /* 1 */ font-size: 100%; /* 2 */ margin: 0; /* 3 */ }

/** Address Firefox 4+ setting `line-height` on `input` using `!important` in the UA stylesheet. */
button, input { line-height: normal; }

/** Address inconsistent `text-transform` inheritance for `button` and `select`. All other form control elements do not inherit `text-transform` values. Correct `button` style inheritance in Chrome, Safari 5+, and IE 8+. Correct `select` style inheritance in Firefox 4+ and Opera. */
button, select { text-transform: none; }

/** 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio` and `video` controls. 2. Correct inability to style clickable `input` types in iOS. 3. Improve usability and consistency of cursor style between image-type `input` and others. */
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; /* 2 */ cursor: pointer; /* 3 */ }

/** Re-set default cursor for disabled elements. */
button[disabled], html input[disabled] { cursor: default; }

/** 1. Address box sizing set to `content-box` in IE 8/9. 2. Remove excess padding in IE 8/9. */
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; /* 1 */ padding: 0; /* 2 */ }

/** 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome. 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome (include `-moz` to future-proof). */
input[type="search"] { -webkit-appearance: textfield; /* 1 */ -moz-box-sizing: content-box; -webkit-box-sizing: content-box; /* 2 */ box-sizing: content-box; }

/** Remove inner padding and search cancel button in Safari 5 and Chrome on OS X. */
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }

/** Remove inner padding and border in Firefox 4+. */
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }

/** 1. Remove default vertical scrollbar in IE 8/9. 2. Improve readability and alignment in all browsers. */
textarea { overflow: auto; /* 1 */ vertical-align: top; /* 2 */ }

/* ========================================================================== Tables ========================================================================== */
/** Remove most spacing between table cells. */
table { border-collapse: collapse; border-spacing: 0; }

meta.foundation-mq-small { font-family: "only screen and (min-width: 768px)"; width: 768px; }

meta.foundation-mq-medium { font-family: "only screen and (min-width:1280px)"; width: 1280px; }

meta.foundation-mq-large { font-family: "only screen and (min-width:1440px)"; width: 1440px; }

*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }

html, body { font-size: 97%; }

body { background: white; color: #222222; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }

a:hover { cursor: pointer; }

img, object, embed { max-width: 100%; height: auto; }

object, embed { height: 100%; }

img { -ms-interpolation-mode: bicubic; }

#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }

.left { float: left !important; }

.right { float: right !important; }

.text-left { text-align: left !important; }

.text-right { text-align: right !important; }

.text-center { text-align: center !important; }

.text-justify { text-align: justify !important; }

.hide { display: none; }

.antialiased, body { -webkit-font-smoothing: antialiased; }

img { display: inline-block; vertical-align: middle; }

textarea { height: auto; min-height: 50px; }

select { width: 100%; }

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }

.subheader, .admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { line-height: 1.4; color: #6f6f6f; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }

/* Typography resets */
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }

/* Default Link Styles */
a { color: #1164be; text-decoration: none; line-height: inherit; }
a img { border: none; }

/* Default paragraph styles */
p { font-family: inherit; font-weight: normal; font-size: 1em; line-height: 1.4; margin-bottom: 1em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }

/* Default header styles */
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: bold; font-style: normal; color: #1c355e; text-rendering: optimizeLegibility; margin-top: 1em; margin-bottom: 0.5em; line-height: 1.2125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #6f6f6f; line-height: 0; }

h1 { font-size: 2.125em; }

h2 { font-size: 1.6875em; }

h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }

h4 { font-size: 1.125em; }

h5 { font-size: 1.125em; }

h6 { font-size: 1em; }

hr { border: solid #dddddd; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }

/* Helpful Typography Defaults */
em, i { font-style: italic; line-height: inherit; }

strong, b { font-weight: bold; line-height: inherit; }

small { font-size: 60%; line-height: inherit; }

code { font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: bold; }

/* Lists */
ul, ol, dl { font-size: 1em; line-height: 1.4; margin-bottom: 1.25em; list-style-position: outside; font-family: inherit; }

ul, ol { margin-left: 2.5em; }
ul.no-bullet, ol.no-bullet { margin-left: 1.5em; }

/* Unordered Lists */
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; /* Override nested font-size change */ }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }

/* Ordered Lists */
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }

/* Definition Lists */
dl dt { margin-bottom: 0.3125em; font-weight: bold; }
dl dd { margin-bottom: 1.25em; }

/* Abbreviations */
abbr, acronym { text-transform: uppercase; font-size: 90%; color: #222222; border-bottom: 1px dotted #dddddd; cursor: help; }

abbr { text-transform: none; }

/* Blockquotes */
blockquote { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
blockquote cite { display: block; font-size: 0.8125em; color: #555555; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #555555; }

blockquote, blockquote p { line-height: 1.6; color: #6f6f6f; }

/* Microformats */
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #dddddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }

.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }

/*@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.6875em; }
  h4 { font-size: 1.4375em; } }*/
/* Tables */
table { background: white; margin-bottom: 1.25em; border: solid 1px #dddddd; }
table thead, table tfoot { background: whitesmoke; font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: #222222; text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: #222222; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #f9f9f9; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.4; }

h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; border-bottom: 1px solid #dddddd }

.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }

*:not(pre) > code { font-size: inherit; font-style: normal !important; letter-spacing: 0; padding: 3px 2px 1px 2px; background-color: #eeeeee; border: 1px solid #dddddd; -webkit-border-radius: 0; border-radius: 0; line-height: inherit; font-weight: normal; }

pre, pre > code { line-height: 1.4; color: black; font-family: monospace, serif; font-weight: normal; }

.keyseq { color: #555555; }

kbd { display: inline-block; color: #222222; font-size: 0.75em; line-height: 1.4; background-color: #f7f7f7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; margin: -0.15em 0.15em 0 0.15em; padding: 0.2em 0.6em 0.2em 0.5em; vertical-align: middle; white-space: nowrap; }

.keyseq kbd:first-child { margin-left: 0; }

.keyseq kbd:last-child { margin-right: 0; }

.menuseq, .menu { color: #090909; }

b.button:before, b.button:after { position: relative; top: -1px; font-weight: normal; }

b.button:before { content: "["; padding: 0 3px 0 2px; }

b.button:after { content: "]"; padding: 0 2px 0 3px; }

#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 0.9375em; padding-right: 0.9375em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }

#content { margin-top: 1.25em; }

#content:before { content: none; }

#header > h1:first-child { color: black; margin-top: 2.25rem; margin-bottom: 0; }
#header > h1:first-child + #toc { margin-top: 8px; border-top: 1px solid #dddddd; }
#header > h1:only-child, body.toc2 #header > h1:nth-last-child(2) { border-bottom: 1px solid #dddddd; padding-bottom: 8px; }
#header .details { border-bottom: 1px solid #dddddd; line-height: 1.45; padding-top: 0.25em; padding-bottom: 0.25em; padding-left: 0.25em; color: #555555; display: -ms-flexbox; display: -webkit-flex; display: flex; -ms-flex-flow: row wrap; -webkit-flex-flow: row wrap; flex-flow: row wrap; }
#header .details span:first-child { margin-left: -0.125em; }
#header .details span.email a { color: #6f6f6f; }
#header .details br { display: none; }
#header .details br + span:before { content: "\00a0\2013\00a0"; }
#header .details br + span.author:before { content: "\00a0\22c5\00a0"; color: #6f6f6f; }
#header .details br + span#revremark:before { content: "\00a0|\00a0"; }
#header #revnumber { text-transform: capitalize; }
#header #revnumber:after { content: "\00a0"; }

#content > h1:first-child:not([class]) { color: black; border-bottom: 1px solid #dddddd; padding-bottom: 8px; margin-top: 0; padding-top: 1rem; margin-bottom: 1.25rem; }

#floating {
  position: fixed;
  z-index: 1000;
  padding: 0.5em;
  right: 0;
  top: 0;
  background: white;
  box-shadow: 0 0 1em #777777;
  -webkit-box-shadow: 0 0 1em #777777;
  -moz-box-shadow: 0 0 1em #777777;
  -webkit-border-bottom-left-radius: 5px;
  -moz-border-radius-bottomleft: 5px;
  max-height: 80%;
  overflow: auto;
}

#floating #full { display: none; } /* Hide the full TOC by default */

#floating:hover #full{
  display: block; /* Show it on hover */
}


#toc { border-bottom: 1px solid #dddddd; padding-bottom: 0.5em; }
#toc > ul { margin-left: 0.125em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin: 0.5em 0; }
#toc ul { font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; list-style-type: none; }
#toc a { text-decoration: none; }
#toc a:active { text-decoration: underline; }

#toctitle { color: #6f6f6f; font-size: 1.2em; }

@media only screen and (min-width: 768px) { #toctitle { font-size: 1.375em; }
  body.toc2 { padding-left: 15em; padding-right: 0; }
  #toc.toc2 { margin-top: 0 !important; background-color: #f2f2f2; position: fixed; width: 15em; left: 0; top: 0; border-right: 1px solid #dddddd; border-top-width: 0 !important; border-bottom-width: 0 !important; z-index: 1000; padding: 1.25em 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; font-size: 1.2em; }
  #toc.toc2 > ul { font-size: 0.9em; margin-bottom: 0; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 15em; }
  body.toc2.toc-right #toc.toc2 { border-right-width: 0; border-left: 1px solid #dddddd; left: auto; right: 0; } }
@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; padding-right: 0; }
  #toc.toc2 { width: 20em; }
  #toc.toc2 #toctitle { font-size: 1.375em; }
  #toc.toc2 > ul { font-size: 0.95em; }
  #toc.toc2 ul ul { padding-left: 1.25em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; } }
#content #toc { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 0; border-radius: 0; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }

#footer { max-width: 100%; background-color: #222222; padding: 1.25em; }

#footer-text { color: #dddddd; line-height: 1.44; }

.sect1 { padding-bottom: 0.625em; }

@media only screen and (min-width: 768px) { .sect1 { padding-bottom: 1.25em; } }
.sect1 + .sect1 { border-top: 1px solid #dddddd; }

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; z-index: 1001; width: 1.5ex; margin-left: -1.5ex; display: block; text-decoration: none !important; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: "\00A7"; font-size: 0.85em; display: block; padding-top: 0.1em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #222222; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #151515; }

.audioblock, .imageblock, .literalblock, .listingblock, .stemblock, .videoblock { margin-bottom: 1.25em; }

.admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-rendering: optimizeLegibility; text-align: left; }

table.tableblock > caption.title { white-space: nowrap; overflow: visible; max-width: 0; }

.paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { color: black; }

table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }

.admonitionblock > table { border-collapse: separate; border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #dddddd; color: #555555; }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }

.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 0; border-radius: 0; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }

.sidebarblock { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 0; border-radius: 0; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock > .content > .title { color: #6f6f6f; margin-top: 0; }

.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }

.literalblock pre, .listingblock pre:not(.highlight), .listingblock pre[class="highlight"], .listingblock pre[class^="highlight "], .listingblock pre.CodeRay, .listingblock pre.prettyprint { background: #eeeeee; }
.sidebarblock .literalblock pre, .sidebarblock .listingblock pre:not(.highlight), .sidebarblock .listingblock pre[class="highlight"], .sidebarblock .listingblock pre[class^="highlight "], .sidebarblock .listingblock pre.CodeRay, .sidebarblock .listingblock pre.prettyprint { background: #f2f1f1; }

.literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { border: 1px solid #cccccc; -webkit-border-radius: 0; border-radius: 0; word-wrap: break-word; padding: 0.8em 0.8em 0.65em 0.8em; font-size: 0.8125em; }
.literalblock pre.nowrap, .literalblock pre[class].nowrap, .listingblock pre.nowrap, .listingblock pre[class].nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
@media only screen and (min-width: 768px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 0.90625em; } }
@media only screen and (min-width: 1280px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 1em; } }

.literalblock.output pre { color: #eeeeee; background-color: black; }

.listingblock pre.highlightjs { padding: 0; }
.listingblock pre.highlightjs > code { padding: 0.8em 0.8em 0.65em 0.8em; -webkit-border-radius: 0; border-radius: 0; }

.listingblock > .content { position: relative; }

.listingblock code[data-lang]:before { display: none; content: attr(data-lang); position: absolute; font-size: 0.75em; top: 0.425rem; right: 0.5rem; line-height: 1; text-transform: uppercase; color: #999; }

.listingblock:hover code[data-lang]:before { display: block; }

.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }

.listingblock.terminal pre .command:not([data-prompt]):before { content: "$"; }

table.pyhltable { border-collapse: separate; border: 0; margin-bottom: 0; background: none; }

table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; }

table.pyhltable td.code { padding-left: .75em; padding-right: 0; }

pre.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #dddddd; }

pre.pygments .lineno { display: inline-block; margin-right: .25em; }

table.pyhltable .linenodiv { background: none !important; padding-right: 0 !important; }

.quoteblock { margin: 0 1em 1.25em 1.5em; display: table; }
.quoteblock > .title { margin-left: -1.5em; margin-bottom: 0.75em; }
.quoteblock blockquote, .quoteblock blockquote p { color: #6f6f6f; font-size: 1.15rem; line-height: 1.75; word-spacing: 0.1em; letter-spacing: 0; font-style: italic; text-align: justify; }
.quoteblock blockquote { margin: 0; padding: 0; border: 0; }
.quoteblock blockquote:before { content: "\201c"; float: left; font-size: 2.75em; font-weight: bold; line-height: 0.6em; margin-left: -0.6em; color: #6f6f6f; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: 0.5em; margin-right: 0.5ex; text-align: right; }
.quoteblock .quoteblock { margin-left: 0; margin-right: 0; padding: 0.5em 0; border-left: 3px solid #555555; }
.quoteblock .quoteblock blockquote { padding: 0 0 0 0.75em; }
.quoteblock .quoteblock blockquote:before { display: none; }

.verseblock { margin: 0 1em 1.25em 1em; }
.verseblock pre { font-family: "Open Sans", "DejaVu Sans", sans; font-size: 1.15rem; color: #6f6f6f; font-weight: 300; text-rendering: optimizeLegibility; }
.verseblock pre strong { font-weight: 400; }
.verseblock .attribution { margin-top: 1.25rem; margin-left: 0.5ex; }

.quoteblock .attribution, .verseblock .attribution { font-size: 0.8125em; line-height: 1.45; font-style: italic; }
.quoteblock .attribution br, .verseblock .attribution br { display: none; }
.quoteblock .attribution cite, .verseblock .attribution cite { display: block; letter-spacing: -0.05em; color: #555555; }

.quoteblock.abstract { margin: 0 0 1.25em 0; display: block; }
.quoteblock.abstract blockquote, .quoteblock.abstract blockquote p { text-align: left; word-spacing: 0; }
.quoteblock.abstract blockquote:before, .quoteblock.abstract blockquote p:first-of-type:before { display: none; }

table.tableblock { max-width: 100%; border-collapse: separate; }
table.tableblock td > .paragraph:last-child p > p:last-child, table.tableblock th > p:last-child, table.tableblock td > p:last-child { margin-bottom: 0; }

table.spread { width: 100%; }

table.tableblock, th.tableblock, td.tableblock { border: 0 solid #dddddd; }

table.grid-all th.tableblock, table.grid-all td.tableblock { border-width: 0 1px 1px 0; }

table.grid-all tfoot > tr > th.tableblock, table.grid-all tfoot > tr > td.tableblock { border-width: 1px 1px 0 0; }

table.grid-cols th.tableblock, table.grid-cols td.tableblock { border-width: 0 1px 0 0; }

table.grid-all * > tr > .tableblock:last-child, table.grid-cols * > tr > .tableblock:last-child { border-right-width: 0; }

table.grid-rows th.tableblock, table.grid-rows td.tableblock { border-width: 0 0 1px 0; }

table.grid-all tbody > tr:last-child > th.tableblock, table.grid-all tbody > tr:last-child > td.tableblock, table.grid-all thead:last-child > tr > th.tableblock, table.grid-rows tbody > tr:last-child > th.tableblock, table.grid-rows tbody > tr:last-child > td.tableblock, table.grid-rows thead:last-child > tr > th.tableblock { border-bottom-width: 0; }

table.grid-rows tfoot > tr > th.tableblock, table.grid-rows tfoot > tr > td.tableblock { border-width: 1px 0 0 0; }

table.frame-all { border-width: 1px; }

table.frame-sides { border-width: 0 1px; }

table.frame-topbot { border-width: 1px 0; }

th.halign-left, td.halign-left { text-align: left; }

th.halign-right, td.halign-right { text-align: right; }

th.halign-center, td.halign-center { text-align: center; }

th.valign-top, td.valign-top { vertical-align: top; }

th.valign-bottom, td.valign-bottom { vertical-align: bottom; }

th.valign-middle, td.valign-middle { vertical-align: middle; }

table thead th, table tfoot th { font-weight: bold; }

tbody tr th { display: table-cell; line-height: 1.4; background: whitesmoke; }

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p { color: #222222; font-weight: bold; }

p.tableblock > code:only-child { background: none; padding: 0; }

p.tableblock { font-size: 1em; }

td > div.verse { white-space: pre; }

ol { margin-left: 2.5em; }

ul li ol { margin-left: 1.5em; }

dl dd { margin-left: 1.125em; }

dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }

ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.625em; }

ul.unstyled, ol.unnumbered, ul.checklist, ul.none { list-style-type: none; }

ul.unstyled, ol.unnumbered, ul.checklist { margin-left: 0.625em; }

ul.checklist li > p:first-child > .fa-check-square-o:first-child, ul.checklist li > p:first-child > input[type="checkbox"]:first-child { margin-right: 0.25em; }

ul.checklist li > p:first-child > input[type="checkbox"]:first-child { position: relative; top: 1px; }

ul.inline { margin: 0 auto 0.625em auto; margin-left: -1.375em; margin-right: 0; padding: 0; list-style: none; overflow: hidden; }
ul.inline > li { list-style: none; float: left; margin-left: 1.375em; display: block; }
ul.inline > li > * { display: block; }

.unstyled dl dt { font-weight: normal; font-style: normal; }

ol.arabic { list-style-type: decimal; }

ol.decimal { list-style-type: decimal-leading-zero; }

ol.loweralpha { list-style-type: lower-alpha; }

ol.upperalpha { list-style-type: upper-alpha; }

ol.lowerroman { list-style-type: lower-roman; }

ol.upperroman { list-style-type: upper-roman; }

ol.lowergreek { list-style-type: lower-greek; }

.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }

td.hdlist1 { padding-right: .75em; font-weight: bold; }

td.hdlist1, td.hdlist2 { vertical-align: top; }

.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }

.colist > table tr > td:first-of-type { padding: 0 0.75em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.25em 0; }

.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: 0 0 0 1px #dddddd; box-shadow: 0 0 0 1px #dddddd; }

.imageblock.left, .imageblock[style*="float: left"] { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }

.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }

a.image { text-decoration: none; }

span.footnote, span.footnoteref { vertical-align: super; font-size: 0.875em; }
span.footnote a, span.footnoteref a { text-decoration: none; }
span.footnote a:active, span.footnoteref a:active { text-decoration: underline; }

#footnotes { padding-top: 0.75em; padding-bottom: 0.75em; margin-bottom: 0.625em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -.25em 0 .75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.375em; line-height: 1.3; font-size: 0.875em; margin-left: 1.2em; text-indent: -1.2em; margin-bottom: .2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }

#content #footnotes { margin-top: -0.625em; margin-bottom: 0; padding: 0.75em 0; }

.gist .file-data > table { border: 0; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }

div.unbreakable { page-break-inside: avoid; }

.big { font-size: larger; }

.small { font-size: smaller; }

.underline { text-decoration: underline; }

.overline { text-decoration: overline; }

.line-through { text-decoration: line-through; }

.aqua { color: #00bfbf; }

.aqua-background { background-color: #00fafa; }

.black { color: black; }

.black-background { background-color: black; }

.blue { color: #0000bf; }

.blue-background { background-color: #0000fa; }

.fuchsia { color: #bf00bf; }

.fuchsia-background { background-color: #fa00fa; }

.gray { color: #606060; }

.gray-background { background-color: #7d7d7d; }

.green { color: #006000; }

.green-background { background-color: #007d00; }

.lime { color: #00bf00; }

.lime-background { background-color: #00fa00; }

.maroon { color: #600000; }

.maroon-background { background-color: #7d0000; }

.navy { color: #000060; }

.navy-background { background-color: #00007d; }

.olive { color: #606000; }

.olive-background { background-color: #7d7d00; }

.purple { color: #600060; }

.purple-background { background-color: #7d007d; }

.red { color: #bf0000; }

.red-background { background-color: #fa0000; }

.silver { color: #909090; }

.silver-background { background-color: #bcbcbc; }

.teal { color: #006060; }

.teal-background { background-color: #007d7d; }

.white { color: #bfbfbf; }

.white-background { background-color: #fafafa; }

.yellow { color: #bfbf00; }

.yellow-background { background-color: #fafa00; }

span.icon > .fa { cursor: default; }

.admonitionblock td.icon [class^="fa icon-"] { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #207c98; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }

.conum[data-value] { display: inline-block; color: #fff !important; background-color: #222222; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; font-size: 0.75em; width: 1.67em; height: 1.67em; line-height: 1.67em; font-family: "Open Sans", "DejaVu Sans", sans-serif; font-style: normal; font-weight: bold; }
.conum[data-value] * { color: #fff !important; }
.conum[data-value] + b { display: none; }
.conum[data-value]:after { content: attr(data-value); }
pre .conum[data-value] { position: relative; top: -0.125em; }

b.conum * { color: inherit !important; }

.conum:not([data-value]):empty { display: none; }

.literalblock pre, .listingblock pre { background: #eeeeee; }

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.min.css">
<style>.listingblock .pygments .hll { background-color: #ffffcc }
.listingblock .pygments  { background: #f8f8f8; }
.listingblock .pygments .tok-c { color: #408080; font-style: italic } /* Comment */
.listingblock .pygments .tok-err { border: 1px solid #FF0000 } /* Error */
.listingblock .pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
.listingblock .pygments .tok-o { color: #666666 } /* Operator */
.listingblock .pygments .tok-cm { color: #408080; font-style: italic } /* Comment.Multiline */
.listingblock .pygments .tok-cp { color: #BC7A00 } /* Comment.Preproc */
.listingblock .pygments .tok-c1 { color: #408080; font-style: italic } /* Comment.Single */
.listingblock .pygments .tok-cs { color: #408080; font-style: italic } /* Comment.Special */
.listingblock .pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
.listingblock .pygments .tok-ge { font-style: italic } /* Generic.Emph */
.listingblock .pygments .tok-gr { color: #FF0000 } /* Generic.Error */
.listingblock .pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
.listingblock .pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
.listingblock .pygments .tok-go { color: #888888 } /* Generic.Output */
.listingblock .pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.listingblock .pygments .tok-gs { font-weight: bold } /* Generic.Strong */
.listingblock .pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.listingblock .pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
.listingblock .pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.listingblock .pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.listingblock .pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.listingblock .pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
.listingblock .pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.listingblock .pygments .tok-kt { color: #B00040 } /* Keyword.Type */
.listingblock .pygments .tok-m { color: #666666 } /* Literal.Number */
.listingblock .pygments .tok-s { color: #BA2121 } /* Literal.String */
.listingblock .pygments .tok-na { color: #7D9029 } /* Name.Attribute */
.listingblock .pygments .tok-nb { color: #008000 } /* Name.Builtin */
.listingblock .pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
.listingblock .pygments .tok-no { color: #880000 } /* Name.Constant */
.listingblock .pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
.listingblock .pygments .tok-ni { color: #999999; font-weight: bold } /* Name.Entity */
.listingblock .pygments .tok-ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.listingblock .pygments .tok-nf { color: #0000FF } /* Name.Function */
.listingblock .pygments .tok-nl { color: #A0A000 } /* Name.Label */
.listingblock .pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.listingblock .pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
.listingblock .pygments .tok-nv { color: #19177C } /* Name.Variable */
.listingblock .pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.listingblock .pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
.listingblock .pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
.listingblock .pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
.listingblock .pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
.listingblock .pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
.listingblock .pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
.listingblock .pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
.listingblock .pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
.listingblock .pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.listingblock .pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
.listingblock .pygments .tok-se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.listingblock .pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
.listingblock .pygments .tok-si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.listingblock .pygments .tok-sx { color: #008000 } /* Literal.String.Other */
.listingblock .pygments .tok-sr { color: #BB6688 } /* Literal.String.Regex */
.listingblock .pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
.listingblock .pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
.listingblock .pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
.listingblock .pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
.listingblock .pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
.listingblock .pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
.listingblock .pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>NoSQL</h1>
<div class="details">
<span id="author" class="author">Aitor Medrano</span><br>
<span id="email" class="email">&lt;<a href="mailto:aitormedrano@gmail.com">aitormedrano@gmail.com</a>&gt;</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Índice de contenidos</div>
<ul class="sectlevel1">
<li><a href="#sesion01">1. No Sólo SQL</a>
<ul class="sectlevel2">
<li><a href="#_caracter%C3%ADsticas">1.1. Características</a></li>
<li><a href="#_nosql_vs_sql">1.2. NoSQL vs. SQL</a></li>
<li><a href="#_implantando_nosql">1.3. Implantando NoSQL</a></li>
<li><a href="#_modelos_de_datos">1.4. Modelos de datos</a></li>
<li><a href="#_consistencia">1.5. Consistencia</a></li>
<li><a href="#_teorema_de_cap">1.6. Teorema de CAP</a></li>
<li><a href="#_mongodb">1.7. MongoDB</a></li>
<li><a href="#_hola_em_mongodb_em">1.8. Hola <em>MongoDB</em></a></li>
<li><a href="#_ejercicios">1.9. Ejercicios</a></li>
</ul>
</li>
<li><a href="#sesion02">2. MongoDB</a>
<ul class="sectlevel2">
<li><a href="#_bson">2.1. BSON</a></li>
<li><a href="#_trabajando_con_el_shell">2.2. Trabajando con el shell</a></li>
<li><a href="#_objectid">2.3. ObjectId</a></li>
<li><a href="#_consultas">2.4. Consultas</a></li>
<li><a href="#_actualizando_documentos">2.5. Actualizando documentos</a></li>
<li><a href="#_borrando_documentos">2.6. Borrando documentos</a></li>
<li><a href="#_control_de_errores">2.7. Control de errores</a></li>
<li><a href="#__em_mongodb_em_desde_em_java_em">2.8. <em>MongoDB</em> desde <em>Java</em></a></li>
<li><a href="#_mapping_de_objetos">2.9. Mapping de objetos</a></li>
<li><a href="#_ejercicios_2">2.10. Ejercicios</a></li>
</ul>
</li>
<li><a href="#sesion03">3. Rendimiento en <em>MongoDB</em></a>
<ul class="sectlevel2">
<li><a href="#_dise%C3%B1ando_el_esquema">3.1. Diseñando el esquema</a></li>
<li><a href="#_transacciones_y_concurrencia">3.2. Transacciones y concurrencia</a></li>
<li><a href="#_gridfs">3.3. GridFS</a></li>
<li><a href="#_%C3%8Dndices">3.4. Índices</a></li>
<li><a href="#_colecciones_limitadas">3.5. Colecciones limitadas</a></li>
<li><a href="#_profiling">3.6. Profiling</a></li>
<li><a href="#_ejercicios_3">3.7. Ejercicios</a></li>
</ul>
</li>
<li><a href="#sesion04">4. Agregaciones y Escalabilidad</a>
<ul class="sectlevel2">
<li><a href="#_agregaciones">4.1. Agregaciones</a></li>
<li><a href="#__em_pipeline_em_de_agregaci%C3%B3n">4.2. <em>Pipeline</em> de agregación</a></li>
<li><a href="#_agregaciones_con_em_java_em">4.3. Agregaciones con <em>Java</em></a></li>
<li><a href="#_replicaci%C3%B3n_2">4.4. Replicación</a></li>
<li><a href="#_replicaci%C3%B3n_en_em_java_em">4.5. Replicación en <em>Java</em></a></li>
<li><a href="#_particionado_em_sharding_em">4.6. Particionado (<em>Sharding</em>)</a></li>
<li><a href="#_ejercicios_4">4.7. Ejercicios</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="sesion01">1. No Sólo SQL</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Si definimos <strong>NoSQL</strong> formalmente, podemos decir que se trata de un conjunto de tecnologías que permiten el procesamiento rápido y eficiente de conjuntos de datos dando la mayor importancia al rendimiento, la fiabilidad y la agilidad.</p>
</div>
<div class="paragraph">
<p>Si nos basamos en el acrónimo, el término se refiere a cualquier almacén de datos que no sigue un modelo relacional, los datos no son relacionales y por tanto no utilizan SQL como lenguaje de consulta. Así pues, los sistemas NoSQL se centran en sistemas complementarios a los SGBD relaciones, que fijan sus prioridades en la escalabilidad y la disponibilidad en contra de la atomicidad y consistencia de los datos.</p>
</div>
<div class="paragraph">
<p>NoSQL aparece como una necesidad debida al creciente volumen de datos sobre usuarios, objetos y productos que las empresas tienen que almacenar, así como la frecuencia con la que se accede a los datos. Los SGDB relacionales existentes no fueron diseñados teniendo en cuenta la escalabilidad ni la flexibilidad necesaria por las frecuentes modificaciones que necesitan las aplicaciones modernas; tampoco aprovechan que el almacenamiento a día de hoy es muy barato, ni el nivel de procesamiento que alcanzan las maquinas actuales.</p>
</div>
<div class="paragraph">
<p>Los diferentes tipos de bases de datos NoSQL existentes se pueden agrupar en cuatro categorías:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><em>Clave-Valor</em></dt>
<dd>
<p>Los almacenes clave-valor son las bases de datos NoSQL más simples. Cada elemento de la base de datos se almacena con un nombre de atributo (o clave) junto a su valor. Los almacenes más conocidos son <em>Redis</em>, <em>Riak</em> y <em>Voldemort</em>. Algunos almacenes, como es el caso de <em>Redis</em>, permiten que cada valor tenga un tipo (por ejemplo, <code>integer</code>) lo cual añade funcionalidad extra.</p>
</dd>
<dt class="hdlist1"><em>Documentales</em></dt>
<dd>
<p>Cada clave se asocia a una estructura compleja que se conoce como documento. Este puede contener diferentes pares clave-valor, o pares de clave-array o incluso documentos anidados, como en un documento JSON. Los ejemplos más conocidos son <em>MongoDB</em> y <em>CouchDB</em>.</p>
</dd>
<dt class="hdlist1"><em>Grafos</em></dt>
<dd>
<p>Los almacenes de grafos se usan para almacenar información sobre redes, como pueden ser conexiones sociales. Los ejemplos más conocidos son <em>Neo4J</em>, <em>FlockDB</em>, <em>InfiniteGraph</em> y <em>HyperGraphDB</em>.</p>
</dd>
<dt class="hdlist1"><em>Basada en columnas</em></dt>
<dd>
<p>Los almacenes basados en columnas como <em>BigTable</em>, <em>Hadoop</em>, <em>Cassandra</em> y <em>HBase</em> están optimizados para consultas sobre grandes conjuntos de datos, y almacenan los datos como columnas, en vez de como filas, de modo que cada fila puede contener un número diferente de columnas.</p>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql01/nosql-databases.jpg" alt="Sistemas NoSQL" width="66%">
</div>
<div class="title">Figure 1. Sistemas NoSQL</div>
</div>
<div class="paragraph">
<p>Estos tipos los estudiaremos en detalle más adelante, centrando gran parte del contenido en <em>MongoDB</em>.</p>
</div>
<div class="sect2">
<h3 id="_características">1.1. Características</h3>
<div class="paragraph">
<p>Si nos centramos en sus <strong>beneficios</strong> y los comparamos con las base de datos relacionales, las bases de datos NoSQL son más escalables, ofrecen un rendimiento mayor y sus modelos de datos resuelven varios problemas que no se plantearon al definir el modelo relacional:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Grandes volúmenes de datos estructurados, semi-estructurados y sin estructurar. Casi todas las implementaciones NoSQL ofrecen algún tipo de representación para datos sin esquema, lo que permite comenzar con una estructura y con el paso del tiempo, añadir nuevos campos, ya sean sencillos o anidados a datos ya existentes.</p>
</li>
<li>
<p>Sprints ágiles, iteraciones rápidas y frecuentes <em>commits/pushes</em> de código, al emplear una sintaxis sencilla para la realización de consultas y la posibilidad de tener un modelo que vaya creciendo al mismo ritmo que el desarrollo.</p>
</li>
<li>
<p>Arquitectura eficiente y escalable diseñada para trabajar con clusters en vez de una arquitectura monolítica y costosa. Las soluciones NoSQL soportan la escalabilidad de un modo transparente para el desarrollador.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_esquemas_dinámicos">1.1.1. Esquemas dinámicos</h4>
<div class="paragraph">
<p>Las bases de datos relacionales requieren definir los esquemas antes de añadir los datos. Una base de datos SQL necesita saber de antemano los datos que vamos a almacenar; por ejemplo, si nos centramos en los datos de un cliente, serían el nombre, apellidos, número de teléfono, etc&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Esto casa bastante mal con los enfoques de desarrollo ágil, ya que cada vez que añadimos nuevas funcionalidades, el esquema de la base de datos suele cambiar. De modo que si a mitad de desarrollo decidimos almacenar los productos favoritos de un cliente del cual guardábamos su dirección y números de teléfono, tendríamos que añadir una nueva columna a la base de datos y migrar la base de datos entera a un nuevo esquema.</p>
</div>
<div class="paragraph">
<p>Si la base de datos es grande, conlleva un proceso lento que implica parar el sistema durante un tiempo considerable. Si frecuentemente cambiamos los datos que la aplicación almacena (al usar un desarrollo iterativo), también tendremos períodos frecuentes de inactividad del sistema. Así pues, no hay un modo efectivo mediante una base de datos relacional, de almacenar los datos que están desestructurados o que no se conocen de antemano.</p>
</div>
<div class="paragraph">
<p>Las bases de datos <em>NoSQL</em> se construyen para permitir la inserción de datos sin un esquema predefinido. Esto facilita la modificación de la aplicación en tiempo real, sin preocuparse por interrupciones de servicio.</p>
</div>
<div class="paragraph">
<p>De este modo se consigue un desarrollo más rápido, integración de código más robusto y menos tiempo empleado en la administración de la base de datos.</p>
</div>
</div>
<div class="sect3">
<h4 id="_particionado">1.1.2. Particionado</h4>
<div class="paragraph">
<p>Dado el modo en el que se estructuran las bases de datos relacionales, normalmente escalan verticalmente - un único servidor que almacena toda la base de datos para asegurar la disponibilidad continua de los datos. Esto se traduce en costes que se incrementan rápidamente, con un límites definidos por el propio hardware, y en un pequeño número de puntos críticos de fallo dentro de la infraestructura de datos.</p>
</div>
<div class="paragraph">
<p>La solución es escalar horizontalmente, añadiendo nuevos servidores en vez de concentrarse en incrementar la capacidad de un único servidor. Este escalado horizontal se conoce como <strong><em>Sharding</em></strong> o <em>Particionado</em>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql01/particionado.jpg" alt="Particionado" width="50%">
</div>
<div class="title">Figure 2. Particionado</div>
</div>
<div class="paragraph">
<p>El particionado no es único de las bases de datos NoSQL. Las bases de datos relacionales también lo soportan. Si en un sistema relacional queremos particionar los datos, podemos distinguir entre particionado:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Horizontal</strong>: diferentes filas en diferentes particiones.</p>
</li>
<li>
<p><strong>Vertical</strong>: diferentes columnas en particiones distintas.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>En el caso de las bases de datos <em>NoSQL</em>, el particionado depende del modelo de la base de datos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Los almacenes clave-valor y las bases de datos documentales normalmente se particionan horizontalmente.</p>
</li>
<li>
<p>Las bases de datos basados en columnas se pueden particionar horizontal o verticalmente.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Escalar horizontalmente una base de datos relacional entre muchas instancias de servidores se puede conseguir pero normalmente conlleva el uso de SANs <span class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnote_1" title="View footnote.">1</a>]</span> y otras triquiñuelas para hacer que el hardware actúe como un único servidor.</p>
</div>
<div class="paragraph">
<p>Como los sistemas SQL no ofrecen esta prestación de forma nativa, los equipos de desarrollo se las tienen que ingeniar para conseguir desplegar múltiples bases de datos relacionales en varias máquinas. Para ello:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Los datos se almacenan en cada instancia de base de datos de manera autónoma</p>
</li>
<li>
<p>El código de aplicación se desarrolla para distribuir los datos y las consultas y agregar los resultados de los datos a través de todas las instancias de bases de datos</p>
</li>
<li>
<p>Se debe desarrollar código adicional para gestionar los fallos sobre los recursos, para realizar <em>joins</em> entre diferentes bases de datos, balancear los datos y/o replicarlos, etc&#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Además, muchos beneficios de las bases de datos como la integridad transaccional se ven comprometidos o incluso eliminados al emplear un escalado horizontal.</p>
</div>
<div class="sect4">
<h5 id="_auto_sharding">Auto-sharding</h5>
<div class="paragraph">
<p>Por contra, las bases de datos NoSQL normalmente soportan <em>auto-sharding</em>, lo que implica que de manera nativa y automáticamente se dividen los datos entre un número arbitrario de servidores, sin que la aplicación sea consciente de la composición del <em>pool</em> de servidores. Los datos y las consultas se balancean entre los servidores.</p>
</div>
<div class="paragraph">
<p>El particionado se realiza mediante un método consistente, como puede ser:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Por <strong>rangos</strong> de su id: por ejemplo <em>"los usuarios del 1 al millón están en la partición 1"</em> o <em>"los usuarios cuyo nombre va de la A a la E"</em> en una partición, en otra de la M a la Q, y de la R a la Z en la tercera.</p>
</li>
<li>
<p>Por <strong>listas</strong>: dividiendo los datos por la categoría del dato, es decir, en el caso de datos sobre libros, las novelas en una partición, las recetas de cocina en otra, etc..</p>
</li>
<li>
<p>Mediante un función <strong><em>hash</em></strong>, la cual devuelve un valor para un elemento que determine a que partición pertenece.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_cuando_particionar">Cuando particionar</h5>
<div class="paragraph">
<p>El motivo para particionar los datos se debe a:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>limitaciones de almacenamiento: los datos no caben en un único servidor, tanto a nivel de disco como de memoria RAM.</p>
</li>
<li>
<p>rendimiento: al balancear la carga entre particiones las escrituras serán más rápidas que al centrarlas en un único servidor.</p>
</li>
<li>
<p>disponibilidad: si un servidor esta ocupado, otro servidor puede devolver los datos. La carga de los servidores se reduce.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>No particionaremos los datos cuando la cantidad sea pequeña, ya que el hecho de distribuir los datos conlleva unos costes que pueden no compensar con un volumen de datos insuficiente. Tampoco esperaremos a particionar cuando tengamos muchísimos datos, ya que el proceso de particionado puede provocar sobrecarga del sistema.</p>
</div>
<div class="paragraph">
<p>La <em>nube</em> facilita de manera considerable este escalado, mediante proveedores como <em>Amazon Web Services</em> el cual ofrece virtualmente una capacidad ilimitada bajo demanda, y preocupándose de todas las tareas necesarias para la administración de la base de datos.</p>
</div>
<div class="paragraph">
<p>Los desarrolladores ya no necesitamos construir plataformas complejas para nuestras aplicaciones, de modo que nos podemos centrar en escribir código de aplicación. Una granja de servidores puede ofrecer el mismo procesamiento y capacidad de almacenamiento que un único servidor de alto rendimiento por mucho menos coste.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_replicación">1.1.3. Replicación</h4>
<div class="paragraph">
<p>La replicación mantiene copias idénticas de los datos en múltiples servidores, lo que facilita que las aplicaciones siempre funcionen y los datos se mantengan seguros, incluso si alguno de los servidores sufre algún problema.</p>
</div>
<div class="paragraph">
<p>La mayoría de las bases de datos NoSQL también soportan la replicación automática, lo que implica una alta disponibilidad y recuperación frente a desastres sin la necesidad de aplicaciones de terceros encargadas de ello. Desde el punto de vista del desarrollador, el entorno de almacenamiento es virtual y ajeno al código de aplicación.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql01/replicacion.jpg" alt="Replicación" width="50%">
</div>
<div class="title">Figure 3. Replicación</div>
</div>
<div class="paragraph">
<p>La replicación de los datos se utiliza para alcanzar:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>escalabilidad</strong>, incrementando el rendimiento al poder distribuir las consultas en diferentes nodos, y mejorar la rendundancia al permitir que cada nodo tenga una copia de los datos.</p>
</li>
<li>
<p><strong>disponibilidad</strong>, ofreciendo tolerancia a fallos de hardware o corrupción de la base de datos. Al replicar los datos vamos a poder tener una copia de la base de datos, dar soporte a un servidor de datos agregados, o tener nodos a modo de copias de seguridad que pueden tomar el control en caso de fallo.</p>
</li>
<li>
<p><strong>aislamiento</strong> (la i en ACID - <em>isolation</em>), entendido como la propiedad que define cuando y cómo al realizar cambios en un nodo se propagan al resto de nodos. Si replicamos los datos podemos crear copias sincronizadas que separar procesos de la base de datos de producción, pudiendo ejecutar informes o copias de seguridad en nodos secundarios de modo que no tenga un impacto negativo en el nodo principal, así como ofrecer un sistema sencillo para separar el entorno de producción del de preproducción.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
No hay que confundir la replicación (copia de los datos en varias máquinas) con la partición (cada máquina tiene un subconjunto de los datos). El entorno más seguro y con mejor rendimiento es aquel que tiene los datos particionados y replicados (cada maquina que tiene un subconjunto de los datos está replicada en 2 o más).
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_caché_integrada">1.1.4. Caché integrada</h4>
<div class="paragraph">
<p>Otra característica que comparten los sistemas NoSQL es que ofrecen un mecanismo de caché de datos integrado, de manera que se puede configurar los sistemas para que los datos se mantengan en memoria y se persistan de manera periodica. El uso de una caché conlleva que la consistencia de los datos no sea completa y podamos tener una consistencia eventual.</p>
</div>
<div class="paragraph">
<p>Existen diferentes productos que ofrecen un mecanismo de caché para los sistemas de bases de datos relacionales. Estos sistemas pueden incrementar el rendimiento de las lecturas de manera sustancial, pero no mejoran el rendimiento de las escrituras, y añaden un capa de complejidad al despliegue del sistema. Si en una aplicación predominan las lecturas, una cache distribuida como <em>MemCached</em> (<a href="http://www.memcached.org" class="bare">http://www.memcached.org</a>) puede ser una buena solución. Pero si en la aplicación las escrituras son más frecuentes, o se reparten al 50%, una caché distribuida puede no mejorar la experiencia global de los usuarios finales.</p>
</div>
<div class="paragraph">
<p>Muchas tecnologías de bases de datos relacionales tienen excelentes capacidades de caché integradas en sus soluciones, manteniendo en memoria los datos con mayor uso todo el tiempo posible y desechando la necesidad de una capa aparte a mantener.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_nosql_vs_sql">1.2. NoSQL vs. SQL</h3>
<div class="paragraph">
<p>A continuación vamos a comparar ambos sistemas:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. Comparación SQL vs NoSQL</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 40%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle"></th>
<th class="tableblock halign-left valign-top">Bases de Datos SQL</th>
<th class="tableblock halign-left valign-top">Bases de Datos NoSQL</th>
</tr>
</thead>
<tbody>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">Tipos</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Un tipo con pequeñas variantes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Muchos tipos distintos como almacenes clave-valor, base de datos documentales, basado en columnas o en grafos</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">Historia</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Desarrollado en los 70 para tratar la primera hornada de aplicaciones que almacenaban datos</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Desarrollado en el 2000 para ayudar a resolver las limitaciones de las bases de datos SQL, particularmente lo relacionado con la escalabilidad, replicación y almacenamiento de datos desestructurados</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">Ejemplos</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">MySQL, PostgreSQL, Oracle</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MongoDB, Cassandra, HBase, Neo4j</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">Modelo de almacenamiento</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Los registros individuales (por ejemplo, empleados) se almacenan como filas en tablas, donde cada columna almacena un atributo específico de ese registro (categoría, fecha de ingreso, etc..), similar a la forma tabular de una hoja de cálculo. Datos de tipos distintos se encuentran en tablas distintas, que se pueden unir al ejecutar consultas más complejas</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Varía dependiendo del tipo de base de datos. Por ejemplo, en los almacenes clave-valor se trabaja de manera similar a las bases de datos relacionales, pero con solo 2 columnas ("clave" y "valor"), y usando el campo "valor" para almacenar información más compleja. En cambio, las bases de datos documentales descartan el modelo de tabla para almacenar toda la información relevante en un único documento con JSON, XML o cualquier otro formato que permita anidar los valores de manera jerarquica.</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">Esquemas</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">La estructura y los tipos de datos se conocen de antemano. Para almacenar información sobre un nuevo atributo se debe modificar la base de datos al completo, tiempo durante el cual la base de datos queda inactiva</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Normalmente dinámica. Los registros pueden añadir información en caliente y almacenar información con diferente estructura en un mismo campo. En algunas bases de datos como los almacenes basados en columnas es un poco más costoso.</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">Escalado</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vertical: un único servidor que debe incrementar su potencia para tratar la demanda creciente. Se pueden repartir bases de datos SQL entre muchos servidores, pero requiere una configuración especial y desarrollo teniendo en cuenta esta configuración</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Horizontal: para añadir capacidad, el administrador de bases de datos simplemente puede añadir más servidores virtuales o instancias en la nube. La base de datos se propaga de manera automática entre los diferentes servidores añadidos.</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">Modelo de Desarrollo</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Repartido entre <em>open source</em> (p.ej. Postgres, MySQL) y software propietario (p.ej., Oracle, DB2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Open source</em></p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">Soporte de transacciones</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Si, las modificaciones se pueden configurar para que se realizan todas o ninguna</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">En algunas circunstancias y ciertos niveles (a nivel de documento <em>vs</em> a nivel a de base de datos)</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">Manipulación de Datos</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">SQL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mediante APIs orientadas a objetos</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">Consistencia</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configurable para consistencia alta</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Depende del producto. Algunos ofrecen gran consistencia (p.ej. MongoDB) mientras otros ofrecen consistencia eventual (p.ej. Cassandra)</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_implantando_nosql">1.3. Implantando NoSQL</h3>
<div class="paragraph">
<p>Normalmente, las empresas empezarán con una prueba de baja escalabilidad de una base de datos NoSQL, de modo que les permita comprender la tecnología asumiendo muy poco riesgo. La mayoría de las bases de datos NoSQL también son <em>open-source</em>, y por tanto se pueden probar sin ningún coste extra. Al tener unos ciclos de desarrollo más rápidos, las empresas pueden innovar con mayor velocidad y mejorar la experiencia de sus cliente a un menor coste.</p>
</div>
<div class="paragraph">
<p>Elegir la base de datos correcta para el proyecto es un tema importante. Se deben considerar las diferentes alternativas a las infraestructuras <em>legacy</em> teniendo en cuenta varios factores:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>la escalabilidad o el rendimiento más allá de las capacidades del sistema existente</p>
</li>
<li>
<p>identificar alternativas viables respecto al software propietario</p>
</li>
<li>
<p>incrementar la velocidad y agilidad del proceso de desarrollo</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Así pues, al elegir un base de datos hemos de tener en cuenta las siguientes dimensiones:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Modelo de Datos</strong>: A elegir entre un modelo documental, basado en columnas, de grafos o mediante clave-valor.</p>
</li>
<li>
<p><strong>Modelo de Consultas</strong>: Dependiendo de la aplicación, puede ser aceptable un modelo de consultas que sólo accede a los registros por su clave primaria. En cambio, otras aplicaciones pueden necesitar consultar por diferentes valores de cada registro. Además, si la aplicación necesita modificar los registros, la base de datos necesita consultar los datos por un índice secundario.</p>
</li>
<li>
<p><strong>Modelo de Consistencia</strong>: Los sistemas NoSQL normalmente mantienen múltiples copias de los datos para ofrecer disponibilidad y escalabilidad al sistema, lo que define la consistencia del mismo. Los sistemas NoSQL tienden a ser consistentes o eventualmente consistentes.</p>
</li>
<li>
<p><strong>APIs</strong>: No existe un estándar para interactuar con los sistemas <em>NoSQL</em>. Cada sistema presenta diferentes diseños y capacidades para los equipos de desarrollo.  La madurez de un API puede suponer una inversión en tiempo y dinero a la hora de desarrollar y mantener el sistema NoSQL.</p>
</li>
<li>
<p><strong>Soporte Comercial y de la Comunidad</strong>: Los usuarios deben considerar la salud de la compañia o de los proyectos al evaluar una base de datos. El producto debe evolucionar y se mantenga para introducir nuevas prestaciones y corregir fallos. Una base de datos con una comunidad fuerte de usuarios:</p>
<div class="ulist">
<ul>
<li>
<p>permite encontrar y contratar desarrolladores con destrezas en el producto.</p>
</li>
<li>
<p>facilita encontrar información, documentación y ejemplos de código.</p>
</li>
<li>
<p>ayuda a las empresas a retener el talento.</p>
</li>
<li>
<p>favorece que otras empresas de software integren sus productos y participen en el ecosistema de la base de datos.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_casos_de_uso">1.3.1. Casos de uso</h4>
<div class="paragraph">
<p>Una vez conocemos los diferentes sistemas y qué elementos puede hacer que nos decidamos por una solución u otra, conviene repasar los casos de uso más comunes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Si vamos a crear una aplicación web cuyo campos sean personalizables, usaremos una solución documental.</p>
</li>
<li>
<p>Como una capa de caché, mediante un almacén clave-valor.</p>
</li>
<li>
<p>Para almacenar archivos binarios sin preocuparse de la gestión de permisos del sistema de archivos, y porder realizar consultas sobre sus metadatos, ya sea mediante una solución documental o un almacén clave-valor.</p>
</li>
<li>
<p>Para almacenar un enorme volumen de datos, donde la consistencia no es lo más importante, pero si la disponibilidad y su capacidad de ser distribuida.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_modelos_de_datos">1.4. Modelos de datos</h3>
<div class="paragraph">
<p>La principal clasificación de los sistemas de BBDD NoSQL se realiza respecto a los diferentes modelos de datos:</p>
</div>
<div class="sect3">
<h4 id="_documental">1.4.1. Documental</h4>
<div class="paragraph">
<p>Mientras las bases de datos relacionales almacenan los datos en filas y columnas, las bases de datos documentales emplean documentos. Estos documentos utilizan una estructura JSON, ofreciendo un modo natural e intuitivo para modelar datos de manera similar a la orientación a objetos, donde cada documento es un objeto.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql01/document.png" alt="Representación de un documento" width="33%">
</div>
<div class="title">Figure 4. Representación de un documento</div>
</div>
<div class="paragraph">
<p>Los documentos se agrupan en colecciones o bases de datos, dependiendo del sistema, lo que permite agrupar documentos.</p>
</div>
<div class="paragraph">
<p>Los documentos contienen uno o más campos, donde cada campo contiene un valor con un tipo, ya sea cadena, fecha, binario o <em>array</em>. En vez de extender los datos entre múltiples columnas y tablas, cada registro y sus datos asociados se almacenan de manera unida en un único documento. Esto simplifica el acceso a los datos y reduce (y en ocasiones elimina) la necesidad de <em>joins</em> y transacciones complejas.</p>
</div>
<div class="sect4">
<h5 id="_características_2">Características</h5>
<div class="paragraph">
<p>En una base de datos documental, la noción de esquema es dinámico: cada documento puede contener diferentes campos. Esta flexibilidad puede ser útil para modelar datos desestructurados y polimórficos, lo que facilita la evolución del desarrollo al permitir añadir nuevos campos de manera dinámica.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, podemos tener dos documentos que pertenecen a la misma colección, pero con atributos diferentes:</p>
</div>
<div class="listingblock">
<div class="title">Datos de dos empleados</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="json"><span class="tok-p">{</span>
  <span class="tok-nt">&quot;EmpleadoID&quot;</span><span class="tok-p">:</span> <span class="tok-s2">&quot;BW1&quot;</span><span class="tok-p">,</span>
  <span class="tok-nt">&quot;Nombre&quot;</span>    <span class="tok-p">:</span> <span class="tok-s2">&quot;Bruce&quot;</span><span class="tok-p">,</span>
  <span class="tok-nt">&quot;Apellido&quot;</span>  <span class="tok-p">:</span> <span class="tok-s2">&quot;Wayne&quot;</span><span class="tok-p">,</span>
  <span class="tok-nt">&quot;Edad&quot;</span>      <span class="tok-p">:</span> <span class="tok-mi">35</span><span class="tok-p">,</span>
  <span class="tok-nt">&quot;Salario&quot;</span>   <span class="tok-p">:</span> <span class="tok-mi">10000000</span>
<span class="tok-p">}</span>

<span class="tok-p">{</span>
  <span class="tok-nt">&quot;EmpleadoID&quot;</span><span class="tok-p">:</span> <span class="tok-s2">&quot;JK1&quot;</span><span class="tok-p">,</span>
  <span class="tok-nt">&quot;Nombre&quot;</span>    <span class="tok-p">:</span> <span class="tok-s2">&quot;Joker&quot;</span><span class="tok-p">,</span>
  <span class="tok-nt">&quot;Edad&quot;</span>      <span class="tok-p">:</span> <span class="tok-mi">34</span><span class="tok-p">,</span>
  <span class="tok-nt">&quot;Salary&quot;</span>    <span class="tok-p">:</span> <span class="tok-mi">5000000</span><span class="tok-p">,</span>
  <span class="tok-nt">&quot;Direccion&quot;</span> <span class="tok-p">:</span> <span class="tok-p">{</span>
    <span class="tok-nt">&quot;Lugar&quot;</span>   <span class="tok-p">:</span> <span class="tok-s2">&quot;Asilo Arkham&quot;</span><span class="tok-p">,</span>
    <span class="tok-nt">&quot;Ciudad&quot;</span>  <span class="tok-p">:</span> <span class="tok-s2">&quot;Gotham&quot;</span>
  <span class="tok-p">},</span>
  <span class="tok-nt">&quot;Proyectos&quot;</span> <span class="tok-p">:</span> <span class="tok-p">[</span>
    <span class="tok-s2">&quot;desintoxicacion-virus&quot;</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;top-secret-007&quot;</span>
  <span class="tok-p">]</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Normalmente, cada documento contiene un elemento clave, sobre el cual se puede obtener un documento de manera unívoca. De todos modos, las bases de datos documentales ofrecen un completo mecanismo de consultas, posibilitando obtener información por cualquier campo del documento. Algunos productos ofrecen opciones de indexado para optimizar las consultas, como pueden ser índices compuestos, dispersos, con tiempo de vida (TTL), únicos, de texto o geoespaciales.</p>
</div>
<div class="paragraph">
<p>Además, estos sistemas ofrecen productos que permiten analizar los datos, mediante funciones de agregación o implementación de <em>MapReduce</em>.</p>
</div>
<div class="paragraph">
<p>Respecto a la modificaciones, los documentos se pueden actualizar en una única sentencia, sin necesidad de dar rodeos para elegir los datos a modificar.</p>
</div>
</div>
<div class="sect4">
<h5 id="_casos_de_uso_2">Casos de uso</h5>
<div class="paragraph">
<p>Las bases de datos documentales sirven para propósito general, válidos para un amplio abanico de aplicaciones gracias a la flexibilidad que ofrece el modelo de datos, lo que permite consultar cualquier campo y modelar de manera natural de manera similar a la programación orientada a objetos.</p>
</div>
<div class="paragraph">
<p>Entre los casos de éxito de estos sistemas cabe destacar:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Sistemas de flujo de eventos: entre diferentes aplicaciones dentro de una empresa</p>
</li>
<li>
<p>Gestores de Contenido, plataformas de Blogging: al almacenar los documentos mediante JSON, facilita la estructura de datos para guardar los comentarios, registros de usuarios, etc&#8230;&#8203;</p>
</li>
<li>
<p>Analíticas Web, datos en Tiempo Real: al permitir modificar partes de un documento, e insertar nuevos atributos a un documento cuando se necesita una nueva métrica</p>
</li>
<li>
<p>Aplicaciones eCommerce: conforme las aplicaciones crecen, el esquema también lo hace</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Si nos centramos en aquellos casos donde no conviene este tipo de sistemas podemos destacar:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Sistemas operaciones con transacciones complejas</p>
</li>
<li>
<p>Sistemas con consultas agregadas que modifican su estructura. Si los criterios de las consultas no paran de cambiar, acabaremos normalizando los datos.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Los productos más destacados son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>MongoDB</em>: <a href="http://www.mongodb.com" class="bare">http://www.mongodb.com</a></p>
</li>
<li>
<p><em>CouchDB</em>: <a href="http://couchdb.apache.org" class="bare">http://couchdb.apache.org</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Al final de la sesión y en el resto del módulo instalaremos, configuraremos y utilizaremos <em>MongoDB</em> en profundidad.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_clave_valor">1.4.2. Clave-Valor</h4>
<div class="paragraph">
<p>Un almacén clave-valor es una simple tabla <em>hash</em> donde todos los accesos a la base de datos se realizan a través de la clave primaria.</p>
</div>
<div class="paragraph">
<p>Desde una perspectiva de modelo de datos, los almacenes de clave-valor son los más básicos.</p>
</div>
<div class="paragraph">
<p>Su funcionamiento es similar a tener una tabla relacional con dos columnas, por ejemplo <code>id</code> y <code>nombre</code>, siendo <code>id</code> la columna utilizada como clave y <code>nombre</code> como valor. Mientras que en una base de datos en el campo `nombre ` sólo podemos almacenar datos de tipo cadena, en un almacén clave-valor, el valor puede ser de un dato simple o un objeto. Cuando una aplicación accede mediante la clave y el valor, se almacenan el par de elementos. Si la clave ya existe, el valor se modifica.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql01/key-value.jpg" alt="Representación de un almacén _key-value_" width="50%">
</div>
<div class="title">Figure 5. Representación de un almacén <em>key-value</em></div>
</div>
<div class="paragraph">
<p>El cliente puede tanto obtener el valor por la clave, asignar un valor a una clave o eliminar una clave del almacén. El valor, sin embargo, es opaco al sistema, el cual no sabe que hay dentro de él, ya que los datos sólo se pueden consultar por la clave, lo cual puede ser un inconveniente. Así pues, la aplicación es responsable de saber qué hay almacenado en cada valor.</p>
</div>
<div class="listingblock">
<div class="title">Interactuando con Riak medianta Java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">Bucket</span> <span class="tok-n">bucket</span> <span class="tok-o">=</span> <span class="tok-n">getBucket</span><span class="tok-o">(</span><span class="tok-n">bucketName</span><span class="tok-o">);</span>  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-n">IRiakObject</span> <span class="tok-n">riakObject</span> <span class="tok-o">=</span> <span class="tok-n">bucket</span><span class="tok-o">.</span><span class="tok-na">store</span><span class="tok-o">(</span><span class="tok-n">key</span><span class="tok-o">,</span> <span class="tok-n">value</span><span class="tok-o">).</span><span class="tok-na">execute</span><span class="tok-o">();</span>

<span class="tok-n">IRiakObject</span> <span class="tok-n">riakObject</span> <span class="tok-o">=</span> <span class="tok-n">bucket</span><span class="tok-o">.</span><span class="tok-na">fetch</span><span class="tok-o">(</span><span class="tok-n">key</span><span class="tok-o">).</span><span class="tok-na">execute</span><span class="tok-o">();</span>
<span class="tok-kt">byte</span><span class="tok-o">[]</span> <span class="tok-n">bytes</span> <span class="tok-o">=</span> <span class="tok-n">riakObject</span><span class="tok-o">.</span><span class="tok-na">getValue</span><span class="tok-o">();</span>
<span class="tok-n">String</span> <span class="tok-n">value</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">String</span><span class="tok-o">(</span><span class="tok-n">bytes</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Riak utiliza el concepto de <em>bucket</em> (cubo) como una manera de agrupar claves, de manera similar a una tabla</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Interactuando con Riak medianta HTTP</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">curl -v -X PUT http://localhost:8091/riak/heroes/ace -H <span class="tok-s2">&quot;Content-Type: application/json&quot;</span> -d <span class="tok-o">{</span><span class="tok-s2">&quot;nombre&quot;</span> : <span class="tok-s2">&quot;Batman&quot;</span>, <span class="tok-s2">&quot;color&quot;</span> : <span class="tok-s2">&quot;Negro&quot;</span><span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Algunos almacenes clave-valor, como puede ser <em>Redis</em>, permiten almacenar datos con cualquier estructura, como por ejemplos listas, conjuntos, <em>hashes</em> y pueden realizar operaciones como intersección, unión, diferencia y rango.</p>
</div>
<div class="listingblock">
<div class="title">Interactuando con Redis</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="redis">SET nombre &quot;Bruce Wayne&quot;      //String
HSET heroe nombre &quot;Batman&quot;    // Hash – set
HSET heroe color &quot;Negro&quot;
SADD &quot;heroe:amigos&quot; &quot;Robin&quot; &quot;Alfred&quot;   // Set – create/update</code></pre>
</div>
</div>
<div class="paragraph">
<p>Estas prestaciones hacen que <em>Redis</em> se extrapole a ámbitos ajenos a un almacén clave-valor. Otra característica que ofrecen algunos almacenes es que permiten crear un segundo nivel de consulta o incluso definir más de una clave para un mismo objeto.</p>
</div>
<div class="paragraph">
<p>Como los almacenes clave-valor siempre utilizan accesos por clave primaria, de manera general tienen un gran rendimiento y son fácilmente escalables.</p>
</div>
<div class="paragraph">
<p>Si queremos que su rendimiento sea máximo, pueden configurarse para que mantegan la información en memoria y que se serialice de manera periódica, a costa de tener una consistencia eventual de los datos.</p>
</div>
<div class="sect4">
<h5 id="_casos_de_uso_3">Casos de uso</h5>
<div class="paragraph">
<p>Este modelo es muy útil para representar datos desestructurados o polimórficos, ya que no fuerzan ningún esquema más allá de los pares de clave-valor.</p>
</div>
<div class="paragraph">
<p>Entre los casos de uso de estos almacenes podemos destacar el almacenaje de:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Información sobre la sesión de navegación (<code>sessionid</code>)</p>
</li>
<li>
<p>Perfiles de usuario, preferencias</p>
</li>
<li>
<p>Datos del carrito de la compra</p>
</li>
<li>
<p>Cachear datos</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Todas estas operaciones van a asociada a operaciones de recuperación, modificación o inserción de los datos de una sola vez, de ahí su elección.</p>
</div>
<div class="paragraph">
<p>En cambio, no conviene utilizar estos almacenes cuando queremos realizar:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Relaciones entre datos</p>
</li>
<li>
<p>Transacciones entre varias operaciones</p>
</li>
<li>
<p>Consultas por los datos del valor</p>
</li>
<li>
<p>Operaciones con conjuntos de claves</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Los almacenes más empleados son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Riak</em>: <a href="http://basho.com/riak/" class="bare">http://basho.com/riak/</a></p>
</li>
<li>
<p><em>Redis</em>: <a href="http://redis.io" class="bare">http://redis.io</a></p>
</li>
<li>
<p><em>Voldemort</em>: <a href="https://github.com/voldemort/voldemort" class="bare">https://github.com/voldemort/voldemort</a> implementación <em>open-source</em> de <em>Amazon DynamoDB</em> <a href="http://aws.amazon.com/dynamodb" class="bare">http://aws.amazon.com/dynamodb</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_basado_en_columnas">1.4.3. Basado en columnas</h4>
<div class="paragraph">
<p>También conocidos como sistemas <em>Big Data</em> o tabulares. Su nombre viene tras la implementación de <em>Google</em> de <em>BigTable</em> (<a href="http://research.google.com/archive/bigtable.html" class="bare">http://research.google.com/archive/bigtable.html</a>), el cual consiste en columnas separadas y sin esquema, a modo de mapa de dos niveles.</p>
</div>
<div class="paragraph">
<p>Las bases de datos relacionales utilizan la fila como unidad de almacenamiento, lo que permite un buen rendimiento de escritura. Sin embargo, cuando las escrituras son ocasionales y es más comun tener que leer unas pocas columnas de muchas filas a la vez, es mejor utilizar como unidad de almacenamiento a grupos de columnas.</p>
</div>
<div class="paragraph">
<p>Un modelo basado en columnas se representa como una estructura agregada de dos niveles. El primer nivel formado por un almacén clave-valor, siendo la clave el identificador de la fila, y el valor un nuevo mapa con los datos agregados de la fila (familias de columnas). Los valores de este segundo nivel son las columnas. De este modo, podemos acceder a los datos de un fila, o a una determinada columna:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql01/column.jpg" alt="Representación de un almacén basado en columnas" width="50%">
</div>
<div class="title">Figure 6. Representación de un almacén basado en columnas</div>
</div>
<div class="paragraph">
<p>Los almacenes basados en columnas utilizan un mapa ordenado multi-dimensional y distribuido para almacenar los datos. Están pensados para que cada fila tenga una gran número de columnas (del orden del millón), almacenando las diferentes versiones que tenga una fila (pudiendo almacenar del orden de miles de millones de filas).</p>
</div>
<div class="sect4">
<h5 id="_familias_de_columnas">Familias de columnas</h5>
<div class="paragraph">
<p>Una columna consiste en un pareja <code>name</code>-<code>value</code>, donde el nombre hace de clave. Además, contiene un atributo <code>timestamp</code> para poder expirar datos y resolver conflictos de escritura.</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo de columna</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-p">{</span>
  <span class="tok-nx">name</span><span class="tok-o">:</span> <span class="tok-s2">&quot;nombre&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">value</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Bruce&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">timestamp</span><span class="tok-o">:</span> <span class="tok-mi">12345667890</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Una fila es una colección de columnas agrupadas a una clave. Si agrupamos filas similares tendremos una <strong>familia de columnas</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-c1">// familia de columnas</span>
<span class="tok-p">{</span>
  <span class="tok-c1">// fila</span>
  <span class="tok-s2">&quot;tim-gordon&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-nx">nombre</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Tim&quot;</span><span class="tok-p">,</span>
    <span class="tok-nx">apellido</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Gordon&quot;</span><span class="tok-p">,</span>
    <span class="tok-nx">ultimaVisita</span><span class="tok-o">:</span> <span class="tok-s2">&quot;2015/12/12&quot;</span>
  <span class="tok-p">}</span>
  <span class="tok-c1">// fila</span>
  <span class="tok-s2">&quot;bruce-wayne&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-nx">nombre</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Bruce&quot;</span><span class="tok-p">,</span>
    <span class="tok-nx">apellido</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Wayne&quot;</span><span class="tok-p">,</span>
    <span class="tok-nx">lugar</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Gotham&quot;</span>
  <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cada registro puede variar en el número de columnas con el que se almacena, y las columnas se pueden anidar dentro de otras formando <strong>super-columnas</strong>, donde el valor es un nuevo mapa de columnas.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><span class="tok-p">{</span>
  <span class="tok-nx">name</span><span class="tok-o">:</span> <span class="tok-s2">&quot;libro:978-84-16152-08-7&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">value</span><span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-nx">autor</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Grant Morrison&quot;</span><span class="tok-p">,</span>
    <span class="tok-nx">titulo</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Batman - Asilo Arkham&quot;</span><span class="tok-p">,</span>
    <span class="tok-nx">isbn</span><span class="tok-o">:</span> <span class="tok-s2">&quot;978-84-16152-08-7&quot;</span>
  <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cuando se utilizan super columnas para crear familias de columnas tendremos una familia de super columnas.</p>
</div>
<div class="paragraph">
<p>En resumen, las bases de datos basadas en columnas, almacenan los datos en familias de columnas como filas, las cuales tienen muchas columnas asociadas al identificador de una fila. Las familias de columnas son grupos de datos relacionados, a las cuales normalmente se accede de manera conjunta.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql01/column-family.jpg" alt="Familia de columnas" width="50%">
</div>
<div class="title">Figure 7. Familia de Columnas</div>
</div>
</div>
<div class="sect4">
<h5 id="_operaciones">Operaciones</h5>
<div class="paragraph">
<p>A la hora de consultar los datos, éstos se pueden obtener por la clave primaria de la familia. Así pues, podemos obtener toda una familia, o la columna de una familia:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cassandra">// Mediante Cassandra
GET Clientes[&#39;bruce-wayne&#39;];  // familia
GET Clientes[&#39;bruce-wayne&#39;][&#39;lugar&#39;]; // columna</code></pre>
</div>
</div>
<div class="paragraph">
<p>Algunos productos ofrecen un soporte limitado para índices secundarios, pero con restricciones. Por ejemplo, <em>Cassandra</em> ofrece el lenguaje CQL similar a SQL pero sin <em>joins</em>, ni subconsultas donde las restricciones de <code>where</code> son sencillas:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cql">SELECT * FROM Clientes
SELECT nombre,email FROM Clientes
SELECT nombre,email FROM Clientes WHERE lugar=&#39;Gotham&#39;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Las actualizaciones se realizan en dos pasos: primero encontrar el registro y segundo modificarlo. En estos sistemas, una modificación puede suponer una reescritura completa del registro independientemente que hayan cambiado unos pocos <em>bytes</em> del mismo.</p>
</div>
</div>
<div class="sect4">
<h5 id="_casos_de_uso_4">Casos de uso</h5>
<div class="paragraph">
<p>De manera similar a los almacenes clave-valor, el mercado de estos sistemas son las aplicaciones que sólo necesitan consultar los datos por un único valor. En cambio, estas aplicaciones centran sus objetivos en el rendimiento y la escalabilidad.</p>
</div>
<div class="paragraph">
<p>Entre los casos de uso destacamos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Sistemas de flujo de eventos: para almacenar estados de las aplicaciones o errores de las mismas.</p>
</li>
<li>
<p>Gestores de Contenido, plataformas de Blogging: mediante familias de columnas podemos almacenar las entradas y las etiquetas, categorías, enlaces, <em>trackbacks</em> en columnas. Los comentarios se pueden almacenar en la misma fila o en otra base de datos.</p>
</li>
<li>
<p>Contadores: para poder almacenar las visitas de cada visitante a cada apartado de un <em>site</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Si nos centramos en aquellos casos donde no conviene este tipo de sistemas podemos destacar:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Sistemas operacionales con transacciones complejas</p>
</li>
<li>
<p>Sistemas con consultas agregadas. Si los criterios de las consultas no paran de cambiar, acabaremos normalizando los datos.</p>
</li>
<li>
<p>Prototipado inicial o sistemas donde el esquema no esté fijado de antemano, ya que las consultas dependen del diseño de las familias de columnas.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Los productos más destacados son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>HBase</em> : <a href="http://hbase.apache.org" class="bare">http://hbase.apache.org</a>, el cual se basa en <em>Hadoop</em> - <a href="http://hadoop.apache.org" class="bare">http://hadoop.apache.org</a></p>
</li>
<li>
<p><em>Cassandra</em> : <a href="http://cassandra.apache.org" class="bare">http://cassandra.apache.org</a></p>
</li>
<li>
<p><em>Amazon SimpleDB</em>: <a href="http://aws.amazon.com/simpledb" class="bare">http://aws.amazon.com/simpledb</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_grafos">1.4.4. Grafos</h4>
<div class="paragraph">
<p>Las bases de datos de grafos almacenan entidades y las relaciones entre estas entidades. Las entidades se conocen como nodos, los cuales tienen propiedades. Cada nodo es similar a una instancia de un objeto. Las relaciones, también conocidas como vértices, a su vez tienen propiedades, y su sentido es importante.</p>
</div>
<div class="paragraph">
<p>Los nodos se organizan mediante relaciones que facilitan encontrar patrones de información existente entre los nodos. Este tipo de organización permite almacenar los datos una vez e interpretar los datos de diferentes maneras dependiendo de sus relaciones.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql01/graph.jpg" alt="Estructura de Grafo" width="50%">
</div>
<div class="title">Figure 8. Estructura de Grafo</div>
</div>
<div class="paragraph">
<p>Los nodos son entidades que tienen propiedades, tales como el nombre. Por ejemplo, en el gráfico cada nodo tiene una propiedad nombre. También podemos ver que las relaciones tienen tipos, como <em>likes</em>, <em>author</em>, etc&#8230;&#8203; Estas propiedades permiten organizar los nodos. Las relaciones pueden tener múltiples propiedades, y además tienen dirección, con lo cual si queremos incluir bidireccionalidad tenemos que añadir dos relaciones en sentidos opuestos.</p>
</div>
<div class="listingblock">
<div class="title">Creando un grafo mediante Neo4J</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">Node</span> <span class="tok-n">martin</span> <span class="tok-o">=</span> <span class="tok-n">graphDb</span><span class="tok-o">.</span><span class="tok-na">createNode</span><span class="tok-o">();</span>
<span class="tok-n">martin</span><span class="tok-o">.</span><span class="tok-na">setProperty</span><span class="tok-o">(</span><span class="tok-s">&quot;name&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Martin&quot;</span><span class="tok-o">);</span>
<span class="tok-n">Node</span> <span class="tok-n">pramod</span> <span class="tok-o">=</span> <span class="tok-n">graphDb</span><span class="tok-o">.</span><span class="tok-na">createNode</span><span class="tok-o">();</span>
<span class="tok-n">pramod</span><span class="tok-o">.</span><span class="tok-na">setProperty</span><span class="tok-o">(</span><span class="tok-s">&quot;name&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Pramod&quot;</span><span class="tok-o">);</span>

<span class="tok-n">martin</span><span class="tok-o">.</span><span class="tok-na">createRelationshipTo</span><span class="tok-o">(</span><span class="tok-n">pramod</span><span class="tok-o">,</span> <span class="tok-n">FRIEND</span><span class="tok-o">);</span>
<span class="tok-n">pramod</span><span class="tok-o">.</span><span class="tok-na">createRelationshipTo</span><span class="tok-o">(</span><span class="tok-n">martin</span><span class="tok-o">,</span> <span class="tok-n">FRIEND</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Los nodos permiten tener diferentes tipos de relaciones entre ellos y así representar relaciones entre las entidades del dominio, y tener relaciones secundarias para características como categoría, camino, árboles de tiempo, listas enlazas para acceso ordenado, etc&#8230;&#8203;  Al no existir un límite en el número ni en el tipo de relaciones que puede tener un nodo, todas se pueden representar en la misma base de datos.</p>
</div>
<div class="sect4">
<h5 id="_traversing">Traversing</h5>
<div class="paragraph">
<p>Una vez tenemos creado un grafo de nodos y relaciones, podemos consultar el grafo de muchas maneras; por ejemplo "obtener todos los nodos que trabajan para <em>Big Co</em> y que les gusta <em>NoSQL Distilled</em>". Realizar una consulta se conoce como hacer un <em>traversing</em> (recorrido) del mismo.</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo de <em>Traversing</em> mediante Neo4J</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">Node</span> <span class="tok-n">martin</span> <span class="tok-o">=</span> <span class="tok-n">nodeIndex</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-s">&quot;name&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Martin&quot;</span><span class="tok-o">).</span><span class="tok-na">getSingle</span><span class="tok-o">();</span>
<span class="tok-n">allRelationships</span> <span class="tok-o">=</span> <span class="tok-n">martin</span><span class="tok-o">.</span><span class="tok-na">getRelationships</span><span class="tok-o">(</span><span class="tok-n">Direction</span><span class="tok-o">.</span><span class="tok-na">INCOMING</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Una ventaja a destacar de las bases de datos basadas en grafos es que podemos cambiar los requisitos de <em>traversing</em> sin tener que cambiar los nodos o sus relaciones.</p>
</div>
<div class="paragraph">
<p>En las bases de datos de grafos, recorrer las relaciones es muy rápido, ya que no se calculan en tiempo de consulta, sino que se persisten como una relación, y por tanto no hay que hacer ningún cálculo.</p>
</div>
<div class="paragraph">
<p>En cambio, en una base de datos relacional, para crear una estructura de grafo se realiza para una relación sencilla (¿Quien es mi jefe?"). Para poder añadir otras relaciones necesitamos muchos cambios en el esquema y trasladar datos entre tablas. Además, necesitamos de antemano saber que consultar queremos realizar para modelar las tablas y las relaciones acorde a las consultas.</p>
</div>
<div class="paragraph">
<p>Así pues, estos sistemas ofrecen ricos modelos de consultas donde se pueden investigar las relaciones simples y complejas entre los nodos para obtener información directa e indirecta de los datos del sistemas. Los tipos de análisis que se realizan sobre estos sistema se ciñen a los tipos de relación existente entre los datos.</p>
</div>
</div>
<div class="sect4">
<h5 id="_casos_de_uso_5">Casos de uso</h5>
<div class="paragraph">
<p>Mientras que el modelo de grafos no es muy intuitivo y tiene una importante curva de aprendizaje, se puede usar en un gran número de aplicaciones.</p>
</div>
<div class="paragraph">
<p>Su principal atractivo es que facilitan almacenar las relaciones entre entidades de una aplicación, como por ejemplo de una red social, o las intersecciones existentes entre carreteras. Es decir, se emplean para almacenar datos que se representan como nodos interconectados.</p>
</div>
<div class="paragraph">
<p>Por lo tanto, los casos de uso son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Datos conectados: redes sociales con diferentes tipos de conexiones entre los usuarios.</p>
</li>
<li>
<p>Enrutamiento, entrega o servicios basados en la posición: si las relaciones almacenan la distancia entre los nodos, podemos realizar consultas sobre lugares cercanos, trayecto más corto, etc&#8230;&#8203;</p>
</li>
<li>
<p>Motores de recomendaciones: de compras, de lugares visitados, etc&#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>En cambio, no se recomienda su uso cuando necesitemos modificar todos o un subconjunto de entidades, ya que modificar una propiedad en todos los nodos es una operación compleja.</p>
</div>
<div class="paragraph">
<p>Los productos más destacados son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Neo4j</em>: <a href="http://neo4j.com" class="bare">http://neo4j.com</a></p>
</li>
<li>
<p><em>FlockDB</em>: <a href="https://github.com/twitter/flockdb" class="bare">https://github.com/twitter/flockdb</a></p>
</li>
<li>
<p><em>HyperGraphDB</em>: <a href="http://www.hypergraphdb.org/index" class="bare">http://www.hypergraphdb.org/index</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_consistencia">1.5. Consistencia</h3>
<div class="paragraph">
<p>En un sistema consistente, las escrituras de una aplicación son visibles en siguientes consultas. Con una consistencia eventual, las escrituras no son visibles inmediatamente.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, en un sistema de control de <em>stock</em>, si el sistema es consistente, cada consulta obtendrá el estado real del inventario, mientras que si tiene consistencia eventual, puede que no sea el estado real en un momento concreto pero terminará siéndolo en breve.</p>
</div>
<div class="sect3">
<h4 id="_sistemas_consistentes">1.5.1. Sistemas consistentes</h4>
<div class="paragraph">
<p>Cada aplicación tiene diferentes requisitos para la consistencia de los datos. Para muchas aplicaciones, es imprescindible que los datos sean consistentes en todo momento. Como los equipos de desarrollo han estado trabajo con un modelo de datos relacional durante décadas, este enfoque parece natural. Sin embargo, en otras ocasiones, la consistencia eventual es un traspiés aceptable si conlleva una mayor flexibilidad en la disponibilidad del sistema.</p>
</div>
<div class="paragraph">
<p>Las bases de datos documentales y de grafos pueden ser consistentes o eventualmente consistentes. Por ejemplo, <em>MongoDB</em> ofrece un consistencia configurable. De manera predeterminada, los datos son consistentes, de modo que todas las escrituras y lecturas se realizan sobre la copia principal de los datos. Pero como opción, las consultas de lectura, se pueden realizar con las copias secundarias donde los datos tendrán consistencia eventual. La elección de la consistencia se realiza a nivel de consulta.</p>
</div>
</div>
<div class="sect3">
<h4 id="_sistemas_de_consistencia_eventual">1.5.2. Sistemas de consistencia eventual</h4>
<div class="paragraph">
<p>Con los sistemas eventualmente consistentes, hay un período de tiempo en el que todas las copias de los datos no están sincronizados. Esto puede ser aceptable para aplicaciones de sólo-lectura y almacenes de datos que no cambian frecuentemente, como los archivos históricos. Dentro del mismo saco podemos meter las aplicaciones con alta tasa de escritura donde las lecturas sean poco frecuentes, como un archivo de <em>log</em>.</p>
</div>
<div class="paragraph">
<p>Un claro ejemplo de sistema eventualmente consistente es el servicio DNS, donde tras registrar un dominio, puede tardar varios días en propagar los datos a través de Internet, pero siempre están disponibles aunque contenga una versión antigua de los datos.</p>
</div>
<div class="paragraph">
<p>Respecto a las bases de datos NoSQL, los almacenes de clave-valor y los basados en columnas son sistemas eventualmente consistentes. Estos tienen que soportar conflictos en las actualizaciones de registros individuales.</p>
</div>
<div class="paragraph">
<p>Como las escrituras se pueden aplicar a cualquier copia de los datos, puede ocurrir, y no sería muy extraño, que hubiese un conflicto de escritura.</p>
</div>
<div class="paragraph">
<p>Algunos sistemas como <em>Riak</em> utilizan vectores de reloj para determinar el orden de los eventos y asegurar que la operación más reciente gana en caso de un conflicto.</p>
</div>
<div class="paragraph">
<p>Otros sistemas como <em>CouchDB</em>, retienen todos los valores conflictivos y permiten al usuario resolver el conflicto. Otro enfoque seguido por <em>Cassandra</em> sencillamente asume que el valor más grande es el correcto.</p>
</div>
<div class="paragraph">
<p>Por estos motivos, las escrituras tienden a comportarse bien en sistemas eventualmente consistentes, pero las actualizaciones pueden conllevar sacrificios que complican la aplicación.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_teorema_de_cap">1.6. Teorema de CAP</h3>
<div class="paragraph">
<p>Propuesto por <em>Eric Brewer</em> en el año 2000, prueba que podemos crear una base de datos distribuida que elija dos de las siguientes tres características:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>C</strong>onsistencia: las escrituras son atómicas y todas las peticiones posteriores obtienen el nuevo valor, independientemente del lugar de la petición.</p>
</li>
<li>
<p>Disponibilidad (<em><strong>A</strong>vailable</em>): la base de datos devolverá siempre un valor. En la práctica significa que no hay <em>downtime</em>.</p>
</li>
<li>
<p>Tolerancia a <strong>P</strong>articiones: el sistema funcionará incluso si la comunicación con un servidor se interrumpe de manera temporal (para ello, ha de dividir los datos entre diferentes nodos).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>En otras palabras, podemos crear un sistema de base de datos que sea consistente y tolerante a particiones (<strong>CP</strong>), un sistema que sea disponible y tolerante a particiones (<strong>AP</strong>), o un sistema que sea consistente y disponible (<strong>CA</strong>). Pero no es posible crear una base de datos distribuida que sea consistente, disponible y tolerante a particiones al mismo tiempo.</p>
</div>
<div class="imageblock" style="float: right">
<div class="content">
<img src="images/nosql01/teorema.png" alt="Teorema de CAP" width="66%">
</div>
</div>
<div class="paragraph">
<p>El teorema CAP es útil cuando consideramos el sistema de base de datos que necesitamos, ya que nos permite decidir cual de las tres características vamos a descartar. La elección realmente se centra entre la disponibilidad y la consistencia, ya que la tolerancia a particiones es una decisión de arquitectura (sea o no distribuida).</p>
</div>
<div class="paragraph">
<p>Aunque el teorema dicte que si en un sistema distribuido elegimos disponibilidad no podemos tener consistencia, todavía podemos obtener consistencia eventual. Es decir, cada nodo siempre estará disponible para servir peticiones, aunque estos nodos no puedan asegurar que la información que contienen sea consistente (pero si bastante precisa), en algún momento lo será.</p>
</div>
<div class="paragraph">
<p>Algunas bases de datos tolerantes a particiones se pueden ajustar para ser más o menos consistentes o disponible a nivel de petición. Por ejemplo, <em>Riak</em> trabaja de esta manera, permitiendo a los clientes decidir en tiempo de petición que nivel de consistencia necesitan.</p>
</div>
<div class="sect3">
<h4 id="_clasificación_según_cap">1.6.1. Clasificación según CAP</h4>
<div class="paragraph">
<p>El siguiente gráfico muestra como dependiendo de estos atributos podemos clasificar los sistemas NoSQL:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql01/CAP.jpg" alt="Triángulo de CAP" width="66%">
</div>
</div>
<div class="paragraph">
<p>Así pues, las bases de datos NoSQL se clasifican en:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>CP</strong>: Consistente y tolerantes a particiones. Tanto <em>MongoDB</em> como <em>HBase</em> son CP, ya que dentro de una partición pueden no estar disponibles para responder una determinada consulta (por ejemplo, evitando lecturas en los nodos esclavo), aunque son tolerantes a fallos porque cualquier nodo secundario se puede convertir en principal y asumir el rol del nodo caído.</p>
</li>
<li>
<p><strong>AP</strong>: Disponibles y tolerantes a particiones. <em>CouchDB</em> permite replicar los datos entre sus nodos aunque no garantiza la consistencia en ninguno de los sus servidores.</p>
</li>
<li>
<p><strong>CA</strong>: Consistentes y disponible. Aquí es donde situaríamos a los SGDB relacionales. Por ejemplo, <em>Redis</em>, <em>PostreSQL</em> y <em>Neo4J</em> son CA, ya que no distribuyen los datos y por tanto la partición no es una restricción.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Lo bueno es que la gran mayoría de sistemas permiten configurarse para cambiar su tipo CAP, lo que permite que <em>MongoDB</em> pase de CP a AP, o <em>CouchDB</em> de AP a CP.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_mongodb">1.7. MongoDB</h3>
<div class="paragraph">
<p><em>MongoDB</em> (<a href="http://www.mongodb.org" class="bare">http://www.mongodb.org</a>) es una de las bases de datos NoSQL más conocidas. Sigue un modelo de datos documental, donde los documentos se basan en JSON.</p>
</div>
<div class="paragraph">
<p><em>MongoDB</em> destaca porque:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Soporta esquemas dinámicos: diferentes documentos de una misma colección pueden tener atributos diferentes.</p>
</li>
<li>
<p>No soporta <em>joins</em>, ya que no escalan bien.</p>
</li>
<li>
<p>No soporta transacciones. Lo que en un SGDB puede suponer múltiples operaciones, con <em>MongoDB</em> se puede hacer en una sola operación al insertar/actualizar todo un documento de una sola vez.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Hay una serie de conceptos que conviene conocer antes de entrar en detalle:</p>
</div>
<div class="imageblock" style="float: right">
<div class="content">
<img src="images/nosql02/mongodbitems.png" alt="Elementos de MongoDB" width="66%">
</div>
<div class="title">Figure 9. Elementos de MongoDB</div>
</div>
<div class="ulist">
<ul>
<li>
<p><em>MongoDB</em> tienen el mismo concepto de <strong>base de datos</strong> que un SGDB. Dentro de una instancia de MongoDB podemos tener 0 o más bases de datos, actuando cada una como un contenedor de alto nivel</p>
</li>
<li>
<p>Una base de datos tendrá 0 o más colecciones. Una <strong>colección</strong> es muy similar a lo que entendemos como tabla dentro de un SGDB. <em>MongoDB</em> ofrece diferentes tipos de colecciones, desde las normales cuyo tamaño crece conforme lo hace el número de documentos, como las colecciones <em>capped</em>, las cuales tienen un tamaño predefinido y que pueden contener una cierta cantidad de información que se sustituirá por nueva cuando se llene.</p>
</li>
<li>
<p>Las colecciones contiene 0 o más <strong>documentos</strong>, por lo que es similar a una fila o registro de un RDMS.</p>
</li>
<li>
<p>Cada documento contiene 0 o más atributos, compuestos de parejas clave/valor. Cada uno de estos documentos no sigue ningún esquema, por lo que dos documentos de una misma colección pueden contener todos los atributos diferentes entre sí.</p>
</li>
<li>
<p><em>MongoDB</em> soporta <strong>índices</strong>, igual que cualquier SGDB, para acelerar la búsqueda de datos.</p>
</li>
<li>
<p>Al realizar cualquier consulta, se devuelve un <strong>cursor</strong>, con el cual podemos hacer cosas tales como contar, ordenar, limitar o saltar documentos.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Así pues, tenemos que una base de datos va a contener varias colecciones, donde cada colección tendrá un conjunto de documentos:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql02/mongodbmodel.jpg" alt="Modelo de MongoDB" width="33%">
</div>
<div class="title">Figure 10. Modelo de MongoDB</div>
</div>
<div class="sect3">
<h4 id="_instalación">1.7.1. Instalación</h4>
<div class="paragraph">
<p>Desde <a href="http://www.mongodb.org/downloads" class="bare">http://www.mongodb.org/downloads</a> podemos descargar la versión acorde a nuestro sistema operativo. Para instalar en <em>Mac</em>, lo más cómodo es utilizar la herramienta <code>brew</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">brew install mongodb</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Si tenemos un sistema de 32 bits podemos trabajar con <em>MongoDB</em>, aunque no es recomendable ya que estamos restringiendo el tamaño de los archivos a 2GB. Así pues, se recomienda siempre instalar la versión de 64 bits sobre un sistema acorde.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si queremos instalar nosotros los binarios a mano, necesitamos descargarlos y ponerlos en el path.</p>
</div>
<div class="paragraph">
<p>Tras la instalación, necesitaremos crear la carpeta para guardar las BBDD. Como convención, se almacenan en <code>/data/db</code> (o <code>C:\data\db</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">mkdir -p /data/db
chown <span class="tok-sb">`</span>id -u<span class="tok-sb">`</span> /data/db</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
En la máquina virtual tenemos instalada la versión <strong>3.0.6</strong> como servicio ( adía de hoy la última versión es la 3.2 ), lo que significa que el demonio está corriendo de forma automática. Además, la carpeta de datos se encuentra en <code>/var/lib/mongodb</code>. Si queremos modificar opciones de arranque, el archivo de configuración se encuentra en <code>/etc/mongod.conf</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finalmente, si no hemos instalado <em>MongoDB</em> como un servicio, para arrancar el servidor en un terminal lanzaremos el demonio <code>mongod</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql02/mongod.jpg" alt="Lanzando el demonio mongod" width="75%">
</div>
<div class="title">Figure 11. Lanzando el demonio mongod</div>
</div>
<div class="paragraph">
<p>Por defecto, el demonio se lanza sobre el puerto 27017. Si accedemos a <code><a href="http://localhost:27017" class="bare">http://localhost:27017</a></code> podremos ver que nos indica como estamos intentando acceder mediante HTTP a <em>MongoDB</em> mediante el puerto reservado al driver nativo.</p>
</div>
<div class="paragraph">
<p>Si no quisiéramos instalarlo, podríamos utilizar una solución <em>Cloud</em> que incluya <em>MongoDB</em>, como pueda ser <a href="https://mongolab.com" target="_blank">MongoLab</a> o <a href="http://aws.amazon.com/es/" target="_blank">Amazon Web Services</a>. Más información en <a href="https://www.mongodb.com/partners/list" class="bare">https://www.mongodb.com/partners/list</a></p>
</div>
<div class="paragraph">
<p>A continuación vamos a estudiar las diferentes herramientas que nos ofrece <em>MongoDB</em> para posteriormente todas las operaciones que podemos realizar.</p>
</div>
</div>
<div class="sect3">
<h4 id="_herramientas">1.7.2. Herramientas</h4>
<div class="paragraph">
<p>Además del demonio y del cliente, <em>MongoDB</em> ofrece un conjunto de herramientas para interactuar con las bases de datos, permitiendo crear y restaurar copias de seguridad.</p>
</div>
<div class="paragraph">
<p>Si estamos interesados en introducir o exportar una colección de datos mediante JSON, podemos emplear los comandos <code>mongoimport</code> y <code>mongoexport</code>:</p>
</div>
<div class="listingblock">
<div class="title">Importanto y exportando datos</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">mongoimport -d nombreBaseDatos -c coleccion –-file nombreFichero.json
mongoexport -d nombreBaseDatos -c coleccion -o nombreFichero.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>Estas herramientas interactúan con datos JSON y no sobre toda la base de datos.</p>
</div>
<div class="paragraph">
<p>Un caso particular y muy común es importar datos que se encuentran en formato CSV/TSV. Para ello, emplearemos el parámetro <code>--type csv</code>:</p>
</div>
<div class="listingblock">
<div class="title">Importanto CSV/TSV - <a href="resources/nosql/poblacionEspanya2013.tsv">poblacionEspanya2013.tsv</a></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">mongoimport --type tsv -d <span class="tok-nb">test</span> -c poblacion --headerline --drop poblacionEspanya2013.tsv</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Más información sobre importar y exportar datos en <a href="http://docs.mongodb.org/manual/core/import-export/" class="bare">http://docs.mongodb.org/manual/core/import-export/</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Antes que hacer un <em>export</em>, es más conveniente realizar un <em>backup</em> en binario mediante <code>mongodump</code>, el cual genera ficheros BSON. Estos archivos posteriormente se restauran mediante <code>mongorestore</code>.</p>
</div>
<div class="listingblock">
<div class="title">Restaurando un copia de seguridad</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">mongodump -d nombreBaseDatos -o nombreFichero.bson
mongorestore -d nombreBaseDatos nombreFichero.bson</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Más información sobre copias de seguridad en <a href="http://docs.mongodb.org/manual/core/backups/" class="bare">http://docs.mongodb.org/manual/core/backups/</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si necesitamos transformar un fichero BSON a JSON (de binario a texto), tenemos el comando <code>bsondump</code>:</p>
</div>
<div class="listingblock">
<div class="title">De BSON a JSON</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">bsondump file.bson &gt; file.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>Otra herramienta es <code>mongostat</code> que permite visualizar el estado del servidor <em>MongoDB</em>, así como algunas estadísticas sobre su rendimiento. Esta herramienta la estudiaremos en la última sesión.</p>
</div>
<div class="paragraph">
<p>Para poder trabajar con <em>MongoDB</em> desde cualquier aplicación necesitamos un driver. <em>MongoDB</em> ofrece drivers oficiales para casi todos los lenguajes de programación actuales. Más información en <a href="http://docs.mongodb.org/ecosystem/drivers/" class="bare">http://docs.mongodb.org/ecosystem/drivers/</a></p>
</div>
<div class="paragraph">
<p>Por ejemplo, para poder trabajar con <em>Java</em>, mediante <em>Maven</em> podremos descargarlo mediante la siguiente dependencia:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;dependency&gt;</span>
  <span class="tok-nt">&lt;groupId&gt;</span>org.mongodb<span class="tok-nt">&lt;/groupId&gt;</span>
  <span class="tok-nt">&lt;artifactId&gt;</span>mongo-java-driver<span class="tok-nt">&lt;/artifactId&gt;</span>
  <span class="tok-nt">&lt;version&gt;</span>2.14.1<span class="tok-nt">&lt;/version&gt;</span>
<span class="tok-nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Aunque trabajaremos en detalle con <em>Java</em> en la siguiente sesión, en <a href="http://docs.mongodb.org/ecosystem/drivers/java/" class="bare">http://docs.mongodb.org/ecosystem/drivers/java/</a> y <a href="http://mongodb.github.io/mongo-java-driver/" class="bare">http://mongodb.github.io/mongo-java-driver/</a> podemos obtener información sobre el <em>driver</em> y el soporte para las diferentes versiones de <em>MongoDB</em>.</p>
</div>
<div class="paragraph">
<p>Finalmente, una herramienta de terceros bastante utilizada es <em>RoboMongo</em> (<a href="http://robomongo.org" class="bare" target="_blank">http://robomongo.org</a>), el cual extiende el shell y permite un uso más amigable.</p>
</div>
<div class="paragraph">
<p>En el curso nos vamos a centrar en el uso del shell y la conectividad de <em>MongoDB</em> mediante Java.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_hola_em_mongodb_em">1.8. Hola <em>MongoDB</em></h3>
<div class="paragraph">
<p>Tras lanzar el demonio <code>mongod</code>, llega el momento de acceder mediante el cliente <code>mongo</code>, el cual funciona igual que un shell, de modo que con la fecha hacia arriba visualizaremos el último comando. El cliente utiliza <em>JavaScript</em> como lenguaje de interacción con la base de datos.</p>
</div>
<div class="paragraph">
<p>Al conectar con <code>mongo</code> si no le indicamos nada se conectará por defecto a la base de datos <code>test</code>. Si queremos conectarnos a una base de datos concreta, la pasaremos como parámetro:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql02/mongoShell.jpg" alt="Lanzando el cliente mongo" width="66%">
</div>
<div class="title">Figure 12. Lanzando el cliente mongo</div>
</div>
<div class="paragraph">
<p>En cualquier momento podemos cambiar la base de datos activa mediante <code>use nombreBaseDatos</code>. Si la base de datos no existiese, <em>MongoDB</em> creará dicha base de datos. Esto es una verdad a medias, ya que la base de datos realmente se crea al insertar datos dentro de alguna colección. Otros comandos muy empleados son <code>show dbs</code> para mostrar las bases de datos existentes, y <code>show collections</code> para obtener las colecciones de la base de datos activa.</p>
</div>
<div class="paragraph">
<p>Así pues, vamos a crear nuestra base de datos <code>expertojava</code>:</p>
</div>
<div class="listingblock">
<div class="title">Accediendo a la base de datos <code>expertojava</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">use</span> <span class="tok-nx">expertojava</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Una vez creada, podemos crear nuestra primera colección, que llamaremos <code>people</code>, e insertaremos un persona con nuestros datos personales mediante el método <code>insert</code>, al que le pasamos un objeto JSON:</p>
</div>
<div class="listingblock">
<div class="title">Insertando una persona</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">insert</span><span class="tok-p">({</span> <span class="tok-nx">nombre</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Aitor&quot;</span><span class="tok-p">,</span> <span class="tok-nx">edad</span><span class="tok-o">:</span> <span class="tok-mi">38</span><span class="tok-p">,</span> <span class="tok-nx">profesion</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Profesor&quot;</span> <span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Una vez insertada, sólo nos queda realizar una consulta para recuperar los datos y comprobar que todo funciona correctamente mediante el método <code>findOne</code>:</p>
</div>
<div class="listingblock">
<div class="title">Recuperando una persona</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">findOne</span><span class="tok-p">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lo que nos dará como resultado un objeto JSON que contiene un atributo <code>_id</code> además de los que le añadimos al insertar la persona:</p>
</div>
<div class="listingblock">
<div class="title">Resultado de la consulta de la persona</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span>
  <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;53274f9883a7adeb6a573e64&quot;</span><span class="tok-p">),</span>
  <span class="tok-s2">&quot;nombre&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Aitor&quot;</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;edad&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">38</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;profesion&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Profesor&quot;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Como podemos observar, todas las instrucciones van a seguir el patrón de <code>db.nombreColeccion.operacion()</code>.</p>
</div>
<div class="paragraph">
<p>Todas las operaciones que podemos realizar las veremos en la siguiente sesión. En todo caso, podemos consultar la documentación en <a href="http://docs.mongodb.org/manual/" class="bare">http://docs.mongodb.org/manual/</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios">1.9. Ejercicios</h3>
<div class="paragraph">
<p>El repositorio a clonar es <code>java_ua/nosql-expertojava</code>.</p>
</div>
<div class="paragraph">
<p>Cada uno de los ejercicios se guardará en un fichero de texto que se almacenará en la raíz del repositorio, a no ser que se indique lo contrario.</p>
</div>
<div class="sect3">
<h4 id="__1_punto_ejercicio_11_cuestionario">1.9.1. (1 punto) Ejercicio 11. Cuestionario</h4>
<div class="paragraph">
<p>En un fichero de texto o un documento con nombre <code>ej11.txt</code> / <code>ej11.odt</code>, responde a las siguientes cuestiones, justificando tu respuesta:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Qué significa el prefijo <em>No</em> del acrónimo <em>NoSQL</em>?</p>
</li>
<li>
<p>¿Un sistema puede soportar al mismo tiempo replicación y particionado?</p>
</li>
<li>
<p>Para los siguientes supuestos, indica qué modelo de datos emplearías y justifica tu respuesta:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Enciclopedia de personajes de cómic</p>
</li>
<li>
<p>Usuarios, perfiles, biblioteca de juegos, puntuaciones, etc&#8230;&#8203; de una plataforma de <em>gaming</em></p>
</li>
<li>
<p>Información académica de un país (centros, alumnos, profesores, asignaturas, calificaciones, &#8230;&#8203;)</p>
</li>
</ol>
</div>
</li>
<li>
<p>Investiga en qué consiste la "persistencia políglota".</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="__0_5_puntos_ejercicio_12_puesta_en_marcha_con_em_mongodb_em">1.9.2. (0.5 puntos) Ejercicio 12. Puesta en marcha con <em>MongoDB</em></h4>
<div class="paragraph">
<p>En esta sesión, vamos a centrarnos en comprobar la instalación que tenemos en nuestra máquina virtual y a trabajar con el shell de <em>MongoDB</em> para familiarizarnos con su uso y poder importar los datos necesarios.</p>
</div>
<div class="paragraph">
<p>En el caso de no tener <em>MongoDB</em> instalado, realiza su instalación. Tras ello, si no esta instalado como demonio, en un terminal arranca el servicio <code>mongod</code>.</p>
</div>
<div class="paragraph">
<p>Posteriormente, tras abrir un terminal y arrancar el shell mediante <code>mongo</code>, se pide comprobar:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>qué bases de datos existen.</p>
</li>
<li>
<p>qué colecciones existen en la base de datos <code>expertojava</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Finalmente, se pide crear una nueva base de datos llamada <code>ejercicios</code>.</p>
</div>
<div class="paragraph">
<p>Anotad en un fichero de texto de nombre <code>ej12.txt</code> los comandos y resultados obtenidos.</p>
</div>
</div>
<div class="sect3">
<h4 id="__0_5_puntos_ejercicio_13_inserciones">1.9.3. (0.5 puntos) Ejercicio 13. Inserciones</h4>
<div class="paragraph">
<p>Sobre la base de datos <code>ejercicios</code>, importa los datos que se encuentran en <a href="resources/nosql/mongo_cities1000.json.txt">mongo_cities1000.json</a> en una colección denominada <code>cities</code>.</p>
</div>
<div class="paragraph">
<p>Si analizas los datos, verás que se crean documentos con una estructura similar a esta:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>name</code>: nombre de la ciudad.</p>
</li>
<li>
<p><code>country</code>: país.</p>
</li>
<li>
<p><code>timezone</code>: zona horaria.</p>
</li>
<li>
<p><code>population</code>: población.</p>
</li>
<li>
<p><code>location</code>: coordenadas compuestas de:</p>
<div class="ulist">
<ul>
<li>
<p><code>longitude</code>: longitud</p>
</li>
<li>
<p><code>latitude</code>: latitud</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Por ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">cities</span><span class="tok-p">.</span><span class="tok-nx">findOne</span><span class="tok-p">()</span>
<span class="tok-p">{</span>
	<span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;55264a34c25edd8055f20cba&quot;</span><span class="tok-p">),</span>
	<span class="tok-s2">&quot;name&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Sant Julià de Lòria&quot;</span><span class="tok-p">,</span>
	<span class="tok-s2">&quot;country&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;AD&quot;</span><span class="tok-p">,</span>
	<span class="tok-s2">&quot;timezone&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Europe/Andorra&quot;</span><span class="tok-p">,</span>
	<span class="tok-s2">&quot;population&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">8022</span><span class="tok-p">,</span>
	<span class="tok-s2">&quot;location&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
		<span class="tok-s2">&quot;longitude&quot;</span> <span class="tok-o">:</span> <span class="tok-mf">42.46372</span><span class="tok-p">,</span>
		<span class="tok-s2">&quot;latitude&quot;</span> <span class="tok-o">:</span> <span class="tok-mf">1.49129</span>
	<span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Se pide insertar una nueva ciudad con los datos de la ciudad donde vives, pero poniendo como nombre de la ciudad tu nombre.</p>
</div>
<div class="paragraph">
<p>Escribe los comandos necesarios y el resultado en <code>ej13.txt</code>.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion02">2. MongoDB</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ya hemos visto que <em>MongoDB</em> es una base de datos documental, que agrupa los documentos en colecciones.</p>
</div>
<div class="paragraph">
<p>En esta sesión estudiaremos la estructura de estos documentos, y como podemos interactuar con ellos.</p>
</div>
<div class="sect2">
<h3 id="_bson">2.1. BSON</h3>
<div class="paragraph">
<p>Mediante <em>JavaScript</em> podemos crear objetos que se representan con JSON. Internamente, <em>MongoDB</em> almacena los documentos en BSON (<em>Binary JSON</em>). Podemos consultar la especificación en <a href="http://BSONSpec.org" class="bare">http://BSONSpec.org</a></p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql02/bson.jpg" alt="Especificación BSON" width="66%">
</div>
<div class="title">Figure 13. Especificación BSON</div>
</div>
<div class="paragraph">
<p>BSON representa un superset de JSON, ya que:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Almacena datos en binario</p>
</li>
<li>
<p>Incluye un conjunto de tipos de datos no incluidos en JSON, como pueden ser <code>ObjectId</code>, <code>Date</code> o <code>BinData</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Podemos consultar todos los tipos que soporta un objeto <em>BSON</em> en <a href="http://docs.mongodb.org/manual/reference/bson-types/" class="bare">http://docs.mongodb.org/manual/reference/bson-types/</a></p>
</div>
<div class="listingblock">
<div class="title">Ejemplo de objeto BSON</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">yo</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
  <span class="tok-nx">nombre</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Aitor&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">apellidos</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Medrano&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">fnac</span><span class="tok-o">:</span> <span class="tok-k">new</span> <span class="tok-nb">Date</span><span class="tok-p">(</span><span class="tok-s2">&quot;Oct 3, 1977&quot;</span><span class="tok-p">),</span>
  <span class="tok-nx">hobbies</span><span class="tok-o">:</span> <span class="tok-p">[</span><span class="tok-s2">&quot;programación&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;videojuegos&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;baloncesto&quot;</span><span class="tok-p">],</span>
  <span class="tok-nx">casado</span><span class="tok-o">:</span> <span class="tok-kc">true</span><span class="tok-p">,</span>
  <span class="tok-nx">hijos</span><span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
  <span class="tok-nx">fechaCreacion</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Timestamp</span><span class="tok-p">()</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Los documentos BSON tienen las siguientes restricciones:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>no pueden tener un tamaño superior a 16 MB.</p>
</li>
<li>
<p>el atributo <code>_id</code> queda reservado para la clave primaria.</p>
</li>
<li>
<p>los nombres de los campos no pueden empezar por <code>$</code>.</p>
</li>
<li>
<p>los nombres de los campos no pueden contener el <code>.</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Además <em>MongoDB</em>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>no asegura que el orden de los campos se respete.</p>
</li>
<li>
<p>es sensible a los tipos de los datos</p>
</li>
<li>
<p>es sensible a las mayúsculas.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Por lo que estos documentos son distintos:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo de objetos con tipos distintos y atributos diferentes</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span><span class="tok-s2">&quot;edad&quot;</span><span class="tok-o">:</span> <span class="tok-s2">&quot;18&quot;</span><span class="tok-p">}</span>
<span class="tok-p">{</span><span class="tok-s2">&quot;edad&quot;</span><span class="tok-o">:</span> <span class="tok-mi">18</span><span class="tok-p">}</span>
<span class="tok-p">{</span><span class="tok-s2">&quot;Edad&quot;</span><span class="tok-o">:</span> <span class="tok-mi">18</span><span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si queremos validar si un documento JSON es válido, podemos usar <a href="http://jsonlint.com/" class="bare">http://jsonlint.com/</a>. Hemos de tener en cuenta que sólo valida JSON y no BSON, por tanto nos dará errores en los tipos de datos propios de BSON.</p>
</div>
</div>
<div class="sect2">
<h3 id="_trabajando_con_el_shell">2.2. Trabajando con el shell</h3>
<div class="paragraph">
<p>Antes de entrar en detalles en las instrucciones necesarias para realizar las operaciones CRUD, veamos algunos comandos que nos serán muy utiles al interactuar con el shell:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 2. Comandos útiles dentro del cliente de <em>MongoDB</em></caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Comando</th>
<th class="tableblock halign-left valign-top">Función</th>
</tr>
</thead>
<tbody>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock"><code>show dbs</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Muestra el nombre de las bases de datos</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock"><code>show collections</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Muestra el nombre de las colecciones</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock"><code>db</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Muestra el nombre de la base de datos que estamos utilizando</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock"><code>db.dropDatabase()</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Elimina la base de datos actual</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock"><code>db.help()</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Muestra los comandos disponibles</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock"><code>db.version()</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Muestra la versión actual del servidor</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>En el resto de la sesión vamos a hacer un uso intenso del shell de <em>MongoDB</em>. Por ejemplo, si nos basamos en el objeto definido en el apartado de BSON, podemos ejecutar las siguientes instrucciones:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplos de interacción con el shell</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">insert</span><span class="tok-p">(</span><span class="tok-nx">yo</span><span class="tok-p">)</span>        <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">()</span>            <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;53274f9883a7adeb6a573e64&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;nombre&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Aitor&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;apellidos&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Medrano&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;fnac&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ISODate</span><span class="tok-p">(</span><span class="tok-s2">&quot;1977-10-02T23:00:00Z&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;hobbies&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span>  <span class="tok-s2">&quot;programación&quot;</span><span class="tok-p">,</span>  <span class="tok-s2">&quot;videojuegos&quot;</span><span class="tok-p">,</span>  <span class="tok-s2">&quot;baloncesto&quot;</span> <span class="tok-p">],</span> <span class="tok-s2">&quot;casado&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">true</span><span class="tok-p">,</span> <span class="tok-s2">&quot;hijos&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span> <span class="tok-s2">&quot;fechaCreacion&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">Timestamp</span><span class="tok-p">(</span><span class="tok-mi">1425633249</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">)</span> <span class="tok-p">}</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">yo</span><span class="tok-p">.</span><span class="tok-nx">email</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;aitormedrano@gmail.com&quot;</span>
<span class="tok-nx">aitormedrano</span><span class="tok-err">@</span><span class="tok-nx">gmail</span><span class="tok-p">.</span><span class="tok-nx">com</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">save</span><span class="tok-p">(</span><span class="tok-nx">yo</span><span class="tok-p">)</span>          <i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">()</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;53274f9883a7adeb6a573e64&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;nombre&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Aitor&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;apellidos&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Medrano&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;fnac&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ISODate</span><span class="tok-p">(</span><span class="tok-s2">&quot;1977-10-02T23:00:00Z&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;hobbies&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span>  <span class="tok-s2">&quot;programación&quot;</span><span class="tok-p">,</span>  <span class="tok-s2">&quot;videojuegos&quot;</span><span class="tok-p">,</span>  <span class="tok-s2">&quot;baloncesto&quot;</span> <span class="tok-p">],</span> <span class="tok-s2">&quot;casado&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">true</span><span class="tok-p">,</span> <span class="tok-s2">&quot;hijos&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span> <span class="tok-s2">&quot;fechaCreacion&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">Timestamp</span><span class="tok-p">(</span><span class="tok-mi">1425633249</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">)</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;53274fca83a7adeb6a573e65&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;nombre&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Aitor&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;apellidos&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Medrano&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;fnac&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ISODate</span><span class="tok-p">(</span><span class="tok-s2">&quot;1977-10-02T23:00:00Z&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;hobbies&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span>  <span class="tok-s2">&quot;programación&quot;</span><span class="tok-p">,</span>  <span class="tok-s2">&quot;videojuegos&quot;</span><span class="tok-p">,</span>  <span class="tok-s2">&quot;baloncesto&quot;</span> <span class="tok-p">],</span> <span class="tok-s2">&quot;casado&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">true</span><span class="tok-p">,</span> <span class="tok-s2">&quot;hijos&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span> <span class="tok-s2">&quot;fechaCreacion&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">Timestamp</span><span class="tok-p">(</span><span class="tok-mi">1425633373</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">),</span> <span class="tok-s2">&quot;email&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;aitormedrano@gmail.com&quot;</span> <span class="tok-p">}</span>      <i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">().</span><span class="tok-nx">forEach</span><span class="tok-p">(</span><span class="tok-nx">printjson</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Si queremos insertar un documento en una colección, hemos de utilizar el método <code><strong>insert</strong></code> (<a href="http://docs.mongodb.org/master/reference/method/db.collection.insert/" class="bare">http://docs.mongodb.org/master/reference/method/db.collection.insert/</a>) pasándole como parámetro el documento que queremos insertar.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code><strong>find</strong></code> permite recuperar documentos</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code><strong>save</strong></code> es similar a <code>insert</code>, pero si existe un documento con el mismo <code>ObjectId</code>, realizará un <code>update</code> (realmente un <code>upsert</code>)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Hay dos documentos porque al guardar el segundo se le ha asignado un nuevo <code>ObjectId</code>. Además, los dos documentos no tienen el mismo número de campos, y la fechaCreación se ha actualizado con el <em>timestamp</em> actual.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Otros ejemplos tanto de <code>insert</code> como de <code>save</code> con objetos directos, sin necesidad de usar variables, serían:</p>
</div>
<div class="listingblock">
<div class="title">Inserción y Guardado</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">insert</span><span class="tok-p">({</span> <span class="tok-nx">nombre</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Aitor&quot;</span><span class="tok-p">,</span> <span class="tok-nx">edad</span> <span class="tok-o">:</span> <span class="tok-mi">37</span><span class="tok-p">,</span> <span class="tok-nx">profesion</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Profesor&quot;</span> <span class="tok-p">})</span>
<span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">save</span><span class="tok-p">({</span> <span class="tok-nx">nombre</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Aitor&quot;</span><span class="tok-p">,</span> <span class="tok-nx">edad</span> <span class="tok-o">:</span> <span class="tok-mi">37</span><span class="tok-p">,</span> <span class="tok-nx">profesion</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Profesor&quot;</span> <span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Autoevaluación</div>
<div class="paragraph">
<p>Al ejecutar las dos instrucciones anteriores sobre una colección vacía ¿Cuantos registros tendrá la colección? <span class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnote_2" title="View footnote.">2</a>]</span></p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_empleando_em_javascript_em">2.2.1. Empleando <em>JavaScript</em></h4>
<div class="paragraph">
<p>Ya hemos comentado que el <em>shell</em> utiliza <em>JavaScript</em> como lenguaje de interacción, por lo que podemos almacenar los comandos en un <em>script</em> externo y ejecutarlo mediante <code>load()</code>:</p>
</div>
<div class="listingblock">
<div class="title">Carga de <em>script</em></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">load</span><span class="tok-p">(</span><span class="tok-s2">&quot;scripts/misDatos.js&quot;</span><span class="tok-p">);</span>   <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-nx">load</span><span class="tok-p">(</span><span class="tok-s2">&quot;/data/db/scripts/misDatos.js&quot;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Si hacemos una referencia relativa, lo hace respecto a la ruta desde la cual se ejecuta el <em>shell</em> <code>mongo</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Otra manera de lanzar un <em>script</em> es hacerlo desde la línea de comandos, pasándole como segundo parámetro el script a ejecutar:</p>
</div>
<div class="listingblock">
<div class="title">Ejecución de <em>script</em></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">mongo expertojava misDatos.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>Si el código a ejecutar no necesita almacenarse en un <em>script</em> externo, el propio <em>shell</em> permite introducir instrucciones en varias líneas:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql02/shellJS.jpg" alt="Uso de JavaScript en el shell" width="75%">
</div>
<div class="title">Figure 14. Uso de <em>JavaScript</em> en el shell</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_objectid">2.3. ObjectId</h3>
<div class="paragraph">
<p>En <em>MongoDB</em>, el atributo <code>_id</code> es único dentro de la colección, y hace la función de clave primaria. Se le asocia un <code>ObjectId</code> (<a href="http://docs.mongodb.org/manual/reference/object-id/" class="bare">http://docs.mongodb.org/manual/reference/object-id/</a>), el cual es un tipo BSON de 12 bytes que se crea mediante:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>el <em>timestamp</em> actual (<em>4 bytes</em>)</p>
</li>
<li>
<p>un identificador de la máquina / <em>hostname</em> (<em>3 bytes</em>) donde se genera</p>
</li>
<li>
<p>un identificador del proceso (<em>2 bytes</em>) donde se genera</p>
</li>
<li>
<p>un número aleatorio (<em>3 bytes</em>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Este objeto lo crea el driver y no <em>MongoDB</em>, por lo cual no deberemos considerar que siguen un orden concreto, ya que clientes diferentes pueden tener <em>timestamps</em> desincronizados. Lo que sí que podemos obtener a partir del <code>ObjectId</code> es la fecha de creación del documento, mediante el método <code>getTimestamp()</code> del atributo <code>_id</code>.</p>
</div>
<div class="listingblock">
<div class="title">Obteniendo la fecha de creación de un documento</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">()[</span><span class="tok-mi">0</span><span class="tok-p">].</span><span class="tok-nx">_id</span>
<span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;53274f9883a7adeb6a573e64&quot;</span><span class="tok-p">)</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">()[</span><span class="tok-mi">0</span><span class="tok-p">].</span><span class="tok-nx">_id</span><span class="tok-p">.</span><span class="tok-nx">getTimestamp</span><span class="tok-p">()</span>
<span class="tok-nx">ISODate</span><span class="tok-p">(</span><span class="tok-s2">&quot;2014-03-17T19:40:08Z&quot;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Este identificador es <strong>global, único e inmutable</strong>. Esto es, no habrá dos repetidos y una vez un documento tiene un <code>_id</code>, éste no se puede modificar.</p>
</div>
<div class="paragraph">
<p>Si en la definición del objeto a insertar no ponemos el atributo identificador, <em>MongoDB</em> creará uno de manera automática. Si lo ponemos nosotros de manera explícita, <em>MongoDB</em> no añadirá ningún <code>ObjectId</code>. Eso sí, debemos asegurarnos que sea único (podemos usar números, cadenas, etc&#8230;&#8203;).</p>
</div>
<div class="paragraph">
<p>Por lo tanto, podemos hacer esto:</p>
</div>
<div class="listingblock">
<div class="title">Asignando un identificador al insertar</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">insert</span><span class="tok-p">({</span><span class="tok-nx">_id</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-p">,</span> <span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s2">&quot;Marina&quot;</span><span class="tok-p">,</span> <span class="tok-nx">edad</span><span class="tok-o">:</span><span class="tok-mi">6</span> <span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Cuidado con los tipos, ya que no es lo mismo insertar un atributo con <code>edad:6</code> (se considera el campo como entero) que con <code>edad:"6"</code>, ya que considera el campo como texto.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>O también, si queremos podemos hacer que el <code>_id</code> de un documento sea un documento en sí, y no un entero, para ello, al insertarlo, podemos asignarle un objeto JSON al atributo identificador:</p>
</div>
<div class="listingblock">
<div class="title">Insertanto un documento cuyo identificador es otro documento</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">insert</span><span class="tok-p">({</span><span class="tok-nx">_id</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s1">&#39;Aitor&#39;</span><span class="tok-p">,</span> <span class="tok-nx">apellidos</span><span class="tok-o">:</span><span class="tok-s1">&#39;Medrano&#39;</span><span class="tok-p">,</span> <span class="tok-nx">twitter</span><span class="tok-o">:</span><span class="tok-s1">&#39;@aitormedrano&#39;</span><span class="tok-p">},</span> <span class="tok-nx">ciudad</span><span class="tok-o">:</span><span class="tok-s1">&#39;Elx&#39;</span><span class="tok-p">})</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_consultas">2.4. Consultas</h3>
<div class="paragraph">
<p>Para recuperar los datos de una colección o un documento en concreto usaremos el método <code>find()</code>:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo de consulta con <code>find()</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">()</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;53274f9883a7adeb6a573e64&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;nombre&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Aitor&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;apellidos&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Medrano&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;fnac&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ISODate</span><span class="tok-p">(</span><span class="tok-s2">&quot;1977-10-02T23:00:00Z&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;hobbies&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span>  <span class="tok-s2">&quot;programación&quot;</span><span class="tok-p">,</span>  <span class="tok-s2">&quot;videojuegos&quot;</span><span class="tok-p">,</span>  <span class="tok-s2">&quot;baloncesto&quot;</span> <span class="tok-p">],</span> <span class="tok-s2">&quot;casado&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">true</span><span class="tok-p">,</span> <span class="tok-s2">&quot;hijos&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;53274fca83a7adeb6a573e65&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;nombre&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Aitor&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;apellidos&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Medrano&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;fnac&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ISODate</span><span class="tok-p">(</span><span class="tok-s2">&quot;1977-10-02T23:00:00Z&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;hobbies&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span>  <span class="tok-s2">&quot;programación&quot;</span><span class="tok-p">,</span>  <span class="tok-s2">&quot;videojuegos&quot;</span><span class="tok-p">,</span>  <span class="tok-s2">&quot;baloncesto&quot;</span> <span class="tok-p">],</span> <span class="tok-s2">&quot;casado&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">true</span><span class="tok-p">,</span> <span class="tok-s2">&quot;hijos&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span> <span class="tok-s2">&quot;email&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;aitormedrano@gmail.com&quot;</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">3</span><span class="tok-p">,</span> <span class="tok-s2">&quot;nombre&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Marina&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;edad&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">6</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El método <code>find()</code> sobre una colección devuelve un cursor a los datos obtenidos, el cual se queda abierto con el servidor y que se cierra automáticamente a los 10 minutos de inactividad o al finalizar su recorrido. Si hay muchos resultados, la consola nos mostrará un subconjunto de los datos (20). Si queremos seguir obtiendo resultados, solo tenemos que introducir <code>it</code>, para que continúe iterando el cursor.</p>
</div>
<div class="paragraph">
<p>Si queremos que el resultado sea más legible, podemos recorrer la consulta y mostrar una vista tabulada mediante <code>printjson</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">().</span><span class="tok-nx">forEach</span><span class="tok-p">(</span><span class="tok-nx">printjson</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En cambio, si sólo queremos recuperar un documento hemos de utilizar <code>findOne()</code>:</p>
</div>
<div class="listingblock">
<div class="title">Recuperando un único documento</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">findOne</span><span class="tok-p">()</span>
<span class="tok-p">{</span>
  <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;53274f9883a7adeb6a573e64&quot;</span><span class="tok-p">),</span>
  <span class="tok-s2">&quot;nombre&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Aitor&quot;</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;apellidos&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Medrano&quot;</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;fnac&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ISODate</span><span class="tok-p">(</span><span class="tok-s2">&quot;1977-10-02T23:00:00Z&quot;</span><span class="tok-p">),</span>
  <span class="tok-s2">&quot;hobbies&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span>
    <span class="tok-s2">&quot;programación&quot;</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;videojuegos&quot;</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;baloncesto&quot;</span>
  <span class="tok-p">],</span>
  <span class="tok-s2">&quot;casado&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">true</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;hijos&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Se puede observar que al recuperar un documento con <code>findOne</code>, se muestra una vista formateada. Si queremos que esta vista se aplique a un documento encontrado con <code>find</code> podemos utilizar el sufijo <code>.pretty()</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">().</span><span class="tok-nx">pretty</span><span class="tok-p">()</span></code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Preparando los ejemplos</div>
<div class="paragraph">
<p>Para los siguientes ejemplos, vamos a utilizar una colección de 800 calificaciones que han obtenido diferentes estudiantes en trabajos, exámenes o cuestionarios.</p>
</div>
<div class="paragraph">
<p>Para ello, importaremos la colección <a href="resources/nosql/grades.json.txt">grades.json</a> mediante:</p>
</div>
<div class="listingblock">
<div class="title">Importanto <a href="resources/nosql/grades.json.txt">grades.json</a></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">mongoimport -d expertojava -c grades --file grades.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>Un ejemplo de una calificación sería:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">findOne</span><span class="tok-p">()</span>
<span class="tok-p">{</span>
  <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;50906d7fa3c412bb040eb577&quot;</span><span class="tok-p">),</span>
  <span class="tok-s2">&quot;student_id&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">0</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;type&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;exam&quot;</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;score&quot;</span> <span class="tok-o">:</span> <span class="tok-mf">54.6535436362647</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El campo <code>type</code> puede tomar los siguientes valores: <em>quiz</em>, <em>homework</em> o <em>exam</em></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_criterios_en_consultas">2.4.1. Criterios en consultas</h4>
<div class="paragraph">
<p>Al hacer una consulta, si queremos obtener datos mediante más de un criterio, en el primer parámetro del <code>find</code> podemos pasar un objeto JSON con los campos a cumplir (condición Y).</p>
</div>
<div class="listingblock">
<div class="title">Consulta con dos condiciones</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-nx">student_id</span><span class="tok-o">:</span><span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-nx">type</span><span class="tok-o">:</span><span class="tok-s2">&quot;quiz&quot;</span><span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Consejo de Rendimiento</div>
<div class="paragraph">
<p>Las consultas disyuntivas, es decir, con varios criterios u operador <code>$and</code>, deben filtrar el conjunto más pequeño cuanto más pronto posible.</p>
</div>
<div class="paragraph">
<p>Supongamos que vamos a consultar documentos que cumplen los criterios A, B y C. Digamos que el criterio A lo cumplen 40.000 documentos, el B lo hacen 9.000 y el C sólo 200.
Si filtramos A, luego B, y finalmente C, el conjunto que trabaja cada criterio es muy grande.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql02/andABC.jpg" alt="Restringiendo consultas AND" width="66%">
</div>
<div class="title">Figure 15. Restringiendo consultas AND de mayor a menor</div>
</div>
<div class="paragraph">
<p>En cambio, si hacemos una consulta que primero empiece por el criterio más restrictivo, el resultado con lo que se intersecciona el siguiente criterio es menor, y por tanto, se realizará más rápido.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql02/andCBA.jpg" alt="Restringiendo consultas AND" width="66%">
</div>
<div class="title">Figure 16. Restringiendo consultas AND de menor a mayor</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>MongoDB</em> también ofrece operadores lógicos para los campos numéricos:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 3. Operadores lógicos</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Comparador</th>
<th class="tableblock halign-left valign-top">Operador</th>
</tr>
</thead>
<tbody>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">menor que (<code>&lt;</code>)</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>$lt</code></p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">menor o igual que (<code>≤</code>)</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>$lte</code></p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">mayor que (<code>&gt;</code>)</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>$gt</code></p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">mayor o igual que (<code>≥</code>)</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>$gte</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Estos operadores se pueden utilizar de forma simultánea sobre un mismo campo o sobre diferentes campos, y se colocan como un nuevo documento en el valor del campo a filtrar, compuesto del operador y del valor a comparar:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplos de consultas con operadores relacionales</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span> <span class="tok-nx">score</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$gt</span><span class="tok-o">:</span><span class="tok-mi">95</span><span class="tok-p">}</span> <span class="tok-p">})</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span> <span class="tok-nx">score</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$gt</span><span class="tok-o">:</span><span class="tok-mi">95</span><span class="tok-p">,</span> <span class="tok-nx">$lte</span><span class="tok-o">:</span><span class="tok-mi">98</span><span class="tok-p">},</span> <span class="tok-nx">type</span><span class="tok-o">:</span><span class="tok-s2">&quot;exam&quot;</span> <span class="tok-p">})</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span> <span class="tok-nx">type</span><span class="tok-o">:</span><span class="tok-s2">&quot;exam&quot;</span><span class="tok-p">,</span> <span class="tok-nx">score</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$gte</span><span class="tok-o">:</span><span class="tok-mi">65</span><span class="tok-p">}</span> <span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para los campos de texto, además de la comparación directa, podemos usar el operador <code>$ne</code> para obtener los documentos cuyo campos <strong>no</strong> tienen un determinado valor. Así pues, podemos usarlo para averiguar todas las calificaciones que no sean cuestionarios (<em>quiz</em>):</p>
</div>
<div class="listingblock">
<div class="title">Consulta con <em>not equal</em></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-nx">type</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$ne</span><span class="tok-o">:</span><span class="tok-s2">&quot;quiz&quot;</span><span class="tok-p">}})</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Mucho cuidado al usar polimorfismo y almacenar en un mismo campo un entero y una cadena, ya que al hacer comparaciones para recuperar datos, no vamos a poder mezclar cadenas con valores numéricos. Se considera un antipatrón el mezclar tipos de datos en un campo.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Las comparaciones de cadenas se realizan siguiendo el orden UTF8, similar a ASCII, con lo cual no es lo mismo buscar un rango entre mayúsculas que minúsculas.</p>
</div>
<div class="paragraph">
<p>Con cierto parecido a la condición de valor no nulo de las BBDD relacionales y teniendo en cuenta que la libertad de esquema puede provocar que un documento tenga unos campos determinados y otro no lo tenga, podemos utilizar el operador <code>$exists</code> si queremos averiguar si un campo existe (y por tanto tiene algún valor).</p>
</div>
<div class="listingblock">
<div class="title">Consulta con condición de existencia de un campo</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-s2">&quot;score&quot;</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$exists</span><span class="tok-o">:</span><span class="tok-kc">true</span><span class="tok-p">}})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pese a que ciertos operadores contengan su correspondiente operador negado, <em>MongoDB</em> ofrece el operador <code>$not</code>. Éste puede utilizarse conjuntamente con otros operadores para negar el resultado de los documentos obtenidos.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, si queremos obtener todas las calificaciones que no sean múltiplo de 5, podríamos hacerlo así:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo de consulta con negación</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-nx">score</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$not</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-nx">$mod</span><span class="tok-o">:</span> <span class="tok-p">[</span><span class="tok-mi">5</span><span class="tok-p">,</span><span class="tok-mi">0</span><span class="tok-p">]}}})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finalmente, si queremos realizar consultas sobre partes de un campo de texto, hemos de emplear expresiones regulares. Para ello, tenemos el operador <code>$regexp</code> o, de manera más sencilla, indicando como valor la expresión regular a cumplir:</p>
</div>
<div class="paragraph">
<p>Por ejemplo, para buscar las personas cuyo nombre contenga la palabra <code>Aitor</code>:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo de consulta con expresión regular</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-sr">/Aitor/</span><span class="tok-p">})</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-sr">/aitor/i</span><span class="tok-p">})</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-nx">nombre</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-nx">$regex</span><span class="tok-o">:</span><span class="tok-sr">/aitor/i</span><span class="tok-p">}})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ya vimos en el módulo de <em>JavaScript</em> la flexibilidad y potencia que ofrecen las expresiones regulares. Para profundizar en su uso mediante <em>MongoDB</em> podéis obtener más información sobre el operador <code>$regex</code> en <a href="http://docs.mongodb.org/manual/reference/operator/query/regex/#op._S_regex" class="bare">http://docs.mongodb.org/manual/reference/operator/query/regex/#op._S_regex</a></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Otros operadores</div>
<div class="paragraph">
<p>Algunos operadores que conviene citar aunque su uso es más bien ocasional son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Si queremos recuperar documentos que dependan del tipo de campo que contiene, podemos preguntar con <code>$type</code>
<a href="http://docs.mongodb.org/manual/reference/operator/query/type/" class="bare">http://docs.mongodb.org/manual/reference/operator/query/type/</a></p>
</li>
<li>
<p>El operador <code>$where</code> permite introducir una expresión <em>JavaScript</em>
<a href="http://docs.mongodb.org/manual/reference/operator/query/where/" class="bare">http://docs.mongodb.org/manual/reference/operator/query/where/</a></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_proyección_de_campos">2.4.2. Proyección de campos</h4>
<div class="paragraph">
<p>Las consultas realizadas hasta ahora devuelven los documentos completos. Si queremos que devuelva un campo o varios campos en concreto, hemos de pasar un segundo parámetro de tipo JSON con aquellos campos que deseamos mostrar con el valor <code>true</code> o <code>1</code>. Destacar que si no se indica nada, por defecto siempre mostrará el campo <code>_id</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">findOne</span><span class="tok-p">({</span><span class="tok-nx">student_id</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-p">},{</span><span class="tok-nx">score</span><span class="tok-o">:</span><span class="tok-kc">true</span><span class="tok-p">});</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;50906d7fa3c412bb040eb583&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;score&quot;</span> <span class="tok-o">:</span> <span class="tok-mf">92.6244233936537</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por lo tanto, si queremos que no se muestre el <code>_id</code>, lo podremos a <code>false</code> o <code>0</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">findOne</span><span class="tok-p">({</span><span class="tok-nx">student_id</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-p">},{</span><span class="tok-nx">score</span><span class="tok-o">:</span><span class="tok-kc">true</span><span class="tok-p">,</span> <span class="tok-nx">_id</span><span class="tok-o">:</span><span class="tok-kc">false</span><span class="tok-p">});</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;score&quot;</span> <span class="tok-o">:</span> <span class="tok-mf">92.6244233936537</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_condiciones_sobre_objetos_anidados">2.4.3. Condiciones sobre objetos anidados</h4>
<div class="paragraph">
<p>Si queremos acceder a campos de subdocumentos, siguiendo la sintaxis de JSON, se utiliza la notación punto. Esta notación permite acceder al campo de un documento anidado, da igual el nivel en el que esté y su orden respecto al resto de campos.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, supongamos que tenemos un catálogo de productos de una tienda electrónica, el cual es similar al siguiente documento:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="json"><span class="tok-p">{</span>
  <span class="tok-nt">&quot;producto&quot;</span> <span class="tok-p">:</span> <span class="tok-s2">&quot;Condensador de Fluzo&quot;</span><span class="tok-p">,</span>
  <span class="tok-nt">&quot;precio&quot;</span> <span class="tok-p">:</span> <span class="tok-mi">100000000000</span><span class="tok-p">,</span>
  <span class="tok-nt">&quot;reviews&quot;</span> <span class="tok-p">:</span> <span class="tok-p">[</span>
    <span class="tok-p">{</span>
      <span class="tok-nt">&quot;usuario&quot;</span> <span class="tok-p">:</span> <span class="tok-s2">&quot;emmett&quot;</span><span class="tok-p">,</span>
      <span class="tok-nt">&quot;comentario&quot;</span> <span class="tok-p">:</span> <span class="tok-s2">&quot;¡Genial!&quot;</span><span class="tok-p">,</span>
      <span class="tok-nt">&quot;calificacion&quot;</span> <span class="tok-p">:</span> <span class="tok-mi">5</span>
    <span class="tok-p">},{</span>
      <span class="tok-nt">&quot;usuario&quot;</span> <span class="tok-p">:</span> <span class="tok-s2">&quot;marty&quot;</span> <span class="tok-p">,</span>
      <span class="tok-nt">&quot;comentario&quot;</span> <span class="tok-p">:</span> <span class="tok-s2">&quot;¡Justo lo que necesitaba!&quot;</span><span class="tok-p">,</span>
      <span class="tok-nt">&quot;calificacion&quot;</span> <span class="tok-p">:</span> <span class="tok-mi">4</span>
    <span class="tok-p">}</span> <span class="tok-p">]</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para acceder al usuario de una revisión usaríamos la propiedad <code>reviews.usuario</code>.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, para averiguar los productos que cuestan más de 10.000 y que tienen una calificación igual a 5 o superior haríamos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">catalogo</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-s2">&quot;precio&quot;</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$gt</span><span class="tok-o">:</span><span class="tok-mi">10000</span><span class="tok-p">},</span><span class="tok-s2">&quot;reviews.calificacion&quot;</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$gte</span><span class="tok-o">:</span><span class="tok-mi">5</span><span class="tok-p">}})</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_condiciones_compuestas_con_y_o">2.4.4. Condiciones compuestas con Y / O</h4>
<div class="paragraph">
<p>Para usar la conjunción o la disyunción, tenemos los operadores <code>$and</code> y <code>$or</code>. Son operadores prefijo, de modo que se ponen antes de las subconsultas que se van a evaluar. Estos operadores trabajan con arrays, donde cada uno de los elementos es un documento con la condición a evaluar, de modo que se realiza la unión entre estas condiciones, aplicando la lógica asociada a AND y a OR.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span> <span class="tok-nx">$or</span><span class="tok-o">:</span><span class="tok-p">[</span> <span class="tok-p">{</span><span class="tok-s2">&quot;type&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;exam&quot;</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-s2">&quot;score&quot;</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$gte</span><span class="tok-o">:</span><span class="tok-mi">65</span><span class="tok-p">}}</span> <span class="tok-p">]})</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span> <span class="tok-nx">$or</span><span class="tok-o">:</span><span class="tok-p">[</span> <span class="tok-p">{</span><span class="tok-s2">&quot;score&quot;</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$lt</span><span class="tok-o">:</span><span class="tok-mi">50</span><span class="tok-p">}},</span> <span class="tok-p">{</span><span class="tok-s2">&quot;score&quot;</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$gt</span><span class="tok-o">:</span><span class="tok-mi">90</span><span class="tok-p">}}</span> <span class="tok-p">]})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Realmente el operador <code>$and</code> no se suele usar porque podemos anidar en la consulta 2 criterios, al poner uno dentro del otro. Así pues, estas dos consultas hacen lo mismo:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplos consultas conjunciones con y sin <code>$and</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span> <span class="tok-nx">type</span><span class="tok-o">:</span><span class="tok-s2">&quot;exam&quot;</span><span class="tok-p">,</span> <span class="tok-nx">score</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$gte</span><span class="tok-o">:</span><span class="tok-mi">65</span><span class="tok-p">}</span> <span class="tok-p">})</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span> <span class="tok-nx">$and</span><span class="tok-o">:</span><span class="tok-p">[</span> <span class="tok-p">{</span><span class="tok-nx">type</span><span class="tok-o">:</span><span class="tok-s2">&quot;exam&quot;</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">score</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$gte</span><span class="tok-o">:</span><span class="tok-mi">65</span><span class="tok-p">}}</span> <span class="tok-p">]</span> <span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Consejo de Rendimiento</div>
<div class="paragraph">
<p>Las consultas conjuntivas, es decir, con varios criterios excluyentes u operador <code>$or</code>, deben filtrar el conjunto más grande cuanto más pronto posible.</p>
</div>
<div class="paragraph">
<p>Supongamos que vamos a consultar los mismos documentos que cumplen los criterios A (40.000 documentos), B (9.000 documentos) y C (200 documentos).</p>
</div>
<div class="paragraph">
<p>Si filtramos C, luego B, y finalmente A, el conjunto de documentos que tiene que comprobar <em>MongoDB</em> es muy grande.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql02/orCBA.jpg" alt="Restringiendo consultas OR" width="66%">
</div>
<div class="title">Figure 17. Restringiendo consultas OR de menor a myor</div>
</div>
<div class="paragraph">
<p>En cambio, si hacemos una consulta que primero empiece por el criterio menos restrictivo, el conjunto de documentos sobre el cual va a tener que comprobar siguientes criterios va a ser menor, y por tanto, se realizará más rápido.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql02/orABC.jpg" alt="Restringiendo consultas AND" width="66%">
</div>
<div class="title">Figure 18. Restringiendo consultas OR de mayor a menor</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>También podemos utilizar el operado <code>$nor</code>, que no es más que la negación de <code>$or</code> y que obtendrá aquellos documentos que no cumplan ninguna de las condiciones.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Autoevaluación</div>
<div class="paragraph">
<p>Que obtendríamos al ejecutar la siguiente consulta: <span class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnote_3" title="View footnote.">3</a>]</span></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span> <span class="tok-nx">score</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$gte</span><span class="tok-o">:</span><span class="tok-mi">65</span><span class="tok-p">},</span> <span class="tok-nx">$nor</span><span class="tok-o">:</span><span class="tok-p">[</span> <span class="tok-p">{</span><span class="tok-nx">type</span><span class="tok-o">:</span><span class="tok-s2">&quot;quiz&quot;</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">type</span><span class="tok-o">:</span><span class="tok-s2">&quot;homework&quot;</span><span class="tok-p">}</span> <span class="tok-p">]</span> <span class="tok-p">})</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finalmente, si queremos indicar mediante un array los diferentes valores que puede cumplir un campo, podemos utilizar el operador <code>$in</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span> <span class="tok-nx">type</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$in</span><span class="tok-o">:</span><span class="tok-p">[</span><span class="tok-s2">&quot;quiz&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;exam&quot;</span><span class="tok-p">]}})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por supuesto, también existe su negación mediante <code>$nin</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_consultas_sobre_arrays">2.4.5. Consultas sobre arrays</h4>
<div class="paragraph">
<p>Si trabajamos con arrays, vamos a poder consultar el contenido de una posición del mismo tal como si fuera un campo normal, siempre que sea un campo de primer nivel, es decir, no sea un documento embebido dentro de un array.</p>
</div>
<div class="paragraph">
<p>Si queremos filtrar teniendo en cuenta el número de ocurrencias del array, podemos utilizar:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>$all</code> para filtrar ocurrencias que tienen todos los valores del array, es decir, los valores pasados a la consulta serán un subconjunto del resultado. Puede que devuelva los mismos, o un array con más campos (el orden no importa)</p>
</li>
<li>
<p><code>$in</code>, igual que SQL, para obtener las ocurrencias que cumple con alguno de los valores pasados (similar a usar <code>$or</code> sobre un conjunto de valores de un mismo campo). Si queremos su negación, usaremos <code>$nin</code>, para obtener los documentos que no cumplen ninguno de los valores.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Por ejemplo, si queremos obtener las personas que dentro de sus amistades se encuentre <em>Juan</em> <strong>y</strong> <em>David</em>, y respecto a sus hobbies estén el <em>footing</em> <strong>o</strong> el <em>baloncesto</em>, tendríamos:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo consulta con <code>$all</code> y <code>$in</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">(</span> <span class="tok-p">{</span><span class="tok-nx">amistades</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-nx">$all</span><span class="tok-o">:</span> <span class="tok-p">[</span><span class="tok-s2">&quot;Juan&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;David&quot;</span><span class="tok-p">]},</span> <span class="tok-nx">hobbies</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-nx">$in</span><span class="tok-o">:</span> <span class="tok-p">[</span><span class="tok-s2">&quot;footing&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;baloncesto&quot;</span><span class="tok-p">]}}</span> <span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si el array contiene documentos y queremos filtrar la consulta sobre los campos de los documentos del array, tenemos que utilizar <code>$elemMatch</code>. Más información en <a href="http://docs.mongodb.org/manual/reference/operator/projection/elemMatch/" class="bare">http://docs.mongodb.org/manual/reference/operator/projection/elemMatch/</a></p>
</div>
<div class="paragraph">
<p>Si lo que nos interesa es la cantidad de elementos que contiene un array, emplearemos el operador <code>$size</code>.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, para obtener las personas que tienen 3 hobbies haríamos:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo consulta con <code>$size</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">(</span> <span class="tok-p">{</span><span class="tok-nx">hobbies</span> <span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-nx">$size</span> <span class="tok-o">:</span> <span class="tok-mi">3</span><span class="tok-p">}}</span> <span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finalmente, a la hora de proyectar los datos, si no estamos interesados en todos los valores de un campo que es un array, podemos restringir el resultado mediante el operador <code>$slice</code>:</p>
</div>
<div class="paragraph">
<p>Así pues, si quisieramos obtener las personas que tienen mas de un hijo, y que de esas personas, en vez de mostrar todos sus hobbies, mostrase los dos primeros, haríamos:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo con <code>$slice</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">(</span> <span class="tok-p">{</span><span class="tok-nx">hijos</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-nx">$gt</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">}},</span> <span class="tok-p">{</span><span class="tok-nx">hobbies</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-nx">$slice</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-p">}}</span> <span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Más información en <a href="http://docs.mongodb.org/manual/reference/operator/projection/slice/" class="bare">http://docs.mongodb.org/manual/reference/operator/projection/slice/</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_conjunto_de_valores">2.4.6. Conjunto de valores</h4>
<div class="paragraph">
<p>Igual que en SQL, a partir de un colección, si queremos obtener todos los diferentes valores que existen en un campo, utilizaremos el método <code><strong>distinct</strong></code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">distinct</span><span class="tok-p">(</span><span class="tok-s1">&#39;type&#39;</span><span class="tok-p">)</span>
<span class="tok-p">[</span> <span class="tok-s2">&quot;exam&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;quiz&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;homework&quot;</span> <span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si queremos filtrar los datos sobre los que se obtienen los valores, le pasaremos un segundo parámetro con el criterio a aplicar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">distinct</span><span class="tok-p">(</span><span class="tok-s1">&#39;type&#39;</span><span class="tok-p">,</span> <span class="tok-p">{</span> <span class="tok-nx">score</span><span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-nx">$gt</span><span class="tok-o">:</span> <span class="tok-mf">99.9</span> <span class="tok-p">}</span> <span class="tok-p">}</span> <span class="tok-p">)</span>
<span class="tok-p">[</span> <span class="tok-s2">&quot;exam&quot;</span> <span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_cursores">2.4.7. Cursores</h4>
<div class="paragraph">
<p>Al hacer una consulta en el <em>shell</em>, se devuelve un cursor. Este cursor lo podemos guardar en un variable, y partir de ahí trabajar con él como haríamos mediante <em>Java</em>. Si <code>cur</code> es la variable que referencia al cursor, podremos utilizar los siguientes métodos:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 4. Métodos de uso de cursores</caption>
<colgroup>
<col style="width: 33%;">
<col style="width: 33%;">
<col style="width: 33%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Método</th>
<th class="tableblock halign-left valign-top">Uso</th>
<th class="tableblock halign-left valign-top">Lugar de ejecución</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cur.hasNext()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code>/<code>false</code> para saber si quedan elementos</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cliente</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cur.next()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pasa al siguiente documento</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cliente</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cur.limit(<em>numElementos</em>)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Restringe el número de resultados a <em>numElementos</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Servidor</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cur.sort({<em>campo</em>:1})</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ordena los datos por <em>campo</em> <code>1</code> ascendente o <code>-1</code> o descendente</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Servidor</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cur.skip(<em>numElementos</em>)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Permite saltar <em>numElementos</em> con el cursor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Servidor</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>La consulta no se ejecuta hasta que el cursor comprueba o pasa al siguiente documento (<code>next</code>/<code>hasNext</code>), por ello que tanto <code>limit</code> como <code>sort</code> (ambos modifican el cursor) sólo se pueden realizar antes de recorrer cualquier elemento del cursor.</p>
</div>
<div class="paragraph">
<p>Como tras realizar una consulta con <code>find</code>, realmente se devuelve un cursor, un uso muy habitual es encadenar una operación de <code>find</code> con <code>sort</code> y/o <code>limit</code> para ordenar el resultado por uno o más campos y posteriormente limitar el número de documentos a devolver.</p>
</div>
<div class="paragraph">
<p>Así pues, si quisiéramos obtener la calificación del trabajo con la nota más alta, podríamos hacerlo así:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span> <span class="tok-nx">type</span><span class="tok-o">:</span><span class="tok-s1">&#39;homework&#39;</span><span class="tok-p">}).</span><span class="tok-nx">sort</span><span class="tok-p">({</span><span class="tok-nx">score</span><span class="tok-o">:-</span><span class="tok-mi">1</span><span class="tok-p">}).</span><span class="tok-nx">limit</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por ejemplo, si queremos paginar las notas de 10 en 10, a partir de la tercera página, podríamos hacer algo así:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">().</span><span class="tok-nx">sort</span><span class="tok-p">({</span><span class="tok-nx">score</span><span class="tok-o">:-</span><span class="tok-mi">1</span><span class="tok-p">}).</span><span class="tok-nx">limit</span><span class="tok-p">(</span><span class="tok-mi">10</span><span class="tok-p">).</span><span class="tok-nx">skip</span><span class="tok-p">(</span><span class="tok-mi">20</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Autoevaluación</div>
<div class="paragraph">
<p>A partir de la colección <em>grades</em>, escribe un consulta que obtenga los documentos de tipo "exam" ordenados descendentemente y que obtenga los documentos de 51 al 70. <span class="footnote">[<a id="_footnoteref_4" class="footnote" href="#_footnote_4" title="View footnote.">4</a>]</span></p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_contando_documentos">2.4.8. Contando Documentos</h4>
<div class="paragraph">
<p>Para contar el número de documentos, en vez de <code>find</code> usaremos el método <code>count</code>. Por ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">count</span><span class="tok-p">({</span><span class="tok-nx">type</span><span class="tok-o">:</span><span class="tok-s2">&quot;exam&quot;</span><span class="tok-p">})</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-nx">type</span><span class="tok-o">:</span><span class="tok-s2">&quot;exam&quot;</span><span class="tok-p">}).</span><span class="tok-nx">count</span><span class="tok-p">()</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">count</span><span class="tok-p">({</span><span class="tok-nx">type</span><span class="tok-o">:</span><span class="tok-s2">&quot;essay&quot;</span><span class="tok-p">,</span> <span class="tok-nx">score</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$gt</span><span class="tok-o">:</span><span class="tok-mi">90</span><span class="tok-p">}})</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>También se puede utilizar <code>count</code> como método de un cursor.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_actualizando_documentos">2.5. Actualizando documentos</h3>
<div class="paragraph">
<p>Para actualizar (y fusionar datos), se utiliza el método <code>update</code> con 2 parámetros: el primero es la consulta para averiguar sobre qué documentos, y en el segundo parámetro, los campos a modificar.</p>
</div>
<div class="listingblock">
<div class="title">Modificando un documento</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">update</span><span class="tok-p">({</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s2">&quot;Steve Jobs&quot;</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s2">&quot;Domingo Gallardo&quot;</span><span class="tok-p">,</span> <span class="tok-nx">salario</span><span class="tok-o">:</span> <span class="tok-mi">1000000</span><span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<code>update</code> hace un <strong>reemplazo</strong> de los campos, es decir, si en el origen había 100 campos y en el <code>update</code> sólo ponemos 2, el resultado sólo tendrá 2 campos. ¡Cuidado que puede ser muy PELIGROSO!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si cuando vamos a actualizar, en el criterio de selección no encuentra el documento sobre el que hacer los cambios, no se realiza ninguna acción.</p>
</div>
<div class="paragraph">
<p>Si quisiéramos que en el caso de no encontrar nada insertase un nuevo documento, acción conocida como <strong>upsert</strong> (<em><strong>up</strong>date + in<strong>sert</strong></em>), hay que pasarle un tercer parámetro al método con el objeto <code>{upsert:true}</code></p>
</div>
<div class="listingblock">
<div class="title">Ejemplo <em>upsert</em></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">update</span><span class="tok-p">({</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s2">&quot;Domingo Gallardo&quot;</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">name</span><span class="tok-o">:</span><span class="tok-s2">&quot;Domingo Gallardo&quot;</span><span class="tok-p">,</span> <span class="tok-nx">twitter</span><span class="tok-o">:</span> <span class="tok-s1">&#39;@domingogallardo&#39;</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">upsert</span><span class="tok-o">:</span> <span class="tok-kc">true</span><span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Otra manera de realizar un <em>upsert</em> es mediante la operación <code>save</code>, que ya hemos visto anteriormente. Así pues, si reescribimos la consulta anterior tendríamos (siempre y cuando considerasemos que el <code>nombre</code> actúa como el campo <code>_id</code>):</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo <em>save</em></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">save</span><span class="tok-p">({</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s2">&quot;Domingo Gallardo&quot;</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">name</span><span class="tok-o">:</span><span class="tok-s2">&quot;Domingo Gallardo&quot;</span><span class="tok-p">,</span> <span class="tok-nx">twitter</span><span class="tok-o">:</span> <span class="tok-s1">&#39;@domingogallardo&#39;</span><span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si no indicamos el valor <code>_id</code>, el comando <code>save</code> asume que es una inserción e inserta el documento en la colección.</p>
</div>
<div class="sect3">
<h4 id="_operadores_de_actualización">2.5.1. Operadores de actualización</h4>
<div class="paragraph">
<p><em>MongoDB</em> ofrece un conjunto de operadores para simplificar la modificación de campos.</p>
</div>
<div class="paragraph">
<p>Para evitar el reemplazo, hay que usar la variable <code>$set</code> (si el campo no existe, se creará).</p>
</div>
<div class="paragraph">
<p>Por ejemplo, para modificar el salario haríamos:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo <code>$set</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">update</span><span class="tok-p">({</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s2">&quot;Aitor Medrano&quot;</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">$set</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">salario</span><span class="tok-o">:</span> <span class="tok-mi">1000000</span><span class="tok-p">}})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Mediante <code>$inc</code> podemos incrementar el valor de una variable.</p>
</div>
<div class="paragraph">
<p>En cambio, si queremos incrementar el salario haríamos:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo <code>$inc</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">update</span><span class="tok-p">({</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s2">&quot;Aitor Medrano&quot;</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">$inc</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">salario</span><span class="tok-o">:</span> <span class="tok-mi">1000</span><span class="tok-p">}})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para eliminar un campo de un documento, usaremos el operador <code>$unset</code>.</p>
</div>
<div class="paragraph">
<p>De este modo, para eliminar el campo <code>twitter</code> de una persona haríamos:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo <code>$unset</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">update</span><span class="tok-p">({</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s2">&quot;Aitor Medrano&quot;</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">$unset</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">twitter</span><span class="tok-o">:</span> <span class="tok-s1">&#39;&#39;</span><span class="tok-p">}})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Otros operadores que podemos utilizar son <code>$mul</code>, <code>$min</code>, <code>$max</code> y <code>$currentDate</code>. Podemos consultar todos los operadores disponibles en <a href="http://docs.mongodb.org/manual/reference/operator/update/" class="bare">http://docs.mongodb.org/manual/reference/operator/update/</a></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Autoevaluación</div>
<div class="paragraph">
<p>Tras realizar la siguiente operación sobre una colección vacía:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">update</span><span class="tok-p">({</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s1">&#39;yo&#39;</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-s1">&#39;$set&#39;</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-s1">&#39;hobbies&#39;</span><span class="tok-o">:</span><span class="tok-p">[</span><span class="tok-s1">&#39;gaming&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;sofing&#39;</span><span class="tok-p">]}},</span> <span class="tok-p">{</span><span class="tok-nx">upsert</span><span class="tok-o">:</span> <span class="tok-kc">true</span><span class="tok-p">}</span> <span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>¿Cuál es el estado de la colección? <span class="footnote">[<a id="_footnoteref_5" class="footnote" href="#_footnote_5" title="View footnote.">5</a>]</span></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Realmente podemos dividir las actualizaciones en cuatro tipos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>reemplazo completo</p>
</li>
<li>
<p>modificar un campo</p>
</li>
<li>
<p>hacer un <em>upsert</em></p>
</li>
<li>
<p>o actualizar múltiples documentos</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_actualización_múltiple">2.5.2. Actualización múltiple</h4>
<div class="paragraph">
<p>Un aspecto que no hemos comentado y el cual es muy importante es que, si a la hora de actualizar la búsqueda devuelve más de un resultado, la actualización sólo se realiza sobre el primer resultado obtenido.</p>
</div>
<div class="paragraph">
<p>Para modificar múltiples documentos, en el tercer parámetro indicaremos <code>{multi: true}</code>. ¡Esta es una diferencia sustancial respecto a SQL!</p>
</div>
<div class="paragraph">
<p>Por ejemplo, para incrementar todas las calificaciones de los exámenes en un punto haríamos:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo Actualización Múltiple</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">update</span><span class="tok-p">({</span><span class="tok-nx">type</span><span class="tok-o">:</span><span class="tok-s1">&#39;exam&#39;</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-s1">&#39;$inc&#39;</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-s1">&#39;score&#39;</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">}},</span> <span class="tok-p">{</span><span class="tok-nx">multi</span><span class="tok-o">:</span> <span class="tok-kc">true</span><span class="tok-p">}</span> <span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cuando se hace una actualización múltiple, <em>MongoDB</em> no la realiza de manera atómica (no soporta transacciones <em>isolated</em>), lo que provoca que se puedan producir pausas (<em>pause yielding</em>). Cada documento si es atómico, por lo que ninguno se va a quedar a la mitad.</p>
</div>
<div class="paragraph">
<p><em>MongoDB</em> ofrece el método <code>findAndModify</code> para encontrar y modificar un documento de manera atómica, y así evitar que, entre la búsqueda y la modificación, el estado del documento se vea afectado. Además, devuelve el documento modificado. Un caso de uso muy común es para contadores y casos similares.</p>
</div>
<div class="listingblock">
<div class="title">Encontrar y Modificar de manera atómica - <code>findAndModify</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">findAndModify</span><span class="tok-p">({</span>
  <span class="tok-nx">query</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">student_id</span><span class="tok-o">:</span><span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-nx">type</span><span class="tok-o">:</span><span class="tok-s2">&quot;exam&quot;</span><span class="tok-p">},</span>
  <span class="tok-nx">update</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$inc</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">score</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">}},</span>
  <span class="tok-k">new</span><span class="tok-o">:</span> <span class="tok-kc">true</span>
<span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por defecto, el documento devuelto será el resultado que ha encontrado con la consulta. Si queremos que nos devuelva el documento modificado con los cambios deseados, necesitamos utilizar el parámetro <code>new</code> a <code>true</code>. Si no lo indicamos o lo ponemos a <code>false</code>, tendremos el comportamiento por defecto.</p>
</div>
<div class="paragraph">
<p>Para el resto de opciones que ofrece <code>findAndModifiy</code> se recomienda consultar la documentación (<a href="http://docs.mongodb.org/master/reference/method/db.collection.findAndModify/" class="bare">http://docs.mongodb.org/master/reference/method/db.collection.findAndModify/</a>)</p>
</div>
<div class="paragraph">
<p>Finalmente, un caso particular de las actualizaciones es la posibilidad de renombrar un campo mediante el operador <code>$rename</code>:</p>
</div>
<div class="listingblock">
<div class="title">Renombrando un campo con <code>$rename</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">update</span><span class="tok-p">(</span> <span class="tok-p">{</span><span class="tok-nx">_id</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">$rename</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-s1">&#39;nickname&#39;</span><span class="tok-o">:</span><span class="tok-s1">&#39;alias&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;cell&#39;</span><span class="tok-o">:</span><span class="tok-s1">&#39;movil&#39;</span><span class="tok-p">}})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos consultar todas las opción de configuración de una actualización en
<a href="http://docs.mongodb.org/manual/reference/method/db.collection.update/" class="bare">http://docs.mongodb.org/manual/reference/method/db.collection.update/</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_actualizaciones_sobre_arrays">2.5.3. Actualizaciones sobre Arrays</h4>
<div class="paragraph">
<p>Para trabajar con arrays necesitamos nuevos operadores que nos permitan tanto introducir como eliminar elementos de una manera más sencilla que sustituir todos los elementos del array.</p>
</div>
<div class="paragraph">
<p>Los operadores que podemos emplear para trabajar con arrays son:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Operador</th>
<th class="tableblock halign-left valign-top">Propósito</th>
</tr>
</thead>
<tbody>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock"><code>$push</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Añade un elemento</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock"><code>$pushAll</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Añade varios elementos</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock"><code>$addToSet</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Añade un elemento sin duplicados</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock"><code>$pull</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Elimina un elemento</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock"><code>$pullAll</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Elimina varios elementos</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock"><code>$pop</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Elimina el primer o el último</p></td>
</tr>
</tbody>
</table>
<div class="sidebarblock">
<div class="content">
<div class="title">Preparando los ejemplos</div>
<div class="paragraph">
<p>Para trabajar con los arrays, vamos a suponer que tenemos una colección de <em>enlaces</em> donde vamos a almacenar un documento por cada site, con un atributo <em>tags</em> con etiquetas sobre el enlace en cuestión</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">enlaces</span><span class="tok-p">.</span><span class="tok-nx">insert</span><span class="tok-p">({</span><span class="tok-nx">titulo</span><span class="tok-o">:</span><span class="tok-s2">&quot;www.google.es&quot;</span><span class="tok-p">,</span> <span class="tok-nx">tags</span><span class="tok-o">:</span><span class="tok-p">[</span><span class="tok-s2">&quot;mapas&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;videos&quot;</span><span class="tok-p">]})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>De modo que tendríamos el siguiente objeto:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span>
	<span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;54f9769212b1897ae84190cf&quot;</span><span class="tok-p">),</span>
	<span class="tok-s2">&quot;titulo&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;www.google.es&quot;</span><span class="tok-p">,</span>
	<span class="tok-s2">&quot;tags&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span>
		<span class="tok-s2">&quot;mapas&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;videos&quot;</span>
	<span class="tok-p">]</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_añadiendo_elementos">Añadiendo elementos</h5>
<div class="paragraph">
<p>Si queremos añadir un elemento, usaremos el operador <code>$push</code>. Si queremos añadir varios elementos de una sola vez, usaremos <code>$pushAll</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">enlaces</span><span class="tok-p">.</span><span class="tok-nx">update</span><span class="tok-p">({</span><span class="tok-nx">titulo</span><span class="tok-o">:</span><span class="tok-s2">&quot;www.google.es&quot;</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">$push</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">tags</span><span class="tok-o">:</span><span class="tok-s2">&quot;blog&quot;</span><span class="tok-p">}})</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">enlaces</span><span class="tok-p">.</span><span class="tok-nx">update</span><span class="tok-p">({</span><span class="tok-nx">titulo</span><span class="tok-o">:</span><span class="tok-s2">&quot;www.google.es&quot;</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">$pushAll</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">tags</span><span class="tok-o">:</span><span class="tok-p">[</span><span class="tok-s2">&quot;calendario&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;email&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;mapas&quot;</span><span class="tok-p">]}})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Al hacer estar modificación, el resultado del documento sería:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span>
  <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;54f9769212b1897ae84190cf&quot;</span><span class="tok-p">),</span>
  <span class="tok-s2">&quot;titulo&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;www.google.es&quot;</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;tags&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span>
    <span class="tok-s2">&quot;mapas&quot;</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;videos&quot;</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;blog&quot;</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;calendario&quot;</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;email&quot;</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;mapas&quot;</span>
  <span class="tok-p">]</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Tanto <code>$push</code> como <code>$pushAll</code> no tienen en cuenta lo que contiene el array, por tanto, si un elemento ya existe, se repetirá y tendremos duplicados. Si queremos evitar los duplicados, usaremos <code>$addToSet</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">enlaces</span><span class="tok-p">.</span><span class="tok-nx">update</span><span class="tok-p">({</span><span class="tok-nx">titulo</span><span class="tok-o">:</span><span class="tok-s2">&quot;www.google.es&quot;</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">$addToSet</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">tags</span><span class="tok-o">:</span><span class="tok-s2">&quot;buscador&quot;</span><span class="tok-p">}})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si queremos añadir más de un campo a la vez sin duplicados, debemos anidar el operador <code>$each</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">enlaces</span><span class="tok-p">.</span><span class="tok-nx">update</span><span class="tok-p">({</span><span class="tok-nx">titulo</span><span class="tok-o">:</span><span class="tok-s2">&quot;www.google.es&quot;</span><span class="tok-p">},{</span> <span class="tok-nx">$addToSet</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">tags</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$each</span><span class="tok-o">:</span><span class="tok-p">[</span><span class="tok-s2">&quot;drive&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;traductor&quot;</span><span class="tok-p">]}}})</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_eliminando_elementos">Eliminando elementos</h5>
<div class="paragraph">
<p>En cambio, si queremos eliminar elementos de un array, usaremos el operador <code>$pull</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">enlaces</span><span class="tok-p">.</span><span class="tok-nx">update</span><span class="tok-p">({</span><span class="tok-nx">titulo</span><span class="tok-o">:</span><span class="tok-s2">&quot;www.google.es&quot;</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">$pull</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">tags</span><span class="tok-o">:</span><span class="tok-s2">&quot;traductor&quot;</span><span class="tok-p">}})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Similar al caso anterior, con <code>$pullAll</code>, eliminaremos varios elementos de una sola vez:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">enlaces</span><span class="tok-p">.</span><span class="tok-nx">update</span><span class="tok-p">({</span><span class="tok-nx">titulo</span><span class="tok-o">:</span><span class="tok-s2">&quot;www.google.es&quot;</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">$pullAll</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">tags</span><span class="tok-o">:</span><span class="tok-p">[</span><span class="tok-s2">&quot;calendario&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;email&quot;</span><span class="tok-p">]}})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Otra manera de eliminar elementos del array es mediante <code>$pop</code>, el cual elimina el primero (<code>-1</code>) o el último (<code>1</code>) elemento del array:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">enlaces</span><span class="tok-p">.</span><span class="tok-nx">update</span><span class="tok-p">({</span><span class="tok-nx">titulo</span><span class="tok-o">:</span><span class="tok-s2">&quot;www.google.es&quot;</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">$pop</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">tags</span><span class="tok-o">:-</span><span class="tok-mi">1</span><span class="tok-p">}})</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_operador_posicional">Operador posicional</h5>
<div class="paragraph">
<p>Por último, tenemos el operador posicional, el cual se expresa con el símbolo <code>$</code> (<a href="http://docs.mongodb.org/master/reference/operator/update/positional/" class="bare">http://docs.mongodb.org/master/reference/operator/update/positional/</a>) y nos permite modificar el elemento que ocupa una determinada posición del array.</p>
</div>
<div class="paragraph">
<p>Supongamos que tenemos las calificaciones de los estudiantes (colección <code>students</code>) en un documento con una estructura similar a la siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-s2">&quot;grades&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span> <span class="tok-mi">80</span><span class="tok-p">,</span> <span class="tok-mi">85</span><span class="tok-p">,</span> <span class="tok-mi">90</span> <span class="tok-p">]</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>y queremos cambiar la calificación de <code>80</code> por <code>82</code>. Mediante el operador posicional haremos:</p>
</div>
<div class="listingblock">
<div class="title">Modificando un array con el operador posicional</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">update</span><span class="tok-p">(</span> <span class="tok-p">{</span> <span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-nx">grades</span><span class="tok-o">:</span> <span class="tok-mi">80</span> <span class="tok-p">},</span> <span class="tok-p">{</span> <span class="tok-nx">$set</span><span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;grades.$&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">82</span> <span class="tok-p">}</span> <span class="tok-p">}</span> <span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>De manera similar, si queremos modificar parte de un documento el cual forma parte de un array, debemos usar la notación punto tras el <code>$</code>:</p>
</div>
<div class="paragraph">
<p>Por ejemplo, supongamos que tenemos estas calificación de un determinado alumno:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo de calificación de un alumno, las cuales forman parte de un objeto dentro de un array</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">4</span><span class="tok-p">,</span> <span class="tok-s2">&quot;grades&quot;</span> <span class="tok-o">:</span>
  <span class="tok-p">[</span> <span class="tok-p">{</span> <span class="tok-nx">grade</span><span class="tok-o">:</span> <span class="tok-mi">80</span><span class="tok-p">,</span> <span class="tok-nx">mean</span><span class="tok-o">:</span> <span class="tok-mi">75</span><span class="tok-p">,</span> <span class="tok-nx">std</span><span class="tok-o">:</span> <span class="tok-mi">8</span> <span class="tok-p">},</span>
    <span class="tok-p">{</span> <span class="tok-nx">grade</span><span class="tok-o">:</span> <span class="tok-mi">85</span><span class="tok-p">,</span> <span class="tok-nx">mean</span><span class="tok-o">:</span> <span class="tok-mi">90</span><span class="tok-p">,</span> <span class="tok-nx">std</span><span class="tok-o">:</span> <span class="tok-mi">5</span> <span class="tok-p">},</span>
    <span class="tok-p">{</span> <span class="tok-nx">grade</span><span class="tok-o">:</span> <span class="tok-mi">90</span><span class="tok-p">,</span> <span class="tok-nx">mean</span><span class="tok-o">:</span> <span class="tok-mi">85</span><span class="tok-p">,</span> <span class="tok-nx">std</span><span class="tok-o">:</span> <span class="tok-mi">3</span> <span class="tok-p">}</span> <span class="tok-p">]</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos observar como tenemos cada calificación como parte de un objeto dentro de un array. Si queremos cambiar el valor de <code>std</code> a <code>6</code> de la calificación cuya nota es <code>85</code>, haremos:</p>
</div>
<div class="listingblock">
<div class="title">Modificando un elemento de un objeto dentro de un array</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">update</span><span class="tok-p">(</span> <span class="tok-p">{</span> <span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-mi">4</span><span class="tok-p">,</span> <span class="tok-s2">&quot;grades.grade&quot;</span><span class="tok-o">:</span> <span class="tok-mi">85</span> <span class="tok-p">},</span> <span class="tok-p">{</span> <span class="tok-nx">$set</span><span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;grades.$.std&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">6</span> <span class="tok-p">}</span> <span class="tok-p">}</span> <span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Es decir, el <code>$</code> referencia al documento que ha cumplido el filtro de búsqueda.</p>
</div>
<div class="paragraph">
<p>Podemos consultar toda la documentación disponible sobre estos operadores en <a href="http://docs.mongodb.org/manual/reference/operator/update-array/" class="bare">http://docs.mongodb.org/manual/reference/operator/update-array/</a></p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_borrando_documentos">2.6. Borrando documentos</h3>
<div class="paragraph">
<p>Para borrar, usaremos el método <code>remove</code>, el cual funciona de manera similar a <code>find</code>. Si no pasamos ningún parámetro, borra toda la colección documento a documento. Si le pasamos un parámetro, éste será el criterio de selección de documentos a eliminar.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">remove</span><span class="tok-p">({</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s2">&quot;Domingo Gallardo&quot;</span><span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Al eliminar un documento, no podemos olvidar que cualquier referencia al documento que existe en la base de datos seguirá existiendo. Por este motivo, manualmente también hay que eliminar o modificar esas referencias.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si queremos borrar toda la colección, es más eficiente usar el método <code>drop</code>, ya que también elimina los índices.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">drop</span><span class="tok-p">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Recordad que eliminar un determinado campo de un documento no se considera un operación de borrado, sino una actualización mediante el operador <code>$unset</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_control_de_errores">2.7. Control de errores</h3>
<div class="paragraph">
<p>En versiones anteriores a la 2.6, si queremos averiguar qué ha sucedido, y si ha fallado conocer el motivo, deberemos ejecutar el siguiente comando con <code>getLastError</code> (<a href="http://docs.mongodb.org/master/reference/command/getLastError/" class="bare">http://docs.mongodb.org/master/reference/command/getLastError/</a>):</p>
</div>
<div class="listingblock">
<div class="title">Control de Errores</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">runCommand</span><span class="tok-p">({</span><span class="tok-nx">getLastError</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para ello, ejecutaremos la sentencia después de haber realizado una operación, para obtener información sobre la última operación realizada.</p>
</div>
<div class="paragraph">
<p>Si la última operación ha sido una modificación mediante un <code>update</code> podremos obtener el número de registros afectados, o si es un <code>upsert</code> podremos obtener si ha insertado o modificado el documento. Finalmente, en el caso de una operación de borrado, podemos obtener el número de documentos eliminados.</p>
</div>
<div class="paragraph">
<p>Desde la versión 2.6, <em>MongoDB</em> devuelve un objeto <code>WriteResult</code> con información del número de documentos afectados (<code>nInserted</code>), y en el caso de un error, un documento en la propiedad <code>writeError</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">insert</span><span class="tok-p">({</span><span class="tok-s2">&quot;_id&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;error&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;nombre&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;Pedro Casas&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;edad&quot;</span><span class="tok-o">:</span><span class="tok-mi">38</span><span class="tok-p">})</span>
<span class="tok-nx">WriteResult</span><span class="tok-p">({</span> <span class="tok-s2">&quot;nInserted&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span> <span class="tok-p">})</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">insert</span><span class="tok-p">({</span><span class="tok-s2">&quot;_id&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;error&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;nombre&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;Pedro Casas&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;edad&quot;</span><span class="tok-o">:</span><span class="tok-mi">38</span><span class="tok-p">})</span>
<span class="tok-nx">WriteResult</span><span class="tok-p">({</span>
	<span class="tok-s2">&quot;nInserted&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">0</span><span class="tok-p">,</span>
	<span class="tok-s2">&quot;writeError&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
		<span class="tok-s2">&quot;code&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">11000</span><span class="tok-p">,</span>
		<span class="tok-s2">&quot;errmsg&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;insertDocument :: caused by :: 11000 E11000 duplicate key error index: expertojava.people.$_id_  dup key: { : \&quot;error\&quot; }&quot;</span>
	<span class="tok-p">}</span>
<span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Más información en <a href="http://docs.mongodb.org/master/reference/method/db.collection.insert/#writeresult" class="bare">http://docs.mongodb.org/master/reference/method/db.collection.insert/#writeresult</a></p>
</div>
<div class="paragraph">
<p>A continuación vamos a estudiar como realizar todas estas operación mediante el driver <em>Java</em> que ofrece <em>MongoDB</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="__em_mongodb_em_desde_em_java_em">2.8. <em>MongoDB</em> desde <em>Java</em></h3>
<div class="paragraph">
<p>Para interactuar desde <em>Java</em> con <em>MongoDB</em> disponemos de diferentes alternativas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Trabajar directamente con el driver <em>Java</em></p>
</li>
<li>
<p>Utilizar un abstracción JPA</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>En nuestro caso, nos vamos a centrar en el uso del driver.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">v2 o v3</div>
<div class="paragraph">
<p>En la actualidad existen dos versiones principales del driver <em>Java</em>, dependiendo de la versión de <em>MongoDB</em> que estemos empleando, ya sea la v2 o la v3. A partir de la versión 3, se introdujeron nuevas interfaces y clases para interactuar con <em>MongoDB</em>, con lo cual, lo primero que debemos hacer es decidirnos por uno u otro.</p>
</div>
<div class="paragraph">
<p>La ventaja de usar la v2 es que existe una comunidad rica con mucha documentación y librerías construidas sobre esta versión. En cambio, la v3 ofrece un API más intuitiva y promete un mejor rendimiento al ofrecer un esquema de documento que se traduce a BSON.</p>
</div>
<div class="paragraph">
<p>En principio, los apuntes que vienen a continuación se centran en la versión v2 para explicar los conceptos. Más adelante, se muestra un ejemplo con código de la versión v3 para mostrar las diferencias.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para descargar el driver, tal como vimos en la unidad anterior, hemos de utilizar la siguiente dependencia <em>Maven</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;dependency&gt;</span>
  <span class="tok-nt">&lt;groupId&gt;</span>org.mongodb<span class="tok-nt">&lt;/groupId&gt;</span>
  <span class="tok-nt">&lt;artifactId&gt;</span>mongo-java-driver<span class="tok-nt">&lt;/artifactId&gt;</span>
  <span class="tok-nt">&lt;version&gt;</span>2.14.2<span class="tok-nt">&lt;/version&gt;</span>
<span class="tok-nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si nos decidimos por la versión 3, el nombre del artefacto cambia, así como su versión:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;dependency&gt;</span>
  <span class="tok-nt">&lt;groupId&gt;</span>org.mongodb<span class="tok-nt">&lt;/groupId&gt;</span>
  <span class="tok-nt">&lt;artifactId&gt;</span>mongodb-driver<span class="tok-nt">&lt;/artifactId&gt;</span>
  <span class="tok-nt">&lt;version&gt;</span>3.2.2<span class="tok-nt">&lt;/version&gt;</span>
<span class="tok-nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Todas las clases explicadas a continuación pertenecen al paquete <code>com.mongodb</code>.  Toda la información del API de <em>MongoDB</em> la podemos encontrar en <a href="http://api.mongodb.org/java/current/" class="bare">http://api.mongodb.org/java/current/</a> e información del driver en <a href="http://mongodb.github.io/mongo-java-driver/" class="bare">http://mongodb.github.io/mongo-java-driver/</a></p>
</div>
<div class="sect3">
<h4 id="__code_mongoclient_code">2.8.1. <code>MongoClient</code></h4>
<div class="paragraph">
<p>Para conectarnos desde <em>Java</em>, tenemos que crear un <code>MongoClient</code>, el cual gestiona internamente un <em>pool</em> de conexiones. Su constructor se sobrecarga para permitir la conexión a una URI, a un determinado puerto o a un conjunto de réplicas. Podemos consultar todas estas opciones en <a href="http://api.mongodb.org/java/current/com/mongodb/MongoClient.html" class="bare">http://api.mongodb.org/java/current/com/mongodb/MongoClient.html</a></p>
</div>
<div class="paragraph">
<p>A partir de un <code>MongoClient</code>, podremos obtener una <code>DB</code> y de ésta una <code>DBCollection</code>:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo de conexión a MongoDB con Java (<code>HolaMongoDB.java</code>)</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">MongoClient</span> <span class="tok-n">cliente</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">MongoClient</span><span class="tok-o">();</span>  <i class="conum" data-value="1"></i><b>(1)</b>

<span class="tok-n">DB</span> <span class="tok-n">db</span> <span class="tok-o">=</span> <span class="tok-n">cliente</span><span class="tok-o">.</span><span class="tok-na">getDB</span><span class="tok-o">(</span><span class="tok-s">&quot;expertojava&quot;</span><span class="tok-o">);</span>
<span class="tok-n">DBCollection</span> <span class="tok-n">col</span> <span class="tok-o">=</span> <span class="tok-n">db</span><span class="tok-o">.</span><span class="tok-na">getCollection</span><span class="tok-o">(</span><span class="tok-s">&quot;people&quot;</span><span class="tok-o">);</span>

<span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;doc:&quot;</span> <span class="tok-o">+</span> <span class="tok-n">col</span><span class="tok-o">.</span><span class="tok-na">findOne</span><span class="tok-o">());</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>MongoClient</code> realiza la conexión con la base de datos. El constructor por defecto se conecta con <code>localhost</code> al puerto <code>27017</code>. Además, lanza una <code>UnknownHostException</code> cuando no encuentra un servidor funcionando</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>DBCollection</code> nos permite interactuar con la colección, y sobre ella realizaremos las operaciones CRUD.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Sobre un <code>MongoClient</code> podemos destacar los siguientes métodos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>getDB(String nombre)</code> &#8594; recupera la base de datos indicada</p>
</li>
<li>
<p><code>dropDatabase(String nombre)</code> &#8594; elimina la base de datos indicada</p>
</li>
<li>
<p><code>getDatabaseNames()</code> &#8594; obtiene el nombre de las bases de datos existentes</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Sobre una <code>DB</code> podemos destacar los siguientes métodos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>getCollection(String nombre)</code> &#8594; recupera la colección indicada</p>
</li>
<li>
<p><code>command(DBObject obj)</code> &#8594; ejecuta un comnado</p>
</li>
<li>
<p><code>createCollection(String col)</code> &#8594; crea una nueva colección sobre la DB activa</p>
</li>
<li>
<p><code>dropDatabase()</code> &#8594; elimina la base de datos activa</p>
</li>
<li>
<p><code>getCollectionNames()</code> &#8594;  obtiene el nombre de las colecciones existentes</p>
</li>
<li>
<p><code>getLastError()</code> &#8594; obtiene el último error, si lo hay, de la operación previa (<em>deprecated</em>)</p>
</li>
<li>
<p><code>shutdownServer()</code> &#8594; detiene el servidor</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="__code_dbobject_code">2.8.2. <code>DBObject</code></h4>
<div class="paragraph">
<p>Para representar un documento JSON se utiliza el interfaz <code>DBObject</code>, el cual se emplea como parámetro para la mayoría de operaciones. Su funcionamiento es similar a un mapa donde las claves están ordenadas.</p>
</div>
<div class="paragraph">
<p>Para crear un documento necesitamos una instancia de <code>BasicDBObject</code>. Por ejemplo, podremos crear un documento del siguiente modo:</p>
</div>
<div class="listingblock">
<div class="title">Rellenando un <code>BasicDBObject</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">BasicDBObject</span> <span class="tok-n">doc</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">();</span>
<span class="tok-n">doc</span><span class="tok-o">.</span><span class="tok-na">put</span><span class="tok-o">(</span><span class="tok-s">&quot;nombre&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Aitor Medrano&quot;</span><span class="tok-o">);</span>
<span class="tok-n">doc</span><span class="tok-o">.</span><span class="tok-na">put</span><span class="tok-o">(</span><span class="tok-s">&quot;fnac&quot;</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-nf">Date</span><span class="tok-o">(</span><span class="tok-mi">234832423</span><span class="tok-o">));</span>
<span class="tok-n">doc</span><span class="tok-o">.</span><span class="tok-na">put</span><span class="tok-o">(</span><span class="tok-s">&quot;casado&quot;</span><span class="tok-o">,</span> <span class="tok-kc">true</span><span class="tok-o">);</span>
<span class="tok-n">doc</span><span class="tok-o">.</span><span class="tok-na">put</span><span class="tok-o">(</span><span class="tok-s">&quot;hijos&quot;</span><span class="tok-o">,</span> <span class="tok-mi">2</span><span class="tok-o">);</span>
<span class="tok-n">doc</span><span class="tok-o">.</span><span class="tok-na">put</span><span class="tok-o">(</span><span class="tok-s">&quot;hobbies&quot;</span><span class="tok-o">,</span> <span class="tok-n">Arrays</span><span class="tok-o">.</span><span class="tok-na">asList</span><span class="tok-o">(</span><span class="tok-s">&quot;programación&quot;</span><span class="tok-o">,</span><span class="tok-s">&quot;videojuegos&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;baloncesto&quot;</span><span class="tok-o">));</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-n">doc</span><span class="tok-o">.</span><span class="tok-na">put</span><span class="tok-o">(</span><span class="tok-s">&quot;direccion&quot;</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;calle&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Mayor&quot;</span><span class="tok-o">)</span>  <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="tok-o">.</span><span class="tok-na">append</span><span class="tok-o">(</span><span class="tok-s">&quot;ciudad&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Elx&quot;</span><span class="tok-o">)</span>
  <span class="tok-o">.</span><span class="tok-na">append</span><span class="tok-o">(</span><span class="tok-s">&quot;cp&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;03206&quot;</span><span class="tok-o">));</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Los arrays realmente son implementaciones de <code>BasicDBList</code>, el cual es una lista de <code>DBObject</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Además de usar el método <code>put</code> para añadir un atributo a un objeto, podemos crear un objeto con su constructor de clave/valor, o mediante el método <code>append</code> para concatenar un objeto al existente.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Además, las operaciones para realizar consultas devuelven objetos <code>DBObject</code> o bien son listas (<code>List&lt;DBObject&gt;</code>). Para acceder a los campos de un <code>DBObject</code> emplearemos el método <code>get</code>:</p>
</div>
<div class="listingblock">
<div class="title">Obteniendo datos a partir de un <code>DBObject</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">Persona</span> <span class="tok-n">p</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Persona</span><span class="tok-o">();</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-n">p</span><span class="tok-o">.</span><span class="tok-na">setNombre</span><span class="tok-o">((</span><span class="tok-n">String</span><span class="tok-o">)</span> <span class="tok-n">obj</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-s">&quot;nombre&quot;</span><span class="tok-o">));</span>
<span class="tok-n">p</span><span class="tok-o">.</span><span class="tok-na">setFnac</span><span class="tok-o">((</span><span class="tok-n">Date</span><span class="tok-o">)</span> <span class="tok-n">obj</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-s">&quot;fnac&quot;</span><span class="tok-o">));</span>
<span class="tok-n">p</span><span class="tok-o">.</span><span class="tok-na">setHijos</span><span class="tok-o">((</span><span class="tok-n">Integer</span><span class="tok-o">)</span> <span class="tok-n">obj</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-s">&quot;hijos&quot;</span><span class="tok-o">));</span>

<span class="tok-n">BasicDBList</span> <span class="tok-n">hobbies</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-n">BasicDBList</span><span class="tok-o">)</span> <span class="tok-n">obj</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-s">&quot;hobbies&quot;</span><span class="tok-o">);</span>
<span class="tok-n">p</span><span class="tok-o">.</span><span class="tok-na">setHobbies</span><span class="tok-o">(</span><span class="tok-n">hobbies</span><span class="tok-o">.</span><span class="tok-na">toArray</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-n">String</span><span class="tok-o">[</span><span class="tok-mi">0</span><span class="tok-o">]));</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Supongamos que tenemos una clase de modelo <code>Persona</code> compuesta únicamente de <em>getters</em>/<em>setters</em> sobre las propiedades del objeto</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Dentro de la clase <code>Persona</code>, tenemos la siguiente declaración <code>String[] hobbies</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para realizar operaciones, tras conectar del <code>MongoClient</code> una <code>DB</code>, y de la <code>DB</code> una <code>DBCollection</code> podemos realizar las operaciones de inserción, consulta, modificación y borrado.</p>
</div>
</div>
<div class="sect3">
<h4 id="_inserción">2.8.3. Inserción</h4>
<div class="paragraph">
<p>Para insertar datos emplearemos el método <code>coleccion.insert(DBObject objeto)</code>.</p>
</div>
<div class="paragraph">
<p>Tras insertar el objeto, <em>MongoDB</em> rellenará automáticamente la clave <code>_id</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Autoevaluación</div>
<div class="paragraph">
<p>¿Funcionará el segundo <code>insert</code>? <span class="footnote">[<a id="_footnoteref_6" class="footnote" href="#_footnote_6" title="View footnote.">6</a>]</span></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">MongoClient</span> <span class="tok-n">client</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">MongoClient</span><span class="tok-o">();</span>
<span class="tok-n">DB</span> <span class="tok-n">db</span> <span class="tok-o">=</span> <span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-na">getDB</span><span class="tok-o">(</span><span class="tok-s">&quot;expertojava&quot;</span><span class="tok-o">);</span>
<span class="tok-n">DBCollection</span> <span class="tok-n">people</span> <span class="tok-o">=</span> <span class="tok-n">db</span><span class="tok-o">.</span><span class="tok-na">getCollection</span><span class="tok-o">(</span><span class="tok-s">&quot;people&quot;</span><span class="tok-o">);</span>
<span class="tok-n">DBObject</span> <span class="tok-n">doc</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;nombre&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Aitor Medrano&quot;</span><span class="tok-o">)</span>
  <span class="tok-o">.</span><span class="tok-na">append</span><span class="tok-o">(</span><span class="tok-s">&quot;twitter&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;@aitormedrano&quot;</span><span class="tok-o">);</span>

<span class="tok-k">try</span> <span class="tok-o">{</span>
  <span class="tok-n">people</span><span class="tok-o">.</span><span class="tok-na">insert</span><span class="tok-o">(</span><span class="tok-n">doc</span><span class="tok-o">);</span>      <span class="tok-c1">// primer insert</span>
  <span class="tok-n">doc</span><span class="tok-o">.</span><span class="tok-na">removeField</span><span class="tok-o">(</span><span class="tok-s">&quot;_id&quot;</span><span class="tok-o">);</span>  <span class="tok-c1">// elimina el campo &quot;_id&quot;</span>
  <span class="tok-n">people</span><span class="tok-o">.</span><span class="tok-na">insert</span><span class="tok-o">(</span><span class="tok-n">doc</span><span class="tok-o">);</span>      <span class="tok-c1">// segundo insert</span>
<span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">Exception</span> <span class="tok-n">e</span><span class="tok-o">)</span> <span class="tok-o">{</span>
  <span class="tok-n">e</span><span class="tok-o">.</span><span class="tok-na">printStackTrace</span><span class="tok-o">();</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_consultas_2">2.8.4. Consultas</h4>
<div class="paragraph">
<p>Para hacer consultas utilizaremos el método <code>find</code> o <code>findOne</code>, de manera similar al uso desde el <em>shell</em>. Hay que destacar que cuando hacemos una consulta con <code>find</code> recuperamos un <code>DBCursor</code>, el cual funciona como un iterador y que nos permite recorrer los documentos encontrados.</p>
</div>
<div class="paragraph">
<p>A continuación tenemos un ejemplo de su uso:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">MongoClient</span> <span class="tok-n">client</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">MongoClient</span><span class="tok-o">();</span>
<span class="tok-n">DB</span> <span class="tok-n">db</span> <span class="tok-o">=</span> <span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-na">getDB</span><span class="tok-o">(</span><span class="tok-s">&quot;expertojava&quot;</span><span class="tok-o">);</span>
<span class="tok-n">DBCollection</span> <span class="tok-n">coleccion</span> <span class="tok-o">=</span> <span class="tok-n">db</span><span class="tok-o">.</span><span class="tok-na">getCollection</span><span class="tok-o">(</span><span class="tok-s">&quot;pruebas&quot;</span><span class="tok-o">);</span>
<span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">drop</span><span class="tok-o">();</span>  <i class="conum" data-value="1"></i><b>(1)</b>

<span class="tok-c1">// insertamos 10 documentos con un número aleatorio</span>
<span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-kt">int</span> <span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-o">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-mi">10</span><span class="tok-o">;</span> <span class="tok-n">i</span><span class="tok-o">++)</span> <span class="tok-o">{</span>
  <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">insert</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;numero&quot;</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-nf">Random</span><span class="tok-o">().</span><span class="tok-na">nextInt</span><span class="tok-o">(</span><span class="tok-mi">100</span><span class="tok-o">)));</span>
<span class="tok-o">}</span>

<span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;Primero:&quot;</span><span class="tok-o">);</span>
<span class="tok-n">DBObject</span> <span class="tok-n">uno</span> <span class="tok-o">=</span> <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">findOne</span><span class="tok-o">();</span> <span class="tok-c1">// Encuentra uno</span>
<span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">uno</span><span class="tok-o">);</span>

<span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;\nTodos: &quot;</span><span class="tok-o">);</span>
<span class="tok-n">DBCursor</span> <span class="tok-n">cursor</span> <span class="tok-o">=</span> <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">();</span> <span class="tok-c1">// Encuentra todos</span>
<span class="tok-k">try</span> <span class="tok-o">{</span>
  <span class="tok-k">while</span> <span class="tok-o">(</span><span class="tok-n">cursor</span><span class="tok-o">.</span><span class="tok-na">hasNext</span><span class="tok-o">())</span> <span class="tok-o">{</span>
    <span class="tok-n">DBObject</span> <span class="tok-n">otro</span> <span class="tok-o">=</span> <span class="tok-n">cursor</span><span class="tok-o">.</span><span class="tok-na">next</span><span class="tok-o">();</span>
    <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">otro</span><span class="tok-o">);</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span> <span class="tok-k">finally</span> <span class="tok-o">{</span>
  <span class="tok-n">cursor</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-o">}</span>

<span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;\nTotal:&quot;</span> <span class="tok-o">+</span> <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">count</span><span class="tok-o">());</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Antes de rellenar la colección, la vaciamos para siempre partir de cero.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Es recomendable cerrar el cursor tras finalizar su uso</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_criterios">Criterios</h5>
<div class="paragraph">
<p>Supongamos que partimos de una colección con los siguientes datos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">MongoClient</span> <span class="tok-n">cliente</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">MongoClient</span><span class="tok-o">();</span>
<span class="tok-n">DB</span> <span class="tok-n">db</span> <span class="tok-o">=</span> <span class="tok-n">cliente</span><span class="tok-o">.</span><span class="tok-na">getDB</span><span class="tok-o">(</span><span class="tok-s">&quot;expertojava&quot;</span><span class="tok-o">);</span>
<span class="tok-n">DBCollection</span> <span class="tok-n">coleccion</span> <span class="tok-o">=</span> <span class="tok-n">db</span><span class="tok-o">.</span><span class="tok-na">getCollection</span><span class="tok-o">(</span><span class="tok-s">&quot;pruebas&quot;</span><span class="tok-o">);</span>
<span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">drop</span><span class="tok-o">();</span>

<span class="tok-c1">// insertamos 10 documentos con 2 números aleatorios</span>
<span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-kt">int</span> <span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-o">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-mi">10</span><span class="tok-o">;</span> <span class="tok-n">i</span><span class="tok-o">++)</span> <span class="tok-o">{</span>
  <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">insert</span><span class="tok-o">(</span>
    <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;x&quot;</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-nf">Random</span><span class="tok-o">().</span><span class="tok-na">nextInt</span><span class="tok-o">(</span><span class="tok-mi">2</span><span class="tok-o">))</span>
      <span class="tok-o">.</span><span class="tok-na">append</span><span class="tok-o">(</span><span class="tok-s">&quot;y&quot;</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-nf">Random</span><span class="tok-o">().</span><span class="tok-na">nextInt</span><span class="tok-o">(</span><span class="tok-mi">100</span><span class="tok-o">)));</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para añadir criterios a las consultas, podemos hacerlo de dos maneras:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Usando el objeto <code>QueryBuilder</code>, el cual ofrece diferentes métodos asociados a los operadores lógicos y aritméticos, y que permite hacer consultas a más alto nivel, lo que desacopla al driver de la sintaxis de <em>MongoDB</em>.</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">QueryBuilder</span> <span class="tok-n">builder</span> <span class="tok-o">=</span> <span class="tok-n">QueryBuilder</span><span class="tok-o">.</span><span class="tok-na">start</span><span class="tok-o">(</span><span class="tok-s">&quot;x&quot;</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">).</span><span class="tok-na">and</span><span class="tok-o">(</span><span class="tok-s">&quot;y&quot;</span><span class="tok-o">).</span><span class="tok-na">greaterThan</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">lessThan</span><span class="tok-o">(</span><span class="tok-mi">90</span><span class="tok-o">);</span>
<span class="tok-kt">long</span> <span class="tok-n">cantidadBuilder</span> <span class="tok-o">=</span> <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">count</span><span class="tok-o">(</span><span class="tok-n">builder</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">());</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Más información en <a href="http://api.mongodb.org/java/current/com/mongodb/QueryBuilder.html" class="bare">http://api.mongodb.org/java/current/com/mongodb/QueryBuilder.html</a></p>
</div>
</li>
<li>
<p>Añadiendo las condiciones de manera similar a como se realiza mediante el shell creando <code>BasicDBObject</code></p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">DBObject</span> <span class="tok-n">query</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;x&quot;</span><span class="tok-o">,</span> <span class="tok-mi">0</span><span class="tok-o">).</span><span class="tok-na">append</span><span class="tok-o">(</span><span class="tok-s">&quot;y&quot;</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;$gt&quot;</span><span class="tok-o">,</span> <span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">append</span><span class="tok-o">(</span><span class="tok-s">&quot;$lt&quot;</span><span class="tok-o">,</span> <span class="tok-mi">90</span><span class="tok-o">));</span>
<span class="tok-kt">long</span> <span class="tok-n">cantidadQuery</span> <span class="tok-o">=</span> <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">count</span><span class="tok-o">(</span><span class="tok-n">query</span><span class="tok-o">);</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>En ambos casos, le podemos pasar tanto el <code>DBObject</code> como el <code>QueryBuilder</code> a los métodos <code>find</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;\nConsultas: &quot;</span><span class="tok-o">);</span>
<span class="tok-n">DBCursor</span> <span class="tok-n">cursor</span> <span class="tok-o">=</span> <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">builder</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">());</span>  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-k">try</span> <span class="tok-o">{</span>
  <span class="tok-k">while</span> <span class="tok-o">(</span><span class="tok-n">cursor</span><span class="tok-o">.</span><span class="tok-na">hasNext</span><span class="tok-o">())</span> <span class="tok-o">{</span>
    <span class="tok-n">DBObject</span> <span class="tok-n">cur</span> <span class="tok-o">=</span> <span class="tok-n">cursor</span><span class="tok-o">.</span><span class="tok-na">next</span><span class="tok-o">();</span>
    <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">cur</span><span class="tok-o">);</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span> <span class="tok-k">finally</span> <span class="tok-o">{</span>
  <span class="tok-n">cursor</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A partir de un <code>QueryBuilder</code>, mediante el método <code>get()</code> obtenemos un <code>DBObject</code></td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
La versión 3.0 ha introducido nuevos filtros para facilitar el filtrado de campos, como <code>eq()</code>, <code>gt()</code>, <code>and()</code>, etc&#8230;&#8203; Más información en <a href="http://api.mongodb.org/java/current/com/mongodb/client/model/Filters.html" class="bare">http://api.mongodb.org/java/current/com/mongodb/client/model/Filters.html</a>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_selección_de_campos">Selección de campos</h5>
<div class="paragraph">
<p>Para elegir que datos queremos proyectar y que aparezcan como resultado de la consulta, el método <code>find</code> permite que indiquemos con un segundo parámetro los campos deseados mediante un <code>BasicDBObject</code> poniendo como nombre los nombres de los atributos y como valores <code>true</code>/<code>false</code> dependiendo de si queremos que se devuelvan o no.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">DBObject</span> <span class="tok-n">query</span> <span class="tok-o">=</span> <span class="tok-n">QueryBuilder</span><span class="tok-o">.</span><span class="tok-na">start</span><span class="tok-o">(</span><span class="tok-s">&quot;x&quot;</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">).</span><span class="tok-na">and</span><span class="tok-o">(</span><span class="tok-s">&quot;y&quot;</span><span class="tok-o">).</span><span class="tok-na">greaterThan</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">lessThan</span><span class="tok-o">(</span><span class="tok-mi">70</span><span class="tok-o">).</span><span class="tok-na">get</span><span class="tok-o">();</span>
<span class="tok-n">DBObject</span> <span class="tok-n">proyeccion</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;y&quot;</span><span class="tok-o">,</span> <span class="tok-kc">true</span><span class="tok-o">).</span><span class="tok-na">append</span><span class="tok-o">(</span><span class="tok-s">&quot;_id&quot;</span><span class="tok-o">,</span> <span class="tok-kc">false</span><span class="tok-o">);</span>  <i class="conum" data-value="1"></i><b>(1)</b>

<span class="tok-n">DBCursor</span> <span class="tok-n">cursor</span> <span class="tok-o">=</span> <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">query</span><span class="tok-o">,</span> <span class="tok-n">proyeccion</span><span class="tok-o">);</span>  <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-k">try</span> <span class="tok-o">{</span>
  <span class="tok-k">while</span> <span class="tok-o">(</span><span class="tok-n">cursor</span><span class="tok-o">.</span><span class="tok-na">hasNext</span><span class="tok-o">())</span> <span class="tok-o">{</span>
    <span class="tok-n">DBObject</span> <span class="tok-n">cur</span> <span class="tok-o">=</span> <span class="tok-n">cursor</span><span class="tok-o">.</span><span class="tok-na">next</span><span class="tok-o">();</span>
    <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">cur</span><span class="tok-o">);</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span> <span class="tok-k">finally</span> <span class="tok-o">{</span>
  <span class="tok-n">cursor</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Proyecta el atributo <code>y</code> y no muestra el <code>_id</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Al método <code>find()</code> le pasamos tanto la consulta como la proyección</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Autoevaluación</div>
<div class="paragraph">
<p>Dada una variable <code>alumnos</code> de tipo <code>DBCollection</code>,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">alumnos</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;tlfno&quot;</span><span class="tok-o">,</span> <span class="tok-mi">1</span><span class="tok-o">).</span><span class="tok-na">append</span><span class="tok-o">(</span><span class="tok-s">&quot;_id&quot;</span><span class="tok-o">,</span> <span class="tok-mi">0</span><span class="tok-o">))</span>
<span class="tok-n">alumnos</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;tlfno&quot;</span><span class="tok-o">,</span> <span class="tok-mi">1</span><span class="tok-o">))</span>
<span class="tok-n">alumnos</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(),</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;tlfno&quot;</span><span class="tok-o">,</span> <span class="tok-mi">1</span><span class="tok-o">).</span><span class="tok-na">append</span><span class="tok-o">(</span><span class="tok-s">&quot;_id&quot;</span><span class="tok-o">,</span> <span class="tok-mi">0</span><span class="tok-o">))</span>
<span class="tok-n">alumnos</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;tlfno&quot;</span><span class="tok-o">,</span> <span class="tok-mi">1</span><span class="tok-o">).</span><span class="tok-na">append</span><span class="tok-o">(</span><span class="tok-s">&quot;_id&quot;</span><span class="tok-o">,</span> <span class="tok-mi">0</span><span class="tok-o">),</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>¿Cual de las anteriores instrucciones nos permitirá obtener todos los documentos pero recuperando únicamente el campo <code>tlfno</code> ? <span class="footnote">[<a id="_footnoteref_7" class="footnote" href="#_footnote_7" title="View footnote.">7</a>]</span></p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_campos_anidados">Campos anidados</h5>
<div class="paragraph">
<p>Cuando tenemos un documento que forma parte del valor del atributo de otro documento, usaremos la notación <code>.</code> para navegar y descender un nivel.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-c1">// insertamos 10 documentos con puntos de inicio y fin aleatorios</span>
<span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-kt">int</span> <span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-o">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-mi">10</span><span class="tok-o">;</span> <span class="tok-n">i</span><span class="tok-o">++)</span> <span class="tok-o">{</span>
  <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">insert</span><span class="tok-o">(</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;_id&quot;</span><span class="tok-o">,</span> <span class="tok-n">i</span><span class="tok-o">)</span>
    <span class="tok-o">.</span><span class="tok-na">append</span><span class="tok-o">(</span><span class="tok-s">&quot;inicio&quot;</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;x&quot;</span><span class="tok-o">,</span> <span class="tok-n">rand</span><span class="tok-o">.</span><span class="tok-na">nextInt</span><span class="tok-o">(</span><span class="tok-mi">90</span><span class="tok-o">)).</span><span class="tok-na">append</span><span class="tok-o">(</span><span class="tok-s">&quot;y&quot;</span><span class="tok-o">,</span> <span class="tok-n">rand</span><span class="tok-o">.</span><span class="tok-na">nextInt</span><span class="tok-o">(</span><span class="tok-mi">90</span><span class="tok-o">)))</span>
    <span class="tok-o">.</span><span class="tok-na">append</span><span class="tok-o">(</span><span class="tok-s">&quot;fin&quot;</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;x&quot;</span><span class="tok-o">,</span> <span class="tok-n">rand</span><span class="tok-o">.</span><span class="tok-na">nextInt</span><span class="tok-o">(</span><span class="tok-mi">90</span><span class="tok-o">)).</span><span class="tok-na">append</span><span class="tok-o">(</span><span class="tok-s">&quot;y&quot;</span><span class="tok-o">,</span> <span class="tok-n">rand</span><span class="tok-o">.</span><span class="tok-na">nextInt</span><span class="tok-o">(</span><span class="tok-mi">90</span><span class="tok-o">)))</span>
  <span class="tok-o">);</span>
<span class="tok-o">}</span>

<span class="tok-n">QueryBuilder</span> <span class="tok-n">builder</span> <span class="tok-o">=</span> <span class="tok-n">QueryBuilder</span><span class="tok-o">.</span><span class="tok-na">start</span><span class="tok-o">(</span><span class="tok-s">&quot;inicio.x&quot;</span><span class="tok-o">).</span><span class="tok-na">greaterThan</span><span class="tok-o">(</span><span class="tok-mi">50</span><span class="tok-o">);</span> <i class="conum" data-value="2"></i><b>(2)</b>

<span class="tok-n">DBCursor</span> <span class="tok-n">cursor</span> <span class="tok-o">=</span> <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">builder</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(),</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;inicio.y&quot;</span><span class="tok-o">,</span> <span class="tok-kc">true</span><span class="tok-o">).</span><span class="tok-na">append</span><span class="tok-o">(</span><span class="tok-s">&quot;_id&quot;</span><span class="tok-o">,</span> <span class="tok-kc">false</span><span class="tok-o">));</span> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Crea 10 documentos del tipo <code>{ "_id" : 0 , "inicio" : { "x" : 28 , "y" : 46} , "fin" : { "x" : 37 , "y" : 51}}</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>La consulta filtra por el campo anidado <code>inicio.x</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>La proyección sólo muestra el campo anidado <code>inicio.y</code></td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Autoevaluación</div>
<div class="paragraph">
<p>Con el siguiente fragmento de código, ¿Qué piensas que sucederá si en la colección existe un documento que cumple con la consulta pero no que no tiene una clave llamada <code>medio.url</code> ? <span class="footnote">[<a id="_footnoteref_8" class="footnote" href="#_footnote_8" title="View footnote.">8</a>]</span></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">DBObject</span> <span class="tok-nf">encuentraUrlPorTipoMedio</span><span class="tok-o">(</span><span class="tok-n">DBCollection</span> <span class="tok-n">videos</span><span class="tok-o">,</span> <span class="tok-n">String</span> <span class="tok-n">tipoMedio</span><span class="tok-o">)</span> <span class="tok-o">{</span>
  <span class="tok-n">DBObject</span> <span class="tok-n">query</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;medio.tipo&quot;</span><span class="tok-o">,</span> <span class="tok-n">mediaType</span><span class="tok-o">);</span>
  <span class="tok-n">DBObject</span> <span class="tok-n">proyeccion</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;medio.url&quot;</span><span class="tok-o">,</span> <span class="tok-kc">true</span><span class="tok-o">);</span>

  <span class="tok-k">return</span> <span class="tok-n">videos</span><span class="tok-o">.</span><span class="tok-na">findOne</span><span class="tok-o">(</span><span class="tok-n">query</span><span class="tok-o">,</span> <span class="tok-n">proyeccion</span><span class="tok-o">);</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Lanzará una excepción</p>
</li>
<li>
<p>Devolverá un documento vacío</p>
</li>
<li>
<p>Devolverá un documento que contiene un único campo que contiene el <code>_id</code> del documento</p>
</li>
<li>
<p>No hay suficiente información para responder</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_trabajando_con_code_dbcursor_code">Trabajando con <code>DBCursor</code></h5>
<div class="paragraph">
<p>Del mismo modo que con el <em>shell</em>, podemos utilizar los métodos <code>sort</code>, <code>skip</code> y <code>limit</code> sobre un <code>DBCursor</code>.</p>
</div>
<div class="paragraph">
<p>Suponiendo que tenemos los mismos datos del ejemplo anterior:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo de métodos sobre un cursor -</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">DBCursor</span> <span class="tok-n">cursor</span> <span class="tok-o">=</span> <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">().</span><span class="tok-na">sort</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;inicio.x&quot;</span><span class="tok-o">,</span> <span class="tok-mi">1</span><span class="tok-o">).</span><span class="tok-na">append</span><span class="tok-o">(</span><span class="tok-s">&quot;inicio.y&quot;</span><span class="tok-o">,</span> <span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-o">)).</span><span class="tok-na">skip</span><span class="tok-o">(</span><span class="tok-mi">2</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">);</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_modificación">2.8.5. Modificación</h4>
<div class="paragraph">
<p>Si queremos modificar un documento, el <em>driver</em> nos ofrece el método <code>update</code> con diferentes sobrecargas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>update(DBObject origen, DBOject destino)</code> &#8594; para cambiar un documento por otro, o aplicar un operador sobre <em>destino</em> y actuar conforme indique el operador</p>
</li>
<li>
<p><code>update(DBObject origen, DBOject destino, boolean upsert, boolean multiple)</code> &#8594; igual que el anterior, más la posibilidad de indicar de si hacemos un <em>upsert</em> o si la actualización es múltiple.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Ejemplo de actualización en Java -</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-o">&gt;</span> <span class="tok-n">nombres</span> <span class="tok-o">=</span> <span class="tok-n">Arrays</span><span class="tok-o">.</span><span class="tok-na">asList</span><span class="tok-o">(</span><span class="tok-s">&quot;Laura&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Pedro&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Ana&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Sergio&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Helena&quot;</span><span class="tok-o">);</span>
<span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span> <span class="tok-o">:</span> <span class="tok-n">nombres</span><span class="tok-o">)</span> <span class="tok-o">{</span>
  <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">insert</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;_id&quot;</span><span class="tok-o">,</span> <span class="tok-n">nombre</span><span class="tok-o">));</span>
<span class="tok-o">}</span>

<span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">update</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;_id&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Laura&quot;</span><span class="tok-o">),</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;hermanos&quot;</span><span class="tok-o">,</span> <span class="tok-mi">2</span><span class="tok-o">));</span> <i class="conum" data-value="1"></i><b>(1)</b>

<span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">update</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;_id&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Laura&quot;</span><span class="tok-o">),</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;$set&quot;</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;edad&quot;</span><span class="tok-o">,</span> <span class="tok-mi">34</span><span class="tok-o">)));</span> <i class="conum" data-value="2"></i><b>(2)</b>

<span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">update</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;_id&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Laura&quot;</span><span class="tok-o">),</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;sexo&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;F&quot;</span><span class="tok-o">));</span> <i class="conum" data-value="3"></i><b>(3)</b>

<span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">update</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;_id&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Emilio&quot;</span><span class="tok-o">),</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;$set&quot;</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;edad&quot;</span><span class="tok-o">,</span> <span class="tok-mi">36</span><span class="tok-o">)),</span> <span class="tok-kc">true</span><span class="tok-o">,</span> <span class="tok-kc">false</span><span class="tok-o">);</span> <i class="conum" data-value="4"></i><b>(4)</b>

<span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">update</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(),</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;$set&quot;</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;titulo&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Don&quot;</span><span class="tok-o">)),</span> <span class="tok-kc">false</span><span class="tok-o">,</span> <span class="tok-kc">true</span><span class="tok-o">);</span> <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Le asigna a <code>Laura</code> 2 hermanos</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Le añade la edad, pero manteniendo el resto de atributos</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Realiza un reemplazo completo con lo que <code>Laura</code> solo tiene el atributo <code>sexo</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Realiza un <em>upsert</em> con lo que inserta una nueva persona</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Realiza una actualización múltiple, con lo que todas las personas tendrán el atributo <code>"titulo":"Don"</code></td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_borrado">2.8.6. Borrado</h4>
<div class="paragraph">
<p>Para borrar un documento usaremos el método <code>remove(DBObject obj)</code> sobre la colección:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">remove</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;_id&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Sergio&quot;</span><span class="tok-o">));</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Podéis consultar un ejemplo completo de CRUD en <a href="http://www.javahotchocolate.com/notes/mongodb-crud.html" class="bare">http://www.javahotchocolate.com/notes/mongodb-crud.html</a>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="__code_mongodb_driver_code">2.8.7. <code>mongodb-driver</code></h4>
<div class="paragraph">
<p>Si nos centramos en la v3 y el driver <em>Java</em> cuyo artefacto es <code>mongodb-driver</code>, tal como hemos comentado, han cambiado una serie de interfaces:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>la base de datos emplea el interfaz <code>MongoDatabase</code>, y la colección <code>MongoCollection</code></p>
</li>
<li>
<p>los documentos se crean mediante el interfaz <code>Document</code>, el cual emplea el método <code>append(clave, valor)</code> para añadir información al documento</p>
</li>
<li>
<p>uso de filtros en consultas del tipo <code>colleccion.find(and(gt("i", 50), lte("i", 100)))</code></p>
</li>
<li>
<p>actualizaciones mediante los operadores de actualización similares a las operaciones desde el <em>shell</em> como <code>colleccion.updateOne(eq("i", 10), set("i", 110))</code> y métodos específicos como <code>updateMany</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A modo de ejemplo, se muestra un fragmento de código similar al anterior:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">MongoClient</span> <span class="tok-n">cliente</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">MongoClient</span><span class="tok-o">();</span>
<span class="tok-n">MongoDatabase</span> <span class="tok-n">database</span> <span class="tok-o">=</span> <span class="tok-n">cliente</span><span class="tok-o">.</span><span class="tok-na">getDatabase</span><span class="tok-o">(</span><span class="tok-s">&quot;expertojava&quot;</span><span class="tok-o">);</span>
<span class="tok-n">MongoCollection</span><span class="tok-o">&lt;</span><span class="tok-n">Document</span><span class="tok-o">&gt;</span> <span class="tok-n">coleccion</span> <span class="tok-o">=</span> <span class="tok-n">database</span><span class="tok-o">.</span><span class="tok-na">getCollection</span><span class="tok-o">(</span><span class="tok-s">&quot;pruebas&quot;</span><span class="tok-o">);</span>
<span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">drop</span><span class="tok-o">();</span>

<span class="tok-c1">// insertamos 10 documentos con un número aleatorio</span>
<span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-kt">int</span> <span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-o">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-mi">10</span><span class="tok-o">;</span> <span class="tok-n">i</span><span class="tok-o">++)</span> <span class="tok-o">{</span>
  <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">insertOne</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">Document</span><span class="tok-o">(</span><span class="tok-s">&quot;numero&quot;</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-nf">Random</span><span class="tok-o">().</span><span class="tok-na">nextInt</span><span class="tok-o">(</span><span class="tok-mi">100</span><span class="tok-o">)));</span>
<span class="tok-o">}</span>

<span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;Primero:&quot;</span><span class="tok-o">);</span>
<span class="tok-n">Document</span> <span class="tok-n">uno</span> <span class="tok-o">=</span> <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">().</span><span class="tok-na">first</span><span class="tok-o">();</span> <span class="tok-c1">// Encuentra uno</span>
<span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">uno</span><span class="tok-o">);</span>

<span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;\nTodos: &quot;</span><span class="tok-o">);</span>
<span class="tok-n">MongoCursor</span><span class="tok-o">&lt;</span><span class="tok-n">Document</span><span class="tok-o">&gt;</span> <span class="tok-n">cursor</span> <span class="tok-o">=</span> <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">().</span><span class="tok-na">iterator</span><span class="tok-o">();;</span> <span class="tok-c1">// Encuentra todos</span>
<span class="tok-k">try</span> <span class="tok-o">{</span>
  <span class="tok-k">while</span> <span class="tok-o">(</span><span class="tok-n">cursor</span><span class="tok-o">.</span><span class="tok-na">hasNext</span><span class="tok-o">())</span> <span class="tok-o">{</span>
    <span class="tok-n">DBObject</span> <span class="tok-n">otro</span> <span class="tok-o">=</span> <span class="tok-n">cursor</span><span class="tok-o">.</span><span class="tok-na">next</span><span class="tok-o">();</span>
    <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">otro</span><span class="tok-o">.</span><span class="tok-na">toJson</span><span class="tok-o">());</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span> <span class="tok-k">finally</span> <span class="tok-o">{</span>
  <span class="tok-n">cursor</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
<span class="tok-o">}</span>

<span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;\nTotal:&quot;</span> <span class="tok-o">+</span> <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">count</span><span class="tok-o">());</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Más información en <a href="http://mongodb.github.io/mongo-java-driver/3.2/driver/getting-started/quick-tour/" class="bare">http://mongodb.github.io/mongo-java-driver/3.2/driver/getting-started/quick-tour/</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_mapping_de_objetos">2.9. Mapping de objetos</h3>
<div class="paragraph">
<p>Hasta ahora, el mapeo de objetos POJO a JSON lo estamos realizando a mano, atributo por atributo. Otras opciones alternativas es automatizar el <em>mapping</em> con herramientas como:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Jackson</strong> (<a href="https://github.com/FasterXML/jackson" class="bare">https://github.com/FasterXML/jackson</a>), y en particular <strong>MongoJack</strong> (<a href="http://mongojack.org" class="bare">http://mongojack.org</a>), que facilitan la conversión de BSON a objetos Java. Una alternativa similar es <strong>Gson</strong>, librería de <em>Google</em> (<a href="https://github.com/google/gson" class="bare">https://github.com/google/gson</a>).</p>
</li>
<li>
<p><strong>Morphia</strong> (<a href="http://mongodb.github.io/morphia/" class="bare">http://mongodb.github.io/morphia/</a>): framework <em>ORM</em> ligero, similar a <em>Hibernate</em>, para automatizar el <em>mapping</em> mediante anotaciones.</p>
</li>
<li>
<p><strong>Spring Data MongoDB</strong>: <em>wrapper</em> que facilita la conexión y simplifica el uso de consultas: (<a href="http://projects.spring.io/spring-data-mongodb/" class="bare">http://projects.spring.io/spring-data-mongodb/</a>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>En esta sesión no vamos a entrar en detalle en estas herramientas por falta de tiempo, pero cabe destacar que ofrecen una serie de ventajas que conviene conocer:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Desarrollo más ágil que con mapeo manual.</p>
</li>
<li>
<p>Anotación unificada entre todas las capas.</p>
</li>
<li>
<p>Manejo de tipos amigables, por ejemplo, para cambios de tipos de <code>long</code> a <code>int</code> de manera transparente.</p>
</li>
<li>
<p>Posibilidad de incluir mapeos diferentes entre la base de datos y las capas del servidor web para transformar los formatos como resultado de una llamada REST.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Otra solución flexible es <strong>Hibernate OGM</strong> (<a href="http://hibernate.org/ogm/" class="bare">http://hibernate.org/ogm/</a>), con soporte para <em>Infinispan</em>, <em>Ehcache</em>, <em>MongoDB</em> y <em>Neo4j</em>. Más información sobre <em>Hibernate OGM</em> y <em>MongoDB</em> en <a href="http://docs.jboss.org/hibernate/ogm/4.1/reference/en-US/html/ogm-mongodb.html" class="bare">http://docs.jboss.org/hibernate/ogm/4.1/reference/en-US/html/ogm-mongodb.html</a></p>
</div>
<div class="paragraph">
<p>Finalmente, si nos decidimos por acceder via el <em>driver</em> directamente y empleamos EJB para ofrecer una capa de servicios, es conveniente encapsular el cliente dentro de un <em>Singleton</em>. Podemos ver un ejemplo completo en <a href="http://www.codingpedia.org/ama/how-to-connect-to-mongodb-from-a-java-ee-stateless-application/" class="bare">http://www.codingpedia.org/ama/how-to-connect-to-mongodb-from-a-java-ee-stateless-application/</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios_2">2.10. Ejercicios</h3>
<div class="paragraph">
<p>En esta sesión, vamos a centrarnos en utilizar los comandos aprendidos para interactuar con los datos de la base de datos <code>ejercicios</code>.</p>
</div>
<div class="paragraph">
<p>Posteriormente, mediante <em>Java</em> también trabajaremos con estos datos.</p>
</div>
<div class="sect3">
<h4 id="__1_punto_ejercicio_21_consultas_desde_code_mongo_code">2.10.1. (1 punto) Ejercicio 21. Consultas desde <code>mongo</code></h4>
<div class="paragraph">
<p>Escribe la operación necesaria y el resultado para averiguar:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Número de ciudades.</p>
</li>
<li>
<p>Datos de la ciudad de <code>Elx</code>.</p>
</li>
<li>
<p>Población de la ciudad de <code>Vergel</code>.</p>
</li>
<li>
<p>Cantidad de ciudades en España <code>({"country":"ES"})</code>.</p>
</li>
<li>
<p>Datos de las ciudades españolas con más de 1.000.000 de habitantes.</p>
</li>
<li>
<p>Cantidad de ciudades de Andorra <code>({"country":"AD"})</code> y España.</p>
</li>
<li>
<p>Listado con el nombre y la población de las 10 ciudades más pobladas.</p>
</li>
<li>
<p>Nombre de las distintas zonas horarias en España.</p>
</li>
<li>
<p>Ciudades españolas que su zona horaria no sea <code>Europe/Madrid</code>.</p>
</li>
<li>
<p>Ciudades españolas que comiencen por <code>Ben</code></p>
</li>
<li>
<p>Ciudades que su zona horaria sea <code>Atlantic/Canary</code> o <code>Africa/Ceuta</code>, y que tengan más de 500.000 habitantes.</p>
</li>
<li>
<p>Nombre y población de las tres ciudades europeas más pobladas.</p>
</li>
<li>
<p>Cantidad de ciudades españolas cuya coordenadas de longitud estén comprendidas entre <code>-0.1</code> y <code>0.1</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Escribe los comandos necesarios y el resultado en <code>ej21.txt</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="__1_punto_ejercicio_22_modificaciones_desde_code_mongo_code">2.10.2. (1 punto) Ejercicio 22. Modificaciones desde <code>mongo</code></h4>
<div class="paragraph">
<p>Escribe la operación necesarias para:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Modifica la población de tu ciudad a 1.000.000</p>
</li>
<li>
<p>Incrementa la población de <code>Elx</code> en 666 personas.</p>
</li>
<li>
<p>Reduce la cantidad de todas las ciudades de Andorra en 5 personas.</p>
</li>
<li>
<p>Modifica la ciudad de <code>Gibraltar</code> para que sea española (tanto el país como la zona horaria).</p>
</li>
<li>
<p>Modifica todas las ciudades y añade un atributo <code>tags</code> que contenga un array vacío.</p>
</li>
<li>
<p>Modifica todas las ciudades españolas y añade al atributo <code>tags</code> el valor <code>sun</code>.</p>
</li>
<li>
<p>Modifica el valor de <code>sun</code> de la ciudad <code>A Coruña</code> y sustitúyelo por <code>rain</code>.</p>
</li>
<li>
<p>Renombra en las ciudades de Andorra, el atributo <code>population</code> por <code>poblacion</code>.</p>
</li>
<li>
<p>Elimina las coordenadas de <code>Gibraltar</code>.</p>
</li>
<li>
<p>Elimina tu entrada</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Escribe los comandos necesarios y el resultado en <code>ej22.txt</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="__1_5_puntos_ejercicio_23_operaciones_desde_em_java_em">2.10.3. (1.5 puntos) Ejercicio 23. Operaciones desde <em>Java</em></h4>
<div class="paragraph">
<p>Los siguientes ejercicios se basan en el uso de <em>Java</em>. Para ello, los ejercicios estarán dentro del paquete <code>es.ua.expertojava.nosql</code>, en una clase nombrada como <code>ConsultasEjercicios</code>.</p>
</div>
<div class="paragraph">
<p>En base a los datos sobre una ciudad almacenados en la colección <code>cities</code> de la base de datos <code>ejercicios</code>, usaremos la siguiente clase <code>Ciudad</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Ciudad</span> <span class="tok-o">{</span>
  <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">name</span><span class="tok-o">;</span>
  <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">country</span><span class="tok-o">;</span>
  <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">timezone</span><span class="tok-o">;</span>
  <span class="tok-kd">private</span> <span class="tok-kt">long</span> <span class="tok-n">population</span><span class="tok-o">;</span>
  <span class="tok-kd">private</span> <span class="tok-kt">float</span> <span class="tok-n">longitude</span><span class="tok-o">;</span>
  <span class="tok-kd">private</span> <span class="tok-kt">float</span> <span class="tok-n">latitude</span><span class="tok-o">;</span>

  <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getName</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-k">return</span> <span class="tok-n">name</span><span class="tok-o">;</span>
  <span class="tok-o">}</span>
  <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setName</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">name</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">name</span> <span class="tok-o">=</span> <span class="tok-n">name</span><span class="tok-o">;</span>
  <span class="tok-o">}</span>

  <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getCountry</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-k">return</span> <span class="tok-n">country</span><span class="tok-o">;</span>
  <span class="tok-o">}</span>
  <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setCountry</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">country</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">country</span> <span class="tok-o">=</span> <span class="tok-n">country</span><span class="tok-o">;</span>
  <span class="tok-o">}</span>

  <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getTimezone</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-k">return</span> <span class="tok-n">timezone</span><span class="tok-o">;</span>
  <span class="tok-o">}</span>
  <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setTimezone</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">timezone</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">timezone</span> <span class="tok-o">=</span> <span class="tok-n">timezone</span><span class="tok-o">;</span>
  <span class="tok-o">}</span>

  <span class="tok-kd">public</span> <span class="tok-kt">long</span> <span class="tok-nf">getPopulation</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-k">return</span> <span class="tok-n">population</span><span class="tok-o">;</span>
  <span class="tok-o">}</span>

  <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setPopulation</span><span class="tok-o">(</span><span class="tok-kt">long</span> <span class="tok-n">population</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">population</span> <span class="tok-o">=</span> <span class="tok-n">population</span><span class="tok-o">;</span>
  <span class="tok-o">}</span>

  <span class="tok-kd">public</span> <span class="tok-kt">float</span> <span class="tok-nf">getLongitude</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-k">return</span> <span class="tok-n">longitude</span><span class="tok-o">;</span>
  <span class="tok-o">}</span>
  <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setLongitude</span><span class="tok-o">(</span><span class="tok-kt">float</span> <span class="tok-n">longitude</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">longitude</span> <span class="tok-o">=</span> <span class="tok-n">longitude</span><span class="tok-o">;</span>
  <span class="tok-o">}</span>

  <span class="tok-kd">public</span> <span class="tok-kt">float</span> <span class="tok-nf">getLatitude</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-k">return</span> <span class="tok-n">latitude</span><span class="tok-o">;</span>
  <span class="tok-o">}</span>
  <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setLatitude</span><span class="tok-o">(</span><span class="tok-kt">float</span> <span class="tok-n">latitude</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">latitude</span> <span class="tok-o">=</span> <span class="tok-n">latitude</span><span class="tok-o">;</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para poder interactuar con este objeto, deberás crear dos métodos privados que se encarguen del <em>mapping</em> entre BSON y el objeto Java:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Ciudad mapDBObject2Ciudad(DBObject dbo)</code></p>
<div class="ulist">
<ul>
<li>
<p>Al asociar la población desde un <code>DBObject</code> a una propiedad <em>Java</em> de tipo <code>long</code>, <em>MongoDB</em> en ocasiones devuelve un entero y en otras un entero largo. Para evitar problemas de <em>casting</em> podemos hacer:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">ciudad</span><span class="tok-o">.</span><span class="tok-na">setPopulation</span><span class="tok-o">(((</span><span class="tok-n">Number</span><span class="tok-o">)</span> <span class="tok-n">dbo</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-s">&quot;population&quot;</span><span class="tok-o">)).</span><span class="tok-na">longValue</span><span class="tok-o">());</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><code>DBObject mapCiudad2DBOject(Ciudad ciudad)</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Una vez creado estos métodos, añadiremos los siguientes  métodos para interactuar con los datos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>void insertaCiudad(Ciudad ciudad)</code>: A partir de una <em>ciudad</em>, inserta los datos en la colecciones <code>cities</code>.</p>
</li>
<li>
<p><code>List&lt;Ciudad&gt; listarCiudades()</code>: Obtiene todas las ciudades de la colección.</p>
</li>
<li>
<p><code>List&lt;Ciudad&gt; listarCiudades(String pais)</code>: Obtiene todos las ciudades de un determinado país.</p>
</li>
<li>
<p><code>List&lt;String&gt; listarPaises()</code>: Obtiene un listado de los paises (sin repeticiones).</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion03">3. Rendimiento en <em>MongoDB</em></h2>
<div class="sectionbody">
<div class="paragraph">
<p>En esta unidad vamos a estudiar como diseñar el esquema, así como el uso de índices y otras herramientas avanzadas para mejorar el rendimiento.</p>
</div>
<div class="sect2">
<h3 id="_diseñando_el_esquema">3.1. Diseñando el esquema</h3>
<div class="paragraph">
<p><em>MongoDB</em> es una base de datos documental, no relacional, donde el esquema no se debe basar en el uso de claves ajenas/<em>joins</em>, ya que no existen.</p>
</div>
<div class="paragraph">
<p>A la hora de diseñar un esquema, si nos encontramos que el esquema esta en 3FN o si cuando hacemos consultas (recordad que no hay <em>joins</em>) estamos teniendo que realizar varias consultas de manera programativa (primero acceder a una tabla, con ese <code>_id</code> ir a otra tabla, etc&#8230;&#8203;.) es que no estamos siguiendo el enfoque adecuado.</p>
</div>
<div class="paragraph">
<p><em>MongoDB</em> no soporta transacciones, ya que su enfoque distribuido dificultaría y penalizaría el rendimiento. En cambio, sí que asegura que las operaciones sean atómicas. Los posibles enfoques para solucionar la falta de transacciones son:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Restructurar el código para que toda la información esté contenida en un único documento.</p>
</li>
<li>
<p>Implementar un sistema de bloqueo por software (semáforo, etc&#8230;&#8203;).</p>
</li>
<li>
<p>Tolerar un grado de inconsistencia en el sistema.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Dependiendo del tipo de relación entre dos documentos, normalizaremos los datos para minimizar la redundancia pero manteniendo en la medida de lo posible que mediante operaciones atómicas se mantenga la integridad de los datos. Para ello, bien crearemos referencias entre dos documentos o embeberemos un documento dentro de otro.</p>
</div>
<div class="sect3">
<h4 id="_referencias">3.1.1. Referencias</h4>
<div class="paragraph">
<p>Las aplicaciones que emplean <em>MongoDB</em> utilizan dos técnicas para relacionar documentos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Referencias <strong>Manuales</strong></p>
</li>
<li>
<p>Uso de <strong>DBRef</strong></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_referencias_manuales">Referencias manuales</h5>
<div class="paragraph">
<p>De manera similar a una base de datos relacional, se almacena el campo <code>_id</code> de un documento en otro documento a modo de clave ajena. De este modo, la aplicación realiza una segunda consulta para obtener los datos relaciones. Estas referencias son sencillas y suficientes para la mayoría de casos de uso.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql03/data-model-normalized.png" alt="Referencias manuales" width="66%">
</div>
<div class="title">Figure 19. Referencias manuales</div>
</div>
<div class="paragraph">
<p>Por ejemplo, si nos basamos en el gráfico anterior, podemos conseguir referenciar estos objetos del siguiente modo:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo de referencia manual - Usuario/Contacto</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">idUsuario</span> <span class="tok-o">=</span> <span class="tok-nx">ObjectId</span><span class="tok-p">();</span>

<span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">usuario</span><span class="tok-p">.</span><span class="tok-nx">insert</span><span class="tok-p">({</span>
  <span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-nx">idUsuario</span><span class="tok-p">,</span>
  <span class="tok-nx">nombre</span><span class="tok-o">:</span> <span class="tok-s2">&quot;123xyz&quot;</span>
<span class="tok-p">});</span>

<span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">contacto</span><span class="tok-p">.</span><span class="tok-nx">insert</span><span class="tok-p">({</span>
  <span class="tok-nx">usuario_id</span><span class="tok-o">:</span> <span class="tok-nx">idUsuario</span><span class="tok-p">,</span>
  <span class="tok-nx">telefono</span><span class="tok-o">:</span>  <span class="tok-s2">&quot;123 456 7890&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">email</span><span class="tok-o">:</span> <span class="tok-s2">&quot;xyz@ejemplo.com&quot;</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_dbref">DBRef</h5>
<div class="paragraph">
<p>Son referencias de un documento a otro mediante el valor del campo <code>_id</code>, el nombre de la colección y, opcionalmente, el nombre de la base de datos. Estos objetos siguen una convención para representar un documento mediante la notación <code>{ "$ref" : &lt;nombreColeccion&gt;, "$id" : &lt;valorCampo_id&gt;, "$db" : &lt;nombreBaseDatos&gt; }</code>.</p>
</div>
<div class="paragraph">
<p>Al incluir estos nombres, las <em>DBRef</em> permite referenciar documentos localizados en diferentes colecciones.</p>
</div>
<div class="paragraph">
<p>Así pues, si reescribimos el código anterior mediante <em>DBRef</em> tendríamos que el contacto queda de la siguiente manera:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo de DBRef - Usuario/Contacto</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">contacto</span><span class="tok-p">.</span><span class="tok-nx">insert</span><span class="tok-p">({</span>
  <span class="tok-nx">usuario_id</span><span class="tok-o">:</span> <span class="tok-k">new</span> <span class="tok-nx">DBRef</span><span class="tok-p">(</span><span class="tok-s2">&quot;usuario&quot;</span><span class="tok-p">,</span> <span class="tok-nx">idUsuario</span><span class="tok-p">),</span>
  <span class="tok-nx">telefono</span><span class="tok-o">:</span>  <span class="tok-s2">&quot;123-456-7890&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">email</span><span class="tok-o">:</span> <span class="tok-s2">&quot;xyz@example.com&quot;</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>De manera similar a las referencias manuales, mediante consultas adicionales se obtendrán los documentos referenciados.</p>
</div>
<div class="paragraph">
<p>Muchos <em>drivers</em> (incluido el de <em>Java</em>, mediante la clase <code>DBRef</code>) contienen métodos auxiliares que realizan las consultas con referencias <em>DBRef</em> automáticamennte.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Desde la propia documentación de <em>MongoDB</em>, recomiendan el uso de referencias manuales, a no ser de que dispongamos documentos de una colección que referencian a documentos que se encuentran en varias colecciones diferentes.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_datos_embebidos">3.1.2. Datos embebidos</h4>
<div class="paragraph">
<p>En cambio, si dentro de un documento almacenamos los datos mediante sub-documentos, ya sea dentro de un atributo o un array, podremos obtener todos los datos mediante un único acceso.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql03/data-model-denormalized.png" alt="Datos Embebidos" width="50%">
</div>
<div class="title">Figure 20. Datos Embebidos</div>
</div>
<div class="paragraph">
<p>Generalmente, emplearemos datos embebidos cuando tengamos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>relaciones <em>"contiene"</em> entre entidades, entre relaciones de documentos "uno a uno" o "uno a pocos".</p>
</li>
<li>
<p>relaciones "uno a muchos" entre entidades. En estas relaciones los documentos hijo (o "muchos") siempre aparecen dentro del contexto del padre o del documento "uno".</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Los datos embebidos ofrecen mejor rendimiento al permitir obtener los datos mediante una única operación, así como modificar datos relacionados en una sola operación atómica de escritura.</p>
</div>
<div class="paragraph">
<p>Un aspecto a tener en cuenta es que un documento <em>BSON</em> puede contener un máximo de 16MB. Si quisiéramos que un atributo contenga más información, tendríamos que utilizar el API de <em>GridFS</em> que veremos más adelante.</p>
</div>
</div>
<div class="sect3">
<h4 id="_relaciones">3.1.3. Relaciones</h4>
<div class="paragraph">
<p>Vamos a estudiar en detalle cada uno de los tipos de relaciones, para intentar clarificar cuando es conveniente utilizar referencias o datos embebidos.</p>
</div>
<div class="sect4">
<h5 id="_1_1">1:1</h5>
<div class="paragraph">
<p>Cuando existe una relación 1:1, como pueda ser entre <code>Persona</code> y <code>Curriculum</code>, o <code>Persona</code> y <code>Direccion</code> hay que embeber un documento dentro del otro, como parte de un atributo.</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo relación 1:1 - Persona/Dirección</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span>
  <span class="tok-nx">nombre</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Aitor&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">edad</span><span class="tok-o">:</span> <span class="tok-mi">38</span><span class="tok-p">,</span>
  <span class="tok-nx">direccion</span><span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-nx">calle</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Mayor&quot;</span><span class="tok-p">,</span>
    <span class="tok-nx">ciudad</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Elx&quot;</span>
  <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La principal ventaja de este planteamiento es que mediante una única consulta podemos obtener tanto los detalles del usuario como su dirección.</p>
</div>
<div class="paragraph">
<p>Un par de aspectos que nos pueden llevar a no embeberlos son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>la frecuencia de acceso. Si a uno de ellos se accede raramente, puede que convenga tenerlos separados para liberar memoria.</p>
</li>
<li>
<p>el tamaño de los elementos. Si hay uno que es mucho más grande que el otro, o uno lo modificamos muchas más veces que el otro, para que cada vez que hagamos un cambio en un documento no tengamos que modificar el otro será mejor separarlos en documentos separados.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Pero siempre teniendo en cuenta la atomicidad de los datos, ya que si necesitamos modificar los dos documentos al mismo tiempo, tendremos que embeber uno dentro del otro.</p>
</div>
</div>
<div class="sect4">
<h5 id="_1_n">1:N</h5>
<div class="paragraph">
<p>Vamos a distinguir dos tipos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>1 a muchos</strong>, como puede ser entre <code>Editorial</code> y <code>Libro</code>. Para este tipo de relación es mejor usar referencias entre los documentos:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Ejemplo relación 1:N - Editorial</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span>
  <span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
  <span class="tok-nx">nombre</span><span class="tok-o">:</span> <span class="tok-s2">&quot;O&#39;Reilly&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">pais</span><span class="tok-o">:</span> <span class="tok-s2">&quot;EE.UU.&quot;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Ejemplo relación 1:N - Libro</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span>
  <span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-mi">1234</span><span class="tok-p">,</span>
  <span class="tok-nx">titulo</span><span class="tok-o">:</span> <span class="tok-s2">&quot;MongoDB: The Definitive Guide&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">autor</span><span class="tok-o">:</span> <span class="tok-p">[</span> <span class="tok-s2">&quot;Kristina Chodorow&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;Mike Dirolf&quot;</span> <span class="tok-p">],</span>
  <span class="tok-nx">numPaginas</span><span class="tok-o">:</span> <span class="tok-mi">216</span><span class="tok-p">,</span>
  <span class="tok-nx">editorial_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
<span class="tok-p">}</span>
<span class="tok-p">{</span>
  <span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-mi">1235</span><span class="tok-p">,</span>
  <span class="tok-nx">titulo</span><span class="tok-o">:</span> <span class="tok-s2">&quot;50 Tips and Tricks for MongoDB Developer&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">autor</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Kristina Chodorow&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">numPaginas</span><span class="tok-o">:</span> <span class="tok-mi">68</span><span class="tok-p">,</span>
  <span class="tok-nx">editorial_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>1 a pocos</strong>, como por ejemplo, dentro de un blog, la relación entre <code>Mensaje</code> y <code>Comentario</code>. En este caso, la mejor solución es crear un array dentro de la entidad 1 ( en nuestro caso, <code>Mensaje</code>). De este modo, el <code>Mensaje</code> contiene un array de <code>Comentario</code>:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Ejemplo relación 1:N - Mensaje/Comentario</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span>
  <span class="tok-nx">titulo</span><span class="tok-o">:</span> <span class="tok-s2">&quot;La broma asesina&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">url</span><span class="tok-o">:</span> <span class="tok-s2">&quot;http://es.wikipedia.org/wiki/Batman:_The_Killing_Joke&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">texto</span><span class="tok-o">:</span> <span class="tok-s2">&quot;La dualidad de Batman y Joker&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">comentarios</span><span class="tok-o">:</span> <span class="tok-p">[</span>
    <span class="tok-p">{</span>
      <span class="tok-nx">autor</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Bruce Wayne&quot;</span><span class="tok-p">,</span>
      <span class="tok-nx">fecha</span><span class="tok-o">:</span> <span class="tok-nx">ISODate</span><span class="tok-p">(</span><span class="tok-s2">&quot;2015-04-01T09:31:32Z&quot;</span><span class="tok-p">),</span>
      <span class="tok-nx">comentario</span><span class="tok-o">:</span> <span class="tok-s2">&quot;A mi me encantó&quot;</span>
    <span class="tok-p">},</span>
    <span class="tok-p">{</span>
      <span class="tok-nx">autor</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Bruno Díaz&quot;</span><span class="tok-p">,</span>
      <span class="tok-nx">fecha</span><span class="tok-o">:</span> <span class="tok-nx">ISODate</span><span class="tok-p">(</span><span class="tok-s2">&quot;2015-04-03T10:07:28Z&quot;</span><span class="tok-p">),</span>
      <span class="tok-nx">comentario</span><span class="tok-o">:</span> <span class="tok-s2">&quot;El mejor&quot;</span>
    <span class="tok-p">}</span>
  <span class="tok-p">]</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Hay que tener siempre en mente la restricción de los 16 MB de BSON. Si vamos a embeber muchos documentos y estos son grandes, hay que vigilar no llegar a dicho tamaño.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En ocasiones las relaciones 1 a muchos se traducen en documentos embebidos cuando la información que nos interesa es la que contiene en un momento determinado. Por ejemplo, dentro de <code>Pedido</code>, el precio de los productos debe embeberse, ya que si en un futuro se modifica el precio de un producto determinado debido a una oferta, el pedido realizado no debe modificar su precio total.</p>
</div>
<div class="paragraph">
<p>Del mismo modo, al almacenar la dirección de una persona, también es conveniente embeberla. No queremos que la dirección de envío de un pedido se modique si un usuario modifica sus datos personales.</p>
</div>
</div>
<div class="sect4">
<h5 id="_n_m">N:M</h5>
<div class="paragraph">
<p>Más que relaciones muchos a muchos, suelen ser relaciones pocos a pocos, como por ejemplo, <code>Libro</code> y <code>Autor</code>, o <code>Profesor</code> y <code>Estudiante</code>.</p>
</div>
<div class="paragraph">
<p>Supongamos que tenemos libros de la siguiente manera y autores con la siguiente estructura:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo relación N:N - Libro</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span>
  <span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
  <span class="tok-nx">titulo</span><span class="tok-o">:</span> <span class="tok-s2">&quot;La historia interminable&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">anyo</span><span class="tok-o">:</span> <span class="tok-mi">1979</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Ejemplo relación N:M - Autor</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span>
  <span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
  <span class="tok-nx">nombre</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Michael Ende&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">pais</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Alemania&quot;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos resolver estas relaciones de tres maneras:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Siguiendo un enfoque relacional, empleando un documento como la entidad que agrupa con referencias manuales a los dos documentos.</p>
<div class="listingblock">
<div class="title">Ejemplo relación N:M - Autor/Libro</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span>
  <span class="tok-nx">autor_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
  <span class="tok-nx">libro_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Este enfoque se desaconseja porque necesita tres consultas para obtener toda la información.</p>
</div>
</li>
<li>
<p>Mediante 2 documentos, cada uno con un array que contenga los ids del otro documento (<em>2 Way Embedding</em>). Hay que tener cuidado porque podemos tener problemas de inconsistencia de datos si no actualizamos correctamente.</p>
<div class="listingblock">
<div class="title">Ejemplo relación N:N - Libro referencia a Autor</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span>
  <span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
  <span class="tok-nx">titulo</span><span class="tok-o">:</span> <span class="tok-s2">&quot;La historia interminable&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">anyo</span><span class="tok-o">:</span> <span class="tok-mi">1979</span><span class="tok-p">,</span>
  <span class="tok-nx">autores</span><span class="tok-o">:</span> <span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span>
<span class="tok-p">},{</span>
  <span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
  <span class="tok-nx">titulo</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Momo&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">anyo</span><span class="tok-o">:</span> <span class="tok-mi">1973</span><span class="tok-p">,</span>
  <span class="tok-nx">autores</span><span class="tok-o">:</span> <span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Ejemplo relación N:M - Autor referencia a Libro</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span>
  <span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
  <span class="tok-nx">nombre</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Michael Ende&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">pais</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Alemania&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">libros</span><span class="tok-o">:</span> <span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">,</span><span class="tok-mi">2</span><span class="tok-p">]</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</li>
<li>
<p>Embeber un documento dentro de otro (<em>One Way Embedding</em>). Por ejemplo:</p>
<div class="listingblock">
<div class="title">Ejemplo relación N:M - Autor embebido en Libro</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span>
  <span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
  <span class="tok-nx">titulo</span><span class="tok-o">:</span> <span class="tok-s2">&quot;La historia interminable&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">anyo</span><span class="tok-o">:</span> <span class="tok-mi">1979</span><span class="tok-p">,</span>
  <span class="tok-nx">autores</span><span class="tok-o">:</span> <span class="tok-p">[{</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s2">&quot;Michael Ende&quot;</span><span class="tok-p">,</span> <span class="tok-nx">pais</span><span class="tok-o">:</span><span class="tok-s2">&quot;Alemania&quot;</span><span class="tok-p">}]</span>
<span class="tok-p">},{</span>
  <span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
  <span class="tok-nx">titulo</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Momo&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">anyo</span><span class="tok-o">:</span> <span class="tok-mi">1973</span><span class="tok-p">,</span>
  <span class="tok-nx">autores</span><span class="tok-o">:</span> <span class="tok-p">[{</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s2">&quot;Michael Ende&quot;</span><span class="tok-p">,</span> <span class="tok-nx">pais</span><span class="tok-o">:</span><span class="tok-s2">&quot;Alemania&quot;</span><span class="tok-p">}]</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En principio este enfoque no se recomienda porque el documento puede crecer mucho y provocar anomalías de modificaciones donde la información no es consistente. Si se opta por esta solución, hay que tener en cuenta que si un documento depende de otro para su creación (por ejemplo, si metemos los profesores dentro de los estudiantes, no vamos a poder dar de alta a profesores sin haber dado de alta previamente a un alumno).</p>
</div>
<div class="paragraph">
<p>A modo de resumen, en las relaciones N:M, hay que establecer el tamaño de N y M. Si N como máximo vale 3 y M 500000, entonces deberíamos seguir un enfoque de embeber la N dentro de la M (<em>One Way Embedding</em>).</p>
</div>
<div class="paragraph">
<p>En cambio, si N vale 3 y M vale 5, entonces podemos hacer que ambos embeban al otro documento (<em>Two Way Embedding</em>).</p>
</div>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Más información en <a href="http://docs.mongodb.org/manual/applications/data-models-relationships/" class="bare">http://docs.mongodb.org/manual/applications/data-models-relationships/</a>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_jerárquicas">Jerárquicas</h5>
<div class="paragraph">
<p>Si tenemos que modelar alguna entidad que tenga hijos y nos importa las relaciones padre-hijos (categoría-subcategoría), podemos tanto embeber un array con los hijos de un documento (<em>children</em>), como embeber un array con los padres de un documento (<em>ancestors</em>)</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Más información en <a href="http://docs.mongodb.org/manual/applications/data-models-tree-structures/" class="bare">http://docs.mongodb.org/manual/applications/data-models-tree-structures/</a>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_rendimiento">3.1.4. Rendimiento</h4>
<div class="paragraph">
<p>De modo general, si vamos a realizar más lecturas que escrituras, es más conveniente denormalizar los datos para usar datos embebidos y así con sólo una lectura obtengamos más información. En cambio, si realizamos muchas inserciones y sobretodo actualizaciones, será conveniente usar referencias con dos documentos.</p>
</div>
<div class="paragraph">
<p>El mayor beneficio de embeber documentos es el rendimiento, sobretodo el de lectura. El acceso a disco es la parte más lenta, pero una vez la aguja se ha colocado en el sector adecuado, la información se obtiene muy rápidamente (alto ancho de banda). El hecho de que toda la información a recuperar esté almacenada de manera secuencial, mediante documentos embebidos, favorece que el rendimiento de lectura sea muy alto, ya que sólo se hace un acceso a la BBDD. Por lo tanto, si la consistencia es secundaria, duplicar los datos (pero de manera limitada) no es una mala idea, ya que el espacio en disco es más barato que el tiempo de computación.</p>
</div>
<div class="paragraph">
<p>Es por ello, que un planteamiento inicial a la hora de modelar los datos es basarse en unidades de aplicación, entendiendo como unidad una petición al <em>backend</em>, ya sea el <em>click</em> de un botón o la carga de los datos para un gráfico. Así pues, cada unidad de aplicación se debería poder conseguir con una única consulta, y por tanto, en gran medida los datos estarán embebidos.</p>
</div>
<div class="paragraph">
<p>Si lo que necesitamos es consistencia de datos, entonces hay que normalizar y usar referencias. Esto conllevará que al modificar un documento, al estar normalizado los datos serán consistentes, aunque necesitemos dos o más lecturas para obtener la información deseada.</p>
</div>
<div class="paragraph">
<p>Hay que tener en cuenta que no debemos hacer <em>joins</em> en las lecturas. En todo caso, si tenemos redundancia, las realizaremos en las escrituras.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Estos y más consejos en <em>6 Rules of Thumb for MongoDB Schema Design</em>: <a href="http://blog.mongodb.org/post/87200945828/6-rules-of-thumb-for-mongodb-schema-design-part-1" class="bare">http://blog.mongodb.org/post/87200945828/6-rules-of-thumb-for-mongodb-schema-design-part-1</a>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_transacciones_y_concurrencia">3.2. Transacciones y concurrencia</h3>
<div class="paragraph">
<p>Ya hemos visto que <em>MongoDB</em> no soporta el concepto de transacción. Mientras que en un SGDB relacional podemos agrupar varias operaciones en una transacción para obtener atomicidad y <em>rollback</em>, en <em>MongoDB</em> solo podemos utilizar las diferentes operaciones de modificación que trabajan con la estructura interna de un documento.
Así pues, la manera de resolver que no haya soporte para transacciones es incrementar la complejidad de un documento para que contenga varios documentos anidados.</p>
</div>
<div class="paragraph">
<p>En el caso de necesitar las transacciones de manera explícita, tal como una aplicación bancaria, no hay nada mejor que una base de datos relacional. Dependiendo del escenario, se pueden combinar ambos enfoques (relacional y <em>MongoDB</em>), mediante una infraestructura más compleja, tanto de desarrollar como de mantener. Estas soluciones híbridas se están haciendo más comunes, y dan pie al concepto de <em>persistencia políglota</em>.</p>
</div>
<div class="paragraph">
<p>Respecto a la <strong>concurrencia</strong>, en los SGBD relacionales, la gestión que se realiza de la ejecución concurrente de una unidad de trabajo se implementa mediante bloqueos o control de multiversiones para aislar cada unidad de trabajo. En cambio, <em>MongoDB</em> emplea bloqueos de lectura/escritura que permiten acceso concurrente para las lecturas de un recurso (ya sea una base de datos o una colección), pero sólo da acceso exclusivo para cada operación de escritura.</p>
</div>
<div class="paragraph">
<p>De una manera más detallada, <em>MongoDB</em> gestiona los bloqueos de lectura y escritura del siguiente modo:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Puede haber un número ilimitado de lecturas simultáneas a un base de datos.</p>
</li>
<li>
<p>En un momento dado, sólo puede haber un escritor en cualquier colección en cualquier base de datos.</p>
</li>
<li>
<p>Una vez recibida una petición de escritura, el escritor bloquea a todos los lectores.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Desde la versión 2.2, se puede restringir el alcance del bloqueo a la base de datos sobre la que se realiza la lectura o la escritura. Desde la versión 3.0, se ha mejorado la gestión de la concurrencia, y sólo se bloquean los documentos implicados en la operación de escritura.</p>
</div>
<div class="paragraph">
<p>Para almacenar información sobre los bloqueos, <em>MongoDB</em> se basa en el motor de almacenamiento, el cual define como se almancenan los datos en el disco. A día de hoy, <em>MongoDB</em> ofrece dos motores:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>MMAPv1</strong>: Almacenamiento por defecto. Emplea bloqueos a nivel de colección.</p>
</li>
<li>
<p><strong>WiredTiger</strong>: Nuevo motor de almacenamiento, que ofrece bloqueo a nivel de documento y permite compresión de los datos. Mediante este motor, múltiples clientes pueden modificar más de un documento de una misma colección al mismo tiempo.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Para indicar el motor de almacenamiento empleado, al arrancar el demonio de <em>MongoDB</em>, mediante el parámetro <code>--storageEngine</code> podemos indicar si queremos <code>mmapv1</code> o <code>wiredTiger</code>:</p>
</div>
<div class="listingblock">
<div class="title">Arrancando con el nuevo motor <code>wiredTiger</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">mongod --storageEngine wiredTiger</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_gridfs">3.3. GridFS</h3>
<div class="paragraph">
<p>Tal como comentamos anteriormente, los documentos BSON tienen la restricción de que no pueden ocupar más de 16 MB. Si necesitamos almacenar <em>Blobs</em>, hemos de utilizar GridFS, el cual es una utilidad que divide un <em>Blob</em> en partes para crear una colección y poder almacenar más información.</p>
</div>
<div class="paragraph">
<p>Así pues, en vez de almacenar un fichero en un único documento, <em>GridFS</em> divide el fichero en partes, o trozos (<em>chunks</em>), y almacena cada uno de estos trozos en un documento separado. Por defecto, <em>GridFS</em> limita el tamaño de cada trozo a 256KB.</p>
</div>
<div class="paragraph">
<p>Para ello, utiliza dos colecciones para almacenar los archivos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>La colección <code>chunks</code> almacena los trozos de los ficheros</p>
</li>
<li>
<p>Mientra que la colección <code>files</code> almacena los metadatos de los ficheros.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql03/gridfs.jpg" alt="GridFS" width="33%">
</div>
<div class="title">Figure 21. GridFS</div>
</div>
<div class="paragraph">
<p>Estas colecciones se crean en el espacio de nombres <code>fs</code>. Este nombre se puede modificar, por ejemplo, si queremos almacenar diferentes tipos de archivos, es decir, por una lado imágenes y por otro vídeos.</p>
</div>
<div class="paragraph">
<p>Cuando se consulta un almacén <em>GridFS</em> por un fichero, el driver o el cliente unirá los trozos tal como necesite. Se pueden hacer consultas sobre ficheros almacenados con <em>GridFS</em>. También se puede acceder a información de secciones arbitrarias de los ficheros, lo que nos permite saltar a la mitad de un archivo de sonido o video.</p>
</div>
<div class="sect3">
<h4 id="__code_mongofiles_code">3.3.1. <code>mongofiles</code></h4>
<div class="paragraph">
<p>Para interactuar con los archivos almacenados desde la consola utilizaremos el comando <code>mongofiles</code>.</p>
</div>
<div class="paragraph">
<p>Si queremos visualizar todos los ficheros que tenemos en nuestra base de datos usaremos la opción <code>list</code>:</p>
</div>
<div class="listingblock">
<div class="title">Listando los archivos GridFS mediante <code>mongofiles</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span class="tok-nv">$ </span>mongofiles list</code></pre>
</div>
</div>
<div class="paragraph">
<p>Al estar vacía la base de datos no se mostrará nada. Aunque en el día a día no utilizaremos <code>mongofiles</code> para interactuar con los archivos, si que es muy útil para explorar y probar los archivos almacenados.</p>
</div>
<div class="paragraph">
<p>Una vez que creamos un archivo, podemos usar la herramienta para explorar los archivos y trozos creados.</p>
</div>
<div class="paragraph">
<p>Para incluir un archivo, se realiza mediante la opción de <code>put</code>:</p>
</div>
<div class="paragraph">
<p>Por ejemplo, para añadir el archivo <code>video.mp4</code> haríamos:</p>
</div>
<div class="listingblock">
<div class="title">Insertando un archivo en GridFS mediante <code>mongofiles</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span class="tok-nv">$ </span>mongofiles put video.mp4
connected to: 127.0.0.1
added file: <span class="tok-o">{</span> _id: ObjectId<span class="tok-o">(</span><span class="tok-s1">&#39;550957b83f627a4bb7f28bc8&#39;</span><span class="tok-o">)</span>, filename: <span class="tok-s2">&quot;video.mp4&quot;</span>, chunkSize: 261120, uploadDate: new Date<span class="tok-o">(</span>1426675642227<span class="tok-o">)</span>, md5: <span class="tok-s2">&quot;b7d51c0c83ef61ccf69f223eded44797&quot;</span>, length: <span class="tok-m">39380552</span> <span class="tok-o">}</span>
<span class="tok-k">done</span>!</code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos observar que tras la inserción, obtenemos un documento que contiente:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>chunkSize</code>: el tamaño de cada trozo</p>
</li>
<li>
<p><code>length</code>: tamaño del fichero</p>
</li>
<li>
<p><code>uploadDate</code>: fecha de creación del fichero en <em>MongoDB</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Si ahora comprobamos los archivos disponibles tendremos:</p>
</div>
<div class="listingblock">
<div class="title">Listando los archivos GridFS mediante <code>mongofiles</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span class="tok-nv">$ </span>mongofiles list
connected to: 127.0.0.1
video.mp4	39380552</code></pre>
</div>
</div>
<div class="paragraph">
<p>Estas operaciones de consulta también la podemos realizar directamente realizando una consulta a la colección <code>fs.files</code> mediante el comando <code>db.fs.files.find()</code> desde <code>mongo</code>:</p>
</div>
<div class="listingblock">
<div class="title">Resultado de la colección <code>fs.files</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">fs</span><span class="tok-p">.</span><span class="tok-nx">files</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">()</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;550957b83f627a4bb7f28bc8&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;filename&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;video.mp4&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;chunkSize&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">261120</span><span class="tok-p">,</span> <span class="tok-s2">&quot;uploadDate&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ISODate</span><span class="tok-p">(</span><span class="tok-s2">&quot;2015-03-18T10:47:22.227Z&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;md5&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;b7d51c0c83ef61ccf69f223eded44797&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;length&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">39380552</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si queremos obtener información sobre los trozos de un archivo (<em>chunks</em>), consultaremos la colección <code>fs.chunks</code> añadiendo un filtro para que no nos muestre la información en binario:</p>
</div>
<div class="listingblock">
<div class="title">Resultado de la colección <code>fs.chunks</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">fs</span><span class="tok-p">.</span><span class="tok-nx">chunks</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({},</span> <span class="tok-p">{</span><span class="tok-s2">&quot;data&quot;</span><span class="tok-o">:</span><span class="tok-mi">0</span><span class="tok-p">})</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;550957b856eb8d804bc96fb8&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;files_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;550957b83f627a4bb7f28bc8&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;n&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">0</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;550957b956eb8d804bc96fb9&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;files_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;550957b83f627a4bb7f28bc8&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;n&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span> <span class="tok-p">}</span>
<span class="tok-p">...</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;550957ba56eb8d804bc9704e&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;files_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;550957b83f627a4bb7f28bc8&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;n&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">150</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Toda interacción con <em>GridFS</em> se debe realizar a través de un <em>driver</em> para evitar incongruencias en los datos.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Otras operaciones que podemos realizar con <code>mongofiles</code> son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>search</code>: busca una cadena en el archivo</p>
</li>
<li>
<p><code>delete</code>: elimina un archivo de <em>GridFS</em></p>
</li>
<li>
<p><code>get</code>: obtiene un archivo</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Todas las opciones de <code>mongofiles</code> se pueden consultar en <a href="http://docs.mongodb.org/manual/reference/program/mongofiles/" class="bare">http://docs.mongodb.org/manual/reference/program/mongofiles/</a></p>
</div>
</div>
<div class="sect3">
<h4 id="__em_gridfs_em_desde_em_java_em">3.3.2. <em>GridFS</em> desde <em>Java</em></h4>
<div class="paragraph">
<p>El driver <em>Java</em> de <em>MongoDB</em> ofrece la clase <code>GridFS</code> para interactuar con los archivos. A partir de dicha clase vamos a poder almacenar archivos en <em>MongoDB</em>.</p>
</div>
<div class="paragraph">
<p>A continuación, se muestra mediante código <em>Java</em> como leer un archivo de vídeo y almacenarlo en la base de datos:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo de inserción en <em>GridFS</em></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">MongoClient</span> <span class="tok-n">cliente</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">MongoClient</span><span class="tok-o">();</span>
<span class="tok-n">DB</span> <span class="tok-n">db</span> <span class="tok-o">=</span> <span class="tok-n">cliente</span><span class="tok-o">.</span><span class="tok-na">getDB</span><span class="tok-o">(</span><span class="tok-s">&quot;expertojava&quot;</span><span class="tok-o">);</span>
<span class="tok-n">FileInputStream</span> <span class="tok-n">inputStream</span> <span class="tok-o">=</span> <span class="tok-kc">null</span><span class="tok-o">;</span>

<span class="tok-n">GridFS</span> <span class="tok-n">videos</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">GridFS</span><span class="tok-o">(</span><span class="tok-n">db</span><span class="tok-o">);</span>

<span class="tok-k">try</span> <span class="tok-o">{</span>
  <span class="tok-n">inputStream</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">FileInputStream</span><span class="tok-o">(</span><span class="tok-s">&quot;video.mp4&quot;</span><span class="tok-o">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">FileNotFoundException</span> <span class="tok-n">e</span><span class="tok-o">)</span> <span class="tok-o">{</span>
  <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;No puedo abrir el fichero&quot;</span><span class="tok-o">);</span>
  <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">exit</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">);</span>
<span class="tok-o">}</span>

<span class="tok-n">GridFSInputFile</span> <span class="tok-n">video</span> <span class="tok-o">=</span> <span class="tok-n">videos</span><span class="tok-o">.</span><span class="tok-na">createFile</span><span class="tok-o">(</span><span class="tok-n">inputStream</span><span class="tok-o">,</span> <span class="tok-s">&quot;video.mp4&quot;</span><span class="tok-o">);</span>      <i class="conum" data-value="2"></i><b>(2)</b>

<span class="tok-c1">// Creamos algunos metadatos para el vídeo</span>
<span class="tok-n">BasicDBObject</span> <span class="tok-n">meta</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;descripcion&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Prevención de riesgos laborales&quot;</span><span class="tok-o">);</span>
<span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-o">&gt;</span> <span class="tok-n">tags</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">ArrayList</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-o">&gt;();</span>
<span class="tok-n">tags</span><span class="tok-o">.</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-s">&quot;Prevención&quot;</span><span class="tok-o">);</span>
<span class="tok-n">tags</span><span class="tok-o">.</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-s">&quot;Ergonomía&quot;</span><span class="tok-o">);</span>
<span class="tok-n">meta</span><span class="tok-o">.</span><span class="tok-na">append</span><span class="tok-o">(</span><span class="tok-s">&quot;tags&quot;</span><span class="tok-o">,</span> <span class="tok-n">tags</span><span class="tok-o">);</span>

<span class="tok-n">video</span><span class="tok-o">.</span><span class="tok-na">setMetaData</span><span class="tok-o">(</span><span class="tok-n">meta</span><span class="tok-o">);</span>  <i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-n">video</span><span class="tok-o">.</span><span class="tok-na">save</span><span class="tok-o">();</span>   <i class="conum" data-value="4"></i><b>(4)</b>

<span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;Object ID: &quot;</span> <span class="tok-o">+</span> <span class="tok-n">video</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-s">&quot;_id&quot;</span><span class="tok-o">));</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Leemos el archivo desde el sistema de archivos</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Creamos un objeto <code>GridFS</code> que referencia al archivo</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Le asociamos al archivo metadatos mediante una lista de cadenas</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Almacena el archivo en la colección</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Al ejecutar este fragmento de código, la colección <code>fs.files</code> contendrá un documento similar al siguiente donde podemos observar que se ha añadido una propiedad ` metadata`:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;553a78edd4c66e72c890472b&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;chunkSize&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">NumberLong</span><span class="tok-p">(</span><span class="tok-mi">261120</span><span class="tok-p">),</span> <span class="tok-s2">&quot;length&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">NumberLong</span><span class="tok-p">(</span><span class="tok-mi">39380552</span><span class="tok-p">),</span> <span class="tok-s2">&quot;md5&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;b7d51c0c83ef61ccf69f223eded44797&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;filename&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;video.mp4&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;contentType&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">null</span><span class="tok-p">,</span> <span class="tok-s2">&quot;uploadDate&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ISODate</span><span class="tok-p">(</span><span class="tok-s2">&quot;2015-04-24T17:10:05.356Z&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;aliases&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">null</span><span class="tok-p">,</span> <span class="tok-s2">&quot;metadata&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;descripcion&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Prevención de riesgos laborales&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;tags&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span> <span class="tok-s2">&quot;Prevención&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;Ergonomía&quot;</span> <span class="tok-p">]</span> <span class="tok-p">}</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si lo que queremos es obtener un archivo que tenemos almacenado en la base de datos para guardarlo en un fichero haríamos:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo de lectura de <em>GridFS</em></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">MongoClient</span> <span class="tok-n">cliente</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">MongoClient</span><span class="tok-o">();</span>
<span class="tok-n">DB</span> <span class="tok-n">db</span> <span class="tok-o">=</span> <span class="tok-n">cliente</span><span class="tok-o">.</span><span class="tok-na">getDB</span><span class="tok-o">(</span><span class="tok-s">&quot;expertojava&quot;</span><span class="tok-o">);</span>

<span class="tok-n">GridFS</span> <span class="tok-n">videos</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">GridFS</span><span class="tok-o">(</span><span class="tok-n">db</span><span class="tok-o">);</span>

<span class="tok-c1">// Buscamos un fichero</span>
<span class="tok-n">GridFSDBFile</span> <span class="tok-n">gridFile</span> <span class="tok-o">=</span> <span class="tok-n">videos</span><span class="tok-o">.</span><span class="tok-na">findOne</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;filename&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;video.mp4&quot;</span><span class="tok-o">));</span> <i class="conum" data-value="1"></i><b>(1)</b>

<span class="tok-n">FileOutputStream</span> <span class="tok-n">outputStream</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">FileOutputStream</span><span class="tok-o">(</span><span class="tok-s">&quot;video_copia.mp4&quot;</span><span class="tok-o">);</span>
<span class="tok-n">gridFile</span><span class="tok-o">.</span><span class="tok-na">writeTo</span><span class="tok-o">(</span><span class="tok-n">outputStream</span><span class="tok-o">);</span> <i class="conum" data-value="2"></i><b>(2)</b>

<span class="tok-c1">// Buscamos varios ficheros</span>
<span class="tok-n">List</span> <span class="tok-o">&lt;</span><span class="tok-n">GridFSDBFile</span><span class="tok-o">&gt;</span> <span class="tok-n">ficheros</span> <span class="tok-o">=</span> <span class="tok-n">videos</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;descripción&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Prueba&quot;</span><span class="tok-o">));</span> <i class="conum" data-value="3"></i><b>(3)</b>

<span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">GridFSDBFile</span> <span class="tok-nl">fichero:</span> <span class="tok-n">ficheros</span><span class="tok-o">)</span> <span class="tok-o">{</span>
  <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">fichero</span><span class="tok-o">.</span><span class="tok-na">getFilename</span><span class="tok-o">());</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Buscamos en <em>GridFS</em> un archivo por su nombre el cual se almacena en un objeto <code>GridFSDBFile</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Escribimos el contenido del <code>gridFile</code> en un nuevo archivo</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Al obtener varios elementos, el resultado de la búsqueda se almacena en <code>List&lt;GridFSDBFile&gt;</code></td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_casos_de_uso_6">3.3.3. Casos de uso</h4>
<div class="paragraph">
<p>El motivo principal de usar <em>GridFS</em> se debe a superar la restricción de los 16MB de los documentos BSON.</p>
</div>
<div class="paragraph">
<p>Además, hay casos donde es preferible almacenar los archivos de vídeo y audio en una base de datos en vez de en el sistema de archivos, ya sea para almacenar metadatos de los archivos, acceder a ellos desde aplicaciones ajenos al sistemas de archivos o replicar el contenido para ofrecer una alta disponibilidad.</p>
</div>
<div class="paragraph">
<p>Otro caso importante es cuando tenemos contenido generado  por el usuario como grandes informes o datos estáticos que no suelen cambiar y que cuestan mucho de generar. En vez de generarlos con cada petición, se pueden ejecutar una vez y almacenarlos como un documento. Cuando se detecta un cambio en el contenido estático, se vuelve a generar el informe en la próxima petición de los datos.</p>
</div>
<div class="paragraph">
<p>Si el sistema de archivos no siempre está disponible, también podemos evaluar <em>GridFS</em> como una alternativa viable. También podemos aprovechar que los fichero se almacenan en trozos y usar estos trozos para almacenar parte del archivo que interesa, como puede ser el contenido MD5 de los datos.</p>
</div>
<div class="paragraph">
<p>Si nos centramos en sus inconvenientes, tenemos que tener claro que hay pérdida de rendimiento respecto a acceder al sistema de archivos. Por ello, se recomienda crear una prueba de concepto en el sistema a desarrollar antes de implementar la solución.</p>
</div>
<div class="paragraph">
<p>Hay que tener en cuenta que <em>GridFS</em> almacena los datos en múltiples documentos, con lo que una actualización atómica no es posible. Si tenemos claro que el contenido es inferior a 16 MB, que es el caso de la mayoría de contenido generado por el usuario, podemos dejar de lado <em>GridFS</em>, y usar directamente documentos BSON los cuales aceptan datos binarios.</p>
</div>
<div class="listingblock">
<div class="title">Guardado datos binarios en un documento BSON - DatosBinario.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">String</span> <span class="tok-n">recurso</span> <span class="tok-o">=</span> <span class="tok-s">&quot;cartel300.png&quot;</span><span class="tok-o">;</span>
<span class="tok-kt">byte</span><span class="tok-o">[]</span> <span class="tok-n">imagenBytes</span> <span class="tok-o">=</span> <span class="tok-n">leerDatosBinarios</span><span class="tok-o">(</span><span class="tok-n">recurso</span><span class="tok-o">);</span>

<span class="tok-n">DBObject</span> <span class="tok-n">doc</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;_id&quot;</span><span class="tok-o">,</span> <span class="tok-mi">1</span><span class="tok-o">);</span>
<span class="tok-n">doc</span><span class="tok-o">.</span><span class="tok-na">put</span><span class="tok-o">(</span><span class="tok-s">&quot;nombreFichero&quot;</span><span class="tok-o">,</span> <span class="tok-n">recurso</span><span class="tok-o">);</span>
<span class="tok-n">doc</span><span class="tok-o">.</span><span class="tok-na">put</span><span class="tok-o">(</span><span class="tok-s">&quot;tamanyo&quot;</span><span class="tok-o">,</span> <span class="tok-n">imagenBytes</span><span class="tok-o">.</span><span class="tok-na">length</span><span class="tok-o">);</span>
<span class="tok-n">doc</span><span class="tok-o">.</span><span class="tok-na">put</span><span class="tok-o">(</span><span class="tok-s">&quot;datos&quot;</span><span class="tok-o">,</span> <span class="tok-n">imagenBytes</span><span class="tok-o">);</span>
<span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">insert</span><span class="tok-o">(</span><span class="tok-n">doc</span><span class="tok-o">);</span>

<span class="tok-kt">byte</span><span class="tok-o">[]</span> <span class="tok-nf">leerDatosBinarios</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">recurso</span><span class="tok-o">)</span> <span class="tok-kd">throws</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
  <span class="tok-n">InputStream</span> <span class="tok-n">in</span> <span class="tok-o">=</span> <span class="tok-n">Thread</span><span class="tok-o">.</span><span class="tok-na">currentThread</span><span class="tok-o">().</span><span class="tok-na">getContextClassLoader</span><span class="tok-o">().</span><span class="tok-na">getResourceAsStream</span><span class="tok-o">(</span><span class="tok-n">recurso</span><span class="tok-o">);</span>
  <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">in</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-kt">int</span> <span class="tok-n">available</span> <span class="tok-o">=</span> <span class="tok-n">in</span><span class="tok-o">.</span><span class="tok-na">available</span><span class="tok-o">();</span>
    <span class="tok-kt">byte</span><span class="tok-o">[]</span> <span class="tok-n">bytes</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-kt">byte</span><span class="tok-o">[</span><span class="tok-n">available</span><span class="tok-o">];</span>
    <span class="tok-n">in</span><span class="tok-o">.</span><span class="tok-na">read</span><span class="tok-o">(</span><span class="tok-n">bytes</span><span class="tok-o">);</span>
    <span class="tok-k">return</span> <span class="tok-n">bytes</span><span class="tok-o">;</span>
  <span class="tok-o">}</span> <span class="tok-k">else</span> <span class="tok-o">{</span>
    <span class="tok-k">throw</span> <span class="tok-k">new</span> <span class="tok-nf">IllegalArgumentException</span><span class="tok-o">(</span><span class="tok-s">&quot;Recurso &quot;</span> <span class="tok-o">+</span> <span class="tok-n">recurso</span> <span class="tok-o">+</span> <span class="tok-s">&quot; no encontrado&quot;</span><span class="tok-o">);</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_Índices">3.4. Índices</h3>
<div class="paragraph">
<p>Los índices son una parte importante de la gestión de bases de datos. Un índice en una base de datos es similar a un índice de un libro; permite saltar directamente a la parte del libro en vez de tener que pasar las páginas buscando el tema o la palabra que nos interesa.</p>
</div>
<div class="paragraph">
<p>En el caso de <em>MongoDB</em>, un índice es una estructura de datos que almacena información sobre los valor de determinados campos de los documentos de una colección. Esta estructura permite recorrer los datos y ordenarlos de manera muy rápida. Así pues, los índices se utilizan tanto al buscar un documento como al ordenar los datos de una consulta.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Preparando los ejemplos</div>
<div class="paragraph">
<p>Para los siguientes ejemplos, vamos a utilizar una colección de 200 estudiantes con las calificaciones que han obtenido en diferentes trabajos, exámenes o cuestionarios.</p>
</div>
<div class="paragraph">
<p>Para ello, importaremos la colección <a href="resources/nosql/students.json.txt">students.json</a> mediante:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">mongoimport -d expertojava -c students --file students.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>Un ejemplo de una estudiante sería:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">findOne</span><span class="tok-p">()</span>
<span class="tok-p">{</span>
  <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">0</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;name&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;aimee Zank&quot;</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;scores&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span>
    <span class="tok-p">{</span>
      <span class="tok-s2">&quot;type&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;exam&quot;</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;score&quot;</span> <span class="tok-o">:</span> <span class="tok-mf">1.463179736705023</span>
    <span class="tok-p">},</span> <span class="tok-p">{</span>
      <span class="tok-s2">&quot;type&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;quiz&quot;</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;score&quot;</span> <span class="tok-o">:</span> <span class="tok-mf">11.78273309957772</span>
    <span class="tok-p">},</span> <span class="tok-p">{</span>
      <span class="tok-s2">&quot;type&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;homework&quot;</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;score&quot;</span> <span class="tok-o">:</span> <span class="tok-mf">6.676176060654615</span>
    <span class="tok-p">},</span> <span class="tok-p">{</span>
      <span class="tok-s2">&quot;type&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;homework&quot;</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;score&quot;</span> <span class="tok-o">:</span> <span class="tok-mf">35.8740349954354</span>
    <span class="tok-p">}</span>
  <span class="tok-p">]</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Para comprobar el impacto del uso de índices, vamos a empezar con un ejemplo para ver cómo de rápido puede hacerse una consulta que tiene un índice respecto a uno que no lo tiene.</p>
</div>
<div class="paragraph">
<p>Para analizar el plan de ejecución de una consulta, podemos emplear el método <code>explain()</code> (<a href="https://docs.mongodb.org/manual/reference/method/cursor.explain/" class="bare">https://docs.mongodb.org/manual/reference/method/cursor.explain/</a>) sobre un cursor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-s2">&quot;name&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Kaila Deibler&quot;</span><span class="tok-p">}).</span><span class="tok-nx">explain</span><span class="tok-p">(</span><span class="tok-s2">&quot;executionStats&quot;</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-s2">&quot;queryPlanner&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-s2">&quot;plannerVersion&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;namespace&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;expertojava.students&quot;</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;indexFilterSet&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">false</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;parsedQuery&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
      <span class="tok-s2">&quot;name&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;$eq&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Kaila Deibler&quot;</span> <span class="tok-p">}</span>
    <span class="tok-p">},</span>
    <span class="tok-s2">&quot;winningPlan&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
      <span class="tok-s2">&quot;stage&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;COLLSCAN&quot;</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;filter&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
        <span class="tok-s2">&quot;name&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;$eq&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Kaila Deibler&quot;</span> <span class="tok-p">}</span>
      <span class="tok-p">},</span>
      <span class="tok-s2">&quot;direction&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;forward&quot;</span>
    <span class="tok-p">},</span>
    <span class="tok-s2">&quot;rejectedPlans&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span> <span class="tok-p">]</span>
  <span class="tok-p">},</span>
  <span class="tok-s2">&quot;executionStats&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-s2">&quot;executionSuccess&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">true</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;nReturned&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;executionTimeMillis&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;totalKeysExamined&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">0</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;totalDocsExamined&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">200</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;executionStages&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
      <span class="tok-s2">&quot;stage&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;COLLSCAN&quot;</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;filter&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
        <span class="tok-s2">&quot;name&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;$eq&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Kaila Deibler&quot;</span> <span class="tok-p">}</span>
      <span class="tok-p">},</span>
      <span class="tok-s2">&quot;nReturned&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;executionTimeMillisEstimate&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">0</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;works&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">204</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;advanced&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;needTime&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">199</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;needYield&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;saveState&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;restoreState&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;isEOF&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;invalidates&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">0</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;direction&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;forward&quot;</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;docsExamined&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">200</span>
    <span class="tok-p">}</span>
  <span class="tok-p">},</span>
  <span class="tok-s2">&quot;serverInfo&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-s2">&quot;host&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;MacBook-Air-de-Aitor.local&quot;</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;port&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">27017</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;version&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;3.2.1&quot;</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;gitVersion&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;a14d55980c2cdc565d4704a7e3ad37e4e535c1b2&quot;</span>
  <span class="tok-p">},</span>
  <span class="tok-s2">&quot;ok&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El plan de ejecución devuelve mucha información (<a href="https://docs.mongodb.org/manual/reference/explain-results/" class="bare">https://docs.mongodb.org/manual/reference/explain-results/</a>), pero nos vamos a centrar en unos pocos atributos para analizar el resultado.</p>
</div>
<div class="paragraph">
<p>A grosso modo, podemos observar como el resultado se divide en dos partes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>queryPlanner</code>: muestra información sobre la consulta, indicando el plan ganador en <code>winningPlan</code></p>
<div class="ulist">
<ul>
<li>
<p><code>winningPlan.stage</code>: muestra información de la acción realizada. Puede tomar los valores:</p>
<div class="ulist">
<ul>
<li>
<p><code>COLLSCAN</code>: escaneo completo de una colección</p>
</li>
<li>
<p><code>IXSCAN</code>: escaneo a partir de un índice</p>
</li>
<li>
<p><code>FETCH</code>: al recuperar documentos</p>
</li>
<li>
<p><code>SHARD_MERGE</code>: al fusionar resultados de las particiones</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><code>executionStats</code>: muestra estadísticas de ejecución</p>
<div class="ulist">
<ul>
<li>
<p><code>executionTimeMillis</code>: tiempo empleado</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Del resultado obtenido, se puede observar mediante la propiedad <code>queryPlanner.winningPlan.stage</code> que ha utilizado un <code>COLLSCAN</code>, lo que significa que se ha realizado un escaneo completo de toda la colección para encontrar los datos, lo que significa que no se ha usado ningún índice en la consulta. Esta consulta sólo devuelve un par de documentos (<code>executionStats.nReturned</code>) pero ha tenido que escanear los 200 existentes (<code>executionStats.totalDocsExamined</code>).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Cuando vamos a buscar un elemento, es mucho mas rápido hacer un <code>findOne</code> que <code>find</code>, porque mientras <code>find</code> recorre toda la colección, con <code>findOne</code> en cuanto encuentre un documento, el cursor se detendrá.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Por defecto, el campo <code>_id</code> esta indexado. Así pues, vamos a buscar el mismo documento de antes, pero ahora mediante el campo indexado:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-nx">_id</span><span class="tok-o">:</span><span class="tok-mi">30</span><span class="tok-p">}).</span><span class="tok-nx">explain</span><span class="tok-p">(</span><span class="tok-s2">&quot;executionStats&quot;</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-s2">&quot;queryPlanner&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-s2">&quot;plannerVersion&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
    <span class="tok-p">...</span>
    <span class="tok-s2">&quot;winningPlan&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
      <span class="tok-s2">&quot;stage&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;IDHACK&quot;</span>
    <span class="tok-p">},</span>
    <span class="tok-s2">&quot;rejectedPlans&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span> <span class="tok-p">]</span>
  <span class="tok-p">},</span>
  <span class="tok-s2">&quot;executionStats&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-s2">&quot;executionSuccess&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">true</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;nReturned&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;executionTimeMillis&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">0</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;totalKeysExamined&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;totalDocsExamined&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;executionStages&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
      <span class="tok-p">...</span>
    <span class="tok-p">}</span>
  <span class="tok-p">},</span>
  <span class="tok-s2">&quot;serverInfo&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-p">...</span>
  <span class="tok-p">},</span>
  <span class="tok-s2">&quot;ok&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora <em>MongoDB</em> sólo ha escaneado el documento que ha devuelto ( <code>executionStats.totalKeysExamined</code>), y ha utilizado un índice para acceder al campo <code>_id</code> (valor <code>IDHACK</code> en <code>winningPlan.stage</code>). Al haber utilizado un índice, hemos evitado tener que mirar en más documentos. Esta consulta se ha realizado más rápidamente (y a mayor número de documentos más se nota la diferencia). Por supuesto, no siempre vamos a buscar por su <code>_id</code>, así que vamos a ver como crear nuevos índices.</p>
</div>
<div class="paragraph">
<p>Toda la información sobre el uso de índices con <em>MongoDB</em> se encuentra en <a href="http://docs.mongodb.org/manual/core/indexes/" class="bare">http://docs.mongodb.org/manual/core/indexes/</a></p>
</div>
<div class="sect3">
<h4 id="_simples">3.4.1. Simples</h4>
<div class="paragraph">
<p>Para crear un índice hemos de utilizar el método <code>createIndex({atributo:orden})</code></p>
</div>
<div class="paragraph">
<p>Si queremos crear un índice sobre la propiedad <code>name</code> en orden ascendente haríamos lo siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">createIndex</span><span class="tok-p">(</span> <span class="tok-p">{</span><span class="tok-nx">name</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">}</span> <span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-s2">&quot;createdCollectionAutomatically&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">false</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;numIndexesBefore&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;numIndexesAfter&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;ok&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si ahora volvemos a ejecutar la consulta por nombre, comprobaremos como ahora ya realiza una búsqueda directa (valor <code>FETCH</code> en <code>winningPlan.stage</code>) y que no ha tenido que recorrer todos los documentos.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-s2">&quot;name&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Kaila Deibler&quot;</span><span class="tok-p">}).</span><span class="tok-nx">explain</span><span class="tok-p">(</span><span class="tok-s2">&quot;executionStats&quot;</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-s2">&quot;queryPlanner&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-s2">&quot;plannerVersion&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
    <span class="tok-p">...</span>
    <span class="tok-s2">&quot;winningPlan&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
      <span class="tok-s2">&quot;stage&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;FETCH&quot;</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;inputStage&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
        <span class="tok-s2">&quot;stage&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;IXSCAN&quot;</span><span class="tok-p">,</span>
        <span class="tok-s2">&quot;keyPattern&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;name&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span> <span class="tok-p">},</span>
        <span class="tok-s2">&quot;indexName&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;name_1&quot;</span><span class="tok-p">,</span>
        <span class="tok-s2">&quot;isMultiKey&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">false</span><span class="tok-p">,</span>
        <span class="tok-s2">&quot;isUnique&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">false</span><span class="tok-p">,</span>
        <span class="tok-s2">&quot;isSparse&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">false</span><span class="tok-p">,</span>
        <span class="tok-s2">&quot;isPartial&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">false</span><span class="tok-p">,</span>
        <span class="tok-s2">&quot;indexVersion&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
        <span class="tok-s2">&quot;direction&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;forward&quot;</span><span class="tok-p">,</span>
        <span class="tok-s2">&quot;indexBounds&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
          <span class="tok-s2">&quot;name&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span>
            <span class="tok-s2">&quot;[\&quot;Kaila Deibler\&quot;, \&quot;Kaila Deibler\&quot;]&quot;</span>
          <span class="tok-p">]</span>
        <span class="tok-p">}</span>
      <span class="tok-p">}</span>
    <span class="tok-p">},</span>
    <span class="tok-s2">&quot;rejectedPlans&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span> <span class="tok-p">]</span>
  <span class="tok-p">},</span>
  <span class="tok-s2">&quot;executionStats&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-s2">&quot;executionSuccess&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">true</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;nReturned&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;executionTimeMillis&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;totalKeysExamined&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;totalDocsExamined&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;executionStages&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
      <span class="tok-p">...</span>
    <span class="tok-p">}</span>
  <span class="tok-p">},</span>
  <span class="tok-s2">&quot;serverInfo&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
  	<span class="tok-p">...</span>
  <span class="tok-p">},</span>
  <span class="tok-s2">&quot;ok&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Un aspecto a considerar de los índices es que aceleran mucho las búsquedas, pero ralentizan las inserciones/modificaciones y hace que la información ocupe más espacio en disco. Por ello, deberemos considerar añadir índices a las colecciones donde el número de lecturas sea mayor que el de escrituras. Si sucede al revés, el uso de índices puede provocar un deterioro en el rendimiento.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El orden de los índices (<code>1</code> para ascendente, <code>-1</code> para descendente) no importa para un índice sencillo, pero si que tendrá un impacto en los índices compuestos cuando se utilizan para ordenar o con una condición de rango.</p>
</div>
<div class="paragraph">
<p>Por supuesto, podemos crear índices sobre propiedades que forman parte de un array. Así pues, podemos crear un índice sobre el tipo de calificación que tiene un estudiante mediante:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">createIndex</span><span class="tok-p">(</span> <span class="tok-p">{</span><span class="tok-nx">scores</span><span class="tok-p">.</span><span class="tok-nx">type</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">}</span> <span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pero además también podemos crear un índice sobre todas las calificaciones, lo cual indexa cada elemento del array, con lo que podemos buscar por cualquier objeto del array. Este tipo de índices se conocen como <strong>multiclave</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">createIndex</span><span class="tok-p">(</span> <span class="tok-p">{</span><span class="tok-nx">scores</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">}</span> <span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Toda la información relativa a los índices creados se almacenan en la colección <code>system.indexes</code>, la cual podremos consultar.</p>
</div>
<div class="paragraph">
<p>Además, también podemos obtener los índices de una determinada colección mediante el método <code>getIndexes()</code>.</p>
</div>
<div class="paragraph">
<p>Finalmente, para borrar un índice emplearemos el método <code>dropIndex(<em>atributo</em>)</code>.</p>
</div>
<div class="paragraph">
<p>Así pues, tenemos que algunas de las operaciones relacionadas con los índices más importantes son:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">system</span><span class="tok-p">.</span><span class="tok-nx">indexes</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">()</span> <span class="tok-c1">// muestra los índices existentes</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">getIndexes</span><span class="tok-p">()</span> <span class="tok-c1">// muestra los índices de la colección students</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">dropIndex</span><span class="tok-p">(</span> <span class="tok-p">{</span><span class="tok-s2">&quot;name&quot;</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">}</span> <span class="tok-p">)</span> <span class="tok-c1">// borra el índice que existe sobre la propiedad name</span></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_propiedades">Propiedades</h5>
<div class="paragraph">
<p>Al crear un índice podemos pasarle algunas opciones como segundo parámetro, como puede ser:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>unique:true</code>: Permite crear índices que sólo permiten valores únicos en una propiedad. No puede haber valores repetidos y una vez creado no permitirá insertar valores duplicados.</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">createIndex</span><span class="tok-p">(</span> <span class="tok-p">{</span><span class="tok-nx">students_id</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">unique</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">}</span> <span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El índice sobre <code>_id</code> es único aunque al visualizarlo no nos diga que lo sea, ya que no permite que se inserten dos <code>_id</code> iguales.</p>
</div>
</li>
<li>
<p>Si queremos añadir un índice sobre una propiedad que no aparece en todos los documentos, necesitamos crear un <em>Sparse Index</em> mediante <code>sparse:true</code>, el cual se crea para el conjunto de claves que tienen valores.</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">createIndex</span><span class="tok-p">(</span> <span class="tok-p">{</span><span class="tok-nx">size</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">sparse</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">}</span> <span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si hacemos una consulta sobre una propiedad que tiene asociado un <em>Sparse Index</em>, nos van a aparecer menos resultados, ya que sólo mostrará aquellos que tengan valores, y no tendrá en cuenta los documentos que tengan dicho campo sin crear.</p>
</div>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Autoevaluación</div>
<div class="paragraph">
<p>Suponemos que tenemos los siguientes documentos en una colección llamada 'people' con los siguientes documentos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">()</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;50a464fb0a9dfcc4f19d6271&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;nombre&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Juan&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;cargo&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Técnico&quot;</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;50a4650c0a9dfcc4f19d6272&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;nombre&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Pedro&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;cargo&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;CEO&quot;</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;50a465280a9dfcc4f19d6273&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;nombre&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Sandra&quot;</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y hay un índice definido del siguiente modo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">createIndex</span><span class="tok-p">({</span><span class="tok-nx">cargo</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">sparse</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si realizamos la siguiente consulta, ¿Qué documentos aparecerán y por qué? <span class="footnote">[<a id="_footnoteref_9" class="footnote" href="#_footnote_9" title="View footnote.">9</a>]</span></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-nx">cargo</span><span class="tok-o">:</span><span class="tok-kc">null</span><span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Ningún documento, ya que la consulta utiliza el índice y no puede haber documentos que no contengan el campo <code>cargo</code></p>
</li>
<li>
<p>Ningún documento, ya que la consulta de <code>cargo:null</code> sólo encuentra documentos que de manera explícita tienen el <em>cargo</em> a nulo, independientemente del índice.</p>
</li>
<li>
<p>El documento de <em>Sandra</em>, ya que la consulta no utilizará el índice</p>
</li>
<li>
<p>Todos los documentos de la colección, ya que todos los documentos cumplen <code>cargo:null</code></p>
</li>
<li>
<p>El documento de <em>Sandra</em>, ya que el comando <code>createIndex</code> no se ejecutará sobre este documento.</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Finalmente, desde la versión 3.2, podemos emplear índices <strong>parciales</strong>, para indexar aquellos documentos que cumplen un criterio específico. Al indexar un subconjunto de los documentos de una colección, estos índices ocupan menos, y reducen el coste de almacenamiento y rendimiento a la hora de crearlo. Para ello, le pasaremos a la propiedad <code>partialFilterExpression</code> el criterio que debe cumplir el índice parcial.</p>
<div class="paragraph">
<p>Por ejemplo, para indexar por tipo de calificación a aquellos estudiantes con una calificación superior a 95 haríamos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">createIndex</span><span class="tok-p">({</span><span class="tok-s2">&quot;scores.type&quot;</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">partialFilterExpression</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-s2">&quot;scores.score&quot;</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$gt</span><span class="tok-o">:</span><span class="tok-mi">95</span><span class="tok-p">}}}</span> <span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para utilizar este índice, la consulta debe realizarse por el campo del mismo, y cumplir con un subconjunto de la expresión de filtrado. Por ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-s2">&quot;scores.type&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;exam&quot;</span><span class="tok-p">})</span> <span class="tok-c1">// No emplea el índice, no utiliza el filtro</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-s2">&quot;scores.type&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;exam&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;scores.score&quot;</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$gt</span><span class="tok-o">:</span><span class="tok-mi">90</span><span class="tok-p">}}</span> <span class="tok-p">)</span> <span class="tok-c1">// No emplea el índice, ya que no cumple el filtr</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-s2">&quot;scores.type&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;exam&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;scores.score&quot;</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$gt</span><span class="tok-o">:</span><span class="tok-mi">96</span><span class="tok-p">}}</span> <span class="tok-p">)</span> <span class="tok-c1">// Si emplea el filtro</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Más información sobre los índices parciales en <a href="https://docs.mongodb.org/manual/core/index-partial/" class="bare">https://docs.mongodb.org/manual/core/index-partial/</a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compuestos">3.4.2. Compuestos</h4>
<div class="paragraph">
<p>Si queremos aplicar un índice sobre más de una propiedad, podemos crear índices compuestos, indicando las propiedades separadas por coma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">createIndex</span><span class="tok-p">({</span><span class="tok-s2">&quot;name&quot;</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-s2">&quot;scores.type&quot;</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Es importante destacar que el orden de los índices importa, y mucho. Si hacemos una consulta que sólo utilice el atributo <code>scores.type</code>, este índice no se va a utilizar.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
No confundir los índices compuestos con hacer 2 o más índices sobre diferentes propiedades.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si creamos un índice sobre los campos (<code>A</code>,<code>B</code>,<code>C</code>), el índice se va a utilizar para las búsquedas sobre <code>A</code>, sobre la dupla (<code>A</code>,<code>B</code>) y sobre el trio (<code>A</code>,<code>B</code>,<code>C</code>). Es decir, los índices se usan con los subconjuntos por la izquierda (prefijos) de los índices compuestos.</p>
</div>
<div class="paragraph">
<p>Si tenemos varios índices candidatos a la hora de ejecutar, el optimizador de consultas de <em>MongoDB</em> los usará en paralelo y se quedará con el resultado del primero que termine. Más información en <a href="http://docs.mongodb.org/manual/core/query-plans/" class="bare">http://docs.mongodb.org/manual/core/query-plans/</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_multiclave">3.4.3. Multiclave</h4>
<div class="paragraph">
<p>Cuando se indexa una propiedad que es un array se crea un índice multiclave para todos los valores del array de todos los documentos. El uso de estos índices son lo que hacen que las consultas sobre documentos embebidos funcionen tan rápido.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">createIndex</span><span class="tok-p">({</span><span class="tok-s2">&quot;teachers&quot;</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">})</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-s2">&quot;teachers&quot;</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-s2">&quot;$all&quot;</span><span class="tok-o">:</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">,</span><span class="tok-mi">3</span><span class="tok-p">]}})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Se pueden crear índices tanto en propiedades básicas, como en propiedades internas de un array, mediante la notación de <code>.</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">createIndex</span><span class="tok-p">({</span><span class="tok-s2">&quot;addresses.phones&quot;</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Sólo se pueden crear índices compuestos multiclave cuando sólo una de las propiedades del índice compuesto es un array; es decir, no puede haber dos propiedades array en un índice compuesto.
Hay que tener cuidado ya que no se va a quejar al crearlo, solo al insertar, porque no va a poder indexar arrays paralelos.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_rendimiento_2">3.4.4. Rendimiento</h4>
<div class="paragraph">
<p>Por defecto, los índices se crean en <em>foreground</em>, de modo que al crear un índice se van a bloquear a todos los <em>writers</em>. Si queremos crearlos en <em>background</em> para no penalizar las escrituras (es más lento, de 2 a 5 veces) lo indicaremos con un segundo parámetro:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">createIndex</span><span class="tok-p">({</span><span class="tok-s2">&quot;twitter&quot;</span><span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">background</span><span class="tok-o">:</span><span class="tok-kc">true</span><span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Más información sobre la creación en <em>background</em> en <a href="https://docs.mongodb.org/manual/core/index-creation/" class="bare">https://docs.mongodb.org/manual/core/index-creation/</a></p>
</div>
<div class="paragraph">
<p>Algunos de los operadores que no utilizan los índices eficientemente son los operadores <code>$where</code>, <code>$nin</code> y <code>$exists</code>. Cuando estos operadores se emplean en una consultar hay que tener en mente un posible cuelo de botella cuando el tamaño de los datos incremente.</p>
</div>
<div class="sect4">
<h5 id="_plan_de_ejecución">Plan de ejecución</h5>
<div class="paragraph">
<p>Al explicar los índices ya hemos visto que podemos obtener información sobre la operación realizada mediante el método <code>.explain()</code>.</p>
</div>
<div class="paragraph">
<p>El atributo <code>indexOnly</code> me dice si toda la información que quiero recuperar se encuentra en el índice. Este atributo va a depender de los campos que quiera que me devuelva la consulta, si son un subconjunto del índice utilizado.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Más información en <a href="http://docs.mongodb.org/manual/reference/method/cursor.explain/" class="bare">http://docs.mongodb.org/manual/reference/method/cursor.explain/</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Los índices tienen que caber en memoria. Si están en disco, pese a ser algorítmicamente mejores que no tener, al ser más grandes que la RAM disponible, no se obtienen beneficios por la penalización de la paginación.</p>
</div>
<div class="paragraph">
<p>Para averiguar el tamaño de los índices (en bytes):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">stats</span><span class="tok-p">()</span>  <span class="tok-c1">// obtiene estadísticas de la colección</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">totalIndexSize</span><span class="tok-p">()</span>  <span class="tok-c1">// obtiene el tamaño del índice</span></code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Mucho cuidado con los índices <em>multikeys</em> porque crecen mucho y si el documento tiene que moverse en disco, el cambio supone tener que cambiar todos los puntos de índice del array.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Aunque sea más responsabilidad de un DBA, los desarrolladores debemos saber si el índice va a caber en memoria. Si no van a caber es mejor no usarlos.</p>
</div>
<div class="paragraph">
<p>Si vemos que no usamos un índice o que su rendimiento es peor, podemos borrarlos con <code>dropIndex</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">dropIndex</span><span class="tok-p">(</span><span class="tok-s1">&#39;nombreDeíndice&#39;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos obtener más información sobre el rendimiento de las consultas mediante su plan de ejecución en <a href="https://docs.mongodb.org/manual/tutorial/analyze-query-plan/" class="bare">https://docs.mongodb.org/manual/tutorial/analyze-query-plan/</a></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Autoevaluación</div>
<div class="paragraph">
<p>Hemos actualizado un documento con una clave llamada <em>etiquetas</em> que provoca que el documento tenga que moverse a disco.
Supongamos que el documento contiene 100 etiquetas en él y que el array de etiquetas está indexada con un índice multiclave.</p>
</div>
<div class="paragraph">
<p>¿Cuantos puntos de índice tienen que actualizarse en el índice para acodomar el movimiento? <span class="footnote">[<a id="_footnoteref_10" class="footnote" href="#_footnote_10" title="View footnote.">10</a>]</span></p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_hints">Hints</h5>
<div class="paragraph">
<p>Si en algún momento queremos forzar el uso de un determinado índice al realizar una consulta, necesitaremos usar el método <code>.hint({campo:1})</code></p>
</div>
<div class="paragraph">
<p>Si queremos que se utilice el índice asociado a la propiedad <code>twitter</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s2">&quot;Aitor Medrano&quot;</span><span class="tok-p">,</span><span class="tok-nx">twitter</span><span class="tok-o">:</span><span class="tok-s2">&quot;aitormedrano&quot;</span><span class="tok-p">}).</span><span class="tok-nx">hint</span><span class="tok-p">({</span><span class="tok-nx">twitter</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">}})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si por algún motivo no queremos usar índices, le pasaremos el operador <code>$natural</code> al método <code>hint()</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s2">&quot;Aitor Medrano&quot;</span><span class="tok-p">,</span><span class="tok-nx">twitter</span><span class="tok-o">:</span><span class="tok-s2">&quot;aitormedrano&quot;</span><span class="tok-p">}).</span><span class="tok-nx">hint</span><span class="tok-p">({</span><span class="tok-nx">$natural</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">}})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si usamos un <em>hint</em> sobre un índice <em>sparse</em> y no hay documentos a devolver con dicho índice porque todos sus campos son nulos, la consulta no devolverá nada, aunque haya documentos que sin dicho índice si cumplen los criterios.</p>
</div>
<div class="paragraph">
<p>Hay que destacar que los operadores <code>$gt</code>, <code>$lt</code>, <code>$ne</code> … provocan un uso ineficiente de los índices, ya que la consulta tiene que recorrer toda la colección de índices.
Si hacemos una consulta sobre varios atributos y en uno de ellos usamos <code>$gt</code>, <code>$lt</code> o similar, es mejor hacer un <em>hint</em> sobre el resto de atributos que sí tienen una selección directa.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, supongamos que en la coleccion de calificaciones quieseramos obtener los exámenes con un calificación comprendida entre 95 y 98.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span> <span class="tok-nx">score</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$gt</span><span class="tok-o">:</span><span class="tok-mi">95</span><span class="tok-p">,</span> <span class="tok-nx">$lte</span><span class="tok-o">:</span><span class="tok-mi">98</span><span class="tok-p">},</span> <span class="tok-nx">type</span><span class="tok-o">:</span><span class="tok-s2">&quot;exam&quot;</span> <span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para esta consulta, suponiendo que tenemos un índice tanto en <code>score</code> como en <code>type</code>, sería conveniente hacer el <em>hint</em> sobre el <code>type</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span> <span class="tok-nx">score</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$gt</span><span class="tok-o">:</span><span class="tok-mi">95</span><span class="tok-p">,</span> <span class="tok-nx">$lte</span><span class="tok-o">:</span><span class="tok-mi">98</span><span class="tok-p">},</span> <span class="tok-nx">type</span><span class="tok-o">:</span><span class="tok-s2">&quot;exam&quot;</span> <span class="tok-p">}).</span><span class="tok-nx">hint</span><span class="tok-p">(</span><span class="tok-s1">&#39;type&#39;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Otros tipos de índices</div>
<div class="ulist">
<ul>
<li>
<p><strong>Geoespaciales</strong>, para trabajar con coordenadas &#8594; <a href="http://docs.mongodb.org/manual/applications/geospatial-indexes/" class="bare">http://docs.mongodb.org/manual/applications/geospatial-indexes/</a></p>
</li>
<li>
<p><strong>De texto</strong>, para realizar búsquedas dentro de un campo &#8594; <a href="http://docs.mongodb.org/manual/core/index-text/" class="bare">http://docs.mongodb.org/manual/core/index-text/</a></p>
</li>
<li>
<p><strong>Hash</strong>, centrado en el uso de <em>sharding</em> &#8594; <a href="http://docs.mongodb.org/manual/core/index-hashed/" class="bare">http://docs.mongodb.org/manual/core/index-hashed/</a></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_colecciones_limitadas">3.5. Colecciones limitadas</h3>
<div class="paragraph">
<p>Una colección limitada (<em>capped collection</em>) es una colección de tamaño fijo, donde se garantiza el orden natural de los datos, es decir, el orden en que se insertaron.</p>
</div>
<div class="paragraph">
<p>Una vez se llena la colección, se eliminan los datos más antiguos, y los datos más nuevos se añaden al final, de manera similar a un <em>buffer</em> circular, asegurando que el orden natural de la colección sigue el orden en el que se insertaron los registros.</p>
</div>
<div class="paragraph">
<p>Este tipo de colecciones se utilizan para logs y auto-guardado de información, ya que su rendimiento es muy alto para inserciones.</p>
</div>
<div class="paragraph">
<p>Se crean de manera explícita mediante el método <code>createCollection</code>, pasándole el tamaño en <em>bytes</em> de la colección. Por ejemplo, si queremos cerar una colección para auditar datos de 20 KB haríamos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">createCollection</span><span class="tok-p">(</span><span class="tok-s2">&quot;auditoria&quot;</span><span class="tok-p">,</span> <span class="tok-p">{</span><span class="tok-nx">capped</span><span class="tok-o">:</span><span class="tok-kc">true</span><span class="tok-p">,</span> <span class="tok-nx">size</span><span class="tok-o">:</span><span class="tok-mi">20480</span><span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Los documentos que se añaden a una colección limitada se pueden modifican, pero no pueden crecer en tamaño. Si sucede, la modificación fallará.
Además, tampoco se pueden eliminar documentos de la colección. Para ello, hay que borrar toda la colección (<em>drop</em>) y volver a crearla.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>También podemos limitar el número de elementos que se pueden añadir a la colección mediante el parámetro <code>max:</code> en la creación de la colección. Sin embargo, hay que asegurarse de disponer de suficiente espacio en la colección para los elementos que queremos añadir. Si la colección se llena antes de que el número de elementos se alcance, se eliminará el elemento más antiguo de la colección.</p>
</div>
<div class="paragraph">
<p>Si retomamos el ejemplo anterior, pero fijamos su máximo a 100 elementos, crearíamos la colección del siguiente modo:</p>
</div>
<div class="listingblock">
<div class="title">Creando una colección limitada a 100 documentos</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">createCollection</span><span class="tok-p">(</span><span class="tok-s2">&quot;auditoria&quot;</span><span class="tok-p">,</span> <span class="tok-p">{</span><span class="tok-nx">capped</span><span class="tok-o">:</span><span class="tok-kc">true</span><span class="tok-p">,</span> <span class="tok-nx">size</span><span class="tok-o">:</span><span class="tok-mi">20480</span><span class="tok-p">,</span> <span class="tok-nx">max</span><span class="tok-o">:</span><span class="tok-mi">100</span><span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El <em>shell</em> de <em>MongoDB</em> ofrece la utilidad <code>validate()</code> para visualizar la cantidad de espacio utilizado por cada colección, ya sea limitada o no. Para comprobar el estado de la colección anterior haríamos:</p>
</div>
<div class="listingblock">
<div class="title">Validando el estado de una colección</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">auditoria</span><span class="tok-p">.</span><span class="tok-nx">validate</span><span class="tok-p">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si queremos consultar los datos de una colección limitada, por su idiosincracia, los resultados aparecerán en el orden de inserción. Si queremos obtenerlos en orden inverso, le tenemos que pasar el operador <code>$natural</code> al método <code>sort()</code>:</p>
</div>
<div class="listingblock">
<div class="title">Consultando una colección limitada a la inversa</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">auditoria</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">().</span><span class="tok-nx">sort</span><span class="tok-p">({</span> <span class="tok-nx">$natural</span><span class="tok-o">:-</span><span class="tok-mi">1</span> <span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finalmente, si queremos averiguar si una colección es limitada, lo haremos mediante el método <code>isCapped()</code>:</p>
</div>
<div class="listingblock">
<div class="title">Comprobando si una colección es limitada</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">auditoria</span><span class="tok-p">.</span><span class="tok-nx">isCapped</span><span class="tok-p">()</span>
<span class="tok-kc">true</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Más información en <a href="https://docs.mongodb.org/manual/core/capped-collections/" class="bare">https://docs.mongodb.org/manual/core/capped-collections/</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_profiling">3.6. Profiling</h3>
<div class="paragraph">
<p>Si arrancamos el demonio con la opción <code>--rest</code> lanzará un servidor HTTP que escucha peticiones en el puerto 28017. Este servidor captura peticiones REST que permiten realizar consultas sobre la información administrativa de la base de datos.</p>
</div>
<div class="paragraph">
<p>Así pues, si abrimos el navegador y accedemos a <a href="http://localhost:28017" class="bare">http://localhost:28017</a> obtendremos algo similar a esto:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql03/mongod-rest.jpg" alt="Interfaz REST de mongod" width="100%">
</div>
<div class="title">Figure 22. Interfaz REST de mongod</div>
</div>
<div class="paragraph">
<p>Más información en <a href="http://docs.mongodb.org/ecosystem/tools/http-interfaces" class="bare">http://docs.mongodb.org/ecosystem/tools/http-interfaces</a></p>
</div>
<div class="paragraph">
<p>Además, <em>MongoDB</em> trae integradas varias herramientas para el control del rendimiento.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, la colección <code>db.system.profile</code> auditará las consultas ejecutadas. Podemos indicar el nivel de las consultas a auditar mediante tres niveles: <code>0</code> (ninguna), <code>1</code> (consultas lentas), <code>2</code> (todas las consultas)</p>
</div>
<div class="paragraph">
<p>Si queremos que se auditen todas las consultas, lo indicaremos del siguiente modo:</p>
</div>
<div class="listingblock">
<div class="title">Auditando todas las consultas</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">setProfilingLevel</span><span class="tok-p">(</span><span class="tok-mi">2</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El método <code>setProfilingLevel()</code> también admite un segundo parámetro para indicar el numero mínimo de milisegundos de las consultas para ser auditadas.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Por defecto, <em>MongoDB</em> automáticamente escribe en el log las consultas que tardan más de 100ms.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si queremos indicar estas propiedades al arrancar el demonio, le pasaremos los parámetros <code>--profile</code> y/o <code>--slowms</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">mongod --profile<span class="tok-o">=</span><span class="tok-m">1</span> --slowms<span class="tok-o">=</span>15</code></pre>
</div>
</div>
<div class="paragraph">
<p>Si en algún momento queremos consultar tanto el nivel como el estado del <em>profiling</em>, podemos utilizar los métodos <code>db.getProfilingLevel()</code> y <code>db.getProfilingStatus()</code>.</p>
</div>
<div class="paragraph">
<p>Sobre los datos auditados, podemos hacer <code>find</code> sobre <code>db.system.profile</code> y filtrar por los campos mostrados:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">system</span><span class="tok-p">.</span><span class="tok-nx">profile</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span> <span class="tok-nx">millis</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-nx">$gt</span> <span class="tok-o">:</span> <span class="tok-mi">1000</span> <span class="tok-p">}</span> <span class="tok-p">}).</span><span class="tok-nx">sort</span><span class="tok-p">({</span><span class="tok-nx">ts</span> <span class="tok-o">:</span> <span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">})</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">system</span><span class="tok-p">.</span><span class="tok-nx">profile</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">().</span><span class="tok-nx">limit</span><span class="tok-p">(</span><span class="tok-mi">10</span><span class="tok-p">).</span><span class="tok-nx">sort</span><span class="tok-p">(</span> <span class="tok-p">{</span> <span class="tok-nx">ts</span> <span class="tok-o">:</span> <span class="tok-o">-</span><span class="tok-mi">1</span> <span class="tok-p">}</span> <span class="tok-p">).</span><span class="tok-nx">pretty</span><span class="tok-p">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Dentro de estas consultas algunos campos significativos son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>op</code>: tipo de operación, ya sea <code>command</code>, <code>query</code>, <code>insert</code>, …</p>
</li>
<li>
<p><code>millis</code>: tiempo empleado en la operación</p>
</li>
<li>
<p><code>ts</code>: <em>timestamp</em> de la operación</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Podéis consultar todos los campos disponibles en <a href="http://docs.mongodb.org/manual/reference/database-profiler/" class="bare">http://docs.mongodb.org/manual/reference/database-profiler/</a></p>
</div>
<div class="paragraph">
<p>Otras herramientas para controlar el rendimiento que se ejecutan en un terminal, son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>mongotop</strong> → similar a la herramienta <code>top</code> de UNIX, muestra el tiempo empleado por <em>MongoDB</em> en las diferentes colecciones, indicando tanto el tiempo empleado en lectura como en escrituras.
Para ello, si queremos se ejecute cada tres segundos, en un terminal:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">mongotop 3</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql03/mongotop.jpg" alt="Ejemplo de ejecutar mongotop 3" width="66%">
</div>
<div class="title">Figure 23. Ejemplo de <code>mongotop</code></div>
</div>
<div class="paragraph">
<p>Más información en : <a href="http://docs.mongodb.org/manual/reference/program/mongotop/" class="bare">http://docs.mongodb.org/manual/reference/program/mongotop/</a></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>mongostat</strong> → muestra el número de operaciones por cada tipo que se realizan por segundo a nivel de servidor, lo que nos da una instantánea de los que está haciendo el servidor.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql03/mongostat.jpg" alt="Ejemplo de ejecutar mongostat 5" width="75%">
</div>
<div class="title">Figure 24. Ejemplo de <code>mongostat</code></div>
</div>
<div class="paragraph">
<p>Una buena columna a vigilar es <code>idx miss %</code>, la cual muestra los índices perdidos, es decir, aquellas consultas que han causado paginación y en vez de obtener los datos de memoria han tenido que acceder a disco.</p>
</div>
<div class="paragraph">
<p>Más información en : <a href="http://docs.mongodb.org/manual/reference/program/mongostat/" class="bare">http://docs.mongodb.org/manual/reference/program/mongostat/</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios_3">3.7. Ejercicios</h3>
<div class="sect3">
<h4 id="__1_5_puntos_ejercicio_31_diseñando_el_esquema">3.7.1. (1.5 puntos) Ejercicio 31. Diseñando el esquema</h4>
<div class="paragraph">
<p>Vamos a realizar el modelo de datos documental de una tienda <em>online</em> que comercializa productos de bricolaje. Para ello, nos interesa almacenar datos de estos productos (nombre, descripción, medidas, peso, pvp, &#8230;&#8203;), y de los pedidos que realizan los clientes. Una vez formalizado un pedido, se le enviará vía mensajería urgente el pedido al domicilio del cliente.</p>
</div>
<div class="paragraph">
<p>De los clientes nos interesa almacenar sus datos personales, datos de contacto (tanto emails como teléfonos), así como las diferentes direcciones que pueda tener asociadas.</p>
</div>
<div class="paragraph">
<p>Del pedido, además de la fecha de realización y de los productos que incluye, el precio total así como la dirección de envío.</p>
</div>
<div class="paragraph">
<p>Para ello, en una base de datos denominada <code>bricomongo</code>, se deben incluir las colecciones necesarias. Cada una de las colecciones debe contener tres o más documentos.</p>
</div>
<div class="paragraph">
<p>Una vez diseñada, creada y tras insertar los datos, se han de exportar las diferentes colecciones mediante <code>mongoexport</code> en archivos denominados <code>ej31-nombreColeccion.json</code>, sustituyendo <code>nombreColeccion</code> por el nombre de las diferentes colecciones que hayas diseñado. Finalmente, se debe exportar toda la base de datos mediante <code>mongodump</code> en un archivo denominado <code>ej31-dump</code></p>
</div>
</div>
<div class="sect3">
<h4 id="__0_75_puntos_ejercicio_32_Índices">3.7.2. (0.75 puntos) Ejercicio 32. Índices</h4>
<div class="paragraph">
<p>En este ejercicio vamos optimizar la base de datos de <code>ejercicios</code> importada en la primera sesión.</p>
</div>
<div class="paragraph">
<p>Las consultas que más se realizan sobre la colección <code>cities</code> son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Recuperar una ciudad por su nombre</p>
</li>
<li>
<p>Recuperar las 5 ciudades más pobladas de un determinado país</p>
</li>
<li>
<p>Recuperar las 3 ciudades menos pobladas de una zona horaria.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Se pide crear los índices adecuados para que estas consultas se ejecuten de manera óptima.</p>
</div>
<div class="paragraph">
<p>Por lo tanto, el archivo <code>ej32.txt</code> debe contener:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>los comandos empleados para comprobar los planes de ejecución antes y después de crear los índices necesarios</p>
</li>
<li>
<p>comandos necesarios para crear los índices elegidos</p>
</li>
<li>
<p>una explicación de la elección del tipo de índice elegido en cada caso.</p>
</li>
<li>
<p>resultado de obtener todos los índices de la colección <code>cities</code> una vez creados todos los índices elegidos</p>
</li>
<li>
<p>tamaño de los índices y requisitos de <em>hardware</em> del servidor necesarios para dar soporte a estos índices</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion04">4. Agregaciones y Escalabilidad</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_agregaciones">4.1. Agregaciones</h3>
<div class="paragraph">
<p>Para poder agrupar datos y realizar cálculos sobre éstos, <em>MongoDB</em> ofrece diferentes alternativas:</p>
</div>
<div class="paragraph">
<p>1.- Mediante operaciones <em>Map-reduce</em> con operación <code>mapreduce()</code> (<a href="http://docs.mongodb.org/manual/core/map-reduce/" class="bare">http://docs.mongodb.org/manual/core/map-reduce/</a>)</p>
</div>
<div class="paragraph">
<p>2.- Mediante operaciones de agrupación sencilla, como pueden ser las operaciones <code>count()</code>, <code>distinct()</code> o <code>group()</code>. Esta última operación permite realizar una serie de cálculos sobre elementos filtrado, de manera similar a <em>Map-reduce</em>, pero más sencillo y limitado, obteniendo un array de elementos agrupados.</p>
</div>
<div class="paragraph">
<p>La firma completa es <code>group({ key, reduce, initial })</code> donde sus parámetros definen:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>key</code>: atributo por el que se van a agrupar los datos</p>
</li>
<li>
<p><code>initial</code>: define un valor base para cada grupo de resultados. Normalmente se inicializa</p>
</li>
<li>
<p><code>reduce</code>: función que agrupa los elementos similar. Recibe dos parámetros, el documento actual (<code>item</code>) sobre el cual se itera, y el objeto contador agregado (<code>prev</code>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Por ejemplo, si quisieramos saber cuantas personas tienen diferente cantidad de hijos y cuantos hay de cada tipo haríamos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">group</span><span class="tok-p">(</span> <span class="tok-p">{</span>
  <span class="tok-nx">key</span><span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-nx">hijos</span><span class="tok-o">:</span> <span class="tok-kc">true</span> <span class="tok-p">},</span>
  <span class="tok-nx">reduce</span><span class="tok-o">:</span> <span class="tok-kd">function</span> <span class="tok-p">(</span> <span class="tok-nx">item</span><span class="tok-p">,</span> <span class="tok-nx">prev</span> <span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nx">prev</span><span class="tok-p">.</span><span class="tok-nx">total</span> <span class="tok-o">+=</span> <span class="tok-mi">1</span><span class="tok-p">;</span>
  <span class="tok-p">},</span>
  <span class="tok-nx">initial</span><span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-nx">total</span> <span class="tok-o">:</span> <span class="tok-mi">0</span> <span class="tok-p">}</span>
<span class="tok-p">}</span> <span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Con lo que obtendríamos (dependiendo de los datos) que hay dos personas que tienen 2 hijos, y una persona que no tiene el atributo hijo definido:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">[</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;hijos&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span> <span class="tok-s2">&quot;total&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span> <span class="tok-p">},</span>
  <span class="tok-p">{</span> <span class="tok-s2">&quot;hijos&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">null</span><span class="tok-p">,</span> <span class="tok-s2">&quot;total&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span> <span class="tok-p">}</span> <span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Hay que destacar que la función <code>group()</code> no funciona en entornos <em>sharded</em>, donde habría que utilizar la función <code>mapreduce()</code> o el framework de agregación.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Podemos ver un ejemplo sencillo en <a href="http://docs.mongodb.org/manual/core/single-purpose-aggregation/#group" class="bare">http://docs.mongodb.org/manual/core/single-purpose-aggregation/#group</a> y más información en <a href="http://docs.mongodb.org/manual/reference/method/db.collection.group" class="bare">http://docs.mongodb.org/manual/reference/method/db.collection.group</a></p>
</div>
<div class="paragraph">
<p>2.- Mediante el uso del <em>Aggregation Framework</em>, basado en el uso de <em>pipelines</em>, el cual permite realizar diversas operaciones sobre los datos. Este framework forma parte de <em>MongoDB</em> desde la versión 2.2, ofrece más posibilidades que la operación <em>group</em> y además permite su uso con <em>sharding</em>.</p>
</div>
<div class="paragraph">
<p>Para ello, a partir de una colección, mediante el método <code>aggregate</code> le pasaremos un array con las fases a realizar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">productos</span><span class="tok-p">.</span><span class="tok-nx">aggregate</span><span class="tok-p">([</span>
  <span class="tok-p">{</span><span class="tok-nx">$group</span><span class="tok-o">:</span>
    <span class="tok-p">{</span><span class="tok-nx">_id</span><span class="tok-o">:</span><span class="tok-s2">&quot;$fabricante&quot;</span><span class="tok-p">,</span> <span class="tok-nx">numProductos</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$sum</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">}}</span>
  <span class="tok-p">},</span>
  <span class="tok-p">{</span><span class="tok-nx">$sort</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-nx">numProductos</span><span class="tok-o">:-</span><span class="tok-mi">1</span><span class="tok-p">}}</span>
<span class="tok-p">])</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="__em_pipeline_em_de_agregación">4.2. <em>Pipeline</em> de agregación</h3>
<div class="paragraph">
<p>Las agregaciones usan un <em>pipeline</em>, conocido como <em>Aggregation Pipeline</em>, de ahí el uso de un array con <code>[</code> <code>]</code> donde cada elemento es una fase del <em>pipeline</em>, de modo que la salida de una fase es la entrada de la siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">coleccion</span><span class="tok-p">.</span><span class="tok-nx">aggregate</span><span class="tok-p">([</span><span class="tok-nx">op1</span><span class="tok-p">,</span> <span class="tok-nx">op2</span><span class="tok-p">,</span> <span class="tok-p">...</span> <span class="tok-nx">opN</span><span class="tok-p">])</span></code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
El resultado del pipeline es un documento y por lo tanto está sujeto a la restricción de BSON, que limita su tamaño a 16MB
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En la siguiente imagen se resumen los pasos de una agrupación donde primero se eligen los elementos que vamos a agrupar mediante <code>$match</code> y posteriormente se agrupan con <code>$group</code> para hacer <code>$sum</code> sobre el total:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql04/aggregation-pipeline.png" alt="Ejemplo de pipeline con $match y $group" width="75%">
</div>
<div class="title">Figure 25. Ejemplo de pipeline con <code>$match</code> y <code>$group</code></div>
</div>
<div class="sect3">
<h4 id="_operadores_del_em_pipeline_em">4.2.1. Operadores del <em>pipeline</em></h4>
<div class="paragraph">
<p>Antes de nada destacar que las fases se pueden repetir, por lo que una consulta puede repetir operadores.</p>
</div>
<div class="paragraph">
<p>Más información en: <a href="http://docs.mongodb.org/manual/reference/operator/aggregation/" class="bare">http://docs.mongodb.org/manual/reference/operator/aggregation/</a></p>
</div>
<div class="paragraph">
<p>A continuación vamos a estudiar todos estos operadores:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 5. Operadores del pipeline</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 60%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Operador</th>
<th class="tableblock halign-left valign-top">Descripción</th>
<th class="tableblock halign-left valign-top">Cardinalidad</th>
</tr>
</thead>
<tbody>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">$project</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Proyección de campos, es decir, propiedades en las que estamos interesados. También nos permite modificar un documento, o crear un subdocumento (<em>reshape</em>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1:1</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">$match</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Filtrado de campos, similar a <em>where</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N:1</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">$group</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Para agrupar los datos, similar a <em>group by</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N:1</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">$sort</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ordenar</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1:1</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">$skip</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Saltar</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N:1</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">$limit</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Limitar los resultados</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N:1</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">$unwind</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Separa los datos que hay dentro de un array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1:N</p></td>
</tr>
</tbody>
</table>
<div class="sidebarblock">
<div class="content">
<div class="title">Preparando los ejemplos</div>
<div class="paragraph">
<p>Para los siguientes ejemplos, vamos a utilizar una colección de productos (<a href="resources/nosql/productos.js">productos.js</a>) de un tienda de electrónica con las características y precios de los mismos.</p>
</div>
<div class="paragraph">
<p>Un ejemplo de un producto sería:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">productos</span><span class="tok-p">.</span><span class="tok-nx">findOne</span><span class="tok-p">()</span>
<span class="tok-p">{</span>
	<span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;5345afc1176f38ea4eda4787&quot;</span><span class="tok-p">),</span>
	<span class="tok-s2">&quot;nombre&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;iPad 16GB Wifi&quot;</span><span class="tok-p">,</span>
	<span class="tok-s2">&quot;fabricante&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Apple&quot;</span><span class="tok-p">,</span>
	<span class="tok-s2">&quot;categoria&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Tablets&quot;</span><span class="tok-p">,</span>
	<span class="tok-s2">&quot;precio&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">499</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para cargar este archivo desde la consola podemos realizar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">mongo &lt; productos.js</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="__code_group_code">4.2.2. <code>$group</code></h4>
<div class="paragraph">
<p>Agrupa los documentos con el propósito de calcular valores agregrados de una colección de documentos. Por ejemplo, podemos usar <code>$group</code> para calcular la media de páginas visitas de manera diaria.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
La salida de $group esta desordenada
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La salida de <code>$group</code> depende de como se definan los grupos. Se empieza especificando un identificador (por ejemplo, un campo <code>_id</code>) para el grupo que creamos con el pipeline. Para este campo <code>_id</code>, podemos especificar varias expresiones, incluyendo un único campo proveniente de un documento del pipeline, un valor calculado de una fase anterior, un documento con muchos campos y otras expresiones válidas, tales como constantes o campos de subdocumentos. También podemos usar operadores de <code>$project</code> para el campo <code>_id</code>.</p>
</div>
<div class="paragraph">
<p>Cuando referenciemos al valor de un campo lo haremos poniendo entre comillas un <code>$</code> delante del nombre del campo. Así pues, para referenciar al fabricante de un producto lo haremos mediante <code>$fabricante</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">productos</span><span class="tok-p">.</span><span class="tok-nx">aggregate</span><span class="tok-p">([{</span><span class="tok-nx">$group</span><span class="tok-o">:</span>
  <span class="tok-p">{</span>
    <span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-s2">&quot;$fabricante&quot;</span><span class="tok-p">,</span>
    <span class="tok-nx">total</span><span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-nx">$sum</span><span class="tok-o">:</span><span class="tok-mi">1</span> <span class="tok-p">}</span>
  <span class="tok-p">}</span>
<span class="tok-p">}])</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Sony&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;total&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Amazon&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;total&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Google&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;total&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Samsung&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;total&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Apple&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;total&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">4</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si lo que queremos es que el valor del identificador contenga un objeto, lo podemos hacer asociandolo como valor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">productos</span><span class="tok-p">.</span><span class="tok-nx">aggregate</span><span class="tok-p">([{</span><span class="tok-nx">$group</span><span class="tok-o">:</span>
  <span class="tok-p">{</span>
    <span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;empresa&quot;</span><span class="tok-o">:</span> <span class="tok-s2">&quot;$fabricante&quot;</span> <span class="tok-p">},</span>
    <span class="tok-nx">total</span><span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-nx">$sum</span><span class="tok-o">:</span><span class="tok-mi">1</span> <span class="tok-p">}</span>
  <span class="tok-p">}</span>
<span class="tok-p">}])</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;empresa&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Amazon&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;total&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;empresa&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Sony&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;total&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;empresa&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Samsung&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;total&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;empresa&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Google&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;total&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;empresa&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Apple&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;total&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">4</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>También podemos agrupar más de un atributo, de tal modo que tengamos un <code>_id</code> compuesto. Por ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">productos</span><span class="tok-p">.</span><span class="tok-nx">aggregate</span><span class="tok-p">([{</span><span class="tok-nx">$group</span><span class="tok-o">:</span>
  <span class="tok-p">{</span>
    <span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-p">{</span>
      <span class="tok-s2">&quot;empresa&quot;</span><span class="tok-o">:</span> <span class="tok-s2">&quot;$fabricante&quot;</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;tipo&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;$categoria&quot;</span> <span class="tok-p">},</span>
    <span class="tok-nx">total</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-nx">$sum</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">}</span>
  <span class="tok-p">}</span>
<span class="tok-p">}])</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;empresa&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Amazon&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;tipo&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Tablets&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;total&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;empresa&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Google&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;tipo&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Tablets&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;total&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;empresa&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Apple&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;tipo&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Portátiles&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;total&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;empresa&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Sony&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;tipo&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Portátiles&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;total&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;empresa&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Samsung&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;tipo&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Tablets&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;total&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;empresa&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Samsung&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;tipo&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Smartphones&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;total&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;empresa&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Apple&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;tipo&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Tablets&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;total&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">3</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Cada expresión de <code>$group</code> <strong>debe</strong> especificar un campo <code>_id</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Además del campo <code>_id</code>, la expresión <code>$group</code> puede incluir campos calculados. Estos otros campos deben utilizar uno de los siguientes acumuladores.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 6. Operadores / Acumuladores de $group</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Nombre</th>
<th class="tableblock halign-left valign-top">Descripción</th>
</tr>
</thead>
<tbody>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">$addToSet</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Devuelve un array con todos los valores únicos para los campos seleccionados entre cada documento del grupo (sin repeticiones)</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">$first</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Devuelve el primer valor del grupo. Se suele usar después de ordenar.</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">$last</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Devuelve el último valor del grupo. Se suele usar después de ordenar.</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">$max</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Devuelve el mayor valor de un grupo</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">$min</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Devuelve el menor valor de un grupo.</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">$avg</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Devuelve el promedio de todos los valores de un grupo</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">$push</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Devuelve un array con todos los valores del campo seleccionado entre cada documento del grupo (puede haber repeticiones)</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">$sum</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Devuelve la suma de todos los valores del grupo</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>A continuación vamos a ver ejemplos de cada uno de estos acumuladores.</p>
</div>
<div class="sect4">
<h5 id="__code_sum_code"><code>$sum</code></h5>
<div class="paragraph">
<p>El operador <code>$sum</code> acumula los valores y devuelve la suma.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, para obtener el montante total de los prodyctos agrupados por fabricante, haríamos:</p>
</div>
<div class="listingblock">
<div class="title">Agrupación con <code>$sum</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">productos</span><span class="tok-p">.</span><span class="tok-nx">aggregate</span><span class="tok-p">([{</span>
  <span class="tok-nx">$group</span><span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-p">{</span>
      <span class="tok-s2">&quot;empresa&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;$fabricante&quot;</span>
    <span class="tok-p">},</span>
    <span class="tok-nx">totalPrecio</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-nx">$sum</span><span class="tok-o">:</span><span class="tok-s2">&quot;$precio&quot;</span><span class="tok-p">}</span>
  <span class="tok-p">}</span>
<span class="tok-p">}])</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;empresa&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Amazon&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;totalPrecio&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">328</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;empresa&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Sony&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;totalPrecio&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">499</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;empresa&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Samsung&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;totalPrecio&quot;</span> <span class="tok-o">:</span> <span class="tok-mf">1014.98</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;empresa&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Google&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;totalPrecio&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">199</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;empresa&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Apple&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;totalPrecio&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2296</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="__code_avg_code"><code>$avg</code></h5>
<div class="paragraph">
<p>Mediante <code>$avg</code> podemos obtener el promedio de los valores de un campo numérico.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, para obtener el precio medio de los productos agrupados por categoría, haríamos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">productos</span><span class="tok-p">.</span><span class="tok-nx">aggregate</span><span class="tok-p">([{</span>
  <span class="tok-nx">$group</span><span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-p">{</span>
      <span class="tok-s2">&quot;categoria&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;$categoria&quot;</span>
    <span class="tok-p">},</span>
    <span class="tok-nx">precioMedio</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-nx">$avg</span><span class="tok-o">:</span><span class="tok-s2">&quot;$precio&quot;</span><span class="tok-p">}</span>
  <span class="tok-p">}</span>
<span class="tok-p">}])</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;categoria&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Portátiles&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;precioMedio&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">499</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;categoria&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Smartphones&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;precioMedio&quot;</span> <span class="tok-o">:</span> <span class="tok-mf">563.99</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;categoria&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Tablets&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;precioMedio&quot;</span> <span class="tok-o">:</span> <span class="tok-mf">396.4271428571428</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="__code_addtoset_code"><code>$addToSet</code></h5>
<div class="paragraph">
<p>Mediante <code>addToSet</code> obtendremos un array con todos los valores únicos para los campos seleccionados entre cada documento del grupo (sin repeticiones).</p>
</div>
<div class="paragraph">
<p>Por ejemplo, para obtener para cada empresa las categorías en las que tienen productos, haríamos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">productos</span><span class="tok-p">.</span><span class="tok-nx">aggregate</span><span class="tok-p">([{</span>
  <span class="tok-nx">$group</span><span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-p">{</span>
     <span class="tok-s2">&quot;fabricante&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;$fabricante&quot;</span>
    <span class="tok-p">},</span>
    <span class="tok-nx">categorias</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-nx">$addToSet</span><span class="tok-o">:</span><span class="tok-s2">&quot;$categoria&quot;</span><span class="tok-p">}</span>
  <span class="tok-p">}</span>
<span class="tok-p">}])</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;fabricante&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Amazon&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;categorias&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span> <span class="tok-s2">&quot;Tablets&quot;</span> <span class="tok-p">]</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;fabricante&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Sony&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;categorias&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span> <span class="tok-s2">&quot;Portátiles&quot;</span> <span class="tok-p">]</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;fabricante&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Samsung&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;categorias&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span> <span class="tok-s2">&quot;Tablets&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;Smartphones&quot;</span> <span class="tok-p">]</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;fabricante&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Google&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;categorias&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span> <span class="tok-s2">&quot;Tablets&quot;</span> <span class="tok-p">]</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;fabricante&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Apple&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;categorias&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span> <span class="tok-s2">&quot;Portátiles&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;Tablets&quot;</span> <span class="tok-p">]</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="__code_push_code"><code>$push</code></h5>
<div class="paragraph">
<p>Mediante <code>$push</code> también obtendremos un array con todos los valores para los campos seleccionados entre cada documento del grupo, pero con repeticiones. Es decir, funciona de manera similar a <code>$addToSet</code> pero permitiendo elementos repetidos.</p>
</div>
<div class="paragraph">
<p>Por ello, si reescribimos la consulta anterior pero haciendo uso de <code>$push</code> obtendremos categorías repetidas:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">productos</span><span class="tok-p">.</span><span class="tok-nx">aggregate</span><span class="tok-p">([{</span>
  <span class="tok-nx">$group</span><span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-p">{</span>
      <span class="tok-s2">&quot;empresa&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;$fabricante&quot;</span>
    <span class="tok-p">},</span>
    <span class="tok-nx">categorias</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-nx">$push</span><span class="tok-o">:</span><span class="tok-s2">&quot;$categoria&quot;</span><span class="tok-p">}</span>
  <span class="tok-p">}</span>
<span class="tok-p">}])</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-s2">&quot;empresa&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Amazon&quot;</span><span class="tok-p">},</span> <span class="tok-s2">&quot;categorias&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span><span class="tok-s2">&quot;Tablets&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;Tablets&quot;</span><span class="tok-p">]</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-s2">&quot;empresa&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Sony&quot;</span><span class="tok-p">},</span> <span class="tok-s2">&quot;categorias&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span><span class="tok-s2">&quot;Portátiles&quot;</span><span class="tok-p">]</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-s2">&quot;empresa&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Samsung&quot;</span><span class="tok-p">},</span> <span class="tok-s2">&quot;categorias&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span><span class="tok-s2">&quot;Smartphones&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;Tablets&quot;</span><span class="tok-p">]</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-s2">&quot;empresa&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Google&quot;</span><span class="tok-p">},</span> <span class="tok-s2">&quot;categorias&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span><span class="tok-s2">&quot;Tablets&quot;</span><span class="tok-p">]</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-s2">&quot;empresa&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Apple&quot;</span><span class="tok-p">},</span> <span class="tok-s2">&quot;categorias&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span><span class="tok-s2">&quot;Tablets&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;Tablets&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;Tablets&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;Portátiles&quot;</span><span class="tok-p">]</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="__code_max_code_y_code_min_code"><code>$max</code> y <code>$min</code></h5>
<div class="paragraph">
<p>Los operadores <code>$max</code> y <code>$min</code> permiten obtener el mayor y el menor valor, respectivamente, del campo por el que se agrupan los documentos.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, para obtener el precio del producto más caro que tiene cada empresa haríamos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">productos</span><span class="tok-p">.</span><span class="tok-nx">aggregate</span><span class="tok-p">([{</span>
  <span class="tok-nx">$group</span><span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-p">{</span>
      <span class="tok-s2">&quot;empresa&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;$fabricante&quot;</span>
    <span class="tok-p">},</span>
    <span class="tok-nx">precioMaximo</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-nx">$max</span><span class="tok-o">:</span><span class="tok-s2">&quot;$precio&quot;</span><span class="tok-p">},</span>
    <span class="tok-nx">precioMinimo</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-nx">$min</span><span class="tok-o">:</span><span class="tok-s2">&quot;$precio&quot;</span><span class="tok-p">},</span>
  <span class="tok-p">}</span>
<span class="tok-p">}])</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;empresa&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Amazon&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;precioMaximo&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">199</span><span class="tok-p">,</span> <span class="tok-s2">&quot;precioMinimo&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">129</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;empresa&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Sony&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;precioMaximo&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">499</span><span class="tok-p">,</span> <span class="tok-s2">&quot;precioMinimo&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">499</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;empresa&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Samsung&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;precioMaximo&quot;</span> <span class="tok-o">:</span> <span class="tok-mf">563.99</span><span class="tok-p">,</span> <span class="tok-s2">&quot;precioMinimo&quot;</span> <span class="tok-o">:</span> <span class="tok-mf">450.99</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;empresa&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Google&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;precioMaximo&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">199</span><span class="tok-p">,</span> <span class="tok-s2">&quot;precioMinimo&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">199</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;empresa&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Apple&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;precioMaximo&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">699</span><span class="tok-p">,</span> <span class="tok-s2">&quot;precioMinimo&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">499</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_doble_code_group_code">Doble <code>$group</code></h5>
<div class="paragraph">
<p>Si queremos obtener el resultado de una agrupación podemos aplicar el operador <code>$group</code> sobre otro <code>$group</code>.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, para obtener el precio medio de los precios medios de los tipos de producto por empresa haríamos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">productos</span><span class="tok-p">.</span><span class="tok-nx">aggregate</span><span class="tok-p">([</span>
  <span class="tok-p">{</span><span class="tok-nx">$group</span><span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-p">{</span>
      <span class="tok-s2">&quot;empresa&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;$fabricante&quot;</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;categoria&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;$categoria&quot;</span>
      <span class="tok-p">},</span>
    <span class="tok-nx">precioMedio</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-nx">$avg</span><span class="tok-o">:</span><span class="tok-s2">&quot;$precio&quot;</span><span class="tok-p">}</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-p">}</span>
  <span class="tok-p">},</span>
  <span class="tok-p">{</span><span class="tok-nx">$group</span><span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-s2">&quot;$_id.empresa&quot;</span><span class="tok-p">,</span>
    <span class="tok-nx">precioMedio</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-nx">$avg</span><span class="tok-o">:</span> <span class="tok-s2">&quot;$precioMedio&quot;</span><span class="tok-p">}</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-p">}</span>
  <span class="tok-p">}</span>
<span class="tok-p">])</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Samsung&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;precioMedio&quot;</span> <span class="tok-o">:</span> <span class="tok-mf">507.49</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Sony&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;precioMedio&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">499</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Apple&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;precioMedio&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">549</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Google&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;precioMedio&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">199</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Amazon&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;precioMedio&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">164</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Precio medio por empresa y categoría</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Precio medio por empresa en base al precio medio anterior</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="__code_first_code_y_code_last_code"><code>$first</code> y <code>$last</code></h5>
<div class="paragraph">
<p>Estos operadores devuelven el valor resultante de aplicar la expresión al primer/último elemento de un grupo de elementos que comparten el mismo grupo por clave.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, para obtener para cada empresa, cual es el tipo de producto que más tiene y la cantidad de dicho tipo haríamos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">productos</span><span class="tok-p">.</span><span class="tok-nx">aggregate</span><span class="tok-p">([</span>
  <span class="tok-p">{</span><span class="tok-nx">$group</span><span class="tok-o">:</span> <span class="tok-p">{</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-p">{</span>
      <span class="tok-s2">&quot;empresa&quot;</span><span class="tok-o">:</span> <span class="tok-s2">&quot;$fabricante&quot;</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;tipo&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;$categoria&quot;</span> <span class="tok-p">},</span>
    <span class="tok-nx">total</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-nx">$sum</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">}</span>
    <span class="tok-p">}</span>
  <span class="tok-p">},</span>
  <span class="tok-p">{</span><span class="tok-nx">$sort</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-s2">&quot;total&quot;</span><span class="tok-o">:-</span><span class="tok-mi">1</span><span class="tok-p">}},</span>
  <span class="tok-p">{</span><span class="tok-nx">$group</span><span class="tok-o">:</span> <span class="tok-p">{</span>
      <span class="tok-nx">_id</span><span class="tok-o">:</span><span class="tok-s2">&quot;$_id.empresa&quot;</span><span class="tok-p">,</span>
      <span class="tok-nx">producto</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-nx">$first</span><span class="tok-o">:</span> <span class="tok-s2">&quot;$_id.tipo&quot;</span>  <i class="conum" data-value="2"></i><b>(2)</b>
      <span class="tok-p">},</span>
      <span class="tok-nx">cantidad</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-nx">$first</span><span class="tok-o">:</span><span class="tok-s2">&quot;$total&quot;</span><span class="tok-p">}</span>
    <span class="tok-p">}</span>
  <span class="tok-p">}</span>
<span class="tok-p">])</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Samsung&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;producto&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Tablets&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;cantidad&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Sony&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;producto&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Portátiles&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;cantidad&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Amazon&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;producto&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Tablets&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;cantidad&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Google&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;producto&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Tablets&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;cantidad&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Apple&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;producto&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Tablets&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;cantidad&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">3</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Agrupamos por empresa y categoría de producto</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Al agrupar por empresa, elegimos la categoría producto que tiene más unidades</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Más información en <a href="http://docs.mongodb.org/manual/reference/operator/aggregation/first/" class="bare">http://docs.mongodb.org/manual/reference/operator/aggregation/first/</a> y <a href="http://docs.mongodb.org/manual/reference/operator/aggregation/last/" class="bare">http://docs.mongodb.org/manual/reference/operator/aggregation/last/</a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="__code_project_code">4.2.3. <code>$project</code></h4>
<div class="paragraph">
<p>Si queremos realizar una proyección sobre el conjunto de resultados y quedarnos con un subconjunto de los campos usaremos el operador <code>$project</code>. Como resultado obtendremos el mismo número de documentos, y en el orden indicado en la proyección.</p>
</div>
<div class="paragraph">
<p>La proyección dentro del <em>framework</em> de agregación es mucho más potente que dentro de las consultas normales. Se emplea para:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>renombrar campos.</p>
</li>
<li>
<p>introducir campos calculados en el documento resultante, mediante <code>$add</code>, <code>$substract</code>, <code>$multiply</code>, <code>$divide</code> o <code>$mod</code></p>
</li>
<li>
<p>transformar campos a mayúsculas <code>$toUpper</code> o minúsculas <code>$toLower</code>, concatenar campos mediante <code>$concat</code> u obtener subcadenas con <code>$substr</code>.</p>
</li>
<li>
<p>transformar campos en base a valores obtenidos a partir de una condición mediante expresiones lógicas con los operadores de comparación vistos en las consultas.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">productos</span><span class="tok-p">.</span><span class="tok-nx">aggregate</span><span class="tok-p">([</span>
  <span class="tok-p">{</span><span class="tok-nx">$project</span><span class="tok-o">:</span>
    <span class="tok-p">{</span>
      <span class="tok-nx">_id</span><span class="tok-o">:</span><span class="tok-mi">0</span><span class="tok-p">,</span>
      <span class="tok-s1">&#39;empresa&#39;</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-nx">$toUpper</span><span class="tok-o">:</span><span class="tok-s2">&quot;$fabricante&quot;</span><span class="tok-p">},</span>  <i class="conum" data-value="1"></i><b>(1)</b>
      <span class="tok-s1">&#39;detalles&#39;</span><span class="tok-o">:</span> <span class="tok-p">{</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-s1">&#39;categoria&#39;</span><span class="tok-o">:</span> <span class="tok-s2">&quot;$categoria&quot;</span><span class="tok-p">,</span>
        <span class="tok-s1">&#39;precio&#39;</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-s2">&quot;$multiply&quot;</span><span class="tok-o">:</span> <span class="tok-p">[</span><span class="tok-s2">&quot;$precio&quot;</span><span class="tok-p">,</span> <span class="tok-mf">1.1</span><span class="tok-p">]}</span>  <i class="conum" data-value="3"></i><b>(3)</b>
      <span class="tok-p">},</span>
      <span class="tok-s1">&#39;elemento&#39;</span><span class="tok-o">:</span><span class="tok-s1">&#39;$nombre&#39;</span>  <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="tok-p">}</span>
  <span class="tok-p">}</span>
<span class="tok-p">])</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;empresa&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;APPLE&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;detalles&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;categoria&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Tablets&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;precio&quot;</span> <span class="tok-o">:</span> <span class="tok-mf">548.9000000000001</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;elemento&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;iPad 16GB Wifi&quot;</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;empresa&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;APPLE&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;detalles&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;categoria&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Tablets&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;precio&quot;</span> <span class="tok-o">:</span> <span class="tok-mf">658.9000000000001</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;elemento&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;iPad 32GB Wifi&quot;</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Transforma un campo y lo pasa a mayúsculas</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Crea un documento anidado</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Incrementa el precio el 10%</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Renombra el campo</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Más información en <a href="http://docs.mongodb.org/manual/reference/operator/aggregation/project/" class="bare">http://docs.mongodb.org/manual/reference/operator/aggregation/project/</a></p>
</div>
</div>
<div class="sect3">
<h4 id="__code_match_code">4.2.4. <code>$match</code></h4>
<div class="paragraph">
<p>Se utiliza principalmente para filtrar los documentos que pasarán a la siguiente etapa del <em>pipeline</em> o a la salida final.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, para seleccionar sólo las tabletas haríamos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">productos</span><span class="tok-p">.</span><span class="tok-nx">aggregate</span><span class="tok-p">([{</span><span class="tok-nx">$match</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">categoria</span><span class="tok-o">:</span><span class="tok-s2">&quot;Tablets&quot;</span><span class="tok-p">}}])</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Aparte de igualar un valor a un campo, podemos emplear los operadores usuales de consulta, como <code>$gt</code>, <code>$lt</code>, <code>$in</code>, etc&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Se recomienda poner el operador <code>match</code> al principio del <em>pipeline</em> para limitar los documentos a procesar en siguientess fases. Si usamos este operador como primera fase podremos hacer uso de los indices de la colección de una manera eficiente.</p>
</div>
<div class="paragraph">
<p>Así pues, para obtener la cantidad de <em>Tablets</em> de menos de 500 euros haríamos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">productos</span><span class="tok-p">.</span><span class="tok-nx">aggregate</span><span class="tok-p">([</span>
  <span class="tok-p">{</span><span class="tok-nx">$match</span><span class="tok-o">:</span>
    <span class="tok-p">{</span><span class="tok-nx">categoria</span><span class="tok-o">:</span><span class="tok-s2">&quot;Tablets&quot;</span><span class="tok-p">,</span>
    <span class="tok-nx">precio</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-nx">$lt</span><span class="tok-o">:</span> <span class="tok-mi">500</span><span class="tok-p">}}},</span>
  <span class="tok-p">{</span><span class="tok-nx">$group</span><span class="tok-o">:</span>
    <span class="tok-p">{</span><span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-s2">&quot;empresa&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;$fabricante&quot;</span><span class="tok-p">},</span>
    <span class="tok-nx">cantidad</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-nx">$sum</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">}}</span>
  <span class="tok-p">}]</span>
<span class="tok-p">)</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;empresa&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Amazon&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;cantidad&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;empresa&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Samsung&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;cantidad&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;empresa&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Google&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;cantidad&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;empresa&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Apple&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;cantidad&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Más información en <a href="http://docs.mongodb.org/manual/reference/operator/aggregation/match/" class="bare">http://docs.mongodb.org/manual/reference/operator/aggregation/match/</a></p>
</div>
</div>
<div class="sect3">
<h4 id="__code_sort_code">4.2.5. <code>$sort</code></h4>
<div class="paragraph">
<p>El operador <code>$sort</code> ordena los documentos recibidos por el campo y el orden indicado por la expresión indicada al <em>pipeline</em>.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, para ordenar los productos por precio descendentemente haríamos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">productos</span><span class="tok-p">.</span><span class="tok-nx">aggregate</span><span class="tok-p">({</span><span class="tok-nx">$sort</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">precio</span><span class="tok-o">:-</span><span class="tok-mi">1</span><span class="tok-p">}})</span></code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
El operador <code>$sort</code> ordena los datos en memoria, por lo que hay que tener cuidado con el tamaño de los datos. Por ello, se emplea en las últimas fases del pipeline, cuando el conjunto de resultados es el menor posible.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si retomamos el ejemplo anterior, y ordenamos los datos por el precio total tenemos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">productos</span><span class="tok-p">.</span><span class="tok-nx">aggregate</span><span class="tok-p">([</span>
  <span class="tok-p">{</span><span class="tok-nx">$match</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">categoria</span><span class="tok-o">:</span><span class="tok-s2">&quot;Tablets&quot;</span><span class="tok-p">}},</span>
  <span class="tok-p">{</span><span class="tok-nx">$group</span><span class="tok-o">:</span>
    <span class="tok-p">{</span><span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-s2">&quot;empresa&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;$fabricante&quot;</span><span class="tok-p">},</span>
    <span class="tok-nx">totalPrecio</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-nx">$sum</span><span class="tok-o">:</span><span class="tok-s2">&quot;$precio&quot;</span><span class="tok-p">}}</span>
  <span class="tok-p">},</span>
  <span class="tok-p">{</span><span class="tok-nx">$sort</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">totalPrecio</span><span class="tok-o">:-</span><span class="tok-mi">1</span><span class="tok-p">}}</span>  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-p">])</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;empresa&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Apple&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;totalPrecio&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1797</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;empresa&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Samsung&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;totalPrecio&quot;</span> <span class="tok-o">:</span> <span class="tok-mf">450.99</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;empresa&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Amazon&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;totalPrecio&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">328</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;empresa&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Google&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;totalPrecio&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">199</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Al ordenar los datos, referenciamos al campo que hemos creado en la fase de <code>$group</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Más información en <a href="http://docs.mongodb.org/manual/reference/operator/aggregation/sort/" class="bare">http://docs.mongodb.org/manual/reference/operator/aggregation/sort/</a></p>
</div>
</div>
<div class="sect3">
<h4 id="__code_skip_code_y_code_limit_code">4.2.6. <code>$skip</code> y <code>$limit</code></h4>
<div class="paragraph">
<p>El operador <code>$limit</code> únicamente limita el número de documentos que pasan a través del <em>pipeline</em>.</p>
</div>
<div class="paragraph">
<p>El operador recibe un número como parámetro:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">productos</span><span class="tok-p">.</span><span class="tok-nx">aggregate</span><span class="tok-p">([{</span><span class="tok-nx">$limit</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-p">}])</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Este operador no modifica los documentos, sólo restringe quien pasa a la siguiente fase.</p>
</div>
<div class="paragraph">
<p>De manera similar, con el operador <code>$skip</code>, saltamos un número determinado de documentos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">productos</span><span class="tok-p">.</span><span class="tok-nx">aggregate</span><span class="tok-p">([{</span><span class="tok-nx">$skip</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-p">}])</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El orden en el que empleemos estos operadores importa, y mucho, ya que no es lo mismo saltar y luego limitar, donde la cantidad de elementos la fija <code>$limit</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">productos</span><span class="tok-p">.</span><span class="tok-nx">aggregate</span><span class="tok-p">([{</span><span class="tok-nx">$skip</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-p">},{</span><span class="tok-nx">$limit</span><span class="tok-o">:</span><span class="tok-mi">4</span><span class="tok-p">}])</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;54ffff889836d613eee9a6e7&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;nombre&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;iPad 64GB Wifi&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;categoria&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Tablets&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;fabricante&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Apple&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;precio&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">699</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;54ffff889836d613eee9a6e8&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;nombre&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Galaxy S3&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;categoria&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Smartphones&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;fabricante&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Samsung&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;precio&quot;</span> <span class="tok-o">:</span> <span class="tok-mf">563.99</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;54ffff889836d613eee9a6e9&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;nombre&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Galaxy Tab 10&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;categoria&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Tablets&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;fabricante&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Samsung&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;precio&quot;</span> <span class="tok-o">:</span> <span class="tok-mf">450.99</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;54ffff889836d613eee9a6ea&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;nombre&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Vaio&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;categoria&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Portátiles&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;fabricante&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Sony&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;precio&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">499</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En cambio, si primero limitamos y luego saltamos, la cantidad de elementos se obtiene de la diferencia entre el límite y el salto:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">productos</span><span class="tok-p">.</span><span class="tok-nx">aggregate</span><span class="tok-p">([{</span><span class="tok-nx">$limit</span><span class="tok-o">:</span><span class="tok-mi">4</span><span class="tok-p">},{</span><span class="tok-nx">$skip</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-p">}])</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;54ffff889836d613eee9a6e7&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;nombre&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;iPad 64GB Wifi&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;categoria&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Tablets&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;fabricante&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Apple&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;precio&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">699</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;54ffff889836d613eee9a6e8&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;nombre&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Galaxy S3&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;categoria&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Smartphones&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;fabricante&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Samsung&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;precio&quot;</span> <span class="tok-o">:</span> <span class="tok-mf">563.99</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Más información en <a href="http://docs.mongodb.org/manual/reference/operator/aggregation/limit/" class="bare">http://docs.mongodb.org/manual/reference/operator/aggregation/limit/</a> y <a href="http://docs.mongodb.org/manual/reference/operator/aggregation/skip/" class="bare">http://docs.mongodb.org/manual/reference/operator/aggregation/skip/</a></p>
</div>
</div>
<div class="sect3">
<h4 id="__code_unwind_code">4.2.7. <code>$unwind</code></h4>
<div class="paragraph">
<p>Este operador es muy interesante y se utiliza solo con operadores array. Al usarlo con un campo array de tamaño N en un documento, lo transforma en N documentos con el campo tomando el valor individual de cada uno de los elementos del array.</p>
</div>
<div class="paragraph">
<p>Si retomamos el ejemplo de la segunda sesión donde actualizabamos una colección de enlaces, teníamos un enlace con la siguiente información:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">enlaces</span><span class="tok-p">.</span><span class="tok-nx">findOne</span><span class="tok-p">()</span>
<span class="tok-p">{</span>
	<span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;54f9769212b1897ae84190cf&quot;</span><span class="tok-p">),</span>
	<span class="tok-s2">&quot;titulo&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;www.google.es&quot;</span><span class="tok-p">,</span>
	<span class="tok-s2">&quot;tags&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span>
		<span class="tok-s2">&quot;mapas&quot;</span><span class="tok-p">,</span>
		<span class="tok-s2">&quot;videos&quot;</span><span class="tok-p">,</span>
		<span class="tok-s2">&quot;blog&quot;</span><span class="tok-p">,</span>
		<span class="tok-s2">&quot;calendario&quot;</span><span class="tok-p">,</span>
		<span class="tok-s2">&quot;email&quot;</span><span class="tok-p">,</span>
		<span class="tok-s2">&quot;mapas&quot;</span>
	<span class="tok-p">]</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos observar como el campo <code>tags</code> contiene 6 valores dentro del array (con un valor repetido). A continuación vamos a <em>desenrollar</em> el array:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">enlaces</span><span class="tok-p">.</span><span class="tok-nx">aggregate</span><span class="tok-p">(</span>
  <span class="tok-p">{</span><span class="tok-nx">$match</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">titulo</span><span class="tok-o">:</span><span class="tok-s2">&quot;www.google.es&quot;</span><span class="tok-p">}},</span>
  <span class="tok-p">{</span><span class="tok-nx">$unwind</span><span class="tok-o">:</span><span class="tok-s2">&quot;$tags&quot;</span><span class="tok-p">})</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;54f9769212b1897ae84190cf&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;titulo&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;www.google.es&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;tags&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;mapas&quot;</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;54f9769212b1897ae84190cf&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;titulo&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;www.google.es&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;tags&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;videos&quot;</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;54f9769212b1897ae84190cf&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;titulo&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;www.google.es&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;tags&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;blog&quot;</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;54f9769212b1897ae84190cf&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;titulo&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;www.google.es&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;tags&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;calendario&quot;</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;54f9769212b1897ae84190cf&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;titulo&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;www.google.es&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;tags&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;email&quot;</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;54f9769212b1897ae84190cf&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;titulo&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;www.google.es&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;tags&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;mapas&quot;</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Así pues hemos obtenido 6 documentos con el mismo <code>_id</code> y <code>titulo</code>, es decir, un documento por elemento del array.</p>
</div>
<div class="paragraph">
<p>De este modo, podemos realizar consultas que sumen/cuenten los elementos del array. Por ejemplo, si queremos obtener las 3 etiquetas que más aparecen en todos los enlaces haríamos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">enlaces</span><span class="tok-p">.</span><span class="tok-nx">aggregate</span><span class="tok-p">([</span>
  <span class="tok-p">{</span><span class="tok-s2">&quot;$unwind&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;$tags&quot;</span><span class="tok-p">},</span>
  <span class="tok-p">{</span><span class="tok-s2">&quot;$group&quot;</span><span class="tok-o">:</span>
   <span class="tok-p">{</span><span class="tok-s2">&quot;_id&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;$tags&quot;</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;total&quot;</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$sum</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">}</span>
   <span class="tok-p">}</span>
  <span class="tok-p">},</span>
  <span class="tok-p">{</span><span class="tok-s2">&quot;$sort&quot;</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-s2">&quot;total&quot;</span><span class="tok-o">:-</span><span class="tok-mi">1</span><span class="tok-p">}},</span>
  <span class="tok-p">{</span><span class="tok-s2">&quot;$limit&quot;</span><span class="tok-o">:</span> <span class="tok-mi">3</span><span class="tok-p">}</span>
<span class="tok-p">])</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;mapas&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;total&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">3</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;email&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;total&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;calendario&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;total&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_doble_code_unwind_code">Doble <code>$unwind</code></h5>
<div class="paragraph">
<p>Si trabajamos con documentos que tienen varios arrays, podemos necesitar desenrollar los dos array. Al hacer un doble <code>unwind</code> se crea un producto cartesiano entre los elementos de los 2 arrays.</p>
</div>
<div class="paragraph">
<p>Supongamos que tenemos los datos del siguiente inventario de ropa:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">inventario</span><span class="tok-p">.</span><span class="tok-nx">drop</span><span class="tok-p">();</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">inventario</span><span class="tok-p">.</span><span class="tok-nx">insert</span><span class="tok-p">({</span><span class="tok-s1">&#39;nombre&#39;</span><span class="tok-o">:</span><span class="tok-s2">&quot;Camiseta&quot;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;tallas&#39;</span><span class="tok-o">:</span><span class="tok-p">[</span><span class="tok-s2">&quot;S&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;M&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;L&quot;</span><span class="tok-p">],</span> <span class="tok-s1">&#39;colores&#39;</span><span class="tok-o">:</span><span class="tok-p">[</span><span class="tok-s1">&#39;azul&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;blanco&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;naranja&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;rojo&#39;</span><span class="tok-p">]})</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">inventario</span><span class="tok-p">.</span><span class="tok-nx">insert</span><span class="tok-p">({</span><span class="tok-s1">&#39;nombre&#39;</span><span class="tok-o">:</span><span class="tok-s2">&quot;Jersey&quot;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;tallas&#39;</span><span class="tok-o">:</span><span class="tok-p">[</span><span class="tok-s2">&quot;S&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;M&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;L&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;XL&quot;</span><span class="tok-p">],</span> <span class="tok-s1">&#39;colores&#39;</span><span class="tok-o">:</span><span class="tok-p">[</span><span class="tok-s1">&#39;azul&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;negro&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;naranja&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;rojo&#39;</span><span class="tok-p">]})</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">inventario</span><span class="tok-p">.</span><span class="tok-nx">insert</span><span class="tok-p">({</span><span class="tok-s1">&#39;nombre&#39;</span><span class="tok-o">:</span><span class="tok-s2">&quot;Pantalones&quot;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;tallas&#39;</span><span class="tok-o">:</span><span class="tok-p">[</span><span class="tok-s2">&quot;32x32&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;32x30&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;36x32&quot;</span><span class="tok-p">],</span> <span class="tok-s1">&#39;colores&#39;</span><span class="tok-o">:</span><span class="tok-p">[</span><span class="tok-s1">&#39;azul&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;blanco&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;naranja&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;negro&#39;</span><span class="tok-p">]})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para obtener un listado de cantidad de pares talla/color haríamos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">inventario</span><span class="tok-p">.</span><span class="tok-nx">aggregate</span><span class="tok-p">([</span>
  <span class="tok-p">{</span><span class="tok-nx">$unwind</span><span class="tok-o">:</span> <span class="tok-s2">&quot;$tallas&quot;</span><span class="tok-p">},</span>
  <span class="tok-p">{</span><span class="tok-nx">$unwind</span><span class="tok-o">:</span> <span class="tok-s2">&quot;$colores&quot;</span><span class="tok-p">},</span>
  <span class="tok-p">{</span><span class="tok-nx">$group</span><span class="tok-o">:</span>
    <span class="tok-p">{</span> <span class="tok-s1">&#39;_id&#39;</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-s1">&#39;talla&#39;</span><span class="tok-o">:</span> <span class="tok-s1">&#39;$tallas&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;color&#39;</span><span class="tok-o">:</span> <span class="tok-s1">&#39;$colores&#39;</span><span class="tok-p">},</span>
    <span class="tok-s1">&#39;total&#39;</span> <span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-s1">&#39;$sum&#39;</span><span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">}</span>
    <span class="tok-p">}</span>
  <span class="tok-p">}</span>
<span class="tok-p">])</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;talla&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;XL&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;color&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;rojo&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;total&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;talla&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;XL&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;color&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;negro&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;total&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;talla&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;L&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;color&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;negro&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;total&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;talla&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;M&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;color&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;negro&quot;</span> <span class="tok-p">},</span> <span class="tok-s2">&quot;total&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span> <span class="tok-p">}</span>
<span class="tok-p">...</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_de_sql_al_em_pipeline_em_de_agregaciones">4.2.8. De SQL al <em>Pipeline</em> de agregaciones</h4>
<div class="paragraph">
<p>Ya hemos visto que el <em>pipeline</em> ofrece operadores para realizar la misma funcionalidad de agrupación que ofrece SQL.</p>
</div>
<div class="paragraph">
<p>Si relacionamos los comandos SQL con el <em>pipeline</em> de agregaciones tenemos las siguientes equivalencias:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 7. Equivalencia con SQL</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">SQL</th>
<th class="tableblock halign-left valign-top"><em>Pipeline</em> de Agregaciones</th>
</tr>
</thead>
<tbody>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">WHERE</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>$match</code></p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">GROUP BY</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>$group</code></p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">HAVING</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>$match</code></p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">SELECT</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>$project</code></p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">ORDER BY</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>$sort</code></p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">LIMIT</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>$limit</code></p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">SUM()</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>$sum</code></p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">COUNT()</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>$sum</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Podemos encontrar ejemplos de consultas SQL transformadas al <em>pipeline</em> en <a href="http://docs.mongodb.org/manual/reference/sql-aggregation-comparison/" class="bare">http://docs.mongodb.org/manual/reference/sql-aggregation-comparison/</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_limitaciones">4.2.9. Limitaciones</h4>
<div class="paragraph">
<p>Hay que tener en cuenta las siguiente limitaciones:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>En versiones anteriores a la 2.6, el <em>pipeline</em> devolvía en cada fase un objeto BSON, y por tanto, el resultado estaba limitado a 16MB</p>
</li>
<li>
<p>Las fases tienen un límite de 100MB en memoría. Si una fase excede dicho límite, se producirá un error. En este caso, hay que habilitar el uso de disco mediante <code>allowDiskUse</code> en las opciones de la agregación. Más información en <a href="http://docs.mongodb.org/manual/reference/method/db.collection.aggregate" class="bare">http://docs.mongodb.org/manual/reference/method/db.collection.aggregate</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_agregaciones_con_em_java_em">4.3. Agregaciones con <em>Java</em></h3>
<div class="paragraph">
<p>Para realizar agregaciones mediante <em>Java</em> emplearemos el método <code>aggregate(List &lt;DBObject&gt;)</code> el cual accepta una lista con el <em>pipeline</em> de la consulta.</p>
</div>
<div class="paragraph">
<p>Vamos a traducir la siguiente consulta:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span>  <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">productos</span><span class="tok-p">.</span><span class="tok-nx">aggregate</span><span class="tok-p">([</span>
  <span class="tok-p">{</span><span class="tok-nx">$match</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">categoria</span><span class="tok-o">:</span><span class="tok-s2">&quot;Tablets&quot;</span><span class="tok-p">}},</span>
  <span class="tok-p">{</span><span class="tok-nx">$group</span><span class="tok-o">:</span>
    <span class="tok-p">{</span><span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-s2">&quot;empresa&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;$fabricante&quot;</span><span class="tok-p">},</span>
    <span class="tok-nx">totalPrecio</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-nx">$sum</span><span class="tok-o">:</span><span class="tok-s2">&quot;$precio&quot;</span><span class="tok-p">}}</span>
  <span class="tok-p">},</span>
  <span class="tok-p">{</span><span class="tok-nx">$sort</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">totalPrecio</span><span class="tok-o">:-</span><span class="tok-mi">1</span><span class="tok-p">}}</span>
<span class="tok-p">])</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Así pues, una vez conectados a la base de datos correspondiente y a la colección <code>productos</code>, vamos a crear tres objetos (uno por cada fase), y se los pasaremos como una lista al método <code>aggregate()</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">DBObject</span> <span class="tok-n">match</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;$match&quot;</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;categoria&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Tablets&quot;</span><span class="tok-o">));</span>
<span class="tok-n">DBObject</span> <span class="tok-n">group</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;$group&quot;</span><span class="tok-o">,</span>
  <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;_id&quot;</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;empresa&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;$fabricante&quot;</span><span class="tok-o">))</span>
  <span class="tok-o">.</span><span class="tok-na">append</span><span class="tok-o">(</span><span class="tok-s">&quot;totalPrecio&quot;</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;$sum&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;$precio&quot;</span><span class="tok-o">)));</span>
<span class="tok-n">DBObject</span> <span class="tok-n">sort</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;$sort&quot;</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;totaPrecio&quot;</span><span class="tok-o">,</span> <span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-o">));</span>

<span class="tok-n">AggregationOutput</span> <span class="tok-n">output</span> <span class="tok-o">=</span> <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">aggregate</span><span class="tok-o">(</span><span class="tok-n">Arrays</span><span class="tok-o">.</span><span class="tok-na">asList</span><span class="tok-o">(</span><span class="tok-n">match</span><span class="tok-o">,</span> <span class="tok-n">group</span><span class="tok-o">,</span> <span class="tok-n">sort</span><span class="tok-o">));</span>  <i class="conum" data-value="1"></i><b>(1)</b>

<span class="tok-n">Iterable</span><span class="tok-o">&lt;</span><span class="tok-n">DBObject</span><span class="tok-o">&gt;</span> <span class="tok-n">datos</span> <span class="tok-o">=</span> <span class="tok-n">output</span><span class="tok-o">.</span><span class="tok-na">results</span><span class="tok-o">();</span>
<span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">DBObject</span> <span class="tok-n">doc</span> <span class="tok-o">:</span> <span class="tok-n">datos</span><span class="tok-o">)</span> <span class="tok-o">{</span>  <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">doc</span><span class="tok-o">);</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Creamos una lista a partir de los <code>DBObject</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Recorremos el conjunto de datos</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El resultado es un objeto <code>AggregationOutput</code>, el cual contiene el método <code>results()</code> que nos devuelve un iterador el cual podemos recorrer.</p>
</div>
</div>
<div class="sect2">
<h3 id="_replicación_2">4.4. Replicación</h3>
<div class="paragraph">
<p>Un aspecto muy importante de <em>MongoDB</em> es que soporta la replicación de los datos de forma nativa mediante el uso de conjuntos de réplicas.</p>
</div>
<div class="sect3">
<h4 id="_conjunto_de_réplicas">4.4.1. Conjunto de réplicas</h4>
<div class="paragraph">
<p>En <em>MongoDB</em> se replican los datos mediante un conjunto de réplicas. Un <strong>Conjunto de Réplicas</strong> (<em>Replica Set</em>) es un grupo de servidores (nodos <code>mongod</code>) donde hay uno que ejerce la función de <strong>primario</strong> y por tanto recibe las peticiones de los clientes, y el resto de servidores hace de <strong>secundarios</strong>, manteniendo copias de los datos del primario.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql04/replica-set-primary.png" alt="Conjunto de Réplicas" width="50%">
</div>
<div class="title">Figure 26. Conjunto de Réplicas</div>
</div>
<div class="paragraph">
<p>Si el nodo primario se cae, los secundarios eligen un nuevo primario entre ellos mismos, en un proceso que se conoce como votación. La aplicación se conectará al nuevo primario de manera transparente. Cuando el antiguo nodo primario vuelva en sí, será un nuevo nodo secundario.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql04/replica-set-arbiter.png" alt="Arbitraje de un secundario" width="66%">
</div>
<div class="title">Figure 27. Arbitraje de un secundario</div>
</div>
<div class="paragraph">
<p>Al usar replicación, si un servidor se cae, siempre vamos a poder obtener los datos a partir de otros servidores del conjunto. Si los datos de un servidor se dañan o son inaccesibles, podemos crear una nueva copia desde uno de los miembros del conjunto.</p>
</div>
</div>
<div class="sect3">
<h4 id="_elementos_de_un_conjunto_de_réplicas">4.4.2. Elementos de un conjunto de réplicas</h4>
<div class="paragraph">
<p>Los tipos de nodos que podemos encontrar en un conjunto de réplica son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Regular: Es el tipo de nodo más común.</p>
<div class="ulist">
<ul>
<li>
<p><strong>Primario</strong>: Acepta todas las operaciones de escritura de los clientes. Cada conjunto de réplicas tendrá sólo un primario, y como sólo un miembro acepta operaciones de escritura, ofrece consitencia estricta para todas las lecturas realizadas desde él.</p>
</li>
<li>
<p><strong>Secundario</strong>: Los secundarios replican el <em>oplog</em> primario y aplican las operaciones a sus conjuntos de datos. De este modo, los nodos secundarios son un espejo del primario. Si el primario deja de estar disponible, el conjunto de réplica elegirá a un secundario para que sea el nuevo primario, mediante un proceso de votación.</p>
<div class="paragraph">
<p>Por defecto, los clientes realizan las lecturas desde el nodo primario. Sin embargo, los clientes pueden indicar que quieren realizar lecturas desde los nodos secundarios.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Es posible que al realizar lecturas de un nodo secundario la información que se obtenga no refleje el estado del nodo primario.
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Árbitro</strong>: se emplea sólo para votar. No contiene copia de los datos y no se puede convertir en primario. Los conjuntos de réplica pueden tener árbitros para añadir votos en las elecciones de un nuevo primario. Siempre tienen un voto, y permiten que los conjuntos de réplica tengan un número impar de nodos, sin la necesidad de tener un miembro que replique los datos. Además, no requieren hardware dedicado.</p>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>No ejecutar un árbitro en sistemas que también ejecutan los miembros primarios y secundarios del conjunto de réplicas.</p>
</div>
<div class="paragraph">
<p>Sólo añadir un árbitro a un conjunto con un número par de miembros.</p>
</div>
<div class="paragraph">
<p>Si se añade un árbitro a un conjunto con un número impar de miembros, el conjunto puede sufrir un empate.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Retrasado (<em>delayed</em>): nodo que se emplea para la recuperación del sistema ante un fallo. Para ello, hay que asignar la propiedad <code>priority:0</code>. Este nodo nunca será un nodo primario.</p>
</li>
<li>
<p>Oculto: empleado para analíticas del sistema.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_oplog">oplog</h5>
<div class="paragraph">
<p>Para soportar la replicación, el nodo primario almacena todos los cambios en su <strong><em>oplog</em></strong>.</p>
</div>
<div class="paragraph">
<p>De manera simplificada, el <em>oplog</em> es un diario de todos los cambios que la instancia principal realiza en las bases de datos con el propósito de replicar dichos cambios en un nodo secundario para asegurar que las dos bases de datos sean idénticas.</p>
</div>
<div class="paragraph">
<p>El servidor principal mantiene el <em>oplog</em>, y el secundario consulta al principal por nuevas entradas que aplicar a sus propias copias de las bases de datos replicadas.</p>
</div>
<div class="paragraph">
<p>El <em>oplog</em> crea un <em>timestamp</em> para cada entrada. Esto permite que un secundario controle la cantidad de información que se ha modificado desde una lectura anterior, y qué entradas necesita transferir para ponerse al día. Si paramos un secundario y lo reiniciamos más adelante, utilizará el <em>oplog</em> para obtener todos los cambios que ha perdido mientras estaba <em>offline</em>.</p>
</div>
<div class="paragraph">
<p>El <em>oplog</em> se almacena en una colección limitada (<em>capped</em>) y ordenada de un tamaño determinado. La opción <code>oplogSize</code> define en MB el tamaño del archivo. Para un sistema de 64 bits con comportamiento de lectura/escritura normales, el <code>oplogSize</code> debería ser de al menos un 5% del espacio de disco disponible. Si el sistema tiene más escrituras que lecturas, puede que necesitemos incrementar este tamaño para asegurar que cualquier nodo secundario pueda estar <em>offline</em> una cantidad de tiempo razonable sin perder información.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Más información de <em>oplog</em> en <a href="http://docs.mongodb.org/manual/core/replica-set-oplog/" class="bare">http://docs.mongodb.org/manual/core/replica-set-oplog/</a>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_creando_un_conjunto_de_réplicas">4.4.3. Creando un conjunto de réplicas</h4>
<div class="paragraph">
<p>A la hora de lanzar una instancia, podemos indicarle mediante parámetros opcionales la siguiente información:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>--dbpath</code>: ruta de la base de datos</p>
</li>
<li>
<p><code>--port</code>: puerto de la base de datos</p>
</li>
<li>
<p><code>--replSet</code>: nombre del conjunto de réplicas</p>
</li>
<li>
<p><code>-–fork</code>: indica que se tiene que crear en un hilo</p>
</li>
<li>
<p><code>--logpath</code>: ruta para almacenar los archivos de <em>log</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Normalmente, cada instancia <code>mongod</code> se coloca en un servidor físico y todos en el puerto estándar.</p>
</div>
<div class="paragraph">
<p>Como ejemplo vamos a crear un conjunto de tres réplicas. Para ello, arrancaremos tres instancias distintas pero que comparten el mismo conjunto de réplicas. Además, en vez de hacerlo en tres máquinas distinas, lo haremos en tres puertos diferentes:</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Las carpeta que se crean tienen que tener los mismos permisos que <code>mongod</code>. Si no existiesen, las tenemos que crear previamente.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Script de creación del conjunto de réplicas - (<a href="resources/nosql/creaConjuntoReplicas.sh">creaConjuntoReplicas.sh</a>)</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span class="tok-c">#!/bin/bash</span>
mkdir -p /data/db/rs1 /data/db/rs2 /data/db/rs3 /data/logs
mongod --replSet replicaExperto --logpath /data/logs/rs1.log --dbpath /data/db/rs1 --port <span class="tok-m">27017</span> --oplogSize <span class="tok-m">64</span> --smallfiles --fork
mongod --replSet replicaExperto --logpath /data/logs/rs2.log --dbpath /data/db/rs2 --port <span class="tok-m">27018</span> --oplogSize <span class="tok-m">64</span> --smallfiles --fork
mongod --replSet replicaExperto --logpath /data/logs/rs3.log --dbpath /data/db/rs3 --port <span class="tok-m">27019</span> --oplogSize <span class="tok-m">64</span> --smallfiles --fork</code></pre>
</div>
</div>
<div class="paragraph">
<p>Y lo lanzamos desde el shell mediante:</p>
</div>
<div class="listingblock">
<div class="title">Lanzando la creación de la réplica</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">bash &lt; creaConjuntoReplicas.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>Al lanzar el <em>script</em>, realmente estamos creando las réplicas, por lo que obtendremos que ha creado hijos y que esta a la espera de conexiones:</p>
</div>
<div class="listingblock">
<div class="title">Resultado de crear el conjunto de replicas</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">about to fork child process, waiting <span class="tok-k">until</span> server is ready <span class="tok-k">for</span> connections.
forked process: 1811
child process started successfully, parent exiting
about to fork child process, waiting <span class="tok-k">until</span> server is ready <span class="tok-k">for</span> connections.
forked process: 1814
child process started successfully, parent exiting
about to fork child process, waiting <span class="tok-k">until</span> server is ready <span class="tok-k">for</span> connections.
forked process: 1817
child process started successfully, parent exiting</code></pre>
</div>
</div>
<div class="paragraph">
<p>Una vez lanzados las tres réplicas, tenemos que enlazarlas.</p>
</div>
<div class="paragraph">
<p>Así pues, nos conectaremos al <em>shell</em> de <code>mongo</code>. Puede ser que necesitemos indicar que nos conectamos al puerto adecuado:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">mongo --port 27017</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para comprobar su estado emplearemos el comando <code>rs.status()</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">rs</span><span class="tok-p">.</span><span class="tok-nx">status</span><span class="tok-p">()</span>
<span class="tok-p">{</span>
  <span class="tok-s2">&quot;startupStatus&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">3</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;info&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;run rs.initiate(...) if not yet done for the set&quot;</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;ok&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">0</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;errmsg&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;can&#39;t get local.system.replset config from self or any seed (EMPTYCONFIG)&quot;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Dentro del <em>shell</em> de <code>mongo</code>, los comandos que trabajan con réplicas comienzan por el prefijo <code>rs.</code>. Mediante <code>rs.help()</code> obtendremos la ayuda de los métodos disponibles,
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A continuación, crearemos un documento con la configuración donde el <code>_id</code> tiene que ser igual al usado al crear la réplica, y el array de <code>members</code> contiene las replicas creadas donde los puertos han de coincidir.</p>
</div>
<div class="listingblock">
<div class="title">Configurando el conjunto de réplicas</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">config</span> <span class="tok-o">=</span> <span class="tok-p">{</span> <span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-s2">&quot;replicaExperto&quot;</span><span class="tok-p">,</span> <span class="tok-nx">members</span><span class="tok-o">:</span><span class="tok-p">[</span>
  <span class="tok-p">{</span> <span class="tok-nx">_id</span> <span class="tok-o">:</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-nx">host</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;localhost:27017&quot;</span><span class="tok-p">},</span>
  <span class="tok-p">{</span> <span class="tok-nx">_id</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-nx">host</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;localhost:27018&quot;</span><span class="tok-p">},</span>
  <span class="tok-p">{</span> <span class="tok-nx">_id</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span> <span class="tok-nx">host</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;localhost:27019&quot;</span><span class="tok-p">}</span>
<span class="tok-p">]};</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Si en los miembros ponemos <code>slaveDelay: numSeg</code> podemos retrasar un nodo respecto al resto (también deberemos indicar que <code>priority : 0</code> para que no sea un nodo principal). Más información en <a href="http://docs.mongodb.org/manual/core/replica-set-delayed-member/" class="bare">http://docs.mongodb.org/manual/core/replica-set-delayed-member/</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Tras crear el documento de configuración, podemos iniciar el conjunto mediante:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">rs</span><span class="tok-p">.</span><span class="tok-nx">initiate</span><span class="tok-p">(</span><span class="tok-nx">config</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-s2">&quot;info&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Config now saved locally.  Should come online in about a minute.&quot;</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;ok&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si ahora volvemos a consultar el estado de la réplica tendremos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">replicaExperto</span><span class="tok-o">:</span><span class="tok-nx">PRIMARY</span><span class="tok-o">&gt;</span> <span class="tok-nx">rs</span><span class="tok-p">.</span><span class="tok-nx">status</span><span class="tok-p">()</span>
<span class="tok-p">{</span>
  <span class="tok-s2">&quot;set&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;replicaExperto&quot;</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;date&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ISODate</span><span class="tok-p">(</span><span class="tok-s2">&quot;2016-02-09T17:57:52.273Z&quot;</span><span class="tok-p">),</span>
  <span class="tok-s2">&quot;myState&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;term&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">NumberLong</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">),</span>
  <span class="tok-s2">&quot;heartbeatIntervalMillis&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">NumberLong</span><span class="tok-p">(</span><span class="tok-mi">2000</span><span class="tok-p">),</span>
  <span class="tok-s2">&quot;members&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span>
  	<span class="tok-p">{</span>
      <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">0</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;name&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;localhost:27017&quot;</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;health&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;state&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;stateStr&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;PRIMARY&quot;</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;uptime&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">89</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;optime&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
        <span class="tok-s2">&quot;ts&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">Timestamp</span><span class="tok-p">(</span><span class="tok-mi">1455040665</span><span class="tok-p">,</span> <span class="tok-mi">2</span><span class="tok-p">),</span>
        <span class="tok-s2">&quot;t&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">NumberLong</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">)</span>
      <span class="tok-p">},</span>
      <span class="tok-s2">&quot;optimeDate&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ISODate</span><span class="tok-p">(</span><span class="tok-s2">&quot;2016-02-09T17:57:45Z&quot;</span><span class="tok-p">),</span>
      <span class="tok-s2">&quot;infoMessage&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;could not find member to sync from&quot;</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;electionTime&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">Timestamp</span><span class="tok-p">(</span><span class="tok-mi">1455040665</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">),</span>
      <span class="tok-s2">&quot;electionDate&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ISODate</span><span class="tok-p">(</span><span class="tok-s2">&quot;2016-02-09T17:57:45Z&quot;</span><span class="tok-p">),</span>
      <span class="tok-s2">&quot;configVersion&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;self&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">true</span>
    <span class="tok-p">},</span>
  	<span class="tok-p">{</span>
      <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;name&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;localhost:27018&quot;</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;health&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;state&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;stateStr&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;SECONDARY&quot;</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;uptime&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">17</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;optime&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
        <span class="tok-s2">&quot;ts&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">Timestamp</span><span class="tok-p">(</span><span class="tok-mi">1455040665</span><span class="tok-p">,</span> <span class="tok-mi">2</span><span class="tok-p">),</span>
        <span class="tok-s2">&quot;t&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">NumberLong</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">)</span>
      <span class="tok-p">},</span>
      <span class="tok-s2">&quot;optimeDate&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ISODate</span><span class="tok-p">(</span><span class="tok-s2">&quot;2016-02-09T17:57:45Z&quot;</span><span class="tok-p">),</span>
      <span class="tok-s2">&quot;lastHeartbeat&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ISODate</span><span class="tok-p">(</span><span class="tok-s2">&quot;2016-02-09T17:57:51.287Z&quot;</span><span class="tok-p">),</span>
      <span class="tok-s2">&quot;lastHeartbeatRecv&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ISODate</span><span class="tok-p">(</span><span class="tok-s2">&quot;2016-02-09T17:57:47.860Z&quot;</span><span class="tok-p">),</span>
      <span class="tok-s2">&quot;pingMs&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">NumberLong</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">),</span>
      <span class="tok-s2">&quot;syncingTo&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;localhost:27017&quot;</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;configVersion&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span>
  	<span class="tok-p">},</span>
  	<span class="tok-p">{</span>
      <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;name&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;localhost:27019&quot;</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;health&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;state&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;stateStr&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;SECONDARY&quot;</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;uptime&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">17</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;optime&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
        <span class="tok-s2">&quot;ts&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">Timestamp</span><span class="tok-p">(</span><span class="tok-mi">1455040665</span><span class="tok-p">,</span> <span class="tok-mi">2</span><span class="tok-p">),</span>
        <span class="tok-s2">&quot;t&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">NumberLong</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">)</span>
      <span class="tok-p">},</span>
      <span class="tok-s2">&quot;optimeDate&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ISODate</span><span class="tok-p">(</span><span class="tok-s2">&quot;2016-02-09T17:57:45Z&quot;</span><span class="tok-p">),</span>
      <span class="tok-s2">&quot;lastHeartbeat&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ISODate</span><span class="tok-p">(</span><span class="tok-s2">&quot;2016-02-09T17:57:51.287Z&quot;</span><span class="tok-p">),</span>
      <span class="tok-s2">&quot;lastHeartbeatRecv&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ISODate</span><span class="tok-p">(</span><span class="tok-s2">&quot;2016-02-09T17:57:47.869Z&quot;</span><span class="tok-p">),</span>
      <span class="tok-s2">&quot;pingMs&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">NumberLong</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">),</span>
      <span class="tok-s2">&quot;syncingTo&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;localhost:27017&quot;</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;configVersion&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span>
  	<span class="tok-p">}</span>
  <span class="tok-p">],</span>
  <span class="tok-s2">&quot;ok&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La próxima vez que lancemos las réplicas ya no deberemos configurarlas. Así pues, el proceso de enlazar e iniciar las réplicas sólo se realiza una vez.</p>
</div>
</div>
<div class="sect3">
<h4 id="_trabajando_con_las_réplicas">4.4.4. Trabajando con las réplicas</h4>
<div class="paragraph">
<p>Una vez que hemos visto que las tres réplicas están funcionando, vamos a comprobar como podemos trabajar con ellas.</p>
</div>
<div class="paragraph">
<p>Para ello, nos conectamos al nodo principal (al ser el puerto predeterminado, podemos omitirlo):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span class="tok-nv">$ </span>mongo --port 27017</code></pre>
</div>
</div>
<div class="paragraph">
<p>Al conectarnos al nodo principal, nos aparece como símbolo del <em>shell</em> el nombre del conjunto de la réplica seguido de dos puntos y <code>PRIMARY</code> si nos hemos conectado al nodo principal, o <code>SECONDARY</code> en caso contrario.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">replicaExperto</span><span class="tok-o">:</span><span class="tok-nx">PRIMARY</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para saber si nos hemos conectado al nodo correcto, mediante <code>rs.isMaster()</code> obtendremos el tipo del nodo (propiedad <code>ismaster</code>) e información sobre el resto de nodos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">replicaExperto</span><span class="tok-o">:</span><span class="tok-nx">PRIMARY</span><span class="tok-o">&gt;</span> <span class="tok-nx">rs</span><span class="tok-p">.</span><span class="tok-nx">isMaster</span><span class="tok-p">()</span>
<span class="tok-p">{</span>
  <span class="tok-s2">&quot;hosts&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span>
    <span class="tok-s2">&quot;localhost:27017&quot;</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;localhost:27018&quot;</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;localhost:27019&quot;</span>
  <span class="tok-p">],</span>
  <span class="tok-s2">&quot;setName&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;replicaExperto&quot;</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;setVersion&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;ismaster&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">true</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;secondary&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">false</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;primary&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;localhost:27017&quot;</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;me&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;localhost:27017&quot;</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;electionId&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;56ba28990000000000000001&quot;</span><span class="tok-p">),</span>
  <span class="tok-s2">&quot;maxBsonObjectSize&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">16777216</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;maxMessageSizeBytes&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">48000000</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;maxWriteBatchSize&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1000</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;localTime&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ISODate</span><span class="tok-p">(</span><span class="tok-s2">&quot;2016-02-09T18:00:46.397Z&quot;</span><span class="tok-p">),</span>
  <span class="tok-s2">&quot;maxWireVersion&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">4</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;minWireVersion&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">0</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;ok&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora que sabemos que estamos en el nodo principal, vamos a insertar datos.</p>
</div>
<div class="paragraph">
<p>Para ello, vamos a insertar 100 documentos:</p>
</div>
<div class="listingblock">
<div class="title">Insertamos 100 documentos sobre <code>replicaExperto:PRIMARY</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-nx">i</span><span class="tok-o">=</span><span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-nx">i</span><span class="tok-o">&lt;</span><span class="tok-mi">1000</span><span class="tok-p">;</span> <span class="tok-nx">i</span><span class="tok-o">++</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">pruebas</span><span class="tok-p">.</span><span class="tok-nx">insert</span><span class="tok-p">({</span><span class="tok-nx">num</span><span class="tok-o">:</span> <span class="tok-nx">i</span><span class="tok-p">})</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Estos 1000 documentos se han insertado en el nodo principal, y se han replicado a los secundarios. Para comprobar la replicación, abrimos un nuevo terminal y nos conectamos a un nodo secundario:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span class="tok-nv">$ </span>mongo --port 27018
replicaExperto:SECONDARY&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Si desde el nodo secundario intentamos consultar el total de documentos de la colección obtendremos un error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">replicaExperto</span><span class="tok-o">:</span><span class="tok-nx">SECONDARY</span><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">pruebas</span><span class="tok-p">.</span><span class="tok-nx">count</span><span class="tok-p">()</span>
<span class="tok-nx">count</span> <span class="tok-nx">failed</span><span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;ok&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-s2">&quot;errmsg&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;not master and slaveOk=false&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;code&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">13435</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El error indica que no somos un nodo primario y por lo tanto no podemos leer de él. Para permitir lecturas en los nodos secundarios, mediante <code>rs.slaveOk()</code> le decimos a <code>mongo</code> que sabemos que nos hemos conectado a un secundairo y admitimos la posibilidad de obtener datos obsoletos.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">replicaExperto</span><span class="tok-o">:</span><span class="tok-nx">SECONDARY</span><span class="tok-o">&gt;</span> <span class="tok-nx">rs</span><span class="tok-p">.</span><span class="tok-nx">slaveOk</span><span class="tok-p">()</span>
<span class="tok-nx">replicaExperto</span><span class="tok-o">:</span><span class="tok-nx">SECONDARY</span><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">pruebas</span><span class="tok-p">.</span><span class="tok-nx">count</span><span class="tok-p">()</span>
<span class="tok-mi">1000</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pero que podamos leer no significa que podamos escribir. Si intentamos escribir en un nodo secundario obtendremos un error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">replicaExperto</span><span class="tok-o">:</span><span class="tok-nx">SECONDARY</span><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">pruebas</span><span class="tok-p">.</span><span class="tok-nx">insert</span><span class="tok-p">({</span><span class="tok-nx">num</span> <span class="tok-o">:</span> <span class="tok-mi">1001</span><span class="tok-p">})</span>
<span class="tok-nx">WriteResult</span><span class="tok-p">({</span> <span class="tok-s2">&quot;writeError&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;code&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">10107</span><span class="tok-p">,</span> <span class="tok-s2">&quot;errmsg&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;not master&quot;</span> <span class="tok-p">}</span> <span class="tok-p">})</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_tolerancia_a_fallos">4.4.5. Tolerancia a fallos</h4>
<div class="paragraph">
<p>Cuando un nodo primario no se comunica con otros miembros del conjunto durante más de 10 segundos, el conjunto de réplicas intentará, de entre los secundarios, que un miembro se convierta en el nuevo primario.</p>
</div>
<div class="paragraph">
<p>Para ello se realiza un proceso de <strong>votación</strong>, de modo que el nodo que obtenga el mayor número de votos se erigirá en primario. Este proceso de votación se realiza bastante rápido (menos de 3 segundos), durante el cual no existe ningún nodo primario y por tanto la réplica no acepta escrituras y todos los miembros se convierten en nodos de sólo-lectura.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql04/replica-set-election.png" alt="Elección de un nuevo primario" width="50%">
</div>
<div class="title">Figure 28. Elección de un nuevo primario</div>
</div>
<div class="sect4">
<h5 id="_proceso_de_votación">Proceso de votación</h5>
<div class="paragraph">
<p>Cuando un nodo secundario no puede contactar con su nodo primario, contactará con el resto de miembros y les indicará que quiere ser elegido como primario. Es decir, cada nodo que no encuentre un primario se nominará como posible primario, de modo que un nodo no nomina a otro a ser primario, únicamente vota sobre una nominación ya existente.</p>
</div>
<div class="paragraph">
<p>Antes de dar su voto, el resto de nodos comprobarán:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>si ellos tienen conectividad con el primario</p>
</li>
<li>
<p>si el nodo que solicita ser primario tienen una réplica actualizada de los datos. Todas las operaciones replicadas están ordenadas por el <em>timestamp</em> ascendentemente, de modo los candidatos deben tener operaciones posteriores o iguales a cualquier miembro con el que tengan conectividad.</p>
</li>
<li>
<p>si existe algún nodo con una prioridad mayor que debería ser elegido.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Si algún miembro que quiere ser primario recibe una mayoría de <em>"sís"</em> se convertirá en el nuevo primario, siempre y cuando no haya un servidor que vete la votación. Si un miembro la veta es porque conoce alguna razón por la que el nodo que quiere ser primario no debería serlo, es decir, ha conseguido contactar con el antiguo primario.</p>
</div>
<div class="paragraph">
<p>Una vez un candidato recibe una mayoría de <em>"sís"</em>, su estado pasará a ser primario.</p>
</div>
</div>
<div class="sect4">
<h5 id="_cantidad_de_elementos">Cantidad de elementos</h5>
<div class="paragraph">
<p>En la votación, se necesita una mayoría de nodos para elegir un primario, ya que una escritura se considera segura cuando ha alcanzado a la mayoría de los nodos. Esta mayoría se define como <strong>más de la mitad</strong> de todos los nodos del conjunto. Hay que destacar que la mayoría no se basa en los elementos que queden en pie o estén disponibles, sino en el conjunto definido en la configuración del conjunto.</p>
</div>
<div class="paragraph">
<p>Por lo tanto, es importante configurar el conjunto de una manera que siempre se puede elegir un nodo primario. Por ejemplo, en un conjunto de cinco nodos, si los nodos 1, 2 y 3 están en un centro de datos y los miembros 4 y 5 en otro, debería haber casi siempre una mayoría disponible en el primer centro de datos (es más probable que se pierda la conexión de red entre centros de datos que dentro de ellos).</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql04/replica-set-failover.jpg" alt="Elección de un nuevo primario" width="33%">
</div>
<div class="title">Figure 29. Elección de un nuevo primario</div>
</div>
<div class="paragraph">
<p>Por lo tanto, una configuración que hay que evitar es aquella compuesta por dos elementos: uno primario y uno secundario. Si uno de los dos miembros deja de estar disponible, el otro miembro no puede verlo. En esta situación, ninguna parte de la partición de red tiene una mayoría, con lo que acabaríamos con dos secundarios.</p>
</div>
<div class="paragraph">
<p>Por ello, el número mínimo de nodos es 3, para que al realizar una nueva elección se pueda elegir un nuevo nodo.</p>
</div>
</div>
<div class="sect4">
<h5 id="_comprobando_la_tolerancia">Comprobando la tolerancia</h5>
<div class="paragraph">
<p>Para comprobar esto, desde el nodo primario vamos a detenerlo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">replicaExperto</span><span class="tok-o">:</span><span class="tok-nx">PRIMARY</span><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">adminCommand</span><span class="tok-p">({</span><span class="tok-s2">&quot;shutdown&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Otra posibilidad en vez de detenerlo es degradarlo a nodo secundario:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">replicaExperto</span><span class="tok-o">:</span><span class="tok-nx">PRIMARY</span><span class="tok-o">&gt;</span> <span class="tok-nx">rs</span><span class="tok-p">.</span><span class="tok-nx">stepDown</span><span class="tok-p">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si pasamos al antiguo nodo secundario, y le preguntamos si es el principal obtendremos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">replicaExperto</span><span class="tok-o">:</span><span class="tok-nx">SECONDARY</span><span class="tok-o">&gt;</span> <span class="tok-nx">rs</span><span class="tok-p">.</span><span class="tok-nx">isMaster</span><span class="tok-p">()</span>
<span class="tok-p">{</span>
  <span class="tok-s2">&quot;setName&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;replicaExperto&quot;</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;setVersion&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;ismaster&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">false</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;secondary&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">true</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;hosts&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span>
    <span class="tok-s2">&quot;localhost:27018&quot;</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;localhost:27019&quot;</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;localhost:27017&quot;</span>
  <span class="tok-p">],</span>
  <span class="tok-s2">&quot;primary&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;localhost:27019&quot;</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;me&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;localhost:27018&quot;</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;maxBsonObjectSize&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">16777216</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;maxMessageSizeBytes&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">48000000</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;maxWriteBatchSize&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1000</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;localTime&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ISODate</span><span class="tok-p">(</span><span class="tok-s2">&quot;2015-03-24T21:55:27.382Z&quot;</span><span class="tok-p">),</span>
  <span class="tok-s2">&quot;maxWireVersion&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;minWireVersion&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">0</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;ok&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si nos fijamos en la propiedad <code>primary</code>, veremos que tenemos un nuevo primario.</p>
</div>
</div>
<div class="sect4">
<h5 id="_configuración_recomendada">Configuración recomendada</h5>
<div class="paragraph">
<p>Se recomiendan dos configuraciones:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Mediante una mayoría del conjunto en un centro de datos. Este planteamiento es bueno si tenemos un <em>data center</em> donde queremos que siempre se aloje el nodo primario de la réplica. Siempre que el centro de datos funcione normalmente, habrá un nodo primario. Sin embargo, si el centro primario pierde la conectividad, el centro de datos secundario no podrá elegir un nuevo primario.</p>
</li>
<li>
<p>Mediante el mismo número de servidores en cada centro de datos, más un servidor que rompe la igualdad en una tercera localización. Este diseño es conveniente cuando ambos centros de datos tienen el mismo grado de confiabilidad y robustez.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_recuperación_del_sistema">4.4.6. Recuperación del sistema</h4>
<div class="paragraph">
<p>Si en un conjunto de réplicas se cae el primario y hay escrituras que se han pasado al <em>oplog</em> de modo que los otros nodos no las han replicado, cuando el nodo primario vuelva en sí como secundario y se sincronice con el primario, se dará cuenta que hay operaciones de escritura pendientes y las pasará a <em>rollback</em>, para que si se desean se apliquen manualmente.</p>
</div>
<div class="paragraph">
<p>Para evitar este escenario, se necesita emplear consistencia en la escritura, de manera que hasta que la escritura no se haya replicado en la mayoría de los nodos no se considere como una escritura exitosa.</p>
</div>
<div class="sect4">
<h5 id="_consistencia_en_la_escritura">Consistencia en la escritura</h5>
<div class="paragraph">
<p>Ya hemos visto que tanto las lecturas como las escrituras se realizan de manera predeterminada en el nodo primario.</p>
</div>
<div class="paragraph">
<p>Las aplicaciones pueden decidir que las escrituras vayan al nodo primario pero las lecturas al secundario. Esto puede provocar que haya lecturas caducas, con datos obsoletos, pero como beneficio podemos escalar el sistema.</p>
</div>
<div class="paragraph">
<p>La replicación es un proceso asíncrono. En el período de tiempo en el que el sistema de votación sucede, no se completa ninguna escritura.</p>
</div>
<div class="paragraph">
<p><em>MongoDB</em> garantiza la consistencia en la escritura, haciendo que sea un sistema consistente. Para ello, ofrece un sistema que garantiza que una escritura ha sido exitosa. Dependiendo del nivel de configuración de la consistencia, las inserciones, modificaciones y borrados pueden tardar más o menos. Si reducimos el nivel de consistencia, el rendimiento será mejor, a costa de poder obtener datos obsoletos u perder datos que no se han terminado de serializar en disco. Con un nivel de consistencia más alto, los clientes esperan tras enviar una operación de escritura a que <em>MongoDB</em> les confirme la operación.</p>
</div>
<div class="paragraph">
<p>Los valores que podemos configurar se realizan mediante las siguientes opciones:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>w</code>: indica el número de servidores que se han de replicar para que la inserción devuelva un ACK.</p>
</li>
<li>
<p><code>j</code>: indica si las escrituras se tienen que trasladar a un diario de bitácora (<em>journal</em>)</p>
</li>
<li>
<p><code>wtimeout</code>: indica el límite de tiempo a esperar como máximo, para prevenir que una escritura se bloquee indefinidamente.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_niveles_de_consistencia">Niveles de consistencia</h5>
<div class="paragraph">
<p>Con estas opciones, podemos configurar diferentes niveles de consistencia son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Sin confirmación: <code>w:0</code></p>
</li>
<li>
<p>Con confirmación: <code>w:1</code></p>
</li>
<li>
<p>Con diario: <code>w:1, j:true</code>. Cada inserción primero se escribe en el diario y posteriormente en el directorio de datos.</p>
</li>
<li>
<p>Con confirmación de la mayoría: <code>w:"majority"</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Estas opciones se indican como parámetro final en las operaciones de insercion y modificación de datos. Por ejemplo:</p>
</div>
<div class="listingblock">
<div class="title">Insertando un documento indicando el nivel de consistencia</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">pruebas</span><span class="tok-p">.</span><span class="tok-nx">insert</span><span class="tok-p">(</span>
  <span class="tok-p">{</span><span class="tok-nx">num</span> <span class="tok-o">:</span> <span class="tok-mi">1002</span><span class="tok-p">},</span>
  <span class="tok-p">{</span><span class="tok-nx">writeConcern</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-nx">w</span><span class="tok-o">:</span><span class="tok-s2">&quot;majority&quot;</span><span class="tok-p">,</span> <span class="tok-nx">wtimeout</span><span class="tok-o">:</span> <span class="tok-mi">5000</span><span class="tok-p">}}</span>
<span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Más información en <a href="http://docs.mongodb.org/manual/core/write-concern/" class="bare">http://docs.mongodb.org/manual/core/write-concern/</a> y <a href="https://www.youtube.com/watch?v=49BPAY1Yb5w" class="bare">https://www.youtube.com/watch?v=49BPAY1Yb5w</a>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_replicación_en_em_java_em">4.5. Replicación en <em>Java</em></h3>
<div class="paragraph">
<p>Para conectar a una réplica desde <em>Java</em>, en el constructor del <code>MongoClient</code> le pasaremos como parámetro una lista con los elementos del conjunto:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo de conexión a un Conjunto de Réplicas</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">MongoClient</span> <span class="tok-n">cliente</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">MongoClient</span><span class="tok-o">(</span><span class="tok-n">Arrays</span><span class="tok-o">.</span><span class="tok-na">asList</span><span class="tok-o">(</span>  <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="tok-k">new</span> <span class="tok-nf">ServerAddress</span><span class="tok-o">(</span><span class="tok-s">&quot;localhost&quot;</span><span class="tok-o">,</span> <span class="tok-mi">27017</span><span class="tok-o">),</span>
  <span class="tok-k">new</span> <span class="tok-nf">ServerAddress</span><span class="tok-o">(</span><span class="tok-s">&quot;localhost&quot;</span><span class="tok-o">,</span> <span class="tok-mi">27018</span><span class="tok-o">),</span>
  <span class="tok-k">new</span> <span class="tok-nf">ServerAddress</span><span class="tok-o">(</span><span class="tok-s">&quot;localhost&quot;</span><span class="tok-o">,</span> <span class="tok-mi">27019</span><span class="tok-o">)));</span>

<span class="tok-c1">// Resto de código similar a si nos conectamos a un sólo servidor</span>
<span class="tok-n">DBCollection</span> <span class="tok-n">coleccion</span> <span class="tok-o">=</span> <span class="tok-n">cliente</span><span class="tok-o">.</span><span class="tok-na">getDB</span><span class="tok-o">(</span><span class="tok-s">&quot;expertojava&quot;</span><span class="tok-o">).</span><span class="tok-na">getCollection</span><span class="tok-o">(</span><span class="tok-s">&quot;pruebas&quot;</span><span class="tok-o">);</span>
<span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">drop</span><span class="tok-o">();</span>

<span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-kt">int</span> <span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-o">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-mi">1000</span><span class="tok-o">;</span> <span class="tok-n">i</span><span class="tok-o">++)</span> <span class="tok-o">{</span>
  <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">insert</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;_id&quot;</span><span class="tok-o">,</span> <span class="tok-n">i</span><span class="tok-o">));</span>
  <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;Insertado documento: &quot;</span> <span class="tok-o">+</span> <span class="tok-n">i</span><span class="tok-o">);</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Creamos la lista con ayuda de <code>Arrays.asList()</code></td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Autoevaluación</div>
<div class="paragraph">
<p>Si dejamos un nodo fuera de la réplica dentro de la lista de conexión del driver ¿Qué pasará? <span class="footnote">[<a id="_footnoteref_11" class="footnote" href="#_footnote_11" title="View footnote.">11</a>]</span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>La aplicación no utilizará el nodo</p>
</li>
<li>
<p>El nodo perdido será descubierto siempre y cuando en la lista haya un nodo válido</p>
</li>
<li>
<p>El nodo perdido se empleará para lectura, pero no para escrituras</p>
</li>
<li>
<p>El nodo perdido se utilizará para escrituras, pero no para lecturas</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Cuando nos conectamos a una réplica, en el cliente le pasamos una lista de nodos (<code>ServerAdress</code>) a conectarnos. Aunque podemos no indicar todos los nodos del conjunto, es conveniente ponerlos.</p>
</div>
<div class="paragraph">
<p>A partir de la lista de servidores, conocida como lista de semillas (<em>seed list</em>), la clase <code>MongoClient</code> averigua los detalles del servidor a partir de los metadatos de la réplica, obtiendo todos los nodos que forman la réplica, así como quien es el primario en dicho momento. Es decir, si nos dejamos algún nodo fuera, el <em>driver</em> descubrirá la configuración del resto de nodos del conjunto y realizará las operaciones sobre los nodos a los no que no nos hemos conectado de manera explicita.</p>
</div>
<div class="paragraph">
<p>Además, <code>MongoClient</code> mantendrá en todo momento un hilo en <em>background</em> con la réplica para estar informado de cualquier cambio que suceda en el estado de la misma.</p>
</div>
<div class="sect3">
<h4 id="_reintento_de_operaciones">4.5.1. Reintento de Operaciones</h4>
<div class="paragraph">
<p>En el caso de operaciones que insertan o modifican los datos, puede que sea conveniente realizar varios intentos con las operaciones para dar tiempo a que el conjunto de réplicas se recupere:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo de Reintento de Operación</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">MongoClient</span> <span class="tok-n">client</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">MongoClient</span><span class="tok-o">(</span><span class="tok-n">Arrays</span><span class="tok-o">.</span><span class="tok-na">asList</span><span class="tok-o">(</span>
  <span class="tok-k">new</span> <span class="tok-nf">ServerAddress</span><span class="tok-o">(</span><span class="tok-s">&quot;localhost&quot;</span><span class="tok-o">,</span> <span class="tok-mi">27017</span><span class="tok-o">),</span>
  <span class="tok-k">new</span> <span class="tok-nf">ServerAddress</span><span class="tok-o">(</span><span class="tok-s">&quot;localhost&quot;</span><span class="tok-o">,</span> <span class="tok-mi">27018</span><span class="tok-o">),</span>
  <span class="tok-k">new</span> <span class="tok-nf">ServerAddress</span><span class="tok-o">(</span><span class="tok-s">&quot;localhost&quot;</span><span class="tok-o">,</span> <span class="tok-mi">27019</span><span class="tok-o">)));</span>

<span class="tok-n">DBCollection</span> <span class="tok-n">coleccion</span> <span class="tok-o">=</span> <span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-na">getDB</span><span class="tok-o">(</span><span class="tok-s">&quot;expertojava&quot;</span><span class="tok-o">).</span><span class="tok-na">getCollection</span><span class="tok-o">(</span><span class="tok-s">&quot;pruebas&quot;</span><span class="tok-o">);</span>
<span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">drop</span><span class="tok-o">();</span>

<span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-kt">int</span> <span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-o">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-n">Integer</span><span class="tok-o">.</span><span class="tok-na">MAX_VALUE</span><span class="tok-o">;</span> <span class="tok-n">i</span><span class="tok-o">++)</span> <span class="tok-o">{</span>
  <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-kt">int</span> <span class="tok-n">intentos</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-o">;</span> <span class="tok-n">intentos</span> <span class="tok-o">&lt;=</span> <span class="tok-mi">2</span><span class="tok-o">;</span> <span class="tok-n">intentos</span><span class="tok-o">++)</span> <span class="tok-o">{</span>
    <span class="tok-k">try</span> <span class="tok-o">{</span>
      <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">insert</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;_id&quot;</span><span class="tok-o">,</span> <span class="tok-n">i</span><span class="tok-o">));</span>
      <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;Documento insertado: &quot;</span> <span class="tok-o">+</span> <span class="tok-n">i</span><span class="tok-o">);</span>
      <span class="tok-k">break</span><span class="tok-o">;</span>
    <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">DuplicateKeyException</span> <span class="tok-n">e</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;Documento ya insertado: &quot;</span> <span class="tok-o">+</span> <span class="tok-n">i</span><span class="tok-o">);</span>
    <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">MongoException</span> <span class="tok-n">e</span><span class="tok-o">)</span> <span class="tok-o">{</span>  <i class="conum" data-value="1"></i><b>(1)</b>
      <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">e</span><span class="tok-o">.</span><span class="tok-na">getMessage</span><span class="tok-o">());</span>
      <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;Reintentando&quot;</span><span class="tok-o">);</span>
      <span class="tok-n">Thread</span><span class="tok-o">.</span><span class="tok-na">sleep</span><span class="tok-o">(</span><span class="tok-mi">5000</span><span class="tok-o">);</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-o">}</span>
  <span class="tok-o">}</span>
  <span class="tok-n">Thread</span><span class="tok-o">.</span><span class="tok-na">sleep</span><span class="tok-o">(</span><span class="tok-mi">500</span><span class="tok-o">);</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Si mientras estamos escribiendo sobre la réplica, el nodo primario se cae, el driver lanzará una <code>MongoException</code>. Por ello, es conveniente capturar la excepción, y si la operación que estamos realizando es una inserción, reintentarla.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Esperamos 5 segundos a que la réplica se recupere y un secundario se convierta en primario</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para poder probar este ejemplo, tras lanzar la clase Java, comenzará a insertar documentos sin parar. En un terminal nos conectamos al nodo primario y lo degradamos mediante <code>rs.stepDown()</code> para que se produzca una votación y se elija un nuevo primario:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">replicaExperto</span><span class="tok-o">:</span><span class="tok-nx">PRIMARY</span><span class="tok-o">&gt;</span> <span class="tok-nx">rs</span><span class="tok-p">.</span><span class="tok-nx">stepDown</span><span class="tok-p">()</span>
<span class="tok-mi">2015</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">03</span><span class="tok-nx">T09</span><span class="tok-o">:</span><span class="tok-mi">41</span><span class="tok-o">:</span><span class="tok-mf">52.619</span><span class="tok-o">+</span><span class="tok-mi">0200</span> <span class="tok-nx">DBClientCursor</span><span class="tok-o">::</span><span class="tok-nx">init</span> <span class="tok-nx">call</span><span class="tok-p">()</span> <span class="tok-nx">failed</span>
<span class="tok-mi">2015</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">03</span><span class="tok-nx">T09</span><span class="tok-o">:</span><span class="tok-mi">41</span><span class="tok-o">:</span><span class="tok-mf">52.621</span><span class="tok-o">+</span><span class="tok-mi">0200</span> <span class="tok-nb">Error</span><span class="tok-o">:</span> <span class="tok-nx">error</span> <span class="tok-nx">doing</span> <span class="tok-nx">query</span><span class="tok-o">:</span> <span class="tok-nx">failed</span> <span class="tok-nx">at</span> <span class="tok-nx">src</span><span class="tok-o">/</span><span class="tok-nx">mongo</span><span class="tok-o">/</span><span class="tok-nx">shell</span><span class="tok-o">/</span><span class="tok-nx">query</span><span class="tok-p">.</span><span class="tok-nx">js</span><span class="tok-o">:</span><span class="tok-mi">81</span>
<span class="tok-mi">2015</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">03</span><span class="tok-nx">T09</span><span class="tok-o">:</span><span class="tok-mi">41</span><span class="tok-o">:</span><span class="tok-mf">52.623</span><span class="tok-o">+</span><span class="tok-mi">0200</span> <span class="tok-nx">trying</span> <span class="tok-nx">reconnect</span> <span class="tok-nx">to</span> <span class="tok-mf">127.0</span><span class="tok-p">.</span><span class="tok-mf">0.1</span><span class="tok-o">:</span><span class="tok-mi">27018</span> <span class="tok-p">(</span><span class="tok-mf">127.0</span><span class="tok-p">.</span><span class="tok-mf">0.1</span><span class="tok-p">)</span> <span class="tok-nx">failed</span>
<span class="tok-mi">2015</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">03</span><span class="tok-nx">T09</span><span class="tok-o">:</span><span class="tok-mi">41</span><span class="tok-o">:</span><span class="tok-mf">52.626</span><span class="tok-o">+</span><span class="tok-mi">0200</span> <span class="tok-nx">reconnect</span> <span class="tok-mf">127.0</span><span class="tok-p">.</span><span class="tok-mf">0.1</span><span class="tok-o">:</span><span class="tok-mi">27018</span> <span class="tok-p">(</span><span class="tok-mf">127.0</span><span class="tok-p">.</span><span class="tok-mf">0.1</span><span class="tok-p">)</span> <span class="tok-nx">ok</span>
<span class="tok-nx">replicaExperto</span><span class="tok-o">:</span><span class="tok-nx">SECONDARY</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si comprobamos la salida del sistema, veremos como el sistema se recupera de una caída del sistema y reintenta la inserción:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="out">...
Documento insertado: 39855
Operation on server localhost:27018 failed
Reintentando
Documento insertado: 39856
...</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_consistencia_de_escritura">4.5.2. Consistencia de Escritura</h4>
<div class="paragraph">
<p>En <em>Java</em>, para indicar el nivel de consistencia, se realiza mediante el método <code>setWriteConcern(nivel)</code>, siendo nivel uno de los valores de la enumeración <code>WriteConcern</code>, la cual puede tomar diferentes valores, siendo los más importantes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>WriteConcern.UNACKNOWLEDGED</code></p>
</li>
<li>
<p><code>WriteConcern.ACKNOWLEDGED</code></p>
</li>
<li>
<p><code>WriteConcern.JOURNALED</code></p>
</li>
<li>
<p><code>WriteConcern.MAJORITY</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Este nivel se puede indicar a nivel de:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>cliente: <code>cliente.setWriteConcern(nivel)</code></p>
</li>
<li>
<p>de base de datos: : <code>db.setWriteConcern(nivel)</code></p>
</li>
<li>
<p>de colección: <code>coleccion.setWriteConcern(nivel)</code></p>
</li>
<li>
<p>o con cada inserción : <code>cliente.insert(doc, nivel)</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Ejemplo de <code>WriteConcern</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">MongoClient</span> <span class="tok-n">cliente</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">MongoClient</span><span class="tok-o">(</span><span class="tok-n">Arrays</span><span class="tok-o">.</span><span class="tok-na">asList</span><span class="tok-o">(</span>
  <span class="tok-k">new</span> <span class="tok-nf">ServerAddress</span><span class="tok-o">(</span><span class="tok-s">&quot;localhost&quot;</span><span class="tok-o">,</span> <span class="tok-mi">27017</span><span class="tok-o">),</span>
  <span class="tok-k">new</span> <span class="tok-nf">ServerAddress</span><span class="tok-o">(</span><span class="tok-s">&quot;localhost&quot;</span><span class="tok-o">,</span> <span class="tok-mi">27018</span><span class="tok-o">),</span>
  <span class="tok-k">new</span> <span class="tok-nf">ServerAddress</span><span class="tok-o">(</span><span class="tok-s">&quot;localhost&quot;</span><span class="tok-o">,</span> <span class="tok-mi">27019</span><span class="tok-o">)));</span>

<span class="tok-n">cliente</span><span class="tok-o">.</span><span class="tok-na">setWriteConcern</span><span class="tok-o">(</span><span class="tok-n">WriteConcern</span><span class="tok-o">.</span><span class="tok-na">JOURNALED</span><span class="tok-o">);</span>

<span class="tok-n">DB</span> <span class="tok-n">db</span> <span class="tok-o">=</span> <span class="tok-n">cliente</span><span class="tok-o">.</span><span class="tok-na">getDB</span><span class="tok-o">(</span><span class="tok-s">&quot;expertojava&quot;</span><span class="tok-o">);</span>
<span class="tok-n">db</span><span class="tok-o">.</span><span class="tok-na">setWriteConcern</span><span class="tok-o">(</span><span class="tok-n">WriteConcern</span><span class="tok-o">.</span><span class="tok-na">ACKNOWLEDGED</span><span class="tok-o">);</span>
<span class="tok-n">DBCollection</span> <span class="tok-n">coleccion</span> <span class="tok-o">=</span> <span class="tok-n">db</span><span class="tok-o">.</span><span class="tok-na">getCollection</span><span class="tok-o">(</span><span class="tok-s">&quot;pruebas&quot;</span><span class="tok-o">);</span>
<span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">setWriteConcern</span><span class="tok-o">(</span><span class="tok-n">WriteConcern</span><span class="tok-o">.</span><span class="tok-na">MAJORITY</span><span class="tok-o">);</span>

<span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">drop</span><span class="tok-o">();</span>

<span class="tok-n">DBObject</span> <span class="tok-n">doc</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;_id&quot;</span><span class="tok-o">,</span> <span class="tok-mi">1</span><span class="tok-o">);</span>

<span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">insert</span><span class="tok-o">(</span><span class="tok-n">doc</span><span class="tok-o">);</span>

<span class="tok-k">try</span> <span class="tok-o">{</span>
  <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">insert</span><span class="tok-o">(</span><span class="tok-n">doc</span><span class="tok-o">,</span> <span class="tok-n">WriteConcern</span><span class="tok-o">.</span><span class="tok-na">UNACKNOWLEDGED</span><span class="tok-o">);</span>
<span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">MongoException</span> <span class="tok-n">e</span><span class="tok-o">)</span> <span class="tok-o">{</span>
  <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">e</span><span class="tok-o">.</span><span class="tok-na">getMessage</span><span class="tok-o">());</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_preferencia_de_lectura">4.5.3. Preferencia de Lectura</h4>
<div class="paragraph">
<p>La preferencia de lectura permite indicar al driver a qué servidores podemos enviar consultas.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Como regla general, enviar peticiones de lectura a nodos secundarios es una mala decisión.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Los posibles preferencias de lectura llevan asociadas situaciones en las que tiene sentido realizar la lectura desde un nodo secundario. Así pues, las preferencias se dividen en:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>primary</code>: valor por defecto. Todas las lecturas se realizan en el nodo primario. Si se cae este nodo, el sistema no acepta lecturas. Es el único modo que garantiza los datos más recientes, ya que todas las escrituras pasan por él.</p>
</li>
<li>
<p><code>primaryPreferred</code>: realiza la lectura de nodos secundarios cuando el primario ha caído. Si el nodo primario está en pie siempre se realizará la lecturas sobre él.</p>
</li>
<li>
<p><code>nearest</code>: en ocasiones los nodos secundarios están más cercanos al cliente. En este caso, podemos acceder a los datos con la menor latencia posible, sin tener en cuenta si accedemos a un primario o a un secundario.</p>
</li>
<li>
<p><code>secondary</code>: envía las lecturas a nodos secundarios. Si no hubiese ningún nodo secundario disponible, la lectura fallará. Se emplea en aplicaciones que sólo quieren utilizar el nodo primario para escrituras, o bien en aplicaciones que quieres sacar estadísticas de los datos y no quieren cargar el nodo principal.</p>
</li>
<li>
<p><code>secondaryPreferred</code>: envía las lecturas a nodos secundarios, pero si no hubiese ninguno, la enviaría al primario.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Las lecturas de los nodos secundarios toman sentido cuando tenemos datos en los que la cantidad de operaciones de lectura son completamente predominantes sobre las escrituras.</p>
</div>
<div class="sect4">
<h5 id="__code_readpreference_code"><code>ReadPreference</code></h5>
<div class="paragraph">
<p>Para configurar estos posibilidades mediante <em>Java</em> emplearemos la clase <code>ReadPreference</code>, la cual ofrece métodos para configurar los valores vistos.</p>
</div>
<div class="paragraph">
<p>Se puede configura con granularidad de:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>cliente: <code>client.setReadPreference()</code></p>
</li>
<li>
<p>base de datos: <code>db.setReadPreference()</code></p>
</li>
<li>
<p>colección: <code>col.setReadPreference()</code></p>
</li>
<li>
<p>operación: <code>cursor.setReadPreference()</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Ejemplo de <code>ReadPreference</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">MongoClient</span> <span class="tok-n">cliente</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">MongoClient</span><span class="tok-o">(</span><span class="tok-n">Arrays</span><span class="tok-o">.</span><span class="tok-na">asList</span><span class="tok-o">(</span>
  <span class="tok-k">new</span> <span class="tok-nf">ServerAddress</span><span class="tok-o">(</span><span class="tok-s">&quot;localhost&quot;</span><span class="tok-o">,</span> <span class="tok-mi">27017</span><span class="tok-o">),</span>
  <span class="tok-k">new</span> <span class="tok-nf">ServerAddress</span><span class="tok-o">(</span><span class="tok-s">&quot;localhost&quot;</span><span class="tok-o">,</span> <span class="tok-mi">27018</span><span class="tok-o">),</span>
  <span class="tok-k">new</span> <span class="tok-nf">ServerAddress</span><span class="tok-o">(</span><span class="tok-s">&quot;localhost&quot;</span><span class="tok-o">,</span> <span class="tok-mi">27019</span><span class="tok-o">)));</span>
<span class="tok-n">cliente</span><span class="tok-o">.</span><span class="tok-na">setReadPreference</span><span class="tok-o">(</span><span class="tok-n">ReadPreference</span><span class="tok-o">.</span><span class="tok-na">primary</span><span class="tok-o">());</span>

<span class="tok-n">DB</span> <span class="tok-n">db</span> <span class="tok-o">=</span> <span class="tok-n">cliente</span><span class="tok-o">.</span><span class="tok-na">getDB</span><span class="tok-o">(</span><span class="tok-s">&quot;expertojava&quot;</span><span class="tok-o">);</span>
<span class="tok-n">db</span><span class="tok-o">.</span><span class="tok-na">setReadPreference</span><span class="tok-o">(</span><span class="tok-n">ReadPreference</span><span class="tok-o">.</span><span class="tok-na">primary</span><span class="tok-o">());</span>
<span class="tok-n">DBCollection</span> <span class="tok-n">coleccion</span> <span class="tok-o">=</span> <span class="tok-n">db</span><span class="tok-o">.</span><span class="tok-na">getCollection</span><span class="tok-o">(</span><span class="tok-s">&quot;pruebas&quot;</span><span class="tok-o">);</span>
<span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">setReadPreference</span><span class="tok-o">(</span><span class="tok-n">ReadPreference</span><span class="tok-o">.</span><span class="tok-na">primaryPreferred</span><span class="tok-o">());</span>

<span class="tok-n">DBCursor</span> <span class="tok-n">cursor</span> <span class="tok-o">=</span> <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">().</span><span class="tok-na">setReadPreference</span><span class="tok-o">(</span><span class="tok-n">ReadPreference</span><span class="tok-o">.</span><span class="tok-na">nearest</span><span class="tok-o">());</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-k">try</span> <span class="tok-o">{</span>
  <span class="tok-k">while</span> <span class="tok-o">(</span><span class="tok-n">cursor</span><span class="tok-o">.</span><span class="tok-na">hasNext</span><span class="tok-o">())</span> <span class="tok-o">{</span>
    <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">cursor</span><span class="tok-o">.</span><span class="tok-na">next</span><span class="tok-o">());</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span> <span class="tok-k">finally</span> <span class="tok-o">{</span>
  <span class="tok-n">cursor</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>El driver elige el servidor al que enviar la consulta mediante un ping a la máquina para averiguar el tiempo empleado (ms).</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Más información en <a href="http://docs.mongodb.org/manual/core/read-preference/" class="bare">http://docs.mongodb.org/manual/core/read-preference/</a> y
<a href="http://docs.mongodb.org/manual/reference/read-preference" class="bare">http://docs.mongodb.org/manual/reference/read-preference</a>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_particionado_em_sharding_em">4.6. Particionado (<em>Sharding</em>)</h3>
<div class="paragraph">
<p>Ya vimos en la primera sesión que dentro del entorno de las bases de datos, particionar consiste en dividir los datos entre múltiples máquinas. Al poner un subconjunto de los datos en cada máquina, vamos a poder almacenar más información y soportar más carga sin necesidad de máquinas más potentes, sino una mayor cantidad de máquinas más modestas (y mucho más baratas).</p>
</div>
<div class="paragraph">
<p>El <em>Sharding</em> es una técnica que fragmenta los datos de la base de datos horizontalmente agrupándolos de algún modo que tenga sentido y que permita un direccionamiento más rápido.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql04/sharded-collection.png" alt="Sharding" width="50%">
</div>
<div class="title">Figure 30. Sharding</div>
</div>
<div class="paragraph">
<p>Por lo tanto, estos <em>shards</em> (fragmentos) pueden estar localizados en diferentes bases de datos y localizaciones físicas.</p>
</div>
<div class="paragraph">
<p>El <em>Sharding</em> no tiene por qué estar basado únicamente en una colección y un campo, puede ser a nivel de todas las colecciones. Por ejemplo podríamos decir <em>"todos los datos de usuarios cuyo perfil está en los Estados Unidos los redirigimos a la base de datos del servidor en Estados Unidos, y todos los de Asia van a la base de datos de Asia"</em>.</p>
</div>
<div class="sect3">
<h4 id="_particionando_con_em_mongodb_em">4.6.1. Particionando con <em>MongoDB</em></h4>
<div class="paragraph">
<p><em>MongoDB</em> implementa el <em>sharding</em> de forma nativa y <strong>automática</strong> (de ahí el término de <em>auto-sharding</em>), siguiendo un enfoque <strong>basado en rangos</strong>.</p>
</div>
<div class="paragraph">
<p>Para ello, divide una colección entre diferentes servidores, utilizando <code>mongos</code> como router de las peticiones entre los <em>sharded clusters</em>.</p>
</div>
<div class="paragraph">
<p>Esto favorece que el desarrollador ignore que la aplicación no se comunica con un único servidor, balanceando de manera automática los datos y permitiendo incrementar o reducir la capacidad del sistema a conveniencia.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Antes de plantearse hacer <em>auto-sharding</em> sobre nuestros datos, es conveniente dominar cómo se trabaja con <em>MongoDB</em> y el uso de conjuntos de réplica.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="__em_sharded_cluster_em"><em>Sharded Cluster</em></h5>
<div class="paragraph">
<p>El particionado de <em>MongoDB</em> permite crear un cluster de muchas máquinas, dividiendo a nivel de colección y poniendo un subconjunto de los datos de la colección en cada uno de los fragmentos.</p>
</div>
<div class="paragraph">
<p>Los componentes de un <em>sharded clusters</em> son:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><em>Shards</em> (Fragmentos)</dt>
<dd>
<p>Cada una de las máquinas del cluster, que almacena un subconjunto de los datos de la colección. Cada <em>shard</em> es una instancia de <code>mongod</code> o un conjunto de réplicas. En un entorno de producción, todos los <em>shards</em> son conjuntos de réplica.</p>
</dd>
<dt class="hdlist1">Servidores de Configuracion</dt>
<dd>
<p>Cada servidor de configuración es una instancia de <code>mongod</code> que almacena metadatos sobre el cluster. Los metadatos mapean los trozos con los <em>shards</em>, definiendo qué rangos de datos definen un trozo (<em>chunk</em>) de la colección, y qué trozos se encuentran en un determinado <em>shard</em>.</p>
<div class="paragraph">
<p>En entornos de producción se aconseja tener 3 servidores de configuración ya que si sólo tuviésemos uno, al producirse una caída el cluster quedaría inaccesible.</p>
</div>
</dd>
<dt class="hdlist1">Enrutadores</dt>
<dd>
<p>Cada router es una instancia <code>mongos</code> que enruta las lecturas y escrituras de las aplicaciones a los <em>shards</em>. Las aplicaciones no acceden directamente a los <em>shards</em>, sino al <em>router</em>. Estos enrutadores funcionan de manera similar a una tabla de contenidos, que nos indica donde se encuentran los datos. Una vez recopilados los datos de los diferentes <em>shards</em>, se fusionan y se encarga de devolverlos a la aplicación.</p>
<div class="paragraph">
<p>En entornos de producción es común tener varios <em>routers</em> para balancear la carga de los clientes.</p>
</div>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql04/sharded-cluster.png" alt="Componentes de un _sharded cluster_" width="50%">
</div>
<div class="title">Figure 31. Componentes de un <em>sharded cluster</em></div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Autoevaluación</div>
<div class="paragraph">
<p>Supongamos que queremos ejecutar múltiples routers <code>mongos</code> para soportar la redundancia. ¿Qué elemento asegurará la tolerancia a fallos y cambiará de un <code>mongos</code> a otro dentro de tu aplicación? <span class="footnote">[<a id="_footnoteref_12" class="footnote" href="#_footnote_12" title="View footnote.">12</a>]</span></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>mongod</code></p>
</li>
<li>
<p><code>mongos</code></p>
</li>
<li>
<p>Driver</p>
</li>
<li>
<p>Los servidores de configuración de <em>sharding</em></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="__em_shard_key_em"><em>Shard key</em></h5>
<div class="paragraph">
<p>Para que <em>MongoDB</em> sepa cómo dividir una colección en trozos, hay que elegir una <strong>shard key</strong>, normalmente el identificador del documento, por ejemplo, <code>student_id</code>. Este identificador es la clave del <em>chunk</em> (por lo hace la misma función que una clave primaria).</p>
</div>
<div class="paragraph">
<p>Para las búsquedas, borrados y actualizaciones, al emplear la <em>shard key</em>, <em>mongos</em> sabe a que <em>shard</em> enviar la petición. En cambio, si la operación no la indica, se hará un <em>broadcast</em> a todas los shards para averiguar donde se encuentra.</p>
</div>
<div class="paragraph">
<p>Por eso, toda inserción debe incluir la <em>shard key</em>. En el caso de tratarse de una clave compuesta, la inserción debe contener la clave completa.</p>
</div>
<div class="paragraph">
<p>Entre los aspectos a tener en cuenta a la hora de elegir una <em>shard key</em> cabe destacar que debe:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Tener una alta cardinalidad, para asegurar que los documentos puedan dividirse en los distintos fragmentos. Por ejemplo, si elegimos un <em>shard key</em> que solo tiene 3 valores posibles y tenemos 5 fragmentos, no podríamos separar los documentos en los 5 fragmentos al solo tener 3 valores posibles para separar. Cuantos más valores posibles pueda tener la clave de fragmentación, más eficiente será la división de los trozos entre los fragmentos disponibles.</p>
</li>
<li>
<p>Tener un alto nivel de aleatoriedad. Si utilizamos una clave que siga un patrón incremental como una fecha o un ID, conllevará que al insertar documentos, el mismo fragmento estará siendo utilizando constantemente durante el rango de valores definido para él. Esto provoca que los datos estén separados de una manera óptima, pero pondrá siempre bajo estrés a un fragmento en períodos de tiempo mientras que los otros posiblemente queden con muy poca actividad (comportamiento conocido como <em>hotspotting</em>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Una solución a las claves que siguen patrones incrementales es aplicar una funcion <em>hash</em> y crear una clave <em>hasheada</em> que si tiene un alto nivel de aleatoriedad.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Más consejos sobre como elegir la <em>shard key</em> en <a href="http://techinsides.blogspot.com.es/2013/09/keynote-concerns-how-to-choose-mongodb.html" class="bare">http://techinsides.blogspot.com.es/2013/09/keynote-concerns-how-to-choose-mongodb.html</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finalmente, destacar que toda <em>shard key</em> debe tener un índice asociado.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_preparando_el_em_sharding_em_con_em_mongodb_em">4.6.2. Preparando el <em>Sharding</em> con <em>MongoDB</em></h4>
<div class="paragraph">
<p>Para comenzar, vamos a crear un particionado en dos instancias en las carpetas <code>/data/s1/db</code> y <code>/data/s2/db</code>. Los logs los colocaremos en <code>/data/logs</code> y crearemos un servidor para la configuración de los metadatos del <em>shard</em> en <code>/data/con1/db</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">mkdir -p /data/s1/db /data/s2/db /data/logs /data/conf1/db
chown <span class="tok-sb">`</span>id -u<span class="tok-sb">`</span> /data/s1/db /data/s2/db /data/logs /data/conf1/db</code></pre>
</div>
</div>
<div class="paragraph">
<p>A continuación, arrancaremos un proceso <code>mongod</code> por cada uno de los <em>shards</em> (con la opción <code>--shardsvr</code>) y un tercero para la base de datos de configuración (con la opción <code>--configsvr</code>). Finalmente, también lanzaremos un proceso <code>mongos</code>:</p>
</div>
<div class="listingblock">
<div class="title">Script de creación del Shard - (<a href="resources/nosql/creaShard.sh">creaShard.sh</a>)</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">mongod --shardsvr --dbpath  /data/s1/db --port <span class="tok-m">27000</span> --logpath /data/logs/sh1.log --smallfiles --oplogSize <span class="tok-m">128</span> --fork
mongod --shardsvr --dbpath  /data/s2/db --port <span class="tok-m">27001</span> --logpath /data/logs/sh2.log --smallfiles --oplogSize <span class="tok-m">128</span> --fork
mongod --configsvr --dbpath  /data/conf1/db --port <span class="tok-m">25000</span> --logpath  /data/logs/config.log --fork
mongos --configdb localhost:25000 --logpath  /data/logs/mongos.log --fork</code></pre>
</div>
</div>
<div class="paragraph">
<p>El cual lanzaremos mediante</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">bash &lt; creaShard.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>Una vez creado, arrancaremos un shell del <code>mongo</code>, y observaremos como se lanza <code>mongos</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span class="tok-nv">$ </span>mongo
MongoDB shell version: 3.2.1
connecting to: <span class="tok-nb">test</span>
mongos&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finalmente, configuraremos el <em>shard</em> mediante el método <code>sh.addShard(URI)</code>, obteniendo confirmación tras cada cada uno:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">mongos</span><span class="tok-o">&gt;</span> <span class="tok-nx">sh</span><span class="tok-p">.</span><span class="tok-nx">addShard</span><span class="tok-p">(</span><span class="tok-s2">&quot;localhost:27000&quot;</span><span class="tok-p">)</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;shardAdded&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;shard0000&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;ok&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span> <span class="tok-p">}</span>  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-nx">mongos</span><span class="tok-o">&gt;</span> <span class="tok-nx">sh</span><span class="tok-p">.</span><span class="tok-nx">addShard</span><span class="tok-p">(</span><span class="tok-s2">&quot;localhost:27001&quot;</span><span class="tok-p">)</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;shardAdded&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;shard0001&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;ok&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>El valor de la propiedad <code>shardAdded</code> nos devuelve el identificado unívoco de cada <em>shard</em>.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
De manera similar que con el conjunto de réplicas se emplean el prefijo <code>rs</code>, para interactuar con los componentes implicados en el <em>sharding</em> se emplea <code>sh</code>. Por ejemplo, mediante <code>sh.help()</code> obtendremos la ayuda de los métodos disponibles.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Así pues, en este momento tenemos montada un <em>shard</em> con:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>dos instancias de <code>mongod</code> para almacenar datos en los puertos 27000 y 27001 (<em>shards</em>)</p>
</li>
<li>
<p>una instancia <code>monogd</code> en el puerto 25000 (servidor de configuración) encargada de almacenar los metadatos del <em>shard</em>, a la cual sólo se deberían conectar el proceso <code>mongos</code> o los drivers para obtener información sobre el <em>shard</em> y la <em>shard key</em></p>
</li>
<li>
<p>y un proceso <code>mongos</code> (<em>enrutador</em>), encargado de aceptar las peticiones de los clientes y enrutar las peticiones al <em>shard</em> adecuado.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql04/sharded.jpg" alt="Shard con dos máquinas" width="33%">
</div>
<div class="title">Figure 32. Shard con dos máquinas</div>
</div>
<div class="paragraph">
<p>Si comprobamos el estado del <em>shard</em> podremos comprobar como tenemos dos <em>shards</em>, con sus identificadores y URIs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">mongos</span><span class="tok-o">&gt;</span> <span class="tok-nx">sh</span><span class="tok-p">.</span><span class="tok-nx">status</span><span class="tok-p">()</span>
<span class="tok-o">---</span> <span class="tok-nx">Sharding</span> <span class="tok-nx">Status</span> <span class="tok-o">---</span>
<span class="tok-nx">sharding</span> <span class="tok-nx">version</span><span class="tok-o">:</span> <span class="tok-p">{</span>
  <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;minCompatibleVersion&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">5</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;currentVersion&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">6</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;clusterId&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;56bc7054ba6728d2673a1755&quot;</span><span class="tok-p">)</span>
<span class="tok-p">}</span>
<span class="tok-nx">shards</span><span class="tok-o">:</span>
  <span class="tok-p">{</span>  <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;shard0000&quot;</span><span class="tok-p">,</span>  <span class="tok-s2">&quot;host&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;localhost:27000&quot;</span> <span class="tok-p">}</span>
  <span class="tok-p">{</span>  <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;shard0001&quot;</span><span class="tok-p">,</span>  <span class="tok-s2">&quot;host&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;localhost:27001&quot;</span> <span class="tok-p">}</span>
<span class="tok-nx">active</span> <span class="tok-nx">mongoses</span><span class="tok-o">:</span>
  <span class="tok-s2">&quot;3.2.1&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span>
<span class="tok-nx">balancer</span><span class="tok-o">:</span>
  <span class="tok-nx">Currently</span> <span class="tok-nx">enabled</span><span class="tok-o">:</span>  <span class="tok-nx">yes</span>
  <span class="tok-nx">Currently</span> <span class="tok-nx">running</span><span class="tok-o">:</span>  <span class="tok-nx">no</span>
  <span class="tok-nx">Failed</span> <span class="tok-nx">balancer</span> <span class="tok-nx">rounds</span> <span class="tok-k">in</span> <span class="tok-nx">last</span> <span class="tok-mi">5</span> <span class="tok-nx">attempts</span><span class="tok-o">:</span>  <span class="tok-mi">0</span>
  <span class="tok-nx">Migration</span> <span class="tok-nx">Results</span> <span class="tok-k">for</span> <span class="tok-nx">the</span> <span class="tok-nx">last</span> <span class="tok-mi">24</span> <span class="tok-nx">hours</span><span class="tok-o">:</span>
    <span class="tok-nx">No</span> <span class="tok-nx">recent</span> <span class="tok-nx">migrations</span>
<span class="tok-nx">databases</span><span class="tok-o">:</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En un entorno de producción, en vez de tener dos <em>shards</em>, habrá un conjunto de réplicas para asegurar la alta disponibilidad. Además, tendremos tres servidores de configuración para asegurar la disponibilidad de éstos. Del mismo modo, habrá tantos procesos <code>mongos</code> creados para un <em>shard</em> como conexiones de clientes.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql04/sharded-production.jpg" alt="Sharding en un entorno de Producción" width="50%">
</div>
<div class="title">Figure 33. Sharding en un entorno de producción</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
En <a href="resources/nosql/init_sharded_replica.sh">init_sharded_replica.sh</a> podéis comprobar como crear <em>sharding</em> sobre un conjunto de réplicas.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_habilitando_el_em_sharding_em">4.6.3. Habilitando el <em>Sharding</em></h4>
<div class="paragraph">
<p>Una vez hemos creado la estructura necesaria para soportar el <em>sharding</em> vamos a insertar un conjunto de datos para posteriormente particionarlos.</p>
</div>
<div class="paragraph">
<p>Para ello, vamos a insertar cien mil usuarios en una colección:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">mongos</span><span class="tok-o">&gt;</span> <span class="tok-nx">use</span> <span class="tok-nx">expertojava</span>
<span class="tok-nx">switched</span> <span class="tok-nx">to</span> <span class="tok-nx">db</span> <span class="tok-nx">expertojava</span>
<span class="tok-nx">mongos</span><span class="tok-o">&gt;</span> <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-kd">var</span> <span class="tok-nx">i</span><span class="tok-o">=</span><span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-nx">i</span><span class="tok-o">&lt;</span><span class="tok-mi">100000</span><span class="tok-p">;</span> <span class="tok-nx">i</span><span class="tok-o">++</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">usuarios</span><span class="tok-p">.</span><span class="tok-nx">insert</span><span class="tok-p">({</span><span class="tok-s2">&quot;login&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;usu&quot;</span> <span class="tok-o">+</span> <span class="tok-nx">i</span><span class="tok-p">,</span><span class="tok-s2">&quot;nombre&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;nom&quot;</span> <span class="tok-o">+</span> <span class="tok-nx">i</span><span class="tok-o">*</span><span class="tok-mi">2</span><span class="tok-p">,</span> <span class="tok-s2">&quot;fcreacion&quot;</span><span class="tok-o">:</span> <span class="tok-k">new</span> <span class="tok-nb">Date</span><span class="tok-p">()});</span>
<span class="tok-p">}</span>
<span class="tok-nx">mongos</span><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">usuarios</span><span class="tok-p">.</span><span class="tok-nx">count</span><span class="tok-p">()</span>
<span class="tok-mi">100000</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Como podemos observar, interactuar con <code>mongos</code> es igual a hacerlo con <code>mongo</code>.</p>
</div>
<div class="paragraph">
<p>Ahora mismo no sabemos en qué cual de los dos <em>shards</em> se han almacenado los datos. Además, estos datos no están particionados, es decir residen en sólo uno de los <em>shards</em>.</p>
</div>
<div class="paragraph">
<p>Para habilitar el <em>sharding</em> a nivel de base de datos y que los datos se repartan entre los fragmentos disponibles, ejecutaremos el comando <code>sh.enableSharding(nombreDB)</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">mongos</span><span class="tok-o">&gt;</span> <span class="tok-nx">sh</span><span class="tok-p">.</span><span class="tok-nx">enableSharding</span><span class="tok-p">(</span><span class="tok-s2">&quot;expertojava&quot;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si volvemos a comprobar el estado del <em>shard</em>, tenemos que se ha creado la nueva base de datos que contiene la propiedad <code>"partitioned" : true</code>, la cual nos informa que esta fragmentada.</p>
</div>
<div class="paragraph">
<p>Antes de habilitar el <em>sharding</em> para una determinada colección, tenemos que crear un índice sobre la <em>shard key</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">mongos</span><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">usuarios</span><span class="tok-p">.</span><span class="tok-nx">createIndex</span><span class="tok-p">({</span><span class="tok-s2">&quot;login&quot;</span><span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">})</span>
<span class="tok-p">{</span>
  <span class="tok-s2">&quot;raw&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-s2">&quot;localhost:27000&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
      <span class="tok-s2">&quot;createdCollectionAutomatically&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">false</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;numIndexesBefore&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;numIndexesAfter&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;ok&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span>
      <span class="tok-p">}</span>
    <span class="tok-p">},</span>
  <span class="tok-s2">&quot;ok&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Una vez habilitado el <em>shard</em> ya podemos fragmentar la colección:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">mongos</span><span class="tok-o">&gt;</span> <span class="tok-nx">sh</span><span class="tok-p">.</span><span class="tok-nx">shardCollection</span><span class="tok-p">(</span><span class="tok-s2">&quot;expertojava.usuarios&quot;</span><span class="tok-p">,</span> <span class="tok-p">{</span><span class="tok-s2">&quot;login&quot;</span><span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">},</span> <span class="tok-kc">false</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El método <code>shardCollection</code> particiona una colección a partir de una <em>shard key</em>. Para ello, recibe tres parámetros:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>nombre de la colección, con nomenclatura de <code>nombreBD.nombreColección</code></p>
</li>
<li>
<p>nombre del campo para fragmentar la colección, es decir, el <em>shard key</em>. Uno de los requisitos es que esta clave tengo una alta cardinalidad. Si tenemos una propiedad con una cardinalidad baja, podemos hacer un <em>hash</em> de la propiedad mediante <code>{"login": "hashed"}</code>. Como en nuestro caso hemos utilizado un campo con valores únicos hemos puesto <code>{"login": 1}</code>.</p>
</li>
<li>
<p>booleano que indica si el valor utilizado como <em>shard key</em> es único. Para ello, el índice que se crea sobre el campo debe ser del tipo <code>unique</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Este comando divide la colección en <em>chunks</em>, la cual es la unidad que utiliza <em>MongoDB</em> para mover los datos. Una vez que se ha ejecutado, <em>MongoDB</em> comenzará a balancear la colección entre los <em>shards</em> del <em>cluster</em>. Este proceso no es instantáneo. Si la colección contiene un gran conjunto de datos puede llevar horas completar el balanceo.</p>
</div>
<div class="paragraph">
<p>Si ahora volvemos a comprobar el estado del <em>shard</em> obtendremos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">mongos</span><span class="tok-o">&gt;</span> <span class="tok-nx">sh</span><span class="tok-p">.</span><span class="tok-nx">status</span><span class="tok-p">()</span>
<span class="tok-o">---</span> <span class="tok-nx">Sharding</span> <span class="tok-nx">Status</span> <span class="tok-o">---</span>
  <span class="tok-nx">sharding</span> <span class="tok-nx">version</span><span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;minCompatibleVersion&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">5</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;currentVersion&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">6</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;clusterId&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;56bc7054ba6728d2673a1755&quot;</span><span class="tok-p">)</span>
  <span class="tok-p">}</span>
  <span class="tok-nx">shards</span><span class="tok-o">:</span>
  	<span class="tok-p">{</span>  <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;shard0000&quot;</span><span class="tok-p">,</span>  <span class="tok-s2">&quot;host&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;localhost:27000&quot;</span> <span class="tok-p">}</span>
  	<span class="tok-p">{</span>  <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;shard0001&quot;</span><span class="tok-p">,</span>  <span class="tok-s2">&quot;host&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;localhost:27001&quot;</span> <span class="tok-p">}</span>
  <span class="tok-nx">active</span> <span class="tok-nx">mongoses</span><span class="tok-o">:</span>
	 <span class="tok-s2">&quot;3.2.1&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span>
  <span class="tok-nx">balancer</span><span class="tok-o">:</span>
  	<span class="tok-nx">Currently</span> <span class="tok-nx">enabled</span><span class="tok-o">:</span>  <span class="tok-nx">yes</span>
  	<span class="tok-nx">Currently</span> <span class="tok-nx">running</span><span class="tok-o">:</span>  <span class="tok-nx">no</span>
  	<span class="tok-nx">Failed</span> <span class="tok-nx">balancer</span> <span class="tok-nx">rounds</span> <span class="tok-k">in</span> <span class="tok-nx">last</span> <span class="tok-mi">5</span> <span class="tok-nx">attempts</span><span class="tok-o">:</span>  <span class="tok-mi">0</span>
  	<span class="tok-nx">Migration</span> <span class="tok-nx">Results</span> <span class="tok-k">for</span> <span class="tok-nx">the</span> <span class="tok-nx">last</span> <span class="tok-mi">24</span> <span class="tok-nx">hours</span><span class="tok-o">:</span>
  		<span class="tok-nx">No</span> <span class="tok-nx">recent</span> <span class="tok-nx">migrations</span>
  <span class="tok-nx">databases</span><span class="tok-o">:</span>
    <span class="tok-p">{</span>  <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;expertojava&quot;</span><span class="tok-p">,</span>  <span class="tok-s2">&quot;primary&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;shard0000&quot;</span><span class="tok-p">,</span>  <span class="tok-s2">&quot;partitioned&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">true</span> <span class="tok-p">}</span>
      <span class="tok-nx">expertojava</span><span class="tok-p">.</span><span class="tok-nx">usuarios</span>
        <span class="tok-nx">shard</span> <span class="tok-nx">key</span><span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;login&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span> <span class="tok-p">}</span>
        <span class="tok-nx">unique</span><span class="tok-o">:</span> <span class="tok-kc">false</span>
        <span class="tok-nx">balancing</span><span class="tok-o">:</span> <span class="tok-kc">true</span>
        <span class="tok-nx">chunks</span><span class="tok-o">:</span>  <i class="conum" data-value="1"></i><b>(1)</b>
          <span class="tok-nx">shard0000</span>	<span class="tok-mi">1</span>
        <span class="tok-p">{</span> <span class="tok-s2">&quot;login&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;$minKey&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span> <span class="tok-p">}</span> <span class="tok-p">}</span> <span class="tok-o">--&gt;&gt;</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;login&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;$maxKey&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span> <span class="tok-p">}</span> <span class="tok-p">}</span> <span class="tok-nx">on</span> <span class="tok-o">:</span> <span class="tok-nx">shard0000</span> <span class="tok-nx">Timestamp</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">)</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>la propiedad <code>chunks</code> muestra la cantidad de <em>trozos</em> que alberga cada partición. Así, pues en este momento tenemos 1 <em>chunk</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Para cada uno de los fragmentos se muestra el rango de valores que alberga cada <em>chunk</em>, así como en que <em>shard</em> se ubica.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Las claves <code>$minKey</code> y <code>$maxKey</code> son similares a menos infinito y más infinito, es decir, no hay ningún valor por debajo ni por encima de ellos. Es decir, indican los topes de la colección.</p>
</div>
</div>
<div class="sect3">
<h4 id="_trabajando_con_el_em_sharding_em">4.6.4. Trabajando con el <em>Sharding</em></h4>
<div class="paragraph">
<p>En este momento, el shard esta creado pero todos los nodos residen en un único fragmento dentro de un partición. Vamos a volver a insertar 100.000 usuarios más a ver que sucede.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">mongos</span><span class="tok-o">&gt;</span> <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-kd">var</span> <span class="tok-nx">i</span><span class="tok-o">=</span><span class="tok-mi">100000</span><span class="tok-p">;</span> <span class="tok-nx">i</span><span class="tok-o">&lt;</span><span class="tok-mi">200000</span><span class="tok-p">;</span> <span class="tok-nx">i</span><span class="tok-o">++</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">usuarios</span><span class="tok-p">.</span><span class="tok-nx">insert</span><span class="tok-p">({</span><span class="tok-s2">&quot;login&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;usu&quot;</span> <span class="tok-o">+</span> <span class="tok-nx">i</span><span class="tok-p">,</span><span class="tok-s2">&quot;nombre&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;nom&quot;</span> <span class="tok-o">+</span> <span class="tok-nx">i</span><span class="tok-o">*</span><span class="tok-mi">2</span><span class="tok-p">,</span> <span class="tok-s2">&quot;fcreacion&quot;</span><span class="tok-o">:</span> <span class="tok-k">new</span> <span class="tok-nb">Date</span><span class="tok-p">()});</span>
<span class="tok-p">}</span>
<span class="tok-nx">mongos</span><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">usuarios</span><span class="tok-p">.</span><span class="tok-nx">count</span><span class="tok-p">()</span>
<span class="tok-mi">200000</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si ahora comprobamos el estado del <em>shard</em>, los datos se deberían haber repartido entre los <em>shards</em> disponibles:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">mongos</span><span class="tok-o">&gt;</span> <span class="tok-nx">sh</span><span class="tok-p">.</span><span class="tok-nx">status</span><span class="tok-p">()</span>
<span class="tok-o">---</span> <span class="tok-nx">Sharding</span> <span class="tok-nx">Status</span> <span class="tok-o">---</span>
<span class="tok-nx">sharding</span> <span class="tok-nx">version</span><span class="tok-o">:</span> <span class="tok-p">{</span>
  <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;minCompatibleVersion&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">5</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;currentVersion&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">6</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;clusterId&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;56bc7054ba6728d2673a1755&quot;</span><span class="tok-p">)</span>
<span class="tok-p">}</span>
<span class="tok-nx">shards</span><span class="tok-o">:</span>
  <span class="tok-p">{</span>  <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;shard0000&quot;</span><span class="tok-p">,</span>  <span class="tok-s2">&quot;host&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;localhost:27000&quot;</span> <span class="tok-p">}</span>
  <span class="tok-p">{</span>  <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;shard0001&quot;</span><span class="tok-p">,</span>  <span class="tok-s2">&quot;host&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;localhost:27001&quot;</span> <span class="tok-p">}</span>
<span class="tok-nx">active</span> <span class="tok-nx">mongoses</span><span class="tok-o">:</span>
  <span class="tok-s2">&quot;3.2.1&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span>
<span class="tok-nx">balancer</span><span class="tok-o">:</span>
  <span class="tok-nx">Currently</span> <span class="tok-nx">enabled</span><span class="tok-o">:</span>  <span class="tok-nx">yes</span>
  <span class="tok-nx">Currently</span> <span class="tok-nx">running</span><span class="tok-o">:</span>  <span class="tok-nx">no</span>
  <span class="tok-nx">Failed</span> <span class="tok-nx">balancer</span> <span class="tok-nx">rounds</span> <span class="tok-k">in</span> <span class="tok-nx">last</span> <span class="tok-mi">5</span> <span class="tok-nx">attempts</span><span class="tok-o">:</span>  <span class="tok-mi">0</span>
  <span class="tok-nx">Migration</span> <span class="tok-nx">Results</span> <span class="tok-k">for</span> <span class="tok-nx">the</span> <span class="tok-nx">last</span> <span class="tok-mi">24</span> <span class="tok-nx">hours</span><span class="tok-o">:</span>
    <span class="tok-mi">31</span> <span class="tok-o">:</span> <span class="tok-nx">Success</span>
<span class="tok-nx">databases</span><span class="tok-o">:</span>
  <span class="tok-p">{</span>  <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;expertojava&quot;</span><span class="tok-p">,</span>  <span class="tok-s2">&quot;primary&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;shard0000&quot;</span><span class="tok-p">,</span>  <span class="tok-s2">&quot;partitioned&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">true</span> <span class="tok-p">}</span>
    <span class="tok-nx">expertojava</span><span class="tok-p">.</span><span class="tok-nx">usuarios</span>
      <span class="tok-nx">shard</span> <span class="tok-nx">key</span><span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;login&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span> <span class="tok-p">}</span>
      <span class="tok-nx">unique</span><span class="tok-o">:</span> <span class="tok-kc">false</span>
      <span class="tok-nx">balancing</span><span class="tok-o">:</span> <span class="tok-kc">true</span>
      <span class="tok-nx">chunks</span><span class="tok-o">:</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-nx">shard0000</span>	<span class="tok-mi">32</span>
        <span class="tok-nx">shard0001</span>	<span class="tok-mi">31</span>
      <span class="tok-nx">too</span> <span class="tok-nx">many</span> <span class="tok-nx">chunks</span> <span class="tok-nx">to</span> <span class="tok-nx">print</span><span class="tok-p">,</span> <span class="tok-nx">use</span> <span class="tok-nx">verbose</span> <span class="tok-k">if</span> <span class="tok-nx">you</span> <span class="tok-nx">want</span> <span class="tok-nx">to</span> <span class="tok-nx">force</span> <span class="tok-nx">print</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Con estos datos se ha forzado a balancear los mismos entre los dos fragmentos, habiendo en cada uno de ellos 32 y 31 trozos respectivamente</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si ahora realizamos una consulta y obtenemos su plan de ejecución veremos como se trata de una consulta que se ejecuta en paralelo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">mongos</span><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">usuarios</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-s2">&quot;login&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;usu12345&quot;</span><span class="tok-p">}).</span><span class="tok-nx">explain</span><span class="tok-p">()</span>
<span class="tok-p">{</span>
  <span class="tok-s2">&quot;queryPlanner&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-s2">&quot;mongosPlannerVersion&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;winningPlan&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
      <span class="tok-s2">&quot;stage&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;SINGLE_SHARD&quot;</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;shards&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span>
        <span class="tok-p">{</span>
          <span class="tok-s2">&quot;shardName&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;shard0001&quot;</span><span class="tok-p">,</span>
          <span class="tok-s2">&quot;connectionString&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;localhost:27001&quot;</span><span class="tok-p">,</span>
          <span class="tok-s2">&quot;serverInfo&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
            <span class="tok-s2">&quot;host&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;MacBook-Air-de-Aitor.local&quot;</span><span class="tok-p">,</span>
            <span class="tok-s2">&quot;port&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">27001</span><span class="tok-p">,</span>
            <span class="tok-s2">&quot;version&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;3.2.1&quot;</span><span class="tok-p">,</span>
            <span class="tok-s2">&quot;gitVersion&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;a14d55980c2cdc565d4704a7e3ad37e4e535c1b2&quot;</span>
          <span class="tok-p">},</span>
          <span class="tok-s2">&quot;plannerVersion&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
          <span class="tok-s2">&quot;namespace&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;expertojava.usuarios&quot;</span><span class="tok-p">,</span>
          <span class="tok-s2">&quot;indexFilterSet&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">false</span><span class="tok-p">,</span>
          <span class="tok-s2">&quot;parsedQuery&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
            <span class="tok-s2">&quot;login&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
              <span class="tok-s2">&quot;$eq&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;usu12345&quot;</span>
            <span class="tok-p">}</span>
          <span class="tok-p">},</span>
          <span class="tok-s2">&quot;winningPlan&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
            <span class="tok-s2">&quot;stage&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;FETCH&quot;</span><span class="tok-p">,</span>
            <span class="tok-s2">&quot;inputStage&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
              <span class="tok-s2">&quot;stage&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;SHARDING_FILTER&quot;</span><span class="tok-p">,</span>
              <span class="tok-s2">&quot;inputStage&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
                  <span class="tok-s2">&quot;stage&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;IXSCAN&quot;</span><span class="tok-p">,</span>
                  <span class="tok-s2">&quot;keyPattern&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
                    <span class="tok-s2">&quot;login&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span>
                <span class="tok-p">},</span>
                <span class="tok-s2">&quot;indexName&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;login_1&quot;</span><span class="tok-p">,</span>
                <span class="tok-s2">&quot;isMultiKey&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">false</span><span class="tok-p">,</span>
                <span class="tok-s2">&quot;isUnique&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">false</span><span class="tok-p">,</span>
                <span class="tok-s2">&quot;isSparse&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">false</span><span class="tok-p">,</span>
                <span class="tok-s2">&quot;isPartial&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">false</span><span class="tok-p">,</span>
                <span class="tok-s2">&quot;indexVersion&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
                <span class="tok-s2">&quot;direction&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;forward&quot;</span><span class="tok-p">,</span>
                <span class="tok-s2">&quot;indexBounds&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
                  <span class="tok-s2">&quot;login&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span>
                    <span class="tok-s2">&quot;[\&quot;usu12345\&quot;, \&quot;usu12345\&quot;]&quot;</span>
                  <span class="tok-p">]</span>
                <span class="tok-p">}</span>
              <span class="tok-p">}</span>
            <span class="tok-p">}</span>
          <span class="tok-p">},</span>
          <span class="tok-s2">&quot;rejectedPlans&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span> <span class="tok-p">]</span>
        <span class="tok-p">}</span>
      <span class="tok-p">]</span>
    <span class="tok-p">}</span>
  <span class="tok-p">},</span>
  <span class="tok-s2">&quot;ok&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos observar como se ha realizado una fase <code>SINGLE_SHARD</code> de manera que ha accedido únicamente al <code>shard0001</code>, y posteriormente una fase de <code>SHARDING_FILTER</code> en la cual ha empleado un índice para el escaneo (<code>IXSCAN</code>).</p>
</div>
<div class="paragraph">
<p>Si en vez de obtener un documento concreto, obtenemos el plan de ejecución de obtener todos los documentos tendremos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">mongos</span><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">usuarios</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">().</span><span class="tok-nx">explain</span><span class="tok-p">()</span>
<span class="tok-p">{</span>
  <span class="tok-s2">&quot;queryPlanner&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-s2">&quot;mongosPlannerVersion&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;winningPlan&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
      <span class="tok-s2">&quot;stage&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;SHARD_MERGE&quot;</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;shards&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span>
        <span class="tok-p">{</span>
          <span class="tok-s2">&quot;shardName&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;shard0000&quot;</span><span class="tok-p">,</span>
          <span class="tok-s2">&quot;connectionString&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;localhost:27000&quot;</span><span class="tok-p">,</span>
          <span class="tok-s2">&quot;serverInfo&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
            <span class="tok-s2">&quot;host&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;MacBook-Air-de-Aitor.local&quot;</span><span class="tok-p">,</span>
            <span class="tok-s2">&quot;port&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">27000</span><span class="tok-p">,</span>
            <span class="tok-s2">&quot;version&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;3.2.1&quot;</span><span class="tok-p">,</span>
            <span class="tok-s2">&quot;gitVersion&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;a14d55980c2cdc565d4704a7e3ad37e4e535c1b2&quot;</span>
          <span class="tok-p">},</span>
          <span class="tok-s2">&quot;plannerVersion&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
          <span class="tok-s2">&quot;namespace&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;expertojava.usuarios&quot;</span><span class="tok-p">,</span>
          <span class="tok-s2">&quot;indexFilterSet&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">false</span><span class="tok-p">,</span>
          <span class="tok-s2">&quot;parsedQuery&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
            <span class="tok-s2">&quot;$and&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span> <span class="tok-p">]</span>
          <span class="tok-p">},</span>
          <span class="tok-s2">&quot;winningPlan&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
            <span class="tok-s2">&quot;stage&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;SHARDING_FILTER&quot;</span><span class="tok-p">,</span>
            <span class="tok-s2">&quot;inputStage&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
              <span class="tok-s2">&quot;stage&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;COLLSCAN&quot;</span><span class="tok-p">,</span>
              <span class="tok-s2">&quot;filter&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
                <span class="tok-s2">&quot;$and&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span> <span class="tok-p">]</span>
              <span class="tok-p">},</span>
              <span class="tok-s2">&quot;direction&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;forward&quot;</span>
            <span class="tok-p">}</span>
          <span class="tok-p">},</span>
          <span class="tok-s2">&quot;rejectedPlans&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span> <span class="tok-p">]</span>
        <span class="tok-p">},</span>
        <span class="tok-p">{</span>
          <span class="tok-s2">&quot;shardName&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;shard0001&quot;</span><span class="tok-p">,</span>
          <span class="tok-s2">&quot;connectionString&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;localhost:27001&quot;</span><span class="tok-p">,</span>
          <span class="tok-s2">&quot;serverInfo&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
            <span class="tok-s2">&quot;host&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;MacBook-Air-de-Aitor.local&quot;</span><span class="tok-p">,</span>
            <span class="tok-s2">&quot;port&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">27001</span><span class="tok-p">,</span>
            <span class="tok-s2">&quot;version&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;3.2.1&quot;</span><span class="tok-p">,</span>
            <span class="tok-s2">&quot;gitVersion&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;a14d55980c2cdc565d4704a7e3ad37e4e535c1b2&quot;</span>
          <span class="tok-p">},</span>
          <span class="tok-s2">&quot;plannerVersion&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
          <span class="tok-s2">&quot;namespace&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;expertojava.usuarios&quot;</span><span class="tok-p">,</span>
          <span class="tok-s2">&quot;indexFilterSet&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">false</span><span class="tok-p">,</span>
          <span class="tok-s2">&quot;parsedQuery&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
            <span class="tok-s2">&quot;$and&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span> <span class="tok-p">]</span>
          <span class="tok-p">},</span>
          <span class="tok-s2">&quot;winningPlan&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
            <span class="tok-s2">&quot;stage&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;SHARDING_FILTER&quot;</span><span class="tok-p">,</span>
            <span class="tok-s2">&quot;inputStage&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
              <span class="tok-s2">&quot;stage&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;COLLSCAN&quot;</span><span class="tok-p">,</span>
              <span class="tok-s2">&quot;filter&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
                <span class="tok-s2">&quot;$and&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span> <span class="tok-p">]</span>
              <span class="tok-p">},</span>
              <span class="tok-s2">&quot;direction&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;forward&quot;</span>
            <span class="tok-p">}</span>
          <span class="tok-p">},</span>
          <span class="tok-s2">&quot;rejectedPlans&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span> <span class="tok-p">]</span>
        <span class="tok-p">}</span>
      <span class="tok-p">]</span>
    <span class="tok-p">}</span>
  <span class="tok-p">},</span>
  <span class="tok-s2">&quot;ok&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Así pues, si en una consulta no le enviamos la <em>shard key</em> como criterio, <code>mongos</code> enviará la consulta a cada <em>shard</em> y realizará un <code>SHARD_MERGE</code> con la información devuelta de cada <em>shard</em>. Si la consulta contiene la <em>shard key</em>, la consulta se enruta directamente al <em>shard</em> apropiado.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios_4">4.7. Ejercicios</h3>
<div class="sect3">
<h4 id="__1_25_puntos_ejercicio_41_agregaciones">4.7.1. (1.25 puntos) Ejercicio 41. Agregaciones</h4>
<div class="paragraph">
<p>A partir de la colección <code>cities</code> de la base de datos <code>ejercicios</code>, escribe los comandos necesarios y el resultado en <code>ej41.txt</code> para obtener la información de las siguientes consultas mediante el <em>pipeline</em> de agregación:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Nombre</code> y <code>población</code> de las tres ciudades españolas con más habitantes. Resultado:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span> <span class="tok-s2">&quot;nombre&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Madrid&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;poblacion&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">3255944</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;nombre&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Barcelona&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;poblacion&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1621537</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;nombre&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Valencia&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;poblacion&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">814208</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
</li>
<li>
<p><code>País</code>, <code>población</code> y cantidad de <code>ciudades</code> de dicho país, ordenados de mayor a menor población. Resultado:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span> <span class="tok-s2">&quot;poblacion&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">282839031</span><span class="tok-p">,</span> <span class="tok-s2">&quot;ciudades&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">5568</span><span class="tok-p">,</span> <span class="tok-s2">&quot;pais&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;CN&quot;</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;poblacion&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">272149640</span><span class="tok-p">,</span> <span class="tok-s2">&quot;ciudades&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">3350</span><span class="tok-p">,</span> <span class="tok-s2">&quot;pais&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;IN&quot;</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;poblacion&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">223341111</span><span class="tok-p">,</span> <span class="tok-s2">&quot;ciudades&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">14566</span><span class="tok-p">,</span> <span class="tok-s2">&quot;pais&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;US&quot;</span> <span class="tok-p">}</span>
<span class="tok-p">...</span></code></pre>
</div>
</div>
</li>
<li>
<p><code>País</code>, <code>población</code>, <code>ratio</code> entendido como el resultado de dividir la población del país entre el número de ciudades, <code>ciudadMasPoblada</code> en mayúsculas y <code>pobCiudadMasPoblada</code> (población de la ciudad más poblada) ordenados por el ratio de población/ciudades:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span> <span class="tok-s2">&quot;ciudadMasPoblada&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Singapore&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;pobCiudadMasPoblada&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">3547809</span><span class="tok-p">,</span> <span class="tok-s2">&quot;pais&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;SG&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;ratio&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">3547809</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;ciudadMasPoblada&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Hong Kong&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;pobCiudadMasPoblada&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">7012738</span><span class="tok-p">,</span> <span class="tok-s2">&quot;pais&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;HK&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;ratio&quot;</span> <span class="tok-o">:</span> <span class="tok-mf">2260092.75</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;ciudadMasPoblada&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Macau&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;pobCiudadMasPoblada&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">520400</span><span class="tok-p">,</span> <span class="tok-s2">&quot;pais&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;MO&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;ratio&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">520400</span> <span class="tok-p">}</span>
<span class="tok-p">...</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="__1_punto_ejercicio_42_43_replicación_em_sharding_em">4.7.2. (1 punto) Ejercicio 42 / 43. Replicación - <em>Sharding</em></h4>
<div class="paragraph">
<p>A continuación, se exponen dos ejercicios, de los cuales el alumno debe de elegir uno de los dos.</p>
</div>
<div class="sect4">
<h5 id="_replicación_3">Replicación</h5>
<div class="paragraph">
<p>Se pide crear una conjunto de 4 réplicas de nombre <code>ej42</code> en la cual insertaremos los datos de las ciudades de la primera sesión.</p>
</div>
<div class="paragraph">
<p>El script de creación del conjunto de réplicas se almacenará en <code>ej42creacion.sh</code>, y los comandos para inicializar el conjunto en <code>ej42init.js</code>.</p>
</div>
<div class="paragraph">
<p>Una vez cargado los datos, obtener el estado del conjunto y guardar el comando y el resultado en <code>ej42estado.txt</code>.</p>
</div>
<div class="paragraph">
<p>Tras ello se pide almacenar en <code>ej42operaciones.txt</code> los comandos y resultados obtenidos para:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Consultar una ciudad en un nodo secundario.</p>
</li>
<li>
<p>Habilitar las lecturas en los nodos secundarios.</p>
</li>
<li>
<p>Volver a consultar la ciudad en el nodo secundario.</p>
</li>
<li>
<p>Insertar una ciudad en el nodo secundario.</p>
</li>
<li>
<p>Detener el nodo primario.</p>
</li>
<li>
<p>Averiguar cual es el nuevo nodo primario.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="__em_sharding_em"><em>Sharding</em></h5>
<div class="paragraph">
<p>Se pide crear un <em>shard</em> con tres servidores e importar las ciudades en el <em>shard</em>.</p>
</div>
<div class="paragraph">
<p>Para ello, particionar los datos por el nombre de la ciudad.</p>
</div>
<div class="paragraph">
<p>El script de creación de las fragmentos se almacenará en <code>ej42creacion.sh</code>, y los comandos para inicializar el <em>sharding</em> en <code>ej42init.js</code>.</p>
</div>
<div class="paragraph">
<p>Una vez cargado los datos, obtener el estado del <em>sharding</em> y almacenar el comando y el resultado en <code>ej42estado1.txt</code>.</p>
</div>
<div class="paragraph">
<p>Tras ello, vacíar la colección y volver a importar los datos. Una vez importados, obtener el estado del <em>sharding</em> y almacenar el comando y el resultado en <code>ej42estado2.txt</code></p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnote_1">
<a href="#_footnoteref_1">1</a>. Storage Area Networks
</div>
<div class="footnote" id="_footnote_2">
<a href="#_footnoteref_2">2</a>. 2, porque no comparten <code>ObjectId</code>
</div>
<div class="footnote" id="_footnote_3">
<a href="#_footnoteref_3">3</a>. documentos con una calificación superior o igual a 65 y no que no sean de tipo "quiz" ni "homework"
</div>
<div class="footnote" id="_footnote_4">
<a href="#_footnoteref_4">4</a>. <code>db.grades.find({"type":"exam"}).sort({"score":-1}).skip(50).limit(20)</code>
</div>
<div class="footnote" id="_footnote_5">
<a href="#_footnoteref_5">5</a>. Al estar la colección vacía, insertará un nuevo registro
</div>
<div class="footnote" id="_footnote_6">
<a href="#_footnoteref_6">6</a>. Sí, porque la llamada a <code>removeField</code> borrará la clave añadida por el driver en el primer <code>insert</code>
</div>
<div class="footnote" id="_footnote_7">
<a href="#_footnoteref_7">7</a>. la correcta es la 3ª instrucción, ya que el primer parámetro del <code>find</code> indica que quiere todos los documentos, y con el segundo ya fija los campos a devolver
</div>
<div class="footnote" id="_footnote_8">
<a href="#_footnoteref_8">8</a>. lanzará una excepción ya que no puede aplicar la proyección
</div>
<div class="footnote" id="_footnote_9">
<a href="#_footnoteref_9">9</a>. la primera opción, ya que no puede haber documentos con propiedades nulas en un índice <em>sparse</em>
</div>
<div class="footnote" id="_footnote_10">
<a href="#_footnoteref_10">10</a>. 100, es decir, todos los valores existentes en el índice multiclave
</div>
<div class="footnote" id="_footnote_11">
<a href="#_footnoteref_11">11</a>. la opción correcta es la 2ª, es decir, si ponemos un nodo de manera correcta, la réplica cargará todos los nodos que la forman
</div>
<div class="footnote" id="_footnote_12">
<a href="#_footnoteref_12">12</a>. El driver se encarga de manera transparente de conectar al router adecuado, y cambiar un router por otro si al que estamos conectado se cae
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2016-04-11 16:49:24 CEST
</div>
</div>
</body>
</html>