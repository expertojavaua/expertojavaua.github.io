<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.2">
<meta name="author" content="Aitor Medrano">
<title>NoSQL</title>
<style>/*! normalize.css v2.1.2 | MIT License | git.io/normalize */
/* ========================================================================== HTML5 display definitions ========================================================================== */
/** Correct `block` display not defined in IE 8/9. */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }

/** Correct `inline-block` display not defined in IE 8/9. */
audio, canvas, video { display: inline-block; }

/** Prevent modern browsers from displaying `audio` without controls. Remove excess height in iOS 5 devices. */
audio:not([controls]) { display: none; height: 0; }

/** Address `[hidden]` styling not present in IE 8/9. Hide the `template` element in IE, Safari, and Firefox < 22. */
[hidden], template { display: none; }

script { display: none !important; }

/* ========================================================================== Base ========================================================================== */
/** 1. Set default font family to sans-serif. 2. Prevent iOS text size adjust after orientation change, without disabling user zoom. */
html { font-family: sans-serif; /* 1 */ -ms-text-size-adjust: 100%; /* 2 */ -webkit-text-size-adjust: 100%; /* 2 */ }

/** Remove default margin. */
body { margin: 0; }

/* ========================================================================== Links ========================================================================== */
/** Remove the gray background color from active links in IE 10. */
a { background: transparent; }

/** Address `outline` inconsistency between Chrome and other browsers. */
a:focus { outline: thin dotted; }

/** Improve readability when focused and also mouse hovered in all browsers. */
a:active, a:hover { outline: 0; }

/* ========================================================================== Typography ========================================================================== */
/** Address variable `h1` font-size and margin within `section` and `article` contexts in Firefox 4+, Safari 5, and Chrome. */
h1 { font-size: 2em; margin: 0.67em 0; }

/** Address styling not present in IE 8/9, Safari 5, and Chrome. */
abbr[title] { border-bottom: 1px dotted; }

/** Address style set to `bolder` in Firefox 4+, Safari 5, and Chrome. */
b, strong { font-weight: bold; }

/** Address styling not present in Safari 5 and Chrome. */
dfn { font-style: italic; }

/** Address differences between Firefox and other browsers. */
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }

/** Address styling not present in IE 8/9. */
mark { background: #ff0; color: #000; }

/** Correct font family set oddly in Safari 5 and Chrome. */
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }

/** Improve readability of pre-formatted text in all browsers. */
pre { white-space: pre-wrap; }

/** Set consistent quote types. */
q { quotes: "\201C" "\201D" "\2018" "\2019"; }

/** Address inconsistent and variable font size in all browsers. */
small { font-size: 80%; }

/** Prevent `sub` and `sup` affecting `line-height` in all browsers. */
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }

sup { top: -0.5em; }

sub { bottom: -0.25em; }

/* ========================================================================== Embedded content ========================================================================== */
/** Remove border when inside `a` element in IE 8/9. */
img { border: 0; }

/** Correct overflow displayed oddly in IE 9. */
svg:not(:root) { overflow: hidden; }

/* ========================================================================== Figures ========================================================================== */
/** Address margin not present in IE 8/9 and Safari 5. */
figure { margin: 0; }

/* ========================================================================== Forms ========================================================================== */
/** Define consistent border, margin, and padding. */
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }

/** 1. Correct `color` not being inherited in IE 8/9. 2. Remove padding so people aren't caught out if they zero out fieldsets. */
legend { border: 0; /* 1 */ padding: 0; /* 2 */ }

/** 1. Correct font family not being inherited in all browsers. 2. Correct font size not being inherited in all browsers. 3. Address margins set differently in Firefox 4+, Safari 5, and Chrome. */
button, input, select, textarea { font-family: inherit; /* 1 */ font-size: 100%; /* 2 */ margin: 0; /* 3 */ }

/** Address Firefox 4+ setting `line-height` on `input` using `!important` in the UA stylesheet. */
button, input { line-height: normal; }

/** Address inconsistent `text-transform` inheritance for `button` and `select`. All other form control elements do not inherit `text-transform` values. Correct `button` style inheritance in Chrome, Safari 5+, and IE 8+. Correct `select` style inheritance in Firefox 4+ and Opera. */
button, select { text-transform: none; }

/** 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio` and `video` controls. 2. Correct inability to style clickable `input` types in iOS. 3. Improve usability and consistency of cursor style between image-type `input` and others. */
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; /* 2 */ cursor: pointer; /* 3 */ }

/** Re-set default cursor for disabled elements. */
button[disabled], html input[disabled] { cursor: default; }

/** 1. Address box sizing set to `content-box` in IE 8/9. 2. Remove excess padding in IE 8/9. */
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; /* 1 */ padding: 0; /* 2 */ }

/** 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome. 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome (include `-moz` to future-proof). */
input[type="search"] { -webkit-appearance: textfield; /* 1 */ -moz-box-sizing: content-box; -webkit-box-sizing: content-box; /* 2 */ box-sizing: content-box; }

/** Remove inner padding and search cancel button in Safari 5 and Chrome on OS X. */
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }

/** Remove inner padding and border in Firefox 4+. */
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }

/** 1. Remove default vertical scrollbar in IE 8/9. 2. Improve readability and alignment in all browsers. */
textarea { overflow: auto; /* 1 */ vertical-align: top; /* 2 */ }

/* ========================================================================== Tables ========================================================================== */
/** Remove most spacing between table cells. */
table { border-collapse: collapse; border-spacing: 0; }

meta.foundation-mq-small { font-family: "only screen and (min-width: 768px)"; width: 768px; }

meta.foundation-mq-medium { font-family: "only screen and (min-width:1280px)"; width: 1280px; }

meta.foundation-mq-large { font-family: "only screen and (min-width:1440px)"; width: 1440px; }

*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }

html, body { font-size: 97%; }

body { background: white; color: #222222; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }

a:hover { cursor: pointer; }

img, object, embed { max-width: 100%; height: auto; }

object, embed { height: 100%; }

img { -ms-interpolation-mode: bicubic; }

#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }

.left { float: left !important; }

.right { float: right !important; }

.text-left { text-align: left !important; }

.text-right { text-align: right !important; }

.text-center { text-align: center !important; }

.text-justify { text-align: justify !important; }

.hide { display: none; }

.antialiased, body { -webkit-font-smoothing: antialiased; }

img { display: inline-block; vertical-align: middle; }

textarea { height: auto; min-height: 50px; }

select { width: 100%; }

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }

.subheader, .admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { line-height: 1.4; color: #6f6f6f; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }

/* Typography resets */
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }

/* Default Link Styles */
a { color: #1164be; text-decoration: none; line-height: inherit; }
a img { border: none; }

/* Default paragraph styles */
p { font-family: inherit; font-weight: normal; font-size: 1em; line-height: 1.4; margin-bottom: 1em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }

/* Default header styles */
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: bold; font-style: normal; color: #1c355e; text-rendering: optimizeLegibility; margin-top: 1em; margin-bottom: 0.5em; line-height: 1.2125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #6f6f6f; line-height: 0; }

h1 { font-size: 2.125em; }

h2 { font-size: 1.6875em; }

h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }

h4 { font-size: 1.125em; }

h5 { font-size: 1.125em; }

h6 { font-size: 1em; }

hr { border: solid #dddddd; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }

/* Helpful Typography Defaults */
em, i { font-style: italic; line-height: inherit; }

strong, b { font-weight: bold; line-height: inherit; }

small { font-size: 60%; line-height: inherit; }

code { font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: bold; }

/* Lists */
ul, ol, dl { font-size: 1em; line-height: 1.4; margin-bottom: 1.25em; list-style-position: outside; font-family: inherit; }

ul, ol { margin-left: 2.5em; }
ul.no-bullet, ol.no-bullet { margin-left: 1.5em; }

/* Unordered Lists */
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; /* Override nested font-size change */ }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }

/* Ordered Lists */
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }

/* Definition Lists */
dl dt { margin-bottom: 0.3125em; font-weight: bold; }
dl dd { margin-bottom: 1.25em; }

/* Abbreviations */
abbr, acronym { text-transform: uppercase; font-size: 90%; color: #222222; border-bottom: 1px dotted #dddddd; cursor: help; }

abbr { text-transform: none; }

/* Blockquotes */
blockquote { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
blockquote cite { display: block; font-size: 0.8125em; color: #555555; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #555555; }

blockquote, blockquote p { line-height: 1.6; color: #6f6f6f; }

/* Microformats */
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #dddddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }

.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }

/*@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.6875em; }
  h4 { font-size: 1.4375em; } }*/
/* Tables */
table { background: white; margin-bottom: 1.25em; border: solid 1px #dddddd; }
table thead, table tfoot { background: whitesmoke; font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: #222222; text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: #222222; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #f9f9f9; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.4; }

h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; border-bottom: 1px solid #dddddd }

.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }

*:not(pre) > code { font-size: inherit; font-style: normal !important; letter-spacing: 0; padding: 3px 2px 1px 2px; background-color: #eeeeee; border: 1px solid #dddddd; -webkit-border-radius: 0; border-radius: 0; line-height: inherit; font-weight: normal; }

pre, pre > code { line-height: 1.4; color: black; font-family: monospace, serif; font-weight: normal; }

.keyseq { color: #555555; }

kbd { display: inline-block; color: #222222; font-size: 0.75em; line-height: 1.4; background-color: #f7f7f7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; margin: -0.15em 0.15em 0 0.15em; padding: 0.2em 0.6em 0.2em 0.5em; vertical-align: middle; white-space: nowrap; }

.keyseq kbd:first-child { margin-left: 0; }

.keyseq kbd:last-child { margin-right: 0; }

.menuseq, .menu { color: #090909; }

b.button:before, b.button:after { position: relative; top: -1px; font-weight: normal; }

b.button:before { content: "["; padding: 0 3px 0 2px; }

b.button:after { content: "]"; padding: 0 2px 0 3px; }

#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 0.9375em; padding-right: 0.9375em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }

#content { margin-top: 1.25em; }

#content:before { content: none; }

#header > h1:first-child { color: black; margin-top: 2.25rem; margin-bottom: 0; }
#header > h1:first-child + #toc { margin-top: 8px; border-top: 1px solid #dddddd; }
#header > h1:only-child, body.toc2 #header > h1:nth-last-child(2) { border-bottom: 1px solid #dddddd; padding-bottom: 8px; }
#header .details { border-bottom: 1px solid #dddddd; line-height: 1.45; padding-top: 0.25em; padding-bottom: 0.25em; padding-left: 0.25em; color: #555555; display: -ms-flexbox; display: -webkit-flex; display: flex; -ms-flex-flow: row wrap; -webkit-flex-flow: row wrap; flex-flow: row wrap; }
#header .details span:first-child { margin-left: -0.125em; }
#header .details span.email a { color: #6f6f6f; }
#header .details br { display: none; }
#header .details br + span:before { content: "\00a0\2013\00a0"; }
#header .details br + span.author:before { content: "\00a0\22c5\00a0"; color: #6f6f6f; }
#header .details br + span#revremark:before { content: "\00a0|\00a0"; }
#header #revnumber { text-transform: capitalize; }
#header #revnumber:after { content: "\00a0"; }

#content > h1:first-child:not([class]) { color: black; border-bottom: 1px solid #dddddd; padding-bottom: 8px; margin-top: 0; padding-top: 1rem; margin-bottom: 1.25rem; }

#floating {
  position: fixed;
  z-index: 1000;
  padding: 0.5em;
  right: 0;
  top: 0;
  background: white;
  box-shadow: 0 0 1em #777777;
  -webkit-box-shadow: 0 0 1em #777777;
  -moz-box-shadow: 0 0 1em #777777;
  -webkit-border-bottom-left-radius: 5px;
  -moz-border-radius-bottomleft: 5px;
  max-height: 80%;
  overflow: auto;
}

#floating #full { display: none; } /* Hide the full TOC by default */

#floating:hover #full{
  display: block; /* Show it on hover */
}


#toc { border-bottom: 1px solid #dddddd; padding-bottom: 0.5em; }
#toc > ul { margin-left: 0.125em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin: 0.5em 0; }
#toc ul { font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; list-style-type: none; }
#toc a { text-decoration: none; }
#toc a:active { text-decoration: underline; }

#toctitle { color: #6f6f6f; font-size: 1.2em; }

@media only screen and (min-width: 768px) { #toctitle { font-size: 1.375em; }
  body.toc2 { padding-left: 15em; padding-right: 0; }
  #toc.toc2 { margin-top: 0 !important; background-color: #f2f2f2; position: fixed; width: 15em; left: 0; top: 0; border-right: 1px solid #dddddd; border-top-width: 0 !important; border-bottom-width: 0 !important; z-index: 1000; padding: 1.25em 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; font-size: 1.2em; }
  #toc.toc2 > ul { font-size: 0.9em; margin-bottom: 0; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 15em; }
  body.toc2.toc-right #toc.toc2 { border-right-width: 0; border-left: 1px solid #dddddd; left: auto; right: 0; } }
@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; padding-right: 0; }
  #toc.toc2 { width: 20em; }
  #toc.toc2 #toctitle { font-size: 1.375em; }
  #toc.toc2 > ul { font-size: 0.95em; }
  #toc.toc2 ul ul { padding-left: 1.25em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; } }
#content #toc { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 0; border-radius: 0; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }

#footer { max-width: 100%; background-color: #222222; padding: 1.25em; }

#footer-text { color: #dddddd; line-height: 1.44; }

.sect1 { padding-bottom: 0.625em; }

@media only screen and (min-width: 768px) { .sect1 { padding-bottom: 1.25em; } }
.sect1 + .sect1 { border-top: 1px solid #dddddd; }

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; z-index: 1001; width: 1.5ex; margin-left: -1.5ex; display: block; text-decoration: none !important; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: "\00A7"; font-size: 0.85em; display: block; padding-top: 0.1em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #222222; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #151515; }

.audioblock, .imageblock, .literalblock, .listingblock, .stemblock, .videoblock { margin-bottom: 1.25em; }

.admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-rendering: optimizeLegibility; text-align: left; }

table.tableblock > caption.title { white-space: nowrap; overflow: visible; max-width: 0; }

.paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { color: black; }

table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }

.admonitionblock > table { border-collapse: separate; border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #dddddd; color: #555555; }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }

.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 0; border-radius: 0; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }

.sidebarblock { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 0; border-radius: 0; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock > .content > .title { color: #6f6f6f; margin-top: 0; }

.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }

.literalblock pre, .listingblock pre:not(.highlight), .listingblock pre[class="highlight"], .listingblock pre[class^="highlight "], .listingblock pre.CodeRay, .listingblock pre.prettyprint { background: #eeeeee; }
.sidebarblock .literalblock pre, .sidebarblock .listingblock pre:not(.highlight), .sidebarblock .listingblock pre[class="highlight"], .sidebarblock .listingblock pre[class^="highlight "], .sidebarblock .listingblock pre.CodeRay, .sidebarblock .listingblock pre.prettyprint { background: #f2f1f1; }

.literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { border: 1px solid #cccccc; -webkit-border-radius: 0; border-radius: 0; word-wrap: break-word; padding: 0.8em 0.8em 0.65em 0.8em; font-size: 0.8125em; }
.literalblock pre.nowrap, .literalblock pre[class].nowrap, .listingblock pre.nowrap, .listingblock pre[class].nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
@media only screen and (min-width: 768px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 0.90625em; } }
@media only screen and (min-width: 1280px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 1em; } }

.literalblock.output pre { color: #eeeeee; background-color: black; }

.listingblock pre.highlightjs { padding: 0; }
.listingblock pre.highlightjs > code { padding: 0.8em 0.8em 0.65em 0.8em; -webkit-border-radius: 0; border-radius: 0; }

.listingblock > .content { position: relative; }

.listingblock code[data-lang]:before { display: none; content: attr(data-lang); position: absolute; font-size: 0.75em; top: 0.425rem; right: 0.5rem; line-height: 1; text-transform: uppercase; color: #999; }

.listingblock:hover code[data-lang]:before { display: block; }

.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }

.listingblock.terminal pre .command:not([data-prompt]):before { content: "$"; }

table.pyhltable { border-collapse: separate; border: 0; margin-bottom: 0; background: none; }

table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; }

table.pyhltable td.code { padding-left: .75em; padding-right: 0; }

pre.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #dddddd; }

pre.pygments .lineno { display: inline-block; margin-right: .25em; }

table.pyhltable .linenodiv { background: none !important; padding-right: 0 !important; }

.quoteblock { margin: 0 1em 1.25em 1.5em; display: table; }
.quoteblock > .title { margin-left: -1.5em; margin-bottom: 0.75em; }
.quoteblock blockquote, .quoteblock blockquote p { color: #6f6f6f; font-size: 1.15rem; line-height: 1.75; word-spacing: 0.1em; letter-spacing: 0; font-style: italic; text-align: justify; }
.quoteblock blockquote { margin: 0; padding: 0; border: 0; }
.quoteblock blockquote:before { content: "\201c"; float: left; font-size: 2.75em; font-weight: bold; line-height: 0.6em; margin-left: -0.6em; color: #6f6f6f; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: 0.5em; margin-right: 0.5ex; text-align: right; }
.quoteblock .quoteblock { margin-left: 0; margin-right: 0; padding: 0.5em 0; border-left: 3px solid #555555; }
.quoteblock .quoteblock blockquote { padding: 0 0 0 0.75em; }
.quoteblock .quoteblock blockquote:before { display: none; }

.verseblock { margin: 0 1em 1.25em 1em; }
.verseblock pre { font-family: "Open Sans", "DejaVu Sans", sans; font-size: 1.15rem; color: #6f6f6f; font-weight: 300; text-rendering: optimizeLegibility; }
.verseblock pre strong { font-weight: 400; }
.verseblock .attribution { margin-top: 1.25rem; margin-left: 0.5ex; }

.quoteblock .attribution, .verseblock .attribution { font-size: 0.8125em; line-height: 1.45; font-style: italic; }
.quoteblock .attribution br, .verseblock .attribution br { display: none; }
.quoteblock .attribution cite, .verseblock .attribution cite { display: block; letter-spacing: -0.05em; color: #555555; }

.quoteblock.abstract { margin: 0 0 1.25em 0; display: block; }
.quoteblock.abstract blockquote, .quoteblock.abstract blockquote p { text-align: left; word-spacing: 0; }
.quoteblock.abstract blockquote:before, .quoteblock.abstract blockquote p:first-of-type:before { display: none; }

table.tableblock { max-width: 100%; border-collapse: separate; }
table.tableblock td > .paragraph:last-child p > p:last-child, table.tableblock th > p:last-child, table.tableblock td > p:last-child { margin-bottom: 0; }

table.spread { width: 100%; }

table.tableblock, th.tableblock, td.tableblock { border: 0 solid #dddddd; }

table.grid-all th.tableblock, table.grid-all td.tableblock { border-width: 0 1px 1px 0; }

table.grid-all tfoot > tr > th.tableblock, table.grid-all tfoot > tr > td.tableblock { border-width: 1px 1px 0 0; }

table.grid-cols th.tableblock, table.grid-cols td.tableblock { border-width: 0 1px 0 0; }

table.grid-all * > tr > .tableblock:last-child, table.grid-cols * > tr > .tableblock:last-child { border-right-width: 0; }

table.grid-rows th.tableblock, table.grid-rows td.tableblock { border-width: 0 0 1px 0; }

table.grid-all tbody > tr:last-child > th.tableblock, table.grid-all tbody > tr:last-child > td.tableblock, table.grid-all thead:last-child > tr > th.tableblock, table.grid-rows tbody > tr:last-child > th.tableblock, table.grid-rows tbody > tr:last-child > td.tableblock, table.grid-rows thead:last-child > tr > th.tableblock { border-bottom-width: 0; }

table.grid-rows tfoot > tr > th.tableblock, table.grid-rows tfoot > tr > td.tableblock { border-width: 1px 0 0 0; }

table.frame-all { border-width: 1px; }

table.frame-sides { border-width: 0 1px; }

table.frame-topbot { border-width: 1px 0; }

th.halign-left, td.halign-left { text-align: left; }

th.halign-right, td.halign-right { text-align: right; }

th.halign-center, td.halign-center { text-align: center; }

th.valign-top, td.valign-top { vertical-align: top; }

th.valign-bottom, td.valign-bottom { vertical-align: bottom; }

th.valign-middle, td.valign-middle { vertical-align: middle; }

table thead th, table tfoot th { font-weight: bold; }

tbody tr th { display: table-cell; line-height: 1.4; background: whitesmoke; }

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p { color: #222222; font-weight: bold; }

p.tableblock > code:only-child { background: none; padding: 0; }

p.tableblock { font-size: 1em; }

td > div.verse { white-space: pre; }

ol { margin-left: 2.5em; }

ul li ol { margin-left: 1.5em; }

dl dd { margin-left: 1.125em; }

dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }

ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.625em; }

ul.unstyled, ol.unnumbered, ul.checklist, ul.none { list-style-type: none; }

ul.unstyled, ol.unnumbered, ul.checklist { margin-left: 0.625em; }

ul.checklist li > p:first-child > .fa-check-square-o:first-child, ul.checklist li > p:first-child > input[type="checkbox"]:first-child { margin-right: 0.25em; }

ul.checklist li > p:first-child > input[type="checkbox"]:first-child { position: relative; top: 1px; }

ul.inline { margin: 0 auto 0.625em auto; margin-left: -1.375em; margin-right: 0; padding: 0; list-style: none; overflow: hidden; }
ul.inline > li { list-style: none; float: left; margin-left: 1.375em; display: block; }
ul.inline > li > * { display: block; }

.unstyled dl dt { font-weight: normal; font-style: normal; }

ol.arabic { list-style-type: decimal; }

ol.decimal { list-style-type: decimal-leading-zero; }

ol.loweralpha { list-style-type: lower-alpha; }

ol.upperalpha { list-style-type: upper-alpha; }

ol.lowerroman { list-style-type: lower-roman; }

ol.upperroman { list-style-type: upper-roman; }

ol.lowergreek { list-style-type: lower-greek; }

.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }

td.hdlist1 { padding-right: .75em; font-weight: bold; }

td.hdlist1, td.hdlist2 { vertical-align: top; }

.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }

.colist > table tr > td:first-of-type { padding: 0 0.75em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.25em 0; }

.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: 0 0 0 1px #dddddd; box-shadow: 0 0 0 1px #dddddd; }

.imageblock.left, .imageblock[style*="float: left"] { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }

.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }

a.image { text-decoration: none; }

span.footnote, span.footnoteref { vertical-align: super; font-size: 0.875em; }
span.footnote a, span.footnoteref a { text-decoration: none; }
span.footnote a:active, span.footnoteref a:active { text-decoration: underline; }

#footnotes { padding-top: 0.75em; padding-bottom: 0.75em; margin-bottom: 0.625em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -.25em 0 .75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.375em; line-height: 1.3; font-size: 0.875em; margin-left: 1.2em; text-indent: -1.2em; margin-bottom: .2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }

#content #footnotes { margin-top: -0.625em; margin-bottom: 0; padding: 0.75em 0; }

.gist .file-data > table { border: 0; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }

div.unbreakable { page-break-inside: avoid; }

.big { font-size: larger; }

.small { font-size: smaller; }

.underline { text-decoration: underline; }

.overline { text-decoration: overline; }

.line-through { text-decoration: line-through; }

.aqua { color: #00bfbf; }

.aqua-background { background-color: #00fafa; }

.black { color: black; }

.black-background { background-color: black; }

.blue { color: #0000bf; }

.blue-background { background-color: #0000fa; }

.fuchsia { color: #bf00bf; }

.fuchsia-background { background-color: #fa00fa; }

.gray { color: #606060; }

.gray-background { background-color: #7d7d7d; }

.green { color: #006000; }

.green-background { background-color: #007d00; }

.lime { color: #00bf00; }

.lime-background { background-color: #00fa00; }

.maroon { color: #600000; }

.maroon-background { background-color: #7d0000; }

.navy { color: #000060; }

.navy-background { background-color: #00007d; }

.olive { color: #606000; }

.olive-background { background-color: #7d7d00; }

.purple { color: #600060; }

.purple-background { background-color: #7d007d; }

.red { color: #bf0000; }

.red-background { background-color: #fa0000; }

.silver { color: #909090; }

.silver-background { background-color: #bcbcbc; }

.teal { color: #006060; }

.teal-background { background-color: #007d7d; }

.white { color: #bfbfbf; }

.white-background { background-color: #fafafa; }

.yellow { color: #bfbf00; }

.yellow-background { background-color: #fafa00; }

span.icon > .fa { cursor: default; }

.admonitionblock td.icon [class^="fa icon-"] { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #207c98; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }

.conum[data-value] { display: inline-block; color: #fff !important; background-color: #222222; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; font-size: 0.75em; width: 1.67em; height: 1.67em; line-height: 1.67em; font-family: "Open Sans", "DejaVu Sans", sans-serif; font-style: normal; font-weight: bold; }
.conum[data-value] * { color: #fff !important; }
.conum[data-value] + b { display: none; }
.conum[data-value]:after { content: attr(data-value); }
pre .conum[data-value] { position: relative; top: -0.125em; }

b.conum * { color: inherit !important; }

.conum:not([data-value]):empty { display: none; }

.literalblock pre, .listingblock pre { background: #eeeeee; }

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.min.css">
<style>.listingblock .pygments .hll { background-color: #ffffcc }
.listingblock .pygments  { background: #f8f8f8; }
.listingblock .pygments .tok-c { color: #408080; font-style: italic } /* Comment */
.listingblock .pygments .tok-err { border: 1px solid #FF0000 } /* Error */
.listingblock .pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
.listingblock .pygments .tok-o { color: #666666 } /* Operator */
.listingblock .pygments .tok-cm { color: #408080; font-style: italic } /* Comment.Multiline */
.listingblock .pygments .tok-cp { color: #BC7A00 } /* Comment.Preproc */
.listingblock .pygments .tok-c1 { color: #408080; font-style: italic } /* Comment.Single */
.listingblock .pygments .tok-cs { color: #408080; font-style: italic } /* Comment.Special */
.listingblock .pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
.listingblock .pygments .tok-ge { font-style: italic } /* Generic.Emph */
.listingblock .pygments .tok-gr { color: #FF0000 } /* Generic.Error */
.listingblock .pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
.listingblock .pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
.listingblock .pygments .tok-go { color: #888888 } /* Generic.Output */
.listingblock .pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.listingblock .pygments .tok-gs { font-weight: bold } /* Generic.Strong */
.listingblock .pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.listingblock .pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
.listingblock .pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.listingblock .pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.listingblock .pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.listingblock .pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
.listingblock .pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.listingblock .pygments .tok-kt { color: #B00040 } /* Keyword.Type */
.listingblock .pygments .tok-m { color: #666666 } /* Literal.Number */
.listingblock .pygments .tok-s { color: #BA2121 } /* Literal.String */
.listingblock .pygments .tok-na { color: #7D9029 } /* Name.Attribute */
.listingblock .pygments .tok-nb { color: #008000 } /* Name.Builtin */
.listingblock .pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
.listingblock .pygments .tok-no { color: #880000 } /* Name.Constant */
.listingblock .pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
.listingblock .pygments .tok-ni { color: #999999; font-weight: bold } /* Name.Entity */
.listingblock .pygments .tok-ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.listingblock .pygments .tok-nf { color: #0000FF } /* Name.Function */
.listingblock .pygments .tok-nl { color: #A0A000 } /* Name.Label */
.listingblock .pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.listingblock .pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
.listingblock .pygments .tok-nv { color: #19177C } /* Name.Variable */
.listingblock .pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.listingblock .pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
.listingblock .pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
.listingblock .pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
.listingblock .pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
.listingblock .pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
.listingblock .pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
.listingblock .pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
.listingblock .pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
.listingblock .pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.listingblock .pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
.listingblock .pygments .tok-se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.listingblock .pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
.listingblock .pygments .tok-si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.listingblock .pygments .tok-sx { color: #008000 } /* Literal.String.Other */
.listingblock .pygments .tok-sr { color: #BB6688 } /* Literal.String.Regex */
.listingblock .pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
.listingblock .pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
.listingblock .pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
.listingblock .pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
.listingblock .pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
.listingblock .pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
.listingblock .pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>NoSQL</h1>
<div class="details">
<span id="author" class="author">Aitor Medrano</span><br>
<span id="email" class="email">&lt;<a href="mailto:aitormedrano@gmail.com">aitormedrano@gmail.com</a>&gt;</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Índice de contenidos</div>
<ul class="sectlevel1">
<li><a href="#sesion02">2. MongoDB</a>
<ul class="sectlevel2">
<li><a href="#_bson">2.1. BSON</a></li>
<li><a href="#_trabajando_con_el_shell">2.2. Trabajando con el shell</a>
<ul class="sectlevel3">
<li><a href="#_empleando_em_javascript_em">2.2.1. Empleando <em>JavaScript</em></a></li>
</ul>
</li>
<li><a href="#_objectid">2.3. ObjectId</a></li>
<li><a href="#_consultas">2.4. Consultas</a>
<ul class="sectlevel3">
<li><a href="#_criterios_en_consultas">2.4.1. Criterios en consultas</a></li>
<li><a href="#_proyecci%C3%B3n_de_campos">2.4.2. Proyección de campos</a></li>
<li><a href="#_condiciones_sobre_objetos_anidados">2.4.3. Condiciones sobre objetos anidados</a></li>
<li><a href="#_condiciones_compuestas_con_y_o">2.4.4. Condiciones compuestas con Y / O</a></li>
<li><a href="#_consultas_sobre_arrays">2.4.5. Consultas sobre arrays</a></li>
<li><a href="#_conjunto_de_valores">2.4.6. Conjunto de valores</a></li>
<li><a href="#_cursores">2.4.7. Cursores</a></li>
<li><a href="#_contando_documentos">2.4.8. Contando Documentos</a></li>
</ul>
</li>
<li><a href="#_actualizando_documentos">2.5. Actualizando documentos</a>
<ul class="sectlevel3">
<li><a href="#_operadores_de_actualizaci%C3%B3n">2.5.1. Operadores de actualización</a></li>
<li><a href="#_actualizaci%C3%B3n_m%C3%BAltiple">2.5.2. Actualización múltiple</a></li>
<li><a href="#_actualizaciones_sobre_arrays">2.5.3. Actualizaciones sobre Arrays</a></li>
</ul>
</li>
<li><a href="#_borrando_documentos">2.6. Borrando documentos</a></li>
<li><a href="#_control_de_errores">2.7. Control de errores</a></li>
<li><a href="#__em_mongodb_em_desde_em_java_em">2.8. <em>MongoDB</em> desde <em>Java</em></a>
<ul class="sectlevel3">
<li><a href="#__code_mongoclient_code">2.8.1. <code>MongoClient</code></a></li>
<li><a href="#__code_dbobject_code">2.8.2. <code>DBObject</code></a></li>
<li><a href="#_inserci%C3%B3n">2.8.3. Inserción</a></li>
<li><a href="#_consultas_2">2.8.4. Consultas</a></li>
<li><a href="#_modificaci%C3%B3n">2.8.5. Modificación</a></li>
<li><a href="#_borrado">2.8.6. Borrado</a></li>
<li><a href="#__code_mongodb_driver_code">2.8.7. <code>mongodb-driver</code></a></li>
</ul>
</li>
<li><a href="#_mapping_de_objetos">2.9. Mapping de objetos</a></li>
<li><a href="#_ejercicios">2.10. Ejercicios</a>
<ul class="sectlevel3">
<li><a href="#__1_punto_ejercicio_21_consultas_desde_code_mongo_code">2.10.1. (1 punto) Ejercicio 21. Consultas desde <code>mongo</code></a></li>
<li><a href="#__1_punto_ejercicio_22_modificaciones_desde_code_mongo_code">2.10.2. (1 punto) Ejercicio 22. Modificaciones desde <code>mongo</code></a></li>
<li><a href="#__1_5_puntos_ejercicio_23_operaciones_desde_em_java_em">2.10.3. (1.5 puntos) Ejercicio 23. Operaciones desde <em>Java</em></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="sesion02">2. MongoDB</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ya hemos visto que <em>MongoDB</em> es una base de datos documental, que agrupa los documentos en colecciones.</p>
</div>
<div class="paragraph">
<p>En esta sesión estudiaremos la estructura de estos documentos, y como podemos interactuar con ellos.</p>
</div>
<div class="sect2">
<h3 id="_bson">2.1. BSON</h3>
<div class="paragraph">
<p>Mediante <em>JavaScript</em> podemos crear objetos que se representan con JSON. Internamente, <em>MongoDB</em> almacena los documentos en BSON (<em>Binary JSON</em>). Podemos consultar la especificación en <a href="http://BSONSpec.org" class="bare">http://BSONSpec.org</a></p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql02/bson.jpg" alt="Especificación BSON" width="66%">
</div>
<div class="title">Figure 1. Especificación BSON</div>
</div>
<div class="paragraph">
<p>BSON representa un superset de JSON, ya que:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Almacena datos en binario</p>
</li>
<li>
<p>Incluye un conjunto de tipos de datos no incluidos en JSON, como pueden ser <code>ObjectId</code>, <code>Date</code> o <code>BinData</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Podemos consultar todos los tipos que soporta un objeto <em>BSON</em> en <a href="http://docs.mongodb.org/manual/reference/bson-types/" class="bare">http://docs.mongodb.org/manual/reference/bson-types/</a></p>
</div>
<div class="listingblock">
<div class="title">Ejemplo de objeto BSON</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">yo</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
  <span class="tok-nx">nombre</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Aitor&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">apellidos</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Medrano&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">fnac</span><span class="tok-o">:</span> <span class="tok-k">new</span> <span class="tok-nb">Date</span><span class="tok-p">(</span><span class="tok-s2">&quot;Oct 3, 1977&quot;</span><span class="tok-p">),</span>
  <span class="tok-nx">hobbies</span><span class="tok-o">:</span> <span class="tok-p">[</span><span class="tok-s2">&quot;programación&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;videojuegos&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;baloncesto&quot;</span><span class="tok-p">],</span>
  <span class="tok-nx">casado</span><span class="tok-o">:</span> <span class="tok-kc">true</span><span class="tok-p">,</span>
  <span class="tok-nx">hijos</span><span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
  <span class="tok-nx">fechaCreacion</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Timestamp</span><span class="tok-p">()</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Los documentos BSON tienen las siguientes restricciones:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>no pueden tener un tamaño superior a 16 MB.</p>
</li>
<li>
<p>el atributo <code>_id</code> queda reservado para la clave primaria.</p>
</li>
<li>
<p>los nombres de los campos no pueden empezar por <code>$</code>.</p>
</li>
<li>
<p>los nombres de los campos no pueden contener el <code>.</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Además <em>MongoDB</em>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>no asegura que el orden de los campos se respete.</p>
</li>
<li>
<p>es sensible a los tipos de los datos</p>
</li>
<li>
<p>es sensible a las mayúsculas.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Por lo que estos documentos son distintos:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo de objetos con tipos distintos y atributos diferentes</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span><span class="tok-s2">&quot;edad&quot;</span><span class="tok-o">:</span> <span class="tok-s2">&quot;18&quot;</span><span class="tok-p">}</span>
<span class="tok-p">{</span><span class="tok-s2">&quot;edad&quot;</span><span class="tok-o">:</span> <span class="tok-mi">18</span><span class="tok-p">}</span>
<span class="tok-p">{</span><span class="tok-s2">&quot;Edad&quot;</span><span class="tok-o">:</span> <span class="tok-mi">18</span><span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si queremos validar si un documento JSON es válido, podemos usar <a href="http://jsonlint.com/" class="bare">http://jsonlint.com/</a>. Hemos de tener en cuenta que sólo valida JSON y no BSON, por tanto nos dará errores en los tipos de datos propios de BSON.</p>
</div>
</div>
<div class="sect2">
<h3 id="_trabajando_con_el_shell">2.2. Trabajando con el shell</h3>
<div class="paragraph">
<p>Antes de entrar en detalles en las instrucciones necesarias para realizar las operaciones CRUD, veamos algunos comandos que nos serán muy utiles al interactuar con el shell:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. Comandos útiles dentro del cliente de <em>MongoDB</em></caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Comando</th>
<th class="tableblock halign-left valign-top">Función</th>
</tr>
</thead>
<tbody>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock"><code>show dbs</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Muestra el nombre de las bases de datos</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock"><code>show collections</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Muestra el nombre de las colecciones</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock"><code>db</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Muestra el nombre de la base de datos que estamos utilizando</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock"><code>db.dropDatabase()</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Elimina la base de datos actual</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock"><code>db.help()</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Muestra los comandos disponibles</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock"><code>db.version()</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Muestra la versión actual del servidor</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>En el resto de la sesión vamos a hacer un uso intenso del shell de <em>MongoDB</em>. Por ejemplo, si nos basamos en el objeto definido en el apartado de BSON, podemos ejecutar las siguientes instrucciones:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplos de interacción con el shell</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">insert</span><span class="tok-p">(</span><span class="tok-nx">yo</span><span class="tok-p">)</span>        <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">()</span>            <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;53274f9883a7adeb6a573e64&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;nombre&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Aitor&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;apellidos&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Medrano&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;fnac&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ISODate</span><span class="tok-p">(</span><span class="tok-s2">&quot;1977-10-02T23:00:00Z&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;hobbies&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span>  <span class="tok-s2">&quot;programación&quot;</span><span class="tok-p">,</span>  <span class="tok-s2">&quot;videojuegos&quot;</span><span class="tok-p">,</span>  <span class="tok-s2">&quot;baloncesto&quot;</span> <span class="tok-p">],</span> <span class="tok-s2">&quot;casado&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">true</span><span class="tok-p">,</span> <span class="tok-s2">&quot;hijos&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span> <span class="tok-s2">&quot;fechaCreacion&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">Timestamp</span><span class="tok-p">(</span><span class="tok-mi">1425633249</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">)</span> <span class="tok-p">}</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">yo</span><span class="tok-p">.</span><span class="tok-nx">email</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;aitormedrano@gmail.com&quot;</span>
<span class="tok-nx">aitormedrano</span><span class="tok-err">@</span><span class="tok-nx">gmail</span><span class="tok-p">.</span><span class="tok-nx">com</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">save</span><span class="tok-p">(</span><span class="tok-nx">yo</span><span class="tok-p">)</span>          <i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">()</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;53274f9883a7adeb6a573e64&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;nombre&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Aitor&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;apellidos&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Medrano&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;fnac&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ISODate</span><span class="tok-p">(</span><span class="tok-s2">&quot;1977-10-02T23:00:00Z&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;hobbies&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span>  <span class="tok-s2">&quot;programación&quot;</span><span class="tok-p">,</span>  <span class="tok-s2">&quot;videojuegos&quot;</span><span class="tok-p">,</span>  <span class="tok-s2">&quot;baloncesto&quot;</span> <span class="tok-p">],</span> <span class="tok-s2">&quot;casado&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">true</span><span class="tok-p">,</span> <span class="tok-s2">&quot;hijos&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span> <span class="tok-s2">&quot;fechaCreacion&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">Timestamp</span><span class="tok-p">(</span><span class="tok-mi">1425633249</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">)</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;53274fca83a7adeb6a573e65&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;nombre&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Aitor&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;apellidos&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Medrano&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;fnac&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ISODate</span><span class="tok-p">(</span><span class="tok-s2">&quot;1977-10-02T23:00:00Z&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;hobbies&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span>  <span class="tok-s2">&quot;programación&quot;</span><span class="tok-p">,</span>  <span class="tok-s2">&quot;videojuegos&quot;</span><span class="tok-p">,</span>  <span class="tok-s2">&quot;baloncesto&quot;</span> <span class="tok-p">],</span> <span class="tok-s2">&quot;casado&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">true</span><span class="tok-p">,</span> <span class="tok-s2">&quot;hijos&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span> <span class="tok-s2">&quot;fechaCreacion&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">Timestamp</span><span class="tok-p">(</span><span class="tok-mi">1425633373</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">),</span> <span class="tok-s2">&quot;email&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;aitormedrano@gmail.com&quot;</span> <span class="tok-p">}</span>      <i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">().</span><span class="tok-nx">forEach</span><span class="tok-p">(</span><span class="tok-nx">printjson</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Si queremos insertar un documento en una colección, hemos de utilizar el método <code><strong>insert</strong></code> (<a href="http://docs.mongodb.org/master/reference/method/db.collection.insert/" class="bare">http://docs.mongodb.org/master/reference/method/db.collection.insert/</a>) pasándole como parámetro el documento que queremos insertar.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code><strong>find</strong></code> permite recuperar documentos</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code><strong>save</strong></code> es similar a <code>insert</code>, pero si existe un documento con el mismo <code>ObjectId</code>, realizará un <code>update</code> (realmente un <code>upsert</code>)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Hay dos documentos porque al guardar el segundo se le ha asignado un nuevo <code>ObjectId</code>. Además, los dos documentos no tienen el mismo número de campos, y la fechaCreación se ha actualizado con el <em>timestamp</em> actual.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Otros ejemplos tanto de <code>insert</code> como de <code>save</code> con objetos directos, sin necesidad de usar variables, serían:</p>
</div>
<div class="listingblock">
<div class="title">Inserción y Guardado</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">insert</span><span class="tok-p">({</span> <span class="tok-nx">nombre</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Aitor&quot;</span><span class="tok-p">,</span> <span class="tok-nx">edad</span> <span class="tok-o">:</span> <span class="tok-mi">37</span><span class="tok-p">,</span> <span class="tok-nx">profesion</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Profesor&quot;</span> <span class="tok-p">})</span>
<span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">save</span><span class="tok-p">({</span> <span class="tok-nx">nombre</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Aitor&quot;</span><span class="tok-p">,</span> <span class="tok-nx">edad</span> <span class="tok-o">:</span> <span class="tok-mi">37</span><span class="tok-p">,</span> <span class="tok-nx">profesion</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Profesor&quot;</span> <span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Autoevaluación</div>
<div class="paragraph">
<p>Al ejecutar las dos instrucciones anteriores sobre una colección vacía ¿Cuantos registros tendrá la colección? <span class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnote_1" title="View footnote.">1</a>]</span></p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_empleando_em_javascript_em">2.2.1. Empleando <em>JavaScript</em></h4>
<div class="paragraph">
<p>Ya hemos comentado que el <em>shell</em> utiliza <em>JavaScript</em> como lenguaje de interacción, por lo que podemos almacenar los comandos en un <em>script</em> externo y ejecutarlo mediante <code>load()</code>:</p>
</div>
<div class="listingblock">
<div class="title">Carga de <em>script</em></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">load</span><span class="tok-p">(</span><span class="tok-s2">&quot;scripts/misDatos.js&quot;</span><span class="tok-p">);</span>   <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-nx">load</span><span class="tok-p">(</span><span class="tok-s2">&quot;/data/db/scripts/misDatos.js&quot;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Si hacemos una referencia relativa, lo hace respecto a la ruta desde la cual se ejecuta el <em>shell</em> <code>mongo</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Otra manera de lanzar un <em>script</em> es hacerlo desde la línea de comandos, pasándole como segundo parámetro el script a ejecutar:</p>
</div>
<div class="listingblock">
<div class="title">Ejecución de <em>script</em></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">mongo expertojava misDatos.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>Si el código a ejecutar no necesita almacenarse en un <em>script</em> externo, el propio <em>shell</em> permite introducir instrucciones en varias líneas:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql02/shellJS.jpg" alt="Uso de JavaScript en el shell" width="{xlarge-size}">
</div>
<div class="title">Figure 2. Uso de <em>JavaScript</em> en el shell</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_objectid">2.3. ObjectId</h3>
<div class="paragraph">
<p>En <em>MongoDB</em>, el atributo <code>_id</code> es único dentro de la colección, y hace la función de clave primaria. Se le asocia un <code>ObjectId</code> (<a href="http://docs.mongodb.org/manual/reference/object-id/" class="bare">http://docs.mongodb.org/manual/reference/object-id/</a>), el cual es un tipo BSON de 12 bytes que se crea mediante:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>el <em>timestamp</em> actual (<em>4 bytes</em>)</p>
</li>
<li>
<p>un identificador de la máquina / <em>hostname</em> (<em>3 bytes</em>) donde se genera</p>
</li>
<li>
<p>un identificador del proceso (<em>2 bytes</em>) donde se genera</p>
</li>
<li>
<p>un número aleatorio (<em>3 bytes</em>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Este objeto lo crea el driver y no <em>MongoDB</em>, por lo cual no deberemos considerar que siguen un orden concreto, ya que clientes diferentes pueden tener <em>timestamps</em> desincronizados. Lo que sí que podemos obtener a partir del <code>ObjectId</code> es la fecha de creación del documento, mediante el método <code>getTimestamp()</code> del atributo <code>_id</code>.</p>
</div>
<div class="listingblock">
<div class="title">Obteniendo la fecha de creación de un documento</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">()[</span><span class="tok-mi">0</span><span class="tok-p">].</span><span class="tok-nx">_id</span>
<span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;53274f9883a7adeb6a573e64&quot;</span><span class="tok-p">)</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">()[</span><span class="tok-mi">0</span><span class="tok-p">].</span><span class="tok-nx">_id</span><span class="tok-p">.</span><span class="tok-nx">getTimestamp</span><span class="tok-p">()</span>
<span class="tok-nx">ISODate</span><span class="tok-p">(</span><span class="tok-s2">&quot;2014-03-17T19:40:08Z&quot;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Este identificador es <strong>global, único e inmutable</strong>. Esto es, no habrá dos repetidos y una vez un documento tiene un <code>_id</code>, éste no se puede modificar.</p>
</div>
<div class="paragraph">
<p>Si en la definición del objeto a insertar no ponemos el atributo identificador, <em>MongoDB</em> creará uno de manera automática. Si lo ponemos nosotros de manera explícita, <em>MongoDB</em> no añadirá ningún <code>ObjectId</code>. Eso sí, debemos asegurarnos que sea único (podemos usar números, cadenas, etc&#8230;&#8203;).</p>
</div>
<div class="paragraph">
<p>Por lo tanto, podemos hacer esto:</p>
</div>
<div class="listingblock">
<div class="title">Asignando un identificador al insertar</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">insert</span><span class="tok-p">({</span><span class="tok-nx">_id</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-p">,</span> <span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s2">&quot;Marina&quot;</span><span class="tok-p">,</span> <span class="tok-nx">edad</span><span class="tok-o">:</span><span class="tok-mi">6</span> <span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Cuidado con los tipos, ya que no es lo mismo insertar un atributo con <code>edad:6</code> (se considera el campo como entero) que con <code>edad:"6"</code>, ya que considera el campo como texto.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>O también, si queremos podemos hacer que el <code>_id</code> de un documento sea un documento en sí, y no un entero, para ello, al insertarlo, podemos asignarle un objeto JSON al atributo identificador:</p>
</div>
<div class="listingblock">
<div class="title">Insertanto un documento cuyo identificador es otro documento</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">insert</span><span class="tok-p">({</span><span class="tok-nx">_id</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s1">&#39;Aitor&#39;</span><span class="tok-p">,</span> <span class="tok-nx">apellidos</span><span class="tok-o">:</span><span class="tok-s1">&#39;Medrano&#39;</span><span class="tok-p">,</span> <span class="tok-nx">twitter</span><span class="tok-o">:</span><span class="tok-s1">&#39;@aitormedrano&#39;</span><span class="tok-p">},</span> <span class="tok-nx">ciudad</span><span class="tok-o">:</span><span class="tok-s1">&#39;Elx&#39;</span><span class="tok-p">})</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_consultas">2.4. Consultas</h3>
<div class="paragraph">
<p>Para recuperar los datos de una colección o un documento en concreto usaremos el método <code>find()</code>:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo de consulta con <code>find()</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">()</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;53274f9883a7adeb6a573e64&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;nombre&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Aitor&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;apellidos&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Medrano&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;fnac&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ISODate</span><span class="tok-p">(</span><span class="tok-s2">&quot;1977-10-02T23:00:00Z&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;hobbies&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span>  <span class="tok-s2">&quot;programación&quot;</span><span class="tok-p">,</span>  <span class="tok-s2">&quot;videojuegos&quot;</span><span class="tok-p">,</span>  <span class="tok-s2">&quot;baloncesto&quot;</span> <span class="tok-p">],</span> <span class="tok-s2">&quot;casado&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">true</span><span class="tok-p">,</span> <span class="tok-s2">&quot;hijos&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;53274fca83a7adeb6a573e65&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;nombre&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Aitor&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;apellidos&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Medrano&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;fnac&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ISODate</span><span class="tok-p">(</span><span class="tok-s2">&quot;1977-10-02T23:00:00Z&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;hobbies&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span>  <span class="tok-s2">&quot;programación&quot;</span><span class="tok-p">,</span>  <span class="tok-s2">&quot;videojuegos&quot;</span><span class="tok-p">,</span>  <span class="tok-s2">&quot;baloncesto&quot;</span> <span class="tok-p">],</span> <span class="tok-s2">&quot;casado&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">true</span><span class="tok-p">,</span> <span class="tok-s2">&quot;hijos&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span> <span class="tok-s2">&quot;email&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;aitormedrano@gmail.com&quot;</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">3</span><span class="tok-p">,</span> <span class="tok-s2">&quot;nombre&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Marina&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;edad&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">6</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El método <code>find()</code> sobre una colección devuelve un cursor a los datos obtenidos, el cual se queda abierto con el servidor y que se cierra automáticamente a los 10 minutos de inactividad o al finalizar su recorrido. Si hay muchos resultados, la consola nos mostrará un subconjunto de los datos (20). Si queremos seguir obtiendo resultados, solo tenemos que introducir <code>it</code>, para que continúe iterando el cursor.</p>
</div>
<div class="paragraph">
<p>Si queremos que el resultado sea más legible, podemos recorrer la consulta y mostrar una vista tabulada mediante <code>printjson</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">().</span><span class="tok-nx">forEach</span><span class="tok-p">(</span><span class="tok-nx">printjson</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En cambio, si sólo queremos recuperar un documento hemos de utilizar <code>findOne()</code>:</p>
</div>
<div class="listingblock">
<div class="title">Recuperando un único documento</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">findOne</span><span class="tok-p">()</span>
<span class="tok-p">{</span>
  <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;53274f9883a7adeb6a573e64&quot;</span><span class="tok-p">),</span>
  <span class="tok-s2">&quot;nombre&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Aitor&quot;</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;apellidos&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Medrano&quot;</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;fnac&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ISODate</span><span class="tok-p">(</span><span class="tok-s2">&quot;1977-10-02T23:00:00Z&quot;</span><span class="tok-p">),</span>
  <span class="tok-s2">&quot;hobbies&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span>
    <span class="tok-s2">&quot;programación&quot;</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;videojuegos&quot;</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;baloncesto&quot;</span>
  <span class="tok-p">],</span>
  <span class="tok-s2">&quot;casado&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">true</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;hijos&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Se puede observar que al recuperar un documento con <code>findOne</code>, se muestra una vista formateada. Si queremos que esta vista se aplique a un documento encontrado con <code>find</code> podemos utilizar el sufijo <code>.pretty()</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">().</span><span class="tok-nx">pretty</span><span class="tok-p">()</span></code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Preparando los ejemplos</div>
<div class="paragraph">
<p>Para los siguientes ejemplos, vamos a utilizar una colección de 800 calificaciones que han obtenido diferentes estudiantes en trabajos, exámenes o cuestionarios.</p>
</div>
<div class="paragraph">
<p>Para ello, importaremos la colección <a href="resources/nosql/grades.json.txt">grades.json</a> mediante:</p>
</div>
<div class="listingblock">
<div class="title">Importanto <a href="resources/nosql/grades.json.txt">grades.json</a></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">mongoimport -d expertojava -c grades --file grades.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>Un ejemplo de una calificación sería:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">findOne</span><span class="tok-p">()</span>
<span class="tok-p">{</span>
  <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;50906d7fa3c412bb040eb577&quot;</span><span class="tok-p">),</span>
  <span class="tok-s2">&quot;student_id&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">0</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;type&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;exam&quot;</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;score&quot;</span> <span class="tok-o">:</span> <span class="tok-mf">54.6535436362647</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El campo <code>type</code> puede tomar los siguientes valores: <em>quiz</em>, <em>homework</em> o <em>exam</em></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_criterios_en_consultas">2.4.1. Criterios en consultas</h4>
<div class="paragraph">
<p>Al hacer una consulta, si queremos obtener datos mediante más de un criterio, en el primer parámetro del <code>find</code> podemos pasar un objeto JSON con los campos a cumplir (condición Y).</p>
</div>
<div class="listingblock">
<div class="title">Consulta con dos condiciones</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-nx">student_id</span><span class="tok-o">:</span><span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-nx">type</span><span class="tok-o">:</span><span class="tok-s2">&quot;quiz&quot;</span><span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Consejo de Rendimiento</div>
<div class="paragraph">
<p>Las consultas disyuntivas, es decir, con varios criterios u operador <code>$and</code>, deben filtrar el conjunto más pequeño cuanto más pronto posible.</p>
</div>
<div class="paragraph">
<p>Supongamos que vamos a consultar documentos que cumplen los criterios A, B y C. Digamos que el criterio A lo cumplen 40.000 documentos, el B lo hacen 9.000 y el C sólo 200.
Si filtramos A, luego B, y finalmente C, el conjunto que trabaja cada criterio es muy grande.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql02/andABC.jpg" alt="Restringiendo consultas AND" width="66%">
</div>
<div class="title">Figure 3. Restringiendo consultas AND de mayor a menor</div>
</div>
<div class="paragraph">
<p>En cambio, si hacemos una consulta que primero empiece por el criterio más restrictivo, el resultado con lo que se intersecciona el siguiente criterio es menor, y por tanto, se realizará más rápido.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql02/andCBA.jpg" alt="Restringiendo consultas AND" width="66%">
</div>
<div class="title">Figure 4. Restringiendo consultas AND de menor a mayor</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>MongoDB</em> también ofrece operadores lógicos para los campos numéricos:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 2. Operadores lógicos</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Comparador</th>
<th class="tableblock halign-left valign-top">Operador</th>
</tr>
</thead>
<tbody>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">menor que (<code>&lt;</code>)</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>$lt</code></p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">menor o igual que (<code>≤</code>)</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>$lte</code></p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">mayor que (<code>&gt;</code>)</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>$gt</code></p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock">mayor o igual que (<code>≥</code>)</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>$gte</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Estos operadores se pueden utilizar de forma simultánea sobre un mismo campo o sobre diferentes campos, y se colocan como un nuevo documento en el valor del campo a filtrar, compuesto del operador y del valor a comparar:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplos de consultas con operadores relacionales</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span> <span class="tok-nx">score</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$gt</span><span class="tok-o">:</span><span class="tok-mi">95</span><span class="tok-p">}</span> <span class="tok-p">})</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span> <span class="tok-nx">score</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$gt</span><span class="tok-o">:</span><span class="tok-mi">95</span><span class="tok-p">,</span> <span class="tok-nx">$lte</span><span class="tok-o">:</span><span class="tok-mi">98</span><span class="tok-p">},</span> <span class="tok-nx">type</span><span class="tok-o">:</span><span class="tok-s2">&quot;exam&quot;</span> <span class="tok-p">})</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span> <span class="tok-nx">type</span><span class="tok-o">:</span><span class="tok-s2">&quot;exam&quot;</span><span class="tok-p">,</span> <span class="tok-nx">score</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$gte</span><span class="tok-o">:</span><span class="tok-mi">65</span><span class="tok-p">}</span> <span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para los campos de texto, además de la comparación directa, podemos usar el operador <code>$ne</code> para obtener los documentos cuyo campos <strong>no</strong> tienen un determinado valor. Así pues, podemos usarlo para averiguar todas las calificaciones que no sean cuestionarios (<em>quiz</em>):</p>
</div>
<div class="listingblock">
<div class="title">Consulta con <em>not equal</em></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-nx">type</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$ne</span><span class="tok-o">:</span><span class="tok-s2">&quot;quiz&quot;</span><span class="tok-p">}})</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Mucho cuidado al usar polimorfismo y almacenar en un mismo campo un entero y una cadena, ya que al hacer comparaciones para recuperar datos, no vamos a poder mezclar cadenas con valores numéricos. Se considera un antipatrón el mezclar tipos de datos en un campo.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Las comparaciones de cadenas se realizan siguiendo el orden UTF8, similar a ASCII, con lo cual no es lo mismo buscar un rango entre mayúsculas que minúsculas.</p>
</div>
<div class="paragraph">
<p>Con cierto parecido a la condición de valor no nulo de las BBDD relacionales y teniendo en cuenta que la libertad de esquema puede provocar que un documento tenga unos campos determinados y otro no lo tenga, podemos utilizar el operador <code>$exists</code> si queremos averiguar si un campo existe (y por tanto tiene algún valor).</p>
</div>
<div class="listingblock">
<div class="title">Consulta con condición de existencia de un campo</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-s2">&quot;score&quot;</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$exists</span><span class="tok-o">:</span><span class="tok-kc">true</span><span class="tok-p">}})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pese a que ciertos operadores contengan su correspondiente operador negado, <em>MongoDB</em> ofrece el operador <code>$not</code>. Éste puede utilizarse conjuntamente con otros operadores para negar el resultado de los documentos obtenidos.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, si queremos obtener todas las calificaciones que no sean múltiplo de 5, podríamos hacerlo así:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo de consulta con negación</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-nx">score</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$not</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-nx">$mod</span><span class="tok-o">:</span> <span class="tok-p">[</span><span class="tok-mi">5</span><span class="tok-p">,</span><span class="tok-mi">0</span><span class="tok-p">]}}})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finalmente, si queremos realizar consultas sobre partes de un campo de texto, hemos de emplear expresiones regulares. Para ello, tenemos el operador <code>$regexp</code> o, de manera más sencilla, indicando como valor la expresión regular a cumplir:</p>
</div>
<div class="paragraph">
<p>Por ejemplo, para buscar las personas cuyo nombre contenga la palabra <code>Aitor</code>:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo de consulta con expresión regular</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-sr">/Aitor/</span><span class="tok-p">})</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-sr">/aitor/i</span><span class="tok-p">})</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-nx">nombre</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-nx">$regex</span><span class="tok-o">:</span><span class="tok-sr">/aitor/i</span><span class="tok-p">}})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ya vimos en el módulo de <em>JavaScript</em> la flexibilidad y potencia que ofrecen las expresiones regulares. Para profundizar en su uso mediante <em>MongoDB</em> podéis obtener más información sobre el operador <code>$regex</code> en <a href="http://docs.mongodb.org/manual/reference/operator/query/regex/#op._S_regex" class="bare">http://docs.mongodb.org/manual/reference/operator/query/regex/#op._S_regex</a></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Otros operadores</div>
<div class="paragraph">
<p>Algunos operadores que conviene citar aunque su uso es más bien ocasional son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Si queremos recuperar documentos que dependan del tipo de campo que contiene, podemos preguntar con <code>$type</code>
<a href="http://docs.mongodb.org/manual/reference/operator/query/type/" class="bare">http://docs.mongodb.org/manual/reference/operator/query/type/</a></p>
</li>
<li>
<p>El operador <code>$where</code> permite introducir una expresión <em>JavaScript</em>
<a href="http://docs.mongodb.org/manual/reference/operator/query/where/" class="bare">http://docs.mongodb.org/manual/reference/operator/query/where/</a></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_proyección_de_campos">2.4.2. Proyección de campos</h4>
<div class="paragraph">
<p>Las consultas realizadas hasta ahora devuelven los documentos completos. Si queremos que devuelva un campo o varios campos en concreto, hemos de pasar un segundo parámetro de tipo JSON con aquellos campos que deseamos mostrar con el valor <code>true</code> o <code>1</code>. Destacar que si no se indica nada, por defecto siempre mostrará el campo <code>_id</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">findOne</span><span class="tok-p">({</span><span class="tok-nx">student_id</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-p">},{</span><span class="tok-nx">score</span><span class="tok-o">:</span><span class="tok-kc">true</span><span class="tok-p">});</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;50906d7fa3c412bb040eb583&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;score&quot;</span> <span class="tok-o">:</span> <span class="tok-mf">92.6244233936537</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por lo tanto, si queremos que no se muestre el <code>_id</code>, lo podremos a <code>false</code> o <code>0</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">findOne</span><span class="tok-p">({</span><span class="tok-nx">student_id</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-p">},{</span><span class="tok-nx">score</span><span class="tok-o">:</span><span class="tok-kc">true</span><span class="tok-p">,</span> <span class="tok-nx">_id</span><span class="tok-o">:</span><span class="tok-kc">false</span><span class="tok-p">});</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;score&quot;</span> <span class="tok-o">:</span> <span class="tok-mf">92.6244233936537</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_condiciones_sobre_objetos_anidados">2.4.3. Condiciones sobre objetos anidados</h4>
<div class="paragraph">
<p>Si queremos acceder a campos de subdocumentos, siguiendo la sintaxis de JSON, se utiliza la notación punto. Esta notación permite acceder al campo de un documento anidado, da igual el nivel en el que esté y su orden respecto al resto de campos.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, supongamos que tenemos un catálogo de productos de una tienda electrónica, el cual es similar al siguiente documento:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="json"><span class="tok-p">{</span>
  <span class="tok-nt">&quot;producto&quot;</span> <span class="tok-p">:</span> <span class="tok-s2">&quot;Condensador de Fluzo&quot;</span><span class="tok-p">,</span>
  <span class="tok-nt">&quot;precio&quot;</span> <span class="tok-p">:</span> <span class="tok-mi">100000000000</span><span class="tok-p">,</span>
  <span class="tok-nt">&quot;reviews&quot;</span> <span class="tok-p">:</span> <span class="tok-p">[</span>
    <span class="tok-p">{</span>
      <span class="tok-nt">&quot;usuario&quot;</span> <span class="tok-p">:</span> <span class="tok-s2">&quot;emmett&quot;</span><span class="tok-p">,</span>
      <span class="tok-nt">&quot;comentario&quot;</span> <span class="tok-p">:</span> <span class="tok-s2">&quot;¡Genial!&quot;</span><span class="tok-p">,</span>
      <span class="tok-nt">&quot;calificacion&quot;</span> <span class="tok-p">:</span> <span class="tok-mi">5</span>
    <span class="tok-p">},{</span>
      <span class="tok-nt">&quot;usuario&quot;</span> <span class="tok-p">:</span> <span class="tok-s2">&quot;marty&quot;</span> <span class="tok-p">,</span>
      <span class="tok-nt">&quot;comentario&quot;</span> <span class="tok-p">:</span> <span class="tok-s2">&quot;¡Justo lo que necesitaba!&quot;</span><span class="tok-p">,</span>
      <span class="tok-nt">&quot;calificacion&quot;</span> <span class="tok-p">:</span> <span class="tok-mi">4</span>
    <span class="tok-p">}</span> <span class="tok-p">]</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para acceder al usuario de una revisión usaríamos la propiedad <code>reviews.usuario</code>.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, para averiguar los productos que cuestan más de 10.000 y que tienen una calificación igual a 5 o superior haríamos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">catalogo</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-s2">&quot;precio&quot;</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$gt</span><span class="tok-o">:</span><span class="tok-mi">10000</span><span class="tok-p">},</span><span class="tok-s2">&quot;reviews.calificacion&quot;</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$gte</span><span class="tok-o">:</span><span class="tok-mi">5</span><span class="tok-p">}})</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_condiciones_compuestas_con_y_o">2.4.4. Condiciones compuestas con Y / O</h4>
<div class="paragraph">
<p>Para usar la conjunción o la disyunción, tenemos los operadores <code>$and</code> y <code>$or</code>. Son operadores prefijo, de modo que se ponen antes de las subconsultas que se van a evaluar. Estos operadores trabajan con arrays, donde cada uno de los elementos es un documento con la condición a evaluar, de modo que se realiza la unión entre estas condiciones, aplicando la lógica asociada a AND y a OR.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span> <span class="tok-nx">$or</span><span class="tok-o">:</span><span class="tok-p">[</span> <span class="tok-p">{</span><span class="tok-s2">&quot;type&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;exam&quot;</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-s2">&quot;score&quot;</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$gte</span><span class="tok-o">:</span><span class="tok-mi">65</span><span class="tok-p">}}</span> <span class="tok-p">]})</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span> <span class="tok-nx">$or</span><span class="tok-o">:</span><span class="tok-p">[</span> <span class="tok-p">{</span><span class="tok-s2">&quot;score&quot;</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$lt</span><span class="tok-o">:</span><span class="tok-mi">50</span><span class="tok-p">}},</span> <span class="tok-p">{</span><span class="tok-s2">&quot;score&quot;</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$gt</span><span class="tok-o">:</span><span class="tok-mi">90</span><span class="tok-p">}}</span> <span class="tok-p">]})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Realmente el operador <code>$and</code> no se suele usar porque podemos anidar en la consulta 2 criterios, al poner uno dentro del otro. Así pues, estas dos consultas hacen lo mismo:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplos consultas conjunciones con y sin <code>$and</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span> <span class="tok-nx">type</span><span class="tok-o">:</span><span class="tok-s2">&quot;exam&quot;</span><span class="tok-p">,</span> <span class="tok-nx">score</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$gte</span><span class="tok-o">:</span><span class="tok-mi">65</span><span class="tok-p">}</span> <span class="tok-p">})</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span> <span class="tok-nx">$and</span><span class="tok-o">:</span><span class="tok-p">[</span> <span class="tok-p">{</span><span class="tok-nx">type</span><span class="tok-o">:</span><span class="tok-s2">&quot;exam&quot;</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">score</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$gte</span><span class="tok-o">:</span><span class="tok-mi">65</span><span class="tok-p">}}</span> <span class="tok-p">]</span> <span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Consejo de Rendimiento</div>
<div class="paragraph">
<p>Las consultas conjuntivas, es decir, con varios criterios excluyentes u operador <code>$or</code>, deben filtrar el conjunto más grande cuanto más pronto posible.</p>
</div>
<div class="paragraph">
<p>Supongamos que vamos a consultar los mismos documentos que cumplen los criterios A (40.000 documentos), B (9.000 documentos) y C (200 documentos).</p>
</div>
<div class="paragraph">
<p>Si filtramos C, luego B, y finalmente A, el conjunto de documentos que tiene que comprobar <em>MongoDB</em> es muy grande.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql02/orCBA.jpg" alt="Restringiendo consultas OR" width="66%">
</div>
<div class="title">Figure 5. Restringiendo consultas OR de menor a myor</div>
</div>
<div class="paragraph">
<p>En cambio, si hacemos una consulta que primero empiece por el criterio menos restrictivo, el conjunto de documentos sobre el cual va a tener que comprobar siguientes criterios va a ser menor, y por tanto, se realizará más rápido.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql02/orABC.jpg" alt="Restringiendo consultas AND" width="66%">
</div>
<div class="title">Figure 6. Restringiendo consultas OR de mayor a menor</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>También podemos utilizar el operado <code>$nor</code>, que no es más que la negación de <code>$or</code> y que obtendrá aquellos documentos que no cumplan ninguna de las condiciones.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Autoevaluación</div>
<div class="paragraph">
<p>Que obtendríamos al ejecutar la siguiente consulta: <span class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnote_2" title="View footnote.">2</a>]</span></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span> <span class="tok-nx">score</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$gte</span><span class="tok-o">:</span><span class="tok-mi">65</span><span class="tok-p">},</span> <span class="tok-nx">$nor</span><span class="tok-o">:</span><span class="tok-p">[</span> <span class="tok-p">{</span><span class="tok-nx">type</span><span class="tok-o">:</span><span class="tok-s2">&quot;quiz&quot;</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">type</span><span class="tok-o">:</span><span class="tok-s2">&quot;homework&quot;</span><span class="tok-p">}</span> <span class="tok-p">]</span> <span class="tok-p">})</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finalmente, si queremos indicar mediante un array los diferentes valores que puede cumplir un campo, podemos utilizar el operador <code>$in</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span> <span class="tok-nx">type</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$in</span><span class="tok-o">:</span><span class="tok-p">[</span><span class="tok-s2">&quot;quiz&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;exam&quot;</span><span class="tok-p">]}})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por supuesto, también existe su negación mediante <code>$nin</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_consultas_sobre_arrays">2.4.5. Consultas sobre arrays</h4>
<div class="paragraph">
<p>Si trabajamos con arrays, vamos a poder consultar el contenido de una posición del mismo tal como si fuera un campo normal, siempre que sea un campo de primer nivel, es decir, no sea un documento embebido dentro de un array.</p>
</div>
<div class="paragraph">
<p>Si queremos filtrar teniendo en cuenta el número de ocurrencias del array, podemos utilizar:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>$all</code> para filtrar ocurrencias que tienen todos los valores del array, es decir, los valores pasados a la consulta serán un subconjunto del resultado. Puede que devuelva los mismos, o un array con más campos (el orden no importa)</p>
</li>
<li>
<p><code>$in</code>, igual que SQL, para obtener las ocurrencias que cumple con alguno de los valores pasados (similar a usar <code>$or</code> sobre un conjunto de valores de un mismo campo). Si queremos su negación, usaremos <code>$nin</code>, para obtener los documentos que no cumplen ninguno de los valores.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Por ejemplo, si queremos obtener las personas que dentro de sus amistades se encuentre <em>Juan</em> <strong>y</strong> <em>David</em>, y respecto a sus hobbies estén el <em>footing</em> <strong>o</strong> el <em>baloncesto</em>, tendríamos:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo consulta con <code>$all</code> y <code>$in</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">(</span> <span class="tok-p">{</span><span class="tok-nx">amistades</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-nx">$all</span><span class="tok-o">:</span> <span class="tok-p">[</span><span class="tok-s2">&quot;Juan&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;David&quot;</span><span class="tok-p">]},</span> <span class="tok-nx">hobbies</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-nx">$in</span><span class="tok-o">:</span> <span class="tok-p">[</span><span class="tok-s2">&quot;footing&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;baloncesto&quot;</span><span class="tok-p">]}}</span> <span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si el array contiene documentos y queremos filtrar la consulta sobre los campos de los documentos del array, tenemos que utilizar <code>$elemMatch</code>. Más información en <a href="http://docs.mongodb.org/manual/reference/operator/projection/elemMatch/" class="bare">http://docs.mongodb.org/manual/reference/operator/projection/elemMatch/</a></p>
</div>
<div class="paragraph">
<p>Si lo que nos interesa es la cantidad de elementos que contiene un array, emplearemos el operador <code>$size</code>.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, para obtener las personas que tienen 3 hobbies haríamos:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo consulta con <code>$size</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">(</span> <span class="tok-p">{</span><span class="tok-nx">hobbies</span> <span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-nx">$size</span> <span class="tok-o">:</span> <span class="tok-mi">3</span><span class="tok-p">}}</span> <span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finalmente, a la hora de proyectar los datos, si no estamos interesados en todos los valores de un campo que es un array, podemos restringir el resultado mediante el operador <code>$slice</code>:</p>
</div>
<div class="paragraph">
<p>Así pues, si quisieramos obtener las personas que tienen mas de un hijo, y que de esas personas, en vez de mostrar todos sus hobbies, mostrase los dos primeros, haríamos:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo con <code>$slice</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">(</span> <span class="tok-p">{</span><span class="tok-nx">hijos</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-nx">$gt</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">}},</span> <span class="tok-p">{</span><span class="tok-nx">hobbies</span><span class="tok-o">:</span> <span class="tok-p">{</span><span class="tok-nx">$slice</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-p">}}</span> <span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Más información en <a href="http://docs.mongodb.org/manual/reference/operator/projection/slice/" class="bare">http://docs.mongodb.org/manual/reference/operator/projection/slice/</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_conjunto_de_valores">2.4.6. Conjunto de valores</h4>
<div class="paragraph">
<p>Igual que en SQL, a partir de un colección, si queremos obtener todos los diferentes valores que existen en un campo, utilizaremos el método <code><strong>distinct</strong></code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">distinct</span><span class="tok-p">(</span><span class="tok-s1">&#39;type&#39;</span><span class="tok-p">)</span>
<span class="tok-p">[</span> <span class="tok-s2">&quot;exam&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;quiz&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;homework&quot;</span> <span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si queremos filtrar los datos sobre los que se obtienen los valores, le pasaremos un segundo parámetro con el criterio a aplicar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">distinct</span><span class="tok-p">(</span><span class="tok-s1">&#39;type&#39;</span><span class="tok-p">,</span> <span class="tok-p">{</span> <span class="tok-nx">score</span><span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-nx">$gt</span><span class="tok-o">:</span> <span class="tok-mf">99.9</span> <span class="tok-p">}</span> <span class="tok-p">}</span> <span class="tok-p">)</span>
<span class="tok-p">[</span> <span class="tok-s2">&quot;exam&quot;</span> <span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_cursores">2.4.7. Cursores</h4>
<div class="paragraph">
<p>Al hacer una consulta en el <em>shell</em>, se devuelve un cursor. Este cursor lo podemos guardar en un variable, y partir de ahí trabajar con él como haríamos mediante <em>Java</em>. Si <code>cur</code> es la variable que referencia al cursor, podremos utilizar los siguientes métodos:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 3. Métodos de uso de cursores</caption>
<colgroup>
<col style="width: 33%;">
<col style="width: 33%;">
<col style="width: 33%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Método</th>
<th class="tableblock halign-left valign-top">Uso</th>
<th class="tableblock halign-left valign-top">Lugar de ejecución</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cur.hasNext()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code>/<code>false</code> para saber si quedan elementos</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cliente</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cur.next()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pasa al siguiente documento</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cliente</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cur.limit(<em>numElementos</em>)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Restringe el número de resultados a <em>numElementos</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Servidor</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cur.sort({<em>campo</em>:1})</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ordena los datos por <em>campo</em> <code>1</code> ascendente o <code>-1</code> o descendente</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Servidor</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cur.skip(<em>numElementos</em>)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Permite saltar <em>numElementos</em> con el cursor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Servidor</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>La consulta no se ejecuta hasta que el cursor comprueba o pasa al siguiente documento (<code>next</code>/<code>hasNext</code>), por ello que tanto <code>limit</code> como <code>sort</code> (ambos modifican el cursor) sólo se pueden realizar antes de recorrer cualquier elemento del cursor.</p>
</div>
<div class="paragraph">
<p>Como tras realizar una consulta con <code>find</code>, realmente se devuelve un cursor, un uso muy habitual es encadenar una operación de <code>find</code> con <code>sort</code> y/o <code>limit</code> para ordenar el resultado por uno o más campos y posteriormente limitar el número de documentos a devolver.</p>
</div>
<div class="paragraph">
<p>Así pues, si quisiéramos obtener la calificación del trabajo con la nota más alta, podríamos hacerlo así:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span> <span class="tok-nx">type</span><span class="tok-o">:</span><span class="tok-s1">&#39;homework&#39;</span><span class="tok-p">}).</span><span class="tok-nx">sort</span><span class="tok-p">({</span><span class="tok-nx">score</span><span class="tok-o">:-</span><span class="tok-mi">1</span><span class="tok-p">}).</span><span class="tok-nx">limit</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por ejemplo, si queremos paginar las notas de 10 en 10, a partir de la tercera página, podríamos hacer algo así:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">().</span><span class="tok-nx">sort</span><span class="tok-p">({</span><span class="tok-nx">score</span><span class="tok-o">:-</span><span class="tok-mi">1</span><span class="tok-p">}).</span><span class="tok-nx">limit</span><span class="tok-p">(</span><span class="tok-mi">10</span><span class="tok-p">).</span><span class="tok-nx">skip</span><span class="tok-p">(</span><span class="tok-mi">20</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Autoevaluación</div>
<div class="paragraph">
<p>A partir de la colección <em>grades</em>, escribe un consulta que obtenga los documentos de tipo "exam" ordenados descendentemente y que obtenga los documentos de 51 al 70. <span class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnote_3" title="View footnote.">3</a>]</span></p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_contando_documentos">2.4.8. Contando Documentos</h4>
<div class="paragraph">
<p>Para contar el número de documentos, en vez de <code>find</code> usaremos el método <code>count</code>. Por ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">count</span><span class="tok-p">({</span><span class="tok-nx">type</span><span class="tok-o">:</span><span class="tok-s2">&quot;exam&quot;</span><span class="tok-p">})</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-nx">type</span><span class="tok-o">:</span><span class="tok-s2">&quot;exam&quot;</span><span class="tok-p">}).</span><span class="tok-nx">count</span><span class="tok-p">()</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">count</span><span class="tok-p">({</span><span class="tok-nx">type</span><span class="tok-o">:</span><span class="tok-s2">&quot;essay&quot;</span><span class="tok-p">,</span> <span class="tok-nx">score</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$gt</span><span class="tok-o">:</span><span class="tok-mi">90</span><span class="tok-p">}})</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>También se puede utilizar <code>count</code> como método de un cursor.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_actualizando_documentos">2.5. Actualizando documentos</h3>
<div class="paragraph">
<p>Para actualizar (y fusionar datos), se utiliza el método <code>update</code> con 2 parámetros: el primero es la consulta para averiguar sobre qué documentos, y en el segundo parámetro, los campos a modificar.</p>
</div>
<div class="listingblock">
<div class="title">Modificando un documento</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">update</span><span class="tok-p">({</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s2">&quot;Steve Jobs&quot;</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s2">&quot;Domingo Gallardo&quot;</span><span class="tok-p">,</span> <span class="tok-nx">salario</span><span class="tok-o">:</span> <span class="tok-mi">1000000</span><span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<code>update</code> hace un <strong>reemplazo</strong> de los campos, es decir, si en el origen había 100 campos y en el <code>update</code> sólo ponemos 2, el resultado sólo tendrá 2 campos. ¡Cuidado que puede ser muy PELIGROSO!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si cuando vamos a actualizar, en el criterio de selección no encuentra el documento sobre el que hacer los cambios, no se realiza ninguna acción.</p>
</div>
<div class="paragraph">
<p>Si quisiéramos que en el caso de no encontrar nada insertase un nuevo documento, acción conocida como <strong>upsert</strong> (<em><strong>up</strong>date + in<strong>sert</strong></em>), hay que pasarle un tercer parámetro al método con el objeto <code>{upsert:true}</code></p>
</div>
<div class="listingblock">
<div class="title">Ejemplo <em>upsert</em></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">update</span><span class="tok-p">({</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s2">&quot;Domingo Gallardo&quot;</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">name</span><span class="tok-o">:</span><span class="tok-s2">&quot;Domingo Gallardo&quot;</span><span class="tok-p">,</span> <span class="tok-nx">twitter</span><span class="tok-o">:</span> <span class="tok-s1">&#39;@domingogallardo&#39;</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">upsert</span><span class="tok-o">:</span> <span class="tok-kc">true</span><span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Otra manera de realizar un <em>upsert</em> es mediante la operación <code>save</code>, que ya hemos visto anteriormente. Así pues, si reescribimos la consulta anterior tendríamos (siempre y cuando considerasemos que el <code>nombre</code> actúa como el campo <code>_id</code>):</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo <em>save</em></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">save</span><span class="tok-p">({</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s2">&quot;Domingo Gallardo&quot;</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">name</span><span class="tok-o">:</span><span class="tok-s2">&quot;Domingo Gallardo&quot;</span><span class="tok-p">,</span> <span class="tok-nx">twitter</span><span class="tok-o">:</span> <span class="tok-s1">&#39;@domingogallardo&#39;</span><span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si no indicamos el valor <code>_id</code>, el comando <code>save</code> asume que es una inserción e inserta el documento en la colección.</p>
</div>
<div class="sect3">
<h4 id="_operadores_de_actualización">2.5.1. Operadores de actualización</h4>
<div class="paragraph">
<p><em>MongoDB</em> ofrece un conjunto de operadores para simplificar la modificación de campos.</p>
</div>
<div class="paragraph">
<p>Para evitar el reemplazo, hay que usar la variable <code>$set</code> (si el campo no existe, se creará).</p>
</div>
<div class="paragraph">
<p>Por ejemplo, para modificar el salario haríamos:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo <code>$set</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">update</span><span class="tok-p">({</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s2">&quot;Aitor Medrano&quot;</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">$set</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">salario</span><span class="tok-o">:</span> <span class="tok-mi">1000000</span><span class="tok-p">}})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Mediante <code>$inc</code> podemos incrementar el valor de una variable.</p>
</div>
<div class="paragraph">
<p>En cambio, si queremos incrementar el salario haríamos:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo <code>$inc</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">update</span><span class="tok-p">({</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s2">&quot;Aitor Medrano&quot;</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">$inc</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">salario</span><span class="tok-o">:</span> <span class="tok-mi">1000</span><span class="tok-p">}})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para eliminar un campo de un documento, usaremos el operador <code>$unset</code>.</p>
</div>
<div class="paragraph">
<p>De este modo, para eliminar el campo <code>twitter</code> de una persona haríamos:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo <code>$unset</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">update</span><span class="tok-p">({</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s2">&quot;Aitor Medrano&quot;</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">$unset</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">twitter</span><span class="tok-o">:</span> <span class="tok-s1">&#39;&#39;</span><span class="tok-p">}})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Otros operadores que podemos utilizar son <code>$mul</code>, <code>$min</code>, <code>$max</code> y <code>$currentDate</code>. Podemos consultar todos los operadores disponibles en <a href="http://docs.mongodb.org/manual/reference/operator/update/" class="bare">http://docs.mongodb.org/manual/reference/operator/update/</a></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Autoevaluación</div>
<div class="paragraph">
<p>Tras realizar la siguiente operación sobre una colección vacía:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">update</span><span class="tok-p">({</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s1">&#39;yo&#39;</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-s1">&#39;$set&#39;</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-s1">&#39;hobbies&#39;</span><span class="tok-o">:</span><span class="tok-p">[</span><span class="tok-s1">&#39;gaming&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;sofing&#39;</span><span class="tok-p">]}},</span> <span class="tok-p">{</span><span class="tok-nx">upsert</span><span class="tok-o">:</span> <span class="tok-kc">true</span><span class="tok-p">}</span> <span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>¿Cuál es el estado de la colección? <span class="footnote">[<a id="_footnoteref_4" class="footnote" href="#_footnote_4" title="View footnote.">4</a>]</span></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Realmente podemos dividir las actualizaciones en cuatro tipos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>reemplazo completo</p>
</li>
<li>
<p>modificar un campo</p>
</li>
<li>
<p>hacer un <em>upsert</em></p>
</li>
<li>
<p>o actualizar múltiples documentos</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_actualización_múltiple">2.5.2. Actualización múltiple</h4>
<div class="paragraph">
<p>Un aspecto que no hemos comentado y el cual es muy importante es que, si a la hora de actualizar la búsqueda devuelve más de un resultado, la actualización sólo se realiza sobre el primer resultado obtenido.</p>
</div>
<div class="paragraph">
<p>Para modificar múltiples documentos, en el tercer parámetro indicaremos <code>{multi: true}</code>. ¡Esta es una diferencia sustancial respecto a SQL!</p>
</div>
<div class="paragraph">
<p>Por ejemplo, para incrementar todas las calificaciones de los exámenes en un punto haríamos:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo Actualización Múltiple</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">update</span><span class="tok-p">({</span><span class="tok-nx">type</span><span class="tok-o">:</span><span class="tok-s1">&#39;exam&#39;</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-s1">&#39;$inc&#39;</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-s1">&#39;score&#39;</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">}},</span> <span class="tok-p">{</span><span class="tok-nx">multi</span><span class="tok-o">:</span> <span class="tok-kc">true</span><span class="tok-p">}</span> <span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cuando se hace una actualización múltiple, <em>MongoDB</em> no la realiza de manera atómica (no soporta transacciones <em>isolated</em>), lo que provoca que se puedan producir pausas (<em>pause yielding</em>). Cada documento si es atómico, por lo que ninguno se va a quedar a la mitad.</p>
</div>
<div class="paragraph">
<p><em>MongoDB</em> ofrece el método <code>findAndModify</code> para encontrar y modificar un documento de manera atómica, y así evitar que, entre la búsqueda y la modificación, el estado del documento se vea afectado. Además, devuelve el documento modificado. Un caso de uso muy común es para contadores y casos similares.</p>
</div>
<div class="listingblock">
<div class="title">Encontrar y Modificar de manera atómica - <code>findAndModify</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">findAndModify</span><span class="tok-p">({</span>
  <span class="tok-nx">query</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">student_id</span><span class="tok-o">:</span><span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-nx">type</span><span class="tok-o">:</span><span class="tok-s2">&quot;exam&quot;</span><span class="tok-p">},</span>
  <span class="tok-nx">update</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$inc</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">score</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">}},</span>
  <span class="tok-k">new</span><span class="tok-o">:</span> <span class="tok-kc">true</span>
<span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por defecto, el documento devuelto será el resultado que ha encontrado con la consulta. Si queremos que nos devuelva el documento modificado con los cambios deseados, necesitamos utilizar el parámetro <code>new</code> a <code>true</code>. Si no lo indicamos o lo ponemos a <code>false</code>, tendremos el comportamiento por defecto.</p>
</div>
<div class="paragraph">
<p>Para el resto de opciones que ofrece <code>findAndModifiy</code> se recomienda consultar la documentación (<a href="http://docs.mongodb.org/master/reference/method/db.collection.findAndModify/" class="bare">http://docs.mongodb.org/master/reference/method/db.collection.findAndModify/</a>)</p>
</div>
<div class="paragraph">
<p>Finalmente, un caso particular de las actualizaciones es la posibilidad de renombrar un campo mediante el operador <code>$rename</code>:</p>
</div>
<div class="listingblock">
<div class="title">Renombrando un campo con <code>$rename</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">update</span><span class="tok-p">(</span> <span class="tok-p">{</span><span class="tok-nx">_id</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">$rename</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-s1">&#39;nickname&#39;</span><span class="tok-o">:</span><span class="tok-s1">&#39;alias&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;cell&#39;</span><span class="tok-o">:</span><span class="tok-s1">&#39;movil&#39;</span><span class="tok-p">}})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos consultar todas las opción de configuración de una actualización en
<a href="http://docs.mongodb.org/manual/reference/method/db.collection.update/" class="bare">http://docs.mongodb.org/manual/reference/method/db.collection.update/</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_actualizaciones_sobre_arrays">2.5.3. Actualizaciones sobre Arrays</h4>
<div class="paragraph">
<p>Para trabajar con arrays necesitamos nuevos operadores que nos permitan tanto introducir como eliminar elementos de una manera más sencilla que sustituir todos los elementos del array.</p>
</div>
<div class="paragraph">
<p>Los operadores que podemos emplear para trabajar con arrays son:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Operador</th>
<th class="tableblock halign-left valign-top">Propósito</th>
</tr>
</thead>
<tbody>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock"><code>$push</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Añade un elemento</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock"><code>$pushAll</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Añade varios elementos</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock"><code>$addToSet</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Añade un elemento sin duplicados</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock"><code>$pull</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Elimina un elemento</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock"><code>$pullAll</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Elimina varios elementos</p></td>
</tr>
<tr>
<th class="tableblock halign-center valign-middle"><p class="tableblock"><code>$pop</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Elimina el primer o el último</p></td>
</tr>
</tbody>
</table>
<div class="sidebarblock">
<div class="content">
<div class="title">Preparando los ejemplos</div>
<div class="paragraph">
<p>Para trabajar con los arrays, vamos a suponer que tenemos una colección de <em>enlaces</em> donde vamos a almacenar un documento por cada site, con un atributo <em>tags</em> con etiquetas sobre el enlace en cuestión</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">enlaces</span><span class="tok-p">.</span><span class="tok-nx">insert</span><span class="tok-p">({</span><span class="tok-nx">titulo</span><span class="tok-o">:</span><span class="tok-s2">&quot;www.google.es&quot;</span><span class="tok-p">,</span> <span class="tok-nx">tags</span><span class="tok-o">:</span><span class="tok-p">[</span><span class="tok-s2">&quot;mapas&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;videos&quot;</span><span class="tok-p">]})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>De modo que tendríamos el siguiente objeto:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span>
	<span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;54f9769212b1897ae84190cf&quot;</span><span class="tok-p">),</span>
	<span class="tok-s2">&quot;titulo&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;www.google.es&quot;</span><span class="tok-p">,</span>
	<span class="tok-s2">&quot;tags&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span>
		<span class="tok-s2">&quot;mapas&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;videos&quot;</span>
	<span class="tok-p">]</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_añadiendo_elementos">Añadiendo elementos</h5>
<div class="paragraph">
<p>Si queremos añadir un elemento, usaremos el operador <code>$push</code>. Si queremos añadir varios elementos de una sola vez, usaremos <code>$pushAll</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">enlaces</span><span class="tok-p">.</span><span class="tok-nx">update</span><span class="tok-p">({</span><span class="tok-nx">titulo</span><span class="tok-o">:</span><span class="tok-s2">&quot;www.google.es&quot;</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">$push</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">tags</span><span class="tok-o">:</span><span class="tok-s2">&quot;blog&quot;</span><span class="tok-p">}})</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">enlaces</span><span class="tok-p">.</span><span class="tok-nx">update</span><span class="tok-p">({</span><span class="tok-nx">titulo</span><span class="tok-o">:</span><span class="tok-s2">&quot;www.google.es&quot;</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">$pushAll</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">tags</span><span class="tok-o">:</span><span class="tok-p">[</span><span class="tok-s2">&quot;calendario&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;email&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;mapas&quot;</span><span class="tok-p">]}})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Al hacer estar modificación, el resultado del documento sería:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span>
  <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;54f9769212b1897ae84190cf&quot;</span><span class="tok-p">),</span>
  <span class="tok-s2">&quot;titulo&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;www.google.es&quot;</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;tags&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span>
    <span class="tok-s2">&quot;mapas&quot;</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;videos&quot;</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;blog&quot;</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;calendario&quot;</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;email&quot;</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;mapas&quot;</span>
  <span class="tok-p">]</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Tanto <code>$push</code> como <code>$pushAll</code> no tienen en cuenta lo que contiene el array, por tanto, si un elemento ya existe, se repetirá y tendremos duplicados. Si queremos evitar los duplicados, usaremos <code>$addToSet</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">enlaces</span><span class="tok-p">.</span><span class="tok-nx">update</span><span class="tok-p">({</span><span class="tok-nx">titulo</span><span class="tok-o">:</span><span class="tok-s2">&quot;www.google.es&quot;</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">$addToSet</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">tags</span><span class="tok-o">:</span><span class="tok-s2">&quot;buscador&quot;</span><span class="tok-p">}})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si queremos añadir más de un campo a la vez sin duplicados, debemos anidar el operador <code>$each</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">enlaces</span><span class="tok-p">.</span><span class="tok-nx">update</span><span class="tok-p">({</span><span class="tok-nx">titulo</span><span class="tok-o">:</span><span class="tok-s2">&quot;www.google.es&quot;</span><span class="tok-p">},{</span> <span class="tok-nx">$addToSet</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">tags</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$each</span><span class="tok-o">:</span><span class="tok-p">[</span><span class="tok-s2">&quot;drive&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;traductor&quot;</span><span class="tok-p">]}}})</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_eliminando_elementos">Eliminando elementos</h5>
<div class="paragraph">
<p>En cambio, si queremos eliminar elementos de un array, usaremos el operador <code>$pull</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">enlaces</span><span class="tok-p">.</span><span class="tok-nx">update</span><span class="tok-p">({</span><span class="tok-nx">titulo</span><span class="tok-o">:</span><span class="tok-s2">&quot;www.google.es&quot;</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">$pull</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">tags</span><span class="tok-o">:</span><span class="tok-s2">&quot;traductor&quot;</span><span class="tok-p">}})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Similar al caso anterior, con <code>$pullAll</code>, eliminaremos varios elementos de una sola vez:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">enlaces</span><span class="tok-p">.</span><span class="tok-nx">update</span><span class="tok-p">({</span><span class="tok-nx">titulo</span><span class="tok-o">:</span><span class="tok-s2">&quot;www.google.es&quot;</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">$pullAll</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">tags</span><span class="tok-o">:</span><span class="tok-p">[</span><span class="tok-s2">&quot;calendario&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;email&quot;</span><span class="tok-p">]}})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Otra manera de eliminar elementos del array es mediante <code>$pop</code>, el cual elimina el primero (<code>-1</code>) o el último (<code>1</code>) elemento del array:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">enlaces</span><span class="tok-p">.</span><span class="tok-nx">update</span><span class="tok-p">({</span><span class="tok-nx">titulo</span><span class="tok-o">:</span><span class="tok-s2">&quot;www.google.es&quot;</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">$pop</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">tags</span><span class="tok-o">:-</span><span class="tok-mi">1</span><span class="tok-p">}})</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_operador_posicional">Operador posicional</h5>
<div class="paragraph">
<p>Por último, tenemos el operador posicional, el cual se expresa con el símbolo <code>$</code> (<a href="http://docs.mongodb.org/master/reference/operator/update/positional/" class="bare">http://docs.mongodb.org/master/reference/operator/update/positional/</a>) y nos permite modificar el elemento que ocupa una determinada posición del array.</p>
</div>
<div class="paragraph">
<p>Supongamos que tenemos las calificaciones de los estudiantes (colección <code>students</code>) en un documento con una estructura similar a la siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-s2">&quot;grades&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span> <span class="tok-mi">80</span><span class="tok-p">,</span> <span class="tok-mi">85</span><span class="tok-p">,</span> <span class="tok-mi">90</span> <span class="tok-p">]</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>y queremos cambiar la calificación de <code>80</code> por <code>82</code>. Mediante el operador posicional haremos:</p>
</div>
<div class="listingblock">
<div class="title">Modificando un array con el operador posicional</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">update</span><span class="tok-p">(</span> <span class="tok-p">{</span> <span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-nx">grades</span><span class="tok-o">:</span> <span class="tok-mi">80</span> <span class="tok-p">},</span> <span class="tok-p">{</span> <span class="tok-nx">$set</span><span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;grades.$&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">82</span> <span class="tok-p">}</span> <span class="tok-p">}</span> <span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>De manera similar, si queremos modificar parte de un documento el cual forma parte de un array, debemos usar la notación punto tras el <code>$</code>:</p>
</div>
<div class="paragraph">
<p>Por ejemplo, supongamos que tenemos estas calificación de un determinado alumno:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo de calificación de un alumno, las cuales forman parte de un objeto dentro de un array</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">4</span><span class="tok-p">,</span> <span class="tok-s2">&quot;grades&quot;</span> <span class="tok-o">:</span>
  <span class="tok-p">[</span> <span class="tok-p">{</span> <span class="tok-nx">grade</span><span class="tok-o">:</span> <span class="tok-mi">80</span><span class="tok-p">,</span> <span class="tok-nx">mean</span><span class="tok-o">:</span> <span class="tok-mi">75</span><span class="tok-p">,</span> <span class="tok-nx">std</span><span class="tok-o">:</span> <span class="tok-mi">8</span> <span class="tok-p">},</span>
    <span class="tok-p">{</span> <span class="tok-nx">grade</span><span class="tok-o">:</span> <span class="tok-mi">85</span><span class="tok-p">,</span> <span class="tok-nx">mean</span><span class="tok-o">:</span> <span class="tok-mi">90</span><span class="tok-p">,</span> <span class="tok-nx">std</span><span class="tok-o">:</span> <span class="tok-mi">5</span> <span class="tok-p">},</span>
    <span class="tok-p">{</span> <span class="tok-nx">grade</span><span class="tok-o">:</span> <span class="tok-mi">90</span><span class="tok-p">,</span> <span class="tok-nx">mean</span><span class="tok-o">:</span> <span class="tok-mi">85</span><span class="tok-p">,</span> <span class="tok-nx">std</span><span class="tok-o">:</span> <span class="tok-mi">3</span> <span class="tok-p">}</span> <span class="tok-p">]</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos observar como tenemos cada calificación como parte de un objeto dentro de un array. Si queremos cambiar el valor de <code>std</code> a <code>6</code> de la calificación cuya nota es <code>85</code>, haremos:</p>
</div>
<div class="listingblock">
<div class="title">Modificando un elemento de un objeto dentro de un array</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">update</span><span class="tok-p">(</span> <span class="tok-p">{</span> <span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-mi">4</span><span class="tok-p">,</span> <span class="tok-s2">&quot;grades.grade&quot;</span><span class="tok-o">:</span> <span class="tok-mi">85</span> <span class="tok-p">},</span> <span class="tok-p">{</span> <span class="tok-nx">$set</span><span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;grades.$.std&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">6</span> <span class="tok-p">}</span> <span class="tok-p">}</span> <span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Es decir, el <code>$</code> referencia al documento que ha cumplido el filtro de búsqueda.</p>
</div>
<div class="paragraph">
<p>Podemos consultar toda la documentación disponible sobre estos operadores en <a href="http://docs.mongodb.org/manual/reference/operator/update-array/" class="bare">http://docs.mongodb.org/manual/reference/operator/update-array/</a></p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_borrando_documentos">2.6. Borrando documentos</h3>
<div class="paragraph">
<p>Para borrar, usaremos el método <code>remove</code>, el cual funciona de manera similar a <code>find</code>. Si no pasamos ningún parámetro, borra toda la colección documento a documento. Si le pasamos un parámetro, éste será el criterio de selección de documentos a eliminar.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">remove</span><span class="tok-p">({</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s2">&quot;Domingo Gallardo&quot;</span><span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Al eliminar un documento, no podemos olvidar que cualquier referencia al documento que existe en la base de datos seguirá existiendo. Por este motivo, manualmente también hay que eliminar o modificar esas referencias.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si queremos borrar toda la colección, es más eficiente usar el método <code>drop</code>, ya que también elimina los índices.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">drop</span><span class="tok-p">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Recordad que eliminar un determinado campo de un documento no se considera un operación de borrado, sino una actualización mediante el operador <code>$unset</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_control_de_errores">2.7. Control de errores</h3>
<div class="paragraph">
<p>En versiones anteriores a la 2.6, si queremos averiguar qué ha sucedido, y si ha fallado conocer el motivo, deberemos ejecutar el siguiente comando con <code>getLastError</code> (<a href="http://docs.mongodb.org/master/reference/command/getLastError/" class="bare">http://docs.mongodb.org/master/reference/command/getLastError/</a>):</p>
</div>
<div class="listingblock">
<div class="title">Control de Errores</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">runCommand</span><span class="tok-p">({</span><span class="tok-nx">getLastError</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para ello, ejecutaremos la sentencia después de haber realizado una operación, para obtener información sobre la última operación realizada.</p>
</div>
<div class="paragraph">
<p>Si la última operación ha sido una modificación mediante un <code>update</code> podremos obtener el número de registros afectados, o si es un <code>upsert</code> podremos obtener si ha insertado o modificado el documento. Finalmente, en el caso de una operación de borrado, podemos obtener el número de documentos eliminados.</p>
</div>
<div class="paragraph">
<p>Desde la versión 2.6, <em>MongoDB</em> devuelve un objeto <code>WriteResult</code> con información del número de documentos afectados (<code>nInserted</code>), y en el caso de un error, un documento en la propiedad <code>writeError</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">insert</span><span class="tok-p">({</span><span class="tok-s2">&quot;_id&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;error&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;nombre&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;Pedro Casas&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;edad&quot;</span><span class="tok-o">:</span><span class="tok-mi">38</span><span class="tok-p">})</span>
<span class="tok-nx">WriteResult</span><span class="tok-p">({</span> <span class="tok-s2">&quot;nInserted&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span> <span class="tok-p">})</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">insert</span><span class="tok-p">({</span><span class="tok-s2">&quot;_id&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;error&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;nombre&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;Pedro Casas&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;edad&quot;</span><span class="tok-o">:</span><span class="tok-mi">38</span><span class="tok-p">})</span>
<span class="tok-nx">WriteResult</span><span class="tok-p">({</span>
	<span class="tok-s2">&quot;nInserted&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">0</span><span class="tok-p">,</span>
	<span class="tok-s2">&quot;writeError&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
		<span class="tok-s2">&quot;code&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">11000</span><span class="tok-p">,</span>
		<span class="tok-s2">&quot;errmsg&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;insertDocument :: caused by :: 11000 E11000 duplicate key error index: expertojava.people.$_id_  dup key: { : \&quot;error\&quot; }&quot;</span>
	<span class="tok-p">}</span>
<span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Más información en <a href="http://docs.mongodb.org/master/reference/method/db.collection.insert/#writeresult" class="bare">http://docs.mongodb.org/master/reference/method/db.collection.insert/#writeresult</a></p>
</div>
<div class="paragraph">
<p>A continuación vamos a estudiar como realizar todas estas operación mediante el driver <em>Java</em> que ofrece <em>MongoDB</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="__em_mongodb_em_desde_em_java_em">2.8. <em>MongoDB</em> desde <em>Java</em></h3>
<div class="paragraph">
<p>Para interactuar desde <em>Java</em> con <em>MongoDB</em> disponemos de diferentes alternativas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Trabajar directamente con el driver <em>Java</em></p>
</li>
<li>
<p>Utilizar un abstracción JPA</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>En nuestro caso, nos vamos a centrar en el uso del driver.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">v2 o v3</div>
<div class="paragraph">
<p>En la actualidad existen dos versiones principales del driver <em>Java</em>, dependiendo de la versión de <em>MongoDB</em> que estemos empleando, ya sea la v2 o la v3. A partir de la versión 3, se introdujeron nuevas interfaces y clases para interactuar con <em>MongoDB</em>, con lo cual, lo primero que debemos hacer es decidirnos por uno u otro.</p>
</div>
<div class="paragraph">
<p>La ventaja de usar la v2 es que existe una comunidad rica con mucha documentación y librerías construidas sobre esta versión. En cambio, la v3 ofrece un API más intuitiva y promete un mejor rendimiento al ofrecer un esquema de documento que se traduce a BSON.</p>
</div>
<div class="paragraph">
<p>En principio, los apuntes que vienen a continuación se centran en la versión v2 para explicar los conceptos. Más adelante, se muestra un ejemplo con código de la versión v3 para mostrar las diferencias.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para descargar el driver, tal como vimos en la unidad anterior, hemos de utilizar la siguiente dependencia <em>Maven</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;dependency&gt;</span>
  <span class="tok-nt">&lt;groupId&gt;</span>org.mongodb<span class="tok-nt">&lt;/groupId&gt;</span>
  <span class="tok-nt">&lt;artifactId&gt;</span>mongo-java-driver<span class="tok-nt">&lt;/artifactId&gt;</span>
  <span class="tok-nt">&lt;version&gt;</span>2.14.2<span class="tok-nt">&lt;/version&gt;</span>
<span class="tok-nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si nos decidimos por la versión 3, el nombre del artefacto cambia, así como su versión:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;dependency&gt;</span>
  <span class="tok-nt">&lt;groupId&gt;</span>org.mongodb<span class="tok-nt">&lt;/groupId&gt;</span>
  <span class="tok-nt">&lt;artifactId&gt;</span>mongodb-driver<span class="tok-nt">&lt;/artifactId&gt;</span>
  <span class="tok-nt">&lt;version&gt;</span>3.2.2<span class="tok-nt">&lt;/version&gt;</span>
<span class="tok-nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Todas las clases explicadas a continuación pertenecen al paquete <code>com.mongodb</code>.  Toda la información del API de <em>MongoDB</em> la podemos encontrar en <a href="http://api.mongodb.org/java/current/" class="bare">http://api.mongodb.org/java/current/</a> e información del driver en <a href="http://mongodb.github.io/mongo-java-driver/" class="bare">http://mongodb.github.io/mongo-java-driver/</a></p>
</div>
<div class="sect3">
<h4 id="__code_mongoclient_code">2.8.1. <code>MongoClient</code></h4>
<div class="paragraph">
<p>Para conectarnos desde <em>Java</em>, tenemos que crear un <code>MongoClient</code>, el cual gestiona internamente un <em>pool</em> de conexiones. Su constructor se sobrecarga para permitir la conexión a una URI, a un determinado puerto o a un conjunto de réplicas. Podemos consultar todas estas opciones en <a href="http://api.mongodb.org/java/current/com/mongodb/MongoClient.html" class="bare">http://api.mongodb.org/java/current/com/mongodb/MongoClient.html</a></p>
</div>
<div class="paragraph">
<p>A partir de un <code>MongoClient</code>, podremos obtener una <code>DB</code> y de ésta una <code>DBCollection</code>:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo de conexión a MongoDB con Java (<code>HolaMongoDB.java</code>)</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">MongoClient</span> <span class="tok-n">cliente</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">MongoClient</span><span class="tok-o">();</span>  <i class="conum" data-value="1"></i><b>(1)</b>

<span class="tok-n">DB</span> <span class="tok-n">db</span> <span class="tok-o">=</span> <span class="tok-n">cliente</span><span class="tok-o">.</span><span class="tok-na">getDB</span><span class="tok-o">(</span><span class="tok-s">&quot;expertojava&quot;</span><span class="tok-o">);</span>
<span class="tok-n">DBCollection</span> <span class="tok-n">col</span> <span class="tok-o">=</span> <span class="tok-n">db</span><span class="tok-o">.</span><span class="tok-na">getCollection</span><span class="tok-o">(</span><span class="tok-s">&quot;people&quot;</span><span class="tok-o">);</span>

<span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;doc:&quot;</span> <span class="tok-o">+</span> <span class="tok-n">col</span><span class="tok-o">.</span><span class="tok-na">findOne</span><span class="tok-o">());</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>MongoClient</code> realiza la conexión con la base de datos. El constructor por defecto se conecta con <code>localhost</code> al puerto <code>27017</code>. Además, lanza una <code>UnknownHostException</code> cuando no encuentra un servidor funcionando</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>DBCollection</code> nos permite interactuar con la colección, y sobre ella realizaremos las operaciones CRUD.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Sobre un <code>MongoClient</code> podemos destacar los siguientes métodos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>getDB(String nombre)</code> &#8594; recupera la base de datos indicada</p>
</li>
<li>
<p><code>dropDatabase(String nombre)</code> &#8594; elimina la base de datos indicada</p>
</li>
<li>
<p><code>getDatabaseNames()</code> &#8594; obtiene el nombre de las bases de datos existentes</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Sobre una <code>DB</code> podemos destacar los siguientes métodos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>getCollection(String nombre)</code> &#8594; recupera la colección indicada</p>
</li>
<li>
<p><code>command(DBObject obj)</code> &#8594; ejecuta un comnado</p>
</li>
<li>
<p><code>createCollection(String col)</code> &#8594; crea una nueva colección sobre la DB activa</p>
</li>
<li>
<p><code>dropDatabase()</code> &#8594; elimina la base de datos activa</p>
</li>
<li>
<p><code>getCollectionNames()</code> &#8594;  obtiene el nombre de las colecciones existentes</p>
</li>
<li>
<p><code>getLastError()</code> &#8594; obtiene el último error, si lo hay, de la operación previa (<em>deprecated</em>)</p>
</li>
<li>
<p><code>shutdownServer()</code> &#8594; detiene el servidor</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="__code_dbobject_code">2.8.2. <code>DBObject</code></h4>
<div class="paragraph">
<p>Para representar un documento JSON se utiliza el interfaz <code>DBObject</code>, el cual se emplea como parámetro para la mayoría de operaciones. Su funcionamiento es similar a un mapa donde las claves están ordenadas.</p>
</div>
<div class="paragraph">
<p>Para crear un documento necesitamos una instancia de <code>BasicDBObject</code>. Por ejemplo, podremos crear un documento del siguiente modo:</p>
</div>
<div class="listingblock">
<div class="title">Rellenando un <code>BasicDBObject</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">BasicDBObject</span> <span class="tok-n">doc</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">();</span>
<span class="tok-n">doc</span><span class="tok-o">.</span><span class="tok-na">put</span><span class="tok-o">(</span><span class="tok-s">&quot;nombre&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Aitor Medrano&quot;</span><span class="tok-o">);</span>
<span class="tok-n">doc</span><span class="tok-o">.</span><span class="tok-na">put</span><span class="tok-o">(</span><span class="tok-s">&quot;fnac&quot;</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-nf">Date</span><span class="tok-o">(</span><span class="tok-mi">234832423</span><span class="tok-o">));</span>
<span class="tok-n">doc</span><span class="tok-o">.</span><span class="tok-na">put</span><span class="tok-o">(</span><span class="tok-s">&quot;casado&quot;</span><span class="tok-o">,</span> <span class="tok-kc">true</span><span class="tok-o">);</span>
<span class="tok-n">doc</span><span class="tok-o">.</span><span class="tok-na">put</span><span class="tok-o">(</span><span class="tok-s">&quot;hijos&quot;</span><span class="tok-o">,</span> <span class="tok-mi">2</span><span class="tok-o">);</span>
<span class="tok-n">doc</span><span class="tok-o">.</span><span class="tok-na">put</span><span class="tok-o">(</span><span class="tok-s">&quot;hobbies&quot;</span><span class="tok-o">,</span> <span class="tok-n">Arrays</span><span class="tok-o">.</span><span class="tok-na">asList</span><span class="tok-o">(</span><span class="tok-s">&quot;programación&quot;</span><span class="tok-o">,</span><span class="tok-s">&quot;videojuegos&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;baloncesto&quot;</span><span class="tok-o">));</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-n">doc</span><span class="tok-o">.</span><span class="tok-na">put</span><span class="tok-o">(</span><span class="tok-s">&quot;direccion&quot;</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;calle&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Mayor&quot;</span><span class="tok-o">)</span>  <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="tok-o">.</span><span class="tok-na">append</span><span class="tok-o">(</span><span class="tok-s">&quot;ciudad&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Elx&quot;</span><span class="tok-o">)</span>
  <span class="tok-o">.</span><span class="tok-na">append</span><span class="tok-o">(</span><span class="tok-s">&quot;cp&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;03206&quot;</span><span class="tok-o">));</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Los arrays realmente son implementaciones de <code>BasicDBList</code>, el cual es una lista de <code>DBObject</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Además de usar el método <code>put</code> para añadir un atributo a un objeto, podemos crear un objeto con su constructor de clave/valor, o mediante el método <code>append</code> para concatenar un objeto al existente.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Además, las operaciones para realizar consultas devuelven objetos <code>DBObject</code> o bien son listas (<code>List&lt;DBObject&gt;</code>). Para acceder a los campos de un <code>DBObject</code> emplearemos el método <code>get</code>:</p>
</div>
<div class="listingblock">
<div class="title">Obteniendo datos a partir de un <code>DBObject</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">Persona</span> <span class="tok-n">p</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Persona</span><span class="tok-o">();</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-n">p</span><span class="tok-o">.</span><span class="tok-na">setNombre</span><span class="tok-o">((</span><span class="tok-n">String</span><span class="tok-o">)</span> <span class="tok-n">obj</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-s">&quot;nombre&quot;</span><span class="tok-o">));</span>
<span class="tok-n">p</span><span class="tok-o">.</span><span class="tok-na">setFnac</span><span class="tok-o">((</span><span class="tok-n">Date</span><span class="tok-o">)</span> <span class="tok-n">obj</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-s">&quot;fnac&quot;</span><span class="tok-o">));</span>
<span class="tok-n">p</span><span class="tok-o">.</span><span class="tok-na">setHijos</span><span class="tok-o">((</span><span class="tok-n">Integer</span><span class="tok-o">)</span> <span class="tok-n">obj</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-s">&quot;hijos&quot;</span><span class="tok-o">));</span>

<span class="tok-n">BasicDBList</span> <span class="tok-n">hobbies</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-n">BasicDBList</span><span class="tok-o">)</span> <span class="tok-n">obj</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-s">&quot;hobbies&quot;</span><span class="tok-o">);</span>
<span class="tok-n">p</span><span class="tok-o">.</span><span class="tok-na">setHobbies</span><span class="tok-o">(</span><span class="tok-n">hobbies</span><span class="tok-o">.</span><span class="tok-na">toArray</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-n">String</span><span class="tok-o">[</span><span class="tok-mi">0</span><span class="tok-o">]));</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Supongamos que tenemos una clase de modelo <code>Persona</code> compuesta únicamente de <em>getters</em>/<em>setters</em> sobre las propiedades del objeto</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Dentro de la clase <code>Persona</code>, tenemos la siguiente declaración <code>String[] hobbies</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para realizar operaciones, tras conectar del <code>MongoClient</code> una <code>DB</code>, y de la <code>DB</code> una <code>DBCollection</code> podemos realizar las operaciones de inserción, consulta, modificación y borrado.</p>
</div>
</div>
<div class="sect3">
<h4 id="_inserción">2.8.3. Inserción</h4>
<div class="paragraph">
<p>Para insertar datos emplearemos el método <code>coleccion.insert(DBObject objeto)</code>.</p>
</div>
<div class="paragraph">
<p>Tras insertar el objeto, <em>MongoDB</em> rellenará automáticamente la clave <code>_id</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Autoevaluación</div>
<div class="paragraph">
<p>¿Funcionará el segundo <code>insert</code>? <span class="footnote">[<a id="_footnoteref_5" class="footnote" href="#_footnote_5" title="View footnote.">5</a>]</span></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">MongoClient</span> <span class="tok-n">client</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">MongoClient</span><span class="tok-o">();</span>
<span class="tok-n">DB</span> <span class="tok-n">db</span> <span class="tok-o">=</span> <span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-na">getDB</span><span class="tok-o">(</span><span class="tok-s">&quot;expertojava&quot;</span><span class="tok-o">);</span>
<span class="tok-n">DBCollection</span> <span class="tok-n">people</span> <span class="tok-o">=</span> <span class="tok-n">db</span><span class="tok-o">.</span><span class="tok-na">getCollection</span><span class="tok-o">(</span><span class="tok-s">&quot;people&quot;</span><span class="tok-o">);</span>
<span class="tok-n">DBObject</span> <span class="tok-n">doc</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;nombre&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Aitor Medrano&quot;</span><span class="tok-o">)</span>
  <span class="tok-o">.</span><span class="tok-na">append</span><span class="tok-o">(</span><span class="tok-s">&quot;twitter&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;@aitormedrano&quot;</span><span class="tok-o">);</span>

<span class="tok-k">try</span> <span class="tok-o">{</span>
  <span class="tok-n">people</span><span class="tok-o">.</span><span class="tok-na">insert</span><span class="tok-o">(</span><span class="tok-n">doc</span><span class="tok-o">);</span>      <span class="tok-c1">// primer insert</span>
  <span class="tok-n">doc</span><span class="tok-o">.</span><span class="tok-na">removeField</span><span class="tok-o">(</span><span class="tok-s">&quot;_id&quot;</span><span class="tok-o">);</span>  <span class="tok-c1">// elimina el campo &quot;_id&quot;</span>
  <span class="tok-n">people</span><span class="tok-o">.</span><span class="tok-na">insert</span><span class="tok-o">(</span><span class="tok-n">doc</span><span class="tok-o">);</span>      <span class="tok-c1">// segundo insert</span>
<span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">Exception</span> <span class="tok-n">e</span><span class="tok-o">)</span> <span class="tok-o">{</span>
  <span class="tok-n">e</span><span class="tok-o">.</span><span class="tok-na">printStackTrace</span><span class="tok-o">();</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_consultas_2">2.8.4. Consultas</h4>
<div class="paragraph">
<p>Para hacer consultas utilizaremos el método <code>find</code> o <code>findOne</code>, de manera similar al uso desde el <em>shell</em>. Hay que destacar que cuando hacemos una consulta con <code>find</code> recuperamos un <code>DBCursor</code>, el cual funciona como un iterador y que nos permite recorrer los documentos encontrados.</p>
</div>
<div class="paragraph">
<p>A continuación tenemos un ejemplo de su uso:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">MongoClient</span> <span class="tok-n">client</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">MongoClient</span><span class="tok-o">();</span>
<span class="tok-n">DB</span> <span class="tok-n">db</span> <span class="tok-o">=</span> <span class="tok-n">client</span><span class="tok-o">.</span><span class="tok-na">getDB</span><span class="tok-o">(</span><span class="tok-s">&quot;expertojava&quot;</span><span class="tok-o">);</span>
<span class="tok-n">DBCollection</span> <span class="tok-n">coleccion</span> <span class="tok-o">=</span> <span class="tok-n">db</span><span class="tok-o">.</span><span class="tok-na">getCollection</span><span class="tok-o">(</span><span class="tok-s">&quot;pruebas&quot;</span><span class="tok-o">);</span>
<span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">drop</span><span class="tok-o">();</span>  <i class="conum" data-value="1"></i><b>(1)</b>

<span class="tok-c1">// insertamos 10 documentos con un número aleatorio</span>
<span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-kt">int</span> <span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-o">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-mi">10</span><span class="tok-o">;</span> <span class="tok-n">i</span><span class="tok-o">++)</span> <span class="tok-o">{</span>
  <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">insert</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;numero&quot;</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-nf">Random</span><span class="tok-o">().</span><span class="tok-na">nextInt</span><span class="tok-o">(</span><span class="tok-mi">100</span><span class="tok-o">)));</span>
<span class="tok-o">}</span>

<span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;Primero:&quot;</span><span class="tok-o">);</span>
<span class="tok-n">DBObject</span> <span class="tok-n">uno</span> <span class="tok-o">=</span> <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">findOne</span><span class="tok-o">();</span> <span class="tok-c1">// Encuentra uno</span>
<span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">uno</span><span class="tok-o">);</span>

<span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;\nTodos: &quot;</span><span class="tok-o">);</span>
<span class="tok-n">DBCursor</span> <span class="tok-n">cursor</span> <span class="tok-o">=</span> <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">();</span> <span class="tok-c1">// Encuentra todos</span>
<span class="tok-k">try</span> <span class="tok-o">{</span>
  <span class="tok-k">while</span> <span class="tok-o">(</span><span class="tok-n">cursor</span><span class="tok-o">.</span><span class="tok-na">hasNext</span><span class="tok-o">())</span> <span class="tok-o">{</span>
    <span class="tok-n">DBObject</span> <span class="tok-n">otro</span> <span class="tok-o">=</span> <span class="tok-n">cursor</span><span class="tok-o">.</span><span class="tok-na">next</span><span class="tok-o">();</span>
    <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">otro</span><span class="tok-o">);</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span> <span class="tok-k">finally</span> <span class="tok-o">{</span>
  <span class="tok-n">cursor</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-o">}</span>

<span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;\nTotal:&quot;</span> <span class="tok-o">+</span> <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">count</span><span class="tok-o">());</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Antes de rellenar la colección, la vaciamos para siempre partir de cero.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Es recomendable cerrar el cursor tras finalizar su uso</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_criterios">Criterios</h5>
<div class="paragraph">
<p>Supongamos que partimos de una colección con los siguientes datos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">MongoClient</span> <span class="tok-n">cliente</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">MongoClient</span><span class="tok-o">();</span>
<span class="tok-n">DB</span> <span class="tok-n">db</span> <span class="tok-o">=</span> <span class="tok-n">cliente</span><span class="tok-o">.</span><span class="tok-na">getDB</span><span class="tok-o">(</span><span class="tok-s">&quot;expertojava&quot;</span><span class="tok-o">);</span>
<span class="tok-n">DBCollection</span> <span class="tok-n">coleccion</span> <span class="tok-o">=</span> <span class="tok-n">db</span><span class="tok-o">.</span><span class="tok-na">getCollection</span><span class="tok-o">(</span><span class="tok-s">&quot;pruebas&quot;</span><span class="tok-o">);</span>
<span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">drop</span><span class="tok-o">();</span>

<span class="tok-c1">// insertamos 10 documentos con 2 números aleatorios</span>
<span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-kt">int</span> <span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-o">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-mi">10</span><span class="tok-o">;</span> <span class="tok-n">i</span><span class="tok-o">++)</span> <span class="tok-o">{</span>
  <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">insert</span><span class="tok-o">(</span>
    <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;x&quot;</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-nf">Random</span><span class="tok-o">().</span><span class="tok-na">nextInt</span><span class="tok-o">(</span><span class="tok-mi">2</span><span class="tok-o">))</span>
      <span class="tok-o">.</span><span class="tok-na">append</span><span class="tok-o">(</span><span class="tok-s">&quot;y&quot;</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-nf">Random</span><span class="tok-o">().</span><span class="tok-na">nextInt</span><span class="tok-o">(</span><span class="tok-mi">100</span><span class="tok-o">)));</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para añadir criterios a las consultas, podemos hacerlo de dos maneras:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Usando el objeto <code>QueryBuilder</code>, el cual ofrece diferentes métodos asociados a los operadores lógicos y aritméticos, y que permite hacer consultas a más alto nivel, lo que desacopla al driver de la sintaxis de <em>MongoDB</em>.</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">QueryBuilder</span> <span class="tok-n">builder</span> <span class="tok-o">=</span> <span class="tok-n">QueryBuilder</span><span class="tok-o">.</span><span class="tok-na">start</span><span class="tok-o">(</span><span class="tok-s">&quot;x&quot;</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">).</span><span class="tok-na">and</span><span class="tok-o">(</span><span class="tok-s">&quot;y&quot;</span><span class="tok-o">).</span><span class="tok-na">greaterThan</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">lessThan</span><span class="tok-o">(</span><span class="tok-mi">90</span><span class="tok-o">);</span>
<span class="tok-kt">long</span> <span class="tok-n">cantidadBuilder</span> <span class="tok-o">=</span> <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">count</span><span class="tok-o">(</span><span class="tok-n">builder</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">());</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Más información en <a href="http://api.mongodb.org/java/current/com/mongodb/QueryBuilder.html" class="bare">http://api.mongodb.org/java/current/com/mongodb/QueryBuilder.html</a></p>
</div>
</li>
<li>
<p>Añadiendo las condiciones de manera similar a como se realiza mediante el shell creando <code>BasicDBObject</code></p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">DBObject</span> <span class="tok-n">query</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;x&quot;</span><span class="tok-o">,</span> <span class="tok-mi">0</span><span class="tok-o">).</span><span class="tok-na">append</span><span class="tok-o">(</span><span class="tok-s">&quot;y&quot;</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;$gt&quot;</span><span class="tok-o">,</span> <span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">append</span><span class="tok-o">(</span><span class="tok-s">&quot;$lt&quot;</span><span class="tok-o">,</span> <span class="tok-mi">90</span><span class="tok-o">));</span>
<span class="tok-kt">long</span> <span class="tok-n">cantidadQuery</span> <span class="tok-o">=</span> <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">count</span><span class="tok-o">(</span><span class="tok-n">query</span><span class="tok-o">);</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>En ambos casos, le podemos pasar tanto el <code>DBObject</code> como el <code>QueryBuilder</code> a los métodos <code>find</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;\nConsultas: &quot;</span><span class="tok-o">);</span>
<span class="tok-n">DBCursor</span> <span class="tok-n">cursor</span> <span class="tok-o">=</span> <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">builder</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">());</span>  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-k">try</span> <span class="tok-o">{</span>
  <span class="tok-k">while</span> <span class="tok-o">(</span><span class="tok-n">cursor</span><span class="tok-o">.</span><span class="tok-na">hasNext</span><span class="tok-o">())</span> <span class="tok-o">{</span>
    <span class="tok-n">DBObject</span> <span class="tok-n">cur</span> <span class="tok-o">=</span> <span class="tok-n">cursor</span><span class="tok-o">.</span><span class="tok-na">next</span><span class="tok-o">();</span>
    <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">cur</span><span class="tok-o">);</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span> <span class="tok-k">finally</span> <span class="tok-o">{</span>
  <span class="tok-n">cursor</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A partir de un <code>QueryBuilder</code>, mediante el método <code>get()</code> obtenemos un <code>DBObject</code></td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
La versión 3.0 ha introducido nuevos filtros para facilitar el filtrado de campos, como <code>eq()</code>, <code>gt()</code>, <code>and()</code>, etc&#8230;&#8203; Más información en <a href="http://api.mongodb.org/java/current/com/mongodb/client/model/Filters.html" class="bare">http://api.mongodb.org/java/current/com/mongodb/client/model/Filters.html</a>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_selección_de_campos">Selección de campos</h5>
<div class="paragraph">
<p>Para elegir que datos queremos proyectar y que aparezcan como resultado de la consulta, el método <code>find</code> permite que indiquemos con un segundo parámetro los campos deseados mediante un <code>BasicDBObject</code> poniendo como nombre los nombres de los atributos y como valores <code>true</code>/<code>false</code> dependiendo de si queremos que se devuelvan o no.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">DBObject</span> <span class="tok-n">query</span> <span class="tok-o">=</span> <span class="tok-n">QueryBuilder</span><span class="tok-o">.</span><span class="tok-na">start</span><span class="tok-o">(</span><span class="tok-s">&quot;x&quot;</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">).</span><span class="tok-na">and</span><span class="tok-o">(</span><span class="tok-s">&quot;y&quot;</span><span class="tok-o">).</span><span class="tok-na">greaterThan</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">lessThan</span><span class="tok-o">(</span><span class="tok-mi">70</span><span class="tok-o">).</span><span class="tok-na">get</span><span class="tok-o">();</span>
<span class="tok-n">DBObject</span> <span class="tok-n">proyeccion</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;y&quot;</span><span class="tok-o">,</span> <span class="tok-kc">true</span><span class="tok-o">).</span><span class="tok-na">append</span><span class="tok-o">(</span><span class="tok-s">&quot;_id&quot;</span><span class="tok-o">,</span> <span class="tok-kc">false</span><span class="tok-o">);</span>  <i class="conum" data-value="1"></i><b>(1)</b>

<span class="tok-n">DBCursor</span> <span class="tok-n">cursor</span> <span class="tok-o">=</span> <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">query</span><span class="tok-o">,</span> <span class="tok-n">proyeccion</span><span class="tok-o">);</span>  <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-k">try</span> <span class="tok-o">{</span>
  <span class="tok-k">while</span> <span class="tok-o">(</span><span class="tok-n">cursor</span><span class="tok-o">.</span><span class="tok-na">hasNext</span><span class="tok-o">())</span> <span class="tok-o">{</span>
    <span class="tok-n">DBObject</span> <span class="tok-n">cur</span> <span class="tok-o">=</span> <span class="tok-n">cursor</span><span class="tok-o">.</span><span class="tok-na">next</span><span class="tok-o">();</span>
    <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">cur</span><span class="tok-o">);</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span> <span class="tok-k">finally</span> <span class="tok-o">{</span>
  <span class="tok-n">cursor</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Proyecta el atributo <code>y</code> y no muestra el <code>_id</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Al método <code>find()</code> le pasamos tanto la consulta como la proyección</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Autoevaluación</div>
<div class="paragraph">
<p>Dada una variable <code>alumnos</code> de tipo <code>DBCollection</code>,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">alumnos</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;tlfno&quot;</span><span class="tok-o">,</span> <span class="tok-mi">1</span><span class="tok-o">).</span><span class="tok-na">append</span><span class="tok-o">(</span><span class="tok-s">&quot;_id&quot;</span><span class="tok-o">,</span> <span class="tok-mi">0</span><span class="tok-o">))</span>
<span class="tok-n">alumnos</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;tlfno&quot;</span><span class="tok-o">,</span> <span class="tok-mi">1</span><span class="tok-o">))</span>
<span class="tok-n">alumnos</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(),</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;tlfno&quot;</span><span class="tok-o">,</span> <span class="tok-mi">1</span><span class="tok-o">).</span><span class="tok-na">append</span><span class="tok-o">(</span><span class="tok-s">&quot;_id&quot;</span><span class="tok-o">,</span> <span class="tok-mi">0</span><span class="tok-o">))</span>
<span class="tok-n">alumnos</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;tlfno&quot;</span><span class="tok-o">,</span> <span class="tok-mi">1</span><span class="tok-o">).</span><span class="tok-na">append</span><span class="tok-o">(</span><span class="tok-s">&quot;_id&quot;</span><span class="tok-o">,</span> <span class="tok-mi">0</span><span class="tok-o">),</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>¿Cual de las anteriores instrucciones nos permitirá obtener todos los documentos pero recuperando únicamente el campo <code>tlfno</code> ? <span class="footnote">[<a id="_footnoteref_6" class="footnote" href="#_footnote_6" title="View footnote.">6</a>]</span></p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_campos_anidados">Campos anidados</h5>
<div class="paragraph">
<p>Cuando tenemos un documento que forma parte del valor del atributo de otro documento, usaremos la notación <code>.</code> para navegar y descender un nivel.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-c1">// insertamos 10 documentos con puntos de inicio y fin aleatorios</span>
<span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-kt">int</span> <span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-o">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-mi">10</span><span class="tok-o">;</span> <span class="tok-n">i</span><span class="tok-o">++)</span> <span class="tok-o">{</span>
  <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">insert</span><span class="tok-o">(</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;_id&quot;</span><span class="tok-o">,</span> <span class="tok-n">i</span><span class="tok-o">)</span>
    <span class="tok-o">.</span><span class="tok-na">append</span><span class="tok-o">(</span><span class="tok-s">&quot;inicio&quot;</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;x&quot;</span><span class="tok-o">,</span> <span class="tok-n">rand</span><span class="tok-o">.</span><span class="tok-na">nextInt</span><span class="tok-o">(</span><span class="tok-mi">90</span><span class="tok-o">)).</span><span class="tok-na">append</span><span class="tok-o">(</span><span class="tok-s">&quot;y&quot;</span><span class="tok-o">,</span> <span class="tok-n">rand</span><span class="tok-o">.</span><span class="tok-na">nextInt</span><span class="tok-o">(</span><span class="tok-mi">90</span><span class="tok-o">)))</span>
    <span class="tok-o">.</span><span class="tok-na">append</span><span class="tok-o">(</span><span class="tok-s">&quot;fin&quot;</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;x&quot;</span><span class="tok-o">,</span> <span class="tok-n">rand</span><span class="tok-o">.</span><span class="tok-na">nextInt</span><span class="tok-o">(</span><span class="tok-mi">90</span><span class="tok-o">)).</span><span class="tok-na">append</span><span class="tok-o">(</span><span class="tok-s">&quot;y&quot;</span><span class="tok-o">,</span> <span class="tok-n">rand</span><span class="tok-o">.</span><span class="tok-na">nextInt</span><span class="tok-o">(</span><span class="tok-mi">90</span><span class="tok-o">)))</span>
  <span class="tok-o">);</span>
<span class="tok-o">}</span>

<span class="tok-n">QueryBuilder</span> <span class="tok-n">builder</span> <span class="tok-o">=</span> <span class="tok-n">QueryBuilder</span><span class="tok-o">.</span><span class="tok-na">start</span><span class="tok-o">(</span><span class="tok-s">&quot;inicio.x&quot;</span><span class="tok-o">).</span><span class="tok-na">greaterThan</span><span class="tok-o">(</span><span class="tok-mi">50</span><span class="tok-o">);</span> <i class="conum" data-value="2"></i><b>(2)</b>

<span class="tok-n">DBCursor</span> <span class="tok-n">cursor</span> <span class="tok-o">=</span> <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">builder</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(),</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;inicio.y&quot;</span><span class="tok-o">,</span> <span class="tok-kc">true</span><span class="tok-o">).</span><span class="tok-na">append</span><span class="tok-o">(</span><span class="tok-s">&quot;_id&quot;</span><span class="tok-o">,</span> <span class="tok-kc">false</span><span class="tok-o">));</span> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Crea 10 documentos del tipo <code>{ "_id" : 0 , "inicio" : { "x" : 28 , "y" : 46} , "fin" : { "x" : 37 , "y" : 51}}</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>La consulta filtra por el campo anidado <code>inicio.x</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>La proyección sólo muestra el campo anidado <code>inicio.y</code></td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Autoevaluación</div>
<div class="paragraph">
<p>Con el siguiente fragmento de código, ¿Qué piensas que sucederá si en la colección existe un documento que cumple con la consulta pero no que no tiene una clave llamada <code>medio.url</code> ? <span class="footnote">[<a id="_footnoteref_7" class="footnote" href="#_footnote_7" title="View footnote.">7</a>]</span></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">DBObject</span> <span class="tok-nf">encuentraUrlPorTipoMedio</span><span class="tok-o">(</span><span class="tok-n">DBCollection</span> <span class="tok-n">videos</span><span class="tok-o">,</span> <span class="tok-n">String</span> <span class="tok-n">tipoMedio</span><span class="tok-o">)</span> <span class="tok-o">{</span>
  <span class="tok-n">DBObject</span> <span class="tok-n">query</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;medio.tipo&quot;</span><span class="tok-o">,</span> <span class="tok-n">mediaType</span><span class="tok-o">);</span>
  <span class="tok-n">DBObject</span> <span class="tok-n">proyeccion</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;medio.url&quot;</span><span class="tok-o">,</span> <span class="tok-kc">true</span><span class="tok-o">);</span>

  <span class="tok-k">return</span> <span class="tok-n">videos</span><span class="tok-o">.</span><span class="tok-na">findOne</span><span class="tok-o">(</span><span class="tok-n">query</span><span class="tok-o">,</span> <span class="tok-n">proyeccion</span><span class="tok-o">);</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Lanzará una excepción</p>
</li>
<li>
<p>Devolverá un documento vacío</p>
</li>
<li>
<p>Devolverá un documento que contiene un único campo que contiene el <code>_id</code> del documento</p>
</li>
<li>
<p>No hay suficiente información para responder</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_trabajando_con_code_dbcursor_code">Trabajando con <code>DBCursor</code></h5>
<div class="paragraph">
<p>Del mismo modo que con el <em>shell</em>, podemos utilizar los métodos <code>sort</code>, <code>skip</code> y <code>limit</code> sobre un <code>DBCursor</code>.</p>
</div>
<div class="paragraph">
<p>Suponiendo que tenemos los mismos datos del ejemplo anterior:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo de métodos sobre un cursor -</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">DBCursor</span> <span class="tok-n">cursor</span> <span class="tok-o">=</span> <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">().</span><span class="tok-na">sort</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;inicio.x&quot;</span><span class="tok-o">,</span> <span class="tok-mi">1</span><span class="tok-o">).</span><span class="tok-na">append</span><span class="tok-o">(</span><span class="tok-s">&quot;inicio.y&quot;</span><span class="tok-o">,</span> <span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-o">)).</span><span class="tok-na">skip</span><span class="tok-o">(</span><span class="tok-mi">2</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">);</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_modificación">2.8.5. Modificación</h4>
<div class="paragraph">
<p>Si queremos modificar un documento, el <em>driver</em> nos ofrece el método <code>update</code> con diferentes sobrecargas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>update(DBObject origen, DBOject destino)</code> &#8594; para cambiar un documento por otro, o aplicar un operador sobre <em>destino</em> y actuar conforme indique el operador</p>
</li>
<li>
<p><code>update(DBObject origen, DBOject destino, boolean upsert, boolean multiple)</code> &#8594; igual que el anterior, más la posibilidad de indicar de si hacemos un <em>upsert</em> o si la actualización es múltiple.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Ejemplo de actualización en Java -</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-o">&gt;</span> <span class="tok-n">nombres</span> <span class="tok-o">=</span> <span class="tok-n">Arrays</span><span class="tok-o">.</span><span class="tok-na">asList</span><span class="tok-o">(</span><span class="tok-s">&quot;Laura&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Pedro&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Ana&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Sergio&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Helena&quot;</span><span class="tok-o">);</span>
<span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">nombre</span> <span class="tok-o">:</span> <span class="tok-n">nombres</span><span class="tok-o">)</span> <span class="tok-o">{</span>
  <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">insert</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;_id&quot;</span><span class="tok-o">,</span> <span class="tok-n">nombre</span><span class="tok-o">));</span>
<span class="tok-o">}</span>

<span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">update</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;_id&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Laura&quot;</span><span class="tok-o">),</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;hermanos&quot;</span><span class="tok-o">,</span> <span class="tok-mi">2</span><span class="tok-o">));</span> <i class="conum" data-value="1"></i><b>(1)</b>

<span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">update</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;_id&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Laura&quot;</span><span class="tok-o">),</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;$set&quot;</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;edad&quot;</span><span class="tok-o">,</span> <span class="tok-mi">34</span><span class="tok-o">)));</span> <i class="conum" data-value="2"></i><b>(2)</b>

<span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">update</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;_id&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Laura&quot;</span><span class="tok-o">),</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;sexo&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;F&quot;</span><span class="tok-o">));</span> <i class="conum" data-value="3"></i><b>(3)</b>

<span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">update</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;_id&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Emilio&quot;</span><span class="tok-o">),</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;$set&quot;</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;edad&quot;</span><span class="tok-o">,</span> <span class="tok-mi">36</span><span class="tok-o">)),</span> <span class="tok-kc">true</span><span class="tok-o">,</span> <span class="tok-kc">false</span><span class="tok-o">);</span> <i class="conum" data-value="4"></i><b>(4)</b>

<span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">update</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(),</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;$set&quot;</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;titulo&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Don&quot;</span><span class="tok-o">)),</span> <span class="tok-kc">false</span><span class="tok-o">,</span> <span class="tok-kc">true</span><span class="tok-o">);</span> <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Le asigna a <code>Laura</code> 2 hermanos</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Le añade la edad, pero manteniendo el resto de atributos</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Realiza un reemplazo completo con lo que <code>Laura</code> solo tiene el atributo <code>sexo</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Realiza un <em>upsert</em> con lo que inserta una nueva persona</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Realiza una actualización múltiple, con lo que todas las personas tendrán el atributo <code>"titulo":"Don"</code></td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_borrado">2.8.6. Borrado</h4>
<div class="paragraph">
<p>Para borrar un documento usaremos el método <code>remove(DBObject obj)</code> sobre la colección:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">remove</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;_id&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Sergio&quot;</span><span class="tok-o">));</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Podéis consultar un ejemplo completo de CRUD en <a href="http://www.javahotchocolate.com/notes/mongodb-crud.html" class="bare">http://www.javahotchocolate.com/notes/mongodb-crud.html</a>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="__code_mongodb_driver_code">2.8.7. <code>mongodb-driver</code></h4>
<div class="paragraph">
<p>Si nos centramos en la v3 y el driver <em>Java</em> cuyo artefacto es <code>mongodb-driver</code>, tal como hemos comentado, han cambiado una serie de interfaces:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>la base de datos emplea el interfaz <code>MongoDatabase</code>, y la colección <code>MongoCollection</code></p>
</li>
<li>
<p>los documentos se crean mediante el interfaz <code>Document</code>, el cual emplea el método <code>append(clave, valor)</code> para añadir información al documento</p>
</li>
<li>
<p>uso de filtros en consultas del tipo <code>colleccion.find(and(gt("i", 50), lte("i", 100)))</code></p>
</li>
<li>
<p>actualizaciones mediante los operadores de actualización similares a las operaciones desde el <em>shell</em> como <code>colleccion.updateOne(eq("i", 10), set("i", 110))</code> y métodos específicos como <code>updateMany</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A modo de ejemplo, se muestra un fragmento de código similar al anterior:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">MongoClient</span> <span class="tok-n">cliente</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">MongoClient</span><span class="tok-o">();</span>
<span class="tok-n">MongoDatabase</span> <span class="tok-n">database</span> <span class="tok-o">=</span> <span class="tok-n">cliente</span><span class="tok-o">.</span><span class="tok-na">getDatabase</span><span class="tok-o">(</span><span class="tok-s">&quot;expertojava&quot;</span><span class="tok-o">);</span>
<span class="tok-n">MongoCollection</span><span class="tok-o">&lt;</span><span class="tok-n">Document</span><span class="tok-o">&gt;</span> <span class="tok-n">coleccion</span> <span class="tok-o">=</span> <span class="tok-n">database</span><span class="tok-o">.</span><span class="tok-na">getCollection</span><span class="tok-o">(</span><span class="tok-s">&quot;pruebas&quot;</span><span class="tok-o">);</span>
<span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">drop</span><span class="tok-o">();</span>

<span class="tok-c1">// insertamos 10 documentos con un número aleatorio</span>
<span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-kt">int</span> <span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-o">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-mi">10</span><span class="tok-o">;</span> <span class="tok-n">i</span><span class="tok-o">++)</span> <span class="tok-o">{</span>
  <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">insertOne</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">Document</span><span class="tok-o">(</span><span class="tok-s">&quot;numero&quot;</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-nf">Random</span><span class="tok-o">().</span><span class="tok-na">nextInt</span><span class="tok-o">(</span><span class="tok-mi">100</span><span class="tok-o">)));</span>
<span class="tok-o">}</span>

<span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;Primero:&quot;</span><span class="tok-o">);</span>
<span class="tok-n">Document</span> <span class="tok-n">uno</span> <span class="tok-o">=</span> <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">().</span><span class="tok-na">first</span><span class="tok-o">();</span> <span class="tok-c1">// Encuentra uno</span>
<span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">uno</span><span class="tok-o">);</span>

<span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;\nTodos: &quot;</span><span class="tok-o">);</span>
<span class="tok-n">MongoCursor</span><span class="tok-o">&lt;</span><span class="tok-n">Document</span><span class="tok-o">&gt;</span> <span class="tok-n">cursor</span> <span class="tok-o">=</span> <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">().</span><span class="tok-na">iterator</span><span class="tok-o">();;</span> <span class="tok-c1">// Encuentra todos</span>
<span class="tok-k">try</span> <span class="tok-o">{</span>
  <span class="tok-k">while</span> <span class="tok-o">(</span><span class="tok-n">cursor</span><span class="tok-o">.</span><span class="tok-na">hasNext</span><span class="tok-o">())</span> <span class="tok-o">{</span>
    <span class="tok-n">DBObject</span> <span class="tok-n">otro</span> <span class="tok-o">=</span> <span class="tok-n">cursor</span><span class="tok-o">.</span><span class="tok-na">next</span><span class="tok-o">();</span>
    <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">otro</span><span class="tok-o">.</span><span class="tok-na">toJson</span><span class="tok-o">());</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span> <span class="tok-k">finally</span> <span class="tok-o">{</span>
  <span class="tok-n">cursor</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
<span class="tok-o">}</span>

<span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;\nTotal:&quot;</span> <span class="tok-o">+</span> <span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">count</span><span class="tok-o">());</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Más información en <a href="http://mongodb.github.io/mongo-java-driver/3.2/driver/getting-started/quick-tour/" class="bare">http://mongodb.github.io/mongo-java-driver/3.2/driver/getting-started/quick-tour/</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_mapping_de_objetos">2.9. Mapping de objetos</h3>
<div class="paragraph">
<p>Hasta ahora, el mapeo de objetos POJO a JSON lo estamos realizando a mano, atributo por atributo. Otras opciones alternativas es automatizar el <em>mapping</em> con herramientas como:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Jackson</strong> (<a href="https://github.com/FasterXML/jackson" class="bare">https://github.com/FasterXML/jackson</a>), y en particular <strong>MongoJack</strong> (<a href="http://mongojack.org" class="bare">http://mongojack.org</a>), que facilitan la conversión de BSON a objetos Java. Una alternativa similar es <strong>Gson</strong>, librería de <em>Google</em> (<a href="https://github.com/google/gson" class="bare">https://github.com/google/gson</a>).</p>
</li>
<li>
<p><strong>Morphia</strong> (<a href="http://mongodb.github.io/morphia/" class="bare">http://mongodb.github.io/morphia/</a>): framework <em>ORM</em> ligero, similar a <em>Hibernate</em>, para automatizar el <em>mapping</em> mediante anotaciones.</p>
</li>
<li>
<p><strong>Spring Data MongoDB</strong>: <em>wrapper</em> que facilita la conexión y simplifica el uso de consultas: (<a href="http://projects.spring.io/spring-data-mongodb/" class="bare">http://projects.spring.io/spring-data-mongodb/</a>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>En esta sesión no vamos a entrar en detalle en estas herramientas por falta de tiempo, pero cabe destacar que ofrecen una serie de ventajas que conviene conocer:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Desarrollo más ágil que con mapeo manual.</p>
</li>
<li>
<p>Anotación unificada entre todas las capas.</p>
</li>
<li>
<p>Manejo de tipos amigables, por ejemplo, para cambios de tipos de <code>long</code> a <code>int</code> de manera transparente.</p>
</li>
<li>
<p>Posibilidad de incluir mapeos diferentes entre la base de datos y las capas del servidor web para transformar los formatos como resultado de una llamada REST.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Otra solución flexible es <strong>Hibernate OGM</strong> (<a href="http://hibernate.org/ogm/" class="bare">http://hibernate.org/ogm/</a>), con soporte para <em>Infinispan</em>, <em>Ehcache</em>, <em>MongoDB</em> y <em>Neo4j</em>. Más información sobre <em>Hibernate OGM</em> y <em>MongoDB</em> en <a href="http://docs.jboss.org/hibernate/ogm/4.1/reference/en-US/html/ogm-mongodb.html" class="bare">http://docs.jboss.org/hibernate/ogm/4.1/reference/en-US/html/ogm-mongodb.html</a></p>
</div>
<div class="paragraph">
<p>Finalmente, si nos decidimos por acceder via el <em>driver</em> directamente y empleamos EJB para ofrecer una capa de servicios, es conveniente encapsular el cliente dentro de un <em>Singleton</em>. Podemos ver un ejemplo completo en <a href="http://www.codingpedia.org/ama/how-to-connect-to-mongodb-from-a-java-ee-stateless-application/" class="bare">http://www.codingpedia.org/ama/how-to-connect-to-mongodb-from-a-java-ee-stateless-application/</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios">2.10. Ejercicios</h3>
<div class="paragraph">
<p>En esta sesión, vamos a centrarnos en utilizar los comandos aprendidos para interactuar con los datos de la base de datos <code>ejercicios</code>.</p>
</div>
<div class="paragraph">
<p>Posteriormente, mediante <em>Java</em> también trabajaremos con estos datos.</p>
</div>
<div class="sect3">
<h4 id="__1_punto_ejercicio_21_consultas_desde_code_mongo_code">2.10.1. (1 punto) Ejercicio 21. Consultas desde <code>mongo</code></h4>
<div class="paragraph">
<p>Escribe la operación necesaria y el resultado para averiguar:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Número de ciudades.</p>
</li>
<li>
<p>Datos de la ciudad de <code>Elx</code>.</p>
</li>
<li>
<p>Población de la ciudad de <code>Vergel</code>.</p>
</li>
<li>
<p>Cantidad de ciudades en España <code>({"country":"ES"})</code>.</p>
</li>
<li>
<p>Datos de las ciudades españolas con más de 1.000.000 de habitantes.</p>
</li>
<li>
<p>Cantidad de ciudades de Andorra <code>({"country":"AD"})</code> y España.</p>
</li>
<li>
<p>Listado con el nombre y la población de las 10 ciudades más pobladas.</p>
</li>
<li>
<p>Nombre de las distintas zonas horarias en España.</p>
</li>
<li>
<p>Ciudades españolas que su zona horaria no sea <code>Europe/Madrid</code>.</p>
</li>
<li>
<p>Ciudades españolas que comiencen por <code>Ben</code></p>
</li>
<li>
<p>Ciudades que su zona horaria sea <code>Atlantic/Canary</code> o <code>Africa/Ceuta</code>, y que tengan más de 500.000 habitantes.</p>
</li>
<li>
<p>Nombre y población de las tres ciudades europeas más pobladas.</p>
</li>
<li>
<p>Cantidad de ciudades españolas cuya coordenadas de longitud estén comprendidas entre <code>-0.1</code> y <code>0.1</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Escribe los comandos necesarios y el resultado en <code>ej21.txt</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="__1_punto_ejercicio_22_modificaciones_desde_code_mongo_code">2.10.2. (1 punto) Ejercicio 22. Modificaciones desde <code>mongo</code></h4>
<div class="paragraph">
<p>Escribe la operación necesarias para:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Modifica la población de tu ciudad a 1.000.000</p>
</li>
<li>
<p>Incrementa la población de <code>Elx</code> en 666 personas.</p>
</li>
<li>
<p>Reduce la cantidad de todas las ciudades de Andorra en 5 personas.</p>
</li>
<li>
<p>Modifica la ciudad de <code>Gibraltar</code> para que sea española (tanto el país como la zona horaria).</p>
</li>
<li>
<p>Modifica todas las ciudades y añade un atributo <code>tags</code> que contenga un array vacío.</p>
</li>
<li>
<p>Modifica todas las ciudades españolas y añade al atributo <code>tags</code> el valor <code>sun</code>.</p>
</li>
<li>
<p>Modifica el valor de <code>sun</code> de la ciudad <code>A Coruña</code> y sustitúyelo por <code>rain</code>.</p>
</li>
<li>
<p>Renombra en las ciudades de Andorra, el atributo <code>population</code> por <code>poblacion</code>.</p>
</li>
<li>
<p>Elimina las coordenadas de <code>Gibraltar</code>.</p>
</li>
<li>
<p>Elimina tu entrada</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Escribe los comandos necesarios y el resultado en <code>ej22.txt</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="__1_5_puntos_ejercicio_23_operaciones_desde_em_java_em">2.10.3. (1.5 puntos) Ejercicio 23. Operaciones desde <em>Java</em></h4>
<div class="paragraph">
<p>Los siguientes ejercicios se basan en el uso de <em>Java</em>. Para ello, los ejercicios estarán dentro del paquete <code>es.ua.expertojava.nosql</code>, en una clase nombrada como <code>ConsultasEjercicios</code>.</p>
</div>
<div class="paragraph">
<p>En base a los datos sobre una ciudad almacenados en la colección <code>cities</code> de la base de datos <code>ejercicios</code>, usaremos la siguiente clase <code>Ciudad</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Ciudad</span> <span class="tok-o">{</span>
  <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">name</span><span class="tok-o">;</span>
  <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">country</span><span class="tok-o">;</span>
  <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">timezone</span><span class="tok-o">;</span>
  <span class="tok-kd">private</span> <span class="tok-kt">long</span> <span class="tok-n">population</span><span class="tok-o">;</span>
  <span class="tok-kd">private</span> <span class="tok-kt">float</span> <span class="tok-n">longitude</span><span class="tok-o">;</span>
  <span class="tok-kd">private</span> <span class="tok-kt">float</span> <span class="tok-n">latitude</span><span class="tok-o">;</span>

  <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getName</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-k">return</span> <span class="tok-n">name</span><span class="tok-o">;</span>
  <span class="tok-o">}</span>
  <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setName</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">name</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">name</span> <span class="tok-o">=</span> <span class="tok-n">name</span><span class="tok-o">;</span>
  <span class="tok-o">}</span>

  <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getCountry</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-k">return</span> <span class="tok-n">country</span><span class="tok-o">;</span>
  <span class="tok-o">}</span>
  <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setCountry</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">country</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">country</span> <span class="tok-o">=</span> <span class="tok-n">country</span><span class="tok-o">;</span>
  <span class="tok-o">}</span>

  <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getTimezone</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-k">return</span> <span class="tok-n">timezone</span><span class="tok-o">;</span>
  <span class="tok-o">}</span>
  <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setTimezone</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">timezone</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">timezone</span> <span class="tok-o">=</span> <span class="tok-n">timezone</span><span class="tok-o">;</span>
  <span class="tok-o">}</span>

  <span class="tok-kd">public</span> <span class="tok-kt">long</span> <span class="tok-nf">getPopulation</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-k">return</span> <span class="tok-n">population</span><span class="tok-o">;</span>
  <span class="tok-o">}</span>

  <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setPopulation</span><span class="tok-o">(</span><span class="tok-kt">long</span> <span class="tok-n">population</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">population</span> <span class="tok-o">=</span> <span class="tok-n">population</span><span class="tok-o">;</span>
  <span class="tok-o">}</span>

  <span class="tok-kd">public</span> <span class="tok-kt">float</span> <span class="tok-nf">getLongitude</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-k">return</span> <span class="tok-n">longitude</span><span class="tok-o">;</span>
  <span class="tok-o">}</span>
  <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setLongitude</span><span class="tok-o">(</span><span class="tok-kt">float</span> <span class="tok-n">longitude</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">longitude</span> <span class="tok-o">=</span> <span class="tok-n">longitude</span><span class="tok-o">;</span>
  <span class="tok-o">}</span>

  <span class="tok-kd">public</span> <span class="tok-kt">float</span> <span class="tok-nf">getLatitude</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-k">return</span> <span class="tok-n">latitude</span><span class="tok-o">;</span>
  <span class="tok-o">}</span>
  <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setLatitude</span><span class="tok-o">(</span><span class="tok-kt">float</span> <span class="tok-n">latitude</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">latitude</span> <span class="tok-o">=</span> <span class="tok-n">latitude</span><span class="tok-o">;</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para poder interactuar con este objeto, deberás crear dos métodos privados que se encarguen del <em>mapping</em> entre BSON y el objeto Java:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Ciudad mapDBObject2Ciudad(DBObject dbo)</code></p>
<div class="ulist">
<ul>
<li>
<p>Al asociar la población desde un <code>DBObject</code> a una propiedad <em>Java</em> de tipo <code>long</code>, <em>MongoDB</em> en ocasiones devuelve un entero y en otras un entero largo. Para evitar problemas de <em>casting</em> podemos hacer:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">ciudad</span><span class="tok-o">.</span><span class="tok-na">setPopulation</span><span class="tok-o">(((</span><span class="tok-n">Number</span><span class="tok-o">)</span> <span class="tok-n">dbo</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-s">&quot;population&quot;</span><span class="tok-o">)).</span><span class="tok-na">longValue</span><span class="tok-o">());</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><code>DBObject mapCiudad2DBOject(Ciudad ciudad)</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Una vez creado estos métodos, añadiremos los siguientes  métodos para interactuar con los datos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>void insertaCiudad(Ciudad ciudad)</code>: A partir de una <em>ciudad</em>, inserta los datos en la colecciones <code>cities</code>.</p>
</li>
<li>
<p><code>List&lt;Ciudad&gt; listarCiudades()</code>: Obtiene todas las ciudades de la colección.</p>
</li>
<li>
<p><code>List&lt;Ciudad&gt; listarCiudades(String pais)</code>: Obtiene todos las ciudades de un determinado país.</p>
</li>
<li>
<p><code>List&lt;String&gt; listarPaises()</code>: Obtiene un listado de los paises (sin repeticiones).</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnote_1">
<a href="#_footnoteref_1">1</a>. 2, porque no comparten <code>ObjectId</code>
</div>
<div class="footnote" id="_footnote_2">
<a href="#_footnoteref_2">2</a>. documentos con una calificación superior o igual a 65 y no que no sean de tipo "quiz" ni "homework"
</div>
<div class="footnote" id="_footnote_3">
<a href="#_footnoteref_3">3</a>. <code>db.grades.find({"type":"exam"}).sort({"score":-1}).skip(50).limit(20)</code>
</div>
<div class="footnote" id="_footnote_4">
<a href="#_footnoteref_4">4</a>. Al estar la colección vacía, insertará un nuevo registro
</div>
<div class="footnote" id="_footnote_5">
<a href="#_footnoteref_5">5</a>. Sí, porque la llamada a <code>removeField</code> borrará la clave añadida por el driver en el primer <code>insert</code>
</div>
<div class="footnote" id="_footnote_6">
<a href="#_footnoteref_6">6</a>. la correcta es la 3ª instrucción, ya que el primer parámetro del <code>find</code> indica que quiere todos los documentos, y con el segundo ya fija los campos a devolver
</div>
<div class="footnote" id="_footnote_7">
<a href="#_footnoteref_7">7</a>. lanzará una excepción ya que no puede aplicar la proyección
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2016-01-24 20:22:59 CET
</div>
</div>
</body>
</html>