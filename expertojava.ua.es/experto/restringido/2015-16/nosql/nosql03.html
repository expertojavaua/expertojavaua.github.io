<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.2">
<meta name="author" content="Aitor Medrano">
<title>NoSQL</title>
<style>/*! normalize.css v2.1.2 | MIT License | git.io/normalize */
/* ========================================================================== HTML5 display definitions ========================================================================== */
/** Correct `block` display not defined in IE 8/9. */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }

/** Correct `inline-block` display not defined in IE 8/9. */
audio, canvas, video { display: inline-block; }

/** Prevent modern browsers from displaying `audio` without controls. Remove excess height in iOS 5 devices. */
audio:not([controls]) { display: none; height: 0; }

/** Address `[hidden]` styling not present in IE 8/9. Hide the `template` element in IE, Safari, and Firefox < 22. */
[hidden], template { display: none; }

script { display: none !important; }

/* ========================================================================== Base ========================================================================== */
/** 1. Set default font family to sans-serif. 2. Prevent iOS text size adjust after orientation change, without disabling user zoom. */
html { font-family: sans-serif; /* 1 */ -ms-text-size-adjust: 100%; /* 2 */ -webkit-text-size-adjust: 100%; /* 2 */ }

/** Remove default margin. */
body { margin: 0; }

/* ========================================================================== Links ========================================================================== */
/** Remove the gray background color from active links in IE 10. */
a { background: transparent; }

/** Address `outline` inconsistency between Chrome and other browsers. */
a:focus { outline: thin dotted; }

/** Improve readability when focused and also mouse hovered in all browsers. */
a:active, a:hover { outline: 0; }

/* ========================================================================== Typography ========================================================================== */
/** Address variable `h1` font-size and margin within `section` and `article` contexts in Firefox 4+, Safari 5, and Chrome. */
h1 { font-size: 2em; margin: 0.67em 0; }

/** Address styling not present in IE 8/9, Safari 5, and Chrome. */
abbr[title] { border-bottom: 1px dotted; }

/** Address style set to `bolder` in Firefox 4+, Safari 5, and Chrome. */
b, strong { font-weight: bold; }

/** Address styling not present in Safari 5 and Chrome. */
dfn { font-style: italic; }

/** Address differences between Firefox and other browsers. */
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }

/** Address styling not present in IE 8/9. */
mark { background: #ff0; color: #000; }

/** Correct font family set oddly in Safari 5 and Chrome. */
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }

/** Improve readability of pre-formatted text in all browsers. */
pre { white-space: pre-wrap; }

/** Set consistent quote types. */
q { quotes: "\201C" "\201D" "\2018" "\2019"; }

/** Address inconsistent and variable font size in all browsers. */
small { font-size: 80%; }

/** Prevent `sub` and `sup` affecting `line-height` in all browsers. */
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }

sup { top: -0.5em; }

sub { bottom: -0.25em; }

/* ========================================================================== Embedded content ========================================================================== */
/** Remove border when inside `a` element in IE 8/9. */
img { border: 0; }

/** Correct overflow displayed oddly in IE 9. */
svg:not(:root) { overflow: hidden; }

/* ========================================================================== Figures ========================================================================== */
/** Address margin not present in IE 8/9 and Safari 5. */
figure { margin: 0; }

/* ========================================================================== Forms ========================================================================== */
/** Define consistent border, margin, and padding. */
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }

/** 1. Correct `color` not being inherited in IE 8/9. 2. Remove padding so people aren't caught out if they zero out fieldsets. */
legend { border: 0; /* 1 */ padding: 0; /* 2 */ }

/** 1. Correct font family not being inherited in all browsers. 2. Correct font size not being inherited in all browsers. 3. Address margins set differently in Firefox 4+, Safari 5, and Chrome. */
button, input, select, textarea { font-family: inherit; /* 1 */ font-size: 100%; /* 2 */ margin: 0; /* 3 */ }

/** Address Firefox 4+ setting `line-height` on `input` using `!important` in the UA stylesheet. */
button, input { line-height: normal; }

/** Address inconsistent `text-transform` inheritance for `button` and `select`. All other form control elements do not inherit `text-transform` values. Correct `button` style inheritance in Chrome, Safari 5+, and IE 8+. Correct `select` style inheritance in Firefox 4+ and Opera. */
button, select { text-transform: none; }

/** 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio` and `video` controls. 2. Correct inability to style clickable `input` types in iOS. 3. Improve usability and consistency of cursor style between image-type `input` and others. */
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; /* 2 */ cursor: pointer; /* 3 */ }

/** Re-set default cursor for disabled elements. */
button[disabled], html input[disabled] { cursor: default; }

/** 1. Address box sizing set to `content-box` in IE 8/9. 2. Remove excess padding in IE 8/9. */
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; /* 1 */ padding: 0; /* 2 */ }

/** 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome. 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome (include `-moz` to future-proof). */
input[type="search"] { -webkit-appearance: textfield; /* 1 */ -moz-box-sizing: content-box; -webkit-box-sizing: content-box; /* 2 */ box-sizing: content-box; }

/** Remove inner padding and search cancel button in Safari 5 and Chrome on OS X. */
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }

/** Remove inner padding and border in Firefox 4+. */
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }

/** 1. Remove default vertical scrollbar in IE 8/9. 2. Improve readability and alignment in all browsers. */
textarea { overflow: auto; /* 1 */ vertical-align: top; /* 2 */ }

/* ========================================================================== Tables ========================================================================== */
/** Remove most spacing between table cells. */
table { border-collapse: collapse; border-spacing: 0; }

meta.foundation-mq-small { font-family: "only screen and (min-width: 768px)"; width: 768px; }

meta.foundation-mq-medium { font-family: "only screen and (min-width:1280px)"; width: 1280px; }

meta.foundation-mq-large { font-family: "only screen and (min-width:1440px)"; width: 1440px; }

*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }

html, body { font-size: 97%; }

body { background: white; color: #222222; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }

a:hover { cursor: pointer; }

img, object, embed { max-width: 100%; height: auto; }

object, embed { height: 100%; }

img { -ms-interpolation-mode: bicubic; }

#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }

.left { float: left !important; }

.right { float: right !important; }

.text-left { text-align: left !important; }

.text-right { text-align: right !important; }

.text-center { text-align: center !important; }

.text-justify { text-align: justify !important; }

.hide { display: none; }

.antialiased, body { -webkit-font-smoothing: antialiased; }

img { display: inline-block; vertical-align: middle; }

textarea { height: auto; min-height: 50px; }

select { width: 100%; }

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }

.subheader, .admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { line-height: 1.4; color: #6f6f6f; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }

/* Typography resets */
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }

/* Default Link Styles */
a { color: #1164be; text-decoration: none; line-height: inherit; }
a img { border: none; }

/* Default paragraph styles */
p { font-family: inherit; font-weight: normal; font-size: 1em; line-height: 1.4; margin-bottom: 1em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }

/* Default header styles */
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: bold; font-style: normal; color: #1c355e; text-rendering: optimizeLegibility; margin-top: 1em; margin-bottom: 0.5em; line-height: 1.2125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #6f6f6f; line-height: 0; }

h1 { font-size: 2.125em; }

h2 { font-size: 1.6875em; }

h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }

h4 { font-size: 1.125em; }

h5 { font-size: 1.125em; }

h6 { font-size: 1em; }

hr { border: solid #dddddd; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }

/* Helpful Typography Defaults */
em, i { font-style: italic; line-height: inherit; }

strong, b { font-weight: bold; line-height: inherit; }

small { font-size: 60%; line-height: inherit; }

code { font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: bold; }

/* Lists */
ul, ol, dl { font-size: 1em; line-height: 1.4; margin-bottom: 1.25em; list-style-position: outside; font-family: inherit; }

ul, ol { margin-left: 2.5em; }
ul.no-bullet, ol.no-bullet { margin-left: 1.5em; }

/* Unordered Lists */
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; /* Override nested font-size change */ }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }

/* Ordered Lists */
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }

/* Definition Lists */
dl dt { margin-bottom: 0.3125em; font-weight: bold; }
dl dd { margin-bottom: 1.25em; }

/* Abbreviations */
abbr, acronym { text-transform: uppercase; font-size: 90%; color: #222222; border-bottom: 1px dotted #dddddd; cursor: help; }

abbr { text-transform: none; }

/* Blockquotes */
blockquote { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
blockquote cite { display: block; font-size: 0.8125em; color: #555555; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #555555; }

blockquote, blockquote p { line-height: 1.6; color: #6f6f6f; }

/* Microformats */
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #dddddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }

.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }

/*@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.6875em; }
  h4 { font-size: 1.4375em; } }*/
/* Tables */
table { background: white; margin-bottom: 1.25em; border: solid 1px #dddddd; }
table thead, table tfoot { background: whitesmoke; font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: #222222; text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: #222222; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #f9f9f9; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.4; }

h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; border-bottom: 1px solid #dddddd }

.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }

*:not(pre) > code { font-size: inherit; font-style: normal !important; letter-spacing: 0; padding: 3px 2px 1px 2px; background-color: #eeeeee; border: 1px solid #dddddd; -webkit-border-radius: 0; border-radius: 0; line-height: inherit; font-weight: normal; }

pre, pre > code { line-height: 1.4; color: black; font-family: monospace, serif; font-weight: normal; }

.keyseq { color: #555555; }

kbd { display: inline-block; color: #222222; font-size: 0.75em; line-height: 1.4; background-color: #f7f7f7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; margin: -0.15em 0.15em 0 0.15em; padding: 0.2em 0.6em 0.2em 0.5em; vertical-align: middle; white-space: nowrap; }

.keyseq kbd:first-child { margin-left: 0; }

.keyseq kbd:last-child { margin-right: 0; }

.menuseq, .menu { color: #090909; }

b.button:before, b.button:after { position: relative; top: -1px; font-weight: normal; }

b.button:before { content: "["; padding: 0 3px 0 2px; }

b.button:after { content: "]"; padding: 0 2px 0 3px; }

#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 0.9375em; padding-right: 0.9375em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }

#content { margin-top: 1.25em; }

#content:before { content: none; }

#header > h1:first-child { color: black; margin-top: 2.25rem; margin-bottom: 0; }
#header > h1:first-child + #toc { margin-top: 8px; border-top: 1px solid #dddddd; }
#header > h1:only-child, body.toc2 #header > h1:nth-last-child(2) { border-bottom: 1px solid #dddddd; padding-bottom: 8px; }
#header .details { border-bottom: 1px solid #dddddd; line-height: 1.45; padding-top: 0.25em; padding-bottom: 0.25em; padding-left: 0.25em; color: #555555; display: -ms-flexbox; display: -webkit-flex; display: flex; -ms-flex-flow: row wrap; -webkit-flex-flow: row wrap; flex-flow: row wrap; }
#header .details span:first-child { margin-left: -0.125em; }
#header .details span.email a { color: #6f6f6f; }
#header .details br { display: none; }
#header .details br + span:before { content: "\00a0\2013\00a0"; }
#header .details br + span.author:before { content: "\00a0\22c5\00a0"; color: #6f6f6f; }
#header .details br + span#revremark:before { content: "\00a0|\00a0"; }
#header #revnumber { text-transform: capitalize; }
#header #revnumber:after { content: "\00a0"; }

#content > h1:first-child:not([class]) { color: black; border-bottom: 1px solid #dddddd; padding-bottom: 8px; margin-top: 0; padding-top: 1rem; margin-bottom: 1.25rem; }

#floating {
  position: fixed;
  z-index: 1000;
  padding: 0.5em;
  right: 0;
  top: 0;
  background: white;
  box-shadow: 0 0 1em #777777;
  -webkit-box-shadow: 0 0 1em #777777;
  -moz-box-shadow: 0 0 1em #777777;
  -webkit-border-bottom-left-radius: 5px;
  -moz-border-radius-bottomleft: 5px;
  max-height: 80%;
  overflow: auto;
}

#floating #full { display: none; } /* Hide the full TOC by default */

#floating:hover #full{
  display: block; /* Show it on hover */
}


#toc { border-bottom: 1px solid #dddddd; padding-bottom: 0.5em; }
#toc > ul { margin-left: 0.125em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin: 0.5em 0; }
#toc ul { font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; list-style-type: none; }
#toc a { text-decoration: none; }
#toc a:active { text-decoration: underline; }

#toctitle { color: #6f6f6f; font-size: 1.2em; }

@media only screen and (min-width: 768px) { #toctitle { font-size: 1.375em; }
  body.toc2 { padding-left: 15em; padding-right: 0; }
  #toc.toc2 { margin-top: 0 !important; background-color: #f2f2f2; position: fixed; width: 15em; left: 0; top: 0; border-right: 1px solid #dddddd; border-top-width: 0 !important; border-bottom-width: 0 !important; z-index: 1000; padding: 1.25em 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; font-size: 1.2em; }
  #toc.toc2 > ul { font-size: 0.9em; margin-bottom: 0; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 15em; }
  body.toc2.toc-right #toc.toc2 { border-right-width: 0; border-left: 1px solid #dddddd; left: auto; right: 0; } }
@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; padding-right: 0; }
  #toc.toc2 { width: 20em; }
  #toc.toc2 #toctitle { font-size: 1.375em; }
  #toc.toc2 > ul { font-size: 0.95em; }
  #toc.toc2 ul ul { padding-left: 1.25em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; } }
#content #toc { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 0; border-radius: 0; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }

#footer { max-width: 100%; background-color: #222222; padding: 1.25em; }

#footer-text { color: #dddddd; line-height: 1.44; }

.sect1 { padding-bottom: 0.625em; }

@media only screen and (min-width: 768px) { .sect1 { padding-bottom: 1.25em; } }
.sect1 + .sect1 { border-top: 1px solid #dddddd; }

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; z-index: 1001; width: 1.5ex; margin-left: -1.5ex; display: block; text-decoration: none !important; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: "\00A7"; font-size: 0.85em; display: block; padding-top: 0.1em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #222222; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #151515; }

.audioblock, .imageblock, .literalblock, .listingblock, .stemblock, .videoblock { margin-bottom: 1.25em; }

.admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-rendering: optimizeLegibility; text-align: left; }

table.tableblock > caption.title { white-space: nowrap; overflow: visible; max-width: 0; }

.paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { color: black; }

table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }

.admonitionblock > table { border-collapse: separate; border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #dddddd; color: #555555; }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }

.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 0; border-radius: 0; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }

.sidebarblock { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 0; border-radius: 0; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock > .content > .title { color: #6f6f6f; margin-top: 0; }

.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }

.literalblock pre, .listingblock pre:not(.highlight), .listingblock pre[class="highlight"], .listingblock pre[class^="highlight "], .listingblock pre.CodeRay, .listingblock pre.prettyprint { background: #eeeeee; }
.sidebarblock .literalblock pre, .sidebarblock .listingblock pre:not(.highlight), .sidebarblock .listingblock pre[class="highlight"], .sidebarblock .listingblock pre[class^="highlight "], .sidebarblock .listingblock pre.CodeRay, .sidebarblock .listingblock pre.prettyprint { background: #f2f1f1; }

.literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { border: 1px solid #cccccc; -webkit-border-radius: 0; border-radius: 0; word-wrap: break-word; padding: 0.8em 0.8em 0.65em 0.8em; font-size: 0.8125em; }
.literalblock pre.nowrap, .literalblock pre[class].nowrap, .listingblock pre.nowrap, .listingblock pre[class].nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
@media only screen and (min-width: 768px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 0.90625em; } }
@media only screen and (min-width: 1280px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 1em; } }

.literalblock.output pre { color: #eeeeee; background-color: black; }

.listingblock pre.highlightjs { padding: 0; }
.listingblock pre.highlightjs > code { padding: 0.8em 0.8em 0.65em 0.8em; -webkit-border-radius: 0; border-radius: 0; }

.listingblock > .content { position: relative; }

.listingblock code[data-lang]:before { display: none; content: attr(data-lang); position: absolute; font-size: 0.75em; top: 0.425rem; right: 0.5rem; line-height: 1; text-transform: uppercase; color: #999; }

.listingblock:hover code[data-lang]:before { display: block; }

.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }

.listingblock.terminal pre .command:not([data-prompt]):before { content: "$"; }

table.pyhltable { border-collapse: separate; border: 0; margin-bottom: 0; background: none; }

table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; }

table.pyhltable td.code { padding-left: .75em; padding-right: 0; }

pre.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #dddddd; }

pre.pygments .lineno { display: inline-block; margin-right: .25em; }

table.pyhltable .linenodiv { background: none !important; padding-right: 0 !important; }

.quoteblock { margin: 0 1em 1.25em 1.5em; display: table; }
.quoteblock > .title { margin-left: -1.5em; margin-bottom: 0.75em; }
.quoteblock blockquote, .quoteblock blockquote p { color: #6f6f6f; font-size: 1.15rem; line-height: 1.75; word-spacing: 0.1em; letter-spacing: 0; font-style: italic; text-align: justify; }
.quoteblock blockquote { margin: 0; padding: 0; border: 0; }
.quoteblock blockquote:before { content: "\201c"; float: left; font-size: 2.75em; font-weight: bold; line-height: 0.6em; margin-left: -0.6em; color: #6f6f6f; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: 0.5em; margin-right: 0.5ex; text-align: right; }
.quoteblock .quoteblock { margin-left: 0; margin-right: 0; padding: 0.5em 0; border-left: 3px solid #555555; }
.quoteblock .quoteblock blockquote { padding: 0 0 0 0.75em; }
.quoteblock .quoteblock blockquote:before { display: none; }

.verseblock { margin: 0 1em 1.25em 1em; }
.verseblock pre { font-family: "Open Sans", "DejaVu Sans", sans; font-size: 1.15rem; color: #6f6f6f; font-weight: 300; text-rendering: optimizeLegibility; }
.verseblock pre strong { font-weight: 400; }
.verseblock .attribution { margin-top: 1.25rem; margin-left: 0.5ex; }

.quoteblock .attribution, .verseblock .attribution { font-size: 0.8125em; line-height: 1.45; font-style: italic; }
.quoteblock .attribution br, .verseblock .attribution br { display: none; }
.quoteblock .attribution cite, .verseblock .attribution cite { display: block; letter-spacing: -0.05em; color: #555555; }

.quoteblock.abstract { margin: 0 0 1.25em 0; display: block; }
.quoteblock.abstract blockquote, .quoteblock.abstract blockquote p { text-align: left; word-spacing: 0; }
.quoteblock.abstract blockquote:before, .quoteblock.abstract blockquote p:first-of-type:before { display: none; }

table.tableblock { max-width: 100%; border-collapse: separate; }
table.tableblock td > .paragraph:last-child p > p:last-child, table.tableblock th > p:last-child, table.tableblock td > p:last-child { margin-bottom: 0; }

table.spread { width: 100%; }

table.tableblock, th.tableblock, td.tableblock { border: 0 solid #dddddd; }

table.grid-all th.tableblock, table.grid-all td.tableblock { border-width: 0 1px 1px 0; }

table.grid-all tfoot > tr > th.tableblock, table.grid-all tfoot > tr > td.tableblock { border-width: 1px 1px 0 0; }

table.grid-cols th.tableblock, table.grid-cols td.tableblock { border-width: 0 1px 0 0; }

table.grid-all * > tr > .tableblock:last-child, table.grid-cols * > tr > .tableblock:last-child { border-right-width: 0; }

table.grid-rows th.tableblock, table.grid-rows td.tableblock { border-width: 0 0 1px 0; }

table.grid-all tbody > tr:last-child > th.tableblock, table.grid-all tbody > tr:last-child > td.tableblock, table.grid-all thead:last-child > tr > th.tableblock, table.grid-rows tbody > tr:last-child > th.tableblock, table.grid-rows tbody > tr:last-child > td.tableblock, table.grid-rows thead:last-child > tr > th.tableblock { border-bottom-width: 0; }

table.grid-rows tfoot > tr > th.tableblock, table.grid-rows tfoot > tr > td.tableblock { border-width: 1px 0 0 0; }

table.frame-all { border-width: 1px; }

table.frame-sides { border-width: 0 1px; }

table.frame-topbot { border-width: 1px 0; }

th.halign-left, td.halign-left { text-align: left; }

th.halign-right, td.halign-right { text-align: right; }

th.halign-center, td.halign-center { text-align: center; }

th.valign-top, td.valign-top { vertical-align: top; }

th.valign-bottom, td.valign-bottom { vertical-align: bottom; }

th.valign-middle, td.valign-middle { vertical-align: middle; }

table thead th, table tfoot th { font-weight: bold; }

tbody tr th { display: table-cell; line-height: 1.4; background: whitesmoke; }

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p { color: #222222; font-weight: bold; }

p.tableblock > code:only-child { background: none; padding: 0; }

p.tableblock { font-size: 1em; }

td > div.verse { white-space: pre; }

ol { margin-left: 2.5em; }

ul li ol { margin-left: 1.5em; }

dl dd { margin-left: 1.125em; }

dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }

ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.625em; }

ul.unstyled, ol.unnumbered, ul.checklist, ul.none { list-style-type: none; }

ul.unstyled, ol.unnumbered, ul.checklist { margin-left: 0.625em; }

ul.checklist li > p:first-child > .fa-check-square-o:first-child, ul.checklist li > p:first-child > input[type="checkbox"]:first-child { margin-right: 0.25em; }

ul.checklist li > p:first-child > input[type="checkbox"]:first-child { position: relative; top: 1px; }

ul.inline { margin: 0 auto 0.625em auto; margin-left: -1.375em; margin-right: 0; padding: 0; list-style: none; overflow: hidden; }
ul.inline > li { list-style: none; float: left; margin-left: 1.375em; display: block; }
ul.inline > li > * { display: block; }

.unstyled dl dt { font-weight: normal; font-style: normal; }

ol.arabic { list-style-type: decimal; }

ol.decimal { list-style-type: decimal-leading-zero; }

ol.loweralpha { list-style-type: lower-alpha; }

ol.upperalpha { list-style-type: upper-alpha; }

ol.lowerroman { list-style-type: lower-roman; }

ol.upperroman { list-style-type: upper-roman; }

ol.lowergreek { list-style-type: lower-greek; }

.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }

td.hdlist1 { padding-right: .75em; font-weight: bold; }

td.hdlist1, td.hdlist2 { vertical-align: top; }

.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }

.colist > table tr > td:first-of-type { padding: 0 0.75em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.25em 0; }

.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: 0 0 0 1px #dddddd; box-shadow: 0 0 0 1px #dddddd; }

.imageblock.left, .imageblock[style*="float: left"] { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }

.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }

a.image { text-decoration: none; }

span.footnote, span.footnoteref { vertical-align: super; font-size: 0.875em; }
span.footnote a, span.footnoteref a { text-decoration: none; }
span.footnote a:active, span.footnoteref a:active { text-decoration: underline; }

#footnotes { padding-top: 0.75em; padding-bottom: 0.75em; margin-bottom: 0.625em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -.25em 0 .75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.375em; line-height: 1.3; font-size: 0.875em; margin-left: 1.2em; text-indent: -1.2em; margin-bottom: .2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }

#content #footnotes { margin-top: -0.625em; margin-bottom: 0; padding: 0.75em 0; }

.gist .file-data > table { border: 0; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }

div.unbreakable { page-break-inside: avoid; }

.big { font-size: larger; }

.small { font-size: smaller; }

.underline { text-decoration: underline; }

.overline { text-decoration: overline; }

.line-through { text-decoration: line-through; }

.aqua { color: #00bfbf; }

.aqua-background { background-color: #00fafa; }

.black { color: black; }

.black-background { background-color: black; }

.blue { color: #0000bf; }

.blue-background { background-color: #0000fa; }

.fuchsia { color: #bf00bf; }

.fuchsia-background { background-color: #fa00fa; }

.gray { color: #606060; }

.gray-background { background-color: #7d7d7d; }

.green { color: #006000; }

.green-background { background-color: #007d00; }

.lime { color: #00bf00; }

.lime-background { background-color: #00fa00; }

.maroon { color: #600000; }

.maroon-background { background-color: #7d0000; }

.navy { color: #000060; }

.navy-background { background-color: #00007d; }

.olive { color: #606000; }

.olive-background { background-color: #7d7d00; }

.purple { color: #600060; }

.purple-background { background-color: #7d007d; }

.red { color: #bf0000; }

.red-background { background-color: #fa0000; }

.silver { color: #909090; }

.silver-background { background-color: #bcbcbc; }

.teal { color: #006060; }

.teal-background { background-color: #007d7d; }

.white { color: #bfbfbf; }

.white-background { background-color: #fafafa; }

.yellow { color: #bfbf00; }

.yellow-background { background-color: #fafa00; }

span.icon > .fa { cursor: default; }

.admonitionblock td.icon [class^="fa icon-"] { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #207c98; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }

.conum[data-value] { display: inline-block; color: #fff !important; background-color: #222222; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; font-size: 0.75em; width: 1.67em; height: 1.67em; line-height: 1.67em; font-family: "Open Sans", "DejaVu Sans", sans-serif; font-style: normal; font-weight: bold; }
.conum[data-value] * { color: #fff !important; }
.conum[data-value] + b { display: none; }
.conum[data-value]:after { content: attr(data-value); }
pre .conum[data-value] { position: relative; top: -0.125em; }

b.conum * { color: inherit !important; }

.conum:not([data-value]):empty { display: none; }

.literalblock pre, .listingblock pre { background: #eeeeee; }

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.min.css">
<style>.listingblock .pygments .hll { background-color: #ffffcc }
.listingblock .pygments  { background: #f8f8f8; }
.listingblock .pygments .tok-c { color: #408080; font-style: italic } /* Comment */
.listingblock .pygments .tok-err { border: 1px solid #FF0000 } /* Error */
.listingblock .pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
.listingblock .pygments .tok-o { color: #666666 } /* Operator */
.listingblock .pygments .tok-cm { color: #408080; font-style: italic } /* Comment.Multiline */
.listingblock .pygments .tok-cp { color: #BC7A00 } /* Comment.Preproc */
.listingblock .pygments .tok-c1 { color: #408080; font-style: italic } /* Comment.Single */
.listingblock .pygments .tok-cs { color: #408080; font-style: italic } /* Comment.Special */
.listingblock .pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
.listingblock .pygments .tok-ge { font-style: italic } /* Generic.Emph */
.listingblock .pygments .tok-gr { color: #FF0000 } /* Generic.Error */
.listingblock .pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
.listingblock .pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
.listingblock .pygments .tok-go { color: #888888 } /* Generic.Output */
.listingblock .pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.listingblock .pygments .tok-gs { font-weight: bold } /* Generic.Strong */
.listingblock .pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.listingblock .pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
.listingblock .pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.listingblock .pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.listingblock .pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.listingblock .pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
.listingblock .pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.listingblock .pygments .tok-kt { color: #B00040 } /* Keyword.Type */
.listingblock .pygments .tok-m { color: #666666 } /* Literal.Number */
.listingblock .pygments .tok-s { color: #BA2121 } /* Literal.String */
.listingblock .pygments .tok-na { color: #7D9029 } /* Name.Attribute */
.listingblock .pygments .tok-nb { color: #008000 } /* Name.Builtin */
.listingblock .pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
.listingblock .pygments .tok-no { color: #880000 } /* Name.Constant */
.listingblock .pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
.listingblock .pygments .tok-ni { color: #999999; font-weight: bold } /* Name.Entity */
.listingblock .pygments .tok-ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.listingblock .pygments .tok-nf { color: #0000FF } /* Name.Function */
.listingblock .pygments .tok-nl { color: #A0A000 } /* Name.Label */
.listingblock .pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.listingblock .pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
.listingblock .pygments .tok-nv { color: #19177C } /* Name.Variable */
.listingblock .pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.listingblock .pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
.listingblock .pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
.listingblock .pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
.listingblock .pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
.listingblock .pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
.listingblock .pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
.listingblock .pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
.listingblock .pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
.listingblock .pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.listingblock .pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
.listingblock .pygments .tok-se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.listingblock .pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
.listingblock .pygments .tok-si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.listingblock .pygments .tok-sx { color: #008000 } /* Literal.String.Other */
.listingblock .pygments .tok-sr { color: #BB6688 } /* Literal.String.Regex */
.listingblock .pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
.listingblock .pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
.listingblock .pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
.listingblock .pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
.listingblock .pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
.listingblock .pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
.listingblock .pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>NoSQL</h1>
<div class="details">
<span id="author" class="author">Aitor Medrano</span><br>
<span id="email" class="email">&lt;<a href="mailto:aitormedrano@gmail.com">aitormedrano@gmail.com</a>&gt;</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Índice de contenidos</div>
<ul class="sectlevel1">
<li><a href="#sesion03">3. Rendimiento en <em>MongoDB</em></a>
<ul class="sectlevel2">
<li><a href="#_dise%C3%B1ando_el_esquema">3.1. Diseñando el esquema</a>
<ul class="sectlevel3">
<li><a href="#_referencias">3.1.1. Referencias</a></li>
<li><a href="#_datos_embebidos">3.1.2. Datos embebidos</a></li>
<li><a href="#_relaciones">3.1.3. Relaciones</a></li>
<li><a href="#_rendimiento">3.1.4. Rendimiento</a></li>
</ul>
</li>
<li><a href="#_transacciones_y_concurrencia">3.2. Transacciones y concurrencia</a></li>
<li><a href="#_gridfs">3.3. GridFS</a>
<ul class="sectlevel3">
<li><a href="#__code_mongofiles_code">3.3.1. <code>mongofiles</code></a></li>
<li><a href="#__em_gridfs_em_desde_em_java_em">3.3.2. <em>GridFS</em> desde <em>Java</em></a></li>
<li><a href="#_casos_de_uso">3.3.3. Casos de uso</a></li>
</ul>
</li>
<li><a href="#_%C3%8Dndices">3.4. Índices</a>
<ul class="sectlevel3">
<li><a href="#_simples">3.4.1. Simples</a></li>
<li><a href="#_compuestos">3.4.2. Compuestos</a></li>
<li><a href="#_multiclave">3.4.3. Multiclave</a></li>
<li><a href="#_rendimiento_2">3.4.4. Rendimiento</a></li>
</ul>
</li>
<li><a href="#_colecciones_limitadas">3.5. Colecciones limitadas</a></li>
<li><a href="#_profiling">3.6. Profiling</a></li>
<li><a href="#_ejercicios">3.7. Ejercicios</a>
<ul class="sectlevel3">
<li><a href="#__1_5_puntos_ejercicio_31_dise%C3%B1ando_el_esquema">3.7.1. (1.5 puntos) Ejercicio 31. Diseñando el esquema</a></li>
<li><a href="#__0_75_puntos_ejercicio_32_%C3%8Dndices">3.7.2. (0.75 puntos) Ejercicio 32. Índices</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="sesion03">3. Rendimiento en <em>MongoDB</em></h2>
<div class="sectionbody">
<div class="paragraph">
<p>En esta unidad vamos a estudiar como diseñar el esquema, así como el uso de índices y otras herramientas avanzadas para mejorar el rendimiento.</p>
</div>
<div class="sect2">
<h3 id="_diseñando_el_esquema">3.1. Diseñando el esquema</h3>
<div class="paragraph">
<p><em>MongoDB</em> es una base de datos documental, no relacional, donde el esquema no se debe basar en el uso de claves ajenas/<em>joins</em>, ya que no existen.</p>
</div>
<div class="paragraph">
<p>A la hora de diseñar un esquema, si nos encontramos que el esquema esta en 3FN o si cuando hacemos consultas (recordad que no hay <em>joins</em>) estamos teniendo que realizar varias consultas de manera programativa (primero acceder a una tabla, con ese <code>_id</code> ir a otra tabla, etc&#8230;&#8203;.) es que no estamos siguiendo el enfoque adecuado.</p>
</div>
<div class="paragraph">
<p><em>MongoDB</em> no soporta transacciones, ya que su enfoque distribuido dificultaría y penalizaría el rendimiento. En cambio, sí que asegura que las operaciones sean atómicas. Los posibles enfoques para solucionar la falta de transacciones son:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Restructurar el código para que toda la información esté contenida en un único documento.</p>
</li>
<li>
<p>Implementar un sistema de bloqueo por software (semáforo, etc&#8230;&#8203;).</p>
</li>
<li>
<p>Tolerar un grado de inconsistencia en el sistema.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Dependiendo del tipo de relación entre dos documentos, normalizaremos los datos para minimizar la redundancia pero manteniendo en la medida de lo posible que mediante operaciones atómicas se mantenga la integridad de los datos. Para ello, bien crearemos referencias entre dos documentos o embeberemos un documento dentro de otro.</p>
</div>
<div class="sect3">
<h4 id="_referencias">3.1.1. Referencias</h4>
<div class="paragraph">
<p>Las aplicaciones que emplean <em>MongoDB</em> utilizan dos técnicas para relacionar documentos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Referencias <strong>Manuales</strong></p>
</li>
<li>
<p>Uso de <strong>DBRef</strong></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_referencias_manuales">Referencias manuales</h5>
<div class="paragraph">
<p>De manera similar a una base de datos relacional, se almacena el campo <code>_id</code> de un documento en otro documento a modo de clave ajena. De este modo, la aplicación realiza una segunda consulta para obtener los datos relaciones. Estas referencias son sencillas y suficientes para la mayoría de casos de uso.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql03/data-model-normalized.png" alt="Referencias manuales" width="66%">
</div>
<div class="title">Figure 1. Referencias manuales</div>
</div>
<div class="paragraph">
<p>Por ejemplo, si nos basamos en el gráfico anterior, podemos conseguir referenciar estos objetos del siguiente modo:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo de referencia manual - Usuario/Contacto</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">idUsuario</span> <span class="tok-o">=</span> <span class="tok-nx">ObjectId</span><span class="tok-p">();</span>

<span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">usuario</span><span class="tok-p">.</span><span class="tok-nx">insert</span><span class="tok-p">({</span>
  <span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-nx">idUsuario</span><span class="tok-p">,</span>
  <span class="tok-nx">nombre</span><span class="tok-o">:</span> <span class="tok-s2">&quot;123xyz&quot;</span>
<span class="tok-p">});</span>

<span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">contacto</span><span class="tok-p">.</span><span class="tok-nx">insert</span><span class="tok-p">({</span>
  <span class="tok-nx">usuario_id</span><span class="tok-o">:</span> <span class="tok-nx">idUsuario</span><span class="tok-p">,</span>
  <span class="tok-nx">telefono</span><span class="tok-o">:</span>  <span class="tok-s2">&quot;123 456 7890&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">email</span><span class="tok-o">:</span> <span class="tok-s2">&quot;xyz@ejemplo.com&quot;</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_dbref">DBRef</h5>
<div class="paragraph">
<p>Son referencias de un documento a otro mediante el valor del campo <code>_id</code>, el nombre de la colección y, opcionalmente, el nombre de la base de datos. Estos objetos siguen una convención para representar un documento mediante la notación <code>{ "$ref" : &lt;nombreColeccion&gt;, "$id" : &lt;valorCampo_id&gt;, "$db" : &lt;nombreBaseDatos&gt; }</code>.</p>
</div>
<div class="paragraph">
<p>Al incluir estos nombres, las <em>DBRef</em> permite referenciar documentos localizados en diferentes colecciones.</p>
</div>
<div class="paragraph">
<p>Así pues, si reescribimos el código anterior mediante <em>DBRef</em> tendríamos que el contacto queda de la siguiente manera:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo de DBRef - Usuario/Contacto</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">contacto</span><span class="tok-p">.</span><span class="tok-nx">insert</span><span class="tok-p">({</span>
  <span class="tok-nx">usuario_id</span><span class="tok-o">:</span> <span class="tok-k">new</span> <span class="tok-nx">DBRef</span><span class="tok-p">(</span><span class="tok-s2">&quot;usuario&quot;</span><span class="tok-p">,</span> <span class="tok-nx">idUsuario</span><span class="tok-p">),</span>
  <span class="tok-nx">telefono</span><span class="tok-o">:</span>  <span class="tok-s2">&quot;123-456-7890&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">email</span><span class="tok-o">:</span> <span class="tok-s2">&quot;xyz@example.com&quot;</span>
<span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>De manera similar a las referencias manuales, mediante consultas adicionales se obtendrán los documentos referenciados.</p>
</div>
<div class="paragraph">
<p>Muchos <em>drivers</em> (incluido el de <em>Java</em>, mediante la clase <code>DBRef</code>) contienen métodos auxiliares que realizan las consultas con referencias <em>DBRef</em> automáticamennte.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Desde la propia documentación de <em>MongoDB</em>, recomiendan el uso de referencias manuales, a no ser de que dispongamos documentos de una colección que referencian a documentos que se encuentran en varias colecciones diferentes.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_datos_embebidos">3.1.2. Datos embebidos</h4>
<div class="paragraph">
<p>En cambio, si dentro de un documento almacenamos los datos mediante sub-documentos, ya sea dentro de un atributo o un array, podremos obtener todos los datos mediante un único acceso.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql03/data-model-denormalized.png" alt="Datos Embebidos" width="50%">
</div>
<div class="title">Figure 2. Datos Embebidos</div>
</div>
<div class="paragraph">
<p>Generalmente, emplearemos datos embebidos cuando tengamos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>relaciones <em>"contiene"</em> entre entidades, entre relaciones de documentos "uno a uno" o "uno a pocos".</p>
</li>
<li>
<p>relaciones "uno a muchos" entre entidades. En estas relaciones los documentos hijo (o "muchos") siempre aparecen dentro del contexto del padre o del documento "uno".</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Los datos embebidos ofrecen mejor rendimiento al permitir obtener los datos mediante una única operación, así como modificar datos relacionados en una sola operación atómica de escritura.</p>
</div>
<div class="paragraph">
<p>Un aspecto a tener en cuenta es que un documento <em>BSON</em> puede contener un máximo de 16MB. Si quisiéramos que un atributo contenga más información, tendríamos que utilizar el API de <em>GridFS</em> que veremos más adelante.</p>
</div>
</div>
<div class="sect3">
<h4 id="_relaciones">3.1.3. Relaciones</h4>
<div class="paragraph">
<p>Vamos a estudiar en detalle cada uno de los tipos de relaciones, para intentar clarificar cuando es conveniente utilizar referencias o datos embebidos.</p>
</div>
<div class="sect4">
<h5 id="_1_1">1:1</h5>
<div class="paragraph">
<p>Cuando existe una relación 1:1, como pueda ser entre <code>Persona</code> y <code>Curriculum</code>, o <code>Persona</code> y <code>Direccion</code> hay que embeber un documento dentro del otro, como parte de un atributo.</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo relación 1:1 - Persona/Dirección</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span>
  <span class="tok-nx">nombre</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Aitor&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">edad</span><span class="tok-o">:</span> <span class="tok-mi">38</span><span class="tok-p">,</span>
  <span class="tok-nx">direccion</span><span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-nx">calle</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Mayor&quot;</span><span class="tok-p">,</span>
    <span class="tok-nx">ciudad</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Elx&quot;</span>
  <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La principal ventaja de este planteamiento es que mediante una única consulta podemos obtener tanto los detalles del usuario como su dirección.</p>
</div>
<div class="paragraph">
<p>Un par de aspectos que nos pueden llevar a no embeberlos son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>la frecuencia de acceso. Si a uno de ellos se accede raramente, puede que convenga tenerlos separados para liberar memoria.</p>
</li>
<li>
<p>el tamaño de los elementos. Si hay uno que es mucho más grande que el otro, o uno lo modificamos muchas más veces que el otro, para que cada vez que hagamos un cambio en un documento no tengamos que modificar el otro será mejor separarlos en documentos separados.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Pero siempre teniendo en cuenta la atomicidad de los datos, ya que si necesitamos modificar los dos documentos al mismo tiempo, tendremos que embeber uno dentro del otro.</p>
</div>
</div>
<div class="sect4">
<h5 id="_1_n">1:N</h5>
<div class="paragraph">
<p>Vamos a distinguir dos tipos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>1 a muchos</strong>, como puede ser entre <code>Editorial</code> y <code>Libro</code>. Para este tipo de relación es mejor usar referencias entre los documentos:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Ejemplo relación 1:N - Editorial</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span>
  <span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
  <span class="tok-nx">nombre</span><span class="tok-o">:</span> <span class="tok-s2">&quot;O&#39;Reilly&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">pais</span><span class="tok-o">:</span> <span class="tok-s2">&quot;EE.UU.&quot;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Ejemplo relación 1:N - Libro</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span>
  <span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-mi">1234</span><span class="tok-p">,</span>
  <span class="tok-nx">titulo</span><span class="tok-o">:</span> <span class="tok-s2">&quot;MongoDB: The Definitive Guide&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">autor</span><span class="tok-o">:</span> <span class="tok-p">[</span> <span class="tok-s2">&quot;Kristina Chodorow&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;Mike Dirolf&quot;</span> <span class="tok-p">],</span>
  <span class="tok-nx">numPaginas</span><span class="tok-o">:</span> <span class="tok-mi">216</span><span class="tok-p">,</span>
  <span class="tok-nx">editorial_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
<span class="tok-p">}</span>
<span class="tok-p">{</span>
  <span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-mi">1235</span><span class="tok-p">,</span>
  <span class="tok-nx">titulo</span><span class="tok-o">:</span> <span class="tok-s2">&quot;50 Tips and Tricks for MongoDB Developer&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">autor</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Kristina Chodorow&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">numPaginas</span><span class="tok-o">:</span> <span class="tok-mi">68</span><span class="tok-p">,</span>
  <span class="tok-nx">editorial_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>1 a pocos</strong>, como por ejemplo, dentro de un blog, la relación entre <code>Mensaje</code> y <code>Comentario</code>. En este caso, la mejor solución es crear un array dentro de la entidad 1 ( en nuestro caso, <code>Mensaje</code>). De este modo, el <code>Mensaje</code> contiene un array de <code>Comentario</code>:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Ejemplo relación 1:N - Mensaje/Comentario</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span>
  <span class="tok-nx">titulo</span><span class="tok-o">:</span> <span class="tok-s2">&quot;La broma asesina&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">url</span><span class="tok-o">:</span> <span class="tok-s2">&quot;http://es.wikipedia.org/wiki/Batman:_The_Killing_Joke&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">texto</span><span class="tok-o">:</span> <span class="tok-s2">&quot;La dualidad de Batman y Joker&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">comentarios</span><span class="tok-o">:</span> <span class="tok-p">[</span>
    <span class="tok-p">{</span>
      <span class="tok-nx">autor</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Bruce Wayne&quot;</span><span class="tok-p">,</span>
      <span class="tok-nx">fecha</span><span class="tok-o">:</span> <span class="tok-nx">ISODate</span><span class="tok-p">(</span><span class="tok-s2">&quot;2015-04-01T09:31:32Z&quot;</span><span class="tok-p">),</span>
      <span class="tok-nx">comentario</span><span class="tok-o">:</span> <span class="tok-s2">&quot;A mi me encantó&quot;</span>
    <span class="tok-p">},</span>
    <span class="tok-p">{</span>
      <span class="tok-nx">autor</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Bruno Díaz&quot;</span><span class="tok-p">,</span>
      <span class="tok-nx">fecha</span><span class="tok-o">:</span> <span class="tok-nx">ISODate</span><span class="tok-p">(</span><span class="tok-s2">&quot;2015-04-03T10:07:28Z&quot;</span><span class="tok-p">),</span>
      <span class="tok-nx">comentario</span><span class="tok-o">:</span> <span class="tok-s2">&quot;El mejor&quot;</span>
    <span class="tok-p">}</span>
  <span class="tok-p">]</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Hay que tener siempre en mente la restricción de los 16 MB de BSON. Si vamos a embeber muchos documentos y estos son grandes, hay que vigilar no llegar a dicho tamaño.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En ocasiones las relaciones 1 a muchos se traducen en documentos embebidos cuando la información que nos interesa es la que contiene en un momento determinado. Por ejemplo, dentro de <code>Pedido</code>, el precio de los productos debe embeberse, ya que si en un futuro se modifica el precio de un producto determinado debido a una oferta, el pedido realizado no debe modificar su precio total.</p>
</div>
<div class="paragraph">
<p>Del mismo modo, al almacenar la dirección de una persona, también es conveniente embeberla. No queremos que la dirección de envío de un pedido se modique si un usuario modifica sus datos personales.</p>
</div>
</div>
<div class="sect4">
<h5 id="_n_m">N:M</h5>
<div class="paragraph">
<p>Más que relaciones muchos a muchos, suelen ser relaciones pocos a pocos, como por ejemplo, <code>Libro</code> y <code>Autor</code>, o <code>Profesor</code> y <code>Estudiante</code>.</p>
</div>
<div class="paragraph">
<p>Supongamos que tenemos libros de la siguiente manera y autores con la siguiente estructura:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo relación N:N - Libro</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span>
  <span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
  <span class="tok-nx">titulo</span><span class="tok-o">:</span> <span class="tok-s2">&quot;La historia interminable&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">anyo</span><span class="tok-o">:</span> <span class="tok-mi">1979</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Ejemplo relación N:M - Autor</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span>
  <span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
  <span class="tok-nx">nombre</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Michael Ende&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">pais</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Alemania&quot;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos resolver estas relaciones de tres maneras:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Siguiendo un enfoque relacional, empleando un documento como la entidad que agrupa con referencias manuales a los dos documentos.</p>
<div class="listingblock">
<div class="title">Ejemplo relación N:M - Autor/Libro</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span>
  <span class="tok-nx">autor_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
  <span class="tok-nx">libro_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Este enfoque se desaconseja porque necesita tres consultas para obtener toda la información.</p>
</div>
</li>
<li>
<p>Mediante 2 documentos, cada uno con un array que contenga los ids del otro documento (<em>2 Way Embedding</em>). Hay que tener cuidado porque podemos tener problemas de inconsistencia de datos si no actualizamos correctamente.</p>
<div class="listingblock">
<div class="title">Ejemplo relación N:N - Libro referencia a Autor</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span>
  <span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
  <span class="tok-nx">titulo</span><span class="tok-o">:</span> <span class="tok-s2">&quot;La historia interminable&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">anyo</span><span class="tok-o">:</span> <span class="tok-mi">1979</span><span class="tok-p">,</span>
  <span class="tok-nx">autores</span><span class="tok-o">:</span> <span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span>
<span class="tok-p">},{</span>
  <span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
  <span class="tok-nx">titulo</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Momo&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">anyo</span><span class="tok-o">:</span> <span class="tok-mi">1973</span><span class="tok-p">,</span>
  <span class="tok-nx">autores</span><span class="tok-o">:</span> <span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Ejemplo relación N:M - Autor referencia a Libro</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span>
  <span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
  <span class="tok-nx">nombre</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Michael Ende&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">pais</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Alemania&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">libros</span><span class="tok-o">:</span> <span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">,</span><span class="tok-mi">2</span><span class="tok-p">]</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</li>
<li>
<p>Embeber un documento dentro de otro (<em>One Way Embedding</em>). Por ejemplo:</p>
<div class="listingblock">
<div class="title">Ejemplo relación N:M - Autor embebido en Libro</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span>
  <span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
  <span class="tok-nx">titulo</span><span class="tok-o">:</span> <span class="tok-s2">&quot;La historia interminable&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">anyo</span><span class="tok-o">:</span> <span class="tok-mi">1979</span><span class="tok-p">,</span>
  <span class="tok-nx">autores</span><span class="tok-o">:</span> <span class="tok-p">[{</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s2">&quot;Michael Ende&quot;</span><span class="tok-p">,</span> <span class="tok-nx">pais</span><span class="tok-o">:</span><span class="tok-s2">&quot;Alemania&quot;</span><span class="tok-p">}]</span>
<span class="tok-p">},{</span>
  <span class="tok-nx">_id</span><span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
  <span class="tok-nx">titulo</span><span class="tok-o">:</span> <span class="tok-s2">&quot;Momo&quot;</span><span class="tok-p">,</span>
  <span class="tok-nx">anyo</span><span class="tok-o">:</span> <span class="tok-mi">1973</span><span class="tok-p">,</span>
  <span class="tok-nx">autores</span><span class="tok-o">:</span> <span class="tok-p">[{</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s2">&quot;Michael Ende&quot;</span><span class="tok-p">,</span> <span class="tok-nx">pais</span><span class="tok-o">:</span><span class="tok-s2">&quot;Alemania&quot;</span><span class="tok-p">}]</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En principio este enfoque no se recomienda porque el documento puede crecer mucho y provocar anomalías de modificaciones donde la información no es consistente. Si se opta por esta solución, hay que tener en cuenta que si un documento depende de otro para su creación (por ejemplo, si metemos los profesores dentro de los estudiantes, no vamos a poder dar de alta a profesores sin haber dado de alta previamente a un alumno).</p>
</div>
<div class="paragraph">
<p>A modo de resumen, en las relaciones N:M, hay que establecer el tamaño de N y M. Si N como máximo vale 3 y M 500000, entonces deberíamos seguir un enfoque de embeber la N dentro de la M (<em>One Way Embedding</em>).</p>
</div>
<div class="paragraph">
<p>En cambio, si N vale 3 y M vale 5, entonces podemos hacer que ambos embeban al otro documento (<em>Two Way Embedding</em>).</p>
</div>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Más información en <a href="http://docs.mongodb.org/manual/applications/data-models-relationships/" class="bare">http://docs.mongodb.org/manual/applications/data-models-relationships/</a>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_jerárquicas">Jerárquicas</h5>
<div class="paragraph">
<p>Si tenemos que modelar alguna entidad que tenga hijos y nos importa las relaciones padre-hijos (categoría-subcategoría), podemos tanto embeber un array con los hijos de un documento (<em>children</em>), como embeber un array con los padres de un documento (<em>ancestors</em>)</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Más información en <a href="http://docs.mongodb.org/manual/applications/data-models-tree-structures/" class="bare">http://docs.mongodb.org/manual/applications/data-models-tree-structures/</a>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_rendimiento">3.1.4. Rendimiento</h4>
<div class="paragraph">
<p>De modo general, si vamos a realizar más lecturas que escrituras, es más conveniente denormalizar los datos para usar datos embebidos y así con sólo una lectura obtengamos más información. En cambio, si realizamos muchas inserciones y sobretodo actualizaciones, será conveniente usar referencias con dos documentos.</p>
</div>
<div class="paragraph">
<p>El mayor beneficio de embeber documentos es el rendimiento, sobretodo el de lectura. El acceso a disco es la parte más lenta, pero una vez la aguja se ha colocado en el sector adecuado, la información se obtiene muy rápidamente (alto ancho de banda). El hecho de que toda la información a recuperar esté almacenada de manera secuencial, mediante documentos embebidos, favorece que el rendimiento de lectura sea muy alto, ya que sólo se hace un acceso a la BBDD. Por lo tanto, si la consistencia es secundaria, duplicar los datos (pero de manera limitada) no es una mala idea, ya que el espacio en disco es más barato que el tiempo de computación.</p>
</div>
<div class="paragraph">
<p>Es por ello, que un planteamiento inicial a la hora de modelar los datos es basarse en unidades de aplicación, entendiendo como unidad una petición al <em>backend</em>, ya sea el <em>click</em> de un botón o la carga de los datos para un gráfico. Así pues, cada unidad de aplicación se debería poder conseguir con una única consulta, y por tanto, en gran medida los datos estarán embebidos.</p>
</div>
<div class="paragraph">
<p>Si lo que necesitamos es consistencia de datos, entonces hay que normalizar y usar referencias. Esto conllevará que al modificar un documento, al estar normalizado los datos serán consistentes, aunque necesitemos dos o más lecturas para obtener la información deseada.</p>
</div>
<div class="paragraph">
<p>Hay que tener en cuenta que no debemos hacer <em>joins</em> en las lecturas. En todo caso, si tenemos redundancia, las realizaremos en las escrituras.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Estos y más consejos en <em>6 Rules of Thumb for MongoDB Schema Design</em>: <a href="http://blog.mongodb.org/post/87200945828/6-rules-of-thumb-for-mongodb-schema-design-part-1" class="bare">http://blog.mongodb.org/post/87200945828/6-rules-of-thumb-for-mongodb-schema-design-part-1</a>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_transacciones_y_concurrencia">3.2. Transacciones y concurrencia</h3>
<div class="paragraph">
<p>Ya hemos visto que <em>MongoDB</em> no soporta el concepto de transacción. Mientras que en un SGDB relacional podemos agrupar varias operaciones en una transacción para obtener atomicidad y <em>rollback</em>, en <em>MongoDB</em> solo podemos utilizar las diferentes operaciones de modificación que trabajan con la estructura interna de un documento.
Así pues, la manera de resolver que no haya soporte para transacciones es incrementar la complejidad de un documento para que contenga varios documentos anidados.</p>
</div>
<div class="paragraph">
<p>En el caso de necesitar las transacciones de manera explícita, tal como una aplicación bancaria, no hay nada mejor que una base de datos relacional. Dependiendo del escenario, se pueden combinar ambos enfoques (relacional y <em>MongoDB</em>), mediante una infraestructura más compleja, tanto de desarrollar como de mantener. Estas soluciones híbridas se están haciendo más comunes, y dan pie al concepto de <em>persistencia políglota</em>.</p>
</div>
<div class="paragraph">
<p>Respecto a la <strong>concurrencia</strong>, en los SGBD relacionales, la gestión que se realiza de la ejecución concurrente de una unidad de trabajo se implementa mediante bloqueos o control de multiversiones para aislar cada unidad de trabajo. En cambio, <em>MongoDB</em> emplea bloqueos de lectura/escritura que permiten acceso concurrente para las lecturas de un recurso (ya sea una base de datos o una colección), pero sólo da acceso exclusivo para cada operación de escritura.</p>
</div>
<div class="paragraph">
<p>De una manera más detallada, <em>MongoDB</em> gestiona los bloqueos de lectura y escritura del siguiente modo:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Puede haber un número ilimitado de lecturas simultáneas a un base de datos.</p>
</li>
<li>
<p>En un momento dado, sólo puede haber un escritor en cualquier colección en cualquier base de datos.</p>
</li>
<li>
<p>Una vez recibida una petición de escritura, el escritor bloquea a todos los lectores.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Desde la versión 2.2, se puede restringir el alcance del bloqueo a la base de datos sobre la que se realiza la lectura o la escritura. Desde la versión 3.0, se ha mejorado la gestión de la concurrencia, y sólo se bloquean los documentos implicados en la operación de escritura.</p>
</div>
<div class="paragraph">
<p>Para almacenar información sobre los bloqueos, <em>MongoDB</em> se basa en el motor de almacenamiento, el cual define como se almancenan los datos en el disco. A día de hoy, <em>MongoDB</em> ofrece dos motores:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>MMAPv1</strong>: Almacenamiento por defecto. Emplea bloqueos a nivel de colección.</p>
</li>
<li>
<p><strong>WiredTiger</strong>: Nuevo motor de almacenamiento, que ofrece bloqueo a nivel de documento y permite compresión de los datos. Mediante este motor, múltiples clientes pueden modificar más de un documento de una misma colección al mismo tiempo.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Para indicar el motor de almacenamiento empleado, al arrancar el demonio de <em>MongoDB</em>, mediante el parámetro <code>--storageEngine</code> podemos indicar si queremos <code>mmapv1</code> o <code>wiredTiger</code>:</p>
</div>
<div class="listingblock">
<div class="title">Arrancando con el nuevo motor <code>wiredTiger</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">mongod --storageEngine wiredTiger</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_gridfs">3.3. GridFS</h3>
<div class="paragraph">
<p>Tal como comentamos anteriormente, los documentos BSON tienen la restricción de que no pueden ocupar más de 16 MB. Si necesitamos almacenar <em>Blobs</em>, hemos de utilizar GridFS, el cual es una utilidad que divide un <em>Blob</em> en partes para crear una colección y poder almacenar más información.</p>
</div>
<div class="paragraph">
<p>Así pues, en vez de almacenar un fichero en un único documento, <em>GridFS</em> divide el fichero en partes, o trozos (<em>chunks</em>), y almacena cada uno de estos trozos en un documento separado. Por defecto, <em>GridFS</em> limita el tamaño de cada trozo a 256KB.</p>
</div>
<div class="paragraph">
<p>Para ello, utiliza dos colecciones para almacenar los archivos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>La colección <code>chunks</code> almacena los trozos de los ficheros</p>
</li>
<li>
<p>Mientra que la colección <code>files</code> almacena los metadatos de los ficheros.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql03/gridfs.jpg" alt="GridFS" width="33%">
</div>
<div class="title">Figure 3. GridFS</div>
</div>
<div class="paragraph">
<p>Estas colecciones se crean en el espacio de nombres <code>fs</code>. Este nombre se puede modificar, por ejemplo, si queremos almacenar diferentes tipos de archivos, es decir, por una lado imágenes y por otro vídeos.</p>
</div>
<div class="paragraph">
<p>Cuando se consulta un almacén <em>GridFS</em> por un fichero, el driver o el cliente unirá los trozos tal como necesite. Se pueden hacer consultas sobre ficheros almacenados con <em>GridFS</em>. También se puede acceder a información de secciones arbitrarias de los ficheros, lo que nos permite saltar a la mitad de un archivo de sonido o video.</p>
</div>
<div class="sect3">
<h4 id="__code_mongofiles_code">3.3.1. <code>mongofiles</code></h4>
<div class="paragraph">
<p>Para interactuar con los archivos almacenados desde la consola utilizaremos el comando <code>mongofiles</code>.</p>
</div>
<div class="paragraph">
<p>Si queremos visualizar todos los ficheros que tenemos en nuestra base de datos usaremos la opción <code>list</code>:</p>
</div>
<div class="listingblock">
<div class="title">Listando los archivos GridFS mediante <code>mongofiles</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span class="tok-nv">$ </span>mongofiles list</code></pre>
</div>
</div>
<div class="paragraph">
<p>Al estar vacía la base de datos no se mostrará nada. Aunque en el día a día no utilizaremos <code>mongofiles</code> para interactuar con los archivos, si que es muy útil para explorar y probar los archivos almacenados.</p>
</div>
<div class="paragraph">
<p>Una vez que creamos un archivo, podemos usar la herramienta para explorar los archivos y trozos creados.</p>
</div>
<div class="paragraph">
<p>Para incluir un archivo, se realiza mediante la opción de <code>put</code>:</p>
</div>
<div class="paragraph">
<p>Por ejemplo, para añadir el archivo <code>video.mp4</code> haríamos:</p>
</div>
<div class="listingblock">
<div class="title">Insertando un archivo en GridFS mediante <code>mongofiles</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span class="tok-nv">$ </span>mongofiles put video.mp4
connected to: 127.0.0.1
added file: <span class="tok-o">{</span> _id: ObjectId<span class="tok-o">(</span><span class="tok-s1">&#39;550957b83f627a4bb7f28bc8&#39;</span><span class="tok-o">)</span>, filename: <span class="tok-s2">&quot;video.mp4&quot;</span>, chunkSize: 261120, uploadDate: new Date<span class="tok-o">(</span>1426675642227<span class="tok-o">)</span>, md5: <span class="tok-s2">&quot;b7d51c0c83ef61ccf69f223eded44797&quot;</span>, length: <span class="tok-m">39380552</span> <span class="tok-o">}</span>
<span class="tok-k">done</span>!</code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos observar que tras la inserción, obtenemos un documento que contiente:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>chunkSize</code>: el tamaño de cada trozo</p>
</li>
<li>
<p><code>length</code>: tamaño del fichero</p>
</li>
<li>
<p><code>uploadDate</code>: fecha de creación del fichero en <em>MongoDB</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Si ahora comprobamos los archivos disponibles tendremos:</p>
</div>
<div class="listingblock">
<div class="title">Listando los archivos GridFS mediante <code>mongofiles</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span class="tok-nv">$ </span>mongofiles list
connected to: 127.0.0.1
video.mp4	39380552</code></pre>
</div>
</div>
<div class="paragraph">
<p>Estas operaciones de consulta también la podemos realizar directamente realizando una consulta a la colección <code>fs.files</code> mediante el comando <code>db.fs.files.find()</code> desde <code>mongo</code>:</p>
</div>
<div class="listingblock">
<div class="title">Resultado de la colección <code>fs.files</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">fs</span><span class="tok-p">.</span><span class="tok-nx">files</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">()</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;550957b83f627a4bb7f28bc8&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;filename&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;video.mp4&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;chunkSize&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">261120</span><span class="tok-p">,</span> <span class="tok-s2">&quot;uploadDate&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ISODate</span><span class="tok-p">(</span><span class="tok-s2">&quot;2015-03-18T10:47:22.227Z&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;md5&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;b7d51c0c83ef61ccf69f223eded44797&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;length&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">39380552</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si queremos obtener información sobre los trozos de un archivo (<em>chunks</em>), consultaremos la colección <code>fs.chunks</code> añadiendo un filtro para que no nos muestre la información en binario:</p>
</div>
<div class="listingblock">
<div class="title">Resultado de la colección <code>fs.chunks</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">fs</span><span class="tok-p">.</span><span class="tok-nx">chunks</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({},</span> <span class="tok-p">{</span><span class="tok-s2">&quot;data&quot;</span><span class="tok-o">:</span><span class="tok-mi">0</span><span class="tok-p">})</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;550957b856eb8d804bc96fb8&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;files_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;550957b83f627a4bb7f28bc8&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;n&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">0</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;550957b956eb8d804bc96fb9&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;files_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;550957b83f627a4bb7f28bc8&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;n&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span> <span class="tok-p">}</span>
<span class="tok-p">...</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;550957ba56eb8d804bc9704e&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;files_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;550957b83f627a4bb7f28bc8&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;n&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">150</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Toda interacción con <em>GridFS</em> se debe realizar a través de un <em>driver</em> para evitar incongruencias en los datos.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Otras operaciones que podemos realizar con <code>mongofiles</code> son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>search</code>: busca una cadena en el archivo</p>
</li>
<li>
<p><code>delete</code>: elimina un archivo de <em>GridFS</em></p>
</li>
<li>
<p><code>get</code>: obtiene un archivo</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Todas las opciones de <code>mongofiles</code> se pueden consultar en <a href="http://docs.mongodb.org/manual/reference/program/mongofiles/" class="bare">http://docs.mongodb.org/manual/reference/program/mongofiles/</a></p>
</div>
</div>
<div class="sect3">
<h4 id="__em_gridfs_em_desde_em_java_em">3.3.2. <em>GridFS</em> desde <em>Java</em></h4>
<div class="paragraph">
<p>El driver <em>Java</em> de <em>MongoDB</em> ofrece la clase <code>GridFS</code> para interactuar con los archivos. A partir de dicha clase vamos a poder almacenar archivos en <em>MongoDB</em>.</p>
</div>
<div class="paragraph">
<p>A continuación, se muestra mediante código <em>Java</em> como leer un archivo de vídeo y almacenarlo en la base de datos:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo de inserción en <em>GridFS</em></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">MongoClient</span> <span class="tok-n">cliente</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">MongoClient</span><span class="tok-o">();</span>
<span class="tok-n">DB</span> <span class="tok-n">db</span> <span class="tok-o">=</span> <span class="tok-n">cliente</span><span class="tok-o">.</span><span class="tok-na">getDB</span><span class="tok-o">(</span><span class="tok-s">&quot;expertojava&quot;</span><span class="tok-o">);</span>
<span class="tok-n">FileInputStream</span> <span class="tok-n">inputStream</span> <span class="tok-o">=</span> <span class="tok-kc">null</span><span class="tok-o">;</span>

<span class="tok-n">GridFS</span> <span class="tok-n">videos</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">GridFS</span><span class="tok-o">(</span><span class="tok-n">db</span><span class="tok-o">);</span>

<span class="tok-k">try</span> <span class="tok-o">{</span>
  <span class="tok-n">inputStream</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">FileInputStream</span><span class="tok-o">(</span><span class="tok-s">&quot;video.mp4&quot;</span><span class="tok-o">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">FileNotFoundException</span> <span class="tok-n">e</span><span class="tok-o">)</span> <span class="tok-o">{</span>
  <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;No puedo abrir el fichero&quot;</span><span class="tok-o">);</span>
  <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">exit</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">);</span>
<span class="tok-o">}</span>

<span class="tok-n">GridFSInputFile</span> <span class="tok-n">video</span> <span class="tok-o">=</span> <span class="tok-n">videos</span><span class="tok-o">.</span><span class="tok-na">createFile</span><span class="tok-o">(</span><span class="tok-n">inputStream</span><span class="tok-o">,</span> <span class="tok-s">&quot;video.mp4&quot;</span><span class="tok-o">);</span>      <i class="conum" data-value="2"></i><b>(2)</b>

<span class="tok-c1">// Creamos algunos metadatos para el vídeo</span>
<span class="tok-n">BasicDBObject</span> <span class="tok-n">meta</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;descripcion&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Prevención de riesgos laborales&quot;</span><span class="tok-o">);</span>
<span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-o">&gt;</span> <span class="tok-n">tags</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">ArrayList</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-o">&gt;();</span>
<span class="tok-n">tags</span><span class="tok-o">.</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-s">&quot;Prevención&quot;</span><span class="tok-o">);</span>
<span class="tok-n">tags</span><span class="tok-o">.</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-s">&quot;Ergonomía&quot;</span><span class="tok-o">);</span>
<span class="tok-n">meta</span><span class="tok-o">.</span><span class="tok-na">append</span><span class="tok-o">(</span><span class="tok-s">&quot;tags&quot;</span><span class="tok-o">,</span> <span class="tok-n">tags</span><span class="tok-o">);</span>

<span class="tok-n">video</span><span class="tok-o">.</span><span class="tok-na">setMetaData</span><span class="tok-o">(</span><span class="tok-n">meta</span><span class="tok-o">);</span>  <i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-n">video</span><span class="tok-o">.</span><span class="tok-na">save</span><span class="tok-o">();</span>   <i class="conum" data-value="4"></i><b>(4)</b>

<span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;Object ID: &quot;</span> <span class="tok-o">+</span> <span class="tok-n">video</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-s">&quot;_id&quot;</span><span class="tok-o">));</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Leemos el archivo desde el sistema de archivos</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Creamos un objeto <code>GridFS</code> que referencia al archivo</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Le asociamos al archivo metadatos mediante una lista de cadenas</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Almacena el archivo en la colección</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Al ejecutar este fragmento de código, la colección <code>fs.files</code> contendrá un documento similar al siguiente donde podemos observar que se ha añadido una propiedad ` metadata`:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;553a78edd4c66e72c890472b&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;chunkSize&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">NumberLong</span><span class="tok-p">(</span><span class="tok-mi">261120</span><span class="tok-p">),</span> <span class="tok-s2">&quot;length&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">NumberLong</span><span class="tok-p">(</span><span class="tok-mi">39380552</span><span class="tok-p">),</span> <span class="tok-s2">&quot;md5&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;b7d51c0c83ef61ccf69f223eded44797&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;filename&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;video.mp4&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;contentType&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">null</span><span class="tok-p">,</span> <span class="tok-s2">&quot;uploadDate&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ISODate</span><span class="tok-p">(</span><span class="tok-s2">&quot;2015-04-24T17:10:05.356Z&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;aliases&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">null</span><span class="tok-p">,</span> <span class="tok-s2">&quot;metadata&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;descripcion&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Prevención de riesgos laborales&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;tags&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span> <span class="tok-s2">&quot;Prevención&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;Ergonomía&quot;</span> <span class="tok-p">]</span> <span class="tok-p">}</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si lo que queremos es obtener un archivo que tenemos almacenado en la base de datos para guardarlo en un fichero haríamos:</p>
</div>
<div class="listingblock">
<div class="title">Ejemplo de lectura de <em>GridFS</em></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">MongoClient</span> <span class="tok-n">cliente</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">MongoClient</span><span class="tok-o">();</span>
<span class="tok-n">DB</span> <span class="tok-n">db</span> <span class="tok-o">=</span> <span class="tok-n">cliente</span><span class="tok-o">.</span><span class="tok-na">getDB</span><span class="tok-o">(</span><span class="tok-s">&quot;expertojava&quot;</span><span class="tok-o">);</span>

<span class="tok-n">GridFS</span> <span class="tok-n">videos</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">GridFS</span><span class="tok-o">(</span><span class="tok-n">db</span><span class="tok-o">);</span>

<span class="tok-c1">// Buscamos un fichero</span>
<span class="tok-n">GridFSDBFile</span> <span class="tok-n">gridFile</span> <span class="tok-o">=</span> <span class="tok-n">videos</span><span class="tok-o">.</span><span class="tok-na">findOne</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;filename&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;video.mp4&quot;</span><span class="tok-o">));</span> <i class="conum" data-value="1"></i><b>(1)</b>

<span class="tok-n">FileOutputStream</span> <span class="tok-n">outputStream</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">FileOutputStream</span><span class="tok-o">(</span><span class="tok-s">&quot;video_copia.mp4&quot;</span><span class="tok-o">);</span>
<span class="tok-n">gridFile</span><span class="tok-o">.</span><span class="tok-na">writeTo</span><span class="tok-o">(</span><span class="tok-n">outputStream</span><span class="tok-o">);</span> <i class="conum" data-value="2"></i><b>(2)</b>

<span class="tok-c1">// Buscamos varios ficheros</span>
<span class="tok-n">List</span> <span class="tok-o">&lt;</span><span class="tok-n">GridFSDBFile</span><span class="tok-o">&gt;</span> <span class="tok-n">ficheros</span> <span class="tok-o">=</span> <span class="tok-n">videos</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;descripción&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;Prueba&quot;</span><span class="tok-o">));</span> <i class="conum" data-value="3"></i><b>(3)</b>

<span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">GridFSDBFile</span> <span class="tok-nl">fichero:</span> <span class="tok-n">ficheros</span><span class="tok-o">)</span> <span class="tok-o">{</span>
  <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">fichero</span><span class="tok-o">.</span><span class="tok-na">getFilename</span><span class="tok-o">());</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Buscamos en <em>GridFS</em> un archivo por su nombre el cual se almacena en un objeto <code>GridFSDBFile</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Escribimos el contenido del <code>gridFile</code> en un nuevo archivo</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Al obtener varios elementos, el resultado de la búsqueda se almacena en <code>List&lt;GridFSDBFile&gt;</code></td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_casos_de_uso">3.3.3. Casos de uso</h4>
<div class="paragraph">
<p>El motivo principal de usar <em>GridFS</em> se debe a superar la restricción de los 16MB de los documentos BSON.</p>
</div>
<div class="paragraph">
<p>Además, hay casos donde es preferible almacenar los archivos de vídeo y audio en una base de datos en vez de en el sistema de archivos, ya sea para almacenar metadatos de los archivos, acceder a ellos desde aplicaciones ajenos al sistemas de archivos o replicar el contenido para ofrecer una alta disponibilidad.</p>
</div>
<div class="paragraph">
<p>Otro caso importante es cuando tenemos contenido generado  por el usuario como grandes informes o datos estáticos que no suelen cambiar y que cuestan mucho de generar. En vez de generarlos con cada petición, se pueden ejecutar una vez y almacenarlos como un documento. Cuando se detecta un cambio en el contenido estático, se vuelve a generar el informe en la próxima petición de los datos.</p>
</div>
<div class="paragraph">
<p>Si el sistema de archivos no siempre está disponible, también podemos evaluar <em>GridFS</em> como una alternativa viable. También podemos aprovechar que los fichero se almacenan en trozos y usar estos trozos para almacenar parte del archivo que interesa, como puede ser el contenido MD5 de los datos.</p>
</div>
<div class="paragraph">
<p>Si nos centramos en sus inconvenientes, tenemos que tener claro que hay pérdida de rendimiento respecto a acceder al sistema de archivos. Por ello, se recomienda crear una prueba de concepto en el sistema a desarrollar antes de implementar la solución.</p>
</div>
<div class="paragraph">
<p>Hay que tener en cuenta que <em>GridFS</em> almacena los datos en múltiples documentos, con lo que una actualización atómica no es posible. Si tenemos claro que el contenido es inferior a 16 MB, que es el caso de la mayoría de contenido generado por el usuario, podemos dejar de lado <em>GridFS</em>, y usar directamente documentos BSON los cuales aceptan datos binarios.</p>
</div>
<div class="listingblock">
<div class="title">Guardado datos binarios en un documento BSON - DatosBinario.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">String</span> <span class="tok-n">recurso</span> <span class="tok-o">=</span> <span class="tok-s">&quot;cartel300.png&quot;</span><span class="tok-o">;</span>
<span class="tok-kt">byte</span><span class="tok-o">[]</span> <span class="tok-n">imagenBytes</span> <span class="tok-o">=</span> <span class="tok-n">leerDatosBinarios</span><span class="tok-o">(</span><span class="tok-n">recurso</span><span class="tok-o">);</span>

<span class="tok-n">DBObject</span> <span class="tok-n">doc</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">BasicDBObject</span><span class="tok-o">(</span><span class="tok-s">&quot;_id&quot;</span><span class="tok-o">,</span> <span class="tok-mi">1</span><span class="tok-o">);</span>
<span class="tok-n">doc</span><span class="tok-o">.</span><span class="tok-na">put</span><span class="tok-o">(</span><span class="tok-s">&quot;nombreFichero&quot;</span><span class="tok-o">,</span> <span class="tok-n">recurso</span><span class="tok-o">);</span>
<span class="tok-n">doc</span><span class="tok-o">.</span><span class="tok-na">put</span><span class="tok-o">(</span><span class="tok-s">&quot;tamanyo&quot;</span><span class="tok-o">,</span> <span class="tok-n">imagenBytes</span><span class="tok-o">.</span><span class="tok-na">length</span><span class="tok-o">);</span>
<span class="tok-n">doc</span><span class="tok-o">.</span><span class="tok-na">put</span><span class="tok-o">(</span><span class="tok-s">&quot;datos&quot;</span><span class="tok-o">,</span> <span class="tok-n">imagenBytes</span><span class="tok-o">);</span>
<span class="tok-n">coleccion</span><span class="tok-o">.</span><span class="tok-na">insert</span><span class="tok-o">(</span><span class="tok-n">doc</span><span class="tok-o">);</span>

<span class="tok-kt">byte</span><span class="tok-o">[]</span> <span class="tok-nf">leerDatosBinarios</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">recurso</span><span class="tok-o">)</span> <span class="tok-kd">throws</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
  <span class="tok-n">InputStream</span> <span class="tok-n">in</span> <span class="tok-o">=</span> <span class="tok-n">Thread</span><span class="tok-o">.</span><span class="tok-na">currentThread</span><span class="tok-o">().</span><span class="tok-na">getContextClassLoader</span><span class="tok-o">().</span><span class="tok-na">getResourceAsStream</span><span class="tok-o">(</span><span class="tok-n">recurso</span><span class="tok-o">);</span>
  <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">in</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-kt">int</span> <span class="tok-n">available</span> <span class="tok-o">=</span> <span class="tok-n">in</span><span class="tok-o">.</span><span class="tok-na">available</span><span class="tok-o">();</span>
    <span class="tok-kt">byte</span><span class="tok-o">[]</span> <span class="tok-n">bytes</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-kt">byte</span><span class="tok-o">[</span><span class="tok-n">available</span><span class="tok-o">];</span>
    <span class="tok-n">in</span><span class="tok-o">.</span><span class="tok-na">read</span><span class="tok-o">(</span><span class="tok-n">bytes</span><span class="tok-o">);</span>
    <span class="tok-k">return</span> <span class="tok-n">bytes</span><span class="tok-o">;</span>
  <span class="tok-o">}</span> <span class="tok-k">else</span> <span class="tok-o">{</span>
    <span class="tok-k">throw</span> <span class="tok-k">new</span> <span class="tok-nf">IllegalArgumentException</span><span class="tok-o">(</span><span class="tok-s">&quot;Recurso &quot;</span> <span class="tok-o">+</span> <span class="tok-n">recurso</span> <span class="tok-o">+</span> <span class="tok-s">&quot; no encontrado&quot;</span><span class="tok-o">);</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_Índices">3.4. Índices</h3>
<div class="paragraph">
<p>Los índices son una parte importante de la gestión de bases de datos. Un índice en una base de datos es similar a un índice de un libro; permite saltar directamente a la parte del libro en vez de tener que pasar las páginas buscando el tema o la palabra que nos interesa.</p>
</div>
<div class="paragraph">
<p>En el caso de <em>MongoDB</em>, un índice es una estructura de datos que almacena información sobre los valor de determinados campos de los documentos de una colección. Esta estructura permite recorrer los datos y ordenarlos de manera muy rápida. Así pues, los índices se utilizan tanto al buscar un documento como al ordenar los datos de una consulta.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Preparando los ejemplos</div>
<div class="paragraph">
<p>Para los siguientes ejemplos, vamos a utilizar una colección de 200 estudiantes con las calificaciones que han obtenido en diferentes trabajos, exámenes o cuestionarios.</p>
</div>
<div class="paragraph">
<p>Para ello, importaremos la colección <a href="resources/nosql/students.json.txt">students.json</a> mediante:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">mongoimport -d expertojava -c students --file students.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>Un ejemplo de una estudiante sería:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">findOne</span><span class="tok-p">()</span>
<span class="tok-p">{</span>
  <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">0</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;name&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;aimee Zank&quot;</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;scores&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span>
    <span class="tok-p">{</span>
      <span class="tok-s2">&quot;type&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;exam&quot;</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;score&quot;</span> <span class="tok-o">:</span> <span class="tok-mf">1.463179736705023</span>
    <span class="tok-p">},</span> <span class="tok-p">{</span>
      <span class="tok-s2">&quot;type&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;quiz&quot;</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;score&quot;</span> <span class="tok-o">:</span> <span class="tok-mf">11.78273309957772</span>
    <span class="tok-p">},</span> <span class="tok-p">{</span>
      <span class="tok-s2">&quot;type&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;homework&quot;</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;score&quot;</span> <span class="tok-o">:</span> <span class="tok-mf">6.676176060654615</span>
    <span class="tok-p">},</span> <span class="tok-p">{</span>
      <span class="tok-s2">&quot;type&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;homework&quot;</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;score&quot;</span> <span class="tok-o">:</span> <span class="tok-mf">35.8740349954354</span>
    <span class="tok-p">}</span>
  <span class="tok-p">]</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Para comprobar el impacto del uso de índices, vamos a empezar con un ejemplo para ver cómo de rápido puede hacerse una consulta que tiene un índice respecto a uno que no lo tiene.</p>
</div>
<div class="paragraph">
<p>Para analizar el plan de ejecución de una consulta, podemos emplear el método <code>explain()</code> (<a href="https://docs.mongodb.org/manual/reference/method/cursor.explain/" class="bare">https://docs.mongodb.org/manual/reference/method/cursor.explain/</a>) sobre un cursor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-s2">&quot;name&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Kaila Deibler&quot;</span><span class="tok-p">}).</span><span class="tok-nx">explain</span><span class="tok-p">(</span><span class="tok-s2">&quot;executionStats&quot;</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-s2">&quot;queryPlanner&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-s2">&quot;plannerVersion&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;namespace&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;expertojava.students&quot;</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;indexFilterSet&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">false</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;parsedQuery&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
      <span class="tok-s2">&quot;name&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;$eq&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Kaila Deibler&quot;</span> <span class="tok-p">}</span>
    <span class="tok-p">},</span>
    <span class="tok-s2">&quot;winningPlan&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
      <span class="tok-s2">&quot;stage&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;COLLSCAN&quot;</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;filter&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
        <span class="tok-s2">&quot;name&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;$eq&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Kaila Deibler&quot;</span> <span class="tok-p">}</span>
      <span class="tok-p">},</span>
      <span class="tok-s2">&quot;direction&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;forward&quot;</span>
    <span class="tok-p">},</span>
    <span class="tok-s2">&quot;rejectedPlans&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span> <span class="tok-p">]</span>
  <span class="tok-p">},</span>
  <span class="tok-s2">&quot;executionStats&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-s2">&quot;executionSuccess&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">true</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;nReturned&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;executionTimeMillis&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;totalKeysExamined&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">0</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;totalDocsExamined&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">200</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;executionStages&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
      <span class="tok-s2">&quot;stage&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;COLLSCAN&quot;</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;filter&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
        <span class="tok-s2">&quot;name&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;$eq&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Kaila Deibler&quot;</span> <span class="tok-p">}</span>
      <span class="tok-p">},</span>
      <span class="tok-s2">&quot;nReturned&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;executionTimeMillisEstimate&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">0</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;works&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">204</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;advanced&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;needTime&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">199</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;needYield&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;saveState&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;restoreState&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;isEOF&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;invalidates&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">0</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;direction&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;forward&quot;</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;docsExamined&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">200</span>
    <span class="tok-p">}</span>
  <span class="tok-p">},</span>
  <span class="tok-s2">&quot;serverInfo&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-s2">&quot;host&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;MacBook-Air-de-Aitor.local&quot;</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;port&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">27017</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;version&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;3.2.1&quot;</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;gitVersion&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;a14d55980c2cdc565d4704a7e3ad37e4e535c1b2&quot;</span>
  <span class="tok-p">},</span>
  <span class="tok-s2">&quot;ok&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El plan de ejecución devuelve mucha información (<a href="https://docs.mongodb.org/manual/reference/explain-results/" class="bare">https://docs.mongodb.org/manual/reference/explain-results/</a>), pero nos vamos a centrar en unos pocos atributos para analizar el resultado.</p>
</div>
<div class="paragraph">
<p>A grosso modo, podemos observar como el resultado se divide en dos partes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>queryPlanner</code>: muestra información sobre la consulta, indicando el plan ganador en <code>winningPlan</code></p>
<div class="ulist">
<ul>
<li>
<p><code>winningPlan.stage</code>: muestra información de la acción realizada. Puede tomar los valores:</p>
<div class="ulist">
<ul>
<li>
<p><code>COLLSCAN</code>: escaneo completo de una colección</p>
</li>
<li>
<p><code>IXSCAN</code>: escaneo a partir de un índice</p>
</li>
<li>
<p><code>FETCH</code>: al recuperar documentos</p>
</li>
<li>
<p><code>SHARD_MERGE</code>: al fusionar resultados de las particiones</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><code>executionStats</code>: muestra estadísticas de ejecución</p>
<div class="ulist">
<ul>
<li>
<p><code>executionTimeMillis</code>: tiempo empleado</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Del resultado obtenido, se puede observar mediante la propiedad <code>queryPlanner.winningPlan.stage</code> que ha utilizado un <code>COLLSCAN</code>, lo que significa que se ha realizado un escaneo completo de toda la colección para encontrar los datos, lo que significa que no se ha usado ningún índice en la consulta. Esta consulta sólo devuelve un par de documentos (<code>executionStats.nReturned</code>) pero ha tenido que escanear los 200 existentes (<code>executionStats.totalDocsExamined</code>).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Cuando vamos a buscar un elemento, es mucho mas rápido hacer un <code>findOne</code> que <code>find</code>, porque mientras <code>find</code> recorre toda la colección, con <code>findOne</code> en cuanto encuentre un documento, el cursor se detendrá.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Por defecto, el campo <code>_id</code> esta indexado. Así pues, vamos a buscar el mismo documento de antes, pero ahora mediante el campo indexado:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-nx">_id</span><span class="tok-o">:</span><span class="tok-mi">30</span><span class="tok-p">}).</span><span class="tok-nx">explain</span><span class="tok-p">(</span><span class="tok-s2">&quot;executionStats&quot;</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-s2">&quot;queryPlanner&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-s2">&quot;plannerVersion&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
    <span class="tok-p">...</span>
    <span class="tok-s2">&quot;winningPlan&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
      <span class="tok-s2">&quot;stage&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;IDHACK&quot;</span>
    <span class="tok-p">},</span>
    <span class="tok-s2">&quot;rejectedPlans&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span> <span class="tok-p">]</span>
  <span class="tok-p">},</span>
  <span class="tok-s2">&quot;executionStats&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-s2">&quot;executionSuccess&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">true</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;nReturned&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;executionTimeMillis&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">0</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;totalKeysExamined&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;totalDocsExamined&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;executionStages&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
      <span class="tok-p">...</span>
    <span class="tok-p">}</span>
  <span class="tok-p">},</span>
  <span class="tok-s2">&quot;serverInfo&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-p">...</span>
  <span class="tok-p">},</span>
  <span class="tok-s2">&quot;ok&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora <em>MongoDB</em> sólo ha escaneado el documento que ha devuelto ( <code>executionStats.totalKeysExamined</code>), y ha utilizado un índice para acceder al campo <code>_id</code> (valor <code>IDHACK</code> en <code>winningPlan.stage</code>). Al haber utilizado un índice, hemos evitado tener que mirar en más documentos. Esta consulta se ha realizado más rápidamente (y a mayor número de documentos más se nota la diferencia). Por supuesto, no siempre vamos a buscar por su <code>_id</code>, así que vamos a ver como crear nuevos índices.</p>
</div>
<div class="paragraph">
<p>Toda la información sobre el uso de índices con <em>MongoDB</em> se encuentra en <a href="http://docs.mongodb.org/manual/core/indexes/" class="bare">http://docs.mongodb.org/manual/core/indexes/</a></p>
</div>
<div class="sect3">
<h4 id="_simples">3.4.1. Simples</h4>
<div class="paragraph">
<p>Para crear un índice hemos de utilizar el método <code>createIndex({atributo:orden})</code></p>
</div>
<div class="paragraph">
<p>Si queremos crear un índice sobre la propiedad <code>name</code> en orden ascendente haríamos lo siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">createIndex</span><span class="tok-p">(</span> <span class="tok-p">{</span><span class="tok-nx">name</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">}</span> <span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-s2">&quot;createdCollectionAutomatically&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">false</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;numIndexesBefore&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;numIndexesAfter&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;ok&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si ahora volvemos a ejecutar la consulta por nombre, comprobaremos como ahora ya realiza una búsqueda directa (valor <code>FETCH</code> en <code>winningPlan.stage</code>) y que no ha tenido que recorrer todos los documentos.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-s2">&quot;name&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Kaila Deibler&quot;</span><span class="tok-p">}).</span><span class="tok-nx">explain</span><span class="tok-p">(</span><span class="tok-s2">&quot;executionStats&quot;</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-s2">&quot;queryPlanner&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-s2">&quot;plannerVersion&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
    <span class="tok-p">...</span>
    <span class="tok-s2">&quot;winningPlan&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
      <span class="tok-s2">&quot;stage&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;FETCH&quot;</span><span class="tok-p">,</span>
      <span class="tok-s2">&quot;inputStage&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
        <span class="tok-s2">&quot;stage&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;IXSCAN&quot;</span><span class="tok-p">,</span>
        <span class="tok-s2">&quot;keyPattern&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;name&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span> <span class="tok-p">},</span>
        <span class="tok-s2">&quot;indexName&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;name_1&quot;</span><span class="tok-p">,</span>
        <span class="tok-s2">&quot;isMultiKey&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">false</span><span class="tok-p">,</span>
        <span class="tok-s2">&quot;isUnique&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">false</span><span class="tok-p">,</span>
        <span class="tok-s2">&quot;isSparse&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">false</span><span class="tok-p">,</span>
        <span class="tok-s2">&quot;isPartial&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">false</span><span class="tok-p">,</span>
        <span class="tok-s2">&quot;indexVersion&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
        <span class="tok-s2">&quot;direction&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;forward&quot;</span><span class="tok-p">,</span>
        <span class="tok-s2">&quot;indexBounds&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
          <span class="tok-s2">&quot;name&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span>
            <span class="tok-s2">&quot;[\&quot;Kaila Deibler\&quot;, \&quot;Kaila Deibler\&quot;]&quot;</span>
          <span class="tok-p">]</span>
        <span class="tok-p">}</span>
      <span class="tok-p">}</span>
    <span class="tok-p">},</span>
    <span class="tok-s2">&quot;rejectedPlans&quot;</span> <span class="tok-o">:</span> <span class="tok-p">[</span> <span class="tok-p">]</span>
  <span class="tok-p">},</span>
  <span class="tok-s2">&quot;executionStats&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
    <span class="tok-s2">&quot;executionSuccess&quot;</span> <span class="tok-o">:</span> <span class="tok-kc">true</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;nReturned&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;executionTimeMillis&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;totalKeysExamined&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;totalDocsExamined&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
    <span class="tok-s2">&quot;executionStages&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
      <span class="tok-p">...</span>
    <span class="tok-p">}</span>
  <span class="tok-p">},</span>
  <span class="tok-s2">&quot;serverInfo&quot;</span> <span class="tok-o">:</span> <span class="tok-p">{</span>
  	<span class="tok-p">...</span>
  <span class="tok-p">},</span>
  <span class="tok-s2">&quot;ok&quot;</span> <span class="tok-o">:</span> <span class="tok-mi">1</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Un aspecto a considerar de los índices es que aceleran mucho las búsquedas, pero ralentizan las inserciones/modificaciones y hace que la información ocupe más espacio en disco. Por ello, deberemos considerar añadir índices a las colecciones donde el número de lecturas sea mayor que el de escrituras. Si sucede al revés, el uso de índices puede provocar un deterioro en el rendimiento.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El orden de los índices (<code>1</code> para ascendente, <code>-1</code> para descendente) no importa para un índice sencillo, pero si que tendrá un impacto en los índices compuestos cuando se utilizan para ordenar o con una condición de rango.</p>
</div>
<div class="paragraph">
<p>Por supuesto, podemos crear índices sobre propiedades que forman parte de un array. Así pues, podemos crear un índice sobre el tipo de calificación que tiene un estudiante mediante:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">createIndex</span><span class="tok-p">(</span> <span class="tok-p">{</span><span class="tok-nx">scores</span><span class="tok-p">.</span><span class="tok-nx">type</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">}</span> <span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pero además también podemos crear un índice sobre todas las calificaciones, lo cual indexa cada elemento del array, con lo que podemos buscar por cualquier objeto del array. Este tipo de índices se conocen como <strong>multiclave</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">createIndex</span><span class="tok-p">(</span> <span class="tok-p">{</span><span class="tok-nx">scores</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">}</span> <span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Toda la información relativa a los índices creados se almacenan en la colección <code>system.indexes</code>, la cual podremos consultar.</p>
</div>
<div class="paragraph">
<p>Además, también podemos obtener los índices de una determinada colección mediante el método <code>getIndexes()</code>.</p>
</div>
<div class="paragraph">
<p>Finalmente, para borrar un índice emplearemos el método <code>dropIndex(<em>atributo</em>)</code>.</p>
</div>
<div class="paragraph">
<p>Así pues, tenemos que algunas de las operaciones relacionadas con los índices más importantes son:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">system</span><span class="tok-p">.</span><span class="tok-nx">indexes</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">()</span> <span class="tok-c1">// muestra los índices existentes</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">getIndexes</span><span class="tok-p">()</span> <span class="tok-c1">// muestra los índices de la colección students</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">dropIndex</span><span class="tok-p">(</span> <span class="tok-p">{</span><span class="tok-s2">&quot;name&quot;</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">}</span> <span class="tok-p">)</span> <span class="tok-c1">// borra el índice que existe sobre la propiedad name</span></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_propiedades">Propiedades</h5>
<div class="paragraph">
<p>Al crear un índice podemos pasarle algunas opciones como segundo parámetro, como puede ser:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>unique:true</code>: Permite crear índices que sólo permiten valores únicos en una propiedad. No puede haber valores repetidos y una vez creado no permitirá insertar valores duplicados.</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">createIndex</span><span class="tok-p">(</span> <span class="tok-p">{</span><span class="tok-nx">students_id</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">unique</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">}</span> <span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El índice sobre <code>_id</code> es único aunque al visualizarlo no nos diga que lo sea, ya que no permite que se inserten dos <code>_id</code> iguales.</p>
</div>
</li>
<li>
<p>Si queremos añadir un índice sobre una propiedad que no aparece en todos los documentos, necesitamos crear un <em>Sparse Index</em> mediante <code>sparse:true</code>, el cual se crea para el conjunto de claves que tienen valores.</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">createIndex</span><span class="tok-p">(</span> <span class="tok-p">{</span><span class="tok-nx">size</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">sparse</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">}</span> <span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si hacemos una consulta sobre una propiedad que tiene asociado un <em>Sparse Index</em>, nos van a aparecer menos resultados, ya que sólo mostrará aquellos que tengan valores, y no tendrá en cuenta los documentos que tengan dicho campo sin crear.</p>
</div>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Autoevaluación</div>
<div class="paragraph">
<p>Suponemos que tenemos los siguientes documentos en una colección llamada 'people' con los siguientes documentos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">()</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;50a464fb0a9dfcc4f19d6271&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;nombre&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Juan&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;cargo&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Técnico&quot;</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;50a4650c0a9dfcc4f19d6272&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;nombre&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Pedro&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;cargo&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;CEO&quot;</span> <span class="tok-p">}</span>
<span class="tok-p">{</span> <span class="tok-s2">&quot;_id&quot;</span> <span class="tok-o">:</span> <span class="tok-nx">ObjectId</span><span class="tok-p">(</span><span class="tok-s2">&quot;50a465280a9dfcc4f19d6273&quot;</span><span class="tok-p">),</span> <span class="tok-s2">&quot;nombre&quot;</span> <span class="tok-o">:</span> <span class="tok-s2">&quot;Sandra&quot;</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y hay un índice definido del siguiente modo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">createIndex</span><span class="tok-p">({</span><span class="tok-nx">cargo</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">sparse</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si realizamos la siguiente consulta, ¿Qué documentos aparecerán y por qué? <span class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnote_1" title="View footnote.">1</a>]</span></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-nx">cargo</span><span class="tok-o">:</span><span class="tok-kc">null</span><span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Ningún documento, ya que la consulta utiliza el índice y no puede haber documentos que no contengan el campo <code>cargo</code></p>
</li>
<li>
<p>Ningún documento, ya que la consulta de <code>cargo:null</code> sólo encuentra documentos que de manera explícita tienen el <em>cargo</em> a nulo, independientemente del índice.</p>
</li>
<li>
<p>El documento de <em>Sandra</em>, ya que la consulta no utilizará el índice</p>
</li>
<li>
<p>Todos los documentos de la colección, ya que todos los documentos cumplen <code>cargo:null</code></p>
</li>
<li>
<p>El documento de <em>Sandra</em>, ya que el comando <code>createIndex</code> no se ejecutará sobre este documento.</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Finalmente, desde la versión 3.2, podemos emplear índices <strong>parciales</strong>, para indexar aquellos documentos que cumplen un criterio específico. Al indexar un subconjunto de los documentos de una colección, estos índices ocupan menos, y reducen el coste de almacenamiento y rendimiento a la hora de crearlo. Para ello, le pasaremos a la propiedad <code>partialFilterExpression</code> el criterio que debe cumplir el índice parcial.</p>
<div class="paragraph">
<p>Por ejemplo, para indexar por tipo de calificación a aquellos estudiantes con una calificación superior a 95 haríamos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">createIndex</span><span class="tok-p">({</span><span class="tok-s2">&quot;scores.type&quot;</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">partialFilterExpression</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-s2">&quot;scores.score&quot;</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$gt</span><span class="tok-o">:</span><span class="tok-mi">95</span><span class="tok-p">}}}</span> <span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para utilizar este índice, la consulta debe realizarse por el campo del mismo, y cumplir con un subconjunto de la expresión de filtrado. Por ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-s2">&quot;scores.type&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;exam&quot;</span><span class="tok-p">})</span> <span class="tok-c1">// No emplea el índice, no utiliza el filtro</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-s2">&quot;scores.type&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;exam&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;scores.score&quot;</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$gt</span><span class="tok-o">:</span><span class="tok-mi">90</span><span class="tok-p">}}</span> <span class="tok-p">)</span> <span class="tok-c1">// No emplea el índice, ya que no cumple el filtr</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-s2">&quot;scores.type&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;exam&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;scores.score&quot;</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$gt</span><span class="tok-o">:</span><span class="tok-mi">96</span><span class="tok-p">}}</span> <span class="tok-p">)</span> <span class="tok-c1">// Si emplea el filtro</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Más información sobre los índices parciales en <a href="https://docs.mongodb.org/manual/core/index-partial/" class="bare">https://docs.mongodb.org/manual/core/index-partial/</a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compuestos">3.4.2. Compuestos</h4>
<div class="paragraph">
<p>Si queremos aplicar un índice sobre más de una propiedad, podemos crear índices compuestos, indicando las propiedades separadas por coma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">createIndex</span><span class="tok-p">({</span><span class="tok-s2">&quot;name&quot;</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-s2">&quot;scores.type&quot;</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Es importante destacar que el orden de los índices importa, y mucho. Si hacemos una consulta que sólo utilice el atributo <code>scores.type</code>, este índice no se va a utilizar.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
No confundir los índices compuestos con hacer 2 o más índices sobre diferentes propiedades.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si creamos un índice sobre los campos (<code>A</code>,<code>B</code>,<code>C</code>), el índice se va a utilizar para las búsquedas sobre <code>A</code>, sobre la dupla (<code>A</code>,<code>B</code>) y sobre el trio (<code>A</code>,<code>B</code>,<code>C</code>). Es decir, los índices se usan con los subconjuntos por la izquierda (prefijos) de los índices compuestos.</p>
</div>
<div class="paragraph">
<p>Si tenemos varios índices candidatos a la hora de ejecutar, el optimizador de consultas de <em>MongoDB</em> los usará en paralelo y se quedará con el resultado del primero que termine. Más información en <a href="http://docs.mongodb.org/manual/core/query-plans/" class="bare">http://docs.mongodb.org/manual/core/query-plans/</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_multiclave">3.4.3. Multiclave</h4>
<div class="paragraph">
<p>Cuando se indexa una propiedad que es un array se crea un índice multiclave para todos los valores del array de todos los documentos. El uso de estos índices son lo que hacen que las consultas sobre documentos embebidos funcionen tan rápido.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">createIndex</span><span class="tok-p">({</span><span class="tok-s2">&quot;teachers&quot;</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">})</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-s2">&quot;teachers&quot;</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-s2">&quot;$all&quot;</span><span class="tok-o">:</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">,</span><span class="tok-mi">3</span><span class="tok-p">]}})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Se pueden crear índices tanto en propiedades básicas, como en propiedades internas de un array, mediante la notación de <code>.</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">createIndex</span><span class="tok-p">({</span><span class="tok-s2">&quot;addresses.phones&quot;</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Sólo se pueden crear índices compuestos multiclave cuando sólo una de las propiedades del índice compuesto es un array; es decir, no puede haber dos propiedades array en un índice compuesto.
Hay que tener cuidado ya que no se va a quejar al crearlo, solo al insertar, porque no va a poder indexar arrays paralelos.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_rendimiento_2">3.4.4. Rendimiento</h4>
<div class="paragraph">
<p>Por defecto, los índices se crean en <em>foreground</em>, de modo que al crear un índice se van a bloquear a todos los <em>writers</em>. Si queremos crearlos en <em>background</em> para no penalizar las escrituras (es más lento, de 2 a 5 veces) lo indicaremos con un segundo parámetro:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">createIndex</span><span class="tok-p">({</span><span class="tok-s2">&quot;twitter&quot;</span><span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">},</span> <span class="tok-p">{</span><span class="tok-nx">background</span><span class="tok-o">:</span><span class="tok-kc">true</span><span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Más información sobre la creación en <em>background</em> en <a href="https://docs.mongodb.org/manual/core/index-creation/" class="bare">https://docs.mongodb.org/manual/core/index-creation/</a></p>
</div>
<div class="paragraph">
<p>Algunos de los operadores que no utilizan los índices eficientemente son los operadores <code>$where</code>, <code>$nin</code> y <code>$exists</code>. Cuando estos operadores se emplean en una consultar hay que tener en mente un posible cuelo de botella cuando el tamaño de los datos incremente.</p>
</div>
<div class="sect4">
<h5 id="_plan_de_ejecución">Plan de ejecución</h5>
<div class="paragraph">
<p>Al explicar los índices ya hemos visto que podemos obtener información sobre la operación realizada mediante el método <code>.explain()</code>.</p>
</div>
<div class="paragraph">
<p>El atributo <code>indexOnly</code> me dice si toda la información que quiero recuperar se encuentra en el índice. Este atributo va a depender de los campos que quiera que me devuelva la consulta, si son un subconjunto del índice utilizado.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Más información en <a href="http://docs.mongodb.org/manual/reference/method/cursor.explain/" class="bare">http://docs.mongodb.org/manual/reference/method/cursor.explain/</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Los índices tienen que caber en memoria. Si están en disco, pese a ser algorítmicamente mejores que no tener, al ser más grandes que la RAM disponible, no se obtienen beneficios por la penalización de la paginación.</p>
</div>
<div class="paragraph">
<p>Para averiguar el tamaño de los índices (en bytes):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">stats</span><span class="tok-p">()</span>  <span class="tok-c1">// obtiene estadísticas de la colección</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">totalIndexSize</span><span class="tok-p">()</span>  <span class="tok-c1">// obtiene el tamaño del índice</span></code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Mucho cuidado con los índices <em>multikeys</em> porque crecen mucho y si el documento tiene que moverse en disco, el cambio supone tener que cambiar todos los puntos de índice del array.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Aunque sea más responsabilidad de un DBA, los desarrolladores debemos saber si el índice va a caber en memoria. Si no van a caber es mejor no usarlos.</p>
</div>
<div class="paragraph">
<p>Si vemos que no usamos un índice o que su rendimiento es peor, podemos borrarlos con <code>dropIndex</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">students</span><span class="tok-p">.</span><span class="tok-nx">dropIndex</span><span class="tok-p">(</span><span class="tok-s1">&#39;nombreDeíndice&#39;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos obtener más información sobre el rendimiento de las consultas mediante su plan de ejecución en <a href="https://docs.mongodb.org/manual/tutorial/analyze-query-plan/" class="bare">https://docs.mongodb.org/manual/tutorial/analyze-query-plan/</a></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Autoevaluación</div>
<div class="paragraph">
<p>Hemos actualizado un documento con una clave llamada <em>etiquetas</em> que provoca que el documento tenga que moverse a disco.
Supongamos que el documento contiene 100 etiquetas en él y que el array de etiquetas está indexada con un índice multiclave.</p>
</div>
<div class="paragraph">
<p>¿Cuantos puntos de índice tienen que actualizarse en el índice para acodomar el movimiento? <span class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnote_2" title="View footnote.">2</a>]</span></p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_hints">Hints</h5>
<div class="paragraph">
<p>Si en algún momento queremos forzar el uso de un determinado índice al realizar una consulta, necesitaremos usar el método <code>.hint({campo:1})</code></p>
</div>
<div class="paragraph">
<p>Si queremos que se utilice el índice asociado a la propiedad <code>twitter</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s2">&quot;Aitor Medrano&quot;</span><span class="tok-p">,</span><span class="tok-nx">twitter</span><span class="tok-o">:</span><span class="tok-s2">&quot;aitormedrano&quot;</span><span class="tok-p">}).</span><span class="tok-nx">hint</span><span class="tok-p">({</span><span class="tok-nx">twitter</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">}})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si por algún motivo no queremos usar índices, le pasaremos el operador <code>$natural</code> al método <code>hint()</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">people</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span><span class="tok-nx">nombre</span><span class="tok-o">:</span><span class="tok-s2">&quot;Aitor Medrano&quot;</span><span class="tok-p">,</span><span class="tok-nx">twitter</span><span class="tok-o">:</span><span class="tok-s2">&quot;aitormedrano&quot;</span><span class="tok-p">}).</span><span class="tok-nx">hint</span><span class="tok-p">({</span><span class="tok-nx">$natural</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">}})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si usamos un <em>hint</em> sobre un índice <em>sparse</em> y no hay documentos a devolver con dicho índice porque todos sus campos son nulos, la consulta no devolverá nada, aunque haya documentos que sin dicho índice si cumplen los criterios.</p>
</div>
<div class="paragraph">
<p>Hay que destacar que los operadores <code>$gt</code>, <code>$lt</code>, <code>$ne</code> … provocan un uso ineficiente de los índices, ya que la consulta tiene que recorrer toda la colección de índices.
Si hacemos una consulta sobre varios atributos y en uno de ellos usamos <code>$gt</code>, <code>$lt</code> o similar, es mejor hacer un <em>hint</em> sobre el resto de atributos que sí tienen una selección directa.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, supongamos que en la coleccion de calificaciones quieseramos obtener los exámenes con un calificación comprendida entre 95 y 98.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span> <span class="tok-nx">score</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$gt</span><span class="tok-o">:</span><span class="tok-mi">95</span><span class="tok-p">,</span> <span class="tok-nx">$lte</span><span class="tok-o">:</span><span class="tok-mi">98</span><span class="tok-p">},</span> <span class="tok-nx">type</span><span class="tok-o">:</span><span class="tok-s2">&quot;exam&quot;</span> <span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para esta consulta, suponiendo que tenemos un índice tanto en <code>score</code> como en <code>type</code>, sería conveniente hacer el <em>hint</em> sobre el <code>type</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">grades</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span> <span class="tok-nx">score</span><span class="tok-o">:</span><span class="tok-p">{</span><span class="tok-nx">$gt</span><span class="tok-o">:</span><span class="tok-mi">95</span><span class="tok-p">,</span> <span class="tok-nx">$lte</span><span class="tok-o">:</span><span class="tok-mi">98</span><span class="tok-p">},</span> <span class="tok-nx">type</span><span class="tok-o">:</span><span class="tok-s2">&quot;exam&quot;</span> <span class="tok-p">}).</span><span class="tok-nx">hint</span><span class="tok-p">(</span><span class="tok-s1">&#39;type&#39;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Otros tipos de índices</div>
<div class="ulist">
<ul>
<li>
<p><strong>Geoespaciales</strong>, para trabajar con coordenadas &#8594; <a href="http://docs.mongodb.org/manual/applications/geospatial-indexes/" class="bare">http://docs.mongodb.org/manual/applications/geospatial-indexes/</a></p>
</li>
<li>
<p><strong>De texto</strong>, para realizar búsquedas dentro de un campo &#8594; <a href="http://docs.mongodb.org/manual/core/index-text/" class="bare">http://docs.mongodb.org/manual/core/index-text/</a></p>
</li>
<li>
<p><strong>Hash</strong>, centrado en el uso de <em>sharding</em> &#8594; <a href="http://docs.mongodb.org/manual/core/index-hashed/" class="bare">http://docs.mongodb.org/manual/core/index-hashed/</a></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_colecciones_limitadas">3.5. Colecciones limitadas</h3>
<div class="paragraph">
<p>Una colección limitada (<em>capped collection</em>) es una colección de tamaño fijo, donde se garantiza el orden natural de los datos, es decir, el orden en que se insertaron.</p>
</div>
<div class="paragraph">
<p>Una vez se llena la colección, se eliminan los datos más antiguos, y los datos más nuevos se añaden al final, de manera similar a un <em>buffer</em> circular, asegurando que el orden natural de la colección sigue el orden en el que se insertaron los registros.</p>
</div>
<div class="paragraph">
<p>Este tipo de colecciones se utilizan para logs y auto-guardado de información, ya que su rendimiento es muy alto para inserciones.</p>
</div>
<div class="paragraph">
<p>Se crean de manera explícita mediante el método <code>createCollection</code>, pasándole el tamaño en <em>bytes</em> de la colección. Por ejemplo, si queremos cerar una colección para auditar datos de 20 KB haríamos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">createCollection</span><span class="tok-p">(</span><span class="tok-s2">&quot;auditoria&quot;</span><span class="tok-p">,</span> <span class="tok-p">{</span><span class="tok-nx">capped</span><span class="tok-o">:</span><span class="tok-kc">true</span><span class="tok-p">,</span> <span class="tok-nx">size</span><span class="tok-o">:</span><span class="tok-mi">20480</span><span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Los documentos que se añaden a una colección limitada se pueden modifican, pero no pueden crecer en tamaño. Si sucede, la modificación fallará.
Además, tampoco se pueden eliminar documentos de la colección. Para ello, hay que borrar toda la colección (<em>drop</em>) y volver a crearla.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>También podemos limitar el número de elementos que se pueden añadir a la colección mediante el parámetro <code>max:</code> en la creación de la colección. Sin embargo, hay que asegurarse de disponer de suficiente espacio en la colección para los elementos que queremos añadir. Si la colección se llena antes de que el número de elementos se alcance, se eliminará el elemento más antiguo de la colección.</p>
</div>
<div class="paragraph">
<p>Si retomamos el ejemplo anterior, pero fijamos su máximo a 100 elementos, crearíamos la colección del siguiente modo:</p>
</div>
<div class="listingblock">
<div class="title">Creando una colección limitada a 100 documentos</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">createCollection</span><span class="tok-p">(</span><span class="tok-s2">&quot;auditoria&quot;</span><span class="tok-p">,</span> <span class="tok-p">{</span><span class="tok-nx">capped</span><span class="tok-o">:</span><span class="tok-kc">true</span><span class="tok-p">,</span> <span class="tok-nx">size</span><span class="tok-o">:</span><span class="tok-mi">20480</span><span class="tok-p">,</span> <span class="tok-nx">max</span><span class="tok-o">:</span><span class="tok-mi">100</span><span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El <em>shell</em> de <em>MongoDB</em> ofrece la utilidad <code>validate()</code> para visualizar la cantidad de espacio utilizado por cada colección, ya sea limitada o no. Para comprobar el estado de la colección anterior haríamos:</p>
</div>
<div class="listingblock">
<div class="title">Validando el estado de una colección</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">auditoria</span><span class="tok-p">.</span><span class="tok-nx">validate</span><span class="tok-p">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si queremos consultar los datos de una colección limitada, por su idiosincracia, los resultados aparecerán en el orden de inserción. Si queremos obtenerlos en orden inverso, le tenemos que pasar el operador <code>$natural</code> al método <code>sort()</code>:</p>
</div>
<div class="listingblock">
<div class="title">Consultando una colección limitada a la inversa</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">auditoria</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">().</span><span class="tok-nx">sort</span><span class="tok-p">({</span> <span class="tok-nx">$natural</span><span class="tok-o">:-</span><span class="tok-mi">1</span> <span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finalmente, si queremos averiguar si una colección es limitada, lo haremos mediante el método <code>isCapped()</code>:</p>
</div>
<div class="listingblock">
<div class="title">Comprobando si una colección es limitada</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">auditoria</span><span class="tok-p">.</span><span class="tok-nx">isCapped</span><span class="tok-p">()</span>
<span class="tok-kc">true</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Más información en <a href="https://docs.mongodb.org/manual/core/capped-collections/" class="bare">https://docs.mongodb.org/manual/core/capped-collections/</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_profiling">3.6. Profiling</h3>
<div class="paragraph">
<p>Si arrancamos el demonio con la opción <code>--rest</code> lanzará un servidor HTTP que escucha peticiones en el puerto 28017. Este servidor captura peticiones REST que permiten realizar consultas sobre la información administrativa de la base de datos.</p>
</div>
<div class="paragraph">
<p>Así pues, si abrimos el navegador y accedemos a <a href="http://localhost:28017" class="bare">http://localhost:28017</a> obtendremos algo similar a esto:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql03/mongod-rest.jpg" alt="Interfaz REST de mongod" width="100%">
</div>
<div class="title">Figure 4. Interfaz REST de mongod</div>
</div>
<div class="paragraph">
<p>Más información en <a href="http://docs.mongodb.org/ecosystem/tools/http-interfaces" class="bare">http://docs.mongodb.org/ecosystem/tools/http-interfaces</a></p>
</div>
<div class="paragraph">
<p>Además, <em>MongoDB</em> trae integradas varias herramientas para el control del rendimiento.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, la colección <code>db.system.profile</code> auditará las consultas ejecutadas. Podemos indicar el nivel de las consultas a auditar mediante tres niveles: <code>0</code> (ninguna), <code>1</code> (consultas lentas), <code>2</code> (todas las consultas)</p>
</div>
<div class="paragraph">
<p>Si queremos que se auditen todas las consultas, lo indicaremos del siguiente modo:</p>
</div>
<div class="listingblock">
<div class="title">Auditando todas las consultas</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">setProfilingLevel</span><span class="tok-p">(</span><span class="tok-mi">2</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El método <code>setProfilingLevel()</code> también admite un segundo parámetro para indicar el numero mínimo de milisegundos de las consultas para ser auditadas.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Por defecto, <em>MongoDB</em> automáticamente escribe en el log las consultas que tardan más de 100ms.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si queremos indicar estas propiedades al arrancar el demonio, le pasaremos los parámetros <code>--profile</code> y/o <code>--slowms</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">mongod --profile<span class="tok-o">=</span><span class="tok-m">1</span> --slowms<span class="tok-o">=</span>15</code></pre>
</div>
</div>
<div class="paragraph">
<p>Si en algún momento queremos consultar tanto el nivel como el estado del <em>profiling</em>, podemos utilizar los métodos <code>db.getProfilingLevel()</code> y <code>db.getProfilingStatus()</code>.</p>
</div>
<div class="paragraph">
<p>Sobre los datos auditados, podemos hacer <code>find</code> sobre <code>db.system.profile</code> y filtrar por los campos mostrados:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">system</span><span class="tok-p">.</span><span class="tok-nx">profile</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">({</span> <span class="tok-nx">millis</span> <span class="tok-o">:</span> <span class="tok-p">{</span> <span class="tok-nx">$gt</span> <span class="tok-o">:</span> <span class="tok-mi">1000</span> <span class="tok-p">}</span> <span class="tok-p">}).</span><span class="tok-nx">sort</span><span class="tok-p">({</span><span class="tok-nx">ts</span> <span class="tok-o">:</span> <span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">})</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">db</span><span class="tok-p">.</span><span class="tok-nx">system</span><span class="tok-p">.</span><span class="tok-nx">profile</span><span class="tok-p">.</span><span class="tok-nx">find</span><span class="tok-p">().</span><span class="tok-nx">limit</span><span class="tok-p">(</span><span class="tok-mi">10</span><span class="tok-p">).</span><span class="tok-nx">sort</span><span class="tok-p">(</span> <span class="tok-p">{</span> <span class="tok-nx">ts</span> <span class="tok-o">:</span> <span class="tok-o">-</span><span class="tok-mi">1</span> <span class="tok-p">}</span> <span class="tok-p">).</span><span class="tok-nx">pretty</span><span class="tok-p">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Dentro de estas consultas algunos campos significativos son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>op</code>: tipo de operación, ya sea <code>command</code>, <code>query</code>, <code>insert</code>, …</p>
</li>
<li>
<p><code>millis</code>: tiempo empleado en la operación</p>
</li>
<li>
<p><code>ts</code>: <em>timestamp</em> de la operación</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Podéis consultar todos los campos disponibles en <a href="http://docs.mongodb.org/manual/reference/database-profiler/" class="bare">http://docs.mongodb.org/manual/reference/database-profiler/</a></p>
</div>
<div class="paragraph">
<p>Otras herramientas para controlar el rendimiento que se ejecutan en un terminal, son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>mongotop</strong> → similar a la herramienta <code>top</code> de UNIX, muestra el tiempo empleado por <em>MongoDB</em> en las diferentes colecciones, indicando tanto el tiempo empleado en lectura como en escrituras.
Para ello, si queremos se ejecute cada tres segundos, en un terminal:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">mongotop 3</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql03/mongotop.jpg" alt="Ejemplo de ejecutar mongotop 3" width="66%">
</div>
<div class="title">Figure 5. Ejemplo de <code>mongotop</code></div>
</div>
<div class="paragraph">
<p>Más información en : <a href="http://docs.mongodb.org/manual/reference/program/mongotop/" class="bare">http://docs.mongodb.org/manual/reference/program/mongotop/</a></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>mongostat</strong> → muestra el número de operaciones por cada tipo que se realizan por segundo a nivel de servidor, lo que nos da una instantánea de los que está haciendo el servidor.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nosql03/mongostat.jpg" alt="Ejemplo de ejecutar mongostat 5" width="{xlarge-size}">
</div>
<div class="title">Figure 6. Ejemplo de <code>mongostat</code></div>
</div>
<div class="paragraph">
<p>Una buena columna a vigilar es <code>idx miss %</code>, la cual muestra los índices perdidos, es decir, aquellas consultas que han causado paginación y en vez de obtener los datos de memoria han tenido que acceder a disco.</p>
</div>
<div class="paragraph">
<p>Más información en : <a href="http://docs.mongodb.org/manual/reference/program/mongostat/" class="bare">http://docs.mongodb.org/manual/reference/program/mongostat/</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios">3.7. Ejercicios</h3>
<div class="sect3">
<h4 id="__1_5_puntos_ejercicio_31_diseñando_el_esquema">3.7.1. (1.5 puntos) Ejercicio 31. Diseñando el esquema</h4>
<div class="paragraph">
<p>Vamos a realizar el modelo de datos documental de una tienda <em>online</em> que comercializa productos de bricolaje. Para ello, nos interesa almacenar datos de estos productos (nombre, descripción, medidas, peso, pvp, &#8230;&#8203;), y de los pedidos que realizan los clientes. Una vez formalizado un pedido, se le enviará vía mensajería urgente el pedido al domicilio del cliente.</p>
</div>
<div class="paragraph">
<p>De los clientes nos interesa almacenar sus datos personales, datos de contacto (tanto emails como teléfonos), así como las diferentes direcciones que pueda tener asociadas.</p>
</div>
<div class="paragraph">
<p>Del pedido, además de la fecha de realización y de los productos que incluye, el precio total así como la dirección de envío.</p>
</div>
<div class="paragraph">
<p>Para ello, en una base de datos denominada <code>bricomongo</code>, se deben incluir las colecciones necesarias. Cada una de las colecciones debe contener tres o más documentos.</p>
</div>
<div class="paragraph">
<p>Una vez diseñada, creada y tras insertar los datos, se han de exportar las diferentes colecciones mediante <code>mongoexport</code> en archivos denominados <code>ej31-nombreColeccion.json</code>, sustituyendo <code>nombreColeccion</code> por el nombre de las diferentes colecciones que hayas diseñado. Finalmente, se debe exportar toda la base de datos mediante <code>mongodump</code> en un archivo denominado <code>ej31-dump</code></p>
</div>
</div>
<div class="sect3">
<h4 id="__0_75_puntos_ejercicio_32_Índices">3.7.2. (0.75 puntos) Ejercicio 32. Índices</h4>
<div class="paragraph">
<p>En este ejercicio vamos optimizar la base de datos de <code>ejercicios</code> importada en la primera sesión.</p>
</div>
<div class="paragraph">
<p>Las consultas que más se realizan sobre la colección <code>cities</code> son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Recuperar una ciudad por su nombre</p>
</li>
<li>
<p>Recuperar las 5 ciudades más pobladas de un determinado país</p>
</li>
<li>
<p>Recuperar las 3 ciudades menos pobladas de una zona horaria.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Se pide crear los índices adecuados para que estas consultas se ejecuten de manera óptima.</p>
</div>
<div class="paragraph">
<p>Por lo tanto, el archivo <code>ej32.txt</code> debe contener:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>los comandos empleados para comprobar los planes de ejecución antes y después de crear los índices necesarios</p>
</li>
<li>
<p>comandos necesarios para crear los índices elegidos</p>
</li>
<li>
<p>una explicación de la elección del tipo de índice elegido en cada caso.</p>
</li>
<li>
<p>resultado de obtener todos los índices de la colección <code>cities</code> una vez creados todos los índices elegidos</p>
</li>
<li>
<p>tamaño de los índices y requisitos de <em>hardware</em> del servidor necesarios para dar soporte a estos índices</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnote_1">
<a href="#_footnoteref_1">1</a>. la primera opción, ya que no puede haber documentos con propiedades nulas en un índice <em>sparse</em>
</div>
<div class="footnote" id="_footnote_2">
<a href="#_footnoteref_2">2</a>. 100, es decir, todos los valores existentes en el índice multiclave
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2016-01-24 20:22:59 CET
</div>
</div>
</body>
</html>