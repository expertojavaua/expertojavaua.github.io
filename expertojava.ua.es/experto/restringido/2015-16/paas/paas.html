<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.2">
<meta name="author" content="José Luis Zamora Sánchez">
<title>Servidores web y PaaS</title>
<style>/*! normalize.css v2.1.2 | MIT License | git.io/normalize */
/* ========================================================================== HTML5 display definitions ========================================================================== */
/** Correct `block` display not defined in IE 8/9. */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }

/** Correct `inline-block` display not defined in IE 8/9. */
audio, canvas, video { display: inline-block; }

/** Prevent modern browsers from displaying `audio` without controls. Remove excess height in iOS 5 devices. */
audio:not([controls]) { display: none; height: 0; }

/** Address `[hidden]` styling not present in IE 8/9. Hide the `template` element in IE, Safari, and Firefox < 22. */
[hidden], template { display: none; }

script { display: none !important; }

/* ========================================================================== Base ========================================================================== */
/** 1. Set default font family to sans-serif. 2. Prevent iOS text size adjust after orientation change, without disabling user zoom. */
html { font-family: sans-serif; /* 1 */ -ms-text-size-adjust: 100%; /* 2 */ -webkit-text-size-adjust: 100%; /* 2 */ }

/** Remove default margin. */
body { margin: 0; }

/* ========================================================================== Links ========================================================================== */
/** Remove the gray background color from active links in IE 10. */
a { background: transparent; }

/** Address `outline` inconsistency between Chrome and other browsers. */
a:focus { outline: thin dotted; }

/** Improve readability when focused and also mouse hovered in all browsers. */
a:active, a:hover { outline: 0; }

/* ========================================================================== Typography ========================================================================== */
/** Address variable `h1` font-size and margin within `section` and `article` contexts in Firefox 4+, Safari 5, and Chrome. */
h1 { font-size: 2em; margin: 0.67em 0; }

/** Address styling not present in IE 8/9, Safari 5, and Chrome. */
abbr[title] { border-bottom: 1px dotted; }

/** Address style set to `bolder` in Firefox 4+, Safari 5, and Chrome. */
b, strong { font-weight: bold; }

/** Address styling not present in Safari 5 and Chrome. */
dfn { font-style: italic; }

/** Address differences between Firefox and other browsers. */
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }

/** Address styling not present in IE 8/9. */
mark { background: #ff0; color: #000; }

/** Correct font family set oddly in Safari 5 and Chrome. */
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }

/** Improve readability of pre-formatted text in all browsers. */
pre { white-space: pre-wrap; }

/** Set consistent quote types. */
q { quotes: "\201C" "\201D" "\2018" "\2019"; }

/** Address inconsistent and variable font size in all browsers. */
small { font-size: 80%; }

/** Prevent `sub` and `sup` affecting `line-height` in all browsers. */
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }

sup { top: -0.5em; }

sub { bottom: -0.25em; }

/* ========================================================================== Embedded content ========================================================================== */
/** Remove border when inside `a` element in IE 8/9. */
img { border: 0; }

/** Correct overflow displayed oddly in IE 9. */
svg:not(:root) { overflow: hidden; }

/* ========================================================================== Figures ========================================================================== */
/** Address margin not present in IE 8/9 and Safari 5. */
figure { margin: 0; }

/* ========================================================================== Forms ========================================================================== */
/** Define consistent border, margin, and padding. */
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }

/** 1. Correct `color` not being inherited in IE 8/9. 2. Remove padding so people aren't caught out if they zero out fieldsets. */
legend { border: 0; /* 1 */ padding: 0; /* 2 */ }

/** 1. Correct font family not being inherited in all browsers. 2. Correct font size not being inherited in all browsers. 3. Address margins set differently in Firefox 4+, Safari 5, and Chrome. */
button, input, select, textarea { font-family: inherit; /* 1 */ font-size: 100%; /* 2 */ margin: 0; /* 3 */ }

/** Address Firefox 4+ setting `line-height` on `input` using `!important` in the UA stylesheet. */
button, input { line-height: normal; }

/** Address inconsistent `text-transform` inheritance for `button` and `select`. All other form control elements do not inherit `text-transform` values. Correct `button` style inheritance in Chrome, Safari 5+, and IE 8+. Correct `select` style inheritance in Firefox 4+ and Opera. */
button, select { text-transform: none; }

/** 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio` and `video` controls. 2. Correct inability to style clickable `input` types in iOS. 3. Improve usability and consistency of cursor style between image-type `input` and others. */
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; /* 2 */ cursor: pointer; /* 3 */ }

/** Re-set default cursor for disabled elements. */
button[disabled], html input[disabled] { cursor: default; }

/** 1. Address box sizing set to `content-box` in IE 8/9. 2. Remove excess padding in IE 8/9. */
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; /* 1 */ padding: 0; /* 2 */ }

/** 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome. 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome (include `-moz` to future-proof). */
input[type="search"] { -webkit-appearance: textfield; /* 1 */ -moz-box-sizing: content-box; -webkit-box-sizing: content-box; /* 2 */ box-sizing: content-box; }

/** Remove inner padding and search cancel button in Safari 5 and Chrome on OS X. */
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }

/** Remove inner padding and border in Firefox 4+. */
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }

/** 1. Remove default vertical scrollbar in IE 8/9. 2. Improve readability and alignment in all browsers. */
textarea { overflow: auto; /* 1 */ vertical-align: top; /* 2 */ }

/* ========================================================================== Tables ========================================================================== */
/** Remove most spacing between table cells. */
table { border-collapse: collapse; border-spacing: 0; }

meta.foundation-mq-small { font-family: "only screen and (min-width: 768px)"; width: 768px; }

meta.foundation-mq-medium { font-family: "only screen and (min-width:1280px)"; width: 1280px; }

meta.foundation-mq-large { font-family: "only screen and (min-width:1440px)"; width: 1440px; }

*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }

html, body { font-size: 97%; }

body { background: white; color: #222222; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }

a:hover { cursor: pointer; }

img, object, embed { max-width: 100%; height: auto; }

object, embed { height: 100%; }

img { -ms-interpolation-mode: bicubic; }

#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }

.left { float: left !important; }

.right { float: right !important; }

.text-left { text-align: left !important; }

.text-right { text-align: right !important; }

.text-center { text-align: center !important; }

.text-justify { text-align: justify !important; }

.hide { display: none; }

.antialiased, body { -webkit-font-smoothing: antialiased; }

img { display: inline-block; vertical-align: middle; }

textarea { height: auto; min-height: 50px; }

select { width: 100%; }

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }

.subheader, .admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { line-height: 1.4; color: #6f6f6f; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }

/* Typography resets */
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }

/* Default Link Styles */
a { color: #1164be; text-decoration: none; line-height: inherit; }
a img { border: none; }

/* Default paragraph styles */
p { font-family: inherit; font-weight: normal; font-size: 1em; line-height: 1.4; margin-bottom: 1em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }

/* Default header styles */
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: bold; font-style: normal; color: #1c355e; text-rendering: optimizeLegibility; margin-top: 1em; margin-bottom: 0.5em; line-height: 1.2125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #6f6f6f; line-height: 0; }

h1 { font-size: 2.125em; }

h2 { font-size: 1.6875em; }

h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }

h4 { font-size: 1.125em; }

h5 { font-size: 1.125em; }

h6 { font-size: 1em; }

hr { border: solid #dddddd; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }

/* Helpful Typography Defaults */
em, i { font-style: italic; line-height: inherit; }

strong, b { font-weight: bold; line-height: inherit; }

small { font-size: 60%; line-height: inherit; }

code { font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: bold; }

/* Lists */
ul, ol, dl { font-size: 1em; line-height: 1.4; margin-bottom: 1.25em; list-style-position: outside; font-family: inherit; }

ul, ol { margin-left: 2.5em; }
ul.no-bullet, ol.no-bullet { margin-left: 1.5em; }

/* Unordered Lists */
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; /* Override nested font-size change */ }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }

/* Ordered Lists */
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }

/* Definition Lists */
dl dt { margin-bottom: 0.3125em; font-weight: bold; }
dl dd { margin-bottom: 1.25em; }

/* Abbreviations */
abbr, acronym { text-transform: uppercase; font-size: 90%; color: #222222; border-bottom: 1px dotted #dddddd; cursor: help; }

abbr { text-transform: none; }

/* Blockquotes */
blockquote { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
blockquote cite { display: block; font-size: 0.8125em; color: #555555; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #555555; }

blockquote, blockquote p { line-height: 1.6; color: #6f6f6f; }

/* Microformats */
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #dddddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }

.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }

/*@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.6875em; }
  h4 { font-size: 1.4375em; } }*/
/* Tables */
table { background: white; margin-bottom: 1.25em; border: solid 1px #dddddd; }
table thead, table tfoot { background: whitesmoke; font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: #222222; text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: #222222; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #f9f9f9; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.4; }

h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; border-bottom: 1px solid #dddddd }

.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }

*:not(pre) > code { font-size: inherit; font-style: normal !important; letter-spacing: 0; padding: 3px 2px 1px 2px; background-color: #eeeeee; border: 1px solid #dddddd; -webkit-border-radius: 0; border-radius: 0; line-height: inherit; font-weight: normal; }

pre, pre > code { line-height: 1.4; color: black; font-family: monospace, serif; font-weight: normal; }

.keyseq { color: #555555; }

kbd { display: inline-block; color: #222222; font-size: 0.75em; line-height: 1.4; background-color: #f7f7f7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; margin: -0.15em 0.15em 0 0.15em; padding: 0.2em 0.6em 0.2em 0.5em; vertical-align: middle; white-space: nowrap; }

.keyseq kbd:first-child { margin-left: 0; }

.keyseq kbd:last-child { margin-right: 0; }

.menuseq, .menu { color: #090909; }

b.button:before, b.button:after { position: relative; top: -1px; font-weight: normal; }

b.button:before { content: "["; padding: 0 3px 0 2px; }

b.button:after { content: "]"; padding: 0 2px 0 3px; }

#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 0.9375em; padding-right: 0.9375em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }

#content { margin-top: 1.25em; }

#content:before { content: none; }

#header > h1:first-child { color: black; margin-top: 2.25rem; margin-bottom: 0; }
#header > h1:first-child + #toc { margin-top: 8px; border-top: 1px solid #dddddd; }
#header > h1:only-child, body.toc2 #header > h1:nth-last-child(2) { border-bottom: 1px solid #dddddd; padding-bottom: 8px; }
#header .details { border-bottom: 1px solid #dddddd; line-height: 1.45; padding-top: 0.25em; padding-bottom: 0.25em; padding-left: 0.25em; color: #555555; display: -ms-flexbox; display: -webkit-flex; display: flex; -ms-flex-flow: row wrap; -webkit-flex-flow: row wrap; flex-flow: row wrap; }
#header .details span:first-child { margin-left: -0.125em; }
#header .details span.email a { color: #6f6f6f; }
#header .details br { display: none; }
#header .details br + span:before { content: "\00a0\2013\00a0"; }
#header .details br + span.author:before { content: "\00a0\22c5\00a0"; color: #6f6f6f; }
#header .details br + span#revremark:before { content: "\00a0|\00a0"; }
#header #revnumber { text-transform: capitalize; }
#header #revnumber:after { content: "\00a0"; }

#content > h1:first-child:not([class]) { color: black; border-bottom: 1px solid #dddddd; padding-bottom: 8px; margin-top: 0; padding-top: 1rem; margin-bottom: 1.25rem; }

#floating {
  position: fixed;
  z-index: 1000;
  padding: 0.5em;
  right: 0;
  top: 0;
  background: white;
  box-shadow: 0 0 1em #777777;
  -webkit-box-shadow: 0 0 1em #777777;
  -moz-box-shadow: 0 0 1em #777777;
  -webkit-border-bottom-left-radius: 5px;
  -moz-border-radius-bottomleft: 5px;
  max-height: 80%;
  overflow: auto;
}

#floating #full { display: none; } /* Hide the full TOC by default */

#floating:hover #full{
  display: block; /* Show it on hover */
}


#toc { border-bottom: 1px solid #dddddd; padding-bottom: 0.5em; }
#toc > ul { margin-left: 0.125em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin: 0.5em 0; }
#toc ul { font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; list-style-type: none; }
#toc a { text-decoration: none; }
#toc a:active { text-decoration: underline; }

#toctitle { color: #6f6f6f; font-size: 1.2em; }

@media only screen and (min-width: 768px) { #toctitle { font-size: 1.375em; }
  body.toc2 { padding-left: 15em; padding-right: 0; }
  #toc.toc2 { margin-top: 0 !important; background-color: #f2f2f2; position: fixed; width: 15em; left: 0; top: 0; border-right: 1px solid #dddddd; border-top-width: 0 !important; border-bottom-width: 0 !important; z-index: 1000; padding: 1.25em 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; font-size: 1.2em; }
  #toc.toc2 > ul { font-size: 0.9em; margin-bottom: 0; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 15em; }
  body.toc2.toc-right #toc.toc2 { border-right-width: 0; border-left: 1px solid #dddddd; left: auto; right: 0; } }
@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; padding-right: 0; }
  #toc.toc2 { width: 20em; }
  #toc.toc2 #toctitle { font-size: 1.375em; }
  #toc.toc2 > ul { font-size: 0.95em; }
  #toc.toc2 ul ul { padding-left: 1.25em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; } }
#content #toc { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 0; border-radius: 0; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }

#footer { max-width: 100%; background-color: #222222; padding: 1.25em; }

#footer-text { color: #dddddd; line-height: 1.44; }

.sect1 { padding-bottom: 0.625em; }

@media only screen and (min-width: 768px) { .sect1 { padding-bottom: 1.25em; } }
.sect1 + .sect1 { border-top: 1px solid #dddddd; }

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; z-index: 1001; width: 1.5ex; margin-left: -1.5ex; display: block; text-decoration: none !important; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: "\00A7"; font-size: 0.85em; display: block; padding-top: 0.1em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #222222; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #151515; }

.audioblock, .imageblock, .literalblock, .listingblock, .stemblock, .videoblock { margin-bottom: 1.25em; }

.admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-rendering: optimizeLegibility; text-align: left; }

table.tableblock > caption.title { white-space: nowrap; overflow: visible; max-width: 0; }

.paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { color: black; }

table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }

.admonitionblock > table { border-collapse: separate; border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #dddddd; color: #555555; }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }

.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 0; border-radius: 0; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }

.sidebarblock { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 0; border-radius: 0; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock > .content > .title { color: #6f6f6f; margin-top: 0; }

.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }

.literalblock pre, .listingblock pre:not(.highlight), .listingblock pre[class="highlight"], .listingblock pre[class^="highlight "], .listingblock pre.CodeRay, .listingblock pre.prettyprint { background: #eeeeee; }
.sidebarblock .literalblock pre, .sidebarblock .listingblock pre:not(.highlight), .sidebarblock .listingblock pre[class="highlight"], .sidebarblock .listingblock pre[class^="highlight "], .sidebarblock .listingblock pre.CodeRay, .sidebarblock .listingblock pre.prettyprint { background: #f2f1f1; }

.literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { border: 1px solid #cccccc; -webkit-border-radius: 0; border-radius: 0; word-wrap: break-word; padding: 0.8em 0.8em 0.65em 0.8em; font-size: 0.8125em; }
.literalblock pre.nowrap, .literalblock pre[class].nowrap, .listingblock pre.nowrap, .listingblock pre[class].nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
@media only screen and (min-width: 768px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 0.90625em; } }
@media only screen and (min-width: 1280px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 1em; } }

.literalblock.output pre { color: #eeeeee; background-color: black; }

.listingblock pre.highlightjs { padding: 0; }
.listingblock pre.highlightjs > code { padding: 0.8em 0.8em 0.65em 0.8em; -webkit-border-radius: 0; border-radius: 0; }

.listingblock > .content { position: relative; }

.listingblock code[data-lang]:before { display: none; content: attr(data-lang); position: absolute; font-size: 0.75em; top: 0.425rem; right: 0.5rem; line-height: 1; text-transform: uppercase; color: #999; }

.listingblock:hover code[data-lang]:before { display: block; }

.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }

.listingblock.terminal pre .command:not([data-prompt]):before { content: "$"; }

table.pyhltable { border-collapse: separate; border: 0; margin-bottom: 0; background: none; }

table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; }

table.pyhltable td.code { padding-left: .75em; padding-right: 0; }

pre.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #dddddd; }

pre.pygments .lineno { display: inline-block; margin-right: .25em; }

table.pyhltable .linenodiv { background: none !important; padding-right: 0 !important; }

.quoteblock { margin: 0 1em 1.25em 1.5em; display: table; }
.quoteblock > .title { margin-left: -1.5em; margin-bottom: 0.75em; }
.quoteblock blockquote, .quoteblock blockquote p { color: #6f6f6f; font-size: 1.15rem; line-height: 1.75; word-spacing: 0.1em; letter-spacing: 0; font-style: italic; text-align: justify; }
.quoteblock blockquote { margin: 0; padding: 0; border: 0; }
.quoteblock blockquote:before { content: "\201c"; float: left; font-size: 2.75em; font-weight: bold; line-height: 0.6em; margin-left: -0.6em; color: #6f6f6f; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: 0.5em; margin-right: 0.5ex; text-align: right; }
.quoteblock .quoteblock { margin-left: 0; margin-right: 0; padding: 0.5em 0; border-left: 3px solid #555555; }
.quoteblock .quoteblock blockquote { padding: 0 0 0 0.75em; }
.quoteblock .quoteblock blockquote:before { display: none; }

.verseblock { margin: 0 1em 1.25em 1em; }
.verseblock pre { font-family: "Open Sans", "DejaVu Sans", sans; font-size: 1.15rem; color: #6f6f6f; font-weight: 300; text-rendering: optimizeLegibility; }
.verseblock pre strong { font-weight: 400; }
.verseblock .attribution { margin-top: 1.25rem; margin-left: 0.5ex; }

.quoteblock .attribution, .verseblock .attribution { font-size: 0.8125em; line-height: 1.45; font-style: italic; }
.quoteblock .attribution br, .verseblock .attribution br { display: none; }
.quoteblock .attribution cite, .verseblock .attribution cite { display: block; letter-spacing: -0.05em; color: #555555; }

.quoteblock.abstract { margin: 0 0 1.25em 0; display: block; }
.quoteblock.abstract blockquote, .quoteblock.abstract blockquote p { text-align: left; word-spacing: 0; }
.quoteblock.abstract blockquote:before, .quoteblock.abstract blockquote p:first-of-type:before { display: none; }

table.tableblock { max-width: 100%; border-collapse: separate; }
table.tableblock td > .paragraph:last-child p > p:last-child, table.tableblock th > p:last-child, table.tableblock td > p:last-child { margin-bottom: 0; }

table.spread { width: 100%; }

table.tableblock, th.tableblock, td.tableblock { border: 0 solid #dddddd; }

table.grid-all th.tableblock, table.grid-all td.tableblock { border-width: 0 1px 1px 0; }

table.grid-all tfoot > tr > th.tableblock, table.grid-all tfoot > tr > td.tableblock { border-width: 1px 1px 0 0; }

table.grid-cols th.tableblock, table.grid-cols td.tableblock { border-width: 0 1px 0 0; }

table.grid-all * > tr > .tableblock:last-child, table.grid-cols * > tr > .tableblock:last-child { border-right-width: 0; }

table.grid-rows th.tableblock, table.grid-rows td.tableblock { border-width: 0 0 1px 0; }

table.grid-all tbody > tr:last-child > th.tableblock, table.grid-all tbody > tr:last-child > td.tableblock, table.grid-all thead:last-child > tr > th.tableblock, table.grid-rows tbody > tr:last-child > th.tableblock, table.grid-rows tbody > tr:last-child > td.tableblock, table.grid-rows thead:last-child > tr > th.tableblock { border-bottom-width: 0; }

table.grid-rows tfoot > tr > th.tableblock, table.grid-rows tfoot > tr > td.tableblock { border-width: 1px 0 0 0; }

table.frame-all { border-width: 1px; }

table.frame-sides { border-width: 0 1px; }

table.frame-topbot { border-width: 1px 0; }

th.halign-left, td.halign-left { text-align: left; }

th.halign-right, td.halign-right { text-align: right; }

th.halign-center, td.halign-center { text-align: center; }

th.valign-top, td.valign-top { vertical-align: top; }

th.valign-bottom, td.valign-bottom { vertical-align: bottom; }

th.valign-middle, td.valign-middle { vertical-align: middle; }

table thead th, table tfoot th { font-weight: bold; }

tbody tr th { display: table-cell; line-height: 1.4; background: whitesmoke; }

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p { color: #222222; font-weight: bold; }

p.tableblock > code:only-child { background: none; padding: 0; }

p.tableblock { font-size: 1em; }

td > div.verse { white-space: pre; }

ol { margin-left: 2.5em; }

ul li ol { margin-left: 1.5em; }

dl dd { margin-left: 1.125em; }

dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }

ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.625em; }

ul.unstyled, ol.unnumbered, ul.checklist, ul.none { list-style-type: none; }

ul.unstyled, ol.unnumbered, ul.checklist { margin-left: 0.625em; }

ul.checklist li > p:first-child > .fa-check-square-o:first-child, ul.checklist li > p:first-child > input[type="checkbox"]:first-child { margin-right: 0.25em; }

ul.checklist li > p:first-child > input[type="checkbox"]:first-child { position: relative; top: 1px; }

ul.inline { margin: 0 auto 0.625em auto; margin-left: -1.375em; margin-right: 0; padding: 0; list-style: none; overflow: hidden; }
ul.inline > li { list-style: none; float: left; margin-left: 1.375em; display: block; }
ul.inline > li > * { display: block; }

.unstyled dl dt { font-weight: normal; font-style: normal; }

ol.arabic { list-style-type: decimal; }

ol.decimal { list-style-type: decimal-leading-zero; }

ol.loweralpha { list-style-type: lower-alpha; }

ol.upperalpha { list-style-type: upper-alpha; }

ol.lowerroman { list-style-type: lower-roman; }

ol.upperroman { list-style-type: upper-roman; }

ol.lowergreek { list-style-type: lower-greek; }

.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }

td.hdlist1 { padding-right: .75em; font-weight: bold; }

td.hdlist1, td.hdlist2 { vertical-align: top; }

.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }

.colist > table tr > td:first-of-type { padding: 0 0.75em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.25em 0; }

.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: 0 0 0 1px #dddddd; box-shadow: 0 0 0 1px #dddddd; }

.imageblock.left, .imageblock[style*="float: left"] { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }

.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }

a.image { text-decoration: none; }

span.footnote, span.footnoteref { vertical-align: super; font-size: 0.875em; }
span.footnote a, span.footnoteref a { text-decoration: none; }
span.footnote a:active, span.footnoteref a:active { text-decoration: underline; }

#footnotes { padding-top: 0.75em; padding-bottom: 0.75em; margin-bottom: 0.625em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -.25em 0 .75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.375em; line-height: 1.3; font-size: 0.875em; margin-left: 1.2em; text-indent: -1.2em; margin-bottom: .2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }

#content #footnotes { margin-top: -0.625em; margin-bottom: 0; padding: 0.75em 0; }

.gist .file-data > table { border: 0; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }

div.unbreakable { page-break-inside: avoid; }

.big { font-size: larger; }

.small { font-size: smaller; }

.underline { text-decoration: underline; }

.overline { text-decoration: overline; }

.line-through { text-decoration: line-through; }

.aqua { color: #00bfbf; }

.aqua-background { background-color: #00fafa; }

.black { color: black; }

.black-background { background-color: black; }

.blue { color: #0000bf; }

.blue-background { background-color: #0000fa; }

.fuchsia { color: #bf00bf; }

.fuchsia-background { background-color: #fa00fa; }

.gray { color: #606060; }

.gray-background { background-color: #7d7d7d; }

.green { color: #006000; }

.green-background { background-color: #007d00; }

.lime { color: #00bf00; }

.lime-background { background-color: #00fa00; }

.maroon { color: #600000; }

.maroon-background { background-color: #7d0000; }

.navy { color: #000060; }

.navy-background { background-color: #00007d; }

.olive { color: #606000; }

.olive-background { background-color: #7d7d00; }

.purple { color: #600060; }

.purple-background { background-color: #7d007d; }

.red { color: #bf0000; }

.red-background { background-color: #fa0000; }

.silver { color: #909090; }

.silver-background { background-color: #bcbcbc; }

.teal { color: #006060; }

.teal-background { background-color: #007d7d; }

.white { color: #bfbfbf; }

.white-background { background-color: #fafafa; }

.yellow { color: #bfbf00; }

.yellow-background { background-color: #fafa00; }

span.icon > .fa { cursor: default; }

.admonitionblock td.icon [class^="fa icon-"] { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #207c98; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }

.conum[data-value] { display: inline-block; color: #fff !important; background-color: #222222; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; font-size: 0.75em; width: 1.67em; height: 1.67em; line-height: 1.67em; font-family: "Open Sans", "DejaVu Sans", sans-serif; font-style: normal; font-weight: bold; }
.conum[data-value] * { color: #fff !important; }
.conum[data-value] + b { display: none; }
.conum[data-value]:after { content: attr(data-value); }
pre .conum[data-value] { position: relative; top: -0.125em; }

b.conum * { color: inherit !important; }

.conum:not([data-value]):empty { display: none; }

.literalblock pre, .listingblock pre { background: #eeeeee; }

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.min.css">
<style>.listingblock .pygments .hll { background-color: #ffffcc }
.listingblock .pygments  { background: #f8f8f8; }
.listingblock .pygments .tok-c { color: #408080; font-style: italic } /* Comment */
.listingblock .pygments .tok-err { border: 1px solid #FF0000 } /* Error */
.listingblock .pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
.listingblock .pygments .tok-o { color: #666666 } /* Operator */
.listingblock .pygments .tok-cm { color: #408080; font-style: italic } /* Comment.Multiline */
.listingblock .pygments .tok-cp { color: #BC7A00 } /* Comment.Preproc */
.listingblock .pygments .tok-c1 { color: #408080; font-style: italic } /* Comment.Single */
.listingblock .pygments .tok-cs { color: #408080; font-style: italic } /* Comment.Special */
.listingblock .pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
.listingblock .pygments .tok-ge { font-style: italic } /* Generic.Emph */
.listingblock .pygments .tok-gr { color: #FF0000 } /* Generic.Error */
.listingblock .pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
.listingblock .pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
.listingblock .pygments .tok-go { color: #888888 } /* Generic.Output */
.listingblock .pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.listingblock .pygments .tok-gs { font-weight: bold } /* Generic.Strong */
.listingblock .pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.listingblock .pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
.listingblock .pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.listingblock .pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.listingblock .pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.listingblock .pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
.listingblock .pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.listingblock .pygments .tok-kt { color: #B00040 } /* Keyword.Type */
.listingblock .pygments .tok-m { color: #666666 } /* Literal.Number */
.listingblock .pygments .tok-s { color: #BA2121 } /* Literal.String */
.listingblock .pygments .tok-na { color: #7D9029 } /* Name.Attribute */
.listingblock .pygments .tok-nb { color: #008000 } /* Name.Builtin */
.listingblock .pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
.listingblock .pygments .tok-no { color: #880000 } /* Name.Constant */
.listingblock .pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
.listingblock .pygments .tok-ni { color: #999999; font-weight: bold } /* Name.Entity */
.listingblock .pygments .tok-ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.listingblock .pygments .tok-nf { color: #0000FF } /* Name.Function */
.listingblock .pygments .tok-nl { color: #A0A000 } /* Name.Label */
.listingblock .pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.listingblock .pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
.listingblock .pygments .tok-nv { color: #19177C } /* Name.Variable */
.listingblock .pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.listingblock .pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
.listingblock .pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
.listingblock .pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
.listingblock .pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
.listingblock .pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
.listingblock .pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
.listingblock .pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
.listingblock .pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
.listingblock .pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.listingblock .pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
.listingblock .pygments .tok-se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.listingblock .pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
.listingblock .pygments .tok-si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.listingblock .pygments .tok-sx { color: #008000 } /* Literal.String.Other */
.listingblock .pygments .tok-sr { color: #BB6688 } /* Literal.String.Regex */
.listingblock .pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
.listingblock .pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
.listingblock .pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
.listingblock .pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
.listingblock .pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
.listingblock .pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
.listingblock .pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Servidores web y PaaS</h1>
<div class="details">
<span id="author" class="author">José Luis Zamora Sánchez</span><br>
<span id="email" class="email">&lt;<a href="mailto:joseluiszamora.jlz@gmail.com">joseluiszamora.jlz@gmail.com</a>&gt;</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Índice de contenidos</div>
<ul class="sectlevel1">
<li><a href="#sesion01">1. Introducción a los servidores de aplicaciones y a WildFly</a>
<ul class="sectlevel2">
<li><a href="#__qu%C3%A9_es_un_servidor_de_aplicaciones">1.1. ¿Qué es un servidor de aplicaciones?</a></li>
<li><a href="#_evoluci%C3%B3n_de_java_enterprise">1.2. Evolución de Java Enterprise</a></li>
<li><a href="#_introducci%C3%B3n_a_wildfly">1.3. Introducción a WildFly</a>
<ul class="sectlevel3">
<li><a href="#_instalaci%C3%B3n_de_wildfly">1.3.1. Instalación de WildFly</a></li>
<li><a href="#_definici%C3%B3n_de_dominio">1.3.2. Definición de dominio</a></li>
<li><a href="#_modos_de_trabajo_de_wildfly">1.3.3. Modos de trabajo de WildFly</a></li>
<li><a href="#_estructura_de_directorios_de_wildfly">1.3.4. Estructura de directorios de WildFly</a></li>
<li><a href="#_creaci%C3%B3n_de_un_usuario_administrador">1.3.5. Creación de un usuario administrador</a></li>
</ul>
</li>
<li><a href="#_herramientas_de_administraci%C3%B3n_de_wildfly">1.4. Herramientas de administración de WildFly</a>
<ul class="sectlevel3">
<li><a href="#_consola_de_administraci%C3%B3n_web">1.4.1. Consola de administración Web</a></li>
<li><a href="#_command_line_interface_cli">1.4.2. Command Line Interface (CLI)</a></li>
<li><a href="#_edici%C3%B3n_manual_de_los_ficheros_de_configuraci%C3%B3n">1.4.3. Edición manual de los ficheros de configuración</a></li>
</ul>
</li>
<li><a href="#_aplicaciones_java_enterprise">1.5. Aplicaciones Java Enterprise</a>
<ul class="sectlevel3">
<li><a href="#_empaquetado_de_aplicaciones">1.5.1. Empaquetado de aplicaciones</a></li>
<li><a href="#_despliegue_de_aplicaciones_en_wildfly">1.5.2. Despliegue de aplicaciones en WildFly</a></li>
</ul>
</li>
<li><a href="#_arquitecturas_basadas_en_microservicios">1.6. Arquitecturas basadas en microservicios</a>
<ul class="sectlevel3">
<li><a href="#_ventajas_de_una_arquitectura_basada_en_microservicios_sobre_una_monol%C3%ADtica">1.6.1. Ventajas de una arquitectura basada en Microservicios sobre una monolítica</a></li>
<li><a href="#_desventajas">1.6.2. Desventajas</a></li>
<li><a href="#_cu%C3%A1ndo_utilizar_microservicios">1.6.3. Cuándo utilizar microservicios</a></li>
<li><a href="#_java_ee_y_los_microservicios">1.6.4. Java EE Y los microservicios</a></li>
<li><a href="#_docker">1.6.5. Docker</a></li>
</ul>
</li>
<li><a href="#_referencias">1.7. Referencias</a></li>
<li><a href="#_ejercicios_de_introducci%C3%B3n_a_los_servidores_de_aplicaciones_y_a_wildfly">1.8. Ejercicios de Introducción a los servidores de aplicaciones y a WildFly</a>
<ul class="sectlevel3">
<li><a href="#_desarrollo_de_un_microservicio_0_3_puntos">1.8.1. Desarrollo de un microservicio  (0.3 Puntos)</a></li>
<li><a href="#_otras_formas_de_despliegue_0_3_puntos">1.8.2. Otras formas de despliegue  (0.3 Puntos)</a></li>
<li><a href="#_virtualizaci%C3%B3n_con_docker_0_6_puntos">1.8.3. Virtualización con Docker (0.6 Puntos)</a></li>
<li><a href="#_entrega">1.8.4. Entrega</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sesion02">2. Administración de recursos en WildFly</a>
<ul class="sectlevel2">
<li><a href="#_fichero_de_configuraci%C3%B3n_del_bootstrap">2.1. Fichero de configuración del Bootstrap</a></li>
<li><a href="#_estructura_de_los_ficheros_de_configuraci%C3%B3n">2.2. Estructura de los ficheros de configuración</a></li>
<li><a href="#_edici%C3%B3n_desde_las_herramientas_de_administraci%C3%B3n">2.3. Edición desde las herramientas de administración</a></li>
<li><a href="#_configuraci%C3%B3n_de_recursos">2.4. Configuración de recursos</a>
<ul class="sectlevel3">
<li><a href="#_configuraci%C3%B3n_de_datasources">2.4.1. Configuración de Datasources</a></li>
<li><a href="#_creaci%C3%B3n_del_datasource_y_los_pool">2.4.2. Creación del Datasource y los pool</a></li>
<li><a href="#_configuraci%C3%B3n_del_contenedor_de_ejb_s">2.4.3. Configuración del contenedor de EJB&#8217;s</a></li>
<li><a href="#_descriptores_de_despliegue">2.4.4. Descriptores de despliegue</a></li>
<li><a href="#_class_loading">2.4.5. Class Loading</a></li>
<li><a href="#_rendimiento">2.4.6. Rendimiento</a></li>
</ul>
</li>
<li><a href="#_referencias_2">2.5. Referencias</a></li>
<li><a href="#_ejercicios_de_administraci%C3%B3n_de_recursos_en_wildfly">2.6. Ejercicios de Administración de recursos en Wildfly</a>
<ul class="sectlevel3">
<li><a href="#_librer%C3%ADa_compartida_de_logs_0_6_puntos">2.6.1. Librería compartida de Logs (0.6 puntos)</a></li>
<li><a href="#_camino_a_eurovisi%C3%B3n_1_punto">2.6.2. Camino a Eurovisión (1 punto)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sesion03">3. Seguridad declarativa en WildFly  (JAAS)</a>
<ul class="sectlevel2">
<li><a href="#_implementaci%C3%B3n_de_la_seguridad_declarativa_en_wildfly">3.1. Implementación de la seguridad declarativa en WildFly</a>
<ul class="sectlevel3">
<li><a href="#_security_domain_y_login_modules">3.1.1. Security Domain y Login Modules</a></li>
<li><a href="#_activaci%C3%B3n_de_la_auditoria_de_seguridad">3.1.2. Activación de la auditoria de seguridad</a></li>
</ul>
</li>
<li><a href="#_administraci%C3%B3n_de_usuarios_y_roless_con_realmdirect">3.2. Administración de usuarios y roless con RealmDirect</a>
<ul class="sectlevel3">
<li><a href="#_realm_personalizado">3.2.1. Realm Personalizado</a></li>
<li><a href="#_configuraci%C3%B3n_de_un_login_module_basado_en_bd">3.2.2. Configuración de un login module basado en BD</a></li>
<li><a href="#_protecci%C3%B3n_de_las_password">3.2.3. Protección de las password</a></li>
<li><a href="#_integraci%C3%B3n_con_un_servidor_ldap_externo">3.2.4. Integración con un servidor LDAP Externo</a></li>
<li><a href="#_login_module_ldapextended">3.2.5. Login module LdapExtended</a></li>
</ul>
</li>
<li><a href="#_role_based_access_control_en_interfaces_de_administraci%C3%B3n">3.3. Role Based Access Control en interfaces de administración</a></li>
<li><a href="#_referencias_3">3.4. Referencias</a></li>
<li><a href="#_ejercicios_de_seguridad_declarativa_en_wildfly">3.5. Ejercicios de seguridad declarativa en WildFly</a>
<ul class="sectlevel3">
<li><a href="#_configuraci%C3%B3n_despliegue_y_alta_de_usuarios_en_wildfly_0_6_puntos">3.5.1. Configuración, despliegue y alta de usuarios en WildFly (0.6 puntos)</a></li>
<li><a href="#_gesti%C3%B3n_de_usuarios_en_base_de_datos_0_3_puntos">3.5.2. Gestión de usuarios en Base de datos (0.3 puntos)</a></li>
<li><a href="#_seguridad_integrada_con_ldap_corporativo_0_3_puntos">3.5.3. Seguridad integrada con LDAP corporativo (0.3 puntos)</a></li>
<li><a href="#_entrega_2">3.5.4. Entrega</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sesion04">4. Certificados digitales y SSL</a>
<ul class="sectlevel2">
<li><a href="#_seguridad_en_la_capa_de_transporte">4.1. Seguridad en la capa de transporte</a>
<ul class="sectlevel3">
<li><a href="#_certificados_digitales">4.1.1. Certificados digitales</a></li>
<li><a href="#_introducci%C3%B3n_a_ssl">4.1.2. Introducción a SSL</a></li>
<li><a href="#_one_way_y_two_way_ssl">4.1.3. One-Way y Two-Way SSL</a></li>
<li><a href="#_creaci%C3%B3n_de_una_ca_ficticia">4.1.4. Creación de una CA ficticia</a></li>
</ul>
</li>
<li><a href="#_referencias_4">4.2. Referencias</a></li>
<li><a href="#_ejercicios_de_certificados_digitales_y_ssl">4.3. Ejercicios de certificados digitales y SSL</a>
<ul class="sectlevel3">
<li><a href="#_encriptaci%C3%B3n_de_las_comunicaciones_one_way_ssl_0_4_puntos">4.3.1. Encriptación de las comunicaciones One-Way SSL (0.4 puntos)</a></li>
<li><a href="#_encriptaci%C3%B3n_de_las_comunicaciones_con_two_way_ssl_0_4_puntos">4.3.2. Encriptación de las comunicaciones con Two-Way SSL (0.4 puntos)</a></li>
<li><a href="#_autenticaci%C3%B3n_de_usuario_a_partir_del_certificado_0_4_puntos">4.3.3. Autenticación de usuario a partir del certificado (0.4 puntos)</a></li>
<li><a href="#_entrega_3">4.3.4. Entrega</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sesion05">5. Introducción a Cloud Computing y a OpenShift</a>
<ul class="sectlevel2">
<li><a href="#__qu%C3%A9_es_cloud_computing">5.1. ¿Qué es Cloud Computing?</a>
<ul class="sectlevel3">
<li><a href="#_computaci%C3%B3n_pre_cloud">5.1.1. Computación Pre-Cloud</a></li>
</ul>
</li>
<li><a href="#__qu%C3%A9_nos_aporta_cloud_computing">5.2. ¿Qué nos aporta Cloud Computing?</a></li>
<li><a href="#_nuevos_conceptos_de_cloud_computing">5.3. Nuevos conceptos de Cloud Computing</a></li>
<li><a href="#_riesgos_de_cloud">5.4. Riesgos de Cloud</a>
<ul class="sectlevel3">
<li><a href="#_qu%C3%A9_opinan_las_empresas_acerca_de_cloud">5.4.1. Qué opinan las empresas acerca de Cloud</a></li>
</ul>
</li>
<li><a href="#_tipos_de_cloud_en_funci%C3%B3n_del_servicio">5.5. Tipos de Cloud en función del servicio</a></li>
<li><a href="#_tipos_de_cloud_en_funci%C3%B3n_del_tipo_de_acceso">5.6. Tipos de Cloud en función del tipo de acceso</a></li>
<li><a href="#_seguridad">5.7. Seguridad</a></li>
<li><a href="#_c%C3%B3mo_elegir_un_proveedor_de_cloud">5.8. Cómo elegir un proveedor de Cloud</a></li>
<li><a href="#_introducci%C3%B3n_a_openshift">5.9. Introducción a OpenShift</a>
<ul class="sectlevel3">
<li><a href="#_lenguajes_y_runtimes_soportados">5.9.1. Lenguajes y runtimes soportados</a></li>
<li><a href="#_versiones_de_openshift">5.9.2. Versiones de OpenShift</a></li>
<li><a href="#_modalidades_de_pago_de_openshift_online">5.9.3. Modalidades de pago de OpenShift Online</a></li>
<li><a href="#_alternativas_a_openshift">5.9.4. Alternativas a OpenShift</a></li>
</ul>
</li>
<li><a href="#_referencias_5">5.10. Referencias</a></li>
<li><a href="#_ejercicios_de_introducci%C3%B3n_a_cloud_computing">5.11. Ejercicios de Introducción a Cloud Computing</a>
<ul class="sectlevel3">
<li><a href="#_despliegue_en_cloud_de_una_aplicaci%C3%B3n_web_1_punto">5.11.1. Despliegue en Cloud de una aplicación web (1 punto)</a></li>
<li><a href="#_importar_el_proyecto_desde_intellij_y_modificar_la_aplicaci%C3%B3n_0_4_puntos">5.11.2. Importar el proyecto desde IntelliJ y modificar la aplicación (0.4 puntos)</a></li>
<li><a href="#_despliegue_de_un_servicio_de_almacenamiento_en_cloud_0_4_puntos">5.11.3. Despliegue de un servicio de almacenamiento en Cloud (0.4 puntos)</a></li>
<li><a href="#_creaci%C3%B3n_de_un_blog_basado_en_wordpress_0_4_puntos">5.11.4. Creación de un blog basado en WordPress (0.4 puntos)</a></li>
<li><a href="#_entrega_4">5.11.5. Entrega</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sesion06">6. Plataforma como Servicio</a>
<ul class="sectlevel2">
<li><a href="#_conceptos_propios_de_openshift">6.1. Conceptos propios de OpenShift</a></li>
<li><a href="#_c%C3%B3mo_funciona_openshift">6.2. Cómo funciona OpenShift</a>
<ul class="sectlevel3">
<li><a href="#_creaci%C3%B3n_de_aplicaciones">6.2.1. Creación de aplicaciones</a></li>
<li><a href="#_a%C3%B1adir_cartridges_de_base_de_datos">6.2.2. Añadir Cartridges de base de datos</a></li>
<li><a href="#_port_forwarding">6.2.3. Port forwarding</a></li>
<li><a href="#_modificaci%C3%B3n_y_despliegue_de_las_aplicaciones">6.2.4. Modificación y despliegue de las aplicaciones</a></li>
<li><a href="#_consulta_de_logs">6.2.5. Consulta de Logs</a></li>
<li><a href="#_borrado_de_aplicaciones">6.2.6. Borrado de aplicaciones</a></li>
<li><a href="#_gesti%C3%B3n_del_dominio">6.2.7. Gestión del dominio</a></li>
</ul>
</li>
<li><a href="#_marketplace">6.3. Marketplace</a></li>
<li><a href="#_monitorizaci%C3%B3n">6.4. Monitorización</a>
<ul class="sectlevel3">
<li><a href="#_herramientas_est%C3%A1ndar_de_monitorizaci%C3%B3n">6.4.1. Herramientas estándar de monitorización</a></li>
<li><a href="#_cartridges_de_terceros">6.4.2. Cartridges de terceros</a></li>
</ul>
</li>
<li><a href="#_referencias_6">6.5. Referencias</a></li>
<li><a href="#_ejercicios_de_plataforma_como_servicio">6.6. Ejercicios de Plataforma como servicio</a>
<ul class="sectlevel3">
<li><a href="#_despliegue_desde_un_repositorio_externo_0_2_puntos">6.6.1. Despliegue desde un repositorio externo (0.2 puntos)</a></li>
<li><a href="#_desarrollo_mixto_local_cloud_0_8_puntos">6.6.2. Desarrollo mixto local/cloud  (0.8 puntos)</a></li>
<li><a href="#_monitorizaci%C3%B3n_de_una_aplicaci%C3%B3n_0_2_puntos">6.6.3. Monitorización de una aplicación (0.2 puntos)</a></li>
<li><a href="#_entrega_5">6.6.4. Entrega</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sesion07">7. Características IaaS+ de OpenShift</a>
<ul class="sectlevel2">
<li><a href="#_introducci%C3%B3n">7.1. Introducción</a></li>
<li><a href="#_configuraci%C3%B3n_avanzada">7.2. Configuración avanzada</a>
<ul class="sectlevel3">
<li><a href="#_ssh">7.2.1. SSH</a></li>
<li><a href="#_variables_de_entorno">7.2.2. Variables de entorno</a></li>
<li><a href="#_uso_de_markers">7.2.3. Uso de Markers</a></li>
<li><a href="#_action_hook_scripts">7.2.4. Action Hook Scripts</a></li>
<li><a href="#_transferencia_de_ficheros">7.2.5. Transferencia de ficheros</a></li>
<li><a href="#_tareas_planificadas_cron">7.2.6. Tareas planificadas (cron)</a></li>
</ul>
</li>
<li><a href="#_almacenamiento_en_disco">7.3. Almacenamiento en disco</a>
<ul class="sectlevel3">
<li><a href="#_si_ya_nos_hemos_quedado_sin_espacio">7.3.1. Si ya nos hemos quedado sin espacio.</a></li>
</ul>
</li>
<li><a href="#_copias_de_seguridad">7.4. Copias de seguridad</a>
<ul class="sectlevel3">
<li><a href="#_deployment_history">7.4.1. Deployment History</a></li>
<li><a href="#_application_snapshots">7.4.2. Application Snapshots</a></li>
</ul>
</li>
<li><a href="#_procedimientos">7.5. Procedimientos</a>
<ul class="sectlevel3">
<li><a href="#_depuraci%C3%B3n_de_aplicaciones">7.5.1. Depuración de aplicaciones</a></li>
<li><a href="#_generar_un_threaddump">7.5.2. Generar un threaddump</a></li>
<li><a href="#_despliegue_manual_de_las_aplicaciones">7.5.3. Despliegue manual de las aplicaciones</a></li>
<li><a href="#_compilaci%C3%B3n_de_proyectos_con_dependencias_propias">7.5.4. Compilación de proyectos con dependencias propias</a></li>
<li><a href="#_despliegue_de_aplicaciones_compiladas_previamente">7.5.5. Despliegue de aplicaciones compiladas previamente.</a></li>
</ul>
</li>
<li><a href="#_referencias_7">7.6. Referencias</a></li>
<li><a href="#_ejercicios_de_caracter%C3%ADsticas_iaas_de_openshift">7.7. Ejercicios de Características IaaS+ de OpenShift</a>
<ul class="sectlevel3">
<li><a href="#_instalaci%C3%B3n_de_forge">7.7.1. Instalación de Forge</a></li>
<li><a href="#_autoescuela">7.7.2. Autoescuela</a></li>
<li><a href="#_despliegue_b%C3%A1sico_de_la_aplicaci%C3%B3n_0_2_punto">7.7.3. Despliegue básico de la aplicación (0.2 punto)</a></li>
<li><a href="#_configuraci%C3%B3n_de_la_aplicaci%C3%B3n_openshift_0_6_puntos">7.7.4. Configuración de la aplicación OpenShift (0.6 puntos)</a></li>
<li><a href="#_uso_de_una_base_de_datos_externa_en_cloud_0_4_puntos">7.7.5. Uso de una base de datos externa en Cloud (0.4 puntos)</a></li>
<li><a href="#_entrega_6">7.7.6. Entrega</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sesion08">8. Integración continua y escalabilidad</a>
<ul class="sectlevel2">
<li><a href="#_escalabilidad">8.1. Escalabilidad</a>
<ul class="sectlevel3">
<li><a href="#_autoescalado_en_openshift">8.1.1. Autoescalado en OpenShift</a></li>
<li><a href="#_definir_una_aplicaci%C3%B3n_como_escalable">8.1.2. Definir una aplicación como escalable</a></li>
<li><a href="#_ajustar_la_configuraci%C3%B3n_de_escalado">8.1.3. Ajustar la configuración de escalado</a></li>
<li><a href="#_monitorizaci%C3%B3n_del_balanceador">8.1.4. Monitorización del balanceador</a></li>
<li><a href="#_configuraci%C3%B3n_de_haproxy">8.1.5. Configuración de HAProxy</a></li>
</ul>
</li>
<li><a href="#_devops">8.2. DevOps</a>
<ul class="sectlevel3">
<li><a href="#_introducci%C3%B3n_2">8.2.1. Introducción</a></li>
<li><a href="#_devops_y_cloud_computing">8.2.2. DevOps y Cloud Computing</a></li>
<li><a href="#_integraci%C3%B3n_continua_ci_con_jenkins">8.2.3. Integración continua (CI) con Jenkins</a></li>
<li><a href="#_como_trabajar_contra_un_repositorio_de_bitbucket">8.2.4. Como trabajar contra un repositorio de Bitbucket</a></li>
<li><a href="#_alternativas_a_jenkins">8.2.5. Alternativas a Jenkins</a></li>
<li><a href="#_deployment_pipeline">8.2.6. Deployment pipeline</a></li>
</ul>
</li>
<li><a href="#_referencias_8">8.3. Referencias</a></li>
<li><a href="#_ejercicios_de_integraci%C3%B3n_continua_y_escalabilidad">8.4. Ejercicios de Integración continua y escalabilidad</a>
<ul class="sectlevel3">
<li><a href="#_despliegue_de_una_aplicaci%C3%B3n_escalable_0_2_puntos">8.4.1. Despliegue de una aplicación escalable (0.2 Puntos)</a></li>
<li><a href="#_prueba_de_estr%C3%A9s_0_4_puntos">8.4.2. Prueba de Estrés ( 0.4 puntos)</a></li>
<li><a href="#_integraci%C3%B3n_continua_0_2_puntos">8.4.3. Integración continua (0.2 puntos)</a></li>
<li><a href="#_pruebas_con_arquillian_0_4_puntos">8.4.4. Pruebas con Arquillian (0.4 puntos)</a></li>
<li><a href="#_entrega_7">8.4.5. Entrega</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="sesion01">1. Introducción a los servidores de aplicaciones y a WildFly</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="__qué_es_un_servidor_de_aplicaciones">1.1. ¿Qué es un servidor de aplicaciones?</h3>
<div class="paragraph">
<p>Un servidor de aplicaciones es una plataforma que implementa los servicios definidos en la especificación de Java Enterprise.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas01/Java_ee72.png" alt="Java ee72" width="66%">
</div>
</div>
<div class="paragraph">
<p>Estos servicios van desde la ejecución de aplicaciones web sencillas, basadas en Servlets/JSP hasta aplicaciones distribuidas con soporte transaccional, basadas en Enterprise Java Beans (EJB) o servicios Web.</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 70%;">
<colgroup>
<col style="width: 71%;">
<col style="width: 14%;">
<col style="width: 14%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Especificación</th>
<th class="tableblock halign-left valign-top">Java EE 6</th>
<th class="tableblock halign-left valign-top">Java EE 7</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Servlet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JavaServer Pages (JSP)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unified Expression Language (EL)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Debugging Support for Other Languages (JSR-45)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JavaServer Pages Standard Tag Library (JSTL)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JavaServer Faces (JSF)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Java API for RESTful Web Services (JAX-RS)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">n/a</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Java API for WebSocket (WebSocket)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">n/a</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Java API for JSON Processing (JSON-P)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">n/a</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Common Annotations for the Java Platform (JSR-250)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enterprise JavaBeans (EJB)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.1 Lite</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.2 Lite</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Java Transaction API (JTA)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Java Persistence API (JPA)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bean Validation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Managed Beans</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interceptors</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contexts and Dependency Injection (CDI)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.1</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">¿Se puede considerar Tomcat un servidor de aplicaciones?</div>
Tomcat implementa un contenedor Web que en su versión 8 cumple las especificaciones Servlet 3.1, JSP 2.3, y EL 3.0 y WebSockets, pero no incluye un contenedor de EJB&#8217;s o da soporte a otras APIs como JMS, por tanto no se puede considerar como un servidor de aplicaciones completo.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Sí que es cierto es que de la combinación de Tomcat con Spring, junto con otras librerías de terceros resulta en algo parecido a un servidor de aplicaciones. Es más, proyectos como Spring Boot o DropWizard permiten integrar dentro de un único fichero, tanto código de aplicación como los servicios que necesita para funcionar.</p>
</div>
<div class="paragraph">
<p>La principal ventaja de un servidor de aplicaciones es que integra todo los componentes necesarios para empezar a trabajar, permitiendo al programador centrarse en lo más importante que es el desarrollo de aplicaciones. Esto no quiere decir que no podamos utilizar las librerías que creamos oportunas, pero el producto ya nos ofrece una solución válida en conjunto.</p>
</div>
<div class="paragraph">
<p>Para un administrador de sistemas también es más sencillo pues al ser un producto estándar, puede trabajar sobre el servidor sin necesidad de conocer los entresijos de las aplicaciones que ejecutan.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">¿Debemos entonces debemos utilizar un servidor de aplicaciones para todo?</div>
No necesariamente, puesto que la administración y configuración de un Tomcat, Jetty u otros servidores es más sencilla, siempre y cuando nuestra aplicación no requiera de servicios más avanzados. Por otra parte si nuestro desarrollo es muy específico puede compensar el invertir tiempo y desarrollar una solución a medida con librerías y/o frameworks alternativos.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Lo que nos debe llevar a pensar en utilizar un servidor de aplicaciones es considerar que cuestiones como la <strong>estandarización, la alta disponibilidad, la monitorización del rendimiento, transaccionalidad y seguridad</strong> son importantes en nuestros desarrollos así como el poder centrarnos en resolver un problema abstrayéndonos de los servicios que vamos a utilizar.</p>
</div>
<div class="paragraph">
<p>La especificación Java EE 7 se publicó en mayo de 2013 pero no es hasta finales de 2015 cuando se puede considerar como instaurada. La propia Oracle certifica su producto comercial WebLogic en Octubre de 2015 y RedHat, a fecha de redacción de estos apuntes aún no ha publicado una versión comercial certificada.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas01/javaee_players.png" alt="javaee players">
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Los más importantes son</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Comerciales: Oracle WebLogic, IBM WebSphere, Red Hat JBoss EAP.</p>
</li>
<li>
<p>Open Source: Oracle GlassFish, RedHat WildFly.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<div class="title">¿Merece la pena pagar por un producto comercial?</div>
<p>Hace unos años la respuesta a esta pregunta era más sencilla, pero hoy en día con la cantidad de información disponible y la madurez de los productos Open Source actuales es complicado el amortizar los costes de licencias, sobre todo en el caso de nuevos desarrollos basados en Java EE 6 o 7.</p>
</div>
</div>
<div class="sect2">
<h3 id="_evolución_de_java_enterprise">1.2. Evolución de Java Enterprise</h3>
<div class="paragraph">
<p>Desde sus inicios, la especificación Java Enterprise ha intentado definir y estandarizar los servicios que una aplicación de negocio necesita, y a lo largo de sus primeras versiones fue añadiendo nuevas tecnologías, si bien el desarrollo de aplicaciones era bastante complejo.</p>
</div>
<div class="paragraph">
<p>Los primeros servidores de aplicaciones de algún modo emulaban el modelo de Mainframe ya conocido en aplicaciones de grandes empresas pero especializado en la ejecución de aplicaciones java y suponían un coste elevado en hardware y licencias.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas01/sun_server.png" alt="sun server">
</div>
</div>
<div class="paragraph">
<p>Esta situación llevó a que surgieran iniciativas como Spring que ofrecían la misma idea de estandarización pero sustentada en contenedores web ligeros, gratuita y sustentada en una gran comunidad de desarrolladores.</p>
</div>
<div class="paragraph">
<p>Proyectos como Spring sirvieron para que, primero Sun y ahora Oracle, entendiesen que el desarrollo debía evolucionar hacía una concepción más sencilla donde el desarrollo fuese lo más cercano posible a la escritura de POJO&#8217;s y los servidores de aplicaciones mucho más ligeros y optimizados. Y por qué no decirlo, se consiguió aceptando como estándar las mejores ideas de los competidores. Esto se consigue sobre todo a partir de la madurez en el mercado de Java EE 6.</p>
</div>
</div>
<div class="sect2">
<h3 id="_introducción_a_wildfly">1.3. Introducción a WildFly</h3>
<div class="paragraph">
<p>WildFly es el nuevo nombre que recibe el servidor de aplicaciones JBoss, desarrollado por Red Hat. Frente a las versiones anteriores (JBoss AS 7.1 y EAP6) presenta las siguientes novedades:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Compatible y optimizado para la JVM de Java SE 7. Esto se traduce en mejoras de rendimiento en Entrada/Salida, políticas de Garbage collector y concurrencia.</p>
</li>
<li>
<p>Certificado para Java EE 7 Web y Full Profile.</p>
</li>
<li>
<p>Roles definidos dentro de los usuarios administradores. Se puede delimitar con mayor detalle las tareas que puede realizar un usuario administrador.</p>
</li>
<li>
<p>Nuevo Servidor Web. Tradicionalmente se utilizaba Tomcat, pero en esta versión se sustituye por Undertow, que proporciona un mayor rendimiento.</p>
</li>
<li>
<p>Mejoras en las herramientas de administración (Consola, línea de comandos).</p>
</li>
<li>
<p>Reducción del número de puertos de escucha a solo 2, puerto de  trabajo y puerto de administración.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Si bien es interesante académicamente poder trabajar con la última especificación de Java EE, Red Hat no ofrece ninguna variante con soporte comercial, por tanto en el mundo de la empresa es más recomendable continuar con una versión anterior ya sea comercial u Open Source.</p>
</div>
<div class="sect3">
<h4 id="_instalación_de_wildfly">1.3.1. Instalación de WildFly</h4>
<div class="paragraph">
<p>La instalación del servidor es muy sencilla. Basta con conectarse a <a href="http://www.wildfly.org" class="bare">http://www.wildfly.org</a> y descargarse un fichero ZIP. Es recomendable establecer la variable de entorno JBOSS_HOME apuntando a la carpeta donde se vaya a descomprimir el servidor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">export JBOSS_HOME=/usr/share/wildfly-8.2.1</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_definición_de_dominio">1.3.2. Definición de dominio</h4>
<div class="paragraph">
<p>Un dominio define un conjunto de propiedades, recursos e instancias de servidores de aplicaciones. La definición de dominios permite flexibilizar y organizar la instalación de servidores de aplicaciones, ya que es posible asignar distintos dominios dentro de un mismo host a distintas organizaciones y administradores. Las aplicaciones y recursos instaladas en un dominio son independientes de los otros dominios. Para permitir que distintos dominios puedan estar en marcha al mismo tiempo, cada dominio utiliza distintos puertos de servicio y administración.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas01/dominio.png" alt="dominio">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_modos_de_trabajo_de_wildfly">1.3.3. Modos de trabajo de WildFly</h4>
<div class="sect4">
<h5 id="_standalone">Standalone</h5>
<div class="paragraph">
<p>Es el modo más sencillo y habitual. Permite ejecutar WildFly como un proceso independiente. Este modo de trabajo no es incompatible con una configuración HA, por lo que podemos tener configurados varios servidores independientes en clúster. Para iniciar WildFly en modo Standalone hay que ejecutar el script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">standalone.sh</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_managed_domain">Managed Domain</h5>
<div class="paragraph">
<p>En este modo se permite iniciar uno o varios servidores de WildFly administrados de forma conjunta desde un único dominio.  La forma de iniciar un dominio WildFly es a través del script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">domain.sh</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Este script iniciará un proceso denominado Host Controller, que se encargará de iniciar los servidores administrados del dominio. El siguiente diagrama describe un dominio WildFly:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas01/DC-HC-Server.png" alt="DC HC Server">
</div>
</div>
<div class="paragraph">
<p>Los conceptos de host y servidor ya los conocemos, pero tenemos nuevos elementos:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Host Controller</dt>
<dd>
<p>Al ejecutar el script <em>domain.sh</em>, se inicia un proceso denominado Host Controller cuya única misión es la de iniciar/parar los distintos servidores que se hayan definido en la máquina. Para ello se comunica con el proceso <em>Domain Controller</em> que definiremos a continuación.</p>
</dd>
<dt class="hdlist1">Domain Controller</dt>
<dd>
<p>Dentro de un dominio debe existir un proceso Host Controller configurado como el Domain Controller, es decir como almacén central de la configuración del dominio. Este proceso será el encargado de gestionar las políticas de administración, de sincronizar dichas políticas con el resto de Host Controllers del dominio</p>
</dd>
<dt class="hdlist1">Server Group</dt>
<dd>
<p>Un server group es un conjunto de instancias que deben ser administradas como si fueran una sola. En una configuración de dominio puede haber uno o varios grupos, y cada servidor de aplicaciones debe ser miembro de un grupo, aún en el caso de que sólo exista un servidor en el dominio. Es responsabilidad del Domain Controller y de los Host Controllers que todos los servidores dentro de un grupo tengan una configuración coherente y los mismos despliegues.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_estructura_de_directorios_de_wildfly">1.3.4. Estructura de directorios de WildFly</h4>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas01/estructura.PNG" alt="estructura">
</div>
</div>
<div class="paragraph">
<p>Las carpetas más importantes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>appclient</strong>: contiene ficheros de configuración y propios del contenedor de aplicaciones clientes.</p>
</li>
<li>
<p><strong>bin</strong>: contiene varios ficheros de configuración de arranque, jboss-client.jar para acceder crear una aplicación cliente Java.</p>
</li>
<li>
<p><strong>domain</strong>: Contiene los ficheros de configuración del modo <em>Managed Domain</em> y datos de ejecución del servidor en este modo.</p>
</li>
<li>
<p><strong>standalone</strong>: Similar la anterior, pero específica del modo <em>Standalone</em>.</p>
</li>
<li>
<p><strong>welcome-content</strong>: Contenido estático de la aplicación web por defecto.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_creación_de_un_usuario_administrador">1.3.5. Creación de un usuario administrador</h4>
<div class="paragraph">
<p>Para poder comenzar a trabajar con WildFly es necesario crear un usuario administrador y para ello utilizaremos el script <em>add-user.sh</em>.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas01/add-user.png" alt="add user">
</div>
</div>
<div class="paragraph">
<p>En este ejemplo, hemos creado el usuario <em>experto</em> como usuario administrador perteneciente al ManagementRealm. Es importante contestar SI a la última pregunta para indicar que el usuario se podrá conectar al domain controller. Se generará una password encriptada que se utilizará a la hora de configurar un dominio de servidores de aplicaciones.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_herramientas_de_administración_de_wildfly">1.4. Herramientas de administración de WildFly</h3>
<div class="sect3">
<h4 id="_consola_de_administración_web">1.4.1. Consola de administración Web</h4>
<div class="paragraph">
<p>Mediante la consola de administración podemos acometer las tareas más básicas de una forma amigable. El puerto de administración habitual es el 9990, y para acceder a la consola basta con abrir la dirección:</p>
</div>
<div class="paragraph">
<p><a href="http://localhost:9990/App.html" class="bare">http://localhost:9990/App.html</a></p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas01/WebConsole.png" alt="WebConsole">
</div>
</div>
<div class="paragraph">
<p>Comparada con la consola de administración de otros servidores como WebLogic o incluso GlassFish es mas rudimentaria, si bien ha mejorado notablemente con respecto a versiones anteriores.</p>
</div>
</div>
<div class="sect3">
<h4 id="_command_line_interface_cli">1.4.2. Command Line Interface (CLI)</h4>
<div class="paragraph">
<p>Se trata de una herramienta de administración desde una pantalla de terminal. A esta consola se accede ejecutando el script <strong>jboss-cli.sh</strong></p>
</div>
<div class="paragraph">
<p>Desde esta consola se puede cambiar la configuración de un servidor local o remoto. Parámetros más importantes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> ./jboss-cli.sh <span class="tok-o">[</span>--help<span class="tok-o">]</span> <span class="tok-o">[</span>--version<span class="tok-o">]</span> <span class="tok-o">[</span>--connect<span class="tok-o">]</span> <span class="tok-o">[</span>--controller<span class="tok-o">]</span> <span class="tok-o">[</span>--commands<span class="tok-o">]</span> <span class="tok-o">[</span>--user<span class="tok-o">]</span> <span class="tok-o">[</span>--password<span class="tok-o">]</span> <span class="tok-o">[</span>--file<span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">--help</dt>
<dd>
<p>Muestra un listado de comandos admitidos</p>
</dd>
<dt class="hdlist1">--version</dt>
<dd>
<p>Muestra información de la versión de WildFly y de la máquina.</p>
</dd>
<dt class="hdlist1">--connect</dt>
<dd>
<p>Comando utilizado para conectarnos al servidor e iniciar su administración</p>
</dd>
<dt class="hdlist1">--controller</dt>
<dd>
<p>Host:puerto al que nos queremos conectar</p>
</dd>
<dt class="hdlist1">--commands</dt>
<dd>
<p>Permite especificar una o varias instrucciones de administración.</p>
</dd>
<dt class="hdlist1">--user/password</dt>
<dd>
<p>Credenciales para conectarse a un servidor, utilizadas normalmente al acceder a un servidor remoto.</p>
</dd>
<dt class="hdlist1">--file</dt>
<dd>
<p>Permite ejecutar un script con múltiples instrucciones de administración.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Ejemplos de uso:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">#</span>Conexión a un servidor <span class="tok-nb">local</span> <span class="tok-o">(</span>localhost:9990<span class="tok-o">)</span>
<span class="tok-go">./jboss-cli.sh --connect</span>

<span class="tok-gp">#</span>Conexión a un host controller remoto
<span class="tok-go">./jboss-cli.sh --connect --controller=192.168.10.1 --user=admin1234 --pasword=pass1234</span>
<span class="tok-gp">#</span>Ejecutar una secuencia de comandos
<span class="tok-go">./jboss-cli.sh --commands=&quot;connect,deploy prueba.jar&quot;</span>
<span class="tok-gp">#</span>Ejecutar un script de administración
<span class="tok-go">./jboss-cli.sh --file=myscript.cli</span>
<span class="tok-gp">#</span>Parar el servidor
<span class="tok-go">./jboss-cli.sh --connect --command=shutdown</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ejemplo de script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">#</span> Connect to Wildfly instance
<span class="tok-go">connect</span>

<span class="tok-gp">#</span> Create Spring Batch Module

<span class="tok-go">module add \</span>
<span class="tok-go">    --name=org.springframework.batch \</span>
<span class="tok-go">    --dependencies=javax.api,javaee.api \</span>
<span class="tok-go">    --resources=${wildfly.module.classpath}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En el caso de que tengamos algún problema con la configuración, que no permita operar normalmente al servidor, podemos recurrir al siguiente comando:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">./standalone.sh --admin-only</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Este comando permite arrancar el servidor en modo administración, bloqueado excepto para tareas administrativas. De esta forma podremos acceder a CLI y corregir la configuración. Una vez hecho esto, podemos salir del modo administración con el siguiente comando:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">[standalone@localhost:9990/]reload --admin-only=false</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Una vez estemos conectados a una instancia de WildFly podemos trabajar directamente sobre la configuración del servidor como si fuera un sistema de ficheros:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas01/jbosscli.png" alt="jbosscli">
</div>
</div>
<div class="paragraph">
<p>Por último, si queremos una interfaz más amigable, podemos ejecutar la consola en modo gráfico:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">./jboss-cli.sh --gui</span></code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas01/jbosscliGUI.png" alt="jbosscliGUI">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_edición_manual_de_los_ficheros_de_configuración">1.4.3. Edición manual de los ficheros de configuración</h4>
<div class="paragraph">
<p>Toda la configuración del servidor persiste en ficheros XML que se pueden editar manualmente. En la siguiente sesión veremos con más detalle la forma en la que WildFly almacena esta configuración pero hay que tener en cuenta que lo recomendable hacer cambios en la configuración mediante las herramientas de administración, sobre todo en servidores de producción.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_aplicaciones_java_enterprise">1.5. Aplicaciones Java Enterprise</h3>
<div class="sect3">
<h4 id="_empaquetado_de_aplicaciones">1.5.1. Empaquetado de aplicaciones</h4>
<div class="paragraph">
<p>Hasta ahora hemos utilizado dos tipos de ficheros para empaquetar aplicaciones Java: ficheros JAR y ficheros WAR. Además de estos tipos hay un tercero específico de las aplicaciones Java Enterprise: el EAR.</p>
</div>
<div class="paragraph">
<p>Los ficheros JAR empaquetan clases Java. Un fichero JAR contiene clases Java compiladas (ficheros .class) junto con un descriptor de la aplicación.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas01/jarwar.png" alt="jarwar">
</div>
</div>
<div class="paragraph">
<p>Cuando un fichero JAR se añade al classpath de una JVM (Máquina Virtual Java) las clases incluidas en él se ponen a disposición de cualquier aplicación Java que ejecute la JVM. De la misma forma, cuando un fichero JAR se define en el classpath del compilador Java, las clases incluidas en él pueden utilizarse en las clases que estamos compilando.</p>
</div>
<div class="paragraph">
<p>Una idea fundamental relacionada con el empaquetado de clases es que el compilador Java y la máquina virtual Java tienen distintos classpath, esto es, resuelven las dependencias utilizando distintos ficheros. Esto trasladado a una aplicación Java Enterprise permite que para compilar una aplicación estándar, únicamente necesitemos una dependencia:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;dependencies&gt;</span>
        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>javax<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>javaee-api<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>7.0<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>provided<span class="tok-nt">&lt;/scope&gt;</span>
		<span class="tok-nt">&lt;/dependency&gt;</span>
<span class="tok-nt">&lt;/dependencies&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El servidor de aplicaciones por su parte contendrá tanto la especificación como las librerías (jars) específicas que implementen la especificación.</p>
</div>
<div class="paragraph">
<p>Las aplicaciones web empaquetadas en ficheros WAR son más complejas puesto que pueden contener recursos estáticos, clases compiladas y librerías Jar. Al desplegar una aplicación web en un servidor de aplicaciones, las librerías contenidas pasan a formar parte del classpath de la aplicación exclusivamente.</p>
</div>
<div class="paragraph">
<p>¿Qué ocurre si queremos utilizar una misma librería en distintas aplicaciones Web desplegadas en un servidor? Si las incluimos en cada aplicación y son pesadas, penalizará el arranque del servidor y elevará el consumo de recursos innecesariamente. Para evitarlo tenemos varias formas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Incluir la librería directamente en el classpath del servidor (¡No recomendado!)</p>
</li>
<li>
<p>Despliegue del jar como <em>librería compartida</em>, en el caso concreto de WildFly sería declararla como módulo global del servidor en ficheros de configuración.</p>
</li>
<li>
<p>Si son aplicaciones relacionadas empaquetarlas dentro de un fichero EAR.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Los ficheros EAR representan una aplicación empresarial formada por distintos módulos (aplicaciones web y ficheros JAR). Los ficheros JAR pueden ser librerías o <em>Enterprise JavaBeans</em> (EJB) usados por las aplicaciones web y estarán disponibles para cualquier aplicación contenida.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas01/ear.png" alt="ear" width="50%">
</div>
</div>
<div class="paragraph">
<p>Otra característica de los EAR es que permite el control unificado (arranque, despliegue, parada&#8230;&#8203;) del conjunto de las aplicaciones contenidas.</p>
</div>
<div class="paragraph">
<p>Físicamente, un fichero EAR es un fichero comprimido con el mismo formato que los ficheros JAR. Todos los comandos que se pueden utilizar con los ficheros JAR (jar -tvf mi-fichero.jar, etc.) sirven para los ficheros EAR. Los ficheros EAR llevan la extensión .ear. La estructura de un fichero EAR es sencilla, contiene un conjunto de ficheros WAR, un conjunto de ficheros JAR y el directorio <em>META-INF</em>, en el que se encuentra los distintos ficheros de configuración necesarios. Opcionalmente puede contener el descriptor de despliegue <em>application.xml</em> en el que se identifican los módulos que se incluyen en él.</p>
</div>
</div>
<div class="sect3">
<h4 id="_despliegue_de_aplicaciones_en_wildfly">1.5.2. Despliegue de aplicaciones en WildFly</h4>
<div class="paragraph">
<p>WildFly nos ofrece tres posibilidades:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Despliegue desde sistema de ficheros (sólo en modalidad standalone).</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">	cp example.war /usr/local/wildfly-8.2.1.Final/standalone/deployments</span></code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Escáner de despliegue</div>
<p>WildFly distingue entre aplicaciones empaquetadas (Jar,War,Ear) o aplicaciones descomprimidas (exploded). Por defecto el autodeploy está habilitado para las aplicaciones empaquetadas pero no para las exploded. En el caso de que el despliegue sea manual, se controla mediante ficheros auxiliares llamados <em>markers</em>. Estos ficheros ficheros también aparecen cuando falla un despliegue por autodeploy (fichero application.FAILED). Si lo eliminamos, el escáner intentará deplegar la aplicación de nuevo.</p>
</div>
<div class="paragraph">
<p>La configuración del escáner de despliegues se realiza sobre el fichero standalone.xml o a través de CLI:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;deployment-scanner</span> <span class="tok-na">scan-interval=</span><span class="tok-s">&quot;5000&quot;</span> <span class="tok-na">relative-to=</span><span class="tok-s">&quot;jboss.server.base.dir&quot;</span>
   <span class="tok-na">path=</span><span class="tok-s">&quot;deployments&quot;</span> <span class="tok-na">auto-deploy-zipped=</span><span class="tok-s">&quot;true&quot;</span> <span class="tok-na">auto-deploy-exploded=</span><span class="tok-s">&quot;false&quot;</span><span class="tok-nt">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para más detalles podéis consultar la documentación de WildFly:  <a href="https://docs.jboss.org/author/display/WFLY8/Application+deployment" class="bare">https://docs.jboss.org/author/display/WFLY8/Application+deployment</a></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Mediante las herramientas de administración</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">[standalone@localhost:9990/]deploy example.war</span></code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas01/deploy.png" alt="deploy">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Uso de herramientas de terceros como por ejemplo wildfly-maven-plugin</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml">		<span class="tok-nt">&lt;plugin&gt;</span>
                <span class="tok-nt">&lt;groupId&gt;</span>org.wildfly.plugins<span class="tok-nt">&lt;/groupId&gt;</span>
                <span class="tok-nt">&lt;artifactId&gt;</span>wildfly-maven-plugin<span class="tok-nt">&lt;/artifactId&gt;</span>
                <span class="tok-nt">&lt;version&gt;</span>1.0.2.Final<span class="tok-nt">&lt;/version&gt;</span>
                <span class="tok-nt">&lt;executions&gt;</span>
                    <span class="tok-nt">&lt;execution&gt;</span>
                        <span class="tok-nt">&lt;phase&gt;</span>install<span class="tok-nt">&lt;/phase&gt;</span>
                        <span class="tok-nt">&lt;goals&gt;</span>
                            <span class="tok-nt">&lt;goal&gt;</span>deploy<span class="tok-nt">&lt;/goal&gt;</span>
                        <span class="tok-nt">&lt;/goals&gt;</span>
                    <span class="tok-nt">&lt;/execution&gt;</span>
                <span class="tok-nt">&lt;/executions&gt;</span>
            <span class="tok-nt">&lt;/plugin&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">	[standalone@localhost:9990/]mvn wildfly:deploy</span>
<span class="tok-go">	[standalone@localhost:9990/]mvn wildfly:redeploy</span>
<span class="tok-go">	[standalone@localhost:9990/]mvn wildfly:undeploy</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Ejecutar aplicacion sin instalación previa de WildFly <em>wildfly:run</em></div>
Es una función interesente del plugin de maven de cara a realizar pruebas o ejecutar la aplicación en una máquina donde no tenemos configurada ninguna instancia de WildFly. Este comando Maven descarga automáticamente un servidor WildFly en modo standalone y despliega en el la aplicación compilada.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_arquitecturas_basadas_en_microservicios">1.6. Arquitecturas basadas en microservicios</h3>
<div class="paragraph">
<p><em>Una arquitectura basada en microservicios es una forma de entender las aplicaciones como un conjunto de pequeños servicios, cada uno ejecutándose como proceso independiente y comunicándose con el resto mediante mecanismos sencillos y "agnósticos", a menudo HTTP. Estos servicios se diseñan sobre funciones de negocio y siguen estrategias de de despliegue independientes. Aunque se trate de servicios independientes suele existir una pequeña lógica de administración común para estos servicios, que pueden estar construidos usando distintos lenguajes de programación y diferentes tecnologías de almacenamiento.</em></p>
</div>
<div class="paragraph">
<p><em>Martin Fowler (padre del término microservicio)</em></p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas01/micro1.png" alt="micro1" width="66%">
</div>
</div>
<div class="paragraph">
<p>Este tipo de arquitectura nace en contraposición a las grandes aplicaciones <em>Monolíticas</em>. En el mundo Java, una aplicación monolítica podría ser un EAR con una serie de módulos y librerías dependientes que se gestiona como una unidad. En si mismo ésto no tiene porqué ser un problema (sigue siendo un modelo válido) hasta que la propia envergadura del proyecto o la dificultad para alcanzar requerimientos de escalabilidad o separación de responsabilidades evidencíen dificultades de gestión. En cierta medida microservicios trata más de organización del trabajo que de tecnologías concretas.</p>
</div>
<div class="paragraph">
<p>También hay que destacar que el término de "micro" no se refiere al tamaño del servicio si no a la funcionalidad que desempeña. Para definir correctamente un microservicio hay que apoyarse en buenas prácticas de programación ya establecidas como la alta cohesión y bajo acoplamiento o el Principio de Responsabilidad Única (Un subsistema, módulo o incluso clase sólo debe tener un motivo para cambiar).</p>
</div>
<div class="paragraph">
<p>Se podría entender como un SOA 2.0 (Arquitectura Orientada a Servicios) o un SOA pragmático donde se sustituyen protocolos pesados como SOAP y elementos como ESB&#8217;s donde se ejecutaba gran cantidad de lógica por servicios donde la inteligencia está en el propio servicio y no existe un control y persistencia centralizados.</p>
</div>
<div class="sect3">
<h4 id="_ventajas_de_una_arquitectura_basada_en_microservicios_sobre_una_monolítica">1.6.1. Ventajas de una arquitectura basada en Microservicios sobre una monolítica</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">Facilidad para escalar el desarrollo</dt>
<dd>
<p>Permite dividir el trabajo entre equipos de trabajo reducidos, con conocimientos completos del stack de desarrollo y con una responsabilidad funcional acotada. (Two Pizza teams)</p>
</dd>
<dt class="hdlist1">Aislamiento ante fallos</dt>
<dd>
<p>Si un servicio tiene un fallo, es factible corregir dicho servicio y desplegarlo individualmente sin afectar al resto de la aplicación.</p>
</dd>
<dt class="hdlist1">Despliegues más rápidos</dt>
<dd>
<p>Poder desplegar por partes facilita el poder realizar despliegues a producción más frecuentes y con un riesgo menor.</p>
</dd>
<dt class="hdlist1">Elimina la dependencia a largo plazo de una tecnología</dt>
<dd>
<p>El utilizar mecanismo de comunicación agnósticos, permite que podamos utilizar la tecnología más adecuada para cada servicio, en contraposición al modelo de EAR donde se elige un único "stack" para toda la aplicación. Si en un momento decidimos cambiar de tecnología, podemos ir reemplazando paulatinamente los servicios afectados.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_desventajas">1.6.2. Desventajas</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">Complejidad de un sistema distribuido</dt>
<dd>
<p>Servicios independientes requieren una monitorización independiente, recursos de ejecución adicionales, herramientas de descubrimiento, gestión de logs&#8230;&#8203; en definitiva costes y complejidad adicionales a las de un proyecto monolítico.</p>
</dd>
</dl>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas01/deathstar.png" alt="deathstar">
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Requieren cultura DevOps</dt>
<dd>
<p>Las iniciativas DevOps permiten automatizar los procesos de validación y despliegue de los nuevos servicios y allanar las dificultades anteriores. Comentaremos con más detalle qué es DevOps en sesiones posteriores.</p>
</dd>
<dt class="hdlist1">Falta de herramientas</dt>
<dd>
<p>Las herramientas tradicionales están orientados a desarrollos monolíticos y no tanto a proyectos complejos distribuidos.</p>
</dd>
<dt class="hdlist1">Comunicación y coordinación entre equipos</dt>
<dd>
<p>Si bien gestionar un equipo grande es complejo, el coordinar y compartir conocimiento entre equipos independientes también plantea retos.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_cuándo_utilizar_microservicios">1.6.3. Cuándo utilizar microservicios</h4>
<div class="paragraph">
<p>Según Martin Fowler no se debería considerar una arquitectura basada en microservicios hasta tener un sistema monolítico que sea demasiado complejo de mantener. Nosotros añadiríamos otro motivo: cuando las necesidades de escalabilidad del trabajo lo justifiquen o se necesite utilizar distintas tecnologías en distintas funciones de negocio.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas01/productivity.png" alt="productivity" width="66%">
</div>
</div>
<div class="paragraph">
<p>Para un desarrollo ya existente, un enfoque muy aceptado es asegurar en primer lugar una que tenemos una aplicación monolítica correcta en términos de arquitectura:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Separación de funciones.</p>
</li>
<li>
<p>Alta cohesión y bajo acoplamiento utilizando APIs bien definidas.</p>
</li>
<li>
<p>Sin redundancias.</p>
</li>
<li>
<p>Diseño dirigido por el Dominio (DDD).</p>
</li>
<li>
<p>Lo demás "sobra".</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>De forma progresiva, se puede ir identificando las distintas funciones de negocio y separarlas en serivicios siguiendo el <em>principio de responsabilidad única</em> (SPR). Una vez definidos los servicios más básicos, las aplicaciones harán uso de ellos combinándolos según diferentes patrones (Ver referencias).</p>
</div>
<div class="paragraph">
<p>Una vez definidos los servicios básicos las aplicaciones harán uso de ellos combinándolos siguiendo distintos patrones:</p>
</div>
</div>
<div class="sect3">
<h4 id="_java_ee_y_los_microservicios">1.6.4. Java EE Y los microservicios</h4>
<div class="paragraph">
<p>El estado de evolución actual de la especificación Java EE permite afrontar el desarrollo de aplicaciones basados en nuevas arquitecturas. Hoy en día, es razonable utilizar un servidor de aplicaciones para desplegar un único servicio basado en Java EE sin incurrir en un consumo excesivo de recursos y beneficiándonos de años de estandarización y una amplia gama de servicios.</p>
</div>
<div class="paragraph">
<p>En cifras, usar un servidor de aplicaciones completo hoy en día puede suponer un sobrecoste de unos 30-50Mb de RAM sobre una aplicación java standalone , así como unos 100Mb de espacio en disco y el tiempo de arranque puede ser de 1-3 segundos de tiempo. En una aplicación empresarial con un número de servicios limitado esto no supone un problema. De hecho, resulta curioso ver cómo se ha ido reduciendo el consumo de recursos en la parte servidora y sin embargo hemos sobrepasado el consumo de las aplicaciones de escritorio pesadas en el lado del cliente (Vease Chrome, por ejemplo).</p>
</div>
<div class="paragraph">
<p>Sólo en el caso de aplicaciones altamente escalables y orientadas a internet (al nivel de Google, Netflix, etc.), merece la pena invertir esfuerzos en reducir al máximo las librerías necesarias para que un servicio funcione. Aún así puede ser más ventajoso aprovechar la modularidad de los servidores de aplicaciones que construir una solución desde cero.</p>
</div>
<div class="paragraph">
<p>Hay ponentes como Adam Bien que plantean un modelo minimalista de aplicación Java EE con las siguientes características:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">1 servidor de aplicaciones, 1 dominio y 1 WAR</dt>
<dd>
<p>El concepto de servicio quedaría constituido por un servidor de aplicaciones que ofrezca todo el API Java EE (Full Profile) a una aplicación desplegada como WAR que implemente un servicio.</p>
</dd>
<dt class="hdlist1">WARs ligeras</dt>
<dd>
<p>El tamaño de un fichero WAR y su complejidad interna influye negativamente en los tiempos de despliegue y arranque de una aplicación. Para conseguir mejores resultados Adam Bien propone los siguientes cambios sobre el modelo de desarrollo de aplicaciones Web:</p>
<div class="ulist">
<ul>
<li>
<p>Utilizar preferentemente las librerías que proporciona el servidor de aplicaciones, en lugar de incluirlas en la aplicación. Esto ya puede suponer pasar de trabajar con un fichero de varios megabytes a unos pocos Kilobytes.</p>
</li>
<li>
<p>Aplicaciones Autocontenidas: toda la lógica del servicio debe estar incluida dentro del War.</p>
</li>
<li>
<p>Reducir o eliminar los módulos JAR internos. Ya hemos comentado que es habitual trabajar con aplicaciones WAR que contienen a su vez librerías JAR con clases diversas y EJB&#8217;s. Este esquema ralentiza las compilaciones y despliegues y en realidad la aplicación siempre se compila o despliega como un todo, por lo que la división interna en librerías no aporta ventajas en muchos casos.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Estructura del código</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>No utilizar interfaces. Únicamente los utilizaremos cuando sepamos que vamos a tener diferentes implementaciones para una misma funcionalidad, pero hasta entonces no complicar el código innecesariamente.</p>
</li>
<li>
<p>Centrarnos en el código de negocio. Java EE permite que las aplicaciones estén compuestas básicamente por POJOS y permite abstraer la complejidad de los servicios. El trabajar con objetos pojo tiene el beneficio adicional de facilitar las pruebas unitarias</p>
</li>
<li>
<p>Pocas anotaciones (Convención sobre declaración): Evitar declarar propiedades que ya tengan el mismo valor por defecto dentro de su especificación.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Ejemplo de microservicio <em>minimalista</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Path</span><span class="tok-o">(</span><span class="tok-s">&quot;cursos&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">CursosResource</span> <span class="tok-o">{</span>

    <span class="tok-nd">@GET</span>
    <span class="tok-nd">@Produces</span><span class="tok-o">(</span><span class="tok-s">&quot;application/json&quot;</span><span class="tok-o">)</span>
    <span class="tok-kd">public</span> <span class="tok-n">JsonObject</span> <span class="tok-nf">all</span><span class="tok-o">(){</span>
        <span class="tok-k">return</span> <span class="tok-n">Json</span><span class="tok-o">.</span><span class="tok-na">createObjectBuilder</span><span class="tok-o">().</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-s">&quot;cursos&quot;</span><span class="tok-o">,</span><span class="tok-s">&quot;JavaEE, JavaScript, MongoDB&quot;</span><span class="tok-o">).</span><span class="tok-na">build</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>

<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_docker">1.6.5. Docker</h4>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas01/Docker_logo.png" alt="Docker logo">
</div>
</div>
<div class="paragraph">
<p>Docker ha supuesto el salto a la fama del concepto de <em>contenerización</em> de servicios y viene a ser una mezcla de máquina virtual con control de versiones tipo Subversion. Permite desplegar todo el stack de una aplicación o servicio en una máquina con un simple comando <em>pull</em> como si fuera un único paquete. Se apoya los conceptos básicos de <em>imagen</em> y <em>contenedor</em>:</p>
</div>
<div class="paragraph">
<p>Una <strong>imagen</strong> se puede considerar como un sistema de archivos en el que podemos añadir lo que la aplicación necesite para funcionar, como una máquina virtual de Java o la instalación de un servidor de aplicaciones. Una característica fundamental es que está formado por capas, que funcionan como los <em>commit</em> de Git o SVN. Cada vez que se añade una capa, se superponen nuevos ficheros sobre la imagen inicial. En este caso es fundamental dejar en la última capa el despliegue de la aplicación para que cuando ésta se modifique, la imagen conserve todas sus capas y sustituya únicamente la última (que tendrá el tamaño del WAR desplegado). Aquí tenemos una importante mejor en el caso de las aplicaciones Java ligeras que proponemos, especialmente si la comparamos con las basadas en Java StandAlone (o FAT Jars).</p>
</div>
<div class="paragraph">
<p>Llamamos <strong>contenedor</strong> a la instancia en ejecución de una imagen. Apoyándose en los mecanismos de seguridad de Linux, el container se ejecuta en un espacio de memoria separado, con lo que es tarea del programador el definir la comunicación entre los procesos del container y el resto de la máquina (gestionando los puertos o montando directorios físicos fundamentalmente). Hay que tener siempre presente que cada vez que se inicia un contenedor, se parte de la imagen definida por lo que cualquier cambio que se realice sobre el sistema de ficheros propio del contenedor NO se almacenará en la imagen y por tanto se perderá.</p>
</div>
<div class="paragraph">
<p>Entender Docker es mucho más sencillo en la práctica, así que en los ejercicios veremos un pequeño ejemplo.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_referencias">1.7. Referencias</h3>
<div class="ulist">
<ul>
<li>
<p>Información sobre Roles Java EE <a href="http://docs.oracle.com/javaee/6/tutorial/doc/bnaca.html" class="bare">http://docs.oracle.com/javaee/6/tutorial/doc/bnaca.html</a> .</p>
</li>
<li>
<p>Wiki con los distintos servidores de aplicaciones y sus especificaciones <a href="http://en.wikipedia.org/wiki/Java_Platform,_Enterprise_Edition" class="bare">http://en.wikipedia.org/wiki/Java_Platform,_Enterprise_Edition</a> .</p>
</li>
<li>
<p>Información sobre WildFly <a href="http://wildfly.org/about/" class="bare">http://wildfly.org/about/</a> .</p>
</li>
<li>
<p>Guia de iniciación <a href="https://docs.jboss.org/author/display/WFLY8/Getting+Started+Guide" class="bare">https://docs.jboss.org/author/display/WFLY8/Getting+Started+Guide</a> .</p>
</li>
<li>
<p>Guía completa de administración <a href="https://docs.jboss.org/author/display/WFLY8/Admin+Guide#AdminGuide-Examplesinthisguide" class="bare">https://docs.jboss.org/author/display/WFLY8/Admin+Guide#AdminGuide-Examplesinthisguide</a> .</p>
</li>
<li>
<p>Despliegues desde sistema de ficheros <a href="https://docs.jboss.org/author/display/WFLY8/Application+deployment" class="bare">https://docs.jboss.org/author/display/WFLY8/Application+deployment</a></p>
</li>
<li>
<p>WildFly Maven Plugin <a href="https://docs.jboss.org/wildfly/plugins/maven/latest/index.html" class="bare">https://docs.jboss.org/wildfly/plugins/maven/latest/index.html</a></p>
</li>
<li>
<p>Java EE 7 Examples <a href="https://github.com/javaee-samples/javaee7-samples" class="bare">https://github.com/javaee-samples/javaee7-samples</a></p>
</li>
<li>
<p>Spring Boot <a href="http://projects.spring.io/spring-boot/" class="bare">http://projects.spring.io/spring-boot/</a></p>
</li>
<li>
<p>Dropwizard <a href="http://www.dropwizard.io/" class="bare">http://www.dropwizard.io/</a></p>
</li>
<li>
<p>WildFly Swarm <a href="http://wildfly.org/swarm/" class="bare">http://wildfly.org/swarm/</a></p>
</li>
<li>
<p>Payara <a href="http://www.payara.co.uk/about" class="bare">http://www.payara.co.uk/about</a></p>
</li>
<li>
<p>WAS Liberty <a href="https://developer.ibm.com/wasdev/" class="bare">https://developer.ibm.com/wasdev/</a></p>
</li>
<li>
<p>Desarrollo con WildFly y Docker <a href="http://tools.jboss.org/blog/2015-03-03-docker-and-wildfly-2.html" class="bare">http://tools.jboss.org/blog/2015-03-03-docker-and-wildfly-2.html</a></p>
</li>
<li>
<p>Introducción a los microservicios <a href="http://microservices.io/patterns/microservices.html" class="bare">http://microservices.io/patterns/microservices.html</a></p>
</li>
<li>
<p>Patrones de diseño para microservicios <a href="http://blog.arungupta.me/microservice-design-patterns/" class="bare">http://blog.arungupta.me/microservice-design-patterns/</a></p>
</li>
<li>
<p>Docker <a href="https://www.docker.com/" class="bare">https://www.docker.com/</a></p>
</li>
<li>
<p>Simulador online de Docker <a href="http://dockersim.com/" class="bare">http://dockersim.com/</a></p>
</li>
<li>
<p>Docker Maven plugin <a href="https://github.com/spotify/docker-maven-plugin/tree/master" class="bare">https://github.com/spotify/docker-maven-plugin/tree/master</a></p>
</li>
<li>
<p>ECB Model <a href="http://www.cs.sjsu.edu/~pearce/modules/patterns/enterprise/ecb/ecb.htm" class="bare">http://www.cs.sjsu.edu/~pearce/modules/patterns/enterprise/ecb/ecb.htm</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios_de_introducción_a_los_servidores_de_aplicaciones_y_a_wildfly">1.8. Ejercicios de Introducción a los servidores de aplicaciones y a WildFly</h3>
<div class="paragraph">
<p>Al ser los primero ejercicios del módulo de PaaS debéis hacer un fork del repositorio <em>ejercicios_paas</em>. En el debéis almacenar todos los ejercicios del módulo Servidores Web y PaaS independientemente de que luego en IntelliJ se gestionen en proyectos separados. De hecho, en las sesiones OpenShift trabajaremos con repositorios Git independientes por aplicación.</p>
</div>
<div class="paragraph">
<p>Además de este repositorio, tenéis los ejemplos de cada sesión dentro de la carpeta <em>ejemplos</em> del mismo repositorio, por si queréis probarlos con más detalle.</p>
</div>
<div class="sect3">
<h4 id="_desarrollo_de_un_microservicio_0_3_puntos">1.8.1. Desarrollo de un microservicio  (0.3 Puntos)</h4>
<div class="paragraph">
<p>Partiendo de que ya habéis trabajado con WildFly en sesiones anteriores vamos a centrarnos en el desarrollo de una aplicación Java EE, de nombre <em>cursos</em>, que sirva para practicar los distintos tipos de despliegue que admite el servidor tanto como instalación local como virtualizada a partir de una imagen de Docker.</p>
</div>
<div class="paragraph">
<p>Para crear el proyecto utilizaremos Maven y un arquetipo elaborado por Adam Bien, que ofrece una aplicación web similar al arquetipo estándar <em>webapp-javaee7</em> pero con una única dependencia que permite referenciar todo el API de Java EE. Básicamente es un proyecto web minimalista con todo lo necesario para desarrollar.</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 70%;">
<colgroup>
<col style="width: 42%;">
<col style="width: 42%;">
<col style="width: 14%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">GroupID</th>
<th class="tableblock halign-left valign-top">Artefacto</th>
<th class="tableblock halign-left valign-top">Versión</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.airhacks</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">javaee7-essentials-archetype</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.3</p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="_pasos_a_seguir">Pasos a seguir</h5>
<div class="paragraph">
<p>1.- Crearemos un nuevo módulo Maven dentro del proyecto de ejercicios a partir de este arquetipo y lo denominaremos cursos. Las propiedades completas del nuevo artefacto serán:</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 70%;">
<colgroup>
<col style="width: 42%;">
<col style="width: 42%;">
<col style="width: 14%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">GroupID</th>
<th class="tableblock halign-left valign-top">Artefacto</th>
<th class="tableblock halign-left valign-top">Versión</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.expertojava.paas</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">cursos</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.0</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Por último indicaremos que el nuevo módulo dentro de IntelliJ se llamará <em>cursos</em> así como el directorio dentro del proyecto principal.</p>
</div>
<div class="paragraph">
<p>2.- Renombraremos el paquete <em>com.airhacks</em> del proyecto generado a <em>es.ua.expertojava.paas.cursos</em> mediante la herramienta <em>Refactor</em> de IntelliJ. Tambien eliminaremos el paquete <em>com</em> que queda vacío tras el proceso anterior.</p>
</div>
<div class="paragraph">
<p>3.- Dentro del repositorio de ejercicios hay una carpeta <em>sesion1</em> con subcarpetas de nombre: boundary, control y entity. Debéis copiar las tres carpetas a dentro de la carpeta es/ua/expertojava/paas/cursos/ del proyecto. Al hacerlo IntelliJ automáticamente importará las clases Java contenidas en dichas carpetas. La estructura del proyecto debe quedar de la siguiente forma:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas01/ejer1.png" alt="ejer1">
</div>
</div>
<div class="paragraph">
<p>Lo que estamos haciendo es dividir una funcion de negocio "cursos" en tres paquetes distintos con diferentes cometidoas:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Boundary</dt>
<dd>
<p>Contiene las clases que definen la interfaz entre la función de negocio y el exterior.</p>
</dd>
<dt class="hdlist1">Control</dt>
<dd>
<p>Son las clases que definen la ejecución del servicio e interactuan con las otras dos capas.</p>
</dd>
<dt class="hdlist1">Entity</dt>
<dd>
<p>Son las clases que gestionan elementos de información persistentes, de mayor o menor granularidad pero con significado propio.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Esta forma de trabajar se llama patrón Entity-Control-Boundary y es una variación del MVC orientado a servicios.</p>
</div>
<div class="paragraph">
<p>4.- Añadir la unidad de persistencia al proyecto. Para ello basta con copiar la carpeta META-INF del directorio <em>sesion1</em> a la ruta /src/main/resources del proyecto.</p>
</div>
<div class="paragraph">
<p>5.- Crear la configuración de despliegue en IntelliJ para poder desplegar la aplicación en nuestra instancia de WildFly.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Si la configuración de ejecución os muestra un mensaje de error indicando que no está definida la versión del JDK a utilizar, ésta se puede establecer desde File-&#8594; Project Structure -&#8594; Project JDK. En nuestro caso trabajaremos con JDK 1.8.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>6.- Una vez desplegada la aplicación comprobar que funciona correctamente mediante la herramienta <em>curl</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">#</span>Dar de alta un curso
<span class="tok-go">curl -H &quot;Content-Type: application/json&quot; -X POST -d &#39;{&quot;nombre&quot;:&quot;Curso de prueba&quot;}&#39; http://localhost:8080/cursos/resources/cursos</span>

<span class="tok-gp">#</span>Obtener la lista de curso almacenada
<span class="tok-go">curl -X GET http://localhost:8080/cursos/resources/cursos</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>7.- Realizar el undeploy desde IntelliJ</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas01/undeploy.png" alt="undeploy">
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_otras_formas_de_despliegue_0_3_puntos">1.8.2. Otras formas de despliegue  (0.3 Puntos)</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Indicar en el fichero <strong>soluciones.txt</strong>, dentro de vuestro proyecto de <em>ejercicios_paas</em>, los pasos a seguir para realizar las siguientes tareas:</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Desplegar la aplicación mediante Autodeploy.</p>
</li>
<li>
<p>Desplegar la aplicación mediante CLI.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Crear un script de CLI, de nombre <strong>script.cli</strong>, que liste las aplicaciones desplegadas, elimine la aplicación cursos.war y que pare el servidor.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_virtualización_con_docker_0_6_puntos">1.8.3. Virtualización con Docker (0.6 Puntos)</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Nota</div>
Este ejercicio será una demostración <em>guiada</em> para que os familiaricéis con Docker, y sentar las bases para quien quiera profundizar más en el tema.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La principal diferencia entre una aplicación desplegada en una máquina virtual con respecto a Docker es que el conjunto de capas sobre las que se apoya la aplicación es más reducido:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas01/vmvscontainer.png" alt="vmvscontainer">
</div>
</div>
<div class="paragraph">
<p>Los contenedores se ejecutan en el espacio de memoria del Sistema operativo Host (debidamente aislados) y no requieren disponer de un sistema de archivos tan complejo como el de un sistema operativo, si no que puede apoyarse en las herramientas específicas necesarias. El resultado es que trabajamos con imágenes más pequeñas y tiempos de arranque mucho más rápidos. También hay que recordar que las imágenes están compuestas por capas apiladas por lo que un cambio en la aplicación desplegada puede suponer sustituir una sola capa, si la imagen está bien estructurada (si se tiene que modificar una capa intermedia, se reemplazan todas las capas dependientes).</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas01/docker-layered-filesystem.png" alt="docker layered filesystem" width="50%">
</div>
</div>
<div class="paragraph">
<p>La composición en capas de una imagen se define paso a paso en un fichero denominado <em>Dockerfile</em>. Un ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">FROM jboss/wildfly:8.2.1.Final</span>
<span class="tok-go">MAINTAINER José Luis Zamora Sánchez joseluiszamora@jlz.gmail.com</span>
<span class="tok-go">EXPOSE 8080 9990</span>
<span class="tok-go">RUN /opt/jboss/wildfly/bin/add-user.sh expertojava expertojava --silent</span>
<span class="tok-go">COPY target/cursos.war /opt/jboss/wildfly/standalone/deployments/</span>
<span class="tok-go">CMD [&quot;/opt/jboss/wildfly/bin/standalone.sh&quot;, &quot;-b&quot;, &quot;0.0.0.0&quot;, &quot;-bmanagement&quot;,&quot;0.0.0.0&quot;]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lo primero que se indica es la capa base que vamos a utilizar, y para ello podemos utilizar una imagen que ya tengamos instalada, o bien una imagen que nos descarguemos de un repositorio. El repositorio por defecto de Docker es <strong>Docker-Hub</strong>, con un planteamiento muy similar a Git Hub. En este repositorio es donde se suelen publicar las imágenes oficiales de todos los proyectos Open Source.</p>
</div>
<div class="paragraph">
<p>También debemos indicar quien será el responsable mantener esta imagen y cómo contactar con él.</p>
</div>
<div class="paragraph">
<p>La comunicación entre el contenedor y el sistema operativo host se realiza mediante conexiones de red, de forma muy similar a otras soluciones como VirtualBox, si bien la definición se realiza en dos partes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Desde el fichero Dockerfile donde se indica que puertos serán accesibles desde el exterior con el comando EXPOSE.</p>
</li>
<li>
<p>Al iniciar el contenedor donde podemos mapear puertos del Host con puertos del contenedor.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A continuación veréis una serie de comandos que realizan operaciones sobre el sistema de archivos como RUN, COPY que realmente se ejecutan en el momento de generar la imagen, no al iniciarse. Es importante indicar que cada línea del fichero Dockerfile supone una capa, por lo que si agrupamos varios comandos en una línea, físicamente se agruparán en una capa. Si os fijáis, con el comando RUN estamos definiciendo quien será el usuario administrador de la instancia de WildFly.</p>
</div>
<div class="paragraph">
<p>Esto es muy útil, por ejemplo, si copiamos un fichero ZIP con un servidor de aplicaciones, lo descomprimimos y lo eliminamos en la misma fila. Si lo hacemos así, sólo se almacenarán las diferencias, es decir la nueva carpeta descomprimida del servidor. Si lo hacemos paso a paso, tendremos una capa intermedia con el ZIP completo, que tendremos que descargar para luego eliminarlo en capas posteriores.</p>
</div>
<div class="paragraph">
<p>Por último, con el comando CMD estamos indicando qué se tiene que ejecutar por defecto al iniciar un contenedor.</p>
</div>
<div class="sect4">
<h5 id="_cliente_docker">Cliente docker</h5>
<div class="paragraph">
<p>Para trabajar con imágenes y contenedores, necesitamos una herramienta cliente, y en nuestro caso es el comando <em>docker</em>. En este enlace tenéis una "chuleta" con comandos útiles para trabajar con imágenes y con contenedores:</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/javaee-samples/docker-java/blob/master/chapters/docker-commands.adoc" class="bare">https://github.com/javaee-samples/docker-java/blob/master/chapters/docker-commands.adoc</a></p>
</div>
</div>
<div class="sect4">
<h5 id="_objetivos">Objetivos</h5>
<div class="paragraph">
<p>Vamos a crear una imagen independiente que despliegue nuestro servicio, para ello seguiremos los siguientes pasos:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Abrir una cuenta gratuita en Docker Hub</p>
<div class="paragraph">
<p>La idea es que vuestra imagen quede publicada y que nosotros podamos validarla directamente a partir del repositorio, con lo que debéis acceder a la página de Docker Hub y registraros como usuarios. Posteriormente configuraréis vuestro cliente de Docker para que se conecte a Docker Hub utilizando vuestra cuenta:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">expertojava@expertojava:~/IdeaProjects/cursos$</span> docker login

<span class="tok-go">Username: &lt;vuestro usuario&gt;</span>
<span class="tok-go">Password:</span>
<span class="tok-go">Email: &lt;vuestro correo&gt;</span>
<span class="tok-go">WARNING: login credentials saved in /home/expertojava/.docker/config.json</span>
<span class="tok-go">Login Succeeded</span></code></pre>
</div>
</div>
</li>
<li>
<p>Simular cómo se actualizaría y desplegaría un servicio en producción:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">docker run -it --name=miservicio -p 8080:8080 -p 9990:9990 djbyte1977/wildfly  # Para crear un nuevo contenedor</span>
<span class="tok-go">docker pull djbyte1977/wildfly # Para actualizar la imagen</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Con estos comandos os descargaréis la última versión de la imagen wildfly de ejemplo que hemos preparado con la aplicación cursos.war ya desplegada y preparada para funcionar. También estamos mapeando los puertos 8080 y 9090 con sus equivalentes en el contenedor. El fichero Dockerfile utilizado para crear esta imagen es el que tenéis de ejemplo, por lo que si se modifica la aplicación cursos.war no tendreis que volver a descargar las capas anteriores (WildFly base + creación del usuario administrador).</p>
</div>
<div class="paragraph">
<p>El comando <em>run -it</em> crea un contenedo con el servidor de aplicaciones en modo interactivo, por lo que será análogo a lanzar un servidor directamente desde un CMD. Alternativamente sería posible lanzarlo en background con el comando:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">docker run -d --name=miservicio -p 8080:8080 -p 9990:9990 djbyte1977/wildfly</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El comando run realmente crea y ejecuta un contenedor por lo que si se ha usado previamente y se ha especificado un nombre, en la siguiente ejecución nos dará un error indicando que ya existe un contenedor con ese nombre .Una vez ya se ha asignado un nombre al contenedor se puede ejecutar simplemente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">docker start miservicio    #-i modo interactivo</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para enumerar los contenedores existentes tenemos el comando:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">docker ps    # Lista los controles en ejecución</span>
<span class="tok-go">docker ps -a # Lista todos los controles</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Una vez hemos lanzado un contenedor en background, lo podemos gestionar mediante los comandos de docker específicos. Ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">#</span> Conectarse a la salida estándar del contenedor
<span class="tok-go">docker attach --sig-proxy=false miservicio</span>

<span class="tok-gp">#</span> Parar el contenedor
<span class="tok-go">docker stop miservicio</span>
<span class="tok-gp">#</span> Matar el contenedor vía SIGKILL
<span class="tok-go">docker kill miservicio</span></code></pre>
</div>
</div>
</li>
<li>
<p>Empaquetar el WAR cursos en una imagen Docker</p>
<div class="paragraph">
<p>Lo primero que tenéis que hacer es crear un fichero Dockerfile con los mismos pasos indicados en el ejemplo y dejarlo en la carpeta donde tengáis vuestro proyecto:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">expertojava@expertojava:~/IdeaProjects/cursos$</span> ls
<span class="tok-go">cursos.iml  Dockerfile  pom.xml  README.md  src  target  WEB-INF</span>
<span class="tok-gp">expertojava@expertojava:~/IdeaProjects/cursos$</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Con la aplicación ya compilada, ejecutaréis el siguiente comando:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">docker build -t &lt;usuario&gt;/wildfly .</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Con este comando habreis creado una nueva imagen asociada a vuestro usuario, pero que únicamente existe en el repositorio local. Si queremos compartirla, la debemos subir a Docker Hub, para ello ejecutaréis:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">docker push &lt;usuario&gt;/wildfly</span></code></pre>
</div>
</div>
</li>
<li>
<p>Repetir el primer paso pero indicando la imagen que habéis creado y dándole un nombre distinto al del ejemplo. Si lo ejecutáis desde vuestra máquina no os descargaréis ninguna capa del repositorio, sin embargo si el servicio estuviera desplegado en otra máquina, al ejecutar un <em>pull</em> se descargaría la capa correspondiente al nuevo WAR.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Importante</div>
La entrega final de este ejercicio constará del código fuente del proyecto, incluyendo el nuevo Dockerfile, y el nombre del repositorio asociado en Docker Hub para que podamos descargar y probar el servicio. El nombre del repositorio se indicará en el fichero <strong>soluciones.txt</strong>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_entrega">1.8.4. Entrega</h4>
<div class="paragraph">
<p>En esta sesión debeis entregar el código fuente del proyecto cursos, el fichero script.cli, y el fichero soluciones.txt actualizado con la información solicitada en los ejercicios.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion02">2. Administración de recursos en WildFly</h2>
<div class="sectionbody">
<div class="paragraph">
<p>En esta sesión vamos a centrarnos en la configuración básica de una instancia de WildFly. Aunque hemos hablado de modalidades de trabajo en Dominio, vamos a centrarnos en los modos standalone por sencillez y porque no nos limitan el acceso a características de alta disponibilidad como en otros servidores.</p>
</div>
<div class="sect2">
<h3 id="_fichero_de_configuración_del_bootstrap">2.1. Fichero de configuración del Bootstrap</h3>
<div class="paragraph">
<p>Hay una cuestión básica que es definir cuanta memoria puede utilizar la aplicación. La forma de definir el tamaño del Heap en Wildfly es bien especificarlo como parámetro del script de arranque, o lo que es más facil, editar el fichero standalone.conf</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">	$JBOSS_HOME/bin/standalone.conf</span>

<span class="tok-go">	JAVA_OPTS=&quot;-XX:MaxPermSize=256m -Xms64m -Xmx512m&quot;</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">JDK 8</div>
En la máquina virtual de la versión 8 desaparece el espacio de memoria denominado Permanent Generation y en su lugar se define uno nuevo denominado Metaspace. La forma de limitarlo es muy similar:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">	$JBOSS_HOME/bin/standalone.conf</span>

<span class="tok-go">	JAVA_OPTS=&quot;-XX:MaxMetaspaceSize=256m -Xms64m -Xmx512m&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En este fichero también podemos especificar una JVM de Java concreta, así como otras propiedades como por ejemplo el número de descriptores de ficheros que podrá utilizar WildFly</p>
</div>
</div>
<div class="sect2">
<h3 id="_estructura_de_los_ficheros_de_configuración">2.2. Estructura de los ficheros de configuración</h3>
<div class="paragraph">
<p>En la sesión anterior comentamos que las herramientas de administración modificación una configuración que físicamente se almacena en ficheros XML. Para cada modo de inicio (Standalone o Domain Managed) existen diferentes configuraciones de inicio, en el caso de operar como servidor independiente. Estos ficheros se encuentran dentro de la carpeta correspondiente a la modalidad (domain o standalone).</p>
</div>
<div class="ulist">
<ul>
<li>
<p>standalone.xml Configuración por defecto, sin soporte JMS.</p>
</li>
<li>
<p>standalone-full.xml Añade soporte JMS (HornetQ).</p>
</li>
<li>
<p>standalone-ha.xml Soporte Clustering.</p>
</li>
<li>
<p>standalone-full-ha.xml Soporte Clustering y JMS.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Se puede especificar un fichero de configuración específico, distinto de la configuración por defecto con el parámetro "-c"</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">./standalone.sh -c standalone-full.xml</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Los ficheros de configuración presentan la siguiente estructura:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas02/EstructuraCfg.png" alt="EstructuraCfg">
</div>
</div>
<div class="paragraph">
<p>El elemento raíz es la etiqueta &lt;server&gt; y de ella cuelgan los siguientes elementos:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Profiles</dt>
<dd>
<p>Los perfiles son configuraciones de servidor y sus distintos subsistemas. En la modalidad standalone, Wildfly sólo permite un perfil por fichero de configuración, sin embargo en el modo domain, es posible definir varios perfiles para distintos tipos de servidores dentro de un dominio. Ejemplo:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;profile&gt;</span>
  ...
  <span class="tok-nt">&lt;subsystem</span> <span class="tok-na">xmlns=</span><span class="tok-s">&quot;urn:jboss:domain:deployment-scanner:2.0&quot;</span><span class="tok-nt">&gt;</span>
            <span class="tok-nt">&lt;deployment-scanner</span> <span class="tok-na">path=</span><span class="tok-s">&quot;deployments&quot;</span> <span class="tok-na">relative-to=</span><span class="tok-s">&quot;jboss.server.base.dir&quot;</span> <span class="tok-na">scan-interval=</span><span class="tok-s">&quot;5000&quot;</span><span class="tok-nt">/&gt;</span>
        <span class="tok-nt">&lt;/subsystem&gt;</span>
  ...
<span class="tok-nt">&lt;/profile&gt;</span></code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Extensions</dt>
<dd>
<p>La mayor parte de las funcionalidades de WildFly se configuran como extensiones, que implementan especificaciones de Java EE.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;extensions&gt;</span>
    [...]
    <span class="tok-nt">&lt;extension</span> <span class="tok-na">module=</span><span class="tok-s">&quot;org.jboss.as.transactions&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;extension</span> <span class="tok-na">module=</span><span class="tok-s">&quot;org.jboss.as.web&quot;</span> <span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;extension</span> <span class="tok-na">module=</span><span class="tok-s">&quot;org.jboss.as.webservices&quot;</span> <span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;extension</span> <span class="tok-na">module=</span><span class="tok-s">&quot;org.jboss.as.weld&quot;</span> <span class="tok-nt">/&gt;</span>
<span class="tok-nt">&lt;/extensions&gt;</span></code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Paths</dt>
<dd>
<p>Los paths son rutas a directorios o ficheros de la máquina a las que se les asocia un nombre lógico. Los paths pueden ser rutas absolutas o relativas a otro path, de modo que la configuración sea portable a otras máquinas:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;path</span> <span class="tok-na">name=</span><span class="tok-s">&quot;log.dir&quot;</span> <span class="tok-na">path=</span><span class="tok-s">&quot;/home/wildfly/logs&quot;</span> <span class="tok-nt">/&gt;</span>  <span class="tok-c">&lt;!-- Ruta absoluta --&gt;</span>

<span class="tok-nt">&lt;file</span> <span class="tok-na">relative-to=</span><span class="tok-s">&quot;log.dir&quot;</span> <span class="tok-na">path=</span><span class="tok-s">&quot;server.log&quot;</span><span class="tok-nt">/&gt;</span>    <span class="tok-c">&lt;!-- Ruta relativa a log.dir --&gt;</span></code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Interfaces</dt>
<dd>
<p>Una interfaz es un nombre lógico asociado a un nombre de máquina/dirección IP a través de la cual podemos acceder a nuestro servidor. Por defecto se definen tres interfaces:</p>
<div class="ulist">
<ul>
<li>
<p><strong>management</strong> La dirección que se utilizará para atender peticiones de administración.</p>
</li>
<li>
<p><strong>public</strong> Esta es la dirección de servicio que atenderá el acceso a las aplicaciones.</p>
</li>
<li>
<p><strong>unsecure</strong> Esta es la dirección que se utilizará para la invocación de objetos remotos IIOP.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;interface</span> <span class="tok-na">name=</span><span class="tok-s">&quot;management&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;inet-address</span> <span class="tok-na">value=</span><span class="tok-s">&quot;${jboss.bind.address.management:127.0.0.1}&quot;</span><span class="tok-nt">/&gt;</span>
<span class="tok-nt">&lt;/interface&gt;</span>
<span class="tok-nt">&lt;interface</span> <span class="tok-na">name=</span><span class="tok-s">&quot;public&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;inet-address</span> <span class="tok-na">value=</span><span class="tok-s">&quot;${jboss.bind.address:127.0.0.1}&quot;</span><span class="tok-nt">/&gt;</span>
<span class="tok-nt">&lt;/interface&gt;</span>
<span class="tok-nt">&lt;interface</span> <span class="tok-na">name=</span><span class="tok-s">&quot;unsecure&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;inet-address</span> <span class="tok-na">value=</span><span class="tok-s">&quot;${jboss.bind.address.unsecure:127.0.0.1}&quot;</span><span class="tok-nt">/&gt;</span>
<span class="tok-nt">&lt;/interface&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por defecto estas interfaces están vinculadas a propiedades del sistema, que se pueden incluso sobrescribir en el inicio del servidor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">./standalone.sh -Djboss.bind.address=192.168.1.100</span></code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Socket binding groups</dt>
<dd>
<p>Un socket binding es básicamente la definición de un punto de escucha y se compone de la interfaz y del puerto de red concreto que se va a utilizar.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;socket-binding-group</span> <span class="tok-na">name=</span><span class="tok-s">&quot;standard-sockets&quot;</span> <span class="tok-na">default-interface=</span><span class="tok-s">&quot;public&quot;</span> <span class="tok-na">port-offset=</span><span class="tok-s">&quot;${jboss.socket.binding.port-offset:0}&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;socket-binding</span> <span class="tok-na">name=</span><span class="tok-s">&quot;management-http&quot;</span> <span class="tok-na">interface=</span><span class="tok-s">&quot;management&quot;</span> <span class="tok-na">port=</span><span class="tok-s">&quot;${jboss.management.http.port:9990}&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;socket-binding</span> <span class="tok-na">name=</span><span class="tok-s">&quot;management-https&quot;</span> <span class="tok-na">interface=</span><span class="tok-s">&quot;management&quot;</span> <span class="tok-na">port=</span><span class="tok-s">&quot;${jboss.management.https.port:9993}&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;socket-binding</span> <span class="tok-na">name=</span><span class="tok-s">&quot;ajp&quot;</span> <span class="tok-na">port=</span><span class="tok-s">&quot;${jboss.ajp.port:8009}&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;socket-binding</span> <span class="tok-na">name=</span><span class="tok-s">&quot;http&quot;</span> <span class="tok-na">port=</span><span class="tok-s">&quot;${jboss.http.port:8080}&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;socket-binding</span> <span class="tok-na">name=</span><span class="tok-s">&quot;https&quot;</span> <span class="tok-na">port=</span><span class="tok-s">&quot;${jboss.https.port:8443}&quot;</span><span class="tok-nt">/&gt;</span>
<span class="tok-nt">&lt;socket-binding-group/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El parámetro port-offset se utiliza para desplegar en una misma máquina distintas instancias de un servidor y asignar a cada una de ellas puertos distintos. El valor del offset se suma a todos los puertos especificados. Una buena práctica es establecer el valor de offset como propiedad del sistema en el inicio, en lugar de indicarlo de forma estática en la configuración.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">System properties</dt>
<dd>
<p>Estas propiedades de configuración del servidor, se pueden establecer de varias formas:</p>
<div class="ulist">
<ul>
<li>
<p>En el fichero de configuración</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;system-properties&gt;</span>
  <span class="tok-nt">&lt;property-name</span><span class="tok-err">=&quot;propiedad&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;true&quot;</span> <span class="tok-nt">/&gt;</span>
<span class="tok-nt">&lt;/system-properties&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>En el script de arranque del servidor standalone.sh o domain.sh.</p>
</li>
<li>
<p>Por línea de comandos, con elparámetro -D</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">./standalone.sh -Dpropiedad=true</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_edición_desde_las_herramientas_de_administración">2.3. Edición desde las herramientas de administración</h3>
<div class="paragraph">
<p>Como ya hemos comentado, la forma más segura de modificar la configuración, es a través de las herramientas de configuración. Uno de los beneficios que reporta utilizar las herramientas es que WildFly crea automáticamente copias de seguridad de la configuración, por si nos equivocamos en algún cambio.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas02/revisiones.png" alt="revisiones">
</div>
</div>
<div class="paragraph">
<p>Sin embargo, en el caso concreto de JBoss, la edición de ficheros de configuración ha sido tradicionalmente la forma más efectiva de administración. Gracias a JBoss AS 7 y WildFly, las herramientas de administración comienzan a acercarse al nivel de otros productos.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Descriptores de despliegue</div>
Además de editar los ficheros de configuración del servidor, es posible codificar la mayor parte de los recursos en ficheros denominados descriptores de despliegue. Los descriptores de despliegue de WildFly complementan a los descriptores estándar de Java EE y permiten utilizar todas las características del servidor. Más información en: <a href="https://docs.jboss.org/author/display/WFLY8/Deployment+Descriptors+used+In+WildFly" class="bare">https://docs.jboss.org/author/display/WFLY8/Deployment+Descriptors+used+In+WildFly</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La consola Web es una aplicación ligera que genera de forma automática vistas sobre la estructura de los ficheros de configuración, con lo que si conocemos la estructura del fichero, la representación Web nos resultará familiar:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas02/ConfigConsola.png" alt="ConfigConsola">
</div>
</div>
<div class="paragraph">
<p>Cuando modifiquemos algunas propiedades que requieran recargar la configuración, la aplicación nos avisará:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas02/Avisos.png" alt="Avisos">
</div>
</div>
<div class="paragraph">
<p>La recarga de la configuración la podemos realizar desde la pestaña <em>Runtime</em>, opción <em>Server</em>.</p>
</div>
<div class="paragraph">
<p>Desde CLI, los cambios se pueden realizar más rápidamente, gracias a la forma de navegar y la ayuda para autocompletar rutas:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas02/ConfigTexto.png" alt="ConfigTexto">
</div>
</div>
<div class="paragraph">
<p>Después de realizar cambios en la configuración, ésta se puede recargar mediante el comando <em>reload</em> o bien parando y arrancando de nuevo el servidor.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuración_de_recursos">2.4. Configuración de recursos</h3>
<div class="paragraph">
<p>La función más importante de un servidor de aplicaciones es la de proporcionar los recursos necesarios para que las aplicaciones puedan funcionar. A continuación repasaremos cómo configurar los recursos más habituales.</p>
</div>
<div class="sect3">
<h4 id="_configuración_de_datasources">2.4.1. Configuración de Datasources</h4>
<div class="paragraph">
<p>Para que las aplicaciones puedan tener acceso a base de datos previamente hay que definir un Datasource y un Pool de conexiones. El Pool de conexiones optimiza el acceso a base de datos creando un conjunto de conexiones antes de que las aplicaciones las lleguen a necesitar. El servidor de aplicaciones asigna estas conexiones dinámicamente a las aplicaciones y en cada asignación nos ahorramos el tiempo de conexión/desconexión a la base de datos.</p>
</div>
<div class="paragraph">
<p>Las propiedades más importantes que definen el comportamiento de un  Pool de conexiones en Wildfly son:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Min Pool Size</dt>
<dd>
<p>El número mínimo de conexiones creadas que puede tener un pool.</p>
</dd>
<dt class="hdlist1">Max Pool Size</dt>
<dd>
<p>El número maximo de conexiones creadas que puede tener un pool.</p>
</dd>
<dt class="hdlist1">Strict Minimum</dt>
<dd>
<p>Si se activa, impide que el número de conexiones pueda bajar más allá del mínimo definido (por ejemplo si las sesiones se liberan por timeout).</p>
</dd>
<dt class="hdlist1">Prefill Enabled</dt>
<dd>
<p>Si se activa, al iniciar un pool de conexiones se crean automáticamente el numero de conexiones indicado como mínimo.</p>
</dd>
<dt class="hdlist1">Flush Strategy</dt>
<dd>
<p>Especifica el modo en el que se liberan las conexiones de un pool ante un error.</p>
</dd>
<dt class="hdlist1">Idle Timeout</dt>
<dd>
<p>Especifica el tiempo en minutos que se puede mantener una conexión sin uso, antes de ser liberada.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Para poder crear una conexión a base de datos en primer lugar hay que instalar el driver jdbc correspondiente. Esto se puede hacer de dos formas:</p>
</div>
<div class="sect4">
<h5 id="_instalación_del_driver_como_módulo">Instalación del driver como módulo</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crear una estructura de directorio dentro de JBOSS_HOME/modules. En el caso de MySQL debemos crear:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">	JBOSS_HOME/modules/system/layers/base/com/mysql/driver/main</span></code></pre>
</div>
</div>
</li>
<li>
<p>Copiar el Jar dentro de la carpeta main</p>
</li>
<li>
<p>Crear un descriptor module.xml dentro de la carpeta main:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;module</span> <span class="tok-na">xmlns=</span><span class="tok-s">&quot;urn:jboss:module:1.3&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;com.mysql.driver&quot;</span><span class="tok-nt">&gt;</span>
 <span class="tok-nt">&lt;resources&gt;</span>
  <span class="tok-nt">&lt;resource-root</span> <span class="tok-na">path=</span><span class="tok-s">&quot;mysql-connector-java-5.1.33.jar&quot;</span> <span class="tok-nt">/&gt;</span>
 <span class="tok-nt">&lt;/resources&gt;</span>
 <span class="tok-nt">&lt;dependencies&gt;</span>
  <span class="tok-nt">&lt;module</span> <span class="tok-na">name=</span><span class="tok-s">&quot;javax.api&quot;</span><span class="tok-nt">/&gt;</span>
  <span class="tok-nt">&lt;module</span> <span class="tok-na">name=</span><span class="tok-s">&quot;javax.transaction.api&quot;</span><span class="tok-nt">/&gt;</span>
 <span class="tok-nt">&lt;/dependencies&gt;</span>
<span class="tok-nt">&lt;/module&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Declarar el driver en el fichero standalone.xml. Añadir al subsistema datasources el nuevo driver</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;driver</span> <span class="tok-na">name=</span><span class="tok-s">&quot;mysql&quot;</span> <span class="tok-na">module=</span><span class="tok-s">&quot;com.mysql.driver&quot;</span><span class="tok-nt">&gt;</span>
	<span class="tok-nt">&lt;driver-class&gt;</span>com.mysql.jdbc.Driver<span class="tok-nt">&lt;/driver-class&gt;</span>
<span class="tok-nt">&lt;/driver&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_instalación_del_driver_como_despliegue">Instalación del driver como despliegue</h5>
<div class="paragraph">
<p>Si no tenemos permisos de administración, podemos simplemente copiar el fichero <em>.jar</em> con el driver de MySQL a la carpeta deployments del servidor. Al iniciar WildFly <strong>debemos revisar</strong> el nombre exacto del driver con el que se publica por si lo necesitamos referenciar en la creación de un datasource.</p>
</div>
<div class="paragraph">
<div class="title">Descarga del driver</div>
<p>NOTE:
El jar lo podéis descargar desde la página de MySQL o bien desde aquí: <a href="http://central.maven.org/maven2/mysql/mysql-connector-java/5.1.33/mysql-connector-java-5.1.33.jar" class="bare">http://central.maven.org/maven2/mysql/mysql-connector-java/5.1.33/mysql-connector-java-5.1.33.jar</a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_creación_del_datasource_y_los_pool">2.4.2. Creación del Datasource y los pool</h4>
<div class="paragraph">
<p>Nuevamente tenemos varias formas de configurar un Datasource, a continuación veremos los pasos para configurarlo desde la consola Web:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Definir el nombre del pool y el nombre JNDI del Datasource</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas02/ds1.png" alt="ds1" width="50%">
</div>
</div>
</li>
<li>
<p>Seleccionar un driver de los instalados en el servidor:</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas02/ds2.png" alt="ds2" width="50%">
</div>
</div>
</li>
<li>
<p>Configurar la cadena de conexión y el usuario/password.</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas02/ds3.png" alt="ds3" width="50%">
</div>
</div>
</li>
<li>
<p>Activar el nuevo pool</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas02/ds4.png" alt="ds4" width="50%">
</div>
</div>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">¿Se puede desplegar un Datasource como un Deployment?</div>
Si, se puede crear un fichero *-ds.xml con la configuración de uno o mas datasources. El fichero tiene la misma estructura que la del subsistema <em>datasources</em> del fichero standalone.xml y se puede copiar directamente a la carpeta deployments, o bien empaquetar dentro de una aplicación. Esta forma de crear datasources es recomendable en entornos de desarrollo, si bien, desde la consola web no es posible administrar este tipo de datasources.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tok-nt">&lt;datasources&gt;</span>
	<span class="tok-nt">&lt;datasource</span> <span class="tok-na">jta=</span><span class="tok-s">&quot;false&quot;</span> <span class="tok-na">jndi-name=</span><span class="tok-s">&quot;java:jboss/datasources/portalDS&quot;</span> <span class="tok-na">pool-name=</span><span class="tok-s">&quot;portalDS&quot;</span> <span class="tok-na">enabled=</span><span class="tok-s">&quot;true&quot;</span> <span class="tok-na">use-ccm=</span><span class="tok-s">&quot;false&quot;</span><span class="tok-nt">&gt;</span>
            <span class="tok-nt">&lt;connection-url&gt;</span>jdbc:mysql://localhost:3306/experto<span class="tok-nt">&lt;/connection-url&gt;</span>
            <span class="tok-nt">&lt;driver-class&gt;</span>com.mysql.jdbc.Driver<span class="tok-nt">&lt;/driver-class&gt;</span>
            <span class="tok-nt">&lt;driver&gt;</span>mysql<span class="tok-nt">&lt;/driver&gt;</span>
            <span class="tok-nt">&lt;security&gt;</span>
                <span class="tok-nt">&lt;user-name&gt;</span>root<span class="tok-nt">&lt;/user-name&gt;</span>
                <span class="tok-nt">&lt;password&gt;</span>expertojavajs<span class="tok-nt">&lt;/password&gt;</span>
            <span class="tok-nt">&lt;/security&gt;</span>
            <span class="tok-nt">&lt;validation&gt;</span>
                <span class="tok-nt">&lt;validate-on-match&gt;</span>false<span class="tok-nt">&lt;/validate-on-match&gt;</span>
                <span class="tok-nt">&lt;background-validation&gt;</span>false<span class="tok-nt">&lt;/background-validation&gt;</span>
            <span class="tok-nt">&lt;/validation&gt;</span>
            <span class="tok-nt">&lt;statement&gt;</span>
                <span class="tok-nt">&lt;share-prepared-statements&gt;</span>false<span class="tok-nt">&lt;/share-prepared-statements&gt;</span>
            <span class="tok-nt">&lt;/statement&gt;</span>
        <span class="tok-nt">&lt;/datasource&gt;</span>
<span class="tok-nt">&lt;/datasources&gt;</span></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_empaquetar_datasources_en_la_aplicación">Empaquetar Datasources en la aplicación:</h5>
<div class="paragraph">
<p>Como hemos comentado el Datasource puede incluirse en las propias aplicaciones. Eso sí, la ubicación del fichero varía en función del tipo de aplicación:</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 45%;">
<colgroup>
<col style="width: 37%;">
<col style="width: 62%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Tipo Aplicación</th>
<th class="tableblock halign-left valign-top">Ubicación</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Web App (.war)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">WEB-INF</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EJB (.jar)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">META-INF</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enterprise (.ear)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">META-INF (empaquetado principal)</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_encriptación_del_password">Encriptación del password</h5>
<div class="paragraph">
<p>WildFly tiene la particularidad de trabajar con passwords en plano en lo que respecta a Datasources. Si la configuración está centralizada en el fichero standalone.xml puede no ser un problema si está protegido para que no sea accesible. Sin embargo si adjuntamos un datasource a una aplicación, o lo copiamos en la carpeta <em>deployments</em> puede ser muy sencillo el averiguar el usuario y la clave de la base de datos. La forma de evitar esto es trabajar con claves encriptadas.</p>
</div>
<div class="paragraph">
<p>Los pasos son los siguientes:</p>
</div>
<div class="listingblock">
<div class="title">Encriptar la password de la base de datos mediante la librería PicketBox</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">expertojavajs@expertojavajs-VirtualBox:/usr/local/wildfly-8.2.1.Final/modules/system/layers/base/org/picketbox/main$</span> java -classpath picketbox-4.0.21.Final.jar org.picketbox.datasource.security.SecureIdentityLoginModule expertojavajs
<span class="tok-go">Encoded password: -46cea3eadea6ff81c9c59e773c1cfb95</span></code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Definir un <em>security-domain</em> asociado a las credenciales, editando el fichero <em>standalone.xml</em>:</div>
<p>Para ello debemos definir un <em>security domain</em> en el servidor, editando el fichero <em>standalone.xml</em> y añadiendo la siguiente información dentro del subsistema urn:jboss:domain:security:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;security-domain</span> <span class="tok-na">name=</span><span class="tok-s">&quot;ds-encrypted&quot;</span> <span class="tok-na">cache-type=</span><span class="tok-s">&quot;default&quot;</span><span class="tok-nt">&gt;</span>
            <span class="tok-nt">&lt;authentication&gt;</span>
                <span class="tok-nt">&lt;login-module</span> <span class="tok-na">code=</span><span class="tok-s">&quot;org.picketbox.datasource.security.SecureIdentityLoginModule&quot;</span>
			<span class="tok-na">flag=</span><span class="tok-s">&quot;required&quot;</span><span class="tok-nt">&gt;</span>
                  <span class="tok-nt">&lt;module-option</span> <span class="tok-na">name=</span><span class="tok-s">&quot;username&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;root&quot;</span><span class="tok-nt">/&gt;</span>
		  <span class="tok-nt">&lt;module-option</span> <span class="tok-na">name=</span><span class="tok-s">&quot;password&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;-46cea3eadea6ff81c9c59e773c1cfb95&quot;</span><span class="tok-nt">/&gt;</span>
                <span class="tok-nt">&lt;module-option</span> <span class="tok-na">name=</span><span class="tok-s">&quot;managedConnectionFactoryName&quot;</span>
			<span class="tok-na">value=</span><span class="tok-s">&quot;jboss.jca:service=LocalTxCM,name=portalDS&quot;</span><span class="tok-nt">/&gt;</span>
            <span class="tok-nt">&lt;/login-module&gt;</span>
            <span class="tok-nt">&lt;/authentication&gt;</span>
        <span class="tok-nt">&lt;/security-domain&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sustituir la información de usuario/password del datasource por la referencia al <em>security domain</em> :</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;security&gt;</span>
	<span class="tok-nt">&lt;security-domain&gt;</span>ds-encrypted<span class="tok-nt">&lt;/security-domain&gt;</span>
<span class="tok-nt">&lt;/security&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configuración_del_contenedor_de_ejb_s">2.4.3. Configuración del contenedor de EJB&#8217;s</h4>
<div class="paragraph">
<p>Los EJB son componentes que implementan principalmente la lógica de negocio de una aplicación Java EE y el servidor de aplicaciones proporciona mecanismos para maximizar la capacidad de proceso de estos componentes.</p>
</div>
<div class="paragraph">
<p>Los EJB&#8217;s se dividen en tres tipos:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Stateless Session Beans</dt>
<dd>
<p>Son objetos que implementan funciones de negocio pero no tienen un estado (valores en memoria).</p>
</dd>
<dt class="hdlist1">Stateful Session Beans</dt>
<dd>
<p>Son objetos que implementan funciones de negocio pero además tienen un estado, que se conserva durante la vida de la sesión.</p>
</dd>
<dt class="hdlist1">Message Driven Beans</dt>
<dd>
<p>Son objetos especializados en el proceso asíncrono de mensajes.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Los Session Beans se pueden instanciar desde cualquier componente de nuestra aplicación que se encuentre en el servidor (servlets, otros EJb&#8217;s, etc.) pero también se pueden ejecutar desde procesos externos al servidor, mediante el protocolo <em>Remoting</em> (basado en RMI). Los objetos MDB son componentes especializados que sólo se ejecutan en respuesta a mensajes enviados asíncronamente a través de lo que se denomina tópico o cola de mensajes.</p>
</div>
<div class="sect4">
<h5 id="_pool_de_ejb_s">Pool de EJB&#8217;s</h5>
<div class="paragraph">
<p>Los EJB&#8217;s son esencialmente POJO&#8217;s a los que se les añade anotaciones específicas para integrarlos dentro del ciclo de vida del contenedor de EJB&#8217;s. Así los objetos EJB se crean y se destruyen en función de la carga de trabajo. Al igual que ocurre con las conexiones a base de datos podemos definir el número de instancias de estos objetos de modo que podamos controlar los recursos destinados a ejecutar esta lógica de negocio. Esto es muy útil en momentos de picos de carga en los que un número excesivo de EJB&#8217;s en ejecución pueden degradar notablemente el rendimiento global del servidor.</p>
</div>
<div class="paragraph">
<p>Este mecanismo es factible para los objetos que no tienen estado, como los Stateless Session Bean y los Message Driven Beans, pero los stateful son objetos equiparables a la sesión HTTP: contienen información de trabajo que no se puede copiar de una sesión a otra. En este caso hay mecanismos que agilizan la carga de la información, pero en ningún caso se puede crear un pool de objetos.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Pool de Objetos en WildFly</div>
Antes de esta versión, existía una configuración de pool de objetos por defecto que aplicaba a todos los Stateless Session Bean. En WildFly por defecto el pool de objetos está desactivado pues se entiende que hoy en día la mejora de rendimiento derivada del pooling no es tan evidente y el uso como contención de capacidad de proceso dependerá de cada aplicación, y por tanto es responsabilidad del desarrollador (o administrador) el parametrizar estos valores. En el caso de MDB&#8217;s sigue estando activo un pool por defecto.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para habilitar el pool por defecto <em>slsb-strict-max-pool</em> (límite de 20 instancias y timeout de acceso de 5 minutos) hay que editar el fichero de configuración añadiendo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;subsystem</span> <span class="tok-na">xmlns=</span><span class="tok-s">&quot;urn:jboss:domain:ejb3:2.0&quot;</span><span class="tok-nt">&gt;</span>
 <span class="tok-nt">&lt;session-bean&gt;</span>
  <span class="tok-nt">&lt;stateless&gt;</span>	<span class="tok-c">&lt;!-- Añadir tag stateless--&gt;</span>
   <span class="tok-nt">&lt;bean-instance-pool-ref</span> <span class="tok-na">pool-name=</span><span class="tok-s">&quot;slsb-strict-max-pool&quot;</span><span class="tok-nt">/&gt;</span>
  <span class="tok-nt">&lt;/stateless&gt;</span></code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas02/EJBPool1.png" alt="EJBPool1">
</div>
</div>
<div class="paragraph">
<p>Para definir un nuevo pool podemos hacerlo desde CLI o a mano editando el fichero de configuración.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Desde CLI, el comando sería el siguiente:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">[standalone@localhost:9990 /] /subsystem=ejb3/strict-max-bean-instance-pool=nuevo-pool:add(max-pool-size=5,timeout-unit=SECONDS,timeout=30)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Con este comando definiremos un nuevo pool de hasta 5 instancias</p>
</div>
<div class="paragraph">
<p>El resultado en el fichero standalone-full.xml es el siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"> <span class="tok-nt">&lt;subsystem</span> <span class="tok-na">xmlns=</span><span class="tok-s">&quot;urn:jboss:domain:ejb3:2.0&quot;</span><span class="tok-nt">&gt;</span>
 ....
  <span class="tok-nt">&lt;pools&gt;</span>
   <span class="tok-nt">&lt;bean-instance-pools&gt;</span>
    <span class="tok-nt">&lt;strict-max-pool</span> <span class="tok-na">name=</span><span class="tok-s">&quot;nuevo-pool&quot;</span> <span class="tok-na">max-pool-size=</span><span class="tok-s">&quot;5&quot;</span> <span class="tok-na">instance-acquisition-timeout=</span><span class="tok-s">&quot;30&quot;</span> <span class="tok-na">instance-acquisition-timeout-unit=</span><span class="tok-s">&quot;SECONDS&quot;</span><span class="tok-nt">/&gt;</span>
....</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para asociar un pool a un EJB concreto, basta añadir una anotación en la clase correspondiente indicando el nombre del pool:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Stateless</span>
<span class="tok-nd">@Pool</span> <span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-s">&quot;ranking-pool&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Ranking</span> <span class="tok-kd">implements</span> <span class="tok-n">RankingLocal</span> <span class="tok-o">{</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_descriptores_de_despliegue">2.4.4. Descriptores de despliegue</h4>
<div class="paragraph">
<p>Java Enterprise proporciona dos métodos para especificar aspectos de la configuración de una aplicación:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Descriptores de despliegue (Ficheros XML).</p>
</li>
<li>
<p>Anotaciones en código.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Sin embargo hay propiedades especificas de Wildfly (comportamiento de los EJB&#8217;s del servidor Web Undertow, etc.) que no quedan cubiertas por el estándar Java EE y que pueden ser definidas desde la aplicación mediante ficheros de configuración propietarios. En la sección de referencias se encuentra un enlace a la lista de descriptores de WildFly, que a la fecha de este documento no estaba completa (se podría utilizar los propios de JBoss 7.1).</p>
</div>
</div>
<div class="sect3">
<h4 id="_class_loading">2.4.5. Class Loading</h4>
<div class="paragraph">
<p>En este apartado trataremos brevemente el orden que sigue el servidor a la hora de localizar las clases que componen una aplicación. En la sesión anterior comentamos los distintos tipos de aplicaciones java y la forma de acceder a componentes compartidos. JBoss proporciona un mecanismo adicional: el uso de <em>módulos</em>.</p>
</div>
<div class="paragraph">
<p>Los módulos se dividen a su vez en</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Módulos estáticos</dt>
<dd>
<p>se integran en las carpetas de módulos del servidor y pueden ser definidos como accesibles por todos los despliegues del servidor.</p>
</dd>
<dt class="hdlist1">Módulos dinámicos</dt>
<dd>
<p>Se copian a la carpeta deployments y pueden ser reemplazados en caliente.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Si recordamos el caso del driver de MySQL veremos que hemos propuesto dos instalaciones, una como módulo estático y otra como módulo dinámico. Por defecto si añadimos un módulo dinámico, el nombre interno que tendrá el módulo en WildFly será:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">deployment.[nombre del fichero]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La forma de especificar que una aplicación necesita acceder a recursos de un módulo, (estático o dinámico) es indicarlo en el fichero <em>MANIFEST.MF</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">Dependencies: deployment.WebExample1.war</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por último, comentar el orden que sigue WildFly para resolver la ubicación de una clase Java. Ordenando de mayor prioridad a menor:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Dependencias del sistema: Son dependencias que el contenedor añade de forma automática a la aplicación, como por ejemplo el API de Java EE.</p>
</li>
<li>
<p>Dependencias de usuario: Son las que el desarrollador define a través del MANIFEST.MF, el Classpath para ficheros JAR o a través del fichero <em>jboss-deployment-structure.xml</em>.</p>
</li>
<li>
<p>Recursos locales. Son las clases que están ubicadas dentro del propio empaquetado de la aplicación, por ejemplo <em>WEB-INF/classes</em> o WEB-INF/lib de una aplicación WAR.</p>
</li>
<li>
<p>Dependencias compartidas. Son las dependencias compartidas entre varios componentes de una aplicación. Típicamente las librerías compartidas dentro de una aplicación EAR.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_rendimiento">2.4.6. Rendimiento</h4>
<div class="paragraph">
<p>Hablar de rendimiento en un servidor de aplicaciones nos permitiría llenar más de una sesión entera del curso, si bien, lo más importante es dimensionar los recursos del servidor (memoria, pool de objetos, conexiónes a base de datos) en función de la carga de trabajo que va a soportar. Dado que gran parte de la programación que se verá en el curso gira en torno a JavaScript, comentar que hay una forma muy sencilla de agilizar los tiempos de carga de las aplicaciones y consiste en habilitar la compresión GZIP en las comunicaciones con el servidor. Descargar con compresión código JavaScript o texto estático en HTML puede reducir el tiempo de descarga hasta un 90%, a costa de un mayor consumo de CPU en el servidor.</p>
</div>
<div class="paragraph">
<p>La forma de habilitarlo en WildFly consiste en definir un filtro y según el tipo de recurso aplicar compresión o no (es contraproducente comprimir recursos estáticos ya comprimidos como imágenes o documentos PDF).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;subsystem</span> <span class="tok-na">xmlns=</span><span class="tok-s">&quot;urn:jboss:domain:undertow:1.0&quot;</span><span class="tok-nt">&gt;</span>
   <span class="tok-nt">&lt;buffer-caches&gt;</span>
      <span class="tok-nt">&lt;buffer-cache</span> <span class="tok-na">name=</span><span class="tok-s">&quot;default&quot;</span> <span class="tok-na">buffer-size=</span><span class="tok-s">&quot;1024&quot;</span> <span class="tok-na">buffers-per-region=</span><span class="tok-s">&quot;1024&quot;</span> <span class="tok-na">max-regions=</span><span class="tok-s">&quot;10&quot;</span><span class="tok-nt">/&gt;</span>
   <span class="tok-nt">&lt;/buffer-caches&gt;</span>
   <span class="tok-nt">&lt;server</span> <span class="tok-na">name=</span><span class="tok-s">&quot;default-server&quot;</span><span class="tok-nt">&gt;</span>
      <span class="tok-nt">&lt;http-listener</span> <span class="tok-na">name=</span><span class="tok-s">&quot;default&quot;</span> <span class="tok-na">socket-binding=</span><span class="tok-s">&quot;http&quot;</span><span class="tok-nt">/&gt;</span>
      <span class="tok-nt">&lt;host</span> <span class="tok-na">name=</span><span class="tok-s">&quot;default-host&quot;</span> <span class="tok-na">alias=</span><span class="tok-s">&quot;localhost&quot;</span><span class="tok-nt">&gt;</span>
          <span class="tok-nt">&lt;location</span> <span class="tok-na">name=</span><span class="tok-s">&quot;/&quot;</span> <span class="tok-na">handler=</span><span class="tok-s">&quot;welcome-content&quot;</span> <span class="tok-nt">/&gt;</span>
          <span class="tok-nt">&lt;filter-ref</span> <span class="tok-na">name=</span><span class="tok-s">&quot;gzipFilter&quot;</span> <span class="tok-na">predicate=</span><span class="tok-s">&quot;path-suffix[&#39;.css&#39;] or path-suffix[&#39;.js&#39;]&quot;</span> <span class="tok-nt">/&gt;</span>
          <span class="tok-nt">&lt;filter-ref</span> <span class="tok-na">name=</span><span class="tok-s">&quot;server-header&quot;</span><span class="tok-nt">/&gt;</span>
          <span class="tok-nt">&lt;filter-ref</span> <span class="tok-na">name=</span><span class="tok-s">&quot;x-powered-by-header&quot;</span><span class="tok-nt">/&gt;</span>
      <span class="tok-nt">&lt;/host&gt;</span>
   <span class="tok-nt">&lt;/server&gt;</span>
   <span class="tok-nt">&lt;servlet-container</span> <span class="tok-na">name=</span><span class="tok-s">&quot;default&quot;</span> <span class="tok-na">default-buffer-cache=</span><span class="tok-s">&quot;default&quot;</span> <span class="tok-na">stack-trace-on-error=</span><span class="tok-s">&quot;local-only&quot;</span><span class="tok-nt">&gt;</span>
      <span class="tok-nt">&lt;jsp-config/&gt;</span>
   <span class="tok-nt">&lt;/servlet-container&gt;</span>
   <span class="tok-nt">&lt;handlers&gt;</span>
      <span class="tok-nt">&lt;file</span> <span class="tok-na">name=</span><span class="tok-s">&quot;welcome-content&quot;</span> <span class="tok-na">path=</span><span class="tok-s">&quot;${jboss.home.dir}/welcome-content&quot;</span> <span class="tok-na">directory-listing=</span><span class="tok-s">&quot;true&quot;</span><span class="tok-nt">/&gt;</span>
   <span class="tok-nt">&lt;/handlers&gt;</span>
   <span class="tok-nt">&lt;filters&gt;</span>
      <span class="tok-nt">&lt;response-header</span> <span class="tok-na">name=</span><span class="tok-s">&quot;server-header&quot;</span> <span class="tok-na">header-name=</span><span class="tok-s">&quot;Server&quot;</span> <span class="tok-na">header-value=</span><span class="tok-s">&quot;Wildfly 8&quot;</span><span class="tok-nt">/&gt;</span>
      <span class="tok-nt">&lt;response-header</span> <span class="tok-na">name=</span><span class="tok-s">&quot;x-powered-by-header&quot;</span> <span class="tok-na">header-name=</span><span class="tok-s">&quot;X-Powered-By&quot;</span> <span class="tok-na">header-value=</span><span class="tok-s">&quot;Undertow 1&quot;</span><span class="tok-nt">/&gt;</span>
      <span class="tok-nt">&lt;gzip</span> <span class="tok-na">name=</span><span class="tok-s">&quot;gzipFilter&quot;</span><span class="tok-nt">/&gt;</span>
   <span class="tok-nt">&lt;/filters&gt;</span>
<span class="tok-nt">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Se añade la referencia al filtro <em>gzipFilter</em> en la lista de filtros y en el tag <em>&lt;filter-ref name&gt;</em>  se define la expresión regular que determina si un elemento se debe comprimir o no.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_referencias_2">2.5. Referencias</h3>
<div class="ulist">
<ul>
<li>
<p>WildFly Administration Guide <a href="https://docs.jboss.org/author/display/WFLY8/Admin+Guide" class="bare">https://docs.jboss.org/author/display/WFLY8/Admin+Guide</a></p>
</li>
<li>
<p>Quickstart JMS <a href="http://www.mastertheboss.com/jboss-jms/how-to-code-a-remote-jms-client-for-wildfly-8" class="bare">http://www.mastertheboss.com/jboss-jms/how-to-code-a-remote-jms-client-for-wildfly-8</a></p>
</li>
<li>
<p>Descriptores de despliegue estándar Java EE 7 <a href="https://wikis.oracle.com/display/GlassFish/Java+EE+7+Maven+Coordinates" class="bare">https://wikis.oracle.com/display/GlassFish/Java+EE+7+Maven+Coordinates</a></p>
</li>
<li>
<p>Descriptores de despliegue específicos de WildFly <a href="https://docs.jboss.org/author/display/WFLY8/Deployment+Descriptors+used+In+WildFly" class="bare">https://docs.jboss.org/author/display/WFLY8/Deployment+Descriptors+used+In+WildFly</a></p>
</li>
<li>
<p>Configuración de los Pool de EJB en JBoss 7 <a href="http://www.javacodegeeks.com/2011/11/jboss-as-7-ejb3-pools-configuration.html" class="bare">http://www.javacodegeeks.com/2011/11/jboss-as-7-ejb3-pools-configuration.html</a></p>
</li>
<li>
<p>Información sobre el ClassLoading en JBoss 7 <a href="https://docs.jboss.org/author/display/AS71/Class+Loading+in+AS7" class="bare">https://docs.jboss.org/author/display/AS71/Class+Loading+in+AS7</a></p>
</li>
<li>
<p>Best Practices for speeding up your Web Site <a href="https://developer.yahoo.com/performance/rules.html" class="bare">https://developer.yahoo.com/performance/rules.html</a></p>
</li>
<li>
<p>GZip Encoding in WildFly <a href="http://rumianom.pl/rumianom/entry/gzip_content_encoding_in_wildfly" class="bare">http://rumianom.pl/rumianom/entry/gzip_content_encoding_in_wildfly</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios_de_administración_de_recursos_en_wildfly">2.6. Ejercicios de Administración de recursos en Wildfly</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">JMS y WildFly</div>
Para que se pueda acceder a determinados recursos como las connection factory o colas del servidor desde un proceso externo, hay que utilizar un nombre JNDI adicional que comience por java:jboss/exported. El cliente jboss-client de WildFly 8.x no implementa JMS 2.0, si no que se corresponde con la especificación Java EE 6.0 La clase genérica Destination no está definida.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Ahora que ya tenemos una visión general sobre la configuración de recursos en WildFly, vamos a realizar una serie de ejercicios para poner en práctica lo que hemos aprendido.</p>
</div>
<div class="sect3">
<h4 id="_librería_compartida_de_logs_0_6_puntos">2.6.1. Librería compartida de Logs (0.6 puntos)</h4>
<div class="paragraph">
<p>Vuestro primer reto será crear una sencilla librería de log, que registre cualquier evento en una tabla de base de datos.  Un evento tendrá los siguientes atributos: timestamp, un mensaje y un tipo: I:informativo, D:debug W:aviso E:error.</p>
</div>
<div class="paragraph">
<p>Debéis realizar las siguientes tareas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Iniciar WildFly en modo standalone en modo Full Profile Java EE (standalone-full.xml).</p>
</li>
<li>
<p>Desplegar la libreria _apli-loglibrary- como librería compartida, que contiene las clases necesarias para implementar la interfaz de log.</p>
</li>
<li>
<p>Definir el datasource <em>java:jboss/datasources/appLogger</em> en un descriptor de despliegue con el password encriptado, que se debe incluir en la propia librería.</p>
</li>
<li>
<p>Desplegar una sencilla aplicación Web  con un único Servlet que registre en base de datos cada llamada que reciba. Debe enlazar externamente con la librería de logs.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Se os proporciona un script <em>eurovision.sql</em> con la tabla de logs y la base de datos para el siguiente ejercicio. También contaréis con los tres proyectos Maven que componen esta aplicación:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Proyecto "Java Application" de nombre <em>apli-logLibrary</em> con la interfaz de Log predefinida.</p>
</li>
<li>
<p>Proyecto "Web Application", <em>apli-AppLogger</em>, con el servlet de prueba: se invocará mediante la llamada a <a href="http://localhost:8080/App/Test" class="bare">http://localhost:8080/App/Test</a></p>
</li>
<li>
<p>Proyecto "Enterprise Application" <em>apli-Enterprise Logger</em> que incluirá únicamente al proyecto Web.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Debéis desplegar tanto la librería compartida como el EAR y comprobar que se registran en la tabla las llamadas al servlet. Los entregables serán los fuentes de todos los proyectos.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Pistas</div>
Si queréis probar la librería sin desplegarla en WildFly debéis utilizar  el denominado cliente completo de WildFly. Es un jar que se utiliza en clientes pesados que incluye todas las clases de WildFly necesarias para trabajar en remoto.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para dar de alta el cliente de WildFly como una dependencia de Maven  hay que hacer lo siguiente:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Acceder a la carpeta <em>/usr/local/wildfly-8.2.1.Final/bin/client</em> .</p>
</li>
<li>
<p>Ejecutar:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>mvn install:install-file -Dfile=jboss-client.jar \
-DgroupId=org.wildfly \
-DartifactId=jboss-client \
-Dversion=8.2.1 \
-Dpackaging=jar \
-DgeneratePom=true</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_camino_a_eurovisión_1_punto">2.6.2. Camino a Eurovisión (1 punto)</h4>
<div class="paragraph">
<p>Tenemos la tarea de desplegar un sistema de votaciones que se utilizará para determinar la próxima canción candidata española a Eurovisión. Esta aplicación presenta una estructura de proyectos típica de las aplicaciones Java Entreprise de hace algunos años. Se trata de una aplicación EAR con distintos subproyectos para cada uno de los módulos que contiene y un pom principal que compila toda la solución. Esta basada en Java EE 5 aunque tiene referencias a las librerías actuales. En resumen, algo muy parecido a lo que os podéis encontrar en el mundo laboral. Los módulos son los siguientes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Una librería con un EJB que implementa la lógica de negocio.</p>
</li>
<li>
<p>Una aplicación Web que implementa la presentación.</p>
</li>
<li>
<p>Una aplicación empresarial EAR que engloba a todo el proyecto.</p>
</li>
<li>
<p>Un cliente Java EE externo.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Gráficamente, la arquitectura de la aplicación es la siguiente:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas02/arquitectura.png" alt="arquitectura">
</div>
</div>
<div class="paragraph">
<p>Se utiliza una aplicación externa para simular una pasarela que recoge los votos emitidos mediante mensajes de móvil. La información que os interesará de dichos mensajes es el número de teléfono origen y el número de la canción votada. El formato del mensaje será el teléfono, de longitud variables, el símbolo "#" como separador y por último la palabra <em>EURO</em> más un número del 01 al 12, ejemplo: <em>654736534#EURO04</em>.</p>
</div>
<div class="paragraph">
<p>Partiréis de los proyectos Maven ya creados y un script SQL para la creación de la base de datos <em>eurovision</em>. Aunque no se estudia en detalle en esta sesión, dentro de la aplicación tenemos un ejemplo de procesamiento asíncrono mediante colas de mensajes y objetos MDB&#8217;s. Para que esta parte funcione correctamente hay que crear un usuario de aplicación denominado <strong>jmsuser</strong>. Para que este nuevo usuario tenga permisos de lectura/escritura hay que asociarlo al grupo <strong>guest</strong>.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas02/ejercicios1.png" alt="ejercicios1">
</div>
</div>
<div class="paragraph">
<p>Para completar el ejercicio teneis que cubrir los siguientes objetivos:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Configurar la aplicación EAR para que utilice la librería compartida de logs del ejercicio anterior.</p>
</li>
<li>
<p>Ajustar la configuración del EJB Ranking que implementa la lógica de negocio añadiéndole un <strong>límite máximo</strong> de 5 objetos simultáneos para el EJB. Como esta configuración es específica de WildFly hay que añadir la siguiente dependencia al proyecto del EJB:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;dependency&gt;</span>
	<span class="tok-nt">&lt;groupId&gt;</span>org.wildfly<span class="tok-nt">&lt;/groupId&gt;</span>
	<span class="tok-nt">&lt;artifactId&gt;</span>wildfly-ejb3<span class="tok-nt">&lt;/artifactId&gt;</span>
	<span class="tok-nt">&lt;version&gt;</span>8.2.1.Final<span class="tok-nt">&lt;/version&gt;</span>
	<span class="tok-nt">&lt;scope&gt;</span>provided<span class="tok-nt">&lt;/scope&gt;</span>
<span class="tok-nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>La aplicación contiene un MDB que recibe los votos y los almacena en base de datos. Hay que revisar cómo está implementado y crear la conexión a base de datos que necesita desde la consola de WildFly.</p>
</li>
<li>
<p>Configurar el usuario JMS que utilizará el cliente Java <em>apli-EnvioSMS</em>. Se trata de una aplicación Java EE que se ejecuta fuera del servidor de aplicaciones pero utiliza los servicios que ofrece, concretamente una cola JMS, denominada <em>jms/entradaMensajes</em> a donde enviará los votos del</p>
</li>
<li>
<p>Desplegar la aplicación y acceder a la consulta de votaciones para ver las posibles canciones a las que se puede votar.</p>
</li>
<li>
<p>Utilizar la aplicación cliente para enviar varios votos y asegurarse de que se contabilizan correctamente.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Los entregables del ejercicio serán:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>El fichero de configuración standalone-full.xml</p>
</li>
<li>
<p>El código fuente de todos los proyectos solicitados, <em>apli-EnvioSMS</em> y <em>Apli-CaminoAEurovision</em>.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Pistas</div>
Para poder compilar la aplicación externa Java EE necesitaréis construir el cliente completo de WildFly, tal y como se explicaba en el ejercicio anterior. Estad muy pendientes del log de WildFly, que es donde se os dará una pista más clara de lo que ocurre en caso de problemas.
</td>
</tr>
</table>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion03">3. Seguridad declarativa en WildFly  (JAAS)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Desde el punto de vista del programador, no hay grandes diferencias a la hora de desarrollar y desplegar una aplicación en WildFly, GlassFish u otro servidor de aplicaciones,  pero es desde la perspectiva del administrador desde donde cada producto muestra una forma diferente de operar. Desde este punto de vista hemos querido cubrir los aspectos más generales del uso de WildFly. A partir de ahora nos centraremos en la seguridad.</p>
</div>
<div class="paragraph">
<p>En esta sesión hablaremos sobre seguridad en declarativa en WildFly y en la siguiente hablaremos de seguridad en la capa de transporte</p>
</div>
<div class="sect2">
<h3 id="_implementación_de_la_seguridad_declarativa_en_wildfly">3.1. Implementación de la seguridad declarativa en WildFly</h3>
<div class="paragraph">
<p>A estas alturas ya tenemos una idea general sobre seguridad declarativa, pero como repaso vamos a revisar una serie de conceptos que enlazan lo que ya hemos visto con algunos elementos nuevos:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Usuarios, grupos y roles</dt>
<dd>
<p>Son los elementos básicos a la hora de definir la seguridad de una aplicación Web y que ya hemos utilizado a lo largo del curso. En el caso concreto de WildFly, grupo y rol se tratan como un mismo concepto, como veremos más adelante.</p>
</dd>
<dt class="hdlist1">Políticas de seguridad</dt>
<dd>
<p>Son asociaciones entre recursos de WildFly y usuarios o roles. Es decir nos permiten definir exactamente quién puede acceder a un determinado recurso y qué operaciones puede hacer con él.</p>
</dd>
<dt class="hdlist1">Dominios de seguridad (Security Domains)</dt>
<dd>
<p>Son las configuraciones de autenticación, autorización, mapeo de seguridad y auditoría propias del servidor de aplicaciones. Implementan la especificación JAAS (Java Authentication and Authorization Service) de seguridad declarativa.</p>
</dd>
<dt class="hdlist1">Security Realms</dt>
<dd>
<p>Los Realm son los almacenes de usuarios, password y roles de las interfaces de administración del servidor (puntos de entrada) tanto desde el exterior como internamente en el propio servidor. Son componentes sobre los que se sustentan los security domain. De inicio WildFly cuenta con dos Security Realm:</p>
<div class="ulist">
<ul>
<li>
<p><strong>ManagementRealm</strong>: que sirve para securizar el acceso a las herramientas de administración (Autenticación)</p>
</li>
<li>
<p><strong>ApplicationRealm</strong>: que se utiliza para controlar el acceso a las aplicaciones desplegadas (Autenticación y Autorización).</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>La configuración del Realm de administración es la siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"> <span class="tok-nt">&lt;security-realm</span> <span class="tok-na">name=</span><span class="tok-s">&quot;ManagementRealm&quot;</span><span class="tok-nt">&gt;</span>
	<span class="tok-nt">&lt;authentication&gt;</span>
		<span class="tok-nt">&lt;local</span> <span class="tok-na">default-user=</span><span class="tok-s">&quot;$local&quot;</span> <span class="tok-na">skip-group-loading=</span><span class="tok-s">&quot;true&quot;</span><span class="tok-nt">/&gt;</span>
		<span class="tok-nt">&lt;properties</span> <span class="tok-na">path=</span><span class="tok-s">&quot;mgmt-users.properties&quot;</span> <span class="tok-na">relative-to=</span><span class="tok-s">&quot;jboss.server.config.dir&quot;</span><span class="tok-nt">/&gt;</span>
	<span class="tok-nt">&lt;/authentication&gt;</span>
	<span class="tok-nt">&lt;authorization</span> <span class="tok-na">map-groups-to-roles=</span><span class="tok-s">&quot;false&quot;</span><span class="tok-nt">&gt;</span>
		<span class="tok-nt">&lt;properties</span> <span class="tok-na">path=</span><span class="tok-s">&quot;mgmt-groups.properties&quot;</span> <span class="tok-na">relative-to=</span><span class="tok-s">&quot;jboss.server.config.dir&quot;</span><span class="tok-nt">/&gt;</span>
	<span class="tok-nt">&lt;/authorization&gt;</span>
 <span class="tok-nt">&lt;/security-realm&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El Realm distingue entre accesos desde la máquina local y accesos remotos. Para los primeros no se requiere password, por lo que la herramienta CLI ejecutada en local se conecta directamente, como ya vimos en la primera sesión. En el caso de utilizar CLI contra una instancia remota o acceder a través de la Consola Web sí que se nos pedirá usuario/password.</p>
</div>
<div class="paragraph">
<p>Los ficheros indicados <em>mgmt-users.properties</em> y <em>mgmt-groups.properties</em> contendrán los usuarios y grupos a los que pertenecen.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
El concepto de grupo sí existe para el  ManagementRealm ya que se pueden definir grupos de usuarios y posteriormente asociarlos con roles de administración RBAC (que veremos al final de la sesión).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El Realm de aplicaciones  tiene una configuración muy parecida:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;security-realm</span> <span class="tok-na">name=</span><span class="tok-s">&quot;ApplicationRealm&quot;</span><span class="tok-nt">&gt;</span>
	<span class="tok-nt">&lt;authentication&gt;</span>
		<span class="tok-nt">&lt;local</span> <span class="tok-na">default-user=</span><span class="tok-s">&quot;$local&quot;</span> <span class="tok-na">allowed-users=</span><span class="tok-s">&quot;*&quot;</span> <span class="tok-na">skip-group-loading=</span><span class="tok-s">&quot;true&quot;</span><span class="tok-nt">/&gt;</span>
		<span class="tok-nt">&lt;properties</span> <span class="tok-na">path=</span><span class="tok-s">&quot;application-users.properties&quot;</span> <span class="tok-na">relative-to=</span><span class="tok-s">&quot;jboss.server.config.dir&quot;</span><span class="tok-nt">/&gt;</span>
	<span class="tok-nt">&lt;/authentication&gt;</span>
	<span class="tok-nt">&lt;authorization&gt;</span>
		<span class="tok-nt">&lt;properties</span> <span class="tok-na">path=</span><span class="tok-s">&quot;application-roles.properties&quot;</span> <span class="tok-na">relative-to=</span><span class="tok-s">&quot;jboss.server.config.dir&quot;</span><span class="tok-nt">/&gt;</span>
	<span class="tok-nt">&lt;/authorization&gt;</span>
<span class="tok-nt">&lt;/security-realm&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>También admite un usuario local de tipo invitado <em>$local</em> y codifica la información de usuarios en ficheros locales. En este caso sí está habilitado el mapeo entre usuarios y roles y se define un fichero específico para ello.</p>
</div>
<div class="paragraph">
<p>Los Security Realm se pueden utilizar tanto en conexiones provenientes del exterior como en conexiones internas. El ejemplo típico de esto último es el subsistema <em>Remoting</em> utilizado para acceder al contenedor de EJB&#8217;s, que por defecto está vinculado al Realm de aplicaciones:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;subsystem</span> <span class="tok-na">xmlns=</span><span class="tok-s">&quot;urn:jboss:domain:remoting:2.0&quot;</span><span class="tok-nt">&gt;</span>
 <span class="tok-nt">&lt;endpoint</span> <span class="tok-na">worker=</span><span class="tok-s">&quot;default&quot;</span><span class="tok-nt">/&gt;</span>
 <span class="tok-nt">&lt;http-connector</span> <span class="tok-na">name=</span><span class="tok-s">&quot;http-remoting-connector&quot;</span> <span class="tok-na">connector-ref=</span><span class="tok-s">&quot;default&quot;</span> <span class="tok-na">security-realm=</span><span class="tok-s">&quot;ApplicationRealm&quot;</span><span class="tok-nt">/&gt;</span>
<span class="tok-nt">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_security_domain_y_login_modules">3.1.1. Security Domain y Login Modules</h4>
<div class="paragraph">
<p>Los <em>Security Domain</em> definen las políticas de autenticación y autorización del servidor de aplicaciones. Un security domain configura uno o varios <em>login modules</em> que implementan estas políticas. La configuración por defecto es la siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml">        <span class="tok-nt">&lt;subsystem</span> <span class="tok-na">xmlns=</span><span class="tok-s">&quot;urn:jboss:domain:security:1.2&quot;</span><span class="tok-nt">&gt;</span>
            <span class="tok-nt">&lt;security-domains&gt;</span>
                <span class="tok-nt">&lt;security-domain</span> <span class="tok-na">name=</span><span class="tok-s">&quot;other&quot;</span> <span class="tok-na">cache-type=</span><span class="tok-s">&quot;default&quot;</span><span class="tok-nt">&gt;</span>
                    <span class="tok-nt">&lt;authentication&gt;</span>
                        <span class="tok-nt">&lt;login-module</span> <span class="tok-na">code=</span><span class="tok-s">&quot;Remoting&quot;</span> <span class="tok-na">flag=</span><span class="tok-s">&quot;optional&quot;</span><span class="tok-nt">&gt;</span>
                            <span class="tok-nt">&lt;module-option</span> <span class="tok-na">name=</span><span class="tok-s">&quot;password-stacking&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;useFirstPass&quot;</span><span class="tok-nt">/&gt;</span>
                        <span class="tok-nt">&lt;/login-module&gt;</span>
                        <span class="tok-nt">&lt;login-module</span> <span class="tok-na">code=</span><span class="tok-s">&quot;RealmDirect&quot;</span> <span class="tok-na">flag=</span><span class="tok-s">&quot;required&quot;</span><span class="tok-nt">&gt;</span>
                            <span class="tok-nt">&lt;module-option</span> <span class="tok-na">name=</span><span class="tok-s">&quot;password-stacking&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;useFirstPass&quot;</span><span class="tok-nt">/&gt;</span>
                        <span class="tok-nt">&lt;/login-module&gt;</span>
                    <span class="tok-nt">&lt;/authentication&gt;</span>
                <span class="tok-nt">&lt;/security-domain&gt;</span>
                <span class="tok-nt">&lt;security-domain</span> <span class="tok-na">name=</span><span class="tok-s">&quot;jboss-web-policy&quot;</span> <span class="tok-na">cache-type=</span><span class="tok-s">&quot;default&quot;</span><span class="tok-nt">&gt;</span>
                    <span class="tok-nt">&lt;authorization&gt;</span>
                        <span class="tok-nt">&lt;policy-module</span> <span class="tok-na">code=</span><span class="tok-s">&quot;Delegating&quot;</span> <span class="tok-na">flag=</span><span class="tok-s">&quot;required&quot;</span><span class="tok-nt">/&gt;</span>
                    <span class="tok-nt">&lt;/authorization&gt;</span>
                <span class="tok-nt">&lt;/security-domain&gt;</span>
                <span class="tok-nt">&lt;security-domain</span> <span class="tok-na">name=</span><span class="tok-s">&quot;jboss-ejb-policy&quot;</span> <span class="tok-na">cache-type=</span><span class="tok-s">&quot;default&quot;</span><span class="tok-nt">&gt;</span>
                    <span class="tok-nt">&lt;authorization&gt;</span>
                        <span class="tok-nt">&lt;policy-module</span> <span class="tok-na">code=</span><span class="tok-s">&quot;Delegating&quot;</span> <span class="tok-na">flag=</span><span class="tok-s">&quot;required&quot;</span><span class="tok-nt">/&gt;</span>
                    <span class="tok-nt">&lt;/authorization&gt;</span>
                <span class="tok-nt">&lt;/security-domain&gt;</span>
            <span class="tok-nt">&lt;/security-domains&gt;</span>
        <span class="tok-nt">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Además del Dominio <em>other</em> tenemos los dominios <em>jboss-ejb-policy</em> y <em>jboss-web-policy</em> que componen los módulos de autorización predefinidos, pero el security domain que nos interesa es el denominado <em>other</em>.</p>
</div>
<div class="paragraph">
<p>Other es el security domain por defecto en la instalación, preparado para trabajar con el <em>Application Realm</em> y en él podemos identificar dos login modules distintos:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Remoting</dt>
<dd>
<p>Utilizado internamente cuando las peticiones de autenticación se reciben a través del protocolo Remoting (habitualmente llamadas a un EJB).</p>
</dd>
<dt class="hdlist1">RealmDirect</dt>
<dd>
<p>Utilizado en el resto de peticiones (por ejemplo, al acceder a una aplicación Web). Este módulo tiene la particularidad delegar en un Realm la tarea de autenticación, que por defecto será el <em>ApplicationRealm</em>.</p>
</dd>
</dl>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas03/jboss-security.png" alt="jboss security" width="50%">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
El Realm que utilizará RealmDirect se puede especificar mediante el module-option <em>realm</em>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Por defecto, los login modules se ejecutarán en el orden en el que se hayan definido. Adicionalmente existe un parámetro denominado <em>flag</em> en cada login module, que nos permitirá definir cómo tratar cada resultado parcial.</p>
</div>
<div class="paragraph">
<p>Puede tener los siguientes valores:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Required</dt>
<dd>
<p>El usuario debe validarse con éxito necesariamente. Independientemente del resultado intentará validarse con el resto de login modules.</p>
</dd>
<dt class="hdlist1">Requisite</dt>
<dd>
<p>El usuario debe validarse con éxito necesariamente. Una vez validado, intentará validarse con el resto de login modules. Las siguientes validaciones podrán fallar pero el usuario seguirá autenticado (excepto si tienen el atributo de requerido). Si falla la validación, termina el proceso de autenticación.</p>
</dd>
<dt class="hdlist1">Sufficient</dt>
<dd>
<p>El usuario intentará validarse, si falla lo intentará con el resto de login modules, pero si es autenticado, la validación termina en ese punto.</p>
</dd>
<dt class="hdlist1">Optional</dt>
<dd>
<p>El usuario intentará validarse, aunque no necesariamente tiene porqué tener éxito. Si todos los login modules están configurados como optional, necesariamente tendrá que validarse con al menos uno de ellos.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>El módulo RealmDirect tiene una única opción, el <em>password-stacking</em> que debe ser utilizado con el valor <em>useFirstPass</em> si se utilizan varios login modules.</p>
</div>
<div class="paragraph">
<p>En esta sesión trabajaremos con tres login modules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>RealmDirect</strong> almacena usuarios y roles en ficheros. Estos ficheros son los definidos dentro del ApplicationRealm.</p>
</li>
<li>
<p><strong>Database</strong> almacena usuarios y roles en una base de datos relacional.</p>
</li>
<li>
<p><strong>LDAP</strong> almacena usuarios y roles en un servidor LDAP como OpenLDAP.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
La lista completa de login modules la podéis encontrar en esta página: <a href="https://docs.jboss.org/author/display/AS71/Security+subsystem+configuration" class="bare">https://docs.jboss.org/author/display/AS71/Security+subsystem+configuration</a>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_activación_de_la_auditoria_de_seguridad">3.1.2. Activación de la auditoria de seguridad</h4>
<div class="paragraph">
<p>En la fase de construcción resulta muy útil  habilitar la auditoría de seguridad antes de comenzar a trabajar con seguridad declarativa. El log normal de Wildfly no suele proporcionar información significativa cuando intentamos acceder a una aplicación securizada y por la causa que sea el servidor no considera válidas nuestras credenciales.</p>
</div>
<div class="paragraph">
<p>La forma de hacerlo en WildFly es un tanto enrevesada pues hay que añadir la siguiente información al subsistema de <strong>logging</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;subsystem</span> <span class="tok-na">xmlns=</span><span class="tok-s">&quot;urn:jboss:domain:logging:2.0&quot;</span><span class="tok-nt">&gt;</span>
			...
            <span class="tok-nt">&lt;periodic-rotating-file-handler</span> <span class="tok-na">name=</span><span class="tok-s">&quot;AUDIT&quot;</span> <span class="tok-na">autoflush=</span><span class="tok-s">&quot;true&quot;</span><span class="tok-nt">&gt;</span>
                <span class="tok-nt">&lt;level</span> <span class="tok-na">name=</span><span class="tok-s">&quot;TRACE&quot;</span><span class="tok-nt">/&gt;</span>
                <span class="tok-nt">&lt;formatter&gt;</span>
                    <span class="tok-nt">&lt;pattern-formatter</span> <span class="tok-na">pattern=</span><span class="tok-s">&quot;%d{HH:mm:ss,SSS} %-5p [%c] (%t) %s%E%n&quot;</span><span class="tok-nt">/&gt;</span>
                <span class="tok-nt">&lt;/formatter&gt;</span>
                <span class="tok-nt">&lt;file</span> <span class="tok-na">relative-to=</span><span class="tok-s">&quot;jboss.server.log.dir&quot;</span> <span class="tok-na">path=</span><span class="tok-s">&quot;audit.log&quot;</span><span class="tok-nt">/&gt;</span>
                <span class="tok-nt">&lt;suffix</span> <span class="tok-na">value=</span><span class="tok-s">&quot;.yyyy-MM-dd&quot;</span><span class="tok-nt">/&gt;</span>
                <span class="tok-nt">&lt;append</span> <span class="tok-na">value=</span><span class="tok-s">&quot;true&quot;</span><span class="tok-nt">/&gt;</span>
            <span class="tok-nt">&lt;/periodic-rotating-file-handler&gt;</span>
            <span class="tok-nt">&lt;logger</span> <span class="tok-na">category=</span><span class="tok-s">&quot;org.jboss.security&quot;</span><span class="tok-nt">&gt;</span>
                <span class="tok-nt">&lt;level</span> <span class="tok-na">name=</span><span class="tok-s">&quot;TRACE&quot;</span><span class="tok-nt">/&gt;</span>
                <span class="tok-nt">&lt;handlers&gt;</span>
                    <span class="tok-nt">&lt;handler</span> <span class="tok-na">name=</span><span class="tok-s">&quot;AUDIT&quot;</span><span class="tok-nt">/&gt;</span>
                <span class="tok-nt">&lt;/handlers&gt;</span>
            <span class="tok-nt">&lt;/logger&gt;</span>
			...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Con este cambio crearemos un nuevo fichero de log, denominado <em>audit.log</em> en la carpeta de logs del servidor con toda la información de la negociación de la seguridad declarativa.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_administración_de_usuarios_y_roless_con_realmdirect">3.2. Administración de usuarios y roless con RealmDirect</h3>
<div class="paragraph">
<p>La forma de dar de alta o editar usuarios ya la conocemos y es a través del script <em>add-user.sh</em> especificando el realm de Aplicaciones. Desde este script se permite asociar un usuario a uno o varios grupos (roles):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="text">What groups do you want this user to belong to? (Please enter a comma separated list, or leave blank for none)[  ]: usuarios</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
add-user.sh da de alta los usuarios indistintamente en la modalidad de standalone y domain.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Los usuarios se almacenarán con el siguiente formato:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="text">username=HEX(MD5(username &#39;:&#39; realm &#39;:&#39; password))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="text">experto=579f4faae456fd4b742f89e35fa935e2
admin=c22052286cd5d72239a90fe193737253</code></pre>
</div>
</div>
<div class="paragraph">
<p>Los roles se especificarán como texto plano en el fichero <em>application-roles.properties</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">experto=Users</span>
<span class="tok-go">admin=Administrators</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_realm_personalizado">3.2.1. Realm Personalizado</h4>
<div class="paragraph">
<p>Como comentamos, RealmDirect utiliza el ApplicationRealm como Realm por defecto a la hora de autenticar usuarios en ficheros. Es perfectamente posible crear un nuevo Realm con una ubicación de ficheros distinta y especificar dicho Realm como el Realm a utilizar por Realm Direct en nuestro security domain. De esta forma podríamos tener separados los usuarios de nuestra aplicación, del común del servidor. La limitación es que el script add-user no da facilidades para trabajar con distintos Realm por lo que es necesario dar de alta manualmente los usuarios (encriptación(hash) de password incluida).</p>
</div>
</div>
<div class="sect3">
<h4 id="_configuración_de_un_login_module_basado_en_bd">3.2.2. Configuración de un login module basado en BD</h4>
<div class="paragraph">
<p>Vamos a agregar al dominio <em>other</em> el login module <em>Database</em>, apoyado en una base de datos externa siguiendo los siguientes pasos:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crear una base de datos MySQL , denominada "seguridad" con las siguientes tablas</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-k">CREATE</span> <span class="tok-k">TABLE</span> <span class="tok-n">USERS</span> <span class="tok-p">(</span>
    <span class="tok-n">principal_id</span> <span class="tok-nb">VARCHAR</span><span class="tok-p">(</span><span class="tok-mi">64</span><span class="tok-p">)</span> <span class="tok-k">primary</span> <span class="tok-k">key</span><span class="tok-p">,</span>
	<span class="tok-n">password</span> <span class="tok-nb">VARCHAR</span><span class="tok-p">(</span><span class="tok-mi">64</span><span class="tok-p">));</span>
<span class="tok-p">;</span>

<span class="tok-k">CREATE</span> <span class="tok-k">TABLE</span> <span class="tok-n">ROLES</span> <span class="tok-p">(</span>
    <span class="tok-n">principal_id</span> <span class="tok-nb">VARCHAR</span><span class="tok-p">(</span><span class="tok-mi">64</span><span class="tok-p">)</span> <span class="tok-k">primary</span> <span class="tok-k">key</span><span class="tok-p">,</span>
	<span class="tok-n">user_role</span> <span class="tok-nb">VARCHAR</span><span class="tok-p">(</span><span class="tok-mi">64</span><span class="tok-p">),</span>
<span class="tok-p">;</span>

<span class="tok-k">ALTER</span> <span class="tok-k">TABLE</span> <span class="tok-n">ROLES</span>
   <span class="tok-k">ADD</span> <span class="tok-k">CONSTRAINT</span> <span class="tok-n">FK1_PRINCIPLES</span>
   <span class="tok-k">FOREIGN</span> <span class="tok-k">KEY</span> <span class="tok-p">(</span> <span class="tok-n">principal_id</span><span class="tok-p">)</span>
   <span class="tok-k">REFERENCES</span> <span class="tok-n">USERS</span> <span class="tok-p">(</span><span class="tok-n">principal_id</span><span class="tok-p">)</span>
   <span class="tok-k">ON</span> <span class="tok-k">DELETE</span> <span class="tok-k">CASCADE</span>
<span class="tok-p">;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Definir un usuario específico para la conexión a la BD seguridad: <em>usuSeg</em>, clave <em>usuSeg</em>. Esto lo podéis hacer desde la herramienta MySQL Workbench que tenéis en Linux.</p>
</li>
<li>
<p>Crear un origen de datos en WildFly, de nombre <em>java:jboss/datasources/seguridad</em>, que acceda a la BD que acabamos de crear.</p>
</li>
<li>
<p>Crear un nuevo security domain que utilice el login module <em>Database</em>:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">#</span> Crear un nuevo security domain con seguridad basada en base de datos
<span class="tok-go">batch</span>

<span class="tok-go">connect</span>

<span class="tok-gp">#</span> Configure the security domain
<span class="tok-go">/subsystem=security/security-domain=seguridad/:add(cache-type=default)</span>
<span class="tok-go">/subsystem=security/security-domain=seguridad/authentication=classic:add(login-modules=[{&quot;code&quot;=&gt;&quot;Database&quot;, &quot;flag&quot;=&gt;&quot;required&quot;, &quot;module-options&quot;=&gt;[(&quot;dsJndiName&quot;=&gt;&quot;java:jboss/datasources/seguridad&quot;),(&quot;principalsQuery&quot;=&gt;&quot;SELECT PASSWORD FROM USERS WHERE principal_id = ?&quot;), (&quot;rolesQuery&quot;=&gt;&quot;SELECT user_role, &#39;Roles&#39; FROM ROLES where principal_id = ?&quot;)]}])</span>

<span class="tok-gp">#</span> Run the batch commands
<span class="tok-go">run-batch</span>

<span class="tok-gp">#</span> Reload the server configuration
<span class="tok-go">:reload</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Grupos</div>
WildFly no introduce el concepto de grupos de usuarios pero la implementación del Login Module Database es muy flexible, por lo que se puede modelar una tabla de grupos, asociar usuarios a grupos y permitir asociar roles a los grupos. Después de esto, bastaría con modificar las queries de recuperación de roles.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_protección_de_las_password">3.2.3. Protección de las password</h4>
<div class="paragraph">
<p>Nuevamente WildFly no nos da un sistema directo para proteger las constraseñas pero si nos permite especificar un mecanismo de encriptación/hash y encargarnos nosotros mismos de su gestión. Concretamente hay que añadir las siguientes opciones al login module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;module-option</span> <span class="tok-na">name=</span><span class="tok-s">&quot;password-stacking&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;useFirstPass&quot;</span><span class="tok-nt">/&gt;</span>
<span class="tok-nt">&lt;module-option</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hashAlgorithm&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;MD5&quot;</span><span class="tok-nt">/&gt;</span>
<span class="tok-nt">&lt;module-option</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hashEncoding&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;hex&quot;</span><span class="tok-nt">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Con estas opciones se especifica el algoritmo para calcular el hash a partir de la contraseña, así como la forma de convertir la cadena binaria resultande en una representación en formato de texto (base64).</p>
</div>
<div class="paragraph">
<p>En la siguiente dirección tenéis una utilidad para calcular estos hash, es importante que el hash generado se introduzca en minúsculas porque la validación es case sensitive: <a href="http://md5-hash-online.waraxe.us/" class="bare">http://md5-hash-online.waraxe.us/</a></p>
</div>
<div class="sect4">
<h5 id="_aplicación_web_de_ejemplo">Aplicación Web de Ejemplo</h5>
<div class="paragraph">
<p>Vamos a construir una sencilla aplicación Web que aproveche la configuración de seguridad que hemos preparado hasta ahora. Esta aplicación Web contará con un único servlet que mostrará la lista de usuarios de la BD seguridad.</p>
</div>
<div class="paragraph">
<p>Para ello definiremos un servlet y lo protegeremos de tal modo que sólo los usuarios y administradores puedan acceder a él. Utilizaremos la autenticación Basic para simplificar.</p>
</div>
<div class="paragraph">
<p>Lo construiremos en los siguientes pasos:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Configurar el nuevo dominio "seguridad" en IntelliJ. Crear un nuevo proyecto Web, mediante Maven.</p>
</li>
<li>
<p>Crear un servlet que responda a la ruta /listado, y que devuelva la consulta:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@WebServlet</span><span class="tok-o">(</span><span class="tok-s">&quot;/protegido/ConsultaServlet&quot;</span><span class="tok-o">)</span>
<span class="tok-nd">@ServletSecurity</span><span class="tok-o">(</span><span class="tok-nd">@HttpConstraint</span><span class="tok-o">(</span><span class="tok-n">rolesAllowed</span> <span class="tok-o">=</span> <span class="tok-o">{</span> <span class="tok-s">&quot;rol_usuario&quot;</span><span class="tok-o">,</span><span class="tok-s">&quot;rol_administrador&quot;</span> <span class="tok-o">}))</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">ConsultaServlet</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span> <span class="tok-o">{</span>

    <span class="tok-nd">@Resource</span><span class="tok-o">(</span><span class="tok-n">mappedName</span> <span class="tok-o">=</span> <span class="tok-s">&quot;java:jboss/datasources/seguridad&quot;</span><span class="tok-o">)</span>
    <span class="tok-n">DataSource</span> <span class="tok-n">segDS</span><span class="tok-o">;</span>

    <span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">processRequest</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                                  <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>
            <span class="tok-kd">throws</span> <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>

        <span class="tok-n">String</span> <span class="tok-n">query</span> <span class="tok-o">=</span> <span class="tok-s">&quot;SELECT * FROM USERS&quot;</span><span class="tok-o">;</span>
        <span class="tok-n">Connection</span> <span class="tok-n">conn</span> <span class="tok-o">=</span> <span class="tok-kc">null</span><span class="tok-o">;</span>
        <span class="tok-n">Statement</span> <span class="tok-n">stmt</span><span class="tok-o">;</span>

        <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setContentType</span><span class="tok-o">(</span><span class="tok-s">&quot;text/html;charset=UTF-8&quot;</span><span class="tok-o">);</span>

        <span class="tok-n">PrintWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>
        <span class="tok-k">try</span> <span class="tok-o">{</span>

            <span class="tok-n">conn</span> <span class="tok-o">=</span> <span class="tok-n">segDS</span><span class="tok-o">.</span><span class="tok-na">getConnection</span><span class="tok-o">();</span>
            <span class="tok-n">stmt</span> <span class="tok-o">=</span> <span class="tok-n">conn</span><span class="tok-o">.</span><span class="tok-na">createStatement</span><span class="tok-o">();</span>


            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;html&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;head&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;title&gt;Servlet listado&lt;/title&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/head&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;body&gt;&quot;</span><span class="tok-o">);</span>

            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;Lista de usuarios:&lt;BR/&gt;&quot;</span><span class="tok-o">);</span>

            <span class="tok-n">ResultSet</span> <span class="tok-n">rs</span> <span class="tok-o">=</span> <span class="tok-n">stmt</span><span class="tok-o">.</span><span class="tok-na">executeQuery</span><span class="tok-o">(</span><span class="tok-n">query</span><span class="tok-o">);</span>
            <span class="tok-k">while</span><span class="tok-o">(</span><span class="tok-n">rs</span><span class="tok-o">.</span><span class="tok-na">next</span><span class="tok-o">())</span>
            <span class="tok-o">{</span>
                <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">rs</span><span class="tok-o">.</span><span class="tok-na">getString</span><span class="tok-o">(</span><span class="tok-s">&quot;principal_id&quot;</span><span class="tok-o">)+</span><span class="tok-s">&quot;/&quot;</span><span class="tok-o">+</span><span class="tok-n">rs</span><span class="tok-o">.</span><span class="tok-na">getString</span><span class="tok-o">(</span><span class="tok-s">&quot;password&quot;</span><span class="tok-o">)+</span><span class="tok-s">&quot;&lt;br/&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-o">}</span>

            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/body&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/html&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">Exception</span> <span class="tok-n">e</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">e</span><span class="tok-o">.</span><span class="tok-na">getMessage</span><span class="tok-o">());</span>

        <span class="tok-o">}</span> <span class="tok-k">finally</span> <span class="tok-o">{</span>
            <span class="tok-k">try</span> <span class="tok-o">{</span>
                <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
                <span class="tok-k">if</span><span class="tok-o">(</span><span class="tok-n">conn</span><span class="tok-o">!=</span><span class="tok-kc">null</span><span class="tok-o">)</span>
                    <span class="tok-n">conn</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
            <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">SQLException</span> <span class="tok-n">ex</span><span class="tok-o">)</span> <span class="tok-o">{</span>
                <span class="tok-n">Logger</span><span class="tok-o">.</span><span class="tok-na">getLogger</span><span class="tok-o">(</span><span class="tok-n">ConsultaServlet</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getName</span><span class="tok-o">()).</span><span class="tok-na">log</span><span class="tok-o">(</span><span class="tok-n">Level</span><span class="tok-o">.</span><span class="tok-na">SEVERE</span><span class="tok-o">,</span> <span class="tok-kc">null</span><span class="tok-o">,</span> <span class="tok-n">ex</span><span class="tok-o">);</span>
            <span class="tok-o">}</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span></code></pre>
</div>
</div>
</li>
<li>
<p>Configurar los descriptores de despliegue. El archivo web.xml tendrá un aspecto parecido a este:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"> <span class="tok-nt">&lt;session-config&gt;</span>
  <span class="tok-nt">&lt;session-timeout&gt;</span>30<span class="tok-nt">&lt;/session-timeout&gt;</span>
  <span class="tok-nt">&lt;/session-config&gt;</span>
 <span class="tok-nt">&lt;welcome-file-list&gt;</span>
  <span class="tok-nt">&lt;welcome-file&gt;</span>index.jsp<span class="tok-nt">&lt;/welcome-file&gt;</span>
  <span class="tok-nt">&lt;/welcome-file-list&gt;</span>
 <span class="tok-nt">&lt;login-config&gt;</span>
  <span class="tok-nt">&lt;auth-method&gt;</span>BASIC<span class="tok-nt">&lt;/auth-method&gt;</span>
  <span class="tok-nt">&lt;realm-name&gt;</span>Mi dominio de seguridad<span class="tok-nt">&lt;/realm-name&gt;</span>
  <span class="tok-nt">&lt;/login-config&gt;</span>
 <span class="tok-nt">&lt;security-role&gt;</span>
  <span class="tok-nt">&lt;description</span> <span class="tok-nt">/&gt;</span>
  <span class="tok-nt">&lt;role-name&gt;</span>rol_usuario<span class="tok-nt">&lt;/role-name&gt;</span>
  <span class="tok-nt">&lt;/security-role&gt;</span>
 <span class="tok-nt">&lt;security-role&gt;</span>
  <span class="tok-nt">&lt;description</span> <span class="tok-nt">/&gt;</span>
  <span class="tok-nt">&lt;role-name&gt;</span>rol_administrador<span class="tok-nt">&lt;/role-name&gt;</span>
  <span class="tok-nt">&lt;/security-role&gt;</span>
  <span class="tok-nt">&lt;/web-app&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
WildFly en su versión 8.10 da algunos problemas a la hora de combinar diferentes tipos de restricciones de integridad sobre un mismo recurso. Como recomendación intentad siempre que sea posible, no declarar más de una restricción sobre un mismo recurso de la aplicación.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Añadiremos el descriptor específico de WildFly <em>jboss-web.xml</em>, en la carpeta WEB-INF:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;jboss-web</span> <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://www.jboss.com/xml/ns/javaee&quot;</span>
           <span class="tok-na">xmlns:xsi=</span><span class="tok-s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
           <span class="tok-na">xsi:schemaLocation=</span><span class="tok-s">&quot;http://www.jboss.com/xml/ns/javaee http://www.jboss.org/schema/jbossas/jboss-web_8_0.xsd&quot;</span>
           <span class="tok-na">version=</span><span class="tok-s">&quot;8.0&quot;</span><span class="tok-nt">&gt;</span>

    <span class="tok-nt">&lt;context-root&gt;</span>/intranet<span class="tok-nt">&lt;/context-root&gt;</span>
    <span class="tok-nt">&lt;security-domain&gt;</span>
        seguridad
    <span class="tok-nt">&lt;/security-domain&gt;</span>
<span class="tok-nt">&lt;/jboss-web&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En el estamos indicando tanto el contexto raiz de la aplicación como el security domain contra el que vamos a autenticarnos.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_integración_con_un_servidor_ldap_externo">3.2.4. Integración con un servidor LDAP Externo</h4>
<div class="paragraph">
<p>LDAP ("Lightweight Directory Acces Protocol") es un protocolo de tipo cliente-servidor para acceder a un servicio de directorio.</p>
</div>
<div class="paragraph">
<p>Cada entrada en el directorio LDAP describe un objeto (por ejemplo: una persona, un recurso de red, una organización) y tiene un único identificador llamado Nombre Distinguido (DN, Distinguished Name). La entrada consiste de una colección de atributos (por ejemplo una persona podría tener apellido, organización, e-mail). Para encontrar las entradas hay que navegar a través del Árbol de Información de Directorio (DIT, Directory Information Tree). En la raíz del árbol se encuentra "el mundo", el cual esta subdividido en el siguiente nivel en países, y en el siguiente en organizaciones. Dentro de las organizaciones se almacenan información de gente, recursos, etc.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas03/ldap1.png" alt="ldap1" width="100%">
</div>
</div>
<div class="paragraph">
<p>Es habitual en empresas de cierto tamaño el tener un servidor donde se almacena la información corporativa de directorio. Los servidores de aplicaciones suelen integrar componentes que permiten acceder a la información de usuarios y roles que resida en dicho servidor LDAP.</p>
</div>
<div class="paragraph">
<p>En nuestra máquina virtual, podemos simular este directorio corporativo instalando OpenLDAP y cargando un directorio de pruebas. Estos serán los pasos a seguir:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Instalar el servidor SLDAPd ejecutando los comandos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">sudo apt-get update</span>
<span class="tok-go">sudo apt-get -y install slapd ldap-utils</span></code></pre>
</div>
</div>
</li>
<li>
<p>Configuración básica del directorio:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">sudo dpkg-reconfigure slapd</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all" style="width: 70%;">
<colgroup>
<col style="width: 75%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Preguntas</th>
<th class="tableblock halign-left valign-top">Respuestas</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Omit OpenLDAP server configuration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DNS domain name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ua.es</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Organization name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">jtech</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Administrator password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">expertojavajs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Database backend to use</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HDB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Do you want the database to be purged</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Move old database</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allow LDAPv2 protocol</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>Configurar el nuevo dominio LDAP mediante un script en lenguaje LDIF:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">#</span>grupo de usuarios
<span class="tok-go">dn: ou=users,dc=ua,dc=es</span>
<span class="tok-go">objectClass: organizationalUnit</span>
<span class="tok-go">ou: users</span>

<span class="tok-gp">#</span>grupo de roles
<span class="tok-go">dn: ou=roles,dc=ua,dc=es</span>
<span class="tok-go">objectClass: organizationalUnit</span>
<span class="tok-go">ou: roles</span>

<span class="tok-gp">#</span>alumno1
<span class="tok-go">dn: uid=alu1,ou=users,dc=ua,dc=es</span>
<span class="tok-go">objectclass: top</span>
<span class="tok-go">objectclass: uidObject</span>
<span class="tok-go">objectClass: inetOrgPerson</span>
<span class="tok-go">objectclass: person</span>
<span class="tok-go">uid: alu1</span>
<span class="tok-go">cn: Cuenta de alu1</span>
<span class="tok-go">sn: alu1</span>
<span class="tok-go">userPassword: alu1</span>
<span class="tok-go">mail: alu1@ua.es</span>

<span class="tok-gp">#</span>alumno2
<span class="tok-go">dn: uid=alu2,ou=users,dc=ua,dc=es</span>
<span class="tok-go">objectclass: top</span>
<span class="tok-go">objectclass: uidObject</span>
<span class="tok-go">objectClass: inetOrgPerson</span>
<span class="tok-go">objectclass: person</span>
<span class="tok-go">uid: alu2</span>
<span class="tok-go">cn: Cuenta de alu2</span>
<span class="tok-go">sn: alu2</span>
<span class="tok-go">userPassword: alu2</span>
<span class="tok-go">mail: alu2@ua.es</span>

<span class="tok-gp">#</span>profesor1
<span class="tok-go">dn: uid=prof1,ou=users,dc=ua,dc=es</span>
<span class="tok-go">objectclass: top</span>
<span class="tok-go">objectclass: uidObject</span>
<span class="tok-go">objectClass: inetOrgPerson</span>
<span class="tok-go">objectclass: person</span>
<span class="tok-go">uid: prof1</span>
<span class="tok-go">cn: Cuenta de prof1</span>
<span class="tok-go">sn: prof1</span>
<span class="tok-go">userPassword: prof1</span>
<span class="tok-go">mail: prof1@ua.es</span>

<span class="tok-gp">#</span>definir rol_usuario y miembros
<span class="tok-go">dn: cn=rol_usuario,ou=roles,dc=ua,dc=es</span>
<span class="tok-go">objectclass: top</span>
<span class="tok-go">objectclass: groupOfNames</span>
<span class="tok-go">cn: rol_usuario</span>
<span class="tok-go">description: grupo de alumnos</span>
<span class="tok-go">member: uid=alu1,ou=users,dc=ua,dc=es</span>
<span class="tok-go">member: uid=alu2,ou=users,dc=ua,dc=es</span>

<span class="tok-gp">#</span>definir rol_administrador y miembros
<span class="tok-go">dn: cn=rol_administrador,ou=roles,dc=ua,dc=es</span>
<span class="tok-go">objectclass: top</span>
<span class="tok-go">objectclass: groupOfNames</span>
<span class="tok-go">cn: rol_administrador</span>
<span class="tok-go">description: grupo de profesores</span>
<span class="tok-go">member: uid=prof1,ou=users,dc=ua,dc=es</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>No vamos a entrar en detalle sobre cómo se configura un servidor LDAP, pero como podéis ver en la configuración, hay una clara jerarquía de objetos. Partiendo del dominio jtech, se crea un usuario administrador y dos unidades organizativas. Dentro de esas dos unidades organizativas (usuarios y grupos) crearemos a su vez un usuario (de login usuario) y un grupo denominado usuarios.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Si os fijáis, al final se indica que el usuario "usuario" pertenece al grupo "usuarios". Cada objeto que hemos comentado se localiza por su dn y en su nombre va arrastrando toda la estructura del directorio.</p>
</div>
<div class="paragraph">
<p>Para cargar esta configuración en nuestro LDAP, debéis ejecutar lo siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">sudo ldapadd -x -D cn=admin,dc=ua,dc=es -W -f directorio.ldif</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para comprobar que todo ha ido bien, podéis consultar el directorio mediante el comando ldapsearch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">sudo ldapsearch -x -b &#39;dc=ua,dc=es&#39; &#39;(objectclass=*)&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>(El asterisco es un comodín, si queréis podéis probar a sustituirlo por cualquier valor de "objectclass" que veáis en la configuración).</p>
</div>
<div class="sect4">
<h5 id="_jxplorer">JXplorer</h5>
<div class="paragraph">
<p>Otra opción para trabajar sobre el directorio es utilizar un cliente LDAP, como por ejemplo, JXplorer. Una vez el directorio tenga la configuración básica, podemos conectarnos a él, indicando el dn de la organización y el usuario/password del administrador. Se nos mostrará gráficamente la composición del directorio y se nos permitirá añadir/modificar/borrar elementos del mismo:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas03/ldap2.png" alt="ldap2" width="50%">
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas03/ldap3.png" alt="ldap3" width="66%">
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_login_module_ldapextended">3.2.5. Login module LdapExtended</h4>
<div class="paragraph">
<p>Una vez configurado nuestro directorio LDAP, debemos añadir y configurar el login module específico para Ldap en  nuestro security domain:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;login-module</span> <span class="tok-na">code=</span><span class="tok-s">&quot;LdapExtended&quot;</span> <span class="tok-na">flag=</span><span class="tok-s">&quot;required&quot;</span> <span class="tok-nt">&gt;</span>
	<span class="tok-nt">&lt;module-option</span> <span class="tok-na">name=</span><span class="tok-s">&quot;java.naming.factory.initial&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;com.sun.jndi.ldap.LdapCtxFactory&quot;</span><span class="tok-nt">/&gt;</span>
	<span class="tok-nt">&lt;module-option</span> <span class="tok-na">name=</span><span class="tok-s">&quot;java.naming.provider.url&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;ldap://localhost:389&quot;</span><span class="tok-nt">/&gt;</span>
	<span class="tok-nt">&lt;module-option</span> <span class="tok-na">name=</span><span class="tok-s">&quot;java.naming.security.authentication&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;simple&quot;</span><span class="tok-nt">/&gt;</span>
	<span class="tok-nt">&lt;module-option</span> <span class="tok-na">name=</span><span class="tok-s">&quot;bindDN&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;cn=admin,dc=ua,dc=es&quot;</span><span class="tok-nt">/&gt;</span>
	<span class="tok-nt">&lt;module-option</span> <span class="tok-na">name=</span><span class="tok-s">&quot;bindCredential&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;expertojavajs&quot;</span><span class="tok-nt">/&gt;</span>
	<span class="tok-nt">&lt;module-option</span> <span class="tok-na">name=</span><span class="tok-s">&quot;baseCtxDN&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;ou=users,dc=ua,dc=es&quot;</span><span class="tok-nt">/&gt;</span>
	<span class="tok-nt">&lt;module-option</span> <span class="tok-na">name=</span><span class="tok-s">&quot;baseFilter&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;(uid={0})&quot;</span> <span class="tok-nt">/&gt;</span>

	<span class="tok-nt">&lt;module-option</span> <span class="tok-na">name=</span><span class="tok-s">&quot;rolesCtxDN&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;ou=roles,dc=ua,dc=es&quot;</span> <span class="tok-nt">/&gt;</span>
	<span class="tok-nt">&lt;module-option</span> <span class="tok-na">name=</span><span class="tok-s">&quot;roleFilter&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;(member={1})&quot;</span> <span class="tok-nt">/&gt;</span>
	<span class="tok-nt">&lt;module-option</span> <span class="tok-na">name=</span><span class="tok-s">&quot;roleAttributeID&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;cn&quot;</span> <span class="tok-nt">/&gt;</span>

	<span class="tok-nt">&lt;module-option</span> <span class="tok-na">name=</span><span class="tok-s">&quot;searchScope&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;ONELEVEL_SCOPE&quot;</span> <span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;module-option</span> <span class="tok-na">name=</span><span class="tok-s">&quot;allowEmptyPasswords&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;true&quot;</span> <span class="tok-nt">/&gt;</span>
<span class="tok-nt">&lt;/login-module&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Cuidado con los espacios en blanco después de los valores de cada propiedad que configuréis tanto en los ficheros LDIF como en los valores de las propiedades. Os ahorraréis bastantes quebraderos de cabeza&#8230;&#8203;
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_role_based_access_control_en_interfaces_de_administración">3.3. Role Based Access Control en interfaces de administración</h3>
<div class="paragraph">
<p>Por último, comentar que a partir de WildFly 8, se introduce también el control de autorización en tareas administrativas. Hasta ahora en JBoss cualquier usuario con acceso al ManagementRealm se consideraba super usuario y podía realizar cualquier tarea de administración. Desde esta nueva versión es posible establecer un control mas preciso de lo que un usuario puede hacer y lo que no, habilitando el control RBAC:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;management&gt;</span>

        <span class="tok-nt">&lt;access-control</span> <span class="tok-na">provider=</span><span class="tok-s">&quot;simple&quot;</span><span class="tok-nt">&gt;</span> <span class="tok-c">&lt;!-- cambiar por rbac--&gt;</span>
            <span class="tok-nt">&lt;role-mapping&gt;</span>
                <span class="tok-nt">&lt;role</span> <span class="tok-na">name=</span><span class="tok-s">&quot;SuperUser&quot;</span><span class="tok-nt">&gt;</span>
                    <span class="tok-nt">&lt;include&gt;</span>
                        <span class="tok-nt">&lt;user</span> <span class="tok-na">name=</span><span class="tok-s">&quot;$local&quot;</span><span class="tok-nt">/&gt;</span>
						<span class="tok-nt">&lt;user</span> <span class="tok-na">alias=</span><span class="tok-s">&quot;experto&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;experto&quot;</span> <span class="tok-nt">/&gt;</span> <span class="tok-c">&lt;!-- Añadir al menos un usuario como Superusuario después del cambio --&gt;</span>
                    <span class="tok-nt">&lt;/include&gt;</span>
                <span class="tok-nt">&lt;/role&gt;</span>
            <span class="tok-nt">&lt;/role-mapping&gt;</span>
        <span class="tok-nt">&lt;/access-control&gt;</span>

    <span class="tok-nt">&lt;/management&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En la sección de roles se muestra un único rol (superusuario), pero tras habilitar el mecanismo de roles tenemos a disposición nuestra los siguientes roles:</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 80%;">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Role</th>
<th class="tableblock halign-left valign-top">Permissions</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Monitor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">El más restrictivo. Solo permisos de consulta de la información en tiempo de ejecución. No permite la consulta de recursos, datos o información de log.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Operator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Los permisos de Monitor y además puede parar/arrancar instancias, activar/desactivar colas JMS y liberar conexiones de base de datos.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maintainer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Los permisos del Operator y además puede modificar la configuración: desplegar nuevas aplicaciones y recursos.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Deployer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Los permisos de Maintainer pero restringidos al despliegue de aplicaciones.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Administrator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Los permisos de Maintainer  pero además permite ver y modificar datos sensibles tales como sistemas de seguridad. No tiene acceso al sistema de auditoria de administración (audit loggin system).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Auditor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Los permisos del monitor más la posibilidad de poder consultar/modificar el audit logging system).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Super User</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tiene todos los permisos, y es el equivalente al usuario administrador de versiones anteriores.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>La administración de la asignación de roles a usuarios y/o grupos está integrada en la consola Web, en contraposición al alta de usuarios, que se sigue haciendo por script.</p>
</div>
<div class="paragraph">
<p>En el caso de querer asociar un grupo de usuarios (mgmt-groups.properties) a un rol de administración, se añadiría de la siguiente forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;role</span> <span class="tok-na">name=</span><span class="tok-s">&quot;Deployer&quot;</span><span class="tok-nt">&gt;</span>
	<span class="tok-nt">&lt;include&gt;</span>
		<span class="tok-nt">&lt;group</span> <span class="tok-na">alias=</span><span class="tok-s">&quot;group-lead-devs&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;lead-developers&quot;</span><span class="tok-nt">/&gt;</span>
	<span class="tok-nt">&lt;/include&gt;</span>
<span class="tok-nt">&lt;/role&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_referencias_3">3.4. Referencias</h3>
<div class="ulist">
<ul>
<li>
<p>WildFly Administration Guide <a href="https://docs.jboss.org/author/display/WFLY8/Admin+Guide" class="bare">https://docs.jboss.org/author/display/WFLY8/Admin+Guide</a></p>
</li>
<li>
<p>OpenLDAP <a href="http://www.openldap.org/doc/admin24/quickstart.html" class="bare">http://www.openldap.org/doc/admin24/quickstart.html</a></p>
</li>
<li>
<p>Instalar LDAP en Ubuntu <a href="http://www.openxarxes.com/instalar-y-configurar-ldap-en-ubuntu-lucid-10-04/" class="bare">http://www.openxarxes.com/instalar-y-configurar-ldap-en-ubuntu-lucid-10-04/</a></p>
</li>
<li>
<p>Security Realms <a href="https://docs.jboss.org/author/display/AS71/Security+Realms" class="bare">https://docs.jboss.org/author/display/AS71/Security+Realms</a></p>
</li>
<li>
<p>Security subsystem configuration <a href="https://docs.jboss.org/author/display/AS71/Security+subsystem+configuration" class="bare">https://docs.jboss.org/author/display/AS71/Security+subsystem+configuration</a></p>
</li>
<li>
<p>Role Based Access Control <a href="https://docs.jboss.org/author/display/WFLY9/RBAC" class="bare">https://docs.jboss.org/author/display/WFLY9/RBAC</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios_de_seguridad_declarativa_en_wildfly">3.5. Ejercicios de seguridad declarativa en WildFly</h3>
<div class="paragraph">
<p>Nuestro siguiente proyecto será poner en marcha una sencilla intranet para nuestra organización donde se muestren las noticias más importantes del día.</p>
</div>
<div class="paragraph">
<p>Trabajaréis sobre el proyecto Maven <em>apli-intranet</em>. Esta aplicación web contempla dos tipos de acciones:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Consulta de noticias del día, abierta a cualquier empleado (autenticado) de la empresa, mediante el servlet <em>ConsultaServlet</em>.</p>
</li>
<li>
<p>Alta de nuevas noticias, únicamente habilitada para los usuarios administradores de la intranet con el servlet <em>NuevoMensajeServlet</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>El contexto raíz de la aplicación debe ser <em>/intranet</em> y a este nivel se encuentra la página y el servlet que implementan la consulta. El JSP y Servlet de alta de noticias se encuentran en <em>/intranet/admin</em> para que podamos establecer restricciones de seguridad diferenciadas.</p>
</div>
<div class="paragraph">
<p>La información relativa a nuestra aplicación se almacenará en la BD <em>seguridad</em> que hemos presentado en la teoría y que crearemos con el script incluido en las plantillas. Para acceder a la base de datos, crearemos un  origen de datos al que denominaremos <em>java:jboss/datasources/seguridad</em>.</p>
</div>
<div class="paragraph">
<p>La tabla donde almacenaremos las noticias tiene el siguiente esquema:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-k">CREATE</span> <span class="tok-k">TABLE</span>  <span class="tok-o">`</span><span class="tok-n">noticias</span><span class="tok-o">`</span> <span class="tok-p">(</span>
  <span class="tok-o">`</span><span class="tok-n">fecha</span><span class="tok-o">`</span> <span class="tok-k">timestamp</span> <span class="tok-k">NOT</span> <span class="tok-k">NULL</span> <span class="tok-k">DEFAULT</span> <span class="tok-k">CURRENT_TIMESTAMP</span><span class="tok-p">,</span>
  <span class="tok-o">`</span><span class="tok-n">noticia</span><span class="tok-o">`</span> <span class="tok-nb">varchar</span><span class="tok-p">(</span><span class="tok-mi">1024</span><span class="tok-p">)</span> <span class="tok-k">DEFAULT</span> <span class="tok-k">NULL</span>
<span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para poner en marcha este proyecto definiremos la seguridad en tres fases separadas, en las que iremos sumando distintos orígenes de datos de información de autenticación (ficheros, base de datos, LDAP) para que trabajen de forma <em>conjunta</em>.</p>
</div>
<div class="sect3">
<h4 id="_configuración_despliegue_y_alta_de_usuarios_en_wildfly_0_6_puntos">3.5.1. Configuración, despliegue y alta de usuarios en WildFly (0.6 puntos)</h4>
<div class="paragraph">
<p>En este ejercicio configuraremos el modelo de seguridad general que queremos para nuestra aplicación. Para ello crearemos un nuevo security domain, al que llamaremos <strong>seguridad-domain</strong>. Funcionará de forma similar al security domain <em>Other</em> pero almacenando la información de usuarios y roles en ficheros específicos.</p>
</div>
<div class="paragraph">
<p>Será necesario crear un nuevo realm, de nombre <strong>IntranetRealm</strong> y que almacenará la información de usuarios en los siguientes ficheros:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>intranet-users.properties</p>
</li>
<li>
<p>intranet-roles.properties</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Una vez definido el modelo de seguridad general, definiremos los siguientes roles:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>usuarios</em>, que contendrán al conjunto de usuarios de la empresa y tendrán el rol: <em>rol_usuario</em>.</p>
</li>
<li>
<p><em>administradores</em>, que serán aquellos usuarios que tengan permiso para dar de alta nuevas noticias en la aplicación, poseerán el rol: <em>rol_administrador</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Como el desarrollo de la aplicación lo llevan a cabo dos programadores, daremos de alta cada uno de ello con un rol distinto y los incluiremos como usuarios del IntranetRealm de WildFly:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>programador1</em> (clave programador1), que tendrá asociado el rol usuario.</p>
</li>
<li>
<p><em>programador2</em> (clave programador2), asociado al rol administrador.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Por último, habrá que modificar el código fuente de la aplicación para que:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Se utilice el nuevo security domain y especificar el contexto raíz /intranet.</p>
</li>
<li>
<p>Definir los roles autorizados para ejecutar los distintos servlets mediante anotaciones:</p>
<div class="ulist">
<ul>
<li>
<p>/ConsultaServlet: roles usuario y administrador:</p>
</li>
<li>
<p>/admin/NuevoMensajeServlet: sólo podrán ejecutarlo los usuarios administradores</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Debéis comprobar que el usuario "programador1" sólo puede ver las noticias del día, mientras que el usuario "programador2" también puede añadir nuevas noticias a la base de datos.</p>
</div>
</div>
<div class="sect3">
<h4 id="_gestión_de_usuarios_en_base_de_datos_0_3_puntos">3.5.2. Gestión de usuarios en Base de datos (0.3 puntos)</h4>
<div class="paragraph">
<p>En nuestra empresa hay un número variable de empleados externos. Estos empleados no pertenecen a ningún directorio corporativo pero se mantienen en una base de datos. El objetivo de este ejercicio es añadir al security domain un login module que trabaje con usuarios y grupos mantenidos en la BD <em>seguridad</em>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Debeis configurar login module como se explica en teoría, configurando el parámetro <em>flag</em> de los login module de modo que un usuario se reconozca como autenticado cuando sea válido para al menos un login module (basado en ficheros o en BD).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para comprobar que todo está en orden, daréis de alta los siguientes usuarios:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>consultor1</em> (clave consultor1), asociado al rol usuario.</p>
</li>
<li>
<p><em>consultor2</em> (clave consultor2), asociado al rol administrador.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Es importante almacenar las contraseñas codificadas por tanto hay que configurar el login module de modo que utilice MD5 en la validación. Asimismo tenéis que comprobar que los usuarios programador1 y programador2 siguen trabajando con normalidad!!</p>
</div>
</div>
<div class="sect3">
<h4 id="_seguridad_integrada_con_ldap_corporativo_0_3_puntos">3.5.3. Seguridad integrada con LDAP corporativo (0.3 puntos)</h4>
<div class="paragraph">
<p>En esta última fase, enlazaremos el directorio corporativo de la empresa con el security domain de WildFly, de modo que un usuario se definirá en el directorio, y en función del rol asociado, tendrá acceso parcial o completo a la aplicación.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Debéis seguir los pasos descritos en teoría y ejecutar el script LDIF que se adjuntan como plantilla. Este script creará automáticamente los siguientes usuarios:
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p><em>alu1</em> (clave alu1) asociado al rol usuario.</p>
</li>
<li>
<p><em>alu2</em> (clave alu2) asociado al rol usuario.</p>
</li>
<li>
<p><em>prof1</em> (clave prof1) asociado al rol administrador.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Podéis utilizar la herramienta <em>JXplorer</em> para comprobar que los usuarios se han creado correctamente, y si tenéis problemas para autenticar algún usuario, recordad que tenéis que habilitar la auditoría de seguridad, para que os dé más detalle de lo que ocurre.</p>
</div>
<div class="paragraph">
<p>El resultado de las tres fases es un security domain que obtiene información sobre los usuarios de múltiples orígenes y permite establecer reglas de seguridad unificadas.</p>
</div>
</div>
<div class="sect3">
<h4 id="_entrega_2">3.5.4. Entrega</h4>
<div class="paragraph">
<p>En esta sesión debeis entregar el proyecto apli-intranet con las modificaciones requeridas y la configuración de WildFly <em>standalone.xml</em>.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion04">4. Certificados digitales y SSL</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Esta sesión está dedicada a entender en qué consiste la seguridad en la capa de transporte y cómo utilizar certificados digitales.</p>
</div>
<div class="sect2">
<h3 id="_seguridad_en_la_capa_de_transporte">4.1. Seguridad en la capa de transporte</h3>
<div class="sect3">
<h4 id="_certificados_digitales">4.1.1. Certificados digitales</h4>
<div class="paragraph">
<p>Junto con los passwords, el mecanismo de autentificación más común en aplicaciones enterprise son los certificados. Comúnmente se emplean para autentificar al servidor, pero también se pueden usar para el cliente, como se hace en la mayoría de organismos oficiales que ofrecen servicios a través de la red.</p>
</div>
<div class="paragraph">
<p>El uso de certificados viene derivado de la criptografía asimétrica en las que se trabaja con dos claves una privada y una pública. En el caso de una comunicación emisor/receptor podemos plantear dos supuestos:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>El emisor encripta un mensaje mediante una clave pública y el receptor lo desencripta mediante una clave privada que sólo él conoce. Este tipo de comunicación garantiza la confidencialidad del mensaje pues sólo el receptor puede saber qué contiene realmente.</p>
</li>
<li>
<p>El emisor encripta un mensaje mediante una clave privada que sólo él conoce. El receptor en cambio lo desencripta con una clave pública que cualquier puede utilizar. Mediante este sistema garantizamos la identidad del emisor, y es la base de la <strong>firma digital</strong>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Un certificado digital no es ni más ni menos que un pequeño documento en el que incluye información sobre la identidad de un individuo o empresa, y una clave pública asociada a este individuo. Por este motivo, también se les conoce como certificados de clave pública o certificados de identidad. Existen varios formatos para certificados digitales no obstante los más comunes se rigen por el estándar <strong>X.509</strong>.</p>
</div>
<div class="paragraph">
<p>Esta asociación debe ir firmada digitalmente por alguien de confianza que le otorgue validez, que son las denominadas <strong>autoridades de certificación</strong> (CA). Hay autoridades de certificación privadas, compañías como Thawte o Verisign, y también públicas. En España tenemos la FNMT y en muchas comunidades autónomas también tienen sus propias CA&#8217;s.</p>
</div>
<div class="paragraph">
<p>Estas entidades a su vez utilizan certificados digitales para acreditar su identidad y poder firmar digitalmente nuestros certificados, por tanto podríamos llegar a plantearnos ¿Quién firma los certificados de las autoridades certificadoras?</p>
</div>
<div class="paragraph">
<p>Para evitar una sucesión de certificados sin fin, existen los denominados certificados <strong>autofirmados</strong>, es decir firmados por el propio titular del certificado. Evidentemente estos certificados son un punto crítico en la seguridad del sistema y sólo deben obtenerse de fuentes y métodos absolutamente fiables. Normalmente vienen ya instalados en los sistemas (servidores de aplicaciones o navegadores) o se obtienen de forma presencial.</p>
</div>
<div class="paragraph">
<p>La secuencia anidada de certificados se denomina <em>cadena de confianza</em> (chain of trust). En dicha cadena, el certificado auto-firmado se denomina <em>certificado raíz</em> (root certificate).</p>
</div>
</div>
<div class="sect3">
<h4 id="_introducción_a_ssl">4.1.2. Introducción a SSL</h4>
<div class="paragraph">
<p>SSL es un protocolo es un protocolo desarrollado por Netscape, para permitir confidencialidad y autenticación en Internet. Funciona como una capa adicional con lo cual es posible combinarlo con HTTP, FTP o TELNET que son protocolos que operan en la capa aplicación de TCP/IP.</p>
</div>
<div class="paragraph">
<p>Para establecer una comunicación segura,  cliente y servidor entablan un diálogo denominado <strong>handshake</strong>:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas04/ssl1.png" alt="ssl1" width="50%">
</div>
</div>
<div class="paragraph">
<p>Las fases son las siguientes:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Solicitud de SSL: El cliente solicita al servidor un recurso mediante conexión segura SSL. El servidor normalmente acepta este tipo de peticiones por un puerto distinto al habitual.</p>
</li>
<li>
<p>El servidor responde enviando un certificado digital para que el cliente pueda comprobar la identidad del servidor,  el algoritmo de criptografía más potente de los que ambos puedan utilizar y una clave pública para encriptar la información que van a intercambiar.</p>
</li>
<li>
<p>El cliente comprueba si el certificado es de un sitio de confianza y si esto es así genera una clave privada de "sesión" aleatoria que envía encriptada al servidor con su clave pública.</p>
</li>
<li>
<p>Esta clave de sesión junto con el algoritmo de encriptación es lo que se va a utilizar en cada mensaje entre cliente y servidor. Para verificar los valores negociados, ambas partes se envían de nuevo la clave de sesión y verifican que coincidan. Si esto es así, la fase de handshake finaliza y se establece el canal de comunicación seguro.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_one_way_y_two_way_ssl">4.1.3. One-Way y Two-Way SSL</h4>
<div class="paragraph">
<p>En el ejemplo de handshake anterior, observamos que es el servidor el que en un momento dado debe acreditar su identidad mediante  un certificado digital, que el cliente debe validar. Este tipo de negociación recibe el nombre de One-Way SSL.</p>
</div>
<div class="paragraph">
<p>Adicionalmente, puede exigir al cliente al cliente que se identifique enviando otro certificado digital, que el servidor deberá validar. Si el uno confía en el otro, se establecerá el canal de comunicación seguro. A esta modalidad de SSL se la denomina Two-Way SSL.</p>
</div>
</div>
<div class="sect3">
<h4 id="_creación_de_una_ca_ficticia">4.1.4. Creación de una CA ficticia</h4>
<div class="paragraph">
<p>El primer paso para trabajar con certificados y SSL es verificar que tenemos instaladas las herramientas OpenSSL. Podéis probar a ejecutar <em>openssl</em> y si no se reconoce el comando instalarlo con:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">sudo apt-get install openssl</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Una vez instalado, hay que realizar un cambio en la configuración, que nos va a permitir firmar certificados:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">/usr/lib/ssl/openssl.conf Línea 170</span>

<span class="tok-go">basicConstraints=CA:TRUE  # Antes FALSE</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Utilizaremos <em>openssql</em> para generar certificados y firmar, y la herramienta <em>keytool</em> de java para importar estos certificados en almacenes de certificados en formato JKS.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
keytool es una herramienta muy completa pero está pensada para trabajar con certificados autofirmados (que adicionalmente pueden ser enviados a una CA para que los firme). OpenSSL proporciona comandos para firmar certificados a partir de uno especificado como parámetro, a modo de CA y simular completamente lo que haría una autoridad de certificación.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Los almacenes son ficheros protegidos donde podemos almacénar uno o mas certificados digitales. Cada certificado digital estará asociado a un <em>alias</em> que se utilizará para recuperar el certificado del almacén. Es habitual tener un almacén para los certificados de identidad (aquellos que el servidor de aplicaciones utiliza para identificarse) y otro de confianza (certificados de cliente y/o CA&#8217;s considerados como válidos).</p>
</div>
<div class="paragraph">
<p>1.- Para empezar, vamos a definir un certificado de CA ficticia que será quien de "credibilidad" a los certificados que vamos a crear.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">openssl req -x509 -newkey rsa:2048 -keyout selfkey.pem -out selfcert.pem -days 365</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Este comando nos pedirá la información que describirá a nuestra CA:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas04/CACert.png" alt="CACert">
</div>
</div>
<div class="paragraph">
<p>2.-  Ahora importaremos este certificado en un almacén denominado trust.jks (certificados de confianza)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">keytool -import -trustcacerts -alias trustself -keystore trust.jks -file selfcert.pem -keyalg RSA -keypass secreto -storepass secreto</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A continuación veremos como definir configurar WildFly en función del tipo de seguridad que queremos configurar.</p>
</div>
<div class="sect4">
<h5 id="_configuración_del_servidor_para_one_way_ssl">Configuración  del servidor para One-Way SSL</h5>
<div class="paragraph">
<p>En esta modalida de SSL, es el servidor el que debe identificarse al cliente y éste confiar en él (o no).</p>
</div>
<div class="paragraph">
<p>Pasos a seguir:</p>
</div>
<div class="paragraph">
<p>1.- Crear un certificado que identifique a nuestro servidor, para ello utilizaremos OpenSSL y los siguientes comandos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">openssl genrsa -out server.key  1024	#crear una clave nueva de certificado</span>
<span class="tok-go">openssl req -new -key server.key -out server.csr #crear una petición de certificado.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Al ejecutar el segundo comando, la herramienta nos irá pidiendo datos para incluir en la petición de certificado:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas04/ServerCert.png" alt="ServerCert">
</div>
</div>
<div class="paragraph">
<p>Si quisiéramos obtener un certificado aprobado por una CA real, deberíamos enviar el fichero server.csr a dicha autoridad ( y pagar), y esta nos generará el certificado y nos dará las instrucciones necesarias para descargarlo.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Si alguien está interesado, algunas CA&#8217;s como Verisign ofrecen certificados válidos durante 30 días a modo de prueba.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>2.- Creación del certificado firmado con el certificado con nuestra CA:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">openssl x509 -req -days 365 -in server.csr -CA selfcert.pem -CAkey selfkey.pem -set_serial 01 -out server.crt</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
El serial number del certificado sirve para identificar los certificados firmados por una CA, y debe ser distinto para cada certificado. Por simplicidad, vamos a enumerarlos manualmente.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>3.- Importar el certificado en nuestro almacén de identidad:</p>
</div>
<div class="paragraph">
<p>La herramienta keytool no permite importar la clave privada de los certificados en los almacenes a partir de un certificado y su clave, por lo que tenemos que recurrir a un formato intermedio:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">#</span> Convertir a PKCS12
<span class="tok-go">openssl pkcs12 -export -name servercert -in server.crt -inkey server.key -out keystore.p12</span>
<span class="tok-gp">#</span>finalmente importarlo en jks
<span class="tok-go">keytool -importkeystore -destkeystore identity.jks -srckeystore keystore.p12 -srcstoretype pkcs12 -alias servercert -keypass secreto -storepass secreto</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>4.- Comprobar que los certificados están importados correctamente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">keytool -list -v -keystore trust.jks -storepass secreto</span>
<span class="tok-go">keytool -list -v -keystore identity.jks -storepass secreto</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Hay muchas contraseñas involucradas en este proceso. Para no complicarnos demasiado utilizaremos la palabra "secreto" como contraseña en todos los casos.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>5.- Copiar los almacenes a la carpeta <em>standalone/configuration</em></p>
</div>
<div class="paragraph">
<p>6.- Definir el realm asociado a los certificados:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;security-realm</span> <span class="tok-na">name=</span><span class="tok-s">&quot;SecureRealm&quot;</span><span class="tok-nt">&gt;</span>
	<span class="tok-nt">&lt;server-identities&gt;</span>
		<span class="tok-nt">&lt;ssl&gt;</span>
			<span class="tok-nt">&lt;keystore</span> <span class="tok-na">path=</span><span class="tok-s">&quot;identity.jks&quot;</span> <span class="tok-na">relative-to=</span><span class="tok-s">&quot;jboss.server.config.dir&quot;</span> <span class="tok-na">keystore-password=</span><span class="tok-s">&quot;secreto&quot;</span> <span class="tok-na">alias=</span><span class="tok-s">&quot;servercert&quot;</span> <span class="tok-na">key-password=</span><span class="tok-s">&quot;secreto&quot;</span><span class="tok-nt">/&gt;</span>
		<span class="tok-nt">&lt;/ssl&gt;</span>
	<span class="tok-nt">&lt;/server-identities&gt;</span>
<span class="tok-nt">&lt;/security-realm&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>7.- Para activar SSL hay que definir un <em>https-listener</em> dentro del subsistema <em>undertow</em> (el servidor web de WildFly):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;subsystem</span> <span class="tok-na">xmlns=</span><span class="tok-s">&quot;urn:jboss:domain:undertow:1.2&quot;</span><span class="tok-nt">&gt;</span>
<span class="tok-nt">&lt;buffer-cache</span> <span class="tok-na">name=</span><span class="tok-s">&quot;default&quot;</span><span class="tok-nt">/&gt;</span>
<span class="tok-nt">&lt;server</span> <span class="tok-na">name=</span><span class="tok-s">&quot;default-server&quot;</span><span class="tok-nt">&gt;</span>
	<span class="tok-nt">&lt;http-listener</span> <span class="tok-na">name=</span><span class="tok-s">&quot;default&quot;</span> <span class="tok-na">socket-binding=</span><span class="tok-s">&quot;http&quot;</span><span class="tok-nt">/&gt;</span>

	<span class="tok-nt">&lt;https-listener</span> <span class="tok-na">name=</span><span class="tok-s">&quot;https&quot;</span> <span class="tok-na">socket-binding=</span><span class="tok-s">&quot;https&quot;</span> <span class="tok-na">security-realm=</span><span class="tok-s">&quot;SecureRealm&quot;</span><span class="tok-nt">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Hay dos elementos interesantes en esta línea:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>El parámetro socket_binding está asociado a "https" pero aplica tanto a las peticiones estándar (8443) como a las de <em>management-https</em>, (9993).</p>
</li>
<li>
<p>El parámetro security-realm asocia el canal a un Security Realm que será el que contenga al certificado de identidad del servidor.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Con esta configuración, estamos indicando que para las peticiones que lleguen por https nuestro servidor se identificará con el certificado asociado al alias <em>servercert</em>.</p>
</div>
<div class="paragraph">
<p>8.- Iniciar el servidor. Con esto ya hemos completado los pasos para implementar One Way SSL pero ahora nos queda hacer que el navegador reconozca el certificado servercert como válido.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas04/ssl3.png" alt="ssl3" width="66%">
</div>
</div>
<div class="paragraph">
<p>Para conseguir esto basta con importar el certificado de la CA en la lista de certificados de autoridades certificadoras del navegador. En Firefox iremos a <em>Editar&#8594;Preferencias&#8594;Avanzado&#8594;Cifrado&#8594;Ver certificados</em>:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas04/cert4.jpg" alt="cert4" width="66%">
</div>
</div>
<div class="paragraph">
<p>Pincharemos en importar y seleccionaremos el archivo <strong>selfcert.pem</strong></p>
</div>
<div class="paragraph">
<p>Se nos pedirá definir para que se utilizará el certificado. Marcamos todas las opciones y aceptamos:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas04/ssl4.png" alt="ssl4" width="66%">
</div>
</div>
<div class="paragraph">
<p>A partir de ahora, si accedemos a la consola, o a cualquier aplicación desplegada en el servidor veremos que se acepta el certificado que envía el servidor:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas04/ssl5.png" alt="ssl5" width="50%">
</div>
</div>
<div class="sect5">
<h6 id="_cambios_en_las_aplicaciones_web">Cambios en las aplicaciones web</h6>
<div class="paragraph">
<p>Si queremos que una serie de recursos de nuestra aplicación se muestren forzosamente mediante SSL, debemos añadir una restricción al archivo web.xml</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;security-constraint&gt;</span>
<span class="tok-nt">&lt;web-resource-collection&gt;</span>
<span class="tok-nt">&lt;web-resource-name&gt;</span>Redireccion SSL<span class="tok-nt">&lt;/web-resource-name&gt;</span>
<span class="tok-nt">&lt;url-pattern&gt;</span>/*<span class="tok-nt">&lt;/url-pattern&gt;</span>
<span class="tok-nt">&lt;/web-resource-collection&gt;</span>
<span class="tok-nt">&lt;user-data-constraint&gt;</span>
<span class="tok-nt">&lt;transport-guarantee&gt;</span>CONFIDENTIAL<span class="tok-nt">&lt;/transport-guarantee&gt;</span>
<span class="tok-nt">&lt;/user-data-constraint&gt;</span>
<span class="tok-nt">&lt;/security-constraint&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_securizar_el_acceso_a_la_consola_web_de_administración">Securizar el acceso a la consola web de administración</h6>
<div class="paragraph">
<p>Ahora que ya conocemos como utilizar SSL, podemos aplicar estos mismos cambios al realm de administración de modo que podamos forzar el acceso a la consola mediante una conexión segura. Los cambios son los siguientes:</p>
</div>
<div class="paragraph">
<p>1.- Añadir el certificado de servidor al ManagementRealm:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;server-identities&gt;</span>
	<span class="tok-nt">&lt;ssl&gt;</span>
		<span class="tok-nt">&lt;keystore</span> <span class="tok-na">path=</span><span class="tok-s">&quot;identity.jks&quot;</span> <span class="tok-na">relative-to=</span><span class="tok-s">&quot;jboss.server.config.dir&quot;</span> <span class="tok-na">keystore-password=</span><span class="tok-s">&quot;secreto&quot;</span> <span class="tok-na">alias=</span><span class="tok-s">&quot;servercert&quot;</span> <span class="tok-na">key-password=</span><span class="tok-s">&quot;secreto&quot;</span><span class="tok-nt">/&gt;</span>
	<span class="tok-nt">&lt;/ssl&gt;</span>
<span class="tok-nt">&lt;/server-identities&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>2.-  Asociar el puerto seguro a la interfaz de administración:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;http-interface</span> <span class="tok-na">security-realm=</span><span class="tok-s">&quot;ManagementRealm&quot;</span> <span class="tok-na">http-upgrade-enabled=</span><span class="tok-s">&quot;true&quot;</span><span class="tok-nt">&gt;</span>
	<span class="tok-nt">&lt;socket-binding</span> <span class="tok-na">https=</span><span class="tok-s">&quot;management-https&quot;</span><span class="tok-nt">/&gt;</span> <span class="tok-c">&lt;!-- Sustituye a management-http --&gt;</span>
<span class="tok-nt">&lt;/http-interface&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_configuración_del_servidor_para_two_way_ssl">Configuración  del servidor para Two-Way SSL</h5>
<div class="paragraph">
<p>Mediante este sistema cliente y servidor se identifican y validan recíprocamente. El configurar esta modalidad de SSL es sencillo, partiendo de la configuración One-Way.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crear un certificado de cliente, firmado por nuestra CA ficticia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">openssl genrsa -out client.key  1024</span>
<span class="tok-go">openssl req -new -key client.key -out client.csr</span>
<span class="tok-go">openssl x509 -req -days 365 -in client.csr -CA selfcert.pem -set_serial 02 -CAkey selfkey.pem   -out client.crt</span></code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas04/ClientCert.png" alt="ClientCert">
</div>
</div>
</li>
<li>
<p>Convertir al formato PKCS12 que incluye clave pública y privada y es reconocido por Firefox:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">openssl pkcs12 -export -name clientcert -in client.crt -inkey client.key -out clientstore.p12</span></code></pre>
</div>
</div>
</li>
<li>
<p>Ahora importaremos el certificado en el navegador. Recordad que ya tenemos el de la CA. Se debe importar el archivo .p12 en la pestaña de "sus certificados":</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas04/ClientCert2.png" alt="ClientCert2">
</div>
</div>
</li>
<li>
<p>Pasamos a continuación a WildFly donde activaremos la función de autenticación en el Security Realm <em>SecureRealm</em> especificando el almacén de certificados de confianza.</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"> <span class="tok-nt">&lt;security-realm</span> <span class="tok-na">name=</span><span class="tok-s">&quot;SecureRealm&quot;</span><span class="tok-nt">&gt;</span>
                ....
                <span class="tok-nt">&lt;authentication&gt;</span>
                    <span class="tok-nt">&lt;truststore</span> <span class="tok-na">path=</span><span class="tok-s">&quot;trust.jks&quot;</span> <span class="tok-na">relative-to=</span><span class="tok-s">&quot;jboss.server.config.dir&quot;</span> <span class="tok-na">keystore-password=</span><span class="tok-s">&quot;secreto&quot;</span><span class="tok-nt">/&gt;</span>
                <span class="tok-nt">&lt;/authentication&gt;</span>
            <span class="tok-nt">&lt;/security-realm&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Por último, tenemos que indicar que queremos que el servidor "pida" al cliente que se identifique. Esto lo hacemos añadiendo un parámetro adicional al _http-listener-:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;https-listener</span> <span class="tok-na">name=</span><span class="tok-s">&quot;https&quot;</span> <span class="tok-na">socket-binding=</span><span class="tok-s">&quot;https&quot;</span> <span class="tok-na">security-realm=</span><span class="tok-s">&quot;SecureRealm&quot;</span> <span class="tok-na">verify-client=</span><span class="tok-s">&quot;REQUESTED&quot;</span><span class="tok-nt">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El parámetro verify-client tiene tres valores posibles:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">NOT_REQUESTED</dt>
<dd>
<p>No solicitar certificado a cliente (valor por defecto)</p>
</dd>
<dt class="hdlist1">REQUESTED</dt>
<dd>
<p>Se pide certificado de cliente, pero si no se presenta se permite continuar la conexión segura.</p>
</dd>
<dt class="hdlist1">REQUIRED</dt>
<dd>
<p>Se requiere un certificado de cliente válido para poder establecer una conexión segura.</p>
</dd>
</dl>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_autorización_del_cliente_mediante_certificados">Autorización del cliente mediante certificados</h5>
<div class="paragraph">
<p>A partir de un usuario identificado por su certificado de cliente, también podemos determinar si tiene un rol asociado y en consecuencia permitirle o no el acceso a determinados recursos. En la sesión anterior hemos aprendido a definir login modules específicos para autenticación y autorización de usuarios con respecto a la información de usuarios que teníamos en ficheros, base de datos o en un directorio LDAP. Ahora introduciremos un nuevo login module: <em>CertificateRoles</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;security-domain</span> <span class="tok-na">name=</span><span class="tok-s">&quot;seguridad-cert&quot;</span> <span class="tok-na">cache-type=</span><span class="tok-s">&quot;default&quot;</span><span class="tok-nt">&gt;</span>
	<span class="tok-nt">&lt;authentication&gt;</span>
		<span class="tok-nt">&lt;login-module</span> <span class="tok-na">code=</span><span class="tok-s">&quot;CertificateRoles&quot;</span> <span class="tok-na">flag=</span><span class="tok-s">&quot;required&quot;</span><span class="tok-nt">&gt;</span>
			<span class="tok-nt">&lt;module-option</span> <span class="tok-na">name=</span><span class="tok-s">&quot;securityDomain&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;seguridad-cert&quot;</span><span class="tok-nt">/&gt;</span>
			<span class="tok-nt">&lt;module-option</span> <span class="tok-na">name=</span><span class="tok-s">&quot;verifier&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;org.jboss.security.auth.certs.AnyCertVerifier&quot;</span><span class="tok-nt">/&gt;</span>
			<span class="tok-nt">&lt;module-option</span> <span class="tok-na">name=</span><span class="tok-s">&quot;rolesProperties&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;file:/usr/local/wildfly/standalone/configuration/roles.properties&quot;</span><span class="tok-nt">/&gt;</span>
		<span class="tok-nt">&lt;/login-module&gt;</span>
	<span class="tok-nt">&lt;/authentication&gt;</span>
	<span class="tok-nt">&lt;jsse</span> <span class="tok-na">keystore-password=</span><span class="tok-s">&quot;secreto&quot;</span> <span class="tok-na">keystore-url=</span><span class="tok-s">&quot;file:/usr/local/wildfly/standalone/configuration/trust.jks&quot;</span> <span class="tok-na">truststore-password=</span><span class="tok-s">&quot;secreto&quot;</span> <span class="tok-na">truststore-url=</span><span class="tok-s">&quot;file:/usr/local/wildfly/standalone/configuration/trust.jks&quot;</span><span class="tok-nt">/&gt;</span>
<span class="tok-nt">&lt;/security-domain&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En este fragmento de XML definimos un nuevo dominio de seguridad _seguridad-cert, en el que introducimos nuevo login module. Los parámetros que son novedad para nosotros son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>rolesProperties: Este login module requiere de un fichero externo en el que se indique para cada identidad asociada a un certificado (CN) a que rol o roles pertenece.</p>
</li>
<li>
<p>jsse: Referencia al almacén de seguridad de certificados de confianza.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>El fichero <em>rolesProperties</em> sigue el mismo formato que el fichero <em>application-roles.properties</em> sin embargo el usuario se debe identificar por el DN  (distinguished name) completo del certificado, es decir con todos los datos que se nos pedía a la hora de generarlo. Además, tanto los espacios como los signos "=" se deben escapar con contrabarras. Como ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="text">CN\=JoseLuis,\ OU\=jtech,\ O\=UA,\ L\=Alicante,\ ST\=Spain,\ C\=ES=rol_usuario</code></pre>
</div>
</div>
<div class="paragraph">
<p>El último signo "=" no se escapa pues es el que separa el usuario de los roles.</p>
</div>
<div class="paragraph">
<p>Por último, también hay que realizar cambios en las aplicaciones, concretamente hay que cambiar el modo de autenticación de la aplicación web de BASIC a CLIENT-CERT en el fichero web.xml:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;login-config&gt;</span>
<span class="tok-nt">&lt;auth-method&gt;</span>CLIENT-CERT<span class="tok-nt">&lt;/auth-method&gt;</span>
<span class="tok-c">&lt;!--&lt;auth-method&gt;BASIC&lt;/auth-method&gt;--&gt;</span>
<span class="tok-nt">&lt;realm-name&gt;</span>mydomain<span class="tok-nt">&lt;/realm-name&gt;</span>
<span class="tok-nt">&lt;/login-config&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_comunicación_ssl_a_través_de_proxies">Comunicación SSL a través de proxies</h5>
<div class="paragraph">
<p>Como ya sabemos, las conexiones SSL son conexiones punto a punto entre cliente y servidor y no admite elementos intermedios que puedan poner en riesgo la seguridad de las comunicaciones. Sin embargo, hay elementos como los denominados balanceadores de carga, que son capaces de encaminar una petición a distintos servidores en función de la carga de trabajo u otros parámetros.</p>
</div>
<div class="paragraph">
<p>En el caso de trabajar con este tipo de elementos, la conexión SSL se divide en dos tramos, una conexión segura entre el cliente y el "proxy", y otra entre el proxy y el servidor. Ambas conexiones se establecen de la misma forma que una conexión directa, es decir una parte hace de cliente y la otra de servidora,  sin embargo el certificado del cliente no se utiliza para negociar la conexión con el servidor, si no el del propio proxy. Gráficamente:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas04/clientcert1.png" alt="clientcert1">
</div>
</div>
<div class="paragraph">
<p>Bajo este supuesto, podremos hacer llegar las credenciales del cliente al servidor, si utilizamos un proxy Apache en este elemento intermedio. Una de sus funciones es la de "inyectar" la información del certificado cliente en una cabecera especial, denominada <em>SSL_CLIENT_CERT</em>. Esta información también estará disponible para las aplicaciones, si estas consultan la cabecera en el parámetro request de la petición.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_referencias_4">4.2. Referencias</h3>
<div class="ulist">
<ul>
<li>
<p>Login modules en WildFly <a href="https://docs.jboss.org/author/display/WFLY8/Authentication+Modules" class="bare">https://docs.jboss.org/author/display/WFLY8/Authentication+Modules</a></p>
</li>
<li>
<p>Securing Realms 	<a href="https://docs.jboss.org/author/display/WFLY8/Security+Realms" class="bare">https://docs.jboss.org/author/display/WFLY8/Security+Realms</a></p>
</li>
<li>
<p>SSL 	<a href="https://docs.jboss.org/author/display/WFLY8/Admin+Guide#AdminGuide-%7B%7B%3Cssl%2F%3E%7D%7D" class="bare">https://docs.jboss.org/author/display/WFLY8/Admin+Guide#AdminGuide-%7B%7B%3Cssl%2F%3E%7D%7D</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios_de_certificados_digitales_y_ssl">4.3. Ejercicios de certificados digitales y SSL</h3>
<div class="paragraph">
<p>Vamos a seguir trabajando con el dominio seguridad y la aplicación <em>apli-intranet</em> de la sesión anterior. Para poder realizar los ejercicios se debe haber completado, al menos, el primer ejercicio de la sesión anterior.</p>
</div>
<div class="sect3">
<h4 id="_encriptación_de_las_comunicaciones_one_way_ssl_0_4_puntos">4.3.1. Encriptación de las comunicaciones One-Way SSL (0.4 puntos)</h4>
<div class="paragraph">
<p>Queremos reforzar la seguridad de las comunicaciones con nuestro servidor, creando un canal seguro SSL en el que el servidor se identificará y el navegador del cliente deberá reconocer dicho certificado como válido.</p>
</div>
<div class="paragraph">
<p>Hay que crear los certificados de la CA, de servidor, importar la CA en el navegador y configurar el servidor para que utilice SSL.</p>
</div>
</div>
<div class="sect3">
<h4 id="_encriptación_de_las_comunicaciones_con_two_way_ssl_0_4_puntos">4.3.2. Encriptación de las comunicaciones con Two-Way SSL (0.4 puntos)</h4>
<div class="paragraph">
<p>Ahora lo que se pretende es que tanto servidor como cliente validen sus certificados respectivos. A los certificados ya creados en el ejercicio anterior se les une un certificado asociado a un <em>Usuario1</em> y que sea el certificado con el que el navegador se identifique para establecer la conexión.</p>
</div>
<div class="paragraph">
<p>Siguiendo los pasos descritos en la teoría, configurar el servidor para que se requieran certificados de cliente y se validen.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Debéis usar la misma contraseña para los almacenes que hemos visto en teoría para que el ejercicio pueda ser corregido.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_autenticación_de_usuario_a_partir_del_certificado_0_4_puntos">4.3.3. Autenticación de usuario a partir del certificado (0.4 puntos)</h4>
<div class="paragraph">
<p>En el ejercicio anterior generamos un certificado identificativo para el cliente mediante el cual se establece un canal seguro si el servidor lo acepta. Sin embargo este mecanismo convive con la validación BASIC mediante usuario/password, con lo que tenemos que seguir pidiendo credenciales al usuario para saber exactamente quién está trabajando desde el navegador y a qué grupo pertenece.</p>
</div>
<div class="paragraph">
<p>La propuesta de este ejercicio es hacer los cambios pertinentes en el dominio de seguridad y en la aplicación para que valide e identifique directamente al usuario cliente  en base a su certificado sin comprobar nada más. Sería algo parecido a conectarnos a la web de la AEAT o a la Seguridad Social empleando un certificado digital que nos identifique.</p>
</div>
<div class="paragraph">
<p>Para completar el ejercicio teneis que:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Asociar el certificado del <em>usuario1</em>, del ejercicio anterior al rol de usuario.</p>
</li>
<li>
<p>Crear un nuevo certificado asociado a un <em>usuario2</em> y asociarlo al rol de administrador.</p>
</li>
<li>
<p>Configurar el servidor para que se utilice el login module de certificados.</p>
</li>
<li>
<p>Cambiar la seguridad de la aplicación intranet para que se valide en base a certificados.</p>
</li>
<li>
<p>Comprobar que si nos autenticamos con los certificados de usuario, cada uno se asocia al rol correspondiente.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Si añadis los tags para forzar el acceso SSL a la aplicación, podéis tener problemas a la hora de tratar los certificados de cliente, por la redirección que hace la aplicación apli-intranet, desde el JSP al servlet de consulta. Lo más sencillo, no utilizarlo.&lt;/note&gt;
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Especificar tanto en <em>web.xml</em> como en el descriptor <em>jboss-web.xml</em> el nombre del security domain que vayáis a utilizar y estad atentos al fichero de auditoría de seguridad (audit.log).
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_entrega_3">4.3.4. Entrega</h4>
<div class="paragraph">
<p>Los entregables de esta sesión son el proyecto apli-intranet, los ficheros properties que defináis y el fichero <em>standalone.xml</em> con la configuración del servidor. Comentad en el código o en los descriptores los cambios que vayáis haciendo para poder comprobar que habéis completado los distintos ejercicios propuestos.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion05">5. Introducción a Cloud Computing y a OpenShift</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="__qué_es_cloud_computing">5.1. ¿Qué es Cloud Computing?</h3>
<div class="paragraph">
<p><strong>Cloud Computing</strong> es una denominación comercial a un modelo de computación que permite utilizar recursos tecnológicos bajo demanda, ofrecidos por un proveedor. Este modelo se enfrenta al modelo tradicional de adquisición y administración de los recursos necesarios para proporcionar una cierta funcionalidad o servicio.</p>
</div>
<div class="paragraph">
<p>El uso de estas tecnologías no es algo nuevo, puesto que desde hace años estamos hablando de servicios de hosting o aplicaciones web. Incluso desde los años 70 existían las sesiones de Time Sharing en los grandes mainframes que nos permite acceder a los recursos de un gran ordenador desde un sencillo terminal.</p>
</div>
<div class="paragraph">
<p>Lo novedoso es que basándose en estas tecnologías se ha conseguido desarrollar un modelo de negocio que permite ofrecer recursos ajustados a las necesidades de los clientes.</p>
</div>
<div class="sect3">
<h4 id="_computación_pre_cloud">5.1.1. Computación Pre-Cloud</h4>
<div class="paragraph">
<p>Antes de las tecnologías Cloud, cualquier proyecto informático requería de una fuerte inversión previa tanto en hardware como en software.</p>
</div>
<div class="paragraph">
<p>En la parte hardware normalmente incluiremos ordenadores, infraestructura de red, almacenamiento de datos, etc. En la parte software normalmente tendremos el coste de las licencias de los sistemas operativos y de las aplicaciones que se vayan a utilizar. A este coste hay que sumarle los desarrollos a medida que se pudieran necesitar.</p>
</div>
<div class="paragraph">
<p>Ampliar hardware no es barato y el que adquiere se debe sobredimensionar por dos motivos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Amortización de la inversión</em>: Debe utilizarse durante un mínimo de tiempo y permitir escalabilidad vertical u horizontal.</p>
</li>
<li>
<p><em>Picos de carga de trabajo</em>: El sistema debe poder hacer frente a la carga de trabajo que se pueda generar en los momentos de mayor actividad, así como ser lo suficientemente potente para que en caso de contingencia en un nodo, poder continuar dando servicio.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>En resumen, para poder implantar un proyecto informático es necesaria una inversión económica considerable, tanto en software como en hardware, y éste último tiende a estar infrautilizado la mayor parte de su tiempo y su ampliación presenta limitaciones.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="__qué_nos_aporta_cloud_computing">5.2. ¿Qué nos aporta Cloud Computing?</h3>
<div class="paragraph">
<p>En contraposición, las principales ventajas que obtendremos al aplicar Cloud Computing son las siguientes:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><em>Flexibilidad</em></dt>
<dd>
<p>La ventaja más importante de Cloud Computing tener a nuestra disposición los recursos que necesitamos, cuando los necesitamos y con una capacidad de adaptación muy rápida a cambios en los requerimientos.</p>
</dd>
<dt class="hdlist1"><em>Estandarización y reusabilidad</em></dt>
<dd>
<p>Los nuevos modelos de computación se basan en tecnologías estandarizadas, probadas por miles de clientes. El objetivo último es liberar al cliente de otras preocupaciones que no sean su proyecto</p>
</dd>
<dt class="hdlist1"><em>Eficiencia</em></dt>
<dd>
<p>En la práctica se consigue un aprovechamiento mucho mayor de los recursos contratados que mediante la adquisición tradicional. Los sistemas de Cloud Computing aportan métricas de calidad de servicio.</p>
</dd>
<dt class="hdlist1"><em>Acceso ubicuo</em></dt>
<dd>
<p>Mediante Cloud podemos acceder a los servicios contratados desde cualquier lugar, a cualquier hora y desde cualquier dispositivo que tenga acceso a Internet.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Otras ventajas propias de Cloud, con ciertos matices son las siguientes:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><em>Seguridad</em></dt>
<dd>
<p>Aunque se suele ver más como un riesgo, realmente es una de las características más importantes sobre todo para pymes, pues los centros de datos de los proveedores de cloud deben implementar medidas de seguridad muy superiores a las habituales en la mayoría de las empresas. Hablaremos más adelante de Seguridad.</p>
</dd>
<dt class="hdlist1"><em>Ahorro de costes</em></dt>
<dd>
<p>Los proyectos implantados mediante tecnologías Cloud permiten un ahorro importante de dinero al comienzo de su utilización, y dado de  que se paga por uso, a largo plazo también debería haber un ahorro importante frente a un enfoque tradicional.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>La realidad es que hacer una previsión de costes a medio o largo plazo no resulta sencillo y a largo plazo puede no ser tan ventajoso. No obstante no hay que perder de vista el resto de ventajas que aporta, sobre todo en flexibilidad.</p>
</div>
</div>
<div class="sect2">
<h3 id="_nuevos_conceptos_de_cloud_computing">5.3. Nuevos conceptos de Cloud Computing</h3>
<div class="paragraph">
<p>Cloud computing aporta nueva terminología, a caballo entre lo técnico y el marketing.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><em>Multitenancy</em> o tenencia múltiple</dt>
<dd>
<p>se refiere al uso compartido de un mismo recurso por parte de muchos usuarios, en contraposición al modelo de uso individual.</p>
</dd>
<dt class="hdlist1"><em>Resiliency</em> o resiliencia</dt>
<dd>
<p>En el contexto de cloud computing, se refiere a la capacidad de un proveedor para mantener una calidad de servicio fijada, a pesar de los posibles fallos o ataques que puediera sufrir.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_riesgos_de_cloud">5.4. Riesgos de Cloud</h3>
<div class="paragraph">
<p>Por supuesto no todo es más fácil y bonito desde la llegada de Cloud, hay nuevas dificultades en el camino:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><em>¿Cómo aplicar Cloud Computing?</em></dt>
<dd>
<p>Hay múltiples formas de entender la computación en la nube. Más adelante hablaremos de <em>Tipos de Cloud</em>.</p>
</dd>
<dt class="hdlist1"><em>Dependencias de terceros</em></dt>
<dd>
<p>Aparece un nuevo jugador que es el proveedor de servicios. No todos los proveedores ofrecen los mismos servicios ni con las mismas garantías.</p>
</dd>
<dt class="hdlist1"><em>Datos de carácter personal</em></dt>
<dd>
<p>Al hilo del punto anterior, al trabajar en Cloud podemos necesitar transferir datos de caracter personal a un centro de datos externo a nuestra empresa e incluso en un país extranjero. La Agencia Española de Protección de Datos dicta una serie de normas acerca de cómo se deben manejar este tipo de datos y puede condicionar la elección del proveedor.</p>
</dd>
</dl>
</div>
<div class="sect3">
<h4 id="_qué_opinan_las_empresas_acerca_de_cloud">5.4.1. Qué opinan las empresas acerca de Cloud</h4>
<div class="paragraph">
<p>Según un informe del Observatorio Nacional de las Telecomunicaciones de Mayo de 2014, el grado de implantación de las tecnologías Cloud en la empresa española es el siguiente:</p>
</div>
<div class="paragraph">
<p>En dicho informe se puede obtener una visión más detallada por sectores. Concretamente en el sector comercial minorista se recogen los motivos que las empresas tienen para no usar tecnlologías cloud:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas05/CloudEnLaEmpresa.png" alt="CloudEnLaEmpresa">
</div>
</div>
<div class="paragraph">
<p>Según este informe, 9 de cada 10 de las empresas que aplican tecnologías CC , utilizan soluciones de almacenamiento y 6 de cada 10, soluciones de backup.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas05/MotivosParaNoUSarCloud.png" alt="MotivosParaNoUSarCloud">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tipos_de_cloud_en_función_del_servicio">5.5. Tipos de Cloud en función del servicio</h3>
<div class="paragraph">
<p>Atendiendo a los servicios que proporcionan, y ordenados de mayor a menor abstracción, tenemos tres grandes tipos de Cloud:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas05/TiposCloud.png" alt="TiposCloud" width="33%">
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><em>SaaS (Software as a Service)</em></dt>
<dd>
<p>Dirigido fundamentalmente a <em>usuarios finales</em>. El proveedor ofrece el uso de aplicaciones completas  que se ejecutan sobre la infraestructura del proveedor.</p>
<div class="ulist">
<ul>
<li>
<p>El usuario no tiene que instalar ningún producto, únicamente necesita tener conectividad.</p>
</li>
<li>
<p>El usuario no tiene ningún control sobre los aspectos técnicos de las aplicaciones a las que tiene acceso.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas05/SaaS.png" alt="SaaS">
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><em>PaaS (Platform as a Service)</em></dt>
<dd>
<p>El proveedor proporciona a su cliente un conjunto de módulos estándar (como bases de datos, servidor de aplicaciones) sobre los que poder desplegar sus propias aplicaciones. El usuario habitual de estos servicios suele ser el de perfil <em>desarrollador</em>.</p>
<div class="ulist">
<ul>
<li>
<p>El usuario tiene acceso a la configuración de los distintos módulos que contrata, así como a diversos parámetros que determinan la escalabilidad, seguridad, o auditoría del servicio PaaS</p>
</li>
<li>
<p>Sin embargo el usuario se abstrae de las tareas de la configuración de las máquinas, mantenimiento de Sistemas operativos, o aspectos de comunicaciones.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas05/PaaS.png" alt="PaaS" width="66%">
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><em>IaaS (Infrastructure as a Service)</em></dt>
<dd>
<p>Se considera la capa inferior de los servicios Cloud, en la que el proveedor ofrece a sus clientes recursos hardware virtualizados, tales como servidores, sistemas de almacenamiento, enrutadores sobre los que el usuario tiene libertad para configurar como desee. El perfil de usuario habitual de esta tecnología es el de <em>desarrollador</em> junto con el <em>administrador de sistemas</em>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>IaaS es el nivel más complejo de gestionar pero es el que otorga una libertad cercana al hardware propietario. Esto no quiere decir que tengamos que configurar todo a mano: en IaaS el proveedor proporciona seguridad, herramientas de clonado, paneles de control, monitorización etc.</p>
</div>
<div class="paragraph">
<p>Por debajo de estas capas estaría la capa de virtualización del proveedor y finalmente las máquinas físicas que dan el servicio real.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas05/IaaS.png" alt="IaaS" width="66%">
</div>
</div>
<div class="paragraph">
<p>De la división tradicional de Cloud surgen numerosas variantes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Iaas+</em>: Proporciona simultáneamente los recursos de PaaS (modulos software) y IaaS (recursos hardware virtualizados). En esta categoría podríamos situar a AWS Azure</p>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas05/IaasPlus.png" alt="IaasPlus">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><em>dSaaS</em>: <em>Data Storage as a Service</em> Tipo de servicio que proporciona almacenamiento remoto y sistema de backup. Se situa al nivel de máquinas físicas</p>
</li>
<li>
<p><em>DCaaS</em>: <em>Data Center as a Service</em> Modelo de venta de servicios que pone a disposición de los clientes recursos de procesamiento de datos e infraestructura físicos. Orientado a grandes empresas que por motivos concretos no puedan expandir sus actuales CPD&#8217;s</p>
</li>
<li>
<p><em>ItaaS</em>: IT as a Service. Modelo que disasocia los departamentos de TI de las pequeñas y medianas empresas. Las empresas se podrán dirigira mercados donde podrán comparar y adquirir la solución que mejor soporte dé a su negocio.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_tipos_de_cloud_en_función_del_tipo_de_acceso">5.6. Tipos de Cloud en función del tipo de acceso</h3>
<div class="dlist">
<dl>
<dt class="hdlist1"><em>Cloud pública</em></dt>
<dd>
<p>Donde los datos de distintos clientes se tratan conjuntamente en los sistemas del proveedor. Los costes son más económicos ya que se hace un uso muy eficiente de los recursos, pero el uso compartido puede mermar la confidencialidad de la información.</p>
</dd>
<dt class="hdlist1"><em>Cloud privada</em></dt>
<dd>
<p>Cuando por la naturaleza de los datos se requiere una seguridad adicional, el proveedor proporciona al cliente una infraestructura aislada del resto donde almacenar su información, y permite al cliente decidir quien puede tener acceso a la información. También se denomina cloud privada al modelo en el que el cliente utiliza su propia infraestructura y utiliza software de un proveedor para ejecutar una plataforma cloud dentro de sus instalaciones.</p>
</dd>
<dt class="hdlist1"><em>Cloud híbrida</em></dt>
<dd>
<p>Básicamente es una combinación de los dos modelos anteriores, estableciendo una comunicación VPN entre los mismos. Por ejemplo, una aplicación puede trabajar con datos de clientes que no sean de carácter personal, pero almacenar información de este tipo en la parte privada de modo que su confidencialidad sea máxima.</p>
</dd>
<dt class="hdlist1"><em>Cloud comunitaria</em></dt>
<dd>
<p>Infraestructuras compartidas entre varias organizaciones con principios similares.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_seguridad">5.7. Seguridad</h3>
<div class="dlist">
<dl>
<dt class="hdlist1"><em>Dato personal</em></dt>
<dd>
<p>Un dato personal es cualquier información concerniente a personas físicas identificadas o identificables.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>La Ley Orgánica 15/1999 de 13 de diciembre de Protección de Datos de Carácter Personal (LOPD) regula los aspectos relativos al tratamiento de los datos personales y la libre circulación de los datos. La Agencia Española de Protección de Datos (AEPD) es el órgano de control que se encarga de garantizar el cumplimiento de esta normativa dentro del territorio español.</p>
</div>
<div class="paragraph">
<p>Si los datos con los que se va a trabajar en la nube pertenecen a esta categoría, la empresa que los trate debe cumplir con carácter previo con el conjunto de obligaciones previstas en la LOPD: la inscripción de ficheros, deberes relacionados con la información en la recogida, el consentimiento y la calidad de los datos, garantía de los llamados derechos ARCO (Acceso, Rectificación, Cancelación y Oposición) o la adopción de medidas de seguridad.
Si los datos con los que se va a trabajar en la nube no son datos personales, se puede proceder sin que la LOPD señale impedimento alguno.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Transferencia internacional de datos personales</dt>
<dd>
<p>Es un tratamiento de datos que supone una transmisión de los mismos fuera del territorio del Espacio Económico Europeo (EEE), bien constituya una cesión o comunicación de datos, bien tenga por objeto la realización de un tratamiento de datos por cuenta del responsable del fichero establecido en territorio español.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Trabajar en la nube con datos de carácter personal, fuera del EEE tiene unos requisitos especiales:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Notificación a la AEPD vía formulario online, si se trata de un país con un nivel de protección adecuado: Suiza, Argentina, Guernsey, Isla de Man, Jersey, Canadá (sólo empresas sujetas a la ley canadiense de protección de datos) y EE.UU. (sólo empresas adheridas a los principios de Safe harbour).</p>
</li>
<li>
<p>Se deberá contar con la autorización del Director de la Agencia de Protección de Datos para el resto de destinos.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>En Junio de 2014 Microsoft fue la primera empresa en conseguir una certificación por parte de la AEPD y la UE, que asegura que sus servicios en la nube ofrecen una buena protección (Office 365, Azure) y por tanto cuentan de antemano con la autorización para poder exportar datos a sus centros de datos.</p>
</div>
<div class="paragraph">
<p>En Octubre de 2015 el Tribunal de Justicia Europeo invalida los acuerdos de Safe Harbour a raíz del escándalo de Facebook y la vigilancia masiva por parte de la agencia norteamericana NSA. En primera instancia los acuerdos de Safe Harbour impedían la investigación de estos sucesos pero la nueva sentencia judicial permite que los paises exijan las mismas garantías de seguridad que dicta las leyes europeas y pueden pronunciarse a favor o en contra de esta cesión de datos con total independencia.</p>
</div>
</div>
<div class="sect2">
<h3 id="_cómo_elegir_un_proveedor_de_cloud">5.8. Cómo elegir un proveedor de Cloud</h3>
<div class="paragraph">
<p>Lo primero de todo es determinar qué modalidad de cloud se adapta mejor a nuestro proyecto informático (si aplica). Es posible que con pago por uso de una aplicación SaaS podamos cubrir nuestras necesidades, por lo que lo primero es explorar este tipo de posibilidades y evaluar coste/beneficio.</p>
</div>
<div class="paragraph">
<p>Una vez tenemos claro que necesitamos una solución a medida, debemos distinguir entre una solución más estandarizada, basada en PaaS, o una solución más flexible pero más compleja de administrar, basada en IaaS.</p>
</div>
<div class="paragraph">
<p>La decisión técnica entre PaaS puede no ser definitiva, pues también influirán los requerimientos del proyecto y por su puesto las tarifas de cada proveedor.</p>
</div>
<div class="paragraph">
<p>Factores que influyen en la elección de un proveedor de Cloud:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Servicios ofertados: Es interesante que el proveedor escogido pueda ofrecer servicios que aunque en un primer momento no vamos a necesitar, podamos preveer que en un futuro sean de interés.</p>
</li>
<li>
<p>Ubicación del <em>Centro de datos</em> donde se alojará la información: Tanto en términos de protección de datos como en rendimiento.</p>
</li>
<li>
<p>Tipo de <em>Centro de datos</em> donde se alojará la información:</p>
<div class="ulist">
<ul>
<li>
<p>De operador (propietarios) Son privados. Los operadores bonifican los costes pero dificultan los cambios.</p>
</li>
<li>
<p>Neutrales (independientes) Accederemos a un pool de servicios. Mayor oferta de servicios y mayor facilidad para cambiar de proveedores.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Calidad de las instalaciones:</p>
<div class="ulist">
<ul>
<li>
<p>Tier 1 (sala refrigerada con recursos de extinción)</p>
</li>
<li>
<p>Hasta tier 4 (Disponibilidad de al menos 99.995% del tiempo, personal 24x7, redundancia en almacenamiento, comunicaciones, refrigeración&#8230;&#8203;)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Medidas de seguridad: iguales o superiores a las necesarias para el proyecto.</p>
</li>
<li>
<p>Políticas de importación/exportación de datos: que faciliten tanto la carga de información, como la extracción en el caso de que decidamos cambiar de proveedor.</p>
</li>
<li>
<p>Calidad del servicio:</p>
<div class="ulist">
<ul>
<li>
<p><em>SLA</em>: acuerdos de nivel de servicio, con obligaciones y penalizaciones.</p>
</li>
<li>
<p><em>SLO</em>: objetivos de nivel de servicio, medida orientativa de la calidad de servicio que se va a obtener.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Costes: siempre evaluados de forma conjunta con el resto de factores. Se deberá crear un escenario de uso, lo más completo posible para poder preveer mejor los costes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Por último, destacar que la mayoría de los proveedores con centro de datos ubicados en España, ofrecen servicios de SaaS o IaaS.</p>
</div>
</div>
<div class="sect2">
<h3 id="_introducción_a_openshift">5.9. Introducción a OpenShift</h3>
<div class="paragraph">
<p>A lo largo de estas sesiones vamos a utilizar PaaS como plataforma de trabajo por estar más enfocada a las necesidades del desarrollador, concretamente la solución PaaS de RedHat. Los motivos para elegir este producto para el curso son varios:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Permite desplegar aplicaciones basadas en muy diversas tecnologías.</p>
</li>
<li>
<p>Si no implementa algún servicio permite integrarse con terceros o construir componentes a medida.</p>
</li>
<li>
<p>Tiene una modalidad de trabajo gratuita (y que no requiere de tarjeta de crédito) lo suficientemente abierta para familiarizarse con la plataforma y desplegar aplicaciones de casi cualquier tipo.</p>
</li>
<li>
<p>permite conocer la plataforma tanto desde el punto de vista del desarrollador como del administrador de sistemas. Podemos ejecutar nuestra propia nube de OpenShift localmente gracias a una máquina virtual o instalarla en nuestra infraestructura.</p>
</li>
<li>
<p>Dentro de la plataforma PaaS, el software utilizado para ejecutar las aplicaciones es el mismo que se utiliza en las aplicaciones de escritorio (presenta características propias de IaaS).</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_lenguajes_y_runtimes_soportados">5.9.1. Lenguajes y runtimes soportados</h4>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas06/openshift2.png" alt="openshift2">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_versiones_de_openshift">5.9.2. Versiones de OpenShift</h4>
<div class="paragraph">
<p>A partir de la idea de ofrecer un servicio PaaS OpenShift se desarrola en tres modalidades distintas:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas06/openshift.png" alt="openshift" width="50%">
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">OpenShift Origin</dt>
<dd>
<p>Es una solución PaaS gratuita, e código abierto y sujeta a licencia Apache2. Este proyecto es sobre el que se inician los nuevos desarrollos de la plataforma y por tanto es el que tiene las funcionalidades más novedosas, pero también es la plataforma menos rodada. Si queremos trabajar con esta versión de OpenShift, debemos descargar el software y configurar nuestra propia infraestructura para ejecutarla.  Si sólo queremos echar un vistazo, podemos descargar una imagen de una máquina ya configurada y ejecutarla con VMWare o VirtualBox.</p>
</dd>
<dt class="hdlist1">OpenShift Online</dt>
<dd>
<p>Aproximadamente cada tres semanas se genera una nueva release de OpenShift, que Red Hat se encarga de configurar y desplegar sobre AWS (Amazon) y la oferta como nube pública tanto en modalidad gratuita como en modalidad de pago</p>
</dd>
<dt class="hdlist1">OpenShift Enterprise</dt>
<dd>
<p>De forma trimestral se genera una versión en la que sólo se introducen las funcionalidades más maduras de OpenShift, y se ofrece como producto comercial con soporte completo por parte de Red Hat. En este caso, OpenShift Enterprise  puede ejecutarse tanto sobre infraestructura de nuestra propia empresa como en modalidad de nube privada en Amazon o Rackspace.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Con estas opciones, es fácil que encontremos una configuración de cloud que se adapte a nuestras necesidades, contando con una ventaja adicional y es que una aplicación es portable entre estas tres versiones siempre y cuando estén disponible los mismos componentes en la plataforma destino.</p>
</div>
<div class="paragraph">
<p>En estas sesiones trabajaremos con OpenShift Online, dado que nos va a permitir centrarnos en la configuración y codificación de las aplicaciones, dejando las tareas de infraestructura al proveedor.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Nomenclatura versiones OpenShift</div>
Las releases de OpenShift Origin se denominan Milestones, ya que son como puntos de control en un desarrollo que no acaba.  Por su parte las versiones de OpenShift enterprise se rigen por el estándar Major version, Minor version, donde el número más significativo se incrementa cuando hay un cambio notable en la arquitectura de OpenShift. Hasta mediados de 2015 las versiones disponibles eran la M4 para Origin y la 2.2 para Enterprise, sin embargo a partir de ese momento se publica una nueva versión del software sustentada en los proyectos de Docker, Kubernetes y Atomic y se unifica la nomenclatura para las versiones Origin y Enterprise: OpenShift 3.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_modalidades_de_pago_de_openshift_online">5.9.3. Modalidades de pago de OpenShift Online</h4>
<div class="paragraph">
<p>OpenShift Online, nos ofrece tres modalidades distintas de pago</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas06/planes.png" alt="planes">
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Gratuito</dt>
<dd>
<p>Nos permite trabajar con hasta tres servidores virtuales de tamaño pequeño y 1Gb de espacio en disco.</p>
</dd>
<dt class="hdlist1">Bronze</dt>
<dd>
<p>Podemos trabajar con hasta 16 servidores, tres gratuitos de tamaño pequeño y los siguientes de cualquier tamaño. A partir del cuarto se generan costes según el uso.</p>
</dd>
<dt class="hdlist1">Silver</dt>
<dd>
<p>Ofrece  las mismas características que la modalidad bronze, pero además pagamos el soporte técnico por parte de Red Hat.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Como ya hemos dicho, para proyectos pequeños podemos trabajar con la modalidad gratuita pero con las siguientes limitaciones:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Número reducido de servidores, y siempre de tamaño pequeño, lo que limita el software y la carga de trabajo que pueden gestionar.</p>
</li>
<li>
<p>Sólo se puede crear un único dominio en el que desplegar las aplicaciones..</p>
</li>
<li>
<p>Transcurridas 24h sin actividad, las aplicaciones se "serializan" a disco para liberar recursos, con lo que el siguiente acceso puede ralentizarse notablemente.</p>
</li>
<li>
<p>No es posible trabajar con certificados digitales propios (como ocurre si queremos utilizar nuestro propio dominio), tan sólo se puede utilizar uno genérico de OpenShift.</p>
</li>
<li>
<p>Espacio en disco limitado a 1 Gb.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_alternativas_a_openshift">5.9.4. Alternativas a OpenShift</h4>
<div class="paragraph">
<p>Si estamos decididos a utilizar PaaS para un proyecto comercial deberíamos conocer qué otras opciones de PaaS tenemos y si alguna de ellas se ajusta mejor a nuestras necesidades. Las principales soluciones PaaS actuales son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>AWS Elastic Beanstalk</em> de Amazon, con soporte a aplicaciones Java, .NET, PHP, Node.js, Python, Ruby y Docker <a href="http://aws.amazon.com/es/elasticbeanstalk/" class="bare">http://aws.amazon.com/es/elasticbeanstalk/</a></p>
</li>
<li>
<p><em>Heroku</em> , con soporte a Ruby, Node.js, Python, Java y PHP  <a href="https://www.heroku.com/features" class="bare">https://www.heroku.com/features</a></p>
</li>
<li>
<p><em>Cloud Foundry</em> de Pivotal, es una solución muy similar a OpenShift en cuando a planteamiento combinado Comercial/OpenSource. <a href="http://cloudfoundry.org/" class="bare">http://cloudfoundry.org/</a></p>
</li>
<li>
<p><em>BlueMix</em> de IBM, que es una implementación comercial de Cloud Foundry. <a href="https://ace.ng.bluemix.net/" class="bare">https://ace.ng.bluemix.net/</a></p>
</li>
<li>
<p><em>Azure</em> de Microsoft, que incluye tanto IaaS como PaaS y soporta el despliegue de máquinas Linux. <a href="http://azure.microsoft.com/en-us/documentation/articles/fundamentals-introduction-to-azure/" class="bare">http://azure.microsoft.com/en-us/documentation/articles/fundamentals-introduction-to-azure/</a></p>
</li>
<li>
<p><em>Google App Engine</em> , la plataforma de PaaS más veterana (2008). Admite Python, Java , PHP y Go.  <a href="https://cloud.google.com/appengine" class="bare">https://cloud.google.com/appengine</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_referencias_5">5.10. Referencias</h3>
<div class="ulist">
<ul>
<li>
<p>Informe Ontsi Mayo 2014 <a href="http://www.ontsi.red.es/ontsi/sites/default/files/e-pyme_13_analisis_sectorial_de_implantacion_de_las_tic_en_la_pyme_espanola.pdf" class="bare">http://www.ontsi.red.es/ontsi/sites/default/files/e-pyme_13_analisis_sectorial_de_implantacion_de_las_tic_en_la_pyme_espanola.pdf</a></p>
</li>
<li>
<p>Proveedores de Cloud Computing en España <a href="http://www.eurocloudspain.org/" class="bare">http://www.eurocloudspain.org/</a></p>
</li>
<li>
<p>Cómo elegir una plataforma PaaS <a href="http://eugenedvorkin.com/choosing-a-cloud-platform-for-java-application/" class="bare">http://eugenedvorkin.com/choosing-a-cloud-platform-for-java-application/</a></p>
</li>
<li>
<p>Legislación Cloud <a href="http://www.agpd.es/portalwebAGPD/canaldocumentacion/publicaciones/common/Guias/GUIA_Cloud.pdf" class="bare">http://www.agpd.es/portalwebAGPD/canaldocumentacion/publicaciones/common/Guias/GUIA_Cloud.pdf</a></p>
</li>
<li>
<p>The NIST Definition of Cloud Computing <a href="http://csrc.nist.gov/publications/nistpubs/800-145/SP800-145.pdf" class="bare">http://csrc.nist.gov/publications/nistpubs/800-145/SP800-145.pdf</a></p>
</li>
<li>
<p>Información sobre la Protección de datos <a href="http://cuidatusdatos.com/infoprotecciondedatos.html" class="bare">http://cuidatusdatos.com/infoprotecciondedatos.html</a></p>
</li>
<li>
<p>Transferencia internacional de datos <a href="https://www.ngncloud.com/blog/2013/10/lopd-y-la-transferencia-internacional-de-datos-en-soluciones-cloud/" class="bare">https://www.ngncloud.com/blog/2013/10/lopd-y-la-transferencia-internacional-de-datos-en-soluciones-cloud/</a></p>
</li>
<li>
<p>WordPress <a href="http://es.wikipedia.org/wiki/WordPress" class="bare">http://es.wikipedia.org/wiki/WordPress</a></p>
</li>
<li>
<p>OpenStack: IaaS open source <a href="https://www.openstack.org/" class="bare">https://www.openstack.org/</a></p>
</li>
<li>
<p>WordPress on OpenShift <a href="http://code.tutsplus.com/tutorials/running-wordpress-on-openshift-an-introduction%E2%80%94%E2%80%8Bcms-20058" class="bare">http://code.tutsplus.com/tutorials/running-wordpress-on-openshift-an-introduction&#8212;&#8203;cms-20058</a></p>
</li>
<li>
<p>Galería de aplicaciones desplegadas sobre OpenShift <a href="https://www.openshift.com/application-gallery" class="bare">https://www.openshift.com/application-gallery</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios_de_introducción_a_cloud_computing">5.11. Ejercicios de Introducción a Cloud Computing</h3>
<div class="paragraph">
<p>En esta sesión vamos a comenzar a trabajar con OpenShift Online, un producto de tipo nube pública de Red Hat. En las sesiones posteriores entraremos más en profundidad en sus características, pero ahora nos dedicaremos a configurar nuestra máquina virtual para trabajar con OpenShift y a realizar nuestros primeros despliegues en cloud.</p>
</div>
<div class="paragraph">
<p>Para trabajar con OpenShift hay que registrarse previamente accediendo a su página principal: <a href="https://www.openshift.com/" class="bare">https://www.openshift.com/</a></p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas05/ejer1.png" alt="ejer1" width="50%">
</div>
</div>
<div class="paragraph">
<p>Haremos click en la versión ONLINE y rellenaremos el formulario de inscripción. Todos los accesos a OpenShift que hagamos desde la universidad se verán desde fuera como provenientes de una misma dirección IP. Para evitar problemas de uso indebido de la plataforma Cloud, nos recomiendan que utilicemos la cuenta de correo del campus virtual en el formulario de registro:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas05/ejer2.png" alt="ejer2" width="50%">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A diferencia de otros proveedores, OpenShift no obliga a introducir los datos de una tarjeta de crédito para comenzar a trabajar, y la modalidad gratuita es suficiente para familiarizarse con el producto.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Una vez registrados se nos ofrece la posibilidad de crear nuestra primera aplicación en cloud, desde la consola web, o desde la línea de comandos, mediante una herramienta llamada <em>rhc</em>.</p>
</div>
<div class="paragraph">
<p>Por lo pronto instalaremos la herramienta en nuestra máquina virtual, con el siguiente comando:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span>sudo apt-get update
<span class="tok-gp">$</span>sudo apt-get install ruby
<span class="tok-gp">$</span>sudo gem install rhc</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Nota para Ubuntu 14.04</div>
La versión integrada de OpenSSL es relativamente antigua con lo que cada vez que ejecutemos el comando rhc nos mostrará un aviso indicando que no se está utilizando los certificados de seguridad más potentes: <em>RSA 1024 bit CA certificates are loaded due to old openssl compatibility</em>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A continuación configuraremos la herramienta rhc para trabajar contra OpenShift Online:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">rhc setup [--clean]</span></code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas05/ejer0.png" alt="ejer0">
</div>
</div>
<div class="paragraph">
<p>Mediante esta herramienta podremos realizar casi cualquier tarea contra OpenShift, pero en esta sesión trabajaremos desde la consola web:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas05/ejer3.png" alt="ejer3">
</div>
</div>
<div class="sect3">
<h4 id="_despliegue_en_cloud_de_una_aplicación_web_1_punto">5.11.1. Despliegue en Cloud de una aplicación web (1 punto)</h4>
<div class="paragraph">
<p>Vamos a comenzar por crear una aplicación web, que desplegaremos sobre un servidor Tomcat. Este sería uno de los despliegues más sencillos que podemos hacer en OpenShift. Lo haremos desde la consola web, haciendo click en la pestaña <em>applications</em> donde seleccionaremos la opción de Tomcat 7:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas05/ejer5.png" alt="ejer5">
</div>
</div>
<div class="paragraph">
<p>En la siguiente pantalla, se nos pide información adicional. Nos interesa en este caso asignar un nombre a nuestra aplicación, a la que llamaremos <em>hellocloud</em> y un namespace, que agrupará a todas las aplicaciones que vayamos a desplegar en OpenShift. Para esta aplicación, y a partir de ahora utilizaremos <strong>nuestro login</strong> del curso.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas05/ejer6.png" alt="ejer6">
</div>
</div>
<div class="paragraph">
<p>Sin más, pulsaremos en el botón de crear aplicación, y tras unos segundos de espera, habremos creado y desplegado nuestra aplicación web en la nube de RedHat. Lo primero que se nos muestra es información de cómo podemos acceder al código fuente de la aplicación para comenzar a trabajar:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas05/ejer65.png" alt="ejer65">
</div>
</div>
<div class="paragraph">
<p>Para acceder a ella, basta con abrir en un navegador la url: <a href="http://&lt;aplicacion&gt;-&lt;namespace&gt;.rhcloud.com/" class="bare">http://&lt;aplicacion&gt;-&lt;namespace&gt;.rhcloud.com/</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_importar_el_proyecto_desde_intellij_y_modificar_la_aplicación_0_4_puntos">5.11.2. Importar el proyecto desde IntelliJ y modificar la aplicación (0.4 puntos)</h4>
<div class="paragraph">
<p>Si ejecutamos la aplicación web, veremos que se abre una aplicación plantilla que nos vuelve a dar información sobre cómo podemos modificar el código de la aplicación. Para cada aplicación en OpenShift, se crea un repositorio Git con las fuentes y lo que tenemos que hacer es clonar dicho repositorio:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">git clone &lt;git_url&gt; &lt;directory_to_create&gt;</span>

<span class="tok-gp">#</span> Within your project directory
<span class="tok-gp">#</span> Commit your changes and push to OpenShift

<span class="tok-gp">$</span> git commit -a -m <span class="tok-s1">&#39;Some commit message&#39;</span>
<span class="tok-gp">$</span> git push</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para saber la URL del repositorio podemos volver a la consola web, y dentro de <em>Applications</em> hacer click sobre la nueva aplicación:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas05/ejer7.png" alt="ejer7">
</div>
</div>
<div class="paragraph">
<p>A continuación ya podremos abrir el proyecto desde nuestro IDE y comenzar a trabajar. <strong>Alternativamente</strong> podemos utilizar la función de IntelliJ de abrir un proyecto desde un repositorio de fuentes, mediante el comando <em>Checkout from Version Control</em>.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas05/ejer8.png" alt="ejer8" width="50%">
</div>
</div>
<div class="paragraph">
<p>Ahora, una vez tenemos ya el código fuente en el IDE, debéis crear un sencillo formulario en la página inicial que nos pida un nombre de usuario y llame  a un  servlet, denominado <em>HelloServlet</em>. Este servlet atenderá a las peticiones que lleguen al contexto <em>/hello</em> y simplemente nos mostrará un mensaje de bienvenida incluyendo el usuario que nos ha enviado el formulario. Lo crearemos en el paquete <em>org.expertojava.paas.servlets</em>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Para crear el servlet lo más sencillo es crearlo directamente desde el menú de  IntelliJ y anotarlo con @WebServlet("[contexto del servlet]")
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Una vez tengamos el código modificado, debéis hacer un <em>commit</em> de los cambios y posteriormente un <em>Push</em> al repositorio de OpenShift.  Si observáis en la ventana <em>Version Control</em> de IntelliJ podréis ver como el comando Push de Git ya encapsula todos los comandos necesarios para subir el código al servidor, compilar y redesplegar la aplicación:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas05/ejer9.png" alt="ejer9">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_despliegue_de_un_servicio_de_almacenamiento_en_cloud_0_4_puntos">5.11.3. Despliegue de un servicio de almacenamiento en Cloud (0.4 puntos)</h4>
<div class="paragraph">
<p>Openshift aporta plantillas (Quickstarts) para proyectos muy diversos. Para empezar vamos a utilizar la plantilla de OwnCloud para crear una aplicación OpenShift con el mismo nombre. OwnCloud es un software de almacenamiento en la nube en la línea de los servicios de DropBox o Google Drive aunque más rudimentario. Dispone además de herramientas cliente de sincronización para cualquier sistema operativo, y también permite montar directamente una unidad con su contenido mediante el protocolo WebDav.</p>
</div>
</div>
<div class="sect3">
<h4 id="_creación_de_un_blog_basado_en_wordpress_0_4_puntos">5.11.4. Creación de un blog basado en WordPress (0.4 puntos)</h4>
<div class="paragraph">
<p>Por último, vamos a utilizar OpenShift para crear un blog sobre Cloud Computing utilizando WordPress. Aunque WordPress ya ofrece la creación de blogs dentro de su dominio, estos se pueden gestionar de una forma muy limitada. La ventaja de utilizar Openshift es que nos va a facilitar toda la puesta en marcha del blog en cuanto a cuestiones técnicas, pero mantendremos las mismas posibilidades de personalización que una instalación en un servidor propio.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
WordPress es una de las herramientas más utilizadas para la creación de blogs y cuenta con un amplio catálogo de plugins.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En este ejercicio hay que crear un blog sobre tecnologías Cloud (aunque si tenéis especial interés en otro tema, adelante), personalizar la apariencia del blog y añadir al menos un Post.  Para ello debéis crear en OpenShift una nueva aplicación denominada <em>blog</em> mediante el Quickstart WordPress 4 e inicializarla.</p>
</div>
<div class="paragraph">
<p>Una vez hecho esto, debéis clonar el respositorio Git y crear un proyecto IntelliJ a partir de estos fuentes. Como veremos más adelante, la forma de aplicar cambios es siempre desde el repositorio Git al Gear y en este caso estamos cambiando la configuración directamente sobre el gear, con lo que nos encontraremos con que el repositorio no contendrá ninguna imagen o plugin que hayamos instalado. Queda fuera del alcance de esta sesión el conocer a fondo WordPress pero sí comentar que  debéis utilizar la herramienta de <em>export</em>  para extraer la información de los post y configuración básica del foro.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas05/ejer10.png" alt="ejer10">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
En el apartado de bibliografía tenéis un enlace en el que se explica cómo desplegar WordPress en OpenShift. No es necesario seguir todos esos pasos para completar el ejercicio pero sí os puede servir para profundizar en el tema si os interesa.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Una vez creado el blog, escribid algún post  a modo de inaguración.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Existe una aplicación de móvil para WordPress que podéis configurar para administrar y escribir en vuestro blog desde cualquier lugar
</td>
</tr>
</table>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas05/ejer11.png" alt="ejer11">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_entrega_4">5.11.5. Entrega</h4>
<div class="paragraph">
<p>En esta sesión debeis entregar las copias de los tres repositorios, excluyendo la carpeta .git para no ocupar demasiado espacio, así como una exportación XML del contenido de vuestro blog.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion06">6. Plataforma como Servicio</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_conceptos_propios_de_openshift">6.1. Conceptos propios de OpenShift</h3>
<div class="paragraph">
<p>A nivel de infraestructura, OpenShift se apoya en dos unidades funcionales básicas: el <em>broker</em> y los <em>Node Servers</em></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Broker</dt>
<dd>
<p>Este elemento es el punto de entrada para todas las tareas de administración. Es el encargado de administrar los login, la resolución DNS, el estado de las aplicaciones y la orquestación general . Los desarrolladores no trabajan directamente contra este elemento, si no que se invoca indirectamente a través de las herramientas de administración, que veremos a continuación. El broker utiliza un frameworks de orquestación de procesos en paralelo, llamado <em>MCollective</em> para enviar instrucciones a los node servers.</p>
</dd>
<dt class="hdlist1">Node Servers</dt>
<dd>
<p>Son las máquinas host que ejecutan tanto los Cartridges como los Gear  por tanto serán los encargados de alojar y ejecutar nuestras aplicaciones. Los Node Server también utilizan un cliente MCollective para recibir las instrucciones del broker.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
La comunicación entre los clientes MCollective del broker y los node server se realiza asíncronamente, mediante un sistema de cola de mensajes.
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Application</dt>
<dd>
<p>Será la aplicación propiamente dicha que despleguemos en la nube. En principio OpenShift está orientado hacia aplicaciones Web (en distintos lenguajes) por lo que los puertos a través de los cuales se podrá acceder a ellas son los típicos  de HTTP (80), HTTPS(443) y SSH (22). Adicionalmente se ofrece soporte beta a conectividad basada en WebSockets, a través de los puertos 8000 y 8443.</p>
</dd>
</dl>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas06/applications.png" alt="applications" width="50%">
</div>
</div>
<div class="paragraph">
<p>Las direcciones de las aplicaciones seguirán el siguiente patrón:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">https://[APPNAME]-[DOMAIN].rhcloud.com</span></code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Gear</dt>
<dd>
<p>Un gear es una partición de un Node server (CPU, memoria y almacenamiento) , que proporciona los recursos necesarios para ejecutar las aplicaciones. Se dividen en tres categorías: small (512Mb RAM), medium (1Gb) y large (2Gb). Para pequeñas aplicaciones suele ser suficiente el gear más limitado, sin embargo hay configuraciones concretas que recomiendan al menos 1Gb de RAM, como en el caso de querer trabajar con JBoss EAP. Cada Gear tendra una estructura de directorios como la siguiente:</p>
</dd>
</dl>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas06/openshift4.png" alt="openshift4">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Si nuestra aplicación supera el límite de memoria impuesto al gear, OpenShift matará automáticamente el proceso y lo relanzará.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Técnicamante, para aislar los procesos del Gear se utiliza Security-Enhanced Linux (SELinux) y para establecer las cuotas de memoria, cpu y disco se utiliza Control Groups (Cgroups). No se indica explícitamente la CPU y de E/S permitida para cada gear, pero Red Hat muestra estas cifras de ejemplo:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas06/openshift25.png" alt="openshift25">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Recientemente se ha anunciado una nueva configuración, denominada <em>Small.highcpu</em> que mantiene el tamaño máximo de memoria pero duplica la capacidad de proceso. También es posible contratar máquinas dedicadas privadas.
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Cartridge</dt>
<dd>
<p>Son los recursos que necesitan las aplicaciones para poder ejecutarse dentro de un gear.  La idea es <em>paquetizar</em> los distintos elementos (servidor de aplicaciones, base de datos, proxy, etc.) en cajas negras y permitir que el desarrollador pueda "insertar" aquellos <em>cartuchos</em> que considere necesarios dentro del gear. En definitiva una forma de abstraer la gestión de la infraestructura y es lo que lo diferencia de un modelo IaaS, si bien como veremos luego tendremos cierta libertad de hacer cambios en estos cartuchos. Hay dos categorías de cartridges:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Standalone</strong>:  Son los runtime de los lenguajes o bien servidores de aplicaciones y los principales responsables de poder desplegar una aplicación. Ejemplo: JBoss, Tomcat, Python o Node.js.</p>
</li>
<li>
<p><strong>Embedded</strong>: Proporcionan funcionalidades extendidas como almacenamiento en base de datos o ejecución de tareas planificadas (Cron), pero por si mismos no son suficientes para ejecutar una aplicación.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Application Scaling</dt>
<dd>
<p>Es una funcionalidad de escalado automática que permite adecuar la capacidad de proceso a la carga de trabajo actual. Si está activada, OpenShift monitoriza el tráfico de entrada y la carga de trabajo de los gear actuales y puede añadir nuevos gears para atender  un pico de trabajo y liberarlos cuando ya no sean necesarios. Mas adelante hablaremos de esta funcionalidad con más detalle.</p>
</dd>
<dt class="hdlist1">Proxy Ports</dt>
<dd>
<p>Permiten a los Gear exponer servicios que estén en ejecución. Cada Gear permite exponer hasta 5 servicios distintos.</p>
</dd>
<dt class="hdlist1">Herramientas de administración</dt>
<dd>
<p>OpenShift proporciona tres herramientas distintas:</p>
<div class="ulist">
<ul>
<li>
<p><strong>RHC</strong> una herramienta de administración en línea de comandos desarrollada en Ruby y portable a todas las plataformas. Veremos que al contrario de Jboss-cli, rhc si puede considerarse ser la herramienta principal de trabajo de administración.</p>
</li>
<li>
<p><strong>API REST</strong> Gran parte de la funcionalidad de RHC se expone también como un API Rest integrable en otras aplicaciones.</p>
</li>
<li>
<p><strong>Consola de administración Web</strong> que nos ofrece un entorno más amigable pero más limitada que RHC.</p>
</li>
<li>
<p><strong>JBoss Tools</strong> Se trata de una serie de plugins para Eclipse que integran en el IDE tanto el trabajo con JBoss/WildFly como el despliegue en cloud. Hay una versión específica de Eclipse llamada <em>JBoss Developer Studio</em> que ya lleva integrados estos plugins.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">SSH</dt>
<dd>
<p>OpenShift permite el acceso remoto a los gear desde nuestras máquinas locales mediante una conexión segura SSH. Como parte del proceso de configuración de la herramienta RHC se generan dos elementos de seguridad:</p>
<div class="ulist">
<ul>
<li>
<p>Un par de claves, pública y privada, asociadas a nuestra máquina. Sería algo parecido a la autenticación basada en certificados que estudiamos en la sesión 4 pero en este caso lo que se hace es subir a OpenShift la clave pública, y en el handshake de la conexión, el equipo envía un mensaje encriptado con la clave privada y OpenShift lo desencripta con la clave pública. Estos ficheros se almacenan en la capreta <em>./ssh</em> del directorio home en los ficheros id_rsa e id_rsa.pub.</p>
</li>
<li>
<p>Un token de autorización que será el que nos identifique en cada conexión evitando el tener que estar introduciendo usuario y clave para autenticarnos. Los token se almacenan en la carpeta <em>./openshift</em> del directorio HOME.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Dentro de una sesión SSH podremos acceder a los log de un gear, hacer cambios en la configuración e interactuar con los servicios desplegados pero no podremos realizar acciones que requieran ser superusuario. Mediante SSH también podremos activar una funcionalidad denominadad <em>port-forwarding</em> que permite mapear puertos de nuestra máquina local con puertos del gear permitiendo realizar tareas de administración desde nuestra máquina local de forma transparente. Lo veremos con más detalle en la siguiente sesión.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Git</dt>
<dd>
<p>Git es la herramienta de control de versiones que utiliza OpenShift. Toda aplicación desplegada en OpenShift tiene un repositorio Git asociado que se crea automáticamente al dar de alta la aplicación. Este repositorio contendrá tanto los fuentes de la aplicación como los elementos de configuración y plugins asociados. OpenShift tiene la particularidad de que cuando hacemos <em>push</em> a este respositorio, no sólo subimos los ficheros sino que aplicamos cambios de configuración, recompilarmos la aplicación y finalmente la redesplegamos, todo ello de forma automática.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_cómo_funciona_openshift">6.2. Cómo funciona OpenShift</h3>
<div class="paragraph">
<p>Esta sería la representación de la arquitectura de OpenShift, en base a los elementos que ya conocemos:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas06/openshift3.png" alt="openshift3">
</div>
</div>
<div class="paragraph">
<p>Cuando un cliente realiza una petición HTTP a una aplicación, en primer lugar se ubica el node server en el que corre la aplicación, mediante la resolución DNS. Cada node server tiene un servidor apache con el módulo de proxy habilitado,  y es quien encamina la petición al gear correspondiente, en función del nombre de la aplicación..</p>
</div>
<div class="paragraph">
<p>El siguiente gráfico describe el proceso de creación de una nueva aplicación:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas06/newapp.png" alt="newapp">
</div>
</div>
<div class="sect3">
<h4 id="_creación_de_aplicaciones">6.2.1. Creación de aplicaciones</h4>
<div class="paragraph">
<p>Vamos a crear una aplicación web mediante la herramienta rhc. Si ejecutamos <em>rhc</em> sin parámetros, se mostrará la ayuda y un listado con todas las opciones disponibles. A continuación enumeraremos las más comunes:</p>
</div>
<div class="paragraph">
<p>Listado de cartridges:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">rhc cartridge list</span></code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas06/rhc1.png" alt="rhc1">
</div>
</div>
<div class="paragraph">
<p>La opción cartridge indica que vamos a ejecutar comandos relacionados con cartridges y  <em>list</em> indica es la instrucción para que se muestren los cartridges disponibles. Una particularidad es que en la consola web muestra cartridges adicionales desarrollados por la comunidad y para los que Red Hat no ofrece soporte mientras que en la herramienta rhc no aparecen.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Es conveniente actualizar periódicamente las herramientas rhc, con el comando <em>gem update rhc</em>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para crear un aplicación debemos tener claro en qué lenguaje vamos a trabajar y una idea de que cartridges vamos a necesitar. Con esta información ejecutaremos el siguiente comando:</p>
</div>
<div class="paragraph">
<p>Crear una aplicación</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">rhc app-create  [nombre_app]  [cartridge ...]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">rhc app create miapp python-2.7</span></code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas06/rhc2.png" alt="rhc2">
</div>
</div>
<div class="paragraph">
<p>Con esta instrucción crearemos un nuevo gear, un repositorio Git, un servidor Apache con el módulo _ mod_wsgi_  y una aplicación plantilla en Python desplegada. También se ejecutará un comando <em>git clone</em> y nos descargaremos el código fuente en una carpeta con el mismo nombre que la aplicación. ¡Fácil y rápido!</p>
</div>
<div class="paragraph">
<p>Este comando tiene parámetros adicionales que pueden ser de utilidad:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">-n, --namespace NAME</dt>
<dd>
<p>Permite especificar el dominio de la aplicación.</p>
</dd>
<dt class="hdlist1">-g, --gear-size SIZE</dt>
<dd>
<p>Permite especificar el tamaño del gear. Si no se especifica se utiliza el tamaño por defecto (small)</p>
</dd>
<dt class="hdlist1">-s, --[no-]scaling</dt>
<dd>
<p>Habilita el Application Scaling</p>
</dd>
<dt class="hdlist1">--from-app NAME</dt>
<dd>
<p>Permite crear una aplicación tomando otra como plantilla.</p>
</dd>
<dt class="hdlist1">--from-code URL</dt>
<dd>
<p>Permite especificar un repositorio Git como origen del código fuente de la aplicación, en lugar de la plantilla.</p>
</dd>
<dt class="hdlist1">--region</dt>
<dd>
<p>Zona geográfica donde se creará el gear: (aws-eu-west-1, aws-us-east-1)</p>
</dd>
</dl>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Ubicación geográfica</div>
Desde septiembre de 2014 es posible especificar la zona en la que queremos que se cree nuestra aplicación. Hasta esa fecha únicamente se trabajaba sobre infraestructura de Amazon ubicada en Estados Unidos y a partir de ahora se puede trabajar sobre AWS en Irlanda.  Hay que tener en cuenta que OpenShift sólo permite especificar la región si tenemos un plan de pago y vamos a utilizar un gear superior a <em>small</em>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si queremos crear una aplicación basada en un tipo de servidor que no esté en la lista de cartridges que muestra OpenShift tenemos dos opciones:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Utilizar el cartridge <em>Do-It-Yourself</em> y configurar a mano un gear como si se tratase de una plataforma IaaS.</p>
</li>
<li>
<p>Recurrir a los cartridges desarrollados por la comunidad de usuarios de OpenShift. De hecho, a la fecha de redacción de esta sesión WildFly 8 no tiene aún un cartridge soportado directamente por Red Hat.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Hay que tener claro a la hora de elegir un cartridge, el tipo de soporte que tendrá. La inmensa mayoría de cartridges mantenidos por OpenShift tienen soporte automático de parches de seguridad, con lo que podemos despreocuparnos de este aspecto.  Si escogemos un cartridge desarrollado por terceros, debemos esta pendientes de aplicar estas actualizaciones. En un entorno de producción, sólo se deberían utilizar cartridges mantenidos por OpenShift, o en todo caso, generados por nosotros con el método genérico de Do-It-Yourself.</p>
</div>
<div class="paragraph">
<p>Para añadir un cartridge desarrollado por terceros se puede utilizar el siguiente comando</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">rhc app create &lt;APP&gt; &lt;URL&gt;</span>

<span class="tok-go">rhc wildfly8 create https://cartreflect-claytondev.rhcloud.com/reflect?github=OpenShift-cartridges/OpenShift-wildfly-cartridge</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El comando creará una aplicación llamada <em>wildfly8</em> y descargará el cartridge de la dirección inidicada. Concretamente la URL tiene que apuntar a un fichero denominado <em>manifest.yml</em> que contiene la definición del cartridge.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Ya es posible crear una aplicación basada en WildFly sin necesidad de utilizar un cartridge externo a OpenShift. El nuevo cartridge se llama <em>jboss-wildfly-8</em>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Desde la consola web, el proceso de creación es muy similar, basta con elegir un tipo de aplicación y rellenar los datos que se solicitan. Alternativamente es posible indicar la URL de un cartridge descargable para crear una aplicación diferente a las enumeradas:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas06/altaApp.png" alt="altaApp">
</div>
</div>
<div class="paragraph">
<p>Otra característica propia de la consola web es que podemos crear una aplicación a partir de un <em>Quickstart</em>. Los quickstart tienen la apariencia de un cartridge normal, si bien son combinaciones de cartridges ya predefinidas para desplegar un tipo de aplicación, además de una configuración de inicio para dicha aplicación. OpenShift tiene bastantes quickstarts con lo que merece la pena buscar uno que se adapte a nuestro proyecto.</p>
</div>
<div class="paragraph">
<p>Una vez creada la aplicación, normalmente se muestra por pantalla las claves de administración del nuevo servidor. No será habitual tener que acceder a la consolta web, dado que la filosofía de OpenShift es desplegar y configurar la aplicación desde el repositorio Git, puede ser muy útil tener estas claves para hacer alguna prueba o un cambio puntual en una instancia que no queramos reiniciar.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas06/claves.png" alt="claves">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_añadir_cartridges_de_base_de_datos">6.2.2. Añadir Cartridges de base de datos</h4>
<div class="paragraph">
<p>Ya conocemos los cartridge que permiten crear aplicaciones pero ahora veremos qué cartridges podemos añadir que proporcionen funciones adicionales como almacenamiento de datos, ejecución de tareas programadas o monitorización.</p>
</div>
<div class="paragraph">
<p>La forma más sencilla de crear estos módulos es simplemente indicarlos en el momento de crear la aplicación.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">rhc app create  [nombre_app]  [cartridge1] ... [cartridgen]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Aunque es perfectamente posible añadirlos o quitarlos a posteriori, con el comando:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">rhc cartridge-add [cartridge] --app [nombre_app]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En el siguiente ejemplo, añadiremos una instancia de MySQL:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas06/bd1.png" alt="bd1">
</div>
</div>
<div class="paragraph">
<p>Si estamos trabajando desde la web, lo habitual es crear la aplicación y al seleccionarla, OpenShift nos ofrecerá directamente la posibilidad de añadir estos módulos.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Hay determinados catridges que sólo se pueden incluir tras instalar uno específico, como por ejemplo, el módulo de administración de BD phpMyAdmin, que sólo se puede instalar si ya hemos incorporado una base de datos MySQL al proyecto.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Al añadir un nuevo cartridge de base de datos, tanto desde la consola web como mediante rhc se nos informa del usuario y password de administración de dicha base de datos. En este caso, no es necesario apuntarnos esta información porque siempre la podremos recuperar desde l/a consola web. Lo que sí que es muy recomendable es <strong>reiniciar la aplicación</strong> para que el gear cargue las variables de entorno necesarias para poder acceder a la nueva base de datos:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas06/bd2.png" alt="bd2">
</div>
</div>
<div class="sect4">
<h5 id="_creación_de_datasources">Creación de DataSources</h5>
<div class="paragraph">
<p>Si examinamos la configuración del servidor, dentro del repositorio GIT:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go"> .openshift/config/standalone.xml</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Veremos que por defecto trae configurados tres datasources, uno para una base de datos en memoria, otro para MySQL y otro para PostgreSQL. Si hemos añadido una BD MySQL y hemos reiniciado la aplicación como se indicaba en el paso anterior, WildFly automáticamente activará su DataSource:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas06/bd3.png" alt="bd3">
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_port_forwarding">6.2.3. Port forwarding</h4>
<div class="paragraph">
<p>Repasando lo aprendido hasta ahora, hemos creado una aplicación Java, hemos añadido una base de datos y la hemos desplegado en un servidor.  También sabemos que podemos modificar la configuración del servidor de aplicaciones y otros elementos haciendo cambios en los ficheros correspondientes del repositorio Git. Por ejemplo para definir un DataSource podríamos editar el fichero de configuración, creando uno nuevo a partir de los Datasources de ejemplo.</p>
</div>
<div class="paragraph">
<p>Pero ahora, al disponer de una base de datos necesitaremos trabajar directamente contra el servidor de base de datos, como por ejemplo para crear la BD de trabajo y sus datos. OpenShift permite hacer esto de varias formas, pero a continuación veremos un mecanismo que permite gestionar la configuración de los servicios desplegados en cloud, como si fueran servicios locales en la máquina del desarrollador.</p>
</div>
<div class="paragraph">
<p>El principal obstáculo que nos encontramos es que los puertos de administración <strong>no</strong> son visibles desde el exterior del servidor con lo que necesitamos algo que nos permita llegar a través de los puertos que sí son accesibles (https,ssh).</p>
</div>
<div class="paragraph">
<p>OpenShift proporciona para ello el comando <strong>port-forward</strong>. Se ejecuta especificando una aplicación:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">rhc port-forward &lt;app&gt;</span></code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas06/portforward.png" alt="portforward">
</div>
</div>
<div class="paragraph">
<p>Se trata de una utilidad que busca puertos libres en nuestro equipo de desarrollo y enlaza con los puertos administrativos de los servicios que se ejecutan en un gear, todo esto a través de un canal ssh. Mientras el comando esté en ejecución podremos administrar los servicios del gear configurando las herramientas de administración para que se conecten al puerto correspondiente de <em>localhost</em> .</p>
</div>
</div>
<div class="sect3">
<h4 id="_modificación_y_despliegue_de_las_aplicaciones">6.2.4. Modificación y despliegue de las aplicaciones</h4>
<div class="paragraph">
<p>La estructura de un repositorio de una aplicación desplegada en OpenShift varía según la tecnología. En el caso de JBossAS 7 / WildFly es la siguiente:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas06/repo.png" alt="repo">
</div>
</div>
<div class="paragraph">
<p><a href="https://developers.OpenShift.com/en/jbossas-overview.html" class="bare">https://developers.OpenShift.com/en/jbossas-overview.html</a></p>
</div>
<div class="paragraph">
<p>Si hemos creado el proyecto con rhc ya tendremos el proyecto en nuestro ordenador, pero si sólo hemos creado la aplicación desde la consola web, debemos descargarnos una copia del repositorio Git de OpenShift, podemos hacerlo de varias formas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ejecutar <em>git clone</em> desde un terminal con la url que se muestra en las propiedades de la aplicación:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">git clone ssh://5408af5a4382ece19c00020f@wildfly8-jlzamora.rhcloud.com/~/git/wildfly8.git/</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Utilizar el comando <em>git-clone</em> de <em>rhc</em></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">rhc git-clone &lt;app&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
rhc añade información adicional al repositorio de modo que los siguientes comandos rhc que lancemos desde dentro de el automáticamente identifiquen la aplicación. Si hemos creado el repositorio con otras herramientas, será necesario especificar manualmente el nombre de la aplicación.
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Desde IntelliJ, con la opción  <em>Check Out from Version Control</em></p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Si la instancia está en estado <em>idle</em> por inactividad, es necesario acceder a la aplicación web para que se inicie porque si no el clonado del repositorio también fallará.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Una vez importado en IntelliJ podemos editar el fichero pom.xml del proyecto. En él, veremos una característica propia de OpenShift:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;profiles&gt;</span>
    <span class="tok-nt">&lt;profile&gt;</span>
     <span class="tok-c">&lt;!-- When built in openshift the &#39;openshift&#39; profile will be used when invoking mvn. --&gt;</span>
     <span class="tok-c">&lt;!-- Use this profile for any OpenShift specific customization your app will need. --&gt;</span>
     <span class="tok-c">&lt;!-- By default that is to put the resulting archive into the &#39;deployments&#39; folder. --&gt;</span>
     <span class="tok-c">&lt;!-- http://maven.apache.org/guides/mini/guide-building-for-different-environments.html --&gt;</span>
     <span class="tok-nt">&lt;id&gt;</span>openshift<span class="tok-nt">&lt;/id&gt;</span>
     <span class="tok-nt">&lt;build&gt;</span>
        <span class="tok-nt">&lt;finalName&gt;</span>wildfly8<span class="tok-nt">&lt;/finalName&gt;</span>
        <span class="tok-nt">&lt;plugins&gt;</span>
          <span class="tok-nt">&lt;plugin&gt;</span>
                <span class="tok-nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="tok-nt">&lt;/groupId&gt;</span>
                <span class="tok-nt">&lt;artifactId&gt;</span>maven-war-plugin<span class="tok-nt">&lt;/artifactId&gt;</span>
                <span class="tok-nt">&lt;version&gt;</span>2.4<span class="tok-nt">&lt;/version&gt;</span>
                <span class="tok-nt">&lt;configuration&gt;</span>
                    <span class="tok-nt">&lt;failOnMissingWebXml&gt;</span>false<span class="tok-nt">&lt;/failOnMissingWebXml&gt;</span>
                    <span class="tok-nt">&lt;outputDirectory&gt;</span>deployments<span class="tok-nt">&lt;/outputDirectory&gt;</span>
              		  <span class="tok-nt">&lt;warName&gt;</span>ROOT<span class="tok-nt">&lt;/warName&gt;</span>
                <span class="tok-nt">&lt;/configuration&gt;</span>
            <span class="tok-nt">&lt;/plugin&gt;</span>
        <span class="tok-nt">&lt;/plugins&gt;</span>
      <span class="tok-nt">&lt;/build&gt;</span>
    <span class="tok-nt">&lt;/profile&gt;</span>
  <span class="tok-nt">&lt;/profiles&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>OpenShift se apoya en el sistema de profiles de Maven para  modificar las características del proyecto generado según estemos trabajando en nuestro equipo o estemos desplegando en la nube. La forma habitual de desplegar aplicaciones web en JBossAS7/WildFly consiste en copiar una aplicación empaquetada WAR/EAR a la carpeta deployments <strong>del repositorio GIT</strong>, con nombre de fichero ROOT.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Si el War/Ear tiene nombre ROOT, se podrá acceder a la aplicación con la URL <a href="http://app-domain.rhcloud.com/mywebsite" class="bare">http://app-domain.rhcloud.com/mywebsite</a>. Si tuviera otro nombre, se accederá por el nombre específico: <a href="http://app_name-namespace.rhcloud.com/nombre_app" class="bare">http://app_name-namespace.rhcloud.com/nombre_app</a>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Los goals por defecto que indica OpenShift a la hora de construir una aplicación son  “clean package -Popenshift -DskipTests“.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Una vez tenemos el proyecto importado podemos hacer los cambios que consideremos sobre él, manteniendo el profile OpenShift y utilizar una instancia local de WildfFly para hacer las pruebas que consideremos convenientes. Podemos proteger los cambios haciendo <strong>commit</strong> con la herramienta git, pero será cuando hagamos <strong>push</strong> cuando subamos los cambios al repositorio de OpenShift y desencadenemos la compilación y despliegue del proyecto en cloud.</p>
</div>
<div class="paragraph">
<p>Alternativamente en IntelliJ se puede definir la configuración de despliegue <em>Openshift Deployment</em> de modo que para el IDE sea análogo a desplegar en cualquier otro servidor de aplicaciones. De hecho, podemos tener dos configuraciones, una <em>local</em> donde hacer nuestras pruebas y otra configuración, <em>cloud</em> para desplegar en OpenShift.</p>
</div>
<div class="paragraph">
<p>Una limitación de IntelliJ 13.1 es que no detecta si una aplicación requere Java EE 7 y presupone que vamos a trabajar con Java EE 6. Por este motivo cuando despleguemos una nueva aplicación en cloud, dicho plugin intentará crear un gear basado en JbossAS7 y desplegar en él nuestra aplicación. La forma de salvar este comportamiento es la siguiente:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crear una aplicación Wildfly8 desde la consola web.</p>
</li>
<li>
<p>En IntelliJ desde la opción  <em>Run&#8594;Edit configurations</em> crear un nuevo "OpenShift Deployment":</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas06/deploy1.png" alt="deploy1">
</div>
</div>
<div class="paragraph">
<p>Es muy importante marcar <em>use custom application name</em> porque ahí vamos a indicar el nombre de la aplicación que hemos creado en el punto anterior. IntelliJ si detecta que ya existe el gear en lugar de crearlo trabajará contra su repositorio Git. El plugin se encargará de eliminar el contenido antiguo del repositorio y subir los ficheros específicos para hacer el despliegue de la nueva aplicación.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas06/deploy2.png" alt="deploy2">
</div>
</div>
</li>
<li>
<p>Añadir el profile "openshift" al fichero pom.xml, especificando como finalname el nombre de la aplicación (gear)</p>
</li>
<li>
<p>Ejecutar la aplicación seleccionando la configuración de IntelliJ que hemos creado y pulsando el botón "Play".</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Si elimináis un gear y lo volvéis a crear con el mismo nombre, no os va a funciona el despliegue desde IntelliJ porque las claves del gear cambian. Es necesario "parar" y "arrancar" OpenShift desde la vista de <em>Application Servers</em> para que se reeenvíe esta información.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_consulta_de_logs">6.2.5. Consulta de Logs</h4>
<div class="paragraph">
<p>Todas las aplicaciones suelen generar información de depuración para poder verificar su correcto funcionamiento, o tener información adicional acerca de un error que se esté produciendo. Para poder consultar el log de una aplicación existe un comando específico de RHC:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">rhc tail &lt;APP&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Con este comando se ejecutará en remoto el comando unix tail, y se visualizarán los logs de todos los cartridges definidos en el gear. En el caso de tener un servidor de aplicaciones y una base de datos, se devolvería la información de ambos. Admite los siguientes parámetros:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">-f files</dt>
<dd>
<p>Permite especificar una o varias carpetas o ficheros a mostrará</p>
</dd>
<dt class="hdlist1">-o 'opciones'</dt>
<dd>
<p>Permite pasar parámetros al comando tail, como por ejemplo el número de líneas a devolver</p>
<div class="literalblock">
<div class="content">
<pre>rhc tail wildfly8 -o '-n 100'</pre>
</div>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Además de consultar los logs existe un comando específico para limpiar los ficheros temporales y de logs de un gear tanto de git como de los servcios en ejecución:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">rhc app tidy &lt;APP&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_borrado_de_aplicaciones">6.2.6. Borrado de aplicaciones</h4>
<div class="paragraph">
<p>Si queremos eliminar una aplicación de OpenShift, basta con acceder a la consola web, seleccionar la aplicación y pulsar en el botón <em>Delete this application&#8230;&#8203;</em>. Alternativamente, por línea de comandos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">rhc app delete &lt;APP&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Si borramos una aplicación estamos liberando un gear con lo que destruiremos la aplicación desplegada, la configuración del servidor y el repositorio de código fuente con lo que esta opción siempre hay que usarla con precaución.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_gestión_del_dominio">6.2.7. Gestión del dominio</h4>
<div class="paragraph">
<p>Al comenzar a trabajar con OpenShift es necesario crear un dominio en el que comenzaremos a crear las aplicaciones. Si desde la consola web pulsamos en el nombre de un domino, podemos acceder a la siguiente pantalla administrativa:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas06/domain.png" alt="domain" width="100%">
</div>
</div>
<div class="paragraph">
<p>Desde esta pantalla podemos dar permisos sobre nuestro dominio, a otros usuarios de OpenShift y en distintas modalidades. Si por el contrario es a nuestro usuario al que se le otorgan permisos de acceso sobre otro dominio, veremos todos nuestros dominios más los autorizados desde la vista <em>Applications</em> junto con las aplicaciones que contengan.</p>
</div>
<div class="paragraph">
<p>Note: Los accesos en modo Edit o Administrator permiten modificar aspectos de las aplicaciones y acceder a sus repositorios de código fuente.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_marketplace">6.3. Marketplace</h3>
<div class="paragraph">
<p>El Marketplace de Openshift es un espacio de reciente creación donde se ofrece la posibilidad de que otras empresas publiquen herramientas o servicios integrables co la plataforma PaaS de Red Hat. El número de productos disponible hasta el momento es escaso, si bien los que hay son bastante interesantes y merece la pena revisarlos al completo. La inmensa mayoría de estos servicios se ofrecen en modalidad gratuita con una serie de limitaciones, de modo que nos sirvan para evaluarlos y si realmente estamos interesados en ellos, los contratemos.</p>
</div>
<div class="paragraph">
<p>Para acceder al Marketplace basta con acceder a la consola web de Openshift y pulsar en el enlace de la parte superior derecha denominado <em>Addons</em> o acceder a la dirección:</p>
</div>
<div class="paragraph">
<p><a href="https://marketplace.openshift.com/openshift" class="bare">https://marketplace.openshift.com/openshift</a></p>
</div>
<div class="paragraph">
<p>Los servicios se muestran clasificados por su tipología. Si nos interesa uno de ellos, en primer lugar hay que "comprarlo" y posteriormente añadirlo a las aplicaciones que queramos. Puede parecer similar a lo que ya conocemos de los cartridges pero la realidad es que cada producto se integra de una forma particular y escasamente documentada.</p>
</div>
<div class="paragraph">
<p>Por ejemplo: si queremos trabajar con una base de datos externa podemos contratar el servicio de ClearDB que nos proporciona una instancia MySQL de 10 Mb alojada en sus servidores. Una vez contratada, pulsaremos en el botón "Add to Apps" y seleccionaremos la aplicación o aplicaciones que queremos que utilicen este servicio.  En el caso concreto de ClearDB se crean unas variables de entorno con los valores adecuados para crear un DataSource que apunte a la BD en la nube, pero es posible que algún servicio incorpore elementos adicionales a los gear. Para más información es conveniente revisar la documentación del Proveedor de servicios.</p>
</div>
</div>
<div class="sect2">
<h3 id="_monitorización">6.4. Monitorización</h3>
<div class="paragraph">
<p>OpenShift hasta el momento no proporciona un cuadro de mando al estilo de otras plataformas como AWS, donde poder comprobar la carga de cada servidor, consumo de recursos o establecer alertas de monitorización. Debemos acudir a cartridges específicos o bien dado que trabajamos con componentes estándar, acudir a sus propias interfaces de monitorización.</p>
</div>
<div class="sect3">
<h4 id="_herramientas_estándar_de_monitorización">6.4.1. Herramientas estándar de monitorización</h4>
<div class="sect4">
<h5 id="_snoop_jsp">snoop.jsp</h5>
<div class="paragraph">
<p>Más que herramienta, se consideraría una página con información de monitorización que OpenShift incluye en sus plantillas de proyectos. En dicha página se muestra información del consumo de memoria de la JVM que proporciona el contenedor de servlets. Por defecto se trata de una página de acceso público. La forma usual de acceder es:</p>
</div>
<div class="paragraph">
<p><a href="http://&lt;app&gt;-&lt;domain&gt;.rhcloud.com/snoop.jsp" class="bare">http://&lt;app&gt;-&lt;domain&gt;.rhcloud.com/snoop.jsp</a></p>
</div>
</div>
<div class="sect4">
<h5 id="_port_forwarding_y_jmx">port-forwarding y JMX</h5>
<div class="paragraph">
<p>Ya sabemos que mediante el comando port-forward podemos acceder a servicios de OpenShift como si fueran servicios que se ejecutan en local. Gracias a esto, podemos acceder al puerto de administración de WildFly o cualquier otro servidor que se ejecute en un gear, desde nuestra máquina local y utilizar cualquier herramienta de monitorización basada en JMX para monitorizar el funcionamiento de la JVM y acceder a los MBeans del servidor.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Un MBean es un objeto de java muy similar a los componentes EJB, pero que cumplen la especificación del API JMX de monitorización. Un MBean puede representar un dispositivo, una aplicación desplegada en el servidor o cualquier recurso gestionado por el servidor de aplicaciones. Para cada uno de ellos, los MBean exponen atributos con su estado de sólo lectura, valores de configuración de lectura/escritura y/o métodos que permiten realizar tareas de administración.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Como ejemplo utilizaremos JVisualVm que es una herramienta perteneciente al JDK.</p>
</div>
<div class="paragraph">
<p>La ejecutaremos con el siguiente comando:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> jvisualvm --cp:a /usr/local/wildfly/bin/client/jboss-cli-client.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>Una vez iniciada la herramienta, añadiremos una nueva conexión JMX especificando la conexión al servidor a través de la IP local y el puerto redirigido al puerto de administración de WildFly, así como el usuario/password de administración de WildFly:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas08/visualvm1.png" alt="visualvm1" width="50%">
</div>
</div>
<div class="paragraph">
<p>Una vez establecida la conexión ya podemos acceder a la información que se recoge en tiempo real del servidor:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas08/visualvm2.png" alt="visualvm2">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
En VisualVM es necesario añadir un plugin para poder acceder a la información de MBeans, desde la configuración de la propia herramienta.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Otra posibilidad es utilizra la herramienta cliente de WildFly conectándonos desde nuestra máquina. Dado que el mecanismo de port-forward intenta utilizar los mismos puertos en la máquina local y gear, bastaría con ejecutar CLI y especificar usuario y password de administración para empezar a trabajar.</p>
</div>
<div class="paragraph">
<p>En las referencias hay un enlace donde se explican algunos ejemplos de consultas que podemos hacer desde CLI.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_cartridges_de_terceros">6.4.2. Cartridges de terceros</h4>
<div class="paragraph">
<p>Otra opción es buscar un módulo desarrollado por terceros que implemente funcionalidades de monitorización del gear, ya sea gratuito o de pago.</p>
</div>
<div class="paragraph">
<p>Como ejemplo de herramienta gratuita tenemos Monit. Monit presenta un panel muy sencillo en el que se muestra el estado de los servicios en ejecución del gear y el estado de las cuotas de memoria y almacenamiento.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas08/monit.png" alt="monit">
</div>
</div>
<div class="paragraph">
<p>El módulo es OpenSource y su código fuente e instrucciones de instalación lo podéis encontrar en este enlace:</p>
</div>
<div class="paragraph">
<p><a href="https://raw.githubusercontent.com/openshift-cartridges/openshift-origin-cartridge-monit/master/metadata/manifest.yml" class="bare">https://raw.githubusercontent.com/openshift-cartridges/openshift-origin-cartridge-monit/master/metadata/manifest.yml</a></p>
</div>
<div class="paragraph">
<p>Sus funciones por defecto son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Cuadro resumen del estado del gear, se accede a través de la dirección <a href="https://&lt;app&gt;-&lt;domain&gt;.rhcloud.com/monit-status" class="bare">https://&lt;app&gt;-&lt;domain&gt;.rhcloud.com/monit-status</a> y  autentica mediante usuario/password.</p>
</li>
<li>
<p>Alertas por mail cuando se alcance un 80% de ocupación de memoria o disco y acciones preventivas cuando se llegue al 90% (reiniciar la aplicación en el caso de un elevado consumo de memoria, y lanzar un comando "tidy" en el caso de que nos estemos quedando sin espacio.</p>
</li>
<li>
<p>Alertas cuando haya caídas en algún servicio y si la caida dura más de 90 segundos, se intenta reiniciar la aplicación principal.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Estas reglas se pueden modificar y ampliar modificando el fichero <em>.monitrc</em></p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
La herramienta no está totalmente adaptada a OpenShift y lo podemos ver si intentamos pulsar en los enlaces de la pantalla de monitorización. Todos ellos están referidos al context-root del servidor cuando realmente en el context-root está nuestra aplicación. La herramienta funciona bien pero para acceder a las pantallas relacionadas hay que editar el link y añadir el contexto raíz de Monit, <em>monit-status</em>.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_monitorización_de_base_de_datos">Monitorización de base de datos</h5>
<div class="paragraph">
<p>Específicamente para tareas administrativas y de monitorización de bases de datos tenemos los siguientes cartridges:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>phpMyAdmin para MySQL.</p>
</li>
<li>
<p>RockMongo, MongoDB Monitoring Service para MongoDB.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Estos módulos se pueden instalar en los gear que ya dispongan de una instancia del gestor de base de datos desplegada.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas08/mysql.png" alt="mysql">
</div>
<div class="title">Figure 1. phpMyAdmin</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_referencias_6">6.5. Referencias</h3>
<div class="ulist">
<ul>
<li>
<p>OpenShift System Architecture Guide <a href="http://OpenShift.github.io/documentation//oo_system_architecture_guide.html" class="bare">http://OpenShift.github.io/documentation//oo_system_architecture_guide.html</a></p>
</li>
<li>
<p>OpenShift Quickstarts <a href="https://www.OpenShift.com/quickstarts" class="bare">https://www.OpenShift.com/quickstarts</a></p>
</li>
<li>
<p>Community Cartridges for OpenShift <a href="https://github.com/OpenShift-cartridges" class="bare">https://github.com/OpenShift-cartridges</a></p>
</li>
<li>
<p>Portal de desarrolladores de OpenShift	<a href="https://developers.OpenShift.com/" class="bare">https://developers.OpenShift.com/</a></p>
</li>
<li>
<p>Libro Getting started with OpenShift <a href="https://www.OpenShift.com/promotions/ebook" class="bare">https://www.OpenShift.com/promotions/ebook</a></p>
</li>
<li>
<p>Ejemplos:  <a href="https://github.com/codemiller/getting-started-with-OpenShift" class="bare">https://github.com/codemiller/getting-started-with-OpenShift</a></p>
</li>
<li>
<p>API REST de administración <a href="https://access.redhat.com/documentation/en-US/OpenShift_Online/2.0/html/REST_API_Guide/index.html" class="bare">https://access.redhat.com/documentation/en-US/OpenShift_Online/2.0/html/REST_API_Guide/index.html</a></p>
</li>
<li>
<p>Monitorización de JBoss EAP/WildFly mediante CLI <a href="http://blog.akquinet.de/2014/09/15/monitoring-the-jboss-eap-wildfly-application-server-with-the-command-line-interface-cli" class="bare">http://blog.akquinet.de/2014/09/15/monitoring-the-jboss-eap-wildfly-application-server-with-the-command-line-interface-cli</a></p>
</li>
<li>
<p>Twitter de OpenShift Operations <a href="https://twitter.com/openshift_ops" class="bare">https://twitter.com/openshift_ops</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios_de_plataforma_como_servicio">6.6. Ejercicios de Plataforma como servicio</h3>
<div class="paragraph">
<p>Vamos a comenzar a trabajar con OpenShift  como plataforma sobre la que desplegar nuestras primeras aplicaciones. Como en la sesión anterior utilizamos los tres gear que tenemos disponibles para trabajar, debéis eliminar uno de ellos. Utilizad el comando rhc adecuado para borrar la aplicación _ OwnCloud_de la sesión anterior.</p>
</div>
<div class="sect3">
<h4 id="_despliegue_desde_un_repositorio_externo_0_2_puntos">6.6.1. Despliegue desde un repositorio externo (0.2 puntos)</h4>
<div class="paragraph">
<p>Vamos a practicar cómo crear una aplicación OpenShift a partir de un código fuente situado en un repositorio externo. Tenéis que crear una nueva aplicación OpenShift de nombre <em>ejemplo</em> indicando de dónde se tienen que obtener los fuentes  de la aplicación. En este caso trabajaréis con un repositorio en GitHub</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/Djbyte1977/ejemplo-OpenShift.git" class="bare">https://github.com/Djbyte1977/ejemplo-OpenShift.git</a></p>
</div>
<div class="paragraph">
<p>Se pide:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crear la aplicación <em>ejemplo</em> desde la consola Web de OpenShift.</p>
</li>
<li>
<p>Utilizar la herramienta RHC y crearla desde el terminal utilizando una sola instrucción.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_desarrollo_mixto_local_cloud_0_8_puntos">6.6.2. Desarrollo mixto local/cloud  (0.8 puntos)</h4>
<div class="paragraph">
<p>Vamos a trabajar sobre la aplicación InsultApp. Esta aplicación es una versión de la aplicación con el mismo nombre publicada en el libro Getting Started with OpenShift, que podéis encontrar en las referencias. Se trata de un generador de "insultos" no demasiado ofensivos, que funciona en base a una base de datos de palabras. En las plantillas podéis encontrar el código fuente del proyecto en Java, así un fichero <em>import.sql</em> con la creación de las tablas que la aplicación necesita para funcionar.</p>
</div>
<div class="paragraph">
<p>Se pide:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Compilar y desplegar el proyecto en una instancia local de WildFly. Se ha de crear una base de datos, de nombre <em>InsultApp</em> y acceder a ella mediante un DataSource con el nombre indicado en la unidad de persistencia.</p>
</li>
<li>
<p>Crear un nuevo perfil de Maven en el proyecto para OpenSHift.</p>
</li>
<li>
<p>Crear una nueva aplicación en OpenShift, de nombre <em>InsultApp</em>, integrar el código de InsultApp "local" y hacer los cambios necesarios para desplegar la aplicación en cloud.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Anotad el usuario y password de administración, lo necesitaréis para el último ejercicio.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_monitorización_de_una_aplicación_0_2_puntos">6.6.3. Monitorización de una aplicación (0.2 puntos)</h4>
<div class="paragraph">
<p>Como paso final, queremos añadir las herramientas de monitorización necesarias para asegurarnos de que el servidor de la aplicación InsultApp está funcionando correctamente. Se pide:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Monitorizar la JVM del servidor con JVisualVM</p>
</li>
<li>
<p>Añadir el cartridge Monit a la aplicación.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_entrega_5">6.6.4. Entrega</h4>
<div class="paragraph">
<p>En esta sesión hay que entregar un fichero TXT con el comando solicitado para el primer ejercicio, un breve resumen de los comandos ejecutados para el ejercicio de Monitorización, y una copia de los repositorios de las aplicaciones <em>ejemplo</em> y <em>InsultApp</em></p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion07">7. Características IaaS+ de OpenShift</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introducción">7.1. Introducción</h3>
<div class="paragraph">
<p>En la sesión anterior adquirimos los conocimientos básicos para crear aplicaciones y desplegarlas en cloud de forma análoga a otros proveedores de PaaS. En esta sesión continuaremos aprendiendo características de Openshift que necesitaremos conocer si vamos a trabajar en un proyecto real y se acercan a la forma de trabajo de una plataforma IaaS+.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuración_avanzada">7.2. Configuración avanzada</h3>
<div class="sect3">
<h4 id="_ssh">7.2.1. SSH</h4>
<div class="paragraph">
<p>OpenShift permite el acceso remoto a nuestros gear mediante una sesión SSH del mismo modo que accederíamos a una máquina física. Una vez estamos conectados a un gear podremos modiicar su configuración, ejecutar comandos de administración o consultar los ficheros de log. Desde la sesión remota tenemos un control razonablemente completo de la parte de máquina que se nos asigna, pero sin embargo no podremos realizar cambios que requieran ser administrador.</p>
</div>
<div class="paragraph">
<p>Para poder iniciar una sesión remota tenemos dos posibilidades:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Utilizar un cliente ssh, al que debemos llamar con una dirección específica que podemos obtener de la propia información  de la aplicación, bien desde la consola web, o bien mediante rhc:</p>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas07/ssh1.png" alt="ssh1" width="50%">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Utilizar rhc como intermediario entre el cliente ssh y OpenShift. En este caso basta con ejecutar:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> rhc ssh &lt;app&gt;</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Conexión SSH desde Windows con Putty</div>
Windows no incorpora ningún cliente de ssh de serie así que hay que recurrir a una aplicación externa. Una de las más extendidas es Putty pero para que emplea una codificación distinta para las claves con lo que es necesario convertir la clave privada generada por openshift, del formato OpenSSH al formato propio de Putty. Esto se puede hacer con la herramienta puttygen que incluye. Una vez convertida, hay que especificar la nueva clave privada en la propiedad <em>Auth</em> de la opción ssh. Más información en: <a href="https://developers.openshift.com/en/managing-remote-connection.html" class="bare">https://developers.openshift.com/en/managing-remote-connection.html</a>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_cambios_en_la_configuración_de_la_aplicación">Cambios en la configuración de la aplicación.</h5>
<div class="paragraph">
<p>Una vez iniciemos la sesión en un gear, veremos un mensaje de bienvenida similar a este:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas07/ssh2.png" alt="ssh2">
</div>
</div>
<div class="paragraph">
<p>Desde la sesión podemos utilzar los comandos habituales de Unix y navegar por la estructura de directorios, que ya anticipamos en la sesión anterior:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas06/openshift4.png" alt="openshift4">
</div>
</div>
<div class="paragraph">
<p>Además de estas carpetas, normalmente nos encontraremos una carpeta adicional por cada cartridge instalado, en la cual encontraremos su configuración.  Desde esta sesión podremos modificar ficheros de configuración reiniciar la aplicación, cargar datos en un SGBD, crear scripts o cualquier otra tarea que requiera trabajo "directo" con la máquina. Podemos utilizar la mayoría de los comandos de unix, más una serie de comandos propios de OpenShift:</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 70%;">
<colgroup>
<col style="width: 16%;">
<col style="width: 83%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Comando</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Descripción</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">help</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">muestra un cuadro resumen con los comandos básicos de OpenShift</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">gear</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">permite controlar la aplicación (iniciarla, pararla, reiniciarla, etc.)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tail_all</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">similar al tail de Unix pero vuelca todos los logs de los servicios</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">quota</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">muestra el espacio utilizado y los límites definidos para el gear</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">mysql</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lanza el cliente de MySQL si tenemos desplegado el cartridge</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">psql</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">cliente de PostgreSQL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">mongo</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">cliente de MongoDB</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Como  norma general, modificaremos los ficheros de configuración directamente sobre el gear para realizar pruebas, para realizar cambios "en caliente" sobre la aplicación o bien cuando no exista reflejo de la configuración de un cartridge dentro del repositorio Git de la aplicación. Los cambios de configuración de servidores de aplicaciones habitualmente se harán a través del repositorio Git, mientras que los cambios de configuración de base  de datos se harán directamente sobre el gear, o utilizando el mecanismo de <em>port-forward</em>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Recordad que si hacemos cambios directamente en el gear y posteriormente modificamos la configuración desde el repositorio Git, perderemos los cambios realizados.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_variables_de_entorno">7.2.2. Variables de entorno</h4>
<div class="paragraph">
<p>OpenShift permite configurar gears con los elementos que consideremos necesarios para ejecutar nuestra aplicación. Si utilizamos una base de datos, deberemos acceder a ella a través de un puerto determinado y con unas credenciales autogeneradas. Lo mismo ocurre con un servidor de aplicaciones o cualquier otro cartridge que hayamos instalado. Sería complicado tener que gestionar manualmente toda esta información de configuración desde la aplicación, configuración que probablemente cambie si desplegamos la aplicación en un gear distinto, o tras un mantenimiento realizado por Red Hat.</p>
</div>
<div class="paragraph">
<p>En OpenShift se propone como solución desacoplar esta configuración de las aplicaciones mediante <em>variables de entorno</em>. Si desde una sesión ssh, ejecutamos el comando <em>env</em> podremos ver la lista de variables de entorno <em>predefinidas</em>.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas07/env1.png" alt="env1">
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 38%;">
<col style="width: 38%;">
<col style="width: 23%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Variable Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Example</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Purpose</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OPENSHIFT_APP_DNS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">appname-namespace.rhcloud.com</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The fully-qualified domain name for your application</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OPENSHIFT_APP_NAME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">appname</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Your application’s name</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OPENSHIFT_APP_UUID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0123456789abcdef0 123456789abcdef</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The UUID your application runs as (32 hex characters)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OPENSHIFT__IP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">127.0.250.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The IP address your application will listen on</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OPENSHIFT__PORT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8080</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The port your application will receive requests from</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OPENSHIFT_DATA_DIR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$OPENSHIFT_HOMEDIR/app-root/data/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A persistent directory for your data</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OPENSHIFT__LOG_DIR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$OPENSHIFT_HOMEDIR//logs/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Where your cartridge-specific logs are stored.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OPENSHIFT__DB_LOG_DIR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$OPENSHIFT_HOMEDIR//log/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Where your database-specific logs are stored.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OPENSHIFT_REPO_DIR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$OPENSHIFT_HOMEDIR/app-root/runtime/repo/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Repository containing the currently deployed version (of the application)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OPENSHIFT_TMP_DIR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/tmp/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A temporary directory you can use. Even though the path is just /tmp, the magic of SELinux protects your data from other users</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Adicionalmente cada catridge que instalemos informa un conjunto de variables distinto por lo que es importante consultar la documentación de cada uno de estos componentes para saber como utilizarlos desde las aplicaciones.</p>
</div>
<div class="sect4">
<h5 id="_crear_modificar_variables">Crear/modificar variables</h5>
<div class="paragraph">
<p>El conjunto de variables de entorno predefinidas puede ser ampliado con las variables que consideremos necesario. Para gestionar las variables de entorno tenemos un comando específico <em>rhc env</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="text">$ rhc env set  VARIABLE1=valor1 ... VARIABLEN=valorn -a &lt;app&gt;	// Establecer variables de entorno
$ rhc env list -a &lt;app&gt; // muestra todas las variables de entorno definidas por el usuario
$ rhc env unset VARIABLE1=valor1 ... VARIABLEN=valorn -a &lt;app&gt; // Eliminar variables de usuario
$ rhc env show VARIABLE1... VARIABLEN -a &lt;app&gt; // Mostrar el valor de las variables especificadas.</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
La mayoría de las variables predefinidas están protegidas para preservar la integridad del gear, por tanto si intentamos modificarlas con este comando se nos mostrará un mensaje de error.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_uso_de_markers">7.2.3. Uso de Markers</h4>
<div class="paragraph">
<p>En la primera sesión de WildFly hablamos de unos ficheros llamados markers que se utilizaban para controlar el despliegue manual de las aplicaciones. El contenido de estos ficheros no es lo importante, si no su nombre y su ubicación. En Openshift se utiliza el mismo concepto para cambiar aspectos de la configuración.</p>
</div>
<div class="paragraph">
<p>El procedimiento habitual para crear estos marcadores es crearlos dentro del repositorio Git, y subirlos al servidor mediante <em>push</em>. La ubicación de estos ficheros dentro del repositorio es <em>./openshift/markers</em>.</p>
</div>
<div class="sect4">
<h5 id="_hot_deploy">Hot Deploy</h5>
<div class="paragraph">
<p>Por defecto, tras realizar un push de cambios al repositorio, se reinicia automáticamente el servidor de aplicaciones. Si queremos redesplegar sin reiniciar el servidor, o bien utilizamos un lenguaje interpretado, podemos desactivar el reinicio automático añadiendo el marcador <em>hot_deploy</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> touch .openshift/markers/hot_deploy
<span class="tok-gp">$</span> git add .openshift/markers/hot_deploy
<span class="tok-gp">$</span> git commit -m <span class="tok-s2">&quot;Changing application to hot deploy&quot;</span>
<span class="tok-gp">$</span> git push origin</code></pre>
</div>
</div>
<div class="paragraph">
<p>Cuando hagamos el push del repositorio, se aplicará el cambio en la configuración del servidor.</p>
</div>
</div>
<div class="sect4">
<h5 id="_otros_markers_de_interés">Otros markers de interés</h5>
<table class="tableblock frame-all grid-all" style="width: 90%;">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">disable_auto_scaling</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Desactiva la creación/destrucción de  gears en función de la carga de trabajo</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">force_clean_build</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fuerza a eliminar todos los artefactos previamente construidos</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">skip_maven_build</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Desactiva la compilación Maven al hacer un push al repositorio</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">enable_jpda</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Activa la depuración remota del servidor de aplicaciones</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">java7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fuerza a utilizar el JRE de Java 7 (por defecto Java 6)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">java8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fuerza a utilizar el JRE de Java 8 (por defecto Java 6)</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_action_hook_scripts">7.2.4. Action Hook Scripts</h4>
<div class="paragraph">
<p>Los catridge de Openshift <em>standalone</em>, implementan un ciclo de vida con las fases más importantes entre la compilación de la aplicación y su despliegue, de forma similar a herramientas como Maven. Al igual que maven, también se admite la ejecución de acciones definidas por el desarrollador al pasar por estas fases.</p>
</div>
<div class="paragraph">
<p>Para saber exactamente que fases están definidas es necesario consultar la documentación el cartridge concreto sin embargo son habituales las siguientes fases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Build action hooks: pre_build, build, deploy, post_deploy.</p>
</li>
<li>
<p>Control action hooks: pre_start, post_start, pre_stop, post_stop, pre_reload, post_reload, pre_restart, post_restart, pre_tidy, post_tidy.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Los scripts de control, admiten especificar un cartridge concreto dentro del gear, por si, por ejemplo, queremos realizar acciones específicas en el arranque/parada de una base de datos.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">pre_start_{cartridge}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para codificar acciones asociadas a fases debemos crear un script dentro del repositorio git, en la carpeta <strong>.openshift/action_hooks</strong>. El script debe tener exactamente el mismo nombre de la fase y puede estar escrito en cualquier lenguaje de script que admita Openshift (shellscript, Python, PHP, Ruby&#8230;&#8203;), no estando limitado a los cartrige concretos que hayamos instalado en el gear. Para que se pueda ejecutar el script es necesario darle permisos de ejecución.</p>
</div>
<div class="paragraph">
<p>Como ejemplo, para descargar un fichero tras compilar la aplicación:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Creamos el script <em>.openshift/action_hooks/build</em></p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">#</span>!/bin/bash
<span class="tok-go">curl -o $OPENSHIFT_DATA_DIR/cartel.png http://web.ua.es/es/expertojava/imagenes/cartel300.png</span></code></pre>
</div>
</div>
</li>
<li>
<p>Subimos el script al repositorio</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> git add .openshift
<span class="tok-gp">$</span> git commit -m <span class="tok-s2">&quot;Adding a build hook&quot;</span>
<span class="tok-gp">$</span> git push</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tras hacer el push, la aplicación se reiniciará y ejecutará la descarga del fichero tras completar la compilación.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Cuando hacemos <em>push</em> a un repositorio, se muestra por la salida estándar tanto la subida de código como el posterior reinicio del servidor y despliegue de la aplicación. En definitiva todo el ciclo de construcción se muestra a través del comando <em>git</em>. Los scripts de compilación o control forman parte de este ciclo y salvo que redirijamos su salida a fichero, también aparecerá su salida estándar.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Si trabajamos en Windows, los permisos de ejecución no se trasladan al repositorio remoto al hacer push. Para corregir este problema habría que ejecutar el comando <em>git update-index --chmod=
+x .openshift/action_hooks/*</em> y luego hacer de nuevo push.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_transferencia_de_ficheros">7.2.5. Transferencia de ficheros</h4>
<div class="sect4">
<h5 id="_scp">scp</h5>
<div class="paragraph">
<p>Si desplegamos una aplicación por primera vez, podemos encontrarnos con la necesidad de cargar datos iniciales en la BD o simplemente crear el modelo de datos mediante un script. En el caso de que nuestra aplicación no sea escalable, esto es sencillo con lo que conocemos: Podemos subir el script al repositorio Git, y desde una sesión SSH ejecutarlo localmente. Otra opción sería utilizar el mecanismo de port-forwarding y lanzar el script desde la máquina de desarrollo.</p>
</div>
<div class="paragraph">
<p>Una alternativa es utilizar el comando scp (secure copy)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> scp &lt;origen&gt; &lt;destino&gt;
<span class="tok-gp">$</span> scp miscript.sql 541f1deb500446885d000683@wildfly8-djbyte.rhcloud.com:~/app-root/data</code></pre>
</div>
</div>
<div class="paragraph">
<p>Este comando permite tanto copiar nuevos ficheros al gear, como descargarnos ficheros a local, variando las rutas de origen y destino. La ruta destino la obtenemos de los datos de conexión ssh que muestra la consola, o que se pueden obtener con el comando <em>rhc app show &lt;app&gt;</em>. A esta dirección se le añaden dos puntos y la ruta destino dentro de la máquina remota.</p>
</div>
</div>
<div class="sect4">
<h5 id="_rsync">rsync</h5>
<div class="paragraph">
<p>Es un comando similar a scp pero que permite la sincronización de ficheros entre origen y destino de forma incremental. Esto puede ser de utilidad para ficheros de log o ficheros de tipo backup, y en general para ficheros que cambien con frecuencia pero siempre de forma incremental.</p>
</div>
<div class="paragraph">
<p>La sintaxis básica del comando sería:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> rsync &lt;origen&gt; &lt;destino&gt;
<span class="tok-gp">$</span> rsync -avz -e ssh 542ab14750044656c70000a0@wildfly8-jlzamora.rhcloud.com:~/app-root/data/prueba.png .</code></pre>
</div>
</div>
<div class="paragraph">
<p>Este ejemplo descargaría del gear un fichero a la carpeta actual. Los parámetros -avz se corresponden con archive (preservar atributos de ficheros) verbose (mostrar información detallada del proceso de sincronización) y compress (utilizar compresión en la descarga de diferencias).</p>
</div>
<div class="paragraph">
<p>Si ejecutamos este comando un par de veces y el fichero origen no cambia, veremos como en el segundo caso la información que se transmite se reduce notablemente.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_tareas_planificadas_cron">7.2.6. Tareas planificadas (cron)</h4>
<div class="paragraph">
<p>OpenShift aporta un cartridge específico para la utilidad de linux <em>cron</em> que permite ejecutar tareas planificadas. Para trabajar con tareas planificadas primero debemos añadir este cartridge a la aplicación que deseemos.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> rhc cartridge add cron</code></pre>
</div>
</div>
<div class="paragraph">
<p>La forma de trabajar con cron es parecida a la que hemos visto para los Action Hook scripts. Dentro del repositorio git , en la carpeta <em>.openshift/cron/</em>  nos encontraremos la siguiente estructura de directorios:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">daily</span>
<span class="tok-go">hourly</span>
<span class="tok-go">minutely</span>
<span class="tok-go">monthly</span>
<span class="tok-go">weekly</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cada carpeta se corresponde con una periodicidad de ejecución y podremos añadir los jobs (scripts) que consideremos dentro de ella. A diferencia de los hook scripts, estos pueden tener el nombre que queramos pero si se trata de un shell script se debe indicarlo en la primera línea con la cabecera estándar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">#</span>! /bin/bash</code></pre>
</div>
</div>
<div class="paragraph">
<p>Los ficheros de los jobs también tendrán que tener el atributo de ejecución para que cron los tenga en cuenta.</p>
</div>
<div class="paragraph">
<p>Por último, como sólo trabajamos con periodicidades es posible que para algunos casos resulte limitada. Si necesitamos una planificación más exacta podemos añadir código adicional al script que trabaje con la hora del sistema. Por ejemplo, si este script se ubica en la carpeta minutely, únicamente se ejecutará en el minuto 12 de la hora actual:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">#</span>!/bin/bash

<span class="tok-go">minute=$(date &#39;+%M&#39;)</span>
<span class="tok-go">if [ $minute != 12 ]; then</span>
<span class="tok-go">    exit</span>
<span class="tok-go">fi</span>
<span class="tok-gp">#</span> rest of the script</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_almacenamiento_en_disco">7.3. Almacenamiento en disco</h3>
<div class="paragraph">
<p>A efectos del desarrollador, el disco del gear no difiere demasiado de una instalación local de linux en la que usamos un usuario sin permisos de administración. De toda la estructura de directorios únicamente vamos a tener permisos de escritura en dos sitios:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>La carpeta del gear (OPENSHIFT_HOMEDIR).</p>
</li>
<li>
<p>La carpeta temporal <em>/tmp</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La carpeta temporal, a diferencia de una máquina línux física es una carpeta es una carpeta propia de cada usuario, es decir que no hay peligro de que otros usuarios que ejecuten sus aplicaciones en la misma máquina que nosotros, tengan acceso a ficheros generados por nosotros. Esta carpeta sólo se puede utilizar en momento puntuales y sabiendo de que no hay garantías que lo que allí almacenemos se vaya a conservar. De hecho, esta carpeta se inicializa en cada reinicio del gear.</p>
</div>
<div class="paragraph">
<p>Otra ubicación importante es la carpeta de datos de OpenShift, asociada a la variable de entorno OPENSHIFT_DATA_DIR  ($OPENSHIFT_HOMEDIR/app-root/data) donde si podremos guardar nuestros datos o configuración con garantias de perdurabilidad.</p>
</div>
<div class="paragraph">
<p>La carpeta git es un caso especial, si bien se podría escribir dentro de ella, todo lo que copiemos se perderá en el siguiente <em>push</em> al repositorio que hagamos.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Una limitación que presenta OpenShift es que el directorio de datos es propio de cada gear y no se comparte entre los distintos gears que pueden estar ejecutando una aplicación escalable. Tampoco existe un mecanismo definido para sincronizar estos directorios de forma automática, por lo que el método recomendado para compartir información entre los gears es almacenarla en base de datos, o bien recurrir a un proveedor externo de almacenamiento, como por ejemplo Amazon S3.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En función del tipo de gear nos vamos a encontrar con una limitación de espacio  de 1Gb de espacio o 6Gb.  Básicamente se tiene en cuenta:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>El directorio /data del gear.</p>
</li>
<li>
<p>La carpeta temporal <em>/tmp</em>.</p>
</li>
<li>
<p>El repositorio Git.</p>
</li>
<li>
<p>Los ficheros de log de las aplicaciones y servidores.</p>
</li>
<li>
<p>Los ficheros de datos de las bases de datos.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Si nos quedamos sin espacio en un gear, todos los servicios comenzarán a fallar, así que es importante tener siempre controlado el espacio disponible. Ya sabemos una forma de obtener el espacio utilizado, y es mediante el comando quota desde una sesión SSH. Rhc nos ofrece un comando que nos dará una visión más global, mostrando el espacio utilizado y la quota para cada uno de los gears sobre los que se ejecuta nuestra aplicación:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">rhc app show &lt;app&gt; --gears quota</span></code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas07/quota1.png" alt="quota1">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Cuando se alcance un 90% de ocupación de disco, Openshift comenzará a mostrarnos avisos tanto al iniciar una sesión SSH como al hacer un <em>push</em> al repositorio Git.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">remote: error: unable to create temporary file: Disk quota exceeded</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_si_ya_nos_hemos_quedado_sin_espacio">7.3.1. Si ya nos hemos quedado sin espacio.</h4>
<div class="paragraph">
<p>Si hemos alcanzado el límite de espacio en un gear podemos resolver el problema de varias formas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Comando tidy de rhc, que elimina los ficheros de log, borra temporales y reorganiza el repositorio git.</p>
</li>
<li>
<p>Si estamos en un plan de pago podemos ampliar el espacio en disco con el siguiente comando:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> rhc cartridge storage &lt;cartridge&gt; -a &lt;app&gt; --set  capacidad<span class="tok-o">(</span>GB<span class="tok-o">)</span>

<span class="tok-gp">$</span> rhc cartridge storage php-5 -a racer --set 5gb</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Todos los gear comienzan con un 1Gb de datos y se pueden ampliar hasta un máximo de 30Gb
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_copias_de_seguridad">7.4. Copias de seguridad</h3>
<div class="paragraph">
<p>Con lo aprendido hasta ahora, es perfectamente posible definir un proceso que de forma periódica, realice una copia de seguridad de los datos de nuestra aplicación. Deberíamos crear un job que se ejecute con la periodicidad que creamos conveniente y que ejecute las siguientes tareas:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Detener la aplicación</p>
</li>
<li>
<p>Exportar los datos de la BD a fichero.</p>
</li>
<li>
<p>Comprimir y transferir la información de BD a otra ubicación (recomendable por seguridad y porque el espacio en el gear es limitado).</p>
<div class="paragraph">
<p>Como ejemplo, se podría subir la información a DropBox o cualquier otro almacenamiento en Cloud. En este enlace se muestra un ejemplo: <a href="https://github.com/andreafabrizi/Dropbox-Uploader" class="bare">https://github.com/andreafabrizi/Dropbox-Uploader</a></p>
</div>
</li>
<li>
<p>Comprimir y transferir la información de los log de aplicación.</p>
</li>
<li>
<p>Limpiar manualmente temporales y logs (desde la sesión ssh no está disponible el comando tidy).</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Ejecutar <em>git gc</em> en la carpeta del repositorio Git <em>.git/&lt;app&gt;</em>/tmp_</p>
</li>
<li>
<p>Eliminar temporales en /tmp, OPENSHIFT_LOG_DIR y  OPENSHIFT_TMP_DIR</p>
<div class="paragraph">
<p>A continuación veremos las herramientas de backup que ofrece OpenShift.</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Iniciar de nuevo la aplicación.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_deployment_history">7.4.1. Deployment History</h4>
<div class="paragraph">
<p>En ocasiones, al desplegar una nueva versión de nuestra aplicación nos podemos encontrar con que no está funcionando como debería. El estudiar qué ha ocurrido, subir código nuevo al repositorio Git y despliegar puede resultar demasiado lento y mientras tanto la aplicación no está dando servicio o puede estar funcionando de forma incorrecta.</p>
</div>
<div class="paragraph">
<p>Por defecto no está activado pero OpenShift pede mantener un histórico de despliegues  y darnos el mecanismo para desplegar una versión previa a la problemática. Para activar este mecanismo de histórico de despligues hay que ejecutar el siguiente comando:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">rhc app-configure --keep-deployments &lt;num&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La información se almacenará en el gear, en la carpeta app-deployments clasificada por timestamp y por "id" de despliegue:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">[wildfly8-jlzamora.rhcloud.com app-deployments]\&gt; ls</span>
<span class="tok-go">2014-10-03_11-32-48.438  2014-10-03_11-51-38.310  by-id  current</span>
<span class="tok-go">[wildfly8-jlzamora.rhcloud.com app-deployments]\&gt; ls by-id</span>
<span class="tok-go">88410fa9  b901caed</span>
<span class="tok-go">[wildfly8-jlzamora.rhcloud.com app-deployments]\&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Desde la máquina de desarrollo podemos listar las versiones almacenadas con el comando <em>deployment list</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">#</span> rhc deployment list &lt;app&gt;

<span class="tok-gp">$</span> rhc deployment list wildfly8

<span class="tok-go">5:33 PM, deployment b901caed</span>
<span class="tok-go">5:52 PM, deployment 88410fa9</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cuando tengamos claro qué versión de la aplicación queremos desplegar, la seleccionaremos con el comando <em>deployment activate</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">#</span> rhc deployment activate &lt;id despliegue&gt; -app &lt;app&gt;
<span class="tok-gp">$</span> rhc deployment activate b901caed -app wildfly8

<span class="tok-go">Activating deployment &#39;b901caed&#39; on application wildfly8 ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Uno de los pros de esta funcionalidad es que de forma rápida podemos revertir el estado de nuestra aplicación a un punto anterior. La principal limitación es que sólo afecta al código de aplicación y sus dependencias, no incluye la configuración del servidor de aplicaciones, la definición de la base de datos ni su contenido.</p>
</div>
</div>
<div class="sect3">
<h4 id="_application_snapshots">7.4.2. Application Snapshots</h4>
<div class="paragraph">
<p>Las snapshots son copias de seguridad de la aplicación al completo, código, base de datos y cualquier información que en los catridge instalados se haya catalogado como exportable. El resultado es un fichero tar.gz con toda la información, que puede ser utilizado para restaurar la aplicación en otro momento.</p>
</div>
<div class="paragraph">
<p>Tanto la creación del snapshot como la restauración son procesos que necesariamente requieren parar la aplicación temporalmente por lo que hay que escoger el momento adecuado para este tipo de backup.</p>
</div>
<div class="paragraph">
<p>El comando para generar un snapshot es el siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">&amp; rhc snapshot-save &lt;app&gt;</span>
<span class="tok-go">Pulling down a snapshot of application &#39;wildfly8&#39; to wildfly8.tar.gz ... done</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Los snapshot se almacenan en la máquina de desarrollo y salvo que especifiquemos otro nombre para el fichero, se sigue la nomenclatura &lt;app&gt;.tar.gz y se sobreescribe en sucesivas ejecuciones.</p>
</div>
<div class="paragraph">
<p>Si queremos restaurar, el comando a utilizar es snapshot-restore</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">&amp; rhc snapshot-restore &lt;app&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_procedimientos">7.5. Procedimientos</h3>
<div class="sect3">
<h4 id="_depuración_de_aplicaciones">7.5.1. Depuración de aplicaciones</h4>
<div class="paragraph">
<p>En casos excepcionales es posible iniciar un proceso de depuración en remoto de una aplicación desplegada en OpenShift para ello tenemos que realizar los siguientes cambios:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Añadir el marker <em>enable_jpda</em> a la aplicación que queremos depurar. Salvo que tengamos habilitado el <em>hot deploy</em> el servidor se reiniciará y arrancará en modo depuración.</p>
</li>
<li>
<p>Ejecutar el comando <em>port-forward</em> de <em>rhc</em>. Deberá mostrarse una redirección del puerto remoto 8787 a nuestra máquina.</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas07/debug1.png" alt="debug1">
</div>
</div>
</li>
<li>
<p>Abrir el proyecto maven de la aplicación en IntelliJ.</p>
</li>
<li>
<p>Crear una nueva configuración de depuración en IntelliJ en modo remoto.</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas07/debug2.png" alt="debug2">
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Es importante seleccionar como sistema de transporte el tipo <em>Socket</em> y el puerto local al que se redirige el puerto remoto de depuración. También se indica en el último desplegable dónde localizar el código fuente del proyecto que se va a depurar.</p>
</div>
<div class="paragraph">
<p>Si ejecutamos la configuración de depuración, nos conectaremos directamente al proceso remoto en modo debug, y podremos depurar la aplicación como si se ejecutase localmente, aunque el precio a pagar es que la depuración se ejecutará con mucha mayor lentitud.</p>
</div>
</div>
<div class="sect3">
<h4 id="_generar_un_threaddump">7.5.2. Generar un threaddump</h4>
<div class="paragraph">
<p>Un threaddump o volcado de hilos es un procedimiento que permite recoger en un fichero, el estado de todos los hilos en ejecución de una aplicación, y si están en ejecución, el código que se está ejecutando. Obtener varios threaddump en un intervalo de tiempo puede darnos información útil para identificar problemas de bloqueos o lentitud de procesamiento.</p>
</div>
<div class="paragraph">
<p>La forma de obtener este volcado es mediante un comando de rhc:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> rhc threaddump -a &lt;app&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
El catridge de Wildfly a fecha de estos apuntes no está redirigiendo correctamente la salida del threaddump al fichero temporal que espera el comando threaddump. En su lugar, hay que consultar el server.log directamente, o mediante el comando <em>tail</em> de rhc.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_despliegue_manual_de_las_aplicaciones">7.5.3. Despliegue manual de las aplicaciones</h4>
<div class="paragraph">
<p>Aunque bien podría haberse implementado como markers, hay parte de la configuración de una aplicación que se resuelve mediante el comando <em>rhc app-configure</em>. Si lo ejecutamos sin parámetros nos mostrará la configuración actual de la aplicación:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">wildfly8 @ http://wildfly8-jlzamora.rhcloud.com/ (uuid: 542ab14750044656c70000a0)</span>
<span class="tok-go">---------------------------------------------------------------------------------</span>
<span class="tok-go">  Deployment:        auto (on git push)</span>
<span class="tok-go">  Keep Deployments:  1</span>
<span class="tok-go">  Deployment Type:   git</span>
<span class="tok-go">  Deployment Branch: master</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pero también admite los siguientes parámetros:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go"> $ rhc app-configure &lt;app&gt;  [parámetros...]</span></code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">--[no-]auto-deploy</dt>
<dd>
<p>Activar/desactivar la compilación y despliegue automático ante un push al respositorio. Por defecto TRUE</p>
</dd>
<dt class="hdlist1">--keep-deployments INTEGER </dt>
<dd>
<p>Controla la profundidad del histórico de despliegues de una aplicación. Por defecto 1.</p>
</dd>
<dt class="hdlist1">--deployment-branch BRANCH</dt>
<dd>
<p>Permite especificar la rama del repositorio git desde el cual queremos compilar y desplegar la aplicación. Por defecto master.</p>
</dd>
<dt class="hdlist1">--deployment-type git|binary </dt>
<dd>
<p>Permite especificar si queremos desplegar un binario o una aplicación compilada a partir del repositorio Git. Por defecto git.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Si desactivamamos la función de <em>auto-deploy</em> podemos desacoplar la subida de cambios al repositorio del despliegue y gestionar los despliegues de forma manual, mediante el comando <em>app-deploy</em></p>
</div>
<div class="literalblock">
<div class="content">
<pre>[source,console]
----
$ rhc app-deploy &lt;ref&gt; --app &lt;app&gt;
----</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Donde ref es una etiqueta, rama o commit específico del repositorio Git (por defecto utilizad master)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Admite los siguientes parámetros que se *superponen* a la configuración especificada vía markers:</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">--[no-]hot-deploy</dt>
<dd>
<p>Desplegar (o no ) sin reiniciar el servidor.</p>
</dd>
<dt class="hdlist1">--[no-]force-clean-build</dt>
<dd>
<p>Recompila todo sl proyecto (o no) antes de desplegar, eliminando cualquier artefacto temporal previamente generado.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_compilación_de_proyectos_con_dependencias_propias">7.5.4. Compilación de proyectos con dependencias propias</h4>
<div class="paragraph">
<p>En algunos proyectos es necesario referenciar a módulos precompilados de los cuales no tenemos el código fuente o no queremos incluirlo en el repositorio de nuestra aplicación. Estos módulos tampoco están disponibles en ningún repositorio público y si disponemos de un repositorio privado, es muy probable que no lo tengamos configurado para ser accesible desde internet. La solución a este problema pasaría por incorporar el artefacto al repositorio maven local mediante una acción personalizada previa a la compilación. Los pasos a realizar serían los siguientes:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Añadir el jar/war a la raíz del repositorio git.</p>
</li>
<li>
<p>Crear un script asociado a la fase <em>prebuild</em> que ejecute un "maven install":</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">#</span>Ejemplo para ficheros jar

<span class="tok-go">mvn install:install-file -Dfile=$OPENSHIFT_REPO_DIR/fichero.jar -DgroupId=&lt;grupo&gt;-DartifactId=&lt;artefacto&gt; -Dversion=&lt;versión&gt; -Dpackaging=jar</span></code></pre>
</div>
</div>
</li>
<li>
<p>Referenciar la dependencia en el pom de la aplicación como una dependencia normal, el scope debe ser <em>compile</em> para que se incluya en el empaquetado finall de la aplicación.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_despliegue_de_aplicaciones_compiladas_previamente">7.5.5. Despliegue de aplicaciones compiladas previamente.</h4>
<div class="paragraph">
<p>Como ya sabemos, la forma normal de desplegar aplicaciones en OpenShift pasa por subir código fuente a un repositorio Git interno a OpenShift, pero también se da soporte al despliegue de aplicaciones previamente compiladas aunque para ello hay que realizar una serie de cambios en el repositorio. Los pasos son los siguientes:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crear una nueva aplicación y clonar su repositorio en nuestra máquina.</p>
</li>
<li>
<p>Dentro del repositorio, eliminar el código fuente completamente, con el comando:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">&amp; git rm -r src/ pom.xml</span></code></pre>
</div>
</div>
</li>
<li>
<p>Copiar el war/ear a la carpeta deployments y hacer <em>commit</em> y <em>push</em>.</p>
</li>
<li>
<p>Limpiar el repositorio git y logs con el comando <em>rhc app tidy</em></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Tal y como comentamos en la sesión anterior si el war tiene como nombre ROOT, la URL de acceso será la URL indicada para nuestra aplicación. Si por el contrario tiene otro nombre, la aplicación se encontrará en la URL inicial más el nombre de la aplicación como contexto raiz.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_referencias_7">7.6. Referencias</h3>
<div class="ulist">
<ul>
<li>
<p>WildFly Cartridge <a href="https://developers.openshift.com/en/wildfly-overview.html" class="bare">https://developers.openshift.com/en/wildfly-overview.html</a></p>
</li>
<li>
<p>Variables de entorno <a href="https://developers.openshift.com/en/managing-environment-variables.html" class="bare">https://developers.openshift.com/en/managing-environment-variables.html</a></p>
</li>
<li>
<p>Depuración en remoto <a href="http://planet.jboss.org/post/debugging_and_browsing_openshift_applications_in_eclipse" class="bare">http://planet.jboss.org/post/debugging_and_browsing_openshift_applications_in_eclipse</a></p>
</li>
<li>
<p>Action hooks	<a href="http://openshift.github.io/documentation/oo_user_guide.html#action-hooks" class="bare">http://openshift.github.io/documentation/oo_user_guide.html#action-hooks</a></p>
</li>
<li>
<p>Openshift v3 <a href="https://www.openshift.com/blogs/openshift-v3-platform-combines-docker-kubernetes-atomic-and-more" class="bare">https://www.openshift.com/blogs/openshift-v3-platform-combines-docker-kubernetes-atomic-and-more</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios_de_características_iaas_de_openshift">7.7. Ejercicios de Características IaaS+ de OpenShift</h3>
<div class="paragraph">
<p>Vamos a realizar una serie de ejercicios en torno a un aplicación que podrían acercarnos a una situación real en la que se desarrolla y despliega una aplicación en una plataforma cloud. En primer lugar vamos a crear la aplicación desde cero apoyándonos en una herramienta de generación de código, de nombre <em>JBoss Forge</em>.</p>
</div>
<div class="paragraph">
<p>Forge funciona como un shell con comandos especializados en la generación de código según las funcionalidades que nuestra aplicación va a necesitar. Por ejemplo, si vamos a trabajar con acceso a base de datos JPA sólo tenemos que declararlo y definir posteriormente nuestras entidades.</p>
</div>
<div class="sect3">
<h4 id="_instalación_de_forge">7.7.1. Instalación de Forge</h4>
<div class="paragraph">
<p>Para instalar la última versión basta con ejecutar el siguiente comando:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">curl http://forge.jboss.org/sh | sh</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Con este procedimiento se descarga siempre la última versión disponible, que a la fecha de redacción de estos apuntes es la 3.0 Alpha. En la carpeta de ejercicios de la sesión07 tenéis un script alternativo <em>forge.sh</em> que descarga la última versión estable, y es la que se debe utilizar.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Una vez instalado, basta con ejecutar forge para iniciar la herramienta:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas07/ejer1.png" alt="ejer1">
</div>
</div>
<div class="paragraph">
<p>De forma similar a la herramienta CLI de WildFly, podemos movernos por la estructura del proyecto mediante el comando <em>cd</em> y podemos visualizar ficheros o ejecutar acciones sobre ellos.</p>
</div>
<div class="paragraph">
<p>Dado que acabamos de instalar la aplicación, añadiremos un par de plugins mediante los comandos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">addon-install-from-git --url https://github.com/forge/addon-arquillian.git --coordinate org.arquillian.forge:arquillian-addon</span>

<span class="tok-go">addon-install-from-git --url https://github.com/forge/angularjs-addon.git --coordinate org.jboss.forge.addon:angularjs</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_autoescuela">7.7.2. Autoescuela</h4>
<div class="paragraph">
<p>Utilizando Forge, vamos a crear una aplicación sencilla de para la gestión de  las clases práctricas de una autoescuela (muy simplificada). Definiremos tres entidades distintas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Alumno</p>
</li>
<li>
<p>Profesor. Un profesor puede dar clase a varios alumnos, mientras que un alumno únicamente recibe clase de un profesor.</p>
</li>
<li>
<p>Vehículo. En este caso un profesor puede utilizar varios vehículos y un vehículo puede ser utilizado por varios profesores, en distintas clases de prácticas.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Mediante Forge vamos a crear nuestra aplicación para gestionar  las prácticas. Ejecutaremos los siguientes comandos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">project-new  --named autoescuela --topLevelPackage org.expertojava.paas</span>

<span class="tok-go">jpa-setup</span>
<span class="tok-go">servlet-setup</span>
<span class="tok-go">cdi-setup</span>
<span class="tok-go">rest-setup</span>
<span class="tok-go">scaffold-setup</span>
<span class="tok-go">constraint-setup</span>

<span class="tok-go">jpa-new-entity --named Alumno</span>
<span class="tok-go">jpa-new-entity --named Profesor</span>
<span class="tok-go">jpa-new-entity --named Vehiculo</span>

<span class="tok-go">jpa-new-field  --named modelo --type String --length 100</span>
<span class="tok-go">jpa-new-field  --named matricula --type String --length 7</span>
<span class="tok-go">constraint-add --onProperty modelo --constraint NotNull</span>
<span class="tok-go">constraint-add --onProperty matricula --constraint NotNull</span>
<span class="tok-go">constraint-add --onProperty matricula --constraint Size --max 7</span>

<span class="tok-go">cd ..</span>
<span class="tok-go">cd Profesor.java</span>
<span class="tok-go">jpa-new-field  --named nombre --type String --length 100</span>
<span class="tok-go">jpa-new-field  --named vehiculos --type org.expertojava.paas.model.Vehiculo --relationshipType Many-to-Many;</span>
<span class="tok-go">jpa-new-field --named alumnos --type org.expertojava.paas.model.Alumno --relationshipType One-to-Many;</span>
<span class="tok-go">constraint-add --onProperty nombre --constraint NotNull</span>

<span class="tok-go">cd ..</span>
<span class="tok-go">cd Alumno.java</span>

<span class="tok-go">jpa-new-field  --named nombre --type String --length 100</span>
<span class="tok-go">jpa-new-field  --named direccion --type String --length 300</span>
<span class="tok-go">jpa-new-field  --named telefono --type String --length 9</span>
<span class="tok-go">constraint-add --onProperty nombre --constraint NotNull</span>
<span class="tok-go">constraint-add --onProperty telefono --constraint Size --max 9</span>

<span class="tok-go">scaffold-generate  --provider Faces --overwrite --targets org.expertojava.paas.model.*</span>
<span class="tok-go">rest-generate-endpoints-from-entities --targets org.expertojava.paas.model.*</span>

<span class="tok-go">build</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Con estas instrucciones habremos creado un nuevo proyecto <em>autoescuela</em>, definido las entidades que intervienen con sus atributos y generado tanto un API REST para su mantenimiento como las páginas JSF necesarias para implementar un CRUD de los datos. Por defecto esta aplicación utilizará el Datasource <em>java:jboss/datasources/ExampleDS</em> que viene definido por defecto en WildFly y que trabaja con una base de datos en memoria, H2.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Por defecto genera un ID automático para todas las entidades. Para hacerlo transparente, la herramienta de scaffolding de JSF oculta automáticamente los campos que llevan la anotacion de Generated. Además de generar una interfaz en JSF, también es posible generar el Scaffolding AngularJS.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Forge no es una herramienta "neutra" en el sentido de que el proyecto Maven resultante tiene dependencias específicas de JBoss. Podéis sustituirlas por la especificación Java EE 7.0 como se explicaba en las primeras sesiones. Todos los servidores de aplicaciones tienen integrada una base de datos y un datasource por defecto. Podéis eliminar directamente la etiqueta &lt;jta-data-source&gt; de la unidad de persistencia para utilizarlo.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_despliegue_básico_de_la_aplicación_0_2_punto">7.7.3. Despliegue básico de la aplicación (0.2 punto)</h4>
<div class="paragraph">
<p>Se pide:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Desplegar la aplicación en el servidor WildFly local de vuestra máquina virtual.</p>
</li>
<li>
<p>Añadir el perfil correspondiente para openshift y desplegarla en una aplicación OpenShift, de nombre , <em>autoescuela</em>.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_configuración_de_la_aplicación_openshift_0_6_puntos">7.7.4. Configuración de la aplicación OpenShift (0.6 puntos)</h4>
<div class="paragraph">
<p>En este ejercicio debéis ajustar la configuración de la aplicación en OpenShift a unos requerimientos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Queremos poder aplicar cambios en el menor tiempo posible, esto es evitar reiniciar WildFly en cada cambio que hagamos en la aplicación.</p>
</li>
<li>
<p>Por seguridad queremos mantener hasta 3 versiones de la aplicación por si en alguna modificación nos hemos equivocado y queremos deshacer los cambios.</p>
</li>
<li>
<p>Sustituir la BD utilizada por defecto H2, por una base de datos PostgreSQL. Debéis crear un Datasource llamado <em>autoLocal</em> que acceda a la base de datos y configurar la unidad de persistencia para que lo utilice.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Para acceder a PostgreSQL hay que modificar la configuración de la unidad de persistencia:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"> <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.dialect&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;org.hibernate.dialect.PostgreSQLDialect&quot;</span><span class="tok-nt">/&gt;</span>
  <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.hbm2ddl.auto&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;update&quot;</span><span class="tok-nt">/&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Configurar un sistema de copias de seguridad, queremos que de forma diaria a las 01:00 AM se haga un backup del contenido de la base de datos.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>El script para esta tarea podría ser el siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">#</span>!/bin/bash
<span class="tok-go">if [ `date +%H:%M` == &quot;18:57&quot; ]</span>
<span class="tok-go">then</span>
<span class="tok-go">        DATE=`date +&quot;%Y-%m-%d&quot;`</span>
<span class="tok-go">        FILE=&quot;$OPENSHIFT_APP_NAME-$DATE.sql.gz&quot;</span>
<span class="tok-go">        INIT_PATH=$OPENSHIFT_DATA_DIR/$FILE</span>
<span class="tok-go">        BACKUP_DIR=$OPENSHIFT_DATA_DIR/sqlbackup</span>
<span class="tok-go">        if [ ! -d &quot;$BACKUP_DIR&quot; ]; then</span>
<span class="tok-go">         mkdir $BACKUP_DIR</span>
<span class="tok-go">        fi</span>
<span class="tok-go">        pg_dump $OPENSHIFT_APP_NAME | gzip &gt; $INIT_PATH</span>
<span class="tok-go">        mv $INIT_PATH $BACKUP_DIR/$FILE</span>
<span class="tok-go">fi</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Por ultimo, queremos mantener una copia sincronizada de los backups que hay en OpenShift con lo que debéis definir una instrucción que permita traerse los cambios que se detecten sobre la carpeta sqlbackup. Incluidla en un fichero llamado <em>soluciones.txt</em>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_uso_de_una_base_de_datos_externa_en_cloud_0_4_puntos">7.7.5. Uso de una base de datos externa en Cloud (0.4 puntos)</h4>
<div class="paragraph">
<p>Por último, vamos a probar a sustituir la base de datos PostgreSQL integrada en el Gear por una base de datos externa proporcionadad por otro proveedor. Para ello, debéis acceder al MarketPlace de OpenShift y crear una cuenta en ElephantSQL. El acceso gratuito proporciona una base de datos de 20Mb con hasta 7 conexiones concurrentes. Debéis crear un nuevo datasource en WildFly, de nombre <em>autoRemoto</em>, que apunte a esta base de datos.</p>
</div>
<div class="paragraph">
<p>Cuando os déis de alta en ElephantSQL, veréis que el proveedor os facilita una conexión con el siguiente formato:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">postgres://sbdivvym:DBRXn9a3ewb8evi4qaFcRy5y_LpF9olh@babar.elephantsql.com:5432/sbdivvym</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si utilizásemos el cliente de PostgreSQL podríamos utilizar esta cadena de conexión tal cual está definida. Sin embargo para crear un Datasource debemos descomponerla en sus partes básicas:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">postgres://[usuario]:[password]@[hostname:[puerto]/[instancia BD]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por último y muy importante, la configuración del datasource la tenéis que hacer utilizando variables de entorno. Es decir, la configuración del datasource no estará definida directamente en WildFly sino que referenciará a variables que vais a tener que definir. Como sugerencias de nombres:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">ELEPHANTSQL_USER</span>
<span class="tok-go">ELEPHANTSQL_PASSWORD</span>
<span class="tok-go">ELEPHANTSQL_HOSTNAME</span>
<span class="tok-go">ELEPHANTSQL_PORT</span>
<span class="tok-go">ELEPHANTSQL_DBINSTANCE</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_entrega_6">7.7.6. Entrega</h4>
<div class="paragraph">
<p>En esta sesión hay que presentar una copia del repositorio <em>autoescuela</em> eliminando la configuración de git como ya hemos hecho en sesiones anteriores y un fichero llamado <em>soluciones.txt</em> con el comando de descarga solicitado en el segundo ejercicio.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sesion08">8. Integración continua y escalabilidad</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_escalabilidad">8.1. Escalabilidad</h3>
<div class="paragraph">
<p>Ya sabemos que OpenShift nos permite trabajar con diferentes tipos de gear con diferentes tamaños de memoría, y recientemente capacidad de proceso (small high cpu),  pero la forma natural de aumentar la capacidad de proceso de las aplicaciones en PaaS y en OpenShift es el llamado escalado horizontal, o lo que es lo mismo, que nuestra aplicación se ejecute en múltiples servidores simultáneamente.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas07/scale1.png" alt="scale1" width="50%">
</div>
<div class="title">Figure 2. Escalabilidad vertical contra escalabilidad horizontal</div>
</div>
<div class="sect3">
<h4 id="_autoescalado_en_openshift">8.1.1. Autoescalado en OpenShift</h4>
<div class="paragraph">
<p>Primero de todo aclarar que el que una aplicación sea escalable no implica que el autoescalado esté activado pero es que Openshift, por defecto gestiona automáticamente la escalabilidad de las aplicaciones, y lo hace de la siguiente forma:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Introduce un elemento en el gear de la aplicación denominado HAProxy y su función es la de balanceador de carga por software. Este componente analiza el tráfico web entrante y lo reenvía al gear de la aplicación.</p>
</li>
<li>
<p>Por defecto OpenShift asigna un máximo de 16 conexiones por gear. Cuando HAProxy detecta que se alcanza un 90% de ocupación de estas conexiones de forma sostenida,  dispara un evento para la creación de forma automática de un nuevo gear que pueda ayudar a tratar la carga de trabajo creciente.</p>
</li>
<li>
<p>Mediante la herramienta <em>rsync</em>, OpenShift copia la configuración, el código y los ficheros empaquetados de la aplicación a un nuevo gear y arranca una nueva instancia del servidor de aplicaciones.</p>
</li>
<li>
<p>Si HAProxy detecta una bajada del número de conexiones por debajo del 50% del maximo, durante un tiempo predefinido,  desencadena la eliminación de los gear replicados hasta que se alcance una situación estable o bien se alcance el mínimo de gears activos configurados.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas07/scale4.png" alt="scale4" width="50%">
</div>
<div class="title">Figure 3. Aplicación escalable</div>
</div>
<div class="paragraph">
<p>Como vemos en la imagen, las aplicaciones escalables situan el backend en un gear independiente a las aplicaciones, en contraposición con las aplicaciones que hemos visto hasta ahora, en las que middleware y backend comparten gear. Esto es necesario para que todos los gear replicados puedan acceder a la base de datos concurrentemente.  OpenShift elige la ubicación de la base de datos de forma automática, en función del tipo de aplicación.</p>
</div>
<div class="paragraph">
<p>HAProxy por defecto utiliza el algoritmo <em>leastconn</em> para repartir las conexiones entre los gear activos, y su forma de trabajar es asignar una nueva conexión al gear que tenga menos conexiones activas en ese momento. Este comportamiento se puede modificar, como veremos más adelante.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">¿Y si hago cambios en el código de una aplicación escalable?</div>
si hacemos un cambio en el código de una aplicación y lo subimos con un comando <em>push</em> de git, iniciaremos la compilación de la aplicación en el gear primario, y una vez compilada que se sincronicen los cambios entre todos los gears activos con el comando <em>rsync</em>.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_motivos_para_definir_las_aplicaciones_como_escalables_por_defecto">Motivos para definir las aplicaciones como escalables por defecto</h5>
<div class="ulist">
<ul>
<li>
<p>Mayor rendimiento al tener cada servidor y cada BD en un gear dedicado.</p>
</li>
<li>
<p>Aunque a priori no sea necesario, el configurar una aplicación como escalable permite que llegado el momento se pueda incrementar la capacidad de proceso.</p>
</li>
<li>
<p>Permite autoescalado y escalado manual, en el caso de que sepamos que va a producirse un aumento importante de la carga de trabajo.</p>
</li>
<li>
<p><strong>No</strong> existe un comando que convierta una aplicación no escalable en escalable. Sólo se puede configurar como escalable en el momento de crear la aplicación.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_otras_ventajas">Otras ventajas</h5>
<div class="ulist">
<ul>
<li>
<p>Alta disponibilidad. Si una instancia de servidor falla, HAProxy repartirá la carga de trabajo entre el resto de instancias que estén operativas. No está documentado que haya ningún proceso automático que reinicie las instancias en caso de caída.</p>
</li>
<li>
<p>Replicación de la sesión: Si trabajamos con JBoss/Wildfly podemos beneficiarnos de la replica de la información de sesión entre los gears de la aplicación. Esto permite que si un servidor cae, la información de sesión se pueda recuperar de otra instancia. Para ello se utiliza una mecanismo de caché distribuida llamado Infinispan. Para habilitar este mecanismo hay que hacer un pequeño cambio en el fichero web.xml de las aplicaciones:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;web-app&gt;</span>
   <span class="tok-nt">&lt;distributable/&gt;</span>
<span class="tok-nt">&lt;/web-app&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>El uso de una caché distribuida permite compartir información entre nodos leyendo y escribiendo elementos con los métodos <em>put/get</em>.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nd">@Resource</span><span class="tok-o">(</span><span class="tok-n">lookup</span><span class="tok-o">=</span><span class="tok-s">&quot;java:jboss/infinispan/container/cluster&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">private</span> <span class="tok-n">CacheContainer</span> <span class="tok-n">container</span><span class="tok-o">;</span>

<span class="tok-c1">// A partir de este punto se pueden utilizar los métodos get() y put() para acceder y almacenar elementos en la caché.</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_definir_una_aplicación_como_escalable">8.1.2. Definir una aplicación como escalable</h4>
<div class="paragraph">
<p>Como ya hemos comentado, sólo es posible configurar una aplicación como escalable en el momento de su creación. Como siempre, tenemos dos opciones:</p>
</div>
<div class="paragraph">
<p>Desde la consola web:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas07/scale5.png" alt="scale5">
</div>
</div>
<div class="paragraph">
<p>Desde un terminal con la herramienta rhc:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">rhc rhc app create &lt;app&gt; &lt;cartridges&gt;... -s</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ajustar_la_configuración_de_escalado">8.1.3. Ajustar la configuración de escalado</h4>
<div class="paragraph">
<p>Por defecto las aplicaciones utilizan un gear para la aplicación, más otro adicional si existe una base de datos. Para ajustar el número máximo y mínimo de gears debemos entrar en la configuración de nuestra aplicación y hacer click sobre los valores del apartado scales:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas07/scale6.png" alt="scale6">
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas07/scale3.png" alt="scale3">
</div>
</div>
<div class="paragraph">
<p>Alternativamente podemos utilizar el comando rhc donde habrá que especificar el cartridge concreto a escalar, la aplicación y el rango de valores.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">rhc cartridge-scale &lt;cartridge a configurar&gt; -a &lt;your app&gt; --min &lt;minimum&gt; --max &lt;maximum&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Si especificamos como máximo -1, estamos indicando que nuestro máximo será el número máximo de gears que nos permita nuestra cuenta.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Una vez creada y en ejecución podemos ajustar manualmente el número de gears con los comandos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">rhc app scale-up &lt;app&gt;</span>
<span class="tok-go">rhc app scale-down &lt;app&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por último, si queremos desactivar el autoescalado, y que seamos nosotros los únicos que gestionemos el número de gears debemos hacerlo a través de nuestra copia del repositorio Git. Debemos entrar en la ruta</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">cd &lt;app&gt;/.openshift/markers</span>
<span class="tok-go">touch disable_auto_scaling</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Con esto crearemos un fichero marcador, de nombre <em>disable_auto_scaling</em>, que debemos subir al repositorio con un commit y un push.</p>
</div>
</div>
<div class="sect3">
<h4 id="_monitorización_del_balanceador">8.1.4. Monitorización del balanceador</h4>
<div class="paragraph">
<p>HAProxy ofrece la posibilidad de consultar datos acumulados sobre la carga de trabajo que está gestionando nuestra aplicación. Podemos acceder a dicha información accediendo a la URL: <a href="http://&lt;app&gt;-&lt;domain&gt;.rhcloud.com/haproxy-status" class="bare">http://&lt;app&gt;-&lt;domain&gt;.rhcloud.com/haproxy-status</a></p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas07/scale7.png" alt="scale7">
</div>
</div>
<div class="paragraph">
<p>De esta página nos interesa la segunda tabla, concretamente la fila local gear donde se muestra la información relativa al gear donde se ejecuta nuestra aplicación. En situaciones donde se requieran gear adicionales, aparecerán nuevas entradas en dicha tabla.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas07/scale8.png" alt="scale8">
</div>
</div>
<div class="paragraph">
<p>Cada gear se presentará en un color en función del estado en el que se encuentre.</p>
</div>
</div>
<div class="sect3">
<h4 id="_configuración_de_haproxy">8.1.5. Configuración de HAProxy</h4>
<div class="paragraph">
<p>HAProxy mantiene su configuración en un fichero haproxy.cfg que se ha de modificar directamente en el gear principal de la aplicación. Para ello hay que iniciar una sesión ssh y acceder a la carpeta de configuración haproxy/conf:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> rhc ssh &lt;app&gt;
<span class="tok-gp">$</span> <span class="tok-nb">cd </span>haproxy/conf
<span class="tok-gp">$</span> vi haproxy.cfg</code></pre>
</div>
</div>
<div class="paragraph">
<p>En este fichero podemos modificar entre otras cosas el algoritmo de reparto de carga. Si realizamos algún cambio en la configuración tendremos que reiniciar el cartridge correspondiente al balanceador.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> rhc cartridge-restart --cartridge haproxy -a &lt;app&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_devops">8.2. DevOps</h3>
<div class="sect3">
<h4 id="_introducción_2">8.2.1. Introducción</h4>
<div class="paragraph">
<p>El uso de metodologías ágiles en el desarrollo de aplicaciones es algo relativamente habitual en la actualidad.  Estas metodologias favorecen las entregas parciales al usuario final y permite que éste haga cambios en los requermientos, en función de sus necesidades. El problema lo tenemos cuando en lugar de facilitar un producto instalable, resulta que debemos proporcionar la infraestructura necesaria para hacerlo funcionar, como es el caso de grandes empresas. Y es que tradicionalmente desarrollo y sistemas suelen ser dos bandos con intereses contrapuestos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Desarrollo</em>: quiero construir y publicar lo que me pide el negocio con agilidad.</p>
</li>
<li>
<p><em>Explotación</em>: me miden por el coste y disponibilidad. No quiero riesgos.</p>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas08/WallOfConfusion.png" alt="WallOfConfusion" width="50%">
</div>
</div>
<div class="paragraph">
<p>Como ejemplo, en un banco podemos encontrarnos con que desde negocio se presiona para poner en marcha un nuevo servicio a clientes. Como respuesta, un equipo de desarrollo comienza a trabajar en el nuevo proyecto. Internamente pueden utilizar la metodología en cascada o incluso metodologías ágiles para proporcionar al usuario interno, distintas entregas del proyecto pero si hablamos de desplegar una aplicación en producción entonces es cuando comienzan las fricciones:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Desarrollo</em>:  Perciben demasiada burocracia,  falta de permisos en producción (monitorización, incidencias), lentitud en los traspasos.</p>
</li>
<li>
<p><em>Explotación</em>: Consideran que les falta información acerca de las aplicaciones que luego tienen que soportar, procedimientos de despliegue mal documentados o con errores, incertidumbre.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>DevOps es un propósito de reconducir esa situación planteando la participación efectiva de los administradores de sistemas en el proceso de desarrollo de aplicaciones, utilizando las mismas metodologías ágiles que los desarrolladores.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas08/devops3.png" alt="devops3" width="50%">
</div>
</div>
<div class="paragraph">
<p>Dentro de una organización se podría identificar la madurez de implantación de DevOps mediante el siguiente gráfico:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas08/devops2.png" alt="devops2" width="50%">
</div>
</div>
<div class="paragraph">
<p>El escalón más básico consiste en la adopción de metodologías ágiles no sólo para la construcción del proyecto sino también para la definición de la infraestructura necesaria para su funcionamiento (infraestructura como script). El siguiente nivel sería la automatización de la integración de cambios en infraestructura y aplicación, y por último el despliegue continuo. La entrega continua implica que dejen de existir las versiones como tal de las aplicaciones y que las nuevas funcionalidades que se desarrollen pasen por un exahustivo proceso automático de validación y despliegue en producción.</p>
</div>
<div class="paragraph">
<p>Note: Continous Delivery es un concepto más genérico que Continuous Deployment. El primero hace referencia a todos los aspectos que permiten hacer despliegues por funcionalidad mientras que el segundo se refiere en sí al proceso técnico de ante un cambio en la aplicación, iniciar el despliegue en producción.</p>
</div>
<div class="paragraph">
<p>En resumen DevOps pretende mejorar la productividad potenciando el trabajo colaborativo dentre desarrolladores y técnicos de sistemas permitiendo que:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Desarrollo se concentre en la construcción de las aplicaciones.</p>
</li>
<li>
<p>Operaciones se concentre en la creación de entornos estandarizados.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_devops_y_cloud_computing">8.2.2. DevOps y Cloud Computing</h4>
<div class="paragraph">
<p>La gran ventaja de las grandes plataformas IaaS y PaaS frente a la informática tradicional es que resuelven gran parte del trabajo de estandarización de entornos y de procesos. Las prácticas que hemos comentado forman parte de los recursos que la propia arquitectura ofrece al administrador de sistemas con lo que simplifica su utilización:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas08/devops1.png" alt="devops1">
</div>
</div>
<div class="paragraph">
<p>En el caso concreto de OpenShift, ya sabemos que tanto la creación de gears como cualquier aspecto de configuración es susceptible de automatizarse mediante script y que en su concepción más básica se utiliza el despliegue continuo. A continuación veremos como aplicar también integración continua, pruebas automatizadas y cómo poder definir una build pipeline.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Las herramientas de integración continua, automatización de pruebas, metodologías por si mismas justificarían varias sesiones con lo que hablaremos de los aspecto más importantes y nos centraremos en su implementación en OpenShift.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_integración_continua_ci_con_jenkins">8.2.3. Integración continua (CI) con Jenkins</h4>
<div class="paragraph">
<p>Entendemos por integración continua un sistema que ejecuta, ante un cambio en una aplicación, la compilación y ejecución automática de un conjunto de pruebas. Si la aplicación compila correctamente y supera las pruebas, la aplicación se considera apta para el despliegue (habitualmente en un entorno desarrollo o integración), pero por el contrario, si no se supera, se deja constancia del error y no se altera la versión de la aplicacion que actualmente está ejecutándose en el siguiente entorno de trabajo.</p>
</div>
<div class="paragraph">
<p>Para aplicar integración continua en un proyecto, necesitaremos herramientas ya conocidas como control de versiones (Git, SVN, etc.) , compilación (desde javac hasta Maven, Gradle) y ejecución de pruebas, pero también necesitaremos una aplicación denominada servidor de CI. Por defecto OpenShift utiliza Jenkins, aunque no nos impide que instalemos cualquier otro producto.</p>
</div>
<div class="paragraph">
<p>El uso de Jenkins está muy integrado en OpenShift en tanto desde la consola web basta con decir que indicar que queremo utilizar integración contínua para una de nuestras aplicaciones, para que el sistema configure los servicios necesarios para comenzar a trabajar con Jenkins.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas08/ci1.png" alt="ci1">
</div>
</div>
<div class="paragraph">
<p>Al activar Jenkins se creará un nuevo gear específico para el servidor de CI y se configurará una tarea específica para compilar la aplicación a través de Jenkins. Al crear el servidor Jenkins se nos informa de una URL para acceder a su configuración y un usuario/password para poder identificarnos como administrador.</p>
</div>
<div class="sect4">
<h5 id="_introducción_a_jenkins">Introducción a Jenkins</h5>
<div class="paragraph">
<p>En el caso de Jenkins podemos entenderlo como una herramienta de ejecución y monitorización de jobs, en un sentido más amplio que la compilación y despliegue de aplicaciones. Si accedemos a la consola de Jenkins, nos encontraremos una pantalla similar a la siguiente:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas08/ci2.png" alt="ci2">
</div>
</div>
<div class="paragraph">
<p>En la parte principal de la pantalla veremos una tabla en la que aparece una única entrada con el mismo nombre que nuestra aplicación  y una serie de métricas, inicialmente sin datos. Lo primero que hay que entender es que para Jenkins, cada aplicación que se construye se denomina <strong>tarea</strong> y  cada vez que se active dicha tarea se genera una <strong>compilación</strong>. Si instalamos Jenkins en nuestra propia infraestructura debemos configurar entre otras cosas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Rutas de las distintas herramientas que intervienen en la construcción de los proyectos.</p>
</li>
<li>
<p>Seguridad básica de Jenkins.</p>
</li>
<li>
<p>Las tareas necesarias para compilar.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Con OpenShift tenemos la ventaja de que estas tres cosas ya están preconfiguradas y listas para funcionar desde el primer momento. Si pulsamos en el icono de "Programar una ejecución", activaremos manualmente la tarea y comenzaremos a construir la aplicación. En la parte izquierda de la pantalla se mostrará una barra de progreso donde podemos ver el avance de la construcción y si pulsamos en <em>Console Output</em> podremos ver exactamente la salida por consola del script de compilación.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas08/ci3.png" alt="ci3">
</div>
</div>
<div class="paragraph">
<p>Una de las características más importantes de Jenkins es que almacena toda la información relativa a la construcción de una aplicación (compilación, pruebas, despliegue), no sólo la muestra en tiempo real.</p>
</div>
<div class="paragraph">
<p>Si dentro de una tarea pulsamos en <em>Configurar</em> se nos muestra un formulario donde se puede parametrizar casi cualquier aspecto de la construcción de la aplicación. Entre otros aspectos:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Definición y descripción de la tarea</dt>
<dd>
<p>Datos identificativos del proyecto.</p>
</dd>
<dt class="hdlist1">Builder a utilizar</dt>
<dd>
<p>Al activarse una tarea se crea dinámicamente un nuevo gear que se encarga específicamente de la construcción de la aplicación.</p>
</dd>
<dt class="hdlist1">Disparadores de ejecuciones</dt>
<dd>
<p>Podemos configurar si queremos que nuestra tarea se active mediante un script, al finalizar otras tareas, periódicamente o cuando se produzca un cambio en un repositorio.</p>
</dd>
<dt class="hdlist1">Ejecución</dt>
<dd>
<p>Es un area donde se muestra el sh que se va a ejecutar y se nos permite su total edición.
Post Ejecución: Podemos definir comandos adicionales que se ejecuten al finalizar correctamente una tarea.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Una vez se haya ejecutado una tarea, veremos que en la pantalla principal aparecen dos iconos asociados a la tarea. El primero de ellos indica si la última compilación ha sido OK o KO, y el segundo muestra una tendencia, en forma de icono de "previsión meteorológica". Si todo va bien, se muestra un icono soleado, pero si se van produciendo errores de compilación, el icono va cambiando hasta mostrar una "tormenta".</p>
</div>
<div class="paragraph">
<p>Por último, comentar que Jenkins se puede extender mediante plugins y existe un conjunto muy numeroso de ellos por lo que es un servidor de CI que se puede adaptar a multitud de proyectos. Existen los plugin de tipo <em>publisher</em> que permiten mostrar información extendida sobre las tareas ejecutadas de forma visual. Es el caso del plugi de <em>Cobertura</em> que muestra gráficamente el grado de cobertura de las pruebas unitarias definidas para una aplicación.</p>
</div>
<div class="paragraph">
<p>Otro plugin interesante es el <em>Pipeline plugin</em> que permite representar un conjunto de tareas interrelacionadas de forma visual. Concretamente se suele utilizar en para representar los Deployment Pipeline de los procesos de Continuous Delivery.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas08/ci4.png" alt="ci4">
</div>
</div>
</div>
<div class="sect4">
<h5 id="_uso_de_jenkins_en_openshift">Uso de Jenkins en OpenShift</h5>
<div class="paragraph">
<p>Por defecto Jenkins se configura  utilizando un Gear para el propio servidor y otro Gear "esclavo" para cada trabajo de compilación. Esto puede ser una limitación muy importante en el caso de trabajar con el  plan gratuito pero veremos formas de paliar este problema. La ventaja de utilizar un Gear específico para compilar es que no estamos parando la aplicación en ningún momento, ni consumiendo parte de sus recursos en la construcción de la aplicación, y si se produce un fallo en el proceso no llega a afectar a la aplicación en ejecucuión.</p>
</div>
<div class="paragraph">
<p>Los eventos que se suceden cuando un usuario hace un cambio sobre una aplicación que trabaja con CI en OpenShift son los siguientes:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>El desarrollador hace <em>push</em> de un cambio al repositorio de la aplicación.</p>
</li>
<li>
<p>Jenkins recibe una notificación de que se ha hecho un cambio en el repositorio de fuentes.</p>
</li>
<li>
<p>A continuación Jenkins crea un gear esclavo para construir la aplicación. Desde ese momento el nuevo gear se puede ver tanto con el comando <em>rhc domain show</em> como accediendo a la consola web. El nombre de la aplicación será el nombre original añadiéndole "bldr" (builder). Este mecanismo tiene una limitación y es que los 28 primeros caracteres de las aplicaciones deben ser únicos o existe riesgo de que en lugar de crear un builder nuevo, se comparta entre las aplicaciones coincidentes.</p>
</li>
<li>
<p>Jenkins ejecuta la tarea de compilación sobre el gear.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Se descarga el código fuente del repositorio git y mediante el comando <em>rsync</em> se copian las librerías asociadas al proyecto que existieran en la aplicación.</p>
</li>
<li>
<p>Se ejecuta el script ci_build.sh que inicia el proceso de compilación en la máquina builder.</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Se ejecutan los script  .openshift/action_hooks/pre_build definidos para la aplicación antes de la construcción.</p>
</li>
<li>
<p>Se construye la aplicación ejecutando todos los pasos de construcción definidos en la tarea de Jenkins.</p>
</li>
<li>
<p>Se ejecutan los script  .openshift/action_hooks/build definidos para la aplicación después de la construcción.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Ejecución de pasos adicionales post compilación  que el desarrollador pueda haber definido.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Una vez construida la aplicación con éxito, Jenkins solicita la parada de la aplicación en ejecución.</p>
</li>
<li>
<p>Mediante <em>rsync</em> se copian los nuevos artefactos compilados al gear de la aplicación.</p>
</li>
<li>
<p>Jenkins inicia de nuevo el gear.</p>
</li>
<li>
<p>Se archiva toda la información del proceso de build en Jenkins.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Pasados 15 minutos sin actividad el builder se destruye automáticamente aunque la información de los procesos de build se mantienen en el gear principal de Jenkins.</p>
</div>
<div class="paragraph">
<p>Además de poder acceder a la consola de las build para analizar el proceso de construcción de una aplicación, en el caso de que algo no funcione como debe, tenemos a nuestra disposición el log de Jenkins, el cual podemos consultar mediante el  comando habitual de OpenShift:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">rhc tail jenkins</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por su parte, si la aplicación no se despliega correctamente podemos consultar el log del gear de la aplicación.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">rhc tail &lt;app&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por último, mencionar que la construcción de la aplicación se realiza con los parámetros por defecto de OpenShift (<em>mvn -e clean package -Popenshift -DskipTests'</em>), por lo que por defecto no se ejecutarán ningún caso de prueba de JUnit u otras herramientas que queramos utilizar. Para poder habilitarlas, dentro del código de la build hay una sección con un comentario:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">#</span> Run tests here</code></pre>
</div>
</div>
<div class="paragraph">
<p>A continuación podríamos añadir la ejecución de pruebas unitarias y cobertura del código:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">mvn test cobertura:cobertura</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si invocamos el comando cobertura necesitaremos el plugin de Cobertura para Jenkins para poder integrar la información de cobertura en la información de la build.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_como_trabajar_contra_un_repositorio_de_bitbucket">8.2.4. Como trabajar contra un repositorio de Bitbucket</h4>
<div class="paragraph">
<p>Ya conocemos cómo OpenShift es capaz de instalar Jenkins y crear una tarea de construcción y despliegue por nosotros. No obstante, nuestras necesidades pueden ser algo más complejas o podemos necesitar ejecutar pasos adicionales en el proceso de construcción. Para ello Jenkins nos permite editar las tareas o bien crear una nueva tarea desde cero.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, podemos querer trabajar con un repositorio en Bitbucket como repositorio principal, en lugar del asociado al gear. La modificación aparentemente es sencilla pues bastaría con edita la información que se muestra en la sección de "Configuración del origen del código fuente":</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas08/ci5.png" alt="ci5">
</div>
</div>
<div class="paragraph">
<p>Pero si lo hacéis os encontraréis con errores de acceso y de permisos al escribir en rutas del gear.</p>
</div>
<div class="sect4">
<h5 id="_tipo_de_credenciales">Tipo de credenciales</h5>
<div class="paragraph">
<p>Lo primero es comentar las tres formas de autenticarse más habituales contra repositorios:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Público (sin credenciales)</dt>
<dd>
<p>Los repositorios de GitHub gratuitos son todos públicos, pero como ya sabéis en BitBucket se pueden tener públicos o privados</p>
</dd>
<dt class="hdlist1">Usuario/password</dt>
<dd>
<p>Donde Jenkins utilizará nuestras claves personales del repositorio. ¿Que ocurre si tenemos que cambiar de password?</p>
</dd>
<dt class="hdlist1">Claves RSA</dt>
<dd>
<p>Mediante el sistema de clave pública/clave privada con lo que lo que se identificará será la propia instancia de Jenkins ante el repositorio de BitBucket o GitHub.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Para poder utilizar credenciales de tipo usuario/password es necesario instalar un componente adicional, el <em>plugin de Bitbucket para Jenkins</em>, pero el método por claves RSA ni siquiera os funcionará con este plugin pues la política de permisos de OpenShift sobre los gear impide que tengamos acceso a la carpeta .ssh donde se guardan las credenciales de usuario y al fichero <em>known_hosts</em> donde se almacenan las máquinas a las que nos hemos conectado. Para poder acceder a otros repositorios con claves RSA, se puede utilizar un catridge alternativo que ubica esta información en $OPENSHIFT_DATA_DIR.</p>
</div>
<div class="paragraph">
<p>Vamos a proponer una solución que contempla ambos enfoques pero requiere una configuración adicional.</p>
</div>
</div>
<div class="sect4">
<h5 id="_jenkins_alternativo">Jenkins "Alternativo"</h5>
<div class="paragraph">
<p>En lugar de dejar a OpenShift la responsabilidad de crear una instancia de Jenkins, la crearemos nosotros en primer lugar, pero utilizando un cartridge de terceros:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go"> rhc create-app jenkins  jenkins-1  &quot;https://cartreflect-claytondev.rhcloud.com/reflect?github=majecek/openshift-community-git-ssh</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Este cartridge tiene la particularidad de trasladar a la carpeta <em>$OPENSHIFT_DATA_DIR/git-ssh</em> toda la información relativa a claves RSA con lo que podremos trabajar con libertad. La estrategia es definir una variable de entorno llamada GIT_SSH que permite especificar un script de tratamiento de credenciales, que entre otras cosas puede especificar la ubicación de las credenciales.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Dado que en gear sólo tenemos permisos para trabajar en carpetas específicas Jenkins está configurado para obtener la identificación del usuario de la carpeta $OPENSHIFT_DATA_DIR en lugar de la propia del usuario como ocurriría en una instalación local. Esto se hace configurando la variable de entorno GIT_SSH para que apunte a un shellscript que  lea de otra ubicación las claves RSA. En el caso de Openshift se encuentra en  /usr/libexec/openshift/cartridges/jenkins/bin/git_ssh_wrapper.sh. Este mismo mecanismo se utiliza en una instalación local de Jenkins para ejecutar tareas de Jenkins como distintos usuarios.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si queremos trabajar con claves RSA, todavía tenemos pendiente el crearlas, así que accederemos a la carpeta OPENSHIFT_DATA_DIR/git-ssh y ejecutaremos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">ssh-keygen</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Deberemos especificar en qué ubicación guardar la clave privada. Especificaremos un nombre de fichero con su ruta completa:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">/var/lib/openshift/547ae964e0b8cdbb49000092/app-root/data/git-ssh/id_rsa</span>



<span class="tok-go">The key fingerprint is:</span>
<span class="tok-go">7d:f1:25:07:da:a7:e3:b0:c5:e0:e7:82:27:dc:2d:33 547ae964e0b8cdbb49000092@ex-std-node44.prod.rhcloud.com</span>
<span class="tok-go">The key&#39;s randomart image is:</span>
<span class="tok-go">+--[ RSA 2048]----+</span>
<span class="tok-go">|              .  |</span>
<span class="tok-go">|             o . |</span>
<span class="tok-go">|            + o +|</span>
<span class="tok-go">|         . . = * |</span>
<span class="tok-go">|        S . + B  |</span>
<span class="tok-go">|         . + O . |</span>
<span class="tok-go">|          + E +  |</span>
<span class="tok-go">|           o =   |</span>
<span class="tok-go">|                 |</span>
<span class="tok-go">+-----------------+</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por último, tenemos que avisar a BitBucket de que vamos a descargar código mediante Jenkins. para ello debemos añadir la clave RSA pública asociada a Jenkins dentro de las <strong>Deployment key</strong> de Bitbucket.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas08/ci6.png" alt="ci6">
</div>
</div>
<div class="paragraph">
<p>Ahora ya estamos en condiciones de autenticarnos en repositorios privados tanto por usuario/password como por claves RSA.</p>
</div>
</div>
<div class="sect4">
<h5 id="_bitbucket_plugin">BitBucket Plugin</h5>
<div class="paragraph">
<p>Gracias a este plugin es posible tener un mayor control de cómo se comunica Jenkins con BitBucket, pero no sólo sirve a la hora de acreditarnos, sino que nos permite que ante un cambio en Bitbucket se dispare la ejecución de una tarea Jenkins.</p>
</div>
<div class="paragraph">
<p>Si editamos una tarea de Jenkins tras instalar el plugin nos aparecerá una nueva forma de "disparar" la ejecución de la tarea.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas08/ci85.png" alt="ci85">
</div>
</div>
<div class="paragraph">
<p>Por la parte de Bitbucket hay que añadir un nuevo elemento que avise a Jenkins cuando hay un cambio en el repositorio. Debemos añadir un <strong>Hook</strong> y lo más sencillo, es especificar uno de tipo POST, es decir una llamada http directa al servidor Jenkins:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas08/ci8.png" alt="ci8">
</div>
</div>
<div class="paragraph">
<p>La URL a indicar es la URL de Jenkins añadiendo la ruta <em>/Bitbucket-hook/</em></p>
</div>
<div class="paragraph">
<p>Por último tenemos que dar de alta las credenciales concretas que vamos a utilizar para autenticarnos. Para ello, en la configuración de la tarea, en la sección del repositorio de código fuente, aparece un desplegable que nos permite especificar qué credenciales queremos utilizar para identificarnos. Como ya sabemos, estas credenciales pueden ser un usuario/password, o especificar la ruta a la clave privada RSA, o directamente "pegar" dicha clave en el formulario de configuración.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas08/ci9.png" alt="ci9">
</div>
</div>
<div class="paragraph">
<p>También tenemos a nivel del menú principal de Jenkins, una nueva opción "Credentials" para gestionar estas credenciales.</p>
</div>
<div class="paragraph">
<p>Por último, comentar que a la fecha de la redacción de estos apuntes no funciona correctamente la descarga de código del repositorio de Bitbucket, en el sentido de que el comando de compilación <em>gear build</em> no sabe exactamente qué rama hay que compilar. La solución pasa por forzar a utilizar una rama concreta. En nuestro ejemplo <em>master</em>. Hay que forzar a descargar el contenido a la rama local master:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas08/ci10.png" alt="ci10">
</div>
</div>
<div class="paragraph">
<p>Y luego antes de compilar, especificar sobre qué rama vamos a trabajar. Hay que editar el código de la build:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">#</span> Build/update libs and run user pre_build and build

<span class="tok-go">GIT_BRANCH=master		# &lt;-- Forzar a compilar sobre la rama master</span>
<span class="tok-go">gear build</span>

<span class="tok-gp">#</span> Run tests here</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
La misma tarea que estamos presentando para trabajar contra Bitbucket la podríamos utilizar para compilar proyectos alojados en GitHub. Bastaría con instalar el plugin asociado a GitHub, configurar el repositorio remoto con la clave pública de Jenkins y cambiar la URL de Hook por: https://[url jenkins]/github-webhook/ con content type  <em>application/x-www-form-urlencoded</em>. En GitHub no se observa el problema de las ramas descrito para el plugin de Bitbucket.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_alternativas_a_jenkins">8.2.5. Alternativas a Jenkins</h4>
<div class="paragraph">
<p>Una de las principales ventajas de utilizar Jenkins integrado en OpenShift es que de forma automática tenemos un sistema que implementa el despliegue continuo. Sin embargo si utilizamos el plan gratuito podemos encontrarnos con sólo nos deja un único gear para poder desplegar nuestras aplicaciones. Una medida que puede paliar el problema es configurar el propio gear de Jenkins como un builder, de modo que tanto la ejecución del servidor como los procesos de compilación correrían en el mismo gear. Esto puede ser factible para proyectos pequeños pero si nos excedemos de los límites de almacenamiento o consumo de memoria, podemos tener errores inesperados.</p>
</div>
<div class="paragraph">
<p>La otra alternativa es utilizar un servidor de CI de otro proveedor en Cloud. Travis, Shippable y CodeShip son soluciones que funcionan con OpenShift. La estrategia con estos servidores es clonar desde un repositorio principal el código fuente, aplicar las validaciones que consideremos oportunas, y si todo es correcto, hacer un <em>push</em> al repositorio del gear en el que queremos desplegar.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas08/ship1.png" alt="ship1">
</div>
</div>
<div class="paragraph">
<p>En el caso concreto de Shippable, nos podemos identificar mediante Oauth Con las cuentas de Bitbucket o GitHub e inmediatamente acceder a nuestros proyectos, pero antes de poder desplegar hacen falta dos cosas:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Añadir la clave pública de Shippable dentro de las claves públicas admitidas de OpenShift, en la pestaña Settings:</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas08/ship2.png" alt="ship2">
</div>
</div>
</li>
<li>
<p>Definir un script de construcción y despliegue. En el caso de Shippable, se denomina <em>shippable.yml</em> y se encuentra en la carpeta raíz del proyecto:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">language: java</span>

<span class="tok-go">jdk:</span>
<span class="tok-go">   - openjdk7</span>

<span class="tok-go">env:</span>
<span class="tok-go">  global:</span>
<span class="tok-go">    - JBOSS_HOME=/tmp/jboss-as-7.1.0.Final</span>
<span class="tok-go">    - JBOSS_SERVER_LOCATION=http://download.jboss.org/jbossas/7.1/jboss-as-7.1.0.Final/jboss-as-7.1.0.Final.tar.gz</span>
<span class="tok-go">    - OPENSHIFT_REPO=ssh://54566a5a5973ca89760000cf@jbossas-djbyte.rhcloud.com/~/git/jbossas.git/</span>

<span class="tok-go">before_install:</span>
<span class="tok-go">  - if [ ! -e $JBOSS_HOME ]; then curl -s $JBOSS_SERVER_LOCATION | tar zx -C /tmp; fi</span>
<span class="tok-go">  - git remote -v | grep ^openshift || git remote add openshift $OPENSHIFT_REPO</span>

<span class="tok-go">before_script:</span>
<span class="tok-go">  - mkdir -p shippable/testresults</span>
<span class="tok-go">  - mkdir -p shippable/codecoverage</span>

<span class="tok-go">script:</span>
<span class="tok-go">  - mvn clean cobertura:cobertura</span>
<span class="tok-go">  - mvn test -Parq-jbossas-managed</span>

<span class="tok-go">after_success:</span>
<span class="tok-go">  - git push -f openshift $BRANCH:master</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_deployment_pipeline">8.2.6. Deployment pipeline</h4>
<div class="paragraph">
<p>Con los elementos que conocemos ya podríamos definir una estrategia de construcción y despliegue para una aplicación en cloud. Esta estrategia podrá ser más o menos compleja en función del tipo de aplicación y el número de partes que intervengan en el proceso. Además del uso que hemos visto de herramientas de CI como Jenkins o Shippable, donde lo que hacemos es básicamente mover código fuente o desplegar aplicaciones ya compiladas en gears, también podemos utilizar el propio api REST de OpenShift para crear, desplegar y destruir gears como parte del ciclo de construcción de una aplicación. En las referencias se cita un enlace donde se explica el plugin <em>OpenShift Deployer</em> que utilizando el api REST permite integrar dentro del proceso de despliegue estas tareas.</p>
</div>
<div class="paragraph">
<p>También se incluye en las referencias algunos enlaces con <em>best practices</em> sobre cómo aprovechar OpenShift para implementar un deployment pipeline. En todas ellas lo habitual suele ser definir varios dominios, uno por cada entorno de trabajo que vayamos a definir. Una posible división entre entornos sería:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Desarrollo</dt>
<dd>
<p>Entorno al que los programadores tienen acceso completo y pueden subir sus cambios desarrollados en local cuando consideran que con correctos y se pueden integrar con la aplicación.</p>
</dd>
<dt class="hdlist1">Test</dt>
<dd>
<p>De forma diaria, se ejecuta una tarea de Jenkins que trae las modificaciones de código realizadas en Desarrollo, recompila la aplicación y ejecuta todas las pruebas automatizadas. También este entorno sirve para que el equipo de testing pueda realizar sus pruebas. Sobre este entorno se podrían realizar pruebas de aceptación por parte de usuarios, o bien separarlas en diferentes entornos.</p>
</dd>
<dt class="hdlist1">Preproducción o Stage</dt>
<dd>
<p>Cuando el equipo de testing da el ok a estas pruebas, manualmente se traspasan los cambios de Test a Preproducción. Todo el código de preproducción se considera código validado y preparado para pasar a producción. Sin embargo en este entorno el equipo de Operaciones puede realizar las últimas pruebas de cara a su puesta en producción.</p>
</dd>
<dt class="hdlist1">Producción</dt>
<dd>
<p>Cuando se considere que la nueva versión puede publicarse, alguien desde operaciones iniciará el proceso de traspaso desde preproducción hasta producción manualmente, quedando la nueva aplicación disponible a los clientes.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>En entornos estáticos tradicionales, se suele tener un servidor por entorno, lo cual puede condicionar las pruebas que se realicen sobre una aplicación ya que en proyectos grandes se pueden estar probandos distintas <em>features</em> simultáneamente y ser incompatibles dichas pruebas. O también es habitual que se quieran promocionar determinadas funcionalidades pero no otras hasta una fecha pactada con el cliente. Gracias a las herramientas (Git, Jenkins, OpenShift) podemos crear servidores de pruebas temporales para ramas específicas de un proyecto, que se validen de forma independiente, y que cuando llegue el momento previo a su despligue en producción, se integren en Preproducción.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_referencias_8">8.3. Referencias</h3>
<div class="ulist">
<ul>
<li>
<p>Application Scaling <a href="https://www.OpenShift.com/developers/scaling" class="bare">https://www.OpenShift.com/developers/scaling</a></p>
</li>
<li>
<p>Scaling in action <a href="https://www.openshift.com/blogs/scaling-in-action-on-openshift" class="bare">https://www.openshift.com/blogs/scaling-in-action-on-openshift</a></p>
</li>
<li>
<p>Autoescalado en OpenShift <a href="https://blog.openshift.com/how-to-host-your-java-ee-application-with-auto-scaling/" class="bare">https://blog.openshift.com/how-to-host-your-java-ee-application-with-auto-scaling/</a></p>
</li>
<li>
<p>Puppet <a href="http://es.wikipedia.org/wiki/Puppet_(software" class="bare">http://es.wikipedia.org/wiki/Puppet_(software</a>)</p>
</li>
<li>
<p>Continuous delivery <a href="http://www.xebia.in/assets/files/whitepaper_xebia_continuous_delivery.pdf" class="bare">http://www.xebia.in/assets/files/whitepaper_xebia_continuous_delivery.pdf</a></p>
</li>
<li>
<p>Continuous delivery using pipelines <a href="http://www.methodsandtools.com/archive/archive.php?id=121" class="bare">http://www.methodsandtools.com/archive/archive.php?id=121</a></p>
</li>
<li>
<p>Openshift development pipeline <a href="https://blog.openshift.com/elevating-your-development-pipeline-to-the-cloud-with-openshift/" class="bare">https://blog.openshift.com/elevating-your-development-pipeline-to-the-cloud-with-openshift/</a></p>
</li>
<li>
<p>Administering Jenkins <a href="https://wiki.jenkins-ci.org/display/JENKINS/Administering+Jenkins" class="bare">https://wiki.jenkins-ci.org/display/JENKINS/Administering+Jenkins</a></p>
</li>
<li>
<p>Cómo subar Sonar en OpenShift <a href="http://majecek.wordpress.com/2013/12/06/how-to-run-sonarqube-4-0-on-openshift/" class="bare">http://majecek.wordpress.com/2013/12/06/how-to-run-sonarqube-4-0-on-openshift/</a></p>
</li>
<li>
<p>Desplegar en OpenShift desde un jenkins externo: <a href="https://blog.openshift.com/deploy-openshift-external-jenkins-instance/" class="bare">https://blog.openshift.com/deploy-openshift-external-jenkins-instance/</a></p>
</li>
<li>
<p>Estrategias de Release Management: <a href="https://blog.openshift.com/release-management-in-the-cloud/" class="bare">https://blog.openshift.com/release-management-in-the-cloud/</a></p>
</li>
<li>
<p>Development pipeline en cloud: <a href="https://blog.openshift.com/elevating-your-development-pipeline-to-the-cloud-with-openshift/" class="bare">https://blog.openshift.com/elevating-your-development-pipeline-to-the-cloud-with-openshift/</a></p>
</li>
<li>
<p>Ticket Monster <a href="http://www.jboss.org/ticket-monster/" class="bare">http://www.jboss.org/ticket-monster/</a></p>
</li>
<li>
<p>Blog de Arun Gupta <a href="http://blog.arungupta.me" class="bare">http://blog.arungupta.me</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_ejercicios_de_integración_continua_y_escalabilidad">8.4. Ejercicios de Integración continua y escalabilidad</h3>
<div class="paragraph">
<p>En esta sesión vamos a trabajar con la aplicación <em>Ticket Monster</em>. Esta aplicación es una plataforma de venta de entradas por internet y Red Hat la publica con fines educativos y como demostracíon de distintas tecnologías. Para más información en la sección de referencias hay un enlace con documentación acerca de esta aplicación.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paas08/ejer1.png" alt="ejer1">
</div>
</div>
<div class="paragraph">
<p>Por lo pronto vamos a descargarnos el código de GitHub correspondiente a la rama de código dirigida a WildFly. Concretamente ejecutaremos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">git clone -b WildFly https://github.com/jboss-developer/ticket-monster.git</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Una vez descargado lo compilaremos con los siguientes parámetros:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">cd ticket-monster/demo</span>
<span class="tok-go">mvn clean package -Ppostgresql-openshift</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La compilación generará un fichero <em>ticket-monster.war</em>.</p>
</div>
<div class="sect3">
<h4 id="_despliegue_de_una_aplicación_escalable_0_2_puntos">8.4.1. Despliegue de una aplicación escalable (0.2 Puntos)</h4>
<div class="paragraph">
<p>Para este ejercicio se pide:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Crear una aplicación OpenShift de nombre <em>ticketmonster</em> que sea escalable y que utilice una base de datos <em>PostgreSQL</em>.</p>
</li>
<li>
<p>Desplegar el war compilado como aplicación.</p>
</li>
<li>
<p>Verificar que la aplicación funciona correctamente.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_prueba_de_estrés_0_4_puntos">8.4.2. Prueba de Estrés ( 0.4 puntos)</h4>
<div class="paragraph">
<p>En este ejercicio vamos a comprobar cómo funciona el mecanismo de autoescalado simulando una carga de trabajo elevada. Para ello, lo primero es instalar una herramienta de pruebas de estrés: <em>ApacheBench</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> sudo apt-get install apache2-utils</code></pre>
</div>
</div>
<div class="paragraph">
<p>La aplicación Ticket monster, tiene una sección de administración generada mediante JBoss Forge y de la cual también expone una interfaz REST para manipular los datos de la aplicación. Vamos a lanzar una consulta de un servicio REST de forma masiva, con el fin de generar un número de sesiones concurrentes lo suficientemente elevado como para que OpenShift dispare la activación de un segundo gear.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Recordad que al configurar una aplicación como escalable ya consumimos 2 gear, así que como mucho, vamos a poder incorporar un tercero.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La forma de lanzar una prueba de carga contra un servicio REST  de consulta (GET) sería la siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> ab -n <span class="tok-m">50000</span> -c <span class="tok-m">50</span> -s <span class="tok-m">100</span> http://ticketmonster-jlzamora.rhcloud.com/rest/sections</code></pre>
</div>
</div>
<div class="paragraph">
<p>Donde  "n" es el número de peticiones a realizar, "c" es el número de peticiones concurrentes y "s" es el tiempo máximo de espera por petición.</p>
</div>
<div class="paragraph">
<p>Si nos conectamos mediante SSH al gear de la aplicación, podemos consultar el log del balanceador en la ruta $OPENSHIFT_LOG_DIR/haproxy_ctld.log donde podremos ver los eventos de creación/destruccion de gears en función de la carga de trabjo. Adicionalmente en la consulta web de HAProxy también podemos ver el número de gears que tenemos en funcionamiento y su carga de trabajo.</p>
</div>
<div class="paragraph">
<p>Para este ejercicio se pide:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Ejecutar la prueba de estrés y verificar que pasado un tiempo se crea automáticamente un gear adicional.</p>
</li>
<li>
<p>En cuanto aparezca el nuevo gear, finalizar la prueba de carga mediante <em>CTRL+C</em> al comando de ApacheBench. Guardar los datos estadísticos de rendimiento que ha generado la herramienta en un fichero llamado <strong>1Gear.txt</strong>.</p>
</li>
<li>
<p>Comprobar que pasado un tiempo, se elimina automáticamente el segundo gear.</p>
</li>
<li>
<p>Obtener una copia del fichero <strong>haproxy_ctld.log</strong> como entregable.</p>
</li>
<li>
<p>Forzar a que la aplicación ticketmonster trabaje siempre con dos gears.</p>
</li>
<li>
<p>Repetir la prueba de carga hasta un número de ejecuciones similar a la realizada en el paso 2, y almacenar las estadísticas de ApacheBench en un fichero llamado <strong>2Gear.txt</strong>.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Si os interesa realizar pruebas de estrés, además de ApacheBench podéis utilizar JMeter para realizar pruebas de estrés. Se trata de una herramienta mucho más completa pero algo más complicada de sacar partido. Como SaaS, tenéis la herramienta BlazeMeter, que permite generar simulaciones de carga de trabajo de forma sencilla pero también permite ejecutar pruebas de estrés de JMeter. La pega es que el acceso gratuito permite generar un volúmen de peticiones limitado.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_integración_continua_0_2_puntos">8.4.3. Integración continua (0.2 puntos)</h4>
<div class="paragraph">
<p>Esta vez vamos a trabajar sobre una aplicación Java EE 7 de ejemplo muy sencilla, pero sobre la que aplicaremos los distintos conceptos que hemos aprendido sobre integración continua y despliegue continuo. En este primer ejercicio se pide crear una nueva aplicación OpenShift denominada <em>bigbang</em> y desplegar sobre ella la aplicación de ejemplo, alojada en GitHub. Para ello eliminaremos los fuentes por defecto y haremos un _pull del siguiente repositorio de GitHub:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">git rm -rf src/ pom.xml</span>
<span class="tok-go">git commit . -m &quot;Eliminar aplicación de ejemplo &quot;</span>

<span class="tok-go">git remote add javaee7 https://github.com/Djbyte1977/bigbang.git</span>
<span class="tok-go">git pull javaee7 master</span>

<span class="tok-go">git push origin master</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Una vez desplegada la aplicación, comprobad que funciona correctamente. La aplicación expone un servicio REST del que podéis obtener una lista de personas o el nombre de una persona concreta preguntando por su id:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">http://[URL aplicación Openshift]/resources/persons</span>

<span class="tok-go">http://[URL aplicación Openshift]/resources/persons/id</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lo siguiente será habilitar integración continua para el proyecto y modificar la clase <em>PersonDatabase</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"> <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">init</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-n">persons</span> <span class="tok-o">=</span> <span class="tok-n">Arrays</span><span class="tok-o">.</span><span class="tok-na">asList</span><span class="tok-o">(</span>
	<span class="tok-k">new</span> <span class="tok-nf">Person</span><span class="tok-o">(</span><span class="tok-s">&quot;Penny&quot;</span><span class="tok-o">),</span>
	<span class="tok-k">new</span> <span class="tok-nf">Person</span><span class="tok-o">(</span><span class="tok-s">&quot;Leonard&quot;</span><span class="tok-o">),</span>
	<span class="tok-k">new</span> <span class="tok-nf">Person</span><span class="tok-o">(</span><span class="tok-s">&quot;Sheldon&quot;</span><span class="tok-o">),</span>
	<span class="tok-k">new</span> <span class="tok-nf">Person</span><span class="tok-o">(</span><span class="tok-s">&quot;Amy&quot;</span><span class="tok-o">),</span>
	<span class="tok-k">new</span> <span class="tok-nf">Person</span><span class="tok-o">(</span><span class="tok-s">&quot;Howard&quot;</span><span class="tok-o">),</span>
	<span class="tok-k">new</span> <span class="tok-nf">Person</span><span class="tok-o">(</span><span class="tok-s">&quot;Bernadette&quot;</span><span class="tok-o">),</span>
	<span class="tok-k">new</span> <span class="tok-nf">Person</span><span class="tok-o">(</span><span class="tok-s">&quot;Raj&quot;</span><span class="tok-o">),</span>
	<span class="tok-k">new</span> <span class="tok-nf">Person</span><span class="tok-o">(</span><span class="tok-s">&quot;Priya&quot;</span><span class="tok-o">),</span>

	<span class="tok-c1">// Añadir una persona a la lista</span>
	<span class="tok-k">new</span> <span class="tok-nf">Person</span><span class="tok-o">(</span><span class="tok-s">&quot;Stu&quot;</span><span class="tok-o">));</span>

    <span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por último, hacer un <em>push</em> del cambio y  verificar que la aplicación se compila primero en Jenkins antes de desplegarse. Ahora, cada vez que hagamos un push, la aplicación se compilará previamente, y si se produce algún fallo, el despliegue no se realizará, por tanto tenemos un nivel adicional de tolerancia ante fallos.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Si ejecutamos la compilación por primera vez, es posible que se produzca algún error de comuncaciones entre nuestra consola y el gear Builder. Normalmente esto es debido a que son instancias gratuitas y que el primer arranque es más costoso. Si lo intentáis por segunda vez os debe funcionar.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_pruebas_con_arquillian_0_4_puntos">8.4.4. Pruebas con Arquillian (0.4 puntos)</h4>
<div class="paragraph">
<p>El siguiente paso es incluir una serie de pruebas que nos garanticen no sólo que el código compila sino que el funcionamiento de la aplicación será el esperado. Para ello incorporaremos a la aplicación un par de casos de prueba implementados con <em>Arquillian</em>. Esta herramienta permite diseñar pruebas unitarias y pruebas integradas que se pueden ejecutar directamente sobre un servidor de aplicaciones, permitiendo realizar pruebas en condiciones muy cercanas a las del funcionamiento real que tendrá la aplicación.</p>
</div>
<div class="paragraph">
<p>Para dotar al proyecto de estas capacidades utilizaremos Forge dentro de la carpeta del proyecto.  Ejecutaremos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> forge

<span class="tok-go">[bigbang]$ addon-install-from-git --url https://github.com/forge/addon-arquillian.git</span>


<span class="tok-go">//Como Framework de pruebas elegid JUnit y elegir el contenedor que queráis utilizar.</span>
<span class="tok-go">[bigbang]$ arquillian-setup</span>

<span class="tok-go">[bigbang]$ arquillian-container-setup</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Forge no sólo se utiliza para crear nuevos proyectos sino que permite modificar proyectos ya existentes. En este caso hemos añadido un plugin a Forge para poder trabajar con Arquillian y hemos añadido a nuestra aplicación la configuración necesaria para utilizar distintos contenedores. Cada contenedor está especializado en interactuar con un tipo de servidor de aplicaciones, en distintas configuraciones. En el caso de WildFly tenemos:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">arquillian-wildfly-remote</dt>
<dd>
<p>Que trabaja contra un servidor WildFly que se esté ejecutando en una máquina, por defecto en localhost:8080</p>
</dd>
<dt class="hdlist1">arquillian-wildfly-managed</dt>
<dd>
<p>En este caso Arquillian se encarga de parar y arrancar el servidor y sólo debemos indicarle en qué carpeta se encuentra, bien a través de la variable de entorno <em>JBOSS_HOME</em> o bien en el fichero de configuración de arquillian (<em>arquillian.xml</em>).</p>
</dd>
</dl>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Por defecto estos plugins siempre van a trabaja contra la última versión de WildFly con lo que si la aplicación se ejecutará en una versión distinta, habría que modificarla en el fichero <em>pom.xml</em>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para trabajar con OpenShift la aproximación es diferente pues en principio no se puede iniciar un proceso servidor dentro de un gear fuera de los puertos autorizados. Por tanto no es sencillo el utilizar uno de los modos anteriores pues la instancia de WildFly no tendrá permisos para abrir los puertos que necesita para funcionar.</p>
</div>
<div class="paragraph">
<p>Por fortuna existe un contenedor específico para OpenShift, <strong>arquillian-openshift-express</strong>, que permite utilizar instancias de JBoss/WildFly ejecutadas dentro de un gear.</p>
</div>
<div class="paragraph">
<p>Como hemos seleccionado la opción de <em>openshift-express</em>, ya tenemos nuestro proyecto preparado con los perfiles adecuados para poder utilizarlo. Faltaría modificar el fichero <em>arquillian.xml</em> dentro de la carpeta de test/resources indicando sobre qué gear vamos a lanzar las pruebas. En nuestro caso, como sólo contamos con tres gear disponibles vamos a utilizar el mismo gear que el despliegue final.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
En condiciones de "producción" necesitaremos 4 gear: 2 para Jenkins, uno para el servidor de Test y otro para el servidor de producción.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Añadiremos la configuración del gear sobre el que vamos a probar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-c">&lt;!-- Datos de ejemplo, cambiar por los vuestros--&gt;</span>
 <span class="tok-nt">&lt;container</span> <span class="tok-na">qualifier=</span><span class="tok-s">&quot;arquillian-openshift-express&quot;</span><span class="tok-nt">&gt;</span>
     <span class="tok-nt">&lt;configuration&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;namespace&quot;</span><span class="tok-nt">&gt;</span>jlzamora<span class="tok-nt">&lt;/property&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;application&quot;</span><span class="tok-nt">&gt;</span>bigbang<span class="tok-nt">&lt;/property&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;libraDomain&quot;</span><span class="tok-nt">&gt;</span>rhcloud.com<span class="tok-nt">&lt;/property&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;sshUserName&quot;</span><span class="tok-nt">&gt;</span>5479d3685973ca8081000033<span class="tok-nt">&lt;/property&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;login&quot;</span><span class="tok-nt">&gt;</span>jl_msg@hotmail.com<span class="tok-nt">&lt;/property&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;deploymentTimeoutInSeconds&quot;</span><span class="tok-nt">&gt;</span>1000<span class="tok-nt">&lt;/property&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;disableStrictHostChecking&quot;</span><span class="tok-nt">&gt;</span>true<span class="tok-nt">&lt;/property&gt;</span>
        <span class="tok-nt">&lt;/configuration&gt;</span>
        <span class="tok-nt">&lt;/container&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
En lugar de indicar valores constantes, si vamos a ejecutar las pruebas desde jenkins podemos utilizar la sintaxis: ${env.NOMBRE_VARIABLE} para leer el valor de una variable de entorno.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>También es necesario hacer algunos cambios manualmente sobre el <em>pom.xml</em> por ¿fallo? de la versión 2.12 de Forge:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Añadir el repositorio de JBoss para poder descargar las últimas versiones de los plugin:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml">        <span class="tok-nt">&lt;repository&gt;</span>
            <span class="tok-nt">&lt;id&gt;</span>jboss-public-repository-group<span class="tok-nt">&lt;/id&gt;</span>
            <span class="tok-nt">&lt;name&gt;</span>JBoss Public Repository Group<span class="tok-nt">&lt;/name&gt;</span>
            <span class="tok-nt">&lt;url&gt;</span>http://repository.jboss.org/nexus/content/groups/public/<span class="tok-nt">&lt;/url&gt;</span>
            <span class="tok-nt">&lt;layout&gt;</span>default<span class="tok-nt">&lt;/layout&gt;</span>
            <span class="tok-nt">&lt;releases&gt;</span>
                <span class="tok-nt">&lt;enabled&gt;</span>true<span class="tok-nt">&lt;/enabled&gt;</span>
                <span class="tok-nt">&lt;updatePolicy&gt;</span>never<span class="tok-nt">&lt;/updatePolicy&gt;</span>
            <span class="tok-nt">&lt;/releases&gt;</span>
            <span class="tok-nt">&lt;snapshots&gt;</span>
                <span class="tok-nt">&lt;enabled&gt;</span>true<span class="tok-nt">&lt;/enabled&gt;</span>
                <span class="tok-nt">&lt;updatePolicy&gt;</span>never<span class="tok-nt">&lt;/updatePolicy&gt;</span>
            <span class="tok-nt">&lt;/snapshots&gt;</span>
        <span class="tok-nt">&lt;/repository&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Añadir dependencias para crear los clientes REST utilizados en las pruebas:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;dependency&gt;</span>
    <span class="tok-nt">&lt;groupId&gt;</span>org.jboss.resteasy<span class="tok-nt">&lt;/groupId&gt;</span>
    <span class="tok-nt">&lt;artifactId&gt;</span>resteasy-client<span class="tok-nt">&lt;/artifactId&gt;</span>
    <span class="tok-nt">&lt;version&gt;</span>3.0.10.Final<span class="tok-nt">&lt;/version&gt;</span>	<span class="tok-c">&lt;!--Sustituir por la versión que utilice WildFly  --&gt;</span>
    <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
<span class="tok-nt">&lt;/dependency&gt;</span>
<span class="tok-nt">&lt;dependency&gt;</span>
    <span class="tok-nt">&lt;groupId&gt;</span>org.jboss.resteasy<span class="tok-nt">&lt;/groupId&gt;</span>
    <span class="tok-nt">&lt;artifactId&gt;</span>resteasy-jaxb-provider<span class="tok-nt">&lt;/artifactId&gt;</span>
    <span class="tok-nt">&lt;version&gt;</span>3.0.10.Final<span class="tok-nt">&lt;/version&gt;</span>  <span class="tok-c">&lt;!--Sustituir por la versión que utilice WildFly  --&gt;</span>
    <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
<span class="tok-nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Además de incluir la configuración de Arquillian debéis incluir tambien algún caso de pruebas. En las plantillas de la sesión 8 encontraréis la clase <em>PersonTest.java</em> que define dos casos concretos para validar el servicio REST:</p>
</div>
<div class="paragraph">
<p>Esta es la parte concreta de los casos de prueba:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">testGetAll</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">Person</span><span class="tok-o">[]</span> <span class="tok-n">persons</span> <span class="tok-o">=</span> <span class="tok-n">target</span><span class="tok-o">.</span><span class="tok-na">request</span><span class="tok-o">().</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-n">Person</span><span class="tok-o">[].</span><span class="tok-na">class</span><span class="tok-o">);</span>
        <span class="tok-n">assertEquals</span><span class="tok-o">(</span><span class="tok-mi">8</span><span class="tok-o">,</span> <span class="tok-n">persons</span><span class="tok-o">.</span><span class="tok-na">length</span><span class="tok-o">);</span>

        <span class="tok-n">assertEquals</span><span class="tok-o">(</span><span class="tok-s">&quot;Penny&quot;</span><span class="tok-o">,</span> <span class="tok-n">persons</span><span class="tok-o">[</span><span class="tok-mi">0</span><span class="tok-o">].</span><span class="tok-na">getName</span><span class="tok-o">());</span>
        <span class="tok-n">assertEquals</span><span class="tok-o">(</span><span class="tok-s">&quot;Leonard&quot;</span><span class="tok-o">,</span> <span class="tok-n">persons</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">].</span><span class="tok-na">getName</span><span class="tok-o">());</span>
        <span class="tok-n">assertEquals</span><span class="tok-o">(</span><span class="tok-s">&quot;Sheldon&quot;</span><span class="tok-o">,</span> <span class="tok-n">persons</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">].</span><span class="tok-na">getName</span><span class="tok-o">());</span>
        <span class="tok-n">assertEquals</span><span class="tok-o">(</span><span class="tok-s">&quot;Amy&quot;</span><span class="tok-o">,</span> <span class="tok-n">persons</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">].</span><span class="tok-na">getName</span><span class="tok-o">());</span>
        <span class="tok-n">assertEquals</span><span class="tok-o">(</span><span class="tok-s">&quot;Howard&quot;</span><span class="tok-o">,</span> <span class="tok-n">persons</span><span class="tok-o">[</span><span class="tok-mi">4</span><span class="tok-o">].</span><span class="tok-na">getName</span><span class="tok-o">());</span>
        <span class="tok-n">assertEquals</span><span class="tok-o">(</span><span class="tok-s">&quot;Bernadette&quot;</span><span class="tok-o">,</span> <span class="tok-n">persons</span><span class="tok-o">[</span><span class="tok-mi">5</span><span class="tok-o">].</span><span class="tok-na">getName</span><span class="tok-o">());</span>
        <span class="tok-n">assertEquals</span><span class="tok-o">(</span><span class="tok-s">&quot;Raj&quot;</span><span class="tok-o">,</span> <span class="tok-n">persons</span><span class="tok-o">[</span><span class="tok-mi">6</span><span class="tok-o">].</span><span class="tok-na">getName</span><span class="tok-o">());</span>
        <span class="tok-n">assertEquals</span><span class="tok-o">(</span><span class="tok-s">&quot;Priya&quot;</span><span class="tok-o">,</span> <span class="tok-n">persons</span><span class="tok-o">[</span><span class="tok-mi">7</span><span class="tok-o">].</span><span class="tok-na">getName</span><span class="tok-o">());</span>
    <span class="tok-o">}</span>

    <span class="tok-cm">/**</span>
<span class="tok-cm">     * Test of get method, of class Person.</span>
<span class="tok-cm">     */</span>
    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">testGetOne</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">WebTarget</span> <span class="tok-n">target2</span> <span class="tok-o">=</span> <span class="tok-n">target</span><span class="tok-o">.</span><span class="tok-na">path</span><span class="tok-o">(</span><span class="tok-s">&quot;{id}&quot;</span><span class="tok-o">);</span>

        <span class="tok-n">Person</span> <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-n">target2</span><span class="tok-o">.</span><span class="tok-na">resolveTemplate</span><span class="tok-o">(</span><span class="tok-s">&quot;id&quot;</span><span class="tok-o">,</span> <span class="tok-mi">0</span><span class="tok-o">).</span><span class="tok-na">request</span><span class="tok-o">().</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-n">Person</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>
        <span class="tok-n">assertEquals</span><span class="tok-o">(</span><span class="tok-s">&quot;Penny&quot;</span><span class="tok-o">,</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getName</span><span class="tok-o">());</span>

        <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-n">target2</span><span class="tok-o">.</span><span class="tok-na">resolveTemplate</span><span class="tok-o">(</span><span class="tok-s">&quot;id&quot;</span><span class="tok-o">,</span> <span class="tok-mi">1</span><span class="tok-o">).</span><span class="tok-na">request</span><span class="tok-o">().</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-n">Person</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>
        <span class="tok-n">assertEquals</span><span class="tok-o">(</span><span class="tok-s">&quot;Leonard&quot;</span><span class="tok-o">,</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getName</span><span class="tok-o">());</span>
    <span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En este ejercicio se pide:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Ejecutar las pruebas utilizando los dos tipos de contenedores de Wildfly en local. Documentar en el fichero <em>soluciones.txt</em> los pasos realizados. Deben ejecutarse correctamente las pruebas pero alguna de ellas detectará un error en el código. Revisar los logs y corregirlo.</p>
</li>
<li>
<p>Desplegar la aplicación en OpenShift.</p>
</li>
<li>
<p>Desde la máquina local probar a ejecutar las pruebas contra la aplicación bigbang de OpenShift:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">mvn test -Parquillian-openshift-express</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La salida de esta ejecución se debe incluir en el fichero <em>soluciones.txt</em>.</p>
</div>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="_posibles_problemas">Posibles problemas</h5>
<div class="paragraph">
<p>A pesar de tener los pasos detallados, a la hora de ejecutar estos ejercicios os podéis encontrar  (entre otros) los siguientes problemas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Lentitud: Los gear gratuitos de OpenShift son muy lentos y tienen una memoria limitada. Las pruebas con Arquillian son pesadas y en estas condiciones tardan bastante en ejecutarse. Dado que los gear se ejecutan en la costa este de EEUU, tenemos el problema añadido de que por la noche son todavía más lentos.</p>
</li>
<li>
<p>Desconexiones de los builder  (excepción hudson.remoting.RequestAbortedException: java.io.IOException: Unexpected termination of the channel). Al lanzar tareas en Jenkins es posible que el gear builder se desconecte del servidor de Jenkins. Se puede solucionar accediendo a la configuración de los nodos, pulsar sobre el builder y a continuación pinchar en el botón "Lanzar agente esclavo" que se muestra para reconectar, cuando hemos perdido la conexión.</p>
</li>
<li>
<p>Errores de ejecución en las pruebas: Las pruebas pueden mostrar un error 500 y en este caso habría que ir al log del servidor para obtener más información. Es posible que si no hemos incluido correctamente las dependencias de Resteasy (la implementación REST de JBoss/Wildfly) las pruebas fallen al no poder crear el cliente REST.</p>
</li>
<li>
<p>Parar a mitad las pruebas con Arquillian. Si interrumpís alguna prueba, podéis hacer un pull del repositorio, borrar los ficheros temporales de la carpeta <em>deployments</em> y volver a hacer un push al servidor para dejarlo en la situación original.</p>
</li>
<li>
<p>Para más información podéis consultar el enlace <a href="http://blog.arungupta.me/2014/11/deployment-pipeline-javaee7-wildfly-arquillian-openshift-jenkins-techtip56/" class="bare">http://blog.arungupta.me/2014/11/deployment-pipeline-javaee7-wildfly-arquillian-openshift-jenkins-techtip56/</a>  pero si probáis el ejemplo que se expone tal cual está, no va a funcionar en WildFly 8.2. Es necesario modificar la clase PersonDatabase y cambiar la anotación @Singleton por @ApplicationScope para que el servidor pueda inyectar correctamente el bean.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_entrega_7">8.4.5. Entrega</h4>
<div class="paragraph">
<p>En esta sesión hay que presentar una copia del repositorio <em>bigbang</em> eliminando la configuración de git como ya hemos hecho en sesiones anteriores y una serie de ficheros:
* Los ficheros 1gear.txt y 2gear.txt del segundo ejercicio.
* El Log del balanceador HAProxy: haproxy_ctld.log.
* Recoger en el fichero de <em>soluciones.txt</em> los pasos necesarios para lanzar las pruebas de arquillian y el log de compilación de las pruebas contra OpenShift.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2015-10-16 22:32:33 CEST
</div>
</div>
</body>
</html>