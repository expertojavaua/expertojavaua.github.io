<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.2">
<meta name="author" content="María Isabel Alfonso, Domingo Gallardo, Alejandro Such, Jose Luis Zamora">
<title>Proyecto de Aplicación Web</title>
<style>/*! normalize.css v2.1.2 | MIT License | git.io/normalize */
/* ========================================================================== HTML5 display definitions ========================================================================== */
/** Correct `block` display not defined in IE 8/9. */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }

/** Correct `inline-block` display not defined in IE 8/9. */
audio, canvas, video { display: inline-block; }

/** Prevent modern browsers from displaying `audio` without controls. Remove excess height in iOS 5 devices. */
audio:not([controls]) { display: none; height: 0; }

/** Address `[hidden]` styling not present in IE 8/9. Hide the `template` element in IE, Safari, and Firefox < 22. */
[hidden], template { display: none; }

script { display: none !important; }

/* ========================================================================== Base ========================================================================== */
/** 1. Set default font family to sans-serif. 2. Prevent iOS text size adjust after orientation change, without disabling user zoom. */
html { font-family: sans-serif; /* 1 */ -ms-text-size-adjust: 100%; /* 2 */ -webkit-text-size-adjust: 100%; /* 2 */ }

/** Remove default margin. */
body { margin: 0; }

/* ========================================================================== Links ========================================================================== */
/** Remove the gray background color from active links in IE 10. */
a { background: transparent; }

/** Address `outline` inconsistency between Chrome and other browsers. */
a:focus { outline: thin dotted; }

/** Improve readability when focused and also mouse hovered in all browsers. */
a:active, a:hover { outline: 0; }

/* ========================================================================== Typography ========================================================================== */
/** Address variable `h1` font-size and margin within `section` and `article` contexts in Firefox 4+, Safari 5, and Chrome. */
h1 { font-size: 2em; margin: 0.67em 0; }

/** Address styling not present in IE 8/9, Safari 5, and Chrome. */
abbr[title] { border-bottom: 1px dotted; }

/** Address style set to `bolder` in Firefox 4+, Safari 5, and Chrome. */
b, strong { font-weight: bold; }

/** Address styling not present in Safari 5 and Chrome. */
dfn { font-style: italic; }

/** Address differences between Firefox and other browsers. */
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }

/** Address styling not present in IE 8/9. */
mark { background: #ff0; color: #000; }

/** Correct font family set oddly in Safari 5 and Chrome. */
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }

/** Improve readability of pre-formatted text in all browsers. */
pre { white-space: pre-wrap; }

/** Set consistent quote types. */
q { quotes: "\201C" "\201D" "\2018" "\2019"; }

/** Address inconsistent and variable font size in all browsers. */
small { font-size: 80%; }

/** Prevent `sub` and `sup` affecting `line-height` in all browsers. */
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }

sup { top: -0.5em; }

sub { bottom: -0.25em; }

/* ========================================================================== Embedded content ========================================================================== */
/** Remove border when inside `a` element in IE 8/9. */
img { border: 0; }

/** Correct overflow displayed oddly in IE 9. */
svg:not(:root) { overflow: hidden; }

/* ========================================================================== Figures ========================================================================== */
/** Address margin not present in IE 8/9 and Safari 5. */
figure { margin: 0; }

/* ========================================================================== Forms ========================================================================== */
/** Define consistent border, margin, and padding. */
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }

/** 1. Correct `color` not being inherited in IE 8/9. 2. Remove padding so people aren't caught out if they zero out fieldsets. */
legend { border: 0; /* 1 */ padding: 0; /* 2 */ }

/** 1. Correct font family not being inherited in all browsers. 2. Correct font size not being inherited in all browsers. 3. Address margins set differently in Firefox 4+, Safari 5, and Chrome. */
button, input, select, textarea { font-family: inherit; /* 1 */ font-size: 100%; /* 2 */ margin: 0; /* 3 */ }

/** Address Firefox 4+ setting `line-height` on `input` using `!important` in the UA stylesheet. */
button, input { line-height: normal; }

/** Address inconsistent `text-transform` inheritance for `button` and `select`. All other form control elements do not inherit `text-transform` values. Correct `button` style inheritance in Chrome, Safari 5+, and IE 8+. Correct `select` style inheritance in Firefox 4+ and Opera. */
button, select { text-transform: none; }

/** 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio` and `video` controls. 2. Correct inability to style clickable `input` types in iOS. 3. Improve usability and consistency of cursor style between image-type `input` and others. */
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; /* 2 */ cursor: pointer; /* 3 */ }

/** Re-set default cursor for disabled elements. */
button[disabled], html input[disabled] { cursor: default; }

/** 1. Address box sizing set to `content-box` in IE 8/9. 2. Remove excess padding in IE 8/9. */
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; /* 1 */ padding: 0; /* 2 */ }

/** 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome. 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome (include `-moz` to future-proof). */
input[type="search"] { -webkit-appearance: textfield; /* 1 */ -moz-box-sizing: content-box; -webkit-box-sizing: content-box; /* 2 */ box-sizing: content-box; }

/** Remove inner padding and search cancel button in Safari 5 and Chrome on OS X. */
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }

/** Remove inner padding and border in Firefox 4+. */
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }

/** 1. Remove default vertical scrollbar in IE 8/9. 2. Improve readability and alignment in all browsers. */
textarea { overflow: auto; /* 1 */ vertical-align: top; /* 2 */ }

/* ========================================================================== Tables ========================================================================== */
/** Remove most spacing between table cells. */
table { border-collapse: collapse; border-spacing: 0; }

meta.foundation-mq-small { font-family: "only screen and (min-width: 768px)"; width: 768px; }

meta.foundation-mq-medium { font-family: "only screen and (min-width:1280px)"; width: 1280px; }

meta.foundation-mq-large { font-family: "only screen and (min-width:1440px)"; width: 1440px; }

*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }

html, body { font-size: 97%; }

body { background: white; color: #222222; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }

a:hover { cursor: pointer; }

img, object, embed { max-width: 100%; height: auto; }

object, embed { height: 100%; }

img { -ms-interpolation-mode: bicubic; }

#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }

.left { float: left !important; }

.right { float: right !important; }

.text-left { text-align: left !important; }

.text-right { text-align: right !important; }

.text-center { text-align: center !important; }

.text-justify { text-align: justify !important; }

.hide { display: none; }

.antialiased, body { -webkit-font-smoothing: antialiased; }

img { display: inline-block; vertical-align: middle; }

textarea { height: auto; min-height: 50px; }

select { width: 100%; }

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }

.subheader, .admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { line-height: 1.4; color: #6f6f6f; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }

/* Typography resets */
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }

/* Default Link Styles */
a { color: #1164be; text-decoration: none; line-height: inherit; }
a img { border: none; }

/* Default paragraph styles */
p { font-family: inherit; font-weight: normal; font-size: 1em; line-height: 1.4; margin-bottom: 1em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }

/* Default header styles */
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: bold; font-style: normal; color: #1c355e; text-rendering: optimizeLegibility; margin-top: 1em; margin-bottom: 0.5em; line-height: 1.2125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #6f6f6f; line-height: 0; }

h1 { font-size: 2.125em; }

h2 { font-size: 1.6875em; }

h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }

h4 { font-size: 1.125em; }

h5 { font-size: 1.125em; }

h6 { font-size: 1em; }

hr { border: solid #dddddd; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }

/* Helpful Typography Defaults */
em, i { font-style: italic; line-height: inherit; }

strong, b { font-weight: bold; line-height: inherit; }

small { font-size: 60%; line-height: inherit; }

code { font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: bold; }

/* Lists */
ul, ol, dl { font-size: 1em; line-height: 1.4; margin-bottom: 1.25em; list-style-position: outside; font-family: inherit; }

ul, ol { margin-left: 2.5em; }
ul.no-bullet, ol.no-bullet { margin-left: 1.5em; }

/* Unordered Lists */
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; /* Override nested font-size change */ }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }

/* Ordered Lists */
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }

/* Definition Lists */
dl dt { margin-bottom: 0.3125em; font-weight: bold; }
dl dd { margin-bottom: 1.25em; }

/* Abbreviations */
abbr, acronym { text-transform: uppercase; font-size: 90%; color: #222222; border-bottom: 1px dotted #dddddd; cursor: help; }

abbr { text-transform: none; }

/* Blockquotes */
blockquote { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
blockquote cite { display: block; font-size: 0.8125em; color: #555555; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #555555; }

blockquote, blockquote p { line-height: 1.6; color: #6f6f6f; }

/* Microformats */
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #dddddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }

.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }

/*@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.6875em; }
  h4 { font-size: 1.4375em; } }*/
/* Tables */
table { background: white; margin-bottom: 1.25em; border: solid 1px #dddddd; }
table thead, table tfoot { background: whitesmoke; font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: #222222; text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: #222222; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #f9f9f9; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.4; }

h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; border-bottom: 1px solid #dddddd }

.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }

*:not(pre) > code { font-size: inherit; font-style: normal !important; letter-spacing: 0; padding: 3px 2px 1px 2px; background-color: #eeeeee; border: 1px solid #dddddd; -webkit-border-radius: 0; border-radius: 0; line-height: inherit; font-weight: normal; }

pre, pre > code { line-height: 1.4; color: black; font-family: monospace, serif; font-weight: normal; }

.keyseq { color: #555555; }

kbd { display: inline-block; color: #222222; font-size: 0.75em; line-height: 1.4; background-color: #f7f7f7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; margin: -0.15em 0.15em 0 0.15em; padding: 0.2em 0.6em 0.2em 0.5em; vertical-align: middle; white-space: nowrap; }

.keyseq kbd:first-child { margin-left: 0; }

.keyseq kbd:last-child { margin-right: 0; }

.menuseq, .menu { color: #090909; }

b.button:before, b.button:after { position: relative; top: -1px; font-weight: normal; }

b.button:before { content: "["; padding: 0 3px 0 2px; }

b.button:after { content: "]"; padding: 0 2px 0 3px; }

#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 0.9375em; padding-right: 0.9375em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }

#content { margin-top: 1.25em; }

#content:before { content: none; }

#header > h1:first-child { color: black; margin-top: 2.25rem; margin-bottom: 0; }
#header > h1:first-child + #toc { margin-top: 8px; border-top: 1px solid #dddddd; }
#header > h1:only-child, body.toc2 #header > h1:nth-last-child(2) { border-bottom: 1px solid #dddddd; padding-bottom: 8px; }
#header .details { border-bottom: 1px solid #dddddd; line-height: 1.45; padding-top: 0.25em; padding-bottom: 0.25em; padding-left: 0.25em; color: #555555; display: -ms-flexbox; display: -webkit-flex; display: flex; -ms-flex-flow: row wrap; -webkit-flex-flow: row wrap; flex-flow: row wrap; }
#header .details span:first-child { margin-left: -0.125em; }
#header .details span.email a { color: #6f6f6f; }
#header .details br { display: none; }
#header .details br + span:before { content: "\00a0\2013\00a0"; }
#header .details br + span.author:before { content: "\00a0\22c5\00a0"; color: #6f6f6f; }
#header .details br + span#revremark:before { content: "\00a0|\00a0"; }
#header #revnumber { text-transform: capitalize; }
#header #revnumber:after { content: "\00a0"; }

#content > h1:first-child:not([class]) { color: black; border-bottom: 1px solid #dddddd; padding-bottom: 8px; margin-top: 0; padding-top: 1rem; margin-bottom: 1.25rem; }

#floating {
  position: fixed;
  z-index: 1000;
  padding: 0.5em;
  right: 0;
  top: 0;
  background: white;
  box-shadow: 0 0 1em #777777;
  -webkit-box-shadow: 0 0 1em #777777;
  -moz-box-shadow: 0 0 1em #777777;
  -webkit-border-bottom-left-radius: 5px;
  -moz-border-radius-bottomleft: 5px;
  max-height: 80%;
  overflow: auto;
}

#floating #full { display: none; } /* Hide the full TOC by default */

#floating:hover #full{
  display: block; /* Show it on hover */
}


#toc { border-bottom: 1px solid #dddddd; padding-bottom: 0.5em; }
#toc > ul { margin-left: 0.125em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin: 0.5em 0; }
#toc ul { font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; list-style-type: none; }
#toc a { text-decoration: none; }
#toc a:active { text-decoration: underline; }

#toctitle { color: #6f6f6f; font-size: 1.2em; }

@media only screen and (min-width: 768px) { #toctitle { font-size: 1.375em; }
  body.toc2 { padding-left: 15em; padding-right: 0; }
  #toc.toc2 { margin-top: 0 !important; background-color: #f2f2f2; position: fixed; width: 15em; left: 0; top: 0; border-right: 1px solid #dddddd; border-top-width: 0 !important; border-bottom-width: 0 !important; z-index: 1000; padding: 1.25em 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; font-size: 1.2em; }
  #toc.toc2 > ul { font-size: 0.9em; margin-bottom: 0; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 15em; }
  body.toc2.toc-right #toc.toc2 { border-right-width: 0; border-left: 1px solid #dddddd; left: auto; right: 0; } }
@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; padding-right: 0; }
  #toc.toc2 { width: 20em; }
  #toc.toc2 #toctitle { font-size: 1.375em; }
  #toc.toc2 > ul { font-size: 0.95em; }
  #toc.toc2 ul ul { padding-left: 1.25em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; } }
#content #toc { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 0; border-radius: 0; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }

#footer { max-width: 100%; background-color: #222222; padding: 1.25em; }

#footer-text { color: #dddddd; line-height: 1.44; }

.sect1 { padding-bottom: 0.625em; }

@media only screen and (min-width: 768px) { .sect1 { padding-bottom: 1.25em; } }
.sect1 + .sect1 { border-top: 1px solid #dddddd; }

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; z-index: 1001; width: 1.5ex; margin-left: -1.5ex; display: block; text-decoration: none !important; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: "\00A7"; font-size: 0.85em; display: block; padding-top: 0.1em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #222222; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #151515; }

.audioblock, .imageblock, .literalblock, .listingblock, .stemblock, .videoblock { margin-bottom: 1.25em; }

.admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-rendering: optimizeLegibility; text-align: left; }

table.tableblock > caption.title { white-space: nowrap; overflow: visible; max-width: 0; }

.paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { color: black; }

table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }

.admonitionblock > table { border-collapse: separate; border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #dddddd; color: #555555; }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }

.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 0; border-radius: 0; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }

.sidebarblock { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 0; border-radius: 0; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock > .content > .title { color: #6f6f6f; margin-top: 0; }

.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }

.literalblock pre, .listingblock pre:not(.highlight), .listingblock pre[class="highlight"], .listingblock pre[class^="highlight "], .listingblock pre.CodeRay, .listingblock pre.prettyprint { background: #eeeeee; }
.sidebarblock .literalblock pre, .sidebarblock .listingblock pre:not(.highlight), .sidebarblock .listingblock pre[class="highlight"], .sidebarblock .listingblock pre[class^="highlight "], .sidebarblock .listingblock pre.CodeRay, .sidebarblock .listingblock pre.prettyprint { background: #f2f1f1; }

.literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { border: 1px solid #cccccc; -webkit-border-radius: 0; border-radius: 0; word-wrap: break-word; padding: 0.8em 0.8em 0.65em 0.8em; font-size: 0.8125em; }
.literalblock pre.nowrap, .literalblock pre[class].nowrap, .listingblock pre.nowrap, .listingblock pre[class].nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
@media only screen and (min-width: 768px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 0.90625em; } }
@media only screen and (min-width: 1280px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 1em; } }

.literalblock.output pre { color: #eeeeee; background-color: black; }

.listingblock pre.highlightjs { padding: 0; }
.listingblock pre.highlightjs > code { padding: 0.8em 0.8em 0.65em 0.8em; -webkit-border-radius: 0; border-radius: 0; }

.listingblock > .content { position: relative; }

.listingblock code[data-lang]:before { display: none; content: attr(data-lang); position: absolute; font-size: 0.75em; top: 0.425rem; right: 0.5rem; line-height: 1; text-transform: uppercase; color: #999; }

.listingblock:hover code[data-lang]:before { display: block; }

.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }

.listingblock.terminal pre .command:not([data-prompt]):before { content: "$"; }

table.pyhltable { border-collapse: separate; border: 0; margin-bottom: 0; background: none; }

table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; }

table.pyhltable td.code { padding-left: .75em; padding-right: 0; }

pre.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #dddddd; }

pre.pygments .lineno { display: inline-block; margin-right: .25em; }

table.pyhltable .linenodiv { background: none !important; padding-right: 0 !important; }

.quoteblock { margin: 0 1em 1.25em 1.5em; display: table; }
.quoteblock > .title { margin-left: -1.5em; margin-bottom: 0.75em; }
.quoteblock blockquote, .quoteblock blockquote p { color: #6f6f6f; font-size: 1.15rem; line-height: 1.75; word-spacing: 0.1em; letter-spacing: 0; font-style: italic; text-align: justify; }
.quoteblock blockquote { margin: 0; padding: 0; border: 0; }
.quoteblock blockquote:before { content: "\201c"; float: left; font-size: 2.75em; font-weight: bold; line-height: 0.6em; margin-left: -0.6em; color: #6f6f6f; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: 0.5em; margin-right: 0.5ex; text-align: right; }
.quoteblock .quoteblock { margin-left: 0; margin-right: 0; padding: 0.5em 0; border-left: 3px solid #555555; }
.quoteblock .quoteblock blockquote { padding: 0 0 0 0.75em; }
.quoteblock .quoteblock blockquote:before { display: none; }

.verseblock { margin: 0 1em 1.25em 1em; }
.verseblock pre { font-family: "Open Sans", "DejaVu Sans", sans; font-size: 1.15rem; color: #6f6f6f; font-weight: 300; text-rendering: optimizeLegibility; }
.verseblock pre strong { font-weight: 400; }
.verseblock .attribution { margin-top: 1.25rem; margin-left: 0.5ex; }

.quoteblock .attribution, .verseblock .attribution { font-size: 0.8125em; line-height: 1.45; font-style: italic; }
.quoteblock .attribution br, .verseblock .attribution br { display: none; }
.quoteblock .attribution cite, .verseblock .attribution cite { display: block; letter-spacing: -0.05em; color: #555555; }

.quoteblock.abstract { margin: 0 0 1.25em 0; display: block; }
.quoteblock.abstract blockquote, .quoteblock.abstract blockquote p { text-align: left; word-spacing: 0; }
.quoteblock.abstract blockquote:before, .quoteblock.abstract blockquote p:first-of-type:before { display: none; }

table.tableblock { max-width: 100%; border-collapse: separate; }
table.tableblock td > .paragraph:last-child p > p:last-child, table.tableblock th > p:last-child, table.tableblock td > p:last-child { margin-bottom: 0; }

table.spread { width: 100%; }

table.tableblock, th.tableblock, td.tableblock { border: 0 solid #dddddd; }

table.grid-all th.tableblock, table.grid-all td.tableblock { border-width: 0 1px 1px 0; }

table.grid-all tfoot > tr > th.tableblock, table.grid-all tfoot > tr > td.tableblock { border-width: 1px 1px 0 0; }

table.grid-cols th.tableblock, table.grid-cols td.tableblock { border-width: 0 1px 0 0; }

table.grid-all * > tr > .tableblock:last-child, table.grid-cols * > tr > .tableblock:last-child { border-right-width: 0; }

table.grid-rows th.tableblock, table.grid-rows td.tableblock { border-width: 0 0 1px 0; }

table.grid-all tbody > tr:last-child > th.tableblock, table.grid-all tbody > tr:last-child > td.tableblock, table.grid-all thead:last-child > tr > th.tableblock, table.grid-rows tbody > tr:last-child > th.tableblock, table.grid-rows tbody > tr:last-child > td.tableblock, table.grid-rows thead:last-child > tr > th.tableblock { border-bottom-width: 0; }

table.grid-rows tfoot > tr > th.tableblock, table.grid-rows tfoot > tr > td.tableblock { border-width: 1px 0 0 0; }

table.frame-all { border-width: 1px; }

table.frame-sides { border-width: 0 1px; }

table.frame-topbot { border-width: 1px 0; }

th.halign-left, td.halign-left { text-align: left; }

th.halign-right, td.halign-right { text-align: right; }

th.halign-center, td.halign-center { text-align: center; }

th.valign-top, td.valign-top { vertical-align: top; }

th.valign-bottom, td.valign-bottom { vertical-align: bottom; }

th.valign-middle, td.valign-middle { vertical-align: middle; }

table thead th, table tfoot th { font-weight: bold; }

tbody tr th { display: table-cell; line-height: 1.4; background: whitesmoke; }

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p { color: #222222; font-weight: bold; }

p.tableblock > code:only-child { background: none; padding: 0; }

p.tableblock { font-size: 1em; }

td > div.verse { white-space: pre; }

ol { margin-left: 2.5em; }

ul li ol { margin-left: 1.5em; }

dl dd { margin-left: 1.125em; }

dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }

ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.625em; }

ul.unstyled, ol.unnumbered, ul.checklist, ul.none { list-style-type: none; }

ul.unstyled, ol.unnumbered, ul.checklist { margin-left: 0.625em; }

ul.checklist li > p:first-child > .fa-check-square-o:first-child, ul.checklist li > p:first-child > input[type="checkbox"]:first-child { margin-right: 0.25em; }

ul.checklist li > p:first-child > input[type="checkbox"]:first-child { position: relative; top: 1px; }

ul.inline { margin: 0 auto 0.625em auto; margin-left: -1.375em; margin-right: 0; padding: 0; list-style: none; overflow: hidden; }
ul.inline > li { list-style: none; float: left; margin-left: 1.375em; display: block; }
ul.inline > li > * { display: block; }

.unstyled dl dt { font-weight: normal; font-style: normal; }

ol.arabic { list-style-type: decimal; }

ol.decimal { list-style-type: decimal-leading-zero; }

ol.loweralpha { list-style-type: lower-alpha; }

ol.upperalpha { list-style-type: upper-alpha; }

ol.lowerroman { list-style-type: lower-roman; }

ol.upperroman { list-style-type: upper-roman; }

ol.lowergreek { list-style-type: lower-greek; }

.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }

td.hdlist1 { padding-right: .75em; font-weight: bold; }

td.hdlist1, td.hdlist2 { vertical-align: top; }

.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }

.colist > table tr > td:first-of-type { padding: 0 0.75em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.25em 0; }

.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: 0 0 0 1px #dddddd; box-shadow: 0 0 0 1px #dddddd; }

.imageblock.left, .imageblock[style*="float: left"] { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }

.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }

a.image { text-decoration: none; }

span.footnote, span.footnoteref { vertical-align: super; font-size: 0.875em; }
span.footnote a, span.footnoteref a { text-decoration: none; }
span.footnote a:active, span.footnoteref a:active { text-decoration: underline; }

#footnotes { padding-top: 0.75em; padding-bottom: 0.75em; margin-bottom: 0.625em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -.25em 0 .75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.375em; line-height: 1.3; font-size: 0.875em; margin-left: 1.2em; text-indent: -1.2em; margin-bottom: .2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }

#content #footnotes { margin-top: -0.625em; margin-bottom: 0; padding: 0.75em 0; }

.gist .file-data > table { border: 0; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }

div.unbreakable { page-break-inside: avoid; }

.big { font-size: larger; }

.small { font-size: smaller; }

.underline { text-decoration: underline; }

.overline { text-decoration: overline; }

.line-through { text-decoration: line-through; }

.aqua { color: #00bfbf; }

.aqua-background { background-color: #00fafa; }

.black { color: black; }

.black-background { background-color: black; }

.blue { color: #0000bf; }

.blue-background { background-color: #0000fa; }

.fuchsia { color: #bf00bf; }

.fuchsia-background { background-color: #fa00fa; }

.gray { color: #606060; }

.gray-background { background-color: #7d7d7d; }

.green { color: #006000; }

.green-background { background-color: #007d00; }

.lime { color: #00bf00; }

.lime-background { background-color: #00fa00; }

.maroon { color: #600000; }

.maroon-background { background-color: #7d0000; }

.navy { color: #000060; }

.navy-background { background-color: #00007d; }

.olive { color: #606000; }

.olive-background { background-color: #7d7d00; }

.purple { color: #600060; }

.purple-background { background-color: #7d007d; }

.red { color: #bf0000; }

.red-background { background-color: #fa0000; }

.silver { color: #909090; }

.silver-background { background-color: #bcbcbc; }

.teal { color: #006060; }

.teal-background { background-color: #007d7d; }

.white { color: #bfbfbf; }

.white-background { background-color: #fafafa; }

.yellow { color: #bfbf00; }

.yellow-background { background-color: #fafa00; }

span.icon > .fa { cursor: default; }

.admonitionblock td.icon [class^="fa icon-"] { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #207c98; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }

.conum[data-value] { display: inline-block; color: #fff !important; background-color: #222222; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; font-size: 0.75em; width: 1.67em; height: 1.67em; line-height: 1.67em; font-family: "Open Sans", "DejaVu Sans", sans-serif; font-style: normal; font-weight: bold; }
.conum[data-value] * { color: #fff !important; }
.conum[data-value] + b { display: none; }
.conum[data-value]:after { content: attr(data-value); }
pre .conum[data-value] { position: relative; top: -0.125em; }

b.conum * { color: inherit !important; }

.conum:not([data-value]):empty { display: none; }

.literalblock pre, .listingblock pre { background: #eeeeee; }

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.min.css">
<style>.listingblock .pygments .hll { background-color: #ffffcc }
.listingblock .pygments  { background: #f8f8f8; }
.listingblock .pygments .tok-c { color: #408080; font-style: italic } /* Comment */
.listingblock .pygments .tok-err { border: 1px solid #FF0000 } /* Error */
.listingblock .pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
.listingblock .pygments .tok-o { color: #666666 } /* Operator */
.listingblock .pygments .tok-cm { color: #408080; font-style: italic } /* Comment.Multiline */
.listingblock .pygments .tok-cp { color: #BC7A00 } /* Comment.Preproc */
.listingblock .pygments .tok-c1 { color: #408080; font-style: italic } /* Comment.Single */
.listingblock .pygments .tok-cs { color: #408080; font-style: italic } /* Comment.Special */
.listingblock .pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
.listingblock .pygments .tok-ge { font-style: italic } /* Generic.Emph */
.listingblock .pygments .tok-gr { color: #FF0000 } /* Generic.Error */
.listingblock .pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
.listingblock .pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
.listingblock .pygments .tok-go { color: #888888 } /* Generic.Output */
.listingblock .pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.listingblock .pygments .tok-gs { font-weight: bold } /* Generic.Strong */
.listingblock .pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.listingblock .pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
.listingblock .pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.listingblock .pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.listingblock .pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.listingblock .pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
.listingblock .pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.listingblock .pygments .tok-kt { color: #B00040 } /* Keyword.Type */
.listingblock .pygments .tok-m { color: #666666 } /* Literal.Number */
.listingblock .pygments .tok-s { color: #BA2121 } /* Literal.String */
.listingblock .pygments .tok-na { color: #7D9029 } /* Name.Attribute */
.listingblock .pygments .tok-nb { color: #008000 } /* Name.Builtin */
.listingblock .pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
.listingblock .pygments .tok-no { color: #880000 } /* Name.Constant */
.listingblock .pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
.listingblock .pygments .tok-ni { color: #999999; font-weight: bold } /* Name.Entity */
.listingblock .pygments .tok-ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.listingblock .pygments .tok-nf { color: #0000FF } /* Name.Function */
.listingblock .pygments .tok-nl { color: #A0A000 } /* Name.Label */
.listingblock .pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.listingblock .pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
.listingblock .pygments .tok-nv { color: #19177C } /* Name.Variable */
.listingblock .pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.listingblock .pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
.listingblock .pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
.listingblock .pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
.listingblock .pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
.listingblock .pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
.listingblock .pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
.listingblock .pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
.listingblock .pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
.listingblock .pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.listingblock .pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
.listingblock .pygments .tok-se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.listingblock .pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
.listingblock .pygments .tok-si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.listingblock .pygments .tok-sx { color: #008000 } /* Literal.String.Other */
.listingblock .pygments .tok-sr { color: #BB6688 } /* Literal.String.Regex */
.listingblock .pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
.listingblock .pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
.listingblock .pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
.listingblock .pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
.listingblock .pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
.listingblock .pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
.listingblock .pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Proyecto de Aplicación Web</h1>
<div class="details">
<span id="author" class="author">María Isabel Alfonso</span><br>
<span id="email" class="email"><a href="mailto:eli@ua.es">eli@ua.es</a></span><br>
<span id="author2" class="author">Domingo Gallardo</span><br>
<span id="email2" class="email"><a href="mailto:domingo.gallardo@ua.es">domingo.gallardo@ua.es</a></span><br>
<span id="author3" class="author">Alejandro Such</span><br>
<span id="email3" class="email"><a href="mailto:alejandro.such@ua.es">alejandro.such@ua.es</a></span><br>
<span id="author4" class="author">Jose Luis Zamora</span><br>
<span id="email4" class="email"><a href="mailto:joseluis.zamora@ua.es">joseluis.zamora@ua.es</a></span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Índice de contenidos</div>
<ul class="sectlevel1">
<li><a href="#sesion02">3. (2,5 puntos) Capa de persistencia y capa de negocio</a>
<ul class="sectlevel2">
<li><a href="#_api_del_servicio">3.1. API del servicio</a></li>
<li><a href="#_iteraci%C3%B3n_1">3.2. Iteración 1</a>
<ul class="sectlevel3">
<li><a href="#_capa_de_persistencia">3.2.1. Capa de persistencia</a></li>
<li><a href="#_capa_de_l%C3%B3gica_de_negocio">3.2.2. Capa de lógica de negocio</a></li>
<li><a href="#_clase_de_servicio">3.2.3. Clase de servicio</a></li>
<li><a href="#_prueba_desde_un_servlet">3.2.4. Prueba desde un servlet</a></li>
<li><a href="#_prueba_desde_arquillian">3.2.5. Prueba desde Arquillian</a></li>
</ul>
</li>
<li><a href="#_resto_de_la_sesi%C3%B3n">3.3. Resto de la sesión</a>
<ul class="sectlevel3">
<li><a href="#_funcionalidades">3.3.1. Funcionalidades</a></li>
<li><a href="#_ejemplos_de_pruebas">3.3.2. Ejemplos de pruebas</a></li>
</ul>
</li>
<li><a href="#_entrega">3.4. Entrega</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="sesion02">3. (2,5 puntos) Capa de persistencia y capa de negocio</h2>
<div class="sectionbody">
<div class="paragraph">
<p>En esta segunda sesión del proyecto web, una vez definidas las clases de modelo de la biblioteca, vamos a desarrollar la capa de persistencia de la aplicación usando JPA y clases DAO y la capa de métodos de negocio utilizando beans gestionados CDIs.</p>
</div>
<div class="paragraph">
<p>Recordemos que el objetivo de la aplicación es gestionar una biblioteca de un centro educativo y proporcionar distintas funcionalidades a los usuarios de la biblioteca y a sus bibliotecarios.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Una modificación que hay realizar en el proyecto resultante de la fase anterior: hay que eliminar los atributos <code>nEjemplares</code> y <code>nEjemplaresDisponibles</code> las clases <code>Libro</code>. Así se independiza totalmente el <em>agregado</em> <code>Libro</code> y <code>Recomendacion</code> del <em>agregado</em> <code>Usuario</code>, <code>Multa</code>, <code>Prestamo</code> y <code>Ejemplar</code>. También eran campos redundantes: el número de ejemplares totales y disponibles los podemos obtener mediante una consulta a la entidad <code>Ejemplar</code>. El diagrama de clases resultante se muestra en la siguiente figura.
</td>
</tr>
</table>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint02/diagrama-clases.png" alt="" width="66%">
</div>
</div>
<div class="sect2">
<h3 id="_api_del_servicio">3.1. API del servicio</h3>
<div class="paragraph">
<p>Es conveniente remarcar que el objetivo final del desarrollo de la parte del servidor es proporcionar todas las funcionalidades de la aplicación en forma de API RESTful, que implementaremos en la sesión 3.</p>
</div>
<div class="paragraph">
<p>En concreto, las funcionalidades que vamos a proporcionar son las siguientes, agrupadas por la restricción de acceso. La autentificación y la restricción de acceso la implementaremos también en la sesión 3.</p>
</div>
<div class="paragraph">
<p><strong>Operaciones restringidas a usuarios</strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Obtener información actual de un usuario: se pasa el <em>login del usuario</em> y se obtienen sus datos.</p>
</li>
<li>
<p>Obener lista de préstamos de un usuario: se pasa el <em>identificador del usuario</em> y se devuelve la colección de préstamos que tiene prestados.</p>
</li>
<li>
<p>Obtener lista de libros de un usuario: se pasa el <em>identificador del usuario</em> y se devuelve la colección de libros que tiene prestados.</p>
</li>
<li>
<p>Solicitar un préstamo de un libro: se pasa el <em>identificador del usuario</em> y el <em>identificador del libro</em> y se realiza el préstamo de un ejemplar si el ejemplar está disponible. Se lanza un error si no hay ejemplares disponibles, si el usuario está multado o si supera el número de préstamos permitidos. Si se ha realizado el préstamo con éxito se devuelve el nuevo préstamo.</p>
</li>
<li>
<p>Realizar la devolución de un ejemplar: se pasa el <em>identificador de usuario</em> y el <em>identificador de ejemplar</em>, se crea un préstamo histórico con sus datos (y se elimina el préstamo activo). Por último, se crea una multa si la devolución está fuera de plazo. Se devuelve un enumerado con el resultado de la devolución: <code>DEVOLUCIÓN_CORRECTA</code> o <code>DEVOLUCIÓN_FUERA_DE_PLAZO</code>.
entidades asociado, si lo hubiera)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Operaciones no restringidas</strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Listado de libros: se devuelve la lista de todos los libros</p>
</li>
<li>
<p>Búsqueda de libros por autor: se pasa una cadena de texto y se devuelve la lista de libros que tienen un autor cuyo nombre contiene esa cadena de texto</p>
</li>
<li>
<p>Búsqueda de libros por título: se pasa una cadena de texto y se devuelve la lista de libros cuyo título contiene esa cadena de texto</p>
</li>
<li>
<p>Búsqueda de libro por identificador: se pasa el <em>identificador del libro</em> y se devuelven los detalles del libro</p>
</li>
<li>
<p>Búsqueda de libro por <em>ISBN</em>: se pasa el <em>ISBN del libro</em> y se devuelven los detalles del libro con ese ISBN</p>
</li>
<li>
<p>Libros recomendados: se pasa el <em>identificador del libro</em> y un número <em>n</em> de recomendaciones deseadas. Se devuelve la lista de, como máximo, <em>n</em> recomendaciones asociadas al libro inicial.</p>
</li>
<li>
<p>Número ejemplares de un libro: se pasa el <em>identificador del libro</em> y se devuelve el número de ejemplares totales de ese libro.</p>
</li>
<li>
<p>Número ejemplares disponibles: se pasa el <em>identificador del libro</em> y se devuelve el número de ejemplares disponibles de ese libro.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Vamos a centrar el desarrollo de la capa de servicios y de persistencia en estas funcionalidades utilizando:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Entidades JPA con anotaciones y <em>Bean Validation</em></p>
</li>
<li>
<p>Capa de DAOs sobre las entidades con el CRUD y las búsquedas de la entidad</p>
</li>
<li>
<p>Capa de servicios con <em>beans gestionados</em> y CDIs</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Realizaremos también un número considerable de pruebas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Pruebas con DbUnit de las entidades</p>
</li>
<li>
<p>Pruebas con Arquillian de los DAO y la capa de servicio</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Vamos a realizar una primera iteración guiada en la que implementaremos algunas de las funcionalidades relacionadas con libros. Después deberás implementar el resto de funcionalidades.</p>
</div>
</div>
<div class="sect2">
<h3 id="_iteración_1">3.2. Iteración 1</h3>
<div class="paragraph">
<p>En esta primera iteración vamos a implementar las dos funcionalidades:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Listado de libros: se devuelve la lista de todos los libros</p>
</li>
<li>
<p>Libros recomendados: se pasa el <em>identificador del libro</em> y un número <em>n</em> de recomendaciones deseadas. Se devuelve la lista de esos <em>n</em> libros que más se han prestado junto con el libro inicial.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_capa_de_persistencia">3.2.1. Capa de persistencia</h4>
<div class="paragraph">
<p>En la capa de persistencia tenemos que convertir las clases de modelo en entidades, utilizando las anotaciones JPA y <em>bean validation</em> necesarias. Crearemos también las clases DAO que encapsulan las operaciones sobre estas entidades.</p>
</div>
<div class="sect4">
<h5 id="_creación_de_la_base_de_datos">Creación de la base de datos</h5>
<div class="paragraph">
<p>Antes de empezar a trabajar con el código debemos crear la base de datos <code>biblioteca</code> en nuestro ordenador y la fuente de datos <code>BibliotecaDS</code> en nuestro servidor WildFly en donde vamos a hacer las pruebas.</p>
</div>
<div class="paragraph">
<p>Para crear la base de datos desde IntelliJ utiliza el panel <em>Database</em> situado en el lateral derecho:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Abre el panel <em>Database</em> en la parte derecha.</p>
</li>
<li>
<p>Crea una nueva conexión con la base de datos MySQL con la opción <em>+ &gt; Data Source &gt; MySQL</em></p>
</li>
<li>
<p>Inicializa los parámetros de la conexión, sólo tienes que indicar el usuario <code>root</code> y la contraseña <code>expertojava</code>. Aparecerá también un aviso indicando que no está descargado el driver de acceso a MySQL, pincha el enlace y lo descargará e instalará.</p>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint02/intellij-datasources.png" alt="" width="100%">
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Una vez configurada la conexión, vamos a utilizarla para crear la base de datos <code>biblioteca</code>. En el panel de base de datos podremos ver un desplegable con las bases de datos existentes. Para crear la nueva base de datos abre la consola SQL pulsando el icono correspondiente del panel de base de datos:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint02/panel-base-datos.png" alt="" width="50%">
</div>
</div>
<div class="paragraph">
<p>Y ejecuta el comando:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-k">CREATE</span> <span class="tok-k">DATABASE</span> <span class="tok-n">biblioteca</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Verás que se ha creado una base de datos con ese nombre bajo las ya existentes por defecto en MySQL.</p>
</div>
<div class="paragraph">
<p>Otra forma de crear la base de datos es hacerlo desde línea de comando:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash session"><span class="tok-gp">$</span> <span class="tok-nb">echo</span> <span class="tok-s2">&quot;CREATE DATABASE biblioteca&quot;</span> &gt; create.sql
<span class="tok-gp">$</span> mysql -u root -p<span class="tok-s2">&quot;expertojava&quot;</span> &lt; create.sql</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_configuración_de_la_fuente_de_datos_mysql_en_wildfly">Configuración de la fuente de datos MySQL en WildFly</h5>
<div class="paragraph">
<p>Recuerda que para trabajar con JPA en una aplicación web el acceso a la base de datos hay que hacerlo a través de una <strong>fuente de datos</strong> creada y gestionada por el servidor de aplicaciones.</p>
</div>
<div class="paragraph">
<p>Vamos a ver cómo configurar una fuente de datos MySQL en WildFly. Algunos de los pasos siguientes no serán necesarios si estás trabajando con el mismo servidor de aplicaciones con el que has hecho los módulos de JPA o de Componentes EJB. Los incluimos por completitud, por si estás trabajando con un servidor recién instalado.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>En primer lugar localiza el driver MySQL <code>mysql-connector-java-5.1.33.jar</code> (lo puedes encontrar en el repositorio local de Maven <code>.m2/repository/mysql/mysql-connector-java/5.1.33/</code></p>
</li>
<li>
<p>Conéctate a la consola de administración de WildFly y selecciona la opción <em>Runtime &gt; Manage Deployments &gt; Add</em> y añade el JAR. Ponle como nombre <em>mysql_connector</em> (no es importante)</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint02/datasource01.png" alt="" width="50%">
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Pulsa en el botón <em>En/Disable</em> para activar el driver</p>
</li>
<li>
<p>En <em>Configuration &gt; Connector &gt; Datasources &gt; XA DATASOURCES</em> tenemos que crear una nueva fuente de datos. Pulsa el botón <em>Add</em> e introduce los siguientes nombres:</p>
<div class="ulist">
<ul>
<li>
<p><em>Name</em>: <code>BibliotecaDS</code></p>
</li>
<li>
<p><em>JNDI Name</em>: <code>java:/datasources/BibliotecaDS</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Selecciona el driver que acabamos de añadir y escribe como nombre de clase XA DataSource: <code>com.mysql.jdbc.jdbc2.optional.MysqlXADataSource</code>:</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint02/datasource03.png" alt="" width="50%">
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Añade la propiedad <code>URL</code> y el valor <code>jdbc:mysql://localhost:3306/biblioteca</code></p>
</li>
<li>
<p>Y en la última pantalla define el usuario y la contraseña de la conexión</p>
<div class="ulist">
<ul>
<li>
<p><em>Username</em>: <code>root</code></p>
</li>
<li>
<p><em>Password</em>: <code>expertojava</code></p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Y prueba la conexión pulsando el botón.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Por último activamos la fuente de datos:</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/proyint02/datasource04.png" alt="" width="66%">
</div>
</div>
</div>
<div class="sect4">
<h5 id="_configuración_de_jpa">Configuración de JPA</h5>
<div class="paragraph">
<p>Vamos a añadir al proyecto la configuración JPA:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Dependencias en el POM</p>
</li>
<li>
<p>Fichero <code>persistence.xml</code> en la configuración de ejecución</p>
</li>
<li>
<p>Fichero <code>persistence.xml</code> en la configuración de test</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Empezamos con el POM de Maven. Hay que añadir al fichero <code>pom.xml</code> las dependencias relacionadas con Hibernate y DbUnit, para poder ejecutar los tests. El fichero completo es el siguiente:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tok-nt">&lt;project</span> <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="tok-na">xmlns:xsi=</span><span class="tok-s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="tok-na">xsi:schemaLocation=</span><span class="tok-s">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;modelVersion&gt;</span>4.0.0<span class="tok-nt">&lt;/modelVersion&gt;</span>

    <span class="tok-nt">&lt;groupId&gt;</span>org.expertojava<span class="tok-nt">&lt;/groupId&gt;</span>
    <span class="tok-nt">&lt;artifactId&gt;</span>jbib-rest<span class="tok-nt">&lt;/artifactId&gt;</span>
    <span class="tok-nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="tok-nt">&lt;/version&gt;</span>
    <span class="tok-nt">&lt;packaging&gt;</span>war<span class="tok-nt">&lt;/packaging&gt;</span>

    <span class="tok-nt">&lt;name&gt;</span>jbib-rest<span class="tok-nt">&lt;/name&gt;</span>

    <span class="tok-nt">&lt;properties&gt;</span>
        <span class="tok-nt">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span class="tok-nt">&lt;/project.build.sourceEncoding&gt;</span>
    <span class="tok-nt">&lt;/properties&gt;</span>

    <span class="tok-nt">&lt;dependencies&gt;</span>
        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>javax<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>javaee-web-api<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>7.0<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>provided<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-c">&lt;!-- Añadimos el scope provided para que no de error el</span>
<span class="tok-c">        elemento provider del persistence.xml de runtime --&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.hibernate<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>hibernate-entitymanager<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>4.3.7.Final<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test,provided<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-c">&lt;!-- Tests --&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>junit<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>junit<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>4.11<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-c">&lt;!-- Logging --&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>commons-logging<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>commons-logging<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>1.2<span class="tok-nt">&lt;/version&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>log4j<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>log4j<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>1.2.17<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.slf4j<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>slf4j-simple<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>1.7.12<span class="tok-nt">&lt;/version&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-c">&lt;!-- JPA --&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.dbunit<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>dbunit<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>2.5.0<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>mysql<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>5.1.33<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.hibernate.javax.persistence<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>hibernate-jpa-2.1-api<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>1.0.0.Final<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.slf4j<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>slf4j-api<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>1.7.7<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-c">&lt;!-- Hibernate validator --&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.hibernate<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>hibernate-validator<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>5.1.3.Final<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>javax.el<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>javax.el-api<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>2.2.4<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.glassfish.web<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>el-impl<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>2.2<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

    <span class="tok-nt">&lt;/dependencies&gt;</span>

    <span class="tok-nt">&lt;build&gt;</span>
        <span class="tok-nt">&lt;finalName&gt;</span>${project.name}<span class="tok-nt">&lt;/finalName&gt;</span>
        <span class="tok-nt">&lt;plugins&gt;</span>
            <span class="tok-nt">&lt;plugin&gt;</span>
                <span class="tok-nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="tok-nt">&lt;/groupId&gt;</span>
                <span class="tok-nt">&lt;artifactId&gt;</span>maven-compiler-plugin<span class="tok-nt">&lt;/artifactId&gt;</span>
                <span class="tok-nt">&lt;version&gt;</span>3.1<span class="tok-nt">&lt;/version&gt;</span>
                <span class="tok-nt">&lt;configuration&gt;</span>
                    <span class="tok-nt">&lt;source&gt;</span>1.7<span class="tok-nt">&lt;/source&gt;</span>
                    <span class="tok-nt">&lt;target&gt;</span>1.7<span class="tok-nt">&lt;/target&gt;</span>
                <span class="tok-nt">&lt;/configuration&gt;</span>
            <span class="tok-nt">&lt;/plugin&gt;</span>
            <span class="tok-nt">&lt;plugin&gt;</span>
                <span class="tok-nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="tok-nt">&lt;/groupId&gt;</span>
                <span class="tok-nt">&lt;artifactId&gt;</span>maven-war-plugin<span class="tok-nt">&lt;/artifactId&gt;</span>
                <span class="tok-nt">&lt;version&gt;</span>2.3<span class="tok-nt">&lt;/version&gt;</span>
                <span class="tok-nt">&lt;configuration&gt;</span>
                    <span class="tok-nt">&lt;failOnMissingWebXml&gt;</span>false<span class="tok-nt">&lt;/failOnMissingWebXml&gt;</span>
                <span class="tok-nt">&lt;/configuration&gt;</span>
            <span class="tok-nt">&lt;/plugin&gt;</span>
            <span class="tok-nt">&lt;plugin&gt;</span>
                <span class="tok-nt">&lt;groupId&gt;</span>org.wildfly.plugins<span class="tok-nt">&lt;/groupId&gt;</span>
                <span class="tok-nt">&lt;artifactId&gt;</span>wildfly-maven-plugin<span class="tok-nt">&lt;/artifactId&gt;</span>
                <span class="tok-nt">&lt;version&gt;</span>1.0.2.Final<span class="tok-nt">&lt;/version&gt;</span>
                <span class="tok-nt">&lt;configuration&gt;</span>
                    <span class="tok-nt">&lt;hostname&gt;</span>localhost<span class="tok-nt">&lt;/hostname&gt;</span>
                    <span class="tok-nt">&lt;port&gt;</span>9990<span class="tok-nt">&lt;/port&gt;</span>
                <span class="tok-nt">&lt;/configuration&gt;</span>
            <span class="tok-nt">&lt;/plugin&gt;</span>
        <span class="tok-nt">&lt;/plugins&gt;</span>
    <span class="tok-nt">&lt;/build&gt;</span>

<span class="tok-nt">&lt;/project&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En el fichero <code>src/main/resources/META-INF/persistence.xml</code> definimos la configuración de JPA y definimos la unidad de persistencia <code>biblioteca</code>.</p>
</div>
<div class="paragraph">
<p>Incluimos la declaración de las clases de entidad que vamos a implementar en esta primera iteración.</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/persistence.xml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tok-nt">&lt;persistence</span> <span class="tok-na">version=</span><span class="tok-s">&quot;2.0&quot;</span>
             <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://java.sun.com/xml/ns/persistence&quot;</span> <span class="tok-na">xmlns:xsi=</span><span class="tok-s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
             <span class="tok-na">xsi:schemaLocation=</span><span class="tok-s">&quot;</span>
<span class="tok-s">        http://java.sun.com/xml/ns/persistence</span>
<span class="tok-s">        http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;persistence-unit</span> <span class="tok-na">name=</span><span class="tok-s">&quot;biblioteca-datasource&quot;</span><span class="tok-nt">&gt;</span>

        <span class="tok-nt">&lt;provider&gt;</span>org.hibernate.jpa.HibernatePersistenceProvider<span class="tok-nt">&lt;/provider&gt;</span>

        <span class="tok-nt">&lt;jta-data-source&gt;</span>java:/datasources/BibliotecaDS<span class="tok-nt">&lt;/jta-data-source&gt;</span>

        <span class="tok-nt">&lt;class&gt;</span>org.expertojava.jbibrest.modelo.Libro<span class="tok-nt">&lt;/class&gt;</span>
        <span class="tok-nt">&lt;class&gt;</span>org.expertojava.jbibrest.modelo.Recomendacion<span class="tok-nt">&lt;/class&gt;</span>

        <span class="tok-nt">&lt;properties&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.id.new_generator_mappings&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;false&quot;</span><span class="tok-nt">/&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.dialect&quot;</span>
                      <span class="tok-na">value=</span><span class="tok-s">&quot;org.hibernate.dialect.MySQLDialect&quot;</span><span class="tok-nt">/&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.hbm2ddl.auto&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;update&quot;</span> <span class="tok-nt">/&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.show_sql&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;true&quot;</span> <span class="tok-nt">/&gt;</span>
        <span class="tok-nt">&lt;/properties&gt;</span>
    <span class="tok-nt">&lt;/persistence-unit&gt;</span>
<span class="tok-nt">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y en la configuración de test añadimos la configuración de JPA que se va a utilizar para lanzar las pruebas. El fichero es <code>src/test/resources/META-INF/persistence.xml</code></p>
</div>
<div class="listingblock">
<div class="title">src/test/resources/META-INF/persistence.xml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-nt">&lt;persistence</span> <span class="tok-na">version=</span><span class="tok-s">&quot;2.1&quot;</span>
             <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://xmlns.jcp.org/xml/ns/persistence&quot;</span>
             <span class="tok-na">xmlns:xsi=</span><span class="tok-s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
             <span class="tok-na">xsi:schemaLocation=</span><span class="tok-s">&quot;http://xmlns.jcp.org/xml/ns/persistence&quot;</span><span class="tok-nt">&gt;</span>

    <span class="tok-nt">&lt;persistence-unit</span> <span class="tok-na">name=</span><span class="tok-s">&quot;biblioteca-local&quot;</span>
                      <span class="tok-na">transaction-type=</span><span class="tok-s">&quot;RESOURCE_LOCAL&quot;</span><span class="tok-nt">&gt;</span>

        <span class="tok-nt">&lt;provider&gt;</span>org.hibernate.jpa.HibernatePersistenceProvider<span class="tok-nt">&lt;/provider&gt;</span>

        <span class="tok-nt">&lt;class&gt;</span>org.expertojava.jbibrest.modelo.Libro<span class="tok-nt">&lt;/class&gt;</span>
        <span class="tok-nt">&lt;class&gt;</span>org.expertojava.jbibrest.modelo.Recomendacion<span class="tok-nt">&lt;/class&gt;</span>

        <span class="tok-nt">&lt;properties&gt;</span>

            <span class="tok-c">&lt;!-- JPA properties --&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;javax.persistence.jdbc.driver&quot;</span>
                      <span class="tok-na">value=</span><span class="tok-s">&quot;com.mysql.jdbc.Driver&quot;</span><span class="tok-nt">/&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;javax.persistence.jdbc.url&quot;</span>
                      <span class="tok-na">value=</span><span class="tok-s">&quot;jdbc:mysql://localhost:3306/biblioteca&quot;</span><span class="tok-nt">/&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;javax.persistence.jdbc.user&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;root&quot;</span><span class="tok-nt">/&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;javax.persistence.jdbc.password&quot;</span>
                      <span class="tok-na">value=</span><span class="tok-s">&quot;expertojava&quot;</span><span class="tok-nt">/&gt;</span>

            <span class="tok-c">&lt;!-- Hibernate properties --&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.dialect&quot;</span>
                      <span class="tok-na">value=</span><span class="tok-s">&quot;org.hibernate.dialect.MySQLDialect&quot;</span><span class="tok-nt">/&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.show_sql&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;true&quot;</span><span class="tok-nt">/&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.format_sql&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;false&quot;</span><span class="tok-nt">/&gt;</span>

            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.hbm2ddl.auto&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;create&quot;</span><span class="tok-nt">/&gt;</span>
        <span class="tok-nt">&lt;/properties&gt;</span>
    <span class="tok-nt">&lt;/persistence-unit&gt;</span>
<span class="tok-nt">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_clases_de_entidades">Clases de entidades</h5>
<div class="paragraph">
<p>Vamos ahora a modificar un pequeño conjunto de clases del modelo, añadiendo las anotaciones necesarias para convertirlas en clases de entidad JPA. En concreto, las clases son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Libro</code></p>
</li>
<li>
<p><code>Recomendacion</code></p>
</li>
<li>
<p><code>ClaseDominio</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Añadiremos anotaciones JPA y anotaciones <em>Bean Validation</em>.</p>
</div>
<div class="paragraph">
<p>La clase <code>ClaseDominio</code> es la superclase de todas las entidades, en donde se define la clave primaria y los métodos <code>equals</code> y <code>hashCode</code> basados en esa clave primaria. Debemos añadir la anotación <code>@MappedSuperclass</code> para indicar a JPA que incluya sus atributos en todas las clases hijas. Además, añadimos las anotaciones relacionadas con la clave primaria.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/expertojava/jbibrest/modelo/ClaseDominio.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">modelo</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.GeneratedValue</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.Id</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.MappedSuperclass</span><span class="tok-o">;</span>

<span class="tok-nd">@MappedSuperclass</span>
<span class="tok-kd">public</span> <span class="tok-kd">abstract</span> <span class="tok-kd">class</span> <span class="tok-nc">ClaseDominio</span> <span class="tok-o">{</span>
    <span class="tok-nd">@Id</span>
    <span class="tok-nd">@GeneratedValue</span>
    <span class="tok-kd">private</span> <span class="tok-n">Long</span> <span class="tok-n">id</span><span class="tok-o">;</span>

    <span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">setId</span><span class="tok-o">(</span><span class="tok-n">Long</span> <span class="tok-n">id</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">id</span> <span class="tok-o">=</span> <span class="tok-n">id</span><span class="tok-o">;</span> <span class="tok-o">}</span>
    <span class="tok-kd">public</span> <span class="tok-n">Long</span> <span class="tok-nf">getId</span><span class="tok-o">()</span> <span class="tok-o">{</span> <span class="tok-k">return</span> <span class="tok-n">id</span><span class="tok-o">;}</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-kt">boolean</span> <span class="tok-nf">equals</span><span class="tok-o">(</span><span class="tok-n">Object</span> <span class="tok-n">o</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-k">this</span> <span class="tok-o">==</span> <span class="tok-n">o</span><span class="tok-o">)</span> <span class="tok-k">return</span> <span class="tok-kc">true</span><span class="tok-o">;</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">o</span> <span class="tok-o">==</span> <span class="tok-kc">null</span> <span class="tok-o">||</span> <span class="tok-n">getClass</span><span class="tok-o">()</span> <span class="tok-o">!=</span> <span class="tok-n">o</span><span class="tok-o">.</span><span class="tok-na">getClass</span><span class="tok-o">())</span> <span class="tok-k">return</span> <span class="tok-kc">false</span><span class="tok-o">;</span>

        <span class="tok-n">ClaseDominio</span> <span class="tok-n">that</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-n">ClaseDominio</span><span class="tok-o">)</span> <span class="tok-n">o</span><span class="tok-o">;</span>

        <span class="tok-k">return</span> <span class="tok-o">!(</span><span class="tok-n">id</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span> <span class="tok-o">?</span> <span class="tok-o">!</span><span class="tok-n">id</span><span class="tok-o">.</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">that</span><span class="tok-o">.</span><span class="tok-na">id</span><span class="tok-o">)</span> <span class="tok-o">:</span> <span class="tok-n">that</span><span class="tok-o">.</span><span class="tok-na">id</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">);</span>

    <span class="tok-o">}</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-kt">int</span> <span class="tok-nf">hashCode</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">id</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span> <span class="tok-o">?</span> <span class="tok-n">id</span><span class="tok-o">.</span><span class="tok-na">hashCode</span><span class="tok-o">()</span> <span class="tok-o">:</span> <span class="tok-mi">0</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Listamos a continuación las otras clases.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/expertojava/jbibrest/modelo/Libro.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">modelo</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.apache.commons.logging.Log</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.apache.commons.logging.LogFactory</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.Column</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.Entity</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.FetchType</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.OneToMany</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.validation.constraints.Min</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.validation.constraints.NotNull</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.HashSet</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.Set</span><span class="tok-o">;</span>

<span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Libro</span> <span class="tok-kd">extends</span> <span class="tok-n">ClaseDominio</span> <span class="tok-o">{</span>
    <span class="tok-nd">@NotNull</span>
    <span class="tok-nd">@Column</span><span class="tok-o">(</span><span class="tok-n">unique</span><span class="tok-o">=</span><span class="tok-kc">true</span><span class="tok-o">,</span> <span class="tok-n">nullable</span> <span class="tok-o">=</span> <span class="tok-kc">false</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">isbn</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">autor</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">titulo</span><span class="tok-o">;</span>
    <span class="tok-nd">@Min</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">Integer</span> <span class="tok-n">numPaginas</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">portadaURI</span><span class="tok-o">;</span>
    <span class="tok-nd">@OneToMany</span><span class="tok-o">(</span><span class="tok-n">mappedBy</span> <span class="tok-o">=</span> <span class="tok-s">&quot;libro&quot;</span><span class="tok-o">,</span> <span class="tok-n">fetch</span> <span class="tok-o">=</span> <span class="tok-n">FetchType</span><span class="tok-o">.</span><span class="tok-na">EAGER</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Recomendacion</span><span class="tok-o">&gt;</span> <span class="tok-n">recomendaciones</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">HashSet</span><span class="tok-o">&lt;</span><span class="tok-n">Recomendacion</span><span class="tok-o">&gt;();</span>

    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">Log</span> <span class="tok-n">logger</span> <span class="tok-o">=</span> <span class="tok-n">LogFactory</span><span class="tok-o">.</span><span class="tok-na">getLog</span><span class="tok-o">(</span><span class="tok-n">Libro</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>

    <span class="tok-kd">public</span> <span class="tok-nf">Libro</span><span class="tok-o">()</span> <span class="tok-o">{}</span>

    <span class="tok-kd">public</span> <span class="tok-nf">Libro</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">isbn</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">isbn</span> <span class="tok-o">=</span> <span class="tok-n">isbn</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getIsbn</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">isbn</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setIsbn</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">isbn</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">isbn</span> <span class="tok-o">=</span> <span class="tok-n">isbn</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getAutor</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">autor</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setAutor</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">autor</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">autor</span> <span class="tok-o">=</span> <span class="tok-n">autor</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getTitulo</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">titulo</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setTitulo</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">titulo</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">titulo</span> <span class="tok-o">=</span> <span class="tok-n">titulo</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">Integer</span> <span class="tok-nf">getNumPaginas</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">numPaginas</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setNumPaginas</span><span class="tok-o">(</span><span class="tok-n">Integer</span> <span class="tok-n">numPaginas</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">numPaginas</span> <span class="tok-o">=</span> <span class="tok-n">numPaginas</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getPortadaURI</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">portadaURI</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setPortadaURI</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">portadaURI</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">portadaURI</span> <span class="tok-o">=</span> <span class="tok-n">portadaURI</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">Recomendacion</span><span class="tok-o">&gt;</span> <span class="tok-nf">getRecomendaciones</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">recomendaciones</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-c1">// Actualización de la relación a-muchos recomendaciones</span>
    <span class="tok-c1">// No hay que actualizar la relación inversa, porque</span>
    <span class="tok-c1">// estamos haciendo una inicialización, no un cambio, y la</span>
    <span class="tok-c1">// recomendación ya está creada con el libro</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">añadeRecomendacion</span><span class="tok-o">(</span><span class="tok-n">Recomendacion</span> <span class="tok-n">recomendacion</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">getRecomendaciones</span><span class="tok-o">().</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-n">recomendacion</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">toString</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-s">&quot;Libro{&quot;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;id=&quot;</span> <span class="tok-o">+</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">getId</span><span class="tok-o">()</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, isbn=&#39;&quot;</span> <span class="tok-o">+</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">getIsbn</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-sc">&#39;\&#39;&#39;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, autor=&#39;&quot;</span> <span class="tok-o">+</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">getAutor</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-sc">&#39;\&#39;&#39;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, titulo=&#39;&quot;</span> <span class="tok-o">+</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">getTitulo</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-sc">&#39;\&#39;&#39;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, numPaginas=&quot;</span> <span class="tok-o">+</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">getNumPaginas</span><span class="tok-o">()</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;, portadaURI=&#39;&quot;</span> <span class="tok-o">+</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">getPortadaURI</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-sc">&#39;\&#39;&#39;</span> <span class="tok-o">+</span>
                <span class="tok-sc">&#39;}&#39;</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/expertojava/jbibrest/modelo/Recomendacion.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">modelo</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.apache.commons.logging.Log</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.apache.commons.logging.LogFactory</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.validation.constraints.NotNull</span><span class="tok-o">;</span>

<span class="tok-nd">@Entity</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">Recomendacion</span> <span class="tok-kd">extends</span> <span class="tok-n">ClaseDominio</span> <span class="tok-o">{</span>
    <span class="tok-nd">@NotNull</span>
    <span class="tok-nd">@ManyToOne</span>
    <span class="tok-nd">@JoinColumn</span><span class="tok-o">(</span><span class="tok-n">nullable</span> <span class="tok-o">=</span> <span class="tok-kc">false</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">Libro</span> <span class="tok-n">libro</span><span class="tok-o">;</span>
    <span class="tok-nd">@NotNull</span>
    <span class="tok-nd">@OneToOne</span>
    <span class="tok-nd">@JoinColumn</span><span class="tok-o">(</span><span class="tok-n">nullable</span> <span class="tok-o">=</span> <span class="tok-kc">false</span><span class="tok-o">)</span>
    <span class="tok-kd">private</span> <span class="tok-n">Libro</span> <span class="tok-n">libroRelacionado</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-n">String</span> <span class="tok-n">comentario</span><span class="tok-o">;</span>

    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">Log</span> <span class="tok-n">logger</span> <span class="tok-o">=</span> <span class="tok-n">LogFactory</span><span class="tok-o">.</span><span class="tok-na">getLog</span><span class="tok-o">(</span><span class="tok-n">Recomendacion</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>

    <span class="tok-kd">public</span> <span class="tok-nf">Recomendacion</span><span class="tok-o">()</span> <span class="tok-o">{}</span>

    <span class="tok-kd">public</span> <span class="tok-nf">Recomendacion</span><span class="tok-o">(</span><span class="tok-n">Libro</span> <span class="tok-n">libro</span><span class="tok-o">,</span> <span class="tok-n">Libro</span> <span class="tok-n">libroRelacionado</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">String</span> <span class="tok-n">msg</span><span class="tok-o">;</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">libro</span> <span class="tok-o">==</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">msg</span> <span class="tok-o">=</span> <span class="tok-s">&quot;Error al crear recomendación: libro null&quot;</span><span class="tok-o">;</span>
            <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-na">error</span><span class="tok-o">(</span><span class="tok-n">msg</span><span class="tok-o">);</span>
            <span class="tok-k">throw</span> <span class="tok-k">new</span> <span class="tok-nf">IllegalArgumentException</span><span class="tok-o">(</span><span class="tok-n">msg</span><span class="tok-o">);</span>
        <span class="tok-o">}</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">libroRelacionado</span> <span class="tok-o">==</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">msg</span> <span class="tok-o">=</span> <span class="tok-s">&quot;Error al crear recomendación: libroRelacionado null&quot;</span><span class="tok-o">;</span>
            <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-na">error</span><span class="tok-o">(</span><span class="tok-n">msg</span><span class="tok-o">);</span>
            <span class="tok-k">throw</span> <span class="tok-k">new</span> <span class="tok-nf">IllegalArgumentException</span><span class="tok-o">(</span><span class="tok-n">msg</span><span class="tok-o">);</span>
        <span class="tok-o">}</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">libro</span> <span class="tok-o">=</span> <span class="tok-n">libro</span><span class="tok-o">;</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">libroRelacionado</span> <span class="tok-o">=</span> <span class="tok-n">libroRelacionado</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">Libro</span> <span class="tok-nf">getLibro</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">libro</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">Libro</span> <span class="tok-nf">getLibroRelacionado</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">libroRelacionado</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setLibroRelacionado</span><span class="tok-o">(</span><span class="tok-n">Libro</span> <span class="tok-n">libroRelacionado</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">libroRelacionado</span> <span class="tok-o">=</span> <span class="tok-n">libroRelacionado</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">String</span> <span class="tok-nf">getComentario</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">comentario</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setComentario</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">comentario</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">comentario</span> <span class="tok-o">=</span> <span class="tok-n">comentario</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_pruebas_con_dbunit">Pruebas con DbUnit</h5>
<div class="paragraph">
<p>Vamos a probar estas dos primeras entidades utilizando DbUnit. Empezamos por crear el fichero <code>src/test/resources/dbunit/dataset1.xml</code> con un conjunto de datos de prueba.</p>
</div>
<div class="listingblock">
<div class="title">src/test/resources/dbunit/dataset1.xml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;?xml version=&#39;1.0&#39; encoding=&#39;UTF-8&#39;?&gt;</span>
<span class="tok-nt">&lt;dataset&gt;</span>
    <span class="tok-nt">&lt;Libro</span> <span class="tok-na">id=</span><span class="tok-s">&quot;1&quot;</span> <span class="tok-na">titulo=</span><span class="tok-s">&quot;Patterns Of Enterprise Application Architecture&quot;</span>
           <span class="tok-na">autor=</span><span class="tok-s">&quot;Martin Fowler&quot;</span> <span class="tok-na">isbn=</span><span class="tok-s">&quot;0321127420&quot;</span> <span class="tok-na">numPaginas=</span><span class="tok-s">&quot;533&quot;</span> <span class="tok-na">portadaURI=</span><span class="tok-s">&quot;0321127420.jpg&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;Libro</span> <span class="tok-na">id=</span><span class="tok-s">&quot;2&quot;</span> <span class="tok-na">titulo=</span><span class="tok-s">&quot;Clean Code&quot;</span> <span class="tok-na">autor=</span><span class="tok-s">&quot;Robert C. Martin&quot;</span>
           <span class="tok-na">isbn=</span><span class="tok-s">&quot;0132350882&quot;</span> <span class="tok-na">numPaginas=</span><span class="tok-s">&quot;288&quot;</span> <span class="tok-na">portadaURI=</span><span class="tok-s">&quot;0132350882.jpg&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;Libro</span> <span class="tok-na">id=</span><span class="tok-s">&quot;3&quot;</span> <span class="tok-na">titulo=</span><span class="tok-s">&quot;Test Driven Development&quot;</span> <span class="tok-na">autor=</span><span class="tok-s">&quot;Kent Beck&quot;</span>
           <span class="tok-na">isbn=</span><span class="tok-s">&quot;0321146530&quot;</span> <span class="tok-na">numPaginas=</span><span class="tok-s">&quot;192&quot;</span> <span class="tok-na">portadaURI=</span><span class="tok-s">&quot;0321146530.jpg&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;Libro</span> <span class="tok-na">id=</span><span class="tok-s">&quot;4&quot;</span> <span class="tok-na">titulo=</span><span class="tok-s">&quot;Extreme Programming Explained&quot;</span> <span class="tok-na">autor=</span><span class="tok-s">&quot;Kent Beck&quot;</span>
           <span class="tok-na">isbn=</span><span class="tok-s">&quot;0321278658&quot;</span> <span class="tok-na">numPaginas=</span><span class="tok-s">&quot;224&quot;</span> <span class="tok-na">portadaURI=</span><span class="tok-s">&quot;0321278658.jpg&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;Libro</span> <span class="tok-na">id=</span><span class="tok-s">&quot;5&quot;</span> <span class="tok-na">titulo=</span><span class="tok-s">&quot;The Art of Computer Programming&quot;</span> <span class="tok-na">autor=</span><span class="tok-s">&quot;Donald E. Knuth&quot;</span>
           <span class="tok-na">isbn=</span><span class="tok-s">&quot;0201896834&quot;</span> <span class="tok-na">numPaginas=</span><span class="tok-s">&quot;144&quot;</span> <span class="tok-na">portadaURI=</span><span class="tok-s">&quot;0321278658.jpg&quot;</span><span class="tok-nt">/&gt;</span>

    <span class="tok-nt">&lt;Recomendacion</span> <span class="tok-na">id=</span><span class="tok-s">&quot;1&quot;</span> <span class="tok-na">libro_id=</span><span class="tok-s">&quot;2&quot;</span> <span class="tok-na">libroRelacionado_id =</span> <span class="tok-s">&quot;3&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;Recomendacion</span> <span class="tok-na">id=</span><span class="tok-s">&quot;2&quot;</span> <span class="tok-na">libro_id=</span><span class="tok-s">&quot;2&quot;</span> <span class="tok-na">libroRelacionado_id =</span> <span class="tok-s">&quot;1&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;Recomendacion</span> <span class="tok-na">id=</span><span class="tok-s">&quot;3&quot;</span> <span class="tok-na">libro_id=</span><span class="tok-s">&quot;3&quot;</span> <span class="tok-na">libroRelacionado_id =</span> <span class="tok-s">&quot;2&quot;</span><span class="tok-nt">/&gt;</span>
<span class="tok-nt">&lt;/dataset&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para empezar definimos un test sencillo que carga el dataset y  comprueba el método <code>find</code> de la entidad. Los creamos en el fichero <code>src/test/java/org.expertojava.jbibrest.persistencia.TestsLibroAggregate.java</code>.</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/org.expertojava.jbibrest.persistencia.TestsLibroAggregate.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">persistencia</span><span class="tok-o">;</span>


<span class="tok-kn">import</span> <span class="tok-nn">org.dbunit.database.DatabaseConfig</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.dbunit.database.DatabaseConnection</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.dbunit.database.IDatabaseConnection</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.dbunit.dataset.IDataSet</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.dbunit.dataset.xml.FlatXmlDataSetBuilder</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.dbunit.ext.mysql.MySqlDataTypeFactory</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.dbunit.operation.DatabaseOperation</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.modelo.Libro</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.junit.AfterClass</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.junit.Before</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.junit.BeforeClass</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.junit.Test</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManager</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManagerFactory</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.Persistence</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.validation.ConstraintViolationException</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.sql.Connection</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.sql.DriverManager</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">junit</span><span class="tok-o">.</span><span class="tok-na">Assert</span><span class="tok-o">.</span><span class="tok-na">assertTrue</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">junit</span><span class="tok-o">.</span><span class="tok-na">Assert</span><span class="tok-o">.</span><span class="tok-na">fail</span><span class="tok-o">;</span>

<span class="tok-c1">//</span>
<span class="tok-c1">// Tests del aggregate formado por las entidades Libro y Recomendacion</span>
<span class="tok-c1">//</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">TestsLibroAggregate</span> <span class="tok-o">{</span>
    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">EntityManagerFactory</span> <span class="tok-n">emf</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">IDatabaseConnection</span> <span class="tok-n">connection</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">IDataSet</span> <span class="tok-n">dataset</span><span class="tok-o">;</span>

    <span class="tok-nd">@BeforeClass</span>
    <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-kt">void</span> <span class="tok-nf">initAllTests</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">try</span> <span class="tok-o">{</span>
            <span class="tok-c1">// Inicializamos sólo una vez el emf antes de todos los tests</span>
            <span class="tok-n">emf</span> <span class="tok-o">=</span> <span class="tok-n">Persistence</span><span class="tok-o">.</span><span class="tok-na">createEntityManagerFactory</span><span class="tok-o">(</span><span class="tok-s">&quot;biblioteca-local&quot;</span><span class="tok-o">);</span>

            <span class="tok-c1">// Inicializamos la conexión a la BD necesaria para</span>
            <span class="tok-c1">// que DBUnit cargue los datos de los tests</span>
            <span class="tok-n">Class</span><span class="tok-o">.</span><span class="tok-na">forName</span><span class="tok-o">(</span><span class="tok-s">&quot;com.mysql.jdbc.Driver&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">Connection</span> <span class="tok-n">jdbcConnection</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-n">Connection</span><span class="tok-o">)</span> <span class="tok-n">DriverManager</span>
                    <span class="tok-o">.</span><span class="tok-na">getConnection</span><span class="tok-o">(</span>
                            <span class="tok-s">&quot;jdbc:mysql://localhost:3306/biblioteca&quot;</span><span class="tok-o">,</span>
                            <span class="tok-s">&quot;root&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;expertojava&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">connection</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">DatabaseConnection</span><span class="tok-o">(</span><span class="tok-n">jdbcConnection</span><span class="tok-o">);</span>

            <span class="tok-c1">// 2 líneas para eliminar el warning</span>
            <span class="tok-n">DatabaseConfig</span> <span class="tok-n">dbConfig</span> <span class="tok-o">=</span> <span class="tok-n">connection</span><span class="tok-o">.</span><span class="tok-na">getConfig</span><span class="tok-o">();</span>
            <span class="tok-n">dbConfig</span><span class="tok-o">.</span><span class="tok-na">setProperty</span><span class="tok-o">(</span><span class="tok-n">DatabaseConfig</span><span class="tok-o">.</span><span class="tok-na">PROPERTY_DATATYPE_FACTORY</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-nf">MySqlDataTypeFactory</span><span class="tok-o">());</span>

            <span class="tok-c1">// Inicializamos el dataset</span>
            <span class="tok-n">FlatXmlDataSetBuilder</span> <span class="tok-n">flatXmlDataSetBuilder</span> <span class="tok-o">=</span>
                    <span class="tok-k">new</span> <span class="tok-nf">FlatXmlDataSetBuilder</span><span class="tok-o">();</span>
            <span class="tok-n">flatXmlDataSetBuilder</span><span class="tok-o">.</span><span class="tok-na">setColumnSensing</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">);</span>
            <span class="tok-n">dataset</span> <span class="tok-o">=</span> <span class="tok-n">flatXmlDataSetBuilder</span><span class="tok-o">.</span><span class="tok-na">build</span><span class="tok-o">(</span><span class="tok-n">Thread</span><span class="tok-o">.</span><span class="tok-na">currentThread</span><span class="tok-o">()</span>
                    <span class="tok-o">.</span><span class="tok-na">getContextClassLoader</span><span class="tok-o">()</span>
                    <span class="tok-o">.</span><span class="tok-na">getResourceAsStream</span><span class="tok-o">(</span><span class="tok-s">&quot;dbunit/dataset1.xml&quot;</span><span class="tok-o">));</span>
        <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">Exception</span> <span class="tok-n">ex</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">ex</span><span class="tok-o">.</span><span class="tok-na">printStackTrace</span><span class="tok-o">();</span>
            <span class="tok-n">fail</span><span class="tok-o">(</span><span class="tok-s">&quot;Excepción al inicializar el emf y DbUnit&quot;</span><span class="tok-o">);</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>

    <span class="tok-c1">// Se ejecuta antes de cada test</span>
    <span class="tok-nd">@Before</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">cleanDB</span><span class="tok-o">()</span> <span class="tok-kd">throws</span> <span class="tok-n">Exception</span> <span class="tok-o">{</span>
        <span class="tok-c1">// Se hace un &quot;clean insert&quot; de los datos de prueba</span>
        <span class="tok-c1">// definidos en el fichero XML. El &quot;clean insert&quot; vacía las</span>
        <span class="tok-c1">// tablas de los datos de prueba y después inserta los datos</span>
        <span class="tok-n">DatabaseOperation</span><span class="tok-o">.</span><span class="tok-na">CLEAN_INSERT</span><span class="tok-o">.</span><span class="tok-na">execute</span><span class="tok-o">(</span><span class="tok-n">connection</span><span class="tok-o">,</span> <span class="tok-n">dataset</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-cm">/*</span>
<span class="tok-cm">     * Tests de entidades Libro y Recomendacion</span>
<span class="tok-cm">     */</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">findLibroIdTest</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">Libro</span> <span class="tok-n">libro</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Libro</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">2L</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>

        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">getIsbn</span><span class="tok-o">().</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-s">&quot;0132350882&quot;</span><span class="tok-o">));</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">getTitulo</span><span class="tok-o">().</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-s">&quot;Clean Code&quot;</span><span class="tok-o">));</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">getAutor</span><span class="tok-o">().</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-s">&quot;Robert C. Martin&quot;</span><span class="tok-o">));</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">getNumPaginas</span><span class="tok-o">().</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-mi">288</span><span class="tok-o">));</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">getPortadaURI</span><span class="tok-o">().</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-s">&quot;0132350882.jpg&quot;</span><span class="tok-o">));</span>
    <span class="tok-o">}</span>

    <span class="tok-c1">// Se ejecuta una vez después de todos los tests</span>
    <span class="tok-nd">@AfterClass</span>
    <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-kt">void</span> <span class="tok-nf">closeEntityManagerFactory</span><span class="tok-o">()</span> <span class="tok-kd">throws</span> <span class="tok-n">Exception</span> <span class="tok-o">{</span>
        <span class="tok-c1">// Borramos todos los datos y cerramos la conexión</span>
        <span class="tok-c1">//DatabaseOperation.DELETE_ALL.execute(connection, dataset);</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">emf</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">)</span>
            <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nos aseguramos de que el test funciona y añadimos algunos más, que comprueben la creación de entidades, las relaciones y el <em>Bean Validation</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">createLibroTest</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">String</span> <span class="tok-n">isbn</span> <span class="tok-o">=</span> <span class="tok-s">&quot;123456789&quot;</span><span class="tok-o">;</span>

        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">begin</span><span class="tok-o">();</span>
        <span class="tok-n">Libro</span> <span class="tok-n">libro</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Libro</span><span class="tok-o">(</span><span class="tok-n">isbn</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">persist</span><span class="tok-o">(</span><span class="tok-n">libro</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">();</span>

        <span class="tok-n">Long</span> <span class="tok-n">libroId</span> <span class="tok-o">=</span> <span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">getId</span><span class="tok-o">();</span>

        <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">Libro</span> <span class="tok-n">libroRecuperado</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Libro</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-n">libroId</span><span class="tok-o">);</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">libroRecuperado</span><span class="tok-o">.</span><span class="tok-na">getIsbn</span><span class="tok-o">().</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">isbn</span><span class="tok-o">));</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">numRecomendacionesTest</span><span class="tok-o">()</span> <span class="tok-o">{</span>

        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">Libro</span> <span class="tok-n">libro</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Libro</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">2L</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>

        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">getRecomendaciones</span><span class="tok-o">().</span><span class="tok-na">size</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-mi">2</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span><span class="tok-o">(</span><span class="tok-n">expected</span> <span class="tok-o">=</span> <span class="tok-n">ConstraintViolationException</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">)</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">errorValidacionNumPaginasNegativasTest</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">Long</span> <span class="tok-n">id</span> <span class="tok-o">=</span> <span class="tok-mi">2L</span><span class="tok-o">;</span>

        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-k">try</span> <span class="tok-o">{</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">begin</span><span class="tok-o">();</span>
            <span class="tok-n">Libro</span> <span class="tok-n">libro</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Libro</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-n">id</span><span class="tok-o">);</span>
            <span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">setNumPaginas</span><span class="tok-o">(-</span><span class="tok-mi">1</span><span class="tok-o">);</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">flush</span><span class="tok-o">();</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">();</span>
        <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">ConstraintViolationException</span> <span class="tok-n">ex</span><span class="tok-o">){</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">rollback</span><span class="tok-o">();</span>
            <span class="tok-k">throw</span> <span class="tok-n">ex</span><span class="tok-o">;</span>
        <span class="tok-o">}</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_clases_dao">Clases DAO</h5>
<div class="paragraph">
<p>Añadimos ahora las clases DAO correspondientes a las entidades anteriores. Lo hacemos en el paquete <code>org.expertojava.jbibrest.persistencia</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>org.expertojava.jbibrest.persistencia.Dao</code></p>
</li>
<li>
<p><code>org.expertojava.jbibrest.persistencia.LibroDAO</code></p>
</li>
<li>
<p><code>org.expertojava.jbibrest.persistencia.Recomendacion</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La clase abstracta <code>Dao</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/expertojava/jbibrest/persistencia/Dao.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">persistencia</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManager</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.PersistenceContext</span><span class="tok-o">;</span>

<span class="tok-kd">abstract</span> <span class="tok-kd">class</span> <span class="tok-nc">Dao</span><span class="tok-o">&lt;</span><span class="tok-n">T</span><span class="tok-o">,</span> <span class="tok-n">K</span><span class="tok-o">&gt;</span> <span class="tok-o">{</span>

    <span class="tok-nd">@PersistenceContext</span>
    <span class="tok-n">EntityManager</span> <span class="tok-n">em</span><span class="tok-o">;</span>

    <span class="tok-kd">public</span> <span class="tok-n">T</span> <span class="tok-nf">create</span><span class="tok-o">(</span><span class="tok-n">T</span> <span class="tok-n">t</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">persist</span><span class="tok-o">(</span><span class="tok-n">t</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">flush</span><span class="tok-o">();</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">refresh</span><span class="tok-o">(</span><span class="tok-n">t</span><span class="tok-o">);</span>
        <span class="tok-k">return</span> <span class="tok-n">t</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">T</span> <span class="tok-nf">update</span><span class="tok-o">(</span><span class="tok-n">T</span> <span class="tok-n">t</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-o">(</span><span class="tok-n">T</span><span class="tok-o">)</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">merge</span><span class="tok-o">(</span><span class="tok-n">t</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">delete</span><span class="tok-o">(</span><span class="tok-n">T</span> <span class="tok-n">t</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">t</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">merge</span><span class="tok-o">(</span><span class="tok-n">t</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">remove</span><span class="tok-o">(</span><span class="tok-n">t</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-kd">abstract</span> <span class="tok-n">T</span> <span class="tok-nf">find</span><span class="tok-o">(</span><span class="tok-n">K</span> <span class="tok-n">id</span><span class="tok-o">);</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La clase <code>LibroDao</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/expertojava/jbibrest/persistencia/LibroDao.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">persistencia</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.modelo.Libro</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.Query</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.TypedQuery</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.ArrayList</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.List</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">LibroDao</span> <span class="tok-kd">extends</span> <span class="tok-n">Dao</span><span class="tok-o">&lt;</span><span class="tok-n">Libro</span><span class="tok-o">,</span> <span class="tok-n">Long</span><span class="tok-o">&gt;</span> <span class="tok-o">{</span>
    <span class="tok-n">String</span> <span class="tok-n">FIND_ALL_LIBROS</span> <span class="tok-o">=</span> <span class="tok-s">&quot;SELECT l FROM Libro l &quot;</span><span class="tok-o">;</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-n">Libro</span> <span class="tok-nf">find</span><span class="tok-o">(</span><span class="tok-n">Long</span> <span class="tok-n">id</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Libro</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-n">id</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Libro</span><span class="tok-o">&gt;</span> <span class="tok-nf">listAllLibros</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">TypedQuery</span><span class="tok-o">&lt;</span><span class="tok-n">Libro</span><span class="tok-o">&gt;</span> <span class="tok-n">query</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">createQuery</span><span class="tok-o">(</span><span class="tok-n">FIND_ALL_LIBROS</span><span class="tok-o">,</span> <span class="tok-n">Libro</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>
        <span class="tok-k">return</span> <span class="tok-n">query</span><span class="tok-o">.</span><span class="tok-na">getResultList</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y la clase <code>RecomendacionDao</code> en donde se guardan recomendaciones que relacionan un libro con otro</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/expertojava/jbibrest/persistencia/RecomendacionDao.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">persistencia</span><span class="tok-o">;</span>


<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.modelo.Recomendacion</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.Query</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.List</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">RecomendacionDao</span> <span class="tok-kd">extends</span> <span class="tok-n">Dao</span><span class="tok-o">&lt;</span><span class="tok-n">Recomendacion</span><span class="tok-o">,</span> <span class="tok-n">Long</span><span class="tok-o">&gt;</span> <span class="tok-o">{</span>
    <span class="tok-n">String</span> <span class="tok-n">FIND_ALL_RECOMENDACIONES</span> <span class="tok-o">=</span> <span class="tok-s">&quot;SELECT r FROM Recomendacion r &quot;</span><span class="tok-o">;</span>

    <span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-n">Recomendacion</span> <span class="tok-nf">find</span><span class="tok-o">(</span><span class="tok-n">Long</span> <span class="tok-n">id</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Recomendacion</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-n">id</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Recomendacion</span><span class="tok-o">&gt;</span> <span class="tok-nf">listAllRecomendaciones</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">Query</span> <span class="tok-n">query</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">createQuery</span><span class="tok-o">(</span><span class="tok-n">FIND_ALL_RECOMENDACIONES</span><span class="tok-o">);</span>
        <span class="tok-k">return</span> <span class="tok-o">(</span><span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Recomendacion</span><span class="tok-o">&gt;)</span> <span class="tok-n">query</span><span class="tok-o">.</span><span class="tok-na">getResultList</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Estos DAO los vamos a inyectar usando CDIs. Para que CDI funcione correctamente debes crear el fichero <code>beans.xml</code> vacío en el directorio <code>main/webapp/WEB-INF</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/WEB-INF/beans.xml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tok-nt">&lt;beans</span>
        <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span>
        <span class="tok-na">xmlns:xsi=</span><span class="tok-s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
        <span class="tok-na">xsi:schemaLocation=</span><span class="tok-s">&quot;http://xmlns.jcp.org/xml/ns/javaee</span>
<span class="tok-s">                      http://xmlns.jcp.org/xml/ns/javaee/beans_1_1.xsd&quot;</span>
        <span class="tok-na">bean-discovery-mode=</span><span class="tok-s">&quot;all&quot;</span><span class="tok-nt">&gt;</span>
<span class="tok-nt">&lt;/beans&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_pruebas_con_arquillian">Pruebas con Arquillian</h5>
<div class="paragraph">
<p>Habrás visto que en la clase <code>Dao</code> se inyecta la unidad de persistencia. Por ello necesitamos probar las clases Dao dentro del servidor de aplicaciones, para lo que utilizaremos Arquilian. También lo utilizaremos para probar los métodos de servicio.</p>
</div>
<div class="paragraph">
<p>Para incluir Arquilian debemos seguir los siguientes pasos:</p>
</div>
<div class="paragraph">
<p>En primer lugar, añadimos las dependencias necesarias en el fichero POM del proyecto Maven:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="xml">    ...

    <span class="tok-nt">&lt;properties&gt;</span>
        <span class="tok-nt">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span class="tok-nt">&lt;/project.build.sourceEncoding&gt;</span>
        <span class="tok-nt">&lt;version.arquillian-persistence&gt;</span>1.0.0.Alpha7<span class="tok-nt">&lt;/version.arquillian-persistence&gt;</span>
    <span class="tok-nt">&lt;/properties&gt;</span>



    <span class="tok-nt">&lt;dependencyManagement&gt;</span>
        <span class="tok-nt">&lt;dependencies&gt;</span>
            <span class="tok-nt">&lt;dependency&gt;</span>
                <span class="tok-nt">&lt;groupId&gt;</span>org.jboss.arquillian<span class="tok-nt">&lt;/groupId&gt;</span>
                <span class="tok-nt">&lt;artifactId&gt;</span>arquillian-bom<span class="tok-nt">&lt;/artifactId&gt;</span>
                <span class="tok-nt">&lt;version&gt;</span>1.1.10.Final<span class="tok-nt">&lt;/version&gt;</span>
                <span class="tok-nt">&lt;scope&gt;</span>import<span class="tok-nt">&lt;/scope&gt;</span>
                <span class="tok-nt">&lt;type&gt;</span>pom<span class="tok-nt">&lt;/type&gt;</span>
            <span class="tok-nt">&lt;/dependency&gt;</span>
        <span class="tok-nt">&lt;/dependencies&gt;</span>
    <span class="tok-nt">&lt;/dependencyManagement&gt;</span>

   ...

        <span class="tok-c">&lt;!-- Arquillian --&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.jboss.arquillian.junit<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>arquillian-junit-container<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.wildfly<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>wildfly-arquillian-container-remote<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>8.1.0.Final<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-c">&lt;!-- Arquillian persistence --&gt;</span> 
<i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.jboss.arquillian.extension<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>arquillian-persistence-api<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>${version.arquillian-persistence}<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.jboss.arquillian.extension<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>arquillian-persistence-core<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>${version.arquillian-persistence}<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.jboss.arquillian.extension<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>arquillian-persistence-dbunit<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>${version.arquillian-persistence}<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        <span class="tok-nt">&lt;dependency&gt;</span>
            <span class="tok-nt">&lt;groupId&gt;</span>org.jboss.arquillian.extension<span class="tok-nt">&lt;/groupId&gt;</span>
            <span class="tok-nt">&lt;artifactId&gt;</span>arquillian-persistence-spi<span class="tok-nt">&lt;/artifactId&gt;</span>
            <span class="tok-nt">&lt;version&gt;</span>${version.arquillian-persistence}<span class="tok-nt">&lt;/version&gt;</span>
            <span class="tok-nt">&lt;scope&gt;</span>test<span class="tok-nt">&lt;/scope&gt;</span>
        <span class="tok-nt">&lt;/dependency&gt;</span>

        ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Las librerías de <em>Arquillian Persistence</em> van a hacer posible utilizar DbUnit para cargar el dataset en la realización de los tests dentro del servidor WildFly.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Después añadimos en el directorio <code>test/resources</code> el fichero <code>persistence-datasource.xml</code> que es una copia del <code>persistence.xml</code> usado en tiempo de ejecución. Lo usaremos para que Arquillian lo copie en el war que despliega en el servidor de aplicaciones.</p>
</div>
<div class="paragraph">
<p>Configuramos el modo de cargar la base de datos con <code>update</code> para mantener los datos que introduce DbUnit en la ejecución de los tests de persistencia.</p>
</div>
<div class="listingblock">
<div class="title">test/resources/persistence-datasource.xml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tok-nt">&lt;persistence</span> <span class="tok-na">version=</span><span class="tok-s">&quot;2.0&quot;</span>
             <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://java.sun.com/xml/ns/persistence&quot;</span> <span class="tok-na">xmlns:xsi=</span><span class="tok-s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
             <span class="tok-na">xsi:schemaLocation=</span><span class="tok-s">&quot;</span>
<span class="tok-s">        http://java.sun.com/xml/ns/persistence</span>
<span class="tok-s">        http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;persistence-unit</span> <span class="tok-na">name=</span><span class="tok-s">&quot;biblioteca-datasource&quot;</span><span class="tok-nt">&gt;</span>

        <span class="tok-nt">&lt;provider&gt;</span>org.hibernate.jpa.HibernatePersistenceProvider<span class="tok-nt">&lt;/provider&gt;</span>

        <span class="tok-nt">&lt;jta-data-source&gt;</span>java:/datasources/BibliotecaDS<span class="tok-nt">&lt;/jta-data-source&gt;</span>
        <span class="tok-nt">&lt;class&gt;</span>org.expertojava.jbibrest.modelo.Libro<span class="tok-nt">&lt;/class&gt;</span>
        <span class="tok-nt">&lt;class&gt;</span>org.expertojava.jbibrest.modelo.Recomendacion<span class="tok-nt">&lt;/class&gt;</span>

        <span class="tok-nt">&lt;properties&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.id.new_generator_mappings&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;false&quot;</span><span class="tok-nt">/&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.dialect&quot;</span>
                      <span class="tok-na">value=</span><span class="tok-s">&quot;org.hibernate.dialect.MySQLDialect&quot;</span><span class="tok-nt">/&gt;</span>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.hbm2ddl.auto&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;create&quot;</span> <span class="tok-nt">/&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="tok-nt">&lt;property</span> <span class="tok-na">name=</span><span class="tok-s">&quot;hibernate.show_sql&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;true&quot;</span> <span class="tok-nt">/&gt;</span>
        <span class="tok-nt">&lt;/properties&gt;</span>
    <span class="tok-nt">&lt;/persistence-unit&gt;</span>
<span class="tok-nt">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configuramos el modo de cargar la base de datos con <code>create</code> para limpiar la base de datos</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Por último, definimos dos tests iniciales con Arquillian. El primero para comprobar las clases Dao se inyectan correctamente y el segundo para comprobar un primer método sencillo del DAO.</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/org.jbibrest.persistencia.TestsLibroAggregateArquillian.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">persistencia</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.modelo.Libro</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.modelo.Recomendacion</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.utils.BibliotecaException</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.arquillian.container.test.api.Deployment</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.arquillian.junit.Arquillian</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.arquillian.persistence.Cleanup</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.arquillian.persistence.CleanupStrategy</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.arquillian.persistence.TestExecutionPhase</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.arquillian.persistence.UsingDataSet</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.shrinkwrap.api.ShrinkWrap</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.shrinkwrap.api.asset.EmptyAsset</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.shrinkwrap.api.spec.JavaArchive</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.junit.Test</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.junit.runner.RunWith</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.inject.Inject</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">junit</span><span class="tok-o">.</span><span class="tok-na">Assert</span><span class="tok-o">.</span><span class="tok-na">assertNotNull</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">junit</span><span class="tok-o">.</span><span class="tok-na">Assert</span><span class="tok-o">.</span><span class="tok-na">assertTrue</span><span class="tok-o">;</span>

<span class="tok-nd">@RunWith</span><span class="tok-o">(</span><span class="tok-n">Arquillian</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">TestsLibroAggregateArquillian</span> <span class="tok-o">{</span>

    <span class="tok-nd">@Inject</span>
    <span class="tok-n">LibroDao</span> <span class="tok-n">libroDao</span><span class="tok-o">;</span>
    <span class="tok-nd">@Inject</span>
    <span class="tok-n">RecomendacionDao</span> <span class="tok-n">recomendacionDao</span><span class="tok-o">;</span>

    <span class="tok-nd">@Deployment</span>
    <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-n">JavaArchive</span> <span class="tok-nf">createDeployment</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">ShrinkWrap</span><span class="tok-o">.</span><span class="tok-na">create</span><span class="tok-o">(</span><span class="tok-n">JavaArchive</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">)</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">Libro</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">Recomendacion</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">LibroDao</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">RecomendacionDao</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">BibliotecaException</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addAsResource</span><span class="tok-o">(</span><span class="tok-s">&quot;persistence-datasource.xml&quot;</span><span class="tok-o">,</span>
                        <span class="tok-s">&quot;META-INF/persistence.xml&quot;</span><span class="tok-o">)</span>
                <span class="tok-o">.</span><span class="tok-na">addAsManifestResource</span><span class="tok-o">(</span><span class="tok-n">EmptyAsset</span><span class="tok-o">.</span><span class="tok-na">INSTANCE</span><span class="tok-o">,</span> <span class="tok-s">&quot;beans.xml&quot;</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">libroDaoNoEsNullTest</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">assertNotNull</span><span class="tok-o">(</span><span class="tok-n">libroDao</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@UsingDataSet</span><span class="tok-o">(</span><span class="tok-s">&quot;dbunit/dataset1.xml&quot;</span><span class="tok-o">)</span>
    <span class="tok-nd">@Cleanup</span><span class="tok-o">(</span><span class="tok-n">phase</span> <span class="tok-o">=</span> <span class="tok-n">TestExecutionPhase</span><span class="tok-o">.</span><span class="tok-na">BEFORE</span><span class="tok-o">,</span>  <span class="tok-n">strategy</span> <span class="tok-o">=</span> <span class="tok-n">CleanupStrategy</span><span class="tok-o">.</span><span class="tok-na">USED_TABLES_ONLY</span><span class="tok-o">)</span>
    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">findLibroIdTest</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">Libro</span> <span class="tok-n">libro</span> <span class="tok-o">=</span> <span class="tok-n">libroDao</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-mi">2L</span><span class="tok-o">);</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">getIsbn</span><span class="tok-o">().</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-s">&quot;0132350882&quot;</span><span class="tok-o">));</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">getTitulo</span><span class="tok-o">().</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-s">&quot;Clean Code&quot;</span><span class="tok-o">));</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">getAutor</span><span class="tok-o">().</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-s">&quot;Robert C. Martin&quot;</span><span class="tok-o">));</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">getNumPaginas</span><span class="tok-o">().</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-mi">288</span><span class="tok-o">));</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">getPortadaURI</span><span class="tok-o">().</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-s">&quot;0132350882.jpg&quot;</span><span class="tok-o">));</span>
    <span class="tok-o">}</span>

<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_pruebas_de_las_clases_dao">Pruebas de las clases Dao</h5>
<div class="paragraph">
<p>Una vez configurado correctamente Arquillian realizamos algunas pruebas adicionales en los DAO, sin ser demasiado exhaustivos. Por ejemplo, podemos probar:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Método <code>find</code></p>
</li>
<li>
<p>Métodos de actualización de las relaciones y sus inversas</p>
</li>
<li>
<p>Consultas</p>
</li>
<li>
<p>Restricciones <em>Bean Validation</em></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">src/test/java/org/jbibrest/persistencia/TestsLibroAggregateArquillian.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java">    <span class="tok-nd">@UsingDataSet</span><span class="tok-o">(</span><span class="tok-s">&quot;dbunit/dataset1.xml&quot;</span><span class="tok-o">)</span>
    <span class="tok-nd">@Cleanup</span><span class="tok-o">(</span><span class="tok-n">phase</span> <span class="tok-o">=</span> <span class="tok-n">TestExecutionPhase</span><span class="tok-o">.</span><span class="tok-na">BEFORE</span><span class="tok-o">,</span>  <span class="tok-n">strategy</span> <span class="tok-o">=</span> <span class="tok-n">CleanupStrategy</span><span class="tok-o">.</span><span class="tok-na">USED_TABLES_ONLY</span><span class="tok-o">)</span>
    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">numRecomendacionesTest</span><span class="tok-o">()</span>  <span class="tok-o">{</span> 
        <span class="tok-n">Libro</span> <span class="tok-n">libro</span> <span class="tok-o">=</span> <span class="tok-n">libroDao</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-mi">2L</span><span class="tok-o">);</span><i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">getRecomendaciones</span><span class="tok-o">().</span><span class="tok-na">size</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-mi">2</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@UsingDataSet</span><span class="tok-o">(</span><span class="tok-s">&quot;dbunit/dataset1.xml&quot;</span><span class="tok-o">)</span>
    <span class="tok-nd">@Cleanup</span><span class="tok-o">(</span><span class="tok-n">phase</span> <span class="tok-o">=</span> <span class="tok-n">TestExecutionPhase</span><span class="tok-o">.</span><span class="tok-na">BEFORE</span><span class="tok-o">,</span>  <span class="tok-n">strategy</span> <span class="tok-o">=</span> <span class="tok-n">CleanupStrategy</span><span class="tok-o">.</span><span class="tok-na">USED_TABLES_ONLY</span><span class="tok-o">)</span>
    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">createLibroTest</span><span class="tok-o">()</span> <span class="tok-o">{</span> 
        <span class="tok-n">String</span> <span class="tok-n">isbn</span> <span class="tok-o">=</span> <span class="tok-s">&quot;123456789&quot;</span><span class="tok-o">;</span><i class="conum" data-value="2"></i><b>(2)</b>

        <span class="tok-n">Libro</span> <span class="tok-n">libro</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Libro</span><span class="tok-o">(</span><span class="tok-n">isbn</span><span class="tok-o">);</span>
        <span class="tok-n">Libro</span> <span class="tok-n">libroCreado</span> <span class="tok-o">=</span> <span class="tok-n">libroDao</span><span class="tok-o">.</span><span class="tok-na">create</span><span class="tok-o">(</span><span class="tok-n">libro</span><span class="tok-o">);</span>
        <span class="tok-n">Long</span> <span class="tok-n">libroId</span> <span class="tok-o">=</span> <span class="tok-n">libroCreado</span><span class="tok-o">.</span><span class="tok-na">getId</span><span class="tok-o">();</span>
        <span class="tok-n">Libro</span> <span class="tok-n">libroRecuperado</span> <span class="tok-o">=</span> <span class="tok-n">libroDao</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">libroId</span><span class="tok-o">);</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">libroRecuperado</span><span class="tok-o">.</span><span class="tok-na">getIsbn</span><span class="tok-o">().</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">isbn</span><span class="tok-o">));</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@UsingDataSet</span><span class="tok-o">(</span><span class="tok-s">&quot;dbunit/dataset1.xml&quot;</span><span class="tok-o">)</span>
    <span class="tok-nd">@Cleanup</span><span class="tok-o">(</span><span class="tok-n">phase</span> <span class="tok-o">=</span> <span class="tok-n">TestExecutionPhase</span><span class="tok-o">.</span><span class="tok-na">BEFORE</span><span class="tok-o">,</span>  <span class="tok-n">strategy</span> <span class="tok-o">=</span> <span class="tok-n">CleanupStrategy</span><span class="tok-o">.</span><span class="tok-na">USED_TABLES_ONLY</span><span class="tok-o">)</span>
    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">findRecomendacionTest</span><span class="tok-o">()</span> <span class="tok-o">{</span> 
        <span class="tok-n">Recomendacion</span> <span class="tok-n">recomendacion</span> <span class="tok-o">=</span> <span class="tok-n">recomendacionDao</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-mi">1L</span><span class="tok-o">);</span><i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">recomendacion</span><span class="tok-o">.</span><span class="tok-na">getLibro</span><span class="tok-o">().</span><span class="tok-na">getTitulo</span><span class="tok-o">().</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-s">&quot;Clean Code&quot;</span><span class="tok-o">));</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">recomendacion</span><span class="tok-o">.</span><span class="tok-na">getLibroRelacionado</span><span class="tok-o">().</span><span class="tok-na">getTitulo</span><span class="tok-o">().</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-s">&quot;Test Driven Development&quot;</span><span class="tok-o">));</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@UsingDataSet</span><span class="tok-o">(</span><span class="tok-s">&quot;dbunit/dataset1.xml&quot;</span><span class="tok-o">)</span>
    <span class="tok-nd">@Cleanup</span><span class="tok-o">(</span><span class="tok-n">phase</span> <span class="tok-o">=</span> <span class="tok-n">TestExecutionPhase</span><span class="tok-o">.</span><span class="tok-na">BEFORE</span><span class="tok-o">,</span>  <span class="tok-n">strategy</span> <span class="tok-o">=</span> <span class="tok-n">CleanupStrategy</span><span class="tok-o">.</span><span class="tok-na">USED_TABLES_ONLY</span><span class="tok-o">)</span>
    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">añadeRecomendacionTest</span><span class="tok-o">()</span> <span class="tok-o">{</span> 
        <span class="tok-n">Libro</span> <span class="tok-n">libro3</span> <span class="tok-o">=</span> <span class="tok-n">libroDao</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-mi">3L</span><span class="tok-o">);</span><i class="conum" data-value="4"></i><b>(4)</b>
        <span class="tok-n">Libro</span> <span class="tok-n">libro1</span> <span class="tok-o">=</span> <span class="tok-n">libroDao</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-mi">1L</span><span class="tok-o">);</span>
        <span class="tok-n">Recomendacion</span> <span class="tok-n">recomendacion</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Recomendacion</span><span class="tok-o">(</span><span class="tok-n">libro3</span><span class="tok-o">,</span> <span class="tok-n">libro1</span><span class="tok-o">);</span>
        <span class="tok-n">recomendacion</span> <span class="tok-o">=</span> <span class="tok-n">recomendacionDao</span><span class="tok-o">.</span><span class="tok-na">create</span><span class="tok-o">(</span><span class="tok-n">recomendacion</span><span class="tok-o">);</span>

        <span class="tok-c1">// actualizamos la relación en memoria</span>
        <span class="tok-n">libro3</span><span class="tok-o">.</span><span class="tok-na">añadeRecomendacion</span><span class="tok-o">(</span><span class="tok-n">recomendacion</span><span class="tok-o">);</span>

        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">libro3</span><span class="tok-o">.</span><span class="tok-na">getRecomendaciones</span><span class="tok-o">().</span><span class="tok-na">size</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-mi">2</span><span class="tok-o">);</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">libro3</span><span class="tok-o">.</span><span class="tok-na">getRecomendaciones</span><span class="tok-o">().</span><span class="tok-na">contains</span><span class="tok-o">(</span><span class="tok-n">recomendacion</span><span class="tok-o">));</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Las anotaciones de Arquillian permiten usar DbUnit desde dentro del servidor:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@UsingDataSet</code>: Inserta el conjunto de prueba indicado. También envuelve el test dentro de una transacción.</p>
</li>
<li>
<p><code>@Cleanup</code>: define el modo de limpieza de los datos de prueba. En nuestro caso, antes de cada ejecución de test se limpiarán las tablas definidas en el conjunto de prueba y se insertaran los datos datos de prueba (con el <code>@UsingDataSet</code>).</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
¡¡No te limites a copiar y pegar!! Es imprescindible que leas bien el código y entiendas qué se está probando en cada test.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_capa_de_lógica_de_negocio">3.2.2. Capa de lógica de negocio</h4>
<div class="paragraph">
<p>Una vez definida la capa de persistencia, vamos a implementar los siguientes métodos de negocio en esta primera iteración:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Listado de libros: se devuelve la lista de todos los libros</p>
</li>
<li>
<p>Libros recomendados: se pasa el <em>identificador del libro</em> y un número <em>n</em> de recomendaciones deseadas. Se devuelve la lista de esas <em>n</em> recomendaciones (o menos, si no hay suficientes recomendaciones)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Vamos a definir los métodos de negocio como método de un bean gestionado que anotaremos con <code>@Transactional</code> para proporcional transaccionalidad en las llamdas a las distintas clases DAO.</p>
</div>
<div class="paragraph">
<p>Vamos a probar la capa de negocio de dos formas. Primero lo haremos accediendo al método desde un servlet y mostrando los resultados en una página web. Y después usaremos usaremos Arquillian.</p>
</div>
</div>
<div class="sect3">
<h4 id="_clase_de_servicio">3.2.3. Clase de servicio</h4>
<div class="paragraph">
<p>Creamos en el paquete <code>org.expertojava.jbibrest.servicio</code> la clase <code>LibroServicio</code>, con la anotación <code>@Transactional</code> contieniendo los métodos <code>listaLibros()</code> y <code>listaRecomendaciones()</code>. Obtenemos los DAO por CDI:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/expertojava/jbibrest/servicio/LibroServicio.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">servicio</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.modelo.Ejemplar</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.modelo.Libro</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.modelo.Recomendacion</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.persistencia.LibroDao</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.persistencia.RecomendacionDao</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.inject.Inject</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.transaction.Transactional</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.ArrayList</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.List</span><span class="tok-o">;</span>

<span class="tok-nd">@Transactional</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">LibroServicio</span> <span class="tok-o">{</span>
    <span class="tok-nd">@Inject</span>
    <span class="tok-n">LibroDao</span> <span class="tok-n">libroDao</span><span class="tok-o">;</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-nd">@Inject</span>
    <span class="tok-n">RecomendacionDao</span> <span class="tok-n">recomendacionDao</span><span class="tok-o">;</span> <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="tok-kd">public</span> <span class="tok-n">Libro</span> <span class="tok-nf">buscaLibroPorId</span><span class="tok-o">(</span><span class="tok-n">Long</span> <span class="tok-n">id</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">id</span> <span class="tok-o">==</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-k">throw</span> <span class="tok-k">new</span> <span class="tok-nf">IllegalArgumentException</span><span class="tok-o">(</span><span class="tok-s">&quot;Id no puede ser null&quot;</span><span class="tok-o">);</span>
        <span class="tok-o">}</span>
        <span class="tok-k">return</span> <span class="tok-n">libroDao</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">id</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Recomendacion</span><span class="tok-o">&gt;</span> <span class="tok-nf">listaRecomendaciones</span><span class="tok-o">(</span><span class="tok-n">Long</span> <span class="tok-n">libroId</span><span class="tok-o">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Recomendacion</span><span class="tok-o">&gt;</span> <span class="tok-n">listaDevuelta</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">ArrayList</span><span class="tok-o">&lt;&gt;();</span>
        <span class="tok-n">Libro</span> <span class="tok-n">libro</span> <span class="tok-o">=</span> <span class="tok-n">libroDao</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">libroId</span><span class="tok-o">);</span>
        <span class="tok-kt">int</span> <span class="tok-n">anyadidos</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-o">;</span>
        <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">Recomendacion</span> <span class="tok-n">rec</span> <span class="tok-o">:</span> <span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">getRecomendaciones</span><span class="tok-o">())</span> <span class="tok-o">{</span>
            <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">anyadidos</span> <span class="tok-o">==</span> <span class="tok-n">n</span><span class="tok-o">)</span> <span class="tok-k">break</span><span class="tok-o">;</span>
            <span class="tok-n">listaDevuelta</span><span class="tok-o">.</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-n">rec</span><span class="tok-o">);</span>
            <span class="tok-n">anyadidos</span><span class="tok-o">++;</span>
        <span class="tok-o">}</span>
        <span class="tok-k">return</span> <span class="tok-n">listaDevuelta</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Libro</span><span class="tok-o">&gt;</span> <span class="tok-nf">listaLibros</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">libroDao</span><span class="tok-o">.</span><span class="tok-na">listAllLibros</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>&lt;1&gt;&lt;2&gt; Obtenemos los DAO por inyección de dependencias</p>
</div>
<div class="paragraph">
<p>Tal y como hemos visto en el módulo de JPA, el bean gestionado obtiene los DAO por inyección de dependencias y los utiliza en los métodos de negocio. Cada método de negocio se ejecuta dentro de una transacción JTA que crea automáticamente el servidor de aplicaciones.</p>
</div>
</div>
<div class="sect3">
<h4 id="_prueba_desde_un_servlet">3.2.4. Prueba desde un servlet</h4>
<div class="paragraph">
<p>Añadimos el fichero <code>src/main/webapp/index.jsp</code> desde donde lanzamos las peticiones a los servlets:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/index.jsp</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-cp">&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.0 Transitional//EN&quot;&gt;</span>
<span class="tok-nt">&lt;html&gt;</span>
    <span class="tok-nt">&lt;head&gt;</span>
        <span class="tok-nt">&lt;title&gt;</span>Start Page<span class="tok-nt">&lt;/title&gt;</span>
        <span class="tok-nt">&lt;meta</span> <span class="tok-na">http-equiv=</span><span class="tok-s">&quot;Content-Type&quot;</span> <span class="tok-na">content=</span><span class="tok-s">&quot;text/html&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;/head&gt;</span>
    <span class="tok-nt">&lt;body&gt;</span>
        <span class="tok-nt">&lt;h1&gt;</span>Pruebas métodos de negocio<span class="tok-nt">&lt;/h1&gt;</span>
        <span class="tok-nt">&lt;hr/&gt;</span>
        <span class="tok-nt">&lt;p&gt;&lt;a</span> <span class="tok-na">href=</span><span class="tok-s">&quot;&lt;%=request.getContextPath()%&gt;/listalibros&quot;</span><span class="tok-nt">&gt;</span>Listado de libros<span class="tok-nt">&lt;/a&gt;&lt;/p&gt;</span>
        <span class="tok-nt">&lt;hr/&gt;</span>
        <span class="tok-nt">&lt;form</span> <span class="tok-na">action=</span><span class="tok-s">&quot;&lt;%=request.getContextPath()%&gt;/listarecomendaciones&quot;</span><span class="tok-nt">&gt;</span>
            <span class="tok-nt">&lt;p&gt;</span>Identificador del libro: <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;libroId&quot;</span><span class="tok-nt">&gt;&lt;/p&gt;</span>
            <span class="tok-nt">&lt;p&gt;</span>Número de recomendaciones: <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;text&quot;</span> <span class="tok-na">name=</span><span class="tok-s">&quot;numRecomendaciones&quot;</span><span class="tok-nt">&gt;&lt;/p&gt;</span>
            <span class="tok-nt">&lt;input</span> <span class="tok-na">type=</span><span class="tok-s">&quot;submit&quot;</span> <span class="tok-na">value=</span><span class="tok-s">&quot;Enviar&quot;</span><span class="tok-nt">&gt;</span>
        <span class="tok-nt">&lt;/form&gt;</span>
        <span class="tok-nt">&lt;/form&gt;</span>
        <span class="tok-nt">&lt;hr/&gt;</span>
    <span class="tok-nt">&lt;/body&gt;</span>
<span class="tok-nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y añadimos los dos servlets que realizan la llamada a los métodos de negocio. En primer lugar <code>src/main/java/org.expertojava.jbibrest.ListadoLibros</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/expertojava/jbibrest/ListadoLibros.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">servlets</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.modelo.Libro</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.servicio.LibroServicio</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.inject.Inject</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.ServletException</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.annotation.WebServlet</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.http.HttpServlet</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.http.HttpServletRequest</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.http.HttpServletResponse</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.io.IOException</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.io.PrintWriter</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.List</span><span class="tok-o">;</span>

<span class="tok-nd">@WebServlet</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;listaLibros&quot;</span><span class="tok-o">,</span> <span class="tok-n">urlPatterns</span><span class="tok-o">=</span><span class="tok-s">&quot;/listaLibros&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">ListadoLibros</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span> <span class="tok-o">{</span>

    <span class="tok-nd">@Inject</span>
    <span class="tok-n">LibroServicio</span> <span class="tok-n">libroServicio</span><span class="tok-o">;</span> <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">doPost</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                          <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>  <span class="tok-kd">throws</span>
            <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>

    <span class="tok-o">}</span>

    <span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                         <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span> <span class="tok-kd">throws</span>
    <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>

        <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Libro</span><span class="tok-o">&gt;</span> <span class="tok-n">listaLibros</span>
                <span class="tok-o">=</span> <span class="tok-n">libroServicio</span><span class="tok-o">.</span><span class="tok-na">listaLibros</span><span class="tok-o">();</span> <i class="conum" data-value="2"></i><b>(2)</b>

        <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setContentType</span><span class="tok-o">(</span><span class="tok-s">&quot;text/html&quot;</span><span class="tok-o">);</span>

        <span class="tok-n">PrintWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;!DOCTYPE HTML PUBLIC \&quot;&quot;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;-//W3C//DTD HTML 4.0 &quot;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;Transitional//EN\&quot;&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;HTML&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;BODY&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;ul&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">Libro</span> <span class="tok-n">libro</span> <span class="tok-o">:</span> <span class="tok-n">listaLibros</span> <span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;li&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">getId</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-s">&quot; - &quot;</span> <span class="tok-o">+</span> <span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">getAutor</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-s">&quot; : &quot;</span> <span class="tok-o">+</span> <span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">getTitulo</span><span class="tok-o">());</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/li&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-o">}</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/ul&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/BODY&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/HTML&quot;</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Inyección del bean gestionado</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Llamada al método de negocio del bean</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Y en segundo lugar <code>src/main/java/org.expertojava.jbibrest.ListaRecomendaciones</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/expertojava/jbibrest/ListaRecomendaciones.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">servlets</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.modelo.Libro</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.modelo.Recomendacion</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.servicio.LibroServicio</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.inject.Inject</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.ServletException</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.annotation.WebServlet</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.http.HttpServlet</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.http.HttpServletRequest</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.servlet.http.HttpServletResponse</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.io.IOException</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.io.PrintWriter</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.List</span><span class="tok-o">;</span>

<span class="tok-nd">@WebServlet</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;listaRecomendaciones&quot;</span><span class="tok-o">,</span> <span class="tok-n">urlPatterns</span><span class="tok-o">=</span><span class="tok-s">&quot;/listaRecomendaciones&quot;</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">ListaRecomendaciones</span> <span class="tok-kd">extends</span> <span class="tok-n">HttpServlet</span> <span class="tok-o">{</span>

    <span class="tok-nd">@Inject</span>
    <span class="tok-n">LibroServicio</span> <span class="tok-n">libroServicio</span><span class="tok-o">;</span>

    <span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">doPost</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                          <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span>  <span class="tok-kd">throws</span>
            <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>

    <span class="tok-o">}</span>

    <span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">doGet</span><span class="tok-o">(</span><span class="tok-n">HttpServletRequest</span> <span class="tok-n">request</span><span class="tok-o">,</span>
                         <span class="tok-n">HttpServletResponse</span> <span class="tok-n">response</span><span class="tok-o">)</span> <span class="tok-kd">throws</span>
    <span class="tok-n">ServletException</span><span class="tok-o">,</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>

        <span class="tok-n">Long</span> <span class="tok-n">libroId</span> <span class="tok-o">=</span> <span class="tok-n">Long</span><span class="tok-o">.</span><span class="tok-na">valueOf</span><span class="tok-o">(</span><span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;libroId&quot;</span><span class="tok-o">));</span>
        <span class="tok-kt">int</span> <span class="tok-n">nRec</span> <span class="tok-o">=</span> <span class="tok-n">Integer</span><span class="tok-o">.</span><span class="tok-na">valueOf</span><span class="tok-o">(</span><span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-na">getParameter</span><span class="tok-o">(</span><span class="tok-s">&quot;numRecomendaciones&quot;</span><span class="tok-o">));</span>

        <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Recomendacion</span><span class="tok-o">&gt;</span> <span class="tok-n">listaRecomendaciones</span>
                <span class="tok-o">=</span> <span class="tok-n">libroServicio</span><span class="tok-o">.</span><span class="tok-na">listaRecomendaciones</span><span class="tok-o">(</span><span class="tok-n">libroId</span><span class="tok-o">,</span> <span class="tok-n">nRec</span><span class="tok-o">);</span>
        <span class="tok-n">Libro</span> <span class="tok-n">libro</span> <span class="tok-o">=</span> <span class="tok-n">libroServicio</span><span class="tok-o">.</span><span class="tok-na">buscaLibroPorId</span><span class="tok-o">(</span><span class="tok-n">libroId</span><span class="tok-o">);</span>

        <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">setContentType</span><span class="tok-o">(</span><span class="tok-s">&quot;text/html&quot;</span><span class="tok-o">);</span>

        <span class="tok-n">PrintWriter</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-na">getWriter</span><span class="tok-o">();</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;!DOCTYPE HTML PUBLIC \&quot;&quot;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;-//W3C//DTD HTML 4.0 &quot;</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot;Transitional//EN\&quot;&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;HTML&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;BODY&gt;&quot;</span><span class="tok-o">);</span>

        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;p&gt; El libro &quot;</span> <span class="tok-o">+</span> <span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">getTitulo</span><span class="tok-o">()</span> <span class="tok-o">+</span>
                <span class="tok-s">&quot; se ha prestado junto con: &lt;/p&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;ul&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">Recomendacion</span> <span class="tok-n">recomendacion</span> <span class="tok-o">:</span> <span class="tok-n">listaRecomendaciones</span> <span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;li&gt;&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">recomendacion</span><span class="tok-o">.</span><span class="tok-na">getLibroRelacionado</span><span class="tok-o">().</span><span class="tok-na">getTitulo</span><span class="tok-o">());</span>
            <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/li&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-o">}</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/ul&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/BODY&gt;&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">&quot;&lt;/HTML&quot;</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_prueba_desde_arquillian">3.2.5. Prueba desde Arquillian</h4>
<div class="paragraph">
<p>También probamos los métodos de negocio desde Arquillian.</p>
</div>
<div class="paragraph">
<p>Creamos la clase <code>TestsLibroServicio.java</code> en el paquete <code>org.expertojava.jbibrest.servicio</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/org/expertojava/jbibrest/servicio/TestsLibroServicio.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">servicio</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.modelo.Libro</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.modelo.Recomendacion</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.persistencia.LibroDao</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.persistencia.RecomendacionDao</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.utils.BibliotecaException</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.arquillian.container.test.api.Deployment</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.arquillian.junit.Arquillian</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.arquillian.persistence.UsingDataSet</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.shrinkwrap.api.ShrinkWrap</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.shrinkwrap.api.asset.EmptyAsset</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.shrinkwrap.api.spec.JavaArchive</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.junit.Test</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.junit.runner.RunWith</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.inject.Inject</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">java.util.List</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">static</span> <span class="tok-n">junit</span><span class="tok-o">.</span><span class="tok-na">framework</span><span class="tok-o">.</span><span class="tok-na">Assert</span><span class="tok-o">.</span><span class="tok-na">assertTrue</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">static</span> <span class="tok-n">junit</span><span class="tok-o">.</span><span class="tok-na">framework</span><span class="tok-o">.</span><span class="tok-na">TestCase</span><span class="tok-o">.</span><span class="tok-na">assertNotNull</span><span class="tok-o">;</span>

<span class="tok-nd">@RunWith</span><span class="tok-o">(</span><span class="tok-n">Arquillian</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">TestsLibroServicio</span> <span class="tok-o">{</span>

    <span class="tok-nd">@Inject</span>
    <span class="tok-n">LibroServicio</span> <span class="tok-n">libroServicio</span><span class="tok-o">;</span>

    <span class="tok-nd">@Deployment</span>
    <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-n">JavaArchive</span> <span class="tok-nf">createDeployment</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">ShrinkWrap</span><span class="tok-o">.</span><span class="tok-na">create</span><span class="tok-o">(</span><span class="tok-n">JavaArchive</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">)</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">Libro</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">LibroDao</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">Recomendacion</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">RecomendacionDao</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">LibroServicio</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">BibliotecaException</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addAsResource</span><span class="tok-o">(</span><span class="tok-s">&quot;persistence-datasource.xml&quot;</span><span class="tok-o">,</span>
                        <span class="tok-s">&quot;META-INF/persistence.xml&quot;</span><span class="tok-o">)</span>
                <span class="tok-o">.</span><span class="tok-na">addAsManifestResource</span><span class="tok-o">(</span><span class="tok-n">EmptyAsset</span><span class="tok-o">.</span><span class="tok-na">INSTANCE</span><span class="tok-o">,</span> <span class="tok-s">&quot;beans.xml&quot;</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">libroServicioNoEsNullTest</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">assertNotNull</span><span class="tok-o">(</span><span class="tok-n">libroServicio</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@UsingDataSet</span><span class="tok-o">(</span><span class="tok-s">&quot;dbunit/dataset1.xml&quot;</span><span class="tok-o">)</span>
    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">buscaLibroPorIdTest</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">Libro</span> <span class="tok-n">libro</span> <span class="tok-o">=</span> <span class="tok-n">libroServicio</span><span class="tok-o">.</span><span class="tok-na">buscaLibroPorId</span><span class="tok-o">(</span><span class="tok-mi">4L</span><span class="tok-o">);</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">libro</span><span class="tok-o">.</span><span class="tok-na">getTitulo</span><span class="tok-o">().</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-s">&quot;Extreme Programming Explained&quot;</span><span class="tok-o">));</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@UsingDataSet</span><span class="tok-o">(</span><span class="tok-s">&quot;dbunit/dataset1.xml&quot;</span><span class="tok-o">)</span>
    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">listaRecomendacionesTest</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Recomendacion</span><span class="tok-o">&gt;</span> <span class="tok-n">recomendaciones</span> <span class="tok-o">=</span> <span class="tok-n">libroServicio</span><span class="tok-o">.</span><span class="tok-na">listaRecomendaciones</span><span class="tok-o">(</span><span class="tok-mi">2L</span><span class="tok-o">,</span> <span class="tok-mi">3</span><span class="tok-o">);</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">recomendaciones</span><span class="tok-o">.</span><span class="tok-na">size</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-mi">2</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_resto_de_la_sesión">3.3. Resto de la sesión</h3>
<div class="paragraph">
<p>Una vez que hemos realizado de forma guiada la primera iteración, debes completar el resto del proyecto siguiendo las pautas anteriores. Dejamos en el tintero algunas funcionalidades, para no hacer demasiado extensa la aplicación.</p>
</div>
<div class="sect3">
<h4 id="_funcionalidades">3.3.1. Funcionalidades</h4>
<div class="paragraph">
<p><strong>Operaciones en la clase <code>LibroServicio</code></strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Creación de libro: se pasan cadenas con isbn, autor y título y se crea una nueva entidad, que se devuelve.</p>
</li>
<li>
<p>Búsqueda de libros por autor: se pasa una cadena de texto y se devuelve la lista de libros que tienen un autor cuyo nombre contiene esa cadena de texto.</p>
</li>
<li>
<p>Búsqueda de libros por título: se pasa una cadena de texto y se devuelve la lista de libros cuyo título contiene esa cadena de texto.</p>
</li>
<li>
<p>Búsqueda de libro por <em>ISBN</em>: se pasa el <em>ISBN del libro</em> y se devuelve el libro con ese ISBN o <code>null</code> si no existe.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Operaciones en la clase <code>EjemplarServicio</code></strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Número ejemplares de un libro: se pasa el <em>identificador del libro</em> y se devuelve el número de ejemplares totales de ese libro.</p>
</li>
<li>
<p>Número ejemplares disponibles: se pasa el <em>identificador del libro</em> y se devuelve el número de ejemplares disponibles de ese libro.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Operaciones en la clase <code>UsuarioServicio</code></strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Obtener información actual de un usuario: se pasa el <em>login del usuario</em> y se obtienen sus datos (un objeto de tipo <code>Usuario</code>): su identificador, sus préstamos activos, su multa, etc.</p>
</li>
<li>
<p>Obener lista de préstamos de un un usuario: se pasa el <em>identificador del usuario</em> y devuelve la colección de préstamos del usuario.</p>
</li>
<li>
<p>Solicitar un préstamo de un libro: se pasa el <em>identificador del usuario</em> y el <em>identificador del libro</em> y se realiza el préstamo de un ejemplar disponible si existe alguno. Se lanza un error si no hay ejemplares disponibles, si el usuario está multado o si supera el número de préstamos permitidos. Si se ha realizado el préstamo con éxito se devuelven los datos del nuevo préstamo.</p>
</li>
<li>
<p>Realizar la devolución de un ejemplar: se pasa el <em>identificador de ejemplar</em>, se cierra el préstamo (se elimina de la lista de préstamos activos y se crea un préstamo histórico) y se crea una multa si la devolución está fuera de plazo. Se devuelve un enumerado con el resultado de la devolución: <code>DEVOLUCIÓN_CORRECTA</code> o <code>DEVOLUCIÓN_FUERA_DE_PLAZO</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_ejemplos_de_pruebas">3.3.2. Ejemplos de pruebas</h4>
<div class="paragraph">
<p>Listamos a continuación algunos ejemplos parciales de las clases de tests.</p>
</div>
<div class="paragraph">
<p>Los datos completos de prueba:</p>
</div>
<div class="listingblock">
<div class="title">/src/test/resources/dbunit/dataset2.xml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;?xml version=&#39;1.0&#39; encoding=&#39;UTF-8&#39;?&gt;</span>
<span class="tok-nt">&lt;dataset&gt;</span>

    <span class="tok-c">&lt;!-- Libros --&gt;</span>

    <span class="tok-nt">&lt;Libro</span> <span class="tok-na">id=</span><span class="tok-s">&quot;1&quot;</span> <span class="tok-na">titulo=</span><span class="tok-s">&quot;Patterns Of Enterprise Application Architecture&quot;</span>
           <span class="tok-na">autor=</span><span class="tok-s">&quot;Martin Fowler&quot;</span> <span class="tok-na">isbn=</span><span class="tok-s">&quot;0321127420&quot;</span> <span class="tok-na">numPaginas=</span><span class="tok-s">&quot;533&quot;</span> <span class="tok-na">portadaURI=</span><span class="tok-s">&quot;0321127420.jpg&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;Libro</span> <span class="tok-na">id=</span><span class="tok-s">&quot;2&quot;</span> <span class="tok-na">titulo=</span><span class="tok-s">&quot;Clean Code&quot;</span> <span class="tok-na">autor=</span><span class="tok-s">&quot;Robert C. Martin&quot;</span>
           <span class="tok-na">isbn=</span><span class="tok-s">&quot;0132350882&quot;</span> <span class="tok-na">numPaginas=</span><span class="tok-s">&quot;288&quot;</span> <span class="tok-na">portadaURI=</span><span class="tok-s">&quot;0132350882.jpg&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;Libro</span> <span class="tok-na">id=</span><span class="tok-s">&quot;3&quot;</span> <span class="tok-na">titulo=</span><span class="tok-s">&quot;Test Driven Development&quot;</span> <span class="tok-na">autor=</span><span class="tok-s">&quot;Kent Beck&quot;</span>
           <span class="tok-na">isbn=</span><span class="tok-s">&quot;0321146530&quot;</span> <span class="tok-na">numPaginas=</span><span class="tok-s">&quot;192&quot;</span> <span class="tok-na">portadaURI=</span><span class="tok-s">&quot;0321146530.jpg&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;Libro</span> <span class="tok-na">id=</span><span class="tok-s">&quot;4&quot;</span> <span class="tok-na">titulo=</span><span class="tok-s">&quot;Extreme Programming Explained&quot;</span> <span class="tok-na">autor=</span><span class="tok-s">&quot;Kent Beck&quot;</span>
           <span class="tok-na">isbn=</span><span class="tok-s">&quot;0321278658&quot;</span> <span class="tok-na">numPaginas=</span><span class="tok-s">&quot;224&quot;</span> <span class="tok-na">portadaURI=</span><span class="tok-s">&quot;0321278658.jpg&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;Libro</span> <span class="tok-na">id=</span><span class="tok-s">&quot;5&quot;</span> <span class="tok-na">titulo=</span><span class="tok-s">&quot;The Art of Computer Programming&quot;</span> <span class="tok-na">autor=</span><span class="tok-s">&quot;Donald E. Knuth&quot;</span>
           <span class="tok-na">isbn=</span><span class="tok-s">&quot;0201896834&quot;</span> <span class="tok-na">numPaginas=</span><span class="tok-s">&quot;144&quot;</span> <span class="tok-na">portadaURI=</span><span class="tok-s">&quot;0321278658.jpg&quot;</span><span class="tok-nt">/&gt;</span>

    <span class="tok-c">&lt;!-- Recomendaciones --&gt;</span>

    <span class="tok-nt">&lt;Recomendacion</span> <span class="tok-na">id=</span><span class="tok-s">&quot;1&quot;</span> <span class="tok-na">libro_id=</span><span class="tok-s">&quot;2&quot;</span> <span class="tok-na">libroRelacionado_id =</span> <span class="tok-s">&quot;3&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;Recomendacion</span> <span class="tok-na">id=</span><span class="tok-s">&quot;2&quot;</span> <span class="tok-na">libro_id=</span><span class="tok-s">&quot;2&quot;</span> <span class="tok-na">libroRelacionado_id =</span> <span class="tok-s">&quot;1&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;Recomendacion</span> <span class="tok-na">id=</span><span class="tok-s">&quot;3&quot;</span> <span class="tok-na">libro_id=</span><span class="tok-s">&quot;3&quot;</span> <span class="tok-na">libroRelacionado_id =</span> <span class="tok-s">&quot;2&quot;</span><span class="tok-nt">/&gt;</span>

    <span class="tok-c">&lt;!-- Usuarios --&gt;</span>

    <span class="tok-nt">&lt;Usuario</span> <span class="tok-na">id=</span><span class="tok-s">&quot;1&quot;</span> <span class="tok-na">tipo=</span><span class="tok-s">&quot;PROFESOR&quot;</span> <span class="tok-na">login=</span><span class="tok-s">&quot;vicente.casamayor&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;Usuario</span> <span class="tok-na">id=</span><span class="tok-s">&quot;2&quot;</span> <span class="tok-na">tipo=</span><span class="tok-s">&quot;ALUMNO&quot;</span> <span class="tok-na">login=</span><span class="tok-s">&quot;antonio.perez&quot;</span> <span class="tok-na">nombre=</span><span class="tok-s">&quot;Antonio&quot;</span>
             <span class="tok-na">apellido1=</span><span class="tok-s">&quot;Pérez&quot;</span> <span class="tok-na">apellido2=</span><span class="tok-s">&quot;Martínez&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;Usuario</span> <span class="tok-na">id=</span><span class="tok-s">&quot;3&quot;</span> <span class="tok-na">tipo=</span><span class="tok-s">&quot;ALUMNO&quot;</span> <span class="tok-na">login=</span><span class="tok-s">&quot;anabel.garcia&quot;</span> <span class="tok-na">nombre=</span><span class="tok-s">&quot;Anabel&quot;</span>
             <span class="tok-na">apellido1=</span><span class="tok-s">&quot;Garcia&quot;</span> <span class="tok-na">apellido2=</span><span class="tok-s">&quot;Sierra&quot;</span><span class="tok-nt">/&gt;</span>

    <span class="tok-c">&lt;!-- Ejemplares --&gt;</span>

    <span class="tok-nt">&lt;Ejemplar</span> <span class="tok-na">id=</span><span class="tok-s">&quot;1&quot;</span> <span class="tok-na">codigoEjemplar=</span><span class="tok-s">&quot;001&quot;</span> <span class="tok-na">fechaAdquisicion=</span><span class="tok-s">&quot;2014-10-01&quot;</span>
              <span class="tok-na">libroId=</span><span class="tok-s">&quot;1&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;Ejemplar</span> <span class="tok-na">id=</span><span class="tok-s">&quot;2&quot;</span> <span class="tok-na">codigoEjemplar=</span><span class="tok-s">&quot;002&quot;</span> <span class="tok-na">fechaAdquisicion=</span><span class="tok-s">&quot;2014-10-01&quot;</span>
              <span class="tok-na">libroId=</span><span class="tok-s">&quot;1&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;Ejemplar</span> <span class="tok-na">id=</span><span class="tok-s">&quot;3&quot;</span> <span class="tok-na">codigoEjemplar=</span><span class="tok-s">&quot;001&quot;</span> <span class="tok-na">fechaAdquisicion=</span><span class="tok-s">&quot;2014-11-01&quot;</span>
              <span class="tok-na">libroId=</span><span class="tok-s">&quot;2&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;Ejemplar</span> <span class="tok-na">id=</span><span class="tok-s">&quot;4&quot;</span> <span class="tok-na">codigoEjemplar=</span><span class="tok-s">&quot;001&quot;</span> <span class="tok-na">fechaAdquisicion=</span><span class="tok-s">&quot;2014-11-21&quot;</span>
              <span class="tok-na">libroId=</span><span class="tok-s">&quot;3&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;Ejemplar</span> <span class="tok-na">id=</span><span class="tok-s">&quot;5&quot;</span> <span class="tok-na">codigoEjemplar=</span><span class="tok-s">&quot;003&quot;</span> <span class="tok-na">fechaAdquisicion=</span><span class="tok-s">&quot;2014-10-01&quot;</span>
              <span class="tok-na">libroId=</span><span class="tok-s">&quot;1&quot;</span><span class="tok-nt">/&gt;</span>

    <span class="tok-c">&lt;!-- Prestamos activos --&gt;</span>

    <span class="tok-nt">&lt;Prestamo</span> <span class="tok-na">id=</span><span class="tok-s">&quot;2&quot;</span> <span class="tok-na">ejemplar_id=</span><span class="tok-s">&quot;4&quot;</span> <span class="tok-na">usuario_id=</span><span class="tok-s">&quot;2&quot;</span> <span class="tok-na">fecha=</span><span class="tok-s">&quot;2014-12-01&quot;</span>
              <span class="tok-na">deberiaDevolverseEl=</span><span class="tok-s">&quot;2014-12-05&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;Prestamo</span> <span class="tok-na">id=</span><span class="tok-s">&quot;3&quot;</span> <span class="tok-na">ejemplar_id=</span><span class="tok-s">&quot;2&quot;</span> <span class="tok-na">usuario_id=</span><span class="tok-s">&quot;1&quot;</span> <span class="tok-na">fecha=</span><span class="tok-s">&quot;2014-11-01&quot;</span>
              <span class="tok-na">deberiaDevolverseEl=</span><span class="tok-s">&quot;2014-11-30&quot;</span><span class="tok-nt">/&gt;</span>
    <span class="tok-nt">&lt;Prestamo</span> <span class="tok-na">id=</span><span class="tok-s">&quot;4&quot;</span> <span class="tok-na">ejemplar_id=</span><span class="tok-s">&quot;3&quot;</span> <span class="tok-na">usuario_id=</span><span class="tok-s">&quot;1&quot;</span> <span class="tok-na">fecha=</span><span class="tok-s">&quot;2014-11-01&quot;</span>
              <span class="tok-na">deberiaDevolverseEl=</span><span class="tok-s">&quot;2014-11-30&quot;</span><span class="tok-nt">/&gt;</span>

    <span class="tok-c">&lt;!-- Multas --&gt;</span>

    <span class="tok-nt">&lt;Multa</span> <span class="tok-na">id=</span><span class="tok-s">&quot;1&quot;</span> <span class="tok-na">desde=</span><span class="tok-s">&quot;2014-12-02&quot;</span> <span class="tok-na">hasta=</span><span class="tok-s">&quot;2015-12-12&quot;</span> <span class="tok-na">usuario_id=</span><span class="tok-s">&quot;3&quot;</span><span class="tok-nt">/&gt;</span>

<span class="tok-nt">&lt;/dataset&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Algunos tests de la clase <code>TestsUsuarioAggregate</code> que prueba las entidades del agregado <code>Usuario</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/org/expertojava/jbibrest/persistencia/TestsUsuarioAggregate.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">persistencia</span><span class="tok-o">;</span>

<span class="tok-c1">// Imports</span>

<span class="tok-c1">//</span>
<span class="tok-c1">// Tests del aggregate formado por las entidades Usuario, Prestamo</span>
<span class="tok-c1">// Ejemplar y Multa</span>
<span class="tok-c1">//</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">TestUsuarioAggregate</span> <span class="tok-o">{</span>
    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">EntityManagerFactory</span> <span class="tok-n">emf</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">IDatabaseConnection</span> <span class="tok-n">connection</span><span class="tok-o">;</span>
    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">IDataSet</span> <span class="tok-n">dataset</span><span class="tok-o">;</span>

    <span class="tok-nd">@BeforeClass</span>
    <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-kt">void</span> <span class="tok-nf">initAllTests</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">try</span> <span class="tok-o">{</span>
            <span class="tok-c1">// Inicializamos sólo una vez el emf antes de todos los tests</span>
            <span class="tok-n">emf</span> <span class="tok-o">=</span> <span class="tok-n">Persistence</span><span class="tok-o">.</span><span class="tok-na">createEntityManagerFactory</span><span class="tok-o">(</span><span class="tok-s">&quot;biblioteca-local&quot;</span><span class="tok-o">);</span>

            <span class="tok-c1">// Inicializamos la conexión a la BD necesaria para</span>
            <span class="tok-c1">// que DBUnit cargue los datos de los tests</span>
            <span class="tok-n">Class</span><span class="tok-o">.</span><span class="tok-na">forName</span><span class="tok-o">(</span><span class="tok-s">&quot;com.mysql.jdbc.Driver&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">Connection</span> <span class="tok-n">jdbcConnection</span> <span class="tok-o">=</span> <span class="tok-n">DriverManager</span>
                    <span class="tok-o">.</span><span class="tok-na">getConnection</span><span class="tok-o">(</span>
                            <span class="tok-s">&quot;jdbc:mysql://localhost:3306/biblioteca&quot;</span><span class="tok-o">,</span>
                            <span class="tok-s">&quot;root&quot;</span><span class="tok-o">,</span> <span class="tok-s">&quot;expertojava&quot;</span><span class="tok-o">);</span>
            <span class="tok-n">connection</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">DatabaseConnection</span><span class="tok-o">(</span><span class="tok-n">jdbcConnection</span><span class="tok-o">);</span>

            <span class="tok-c1">// 2 líneas para eliminar el warning</span>
            <span class="tok-n">DatabaseConfig</span> <span class="tok-n">dbConfig</span> <span class="tok-o">=</span> <span class="tok-n">connection</span><span class="tok-o">.</span><span class="tok-na">getConfig</span><span class="tok-o">();</span>
            <span class="tok-n">dbConfig</span><span class="tok-o">.</span><span class="tok-na">setProperty</span><span class="tok-o">(</span><span class="tok-n">DatabaseConfig</span><span class="tok-o">.</span><span class="tok-na">PROPERTY_DATATYPE_FACTORY</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-nf">MySqlDataTypeFactory</span><span class="tok-o">());</span>

            <span class="tok-c1">// Inicializamos el dataset</span>
            <span class="tok-n">FlatXmlDataSetBuilder</span> <span class="tok-n">flatXmlDataSetBuilder</span> <span class="tok-o">=</span>
                    <span class="tok-k">new</span> <span class="tok-nf">FlatXmlDataSetBuilder</span><span class="tok-o">();</span>
            <span class="tok-n">flatXmlDataSetBuilder</span><span class="tok-o">.</span><span class="tok-na">setColumnSensing</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">);</span>
            <span class="tok-n">dataset</span> <span class="tok-o">=</span> <span class="tok-n">flatXmlDataSetBuilder</span><span class="tok-o">.</span><span class="tok-na">build</span><span class="tok-o">(</span><span class="tok-n">Thread</span><span class="tok-o">.</span><span class="tok-na">currentThread</span><span class="tok-o">()</span>
                    <span class="tok-o">.</span><span class="tok-na">getContextClassLoader</span><span class="tok-o">()</span>
                    <span class="tok-o">.</span><span class="tok-na">getResourceAsStream</span><span class="tok-o">(</span><span class="tok-s">&quot;dbunit/dataset2.xml&quot;</span><span class="tok-o">));</span>
        <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">Exception</span> <span class="tok-n">ex</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">ex</span><span class="tok-o">.</span><span class="tok-na">printStackTrace</span><span class="tok-o">();</span>
            <span class="tok-n">fail</span><span class="tok-o">(</span><span class="tok-s">&quot;Excepción al inicializar el emf y DbUnit&quot;</span><span class="tok-o">);</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>

    <span class="tok-c1">// Se ejecuta antes de cada test</span>
    <span class="tok-nd">@Before</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">cleanDB</span><span class="tok-o">()</span> <span class="tok-kd">throws</span> <span class="tok-n">Exception</span> <span class="tok-o">{</span>
        <span class="tok-c1">// Se hace un &quot;clean insert&quot; de los datos de prueba</span>
        <span class="tok-c1">// definidos en el fichero XML. El &quot;clean insert&quot; vacía las</span>
        <span class="tok-c1">// tablas de los datos de prueba y después inserta los datos</span>
        <span class="tok-n">DatabaseOperation</span><span class="tok-o">.</span><span class="tok-na">CLEAN_INSERT</span><span class="tok-o">.</span><span class="tok-na">execute</span><span class="tok-o">(</span><span class="tok-n">connection</span><span class="tok-o">,</span> <span class="tok-n">dataset</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">cargaDataSetTest</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">usuarioRecuperadoContienePrestamos</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">Usuario</span> <span class="tok-n">usuario</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Usuario</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">1L</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">usuario</span><span class="tok-o">.</span><span class="tok-na">getPrestamos</span><span class="tok-o">().</span><span class="tok-na">size</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-mi">2</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">usuarioRecuperadoContieneMulta</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">Usuario</span> <span class="tok-n">usuario</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Usuario</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">3L</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">usuario</span><span class="tok-o">.</span><span class="tok-na">getMulta</span><span class="tok-o">().</span><span class="tok-na">getId</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-mi">1L</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">eliminaPrestamoDeUsuarioyEjemplar</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">begin</span><span class="tok-o">();</span>
        <span class="tok-n">Usuario</span> <span class="tok-n">usuario</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Usuario</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">1L</span><span class="tok-o">);</span>
        <span class="tok-n">Ejemplar</span> <span class="tok-n">ejemplar</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Ejemplar</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">2L</span><span class="tok-o">);</span>
        <span class="tok-n">Prestamo</span> <span class="tok-n">prestamo</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Prestamo</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">3L</span><span class="tok-o">);</span>
        <span class="tok-n">usuario</span><span class="tok-o">.</span><span class="tok-na">quitaPrestamo</span><span class="tok-o">(</span><span class="tok-n">prestamo</span><span class="tok-o">);</span>
        <span class="tok-n">ejemplar</span><span class="tok-o">.</span><span class="tok-na">quitaPrestamo</span><span class="tok-o">();</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">remove</span><span class="tok-o">(</span><span class="tok-n">prestamo</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">();</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>

        <span class="tok-c1">// Comprobamos que la relación se ha actualizado en memoria</span>

        <span class="tok-n">assertFalse</span><span class="tok-o">(</span><span class="tok-n">usuario</span><span class="tok-o">.</span><span class="tok-na">getPrestamos</span><span class="tok-o">().</span><span class="tok-na">contains</span><span class="tok-o">(</span><span class="tok-n">prestamo</span><span class="tok-o">));</span>
        <span class="tok-n">assertNull</span><span class="tok-o">(</span><span class="tok-n">ejemplar</span><span class="tok-o">.</span><span class="tok-na">getPrestamo</span><span class="tok-o">());</span>

        <span class="tok-c1">// Comprobamos que la relación se ha actualizado en BD</span>

        <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">prestamo</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Prestamo</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">3L</span><span class="tok-o">);</span>
        <span class="tok-n">usuario</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Usuario</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">1L</span><span class="tok-o">);</span>
        <span class="tok-n">ejemplar</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Ejemplar</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">2L</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>

        <span class="tok-n">assertFalse</span><span class="tok-o">(</span><span class="tok-n">usuario</span><span class="tok-o">.</span><span class="tok-na">getPrestamos</span><span class="tok-o">().</span><span class="tok-na">contains</span><span class="tok-o">(</span><span class="tok-n">prestamo</span><span class="tok-o">));</span>
        <span class="tok-n">assertNull</span><span class="tok-o">(</span><span class="tok-n">ejemplar</span><span class="tok-o">.</span><span class="tok-na">getPrestamo</span><span class="tok-o">());</span>
        <span class="tok-n">assertNull</span><span class="tok-o">(</span><span class="tok-n">prestamo</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span><span class="tok-o">(</span><span class="tok-n">expected</span> <span class="tok-o">=</span> <span class="tok-n">BibliotecaException</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">)</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">eliminaPrestamoDeUsuarioLanzaExcepcionCuandoPrestamoNoEsDeUsuario</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-k">try</span> <span class="tok-o">{</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">begin</span><span class="tok-o">();</span>
            <span class="tok-n">Usuario</span> <span class="tok-n">usuario</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Usuario</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">1L</span><span class="tok-o">);</span>
            <span class="tok-n">Prestamo</span> <span class="tok-n">prestamo</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Prestamo</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">2L</span><span class="tok-o">);</span>
            <span class="tok-n">usuario</span><span class="tok-o">.</span><span class="tok-na">quitaPrestamo</span><span class="tok-o">(</span><span class="tok-n">prestamo</span><span class="tok-o">);</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">();</span>
        <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">Exception</span> <span class="tok-n">ex</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">rollback</span><span class="tok-o">();</span>
            <span class="tok-k">throw</span> <span class="tok-n">ex</span><span class="tok-o">;</span>
        <span class="tok-o">}</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">prestamoCreadoConUsuarioyEjemplarActualizaCorrectamenteEntidades</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">EntityManager</span> <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">begin</span><span class="tok-o">();</span>
        <span class="tok-n">Ejemplar</span> <span class="tok-n">ejemplar</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Ejemplar</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">1L</span><span class="tok-o">);</span>
        <span class="tok-n">Usuario</span> <span class="tok-n">usuario</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Usuario</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">2L</span><span class="tok-o">);</span>
        <span class="tok-n">Date</span> <span class="tok-n">fechaInicio</span> <span class="tok-o">=</span> <span class="tok-n">Utils</span><span class="tok-o">.</span><span class="tok-na">stringToDate</span><span class="tok-o">(</span><span class="tok-s">&quot;08-11-2015&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">Date</span> <span class="tok-n">fechaDevolucion</span> <span class="tok-o">=</span> <span class="tok-n">BibliotecaBR</span><span class="tok-o">.</span><span class="tok-na">getInstance</span><span class="tok-o">().</span><span class="tok-na">fechaDevolucionPrestamo</span><span class="tok-o">(</span><span class="tok-n">usuario</span><span class="tok-o">,</span> <span class="tok-n">fechaInicio</span><span class="tok-o">);</span>
        <span class="tok-n">Prestamo</span> <span class="tok-n">prestamo</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">Prestamo</span><span class="tok-o">(</span><span class="tok-n">usuario</span><span class="tok-o">,</span> <span class="tok-n">ejemplar</span><span class="tok-o">,</span> <span class="tok-n">fechaInicio</span><span class="tok-o">,</span> <span class="tok-n">fechaDevolucion</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">persist</span><span class="tok-o">(</span><span class="tok-n">prestamo</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">flush</span><span class="tok-o">();</span>
        <span class="tok-n">Long</span> <span class="tok-n">prestamoId</span> <span class="tok-o">=</span> <span class="tok-n">prestamo</span><span class="tok-o">.</span><span class="tok-na">getId</span><span class="tok-o">();</span>
        <span class="tok-n">usuario</span><span class="tok-o">.</span><span class="tok-na">añadePrestamo</span><span class="tok-o">(</span><span class="tok-n">prestamo</span><span class="tok-o">);</span>
        <span class="tok-n">ejemplar</span><span class="tok-o">.</span><span class="tok-na">setPrestamo</span><span class="tok-o">(</span><span class="tok-n">prestamo</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">getTransaction</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">();</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>

        <span class="tok-c1">// Comprobamos que la relación se ha actualizado en memoria</span>

        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">ejemplar</span><span class="tok-o">.</span><span class="tok-na">getPrestamo</span><span class="tok-o">().</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">prestamo</span><span class="tok-o">));</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">usuario</span><span class="tok-o">.</span><span class="tok-na">getPrestamos</span><span class="tok-o">().</span><span class="tok-na">contains</span><span class="tok-o">(</span><span class="tok-n">prestamo</span><span class="tok-o">));</span>

        <span class="tok-c1">// Comprobamos que la relación se ha actualizado en BD</span>

        <span class="tok-n">em</span> <span class="tok-o">=</span> <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">createEntityManager</span><span class="tok-o">();</span>
        <span class="tok-n">prestamo</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Prestamo</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-n">prestamoId</span><span class="tok-o">);</span>
        <span class="tok-n">ejemplar</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Ejemplar</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">1L</span><span class="tok-o">);</span>
        <span class="tok-n">usuario</span> <span class="tok-o">=</span> <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-n">Usuario</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">,</span> <span class="tok-mi">2L</span><span class="tok-o">);</span>
        <span class="tok-n">em</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">ejemplar</span><span class="tok-o">.</span><span class="tok-na">getPrestamo</span><span class="tok-o">().</span><span class="tok-na">equals</span><span class="tok-o">(</span><span class="tok-n">prestamo</span><span class="tok-o">));</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">usuario</span><span class="tok-o">.</span><span class="tok-na">getPrestamos</span><span class="tok-o">().</span><span class="tok-na">contains</span><span class="tok-o">(</span><span class="tok-n">prestamo</span><span class="tok-o">));</span>
    <span class="tok-o">}</span>

    <span class="tok-c1">// Se ejecuta una vez después de todos los tests</span>
    <span class="tok-nd">@AfterClass</span>
    <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-kt">void</span> <span class="tok-nf">closeEntityManagerFactory</span><span class="tok-o">()</span> <span class="tok-kd">throws</span> <span class="tok-n">Exception</span> <span class="tok-o">{</span>
        <span class="tok-c1">// Borramos todos los datos y cerramos la conexión</span>
        <span class="tok-c1">//DatabaseOperation.DELETE_ALL.execute(connection, dataset);</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">emf</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">)</span>
            <span class="tok-n">emf</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La clase <code>TestsUsuarioAggregateArquillian.java</code> contiene las pruebas de los DAOs del agregado <code>Usuario</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/org/expertojava/jbibrest/persistencia/TestsUsuarioAggregateArquillian.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">persistencia</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.modelo.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.utils.BibliotecaException</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.arquillian.container.test.api.Deployment</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.arquillian.junit.Arquillian</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.arquillian.junit.InSequence</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.arquillian.persistence.Cleanup</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.arquillian.persistence.CleanupStrategy</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.arquillian.persistence.TestExecutionPhase</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.arquillian.persistence.UsingDataSet</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.shrinkwrap.api.ShrinkWrap</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.shrinkwrap.api.asset.EmptyAsset</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.shrinkwrap.api.spec.JavaArchive</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.junit.Test</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.junit.runner.RunWith</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.inject.Inject</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">javax.persistence.EntityManager</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">java.util.List</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">junit</span><span class="tok-o">.</span><span class="tok-na">Assert</span><span class="tok-o">.*;</span>
<span class="tok-kn">import</span> <span class="tok-nn">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">junit</span><span class="tok-o">.</span><span class="tok-na">Assert</span><span class="tok-o">.</span><span class="tok-na">assertFalse</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">junit</span><span class="tok-o">.</span><span class="tok-na">Assert</span><span class="tok-o">.</span><span class="tok-na">assertNull</span><span class="tok-o">;</span>

<span class="tok-nd">@RunWith</span><span class="tok-o">(</span><span class="tok-n">Arquillian</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">TestUsuarioAggregateArquillian</span> <span class="tok-o">{</span>

    <span class="tok-nd">@Inject</span>
    <span class="tok-n">UsuarioDao</span> <span class="tok-n">usuarioDao</span><span class="tok-o">;</span>
    <span class="tok-nd">@Inject</span>
    <span class="tok-n">PrestamoDao</span> <span class="tok-n">prestamoDao</span><span class="tok-o">;</span>
    <span class="tok-nd">@Inject</span>
    <span class="tok-n">EjemplarDao</span> <span class="tok-n">ejemplarDao</span><span class="tok-o">;</span>
    <span class="tok-nd">@Inject</span>
    <span class="tok-n">MultaDao</span> <span class="tok-n">multaDao</span><span class="tok-o">;</span>

    <span class="tok-nd">@Deployment</span>
    <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-n">JavaArchive</span> <span class="tok-nf">createDeployment</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">ShrinkWrap</span><span class="tok-o">.</span><span class="tok-na">create</span><span class="tok-o">(</span><span class="tok-n">JavaArchive</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">)</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">Alumno</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">Profesor</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">Direccion</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">Multa</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">Prestamo</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">Usuario</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">Dao</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">EjemplarDao</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">MultaDao</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">PrestamoDao</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">UsuarioDao</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">BibliotecaException</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addAsResource</span><span class="tok-o">(</span><span class="tok-s">&quot;persistence-datasource.xml&quot;</span><span class="tok-o">,</span>
                        <span class="tok-s">&quot;META-INF/persistence.xml&quot;</span><span class="tok-o">)</span>
                <span class="tok-o">.</span><span class="tok-na">addAsManifestResource</span><span class="tok-o">(</span><span class="tok-n">EmptyAsset</span><span class="tok-o">.</span><span class="tok-na">INSTANCE</span><span class="tok-o">,</span> <span class="tok-s">&quot;beans.xml&quot;</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@UsingDataSet</span><span class="tok-o">(</span><span class="tok-s">&quot;dbunit/dataset2.xml&quot;</span><span class="tok-o">)</span>
    <span class="tok-nd">@Cleanup</span><span class="tok-o">(</span><span class="tok-n">phase</span> <span class="tok-o">=</span> <span class="tok-n">TestExecutionPhase</span><span class="tok-o">.</span><span class="tok-na">BEFORE</span><span class="tok-o">,</span> <span class="tok-n">strategy</span> <span class="tok-o">=</span> <span class="tok-n">CleanupStrategy</span><span class="tok-o">.</span><span class="tok-na">USED_TABLES_ONLY</span><span class="tok-o">)</span>
    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">daosNoSonNullTest</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">assertNotNull</span><span class="tok-o">(</span><span class="tok-n">usuarioDao</span><span class="tok-o">);</span>
        <span class="tok-n">assertNotNull</span><span class="tok-o">(</span><span class="tok-n">prestamoDao</span><span class="tok-o">);</span>
        <span class="tok-n">assertNotNull</span><span class="tok-o">(</span><span class="tok-n">ejemplarDao</span><span class="tok-o">);</span>
        <span class="tok-n">assertNotNull</span><span class="tok-o">(</span><span class="tok-n">multaDao</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@UsingDataSet</span><span class="tok-o">(</span><span class="tok-s">&quot;dbunit/dataset2.xml&quot;</span><span class="tok-o">)</span>
    <span class="tok-nd">@Cleanup</span><span class="tok-o">(</span><span class="tok-n">phase</span> <span class="tok-o">=</span> <span class="tok-n">TestExecutionPhase</span><span class="tok-o">.</span><span class="tok-na">BEFORE</span><span class="tok-o">,</span> <span class="tok-n">strategy</span> <span class="tok-o">=</span> <span class="tok-n">CleanupStrategy</span><span class="tok-o">.</span><span class="tok-na">USED_TABLES_ONLY</span><span class="tok-o">)</span>
    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">usuarioRecuperadoContienePrestamos</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">Usuario</span> <span class="tok-n">usuario</span> <span class="tok-o">=</span> <span class="tok-n">usuarioDao</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-mi">1L</span><span class="tok-o">);</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">usuario</span><span class="tok-o">.</span><span class="tok-na">getPrestamos</span><span class="tok-o">().</span><span class="tok-na">size</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-mi">2</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Cleanup</span><span class="tok-o">(</span><span class="tok-n">phase</span> <span class="tok-o">=</span> <span class="tok-n">TestExecutionPhase</span><span class="tok-o">.</span><span class="tok-na">BEFORE</span><span class="tok-o">,</span>  <span class="tok-n">strategy</span> <span class="tok-o">=</span> <span class="tok-n">CleanupStrategy</span><span class="tok-o">.</span><span class="tok-na">USED_TABLES_ONLY</span><span class="tok-o">)</span>
    <span class="tok-nd">@UsingDataSet</span><span class="tok-o">(</span><span class="tok-s">&quot;dbunit/dataset2.xml&quot;</span><span class="tok-o">)</span>
    <span class="tok-nd">@Test</span>
    <span class="tok-nd">@InSequence</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">eliminaPrestamoDeUsuarioyEjemplar</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">Usuario</span> <span class="tok-n">usuario</span> <span class="tok-o">=</span> <span class="tok-n">usuarioDao</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-mi">1L</span><span class="tok-o">);</span>
        <span class="tok-n">Ejemplar</span> <span class="tok-n">ejemplar</span> <span class="tok-o">=</span> <span class="tok-n">ejemplarDao</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-mi">2L</span><span class="tok-o">);</span>
        <span class="tok-n">Prestamo</span> <span class="tok-n">prestamo</span> <span class="tok-o">=</span> <span class="tok-n">prestamoDao</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-mi">3L</span><span class="tok-o">);</span>
        <span class="tok-n">usuario</span><span class="tok-o">.</span><span class="tok-na">quitaPrestamo</span><span class="tok-o">(</span><span class="tok-n">prestamo</span><span class="tok-o">);</span>
        <span class="tok-n">usuarioDao</span><span class="tok-o">.</span><span class="tok-na">update</span><span class="tok-o">(</span><span class="tok-n">usuario</span><span class="tok-o">);</span>
        <span class="tok-n">ejemplar</span><span class="tok-o">.</span><span class="tok-na">quitaPrestamo</span><span class="tok-o">();</span>
        <span class="tok-n">ejemplarDao</span><span class="tok-o">.</span><span class="tok-na">update</span><span class="tok-o">(</span><span class="tok-n">ejemplar</span><span class="tok-o">);</span>
        <span class="tok-n">prestamoDao</span><span class="tok-o">.</span><span class="tok-na">delete</span><span class="tok-o">(</span><span class="tok-n">prestamo</span><span class="tok-o">);</span>

        <span class="tok-c1">// Comprobamos que la relación se ha actualizado en memoria</span>

        <span class="tok-n">assertFalse</span><span class="tok-o">(</span><span class="tok-n">usuario</span><span class="tok-o">.</span><span class="tok-na">getPrestamos</span><span class="tok-o">().</span><span class="tok-na">contains</span><span class="tok-o">(</span><span class="tok-n">prestamo</span><span class="tok-o">));</span>
        <span class="tok-n">assertNull</span><span class="tok-o">(</span><span class="tok-n">ejemplar</span><span class="tok-o">.</span><span class="tok-na">getPrestamo</span><span class="tok-o">());</span>
    <span class="tok-o">}</span>

    <span class="tok-c1">// Ponemos la anotación NONE para que no se borren los datos de las tablas</span>
    <span class="tok-c1">// y podamos comprobar el resultado de la acción anterior en la que se ha</span>
    <span class="tok-c1">// eliminado un préstamo. Utilizamos también InSequence para asegurar que</span>
    <span class="tok-c1">// los tests se ejecutan en el orden correcto.</span>
    <span class="tok-nd">@Cleanup</span><span class="tok-o">(</span><span class="tok-n">phase</span> <span class="tok-o">=</span> <span class="tok-n">TestExecutionPhase</span><span class="tok-o">.</span><span class="tok-na">NONE</span><span class="tok-o">)</span>
    <span class="tok-nd">@Test</span>
    <span class="tok-nd">@InSequence</span><span class="tok-o">(</span><span class="tok-mi">2</span><span class="tok-o">)</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">compruebaPrestamoEliminado</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">Prestamo</span> <span class="tok-n">prestamo</span> <span class="tok-o">=</span> <span class="tok-n">prestamoDao</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-mi">3L</span><span class="tok-o">);</span>
        <span class="tok-n">Usuario</span> <span class="tok-n">usuario</span> <span class="tok-o">=</span> <span class="tok-n">usuarioDao</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-mi">1L</span><span class="tok-o">);</span>
        <span class="tok-n">Ejemplar</span> <span class="tok-n">ejemplar</span> <span class="tok-o">=</span> <span class="tok-n">ejemplarDao</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-mi">2L</span><span class="tok-o">);</span>

        <span class="tok-n">assertFalse</span><span class="tok-o">(</span><span class="tok-n">usuario</span><span class="tok-o">.</span><span class="tok-na">getPrestamos</span><span class="tok-o">().</span><span class="tok-na">contains</span><span class="tok-o">(</span><span class="tok-n">prestamo</span><span class="tok-o">));</span>
        <span class="tok-n">assertNull</span><span class="tok-o">(</span><span class="tok-n">ejemplar</span><span class="tok-o">.</span><span class="tok-na">getPrestamo</span><span class="tok-o">());</span>
        <span class="tok-n">assertNull</span><span class="tok-o">(</span><span class="tok-n">prestamo</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@Cleanup</span><span class="tok-o">(</span><span class="tok-n">phase</span> <span class="tok-o">=</span> <span class="tok-n">TestExecutionPhase</span><span class="tok-o">.</span><span class="tok-na">BEFORE</span><span class="tok-o">,</span>  <span class="tok-n">strategy</span> <span class="tok-o">=</span> <span class="tok-n">CleanupStrategy</span><span class="tok-o">.</span><span class="tok-na">USED_TABLES_ONLY</span><span class="tok-o">)</span>
    <span class="tok-nd">@UsingDataSet</span><span class="tok-o">(</span><span class="tok-s">&quot;dbunit/dataset2.xml&quot;</span><span class="tok-o">)</span>
    <span class="tok-nd">@Test</span>
    <span class="tok-nd">@InSequence</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">)</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">eliminaMultaDeUsuario</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">Usuario</span> <span class="tok-n">usuario</span> <span class="tok-o">=</span> <span class="tok-n">usuarioDao</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-mi">3L</span><span class="tok-o">);</span>
        <span class="tok-n">Multa</span> <span class="tok-n">multa</span> <span class="tok-o">=</span> <span class="tok-n">usuario</span><span class="tok-o">.</span><span class="tok-na">getMulta</span><span class="tok-o">();</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">multa</span><span class="tok-o">.</span><span class="tok-na">getId</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-mi">1L</span><span class="tok-o">);</span>
        <span class="tok-n">usuario</span><span class="tok-o">.</span><span class="tok-na">quitaMulta</span><span class="tok-o">();</span>
        <span class="tok-n">usuarioDao</span><span class="tok-o">.</span><span class="tok-na">update</span><span class="tok-o">(</span><span class="tok-n">usuario</span><span class="tok-o">);</span>
        <span class="tok-n">multaDao</span><span class="tok-o">.</span><span class="tok-na">delete</span><span class="tok-o">(</span><span class="tok-n">multa</span><span class="tok-o">);</span>
        <span class="tok-n">assertNull</span><span class="tok-o">(</span><span class="tok-n">usuario</span><span class="tok-o">.</span><span class="tok-na">getMulta</span><span class="tok-o">());</span>
    <span class="tok-o">}</span>

    <span class="tok-c1">// Igual que antes, en el test compruebaPrestamoEliminado</span>
    <span class="tok-nd">@Cleanup</span><span class="tok-o">(</span><span class="tok-n">phase</span> <span class="tok-o">=</span> <span class="tok-n">TestExecutionPhase</span><span class="tok-o">.</span><span class="tok-na">NONE</span><span class="tok-o">)</span>
    <span class="tok-nd">@Test</span>
    <span class="tok-nd">@InSequence</span><span class="tok-o">(</span><span class="tok-mi">4</span><span class="tok-o">)</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">compuebaMultaEliminada</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">Multa</span> <span class="tok-n">multa</span> <span class="tok-o">=</span> <span class="tok-n">multaDao</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-mi">1L</span><span class="tok-o">);</span>
        <span class="tok-n">Usuario</span> <span class="tok-n">usuario</span> <span class="tok-o">=</span> <span class="tok-n">usuarioDao</span><span class="tok-o">.</span><span class="tok-na">find</span><span class="tok-o">(</span><span class="tok-mi">3L</span><span class="tok-o">);</span>
        <span class="tok-n">assertNull</span><span class="tok-o">(</span><span class="tok-n">usuario</span><span class="tok-o">.</span><span class="tok-na">getMulta</span><span class="tok-o">());</span>
        <span class="tok-n">assertNull</span><span class="tok-o">(</span><span class="tok-n">multa</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-c1">// Pruebas EjemplarDao</span>

    <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La clase <code>TestsUsuarioServicio</code> contiene las pruebas de los métodos de negocio de <code>UsuarioServicio</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/org/expertojava/jbibrest/servicio/TestsUsuarioServicio.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">servicio</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.modelo.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.persistencia.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.utils.BibliotecaBR</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.utils.BibliotecaException</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.expertojava.jbibrest.utils.FechaActualStub</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.arquillian.container.test.api.Deployment</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.arquillian.junit.Arquillian</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.arquillian.persistence.Cleanup</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.arquillian.persistence.CleanupStrategy</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.arquillian.persistence.TestExecutionPhase</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.arquillian.persistence.UsingDataSet</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.shrinkwrap.api.ShrinkWrap</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.shrinkwrap.api.asset.EmptyAsset</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.jboss.shrinkwrap.api.spec.JavaArchive</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.junit.Assert</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.junit.Test</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.junit.runner.RunWith</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">javax.inject.Inject</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.List</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">static</span> <span class="tok-n">junit</span><span class="tok-o">.</span><span class="tok-na">framework</span><span class="tok-o">.</span><span class="tok-na">Assert</span><span class="tok-o">.</span><span class="tok-na">assertTrue</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">static</span> <span class="tok-n">junit</span><span class="tok-o">.</span><span class="tok-na">framework</span><span class="tok-o">.</span><span class="tok-na">TestCase</span><span class="tok-o">.</span><span class="tok-na">assertNotNull</span><span class="tok-o">;</span>

<span class="tok-nd">@RunWith</span><span class="tok-o">(</span><span class="tok-n">Arquillian</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">TestsUsuarioServicio</span> <span class="tok-o">{</span>

    <span class="tok-nd">@Inject</span>
    <span class="tok-n">UsuarioServicio</span> <span class="tok-n">usuarioServicio</span><span class="tok-o">;</span>

    <span class="tok-nd">@Deployment</span>
    <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-n">JavaArchive</span> <span class="tok-nf">createDeployment</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-n">ShrinkWrap</span><span class="tok-o">.</span><span class="tok-na">create</span><span class="tok-o">(</span><span class="tok-n">JavaArchive</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">)</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">Alumno</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">Profesor</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">Direccion</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">Multa</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">Prestamo</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">Usuario</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">EjemplarDao</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">MultaDao</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">PrestamoDao</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">UsuarioDao</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">BibliotecaException</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addPackage</span><span class="tok-o">(</span><span class="tok-n">UsuarioServicio</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">.</span><span class="tok-na">getPackage</span><span class="tok-o">())</span>
                <span class="tok-o">.</span><span class="tok-na">addAsResource</span><span class="tok-o">(</span><span class="tok-s">&quot;persistence-datasource.xml&quot;</span><span class="tok-o">,</span>
                        <span class="tok-s">&quot;META-INF/persistence.xml&quot;</span><span class="tok-o">)</span>
                <span class="tok-o">.</span><span class="tok-na">addAsManifestResource</span><span class="tok-o">(</span><span class="tok-n">EmptyAsset</span><span class="tok-o">.</span><span class="tok-na">INSTANCE</span><span class="tok-o">,</span> <span class="tok-s">&quot;beans.xml&quot;</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@UsingDataSet</span><span class="tok-o">(</span><span class="tok-s">&quot;dbunit/dataset2.xml&quot;</span><span class="tok-o">)</span>
    <span class="tok-nd">@Cleanup</span><span class="tok-o">(</span><span class="tok-n">phase</span> <span class="tok-o">=</span> <span class="tok-n">TestExecutionPhase</span><span class="tok-o">.</span><span class="tok-na">BEFORE</span><span class="tok-o">,</span> <span class="tok-n">strategy</span> <span class="tok-o">=</span> <span class="tok-n">CleanupStrategy</span><span class="tok-o">.</span><span class="tok-na">USED_TABLES_ONLY</span><span class="tok-o">)</span>
    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">usuarioServicioNoEsNullTest</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">assertNotNull</span><span class="tok-o">(</span><span class="tok-n">usuarioServicio</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@UsingDataSet</span><span class="tok-o">(</span><span class="tok-s">&quot;dbunit/dataset2.xml&quot;</span><span class="tok-o">)</span>
    <span class="tok-nd">@Cleanup</span><span class="tok-o">(</span><span class="tok-n">phase</span> <span class="tok-o">=</span> <span class="tok-n">TestExecutionPhase</span><span class="tok-o">.</span><span class="tok-na">BEFORE</span><span class="tok-o">,</span> <span class="tok-n">strategy</span> <span class="tok-o">=</span> <span class="tok-n">CleanupStrategy</span><span class="tok-o">.</span><span class="tok-na">USED_TABLES_ONLY</span><span class="tok-o">)</span>
    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">buscaUsuarioPorIdTest</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">Usuario</span> <span class="tok-n">usuario</span> <span class="tok-o">=</span> <span class="tok-n">usuarioServicio</span><span class="tok-o">.</span><span class="tok-na">buscaUsuarioPorId</span><span class="tok-o">(</span><span class="tok-mi">1L</span><span class="tok-o">);</span>
        <span class="tok-n">Assert</span><span class="tok-o">.</span><span class="tok-na">assertTrue</span><span class="tok-o">(</span><span class="tok-n">usuario</span><span class="tok-o">.</span><span class="tok-na">getPrestamos</span><span class="tok-o">().</span><span class="tok-na">size</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-mi">2</span><span class="tok-o">);</span>
        <span class="tok-n">assertNotNull</span><span class="tok-o">(</span><span class="tok-n">usuarioServicio</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@UsingDataSet</span><span class="tok-o">(</span><span class="tok-s">&quot;dbunit/dataset2.xml&quot;</span><span class="tok-o">)</span>
    <span class="tok-nd">@Cleanup</span><span class="tok-o">(</span><span class="tok-n">phase</span> <span class="tok-o">=</span> <span class="tok-n">TestExecutionPhase</span><span class="tok-o">.</span><span class="tok-na">BEFORE</span><span class="tok-o">,</span> <span class="tok-n">strategy</span> <span class="tok-o">=</span> <span class="tok-n">CleanupStrategy</span><span class="tok-o">.</span><span class="tok-na">USED_TABLES_ONLY</span><span class="tok-o">)</span>
    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">recuperaUsuarioTest</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">Usuario</span> <span class="tok-n">usuario</span> <span class="tok-o">=</span> <span class="tok-n">usuarioServicio</span><span class="tok-o">.</span><span class="tok-na">recuperarUsuario</span><span class="tok-o">(</span><span class="tok-s">&quot;vicente.casamayor&quot;</span><span class="tok-o">);</span>
        <span class="tok-n">Assert</span><span class="tok-o">.</span><span class="tok-na">assertTrue</span><span class="tok-o">(</span><span class="tok-n">usuario</span><span class="tok-o">.</span><span class="tok-na">getPrestamos</span><span class="tok-o">().</span><span class="tok-na">size</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-mi">2</span><span class="tok-o">);</span>
        <span class="tok-n">assertNotNull</span><span class="tok-o">(</span><span class="tok-n">usuarioServicio</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>

    <span class="tok-nd">@UsingDataSet</span><span class="tok-o">(</span><span class="tok-s">&quot;dbunit/dataset2.xml&quot;</span><span class="tok-o">)</span>
    <span class="tok-nd">@Cleanup</span><span class="tok-o">(</span><span class="tok-n">phase</span> <span class="tok-o">=</span> <span class="tok-n">TestExecutionPhase</span><span class="tok-o">.</span><span class="tok-na">BEFORE</span><span class="tok-o">,</span> <span class="tok-n">strategy</span> <span class="tok-o">=</span> <span class="tok-n">CleanupStrategy</span><span class="tok-o">.</span><span class="tok-na">USED_TABLES_ONLY</span><span class="tok-o">)</span>
    <span class="tok-nd">@Test</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">realizarPrestamoTest</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-n">GeneradorFechaActualStub</span> <span class="tok-n">generadorFechaActual</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">GeneradorFechaActualStub</span><span class="tok-o">();</span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-n">generadorFechaActual</span><span class="tok-o">.</span><span class="tok-na">setFechaActual</span><span class="tok-o">(</span><span class="tok-n">Utils</span><span class="tok-o">.</span><span class="tok-na">stringToDate</span><span class="tok-o">(</span><span class="tok-s">&quot;2014-11-02&quot;</span><span class="tok-o">));</span>

        <span class="tok-c1">// Actualizamos el generador de fecha actual en BibliotecaBR para que el</span>
        <span class="tok-c1">// método de negocio obtenga esa fecha</span>
        <span class="tok-n">BibliotecaBR</span><span class="tok-o">.</span><span class="tok-na">getInstance</span><span class="tok-o">().</span><span class="tok-na">setFechaActualGenerator</span><span class="tok-o">(</span><span class="tok-n">generadorFechaActual</span><span class="tok-o">);</span>

        <span class="tok-n">Prestamo</span> <span class="tok-n">prestamo</span> <span class="tok-o">=</span> <span class="tok-n">usuarioServicio</span><span class="tok-o">.</span><span class="tok-na">solicitaPrestamo</span><span class="tok-o">(</span><span class="tok-mi">1L</span><span class="tok-o">,</span> <span class="tok-mi">1L</span><span class="tok-o">);</span>
        <span class="tok-n">Usuario</span> <span class="tok-n">usuario</span> <span class="tok-o">=</span> <span class="tok-n">usuarioServicio</span><span class="tok-o">.</span><span class="tok-na">buscaUsuarioPorId</span><span class="tok-o">(</span><span class="tok-mi">1L</span><span class="tok-o">);</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">prestamo</span><span class="tok-o">.</span><span class="tok-na">getEjemplar</span><span class="tok-o">().</span><span class="tok-na">getLibroId</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-mi">1</span><span class="tok-o">);</span>
        <span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">usuario</span><span class="tok-o">.</span><span class="tok-na">getPrestamos</span><span class="tok-o">().</span><span class="tok-na">contains</span><span class="tok-o">(</span><span class="tok-n">prestamo</span><span class="tok-o">));</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Gestión de la fecha actual para poder fijarla en los tests (ver el apartado siguiente)</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_gestión_de_la_fecha_actual_en_los_tests">Gestión de la fecha actual en los tests</h5>
<div class="paragraph">
<p>La fecha actual es un elemento cambiante de cualquier aplicación. Es importante poder <em>fijarla</em> en los tests para que la ejecución de éstos no sea dependiente de la fecha del sistema. Existen varias formas de solucionar este problema. Una de ellas es definir una función auxiliar en la aplicación que devuelva la fecha del sistema por defecto y modificar esta función en los tests.</p>
</div>
<div class="paragraph">
<p>Listamos a continuación las clases que usamos.</p>
</div>
<div class="paragraph">
<p><strong>Interfaz <code>GeneradorFechaActual.java</code></strong></p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/expertojava/jbibrest/utils/GeneradorFechaActual.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">utils</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">java.util.Date</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">interface</span> <span class="tok-nc">GeneradorFechaActual</span> <span class="tok-o">{</span>
    <span class="tok-kd">public</span> <span class="tok-n">Date</span> <span class="tok-nf">getFechaActual</span><span class="tok-o">();</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Implementación <code>GeneradorFechaActualReal.java</code></strong>:</p>
</div>
<div class="paragraph">
<p>En el código principal de la aplicación definimos la implementación que devuelve la fecha real:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/expertojava/jbibrest/utils/GeneradorFechaActualReal.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">utils</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">java.util.Date</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">GeneradorFechaActualReal</span> <span class="tok-kd">implements</span> <span class="tok-n">GeneradorFechaActual</span> <span class="tok-o">{</span>
    <span class="tok-kd">public</span> <span class="tok-n">Date</span> <span class="tok-nf">getFechaActual</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-k">new</span> <span class="tok-nf">Date</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Implementación <code>GeneradorFechaActualStub.java</code></strong></p>
</div>
<div class="paragraph">
<p>En el código de tests definimos la implementación <em>mockup</em> que permite fijar la fecha a la que nos interesa:</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/org/expertojava/jbibrest/utils/GeneradorFechaActualStub.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">package</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">expertojava</span><span class="tok-o">.</span><span class="tok-na">jbibrest</span><span class="tok-o">.</span><span class="tok-na">utils</span><span class="tok-o">;</span>

<span class="tok-kn">import</span> <span class="tok-nn">java.util.Date</span><span class="tok-o">;</span>

<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">GeneradorFechaActualStub</span> <span class="tok-kd">implements</span> <span class="tok-n">GeneradorFechaActual</span> <span class="tok-o">{</span>
    <span class="tok-n">Date</span> <span class="tok-n">fecha</span> <span class="tok-o">=</span> <span class="tok-kc">null</span><span class="tok-o">;</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setFechaActual</span><span class="tok-o">(</span><span class="tok-n">Date</span> <span class="tok-n">fecha</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">fecha</span> <span class="tok-o">=</span> <span class="tok-n">fecha</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">Date</span> <span class="tok-nf">getFechaActual</span><span class="tok-o">()</span>  <span class="tok-o">{</span>
       <span class="tok-k">return</span> <span class="tok-n">fecha</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Singleton <code>BibliotecaBR</code></strong></p>
</div>
<div class="paragraph">
<p>El generador de fechas lo guardamos en el <em>singleton</em> <code>BibliotecaBR</code>, y lo inicializamos por defecto al generador de la fecha real:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org / expertojava / jbibrest / utils / BibliotecaBR.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">BibliotecaBR</span> <span class="tok-o">{</span>

    <span class="tok-o">...</span>

    <span class="tok-c1">// Generador de fecha actual</span>
    <span class="tok-n">GeneradorFechaActual</span> <span class="tok-n">generadorFechaActual</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">GeneradorFechaActualReal</span><span class="tok-o">();</span>

    <span class="tok-o">...</span>

    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">setGeneradorFechaActual</span><span class="tok-o">(</span><span class="tok-n">GeneradorFechaActual</span> <span class="tok-n">generadorFechaActual</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">generadorFechaActual</span> <span class="tok-o">=</span> <span class="tok-n">generadorFechaActual</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">public</span> <span class="tok-n">GeneradorFechaActual</span> <span class="tok-nf">getGeneradorFechaActual</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span> <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">generadorFechaActual</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>
    <span class="tok-o">...</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Uso en la aplicación</strong></p>
</div>
<div class="paragraph">
<p>En la aplicación debemos obtener la fecha actual consultando el objeto guardado en <code>BibliotecaBR</code>. De esta forma, obtendremos la fecha real o la fecha fijada por el test, según en qué contexto se esté ejecutando el código:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">GeneradorFechaActual</span> <span class="tok-n">generadorFechaActual</span> <span class="tok-o">=</span> <span class="tok-n">BibliotecaBR</span><span class="tok-o">.</span><span class="tok-na">getInstance</span><span class="tok-o">().</span><span class="tok-na">getGeneradorFechaActual</span><span class="tok-o">();</span>
<span class="tok-n">Date</span> <span class="tok-n">fechaActual</span> <span class="tok-o">=</span> <span class="tok-n">generadorFechaActual</span><span class="tok-o">.</span><span class="tok-na">getFechaActual</span><span class="tok-o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Actualización de la fecha en el test</strong></p>
</div>
<div class="paragraph">
<p>En el test definimos una implementación del generador que nos permite fijar la fecha, definimos la fecha actual y lo inyectamos en <code>BibliotecaBR</code> antes de llamar al método de servicio:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">GeneradorFechaActualStub</span> <span class="tok-n">generadorFechaActual</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">GeneradorFechaActualStub</span><span class="tok-o">();</span>
<span class="tok-n">generadorFechaActual</span><span class="tok-o">.</span><span class="tok-na">setFechaActual</span><span class="tok-o">(</span><span class="tok-n">Utils</span><span class="tok-o">.</span><span class="tok-na">stringToDate</span><span class="tok-o">(</span><span class="tok-s">&quot;2014-11-02&quot;</span><span class="tok-o">));</span>

<span class="tok-c1">// Actualizamos el generador de fecha actual en BibliotecaBR para que el</span>
<span class="tok-c1">// método de negocio obtenga esa fecha</span>
<span class="tok-n">BibliotecaBR</span><span class="tok-o">.</span><span class="tok-na">getInstance</span><span class="tok-o">().</span><span class="tok-na">setFechaActualGenerator</span><span class="tok-o">(</span><span class="tok-n">generadorFechaActual</span><span class="tok-o">);</span>

<span class="tok-n">Prestamo</span> <span class="tok-n">prestamo</span> <span class="tok-o">=</span> <span class="tok-n">usuarioServicio</span><span class="tok-o">.</span><span class="tok-na">solicitaPrestamo</span><span class="tok-o">(</span><span class="tok-mi">1L</span><span class="tok-o">,</span> <span class="tok-mi">1L</span><span class="tok-o">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-n">Usuario</span> <span class="tok-n">usuario</span> <span class="tok-o">=</span> <span class="tok-n">usuarioServicio</span><span class="tok-o">.</span><span class="tok-na">buscaUsuarioPorId</span><span class="tok-o">(</span><span class="tok-mi">1L</span><span class="tok-o">);</span>
<span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">prestamo</span><span class="tok-o">.</span><span class="tok-na">getEjemplar</span><span class="tok-o">().</span><span class="tok-na">getLibroId</span><span class="tok-o">()</span> <span class="tok-o">==</span> <span class="tok-mi">1</span><span class="tok-o">);</span>
<span class="tok-n">assertTrue</span><span class="tok-o">(</span><span class="tok-n">usuario</span><span class="tok-o">.</span><span class="tok-na">getPrestamos</span><span class="tok-o">().</span><span class="tok-na">contains</span><span class="tok-o">(</span><span class="tok-n">prestamo</span><span class="tok-o">));</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Llamamos al método de servicio habiendo inyectado la fecha 2014-11-02 como fecha actual. Si no lo hiciéramos así, se produciría un error al intentar el usuario tomar un libro prestado, porque tiene préstamos que vencen en 2014 y si se obtuviera la fecha actual real su estado sería moroso.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_entrega">3.4. Entrega</h3>
<div class="paragraph">
<p>Debes completar las funcionalidades y las pruebas del proyecto. Repasamos la lista de cosas por hacer:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Añadir las anotaciones JPA a las clases restantes</p>
<div class="ulist">
<ul>
<li>
<p><code>Usuario</code> (abstracta) y su relación de herencia con <code>Alumno</code> y <code>Profesor</code></p>
</li>
<li>
<p><code>Ejemplar</code></p>
</li>
<li>
<p><code>Prestamo</code></p>
</li>
<li>
<p><code>Multa</code></p>
</li>
<li>
<p><code>PrestamoHistorico</code></p>
</li>
<li>
<p><code>MultaHistorica</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Crear las clases DAO</p>
<div class="ulist">
<ul>
<li>
<p><code>UsuarioDao</code></p>
</li>
<li>
<p><code>EjemplarDao</code></p>
</li>
<li>
<p><code>PrestamoDao</code></p>
</li>
<li>
<p><code>MultaDao</code></p>
</li>
<li>
<p><code>PrestamoHistoricoDao</code></p>
</li>
<li>
<p><code>MultaHistoricaDao</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Añadir los métodos de negocio necesarios en las clases <code>LibroServicio</code> y <code>UsuariServicio</code></p>
</li>
<li>
<p>Deberás crear y completar los tests correspondientes para comprobar que funcionan correctamente las entidades, los DAOs y los métodos de negocio:</p>
<div class="ulist">
<ul>
<li>
<p><code>Persistencia.LibroAggregateTests.java</code> - Pruebas de las entidades del agregado <code>Libro</code></p>
</li>
<li>
<p><code>Persistencia.LibroAggregateArquillianTests.java</code> - Pruebas de los DAO del agregado <code>Libro</code></p>
</li>
<li>
<p><code>Persistencia.UsuarioAggregateTests.java</code> - Pruebas de las entidades del agregado <code>Usuario</code></p>
</li>
<li>
<p><code>Persistencia.UsuarioAggregateArquillianTests.java</code> - Pruebas de los DAO del agregado <code>Usuario</code></p>
</li>
<li>
<p><code>Servicio.LibroServicioTests.java</code> - Pruebas clase <code>LibroServicio</code></p>
</li>
<li>
<p><code>Servicio.UsuarioServicioTests.java</code> - Pruebas clase <code>UsuarioServicio</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Debes también añadir servlets adicionales con los que probar manualmente la aplicación</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>La fecha de entrega del proyecto será el <strong>jueves 28 de enero</strong>.</p>
</div>
<div class="paragraph">
<p>Debes dar premiso de lectura en el repositorio <code>jbib-rest-expertojava</code> al usuario <strong>entregas-expertojava</strong> y confirmar la entrega en Moodle.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2015-10-16 07:47:33 CEST
</div>
</div>
</body>
</html>