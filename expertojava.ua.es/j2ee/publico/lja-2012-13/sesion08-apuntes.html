<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta content="Apache Forrest" name="Generator">
<meta name="Forrest-version" content="0.7">
<meta name="Forrest-skin-name" content="pelt">
<title>Pruebas con DBUnit</title>
<link type="text/css" href="skin/highlight/shCore.css" rel="stylesheet">
<link type="text/css" href="skin/highlight/shThemeEclipse.css" rel="stylesheet">
<script src="skin/highlight/shCore.js" type="text/javascript"></script><script src="skin/highlight/shAutoloader.js" type="text/javascript"></script>
<link type="text/css" href="skin/basic.css" rel="stylesheet">
<link media="screen" type="text/css" href="skin/screen.css" rel="stylesheet">
<link media="print" type="text/css" href="skin/print.css" rel="stylesheet">
<link type="text/css" href="skin/profile.css" rel="stylesheet">
<script src="skin/getBlank.js" language="javascript" type="text/javascript"></script><script src="skin/getMenu.js" language="javascript" type="text/javascript"></script><script src="skin/fontsize.js" language="javascript" type="text/javascript"></script>
<link rel="shortcut icon" href="">
</head>
<body onload="init()">
<script type="text/javascript">ndeSetTextSize();</script>
<div id="top">
<div class="header">
<div class="grouplogo">
<a href="http://web.ua.es/especialistajava"><img class="logoImage" alt="jtech" src="images/baner_j2ee_izq.gif" title="Experto en Desarrollo de Aplicaciones y Servicios con Java Enterprise"></a>
</div>
<div class="projectlogoA1">
<a href="http://www.dccia.ua.es/"><img class="logoImage" alt="Lenguaje Java Avanzado" src="images/baner_j2ee_der.gif" title="Lenguaje Java Avanzado"></a>
</div>
<ul id="tabs">
<li>
<a class="base-not-selected" href="javascript:location.href='../index.html'">Home</a>
</li>
<li>
<a class="base-not-selected" href="javascript:location.href='../aplic-web.html'">Aplicaciones Web</a>
</li>
<li>
<a class="base-not-selected" href="javascript:location.href='../aplic-ent.html'">Aplicaciones Enterprise</a>
</li>
<li>
<a class="base-not-selected" href="javascript:location.href='../charlas.html'">Charlas</a>
</li>
<li>
<a class="base-not-selected" href="javascript:location.href='../proy-int/index.html'">Proyecto</a>
</li>
<li class="current">
<a class="base-selected" href="index.html">Java y Herramientas de Desarrollo</a>
</li>
</ul>
</div>
</div>
<div id="main">
<div id="publishedStrip">
<div id="level2tabs"></div>
<script type="text/javascript"><!--
document.write("<text>Last Published:</text> " + document.lastModified);
//  --></script>
</div>
<div class="breadtrail">
             
             &nbsp;
           </div>
<div id="menu">
<div onclick="SwitchMenu('menu_selected_1.1', 'skin/')" id="menu_selected_1.1Title" class="menutitle" style="background-image: url('skin/images/chapter_open.gif');">Materiales</div>
<div id="menu_selected_1.1" class="selectedmenuitemgroup" style="display: block;">
<div class="menuitem">
<a href="index.html" title="Java y Herramientas de Desarrollo">&Iacute;ndice</a>
</div>
<div onclick="SwitchMenu('menu_selected_1.1.2', 'skin/')" id="menu_selected_1.1.2Title" class="menutitle" style="background-image: url('skin/images/chapter_open.gif');">Teor&iacute;a</div>
<div id="menu_selected_1.1.2" class="selectedmenuitemgroup" style="display: block;">
<div class="menuitem">
<a href="sesion01-apuntes.html">Sesion 1</a>
</div>
<div class="menuitem">
<a href="sesion02-apuntes.html">Sesion 2</a>
</div>
<div class="menuitem">
<a href="sesion03-apuntes.html">Sesion 3</a>
</div>
<div class="menuitem">
<a href="sesion04-apuntes.html">Sesion 4</a>
</div>
<div class="menuitem">
<a href="sesion05-apuntes.html">Sesion 5</a>
</div>
<div class="menuitem">
<a href="sesion06-apuntes.html">Sesion 6</a>
</div>
<div class="menuitem">
<a href="sesion07-apuntes.html">Sesion 7</a>
</div>
<div class="menupage">
<div class="menupagetitle">Sesion 8</div>
</div>
</div>
<div onclick="SwitchMenu('menu_1.1.3', 'skin/')" id="menu_1.1.3Title" class="menutitle">Ejercicios</div>
<div id="menu_1.1.3" class="menuitemgroup">
<div class="menuitem">
<a href="sesion01-ejercicios.html">Sesion 1</a>
</div>
<div class="menuitem">
<a href="sesion02-ejercicios.html">Sesion 2</a>
</div>
<div class="menuitem">
<a href="sesion03-ejercicios.html">Sesion 3</a>
</div>
<div class="menuitem">
<a href="sesion04-ejercicios.html">Sesion 4</a>
</div>
<div class="menuitem">
<a href="sesion05-ejercicios.html">Sesion 5</a>
</div>
<div class="menuitem">
<a href="sesion06-ejercicios.html">Sesion 6</a>
</div>
<div class="menuitem">
<a href="sesion07-ejercicios.html">Sesion 7</a>
</div>
<div class="menuitem">
<a href="sesion08-ejercicios.html">Sesion 8</a>
</div>
</div>
</div>
<div id="credit"></div>
<div id="roundbottom">
<img style="display: none" class="corner" height="15" width="15" alt="" src="skin/images/rc-b-l-15-1body-2menu-3menu.png"></div>
<div id="credit2"></div>
</div>
<div id="content">
<div title="Portable Document Format" class="pdflink">
<a class="dida" href="sesion08-apuntes.pdf"><img alt="PDF -icon" src="skin/images/pdfdoc.gif" class="skin"><br>
        PDF</a>
</div>
<h1>Pruebas con DBUnit</h1>
<div id="minitoc-area">
<ul class="minitoc">
<li>
<a href="#Introducci%C3%B3n">Introducci&oacute;n</a>
</li>
<li>
<a href="#DbUnit">DbUnit</a>
<ul class="minitoc">
<li>
<a href="#Ciclo+de+vida">Ciclo de vida</a>
</li>
<li>
<a href="#Caracter%C3%ADsticas+de+DbUnit">Caracter&iacute;sticas de DbUnit</a>
</li>
</ul>
</li>
<li>
<a href="#Pr%C3%A1cticas+recomendadas">Pr&aacute;cticas recomendadas</a>
</li>
<li>
<a href="#Clases+e+interfaces">Clases e interfaces</a>
</li>
<li>
<a href="#Estructura+en+un+proyecto">Estructura en un proyecto</a>
</li>
</ul>
</div>


<a name="N1000C"></a><a name="Introducci%C3%B3n"></a>
<h2 class="underlined_10">Introducci&oacute;n</h2>
<div class="section">
<p>El correcto acceso a datos es fundamental en cualquier aplicaci&oacute;n.
La complejidad de algunos modelos de datos crea la necesidad de pruebas
sistem&aacute;ticas de la capa de datos. Por un lado se necesita probar
que la capa de acceso a datos genera el estado correcto 
en la base de datos (BD). Por otro lado tambi&eacute;n se necesita probar
que ante determinado estado de la BD el c&oacute;digo Java se
comporta de la manera esperada. </p>
<p>Sistematizar estas pruebas requiere una manera sencilla de 
reestablecer el estado de la base de datos. De otra manera surgir&iacute;an
problemas cada vez que un test falle y deje la BD en un estado
inconsistente para los siguientes tests.</p>
</div>

<a name="N10019"></a><a name="DbUnit"></a>
<h2 class="underlined_10">DbUnit</h2>
<div class="section">
<p>DbUnit es un framework de c&oacute;digo abierto que fue creado por
Manuel Laflamme. Est&aacute; basado en JUnit, de hecho sus clases
extienden el comportamiento de las clases de JUnit. Eso permite
la total integraci&oacute;n con el resto de pruebas en JUnit.</p>
<p>DbUnit nos permite gestionar el estado de una BD durante
las pruebas unitarias y de integraci&oacute;n. Constituye la alternativa
a la creaci&oacute;n de clases stub y mocks para controlar las dependencias
externas.</p>
<a name="N10025"></a><a name="Ciclo+de+vida"></a>
<h3 class="underlined_5">Ciclo de vida</h3>
<p>El ciclo de vida de las pruebas con DbUnit es el siguiente:</p>
<p>1. Eliminar el estado previo de la BD resultante
  de pruebas anteriores (en lugar de restaurarla
  tras cada test).</p>
<p>2. Cargar los datos necesarios para las pruebas
  de la BD (s&oacute;lo los necesarios para cada test).</p>
<p>3. Utilizar los m&eacute;todos de la librer&iacute;a DbUnit en las
  aserciones para realizar el test.</p>
<a name="N10038"></a><a name="Caracter%C3%ADsticas+de+DbUnit"></a>
<h3 class="underlined_5">Caracter&iacute;sticas de DbUnit</h3>
<p>DbUnit nos permite los problemas que surgen si el
  &uacute;ltimo caso de prueba ha dejado la base de datos
  inconsistente.</p>
<p>DbUnit puede trabajar con conjuntos de datos grandes.</p>
<p>Permite verificar que el contenido de la base de
  datos es igual a determinado conjunto de datos
  esperado, a nivel de fichero, a nivel de consulta o bien a nivel de
  tabla.</p>
<p>Nos proporciona un mecanismo basado en XML para cargar los datos
  en la BD y para exportarlos desde la BD.</p>
<p>Proporciona una forma de aislar los experimentos en distintos casos de prueba
   individuales, uno por cada operaci&oacute;n.</p>
</div>

<a name="N1004F"></a><a name="Pr%C3%A1cticas+recomendadas"></a>
<h2 class="underlined_10">Pr&aacute;cticas recomendadas</h2>
<div class="section">
<p>La documentaci&oacute;n de DbUnit establece una serie de pautas como pr&aacute;cticas recomendadas
o pr&aacute;cticas adecuadas (best practices). </p>
<ul>

<li>Usar una instancia de la BD por cada desarrollador. As&iacute; se evitan
interferencias entre ellos.</li>

<li>Programar las pruebas de tal manera que no haya que 
restaurar el estado de la base de datos tras el test. No pasa nada si 
la base de datos se queda en un estado diferente tras el test. Dejarlo
puede ayudar para encontrar el fallo de determinada prueba. Lo importante es
que la base de datos se pone en un estado conocido antes de cada test.</li>

<li>Usar m&uacute;ltiples conjuntos de datos peque&ntilde;os en lugar de uno grande.
Cada prueba necesita un conjunto de tablas y de registros, no necesariamente toda la
base de datos.</li>

<li>Inicializar los datos comunes s&oacute;lo una vez para todos los tests. Si hay
datos que s&oacute;lo son de lectura, no tenemos por qu&eacute; tocarlos si nos aseguramos
de que las pruebas no los modifican.</li>

</ul>
<p>Estrategias de conexi&oacute;n recomendadas.</p>
<ul>

<li>Como cliente remoto con la clase <span class="codefrag">DatabaseTestCase</span>.</li>

<li>A trav&eacute;s del pool de conexiones de un servidor de aplicaciones, con
<span class="codefrag">IDataBaseConnection o con JndiBasedDBTestCase.</span>
</li>

</ul>
</div>

<a name="N10079"></a><a name="Clases+e+interfaces"></a>
<h2 class="underlined_10">Clases e interfaces</h2>
<div class="section">
<p>DbUnit es un conjunto de clases, algunas de las cu&aacute;les heredan de
clases de JUnit. DbUnit tiene una serie de dependencias con las
siguientes librer&iacute;as (bibliotecas): </p>
<ul>

<li>JUnit: framework base para las pruebas</li>

<li>Jakarta Commons IO: utilidades de entrada y salida</li>

<li>Slf4j: frontend para frameworks de logging</li>

</ul>
<p>Nosotros utilizaremos las versiones JUnit 4, Commons IO 1.4
y Slf4j 1.6. L&oacute;gicamente tambi&eacute;n es necesaria la librer&iacute;a para 
el acceso a la base de datos, pero esto ya no es una dependencia
de DbUnit, sino de nuestro proyecto. En nuestro caso utilizaremos
el conector JDBC de MySQL.</p>
<p>
<span class="codefrag">DBTestCase</span> hereda de la clase <span class="codefrag">TestCase</span> de JUnit y 
proporciona m&eacute;todos para inicializar y restaurar la BD antes y despu&eacute;s de cada test.
Utiliza la interfaz <span class="codefrag">IDatabaseTester</span> para conectar con la BD.
A partir de la versi&oacute;n 2.2 de DbUnit se ha pasado a la alternativa de utilizar
directamente el <span class="codefrag">IDatabaseTester</span>, como se ver&aacute; en los ejemplos.</p>
<p>
<span class="codefrag">IDatabaseTester</span> devuelve conexiones a la base de datos, del tipo
<span class="codefrag">IDatabaseConnection</span>. La implementaci&oacute;n que nosotros vamos a utilizar
es la de JDBC, <span class="codefrag">JdbcDatabaseTester</span>. Tiene m&eacute;todos
<span class="codefrag">onSetUp(), setSetUpOperation(op), onTearDown(), setTearDownOperation(op),
getConnection()</span>, entre otros.</p>
<p>
<span class="codefrag">IDatabaseConnection</span> es la interfaz a la conexi&oacute;n con la base de 
datos y cuenta con m&eacute;todos para crear un conjunto de datos <span class="codefrag">createDataSet()</span>,
crear una lista concreta de tablas, <span class="codefrag">createDataSet(listaTablas)</span>,
crear una tabla extra&iacute;da de la base de datos, <span class="codefrag">createTable(tabla)</span>,
crear una tabla con el resultado de una query sobre la BD con
<span class="codefrag">createQueryTable(tabla, sql)</span>, y otros m&eacute;todos como <span class="codefrag">
getConnection(), getConfig(), getRow()</span>.
</p>
<p>La interfaz <span class="codefrag">IDataSet</span> representa una colecci&oacute;n de tablas
y se utiliza para situar la BD en un estado determinado, as&iacute; como para comparar
el estado actual de la BD con el estado esperado. Dos implementaciones son
<span class="codefrag">QueryDataSet</span> y <span class="codefrag">FlatXmlDataSet</span>. Esta &uacute;ltima implementaci&oacute;n
sirve para importar y exportar conjuntos de datos a XML en un formato como 
el siguiente:</p>
<pre class="brush:xml;">

&lt;?xml version='1.0' encoding='UTF-8'?&gt;
&lt;dataset&gt;
&lt;TEST_TABLE COL0="row 0 col 0"
COL1="row 0 col 1"
COL2="row 0 col 2"/&gt;
&lt;TEST_TABLE COL1="row 1 col 1"/&gt;
&lt;SECOND_TABLE COL0="row 0 col 0"
COL1="row 0 col 1" /&gt;
&lt;EMPTY_TABLE/&gt;
&lt;/dataset&gt;

</pre>
<p>Por &uacute;ltimo otra clase importante es la <span class="codefrag">Assertion</span> que
define los m&eacute;todos est&aacute;ticos para realizar las comparaciones: 
<span class="codefrag">assertEquals(IDataSet, IDataSet)</span> y <span class="codefrag">assertEquals(ITable, ITable)</span>
</p>
</div>


<a name="N100DE"></a><a name="Estructura+en+un+proyecto"></a>
<h2 class="underlined_10">Estructura en un proyecto</h2>
<div class="section">
<p>La estructura del proyecto es similar a la que podemos usar con JUnit,
aislando las pruebas en una carpeta separada <span class="codefrag">test</span>.</p>
<p>
<img alt="Estructura del proyecto en Eclipse" content-width="5cm" src="imagenes/dbunit/dbu2.jpeg" width="240">
  </p>
<p>Con DbUnit tambi&eacute;n necesitaremos una carpeta de recursos <span class="codefrag">resources</span>
donde guardar los recursos XML. &Eacute;stos consistir&aacute;n en ficheros independientes
para cada prueba, tanto para la inicializaci&oacute;n de la BD, como para el
estado esperado de la BD tras cada prueba:</p>
<p>
<img alt="XML con el estado de inicializaci&oacute;n de la BD" content-width="6cm" src="imagenes/dbunit/dbu3.jpeg" width="300">
  </p>
<p>
<img alt="XML con el estado esperado de la BD tras el test" content-width="6cm" src="imagenes/dbunit/dbu4.jpeg" width="300">
  </p>
<p>La estructura b&aacute;sica de la clase que contiene un conjunto de pruebas 
consiste en implementar los m&eacute;todos que se ejecutan antes de cada
test, despu&eacute;s, y los tests en s&iacute;. Tambi&eacute;n habr&iacute;a que incluir las 
variables de instancia del DAO y del <span class="codefrag">IDatabaseTester</span>:
</p>
<pre class="brush:java;">

public class TestMiJDBCDAO {
	private JDBCDAO dao;
	private IDatabaseTester databaseTester;
	
	@Before
	public void setUp() throws Exception {

	}
	
	@After
	public void tearDown() throws Exception {

	}

	@Test
	public void test1DelAdd() throws Exception {

	}
        ...
}

</pre>
<p>Obtener la instancia al DAO se podr&iacute;a hacer o bien
antes de cada test, o bien antes de todos los tests,
con una funci&oacute;n anotada como <span class="codefrag">@BeforeCase</span>.
Antes de cada prueba tambi&eacute;n hay que configurar el
<span class="codefrag">IDatabaseTester</span>, en este caso para acceder
por JDBC, e inicializar el conjunto de datos a partir
del recurso XML apropiado. Finalmente hay que llamar
la operaci&oacute;n <span class="codefrag">databaseTester.onSetup()</span> que
llama a la operaci&oacute;n por defecto de inicio de test de
la clase <span class="codefrag">DatabaseOperation</span>. &Eacute;sta define el
contrato de la interfaz para operaciones realizadas
en la base de datos. 
</p>
<pre class="brush:java;">

	@Before
	public void setUp() throws Exception {
		//Obtener instancia del DAO que testeamos
		pdao = new JDBCPeliculaDAO();
		
		//Acceder a la base de datos
		databaseTester = new JdbcDatabaseTester("com.mysql.jdbc.Driver",
        	"jdbc:mysql://localhost/databasename", "username", "password");
		
		//Inicializar el dataset en la BD
		FlatXmlDataSetBuilder builder = new FlatXmlDataSetBuilder();
    	IDataSet dataSet = builder.build(
    	  this.getClass().getResourceAsStream("/db-init.xml"));
    	databaseTester.setDataSet(dataSet);

		//Llamar a la operaci&oacute;n por defecto setUpOperation
		databaseTester.onSetup();
	}

</pre>
<p>Similarmente llamaremos a <span class="codefrag">onTearDown()</span>
despu&eacute;s de cada prueba:</p>
<pre class="brush:java;">

	@After
	public void tearDown() throws Exception {
		databaseTester.onTearDown();
	}

</pre>
<p>La prueba se a&iacute;sla en un m&eacute;todo en el que realizamos la operaci&oacute;n
a trav&eacute;s del DAO, conectamos con la base de datos a trav&eacute;s
de <span class="codefrag">IDatabaseConnection</span>, creamos el dataset de las
tablas implicadas en el test, y lo escribimos en un archivo en formato
XML. Obtenemos los datos esperados de otro archivo XML y los
comparamos. Deben ser id&eacute;nticos para que la prueba tenga &eacute;xito.</p>
<pre class="brush:java;">

	@Test
	public void test1() throws Exception {
		//Realizar la operaci&oacute;n con el JDBC DAO
		...		

		// Conectar a la base de datos MySQL
		IDatabaseConnection connection = databaseTester.getConnection();
		DatabaseConfig dbconfig = connection.getConfig();
		dbconfig.setProperty(
				"http://www.dbunit.org/properties/datatypeFactory",
				new MySqlDataTypeFactory());

		// Crear el DataSet de la base de datos MySQL
		QueryDataSet partialDataSet = new QueryDataSet(connection);
		partialDataSet.addTable("tabla1");
		partialDataSet.addTable("tabla2");
		partialDataSet.addTable("tabla3");

		// Escribir el DataSet en XML para despu&eacute;s compararlo con el esperado
		File outputFile = new File("db-output.xml");
		FlatXmlDataSet.write(partialDataSet, new FileOutputStream(outputFile));

		// Obtener los datos esperados del XML
		URL url = IDatabaseTester.class.getResource("/db-expected1.xml");
		Assert.assertNotNull(url);
		File inputFile = new File(url.getPath());

		// Comparar los ficheros XML
		Assert.assertEquals(FileUtils.readFileToString(inputFile, "UTF8"),
				FileUtils.readFileToString(outputFile, "UTF8"));
	}

</pre>
<p>Por &uacute;ltimo, las pruebas se ejecutan a trav&eacute;s de JUnit:</p>
<p>
<img alt="Resultado de la ejecuci&oacute;n de las pruebas." content-width="5cm" src="imagenes/dbunit/dbu5.jpeg" width="240">
  </p>
<p>Se puede probar el siguiente ejemplo de proyecto con DbUnit en Eclipse: 
<a href="ejemplos/DBUnitExample.zip">DBUnitExample.zip</a>. </p>
</div>


<p class="pageBreakAfter"></p>

</div>
<div class="clearboth">&nbsp;</div>
</div>
<div id="footer">
<div class="lastmodified">
<script type="text/javascript"><!--
document.write("<text>Last Published:</text> " + document.lastModified);
//  --></script>
</div>
<div class="copyright">
        Copyright &copy;
         2012-2013 Dept. Ciencia de la Computaci&oacute;n e IA</div>
</div>
<script type="text/javascript">
     
         SyntaxHighlighter.defaults['toolbar'] = false;
         SyntaxHighlighter.autoloader(
  		     'java                   skin/highlight/shBrushJava.js',
  		     'xml xhtml xslt html    skin/highlight/shBrushXml.js',
  		     'js jscript javascript  skin/highlight/shBrushJScript.js',
  		     'groovy                 skin/highlight/shBrushGroovy.js',
  		     'bash shell             skin/highlight/shBrushBash.js',
  		     'php                    skin/highlight/shBrushPhp.js',
  		     'css                    skin/highlight/shBrushCss.js',
  		     'sql                    skin/highlight/shBrushSql.js',
  		     'objc                   skin/highlight/shBrushObjC.js',
  		     'cpp c                  skin/highlight/shBrushCpp.js',
  		     'text plain             skin/highlight/shBrushPlain.js'
         );
         SyntaxHighlighter.all();
     </script><a href="skin/highlight/shBrushJava.js"></a><a href="skin/highlight/shBrushXml.js"></a><a href="skin/highlight/shBrushJScript.js"></a><a href="skin/highlight/shBrushGroovy.js"></a><a href="skin/highlight/shBrushBash.js"></a><a href="skin/highlight/shBrushPhp.js"></a><a href="skin/highlight/shBrushCss.js"></a><a href="skin/highlight/shBrushSql.js"></a><a href="skin/highlight/shBrushObjC.js"></a><a href="skin/highlight/shBrushCpp.js"></a><a href="skin/highlight/shBrushPlain.js"></a>
</body>
</html>
