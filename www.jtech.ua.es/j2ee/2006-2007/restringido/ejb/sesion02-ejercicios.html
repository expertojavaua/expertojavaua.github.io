<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta content="Apache Forrest" name="Generator">
<meta name="Forrest-version" content="0.7">
<meta name="Forrest-skin-name" content="pelt">
<title>Sesi&oacute;n 2 de ejercicios EJB - Beans de sesi&oacute;n sin estado</title>
<link type="text/css" href="skin/basic.css" rel="stylesheet">
<link media="screen" type="text/css" href="skin/screen.css" rel="stylesheet">
<link media="print" type="text/css" href="skin/print.css" rel="stylesheet">
<link type="text/css" href="skin/profile.css" rel="stylesheet">
<script src="skin/getBlank.js" language="javascript" type="text/javascript"></script><script src="skin/getMenu.js" language="javascript" type="text/javascript"></script><script src="skin/fontsize.js" language="javascript" type="text/javascript"></script>
<link rel="shortcut icon" href="">
</head>
<body onload="init()">
<script type="text/javascript">ndeSetTextSize();</script>
<div id="top">
<div class="header">
<div class="grouplogo">
<a href="http://www.jtech.ua.es/j2ee"><img class="logoImage" alt="J2EE" src="images/baner_j2ee_izq.gif" title="Curso Especialista Universitario J2EE"></a>
</div>
<div class="projectlogoA1">
<a href="http://www.dccia.ua.es/"><img class="logoImage" alt="Componentes EJB" src="images/baner_j2ee_der.gif" title="Componentes EJB"></a>
</div>
<ul id="tabs">
<li>
<a class="base-not-selected" href="../index.html">M&oacute;dulos</a>
</li>
<li class="current">
<a class="base-selected" href="index.html">Componentes EJB</a>
</li>
</ul>
</div>
</div>
<div id="main">
<div id="publishedStrip">
<div id="level2tabs"></div>
<script type="text/javascript"><!--
document.write("<text>Last Published:</text> " + document.lastModified);
//  --></script>
</div>
<div class="breadtrail">
             
             &nbsp;
           </div>
<div id="menu">
<div onclick="SwitchMenu('menu_selected_1.1', 'skin/')" id="menu_selected_1.1Title" class="menutitle" style="background-image: url('skin/images/chapter_open.gif');">Materiales</div>
<div id="menu_selected_1.1" class="selectedmenuitemgroup" style="display: block;">
<div class="menuitem">
<a href="index.html" title="Componentes EJB">&Iacute;ndice</a>
</div>
<div onclick="SwitchMenu('menu_1.1.2', 'skin/')" id="menu_1.1.2Title" class="menutitle">Teor&iacute;a</div>
<div id="menu_1.1.2" class="menuitemgroup">
<div class="menuitem">
<a href="sesion01-apuntes.html" title="Introducci&oacute;n a los Enterprise Beans">Sesi&oacute;n 1</a>
</div>
<div class="menuitem">
<a href="sesion02-apuntes.html" title="Beans de sesi&oacute;n">Sesi&oacute;n 2</a>
</div>
<div class="menuitem">
<a href="sesion03-apuntes.html" title="Beans de sesi&oacute;n">Sesi&oacute;n 3</a>
</div>
<div class="menuitem">
<a href="sesion04-apuntes.html" title="Beans de sesi&oacute;n">Sesi&oacute;n 4</a>
</div>
<div class="menuitem">
<a href="sesion05-apuntes.html" title="Seguridad">Sesi&oacute;n 5</a>
</div>
<div class="menuitem">
<a href="sesion06-apuntes.html" title="Transacciones">Sesi&oacute;n 6</a>
</div>
<div class="menuitem">
<a href="sesion07-apuntes.html" title="EJB 3.0">Sesi&oacute;n 7</a>
</div>
<div class="menuitem">
<a href="sesion08-apuntes.html" title="JPA">Sesi&oacute;n 8</a>
</div>
<div class="menuitem">
<a href="roadmap.html" title="Roadmap EJB">Roadmap</a>
</div>
</div>
<div onclick="SwitchMenu('menu_selected_1.1.3', 'skin/')" id="menu_selected_1.1.3Title" class="menutitle" style="background-image: url('skin/images/chapter_open.gif');">Ejercicios</div>
<div id="menu_selected_1.1.3" class="selectedmenuitemgroup" style="display: block;">
<div class="menuitem">
<a href="sesion01-ejercicios.html" title="Introducci&oacute;n a los Enterprise Beans">Sesi&oacute;n 1</a>
</div>
<div class="menupage">
<div class="menupagetitle">Sesi&oacute;n 2</div>
</div>
<div class="menuitem">
<a href="sesion03-ejercicios.html" title="Beans de sesi&oacute;n">Sesi&oacute;n 3</a>
</div>
<div class="menuitem">
<a href="sesion04-ejercicios.html" title="Beans de sesi&oacute;n con estado">Sesi&oacute;n 4</a>
</div>
<div class="menuitem">
<a href="sesion05-ejercicios.html" title="Seguridad">Sesi&oacute;n 5</a>
</div>
<div class="menuitem">
<a href="sesion06-ejercicios.html" title="Transacciones">Sesi&oacute;n 6</a>
</div>
<div class="menuitem">
<a href="sesion07-ejercicios.html" title="EJB 3.0">Sesi&oacute;n 7</a>
</div>
<div class="menuitem">
<a href="sesion08-ejercicios.html" title="JPA">Sesi&oacute;n 8</a>
</div>
</div>
</div>
<div id="credit"></div>
<div id="roundbottom">
<img style="display: none" class="corner" height="15" width="15" alt="" src="skin/images/rc-b-l-15-1body-2menu-3menu.png"></div>
<div id="credit2"></div>
</div>
<div id="content">
<div title="Portable Document Format" class="pdflink">
<a class="dida" href="sesion02-ejercicios.pdf"><img alt="PDF -icon" src="skin/images/pdfdoc.gif" class="skin"><br>
        PDF</a>
</div>
<h1>Sesi&oacute;n 2 de ejercicios EJB - Beans de sesi&oacute;n sin estado</h1>
<div id="minitoc-area">
<ul class="minitoc">
<li>
<a href="#Proyecto+cliente">Proyecto cliente</a>
</li>
<li>
<a href="#Eliminar+el+bean+Saludo+del+servidor+de+aplicaciones">Eliminar el bean Saludo del servidor de aplicaciones</a>
</li>
<li>
<a href="#Instalaci%C3%B3n+del">Instalaci&oacute;n del Runtime BEA Weblogic</a>
</li>
<li>
<a href="#Creaci%C3%B3n+y+despliegue+del+bean+Saludo">Creaci&oacute;n y despliegue del bean Saludo</a>
</li>
<li>
<a href="#%28*%29+Creaci%C3%B3n+y+despliegue+de+la+aplicaci%C3%B3n+Web+ejb-saludoWar">(*) Creaci&oacute;n y despliegue de la aplicaci&oacute;n Web ejb-saludoWar</a>
</li>
</ul>
</div>


<p>En los ejercicios de esta sesi&oacute;n vamos a detallar todos los pasos necesarios para implementar el bean <span class="codefrag">Saludo</span> que hemos probado en la sesi&oacute;n anterior. </p>


<p>Vamos a continuar usando el entorno Eclipse WebTools, aunque a partir de la pr&oacute;xima sesi&oacute;n usaremos el entorno de programaci&oacute;n BEA Workshop.</p>


<p>Pasos a seguir:</p>


<ul>

<li>Crear una clase de prueba JUnit en el proyecto de la sesi&oacute;n anterior <span class="codefrag">ejb-cliente-saludo</span> para probar el enterprise bean de forma remota.</li>

<li>Eliminar el bean desplegado en la sesi&oacute;n anterior.</li>

<li>Crear el bean <span class="codefrag">Saludo</span>.</li>

<li>Desplegar el bean <span class="codefrag">Saludo</span> y comprobar el cliente y las pruebas de JUnit.</li>

<li>Crear la aplicaci&oacute;n web <span class="codefrag">ejb-saludoWar</span>, el fichero EAR con el EJB y desplegar todo en el servidor de aplicaciones.</li>

</ul>


<a name="N10036"></a><a name="Proyecto+cliente"></a>
<h2 class="underlined_10">Proyecto cliente</h2>
<div class="section">
<p>Continua trabajando con el proyecto que creaste en la sesi&oacute;n anterior y con el enterprise bean desplegado en el servidor de aplicaciones en funcionamiento:</p>
<p>

<img alt="" content-width="6cm" src="imagenes/ejercicios02/img2.png">
</p>
<p>Ejecuta el programa <span class="codefrag">ClienteSaludo</span> para comprobar que el bean est&aacute; desplegado y activo. Vamos ahora a crear la prueba JUnit que compruebe el funcionamiento remoto del bean (cuando lo volvamos a desplegar).</p>
<ul>

<li>Crea un nuevo paquete <span class="codefrag">es.ua.jtech.ejb.tests</span>. Pulsa el bot&oacute;n derecho sobre &eacute;l y crea un nuevo "JUnit Test Case". Pulsa en el enlace inferior del di&aacute;logo que aparece para incorporar la librer&iacute;a de JUnit al<em> build path</em>.</li>


<li>Escribe como nombre de la clase de prueba <span class="codefrag">TestSaludo</span>. Escribe el siguiente c&oacute;digo (copia y pega). En &eacute;l se definen tres pruebas que se ejecutan secuencialmente. La primera crea el acceso al bean (objeto que implementa la interfaz <span class="codefrag">Saludo</span>) y se guarda en la variable est&aacute;tica <span class="codefrag">saludo</span>. La segunda prueba el m&eacute;todo <span class="codefrag">saluda()</span> y la tercera el m&eacute;todo <span class="codefrag">getSaludo(int numDatos)</span>:</li>

</ul>
<p>
<strong>TestSaludo.java</strong>:</p>
<pre class="code">package es.ua.jtech.ejb.tests;

import java.io.IOException;
import java.util.Properties;

import javax.naming.Context;
import javax.naming.InitialContext;
import javax.rmi.PortableRemoteObject;

import es.ua.jtech.ejb.beans.Saludo;
import es.ua.jtech.ejb.beans.SaludoHome;
import es.ua.jtech.ejb.beans.SaludoTO;

import junit.framework.TestCase;

public class TestSaludo extends TestCase {
   private static Saludo saludo;

   public TestSaludo(String nombre) {
      super(nombre);
   }

   public void testCreateSaludo() {
      try {
         Context jndiContext = getInitialContext(); 
         Object obj = jndiContext.lookup("SaludoBean"); 
         SaludoHome home = (SaludoHome) narrow(obj, SaludoHome.class); 
         obj = home.create(); 
         saludo = (Saludo) narrow(obj, Saludo.class);
      } catch (Exception e) {
         fail("Fallo en la creaci&oacute;n");
      }
   }

   public void testSaluda() {
      try {
         String saludoStr = saludo.saluda();
         assertTrue(saludoStr.equals("Hola, que tal?")
               || saludoStr.equals("Cuanto tiempo sin verte")
               || saludoStr.equals("Que te cuentas?")
               || saludoStr.equals("Me alegro de volver a verte"));
      } catch (Exception e) {
         fail("Fallo en la comunicaci&oacute;n con el bean");
      }
   }

   public void testGetSaludo() {
      try {
         SaludoTO saludoTO = saludo.getSaludo(100);
         assertTrue(saludoTO.getDatos().size() == 100);
      } catch (Exception e) {
         fail("Fallo en la comunicaci&oacute;n con el bean");
      }
   }

   private static Context getInitialContext() 
         throws javax.naming.NamingException, IOException {
      Properties p = new Properties();
      p.put(Context.INITIAL_CONTEXT_FACTORY,
            "weblogic.jndi.WLInitialContextFactory");
      p.put(Context.PROVIDER_URL, "t3://localhost:7001");
      return new InitialContext(p);
   }

   private static Object narrow(Object obj, Class clase) { 
      return PortableRemoteObject.narrow(obj, clase);
   }
}</pre>
<ul>

<li>Ejecuta el test con el bot&oacute;n derecho sobre el fichero <span class="codefrag">TestSaludo.java</span> y seleccionando la opci&oacute;n "Run As &gt; JUnit Test". Todas las pruebas deben funcionar correctamente. En la siguiente figura se muestra el aspecto de la vista de JUnit, despu&eacute;s de haberla colocado en el panel inferior derecho.:</li>

</ul>
<p>

<img alt="" content-width="12cm" src="imagenes/ejercicios02/img4bis.png">
</p>
</div>


<a name="N10086"></a><a name="Eliminar+el+bean+Saludo+del+servidor+de+aplicaciones"></a>
<h2 class="underlined_10">Eliminar el bean Saludo del servidor de aplicaciones</h2>
<div class="section">
<p>Usar la consola de administraci&oacute;n para eliminar del servidor de aplicaciones el bean <span class="codefrag">ejb-saludo</span>. Para ello:</p>
<ul>

<li>Pincha en el bot&oacute;n "Lock &amp; Edit" (panel superior izquierdo)</li>

<li>Activa la casilla del bean <span class="codefrag">ejb-saludo</span>. Despliega el men&uacute; "Stop" y selecciona la opci&oacute;n "Force Stop Now". Confirma.</li>

<li>Ahora que el bean se encuentra en estado "Prepared" ya podemos eliminarlo. Vuelve a activar su casilla y pulsa ahora "Delete". Confirma.</li>

<li> Pulsa en "Activate Changes" (en verde). El bean ha sido eliminado.</li>

</ul>
<p>Para el servidor de aplicaciones, utilizando el men&uacute; "Inicio" de Windows.</p>
<p>Lanza de nuevo las pruebas JUnit. Ver&aacute;s que las tres pruebas definidas fallan (las dos &uacute;ltimas necesitan que la primera haya obtenido correctamente el bean).</p>
<p>

<img alt="" content-width="12cm" src="imagenes/ejercicios02/img4.png">
</p>
<p>Nuestro objetivo en lo que falta de sesi&oacute;n de ejercicios es <strong>MAKE IT GREEN!</strong>
</p>
</div>



<a name="N100B8"></a><a name="Instalaci%C3%B3n+del"></a>
<h2 class="underlined_10">Instalaci&oacute;n del Runtime BEA Weblogic</h2>
<div class="section">
<p>1. Selecciona la opci&oacute;n "Window &gt; Preferences... &gt; Server &gt; Installed Runtimes" y pulsa "Add...". Selecciona "BEA Systems, Inc. &gt; Generic BEA Weblogic v9.2". Acepta el siguiente di&aacute;logo.</p>
<p>

<img alt="" content-width="8cm" src="imagenes/ejercicios02/img5.png">
</p>
</div>


<a name="N100CD"></a><a name="Creaci%C3%B3n+y+despliegue+del+bean+Saludo"></a>
<h2 class="underlined_10">Creaci&oacute;n y despliegue del bean Saludo</h2>
<div class="section">
<p>Vamos ahora a crear paso a paso el enterprise bean <span class="codefrag">SaludoBean</span>.</p>
<p>1. Crea un proyecto con el asistente "EJB &gt; EJB Project" con el nombre de "ejb-saludo". Acepta los di&aacute;logos del asistente. Abre la perspectiva "J2EE" tal y como te sugiere el asistente.</p>
<p>2. En la pesta&ntilde;a de "Servers" a&ntilde;ade el servidor BEA Weblogic del dominio "ejb" que creaste en la sesi&oacute;n pasada:</p>
<ul>

<li>Bot&oacute;n derecho &gt; "New &gt; Server".</li>

<li>En la siguiente pantalla escoge "Next&gt;" para introducir el path en donde est&aacute; el dominio "ejb" ("C:\bea\user_projects\domains\ejb"), los path de los comandos de arranque y parada del servidor y el usuario y contrase&ntilde;a para administrarlo (ver figura). Pulsa  "Finish". </li>

</ul>
<p>

<img alt="" content-width="8cm" src="imagenes/ejercicios02/img7.png">
</p>
<p>El servidor aparecer&aacute; en estado "Stopped". El aspecto de Eclipse debe ser el siguiente:</p>
<p>

<img alt="" content-width="13cm" src="imagenes/ejercicios02/img8.png">
</p>
<p>3. Crea el paquete <span class="codefrag">es.ua.jtech.ejb.beans</span> en el paquete <span class="codefrag">ejb-saludo</span> y crea en &eacute;l los ficheros (c&oacute;pialos de los apuntes):</p>
<ul>

<li>Saludo.java</li>

<li>SaludoHome.java</li>

<li>SaludoBean.java</li>

<li>SaludoTO.java</li>

</ul>
<p>4. Modifica en el directorio "src/META-INF" el fichero <span class="codefrag">ejb-jar.xml</span> y crea el fichero <span class="codefrag">weblogic-ejb-jar.xml</span> con el siguiente contenido.</p>
<p>
<strong>ejb-jar.xml</strong>:</p>
<pre class="code">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;ejb-jar id="ejb-jar_ID" version="2.1"
xmlns="http://java.sun.com/xml/ns/j2ee"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xsi:schemaLocation="http://java.sun.com/xml/ns/j2ee
http://java.sun.com/xml/ns/j2ee/ejb-jar_2_1.xsd"&gt;
    &lt;enterprise-beans&gt;
        &lt;session&gt;
            &lt;ejb-name&gt;SaludoBean&lt;/ejb-name&gt;
            &lt;home&gt;es.ua.jtech.ejb.beans.SaludoHome&lt;/home&gt;
            &lt;remote&gt;es.ua.jtech.ejb.beans.Saludo&lt;/remote&gt;
            &lt;ejb-class&gt;es.ua.jtech.ejb.beans.SaludoBean&lt;/ejb-class&gt;
            &lt;session-type&gt;Stateless&lt;/session-type&gt;
            &lt;transaction-type&gt;Container&lt;/transaction-type&gt;
        &lt;/session&gt;
    &lt;/enterprise-beans&gt;
&lt;/ejb-jar&gt;</pre>
<p>
<strong>weblogic-ejb-jar.xml</strong>:</p>
<pre class="code">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;weblogic-ejb-jar xmlns="http://www.bea.com/ns/weblogic/90"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xsi:schemaLocation="http://www.bea.com/ns/weblogic/90 
http://www.bea.com/ns/weblogic/90/weblogic-ejb-jar.xsd"&gt;
    &lt;weblogic-enterprise-bean&gt;
        &lt;ejb-name&gt;SaludoBean&lt;/ejb-name&gt;
        &lt;jndi-name&gt;SaludoBean&lt;/jndi-name&gt;
    &lt;/weblogic-enterprise-bean&gt;
&lt;/weblogic-ejb-jar&gt;</pre>
<p> La configuraci&oacute;n del proyecto debe quedar como la siguiente figura:</p>
<p>

<img alt="" content-width="13cm" src="imagenes/ejercicios02/img10.png">
</p>
<p>5. Asegurate de que el servidor de aplicaciones est&aacute; parado y que no hay ninguna instancia funcionando fuera de Eclipse, conect&aacute;ndote a la consola de administraci&oacute;n. Deber&aacute; aparecer el mensaje de error del navegador "Imposible realizar la conexi&oacute;n". Pon en marcha el servidor de aplicaciones pulsando el bot&oacute;n verde con el s&iacute;mbolo de "play" o pulsando el bot&oacute;n derecho sobre el servidor y seleccionando "Start".</p>
<p>6. Despliega el bean en el servidor de aplicaciones. Para ello, pulsa con el bot&oacute;n derecho en el servidor (panel inferior) y escoge la opci&oacute;n "Add and Remove Projects...". Selecciona el proyecto <span class="codefrag">ejb-saludo</span> y pulsa "Finish" para desplegarlo en el servidor:</p>
<p>

<img alt="" content-width="6cm" src="imagenes/ejercicios02/img9.png">
</p>
<p>6. Si consultas en la consola de administraci&oacute;n ver&aacute;s que el bean se ha desplegado correctamente y est&aacute; en estado activo.</p>
<p>7. Prueba ahora a ejecutar los tests de JUnit y todos deben funcionar correctamente.</p>
<p>8. Ahora puedes modificar el bean, cambiando la implementaci&oacute;n de alguno de los m&eacute;todos en el fichero <span class="codefrag">SaludoBean.java</span>. Por ejemplo, haz que el bean devuelva tu nombre junto al saludo, modificando el m&eacute;todo <span class="codefrag">saluda()</span> de la siguiente forma: </p>
<pre class="code">public String saluda() {
   int random = (int) (Math.random() * saludos.length);
   <strong>return "Pepito dice: " + saludos[random];</strong>
}
</pre>
<p>9. Salva el fichero y ver&aacute;s que el estado del servidor cambia a "Republish". Pulsa en el bot&oacute;n derecho y selecciona "Publish". Ver&aacute;s como el bean se redespliega en el servidor. Ejecuta el programa <span class="codefrag">ClienteSaludo.java</span> y comprueba que el mensaje que devuelve el bean ha cambiado.</p>
</div>



<a name="N10167"></a><a name="%28*%29+Creaci%C3%B3n+y+despliegue+de+la+aplicaci%C3%B3n+Web+ejb-saludoWar"></a>
<h2 class="underlined_10">(*) Creaci&oacute;n y despliegue de la aplicaci&oacute;n Web ejb-saludoWar</h2>
<div class="section">
<p>Vamos a terminar creando y desplegando la aplicaci&oacute;n Web que accede al bean de forma local.</p>
<p>1. Elimina el bean del servidor de aplicaciones, seleccionando la opci&oacute;n "Add and Remove Projects..." y eliminando el proyecto "ejb-saludo". Ver&aacute;s que autom&aacute;ticamente se lanza una tarea de <em>ant</em> que realiza el <em>undeploy</em> del bean. Comprueba en la consola de administraci&oacute;n que el bean ya no est&aacute; desplegado.</p>
<p>2. Modifica los ficheros descriptores de despliegue a&ntilde;adiendo las siguientes l&iacute;neas (marcadas con una flecha):</p>
<p>
<strong>ejb-jar.xml</strong>:</p>
<pre class="code">
        ...
        &lt;remote&gt;es.ua.jtech.ejb.beans.Saludo&lt;/remote&gt;
  ---&gt;  &lt;local-home&gt;es.ua.jtech.ejb.beans.SaludoLocalHome&lt;/local-home&gt;
  ---&gt;  &lt;local&gt;es.ua.jtech.ejb.beans.SaludoLocal&lt;/local&gt;
        &lt;ejb-class&gt;es.ua.jtech.ejb.beans.SaludoBean&lt;/ejb-class&gt;
        ...</pre>
<p>
<strong>weblogic-ejb-jar.xml</strong>:</p>
<pre class="code">
    ...
    &lt;weblogic-enterprise-bean&gt;
        &lt;ejb-name&gt;SaludoBean&lt;/ejb-name&gt;
        &lt;jndi-name&gt;SaludoBean&lt;/jndi-name&gt;
  ---&gt;  &lt;local-jndi-name&gt;SaludoBeanLocal&lt;/local-jndi-name&gt;
    &lt;/weblogic-enterprise-bean&gt;
    ...</pre>
<p>Ver&aacute;s que aparecen errores en el proyecto. Eclipse detecta que las clases declaradas en el descriptor de despliegue no han sido definidas.</p>
<p>
<img alt="" content-width="13cm" src="imagenes/ejercicios02/img11.png">
</p>
<p>2. A&ntilde;ade en el paquete del bean <span class="codefrag">ejb-saludo</span> (paquete <span class="codefrag">es.ua.jtech.ejb.beans</span>) las interfaces que facilitan el acceso local al bean (c&oacute;pialas de los apuntes):</p>
<ul>

<li>SaludoLocal.java</li>

<li>SaludoLocalHome.java</li>

</ul>
<p>Ver&aacute;s que han desaparecido los errores en el proyecto. De esta forma has a&ntilde;adido las interfaces locales al bean, para que se pueda acceder desde la aplicaci&oacute;n web.</p>
<p>3. Crea un nuevo proyecto <span class="codefrag">ejb-saludoWar</span> del tipo "Dynamic Web Project". Crea el paquete <span class="codefrag">es.ua.jtech.ejb.delegates</span> y en ese paquete, crea la siguiente clase Java: </p>
<p>
<strong>SaludoBean.java</strong>
</p>
<pre class="code">package es.ua.jtech.ejb.delegates;

import java.io.IOException;
import java.util.Date;
import java.util.List;
import java.util.Properties;

import javax.naming.Context;
import javax.naming.InitialContext;

import es.ua.jtech.ejb.beans.SaludoTO;
import es.ua.jtech.ejb.beans.SaludoLocal;
import es.ua.jtech.ejb.beans.SaludoLocalHome;

public class SaludoBean {
   private String mensaje;
   private Date fecha;
   private List&lt;Integer&gt; datos;

   public SaludoBean() {
      try {
         Context jndiContext = getInitialContext();
         SaludoLocalHome home = (SaludoLocalHome) jndiContext.lookup("SaludoBeanLocal");
         SaludoLocal saludo = (SaludoLocal) home.create();
         SaludoTO saludoTO = saludo.getSaludo(100000);
         this.mensaje = saludoTO.getMensaje();
         this.fecha = saludoTO.getFecha();
         this.datos = saludoTO.getDatos();
      } catch (Exception e) {
         e.printStackTrace(); // [7]
      }
   }

   public int getNumDatos() {
      return datos.size();
   }

   public String getFecha() {
      return fecha.toString();
   }

   public String getMensaje() {
      return mensaje;
   }

   private Context getInitialContext() throws javax.naming.NamingException,
         IOException {
      Properties p = new Properties();
      p.put(Context.INITIAL_CONTEXT_FACTORY,
            "weblogic.jndi.WLInitialContextFactory");
      p.put(Context.PROVIDER_URL, "t3://localhost:7001");
      return new InitialContext(p);
   }
}</pre>
<p>Ver&aacute;s que se trata de un JavaBean que en su creaci&oacute;n accede al enterprise bean de forma local, guardando los datos que &eacute;ste devuelve en sus propiedades <span class="codefrag">numDatos</span>, <span class="codefrag">fecha</span> y <span class="codefrag">mensaje</span>.</p>
<p>4. Comprueba que han aparecido errores en el proyecto reci&eacute;n creado, porque las interfaces del enterprise bean no se encuentran en el <em>build path</em> del proyecto web. Vamos a arreglarlo poniendo el proyecto <span class="codefrag">ejb-saludo</span> en el <em>build path</em> del proyecto web. Para ello, pulsa el bot&oacute;n derecho en el proyecto web y selecciona "Build Path &gt; Configure Build Path...". Selecciona la pesta&ntilde;a "Projects" y a&ntilde;ade el proyecto <span class="codefrag">ejb-saludo</span>. Ya no debe aparecer ning&uacute;n error.</p>
<p>5. Crea el fichero JSP que muestre por pantalla el resultado de la llamada al enterprise bean. Para eso crea el fichero <span class="codefrag">index.jsp</span> en el directorio <span class="codefrag">WebContent</span> con el siguiente contenido:</p>
<pre class="code">&lt;%@ page language="java" contentType="text/html; charset=ISO-8859-1"
    pageEncoding="ISO-8859-1"%&gt;
&lt;!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd"&gt;

&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"&gt;
&lt;title&gt;Saludo&lt;/title&gt;
&lt;/head&gt;

&lt;body&gt;
&lt;jsp:useBean id="saludo" scope="request"
class="es.ua.jtech.ejb.delegates.SaludoBean"&gt;
&lt;/jsp:useBean&gt;

&lt;h2&gt;Saludo&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;Mensaje: &lt;%= saludo.getMensaje()%&gt;&lt;/li&gt;
&lt;li&gt;Fecha de creaci&oacute;n: &lt;%= saludo.getFecha() %&gt;&lt;/li&gt;
&lt;li&gt;N&uacute;mero de datos: &lt;%= saludo.getNumDatos() %&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;/body&gt;
&lt;/html&gt;</pre>
<p>F&iacute;jate que la p&aacute;gina JSP crea un JavaBean <span class="codefrag">delegates.SaludoBean</span> de &aacute;mbito <em>request</em>. Esto significa que cada vez que se cargue la p&aacute;gina, se va a llamar al procedimiento de creaci&oacute;n del JavaBean, que a su vez llamar&aacute; a la creaci&oacute;n del enterprise bean. Despu&eacute;s se muestran las propiedades del JavaBean, que se han obtenido en la llamada al enterprise bean.</p>
<p>6. Ya s&oacute;lo queda desplegar conjuntamente el proyecto ejb y el proyecto web. Para ello vamos a integrarlos ambos en un EAR. Crea un nuevo proyecto "J2EE &gt; Enterprise Application Project" con el nombre de <span class="codefrag">ejb-saludoWebEAR</span> que contenga los projectos <span class="codefrag">ejb-saludo</span> y <span class="codefrag">ejb-saludoWar</span> (ver figura)</p>
<p>
<img alt="" content-width="8cm" src="imagenes/ejercicios02/img12.png">
</p>
<p>Una vez creado el proyecto EAR, el explorador de proyectos debe tener el siguiente aspecto:</p>
<p>
<img alt="" content-width="6cm" src="imagenes/ejercicios02/img13.png">
</p>
<p>Despliega ahora el proyecto EAR, pulsando el bot&oacute;n derecho sobre el servidor de aplicaciones y escogiendo la opci&oacute;n "Add and Remove Projects...". Ver&aacute;s que el &uacute;nico proyecto que permite desplegar es el reci&eacute;n creado. Selecci&oacute;nalo y pulsa "Publish" en el servidor.</p>
<p>7. Para comprobar que todo ha funcionado correctamente, accede al servidor con la consola de administraci&oacute;n y comprueba que se ha desplegado el EAR.</p>
<p>8. Por &uacute;ltimo, accede a la URL <span class="codefrag">http://localhost:7001/ejb-saludoWar</span> para comprobar el funcionamiento de la p&aacute;gina. Tambi&eacute;n debes poder acceder al bean de forma remota con el cliente y las pruebas JUnit.</p>
<p>Para dejar el servidor de aplicaciones en un estado consistente y vac&iacute;o para la siguiente sesi&oacute;n, elimina el EAR desplegado y p&aacute;ralo antes de cerrar Eclipse. </p>
</div>


<p class="pageBreakAfter"></p>

</div>
<div class="clearboth">&nbsp;</div>
</div>
<div id="footer">
<div class="lastmodified">
<script type="text/javascript"><!--
document.write("<text>Last Published:</text> " + document.lastModified);
//  --></script>
</div>
<div class="copyright">
        Copyright &copy;
         2006-2007 Depto. CCIA</div>
</div>
</body>
</html>
