<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta content="Apache Forrest" name="Generator">
<meta name="Forrest-version" content="0.7">
<meta name="Forrest-skin-name" content="pelt">
<title>Sesi&oacute;n 4 de ejercicios EJB - Conexi&oacute;n con BD de un EJB con estado</title>
<link type="text/css" href="skin/basic.css" rel="stylesheet">
<link media="screen" type="text/css" href="skin/screen.css" rel="stylesheet">
<link media="print" type="text/css" href="skin/print.css" rel="stylesheet">
<link type="text/css" href="skin/profile.css" rel="stylesheet">
<script src="skin/getBlank.js" language="javascript" type="text/javascript"></script><script src="skin/getMenu.js" language="javascript" type="text/javascript"></script><script src="skin/fontsize.js" language="javascript" type="text/javascript"></script>
<link rel="shortcut icon" href="">
</head>
<body onload="init()">
<script type="text/javascript">ndeSetTextSize();</script>
<div id="top">
<div class="header">
<div class="grouplogo">
<a href="http://www.jtech.ua.es/j2ee"><img class="logoImage" alt="J2EE" src="images/baner_j2ee_izq.gif" title="Curso Especialista Universitario J2EE"></a>
</div>
<div class="projectlogoA1">
<a href="http://www.dccia.ua.es/"><img class="logoImage" alt="Componentes EJB" src="images/baner_j2ee_der.gif" title="Componentes EJB"></a>
</div>
<ul id="tabs">
<li>
<a class="base-not-selected" href="../index.html">M&oacute;dulos</a>
</li>
<li class="current">
<a class="base-selected" href="index.html">Componentes EJB</a>
</li>
</ul>
</div>
</div>
<div id="main">
<div id="publishedStrip">
<div id="level2tabs"></div>
<script type="text/javascript"><!--
document.write("<text>Last Published:</text> " + document.lastModified);
//  --></script>
</div>
<div class="breadtrail">
             
             &nbsp;
           </div>
<div id="menu">
<div onclick="SwitchMenu('menu_selected_1.1', 'skin/')" id="menu_selected_1.1Title" class="menutitle" style="background-image: url('skin/images/chapter_open.gif');">Materiales</div>
<div id="menu_selected_1.1" class="selectedmenuitemgroup" style="display: block;">
<div class="menuitem">
<a href="index.html" title="Componentes EJB">&Iacute;ndice</a>
</div>
<div onclick="SwitchMenu('menu_1.1.2', 'skin/')" id="menu_1.1.2Title" class="menutitle">Teor&iacute;a</div>
<div id="menu_1.1.2" class="menuitemgroup">
<div class="menuitem">
<a href="sesion01-apuntes.html" title="Introducci&oacute;n a los Enterprise Beans">Sesi&oacute;n 1</a>
</div>
<div class="menuitem">
<a href="sesion02-apuntes.html" title="Beans de sesi&oacute;n">Sesi&oacute;n 2</a>
</div>
<div class="menuitem">
<a href="sesion03-apuntes.html" title="Beans de sesi&oacute;n">Sesi&oacute;n 3</a>
</div>
<div class="menuitem">
<a href="sesion04-apuntes.html" title="Beans de sesi&oacute;n">Sesi&oacute;n 4</a>
</div>
<div class="menuitem">
<a href="sesion05-apuntes.html" title="Seguridad">Sesi&oacute;n 5</a>
</div>
<div class="menuitem">
<a href="sesion06-apuntes.html" title="Transacciones">Sesi&oacute;n 6</a>
</div>
<div class="menuitem">
<a href="sesion07-apuntes.html" title="EJB 3.0">Sesi&oacute;n 7</a>
</div>
<div class="menuitem">
<a href="sesion08-apuntes.html" title="JPA">Sesi&oacute;n 8</a>
</div>
<div class="menuitem">
<a href="roadmap.html" title="Roadmap EJB">Roadmap</a>
</div>
</div>
<div onclick="SwitchMenu('menu_selected_1.1.3', 'skin/')" id="menu_selected_1.1.3Title" class="menutitle" style="background-image: url('skin/images/chapter_open.gif');">Ejercicios</div>
<div id="menu_selected_1.1.3" class="selectedmenuitemgroup" style="display: block;">
<div class="menuitem">
<a href="sesion01-ejercicios.html" title="Introducci&oacute;n a los Enterprise Beans">Sesi&oacute;n 1</a>
</div>
<div class="menuitem">
<a href="sesion02-ejercicios.html" title="Beans de sesi&oacute;n">Sesi&oacute;n 2</a>
</div>
<div class="menuitem">
<a href="sesion03-ejercicios.html" title="Beans de sesi&oacute;n">Sesi&oacute;n 3</a>
</div>
<div class="menupage">
<div class="menupagetitle">Sesi&oacute;n 4</div>
</div>
<div class="menuitem">
<a href="sesion05-ejercicios.html" title="Seguridad">Sesi&oacute;n 5</a>
</div>
<div class="menuitem">
<a href="sesion06-ejercicios.html" title="Transacciones">Sesi&oacute;n 6</a>
</div>
<div class="menuitem">
<a href="sesion07-ejercicios.html" title="EJB 3.0">Sesi&oacute;n 7</a>
</div>
<div class="menuitem">
<a href="sesion08-ejercicios.html" title="JPA">Sesi&oacute;n 8</a>
</div>
</div>
</div>
<div id="credit"></div>
<div id="roundbottom">
<img style="display: none" class="corner" height="15" width="15" alt="" src="skin/images/rc-b-l-15-1body-2menu-3menu.png"></div>
<div id="credit2"></div>
</div>
<div id="content">
<div title="Portable Document Format" class="pdflink">
<a class="dida" href="sesion04-ejercicios.pdf"><img alt="PDF -icon" src="skin/images/pdfdoc.gif" class="skin"><br>
        PDF</a>
</div>
<h1>Sesi&oacute;n 4 de ejercicios EJB - Conexi&oacute;n con BD de un EJB con estado</h1>
<div id="minitoc-area">
<ul class="minitoc">
<li>
<a href="#Configuraci%C3%B3n+del+espacio+de+trabajo+inicial">Configuraci&oacute;n del espacio de trabajo inicial</a>
</li>
<li>
<a href="#Creaci%C3%B3n+del+EAR">Creaci&oacute;n del EAR</a>
</li>
<li>
<a href="#Creaci%C3%B3n+del+proyecto+EJB+y+del+enterprise+bean">Creaci&oacute;n del proyecto EJB y del enterprise bean</a>
</li>
<li>
<a href="#Despliegue+del+EAR">Despliegue del EAR</a>
</li>
<li>
<a href="#Creaci%C3%B3n+de+la+fuente+de+datos">Creaci&oacute;n de la fuente de datos</a>
</li>
<li>
<a href="#Comprobaci%C3%B3n+del+funcionamiento+remoto">Comprobaci&oacute;n del funcionamiento remoto</a>
</li>
</ul>
</div>


<p>En esta sesi&oacute;n de ejercicios vamos a crear un enterprise bean con estado que implemente un <em>business object</em> remoto que usa un DAO. El estado del bean nos va a servir para mantener en una variable el DAO y no tener que crearlo cada vez que se abre una sesi&oacute;n. Como ejemplo vamos a usar un DAO del proyecto de integraci&oacute;n: el DAO <em>Usuario</em>.</p>


<p>Partimos del proyecto com&uacute;n en el que se define el DAO. Tambi&eacute;n, para ahorrar tiempo, entregamos un proyecto que implementa una conexi&oacute;n remota al EJB y un conjunto de pruebas JUnit que testean el EJB.</p>


<p>En resumen, los pasos a seguir son los siguientes:</p>


<ul>

<li>Configuraci&oacute;n del espacio de trabajo inicial</li>

<li>Creaci&oacute;n del EAR en el que se va a incluir el DAO y el bean</li>

<li>Creaci&oacute;n del enterprise bean</li>

<li>Despliegue del EAR en el servidor de aplicaciones</li>

<li>Creaci&oacute;n de la fuente de datos en el servidor de aplicaciones</li>

<li>Comprobaci&oacute;n del funcionamiento remoto</li>

</ul>


<a name="N10030"></a><a name="Configuraci%C3%B3n+del+espacio+de+trabajo+inicial"></a>
<h2 class="underlined_10">Configuraci&oacute;n del espacio de trabajo inicial</h2>
<div class="section">
<p>1. Descarga el ZIP con los proyectos de esta sesi&oacute;n de ejercicios. En &eacute;l se encuentran los proyectos <span class="codefrag">ejb-usuario-comun</span> (contiene el DAO <em>Usuario</em>) y <span class="codefrag">ejb-usuario-cliente</span> que contiene el cliente remoto y las pruebas JUnit que haremos con el EJB.</p>
<p>Como referencia, para comprobar qu&eacute; m&eacute;todos debemos crear en el enterprise bean, listamos a continuaci&oacute;n ambos clientes.</p>
<p>
<strong>ClienteUsuario.java</strong>
</p>
<pre class="code">package es.ua.jtech.ejb.clientes;

import java.io.IOException;
import java.util.Properties;

import javax.naming.Context;
import javax.naming.InitialContext;
import javax.rmi.PortableRemoteObject;

import es.ua.jtech.ejb.beans.Usuario;
import es.ua.jtech.ejb.beans.UsuarioHome;
import es.ua.jtech.proyint.to.UsuarioTO;

public class ClienteUsuario {

   public static void main(String[] args) {
      try {
         Context jndiContext = getInitialContext();
         Object obj = jndiContext.lookup("UsuarioBean");
         UsuarioHome home = (UsuarioHome) narrow(obj, UsuarioHome.class);
         obj = home.create();
         Usuario usuario = (Usuario) narrow(obj, Usuario.class);

         System.out.println("Voy a crear el usuario domingo");
         UsuarioTO usuarioTO = new UsuarioTO("domingo","gallardo",
                                              "Domingo","Gallardo","L&oacute;pez");
         usuario.addUsuario(usuarioTO);
         System.out.println("Voy a buscar el usuario domingo");
         usuarioTO = usuario.selectUsuario("domingo");
         if (usuarioTO != null) {
            System.out.println("Usuario domingo encontrado");
            System.out.println("Contrase&ntilde;a: " + usuarioTO.getPassword());
            System.out.println("Nombre completo: " + usuarioTO.getNombre() + " " +
                                                     usuarioTO.getApellido1() + " " +
                                                     usuarioTO.getApellido2());
         }
         else {
            System.out.println("Usuario no encontrado");
         }
         System.out.println("Voy a borrar el usuario domingo");
         usuario.deleteUsuario("domingo");
         System.out.println("Voy a buscar el usuario domingo");        
         usuarioTO = usuario.selectUsuario("domingo");
         if (usuarioTO != null) {
            System.out.println("Usuario domingo encontrado");
            System.out.println("Contrase&ntilde;a: " + usuarioTO.getPassword());
            System.out.println("Nombre completo: " + usuarioTO.getNombre() + " " +
                                                     usuarioTO.getApellido1() + " " +
                                                     usuarioTO.getApellido2());
         }
         else {
            System.out.println("Usuario no encontrado");
         }
         System.out.println("Adios");
      } catch (Exception e) {
         e.printStackTrace();
      }
   }

   private static Context getInitialContext() 
         throws javax.naming.NamingException, IOException {
      Properties p = new Properties();
      p.put(Context.INITIAL_CONTEXT_FACTORY,
            "weblogic.jndi.WLInitialContextFactory");
      p.put(Context.PROVIDER_URL, "t3://localhost:7001");
      return new InitialContext(p);
   }

   private static Object narrow(Object obj, Class clase) {
      return PortableRemoteObject.narrow(obj, clase);
   }
}</pre>
<p>
<strong>TestUsuario.java:</strong>
</p>
<pre class="code">package es.ua.jtech.ejb.tests;

import java.io.IOException;
import java.util.Properties;

import javax.naming.Context;
import javax.naming.InitialContext;
import javax.rmi.PortableRemoteObject;

import es.ua.jtech.ejb.beans.Usuario;
import es.ua.jtech.ejb.beans.UsuarioHome;
import es.ua.jtech.proyint.to.UsuarioTO;
import junit.framework.TestCase;

public class TestUsuario extends TestCase {
    private static Usuario usuario;
    
    public TestUsuario (String nombre) {
        super(nombre);
    }
    
    public void testCreateUsuario() {
        try {
        Context jndiContext = getInitialContext(); 
        Object obj = jndiContext.lookup("UsuarioBean"); 
        UsuarioHome home = (UsuarioHome) narrow(obj, UsuarioHome.class); 
        obj = home.create(); 
        usuario = (Usuario) narrow(obj, Usuario.class);
        } catch (Exception e) {
            fail("Fallo en la creaci&oacute;n");
        }
    }
    
    public void testAddUsuario() {
        try {
           UsuarioTO usuarioTO = new UsuarioTO("domingo","gallardo",
                 "Domingo","Gallardo","L&oacute;pez");
           usuario.addUsuario(usuarioTO);
        } catch (Exception e) {
            fail("Fallo a&ntilde;adiendo usuario");
        }
    }
    
    public void testSelectUsuario() {
       try {
          UsuarioTO usuarioTO = usuario.selectUsuario("domingo");
          assertTrue(usuarioTO != null);
       }  catch (Exception e) {
          fail("Fallo seleccionando usuario");
       }
    }
    
    public void testDeleteUsuario() {
       try {
          int numBorrados = usuario.deleteUsuario("domingo");
          assertTrue(numBorrados == 1);
       }  catch (Exception e) {
          fail("Fallo borrando usuario");
       }      
    }
    
    private static Context getInitialContext()
            throws javax.naming.NamingException, IOException {
        Properties p = new Properties();
        p.put(Context.INITIAL_CONTEXT_FACTORY,
                "weblogic.jndi.WLInitialContextFactory");
        p.put(Context.PROVIDER_URL, "t3://localhost:7001");
        return new InitialContext(p);
    }

    private static Object narrow(Object obj, Class clase) {
        return PortableRemoteObject.narrow(obj, clase);
    }
}</pre>
<p>Hay que hacer notar que el bean va a ofrecer los servicios determinados por sus m&eacute;todos remotos: <span class="codefrag">addUsuario</span>, <span class="codefrag">selectUsuario</span> y <span class="codefrag">deleteUsuario</span>. En este caso son los mismos m&eacute;todos que el DAO, pero normalmente el bean proporciona una l&oacute;gica de negocio adicional (lo veremos en el proyecto de integraci&oacute;n).</p>
<p>2. Importa los proyectos en tu espacio de trabajo Workshop.</p>
<p>3. Crea la base de datos <span class="codefrag">ejb</span> y carga sus datos. Para ello, muestra la vista de Ant y a&ntilde;ade el <em>buildfile</em> que hay en el directorio <span class="codefrag">bd</span>. Ejecuta las tareas <span class="codefrag">initDB</span> y <span class="codefrag">dataDB</span> para crear la base de datos y la tabla USUARIOS. La configuraci&oacute;n del espacio de trabajo se muestra en la siguiente imagen:</p>
<p>

<img alt="" content-width="13cm" src="imagenes/ejercicios04/img1.png">
</p>
</div>


<a name="N1007F"></a><a name="Creaci%C3%B3n+del+EAR"></a>
<h2 class="underlined_10">Creaci&oacute;n del EAR</h2>
<div class="section">
<p>1. Utiliza el asistente para crear el EAR <span class="codefrag">ejb-usuarioEAR</span>. Incluye en &eacute;l el proyecto <span class="codefrag">ejb-usuario-comun</span>.</p>
<p>

<img alt="" content-width="6cm" src="imagenes/ejercicios04/img2.png">
</p>
</div>



<a name="N10097"></a><a name="Creaci%C3%B3n+del+proyecto+EJB+y+del+enterprise+bean"></a>
<h2 class="underlined_10">Creaci&oacute;n del proyecto EJB y del enterprise bean</h2>
<div class="section">
<p>1. Utiliza el asistente para crear el proyecto Weblogic EJB <span class="codefrag">ejb-usuario</span>, a&ntilde;adi&eacute;ndolo al EAR.</p>
<p>

<img alt="" content-width="6cm" src="imagenes/ejercicios04/img3.png">
</p>
<p>2. Modifica las dependencias del proyecto reci&eacute;n creado para incluir la librer&iacute;a <span class="codefrag">ejb-usuario-comun.jar</span> correspondiente al proyecto <span class="codefrag">ejb-usuario-comun</span> en el que se define el DAO.</p>
<p>

<img alt="" content-width="6cm" src="imagenes/ejercicios04/img4.png">
</p>
<p>3. Crea en el proyecto bean el paquete <span class="codefrag">es.ua.jtech.ejb.beans</span>.</p>
<p>4. Crea en ese paquete el <em>WebLogic Session Bean</em> <span class="codefrag">UsuarioBean</span> usando el asistente correspondiente.</p>
<p>5. Cambia el nombre remoto JNDI del bean a <span class="codefrag">UsuarioBean</span> y los nombres de las clases remotas a <span class="codefrag">Usuario</span> y <span class="codefrag">UsuarioHome</span>:</p>
<p>

<img alt="" content-width="13cm" src="imagenes/ejercicios04/img5.png">
</p>
<p>6. Define la variables est&aacute;tica que va a contener el DAO: </p>
<pre class="code">   private static IUsuario usuarioDAO;</pre>
<p>7. A&ntilde;ade en el m&eacute;todo de creaci&oacute;n del bean el c&oacute;digo necesario para que el bean obtenga un <span class="codefrag">usuarioDAO</span> y lo guarde en la variable est&aacute;tica</p>
<p>8. A&ntilde;ade los m&eacute;todos de negocio y completa el c&oacute;digo (escribimos el c&oacute;digo de uno de ellos como ejemplo):</p>
<pre class="code">@RemoteMethod()
public UsuarioTO selectUsuario(String nombre) {
   UsuarioTO usuario = null;

   try {
      usuario = usuarioDAO.selectUsuario(nombre);
   } catch (DAOException e) {
       e.printStackTrace();
   }
   return usuario;
}

@RemoteMethod()
public void addUsuario(UsuarioTO usuarioTO) {...}

@RemoteMethod()
public int deleteUsuario(String nombre) {...}</pre>
<p>9. Define en las propiedades del EJB el nombre del <em>client jar</em> a crear: <span class="codefrag">ejb-usuario-clientjar.jar</span>.</p>
<p>

<img alt="" content-width="6cm" src="imagenes/ejercicios04/img5bis.png">
</p>
</div>


<a name="N10105"></a><a name="Despliegue+del+EAR"></a>
<h2 class="underlined_10">Despliegue del EAR</h2>
<div class="section">
<p>1. Pon en marcha el servidor de aplicaciones y despliega el EAR en &eacute;l:</p>
<p>

<img alt="" content-width="6cm" src="imagenes/ejercicios04/img6.png">
</p>
<p>2. A&ntilde;ade el ejbjar al cliente y reconstruye el proyecto.</p>
<p>

<img alt="" content-width="6cm" src="imagenes/ejercicios04/img7.png">
</p>
<p>3. Prueba el cliente <span class="codefrag">ClienteUsuario.java</span>, ver&aacute;s que no funciona porque falta por a&ntilde;adir la fuente de datos al servidor de aplicaciones. </p>
<p>

<img alt="" content-width="13cm" src="imagenes/ejercicios04/img8.png">
</p>
<div class="frame warning">
<div class="label">Aviso</div>
<div class="content">El manejo de las excepciones que ese hace en este ejemplo no es el correcto. En las sesiones pr&oacute;ximas veremos que es conveniente crear excepciones espec&iacute;ficas del EJB que abstraigan las excepciones del DAO.</div>
</div>
</div>


<a name="N10133"></a><a name="Creaci%C3%B3n+de+la+fuente+de+datos"></a>
<h2 class="underlined_10">Creaci&oacute;n de la fuente de datos</h2>
<div class="section">
<p>1. Crea con la consola de administraci&oacute;n la fuente de datos "ejbDS" con la BD "ejb":</p>
<p>

<img alt="" content-width="8cm" src="imagenes/ejercicios04/img9.png">
</p>
<p>

<img alt="" content-width="8cm" src="imagenes/ejercicios04/img10.png">
</p>
<p>2. Prueba que funciona la conexi&oacute;n:</p>
<p>

<img alt="" content-width="8cm" src="imagenes/ejercicios04/img11.png">
</p>
<p>3. &Aacute;&ntilde;adela al servidor de aplicaciones y activa los cambios:</p>
<p>

<img alt="" content-width="8cm" src="imagenes/ejercicios04/img12.png">
</p>
</div>


<a name="N10163"></a><a name="Comprobaci%C3%B3n+del+funcionamiento+remoto"></a>
<h2 class="underlined_10">Comprobaci&oacute;n del funcionamiento remoto</h2>
<div class="section">
<p>1. Vuelve a probar el cliente y las pruebas JUnit. &iexcl;Ahora ya funcionan!:</p>
<p>

<img alt="" content-width="13cm" src="imagenes/ejercicios04/img13.png">
</p>
</div>




<p class="pageBreakAfter"></p>





</div>
<div class="clearboth">&nbsp;</div>
</div>
<div id="footer">
<div class="lastmodified">
<script type="text/javascript"><!--
document.write("<text>Last Published:</text> " + document.lastModified);
//  --></script>
</div>
<div class="copyright">
        Copyright &copy;
         2006-2007 Depto. CCIA</div>
</div>
</body>
</html>
