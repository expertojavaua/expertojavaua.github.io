<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta content="Apache Forrest" name="Generator">
<meta name="Forrest-version" content="0.7">
<meta name="Forrest-skin-name" content="pelt">
<title>Sesi&oacute;n 5 de ejercicios EJB - Transacciones EJB</title>
<link type="text/css" href="skin/basic.css" rel="stylesheet">
<link media="screen" type="text/css" href="skin/screen.css" rel="stylesheet">
<link media="print" type="text/css" href="skin/print.css" rel="stylesheet">
<link type="text/css" href="skin/profile.css" rel="stylesheet">
<script src="skin/getBlank.js" language="javascript" type="text/javascript"></script><script src="skin/getMenu.js" language="javascript" type="text/javascript"></script><script src="skin/fontsize.js" language="javascript" type="text/javascript"></script>
<link rel="shortcut icon" href="">
</head>
<body onload="init()">
<script type="text/javascript">ndeSetTextSize();</script>
<div id="top">
<div class="header">
<div class="grouplogo">
<a href="http://www.jtech.ua.es/j2ee"><img class="logoImage" alt="J2EE" src="images/baner_j2ee_izq.gif" title="Curso Especialista Universitario J2EE"></a>
</div>
<div class="projectlogoA1">
<a href="http://www.dccia.ua.es/"><img class="logoImage" alt="Componentes EJB" src="images/baner_j2ee_der.gif" title="Componentes EJB"></a>
</div>
<ul id="tabs">
<li>
<a class="base-not-selected" href="../index.html">M&oacute;dulos</a>
</li>
<li class="current">
<a class="base-selected" href="index.html">Componentes EJB</a>
</li>
</ul>
</div>
</div>
<div id="main">
<div id="publishedStrip">
<div id="level2tabs"></div>
<script type="text/javascript"><!--
document.write("<text>Last Published:</text> " + document.lastModified);
//  --></script>
</div>
<div class="breadtrail">
             
             &nbsp;
           </div>
<div id="menu">
<div onclick="SwitchMenu('menu_selected_1.1', 'skin/')" id="menu_selected_1.1Title" class="menutitle" style="background-image: url('skin/images/chapter_open.gif');">Materiales</div>
<div id="menu_selected_1.1" class="selectedmenuitemgroup" style="display: block;">
<div class="menuitem">
<a href="index.html" title="Componentes EJB">&Iacute;ndice</a>
</div>
<div onclick="SwitchMenu('menu_1.1.2', 'skin/')" id="menu_1.1.2Title" class="menutitle">Teor&iacute;a</div>
<div id="menu_1.1.2" class="menuitemgroup">
<div class="menuitem">
<a href="sesion01-apuntes.html" title="Introducci&oacute;n a los Enterprise Beans">Sesi&oacute;n 1</a>
</div>
<div class="menuitem">
<a href="sesion02-apuntes.html" title="Beans de sesi&oacute;n">Sesi&oacute;n 2</a>
</div>
<div class="menuitem">
<a href="sesion03-apuntes.html" title="Beans de sesi&oacute;n">Sesi&oacute;n 3</a>
</div>
<div class="menuitem">
<a href="sesion04-apuntes.html" title="Beans de sesi&oacute;n">Sesi&oacute;n 4</a>
</div>
<div class="menuitem">
<a href="sesion05-apuntes.html" title="Seguridad">Sesi&oacute;n 5</a>
</div>
<div class="menuitem">
<a href="sesion06-apuntes.html" title="Transacciones">Sesi&oacute;n 6</a>
</div>
<div class="menuitem">
<a href="sesion07-apuntes.html" title="EJB 3.0">Sesi&oacute;n 7</a>
</div>
<div class="menuitem">
<a href="sesion08-apuntes.html" title="JPA">Sesi&oacute;n 8</a>
</div>
<div class="menuitem">
<a href="roadmap.html" title="Roadmap EJB">Roadmap</a>
</div>
</div>
<div onclick="SwitchMenu('menu_selected_1.1.3', 'skin/')" id="menu_selected_1.1.3Title" class="menutitle" style="background-image: url('skin/images/chapter_open.gif');">Ejercicios</div>
<div id="menu_selected_1.1.3" class="selectedmenuitemgroup" style="display: block;">
<div class="menuitem">
<a href="sesion01-ejercicios.html" title="Introducci&oacute;n a los Enterprise Beans">Sesi&oacute;n 1</a>
</div>
<div class="menuitem">
<a href="sesion02-ejercicios.html" title="Beans de sesi&oacute;n">Sesi&oacute;n 2</a>
</div>
<div class="menuitem">
<a href="sesion03-ejercicios.html" title="Beans de sesi&oacute;n">Sesi&oacute;n 3</a>
</div>
<div class="menuitem">
<a href="sesion04-ejercicios.html" title="Beans de sesi&oacute;n con estado">Sesi&oacute;n 4</a>
</div>
<div class="menupage">
<div class="menupagetitle">Sesi&oacute;n 5</div>
</div>
<div class="menuitem">
<a href="sesion06-ejercicios.html" title="Transacciones">Sesi&oacute;n 6</a>
</div>
<div class="menuitem">
<a href="sesion07-ejercicios.html" title="EJB 3.0">Sesi&oacute;n 7</a>
</div>
<div class="menuitem">
<a href="sesion08-ejercicios.html" title="JPA">Sesi&oacute;n 8</a>
</div>
</div>
</div>
<div id="credit"></div>
<div id="roundbottom">
<img style="display: none" class="corner" height="15" width="15" alt="" src="skin/images/rc-b-l-15-1body-2menu-3menu.png"></div>
<div id="credit2"></div>
</div>
<div id="content">
<div title="Portable Document Format" class="pdflink">
<a class="dida" href="sesion05-ejercicios.pdf"><img alt="PDF -icon" src="skin/images/pdfdoc.gif" class="skin"><br>
        PDF</a>
</div>
<h1>Sesi&oacute;n 5 de ejercicios EJB - Transacciones EJB</h1>
<div id="minitoc-area">
<ul class="minitoc">
<li>
<a href="#Pasos+previos">Pasos previos</a>
</li>
<li>
<a href="#Gesti%C3%B3n+de+transacciones+con+JTA">Gesti&oacute;n de transacciones con JTA</a>
</li>
<li>
<a href="#Gesti%C3%B3n+de+transacciones+declarativas+en+EJB">Gesti&oacute;n de transacciones declarativas en EJB</a>
<ul class="minitoc">
<li>
<a href="#Gesti%C3%B3n+de+la+transacci%C3%B3n+en+un+%C3%BAnico+m%C3%A9todo+del+EJB">Gesti&oacute;n de la transacci&oacute;n en un &uacute;nico m&eacute;todo del EJB</a>
</li>
<li>
<a href="#Propagaci%C3%B3n+de+la+transacci%C3%B3n+del+cliente+al+EJB">Propagaci&oacute;n de la transacci&oacute;n del cliente al EJB</a>
</li>
</ul>
</li>
</ul>
</div>


<a name="N1000C"></a><a name="Pasos+previos"></a>
<h2 class="underlined_10">Pasos previos</h2>
<div class="section">
<p>Para probar la gesti&oacute;n de transacciones en EJB vamos a continuar usuando el entorno de programaci&oacute;n BEA Workshop y el dominio Weblogic "ejb" con el que estamos trabajando. Utilizaremos tambi&eacute;n la aplicaci&oacute;n EAR "ejb-usuarioEAR" desarrollada en el ejercicio anterior. Si no te dio tiempo a terminar el ejercicio, puedes descargarte su soluci&oacute;n de la p&aacute;gina Web.</p>
<p>La aplicaci&oacute;n EAR contiene:</p>
<ul>

<li>El proyecto "ejb-usuario-comun" con el DAO <span class="codefrag">UsuarioDAO</span> que implementa las operaciones:
<ul>

<li>
<span class="codefrag">void addUsuario(UsuarioTO)</span>
</li>

<li>
<span class="codefrag">int delUsuario(String)</span>
</li>

<li>
<span class="codefrag">List&lt;UsuarioTO&gt; getAllUsuarios()</span>
</li>

<li>
<span class="codefrag">UsuarioTO selectUsuario(String)</span>
</li>

<li>
<span class="codefrag">UsuarioTO selectUsuario(String,String)</span>
</li>

<li>
<span class="codefrag">int updateUsuario(UsuarioTO)</span>
</li>

</ul>
</li>

<li>El proyecto EJB "ejb-usuario" con el EJB <span class="codefrag">UsuarioBean</span> que proporciona el acceso remoto al DAO.</li>

</ul>
<p>Adem&aacute;s, en el ejercicio anterior se implement&oacute; el proyecto "ejb-usuario-cliente" que contiene un cliente ejemplo que accede de forma remota al bean.</p>
<p>Vamos a comenzar mejorando dos peque&ntilde;as cuestiones del ejercicio anterior.</p>
<p>En primer lugar, en el proyecto EJB no es correcto definir como <em>static</em> el objeto <span class="codefrag">UsuarioDAO</span>, ya que esto crear&iacute;a un &uacute;nico DAO compartido por todos los posibles clientes del EJB, creando un cuello de botella en el dise&ntilde;o.</p>
<p>Comencemos, pues, por eliminar la declaraci&oacute;n <span class="codefrag">static</span> de los objetos <span class="codefrag">factoriaDAOs</span> y <span class="codefrag">usuarioDAO</span> del EJB <span class="codefrag">UsuarioBean</span>. Su definici&oacute;n quedar&iacute;a como sigue:</p>
<pre class="code">@Session(ejbName = "UsuarioBean")
@JndiName(remote = "UsuarioBean") 
@FileGeneration(remoteClass = Constants.Bool.TRUE, 
                remoteHome = Constants.Bool.TRUE, 
                localClass = Constants.Bool.FALSE, 
                localHome = Constants.Bool.FALSE, 
                remoteClassName = "Usuario", 
                remoteHomeName = "UsuarioHome")
public class UsuarioBean extends GenericSessionBean 
   implements SessionBean {

   private static final long serialVersionUID = 1L;
   <strong>private FactoriaDAOs factoriaDAOs;
   private IUsuarioDAO usuarioDAO;</strong>

   public void ejbCreate() {
       factoriaDAOs = FactoriaDAOs.getInstance();
       usuarioDAO = factoriaDAOs.getUsuarioDAO();
   }
   ...</pre>
<p>En segundo lugar, vamos a modificar el <em>build path</em> del proyecto cliente para evitar tener que copiar el JAR cliente "ejb-usuario-clientjar.jar" cada vez que modificamos el proyecto EJB.</p>
<p>Para ello basta con borrar el fichero "ejb-usuario-clientjar.jar" del proyecto cliente y a&ntilde;adir al <em>build path</em> el fichero mismo fichero JAR del proyecto EJB:</p>
<p>1. Borrar la librer&iacute;a <span class="codefrag">ejb-usuario-clientjar.jar</span> del proyecto <span class="codefrag">ejb-usuario-cliente</span>.</p>
<p>2. Configurar el <em>build path</em> del proyecto y seleccionar en la pesta&ntilde;a "Libraries" la opci&oacute;n "Add JARs...". Seleccionar el fichero "ejb-usuario-clientjar.jar" del proyecto "ejb-usuario".</p>
<p>De esta forma se enlaza directamente con el proyecto cliente el JAR cliente que reside en el proyecto EJB. Recordemos que cada vez que modificamos el proyecto EJB y lo redesplegamos en el servidor se vuelve a generar el fichero JAR cliente.</p>
<p>La configuraci&oacute;n inicial del proyecto queda como muestra la siguiente pantalla:</p>
<p>
<img alt="" content-width="6cm" src="imagenes/ejercicios05/img1.png"></p>
<p>Pon en marcha el servidor de aplicaciones y despliega el EAR.  Inicializa la base de datos con las tareas ant del fichero "build.xml" del proyecto com&uacute;n ("Bot&oacute;n derecho &gt; Run As &gt; Ant Build..." y selecciona los dos targets en el orden "initBD", "dataBD"). Comprueba que todo funciona correctamente ejecutando las pruebas JUnit del proyecto cliente.</p>
</div>


<a name="N10091"></a><a name="Gesti%C3%B3n+de+transacciones+con+JTA"></a>
<h2 class="underlined_10">Gesti&oacute;n de transacciones con JTA</h2>
<div class="section">
<p>En esta primera parte del ejercicio vamos a probar la gesti&oacute;n de transacciones utilizando JTA (Java Transaction API). Recordemos que con JTA es posible demarcar las transacciones fuera del DAO y realizar las llamadas a sus m&eacute;todos en el contexto transaccional definido.</p>
<p>Vamos a realizar la gesti&oacute;n de la transacci&oacute;n en una p&aacute;gina JSP que accede al DAO.</p>
<p>1. Crea un nuevo proyecto Web en el EAR con el nombre "ejb-usuarioWeb".</p>
<p>2. A&ntilde;ade la dependencia entre el proyecto Web y el proyecto com&uacute;n (seleccionar "Bot&oacute;n derecho &gt; Properties &gt; J2EE Module Dependencies" y a&ntilde;adir "ejb-usuario-comun.jar").</p>
<p>3. Crea el siguiente fichero JSP "index.jsp" en el directorio "WebContent"</p>
<pre class="code">&lt;%@ page language="java" contentType="text/html;charset=UTF-8"%&gt;

&lt;html&gt;
    &lt;body&gt;
    JavaServer Page - ${pageContext.request.requestURI}
    &lt;% 
       javax.naming.Context jndiContext = new javax.naming.InitialContext();
       javax.transaction.UserTransaction tx = (javax.transaction.UserTransaction)
          jndiContext.lookup("javax.transaction.UserTransaction");
       es.ua.jtech.proyint.dao.FactoriaDAOs factoria = 
          es.ua.jtech.proyint.dao.FactoriaDAOs.getInstance();
       es.ua.jtech.proyint.dao.usuario.IUsuarioDAO usuario = factoria.getUsuarioDAO();
      
       try {
          tx.begin();    
          // Llamadas al UsuarioDAO
          tx.commit();
    %&gt;
         &lt;p&gt;Transacci&oacute;n terminada con &eacute;xito.&lt;/p&gt; 
    &lt;% } catch (es.ua.jtech.proyint.dao.DAOException e) {
          tx.rollback(); %&gt;
       &lt;p&gt;Fallo en la transacci&oacute;n&lt;/p&gt;
    &lt;%   }%&gt;
    
    &lt;/body&gt;
&lt;/html&gt;</pre>
<p>En el c&oacute;digo abrimos una transacci&oacute;n con la llamada <span class="codefrag">tx.begin()</span>. Dentro del alcance de la transacci&oacute;n hacemos las llamadas al DAO y, si no se ha producido ninguna excepci&oacute;n, se ejecuta el <span class="codefrag">tx.commit()</span>. Si se produce alguna excepci&oacute;n, se captura y se ejecuta la sentencia <span class="codefrag">tx.rollback()</span>, con lo que la BD vuelve al estado previo al comienzo de la transacci&oacute;n.</p>
<p>Para probar el ejemplo, tenemos que a&ntilde;adir algunas llamadas a m&eacute;todos del <span class="codefrag">usuarioDAO</span>, desplegar el EAR, acceder a la p&aacute;gina "http://localhost:7001/ejb-usuarioWeb/" y comprobar con el administrador de la BD sobre la tabla "usuario" que la gesti&oacute;n de la transacci&oacute;n est&aacute; funcionando correctamente. </p>
<p>Podemos comenzar probando que todo funciona correctamente haciendo una b&uacute;squeda:</p>
<pre class="code">    &lt;% 
      ...      
       try {
          tx.begin();    
          es.ua.jtech.proyint.to.UsuarioTO usuarioTO = usuario.selectUsuario("otto");
          tx.commit();
    %&gt;
         &lt;p&gt;Transacci&oacute;n terminada con &eacute;xito.&lt;br/&gt;
         He encontrado al usuario.&lt;/p&gt; 
    &lt;% } catch (es.ua.jtech.proyint.dao.DAOException e) {
          tx.rollback(); %&gt;
       &lt;p&gt;Fallo en la transacci&oacute;n.&lt;/p&gt;
    &lt;%   }%&gt;</pre>
<p>Comprueba que la aplicaci&oacute;n funciona correctamente:</p>
<p>
<img alt="" content-width="8cm" src="imagenes/ejercicios05/img2.png"></p>
<p>Vamos ahora a provocar una excepci&oacute;n. Una posible forma es a&ntilde;adiendo un usuario con un login que ya existe. Por ejemplo, el siguiente c&oacute;digo provoca un fallo en la transacci&oacute;n, ya que a&ntilde;adimos un usuario que ya existe:</p>
<pre class="code">   ...      
   try {
      tx.begin();    
      es.ua.jtech.proyint.to.UsuarioTO usuarioTO = usuario.selectUsuario("otto");
      <strong>usuario.addUsuario(usuarioTO);</strong>
      tx.commit();
   ...</pre>
<p>Despli&eacute;galo y prueba a conectarte a la aplicaci&oacute;n, ver&aacute;s el mensaje provocado por el fallo en la transacci&oacute;n. </p>
<p>Cambia ahora el login y vuelva a probar la aplicaci&oacute;n. Ver&aacute;s que ahora s&iacute; se termina la transacci&oacute;n.</p>
<pre class="code">   ...      
   try {
      tx.begin();    
      es.ua.jtech.proyint.to.UsuarioTO usuarioTO = usuario.selectUsuario("otto");
      <strong>usuarioTO.setlogin("otto2");</strong>
      usuario.addUsuario(usuarioTO);
      tx.commit();
   ...</pre>
<p>Comprueba con el administrador de BD que la tabla se ha modificado:</p>
<p>
<img alt="" content-width="10cm" src="imagenes/ejercicios05/img3.png"></p>
<p>Vamos a probar, por &uacute;ltimo, que realmente se realiza el <em>rollback</em> cuando se produce una excepci&oacute;n. Antes de producir el error a&ntilde;ade un usuario correcto en la base de datos. Comprueba que, aunque se ha producido el error despu&eacute;s de a&ntilde;adir el usuario, la tabla de usuarios no se ha actualizado: </p>
<pre class="code">   ...      
   try {
      tx.begin();    
      es.ua.jtech.proyint.to.UsuarioTO usuarioTO = usuario.selectUsuario("otto");
      <strong>usuarioTO.setlogin("otto3");</strong>
      usuario.addUsuario(usuarioTO);%&gt;
      &lt;p&gt;Usuario a&ntilde;adido.&lt;/p&gt;
  &lt;%  usuario.addUsuario(usuarioTO);
      tx.commit();
   ...</pre>
<p>Si nos conectamos a la p&aacute;gina, veremos el siguiente mensaje:</p>
<p>
<img alt="" content-width="8cm" src="imagenes/ejercicios05/img4.png"></p>
<p>Y si consultamos la tabla, podremos comprobar que el usuario "otto3" no se ha a&ntilde;adido.</p>
</div>


<a name="N10106"></a><a name="Gesti%C3%B3n+de+transacciones+declarativas+en+EJB"></a>
<h2 class="underlined_10">Gesti&oacute;n de transacciones declarativas en EJB</h2>
<div class="section">
<p>Vamos por &uacute;ltimo a comprobar la gesti&oacute;n de transacciones en los EJB. Vamos a realizar las siguientes pruebas:</p>
<ul>

<li>Crear un m&eacute;todo en el EJB que realice una secuencia de llamadas a m&eacute;todos del DAO y comprobar la gesti&oacute;n de la transacci&oacute;n en funci&oacute;n del atributo declarado en el m&eacute;todo.</li>

<li>Crear la transacci&oacute;n en el cliente remoto, llamar a los m&eacute;todos elementales del EJB y comprobar la gesti&oacute;n de la transacci&oacute;n en funci&oacute;n de los atributos.</li>

</ul>
<a name="N10118"></a><a name="Gesti%C3%B3n+de+la+transacci%C3%B3n+en+un+%C3%BAnico+m%C3%A9todo+del+EJB"></a>
<h3 class="underlined_5">Gesti&oacute;n de la transacci&oacute;n en un &uacute;nico m&eacute;todo del EJB</h3>
<p>Creamos el siguiente m&eacute;todo en el EJB "UsuarioBean":</p>
<pre class="code">   @RemoteMethod(transactionAttribute = 
      Constants.TransactionAttribute.REQUIRED)
   public void pruebaTransaccion(String login, Boolean excepcion) {
      try {
         UsuarioTO usuarioTO = new UsuarioTO();
         usuarioTO.setLogin(login);
         usuarioDAO.addUsuario(usuarioTO);
         if (excepcion) usuarioDAO.addUsuario(usuarioTO);
      } catch (DAOException e) {
         e.printStackTrace();
         throw new EJBException();
     }
   }</pre>
<p>Lo probamos con el siguiente programa en el paquete <span class="codefrag">es.ua.jtech.ejb.clientes</span> del proyecto cliente:</p>
<pre class="code">...

public class ClienteTransaccion {

   public static void main(String[] args) {
         try {
            Context jndiContext = getInitialContext();
            Object obj = jndiContext.lookup("UsuarioBean");
            UsuarioHome home = 
                  (UsuarioHome) narrow(obj, UsuarioHome.class);
            obj = home.create();
            Usuario usuario = (Usuario) narrow(obj, Usuario.class);
            
            System.out.print("Introduce el login de un nuevo " +
                "usuario (no debe existir en la BD): ");
            BufferedReader in = new 
                BufferedReader(new InputStreamReader(System.in));
            String login = in.readLine();
            System.out.print("Quieres provocar una excepci&oacute;n (si/no)?: ");
            in = new BufferedReader(new InputStreamReader(System.in));
            String respuesta = in.readLine();
            Boolean excepcion = false;
            if (respuesta.equals("si")) excepcion = true;
            <strong>usuario.pruebaTransaccion(login, excepcion);</strong>
            System.out.println("M&eacute;todo llamado con &eacute;xito");
         } catch (Exception e) {
            System.out.println("Excepci&oacute;n \n Mensaje: " 
                  + e.getMessage());
         } 
   }
   ... </pre>
<p>Lanza el administrador de BD, consulta los usuarios de la BD y ejecuta la aplicaci&oacute;n. Podr&aacute;s comprobar que funciona correctamente la gesti&oacute;n de la transacci&oacute;n.</p>
<p>Prueba a quitar el atributo de transacci&oacute;n del m&eacute;todo en el EJB (o a declararlo con un atributo de "NEVER"). Podr&aacute;s comprobar que en este caso no se recupera la transacci&oacute;n y se a&ntilde;ade el nuevo usuario en la tabla.</p>
<a name="N10139"></a><a name="Propagaci%C3%B3n+de+la+transacci%C3%B3n+del+cliente+al+EJB"></a>
<h3 class="underlined_5">Propagaci&oacute;n de la transacci&oacute;n del cliente al EJB</h3>
<p>Vamos a terminar probando el atributo transaccional "REQUIRES_NEW". Recordemos que con este atributo un m&eacute;todo crea un nuevo contexto transaccional dentro del contexto del llamador. Si el m&eacute;todo termina con &eacute;xito, la transacci&oacute;n se confirma, independientemente de si la transacci&oacute;n del llamador termina o no con &eacute;xito. </p>
<p>Para probarlo, abrimos una transacci&oacute;n en el cliente que llama al EJB, llamamos al m&eacute;todo del EJB y hacemos en el cliente que la   transacci&oacute;n se aborte.</p>
<p>Si el atributo transaccional del m&eacute;todo llamado es "REQUIRED", el <em>rollback</em> de la transacci&oacute;n en el cliente afectar&aacute; tambi&eacute;n al m&eacute;todo del EJB, aunque &eacute;ste haya terminado. Sin embargo, si el atributo es "REQUIRES_NEW" el <em>rollback</em> en el cliente no afectar&aacute; al EJB, porque &eacute;ste habr&aacute; realizado su m&eacute;todo en una nueva transacci&oacute;n terminada con &eacute;xito. Por &uacute;ltimo, si el atributo del m&eacute;todo llamado es "REQUIRES_NEW" y la transacci&oacute;n del EJB falla, este fallo tambi&eacute;n afecta a la transacci&oacute;n del llamador. En concreto, vamos a usar el m&eacute;todo <span class="codefrag">addUsuario(UsuarioTO)</span> y un programa cliente nuevo.</p>
<p>1. Empecemos por a&ntilde;adir en el EJB un m&eacute;todo <span class="codefrag">addUsuario(String</span> con un atributo transaccional de "REQUIRED" y hagamos que lance una excepci&oacute;n si falla (cuando se a&ntilde;ade un usuario que ya existe):</p>
<pre class="code">   @RemoteMethod(transactionAttribute = Constants.TransactionAttribute.REQUIRED)
   public void addUsuario(String login) {
      try {
         UsuarioTO usuarioTO = new UsuarioTO();
         usuarioTO.setLogin(login);
         usuarioDAO.addUsuario(usuarioTO);
      } catch (DAOException e) {
         e.printStackTrace();
         throw new EJBException();
      }
   }</pre>
<p>2. Escribimos ahora un nuevo cliente remoto, basado en el cliente anterior:</p>
<pre class="code">...
public class ClienteTransaccion2 {

  public static void main(String[] args) {
    <strong>UserTransaction tx = null;</strong>

      try {
         Context jndiContext = getInitialContext();
         Object obj = jndiContext.lookup("UsuarioBean");
         UsuarioHome home = (UsuarioHome) 
             narrow(obj, UsuarioHome.class);
         obj = home.create();
         Usuario usuario = (Usuario) narrow(obj, Usuario.class);
            
         System.out.println(
             "Probando las transacciones abiertas en el cliente...");
         System.out.print(
             "Introduce el login de un nuevo usuario " + 
             "(no debe existir en la BD): ");
         BufferedReader in = 
           new BufferedReader(new InputStreamReader(System.in));
         String login = in.readLine();
         System.out.print(
            "Quieres provocar una excepci&oacute;n (si/no)?: ");
         in = new BufferedReader(new InputStreamReader(System.in));
         String respuesta = in.readLine();
         Boolean excepcion = false;
         if (respuesta.equals("si")) excepcion = true;

         <strong>tx = (javax.transaction.UserTransaction)
            jndiContext.lookup("javax.transaction.UserTransaction");
         tx.begin();
         usuario.addUsuario(login);
         if (excepcion)
           usuario.addUsuario(login);
         tx.commit();</strong>
         System.out.println("M&eacute;todo llamado con &eacute;xito");
      } catch (Exception e) {
         System.out.println("Excepci&oacute;n \n Mensaje: " 
               + e.getMessage());
         try {
            <strong>tx.rollback();</strong>
         } catch (Exception e1) {
            e1.printStackTrace();
         }
      } 
   }
   ...</pre>
<p>Podemos ver que primero se hace una llamada a <span class="codefrag">addUsuario</span> y despu&eacute;s (cuando &eacute;sta ya ha terminado) se provoca una excepci&oacute;n volviendo a llamar la m&eacute;todo, ahora con un usuario ya existente. Estas dos llamadas se hacen dentro de una transacci&oacute;n creada en el cliente con un objeto <span class="codefrag">UserTransaction</span> proporcionado por el servidor de aplicaciones.</p>
<p>3. A&ntilde;adimos un usuario nuevo y forzamos una excepci&oacute;n. Comprobamos que el usuario no se ha a&ntilde;adido en la BD porque el atributo transaccional del m&eacute;todo es "REQUIRED" y se hereda la transacci&oacute;n del llamador.</p>
<p>4. Cambiamos el atributo transaccional del m&eacute;todo del EJB a "REQUIRES_NEW". Volvemos a a&ntilde;adir un usuario nuevo y a forzar la excepci&oacute;n. Comprobamos que el usuario se ha a&ntilde;adido en la tabla.</p>
</div>


<p class="pageBreakAfter"></p>


</div>
<div class="clearboth">&nbsp;</div>
</div>
<div id="footer">
<div class="lastmodified">
<script type="text/javascript"><!--
document.write("<text>Last Published:</text> " + document.lastModified);
//  --></script>
</div>
<div class="copyright">
        Copyright &copy;
         2006-2007 Depto. CCIA</div>
</div>
</body>
</html>
