<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta content="Apache Forrest" name="Generator">
<meta name="Forrest-version" content="0.7">
<meta name="Forrest-skin-name" content="pelt">
<title>Sesi&oacute;n 6 de ejercicios EJB - Seguridad en EJB</title>
<link type="text/css" href="skin/basic.css" rel="stylesheet">
<link media="screen" type="text/css" href="skin/screen.css" rel="stylesheet">
<link media="print" type="text/css" href="skin/print.css" rel="stylesheet">
<link type="text/css" href="skin/profile.css" rel="stylesheet">
<script src="skin/getBlank.js" language="javascript" type="text/javascript"></script><script src="skin/getMenu.js" language="javascript" type="text/javascript"></script><script src="skin/fontsize.js" language="javascript" type="text/javascript"></script>
<link rel="shortcut icon" href="">
</head>
<body onload="init()">
<script type="text/javascript">ndeSetTextSize();</script>
<div id="top">
<div class="header">
<div class="grouplogo">
<a href="http://www.jtech.ua.es/j2ee"><img class="logoImage" alt="J2EE" src="images/baner_j2ee_izq.gif" title="Curso Especialista Universitario J2EE"></a>
</div>
<div class="projectlogoA1">
<a href="http://www.dccia.ua.es/"><img class="logoImage" alt="Componentes EJB" src="images/baner_j2ee_der.gif" title="Componentes EJB"></a>
</div>
<ul id="tabs">
<li>
<a class="base-not-selected" href="../index.html">M&oacute;dulos</a>
</li>
<li class="current">
<a class="base-selected" href="index.html">Componentes EJB</a>
</li>
</ul>
</div>
</div>
<div id="main">
<div id="publishedStrip">
<div id="level2tabs"></div>
<script type="text/javascript"><!--
document.write("<text>Last Published:</text> " + document.lastModified);
//  --></script>
</div>
<div class="breadtrail">
             
             &nbsp;
           </div>
<div id="menu">
<div onclick="SwitchMenu('menu_selected_1.1', 'skin/')" id="menu_selected_1.1Title" class="menutitle" style="background-image: url('skin/images/chapter_open.gif');">Materiales</div>
<div id="menu_selected_1.1" class="selectedmenuitemgroup" style="display: block;">
<div class="menuitem">
<a href="index.html" title="Componentes EJB">&Iacute;ndice</a>
</div>
<div onclick="SwitchMenu('menu_1.1.2', 'skin/')" id="menu_1.1.2Title" class="menutitle">Teor&iacute;a</div>
<div id="menu_1.1.2" class="menuitemgroup">
<div class="menuitem">
<a href="sesion01-apuntes.html" title="Introducci&oacute;n a los Enterprise Beans">Sesi&oacute;n 1</a>
</div>
<div class="menuitem">
<a href="sesion02-apuntes.html" title="Beans de sesi&oacute;n">Sesi&oacute;n 2</a>
</div>
<div class="menuitem">
<a href="sesion03-apuntes.html" title="Beans de sesi&oacute;n">Sesi&oacute;n 3</a>
</div>
<div class="menuitem">
<a href="sesion04-apuntes.html" title="Beans de sesi&oacute;n">Sesi&oacute;n 4</a>
</div>
<div class="menuitem">
<a href="sesion05-apuntes.html" title="Seguridad">Sesi&oacute;n 5</a>
</div>
<div class="menuitem">
<a href="sesion06-apuntes.html" title="Transacciones">Sesi&oacute;n 6</a>
</div>
<div class="menuitem">
<a href="sesion07-apuntes.html" title="EJB 3.0">Sesi&oacute;n 7</a>
</div>
<div class="menuitem">
<a href="sesion08-apuntes.html" title="JPA">Sesi&oacute;n 8</a>
</div>
<div class="menuitem">
<a href="roadmap.html" title="Roadmap EJB">Roadmap</a>
</div>
</div>
<div onclick="SwitchMenu('menu_selected_1.1.3', 'skin/')" id="menu_selected_1.1.3Title" class="menutitle" style="background-image: url('skin/images/chapter_open.gif');">Ejercicios</div>
<div id="menu_selected_1.1.3" class="selectedmenuitemgroup" style="display: block;">
<div class="menuitem">
<a href="sesion01-ejercicios.html" title="Introducci&oacute;n a los Enterprise Beans">Sesi&oacute;n 1</a>
</div>
<div class="menuitem">
<a href="sesion02-ejercicios.html" title="Beans de sesi&oacute;n">Sesi&oacute;n 2</a>
</div>
<div class="menuitem">
<a href="sesion03-ejercicios.html" title="Beans de sesi&oacute;n">Sesi&oacute;n 3</a>
</div>
<div class="menuitem">
<a href="sesion04-ejercicios.html" title="Beans de sesi&oacute;n con estado">Sesi&oacute;n 4</a>
</div>
<div class="menuitem">
<a href="sesion05-ejercicios.html" title="Seguridad">Sesi&oacute;n 5</a>
</div>
<div class="menupage">
<div class="menupagetitle">Sesi&oacute;n 6</div>
</div>
<div class="menuitem">
<a href="sesion07-ejercicios.html" title="EJB 3.0">Sesi&oacute;n 7</a>
</div>
<div class="menuitem">
<a href="sesion08-ejercicios.html" title="JPA">Sesi&oacute;n 8</a>
</div>
</div>
</div>
<div id="credit"></div>
<div id="roundbottom">
<img style="display: none" class="corner" height="15" width="15" alt="" src="skin/images/rc-b-l-15-1body-2menu-3menu.png"></div>
<div id="credit2"></div>
</div>
<div id="content">
<div title="Portable Document Format" class="pdflink">
<a class="dida" href="sesion06-ejercicios.pdf"><img alt="PDF -icon" src="skin/images/pdfdoc.gif" class="skin"><br>
        PDF</a>
</div>
<h1>Sesi&oacute;n 6 de ejercicios EJB - Seguridad en EJB</h1>
<div id="minitoc-area">
<ul class="minitoc">
<li>
<a href="#Modificaci%C3%B3n+del+EJB+UsuarioBean">Modificaci&oacute;n del EJB UsuarioBean</a>
</li>
<li>
<a href="#Comprobaci%C3%B3n+de+la+seguridad">Comprobaci&oacute;n de la seguridad</a>
</li>
<li>
<a href="#Creaci%C3%B3n+de+los+usuarios+y+grupos+en+la+consola+de+administraci%C3%B3n">Creaci&oacute;n de los usuarios y grupos en la consola de administraci&oacute;n</a>
</li>
<li>
<a href="#Seguridad+programativa">Seguridad programativa</a>
</li>
<li>
<a href="#Seguridad+en+las+llamadas+locales+desde+aplicaciones+web">Seguridad en las llamadas locales desde aplicaciones web</a>
</li>
</ul>
</div>


<p>En esta sesi&oacute;n vamos a modificar la aplicaci&oacute;n EAR "ejb-usuarioEAR" terminada en la sesi&oacute;n anterior (transacciones) para probar las distintas caracter&iacute;sticas de la gesti&oacute;n de seguridad en EJB.</p>


<p>En concreto, los pasos que vamos a seguir en esta sesi&oacute;n de ejercicios son:</p>


<ul>

<li>Modificar el c&oacute;digo del EJB "UsuarioBean" para a&ntilde;adir una lista de roles permitidos al m&eacute;todo <span class="codefrag">addUsuario(String)</span> y para definir los principals asociados a esos roles.</li>


<li>Probar con un cliente remoto el funcionamiento de los roles: s&oacute;lo ser&aacute; posible ejecutar el m&eacute;todo si el cliente se autentifica como uno de los usuarios asociados a los roles.</li>


<li>Definir en la consola de administraci&oacute;n los usuarios y grupos asociados a los roles definidos en la aplicaci&oacute;n.</li>


<li>Modificar el EJB para probar la gesti&oacute;n programativa de la seguridad.</li>


<li>A&ntilde;adir una aplicaci&oacute;n Web con una p&aacute;gina JSP en la que se compruebe que el acceso al m&eacute;todo tambi&eacute;n est&aacute; restringido en el caso del acceso local. Autentifcarse en la p&aacute;gina JSP y conseguir realizar la llamada al m&eacute;todo.</li>

</ul>


<a name="N10027"></a><a name="Modificaci%C3%B3n+del+EJB+UsuarioBean"></a>
<h2 class="underlined_10">Modificaci&oacute;n del EJB UsuarioBean</h2>
<div class="section">
<p>1. Modifica en el proyecto EJB el m&eacute;todo <span class="codefrag">addUsuario(String)</span> de la clase <span class="codefrag">UsuarioBean</span> para incluir la declaraci&oacute;n de roles en la anotaci&oacute;n <span class="codefrag">@RemoteMethod</span>.</p>
<pre class="code">   @RemoteMethod(
         roles = "admin, bibliotecario")
   public void addUsuario(String login) {
      try {
         UsuarioTO usuarioTO = new UsuarioTO();
         usuarioTO.setLogin(login);
         usuarioDAO.addUsuario(usuarioTO);
      } catch (DAOException e) {
         e.printStackTrace();
         throw new EJBException();
      }
   }</pre>
<p>2. A&ntilde;ade la anotaci&oacute;n <span class="codefrag">@RoleMappings</span> en la declaraci&oacute;n de la clase, para definir los <em>principals</em> asociados a los roles: el usuario "admin" asociado al rol "administrador" y los usuarios "dgl", "admin" y el grupo "Bibliotecarios" asociados al rol "bibliotecario".</p>
<pre class="code">@RoleMappings(
      {@RoleMapping(principals = "admin", roleName = "administrador"),
       @RoleMapping(principals = "dgl, admin, Bibliotecarios",
                    roleName = "bibliotecario")})
public class UsuarioBean extends GenericSessionBean implements SessionBean {
   ...
</pre>
<p>3. Despliega el proyecto "ejb-usuarioEAR" en el servidor de aplicaciones (dominio "ejb").</p>
</div>


<a name="N1004E"></a><a name="Comprobaci%C3%B3n+de+la+seguridad"></a>
<h2 class="underlined_10">Comprobaci&oacute;n de la seguridad</h2>
<div class="section">
<p>Vamos a probar con un cliente remoto el funcionamiento de los roles: s&oacute;lo ser&aacute; posible ejecutar el m&eacute;todo si el cliente se autentifica como uno de los usuarios asociados a los roles.</p>
<p>Para autentificarse como un usuario en el cliente remoto vamos a usar autentificaci&oacute;n mediante JNDI, pasando el login y contrase&ntilde;a al servidor de aplicaciones mediante el <span class="codefrag">InitialContext</span>. Utiliza como login y contrase&ntilde;a inicial el de administraci&oacute;n del servidor de aplicaciones. El c&oacute;digo del cliente es el siguiente:</p>
<pre class="code">package es.ua.jtech.ejb.clientes;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.util.Properties;

import javax.naming.Context;
import javax.naming.InitialContext;
import javax.rmi.PortableRemoteObject;

import es.ua.jtech.ejb.beans.Usuario;
import es.ua.jtech.ejb.beans.UsuarioHome;

public class ClienteSeguridad {
   public static void main(String[] args) {
      try {
         Context jndiContext = getInitialContext();
         Object obj = jndiContext.lookup("UsuarioBean");
         UsuarioHome home = (UsuarioHome) narrow(
            obj, UsuarioHome.class);
         obj = home.create();
         Usuario usuario = (Usuario) narrow(obj, Usuario.class);
         
         System.out.println("Probando la seguridad...");
         System.out.print("Introduce el login de un nuevo usuario " 
               + "(no debe existir en la BD): ");
         BufferedReader in = new BufferedReader(
            new InputStreamReader(System.in));
         String login = in.readLine();
         usuario.addUsuario(login);
         System.out.println("M&eacute;todo llamado con &eacute;xito");
      } catch (Exception e) {
         System.out.println("Excepci&oacute;n \n Mensaje: " 
               + e.getMessage());
         e.printStackTrace();
         } 
   }

   private static Context getInitialContext()
         throws javax.naming.NamingException, IOException {
      Properties p = new Properties();
      p.put(Context.INITIAL_CONTEXT_FACTORY,
            "weblogic.jndi.WLInitialContextFactory");
      p.put(Context.PROVIDER_URL, "t3://localhost:7001");
      <strong>p.put(Context.SECURITY_PRINCIPAL, "weblogic");
      p.put(Context.SECURITY_CREDENTIALS, "weblogic");</strong>
      return new InitialContext(p);
   }

   private static Object narrow(Object obj, Class clase) {
      return PortableRemoteObject.narrow(obj, clase);
   }
}</pre>
<p>1. Crea el cliente en el proyecto cliente (paquete <span class="codefrag">es.ua.jtech.ejb.clientes</span>)</p>
<p>2. Ejec&uacute;talo y ver&aacute;s que aparece una excepci&oacute;n de tipo "CORBA NO_PERMISSION", debido a que el usuario "weblogic" no est&aacute; autorizado a acceder al m&eacute;todo.</p>
</div>



<a name="N1006E"></a><a name="Creaci%C3%B3n+de+los+usuarios+y+grupos+en+la+consola+de+administraci%C3%B3n"></a>
<h2 class="underlined_10">Creaci&oacute;n de los usuarios y grupos en la consola de administraci&oacute;n</h2>
<div class="section">
<p>1. Accede a la consola de administracion del dominio "ejb" y escoge la opci&oacute;n "Security Realms &gt; myrealm".</p>
<p>2. Escoge la pesta&ntilde;a "Users and Groups" y pincha en el bot&oacute;n "New"  para a&ntilde;adir nuevos usuarios. A&ntilde;ade, los usuarios "dgl" y "admin" con la contrase&ntilde;a "12345678". Al final debe aparecer una pantalla como la siguiente. La descripci&oacute;n no es relevante, s&oacute;lo es informativa.</p>
<p>
<img alt="" content-width="9cm" src="imagenes/ejercicios06/img1.png"></p>
</div>


<p>3. Cambia en el c&oacute;digo del cliente el nombre del usuario por el de "admin" y la contrase&ntilde;a por "12345678":</p>


<pre class="code">      p.put(Context.SECURITY_PRINCIPAL, "admin");
      p.put(Context.SECURITY_CREDENTIALS, "12345678");</pre>


<p> Prueba a ejecutarlo y comprueba que ahora s&iacute; fuciona, porque se accede al m&eacute;todo del EJB con un <em>principal</em> asociado a un rol autorizado para el m&eacute;todo <span class="codefrag">addUsuario</span>.</p>


<p>4. Vamos a probar ahora con algo que proprociona m&aacute;s flexibilidad. En el c&oacute;digo del EJB hemos autorizado el acceso al <em>principal</em> "Bibliotecarios", que vamos a definir en el servidor de aplicaciones como un grupo, en lugar de como un usuario. De esta forma estaremos autorizando el acceso al EJB a cualquier usuario que pertenezca a ese grupo.</p>


<p>Este enfoque es m&aacute;s flexible porque nos permite a&ntilde;adir usuarios autorizados utilizando &uacute;nicamente el servidor de aplicaciones, sin tocar el c&oacute;digo ni los descriptores de despliegue del EAR.</p>


<p>Escoge la opci&oacute;n "Groups" en la pesta&ntilde;a "Users and Groups" del <em>security realm</em> "myrealm" (pantalla anterior). A&ntilde;ade un nuevo grupo "Bibliotecarios".</p>


<p>Crea ahora un nuevo usuario "rmc" con la contrase&ntilde;a "12345678". Pincha en el usuario, luego en la pesta&ntilde;a "Groups" y selecciona el grupo "Bibliotecarios": </p>


<p>
<img alt="" content-width="7cm" src="imagenes/ejercicios06/img2.png"></p>


<p>5. Cambia ahora el usuario en la aplicaci&oacute;n cliente y prueba a ejecutarla. Ver&aacute;s que tambi&eacute;n tienes acceso, ya que el usuario "rmc" pertenece al grupo "Bibliotecarios" y posee ese <em>principal</em>.</p>


<a name="N100AF"></a><a name="Seguridad+programativa"></a>
<h2 class="underlined_10">Seguridad programativa</h2>
<div class="section">
<p>1. A&ntilde;ade el siguiente c&oacute;digo en el EJB para comprobar seguridad programativa.</p>
<pre class="code">public class UsuarioBean extends GenericSessionBean
   implements SessionBean {
<strong>   SessionContext ctx = null;</strong>

   ...
  
   <strong>public void setSessionContext(SessionContext ctx) {
      this.ctx = ctx;
   }</strong>
   ...
   public void addUsuario(String login) {
      <strong>System.out.println(<strong>ctx.getCallerPrincipal().getName()</strong>);
      if (<strong>ctx.isCallerInRole("administrador")</strong>) {
         //c&oacute;digo ejecutado por administradores
         System.out.println("Me llama un administrador");
      }
      if (<strong>ctx.isCallerInRole("bibliotecario")</strong>){
         //c&oacute;digo ejecutado por bibliotecarios
         System.out.println("Me llama un bibliotecario");
      }</strong>
      ...
   }
   ...</pre>
<p>En la primera parte del c&oacute;digo declaramos el m&eacute;todo de ciclo de vida <span class="codefrag">setSessionContext</span> que es llamado por el contenedor EJB y actualiza la variable de instancia <span class="codefrag">SessionContext ctx</span>. En la segunda parte, modificamos el m&eacute;todo <span class="codefrag">addUsuario</span> para que se imprima por la salida est&aacute;ndar (la consola del servidor de aplicaciones) el nombre del <em>principal</em> del llamador y comprobamos si tiene el rol "administrador" y el rol "bibliotecario".</p>
<p>6. Prueba a ejecutar el cliente remoto con distintos usuarios y comprueba lo que aparece por la salida est&aacute;ndar. Si accedes, por ejemplo, con el usuario "admin" debe aparecer que tiene dos roles: "administrador" y "bibliotecario".</p>
</div>


<a name="N100E1"></a><a name="Seguridad+en+las+llamadas+locales+desde+aplicaciones+web"></a>
<h2 class="underlined_10">Seguridad en las llamadas locales desde aplicaciones web</h2>
<div class="section">
<p>Vamos a terminar modificando la p&aacute;gina "index.jsp" del proyecto web que creamos en la sesi&oacute;n anterior para que se haga una llamada al EJB y se compruebe que tambi&eacute;n se controla el acceso en las peticiones locales.</p>
<p>1. A&ntilde;ade al m&eacute;todo <span class="codefrag">addUsuario()</span>la anotaci&oacute;n:</p>
<pre class="code">@LocalMethod(roles="administrador, bibliotecario")</pre>
<p>Modifica tambi&eacute;n las anotaciones <span class="codefrag">@JndiName</span> y <span class="codefrag">@FileGeneration</span> para definir el nombre JNDI local y las interfaces local y localhome:</p>
<pre class="code">@JndiName(remote = "UsuarioBean",
          local = "UsuarioBeanLocal")
@FileGeneration(remoteClass = Constants.Bool.TRUE, 
                remoteHome = Constants.Bool.TRUE, 
                localClass = Constants.Bool.TRUE, 
                localHome = Constants.Bool.TRUE, 
                remoteClassName = "Usuario", 
                remoteHomeName = "UsuarioHome", 
                localClassName = "UsuarioLocal", 
                localHomeName = "UsuarioLocalHome")</pre>
<p>De esta forma es posible llamar al m&eacute;todo de forma local desde una p&aacute;gina JSP en una aplicaci&oacute;n Web desplegada en el mismo EAR.</p>
<p>2. A&ntilde;ade el proyecto "ejb-usuario" en las "J2EE Module Dependencies" del proyecto web ("Bot&oacute;n derecho en el proyecto web &gt; Properties &gt; J2EE Module Dependencies" y pincha en la pesta&ntilde;a "J2EE Modules"). Debe aparecer la siguiente figura:</p>
<p>
<img alt="" content-width="7cm" src="imagenes/ejercicios06/img3.png"></p>
<p>3. Modifica la p&aacute;gina "index.jsp" del proyecto "ejb-usuarioWeb" para que se realice una llamada sin autentificarse al enterprise bean:</p>
<pre class="code">&lt;%@ page language="java" contentType="text/html;charset=UTF-8"%&gt;

&lt;html&gt;
    &lt;body&gt;
    JavaServer Page - ${pageContext.request.requestURI}
    &lt;% 
       javax.naming.Context jndiContext = 
          new javax.naming.InitialContext();
       es.ua.jtech.ejb.beans.UsuarioLocalHome home =
         (es.ua.jtech.ejb.beans.UsuarioLocalHome) 
               jndiContext.lookup("UsuarioBeanLocal");
       es.ua.jtech.ejb.beans.UsuarioLocal usuario = home.create();
       usuario.addUsuario("pdasdwds");%&gt;

    &lt;p&gt;Usuario a&ntilde;adido&lt;/p&gt;           
    &lt;/body&gt;
&lt;/html&gt;</pre>
<p>4. Accede a la p&aacute;gina "http://localhost:7001/ejb-usuarioWeb" y ver&aacute;s como se produce un error de tipo <span class="codefrag">javax.ejb.AccessLocalException</span> que indica que el usuario "anonymous" no tiene permisos suficientes para acceder al m&eacute;todo del EJB.</p>
<p>5. Modifica el c&oacute;digo de la p&aacute;gina JSP para realizar la autentificaci&oacute;n mediante JNDI:</p>
<pre class="code">    ...
    JavaServer Page - ${pageContext.request.requestURI}
    &lt;%
       <strong>weblogic.jndi.Environment env = 
            new weblogic.jndi.Environment();
       env.setSecurityPrincipal("dgl");
       env.setSecurityCredentials("12345678");
       javax.naming.Context jndiContext = env.getInitialContext()</strong>
       es.ua.jtech.ejb.beans.UsuarioLocalHome home =
         (es.ua.jtech.ejb.beans.UsuarioLocalHome) 
               jndiContext.lookup("UsuarioBeanLocal");
       ...</pre>
<p>6. Vuelve a acceder a la URL de la aplicaci&oacute;n Web y comprueba que ahora s&iacute; que se ejecuta el m&eacute;todo del EJB.</p>
</div>


<p class="pageBreakAfter"></p>

</div>
<div class="clearboth">&nbsp;</div>
</div>
<div id="footer">
<div class="lastmodified">
<script type="text/javascript"><!--
document.write("<text>Last Published:</text> " + document.lastModified);
//  --></script>
</div>
<div class="copyright">
        Copyright &copy;
         2006-2007 Depto. CCIA</div>
</div>
</body>
</html>
