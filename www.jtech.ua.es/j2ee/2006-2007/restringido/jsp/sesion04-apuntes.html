<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta content="Apache Forrest" name="Generator">
<meta name="Forrest-version" content="0.7">
<meta name="Forrest-skin-name" content="pelt">
<title>Manejo de Cookies y de Sesiones</title>
<link type="text/css" href="skin/basic.css" rel="stylesheet">
<link media="screen" type="text/css" href="skin/screen.css" rel="stylesheet">
<link media="print" type="text/css" href="skin/print.css" rel="stylesheet">
<link type="text/css" href="skin/profile.css" rel="stylesheet">
<script src="skin/getBlank.js" language="javascript" type="text/javascript"></script><script src="skin/getMenu.js" language="javascript" type="text/javascript"></script><script src="skin/fontsize.js" language="javascript" type="text/javascript"></script>
<link rel="shortcut icon" href="">
</head>
<body onload="init()">
<script type="text/javascript">ndeSetTextSize();</script>
<div id="top">
<div class="header">
<div class="grouplogo">
<a href="http://www.jtech.ua.es/j2ee"><img class="logoImage" alt="J2EE" src="images/baner_j2ee_izq.gif" title="Curso Especialista Universitario J2EE"></a>
</div>
<div class="projectlogoA1">
<a href="http://www.dccia.ua.es/"><img class="logoImage" alt="Servlets y JSP" src="images/baner_j2ee_der.gif" title="Servlets y JSP"></a>
</div>
<ul id="tabs">
<li>
<a class="base-not-selected" href="../index.html">M&oacute;dulos</a>
</li>
<li class="current">
<a class="base-selected" href="index.html">Servlets y JSP</a>
</li>
</ul>
</div>
</div>
<div id="main">
<div id="publishedStrip">
<div id="level2tabs"></div>
<script type="text/javascript"><!--
document.write("<text>Last Published:</text> " + document.lastModified);
//  --></script>
</div>
<div class="breadtrail">
             
             &nbsp;
           </div>
<div id="menu">
<div onclick="SwitchMenu('menu_selected_1.1', 'skin/')" id="menu_selected_1.1Title" class="menutitle" style="background-image: url('skin/images/chapter_open.gif');">Servlets y JSP</div>
<div id="menu_selected_1.1" class="selectedmenuitemgroup" style="display: block;">
<div class="menuitem">
<a href="index.html" title="Servlets y JSP">&Iacute;ndice</a>
</div>
<div onclick="SwitchMenu('menu_selected_1.1.2', 'skin/')" id="menu_selected_1.1.2Title" class="menutitle" style="background-image: url('skin/images/chapter_open.gif');">Teor&iacute;a</div>
<div id="menu_selected_1.1.2" class="selectedmenuitemgroup" style="display: block;">
<div class="menuitem">
<a href="sesion01-apuntes.html">Sesion 1</a>
</div>
<div class="menuitem">
<a href="sesion02-apuntes.html">Sesion 2</a>
</div>
<div class="menuitem">
<a href="sesion03-apuntes.html">Sesion 3</a>
</div>
<div class="menupage">
<div class="menupagetitle">Sesion 4</div>
</div>
<div class="menuitem">
<a href="sesion05-apuntes.html">Sesion 5</a>
</div>
<div class="menuitem">
<a href="sesion06-apuntes.html">Sesion 6</a>
</div>
<div class="menuitem">
<a href="sesion07-apuntes.html">Sesion 7</a>
</div>
<div class="menuitem">
<a href="sesion08-apuntes.html">Sesion 8</a>
</div>
<div class="menuitem">
<a href="sesion09-apuntes.html">Sesion 9</a>
</div>
<div class="menuitem">
<a href="sesion10-apuntes.html">Sesion 10</a>
</div>
<div class="menuitem">
<a href="sesion11-apuntes.html">Sesion 11</a>
</div>
<div class="menuitem">
<a href="sesion12-apuntes.html">Sesion 12</a>
</div>
<div class="menuitem">
<a href="roadmap-apuntes.html">Roadmap</a>
</div>
</div>
<div onclick="SwitchMenu('menu_1.1.3', 'skin/')" id="menu_1.1.3Title" class="menutitle">Ejercicios</div>
<div id="menu_1.1.3" class="menuitemgroup">
<div class="menuitem">
<a href="sesion01-ejercicios.html">Sesion 1</a>
</div>
<div class="menuitem">
<a href="sesion02-ejercicios.html">Sesion 2</a>
</div>
<div class="menuitem">
<a href="sesion03-ejercicios.html">Sesion 3</a>
</div>
<div class="menuitem">
<a href="sesion04-ejercicios.html">Sesion 4</a>
</div>
<div class="menuitem">
<a href="sesion05-ejercicios.html">Sesion 5</a>
</div>
<div class="menuitem">
<a href="sesion06-ejercicios.html">Sesion 6</a>
</div>
<div class="menuitem">
<a href="sesion07-ejercicios.html">Sesion 7</a>
</div>
<div class="menuitem">
<a href="sesion08-ejercicios.html">Sesion 8</a>
</div>
<div class="menuitem">
<a href="sesion09-ejercicios.html">Sesion 9</a>
</div>
<div class="menuitem">
<a href="sesion10-ejercicios.html">Sesion 10</a>
</div>
<div class="menuitem">
<a href="sesion11-ejercicios.html">Sesion 11</a>
</div>
<div class="menuitem">
<a href="sesion12-ejercicios.html">Sesion 12</a>
</div>
</div>
</div>
<div id="credit"></div>
<div id="roundbottom">
<img style="display: none" class="corner" height="15" width="15" alt="" src="skin/images/rc-b-l-15-1body-2menu-3menu.png"></div>
<div id="credit2"></div>
</div>
<div id="content">
<div title="Portable Document Format" class="pdflink">
<a class="dida" href="sesion04-apuntes.pdf"><img alt="PDF -icon" src="skin/images/pdfdoc.gif" class="skin"><br>
        PDF</a>
</div>
<h1>Manejo de Cookies y de Sesiones</h1>
<div id="minitoc-area">
<ul class="minitoc">
<li>
<a href="#Cookies">Cookies</a>
<ul class="minitoc">
<li>
<a href="#Enviar+una+cookie">Enviar una cookie</a>
</li>
<li>
<a href="#Obtener+una+cookie">Obtener una cookie</a>
</li>
<li>
<a href="#Ejemplo">Ejemplo</a>
</li>
</ul>
</li>
<li>
<a href="#Seguimiento+de+sesiones">Seguimiento de sesiones</a>
<ul class="minitoc">
<li>
<a href="#Obtener+una+sesi%C3%B3n">Obtener una sesi&oacute;n</a>
</li>
<li>
<a href="#Guardar+y+obtener+datos+de+la+sesi%C3%B3n">Guardar y obtener datos de la sesi&oacute;n</a>
</li>
<li>
<a href="#Invalidar+la+sesi%C3%B3n">Invalidar la sesi&oacute;n</a>
</li>
<li>
<a href="#Compatibilidad+con+los+navegadores">Compatibilidad con los navegadores</a>
</li>
<li>
<a href="#Oyentes">Oyentes</a>
</li>
<li>
<a href="#Ejemplos">Ejemplos</a>
</li>
</ul>
</li>
</ul>
</div>

<p>Veremos en este tema aspectos sobre el seguimiento de las acciones de los usuarios sobre un sitio web. Para ello veremos c&oacute;mo trabajar con cookies en los servlets, y c&oacute;mo manejar informaci&oacute;n sobre las sesiones de los usuarios.</p>

<a name="N1000F"></a><a name="Cookies"></a>
<h2 class="underlined_10">Cookies</h2>
<div class="section">
<p>Una <strong>cookie</strong> es un objeto de tipo <span class="codefrag">nombre = valor</span> donde se asigna un <span class="codefrag">valor</span> determinado (una cadena de texto) a una variable del <span class="codefrag">nombre</span>  indicado. Dicho objeto es almacenado y recordado por el servidor web y el navegador durante un per&iacute;odo de tiempo (indicado como un par&aacute;metro interno de la propia <span class="codefrag">cookie</span>). As&iacute;, se puede tener una lista de <span class="codefrag">cookies</span> con distintas variables y distintos valores, para almacenar informaci&oacute;n relevante para cada usuario (se tienen listas de cookies independientes para cada usuario).</p>
<p>En Javascript, por ejemplo, el objeto <span class="codefrag"> document.cookie</span> contiene como valor una lista de la forma:</p>
<p>
<span class="codefrag">nombre1=valor1;nombre2=valor2;...;nombreN=valorN</span>
</p>
<p>donde se almacenan as&iacute; los valores de las cookies que se tengan definidas.</p>
<p>Se pueden emplear <span class="codefrag">cookies</span>, entre otras cosas, para:</p>
<ul> 
		
<li>
<strong>Identificar a un usuario durante una o varias sesiones</strong>. Por ejemplo, a la hora de realizar compras a trav&eacute;s de una tienda web, se almacena su identidad (login y password) como una cookie y se recuerda a lo largo de diferentes visitas qu&eacute; es lo que lleva almacenado en su cesta de la compra cada usuario.</li>
		
<li>
<strong>Personalizar un sitio web de acuerdo a las preferencias de cada usuario</strong>: definir el contenido, apariencia, etc, que queremos que tenga una determinada p&aacute;gina en funci&oacute;n de las preferencias del usuario que la est&eacute; visitando.</li>
	
</ul>
<p> Los navegadores que trabajen con cookies pueden soportar hasta 20 cookies por servidor, de al menos 4 KB cada una. Los servlets que se ejecutan en un mismo servidor comparten las cookies.</p>
<p>A la hora de trabajar con cookies, debemos tener en cuenta que nuestro sitio web no debe depender de ellas, puesto que muchos navegadores y usuarios las deshabilitan para evitar problemas de privacidad y otras cuestiones.</p>
<p>Veremos ahora c&oacute;mo trabajar con cookies desde servlets.</p>
<a name="N10053"></a><a name="Enviar+una+cookie"></a>
<h3 class="underlined_5">Enviar una cookie</h3>
<p>Para crear una nueva cookie y enviarla, se siguen los pasos:</p>
<p>
<strong>1. Crear la cookie</strong>
</p>
<p>Las cookies se manejan con la clase <strong><span class="codefrag">Cookie</span></strong>. Se tiene el constructor:</p>
<pre class="code">public Cookie (String nombre, String valor)</pre>
<p>que crea una cookie de nombre <span class="codefrag">nombre</span>, d&aacute;ndole el valor <span class="codefrag">valor</span>.</p>
<p>
<strong>2. Establecer los atributos de la cookie</strong>
</p>
<p>Una vez creada la cookie, podemos establecer los atributos que queramos, con los m&eacute;todos de la clase <span class="codefrag">Cookie</span>. Por ejemplo, se tienen:</p>
<pre class="code">public void setComment(String comentario)
public void setMaxAge(int edad)
...</pre>
<p>El primero asigna una cadena descriptiva sobre la cookie. El segundo indica cu&aacute;ntos segundos de vida tiene. Si es un valor negativo, se borrar&aacute; la cookie cuando se cierre el navegador. Si el valor es 0, se borra la cookie instant&aacute;neamente, y si es positivo, se borrar&aacute; la cookie cuando pasen los segundos indicados (si cerramos y volvemos a abrir el navegador dentro de ese tiempo, la cookie todav&iacute;a persistir&aacute;). Se tienen otros m&eacute;todos para establecer atributos de la cookie.</p>
<p>
<strong>3. Enviar la cookie</strong>
</p>
<p>Las cookies se a&ntilde;aden a la cabecera de la respuesta, y se env&iacute;an as&iacute; al cliente, mediante el m&eacute;todo de <span class="codefrag">HttpServletResponse</span>:</p>
<pre class="code">public void addCookie (Cookie cookie)</pre>
<p>
<strong>Ejemplo</strong>
</p>
<p>Vemos un ejemplo completo de env&iacute;o de cookie:</p>
<pre class="code">public class MiServlet extends HttpServlet 
{ 
	public void doGet (HttpServletRequest request, 
	                   HttpServletResponse response) 
	throws ServletException, IOException
	{	
		Cookie miCookie = new Cookie ("nombre", "Pepe");
		miCookie.setMaxAge(120);
		response.addCookie(miCookie);
		PrintWriter out = response.getWriter();
		...
	}
}</pre>
<p>Hay que tener en cuenta que las cookies son parte de la cabecera HTTP, con lo cual hay que enviarlas ANTES de escribir la respuesta (o antes de obtener el objeto <span class="codefrag">Writer</span> si lo queremos utilizar).</p>
<a name="N100A5"></a><a name="Obtener+una+cookie"></a>
<h3 class="underlined_5">Obtener una cookie</h3>
<p>Para obtener una cookie que env&iacute;a el cliente se trabaja sobre la petici&oacute;n del cliente (<span class="codefrag">HttpServletRequest</span>), siguiendo los pasos:</p>
<p>
<strong>1. Obtener todas las cookies</strong>
</p>
<p>Obtenemos todas las cookies con el m&eacute;todo <strong>getCookies()</strong> de la clase <span class="codefrag">HttpServletRequest</span>:</p>
<pre class="code">public Cookie[] getCookies()</pre>
<p>Con esto se tiene un array con todas las cookies actuales para el usuario. Si no hay cookies el m&eacute;todo devuelve <span class="codefrag">null</span>.</p>
<p>
<strong>2. Obtener el valor de una cookie</strong>
</p>
<p>Con lo anterior, para obtener el valor de una cookie simplemente recorremos el array de cookies buscando la que concuerde con el nombre que queramos. Pueden	ser &uacute;tiles los m&eacute;todos de <span class="codefrag">Cookie</span>:</p>
<pre class="code">public String getName()
public String getValue()</pre>
<p>El primero obtiene el nombre de la cookie, y el segundo el valor.</p>
<p>
<strong>Ejemplo</strong>
</p>
<p>Un ejemplo de uso, para obtener el nombre del usuario, guardado en la cookie	"nombre":</p>
<pre class="code">public void doGet (HttpServletRequest request, 
                   HttpServletResponse response) 
throws ServletException, IOException
{	
	Cookie[] cookies = request.getCookies();
	String nombre;
	for (int i = 0; i &lt; cookies.length; i++)
		if (cookies[i].getName().equals("nombre"))
			nombre = cookies[i].getValue();
}</pre>
<a name="N100E5"></a><a name="Ejemplo"></a>
<h3 class="underlined_5">Ejemplo</h3>
<p>Aqu&iacute; ten&eacute;is un ejemplo de uso de cookies. El servlet <span class="codefrag">ServletCookies</span> cuenta el n&uacute;mero de visitas a una p&aacute;gina con una cookie que dura 3 minutos.</p>
<pre class="code">package ejemplos;

import java.io.*;
import javax.servlet.*;
import javax.servlet.http.*;

public class ServletCookies extends HttpServlet
{
   <strong>// Metodo para GET
</strong>	
   public void doGet(HttpServletRequest request, 
                     HttpServletResponse response) 
   throws ServletException, IOException
   {
	response.setContentType("text/html");
	response.setHeader("Cache-Control", "no-cache");
	
	Cookie[] cookies = request.getCookies();
	Cookie contador = buscaCookie("contador", cookies);
	
	if (contador == null)
	{
<strong>	   // Creamos la cookie con el contador
</strong>			
	   Cookie cookie = new Cookie ("contador", "1");
	   cookie.setMaxAge(180);
	   response.addCookie(cookie);

	<strong>   // Mostramos el mensaje de primera visita
</strong>
	   PrintWriter out = response.getWriter();
	   out.println ("&lt;HTML&gt;");			
	   out.println ("&lt;BODY&gt;");			
	   out.println ("Primera visita"); 
	   out.println ("&lt;BR&gt;");
	   out.println ("&lt;/BODY&gt;");
	   out.println ("&lt;/HTML&gt;");

	} else {
	
	<strong>   // Obtenemos el valor actual del contador
</strong>			
	   int cont = Integer.parseInt(contador.getValue());
	   cont++;
		
	<strong>   // Modificamos el valor de la cookie 
	   // incrementando el contador
</strong>			
	   Cookie cookie = new Cookie ("contador", "" + cont);
	   cookie.setMaxAge(180);
	   response.addCookie(cookie);

	<strong>   // Mostramos el numero de visitas
</strong>
	   PrintWriter out = response.getWriter();
	   out.println ("&lt;HTML&gt;");
	   out.println ("&lt;BODY&gt;");
	   out.println ("Visita numero " + cont);
	   out.println ("&lt;BR&gt;");
	   out.println ("&lt;/BODY&gt;");
	   out.println ("&lt;/HTML&gt;");
	}		
   }	

   <strong>// Busca la cookie 'nombre' 
   // en el array de cookies indicado. 
   // Devuelve null si no esta
</strong>	
   private Cookie buscaCookie(String nombre, 
                              Cookie[] cookies)
   {
	if (cookies == null)
	   return null;
	
	for (int i = 0; i &lt; cookies.length; i++)
	   if (cookies[i].getName().equals(nombre))
		return cookies[i];
	
	return null;
   }
}</pre>
<p>Pod&eacute;is probar el ejemplo con:</p>
<pre class="code">http://localhost:8080/appcs/servlet/ejemplos.ServletCookies </pre>
</div>


<a name="N10113"></a><a name="Seguimiento+de+sesiones"></a>
<h2 class="underlined_10">Seguimiento de sesiones</h2>
<div class="section">
<p>El seguimiento de sesiones es un mecanismo empleado por los servlets para gestionar un estado sobre las peticiones realizadas desde un mismo cliente (un mismo navegador) a lo largo de un per&iacute;odo de tiempo determinado. Las sesiones se comparten por los servlets a los que accede un cliente (algo &uacute;til si queremos construir una aplicaci&oacute;n basada en m&uacute;ltiples servlets).</p>
<p>Para utilizar el seguimiento de sesiones se tienen los pasos:</p>
<ul>
		
<li>Utilizar una sesi&oacute;n (objeto <strong>HttpSession</strong>) para un usuario</li>
		
<li>Almacenar u obtener datos del objeto <span class="codefrag">HttpSession</span>
</li>
		
<li>Opcionalmente, invalidar la sesi&oacute;n</li>
	
</ul>
<a name="N10130"></a><a name="Obtener+una+sesi%C3%B3n"></a>
<h3 class="underlined_5">Obtener una sesi&oacute;n</h3>
<p>El m&eacute;todo <strong><span class="codefrag">getSession()</span></strong> del objeto <strong><span class="codefrag">HttpServletRequest</span></strong> obtiene una sesi&oacute;n de usuario.</p>
<pre class="code">public HttpSession getSession()
public HttpSession getSession(boolean crear)</pre>
<p>El primer m&eacute;todo obtiene la sesi&oacute;n actual, o crea una si no existe. Con el segundo m&eacute;todo podemos establecer, mediante el flag booleano, si queremos crear una nueva si no existe (<span class="codefrag">true</span>) o no (<span class="codefrag">false</span>). Si la sesi&oacute;n es nueva, el m&eacute;todo <strong>isNew()</strong> del <span class="codefrag">HttpSession</span> devuelve <span class="codefrag">true</span>, y la sesi&oacute;n no tiene ning&uacute;n dato asociado. Deberemos ir a&ntilde;adi&eacute;ndole datos tras crearla.</p>
<p>Para mantener la sesi&oacute;n de forma adecuada, debemos llamar a <span class="codefrag">getSession()</span> antes de que se escriba nada en la respuesta <span class="codefrag">HttpServletResponse</span> (y si utilizamos un <span class="codefrag">Writer</span>, debemos obtenerla antes de obtener el <span class="codefrag">Writer</span>, no antes de escribir datos).</p>
<p>Por ejemplo:</p>
<pre class="code">public class MiServlet extends HttpServlet 
{ 
	public void doGet (HttpServletRequest request, 
	                   HttpServletResponse response) 
	throws ServletException, IOException
	{	
		HttpSession sesion = request.getSession(true);
		...
		PrintWriter out = response.getWriter();
		...
	}
}</pre>
<a name="N1016E"></a><a name="Guardar+y+obtener+datos+de+la+sesi%C3%B3n"></a>
<h3 class="underlined_5">Guardar y obtener datos de la sesi&oacute;n</h3>
<p>La interfaz <strong><span class="codefrag">HttpSession</span></strong> proporciona m&eacute;todos que permiten almacenar y obtener:</p>
<ul>
			
<li>
				
<p>Propiedades de la sesi&oacute;n, como por ejemplo su identificador:</p>
				
<pre class="code">public String getId()</pre>
			
</li>
			
<li>
				
<p>Datos de la aplicaci&oacute;n, que se almacenan y obtienen como pares nombre-valor, donde el nombre es un <span class="codefrag">String</span> que identifica al dato, y el valor es un <span class="codefrag">Object</span> con el valor asociado. Tendremos que tener cuidado de no sobreescribir datos de un servlet desde otro accidentalmente. Se tienen los m&eacute;todos:</p>

<pre class="code">public Object getAttribute(String nombre)
public void   setAttribute(String nombre, Object valor)
public void   removeAttribute(String nombre)</pre>
				
<p>que obtienen / establecen / eliminan, respectivamente, valores de atributos. Estos`m&eacute;todos eran <span class="codefrag">getValue()</span>, <span class="codefrag">putValue()</span>  y <span class="codefrag">removeValue() </span>hasta la versi&oacute;n 2.2 de servlets. Se tienen adem&aacute;s m&eacute;todos como <span class="codefrag">getAttributeNames()</span> para obtener los nombres de los atributos que se tienen almacenados para la sesi&oacute;n, y otros m&eacute;todos de utilidad en la clase <span class="codefrag">HttpSession</span>.</p>
			
</li>
		
</ul>
<p>Por ejemplo:</p>
<pre class="code">public class MiServlet extends HttpServlet 
{ 
	public void doGet (HttpServletRequest request, 
	                   HttpServletResponse response) 
	throws ServletException, IOException
	{	
		HttpSession sesion = request.getSession(true);
		String nombreUsuario = 
		   (String)(sesion.getAttribute("nombre"));
		sesion.setAttribute("password", "secreto");
	}
}</pre>
<p>El ejemplo lee el atributo "nombre" de la sesi&oacute;n, y establece el atributo "password" al valor "secreto".</p>
<a name="N101B5"></a><a name="Invalidar+la+sesi%C3%B3n"></a>
<h3 class="underlined_5">Invalidar la sesi&oacute;n</h3>
<p>Una sesi&oacute;n de usuario puede invalidarse manualmente, o autom&aacute;ticamente (dependiendo de d&oacute;nde est&eacute; ejecutando el servlet). Esto implica eliminar el objeto <span class="codefrag">HttpSession</span><strong> </strong>y sus valores de la memoria. Se tienen los m&eacute;todos de <span class="codefrag">HttpSession</span>:</p>
<pre class="code">public int getMaxInactiveInterval()
public void setMaxInactiveInterval(int intervalo)
public void invalidate()</pre>
<p>Para invalidarla autom&aacute;ticamente, la sesi&oacute;n expira cuando transcurre el tiempo indicado por el m&eacute;todo <strong><span class="codefrag">getMaxInactiveInterval()</span></strong> entre dos accesos del cliente (en segundos). Se puede establecer dicho valor con <strong><span class="codefrag">setMaxInactiveInterval(...)</span></strong>.</p>
<p>Para invalidar manualmente una sesi&oacute;n, se emplea el m&eacute;todo <strong><span class="codefrag">invalidate()</span></strong> de la misma. Esto puede ser interesante por ejemplo en comercio electr&oacute;nico: podemos mantener una sesi&oacute;n donde se vayan acumulando los productos que un usuario quiera comprar, e invalidar la sesi&oacute;n (borrarla) cuando el usuario compre los productos.</p>
<p>Por ejemplo:</p>
<pre class="code">public class MiServlet extends HttpServlet 
{ 
	public void doGet (HttpServletRequest request, 
	                   HttpServletResponse response) 
	throws ServletException, IOException
	{	
		HttpSession sesion = request.getSession(true);
		...
		sesion.invalidate();
		...
	}
}</pre>
<a name="N101E4"></a><a name="Compatibilidad+con+los+navegadores"></a>
<h3 class="underlined_5">Compatibilidad con los navegadores</h3>
<p>Una alternativa para el seguimiento de sesiones consiste en la <strong><span class="codefrag">reescritura de URLs</span></strong>. Con esta t&eacute;cnica, se a&ntilde;aden como par&aacute;metros de la URL los datos relativos a la sesi&oacute;n actual, de forma que se van conservando entre las p&aacute;ginas.</p>
<p>El seguimiento de sesiones por defecto emplea cookies para almacenar el identificador de una sesi&oacute;n. Para poder utilizar seguimiento de sesiones con usuarios que accedan desde navegadores que no utilicen cookies, los servlets aplican autom&aacute;ticamente la reescritura de URLs cuando no se utilizan cookies. </p>
<p>Para poder utilizar esto, debemos codificar todas las URLs que referenciemos. Para esto se emplean los m&eacute;todos:</p>
<pre class="code">public String encodeURL(String url)
public String encodeRedirectURL(String url) </pre>
<p>El primero se emplea para asociar identificadores con URLs, se utilizar&aacute; cuando pongamos urls en el contenido de la p&aacute;gina que generamos. El segundo se utiliza para asociar identificadores con redirecciones. Lo emplearemos cuando utilicemos m&eacute;todos <span class="codefrag">sendRedirect()</span>, para codificar la URL que se le pasa. Ambos devuelven la URL sobreescrita si la sobreescritura ha sido necesaria, o la misma URL si no ha sido necesario sobreescribir.</p>
<p>Por ejemplo:</p>
<pre class="code">public class MiServlet extends HttpServlet 
{ 
	public void doGet (HttpServletRequest request, 
	                   HttpServletResponse response) 
	throws ServletException, IOException
	{			
		...
		String url = response.encodeURL(
		   "http://localhost:8080/mipagina.html");
		out.println ("&lt;a href=\"" + url + "\"&gt;...&lt;/a&gt;");
		...
		String url2 = response.encodeRedirectURL(
		   "http://otrapagina.com");
		response.sendRedirect(url2);
	}
}</pre>
<a name="N10209"></a><a name="Oyentes"></a>
<h3 class="underlined_5">Oyentes</h3>
<p>Existen tres tipos de oyentes (<span class="codefrag">listeners</span>) que podemos utilizar en sesiones, para dar respuesta a eventos que produzcan las propias sesiones, o que desde fuera se provoquen sobre las mismas:</p>
<ul>
			
<li>
				
<p>
<strong><span class="codefrag">HttpSessionListener</span></strong> se emplea para eventos de crear la sesi&oacute;n y terminarla. Tiene los m&eacute;todos:</p>

<pre class="code">public void sessionCreated(HttpSessionEvent e)
public void sessionDestroyed(HttpSessionEvent e)</pre>
				
<p>El objeto que implemente esta interfaz ejecutar&aacute; el c&oacute;digo de <span class="codefrag">sessionCreated()</span> cuando se inicie la sesi&oacute;n, y el de <span class="codefrag">sessionDestroyed()</span> cuando se termine. Las clases que implementen este oyente deben configurarse en el fichero descriptor de la aplicaci&oacute;n, mediante etiquetas <strong>&lt;listener&gt;</strong>:</p>

<pre class="code">&lt;listener&gt;
	&lt;listener-class&gt;clase&lt;/listener-class&gt;
&lt;/listener&gt;</pre>
				
<p>donde en <strong>&lt;listener-class&gt;</strong> se pone el nombre (completo) de la clase que implementa el listener. As&iacute;, el listener se registra, y el servidor ya sabe que tiene que notificarle en los momentos oportunos. </p>
			
</li>
			
<li>
				
<p>
<strong>HttpSessionBindingListener</strong>: si un objeto asociado a una sesi&oacute;n implementa esta interfaz, la sesi&oacute;n se encarga de notificarle de cu&aacute;ndo son a&ntilde;adidos y eliminados de la sesi&oacute;n. Para ello la interfaz tiene los m&eacute;todos: </p>

<pre class="code">public void valueBound(HttpSessionBindingEvent e)
public void valueUnbound(HttpSessionBindingEvent e)</pre>
				
<p>El objeto que implemente esta interfaz ejecutar&aacute; el c&oacute;digo de <span class="codefrag">valueBound()</span> cuando la sesi&oacute;n lo a&ntilde;ada, y el m&eacute;todo <span class="codefrag">valueUnbound()</span> cuando la sesi&oacute;n lo elimine.</p>
			
</li>
			
<li>
				
<p>
<strong>HttpSessionActivationListener</strong>: si un objeto asociado a una sesi&oacute;n implementa esta interfaz, la sesi&oacute;n se encarga de notificarles de cu&aacute;ndo el contenedor cambia la sesi&oacute;n entre m&aacute;quinas virtuales distintas, para un sistema distribuido. Para ello tiene los m&eacute;todos: </p>

<pre class="code">public void sessionDidActivate(HttpSessionEvent e)
public void sessionWillPassivate(HttpSessionEvent e)</pre>
				
<p>El objeto que implemente esta interfaz ejecutar&aacute; el c&oacute;digo de <span class="codefrag">sessionDidActivate()</span> cuando la sesi&oacute;n se active, y <span class="codefrag">sessionWillPassivate() </span>cuando se vuelva pasiva.</p>
			
</li>
		
</ul>
<a name="N10266"></a><a name="Ejemplos"></a>
<h3 class="underlined_5">Ejemplos</h3>
<p>Aqu&iacute; ten&eacute;is un ejemplo de uso de sesiones. El servlet <span class="codefrag">ServletSesiones</span> cuenta el n&uacute;mero de visitas a una p&aacute;gina en una sola sesi&oacute;n (en una sola ventana de navegador).</p>
<pre class="code">package ejemplos;

import java.io.*;
import javax.servlet.*;
import javax.servlet.http.*;

public class ServletSesiones extends HttpServlet
{
   <strong>// Metodo para GET
</strong>	
   public void doGet(HttpServletRequest request, 
                     HttpServletResponse response) 
   throws ServletException, IOException
   {
	response.setContentType("text/html");
	response.setHeader("Cache-Control", "no-cache");
		
	HttpSession sesion = request.getSession();
	PrintWriter out = response.getWriter();

	if (sesion.isNew())
	{
<strong>	   // Mostramos un mensaje de primera visita
</strong>
	   out.println ("&lt;HTML&gt;");			
	   out.println ("&lt;BODY&gt;");			
	   out.println ("Primera visita a la pagina");
	   out.println ("&lt;BR&gt;");
	   out.println ("&lt;/BODY&gt;");			
	   out.println ("&lt;/HTML&gt;");			
			
	   sesion.setAttribute("contador", new Integer(1));
			
	} else {

	<strong>   // Mostramos el numero de visitas 
	   // y actualizamos el contador
</strong>			
	   int contador = ((Integer)
	   (sesion.getAttribute("contador"))).intValue();
	   contador++;

	   out.println ("&lt;HTML&gt;");			
	   out.println ("&lt;BODY&gt;");			
	   out.println ("Visita numero " + 
			contador + 
			" a la pagina en esta sesion");
	   out.println ("&lt;BR&gt;");
	   out.println ("&lt;/BODY&gt;");
	   out.println ("&lt;/HTML&gt;");
			
	   sesion.setAttribute("contador", 
		               new Integer(contador));
	}		
   }	
}</pre>
<p>Pod&eacute;is probar el ejemplo con:</p>
<pre class="code">http://localhost:8080/appcs/servlet/ejemplos.ServletSesiones </pre>
<p>El siguiente servlet utiliza como atributo de sesi&oacute;n una clase interna <span class="codefrag">ObjetoSesion</span>, que implementa la interfaz <span class="codefrag">HttpSessionBindingListener</span>. Dicho objeto tiene dentro un valor entero, y una cadena. Cada vez que el objeto se a&ntilde;ade a la sesi&oacute;n se modifica un mensaje de texto, mostrando el valor entero actual del objeto:</p>
<pre class="code">package ejemplos;

import java.io.*;
import javax.servlet.*;
import javax.servlet.http.*;

public class EjemploServletListener extends HttpServlet
{
   public void doGet(HttpServletRequest request, 
                     HttpServletResponse response) 
   throws ServletException, IOException
   {
	response.setContentType("text/html");
	response.setHeader("Cache-Control", 
			   "no-cache");
		
	HttpSession sesion = request.getSession();
	PrintWriter out = response.getWriter();

	if (sesion.isNew())
	{
<strong>	   // Mostramos mensaje de inicio
</strong>
	   out.println ("&lt;HTML&gt;&lt;BODY&gt;" + 
			"Mensaje de inicio" + 
			"&lt;/BODY&gt;&lt;/HTML&gt;");
	   sesion.setAttribute("contador", 
			       new ObjetoSesion(1));
			
	} else {

<strong>	   // Mostramos el valor actual del 
	   // objeto "contador"
</strong>			
	   int contador = ((ObjetoSesion)
	      (sesion.getAttribute("contador"))).getValor();
	   String mensaje = ((ObjetoSesion)
	      (sesion.getAttribute("contador"))).getEnlazado();

	   out.println ("&lt;HTML&gt;&lt;BODY&gt;");			
	   out.println ("Valor: " + contador + 
			"&lt;br&gt;Enlazado: " + mensaje);
	   out.println ("&lt;/BODY&gt;&lt;/HTML&gt;");			
		
	   sesion.setAttribute("contador", 
	      new ObjetoSesion(contador+1));
	}		
   }	
}

class ObjetoSesion implements HttpSessionBindingListener
{
   int valor;
   String enlazado = "NO";
	
   public ObjetoSesion(int valor)
   {
	this.valor = valor;
   }
	
   public void valueBound(HttpSessionBindingEvent e)
   {
	enlazado = "Objeto enlazado a la sesion " + 
		   valor + " veces";
   }
	
   public void valueUnbound(HttpSessionBindingEvent e)
   {
   }
	
   public String getEnlazado()
   {
	return enlazado;
   }
	
   public int getValor()
   {
  	return valor;
   }
}</pre>
<p>Si cargamos el servlet por primera vez en la sesi&oacute;n, muestra el mensaje:</p>
<pre class="code">Mensaje de bienvenida</pre>
<p>Luego, cada vez que recarguemos el servlet se entrar&aacute; en el bloque <span class="codefrag">else</span>, y al llamar al m&eacute;todo <span class="codefrag">setAttribute()</span> se disparar&aacute; el m&eacute;todo <span class="codefrag">valueBound()</span>, actualizando la cadena. Con esto, con cada recarga se mostrar&aacute; el mensaje:</p>
<pre class="code">Valor: i
Enlazado: Objeto enlazado a la sesion i veces</pre>
<p>siendo <span class="codefrag">i</span> el n&uacute;mero de veces que se ha enlazado (que coincide con el n&uacute;mero de veces que se ha cargado el servlet, en este caso).</p>
<p>Pod&eacute;is probar el ejemplo con:</p>
<pre class="code">http://localhost:8080/appcs/servlet/ejemplos.EjemploServletListener </pre>
</div>

<p class="pageBreakAfter"></p>

</div>
<div class="clearboth">&nbsp;</div>
</div>
<div id="footer">
<div class="lastmodified">
<script type="text/javascript"><!--
document.write("<text>Last Published:</text> " + document.lastModified);
//  --></script>
</div>
<div class="copyright">
        Copyright &copy;
         2006 Depto. CCIA</div>
</div>
</body>
</html>
