<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta content="Apache Forrest" name="Generator">
<meta name="Forrest-version" content="0.7">
<meta name="Forrest-skin-name" content="pelt">
<title>Creaci&oacute;n de librer&iacute;as de tags</title>
<link type="text/css" href="skin/basic.css" rel="stylesheet">
<link media="screen" type="text/css" href="skin/screen.css" rel="stylesheet">
<link media="print" type="text/css" href="skin/print.css" rel="stylesheet">
<link type="text/css" href="skin/profile.css" rel="stylesheet">
<script src="skin/getBlank.js" language="javascript" type="text/javascript"></script><script src="skin/getMenu.js" language="javascript" type="text/javascript"></script><script src="skin/fontsize.js" language="javascript" type="text/javascript"></script>
<link rel="shortcut icon" href="">
</head>
<body onload="init()">
<script type="text/javascript">ndeSetTextSize();</script>
<div id="top">
<div class="header">
<div class="grouplogo">
<a href="http://www.jtech.ua.es/j2ee"><img class="logoImage" alt="J2EE" src="images/baner_j2ee_izq.gif" title="Curso Especialista Universitario J2EE"></a>
</div>
<div class="projectlogoA1">
<a href="http://www.dccia.ua.es/"><img class="logoImage" alt="Servlets y JSP" src="images/baner_j2ee_der.gif" title="Servlets y JSP"></a>
</div>
<ul id="tabs">
<li>
<a class="base-not-selected" href="../index.html">M&oacute;dulos</a>
</li>
<li class="current">
<a class="base-selected" href="index.html">Servlets y JSP</a>
</li>
</ul>
</div>
</div>
<div id="main">
<div id="publishedStrip">
<div id="level2tabs"></div>
<script type="text/javascript"><!--
document.write("<text>Last Published:</text> " + document.lastModified);
//  --></script>
</div>
<div class="breadtrail">
             
             &nbsp;
           </div>
<div id="menu">
<div onclick="SwitchMenu('menu_selected_1.1', 'skin/')" id="menu_selected_1.1Title" class="menutitle" style="background-image: url('skin/images/chapter_open.gif');">Servlets y JSP</div>
<div id="menu_selected_1.1" class="selectedmenuitemgroup" style="display: block;">
<div class="menuitem">
<a href="index.html" title="Servlets y JSP">&Iacute;ndice</a>
</div>
<div onclick="SwitchMenu('menu_selected_1.1.2', 'skin/')" id="menu_selected_1.1.2Title" class="menutitle" style="background-image: url('skin/images/chapter_open.gif');">Teor&iacute;a</div>
<div id="menu_selected_1.1.2" class="selectedmenuitemgroup" style="display: block;">
<div class="menuitem">
<a href="sesion01-apuntes.html">Sesion 1</a>
</div>
<div class="menuitem">
<a href="sesion02-apuntes.html">Sesion 2</a>
</div>
<div class="menuitem">
<a href="sesion03-apuntes.html">Sesion 3</a>
</div>
<div class="menuitem">
<a href="sesion04-apuntes.html">Sesion 4</a>
</div>
<div class="menuitem">
<a href="sesion05-apuntes.html">Sesion 5</a>
</div>
<div class="menuitem">
<a href="sesion06-apuntes.html">Sesion 6</a>
</div>
<div class="menuitem">
<a href="sesion07-apuntes.html">Sesion 7</a>
</div>
<div class="menuitem">
<a href="sesion08-apuntes.html">Sesion 8</a>
</div>
<div class="menuitem">
<a href="sesion09-apuntes.html">Sesion 9</a>
</div>
<div class="menupage">
<div class="menupagetitle">Sesion 10</div>
</div>
<div class="menuitem">
<a href="sesion11-apuntes.html">Sesion 11</a>
</div>
<div class="menuitem">
<a href="sesion12-apuntes.html">Sesion 12</a>
</div>
<div class="menuitem">
<a href="roadmap-apuntes.html">Roadmap</a>
</div>
</div>
<div onclick="SwitchMenu('menu_1.1.3', 'skin/')" id="menu_1.1.3Title" class="menutitle">Ejercicios</div>
<div id="menu_1.1.3" class="menuitemgroup">
<div class="menuitem">
<a href="sesion01-ejercicios.html">Sesion 1</a>
</div>
<div class="menuitem">
<a href="sesion02-ejercicios.html">Sesion 2</a>
</div>
<div class="menuitem">
<a href="sesion03-ejercicios.html">Sesion 3</a>
</div>
<div class="menuitem">
<a href="sesion04-ejercicios.html">Sesion 4</a>
</div>
<div class="menuitem">
<a href="sesion05-ejercicios.html">Sesion 5</a>
</div>
<div class="menuitem">
<a href="sesion06-ejercicios.html">Sesion 6</a>
</div>
<div class="menuitem">
<a href="sesion07-ejercicios.html">Sesion 7</a>
</div>
<div class="menuitem">
<a href="sesion08-ejercicios.html">Sesion 8</a>
</div>
<div class="menuitem">
<a href="sesion09-ejercicios.html">Sesion 9</a>
</div>
<div class="menuitem">
<a href="sesion10-ejercicios.html">Sesion 10</a>
</div>
<div class="menuitem">
<a href="sesion11-ejercicios.html">Sesion 11</a>
</div>
<div class="menuitem">
<a href="sesion12-ejercicios.html">Sesion 12</a>
</div>
</div>
</div>
<div id="credit"></div>
<div id="roundbottom">
<img style="display: none" class="corner" height="15" width="15" alt="" src="skin/images/rc-b-l-15-1body-2menu-3menu.png"></div>
<div id="credit2"></div>
</div>
<div id="content">
<div title="Portable Document Format" class="pdflink">
<a class="dida" href="sesion10-apuntes.pdf"><img alt="PDF -icon" src="skin/images/pdfdoc.gif" class="skin"><br>
        PDF</a>
</div>
<h1>Creaci&oacute;n de librer&iacute;as de tags</h1>
<div id="minitoc-area">
<ul class="minitoc">
<li>
<a href="#Consideraciones+previas">Consideraciones previas</a>
</li>
<li>
<a href="#Tags+simples">Tags simples</a>
</li>
<li>
<a href="#Tags+con+par%C3%A1metros">Tags con par&aacute;metros</a>
</li>
<li>
<a href="#BodyTags">BodyTags</a>
</li>
<li>
<a href="#Tags+anidados">Tags anidados</a>
</li>
</ul>
</div>


<p>Veremos en esta sesi&oacute;n c&oacute;mo podemos definir nuestros propios tags y formar con ellos una librer&iacute;a, tratando distintos tipos de tags (aunque no todos) los que se pueden hacer. </p>
 

<a name="N1000F"></a><a name="Consideraciones+previas"></a>
<h2 class="underlined_10">Consideraciones previas</h2>
<div class="section">
<p>Para ello iremos incorporando tags a una librer&iacute;a nueva, que llamaremos <strong>pruebatags</strong>.<strong> </strong>Antes de comenzar a ver c&oacute;mo crear tags, tendremos en cuenta las siguientes consideraciones: </p>
<ul>
		
<li>Para definir los tags haremos clases Java, que contendr&aacute;n el c&oacute;digo de cada tag. Luego desde las p&aacute;ginas JSP llamaremos a los tags (con lo que se ejecutar&aacute; el c&oacute;digo de las clases Java que los implementan). Colocaremos todas las clases de nuestra librer&iacute;a de tags en el paquete <strong>pruebatags</strong>.</li>
		
<li>Utilizaremos los paquetes <strong>javax.servlet.jsp </strong>y <strong>javax.servlet.jsp.tagext</strong> principalmente para definir las librer&iacute;as de tags. Para poder acceder a ellos deberemos tener en el classpath el fichero JAR correspondiente (el fichero <strong>j2ee.jar</strong> que viene con J2EE, o alg&uacute;n fichero espec&iacute;fico del servidor que incorpore estas librer&iacute;as, como por ejemplo <span class="codefrag">servlet.jar</span> en Tomcat 4, o <span class="codefrag">jsp-api.jar</span> en Tomcat 5).</li>
		
<li>
			
<p>Emplearemos el servidor <strong>Apache Tomcat</strong> para probar los tags. Crearemos un directorio <strong>tags</strong> a partir del ra&iacute;z <span class="codefrag">webapps</span>, y en &eacute;l definiremos el directorio <span class="codefrag">WEB-INF</span>, con el fichero <strong>web.xml</strong>:</p>
           

<pre class="code">&lt;!DOCTYPE web-app PUBLIC 
 "-//Sun Microsystems, Inc.//
 DTD Web Application 2.2//EN" 
 "http://java.sun.com/j2ee/dtds/web-app_2_2.dtd"&gt;

&lt;web-app&gt;
	&lt;display-name&gt;Pruebas de Tags&lt;/display-name&gt;
	&lt;description&gt;
		Ejemplos de Creacion de Tags
	&lt;/description&gt;

	&lt;taglib&gt;
		&lt;taglib-uri&gt;pruebatags&lt;/taglib-uri&gt;
		&lt;taglib-location&gt;
		/WEB-INF/pruebatags.tld
		&lt;/taglib-location&gt;
	&lt;/taglib&gt;
&lt;/web-app&gt;</pre>
           
			
<p>donde indicamos que se va a utilizar la librer&iacute;a <span class="codefrag">pruebatags</span>, cuyo fichero descriptor (<span class="codefrag">pruebatags.tld</span>) est&aacute; en <span class="codefrag">WEB-INF</span> (lo a&ntilde;adiremos m&aacute;s adelante). </p>
		
</li>
	
</ul>
</div>


<a name="N1005F"></a><a name="Tags+simples"></a>
<h2 class="underlined_10">Tags simples</h2>
<div class="section">
<p>Como ejemplo de tag simple haremos un tag que muestre la fecha actual. Veremos los pasos que se siguen: </p>
<p>
<strong>1. Creaci&oacute;n de la clase que implementa el tag</strong> 
</p>
<p>Llamaremos <strong>FechaActual</strong> a la clase que implementa al tag. </p>
<pre class="code">package pruebatags;

import javax.servlet.jsp.*;
import javax.servlet.jsp.tagext.*;

import java.util.Calendar;

public class FechaActual implements Tag
{
	private PageContext contexto;	<strong>// Contexto del tag</strong>
	private Tag padre; 		<strong>// Tag padre del actual</strong>
	
	<strong>// Metodo llamado cuando se comienza el tag
</strong>	public int doStartTag() throws JspException 
	{ 
		return SKIP_BODY; 
	} 
	
	<strong>// Metodo llamado cuando se termina el tag
</strong>	public int doEndTag() throws JspException 
	{
		try
		{
	<strong>		// Mostramos la fecha y hora actuales
</strong>		        Calendar c=Calendar.getInstance();
			contexto.getOut().write(
				c.get(Calendar.DAY_OF_MONTH) + 
				"/" + 
				(c.get(Calendar.MONTH)+1) + 
				"/" + 
				c.get(Calendar.YEAR) + 
				" - " + 
				c.get(Calendar.HOUR_OF_DAY) + 
				":" + 
				c.get(Calendar.MINUTE) + 
				":" + 
				c.get(Calendar.SECOND)); 
		} catch(java.io.IOException e) {
			throw new JspException("Error"); 
		}
		return EVAL_PAGE;
	} 
	
<strong>	// Metodo de limpieza
</strong>	public void release() {}
	
	<strong>// Metodo para asignar el contexto
</strong>	public void setPageContext(final PageContext contexto) 
	{
		this.contexto = contexto; 
	} 
	
	<strong>// Metodo para asignar el tag padre
</strong>	public void setParent(final Tag padre) 
	{
		this.padre = padre;
	} 
	
	<strong>// Metodo para obtener el padre
</strong>	public Tag getParent() 
	{
		return padre;
	}
}</pre>
<ul>
		
<li>Primero colocamos el nombre del paquete, los paquetes que necesitamos y definimos la clase. El paquete <strong>java.util.Calendar</strong> lo utilizamos para obtener la fecha y hora actuales. Los otros dos paquetes son los que se han dicho que se emplean para crear librer&iacute;as de tags. La clase implementa la interfaz <strong>javax.servlet.jsp.tagext.Tag</strong>, con lo que hay que definir todos sus m&eacute;todos.</li>
		
<li>Despu&eacute;s creamos dos campos: uno para guardar el contexto del tag (campo <span class="codefrag">contexto</span>), y otro para guardar el tag padre del actual (campo <span class="codefrag">padre</span>).</li> 
		
<li>El m&eacute;todo <strong>doStartTag() </strong>se llama cuando se inicia el tag. En este caso se devuelve <strong>SKIP_BODY</strong> para que no se eval&uacute;e el cuerpo del tag. En caso de que queramos evaluarlo, se debe devolver <strong>EVAL_BODY_INCLUDE</strong>.</li>
		
<li>El m&eacute;todo <strong>doEndTag() </strong>se llama cuando se termina el tag. Aqu&iacute; se muestra por la salida del contexto la fecha y hora actuales (usando un objeto <span class="codefrag">java.util.Calendar</span>), y se devuelve <strong>EVAL_PAGE</strong> para que se siga evaluando el resto de la p&aacute;gina. Si no queremos que se siga evaluando, se devuelve <strong>SKIP_PAGE</strong>.</li>
		
<li>El resto de m&eacute;todos es necesario ponerlos, al formar parte de la interfaz <span class="codefrag">Tag</span>. Con <strong>release()</strong><span class="codefrag"> </span>se pueden liberar recursos asociados al tag. Con <strong>setPageContext()</strong><span class="codefrag"> </span>se establece el contexto para el tag, y con <strong>setParent()</strong> y <strong>getParent()</strong> se establece y obtiene el tag padre del actual. Estos m&eacute;todos se llaman cuando se utiliza el tag. No tenemos que preocuparnos de llamarlos nosotros, s&oacute;lo dejarlos definidos para que hagan lo correcto (establezcan el contexto y el tag padre).</li>
	
</ul>
<p>Una vez que tengamos la clase definida, la <strong>compilamos</strong>. </p>
<p>
<strong>2. Crear el fichero TLD</strong> 
</p>
<p>Creamos un fichero de texto con extensi&oacute;n <strong>.tld</strong>, que llamaremos por ejemplo <strong>pruebatags.tld</strong>, y que contendr&aacute; la descripci&oacute;n de la librer&iacute;a de tags. Su contenido es: </p>
<pre class="code">&lt;?xml version="1.0" encoding="ISO-8859-1" ?&gt;
&lt;!DOCTYPE taglib PUBLIC "-//Sun Microsystems, Inc.//
 DTD JSP Tag Library 1.1//EN" 
 "http://java.sun.com/j2ee/dtds/web-jsptaglibrary_1_1.dtd"&gt; 

&lt;taglib&gt; 

	&lt;tlibversion&gt;1.0&lt;/tlibversion&gt; 
	&lt;jspversion&gt;1.1&lt;/jspversion&gt;
	&lt;shortname&gt;pt&lt;/shortname&gt;
	&lt;uri&gt;pruebatags&lt;/uri&gt;
	&lt;info&gt;Librer&iacute;a de prueba&lt;/info&gt; 

	&lt;tag&gt; 
		&lt;name&gt;fechaactual&lt;/name&gt; 
		&lt;tagclass&gt;pruebatags.FechaActual&lt;/tagclass&gt;
		&lt;bodycontent&gt;empty&lt;/bodycontent&gt;
		&lt;info&gt;Muestra la fecha y hora actual&lt;/info&gt;
	&lt;/tag&gt;

&lt;/taglib&gt;</pre>
<p>La sintaxis del documento TLD se explic&oacute; anteriormente, viendo otras librer&iacute;as de tags. Hemos creado una librer&iacute;a llamada <span class="codefrag">pruebatags</span>, donde tenemos un tag, llamado <span class="codefrag">fechaactual</span>, implementado por la clase <span class="codefrag">pruebatags.FechaActual</span>.</p>
<p>La estructura de <span class="codefrag">tag</span>  la iremos repitiendo luego para cada tag de la librer&iacute;a que vayamos creando. Nos queda llevar este fichero TLD al directorio <span class="codefrag">WEB-INF </span>del directorio <span class="codefrag">tags</span> donde estamos creando la librer&iacute;a. </p>
<p>
<strong>3. Crear un JAR con la librer&iacute;a</strong> 
</p>
<p>Podemos crear un fichero JAR (<strong>pruebatags.jar</strong> por ejemplo), que contenga los ficheros <span class="codefrag">.class </span>con las clases que implementen los tags (en este caso s&oacute;lo est&aacute; la clase <span class="codefrag">FechaActual</span>). Luego copiamos dicho fichero JAR en el directorio <span class="codefrag">WEB-INF/lib </span>de nuestro directorio <span class="codefrag">tags</span>. </p>
<p>Tambi&eacute;n podemos no crear el JAR, y colocar los ficheros <span class="codefrag">.class</span> en el directorio <span class="codefrag">WEB-INF/classes</span> (quedando as&iacute; en la carpeta <span class="codefrag">WEB-INF/classes/pruebatags</span>). La primera opci&oacute;n es m&aacute;s recomendable si queremos llevar la librer&iacute;a a otras m&aacute;quinas. </p>
<p>
<strong>4. Probar el tag</strong> 
</p>
<p>Finalmente, probamos el funcionamiento del tag. </p>
<pre class="code">&lt;%@ taglib uri="pruebatags" prefix="pt"%&gt;

&lt;HTML&gt; 
&lt;BODY &gt; 
	La fecha actual es:
	&lt;pt:fechaactual/&gt;
&lt;/BODY&gt; 
&lt;/HTML&gt; </pre>
</div>
           

<a name="N10138"></a><a name="Tags+con+par%C3%A1metros"></a>
<h2 class="underlined_10">Tags con par&aacute;metros</h2>
<div class="section">
<p>Como ejemplo de tag parametrizado vamos a crear un tag que salude al nombre que se le pase como par&aacute;metro: </p>
<p>
<strong>1. Creaci&oacute;n de la clase que implementa el tag</strong> 
</p>
<p>Llamaremos <strong>Saludo</strong> a la clase que implementa al tag. </p>
<pre class="code">package pruebatags;

import javax.servlet.jsp.*;
import javax.servlet.jsp.tagext.*;

public class Saludo implements Tag
{
	private PageContext contexto;	<strong>// Contexto del tag
</strong>	private Tag padre; 		<strong>// Tag padre del actual
</strong>	String nombre = "";		<strong>/</strong><strong>/ Nombre a saludar</strong>
	
<strong>	// Metodo llamado cuando se comienza el tag
</strong>	public int doStartTag() throws JspException 
	{ 
		return SKIP_BODY; 
	} 
	
<strong>	// Metodo llamado cuando se termina el tag
</strong>	public int doEndTag() throws JspException 
	{
		try
		{
			// Mostramos el saludo
			contexto.getOut().write("&iexcl;Hola " + 
						nombre + "!"); 
		} catch(java.io.IOException e) {
			throw new JspException("Error"); 
		}
		return EVAL_PAGE;
	} 
	
<strong>	// Metodo de limpieza
</strong>	public void release() {}
	
<strong>	// Metodo para asignar el contexto
</strong>	public void setPageContext(final PageContext contexto) 
	{
		this.contexto = contexto; 
	} 
	
<strong>	// Metodo para asignar el tag padre
</strong>	public void setParent(final Tag padre) 
	{
		this.padre = padre;
	} 
	
<strong>	// Metodo para obtener el padre
</strong>	public Tag getParent() 
	{
		return padre;
	}

<strong>	// Establece el nombre al que saludar
</strong>	public void setNombre(String nombre) 
	{
		this.nombre = nombre; 
	} 	
}</pre>
<p>El c&oacute;digo es muy similar al visto para <strong>FechaActual</strong>, con alg&uacute;n cambio: se a&ntilde;ade el campo <strong>nombre</strong>, que contendr&aacute; el nombre al que se saluda. Luego, en <strong>doEndTag()</strong> se muestra el mensaje de saludo, en lugar de la fecha. Finalmente, se tiene el m&eacute;todo <strong>setNombre()</strong> que establece el nombre al que saludar. Esto lo har&aacute; autom&aacute;ticamente JSP (de forma similar a los beans), tomando el nombre del par&aacute;metro que se le pase al tag.</p>
<p>
<strong>2. Crear el fichero TLD</strong> 
</p>
<p>En este caso modificamos el fichero TLD anterior, a&ntilde;adi&eacute;ndole una nueva marca <span class="codefrag">tag</span> con los datos del nuevo tag: </p>
<pre class="code">	&lt;tag&gt; 
		&lt;name&gt;saludo&lt;/name&gt; 
		&lt;tagclass&gt;pruebatags.Saludo&lt;/tagclass&gt;
		&lt;bodycontent&gt;empty&lt;/bodycontent&gt;
		&lt;info&gt;Muestra un saludo&lt;/info&gt;
		&lt;attribute&gt; 
			&lt;name&gt;nombre&lt;/name&gt;
			&lt;required&gt;false&lt;/required&gt;
			&lt;rtexprvalue&gt;false&lt;/rtexprvalue&gt;
		&lt;/attribute&gt; 	
	&lt;/tag&gt;</pre>
<p>Llamamamos al tag <span class="codefrag">saludo</span> (el nombre que usaremos desde JSP). Al igual que el anterior, no tiene cuerpo. Con la etiqueta <span class="codefrag">attribute</span> le indicamos que tiene un atributo <span class="codefrag">nombre</span>, que es el nombre al que saludar.</p>
<p>
<strong>3. Crear un JAR con la librer&iacute;a</strong> 
</p>
<p>Actualizamos el fichero JAR anterior o el directorio <span class="codefrag">classes </span>a&ntilde;adiendo la nueva clase creada. </p>
<p>
<strong>4. Probar el tag</strong> 
</p>
<p>Creamos una p&aacute;gina similar a la del tag anterior: </p>
<pre class="code">&lt;%@ taglib uri="pruebatags" prefix="pt"%&gt;

&lt;HTML&gt; 
&lt;BODY &gt; 
	Saludo:
	&lt;pt:saludo nombre="Pepe"/&gt;
&lt;/BODY&gt; 
&lt;/HTML&gt; </pre>
</div>
           

<a name="N101B2"></a><a name="BodyTags"></a>
<h2 class="underlined_10">BodyTags</h2>
<div class="section">
<p>Con los BodyTags podemos reevaluar el contenido del cuerpo del tag tantas veces como se quiera. Haremos con ello un iterador, que repetir&aacute; un n&uacute;mero determinado de veces (pasada como par&aacute;metro) el contenido del cuerpo del tag: </p>
<p>
<strong>1. Creaci&oacute;n de la clase que implementa el tag</strong> 
</p>
<p>Llamaremos <strong>Iterador</strong> a la clase que implementa al tag. </p>
<pre class="code">package pruebatags;

import javax.servlet.jsp.*;
import javax.servlet.jsp.tagext.*;

public class Iterador extends BodyTagSupport
{
	private PageContext contexto;	<strong>// Contexto del tag
</strong>	private Tag padre; 		<strong>// Tag padre del actual</strong>
	int veces = 10;			<strong>// Num de iteraciones</strong>
	int valorActual = 0;		<strong>// Valor del contador</strong>
	
<strong>	// Metodo llamado cuando se comienza el tag
</strong>	public int doStartTag() throws JspException 
	{ 
		if (valorActual &gt;= veces)
			return SKIP_BODY;
		else
		{
			valorActual++;
			return EVAL_BODY_BUFFERED;
		}
	} 

<strong>	// Metodo llamado tras cada evaluacion del tag
</strong>	public int doAfterBody() throws JspException 
	{ 
		if (valorActual &gt;= veces)
			return SKIP_BODY;
		else
		{
			valorActual++;
			return EVAL_BODY_BUFFERED;
		}
	} 
	
<strong>	// Metodo llamado cuando se termina el tag
</strong>	public int doEndTag() throws JspException 
	{
		try
		{ 
			if(bodyContent != null)
			       bodyContent.writeOut(
			       bodyContent.getEnclosingWriter()); 
		} catch(java.io.IOException e) { 
			throw new JspException("IO Error"); 
		}		
		return EVAL_PAGE;
	} 
	
<strong>	// Establece el numero de iteraciones
</strong>	public void setVeces(int veces) 
	{
		this.veces = veces; 
	} 	
}</pre>
<p>Se hereda de la clase <strong>BodyTagSupport </strong>que implementa la interfaz <span class="codefrag">BodyTag</span>, con lo que s&oacute;lo tendremos que sobreescribir los m&eacute;todos que necesitemos. En el campo <span class="codefrag">veces</span><strong> </strong>guardamos el n&uacute;mero de iteraciones a realizar. Luego con <span class="codefrag">valorActual </span>vamos incrementando el contador hasta llegar a <span class="codefrag">veces</span>. El m&eacute;todo <strong>doStartTag()</strong> se ejecuta al empezar el tag, y luego es el m&eacute;todo <strong>doAfterBody() </strong>quien permite repetir el contenido del cuerpo mientras se cumpla la condici&oacute;n que se quiera. Al terminar, en <strong>doEndTag() </strong>imprimimos el resultado de procesar el cuerpo tras el n&uacute;mero de iteraciones establecido. Con el m&eacute;todo <strong>setVeces()</strong> asignamos el n&uacute;mero de iteraciones (como en el caso anterior, esto lo har&aacute; autom&aacute;ticamente JSP tomando el n&uacute;mero de iteraciones del par&aacute;metro que se le pase al tag).</p>
<p>
<strong>2. Crear el fichero TLD</strong> 
</p>
<p>Modificamos el fichero TLD anterior, a&ntilde;adi&eacute;ndole una nueva marca <span class="codefrag">tag</span> con los datos del nuevo tag: </p>
<pre class="code">	&lt;tag&gt; 
		&lt;name&gt;itera&lt;/name&gt; 
		&lt;tagclass&gt;pruebatags.Iterador&lt;/tagclass&gt;
		&lt;bodycontent&gt;JSP&lt;/bodycontent&gt;
		&lt;info&gt;Muestra un saludo&lt;/info&gt;
		&lt;attribute&gt; 
			&lt;name&gt;veces&lt;/name&gt;
			&lt;required&gt;true&lt;/required&gt;
			&lt;rtexprvalue&gt;true&lt;/rtexprvalue&gt;
		&lt;/attribute&gt; 	
	&lt;/tag&gt;</pre>
<p>Llamamamos al tag <span class="codefrag">itera</span> (el nombre que usaremos desde JSP). En <span class="codefrag">bodycontent </span>ponemos <span class="codefrag">JSP</span> para que sea JSP quien se encargue de evaluar el cuerpo del tag. Como atributo le pasamos el n&uacute;mero de iteraciones, con un par&aacute;metro llamado <span class="codefrag">veces</span>. Dicho par&aacute;metro es requerido, y admite expresiones JSP en su valor.</p>
<p>
<strong>3. Crear un JAR con la librer&iacute;a</strong> 
</p>
<p>Actualizamos el fichero JAR anterior o el directorio <span class="codefrag">classes </span>a&ntilde;adiendo la nueva clase creada. </p>
<p>
<strong>4. Probar el tag</strong> 
</p>
<p>Utilizamos una p&aacute;gina como: </p>
<pre class="code">&lt;%@ taglib uri="pruebatags" prefix="pt"%&gt;

&lt;HTML&gt; 
&lt;BODY &gt; 
	&lt;%int valor = 0;%&gt;
	&lt;pt:itera veces="5"&gt;
		Valor = &lt;%=valor%&gt;
		&lt;%valor+=10;%&gt;
	&lt;/pt:itera&gt;
&lt;/BODY&gt; 
&lt;/HTML&gt; </pre>
</div>
           

<a name="N10238"></a><a name="Tags+anidados"></a>
<h2 class="underlined_10">Tags anidados</h2>
<div class="section">
<p>Veremos por &uacute;ltimo c&oacute;mo crear tags contenidos en otros tags. Como ejemplo haremos un tag <span class="codefrag">switch</span>-<span class="codefrag">case </span>donde el tag padre contendr&aacute; el <span class="codefrag">switch </span>con un valor global, y dentro podr&aacute; tener uno o varios tag <span class="codefrag">case</span> que se ejecutar&aacute;n en caso de que el valor global coincida con el suyo. </p>
<p>
<strong>1. Creaci&oacute;n de la clase que implementa el Tag</strong> 
</p>
<p>En este caso tenemos 2 clases (porque tenemos 2 tags). El <span class="codefrag">switch </span>padre lo implementamos en la clase <strong>TagSwitch</strong>: </p>
<pre class="code">package pruebatags;

import javax.servlet.jsp.*;
import javax.servlet.jsp.tagext.*;

public class TagSwitch implements Tag
{
	private PageContext contexto;	<strong>// Contexto del tag
</strong>	private Tag padre; 		<strong>// Tag padre del actual</strong>
	String valor;			<strong>// Valor para comparar</strong>
	
<strong>	// Metodo llamado cuando se comienza el tag
</strong>	public int doStartTag() throws JspException 
	{ 
		return EVAL_BODY_INCLUDE; 
	} 
	
<strong>	// Metodo llamado cuando se termina el tag
</strong>	public int doEndTag() throws JspException 
	{
		return EVAL_PAGE;
	} 
	
<strong>	// Metodo de limpieza
</strong>	public void release() {}
	
<strong>	// Metodo para asignar el contexto
</strong>	public void setPageContext(final PageContext contexto) 
	{
		this.contexto = contexto; 
	} 
	
<strong>	// Metodo para asignar el tag padre
</strong>	public void setParent(final Tag padre) 
	{
		this.padre = padre;
	} 
	
<strong>	// Metodo para obtener el padre
</strong>	public Tag getParent() 
	{
		return padre;
	}
	
<strong>	// Obtiene el valor con que comparar con los case
</strong>	public String getValor()
	{
		return valor;
	}		

<strong>	// Establece el valor con que comparar con los case
</strong>	public void setValor(String valor)
	{
		this.valor = valor;
	}		
}</pre>
<p>En el campo <span class="codefrag">valor</span> se guarda el valor con que se comparar&aacute;n luego los <span class="codefrag">case</span> para ver cu&aacute;l encaja. Con los m&eacute;todos <strong>getValor() </strong>y <strong>setValor() </strong>se puede obtener/establecer dicho valor. Observar tambi&eacute;n que en <strong>doStartTag()</strong> se devuelve <strong>EVAL_BODY_INCLUDE</strong> para que se eval&uacute;e el cuerpo del tag. El resto es muy parecido a los primeros tags vistos. </p>
<p>Definimos tambi&eacute;n el tag <span class="codefrag">case</span>, implementado en la clase <strong>TagCase</strong>: </p>
<pre class="code">package pruebatags;

import javax.servlet.jsp.*;
import javax.servlet.jsp.tagext.*;

public class TagCase implements Tag
{
	private PageContext contexto;	<strong>// Contexto del tag</strong>
	private Tag padre; 		<strong>// Tag padre del actual</strong>
	String valor;			<strong>// Valor del case</strong>
	
<strong>	// Metodo llamado cuando se comienza el tag
</strong>	public int doStartTag() throws JspException 
	{ 
		TagSwitch miPadre = (TagSwitch)getParent();
		
		if(miPadre==null)
			throw new JspException("case sin switch");

		try
		{
			if(miPadre.getValor().equals(getValor()))
				return EVAL_BODY_INCLUDE; 
			else
				return SKIP_BODY;
		} catch(NullPointerException e) {

			if(miPadre.getValor()==null || 
			   getValor()==null)
				return EVAL_BODY_INCLUDE;
			else
				return SKIP_BODY; 
		} 	
	} 
	
<strong>	// Metodo llamado cuando se termina el tag
</strong>	public int doEndTag() throws JspException 
	{
		return EVAL_PAGE;
	} 
	
<strong>	// Metodo de limpieza
</strong>	public void release() {}
	
<strong>	// Metodo para asignar el contexto
</strong>	public void setPageContext(final PageContext contexto) 
	{
		this.contexto = contexto; 
	} 
	
<strong>	// Metodo para asignar el tag padre
</strong>	public void setParent(final Tag padre) 
	{
		this.padre = padre;
	} 
	
<strong>	// Metodo para obtener el padre
</strong>	public Tag getParent() 
	{
		return padre;
	}

<strong>	// Obtiene el valor del case
</strong>	public String getValor()
	{
		return valor;
	}		

<strong>	// Establece el valor del case
</strong>	public void setValor(String valor)
	{
		this.valor = valor;
	}			
}</pre>
<p>El campo <span class="codefrag">valor</span> aqu&iacute; guarda el valor de cada <span class="codefrag">case</span> concreto. En el m&eacute;todo <strong>doStartTag()</strong> se obtiene el tag padre, y se compara su valor con el del tag <span class="codefrag">case</span> actual. Si coinciden, se eval&uacute;a el cuerpo del tag, y si no no se eval&uacute;a. </p>
<p>
<strong>2. Crear el fichero TLD</strong> 
</p>
<p>Modificamos el fichero TLD anterior, a&ntilde;adi&eacute;ndole los dos tags: </p>
<pre class="code">	&lt;tag&gt;
		&lt;name&gt;switch&lt;/name&gt;
		&lt;tagclass&gt;pruebatags.TagSwitch&lt;/tagclass&gt;
		&lt;bodycontent&gt;JSP&lt;/bodycontent&gt;
		&lt;info&gt;Tag switch&lt;/info&gt;
		&lt;attribute&gt;
			&lt;name&gt;valor&lt;/name&gt;
			&lt;required&gt;true&lt;/required&gt;
			&lt;rtexprvalue&gt;true&lt;/rtexprvalue&gt;
		&lt;/attribute&gt;	
	&lt;/tag&gt;

	&lt;tag&gt;
		&lt;name&gt;case&lt;/name&gt;
		&lt;tagclass&gt;pruebatags.TagCase&lt;/tagclass&gt;
		&lt;bodycontent&gt;JSP&lt;/bodycontent&gt;
		&lt;info&gt;Tag case&lt;/info&gt;
		&lt;attribute&gt;
			&lt;name&gt;valor&lt;/name&gt;
			&lt;required&gt;true&lt;/required&gt;
			&lt;rtexprvalue&gt;true&lt;/rtexprvalue&gt;
		&lt;/attribute&gt;
	&lt;/tag&gt;</pre>
<p>Llamamamos a los tags <span class="codefrag">switch </span>y <span class="codefrag">case </span>respectivamente. Como atributo le pasamos el valor de cada uno, con un par&aacute;metro llamado <span class="codefrag">valor</span>.</p>
<p>
<strong>3. Crear un JAR con la librer&iacute;a</strong> 
</p>
<p>Actualizamos el fichero JAR anterior o el directorio <span class="codefrag">classes </span>a&ntilde;adiendo las nuevas clases creadas. </p>
<p>
<strong>4. Probar el tag</strong> 
</p>
<p>Utilizamos una p&aacute;gina como: </p>
<pre class="code">&lt;%@ taglib uri="pruebatags" prefix="pt"%&gt;

&lt;HTML&gt; 
&lt;BODY &gt; 
	&lt;pt:switch valor="a"&gt;
		&lt;pt:case valor="b"&gt;
			Si sale esto es que el valor es b
		&lt;/pt:case&gt;

		&lt;pt:case valor="a"&gt;
			Si sale esto es que el valor es a
		&lt;/pt:case&gt;

		&lt;pt:case valor="c"&gt;
			Si sale esto es que el valor es c
		&lt;/pt:case&gt;
	&lt;/pt:switch&gt;
&lt;/BODY&gt; 
&lt;/HTML&gt; </pre>
</div>
          

<p class="pageBreakAfter"></p>
           

</div>
<div class="clearboth">&nbsp;</div>
</div>
<div id="footer">
<div class="lastmodified">
<script type="text/javascript"><!--
document.write("<text>Last Published:</text> " + document.lastModified);
//  --></script>
</div>
<div class="copyright">
        Copyright &copy;
         2006 Depto. CCIA</div>
</div>
</body>
</html>
