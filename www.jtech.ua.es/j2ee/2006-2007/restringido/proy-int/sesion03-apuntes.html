<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta content="Apache Forrest" name="Generator">
<meta name="Forrest-version" content="0.7">
<meta name="Forrest-skin-name" content="pelt">
<title>Aplicaci&oacute;n web con servlets</title>
<link type="text/css" href="skin/basic.css" rel="stylesheet">
<link media="screen" type="text/css" href="skin/screen.css" rel="stylesheet">
<link media="print" type="text/css" href="skin/print.css" rel="stylesheet">
<link type="text/css" href="skin/profile.css" rel="stylesheet">
<script src="skin/getBlank.js" language="javascript" type="text/javascript"></script><script src="skin/getMenu.js" language="javascript" type="text/javascript"></script><script src="skin/fontsize.js" language="javascript" type="text/javascript"></script>
<link rel="shortcut icon" href="">
</head>
<body onload="init()">
<script type="text/javascript">ndeSetTextSize();</script>
<div id="top">
<div class="header">
<div class="grouplogo">
<a href="http://www.jtech.ua.es/j2ee"><img class="logoImage" alt="J2EE" src="images/baner_j2ee_izq.gif" title="Curso Especialista Universitario en Java Enterprise"></a>
</div>
<div class="projectlogoA1">
<a href="http://www.dccia.ua.es/"><img class="logoImage" alt="Proyecto de Integracion" src="images/baner_j2ee_der.gif" title="Proyecto de Integracion"></a>
</div>
<ul id="tabs">
<li>
<a class="base-not-selected" href="../index.html">M&oacute;dulos</a>
</li>
<li class="current">
<a class="base-selected" href="index.html">Proyecto de Integraci&oacute;n</a>
</li>
</ul>
</div>
</div>
<div id="main">
<div id="publishedStrip">
<div id="level2tabs"></div>
<script type="text/javascript"><!--
document.write("<text>Last Published:</text> " + document.lastModified);
//  --></script>
</div>
<div class="breadtrail">
             
             &nbsp;
           </div>
<div id="menu">
<div onclick="SwitchMenu('menu_selected_1.1', 'skin/')" id="menu_selected_1.1Title" class="menutitle" style="background-image: url('skin/images/chapter_open.gif');">Proyecto de Integraci&oacute;n</div>
<div id="menu_selected_1.1" class="selectedmenuitemgroup" style="display: block;">
<div class="menuitem">
<a href="index.html" title="Proyecto de Integraci&oacute;n">&Iacute;ndice</a>
</div>
<div onclick="SwitchMenu('menu_selected_1.1.2', 'skin/')" id="menu_selected_1.1.2Title" class="menutitle" style="background-image: url('skin/images/chapter_open.gif');">Teor&iacute;a</div>
<div id="menu_selected_1.1.2" class="selectedmenuitemgroup" style="display: block;">
<div class="menuitem">
<a href="sesion01-apuntes.html" title="Sesi&oacute;n 1: Caso de estudio">Sesi&oacute;n 1</a>
</div>
<div class="menuitem">
<a href="sesion02-apuntes.html" title="Sesi&oacute;n 2: DAO con JDBC">Sesi&oacute;n 2</a>
</div>
<div class="menupage">
<div class="menupagetitle">Sesi&oacute;n 3</div>
</div>
<div class="menuitem">
<a href="sesion04-apuntes.html" title="Sesi&oacute;n 4: Aplicaci&oacute;n web con servlets y JSPs">Sesi&oacute;n 4</a>
</div>
<div class="menuitem">
<a href="sesion0506-apuntes.html" title="Sesiones 5 y 6: Aplicaci&oacute;n web con Struts">Sesi&oacute;n 5-6</a>
</div>
<div class="menuitem">
<a href="sesion07-apuntes.html" title="Sesi&oacute;n 7: Aplicaci&oacute;n web con Hibernate">Sesi&oacute;n 7</a>
</div>
<div class="menuitem">
<a href="sesion08-apuntes.html" title="Sesi&oacute;n 8: Proyecto web">Sesi&oacute;n 8</a>
</div>
<div class="menuitem">
<a href="sesion09-apuntes.html" title="Sesi&oacute;n 9: Spring">Sesi&oacute;n 9</a>
</div>
<div class="menuitem">
<a href="sesion10-apuntes.html" title="Sesi&oacute;n 10: Servidores de aplicaciones">Sesi&oacute;n 10</a>
</div>
<div class="menuitem">
<a href="sesion11-apuntes.html" title="Sesi&oacute;n 11: Componentes EJB">Sesi&oacute;n 11</a>
</div>
<div class="menuitem">
<a href="sesion12-apuntes.html" title="Sesi&oacute;n 12: Mensajes: JMS">Sesi&oacute;n 12</a>
</div>
<div class="menuitem">
<a href="sesion13-apuntes.html" title="Sesi&oacute;n 13: Servicios Web">Sesi&oacute;n 13</a>
</div>
<div class="menuitem">
<a href="sesion14-apuntes.html" title="Sesi&oacute;n 14: Proyecto Enterprise">Sesi&oacute;n 14</a>
</div>
</div>
</div>
<div id="credit"></div>
<div id="roundbottom">
<img style="display: none" class="corner" height="15" width="15" alt="" src="skin/images/rc-b-l-15-1body-2menu-3menu.png"></div>
<div id="credit2"></div>
</div>
<div id="content">
<div title="Portable Document Format" class="pdflink">
<a class="dida" href="sesion03-apuntes.pdf"><img alt="PDF -icon" src="skin/images/pdfdoc.gif" class="skin"><br>
        PDF</a>
</div>
<h1>Aplicaci&oacute;n web con servlets</h1>
<div id="minitoc-area">
<ul class="minitoc">
<li>
<a href="#Introducci%C3%B3n">Introducci&oacute;n</a>
</li>
<li>
<a href="#Creaci%C3%B3n+del+proyecto+web">Creaci&oacute;n del proyecto web</a>
</li>
<li>
<a href="#Configurar+el+pooling+de+conexiones">Configurar el pooling de conexiones</a>
</li>
<li>
<a href="#Fichero+Ant+para+el+nuevo+proyecto">Fichero Ant para el nuevo proyecto</a>
</li>
<li>
<a href="#Acciones+a+realizar">Acciones a realizar</a>
</li>
<li>
<a href="#Servlets+a+desarrollar">Servlets a desarrollar</a>
<ul class="minitoc">
<li>
<a href="#Servlet+para+acciones+sobre+usuarios">Servlet para acciones sobre usuarios</a>
</li>
<li>
<a href="#Servlet+para+acciones+sobre+libros">Servlet para acciones sobre libros</a>
</li>
<li>
<a href="#Servlet+para+acciones+sobre+operaciones">Servlet para acciones sobre operaciones</a>
</li>
<li>
<a href="#Estructura+general+de+cada+servlet">Estructura general de cada servlet</a>
</li>
<li>
<a href="#Consideraciones+sobre+el+paso+de+par%C3%A1metros">Consideraciones sobre el paso de par&aacute;metros</a>
<ul class="minitoc">
<li>
<a href="#Ejemplo+de+formulario+para+la+parte+cliente">Ejemplo de formulario para la parte cliente</a>
</li>
</ul>
</li>
<li>
<a href="#Logging">Logging</a>
</li>
</ul>
</li>
</ul>
</div>


<a name="N1000C"></a><a name="Introducci%C3%B3n"></a>
<h2 class="underlined_10">Introducci&oacute;n</h2>
<div class="section">
<p>En esta sesi&oacute;n de integraci&oacute;n incorporaremos la estructura de clases (<em>TransferObjects</em>) y los <em>DAOs</em> implementados en las sesiones anteriores, a una aplicaci&oacute;n web din&aacute;mica que, mediante servlets que utilicen estas clases previas, aportar&aacute;n todas las funcionalidades de los DAOs a la aplicaci&oacute;n web. </p>
</div>


<a name="N1001C"></a><a name="Creaci%C3%B3n+del+proyecto+web"></a>
<h2 class="underlined_10">Creaci&oacute;n del proyecto web</h2>
<div class="section">
<p>En primer lugar, vamos a crear un proyecto web din&aacute;mico (<em>New - Dynamic Web Project</em>), llamado <strong><span class="codefrag">proy-int-web</span></strong>. Dejamos que cree las carpetas por defecto <span class="codefrag">WebContent</span> (donde pondremos nuestras p&aacute;ginas HTML y JSP, aparte de librer&iacute;as, <span class="codefrag">web.xml</span> y dem&aacute;s), y <span class="codefrag">src</span> (donde pondremos nuestros servlets y otras clases), y <span class="codefrag">build</span> (para compilar y unir toda la aplicaci&oacute;n antes de desplegar o empaquetar). Como nombre de contexto, le pondremos tambi&eacute;n <strong><span class="codefrag">proy-int-web</span></strong>.</p>
<p>
<img alt="Los dos proyectos coexistiendo" content-width="5cm" src="imagenes/s3/proyref.jpg" width="249"></p>
<p>Aparte, creamos <strong>dos carpetas fuentes</strong>, que utilizaremos m&aacute;s adelante, <strong><span class="codefrag">resources</span></strong> y <strong><span class="codefrag">test</span></strong>.</p>
<p>Despu&eacute;s, tenemos que enlazar este proyecto web con el proyecto <span class="codefrag">proy-int-comun</span> que tenemos de sesiones anteriores. Para eso, seguimos los pasos:</p>
<ul>
	
<li>
		Vamos a las <em>Properties</em> del nuevo proyecto, y en su <em>Build Path</em> a&ntilde;adimos el proyecto <span class="codefrag">proy-int-comun</span> en la pesta&ntilde;a <em>Projects</em>.
		<p>
<img alt="Relacionar el proyecto Java con el proyecto web" content-width="11cm" src="imagenes/s3/relproyectos.jpg" width="588"></p>
	
</li>
	
<li>Copiamos los ficheros JAR que necesitemos (de momento, las librer&iacute;as de <span class="codefrag">commons-logging</span> y <span class="codefrag">log4j</span>) a <span class="codefrag">WebContent/WEB-INF/lib</span>
</li>
	
<li>
		Volvemos a <em>Properties</em> del proyecto web, y en <em>J2EE Module Dependencies</em> marcamos el proyecto anterior, <span class="codefrag">proy-int-comun</span>.
		<p>
<img alt="Dependencias entre m&oacute;dulos" content-width="11cm" src="imagenes/s3/moddep.jpg" width="578"></p>
	
</li>

</ul>
</div>


<a name="N1008F"></a><a name="Configurar+el+pooling+de+conexiones"></a>
<h2 class="underlined_10">Configurar el pooling de conexiones</h2>
<div class="section">
<p>En las sesiones de integraci&oacute;n anteriores obten&iacute;amos una <span class="codefrag">Connection</span> simple, a trav&eacute;s de un <span class="codefrag">DriverManager</span>, en el m&eacute;todo <span class="codefrag">createConnection</span> de la clase <span class="codefrag">es.ua.jtech.proyint.dao.FactoriaFuenteDatos</span>. Ahora que vamos a pasar a aplicaci&oacute;n web, vamos a mejorar el rendimiento, accediendo al pooling de conexiones que nos ofrece Tomcat. Para ello, introduciremos los siguientes cambios:</p>
<ul>
		
<li>Creamos un fichero <span class="codefrag">context.xml</span> en la carpeta <span class="codefrag">META-INF</span> de nuestro proyecto web, donde definiremos las caracter&iacute;sticas del pooling:
			<pre class="code">&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;Context&gt;
    &lt;Resource
        name="jdbc/biblioteca"
        type="javax.sql.DataSource"
        auth="Container"
        username="root"
        password=""
        driverClassName="com.mysql.jdbc.Driver"
        url="jdbc:mysql://localhost:3306/biblioteca?autoReconnect=true"/&gt;
            
        &lt;ResourceParams name="miBD"&gt;
            
            &lt;parameter&gt;
                &lt;name&gt;maxActive&lt;/name&gt;
                &lt;value&gt;20&lt;/value&gt;
            &lt;/parameter&gt;
            
            &lt;parameter&gt;
                &lt;name&gt;maxIdle&lt;/name&gt;
                &lt;value&gt;5&lt;/value&gt;
            &lt;/parameter&gt;
            
            &lt;parameter&gt;
                &lt;name&gt;maxWait&lt;/name&gt;
                &lt;value&gt;10000&lt;/value&gt;
            &lt;/parameter&gt;
            
        &lt;/ResourceParams&gt;

&lt;/Context&gt;</pre>
		
</li>
		
<li>
			Modificar el fichero <span class="codefrag">web.xml</span> de la aplicaci&oacute;n para que referencie al recurso creado en el paso anterior. Para eso, a&ntilde;adimos estas l&iacute;neas:
			<pre class="code">&lt;resource-ref&gt;
	&lt;res-ref-name&gt;jdbc/biblioteca&lt;/res-ref-name&gt;
	&lt;res-type&gt;javax.sql.DataSource&lt;/res-type&gt;
	&lt;res-auth&gt;Container&lt;/res-auth&gt;
&lt;/resource-ref&gt;</pre>
		
</li>
		
<li>
			Finalmente, tenemos que retocar el m&eacute;todo <span class="codefrag">createConnection</span> de la clase <span class="codefrag">es.ua.jtech.proyint.dao.FactoriaFuenteDatos</span> del proyecto <span class="codefrag">proy-int-comun</span> anterior, y sustituir la l&iacute;nea:
			<pre class="code">conn = DriverManager.getConnection("jdbc:mysql://localhost/biblioteca", "root", "");</pre>
			por estas l&iacute;neas:
			<pre class="code">Context initCtx = new InitialContext();
Context envCtx = (Context) initCtx.lookup("java:comp/env");
DataSource ds = (DataSource)envCtx.lookup("jdbc/biblioteca");	
conn = ds.getConnection();</pre>
			Deberemos importar, para ello, los paquetes <span class="codefrag">javax.naming.*</span> y <span class="codefrag">javax.sql.*</span>.
		</li>
	
</ul>
</div>


<a name="N100D9"></a><a name="Fichero+Ant+para+el+nuevo+proyecto"></a>
<h2 class="underlined_10">Fichero Ant para el nuevo proyecto</h2>
<div class="section">
<p>Aparte de hacer las pruebas desde WebTools, tambi&eacute;n necesitamos tener un fichero Ant que nos permita, una vez finalizado, poder desplegar y/o empaquetar definitivamente nuestra aplicaci&oacute;n web. Para ello, a&ntilde;adiremos un fichero <span class="codefrag">build.xml</span> en la ra&iacute;z del proyecto web, con un contenido como el siguiente:</p>
<pre class="code">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project basedir="." default="build" name="proy-int-web"&gt;

	&lt;property name="proy-int-comun.location" value="../proy-int-comun" /&gt;
	&lt;property name="proy-int-web.location" value="." /&gt;

	&lt;!-- propiedades relativas a Tomcat --&gt;
	&lt;property name="tomcat.home" value="C:/Archivos de programa/Apache Software Foundation/Tomcat 5.5" /&gt;
	&lt;property name="lib.home" value="${proy-int-web.location}/WebContent/WEB-INF/lib/" /&gt;

	&lt;!-- subdirectorios del proyecto --&gt;
	&lt;property name="build.home" value="build" /&gt;
	&lt;property name="web.home" value="WebContent" /&gt;
	&lt;property name="src.home" value="src" /&gt;
	&lt;property name="test.home" value="test" /&gt;
	&lt;property name="resources.home" value="resources" /&gt;
	&lt;property name="app.name" value="proy-int-web" /&gt;
	&lt;property name="dist.home" value="dist" /&gt;
	&lt;property name="docs.home" value="doc" /&gt;

	&lt;!-- classpath --&gt;
	&lt;path id="project.classpath"&gt;
		&lt;pathelement location="${proy-int-comun.location}/build" /&gt;
		&lt;pathelement location="${proy-int-web.location}/WebContent/WEB-INF/classes" /&gt;
		&lt;fileset dir="${tomcat.home}/common/lib/"&gt;
			&lt;include name="*.jar" /&gt;
		&lt;/fileset&gt;
		&lt;fileset dir="${proy-int-web.location}/WebContent/WEB-INF/lib/"&gt;
			&lt;include name="*.jar" /&gt;
		&lt;/fileset&gt;
	&lt;/path&gt;

	&lt;target name="init"&gt;
		&lt;mkdir dir="${dist.home}" /&gt;
		&lt;mkdir dir="${build.home}" /&gt;
	&lt;/target&gt;

	&lt;target name="clean"&gt;
		&lt;delete dir="${dist.home}" /&gt;
		&lt;delete dir="${build.home}" /&gt;
	&lt;/target&gt;

	&lt;target name="build" depends="init"&gt;
		&lt;!-- crea estr. de directorios en build --&gt;
		&lt;mkdir dir="${build.home}/WEB-INF" /&gt;
		&lt;mkdir dir="${build.home}/WEB-INF/classes" /&gt;

		&lt;!-- copia web a build --&gt;
		&lt;copy todir="${build.home}"&gt;
			&lt;fileset dir="${web.home}" /&gt;
		&lt;/copy&gt;

		&lt;!-- proyecto SRC --&gt;
		&lt;ant antfile="${proy-int-comun.location}/build.xml" target="dist" inheritAll="false" /&gt;
		&lt;copy todir="${build.home}/WEB-INF/lib" file="${proy-int-comun.location}/dist/proy-int-comun.jar" /&gt;

		&lt;echo message="${ant.project.name}: ${ant.file}" /&gt;
		&lt;javac destdir="${build.home}/WEB-INF/classes"&gt;
			&lt;src path="${resources.home}" /&gt;
			&lt;src path="${src.home}" /&gt;
			&lt;src path="${test.home}" /&gt;
			&lt;classpath refid="project.classpath" /&gt;
		&lt;/javac&gt;

	&lt;/target&gt;

	&lt;!-- deploy, copiando el war a Tomcat  --&gt;
	&lt;target name="deploy" depends="dist"&gt;
		&lt;copy todir="${tomcat.home}/webapps/" file="${dist.home}/${app.name}.war" /&gt;
	&lt;/target&gt;

	&lt;!-- crear el war --&gt;
	&lt;target name="dist" depends="build"&gt;
		&lt;mkdir dir="${dist.home}" /&gt;
		&lt;jar jarfile="${dist.home}/${app.name}.war" basedir="${build.home}" /&gt;
	&lt;/target&gt;

	
&lt;/project&gt;</pre>
</div>


<a name="N100EA"></a><a name="Acciones+a+realizar"></a>
<h2 class="underlined_10">Acciones a realizar</h2>
<div class="section">
<p>De la sesi&oacute;n anterior, tenemos unos objetos DAO que realizan una serie de acciones sobre usuarios (<span class="codefrag">IUsuarioDAO</span> y su implementaci&oacute;n <span class="codefrag">UsuarioJDBCDAO</span>), sobre libros (<span class="codefrag">ILibroDAO</span> y su implementaci&oacute;n <span class="codefrag">LibroJDBCDAO</span>), y sobre operaciones de usuarios con libros (<span class="codefrag">IOperacionDAO</span> y su implementaci&oacute;n <span class="codefrag">OperacionJDBCDAO</span>). Estos objetos, se apoyan para trabajar en sus respectivos <em>TransferObjects</em> (<span class="codefrag">UsuarioTO</span>, <span class="codefrag">LibroTO</span> y <span class="codefrag">OperacionTO</span>, respectivamente) para ciertas operaciones, como por ejemplo, dar de alta un nuevo usuario, libro u operaci&oacute;n, dado el <em>TransferObject</em> correspondiente que almacena sus campos.</p>
<p>Lo que vamos a hacer en esta sesi&oacute;n es incorporar estas clases a la estructura de una aplicaci&oacute;n web donde, mediante p&aacute;ginas HTML/JSP, indicaremos al servidor la operaci&oacute;n que queremos realizar (por ejemplo, dar de alta un nuevo usuario, o listar todos los libros). Estas operaciones ir&aacute;n a parar al servlet encargado de atenderlas (veremos luego qu&eacute; servlets implementar). Dicho servlet utilizar&aacute; las clases auxiliares anteriores (los DAOs y los <em>TransferObjects</em>) para realizar la operaci&oacute;n, y luego mostrar un resultado (una p&aacute;gina HTML generada por &eacute;l mismo, con el resultado de la operaci&oacute;n).</p>
<p>Recopilando las acciones que realizan los DAOs implementados contra la base de datos, tenemos las siguientes:</p>
<ul>
	
<li>Para un <strong>usuario</strong>:
	<ul>
		
<li>Obtener los datos de un usuario (un objeto <span class="codefrag">UsuarioTO</span>) dados su login y password</li>
		
<li>Dar de alta en la base de datos a un usuario, dado el objeto <span class="codefrag">UsuarioTO</span> que contiene dichos datos</li>
		
<li>Eliminar de la base de datos a un usuario, dado el objeto <span class="codefrag">UsuarioTO</span> con sus datos</li>
		
<li>Obtener una lista de objetos <span class="codefrag">UsuarioTO</span>, con los datos de todos los usuarios de la base de datos</li>
	
</ul>
	
</li>
	
<li>Para un <strong>libro</strong>:
	<ul>
		
<li>Obtener los datos de un libro (un objeto <span class="codefrag">LibroTO</span>) dado su isbn</li>
		
<li>Dar de alta en la base de datos un libro, dado el objeto <span class="codefrag">LibroTO</span> que contiene dichos datos</li>
		
<li>Eliminar de la base de datos un libro, dado el objeto <span class="codefrag">LibroTO</span> con sus datos</li>
		
<li>Obtener una lista de objetos <span class="codefrag">LibroTO</span>, con los datos de todos los libros de la base de datos</li>
	
</ul>
	
</li>
	
<li>Para una <strong>operaci&oacute;n</strong>:
	<ul>
		
<li>Dados un usuario (con un objeto <span class="codefrag">UsuarioTO</span>) y un libro (con un objeto <span class="codefrag">LibroTO</span>), realizar la reserva del libro por parte del usuario</li>
	
</ul>
	
</li>

</ul>
<p>Es <strong>IMPORTANTE</strong> tener en cuenta que, para que todo esto funcione de la forma m&aacute;s modular posible, necesitamos tener una clase <span class="codefrag">es.ua.jtech.proyint.dao.FactoriaDAOs</span>, de la sesi&oacute;n anterior. Esta clase ser&aacute; la que nos proporcione el "puente" para acceder desde los servlets a los DAOs, y desde los DAOs a las operaciones que queramos realizar. Por ejemplo, para sacar un listado de todos los libros de la biblioteca, har&iacute;amos, desde el servlet, lo siguiente:</p>
<pre class="code">FactoriaDAOs fd = FactoriaDAOs.getInstance();
ILibroDAO il = fd.getLibroDAO();
List&lt;LibroTO&gt; lista = il.getAllLibros();
<em>...// y luego recorrer la lista y mostrarla</em>
</pre>
<p>Como puede verse, el esquema a seguir es que el servlet obtenga la factor&iacute;a, &eacute;sta le proporcione el interfaz DAO que necesite (<span class="codefrag">ILibroDAO</span>, en este caso), y con dicho interfaz, llamar al m&eacute;todo o m&eacute;todos necesarios para completar la operaci&oacute;n.</p>
</div>


<a name="N1018A"></a><a name="Servlets+a+desarrollar"></a>
<h2 class="underlined_10">Servlets a desarrollar</h2>
<div class="section">
<p>Vamos a desarrollar un servlet para atender las peticiones de cada DAO. Dicho servlet recibir&aacute; un par&aacute;metro llamado <strong>accion</strong>, que identificar&aacute; la acci&oacute;n a realizar para ese DAO (por ejemplo, si es un libro, el par&aacute;metro <em>accion</em> indicar&aacute; si queremos sacar un listado, o dar de alta un libro, o borrarlo... etc).</p>
<p>Antes de nada, creamos en la carpeta <span class="codefrag">src</span> un paquete <strong><span class="codefrag">es.ua.jtech.proyint.servlet.accion</span></strong>, donde iremos colocando nuestros servlets</p>
<a name="N101A3"></a><a name="Servlet+para+acciones+sobre+usuarios"></a>
<h3 class="underlined_5">Servlet para acciones sobre usuarios</h3>
<p>Crearemos un servlet en el paquete anterior, llamado <strong><span class="codefrag">UsuarioServlet</span></strong>, que para cada petici&oacute;n que le llegue:</p>
<ul>
		
<li>Distinguir&aacute; el par&aacute;metro <span class="codefrag">accion</span> de la petici&oacute;n:</li>
		
<li>Si la acci&oacute;n es <strong><span class="codefrag">seleccionar</span></strong>, llamar&aacute; al m&eacute;todo <span class="codefrag">selectUsuario</span> del DAO de usuarios (pas&aacute;ndole como par&aacute;metros el login y password del usuario a buscar, que le llegar&aacute;n en la petici&oacute;n). Lo que se obtenga como resultado (un objeto <span class="codefrag">UsuarioTO</span>, si todo ha ido bien), se mostrar&aacute; en una p&aacute;gina generada por el propio servlet</li>
		
<li>Si la acci&oacute;n es <strong><span class="codefrag">insertar</span></strong>, llamar&aacute; al m&eacute;todo <span class="codefrag">addUsuario</span> del DAO de usuarios (pas&aacute;ndole como par&aacute;metros un objeto <span class="codefrag">UsuarioTO</span> con los datos del usuario a insertar, que le llegar&aacute;n en la petici&oacute;n). Si la operaci&oacute;n se pudo realizar, generar&aacute; una p&aacute;gina con un mensaje de OK, y si no, otra p&aacute;gina con un mensaje de error.</li>
		
<li>Si la acci&oacute;n es <strong><span class="codefrag">borrar</span></strong>, llamar&aacute; al m&eacute;todo <span class="codefrag">delUsuario</span> del DAO de usuarios (pas&aacute;ndole como par&aacute;metros un objeto <span class="codefrag">UsuarioTO</span> con los datos del usuario a borrar, que le llegar&aacute;n en la petici&oacute;n). Si la operaci&oacute;n se pudo realizar, generar&aacute; una p&aacute;gina con un mensaje de OK, y si no, otra p&aacute;gina con un mensaje de error.</li>
		
<li>Si la acci&oacute;n es <strong><span class="codefrag">listar</span></strong>, llamar&aacute; al m&eacute;todo <span class="codefrag">getAllUsuarios</span> del DAO de usuarios y generar&aacute; una p&aacute;gina con los datos de cada usuario (recorriendo la lista de objetos <span class="codefrag">UsuarioTO</span> que le devolver&aacute; el m&eacute;todo)</li>
	
</ul>
<a name="N101EE"></a><a name="Servlet+para+acciones+sobre+libros"></a>
<h3 class="underlined_5">Servlet para acciones sobre libros</h3>
<p>Crearemos otro servlet en el paquete anterior, llamado <strong><span class="codefrag">LibroServlet</span></strong>, que para cada petici&oacute;n que le llegue:</p>
<ul>
		
<li>Distinguir&aacute; el par&aacute;metro <span class="codefrag">accion</span> de la petici&oacute;n:</li>
		
<li>Si la acci&oacute;n es <strong><span class="codefrag">seleccionar</span></strong>, llamar&aacute; al m&eacute;todo <span class="codefrag">selectLibro</span> del DAO de libros (pas&aacute;ndole como par&aacute;metro el isbn del libro, que le llegar&aacute;n en la petici&oacute;n). Lo que se obtenga como resultado (un objeto <span class="codefrag">LibroTO</span>, si todo ha ido bien), se mostrar&aacute; en una p&aacute;gina generada por el propio servlet</li>
		
<li>Si la acci&oacute;n es <strong><span class="codefrag">insertar</span></strong>, llamar&aacute; al m&eacute;todo <span class="codefrag">addLibro</span> del DAO de libros (pas&aacute;ndole como par&aacute;metros un objeto <span class="codefrag">LibroTO</span> con los datos del libro a insertar, que le llegar&aacute;n en la petici&oacute;n). Si la operaci&oacute;n se pudo realizar, generar&aacute; una p&aacute;gina con un mensaje de OK, y si no, otra p&aacute;gina con un mensaje de error.</li>
		
<li>Si la acci&oacute;n es <strong><span class="codefrag">borrar</span></strong>, llamar&aacute; al m&eacute;todo <span class="codefrag">delLibro</span> del DAO de libros (pas&aacute;ndole como par&aacute;metros un objeto <span class="codefrag">LibroTO</span> con los datos del libro a borrar, que le llegar&aacute;n en la petici&oacute;n). Si la operaci&oacute;n se pudo realizar, generar&aacute; una p&aacute;gina con un mensaje de OK, y si no, otra p&aacute;gina con un mensaje de error.</li>
		
<li>Si la acci&oacute;n es <strong><span class="codefrag">listar</span></strong>, llamar&aacute; al m&eacute;todo <span class="codefrag">getAllLibros</span> del DAO de libros y generar&aacute; una p&aacute;gina con los datos de cada libro (recorriendo la lista de objetos <span class="codefrag">LibroTO</span> que le devolver&aacute; el m&eacute;todo)</li>
	
</ul>
<a name="N10239"></a><a name="Servlet+para+acciones+sobre+operaciones"></a>
<h3 class="underlined_5">Servlet para acciones sobre operaciones</h3>
<p>Crearemos un tercer servlet en el paquete anterior, llamado <strong><span class="codefrag">OperacionServlet</span></strong>, que para cada petici&oacute;n que le llegue:</p>
<ul>
		
<li>Distinguir&aacute; el par&aacute;metro <span class="codefrag">accion</span> de la petici&oacute;n (aunque s&oacute;lo hay una acci&oacute;n en el DAO, lo dejaremos abierto por si luego hay que a&ntilde;adir m&aacute;s):</li>
		
<li>Si la acci&oacute;n es <strong><span class="codefrag">reservar</span></strong>, llamar&aacute; al m&eacute;todo <span class="codefrag">realizaReserva</span> del DAO de operaciones (pas&aacute;ndole como par&aacute;metro el usuario (<span class="codefrag">UsuarioTO</span>), el libro (<span class="codefrag">LibroTO</span>), y las fechas de inicio y fin, que le vendr&aacute;n en la petici&oacute;n). Si la operaci&oacute;n se pudo realizar, generar&aacute; una p&aacute;gina con un mensaje de OK, y si no, otra p&aacute;gina con un mensaje de error.</li>
	
</ul>
<a name="N10260"></a><a name="Estructura+general+de+cada+servlet"></a>
<h3 class="underlined_5">Estructura general de cada servlet</h3>
<p>Cada servlet tendr&aacute; sus m&eacute;todos <span class="codefrag">doGet</span> y <span class="codefrag">doPost</span> (este &uacute;ltimo llamar&aacute; a <span class="codefrag">doGet</span> directamente). Despu&eacute;s, en <span class="codefrag">doGet</span> distinguiremos el par&aacute;metro <span class="codefrag">accion</span>, y en funci&oacute;n de eso, llamaremos a uno u otro m&eacute;todo privado de la clase, que se encargar&aacute; de terminar la acci&oacute;n. Por ejemplo, para el caso del libro:</p>
<pre class="code">public class LibroServlet 
extends javax.servlet.http.HttpServlet 
implements javax.servlet.Servlet 
{

	public LibroServlet() {
		super();
	}   	
	
	public void doGet(HttpServletRequest request, HttpServletResponse response) 
	throws ServletException, IOException 
	{
		String parAccion = request.getParameter("accion");
			
		} else if ("listar".equals(parAccion)) {
			
			// Listado de libros
			listaLibros(request, response);		
			return;	

		} else if ("seleccionar".equals(parAccion)) {
			
			// Seleccion de un libro
			seleccionaLibro(request, response);	
			return;		

		} else if ("insertar".equals(parAccion)) {
			
			// Insercion de un libro
			insertaLibro(request, response);
			return;			

		} else if ("borrar".equals(parAccion)) {
			
			// Borrado de un libro
			borraLibro(request, response);
			return;
						
		} else {
		
			generaPagina("&lt;h2&gt;Comando no valido&lt;/h2&gt;", response);
			return;
		}
	}</pre>
<p>donde <span class="codefrag">listaLibros, seleccionaLibro, insertaLibro, borraLibro</span> son m&eacute;todos que deber&eacute;is implementar, y cada uno har&aacute; la operaci&oacute;n indicada, tomando del request los datos que necesite, y enviando en el response la respuesta indicada. Por ejemplo, para la acci&oacute;n de listar todos los libros, el m&eacute;todo <span class="codefrag">listaLibros</span> podr&iacute;a ser algo como:</p>
<pre class="code">private void listaLibros(HttpServletRequest request, HttpServletResponse response)
{
	String contenido = "";
	FactoriaDAOs fd = FactoriaDAOs.getInstance();
	ILibroDAO il = fd.getLibroDAO();
	List&lt;LibroTO&gt; lista = null;
	try
	{
		lista = il.getAllLibros();
		if (lista != null)
		{
			contenido = "&lt;ul&gt;";
			for (int i = 0; i &lt; lista.size(); i++)
			{
				LibroTO libro = lista.get(i);
				contenido += "&lt;li&gt;" + 
							 libro.getIsbn() + "-" + 
							 libro.getTitulo() + "-" + 
							 libro.getAutor() + "-" + 
							 libro.getNumPaginas() + " pags.&lt;/li&gt;";
			}
			contenido += "&lt;/ul&gt;";
			generaPagina(contenido, response);
			return;
		} else {
			generaPagina("&lt;h2&gt;No se encontraron resultados&lt;/h2&gt;", response);
		}
	} catch (Exception ex) {
		generaPagina("&lt;h2&gt;Error recuperando listado&lt;/h2&gt;", response);
		return;
	}
	
}</pre>
<p>El m&eacute;todo <span class="codefrag">generaPagina</span> nos servir&aacute; para generar la respuesta (la p&aacute;gina de respuesta), ya sea un resultado a devolver, o un mensaje de error. A este m&eacute;todo le pasamos un texto a mostrar, y el objeto <span class="codefrag">response</span>, y generar&aacute; una p&aacute;gina en el <span class="codefrag">response</span> con el texto que le indiquemos.</p>
<p>Con todo esto, la estructura que nos quedar&aacute; para cada servlet (en este caso, el <span class="codefrag">LibroServlet</span>) ser&aacute; algo parecido a:</p>
<p>
<img alt="Estructura de m&eacute;todos de cada servlet" content-width="9cm" src="imagenes/s3/estservlets.jpg" width="456"></p>
<a name="N102A3"></a><a name="Consideraciones+sobre+el+paso+de+par%C3%A1metros"></a>
<h3 class="underlined_5">Consideraciones sobre el paso de par&aacute;metros</h3>
<p>Algunas operaciones (como por ejemplo dar de alta un usuario, o borrar un libro, o realizar una reserva, entre otras) necesitan que se les pase objetos complejos (<span class="codefrag">UsuarioTO, LibroTO</span>...). Sin embargo, este tipo de objetos no podemos pasarlos en una petici&oacute;n desde un navegador. Lo que haremos ser&aacute;:</p>
<ul>
			
<li>Si queremos <strong>dar de alta un libro o un usuario</strong>, en la petici&oacute;n le pasaremos, por separado, todos los campos necesarios para, en el servlet, construir el objeto <span class="codefrag">UsuarioTO</span> o <span class="codefrag">LibroTO</span> correspondiente, y poder llamar as&iacute; al m&eacute;todo del DAO asociado (<span class="codefrag">addUsuario</span> o <span class="codefrag">addLibro</span>, seg&uacute;n el caso).</li>
			
<li>Si queremos <strong>borrar un libro o un usuario</strong>, simplemente le pasaremos su isbn, o su login y password, respectivamente. El servlet se encargar&aacute; de consultar con la BD (llamando al m&eacute;todo <span class="codefrag">selectUsuario</span> o <span class="codefrag">selectLibro</span> correspondiente), construir el objeto TO correspondiente, y pas&aacute;rselo al m&eacute;todo <span class="codefrag">delUsuario</span> o <span class="codefrag">delLibro</span>.</li>
			
<li>Si queremos <strong>realizar una reserva</strong>, le pasaremos en la petici&oacute;n el isbn del libro, login y password del usuario, y las fechas de inicio y fin. Con estos campos el servlet deber&aacute; construir los objetos <span class="codefrag">UsuarioTO</span> y <span class="codefrag">LibroTO</span>, y llamar al m&eacute;todo <span class="codefrag">realizaReserva</span>
</li>
			
<li>Para el <strong>resto de operaciones (seleccionar un usuario o un libro, o listar todos los usuarios o libros)</strong>, ya no hay que pasar campos, o los que hay que pasar a los m&eacute;todos del DAO ya son campos simples (el login y password del usuario, o el isbn del libro, respectivamente), y se pueden enviar en la petici&oacute;n sin problemas.</li>
		
</ul>
<a name="N102EA"></a><a name="Ejemplo+de+formulario+para+la+parte+cliente"></a>
<h4>Ejemplo de formulario para la parte cliente</h4>
<p>En la sesi&oacute;n de integraci&oacute;n de JSP se elaborar&aacute;n las p&aacute;ginas para enviar comandos a la biblioteca desde el cliente, y para mostrar los resultados desde el servidor. Hasta entonces, para simplificar y poder probar el funcionamiento de los servlets, podemos hacer varios formularios en una p&aacute;gina <strong><span class="codefrag">index.html</span></strong>, uno por cada operaci&oacute;n que queramos probar, y lanzar uno u otro seg&uacute;n lo que queramos hacer.</p>
<p>Por ejemplo, este formulario nos servir&iacute;a para sacar los datos de un usuario dado su login y password (primer formulario), y para listar todos los libros (segundo formulario):</p>
<pre class="code">&lt;html&gt;
&lt;body&gt;
&lt;table width="80%" border="1"&gt;
	&lt;tr&gt;
		&lt;td&gt;
		&lt;form action="servlet/es.ua.jtech.proyint.servlet.accion.UsuarioServlet"&gt;
		&lt;input type="hidden" name="accion" value="seleccionar" /&gt;
		&lt;strong&gt;Seleccionar usuario:&lt;/strong&gt;&lt;br /&gt;
		Login:&lt;input type="text" name="login" value="" size="10" /&gt;&lt;br /&gt;
		Password:&lt;input type="text" name="password" value="" size="10" /&gt;&lt;br /&gt;
		&lt;input type="submit" value="Ejecutar" /&gt;
		&lt;/form&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td&gt;
		&lt;form action="servlet/es.ua.jtech.proyint.servlet.accion.LibroServlet"&gt;
		&lt;input type="hidden" name="accion" value="listar" /&gt;
		&lt;strong&gt;Listar todos los libros:&lt;/strong&gt;&lt;br /&gt;
		&lt;input type="submit" value="Ejecutar" /&gt;
		&lt;/form&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;

&lt;/body&gt;
&lt;/html&gt;</pre>
<div class="frame note">
<div class="label">Importante</div>
<div class="content">En este c&oacute;digo fuente, para mayor claridad, se ha dejado en el <em>action</em> de cada formulario una llamada directa al servlet, poniendo el nombre de su clase, para dar a entender que el formulario llamar&aacute; al servlet concreto que necesite. Se recomienda que, en la pr&aacute;ctica, cambiemos esto por un nombre alternativo (etiqueta <span class="codefrag">servlet-name</span> en <span class="codefrag">web.xml</span>).</div>
</div>
<a name="N1030D"></a><a name="Logging"></a>
<h3 class="underlined_5">Logging</h3>
<p>Finalmente, a&ntilde;ade en cada servlet mensajes de log (del tipo adecuado) para advertir del resultado de cada operaci&oacute;n que realizan, y de los errores que puedan producirse. Estos mensajes pueden ir colocados, por comodidad, en cada uno de los m&eacute;todos privados que atienden cada tipo de comando en cada servlet.</p>
<p>Deber&aacute;s a&ntilde;adir los ficheros <span class="codefrag">properties</span> necesarios en la carpeta fuente <span class="codefrag">resources</span>.</p>
<p>Los mensajes de log deber&aacute;n guardarse en un fichero <span class="codefrag">proy-int-web.log</span> en una carpeta <span class="codefrag">logs</span> dentro del proyecto web, mediante un <span class="codefrag">DailyRollingFileAppender</span> con periodicidad diaria (como en <span class="codefrag">proy-int-comun</span>).</p>
</div>


<p class="pageBreakAfter"></p>


</div>
<div class="clearboth">&nbsp;</div>
</div>
<div id="footer">
<div class="lastmodified">
<script type="text/javascript"><!--
document.write("<text>Last Published:</text> " + document.lastModified);
//  --></script>
</div>
<div class="copyright">
        Copyright &copy;
         2006-2007 Depto. CCIA</div>
</div>
</body>
</html>
