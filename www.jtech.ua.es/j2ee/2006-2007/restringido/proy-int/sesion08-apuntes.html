<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta content="Apache Forrest" name="Generator">
<meta name="Forrest-version" content="0.7">
<meta name="Forrest-skin-name" content="pelt">
<title>Proyecto Web</title>
<link type="text/css" href="skin/basic.css" rel="stylesheet">
<link media="screen" type="text/css" href="skin/screen.css" rel="stylesheet">
<link media="print" type="text/css" href="skin/print.css" rel="stylesheet">
<link type="text/css" href="skin/profile.css" rel="stylesheet">
<script src="skin/getBlank.js" language="javascript" type="text/javascript"></script><script src="skin/getMenu.js" language="javascript" type="text/javascript"></script><script src="skin/fontsize.js" language="javascript" type="text/javascript"></script>
<link rel="shortcut icon" href="">
</head>
<body onload="init()">
<script type="text/javascript">ndeSetTextSize();</script>
<div id="top">
<div class="header">
<div class="grouplogo">
<a href="http://www.jtech.ua.es/j2ee"><img class="logoImage" alt="J2EE" src="images/baner_j2ee_izq.gif" title="Curso Especialista Universitario en Java Enterprise"></a>
</div>
<div class="projectlogoA1">
<a href="http://www.dccia.ua.es/"><img class="logoImage" alt="Proyecto de Integracion" src="images/baner_j2ee_der.gif" title="Proyecto de Integracion"></a>
</div>
<ul id="tabs">
<li>
<a class="base-not-selected" href="../index.html">M&oacute;dulos</a>
</li>
<li class="current">
<a class="base-selected" href="index.html">Proyecto de Integraci&oacute;n</a>
</li>
</ul>
</div>
</div>
<div id="main">
<div id="publishedStrip">
<div id="level2tabs"></div>
<script type="text/javascript"><!--
document.write("<text>Last Published:</text> " + document.lastModified);
//  --></script>
</div>
<div class="breadtrail">
             
             &nbsp;
           </div>
<div id="menu">
<div onclick="SwitchMenu('menu_selected_1.1', 'skin/')" id="menu_selected_1.1Title" class="menutitle" style="background-image: url('skin/images/chapter_open.gif');">Proyecto de Integraci&oacute;n</div>
<div id="menu_selected_1.1" class="selectedmenuitemgroup" style="display: block;">
<div class="menuitem">
<a href="index.html" title="Proyecto de Integraci&oacute;n">&Iacute;ndice</a>
</div>
<div onclick="SwitchMenu('menu_selected_1.1.2', 'skin/')" id="menu_selected_1.1.2Title" class="menutitle" style="background-image: url('skin/images/chapter_open.gif');">Teor&iacute;a</div>
<div id="menu_selected_1.1.2" class="selectedmenuitemgroup" style="display: block;">
<div class="menuitem">
<a href="sesion01-apuntes.html" title="Sesi&oacute;n 1: Caso de estudio">Sesi&oacute;n 1</a>
</div>
<div class="menuitem">
<a href="sesion02-apuntes.html" title="Sesi&oacute;n 2: DAO con JDBC">Sesi&oacute;n 2</a>
</div>
<div class="menuitem">
<a href="sesion03-apuntes.html" title="Sesi&oacute;n 3: Aplicaci&oacute;n web con servlets">Sesi&oacute;n 3</a>
</div>
<div class="menuitem">
<a href="sesion04-apuntes.html" title="Sesi&oacute;n 4: Aplicaci&oacute;n web con servlets y JSPs">Sesi&oacute;n 4</a>
</div>
<div class="menuitem">
<a href="sesion0506-apuntes.html" title="Sesiones 5 y 6: Aplicaci&oacute;n web con Struts">Sesi&oacute;n 5-6</a>
</div>
<div class="menuitem">
<a href="sesion07-apuntes.html" title="Sesi&oacute;n 7: Aplicaci&oacute;n web con Hibernate">Sesi&oacute;n 7</a>
</div>
<div class="menupage">
<div class="menupagetitle">Sesi&oacute;n 8</div>
</div>
<div class="menuitem">
<a href="sesion09-apuntes.html" title="Sesi&oacute;n 9: Spring">Sesi&oacute;n 9</a>
</div>
<div class="menuitem">
<a href="sesion10-apuntes.html" title="Sesi&oacute;n 10: Servidores de aplicaciones">Sesi&oacute;n 10</a>
</div>
<div class="menuitem">
<a href="sesion11-apuntes.html" title="Sesi&oacute;n 11: Componentes EJB">Sesi&oacute;n 11</a>
</div>
<div class="menuitem">
<a href="sesion12-apuntes.html" title="Sesi&oacute;n 12: Mensajes: JMS">Sesi&oacute;n 12</a>
</div>
<div class="menuitem">
<a href="sesion13-apuntes.html" title="Sesi&oacute;n 13: Servicios Web">Sesi&oacute;n 13</a>
</div>
<div class="menuitem">
<a href="sesion14-apuntes.html" title="Sesi&oacute;n 14: Proyecto Enterprise">Sesi&oacute;n 14</a>
</div>
</div>
</div>
<div id="credit"></div>
<div id="roundbottom">
<img style="display: none" class="corner" height="15" width="15" alt="" src="skin/images/rc-b-l-15-1body-2menu-3menu.png"></div>
<div id="credit2"></div>
</div>
<div id="content">
<div title="Portable Document Format" class="pdflink">
<a class="dida" href="sesion08-apuntes.pdf"><img alt="PDF -icon" src="skin/images/pdfdoc.gif" class="skin"><br>
        PDF</a>
</div>
<h1>Proyecto Web</h1>
<div id="minitoc-area">
<ul class="minitoc">
<li>
<a href="#Introducci%C3%B3n">Introducci&oacute;n</a>
</li>
<li>
<a href="#Navegaci%C3%B3n">Navegaci&oacute;n</a>
</li>
<li>
<a href="#Refactorizando+el+Login">Refactorizando el Login</a>
<ul class="minitoc">
<li>
<a href="#P%C3%A1gina+de+login">P&aacute;gina de login</a>
</li>
<li>
<a href="#AccionLogin.java">AccionLogin.java</a>
</li>
<li>
<a href="#Tokens.java">Tokens.java</a>
</li>
<li>
<a href="#struts-config.xml">struts-config.xml</a>
</li>
<li>
<a href="#menu.jsp+-%3E+%2Fjsp%2Fbiblio%2Findex.jsp">menu.jsp -&gt; /jsp/biblio/index.jsp</a>
</li>
</ul>
</li>
<li>
<a href="#Web+del+Administrador">Web del Administrador</a>
<ul class="minitoc">
<li>
<a href="#Listado+de+Usuarios">Listado de Usuarios</a>
<ul class="minitoc">
<li>
<a href="#AccionListarUsuarios.java">AccionListarUsuarios.java</a>
</li>
<li>
<a href="#%2Fjsp%2Fadmin%2FlistadoUsuarios.jsp">/jsp/admin/listadoUsuarios.jsp</a>
</li>
</ul>
</li>
<li>
<a href="#Alta%2FModificaci%C3%B3n+de+Usuario">Alta/Modificaci&oacute;n de Usuario</a>
<ul class="minitoc">
<li>
<a href="#AccionInsertarUsuario.java">AccionInsertarUsuario.java</a>
</li>
<li>
<a href="#AccionSeleccionarUsuario.java">AccionSeleccionarUsuario.java</a>
</li>
<li>
<a href="#AccionModificarUsuario.java">AccionModificarUsuario.java</a>
</li>
</ul>
</li>
<li>
<a href="#struts-config.xml-N10286">struts-config.xml</a>
</li>
</ul>
</li>
<li>
<a href="#Web+del+Bibliotecario">Web del Bibliotecario</a>
<ul class="minitoc">
<li>
<a href="#Listado+de+todos+los+libros">Listado de todos los libros</a>
<ul class="minitoc">
<li>
<a href="#OperacionJDBCDAO.selectTodosLibros%28%29">OperacionJDBCDAO.selectTodosLibros()</a>
</li>
<li>
<a href="#%2Fjsp%2Fbiblio%2FlistadoLibros.jsp">/jsp/biblio/listadoLibros.jsp</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#Capa+de+Negocio">Capa de Negocio</a>
<ul class="minitoc">
<li>
<a href="#IUsuarioBO.java">IUsuarioBO.java</a>
<ul class="minitoc">
<li>
<a href="#UsuarioException.java">UsuarioException.java</a>
</li>
</ul>
</li>
<li>
<a href="#UsuarioBO.java">UsuarioBO.java</a>
</li>
<li>
<a href="#AccionInsertarUsuario.java-N103CB">AccionInsertarUsuario.java</a>
</li>
</ul>
</li>
<li>
<a href="#Reserva+de+un+libro">Reserva de un libro</a>
<ul class="minitoc">
<li>
<a href="#AccionPrepararReserva.java">AccionPrepararReserva.java</a>
</li>
<li>
<a href="#preparaReserva.jsp">preparaReserva.jsp</a>
</li>
<li>
<a href="#AccionReservar.java">AccionReservar.java</a>
</li>
<li>
<a href="#OperacionBO.realizaReserva%28login%2C+isbn%29">OperacionBO.realizaReserva(login, isbn)</a>
<ul class="minitoc">
<li>
<a href="#compruebaCupoOperacion%28login%29">compruebaCupoOperacion(login)</a>
</li>
<li>
<a href="#calculaNumDiasReserva%28login%29">calculaNumDiasReserva(login)</a>
</li>
</ul>
</li>
<li>
<a href="#OperacionJDBCDAO.realizaReserva%28login%2Cisbn%2Cfinicio%2Cffin%29">OperacionJDBCDAO.realizaReserva(login,isbn,finicio,ffin)</a>
</li>
</ul>
</li>
<li>
<a href="#Guia+de+Estilo">Guia de Estilo</a>
</li>
<li>
<a href="#Entrega">Entrega</a>
</li>
</ul>
</div>


<a name="N1000C"></a><a name="Introducci%C3%B3n"></a>
<h2 class="underlined_10">Introducci&oacute;n</h2>
<div class="section">
<p>El objetivo principal de las sesiones del proyecto web es refactorizar la aplicaci&oacute;n de la biblioteca para dotarla de una calidad semejante a la de un proyecto empresarial real. Esto se traduce en un subconjunto de actividades:</p>
<ul>
    
<li>Crear un esquema de navegaci&oacute;n apropiado</li>
    
<li>Crear un interfaz de usuario amigable</li>
    
<li>Aplicar una nomenclatura adecuada a todo el proyecto</li>
    
<li>Uso extensivo de Struts, mediante sus taglibs, gesti&oacute;n de errores, validaciones, etc...</li>
    
<li>Mejorar la calidad del c&oacute;digo implementado</li>
    
<li>Ampliar la bater&iacute;a de pruebas del sistema</li>

</ul>
<div class="frame note">
<div class="label">Aclaraci&oacute;n</div>
<div class="content">
A lo largo de la sesi&oacute;n nos vamos a dedicar a retocar/reescribir c&oacute;digo previamente implementado, pero &iquest;porqu&eacute; no lo hemos hecho bien desde el principio? El planteamiento del supuesto inicial, conjunto al desarrollo incremental de cada sesi&oacute;n, fomenta que cada sesi&oacute;n adopte las necesidades del proyecto a las tecnolog&iacute;as empleadas. Ahora es el momento de rehacer gran parte de la aplicaci&oacute;n y formar una base estable para futuros desarrollos.</div>
</div>
</div>


<a name="N1002F"></a><a name="Navegaci%C3%B3n"></a>
<h2 class="underlined_10">Navegaci&oacute;n</h2>
<div class="section">
<p>El flujo de navegaci&oacute;n de la aplicaci&oacute;n se detalla en el siguiente diagrama:</p>
<p>
    
<img alt="Diagrama de Navegacion" content-width="15cm" src="imagenes/s8/navegacion.gif" width="558">
</p>
<p>Cada una de las siguientes secciones, analizar&aacute; y resolver&aacute; algunas partes de la aplicaci&oacute;n, partiendo de la funcionalidad, interfaz de usuario y calidad del c&oacute;digo. El resto de funcionalidades, quedar&aacute;n como ejercicios.</p>
</div>


<a name="N10045"></a><a name="Refactorizando+el+Login"></a>
<h2 class="underlined_10">Refactorizando el Login</h2>
<div class="section">
<p>Vamos a empezar por la puerta de entrada de la aplicaci&oacute;n. Nuestro departamento de dise&ntilde;o gr&aacute;fico nos ha entregado la siguiente hoja de estilo (la colocaremos en <a href="recursos/s8/css/style.css"><span class="codefrag">WebContent/css/style.css</span></a>) y un conjunto de im&aacute;genes (que colocaremos en la carpeta <a href="recursos/s8/imagenes.zip"><span class="codefrag">WebContent/im&aacute;genes</span></a>). Adem&aacute;s, nos anexan los siguientes pantallazos con la apariencia de la aplicaci&oacute;n:</p>
<ul>
    
<li>Login</li>

</ul>
<p>
    
<img alt="Pantalla de Login" content-width="16cm" src="imagenes/s8/login.jpg" width="632">
</p>
<ul>
    
<li>Web del Bibliotecario</li>

</ul>
<p>
    
<img alt="Web del Bibliotecario" content-width="17cm" src="imagenes/s8/indexBiblio.jpg" width="689">
</p>
<a name="N10076"></a><a name="P%C3%A1gina+de+login"></a>
<h3 class="underlined_5">P&aacute;gina de login</h3>
<p>Esta p&aacute;gina es la puerta de entrada a la aplicaci&oacute;n. La p&aacute;gina ya maquetada y con los taglibs de struts la colocaremos en <a href="http://www.jtech.ua.es/j2ee/2006-2007/restringido/proy-int/recursos/s8/index.jsp"><span class="codefrag">WebContent/index.jsp</span></a>
</p>
<p>Al pulsar a entrar, la p&aacute;gina cede el control al ActionMapping <span class="codefrag">/accionLogin</span>, mapeado con el Action <span class="codefrag">es.ua.jtech.proyint.presentacion.acciones.loginlogout.AccionLogin</span>
</p>
<a name="N1008C"></a><a name="AccionLogin.java"></a>
<h3 class="underlined_5">AccionLogin.java</h3>
<p>La apariencia previa a la refactorizaci&oacute;n del <em>Action</em> es la siguiente:</p>
<pre class="code">
public class AccionLogin extends Action {

    private static Log logger = LogFactory.getLog(AccionLogin.class.getName());
    
    @Override
    public ActionForward execute(ActionMapping mapping, ActionForm form,
            HttpServletRequest request, HttpServletResponse res)
            throws Exception {
    
        <strong>String login = request.getParameter("login");
        String password = request.getParameter("password");</strong>
        
        HttpSession sesion = request.getSession();
        
        FactoriaDAOs fd = FactoriaDAOs.getInstance();
        IUsuarioDAO iu = fd.getUsuarioDAO();
        
        try {
            UsuarioTO usuario = iu.selectUsuario(login, password);
            if (usuario != null) {
                sesion.setAttribute("usuario", usuario);
                <strong>return mapping.findForward("OK");</strong>
                // doForward(request, response, "/jsp/menu.jsp");
            } else {
                <strong>request.setAttribute("error", "El login y/o password no son correctos");
                return mapping.findForward("error");</strong>
                // doForward(request, response, "/index.jsp");
            }
        } catch (Exception e) {
            <strong>logger.error("Login - " + request.getParameter("login") + " - Error haciendo login");
            request.setAttribute("error", "Error al hacer login");
            return mapping.findForward("error");</strong>
        }
    }
}
</pre>
<p>Vamos a cambiar:</p>
<ul>
    
<li>La lectura de par&aacute;metros de la <span class="codefrag">request</span>, por el uso de <span class="codefrag">ActionForms</span>, de modo que evitemos errores de tipograf&iacute;a.</li>
    
<li>El uso de la variable <span class="codefrag">error</span> en la <span class="codefrag">request</span>, por la gesti&oacute;n de <em>Struts</em> de los errores mediante los <span class="codefrag">ActionErrors</span>.</li>
    
<li>La l&oacute;gica de control no esta en este <span class="codefrag">Action</span>, sino que la ha cedido a la vista (en menu.jsp) donde mediante diferentes sentencias condicionales muestra las 3 subaplicaciones de la biblioteca (administraci&oacute;n, bibliotecario y socio).</li>
    
<li>No es recomendable la aparici&oacute;n de m&aacute;s de una sentencia <span class="codefrag">return</span> dentro de un m&eacute;todo, por lo tanto, vamos a unificar los posibles retornos en una variable, la cual devolveremos al final.</li>
    
<li>El uso de cadenas por tokens unificados en un clase <span class="codefrag">Tokens</span>
</li>
    
<li>El mensaje de log no debe indicar la clase en la que se encuentra, ya que eso ya lo realiza el propio framework de <em>log4j</em>
</li>

</ul>
<p>El resultado es el siguiente:</p>
<pre class="code">
public ActionForward execute(ActionMapping mapping, ActionForm form,
        HttpServletRequest request, HttpServletResponse res)
        throws Exception {

    ActionMessages errors = new ActionMessages();
    HttpSession sesion = request.getSession(true);
    String forward = "";

    <strong>LoginForm aForm = (LoginForm) form;</strong>

    FactoriaDAOs fd = FactoriaDAOs.getInstance();
    IUsuarioDAO iu = fd.getUsuarioDAO();

    try {
        UsuarioTO usuario = iu.selectUsuario(aForm.getLogin(), aForm
                .getPassword());
        if (usuario != null) {
            logger.debug("Entra el usuario " + usuario);

            // TODO Crear un objeto contenedor para la sesion
            <span class="codefrag">sesion.setAttribute(Tokens.SES_USUARIO, usuario);</span>

            // Comprobamos a que p&aacute;gina le cedemos el control
            <strong>if ((TipoUsuario.administrador).equals(usuario.getTipo())) {
                forward = Tokens.FOR_ADMIN;
            } else if ((TipoUsuario.bibliotecario)
                    .equals(usuario.getTipo())) {
                forward = Tokens.FOR_BIBLIO;
            } else {
                forward = Tokens.FOR_SOCIO;
            }</strong>

        } else {
            <strong>errors.add(ActionMessages.GLOBAL_MESSAGE, new ActionMessage(
                    Tokens.ERROR_KEY_LOGIN_NO_EXISTE));</strong>
        }
    } catch (DAOException e) {
        <strong>logger.error("Error haciendo login con " + aForm.getLogin());

        errors.add(ActionMessages.GLOBAL_MESSAGE, new ActionMessage(
                Tokens.ERROR_KEY_LOGIN_KO));</strong>
    }

<strong>    ActionForward af = null;
    if (errors.size() &gt; 0) {
        this.saveErrors(request, errors);
        af = mapping.getInputForward();
    } else {
        af = mapping.findForward(forward);
    }

    return af;</strong>
}
</pre>
<div class="frame warning">
<div class="label">Cuidado</div>
<div class="content">Al leer el login/password mediante un ActionForm, debemos crear dicha clase y actualizar la definici&oacute;n del Validator.</div>
</div>
<a name="N100FA"></a><a name="Tokens.java"></a>
<h3 class="underlined_5">Tokens.java</h3>
<p>La clase de Tokens la definimos como una interfaz para que no se pueda instanciar, y que nos permite definir atributos (que al estar en un interfaz, autom&aacute;ticamente se convierten en atributos finales y est&aacute;ticos).</p>
<pre class="code">
public interface Tokens {

	// Sesion
	String SES_USUARIO = "usuario";

	// Request
	String REQ_LOGIN = "login";
	String REQ_PASSWORD = "password";

	// Response
	String RES_USUARIOS = "usuarios";
	String RES_LIBROS = "libros";
	
	// Errores
	String ERROR_KEY_LOGIN_NO_EXISTE = "error.login.noExiste";
	String ERROR_KEY_LOGIN_KO = "error.login.ko";
	String ERROR_KEY_PERMISOS_ADMIN = "error.usuario.permisosAdmin";
	String ERROR_KEY_FALTA_LOGIN = "error.usuario.faltaLogin";
    
    // .....
}
</pre>
<a name="N10108"></a><a name="struts-config.xml"></a>
<h3 class="underlined_5">struts-config.xml</h3>
<p>Tal como hemos comentado, toda la l&oacute;gica de control estaba en el archivo de men&uacute;. Adem&aacute;s, est&aacute;bamos gestionando los errores mediante una variable en la request.</p>
<pre class="code">
&lt;action path="/accionLogin" type="es.ua.jtech.proyint.presentacion.acciones.loginlogout.AccionLogin"&gt;
    &lt;forward name="OK" path="/jsp/menu.jsp"/&gt;
    &lt;forward name="error" path="/index.jsp"/&gt;
&lt;/action&gt;
</pre>
<p>De este modo, la l&oacute;gica de control reside en el controlador, la gesti&oacute;n de errores la implementa <em>Struts</em>, de modo que si se produce un error le redirigimos a la p&aacute;gina de entrada al action, definido por el atributo <span class="codefrag">input</span> del <span class="codefrag">ActionMapping</span>.</p>
<pre class="code">&lt;action path="/accionLogin"
    type="es.ua.jtech.proyint.presentacion.acciones.loginlogout.AccionLogin"
    name="loginForm" scope="request" input="/index.jsp"&gt;
    &lt;forward name="admin" path="/accionListarUsuarios.do" /&gt;
    &lt;forward name="biblio" path="/jsp/biblio/index.jsp" /&gt;
    &lt;forward name="socio" path="/jsp/socio/index.jsp" /&gt;
&lt;/action&gt;
</pre>
<a name="N10126"></a><a name="menu.jsp+-%3E+%2Fjsp%2Fbiblio%2Findex.jsp"></a>
<h3 class="underlined_5">menu.jsp -&gt; /jsp/biblio/index.jsp</h3>
<p>El archivo anterior conten&iacute;a la siguiente l&oacute;gica en la vista:</p>
<pre class="code">
&lt;h1&gt;Men&uacute; principal&lt;/h1&gt;
&lt;c:if test="${empty sessionScope.usuario}"&gt;
	&lt;jsp:forward page="/index.jsp"/&gt;
&lt;/c:if&gt;
&lt;c:if test="${sessionScope.usuario.tipo=='administrador'}"&gt;
....
    &lt;!-- Web del Administrador --&gt;
.....
&lt;/c:if&gt;
&lt;c:if test="${sessionScope.usuario.tipo=='bibliotecario'}"&gt;
....
    &lt;!-- Web del Bibliotecario --&gt;
.....
&lt;/c:if&gt;
&lt;c:if test="${sessionScope.usuario.tipo=='profesor' || sessionScope.usuario.tipo=='socio'}"&gt;
....
    &lt;!-- Web del Socio --&gt;
.....
&lt;/c:if&gt;
</pre>
<p>Y ahora vamos a tener 3 p&aacute;ginas de entrada a la aplicaci&oacute;n, las cuales comparten la misma estructura de p&aacute;gina. El esquema general de cada p&aacute;gina ser&aacute; la siguiente (este caso particular es la p&aacute;gina <span class="codefrag">WebContent/jsp/biblio/index.jsp</span>):</p>
<pre class="code">
&lt;%@ page contentType="text/html; charset=ISO-8859-1" pageEncoding="ISO-8859-1"%&gt;
&lt;%@ taglib uri="http://struts.apache.org/tags-html" prefix="html" %&gt; 

&lt;!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"&gt;
	&lt;title&gt;Biblioteca jTech - Bibliotecario&lt;/title&gt;
	&lt;link rel="stylesheet" type="text/css" href="css/style.css" title="800px style" media="screen,projection" /&gt;
&lt;/head&gt;
&lt;body&gt;

&lt;div id="wrap"&gt;
    &lt;%@include file="/jsp/cabecera.jspf" %&gt;
    
    &lt;%@include file="/jsp/biblio/menu.jspf" %&gt;
    
    &lt;div id="content"&gt;
    &lt;h2&gt;Bienvenido !!! &lt;/h2&gt;
    &lt;/div&gt;
    
    &lt;%@include file="/jsp/pie.jspf" %&gt;
&lt;/div&gt;

&lt;/body&gt;
&lt;/html&gt;
</pre>
<div class="frame note">
<div class="label">Plantillas</div>
<div class="content">
A la hora de implementar una aplicaci&oacute;n de este tipo, el uso de un gestor de plantillas, del tipo de Tiles, SiteMesh (<a class="external" href="http://www.opensymphony.com/sitemesh">www.opensymphony.com/sitemesh</a>) o Velocity (<a class="external" href="http://jakarta.apache.org/velocity">jakarta.apache.org/velocity</a>), facilita mucho el desarrollo, minimizando la cantidad de c&oacute;digo a implementar y  la redundancia de HTML.
</div>
</div>
</div>


<a name="N1014B"></a><a name="Web+del+Administrador"></a>
<h2 class="underlined_10">Web del Administrador</h2>
<div class="section">
<p>El administrador del sistema va a ser el encargado de gestionar los usuarios, de modo que al entrar a su web, le debe aparecer un listado de todos los usuarios, d&aacute;ndole la posibilidad de crear un nuevo usuario, o de modificar/borrar uno de los usuarios existentes.</p>
<a name="N10154"></a><a name="Listado+de+Usuarios"></a>
<h3 class="underlined_5">Listado de Usuarios</h3>
<p>A continuaci&oacute;n se muestra un pantallazo de la apariencia del listado, donde podemos observar que para cada usuario, podemos editar sus datos o bien eliminarlo (mediante los iconos correspondientes):</p>
<p>
    
<img alt="Web del Administrador" content-width="15cm" src="imagenes/s8/indexAdmin.jpg" width="672">
</p>
<div class="frame note">
<div class="label">Ejericio Optativo I</div>
<div class="content">
Problema: &iquest;Qu&eacute; pasa cuando el listado contenga 10000 usuarios?<br>
Soluci&oacute;n I: Paginaci&oacute;n (por ejemplo, 20 usuarios por pantalla) y Ordenar (permitir clickar sobre los nombres de las columnas y ordenar el listado por dicho campo).<br>
Soluci&oacute;n II: Crear un buscador que permita obtener usuarios que cumplan ciertos requisitos (expresi&oacute;n regular con el login, estado del usuario, etc...)
</div>
</div>
<div class="frame warning">
<div class="label">Cuestiones en el aire...</div>
<div class="content">
&iquest;Qu&eacute; hacemos con los usuarios que tienen un estado de baja? &iquest;Cuando eliminamos un usuario, hacemos un borrado f&iacute;sico o un borrado l&oacute;gico?
</div>
</div>
<p>Este tipo de listados, siempre van acompa&ntilde;ados de un buscador para filtrar los resultados, posibilitando la ordenaci&oacute;n de los resultados mediante la acci&oacute;n de clickar sobre las columnas, y de una leyenda de colores que visualmente aclare los diferentes tipos de registros (por ejemplo, los usuarios activos en blanco, los morosos en rojo, los de baja en gris claro, etc...)</p>
<a name="N10175"></a><a name="AccionListarUsuarios.java"></a>
<h4>AccionListarUsuarios.java</h4>
<pre class="code">
public ActionForward execute(ActionMapping mapping, ActionForm form,
        HttpServletRequest request, HttpServletResponse response) throws Exception {
        
    if(!compruebaPermisos(request, TipoUsuario.administrador)) {
        request.setAttribute("error", "Se necesita ser administrador para obtener el listado de usuarios");
        return mapping.findForward("noAutorizado");
    } else { 
        FactoriaDAOs fd = FactoriaDAOs.getInstance();
        IUsuarioDAO iu = fd.getUsuarioDAO();
        List&lt;UsuarioTO&gt; lista = null;
        try
        {
            lista = iu.getAllUsuarios();
            if (lista != null)
            {
                request.setAttribute("lista", lista);
                logger.info("Usuarios - listar - Listado servido correctamente");
                return mapping.findForward("OK");
            } else {
                request.setAttribute("error", "No se encontraron resultados");
                logger.warn("Usuarios - listar - No se encontraron resultados");
                return mapping.findForward("error");
            }
        } catch (Exception ex) {
            request.setAttribute("error", "Error recuperando listado");
            logger.error("Usuarios - listar - Error recuperando listado");
            return mapping.findForward("error");
        }
    }
}
</pre>
<p>Del mismo modo que antes, vamos a cambiar:</p>
<ul>
    
<li>El uso de la variable <span class="codefrag">error</span> en la <span class="codefrag">request</span>, por la gesti&oacute;n de <em>Struts</em> de los errores mediante los <span class="codefrag">ActionErrors</span>.</li>
    
<li>No es recomendable la aparici&oacute;n de m&aacute;s de una sentencia <span class="codefrag">return</span> dentro de un m&eacute;todo, por lo tanto, vamos a unificar los posibles retornos en una variable, la cual devolveremos al final.</li>
    
<li>El uso de cadenas por tokens unificados en un clase <span class="codefrag">Tokens</span>
</li>
    
<li>El mensaje de log no debe indicar la clase en la que se encuentra, ya que eso ya lo realiza el propio framework de <em>log4j</em>
</li>
    
<li>La gesti&oacute;n de permisos vamos a mantenerla (aunque se deber&iacute;a implementar mediante los mecanismos de seguridad declarativa que ofrece Struts).</li>

</ul>
<pre class="code">
public ActionForward execute(ActionMapping mapping, ActionForm form,
        HttpServletRequest request, HttpServletResponse response) throws Exception {

    ActionMessages errors = new ActionMessages();
    ActionForward forward = mapping.getInputForward();

    if (!compruebaPermisos(request, TipoUsuario.administrador)) {
<strong>        errors.add(ActionMessages.GLOBAL_MESSAGE, new ActionMessage(Tokens.ERROR_KEY_PERMISOS_ADMIN));
        forward = mapping.findForward(Tokens.FOR_NO_AUTORIZADO);</strong>
    } else {
        FactoriaDAOs fd = FactoriaDAOs.getInstance();
        IUsuarioDAO iu = fd.getUsuarioDAO();
        List&lt;UsuarioTO&gt; lista = null;
        try {
            lista = iu.getAllUsuarios();
            if (lista != null) {
<strong>                request.setAttribute(Tokens.RES_USUARIOS, lista);
                logger.info("Listado servido correctamente");
                forward = mapping.findForward(Tokens.FOR_OK);</strong>
            } else {
<strong>                logger.warn("No se encontraron resultados");
                errors.add(ActionMessages.GLOBAL_MESSAGE, new ActionMessage(Tokens.ERROR_KEY_USUARIO_LISTADO_VACIO));</strong>
            }
<strong>        } catch (DAOException ex) {</strong>
            errors.add(ActionMessages.GLOBAL_MESSAGE, new ActionMessage(
                    Tokens.ERROR_KEY_USUARIO_RECUPERANDO));
            logger.error("Error recuperando listado de usuarios", ex);
        }
    }
    
<strong>    if (errors.size() &gt; 0) {
        this.saveErrors(request, errors);
    }</strong>
    
    return forward;
}
</pre>
<a name="N101BB"></a><a name="%2Fjsp%2Fadmin%2FlistadoUsuarios.jsp"></a>
<h4>/jsp/admin/listadoUsuarios.jsp</h4>
<p>La vista con las etiquetas Struts queda del siguiente modo:</p>
<pre class="code">
&lt;body&gt;
&lt;div id="wrap"&gt;
&lt;%@include file="/jsp/cabecera.jspf" %&gt;

&lt;%@include file="/jsp/admin/menu.jspf" %&gt;

&lt;div id="content"&gt;
&lt;h3&gt;Listado de Usuarios&lt;/h3&gt;

&lt;logic:messagesPresent&gt;&lt;html:errors /&gt;&lt;/logic:messagesPresent&gt;

&lt;table&gt;
    &lt;tr&gt;
        &lt;th&gt;login&lt;/th&gt;
        &lt;th&gt;nombre&lt;/th&gt;
        &lt;th&gt;1er Apellido&lt;/th&gt;
        &lt;th&gt;2do Apellido&lt;/th&gt;
        &lt;th&gt;tipo&lt;/th&gt;
        &lt;th&gt;estado&lt;/th&gt;
        &lt;td&gt;&amp;nbsp;&lt;/td&gt;
    &lt;/tr&gt;
&lt;c:forEach var="usuario" items="${requestScope.usuarios}"&gt;
    &lt;tr&gt;
        &lt;td&gt;
            &lt;html:link action="/accionSeleccionarUsuario"
            paramId="login" paramName="usuario" paramProperty="login" title="editar"&gt;
                ${usuario.login}
            &lt;/html:link&gt;
        &lt;/td&gt;
        &lt;td&gt;${usuario.nombre}&lt;/td&gt;
        &lt;td&gt;${usuario.apellido1}&lt;/td&gt;
        &lt;td&gt;${usuario.apellido2}&lt;/td&gt;
        &lt;td&gt;${usuario.tipo}&lt;/td&gt;
        &lt;td&gt;${usuario.estado}&lt;/td&gt;
        &lt;td&gt;
            &lt;html:link action="/accionSeleccionarUsuario"
            paramId="login" paramName="usuario" paramProperty="login"&gt;
                &lt;html:img page="/imagenes/editar.gif" title="editar" /&gt;
            &lt;/html:link&gt;
            &lt;html:link action="/accionBorrarUsuario"
            paramId="login" paramName="usuario" paramProperty="login"&gt;
                &lt;html:img page="/imagenes/borrar.gif" title="borrar" /&gt;
            &lt;/html:link&gt;
        &lt;/td&gt;
    &lt;/tr&gt;
&lt;/c:forEach&gt;
&lt;/table&gt;
&lt;/div&gt;

&lt;%@include file="/jsp/pie.jspf" %&gt;
&lt;/div&gt;
&lt;/body&gt;
</pre>
<a name="N101CA"></a><a name="Alta%2FModificaci%C3%B3n+de+Usuario"></a>
<h3 class="underlined_5">Alta/Modificaci&oacute;n de Usuario</h3>
<p>Cuando se crea un usuario, se debe comprobar que la contrase&ntilde;a introducida es correcta, mediante una introducci&oacute;n redundante de la misma:</p>
<p>
    
<img alt="Alta de Usuario" content-width="16cm" src="imagenes/s8/altaUsuario.jpg" width="618">
</p>
<p>Tambi&eacute;n hemos ocultado la creaci&oacute;n del estado del usuario, ya que un usuario reci&eacute;n creado es un usuario activo. En cambio, en el formulario de modificaci&oacute;n de un usuario, si que se debe ofrecer la posibilidad de modificar su estado:</p>
<p>
    
<img alt="Modificaci&oacute;n de Usuario" content-width="16cm" src="imagenes/s8/modificarUsuario.jpg" width="618">
</p>
<a name="N101E8"></a><a name="AccionInsertarUsuario.java"></a>
<h4>AccionInsertarUsuario.java</h4>
<p>Partimos del siguiente c&oacute;digo:</p>
<pre class="code">
<em>// dentro del else una vez comprobado los permisos</em>
if (request.getParameter("login") == null || request.getParameter("password") == null) {
    request.setAttribute("error", "Falta login y/o password");
    logger.error("Usuarios - insertar - Falta login y/o password");
    return mapping.findForward("error");
}

String nombre = request.getParameter("nombre") != null?request.getParameter("nombre"):"";
String apellido1 = request.getParameter("apellido1") != null?request.getParameter("apellido1"):"";
String apellido2 = request.getParameter("apellido2") != null?request.getParameter("apellido2"):"";
TipoUsuario tipo = null;
String parTipo = request.getParameter("tipo");

if ("administrador".equals(parTipo)) {
    tipo = TipoUsuario.administrador;
} else if ("bibliotecario".equals(parTipo)) {
    tipo = TipoUsuario.bibliotecario;
} else if ("socio".equals(parTipo)) {
    tipo = TipoUsuario.socio;
} else {
    tipo = TipoUsuario.profesor;
}

EstadoUsuario estado = null;
String parEstado = request.getParameter("estado");
if ("baja".equals(parEstado)) {
    estado = EstadoUsuario.baja;
} else if ("activo".equals(parEstado)) {
    estado = EstadoUsuario.activo;
} else if ("reserva".equals(parEstado)) {
    estado = EstadoUsuario.reserva;
} else if ("moroso".equals(parEstado)) {
    estado = EstadoUsuario.moroso;
} else {
    estado = EstadoUsuario.prestamo;
}

FactoriaDAOs fd = FactoriaDAOs.getInstance();
IUsuarioDAO iu = fd.getUsuarioDAO();
UsuarioTO usu = new UsuarioTO(request.getParameter("login"), request.getParameter("password"),
                        nombre, apellido1, apellido2, tipo, estado);
try {
    iu.addUsuario(usu);
    logger.info("Usuarios - insertar - " + request.getParameter("login") + " - Insercion realizada");
    return mapping.findForward("OK");
} catch (Exception ex) {
    logger.error("Usuarios - insertar - " + request.getParameter("login") + " - Error en la insercion");
    request.setAttribute("error", "Error al insertar usuario");
    return mapping.findForward("error");
}
</pre>
<p>Dentro de la acci&oacute;n de insertar un usuario, vamos a aprovechar las caracter&iacute;sticas de reflection que ofrece Java. Mediante las librer&iacute;as <em>BeanUtils de Jakarta</em> (<a class="external" href="http://jakarta.apache.org/commons/beanutils/">jakarta.apache.org/commons/beanutils</a>) podemos copias los valores de los formularios a nuestros TOs de forma autom&aacute;tica. El &uacute;nico problema encontrado son las enumeraciones, las cuales todav&iacute;a no est&aacute;n soportadas por dicha librer&iacute;as, de modo que tenemos que hacer el "mapeo" de las mismas de forma expl&iacute;cita.</p>
<pre class="code">
<em>// dentro del else una vez comprobado los permisos</em>
UsuarioForm usuarioForm = (UsuarioForm) form;
UsuarioTO usu = new UsuarioTO();

try {
    BeanUtils.copyProperties(usu, usuarioForm);
<em>    // Copiamos explicitamente los datos tipo enum, pq
    // BeanUtils todavia no lo soporta. Esperar a la version 1.8
    // TODO Cambiar por version 1.8 de beanutils</em>
    usu.setTipo(usuarioForm.getTipoUsuario());
} catch (IllegalAccessException iae) {
    logger.warn("No se han copiado todos los atributos", iae);
}

FactoriaDAOs fd = FactoriaDAOs.getInstance();
IUsuarioDAO iu = fd.getUsuarioDAO();

try {
<em>    // Al crear el usuario, siempre estar&aacute; activo
    // Esto es logica de negocio
    // TODO Poner en capa de logica de negocio</em>
    usu.setEstado(EstadoUsuario.activo);
    iu.addUsuario(usu);
    logger.info("Insercion de " + usuarioForm + " realizada");
    forward = mapping.findForward(Tokens.FOR_OK);
} catch (Exception ex) {
    logger.error("Error en la actualizacion de " + usuarioForm.getLogin(), ex);
    errors.add(ActionMessages.GLOBAL_MESSAGE, new ActionMessage(Tokens.ERROR_KEY_USUARIO_INSERCION));
}
</pre>
<p>Si nos fijamos en la asignaci&oacute;n de la enumeraci&oacute;n, estamos pasando un <span class="codefrag">String</span> (del <em>ActionForm</em>) como par&aacute;metro al atributo <span class="codefrag">tipo</span> cuya clase es <span class="codefrag">TipoUsuario</span>. Para que esto funcione, y simplificar tanto el c&oacute;digo de los <em>Action</em> como de los <em>DAOs</em>, a&ntilde;adimos un m&eacute;todo que act&uacute;a como decorador del atributo (patr&oacute;n <em>Decorator</em>), el cual realizar&aacute; la conversi&oacute;n. As&iacute; pues, en <span class="codefrag">UsuarioTO</span> a&ntilde;adimos los siguientes m&eacute;todos:</p>
<pre class="code">
<em>// UsuarioTO.java</em>

public void setEstado(String estado) {
    if (estado != null) {
        this.estado = Enum.valueOf(EstadoUsuario.class, estado);
    }
}

public void setTipo(String tipo) {
    if (tipo != null) {
        this.tipo = Enum.valueOf(TipoUsuario.class, tipo);
    }
}
</pre>
<p>Adem&aacute;s, el formulario debe comprobar que los 2 campos de password coinciden. Para ello, como el <em>Validator</em> de <em>Struts</em> no permite la relaci&oacute;n entre campos, recurriremos al m&eacute;todo <span class="codefrag">validate</span> del <span class="codefrag">UsuarioForm</span>.</p>
<pre class="code">
<em>// UsuarioForm.java</em>

public ActionErrors validate(ActionMapping mapping,
        HttpServletRequest request) {
    ActionErrors errors = super.validate(mapping, request);

    if (!(password.equals(password2))) {
        errors.add("password", new ActionMessage(
                Tokens.ERROR_KEY_USUARIO_PASSWORD_DIFERENTE));
    }
    return errors;
}
</pre>
<a name="N10244"></a><a name="AccionSeleccionarUsuario.java"></a>
<h4>AccionSeleccionarUsuario.java</h4>
<p>Para la acci&oacute;n de leer un usuario, la cual rellenar&aacute; los valores del formulario a mostrar al administrador para que modifique los datos de un determinado usuario, vamos a llegar al siguiente c&oacute;digo:</p>
<pre class="code">
<em>// dentro del else una vez comprobado los permisos</em>
FactoriaDAOs fd = FactoriaDAOs.getInstance();
IUsuarioDAO iu = fd.getUsuarioDAO();
UsuarioTO usu = null;

try {
    usu = iu.selectUsuario(login);

    if (usu != null) {
        logger.info("[" + login + "] - Datos servidos correctamente");

        UsuarioForm usuarioForm = (UsuarioForm) form;
        BeanUtils.copyProperties(usuarioForm, usu);
<em>        // Volvemos a copiar el password
        // TODO Quitar enumeraciones con beanutils 1.8</em>
        usuarioForm.setPassword2(usu.getPassword());
        usuarioForm.setTipoUsuario(usu.getTipo().toString());
        usuarioForm.setEstadoUsuario(usu.getEstado().toString());

        forward = mapping.findForward(Tokens.FOR_OK);
    } else {
        logger.error("Error obteniendo usuario " + login);
        errors.add(ActionMessages.GLOBAL_MESSAGE, new ActionMessage(Tokens.ERROR_KEY_USUARIO_NO_ENCONTRADO));
    }
} catch (Exception ex) {
    errors.add(ActionMessages.GLOBAL_MESSAGE, new ActionMessage(Tokens.ERROR_KEY_USUARIO_RECUPERANDO));
    logger.error(Error recuperando usuario " + login, ex);
}
</pre>
<p>El modo m&aacute;s f&aacute;cil de propagar los valores de un <em>TO</em> a un formulario es mediante la inclusi&oacute;n de sus valores dentro del <em>ActionForm</em> asociado al <em>Action</em>, de nuevo mediante las librer&iacute;as <em>BeanUtils</em>, pero ahora el flujo es del <em>TO</em> al <em>ActionForm</em>. De este action, cabe destacar 2 cosas singulares:</p>
<ul>
    
<li>Como el formulario tienen 2 campos para mostrar la contrase&ntilde;a, y nuestro UsuarioTO solo tiene uno, debemos rellenar de forma expl&iacute;cita dicho campo del ActionForm.</li>
    
<li>Como ahora vamos a mostrar los valores de las 2 enumeraciones, debemos mapear los 2 atributos.</li>

</ul>
<a name="N10275"></a><a name="AccionModificarUsuario.java"></a>
<h4>AccionModificarUsuario.java</h4>
<pre class="code">
<em>// dentro del else una vez comprobado los permisos</em>
UsuarioForm usuarioForm = (UsuarioForm) form;
UsuarioTO usu = new UsuarioTO();

try {
    BeanUtils.copyProperties( usu, usuarioForm);
<em>    // Copiamos explicitamente los datos tipo enum, pq 
    // BeanUtils todavia no lo soporta. Esperar a la version 1.8
    // TODO Cambiar por version 1.8 de beanutils</em>
    usu.setEstado(usuarioForm.getEstadoUsuario());
    usu.setTipo(usuarioForm.getTipoUsuario());
} catch (IllegalAccessException iae) {
    logger.warn("No se han copiado todos los atributos",iae);
}

FactoriaDAOs fd = FactoriaDAOs.getInstance();
IUsuarioDAO iu = fd.getUsuarioDAO();

try {
    iu.updateUsuario(usu);
    logger.info("Actualizacion de " + usuarioForm + " realizada");
    forward =  mapping.findForward(Tokens.FOR_OK);
} catch (Exception ex) {
    logger.error("Error en la actualizacion de " + usuarioForm.getLogin(), ex);
    errors.add(ActionMessages.GLOBAL_MESSAGE, new ActionMessage(Tokens.ERROR_KEY_USUARIO_ACTUALIZACION));
}
</pre>
<a name="N10286"></a><a name="struts-config.xml-N10286"></a>
<h3 class="underlined_5">struts-config.xml</h3>
<p>A partir de todas estas operaciones, y el esquema de navegaci&oacute;n mostrado, los ActionMappings quedan as&iacute;:</p>
<pre class="code">
&lt;action path="/accionListarUsuarios"
    type="es.ua.jtech.proyint.presentacion.acciones.usuarios.AccionListarUsuarios"&gt;
    &lt;forward name="OK" path="/jsp/admin/listadoUsuarios.jsp" /&gt;
&lt;/action&gt;
&lt;action path="/accionPrepararAltaUsuario"
    type="org.apache.struts.actions.ForwardAction" name="usuarioForm"
    validate="false" parameter="/jsp/admin/altaUsuario.jsp" /&gt;
&lt;action path="/accionInsertarUsuario"
    type="es.ua.jtech.proyint.presentacion.acciones.usuarios.AccionInsertarUsuario"
    input="/accionPrepararAltaUsuario.do" name="usuarioForm"&gt;
    &lt;forward name="OK" path="/accionListarUsuarios.do" /&gt;
&lt;/action&gt;
&lt;action path="/accionSeleccionarUsuario"
    type="es.ua.jtech.proyint.presentacion.acciones.usuarios.AccionSeleccionarUsuario"
    name="usuarioForm" input="/accionListarUsuarios.do"
    validate="false"&gt;
    &lt;forward name="OK" path="/jsp/admin/modificaUsuario.jsp" /&gt;
&lt;/action&gt;		
&lt;action path="/accionModificarUsuario"
    type="es.ua.jtech.proyint.presentacion.acciones.usuarios.AccionModificarUsuario"
    input="/accionSeleccionarUsuario.do" name="usuarioForm"&gt;
    &lt;forward name="OK" path="/accionListarUsuarios.do" /&gt;
&lt;/action&gt;
&lt;action path="/accionBorrarUsuario"
    type="es.ua.jtech.proyint.presentacion.acciones.usuarios.AccionBorrarUsuario"
    input="/accionListarUsuarios.do"&gt;
    &lt;forward name="OK" path="/accionListarUsuarios.do" /&gt;
&lt;/action&gt;
</pre>
</div>


<a name="N10295"></a><a name="Web+del+Bibliotecario"></a>
<h2 class="underlined_10">Web del Bibliotecario</h2>
<div class="section">
<p>Tal como hemos mostrado antes, las opciones del bibliotecario ser&aacute;n la gesti&oacute;n de los libros (alta, baja, modificaci&oacute;n), as&iacute; como los listados de libros y operaciones (libros disponibles, reservados, prestados, etc...), y de usuarios con retrasos y multados.</p>
<p>
    
<img alt="Men&uacute; del Bibliotecario" content-width="5cm" src="imagenes/s8/menuBiblio.jpg" width="147">
</p>
<div class="frame note">
<div class="label">Cambio necesario</div>
<div class="content">
Para poder realizar los listados de usuario retrasados, necesitar&aacute;s una columna a la tabla de operaciones y en los objetos, para almacenar la fecha real de devoluci&oacute;n de un libro.</div>
</div>
<a name="N102AB"></a><a name="Listado+de+todos+los+libros"></a>
<h3 class="underlined_5">Listado de todos los libros</h3>
<p>La apariencia de los listados debe ser semejante a la siguiente, teniendo en cuenta que dependiendo del estado del libro, se deber&aacute;n mostrar las opciones pertinentes (<strong>P</strong>restar, <strong>R</strong>eservar, <strong>A</strong>nular <strong>R</strong>eserva, o <strong>D</strong>evolver <strong>P</strong>r&eacute;stamo):</p>
<p>
    
<img alt="Listado de todos los libros" content-width="15cm" src="imagenes/s8/listarTodos.jpg" width="610">
</p>
<div class="frame note">
<div class="label">Ejercicio Optativo II</div>
<div class="content">
Antes hemos comentado que para realizar la devoluci&oacute;n de un pr&eacute;stamo, debemos almacenar la fecha real de devoluci&oacute;n del libro. A partir de este campo, podremos listar los usuarios que se retrasan en la devoluci&oacute;n de un libro.<br>
Se plantea como optativos los listados de Usuarios Retrasados y Usuarios Morosos.
</div>
</div>
<p>La dificultad de los listados va a residir, por un lado en realizar la consulta SQL adecuada, y por otro, dibujar los datos teniendo en cuenta el estado de los libros.</p>
<a name="N102D8"></a><a name="OperacionJDBCDAO.selectTodosLibros%28%29"></a>
<h4>OperacionJDBCDAO.selectTodosLibros()</h4>
<pre class="code">
public List&lt;OperacionTO&gt; selectTodosLibros() throws DAOException {
    List&lt;OperacionTO&gt; result = null;

    Connection conn = null;
    Statement st = null;
    ResultSet rs = null;

    <em>// Left join de libro con operacion, de modo que va a mostrar todos los libros,
    // y para aquellos que tienen una operacion de prestamo o reserva con rango de fechas dentro del dia actual
    // obtendr&aacute; los datos de la operacion</em>
    String sql = <strong>"SELECT l.*, u.*, o.idOperacion, o.finicio, o.ffin, o.tipoOperacion "
            + " FROM libro l left join (operacion o, usuario u) on"
            + " (l.isbn = o.isbn and o.login = u.login and o.tipoOperacion != 'multa'"
            + " and (o.finicio&lt;=now() and now()&lt;=o.ffin))";</strong>

    try {
        conn = FactoriaFuenteDatos.getInstance().createConnection();
        st = conn.createStatement();
        rs = st.executeQuery(sql);

        logger.debug("Listando: " + sql);
        result = new ArrayList&lt;OperacionTO&gt;();

        OperacionTO op = null;
        UsuarioTO usu = null;
        LibroTO libro = null;
        while (rs.next()) {
            <strong>libro = new LibroTO();</strong>
            libro.setIsbn(rs.getString("isbn"));
            libro.setTitulo(rs.getString("titulo"));
            libro.setAutor(rs.getString("autor"));
            libro.setNumPaginas(rs.getInt("numPaginas"));

            <strong>usu = new UsuarioTO();</strong>
            usu.setLogin(rs.getString("login"));

            <strong>op = new OperacionTO();
            op.setUsuario(usu);
            op.setLibro(libro);</strong>
            op.setIdOperacion(rs.getString("idOperacion"));
            op.setFechaInicio(rs.getDate("finicio"));
            op.setFechaFin(rs.getDate("ffin"));
            op.setTipo(rs.getString("tipoOperacion"));

            <strong>result.add(op);</strong>
        }
    } catch (SQLException sqle) {
        throw new DAOException("Error en el select de todos los libros",
                sqle);
    } finally {
        // cerramos los recursos
        // ...
    }

    return result;
}
</pre>
<div class="frame note">
<div class="label">Curiosidad</div>
<div class="content">
Aunque la codificaci&oacute;n de JDBC esta cayendo en desuso, las empresas que siguen emple&aacute;ndolo, utilizan alg&uacute;n tipo de framework para evitar repetir el c&oacute;digo de apertura y cierre de recursos, por ejemplo <em>Commons DbUtils</em> (<a class="external" href="http://jakarta.apache.org/commons/dbutils/">jakarta.apache.org/commons/dbutils</a>) o una parte de iBatis (<a class="external" href="http://ibatis.apache.org/">ibatis.apache.org</a>). Adem&aacute;s, suelen definir los nombres de los campos con constantes (igual que la interfaz Tokens), por si surge la necesidad de renombrar un campo en la base de datos, minimizar los cambios en el c&oacute;digo Java.
</div>
</div>
<a name="N10304"></a><a name="%2Fjsp%2Fbiblio%2FlistadoLibros.jsp"></a>
<h4>/jsp/biblio/listadoLibros.jsp</h4>
<p>El listado de libros es muy semejante entre los que muestran todos los libros, y los que muestran los reservado o prestados.</p>
<pre class="code">...
&lt;div id="content"&gt;
&lt;h3&gt;Listado de Todos los Libros&lt;/h3&gt;

&lt;logic:messagesPresent&gt;
	&lt;div class="box"&gt;&lt;html:errors /&gt;&lt;/div&gt;
&lt;/logic:messagesPresent&gt;

&lt;table&gt;
&lt;tr&gt;
    &lt;th&gt;isbn&lt;/th&gt;
    &lt;th&gt;titulo&lt;/th&gt;
    &lt;th&gt;autor&lt;/th&gt;
    &lt;th&gt;estado&lt;/th&gt;
    &lt;td colspan="2"&gt;&amp;nbsp;&lt;/td&gt;
&lt;/tr&gt;
&lt;c:forEach var="operacion" items="${requestScope.libros}"&gt;
    &lt;tr&gt;
        &lt;td&gt;${operacion.libro.isbn}&lt;/td&gt;
        &lt;td&gt;${operacion.libro.titulo}&lt;/td&gt;
        &lt;td&gt;${operacion.libro.autor}&lt;/td&gt;
        &lt;td&gt;${operacion.tipo}
            &lt;logic:present name="operacion"	property="tipo"&gt;
                &lt;br /&gt;
                &lt;div class="small"&gt;
                    (&lt;bean:write name="operacion" property="fechaInicio" format="dd/MM/yy" /&gt;
                    -
                    &lt;bean:write name="operacion" property="fechaFin" format="dd/MM/yy" /&gt;)
                &lt;/div&gt;
            &lt;/logic:present&gt;
        &lt;/td&gt;
        &lt;td nowrap="nowrap"&gt;
            &lt;html:link action="/accionSeleccionarUsuario" paramId="login" paramName="usuario" paramProperty="login"&gt;
                &lt;html:img page="/imagenes/editar.gif" title="editar" /&gt;
            &lt;/html:link&gt;
            &lt;html:link action="/accionBorrarUsuario" paramId="login" paramName="usuario" paramProperty="login"&gt;
                &lt;html:img page="/imagenes/borrar.gif" title="borrar" /&gt;
            &lt;/html:link&gt;
        &lt;/td&gt;
        &lt;td nowrap="nowrap"&gt;
            &lt;logic:notPresent name="operacion" property="tipo"&gt;
            &lt;html:link action="/accionSeleccionarUsuario" paramId="login" paramName="usuario" paramProperty="login"&gt;
                &lt;html:img page="/imagenes/r.gif" title="reservar" /&gt;
            &lt;/html:link&gt;
            &lt;html:link action="/accionBorrarUsuario" paramId="login" paramName="usuario" paramProperty="login"&gt;
                &lt;html:img page="/imagenes/p.gif" title="prestar" /&gt;
            &lt;/html:link&gt;
            &lt;/logic:notPresent&gt;
            &lt;logic:equal name="operacion" property="tipo" value="reserva"&gt;
            &lt;html:link action="/accionSeleccionarUsuario" paramId="login" paramName="usuario" paramProperty="login"&gt;
                &lt;html:img page="/imagenes/ar.gif" title="anular reserva" /&gt;
            &lt;/html:link&gt;
            &lt;/logic:equal&gt;
            &lt;logic:equal name="operacion" property="tipo" value="prestamo"&gt;
            &lt;html:link action="/accionSeleccionarUsuario" paramId="login" paramName="usuario" paramProperty="login"&gt;
                &lt;html:img page="/imagenes/dp.gif" title="devolver prestamo" /&gt;
            &lt;/html:link&gt;
            &lt;/logic:equal&gt;
        &lt;/td&gt;
    &lt;/tr&gt;
&lt;/c:forEach&gt;
&lt;/table&gt;
&lt;/div&gt;
...
</pre>
<p>Para tener clara la navegaci&oacute;n y el flujo de datos, se adjunta un video de la gesti&oacute;n de libros por parte del bibliotecario: <a href="http://www.jtech.ua.es/j2ee/2006-2007/restringido/proy-int/recursos/s8/bibliotecarioDivX.avi">video.avi</a>
</p>
<div class="frame note">
<div class="label">&iquest;Negocio en el Action?</div>
<div class="content">
Si el Action es el encargado de llamar al DAO, entonces deber&aacute; obtener la fecha actual (fecha de inicio) y dependiendo del estado del usuario, a partir del n&uacute;mero de d&iacute;as que tiene derecho, calcular la fecha de fin. Previamente, deber&aacute; obtener el n&uacute;mero de reservas o prestamos activos, para comprobar si ya tiene completo el cupo de libros. &iquest;Y todo esto lo colocamos en lo que llamamos <em>controlador</em>?</div>
</div>
</div>



<a name="N10323"></a><a name="Capa+de+Negocio"></a>
<h2 class="underlined_10">Capa de Negocio</h2>
<div class="section">
<p>Ya hemos visto c&oacute;mo estamos poniendo l&oacute;gica de negocio en nuestros Actions. Por ejemplo, al hacer una inserci&oacute;n de un usuario, el <em>Action</em> le pone el estado a activo, o cuando hacemos una reserva/pr&eacute;stamo, el <em>Action</em> se esta encargando obtener la fecha actual, y dependiendo del rol, poner la fecha de finalizaci&oacute;n. Todo esto es l&oacute;gica de negocio que debe residir en una capa aparte.</p>
<p>Para ello, vamos a crear un POJO (<em>Plain Old Java Object</em>) que simule el patr&oacute;n <em>Business Object</em> por cada subsistema. Este BO, cuando la aplicaci&oacute;n pase a ser distribuida, se convertir&aacute; en el delegador del negocio (patr&oacute;n B<em>usiness Delegate</em>). Para ello, del mismo modo que tenemos una factor&iacute;a que hace de puerta de entrada a la capa de los datos, vamos a a&ntilde;adir otra factor&iacute;a que nos sirve para entrar al negocio.</p>
<p>
    
<img alt="Capa de Negocio" content-width="15cm" src="imagenes/s8/capaNegocio.jpg" width="637">
</p>
<p>Como ejemplo, vamos a refactorizar el <em>Action</em> de <span class="codefrag">AccionInsertarUsuario</span> de  modo que llame a la capa de negocio y le ceda el control.</p>
<div class="frame note">
<div class="label">Proyecto y Paquete</div>
<div class="content">La capa de negocio es independiente de la capa de presentaci&oacute;n, y por tanto no tenemos porque crear estos objetos en el proyecto web. Tiene mucho m&aacute;s sentido crearlos en el proyecto com&uacute;n.<br>
Adem&aacute;s, colocaremos todas las clases dentro del paquete <span class="codefrag">es.ua.jtech.proyint.bo</span>
</div>
</div>
<a name="N10358"></a><a name="IUsuarioBO.java"></a>
<h3 class="underlined_5">IUsuarioBO.java</h3>
<p>As&iacute; pues, primero crearemos el interfaz con las operaciones de negocio</p>
<pre class="code">
<strong>package es.ua.jtech.proyint.bo.usuario;</strong>

import java.util.List;
import es.ua.jtech.proyint.to.UsuarioTO;

public interface <strong>IUsuarioBO</strong> {
    
    /**
     * Selecciona un usuario, comprobando su contrase&ntilde;a
     * 
     * @param login Login del usuario a seleccionar
     * @param password Contrase&ntilde;a &iacute;dem
     * @return El usuario seleccionado o null si no existe
     * @throws UsuarioException
     */
    UsuarioTO <strong>autenticaUsuario</strong>(String login, String password) throws UsuarioException;
    
    /**
     * Selecciona un usuario, comprobando su contrase&ntilde;a
     * 
     * @param login Login del usuario a seleccionar
     * @return El usuario seleccionado o null si no existe
     * @throws UsuarioException
     */
    UsuarioTO <strong>recuperaUsuario</strong>(String login) throws UsuarioException;
    
    /**
     * A&ntilde;ade un usuario a la BD
     * 
     * @param usuario Usuario a a&ntilde;adir en la BD
     * @throws UsuarioException
     */
    void <strong>anyadeUsuario</strong>(UsuarioTO usuario) throws UsuarioException;
    
    /**
     * Borra el usuario de la BD
     * 
     * @param usuario Usuario a eliminar
     * @return N&uacute;mero de registros afectados en el borrado
     * @throws UsuarioException
     */
    void <strong>eliminaUsuario</strong>(UsuarioTO usuario) throws UsuarioException;
    
    /**
     * Actualiza los datos de un usario de la BD
     * 
     * @param usuario Usuario a modificar
     * @return N&uacute;mero de registros afectados en la actualizacion
     * @throws UsuarioException
     */
    void <strong>actualizaUsuario</strong>(UsuarioTO usuario) throws UsuarioException;
    
    /**
     * Devuelve una lista con todos los usuarios en la BD
     * 
     * @return Lista con todos los usuarios
     * @throws UsuarioException
     */
    List&lt;UsuarioTO&gt; <strong>listaUsuarios</strong>() throws UsuarioException;
}
</pre>
<p>De este c&oacute;digo podemos observar c&oacute;mo los m&eacute;todos lanzan la excepci&oacute;n <span class="codefrag">UsuarioException</span>. Hemos creado una excepci&oacute;n de aplicaci&oacute;n para abstraer las capas posteriores del negocio. &iexcl;La presentaci&oacute;n no debe saber que hay detr&aacute;s del lado oscuro!</p>
<a name="N10382"></a><a name="UsuarioException.java"></a>
<h4>UsuarioException.java</h4>
<p>As&iacute; pues, por cada subsistema crearemos una o m&aacute;s excepciones de aplicaci&oacute;n.</p>
<pre class="code">
<strong>package es.ua.jtech.proyint.bo.usuario;</strong>

public class <strong>UsuarioException extends Exception</strong> {
    
    private static final long serialVersionUID = 6158132279964132104L;
    
    public <strong>UsuarioException</strong>() {
        super();
    }
    
    public UsuarioException(String message) {
        super(message);
    }
    
    public UsuarioException(String message, Throwable cause) {
        super(message, cause);
    }
}
</pre>
<a name="N10399"></a><a name="UsuarioBO.java"></a>
<h3 class="underlined_5">UsuarioBO.java</h3>
<p>A partir de la interfaz, crearemos la implementaci&oacute;n, en la cual colocaremos las reglas de negocio y realizar&aacute; las llamadas a la capa de datos.</p>
<pre class="code">
<strong>package es.ua.jtech.proyint.bo.usuario;</strong>

import java.util.List;
// resto de imports

public class <strong>UsuarioBO implements IUsuarioBO</strong> {
    
    public void <strong>actualizaUsuario(UsuarioTO usuario) throws UsuarioException</strong> {
        IUsuarioDAO dao = FactoriaDAOs.getInstance().getUsuarioDAO();
    
        <strong>if (usuario == null) {
            throw new IllegalArgumentException("Se esperaba un usuario");
        }</strong>
    
        try {
            int numAct = dao.updateUsuario(usuario);
            <strong>if (numAct == 0) {
                throw new UsuarioException("No ha actualizado a ningun usuario");
            }</strong>
        } catch (<strong>DAOException</strong> daoe) {
            throw new <strong>UsuarioException</strong>("Error actualizando usuario", daoe);
        }
    
    }
    
    public void anyadeUsuario(UsuarioTO usuario) throws UsuarioException {
        if (usuario == null) {
            throw new IllegalArgumentException("Se esperaba un usuario");
        }
    
        <em>// Le ponemos el estado a activo</em>
        <strong>usuario.setEstado(EstadoUsuario.activo);</strong>
    
        IUsuarioDAO dao = FactoriaDAOs.getInstance().getUsuarioDAO();
    
        try {
            dao.addUsuario(usuario);
        } catch (DAOException daoe) {
            throw new UsuarioException("Error insertando usuario", daoe);
        }
    
    }
    
    public UsuarioTO recuperaUsuario(String login) throws UsuarioException {
        if (login == null) {
            throw new IllegalArgumentException("Se esperaba login");
        }
    
        UsuarioTO result = null;
        IUsuarioDAO dao = FactoriaDAOs.getInstance().getUsuarioDAO();
    
        try {
            result = dao.selectUsuario(login);
        } catch (DAOException daoe) {
            throw new UsuarioException("Error recuperando usuario", daoe);
        }
    
        return result;
    }

    // resto de m&eacute;todos
    // ...
}
</pre>
<p>La capa de negocio debe funcionar como puerta de entrada a la inteligencia de la aplicaci&oacute;n, y por lo tanto, no debe dar por sentado que los datos de entrada son correctos. Al menos se debe comprobar que los par&aacute;metros llegan con valores rellenados, y dependiendo de la robustez deseada, duplicar algunas de las validaciones realizadas en los <span class="codefrag">ActionForm</span>.</p>
<div class="frame note">
<div class="label">Factoria de BOs</div>
<div class="content">Del mismo modo que con los DAOs, hemos de crear una factor&iacute;a de BOs encargada de desacoplar la creacion de las implementaciones de sus interfaces.</div>
</div>
<a name="N103CB"></a><a name="AccionInsertarUsuario.java-N103CB"></a>
<h3 class="underlined_5">AccionInsertarUsuario.java</h3>
<p>Como ejemplo, refactorizaremos este Action llevando la l&oacute;gica de negocio a su correspondiente capa.</p>
<pre class="code">
// ya hemos mapeado el UsuarioForm con el UsuarioTO
<strong>FactoriaDAOs fd = FactoriaDAOs.getInstance();
IUsuarioDAO iu = fd.getUsuarioDAO();</strong>

try {
    // Al crear el usuario, siempre estar&aacute; activo
    // Esto es logica de negocio
    // TODO Poner en capa de logica de negocio
    <strong>usu.setEstado(EstadoUsuario.activo);</strong>
    iu.addUsuario(usu);
    logger.info("Insercion de " + usuarioForm + " realizada");
    forward = mapping.findForward(Tokens.FOR_OK);
} catch (Exception ex) {
    logger.error("Error en la actualizacion de "
            + usuarioForm.getLogin(), ex);
    errors.add(ActionMessages.GLOBAL_MESSAGE, new ActionMessage(Tokens.ERROR_KEY_USUARIO_INSERCION));
}
</pre>
<p>Al refactorizar y llevar la asignaci&oacute;n del estado y la invocaci&oacute;n al DAO, nos queda lo siguiente:</p>
<pre class="code">
// ya hemos mapeado el UsuarioForm con el UsuarioTO
<strong>FactoriaBOs fb = FactoriaBOs.getInstance();
IUsuarioBO iu = fb.getUsuarioBO();</strong>

try {
    <strong>iu.anyadeUsuario(usu);</strong>
    logger.info("Insercion de " + usuarioForm + " realizada");
    
// ... resto de instrucciones
</pre>
<p>Como ejercicio, se plantea refactorizar toda la aplicaci&oacute;n para incluir la capa de negocio. Todas las comprobaciones que no sean de entradas de un Action se deben realizar en negocio (por ejemplo, el borrado de usuario no necesita comprobar que el usuario exista, ni tampoco le hace falta el UsuarioTO para eliminar un usuario).</p>
</div>



<a name="N103F0"></a><a name="Reserva+de+un+libro"></a>
<h2 class="underlined_10">Reserva de un libro</h2>
<div class="section">
<p>Para comprobar el uso de la capa de negocio, vamos a estudiar el flujo de llamadas. Para realizar una reserva desde el bibliotecario, primero hemos de elegir que libro se quiere reservar, para posteriormente, seleccionar que usuario va a realizar la reserva.</p>
<div class="frame note">
<div class="label">Alternativa</div>
<div class="content">Tambi&eacute;n podr&iacute;amos hacerlo al reves, primero elegir el usuario y luego visualizar las opciones que puede realizar ese usuario</div>
</div>
<p>As&iacute; pues, en el siguiente ejemplo seleccionamos el libro de "<em>Applying UML and Patterns</em>"</p>
<p>
    
<img alt="Selecci&oacute;n del Libro a Reserva" content-width="15cm" src="imagenes/s8/reserva11.jpg" width="615">
</p>
<a name="N1040C"></a><a name="AccionPrepararReserva.java"></a>
<h3 class="underlined_5">AccionPrepararReserva.java</h3>
<p>Al pulsar sobre la R, le pasamos el control a AccionPrepararReserva, el cual se encarga de recuperar los datos del libro a reservar (para mostr&aacute;rselos al usuario) y de los usuarios que pueden realizar reservas (socios y profesores no morosos).</p>
<pre class="code">
// despues del else de los permisos
FactoriaBOs fd = FactoriaBOs.getInstance();
IUsuarioBO io = fd.getUsuarioBO();
ILibroBO il = fd.getLibroBO();

ReservaForm rf = (ReservaForm) form;

try {
    LibroTO libro = il.recuperaLibro(rf.getIsbn());
    request.setAttribute(Tokens.RES_LIBRO, libro);
} catch (LibroException le) {
    logger.error("Error recuperando la info del libro a reservar", le);
    errors.add(ActionMessages.GLOBAL_MESSAGE, new ActionMessage(Tokens.ERROR_KEY_LIBRO_RECUPERANDO));
}

try {
    List&lt;UsuarioTO&gt; usuarios = io.listadoPosiblesPrestatarios();
    request.setAttribute(Tokens.RES_USUARIOS, usuarios);
    forward = mapping.findForward(Tokens.FOR_OK);
} catch (UsuarioException ue) {
    logger.error("Error en el listado de los socios", ue);
    errors.add(ActionMessages.GLOBAL_MESSAGE, new ActionMessage(Tokens.ERROR_KEY_OP_LISTADO_LIBROS));
}
</pre>
<a name="N1041A"></a><a name="preparaReserva.jsp"></a>
<h3 class="underlined_5">preparaReserva.jsp</h3>
<p>El Action anterior nos redirigir&aacute; a la vista que se encarga de pintar los datos, a la espera de seleccionar el usuario y realizar la reserva:</p>
<pre class="code">
&lt;div id="content"&gt;
&lt;h2&gt;Proceso de Reserva&lt;/h2&gt;

&lt;logic:messagesPresent&gt;
    &lt;div class="box"&gt;&lt;html:errors /&gt;&lt;/div&gt;
&lt;/logic:messagesPresent&gt;

&lt;p&gt;El libro a reservar es:&lt;/p&gt;
&lt;table&gt;
    &lt;tr&gt;&lt;th&gt;Nombre&lt;/th&gt;&lt;th&gt;Autor&lt;/th&gt;&lt;th&gt;N&uacute;m P&aacute;ginas&lt;/th&gt;&lt;/tr&gt;
    &lt;tr&gt;
        &lt;td&gt;&lt;bean:write name="libro" property="titulo" /&gt;&lt;/td&gt;
        &lt;td&gt;&lt;bean:write name="libro" property="autor" /&gt;&lt;/td&gt;
        &lt;td&gt;&lt;bean:write name="libro" property="numPaginas" /&gt;&lt;/td&gt;
    &lt;/tr&gt;
&lt;/table&gt;

&lt;p&gt;&amp;nbsp;&lt;/p&gt;

&lt;p&gt;Por favor, elija el usuario que desea realizar la reserva:&lt;/p&gt;
&lt;html:form action="/accionReservar"&gt;
&lt;html:hidden property="isbn" /&gt;
&lt;fieldset&gt;
&lt;legend&gt;Usuario que realiza la reserva&lt;/legend&gt;
&lt;table&gt;
    &lt;tr&gt;&lt;th width="100"&gt;Usuario&lt;/th&gt;
    &lt;td&gt;
        &lt;html:select property="login"&gt;
        &lt;html:options collection="usuarios" property="login" /&gt;
        &lt;/html:select&gt;
    &lt;/td&gt;&lt;/tr&gt;
&lt;/table&gt;
&lt;/fieldset&gt;
&lt;div align="right"&gt;&lt;html:submit value="enviar" /&gt;&lt;/div&gt;
&lt;/html:form&gt;

&lt;/div&gt;
</pre>
<p>El resultado es la siguiente vista:</p>
<p>
    
<img alt="Selecci&oacute;n del Usuario" content-width="15cm" src="imagenes/s8/reserva2.jpg" width="613">
</p>
<p>Al pulsar sobre enviar es cuando realmente se realiza la reserva.</p>
<a name="N10437"></a><a name="AccionReservar.java"></a>
<h3 class="underlined_5">AccionReservar.java</h3>
<p>El formulario anterior le cede el control a este Action, el cual a su vez, ceder&aacute; el control al negocio para realizar la reserva. Destacar como negocio esta lanzando 2 excepciones: la primera por si el usuario tiene el cupo de reserva llenas, y la segunda por si se produce cualquier otro error.</p>
<div class="frame note">
<div class="label">Consejo</div>
<div class="content">
Es muy &uacute;til definir excepciones de aplicaci&oacute;n para informar de las acciones an&oacute;malas de la aplicaci&oacute;n. De ahi el nombre de excepci&oacute;n.</div>
</div>
<pre class="code">
FactoriaBOs fd = FactoriaBOs.getInstance();
<strong>IOperacionBO io = fd.getOperacionBO();</strong>

ReservaForm rf = (ReservaForm) form;

try {
    io.<strong>realizaReserva</strong>(rf.getLogin(), rf.getIsbn());
    
    logger.info("Reserva de " + rf.getLogin() + " para el libro " + rf.getIsbn() + " realizada");
    return mapping.findForward(Tokens.FOR_OK);
} catch (<strong>OperacionCupoCompletoException</strong> occe) {
    logger.error("Error en la reserva por cumpo completo", occe);
    errors.add(ActionMessages.GLOBAL_MESSAGE, new ActionMessage(Tokens.ERROR_KEY_OP_CUPO_RESERVA_COMPLETO));
} catch (<strong>OperacionException</strong> oe) {
    logger.error("Error en la reserva", oe);
    errors.add(ActionMessages.GLOBAL_MESSAGE, new ActionMessage(Tokens.ERROR_KEY_OP_RESERVANDO));
}
</pre>
<a name="N10455"></a><a name="OperacionBO.realizaReserva%28login%2C+isbn%29"></a>
<h3 class="underlined_5">OperacionBO.realizaReserva(login, isbn)</h3>
<p>La operaci&oacute;n en negocio va a realizar los siguientes pasos:</p>
<ol>
    
<li>Comprobar par&aacute;metros de entrada</li>
    
<li>Comprobar que el usuario tiene cupo libre para realizar otra reserva</li>
    
<li>Calcular el n&uacute;mero de d&iacute;as de validez de la reserva</li>
    
<li>Realizar la reserva</li>

</ol>
<pre class="code">
public String realizaReserva(String login, String isbn) throws OperacionException, OperacionCupoCompletoException {

    <strong>if (login == null || isbn == null) {
        throw new IllegalArgumentException("Se esperaba un login y un isbn");
    }</strong>

    String result = null;
    IOperacionDAO dao = FactoriaDAOs.getInstance().getOperacionDAO();

    // Comprobamos que el usuario no tiene lleno el cupo de reservas
    <strong>this.compruebaCupoOperacion(login);</strong>

    // Calculamos el numero de dias que tiene validez la reserva (Socio = 5
    // , Profesor = 10)
    Calendar cal = GregorianCalendar.getInstance();
    <strong>Date ahora = cal.getTime();
    Date ffin = DateUtils.addDays(ahora, this.calculaNumDiasReserva(login));</strong>

    try {
        result = <strong>dao.realizaReserva(login, isbn, ahora, ffin);</strong>
    } catch (DAOException daoe) {
        throw new OperacionException("Error realizando reserva", daoe);
    }

    return result;
}
</pre>
<a name="N1047D"></a><a name="compruebaCupoOperacion%28login%29"></a>
<h4>compruebaCupoOperacion(login)</h4>
<p>A partir del usuario, le cedemos el control a un DAO que a partir del tipo (reserva o pr&eacute;stamo), nos devolver&aacute; el n&uacute;mero de reservas/pr&eacute;stamos que tiene activas dicho usuario. Destacar que este m&eacute;todo lanza las 2 excepciones comentadas anteriormente.</p>
<pre class="code">
private void compruebaCupoOperacion(String login) throws OperacionException, OperacionCupoCompletoException {

    UsuarioTO usuario = null;
    IUsuarioDAO uDao = FactoriaDAOs.getInstance().getUsuarioDAO();
    try {
        usuario = uDao.selectUsuario(login);
    } catch (DAOException daoe) {
        throw new OperacionException(
                "Error recuperando usuario para calcular dias de reserva",
                daoe);
    }

    IOperacionDAO oDao = FactoriaDAOs.getInstance().getOperacionDAO();
    int numOp = 0;
    try {
        numOp = oDao.selectOperacionesActivas(login, TipoOperacion.reserva);
    } catch (DAOException daoe) {
        throw new OperacionException("Error recuperando reservas activas",
                daoe);
    }

<strong>    if ((TipoUsuario.socio == usuario.getTipo() &amp;&amp; numOp &gt;= 3)
            || (TipoUsuario.profesor == usuario.getTipo() &amp;&amp; numOp &gt;= 10)) {
        throw new OperacionCupoCompletoException(
                "El cupo de reservas posibles esta lleno");
    }</strong>
}
</pre>
<a name="N1048E"></a><a name="calculaNumDiasReserva%28login%29"></a>
<h4>calculaNumDiasReserva(login)</h4>
<p>A partir del usuario, recuperamos su rol, y calculamos el n&uacute;mero de d&iacute;as de reserva.</p>
<pre class="code">
private int calculaNumDiasReserva(String login) throws OperacionException {
    int numDias = 0;

    UsuarioTO usuario = null;
    IUsuarioDAO uDao = FactoriaDAOs.getInstance().getUsuarioDAO();
    try {
        usuario = uDao.selectUsuario(login);
    } catch (DAOException daoe) {
        throw new OperacionException(
                "Error recuperando usuario para calcular dias de reserva",
                daoe);
    }

<strong>    if (TipoUsuario.socio == usuario.getTipo()) {
        numDias = 5;
    } else if (TipoUsuario.profesor == usuario.getTipo()) {
        numDias = 10;
    } else {
        throw new OperacionException(
                "Solo los socios y profesores pueden realizar reservas");
    }</strong>

    return numDias;

}
</pre>
<div class="frame note">
<div class="label">Interfaz de Negocio</div>
<div class="content">
El interfaz de negocio no tiene porque tener una relaci&oacute;n 1:1 con la de datos. En este ejemplo se demuestra como el negocio toma decisiones que luego la capa de datos aprovecha.</div>
</div>
<a name="N104A4"></a><a name="OperacionJDBCDAO.realizaReserva%28login%2Cisbn%2Cfinicio%2Cffin%29"></a>
<h3 class="underlined_5">OperacionJDBCDAO.realizaReserva(login,isbn,finicio,ffin)</h3>
<p>A continuaci&oacute;n se detalla la operaci&oacute;n de reservar desde el punto de vista del DAO.</p>
<pre class="code">
public String <strong>realizaReserva(String idUsuario, String idLibro, Date ahora, Date ffin)</strong> throws DAOException {
    String result = null;
    Connection conn = null;
    PreparedStatement st = null, stUsu = null;

    String sqlInsertOperacion = "insert into operacion(login, "
            + "isbn, tipoOperacion, finicio, ffin) values (?, ?, ?, ?, ?)";

    String sqlUpdateUsuario = "update usuario set estadoUsuario=? where login=? ";

    try {
        conn = FactoriaFuenteDatos.getInstance().createConnection();
        conn.setAutoCommit(false);

        st = conn.prepareStatement(<strong>sqlInsertOperacion</strong>);
        st.setString(1, idUsuario);
        st.setString(2, idLibro);
        st.setString(3, TipoOperacion.reserva.toString());
        st.setDate(4, new java.sql.Date(ahora.getTime()));
        st.setDate(5, new java.sql.Date(ffin.getTime()));
        st.executeUpdate();

        ResultSet rs = st.getGeneratedKeys();
        if (rs.next()) {
            result = rs.getString(1); // Obtenemos el id de la operaci&oacute;n
        }
        rs.close();

        stUsu = conn.prepareStatement(<strong>sqlUpdateUsuario</strong>);
        stUsu.setString(1, EstadoUsuario.reserva.toString());
        stUsu.setString(2, idUsuario);
        stUsu.executeUpdate();

        conn.commit();
    } catch (SQLException sqle) {
        try {
            conn.rollback();
        } catch (SQLException e) {
            throw new RuntimeException("Error haciendo rollback", e);
        }
        throw new DAOException("Error en el update de operacion", sqle);
    } finally {
        // cierre de conexiones
        // ...
    }

    return result;
}
</pre>
<p>El resultado final es una nueva reserva:</p>
<p>
    
<img alt="Reserva Realizada" content-width="15cm" src="imagenes/s8/reserva3.jpg" width="611">
</p>
</div>


<a name="N104C8"></a><a name="Guia+de+Estilo"></a>
<h2 class="underlined_10">Guia de Estilo</h2>
<div class="section">
<p>Toda la aplicaci&oacute;n debe hacer un uso consistente de los taglibs de Struts, tanto a nivel de formularios con sus correspondientes ActionForms como referencias a enlaces, tratamiento de errores, etc...</p>
<p>Todas las clases Java deben contener una cabecera Javadoc indicando el prop&oacute;sito de la clase, y los atributos javadoc de author y version con los valores del CVS. Por ejemplo, en la interfaz <span class="codefrag">Tokens.java</span> tenemos:</p>
<pre class="code">
/**
 * Interfaz con las constantes utilizadas dentro de los actions
 * 
 * @author $Author: amedrano $
 * @version $Revision: 1.6 $
 */
</pre>
<p>Siempre que sea posible, se minimizar&aacute; el acoplamiento entre las diferentes capas y objetos, pasando como par&aacute;metros el menor n&uacute;mero de informaci&oacute;n posible.</p>
<p>Adem&aacute;s, el proyecto deber&aacute; incluir &uacute;nicamente el c&oacute;digo fuente de la funcionalidad desarrollada. Todo los desarrollos previos (Servlets, AccionPrueba, etc...) debe ser eliminados del proyecto.</p>
<p>No debe haber ning&uacute;n mensaje de error o advertencia en la pesta&ntilde;a <em>Problems</em> de Eclipse. Para ello, se debe revisar que todo el c&oacute;digo es correcto, as&iacute; como objetos declarados y no utilizados, imports de sobra, etc...</p>
</div>


<a name="N104E8"></a><a name="Entrega"></a>
<h2 class="underlined_10">Entrega</h2>
<div class="section">
<p>La entrega se realizar&aacute; por parejas. Si alguien quiere implementar la aplicaci&oacute;n de forma individual, no se valorar&aacute; el trabajo extra. El objetivo del proyecto es mejorar la calidad, trabajar en equipo (modelado &aacute;gil y programaci&oacute;n en parejas), y aprender. Recordar que 2 cerebros son mejor que 1 :)</p>
<p>Hay que entregar toda la parte de administraci&oacute;n, as&iacute; como la gesti&oacute;n de libros y listado con reservas y prestamos de la web del bibliotecario</p>
<p>Se adjunta un archivo con todo el c&oacute;digo mostrado (sin la capa de negocio) en el presente documento: <a href="recursos/s8/plantillaWeb.zip">plantillaWeb.zip</a>
</p>
</div>


<p class="pageBreakAfter"></p>


</div>
<div class="clearboth">&nbsp;</div>
</div>
<div id="footer">
<div class="lastmodified">
<script type="text/javascript"><!--
document.write("<text>Last Published:</text> " + document.lastModified);
//  --></script>
</div>
<div class="copyright">
        Copyright &copy;
         2006-2007 Depto. CCIA</div>
</div>
</body>
</html>
