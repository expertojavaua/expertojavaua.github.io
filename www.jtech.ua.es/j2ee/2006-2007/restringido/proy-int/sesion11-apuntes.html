<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta content="Apache Forrest" name="Generator">
<meta name="Forrest-version" content="0.7">
<meta name="Forrest-skin-name" content="pelt">
<title>Componentes EJB</title>
<link type="text/css" href="skin/basic.css" rel="stylesheet">
<link media="screen" type="text/css" href="skin/screen.css" rel="stylesheet">
<link media="print" type="text/css" href="skin/print.css" rel="stylesheet">
<link type="text/css" href="skin/profile.css" rel="stylesheet">
<script src="skin/getBlank.js" language="javascript" type="text/javascript"></script><script src="skin/getMenu.js" language="javascript" type="text/javascript"></script><script src="skin/fontsize.js" language="javascript" type="text/javascript"></script>
<link rel="shortcut icon" href="">
</head>
<body onload="init()">
<script type="text/javascript">ndeSetTextSize();</script>
<div id="top">
<div class="header">
<div class="grouplogo">
<a href="http://www.jtech.ua.es/j2ee"><img class="logoImage" alt="J2EE" src="images/baner_j2ee_izq.gif" title="Curso Especialista Universitario en Java Enterprise"></a>
</div>
<div class="projectlogoA1">
<a href="http://www.dccia.ua.es/"><img class="logoImage" alt="Proyecto de Integracion" src="images/baner_j2ee_der.gif" title="Proyecto de Integracion"></a>
</div>
<ul id="tabs">
<li>
<a class="base-not-selected" href="../index.html">M&oacute;dulos</a>
</li>
<li class="current">
<a class="base-selected" href="index.html">Proyecto de Integraci&oacute;n</a>
</li>
</ul>
</div>
</div>
<div id="main">
<div id="publishedStrip">
<div id="level2tabs"></div>
<script type="text/javascript"><!--
document.write("<text>Last Published:</text> " + document.lastModified);
//  --></script>
</div>
<div class="breadtrail">
             
             &nbsp;
           </div>
<div id="menu">
<div onclick="SwitchMenu('menu_selected_1.1', 'skin/')" id="menu_selected_1.1Title" class="menutitle" style="background-image: url('skin/images/chapter_open.gif');">Proyecto de Integraci&oacute;n</div>
<div id="menu_selected_1.1" class="selectedmenuitemgroup" style="display: block;">
<div class="menuitem">
<a href="index.html" title="Proyecto de Integraci&oacute;n">&Iacute;ndice</a>
</div>
<div onclick="SwitchMenu('menu_selected_1.1.2', 'skin/')" id="menu_selected_1.1.2Title" class="menutitle" style="background-image: url('skin/images/chapter_open.gif');">Teor&iacute;a</div>
<div id="menu_selected_1.1.2" class="selectedmenuitemgroup" style="display: block;">
<div class="menuitem">
<a href="sesion01-apuntes.html" title="Sesi&oacute;n 1: Caso de estudio">Sesi&oacute;n 1</a>
</div>
<div class="menuitem">
<a href="sesion02-apuntes.html" title="Sesi&oacute;n 2: DAO con JDBC">Sesi&oacute;n 2</a>
</div>
<div class="menuitem">
<a href="sesion03-apuntes.html" title="Sesi&oacute;n 3: Aplicaci&oacute;n web con servlets">Sesi&oacute;n 3</a>
</div>
<div class="menuitem">
<a href="sesion04-apuntes.html" title="Sesi&oacute;n 4: Aplicaci&oacute;n web con servlets y JSPs">Sesi&oacute;n 4</a>
</div>
<div class="menuitem">
<a href="sesion0506-apuntes.html" title="Sesiones 5 y 6: Aplicaci&oacute;n web con Struts">Sesi&oacute;n 5-6</a>
</div>
<div class="menuitem">
<a href="sesion07-apuntes.html" title="Sesi&oacute;n 7: Aplicaci&oacute;n web con Hibernate">Sesi&oacute;n 7</a>
</div>
<div class="menuitem">
<a href="sesion08-apuntes.html" title="Sesi&oacute;n 8: Proyecto web">Sesi&oacute;n 8</a>
</div>
<div class="menuitem">
<a href="sesion09-apuntes.html" title="Sesi&oacute;n 9: Spring">Sesi&oacute;n 9</a>
</div>
<div class="menuitem">
<a href="sesion10-apuntes.html" title="Sesi&oacute;n 10: Servidores de aplicaciones">Sesi&oacute;n 10</a>
</div>
<div class="menupage">
<div class="menupagetitle">Sesi&oacute;n 11</div>
</div>
<div class="menuitem">
<a href="sesion12-apuntes.html" title="Sesi&oacute;n 12: Mensajes: JMS">Sesi&oacute;n 12</a>
</div>
<div class="menuitem">
<a href="sesion13-apuntes.html" title="Sesi&oacute;n 13: Servicios Web">Sesi&oacute;n 13</a>
</div>
<div class="menuitem">
<a href="sesion14-apuntes.html" title="Sesi&oacute;n 14: Proyecto Enterprise">Sesi&oacute;n 14</a>
</div>
</div>
</div>
<div id="credit"></div>
<div id="roundbottom">
<img style="display: none" class="corner" height="15" width="15" alt="" src="skin/images/rc-b-l-15-1body-2menu-3menu.png"></div>
<div id="credit2"></div>
</div>
<div id="content">
<div title="Portable Document Format" class="pdflink">
<a class="dida" href="sesion11-apuntes.pdf"><img alt="PDF -icon" src="skin/images/pdfdoc.gif" class="skin"><br>
        PDF</a>
</div>
<h1>Componentes EJB</h1>
<div id="minitoc-area">
<ul class="minitoc">
<li>
<a href="#Introducci%C3%B3n">Introducci&oacute;n</a>
</li>
<li>
<a href="#Paso+previo%3A+problema+con+los+tipos+enumerados">Paso previo: problema con los tipos enumerados</a>
</li>
<li>
<a href="#Refactorizaci%C3%B3n+de+la+capa+DAO">Refactorizaci&oacute;n de la capa DAO</a>
</li>
<li>
<a href="#Creaci%C3%B3n+de+la+capa+EJB+y+del+Business+Delegate">Creaci&oacute;n de la capa EJB y del Business Delegate</a>
</li>
<li>
<a href="#Modificaci%C3%B3n+de+la+capa+web">Modificaci&oacute;n de la capa web</a>
</li>
<li>
<a href="#Cliente+remoto">Cliente remoto</a>
</li>
<li>
<a href="#Ejercicios+no+guiados">Ejercicios no guiados</a>
</li>
</ul>
</div>


<a name="N1000C"></a><a name="Introducci%C3%B3n"></a>
<h2 class="underlined_10">Introducci&oacute;n</h2>
<div class="section">
<p>El objetivo de esta sesi&oacute;n de integraci&oacute;n es incorporar una capa de EJB que asuma la l&oacute;gica de negocio que implementa actualmente el proyecto com&uacute;n en las clases BOs y DAOs. El objetivo final ser&aacute; sustituir las llamadas a los BOs por llamadas EJBs en aquellas funcionalidades en las que haya que manejar transaccionalidad.</p>
<p>Tal y como termin&oacute; la integraci&oacute;n del proyecto web, la l&oacute;gica de negocio ha quedado repartida entre los BOs y los DAOs. En los DAOs ha quedado el c&oacute;digo para gestionar las transacciones, y su gesti&oacute;n se realiza con JDBC (con los m&eacute;todos <span class="codefrag">autocommit(false)</span>, <span class="codefrag">commit()</span> y <span class="codefrag">rollback()</span> de la conexi&oacute;n). Esto hace que los DAOs sean poco flexibles y poco reutilizables. En concreto, el DAO <span class="codefrag">OperacionDAO</span> se hace cargo de toda la l&oacute;gica de negocio que conlleva la actualizaci&oacute;n transaccional de la propia tabla <span class="codefrag">operacion</span> y tambi&eacute;n de la actualizaci&oacute;n del estado del usuario en la tabla <span class="codefrag">usuario</span>. Vamos hacer que la capa EJB se encarge de esta gesti&oacute;n. Para ello, vamos a crear un EJB <span class="codefrag">OperacionBean</span> que acceda a los DAO <span class="codefrag">OperacionDAO</span> (refactorizado) y <span class="codefrag">UsarioDAO</span> e implemente la l&oacute;gica de negocio repartida en la actualidad en las clases <span class="codefrag">OperacionBO</span> y <span class="codefrag">OperacionDAO</span>.</p>
</div>


<a name="N1003A"></a><a name="Paso+previo%3A+problema+con+los+tipos+enumerados"></a>
<h2 class="underlined_10">Paso previo: problema con los tipos enumerados</h2>
<div class="section">
<p>Como paso previo, tenemos que arreglar un peque&ntilde;o problema. Los EJB (en concreto, la especificaci&oacute;n CORBA-RMI en la que se basan) no soportan en la actualidad los tipos enumerados (introducidos en Java 5), por lo que debemos sustituir todas las declaraciones de tipos enumerados por el tipo <span class="codefrag">String</span> y todos los valores de variables de esos tipos por constantes definidas en la clase las clases internas (<em>inner classes</em>) <span class="codefrag">Constantes.Operacion</span> y <span class="codefrag">Constantes.Usuario</span> del paquete <span class="codefrag">DAO</span>. </p>
<p>En la p&aacute;gina del curso est&aacute; disponible una soluci&oacute;n inicial del proyecto de integraci&oacute;n en la que se hecho este cambio. Incluimos a continuaci&oacute;n una lista de los cambios a realizar, por si quer&eacute;is continuar con vuestra versi&oacute;n.</p>
<p>Elimina las clases: </p>
<pre class="code">  es.ua.jtech.proyint.to.EstadoUsuario
  es.ua.jtech.proyint.to.TipoOperacion
  es.ua.jtech.proyint.to.TipoUsuario</pre>
<p>Modifica las declaraciones de tipos anteriores por <span class="codefrag">Strings</span> en todas las clases.</p>
<p>A&ntilde;ade en el paquete <span class="codefrag">es.ua.jtech.proyint.dao</span> la clase <span class="codefrag">Constantes</span> con el siguiente c&oacute;digo en el que se definen las clases internas <span class="codefrag">Operacion</span> y <span class="codefrag">Usuario</span> y sus constantes asociadas:</p>
<pre class="code">public class Constantes {
   public static class Operacion {
      public static String TIPO_RESERVA = "reserva";
      public static String TIPO_PRESTAMO = "prestamo";
      public static String TIPO_MULTA = "multa"
   }
   
   public static class Usuario {
      public static String ESTADO_BAJA = "baja";
      public static String ESTADO_ACTIVO = "activo";
      public static String ESTADO_RESERVA = "reserva";
      public static String ESTADO_PRESTAMO = "prestamo";
      public static String ESTADO_MOROSO = "moroso";
      public static String TIPO_SOCIO = "socio";
      public static String TIPO_PROFESOR = "profesor";
      public static String TIPO_BIBLIOTECARIO = "bibliotecario";
      public static String TIPO_ADMINISTRADOR = "administrador";
   }
}
</pre>
<p>Arregla todos los errores: </p>
<p>- En las clases que utilizan JDBC hay que cambiar:</p>
<pre class="code">Enum.valueOf(EstadoUsuario.class, rs.getString("estadoUsuario")) 
Enum.valueOf(TipoUsuario.class, rs.getString("tipoUsuario"))
Enum.valueOf(TipoOperacion.class, rs.getString("tipoOperacion")</pre>
<p>por:</p>
<pre class="code">
<strong>rs.getString("estadoUsuario")
rs.getString("tipoUsuario")
rs.getString("tipoOperacion")</strong>
</pre>
<p>- Sustituye los valores del estilo <span class="codefrag">TipoOperacion.prestamo</span> por 
las constantes: <span class="codefrag">Constantes.Operacion.TIPO_PRESTAMO</span>.</p>
<p>- Sustituye las llamadas a <span class="codefrag">estado.toString()</span> por <span class="codefrag">estado</span>
</p>
<p>- Sustituye las comparaciones </p>
<pre class="code">TipoUsuario.socio == usuario.getTipo()</pre>
<p>por</p>
<pre class="code">
<strong>usuario.getTipo().equals(Constantes.Usuario.TIPO_SOCIO)</strong>
</pre>
<p>- En <span class="codefrag">AccionComun.java</span> sustituir</p>
<pre class="code">usuario.getTipo() == tipo</pre>
<p>por</p>
<pre class="code">
<strong>usuario.getTipo.equals(tipo)</strong>
</pre>
</div>


<a name="N100BA"></a><a name="Refactorizaci%C3%B3n+de+la+capa+DAO"></a>
<h2 class="underlined_10">Refactorizaci&oacute;n de la capa DAO</h2>
<div class="section">
<p>Tal y como hemos comentado en la introducci&oacute;n, el objetivo principal de esta sesi&oacute;n del proyecto de integraci&oacute;n es la inclusi&oacute;n de una capa de EJB con el EJB <span class="codefrag">OperacionBean</span> que implemente toda la l&oacute;gica de negocio que est&aacute; repartida entre las clases <span class="codefrag">OperacionBO</span> y <span class="codefrag">OperacionDAO</span>.</p>
<p>Para ello debemos transformar las clases DAO que van a ser usadas por el EJB (en este caso <span class="codefrag">IOperacionDAO</span> y <span class="codefrag">OperacionJDBCDAO</span>) para que realicen operaciones at&oacute;micas y no incluyan la l&oacute;gica de negocio ni gesti&oacute;n de transacciones.</p>
<p>Podr&iacute;amos hacerlo de varias formas, pero lo m&aacute;s sencillo es crear en el proyecto com&uacute;n unas clases nuevas denominadas <span class="codefrag">IOperacionAtomicaDAO</span> y <span class="codefrag">OperacionAtomicaJDBCDAO</span> que hagan este papel. As&iacute; mantenemos las clases antiguas para que sigan funcionando correctamente las clases que las usen.</p>
<p>A continuaci&oacute;n listamos el c&oacute;digo de la clase <span class="codefrag">IOperacionAtomicaDAO</span> que muestra la interfaz a implementar:</p>
<pre class="code">package es.ua.jtech.proyint.dao.operacion;

import java.util.Date;
import java.util.List;

import es.ua.jtech.proyint.dao.DAOException;
import es.ua.jtech.proyint.to.LibroTO;
import es.ua.jtech.proyint.to.OperacionTO;

public interface IOperacionAtomicaDAO {

   public String addReserva(String login, String isbn, Date ffin)
      throws DAOException;

   public int deleteReserva(String idOperacion)
      throws DAOException;

   public String addPrestamo(String login, String isbn, Date ffin)
      throws DAOException;

   public String addMulta(String login, String isbn, Date ffin)
      throws DAOException;

   public void cierraOperacion(String idOperacion) 
      throws DAOException;

   public OperacionTO selectOperacion(String idOperacion)
      throws DAOException;

   public List&lt;OperacionTO&gt; selectTodosLibros() 
      throws DAOException;

   public List&lt;OperacionTO&gt; selectReservas() 
      throws DAOException;

   public List&lt;OperacionTO&gt; selectPrestamos() 
      throws DAOException;

   public List&lt;LibroTO&gt; selectDisponibles()
      throws DAOException;

   public int selectOperacionesActivas(String login, String tipo)
      throws DAOException;
}</pre>
<p>La diferencia fundamental de esta nueva implementaci&oacute;n con respecto a la anterior es que las operaciones de actualizaci&oacute;n de esta versi&oacute;n del DAO (<span class="codefrag">addReserva</span>, <span class="codefrag">deleteReserva</span>, <span class="codefrag">addPrestamo</span>, <span class="codefrag">addMulta</span>, <span class="codefrag">cierraOperacion</span>) s&oacute;lo tocan la tabla "operaciones" de la BD. Esto va a simplificar mucho la implementaci&oacute;n, ya que toda la l&oacute;gica de negocio y la gesti&oacute;n de transacciones la vamos a realizar en el EJB.</p>
<p>Algunos cambios concretos de esta nueva interfaz con respecto a la antigua son los siguientes:</p>
<ul>

<li>No se utiliza la fecha actual en los par&aacute;metros. Consideramos que la gesti&oacute;n de la fecha actual debe de realizarse dentro de la capa DAO (utilizando la funci&oacute;n <span class="codefrag">now()</span> de SQL o alguna funci&oacute;n similar de la capa de persistencia utilizada) y no en la capa de negocio.</li>

<li>Se han simplificado los m&eacute;todos de la clase, ya que ahora las actualizaciones consisten sencillamente en a&ntilde;adir una operaci&oacute;n, en eliminarla (s&oacute;lo en el caso de las reservas) o en cerrar una operaci&oacute;n (poner como fecha fin real la fecha actual del sistema de persistencia). Tambi&eacute;n se han cambiado el nombre de las operaciones, para reflejar su car&aacute;cter elemental.</li>

<li>Se han eliminado los m&eacute;todos que implementaban l&oacute;gica de negocio con m&uacute;ltiples operaciones y gesti&oacute;n de transacciones, como <span class="codefrag">pasaReserva2Prestamo</span> o <span class="codefrag">devolverPrestamoConMulta</span>.</li>

</ul>
<p>La implementaci&oacute;n de las operaciones de actualizaci&oacute;n es muy sencilla, si consultas la versi&oacute;n antigua del DAO. A continuaci&oacute;n listamos como ejemplo la operaci&oacute;n <span class="codefrag">cierraOperacion</span>:</p>
<pre class="code">   public void cierraOperacion(String idOperacion) throws DAOException {
      Connection conn = null;
      PreparedStatement st = null;

      try {
         String sql = "update operacion set ffin=now() where idOperacion=?";

         conn = FactoriaFuenteDatos.getInstance().createConnection();
         conn.setAutoCommit(false);

         st = conn.prepareStatement(sql);
         st.setString(1, idOperacion);
         st.executeUpdate();
         st.close();
      } catch (SQLException sqle) {
         throw new DAOException("Error en el delete de operacion", sqle);
      } finally {
         try {
            if (st != null) {
               st.close();
               st = null;
            }
         } catch (SQLException sqlError) {
            throw new RuntimeException("Error cerrando las conexiones",
                  sqlError);
         }
      }
   }</pre>
<p>Implementa todos los m&eacute;todos de actualizaci&oacute;n restantes de la interfaz, dejando los m&eacute;todos de consulta sin modificar (c&oacute;pialos de la versi&oacute;n normal del DAO).</p>
<p>Terminamos a&ntilde;adiendo en la clase <span class="codefrag">FactoriaDAOs</span> un m&eacute;todo para obtener el <span class="codefrag">OperacionAtomicaJDBCDAO</span>:</p>
<p>En <span class="codefrag">FactoriaDAOs:</span>
</p>
<pre class="code">   public IOperacionAtomicaDAO getOperacionAtomicaDAO() {
      return new OperacionAtomicaJDBCDAO();
   }</pre>
</div>


<div class="frame note">
<div class="label">Nota</div>
<div class="content">
No es necesario modificar las clases DAO <span class="codefrag">UsuarioJDBCDAO</span> y <span class="codefrag">LibroJDBCDAO</span> porque ya definen operaciones elementales.
</div>
</div>


<a name="N1013B"></a><a name="Creaci%C3%B3n+de+la+capa+EJB+y+del+Business+Delegate"></a>
<h2 class="underlined_10">Creaci&oacute;n de la capa EJB y del Business Delegate</h2>
<div class="section">
<p>Una vez modificada la capa de acceso a datos, pasamos a implementar el EJB <span class="codefrag">OperacionBean</span> que implemente toda la l&oacute;gica de negocio que est&aacute; repartida entre las clases <span class="codefrag">OperacionBO</span> y <span class="codefrag">OperacionDAO</span>.</p>
<p>Crea el proyecto EJB "proy-int-ejb" a&ntilde;adi&eacute;ndolo al EAR:</p>
<p>
<img alt="" content-width="8cm" src="imagenes/s11/img1.png"></p>
<p>Configura el <em>buildpath</em> del proyecto EJB para incluir el proyecto com&uacute;n:.  </p>
<p>
<img alt="" content-width="8cm" src="imagenes/s11/img2.png"></p>
<p>Crea el paquete "es.ua.jtech.proyint.beans" en el proyecto EJB.
Crea en el paquete el bean de sesi&oacute;n <span class="codefrag">OperacionBean</span> con las siguientes caracter&iacute;sticas:</p>
<ul>

<li>Nombres JNDI remoto y local: <span class="codefrag">OperacionBean</span> y <span class="codefrag">OperacionBeanLocal</span>
</li>

<li>Nombres de interfaces remotas y locales: <span class="codefrag">Operacion</span>, <span class="codefrag">OperacionHome</span>, <span class="codefrag">OperacionLocal</span> y <span class="codefrag">OperacionLocalHome</span>
</li>

<li>Gesti&oacute;n de transacci&oacute;n global del EJB: REQUIRED</li>

</ul>
<p>Crea en el EJB los m&eacute;todos remotos y locales <span class="codefrag">pasaReserva2Prestamo</span> y <span class="codefrag">listadoPrestamo</span> que implementar&aacute;n esas operaciones de la capa de negocio.</p>
<p>El resultado ser&aacute; algo as&iacute; c&oacute;mo:</p>
<pre class="code">// imports y anotaciones
public class OperacionBean extends GenericSessionBean 
   implements SessionBean {

   private static final long serialVersionUID = 1L;
   private static Log logger = LogFactory
      .getLog(OperacionBean.class.getName());

   public void ejbCreate() {
   }

   @RemoteMethod()
   @LocalMethod()
   public String pasaReserva2Prestamo(String idOperacion) {
      return null;
   }

   @RemoteMethod()
   @LocalMethod()
   public List&lt;OperacionTO&gt; listadoPrestamos() {
      return null;
   }
}</pre>
<p>Recordemos que en la estructura del proyecto todos los objetos de negocio implementan la interfaz correspondiente y que una factor&iacute;a se encarga de crearlos y pas&aacute;rselos a la capa web.</p>
<p>Seg&uacute;n este planteamiento habr&iacute;a que hacer que el EJB implementara la interfaz <span class="codefrag">IOperacionBO</span>, ya que es quien va a implementar todas las operaciones de negocio. El problema que nos encontramos es que la clase anterior no es usada por el cliente (recuerda el funcionamiento de los EJB). Las clases usadas por los clientes son las clases interfaz (local: <span class="codefrag">OperacionLocal</span> y remota: <span class="codefrag">Operacion</span>) que son generadas a partir de las anotaciones. Estas clases son las que deber&iacute;an implementar la interfaz, pero no existe ninguna anotaci&oacute;n ni ning&uacute;n atributo que nos permita especifcarlo (este es uno de los ejemplos de los problemas derivados de EJBs que no son POJOs).</p>
<p>La soluci&oacute;n que hemos encontrado es utilizar el patr&oacute;n <em>business delegate</em> creando el <em>POJO</em> <span class="codefrag">OperationDelegate</span> que implementa la interfaz de la l&oacute;gica de negocio <span class="codefrag">IOperacionBO</span> y realiza las llamadas al EJB, ocultando su complejidad.</p>
<p>En el m&eacute;todo de creaci&oacute;n del <span class="codefrag">OperacionDelegate</span> debemos obtener un acceso local al EJB (<span class="codefrag">OperacionLocal</span>) que usaremos en las llamadas a sus m&eacute;todos de negocio.</p>
<p>Crea, por tanto, la clase <span class="codefrag">OperacionDelegate</span> en el proyecto EJB (en el paquete <span class="codefrag">es.ua.jtech.proyint.ejb.delegate</span>):</p>
<pre class="code">package es.ua.jtech.proyint.delegate;

// imports...

public class OperacionDelegate implements IOperacionBO {
   <strong>private OperacionLocal operacionEJB;</strong>

   public OperacionDelegate() {
      try {
         <strong>Context jndiContext = new InitialContext();
         OperacionLocalHome home = (OperacionLocalHome) 
               jndiContext.lookup("OperacionBeanLocal");
         operacionEJB = (OperacionLocal) home.create();
      } catch (Exception e) {
         throw new RuntimeException("Error al obtener el EJB", e);
      }</strong>
   }

   public String pasaReserva2Prestamo(String idOperacion) {
      return <strong>operacionEJB.pasaReserva2Prestamo(idOperacion);</strong>
   }

   public List&lt;OperacionTO&gt; listadoPrestamos() {
      return <strong>operacionEJB.listadoPrestamos();</strong>
   }

  ...
</pre>
<p>Falta hacer que la factor&iacute;a de objetos de negocio devuelva el <em>business delegate</em>. Al ser una factor&iacute;a que va a devolver objetos que llaman a EJBs, debemos colocarla en el proyecto EJB.</p>
<p>Copia la clase "FactoryBOs" del proyecto com&uacute;n al proyecto EJB en el paquete <span class="codefrag">es.ua.jtech.proyint.ejb.bo</span>) y modif&iacute;cala para que el m&eacute;todo <span class="codefrag">getOperacionBO</span> devuelva un <em>OperacionDelegate</em>. Elimina el resto de m&eacute;todos que devuelven otros tipos de BOs, porque esta clase s&oacute;lo va a trabajar con <em>delegates</em> de EJB.</p>
<p>En el proyecto EJB:</p>
<pre class="code">package es.ua.jtech.proyint.ejb.bo;

// imports ...

public class FactoriaBOs {

   private static FactoriaBOs me = new FactoriaBOs();

   private FactoriaBOs() {
   }

   public static FactoriaBOs getInstance() {
      return me;
   }

   public IOperacionBO getOperacionBO() {
      <strong>return new OperacionDelegate();</strong>
   }
}</pre>
<div class="frame warning">
<div class="label">Aviso</div>
<div class="content">Ahora hay dos clases que se llaman igual: <span class="codefrag">FactoryBOs</span>. La diferencia entre ambas est&aacute; en el m&eacute;todo <span class="codefrag">getOperacionBO()</span>: la <span class="codefrag">FactoriaBOs</span> que reside en el proyecto com&uacute;n devuelve un <span class="codefrag">OperacionBO</span> y la que reside en el proyecto EJB devuelve un EJB local <span class="codefrag">OperacionLocal</span>. El proyecto web usar&aacute; una factor&iacute;a u otra dependiendo del paquete que se importe.
</div>
</div>
<p>En este momento, ya tenemos todo listo para implementar los m&eacute;todos de negocio en el EJB, bas&aacute;ndonos en la clase <span class="codefrag">OperacionBO</span> del proyecto com&uacute;n y a&ntilde;adiendo el c&oacute;digo relacionado con la transacci&oacute;n que hemos eliminado del <span class="codefrag">OperacionDAO</span> original.</p>
<p>Recordemos que hemos comenzado por las siguientes dos operaciones:</p>
<ul>

<li>
<span class="codefrag">pasaReserva2Prestamo</span>
</li>

<li>
<span class="codefrag">listadoPrestamos</span>
</li>

</ul>
<p>Vamos a empezar por implementar la operaci&oacute;n m&aacute;s sencilla de las dos, <span class="codefrag">listadoPrestamos</span>. A&ntilde;adimos al EJB el c&oacute;digo para obtener y guardar en una variable de instancia el objeto <span class="codefrag">OperacionAtomicaJDBCDAO</span> e implementamos la operaci&oacute;n haciendo una llamada al m&eacute;todo correspondiente de este objeto:</p>
<p>A&ntilde;adimos en el c&oacute;digo del EJB <span class="codefrag">OperacionBean</span>:</p>
<pre class="code">   private FactoriaDAOs factoriaDAOs;
   private IOperacionAtomicaDAO operacionAtomica;

   public void ejbCreate() {
      factoriaDAOs = FactoriaDAOs.getInstance();
      <strong>operacionAtomica = factoriaDAOs.getOperacionAtomicaDAO();</strong>
   }

   // M&eacute;todos de negocio

   @RemoteMethod()
   @LocalMethod()
   public List&lt;OperacionTO&gt; listadoPrestamos() {
      List&lt;OperacionTO&gt; listaOperaciones = null;
      try {
         <strong>listaOperaciones = operacionAtomica.selectPrestamos();</strong>
      } catch (DAOException e) {
         e.printStackTrace();
         throw new EJBException();
      }
      return listaOperaciones;
   }
}</pre>
<p>Vamos ahora a implementar la clase de <span class="codefrag">pasaReserva2Prestamo</span>, que debe realizar la misma l&oacute;gica de negocio que el m&eacute;todo llamado igual de la clase <span class="codefrag">OperacionBO</span> del proyecto com&uacute;n y en la que debemos usar la nueva clase DAO at&oacute;mica <span class="codefrag">IOperacionAtomicaDAO</span>.</p>
<div class="frame warning">
<div class="label">Aviso</div>
<div class="content">Recordemos que todo el m&eacute;todo del EJB se realiza en un contexto transaccional y que cuando la transacci&oacute;n falla hay que provocar una excepci&oacute;n <span class="codefrag">EJBException</span> que provocar&aacute; autom&aacute;ticamente el <em>rollback</em> de la transacci&oacute;n.</div>
</div>
<pre class="code">   /**
    * TODO Falta cambiar el estado del usuario.
    */
   @RemoteMethod()
   @LocalMethod()
   public String pasaReserva2Prestamo(String idOperacion)
         throws OperacionException, OperacionCaducadaException {
      if (idOperacion == null) {
         throw new IllegalArgumentException(
               "Se esperaba identificador de la operacion");
      }
      String result = null;

      // Comprobamos que la reserva no ha caducado y que realmente 
      // es una reserva
      OperacionTO op = null;
      try {
         op = operacionAtomica.selectOperacion(idOperacion);
      } catch (DAOException daoe) {
         throw new OperacionException(
               "Error recuperando datos de la operacion", daoe);
      }
      Calendar cal = GregorianCalendar.getInstance();
      Date ahora = cal.getTime();
      if (op.getFechaFin().before(ahora)) {
         System.out.println("voy a lanzar una excepci&oacute;n");
         throw new OperacionCaducadaException(
               "La fecha de la reserva ha caducado");
      }

      if (!(op.getTipo().equals(Constantes.Operacion.TIPO_RESERVA))) {
         throw new OperacionException(
               "Se esperaba una operacion con estado de reserva");
      }

      // Calculamos el numero de dias que tiene validez el prestamo
      // (Socio = 7, Profesor = 30)

      Date ffin = DateUtils.addDays(ahora,
             this.calculaNumDiasPrestamo(op.getUsuario().getTipo()));
      String login = op.getUsuario().getLogin();
      String isbn = op.getLibro().getIsbn();
      
      // Transacci&oacute;n
      
      <strong> try {
         operacionAtomica.cierraOperacion(idOperacion);
         result = operacionAtomica.addPrestamo(login, isbn, ffin);
      } catch (DAOException e) {
         e.printStackTrace();</strong>
         // Lanzamos una EJBException para indicar al contenedor
         // que el m&eacute;todo ha fallado y que hay que deshacer 
         // la transacci&oacute;n
         <strong>throw new EJBException(
               "Error realizando el paso de reserva a prestamo", e);
      }</strong>
      return result;
   }</pre>
<p>Con esto ya hemos terminado de implementar las dos operaciones de la capa de negocio gestionada por el EJB. S&oacute;lo nos queda comprobar su funcionamiento.</p>
<div class="frame note">
<div class="label">Nota</div>
<div class="content">
Resumen de la arquitectura de la capa de negocio EJB:<br>

<br>
-La capa de negocio EJB est&aacute; implementada por la clase <span class="codefrag">OperacionDelegate</span> y el EJB <span class="codefrag">OperacionBean</span>.
<br>
-La clase <span class="codefrag">OperacionDelegate</span> proporciona una versi&oacute;n POJO del EJB para ser usada por la capa web.
<br>
-Una operaci&oacute;n de negocio en la clase <span class="codefrag">OperacionDelegate</span> provoca una llamada a operaci&oacute;n de negocio con el mismo nombre definida en el EJB. Esta operaci&oacute;n en el EJB se realiza en un entorno transaccional y se implementa mediante m&uacute;ltiples llamadas elementales a la capa DAO que acceden y modifican las distintas tablas de datos. Si alguna de las llamadas elementales falla, se lanza una excepci&oacute;n <span class="codefrag">EJBException</span> que provoca un <em>rollback</em> autom&aacute;tico de la transacci&oacute;n.
</div>
</div>
</div>


<a name="N10275"></a><a name="Modificaci%C3%B3n+de+la+capa+web"></a>
<h2 class="underlined_10">Modificaci&oacute;n de la capa web</h2>
<div class="section">
<p>Vamos por &uacute;ltimo a introducir cambios en la capa web, para que se llame al <em>business delegate</em> que acabamos de programar.</p>
<p>En primer lugar tenemos que relacionar el <em>buildpath</em> del proyecto web con el proyecto EJB. Para ello accedemos a la opci&oacute;n "J2EE Module Dependencies" del proyecto web y activamos la casilla de "proy-int-ejb.jar":</p>
<p>
<img alt="" content-width="7cm" src="imagenes/s11/img3.png"></p>
<p>Una vez actualizado el <em>classpath</em> ya podemos cambiar las clases que nos interesan de la capa web para que se importe la clase <span class="codefrag">FactoriaBOs</span> reci&eacute;n creada. En concreto, basta con sustituir</p>
<pre class="code">import es.ua.jtech.proyint.bo.FactoriaBOs</pre>
<p>por</p>
<pre class="code">
<strong>import es.ua.jtech.proyint.ejb.FactoriaBOs</strong>
</pre>
<p>en todas las clases en las que se llamen a m&eacute;todos que hayamos refactorizado. En concreto:</p>
<ul>

<li>
<span class="codefrag">AccionPasarReserva2Prestamo</span>
</li>

<li>
<span class="codefrag">AccionListarPrestamos</span>
</li>

</ul>
<p>De esta forma, utilizamos una factor&iacute;a que devuelve el business delegate de la capa EJB. No hay que hacer ning&uacute;n otro cambio. Prueba que funciona correctamente conect&aacute;ndote a: </p>
<pre class="code">http://localhost:7001/proy-int-web/</pre>
<p>Autentif&iacute;cate como bibliotecario (usuario: "bibliotecario" y contrase&ntilde;a: "bibliotecario"), realiza una reserva (esta operaci&oacute;n est&aacute; gestionada todav&iacute;a por la capa DAO) y despu&eacute;s pasa la reserva a pr&eacute;stamo. Si el EJB ha funcionado correctamente, se debe haber creado una nueva operaci&oacute;n de tipo pr&eacute;stamo y se debe haber actualizado la fecha de finalizaci&oacute;n real de la reserva. Comprueba lo primero con la interfaz web (opciones "Listar libros prestados" y "Listar libros reservados") y lo segundo con el administrador de BD. Al acceder a opci&oacute;n "Listar libros prestados" est&aacute;s tambi&eacute;n comprobando que el m&eacute;todo de consulta que has creado en el EJB funciona correctamente.</p>
<p>El usuario sigue estando en estado "reserva" porque no hemos implementado todav&iacute;a en el EJB la actualizaci&oacute;n de su estado (es un ejercicio optativo).</p>
</div>


<a name="N102BE"></a><a name="Cliente+remoto"></a>
<h2 class="underlined_10">Cliente remoto</h2>
<div class="section">
<p>Crea el proyecto Java "proy-int-cliente", configura su build path para que pueda usar de forma remota el EJB <span class="codefrag">OperacionBean</span> y escribe un cliente remoto que pida un c&oacute;digo de operaci&oacute;n (que deber&aacute; ser una reserva abierta) y que realice el pr&eacute;stamo:</p>
<pre class="code">
   ...
   System.out.print("Introduce el id de la reserva que quieres pasar a pr&eacute;stamo: ");
   BufferedReader in = new BufferedReader(new InputStreamReader(System.in));
   String idOperacion = in.readLine();
   System.out.println("Voy a pasar a prestamo la reserva " + idOperacion);
   <strong>operacion.pasaReserva2Prestamo(idOperacion);</strong>
   System.out.println("Pr&eacute;stamo realizado");
   ...
</pre>
<p>Crea una reserva con la interfaz web, consulta su id con el administrador de BD y p&aacute;sala a pr&eacute;stamo con el cliente remoto.</p>
</div>


<a name="N102D5"></a><a name="Ejercicios+no+guiados"></a>
<h2 class="underlined_10">Ejercicios no guiados</h2>
<div class="section">
<p>Terminamos con un par de ejercicios que deb&eacute;is implementar por vuestra cuenta, siguiendo la misma estructura que en el ejemplo guiado:</p>
<ul>

<li>A&ntilde;adir en el m&eacute;todo reci&eacute;n creado del EJB el c&oacute;digo para actualizar el estado del usuario prestatario del libro: si su estado era "reserva" y no tiene ning&uacute;n libro m&aacute;s reservado cambiar su estado a "prestamo".</li>


<li>A&ntilde;adir al EJB los m&eacute;todos <span class="codefrag">realizaReserva(String login, String isbn)</span> y <span class="codefrag">realizaPrestamo(String login, String isbn)</span>.</li>

</ul>
</div>


</div>
<div class="clearboth">&nbsp;</div>
</div>
<div id="footer">
<div class="lastmodified">
<script type="text/javascript"><!--
document.write("<text>Last Published:</text> " + document.lastModified);
//  --></script>
</div>
<div class="copyright">
        Copyright &copy;
         2006-2007 Depto. CCIA</div>
</div>
</body>
</html>
