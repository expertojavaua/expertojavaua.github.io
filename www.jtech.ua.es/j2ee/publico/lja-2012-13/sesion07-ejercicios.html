<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta content="Apache Forrest" name="Generator">
<meta name="Forrest-version" content="0.7">
<meta name="Forrest-skin-name" content="pelt">
<title>Ejercicios de Java Database Connectivity</title>
<link type="text/css" href="skin/highlight/shCore.css" rel="stylesheet">
<link type="text/css" href="skin/highlight/shThemeEclipse.css" rel="stylesheet">
<script src="skin/highlight/shCore.js" type="text/javascript"></script><script src="skin/highlight/shAutoloader.js" type="text/javascript"></script>
<link type="text/css" href="skin/basic.css" rel="stylesheet">
<link media="screen" type="text/css" href="skin/screen.css" rel="stylesheet">
<link media="print" type="text/css" href="skin/print.css" rel="stylesheet">
<link type="text/css" href="skin/profile.css" rel="stylesheet">
<script src="skin/getBlank.js" language="javascript" type="text/javascript"></script><script src="skin/getMenu.js" language="javascript" type="text/javascript"></script><script src="skin/fontsize.js" language="javascript" type="text/javascript"></script>
<link rel="shortcut icon" href="">
</head>
<body onload="init()">
<script type="text/javascript">ndeSetTextSize();</script>
<div id="top">
<div class="header">
<div class="grouplogo">
<a href="http://web.ua.es/especialistajava"><img class="logoImage" alt="jtech" src="images/baner_j2ee_izq.gif" title="Experto en Desarrollo de Aplicaciones y Servicios con Java Enterprise"></a>
</div>
<div class="projectlogoA1">
<a href="http://www.dccia.ua.es/"><img class="logoImage" alt="Lenguaje Java Avanzado" src="images/baner_j2ee_der.gif" title="Lenguaje Java Avanzado"></a>
</div>
<ul id="tabs">
<li>
<a class="base-not-selected" href="javascript:location.href='../index.html'">Home</a>
</li>
<li>
<a class="base-not-selected" href="javascript:location.href='../aplic-web.html'">Aplicaciones Web</a>
</li>
<li>
<a class="base-not-selected" href="javascript:location.href='../aplic-ent.html'">Aplicaciones Enterprise</a>
</li>
<li>
<a class="base-not-selected" href="javascript:location.href='../charlas.html'">Charlas</a>
</li>
<li>
<a class="base-not-selected" href="javascript:location.href='../proy-int/index.html'">Proyecto</a>
</li>
<li class="current">
<a class="base-selected" href="index.html">Java y Herramientas de Desarrollo</a>
</li>
</ul>
</div>
</div>
<div id="main">
<div id="publishedStrip">
<div id="level2tabs"></div>
<script type="text/javascript"><!--
document.write("<text>Last Published:</text> " + document.lastModified);
//  --></script>
</div>
<div class="breadtrail">
             
             &nbsp;
           </div>
<div id="menu">
<div onclick="SwitchMenu('menu_selected_1.1', 'skin/')" id="menu_selected_1.1Title" class="menutitle" style="background-image: url('skin/images/chapter_open.gif');">Materiales</div>
<div id="menu_selected_1.1" class="selectedmenuitemgroup" style="display: block;">
<div class="menuitem">
<a href="index.html" title="Java y Herramientas de Desarrollo">&Iacute;ndice</a>
</div>
<div onclick="SwitchMenu('menu_1.1.2', 'skin/')" id="menu_1.1.2Title" class="menutitle">Teor&iacute;a</div>
<div id="menu_1.1.2" class="menuitemgroup">
<div class="menuitem">
<a href="sesion01-apuntes.html">Sesion 1</a>
</div>
<div class="menuitem">
<a href="sesion02-apuntes.html">Sesion 2</a>
</div>
<div class="menuitem">
<a href="sesion03-apuntes.html">Sesion 3</a>
</div>
<div class="menuitem">
<a href="sesion04-apuntes.html">Sesion 4</a>
</div>
<div class="menuitem">
<a href="sesion05-apuntes.html">Sesion 5</a>
</div>
<div class="menuitem">
<a href="sesion06-apuntes.html">Sesion 6</a>
</div>
<div class="menuitem">
<a href="sesion07-apuntes.html">Sesion 7</a>
</div>
<div class="menuitem">
<a href="sesion08-apuntes.html">Sesion 8</a>
</div>
</div>
<div onclick="SwitchMenu('menu_selected_1.1.3', 'skin/')" id="menu_selected_1.1.3Title" class="menutitle" style="background-image: url('skin/images/chapter_open.gif');">Ejercicios</div>
<div id="menu_selected_1.1.3" class="selectedmenuitemgroup" style="display: block;">
<div class="menuitem">
<a href="sesion01-ejercicios.html">Sesion 1</a>
</div>
<div class="menuitem">
<a href="sesion02-ejercicios.html">Sesion 2</a>
</div>
<div class="menuitem">
<a href="sesion03-ejercicios.html">Sesion 3</a>
</div>
<div class="menuitem">
<a href="sesion04-ejercicios.html">Sesion 4</a>
</div>
<div class="menuitem">
<a href="sesion05-ejercicios.html">Sesion 5</a>
</div>
<div class="menuitem">
<a href="sesion06-ejercicios.html">Sesion 6</a>
</div>
<div class="menupage">
<div class="menupagetitle">Sesion 7</div>
</div>
<div class="menuitem">
<a href="sesion08-ejercicios.html">Sesion 8</a>
</div>
</div>
</div>
<div id="credit"></div>
<div id="roundbottom">
<img style="display: none" class="corner" height="15" width="15" alt="" src="skin/images/rc-b-l-15-1body-2menu-3menu.png"></div>
<div id="credit2"></div>
</div>
<div id="content">
<div title="Portable Document Format" class="pdflink">
<a class="dida" href="sesion07-ejercicios.pdf"><img alt="PDF -icon" src="skin/images/pdfdoc.gif" class="skin"><br>
        PDF</a>
</div>
<h1>Ejercicios de Java Database Connectivity</h1>
<div id="minitoc-area">
<ul class="minitoc">
<li>
<a href="#Filmoteca+en+MySQL">Filmoteca en MySQL</a>
</li>
<li>
<a href="#Conectar+con+la+base+de+de+datos+%280.5+puntos%29">Conectar con la base de de datos (0.5 puntos)</a>
</li>
<li>
<a href="#Consulta+sin+par%C3%A1metros+%280.5+puntos%29">Consulta sin par&aacute;metros (0.5 puntos)</a>
</li>
<li>
<a href="#Sentencias+preparadas+%280.5+puntos%29">Sentencias preparadas (0.5 puntos)</a>
</li>
<li>
<a href="#Sentencias+de+borrado+de+registros+%280.5+puntos%29">Sentencias de borrado de registros (0.5 puntos)</a>
</li>
<li>
<a href="#Sentencias+de+inserci%C3%B3n+de+registros+y+valores+autoincrementados+%280.5+puntos%29">Sentencias de inserci&oacute;n de registros y valores autoincrementados (0.5 puntos)</a>
</li>
<li>
<a href="#Transacciones+%280.5+puntos%29">Transacciones (0.5 puntos)</a>
</li>
</ul>
</div>

<a name="N1000C"></a><a name="Filmoteca+en+MySQL"></a>
<h2 class="underlined_10">Filmoteca en MySQL</h2>
<div class="section">
<p>Vamos a implementar una parte de la base de datos de la filmoteca
  de los anteriores ejercicios: la tabla de pel&iacute;culas y la lista de directores de la pel&iacute;cula.
  Dejaremos para otro momento la tabla de actores. Cada pel&iacute;cula puede tener varios
  directores, y cada director puede haber dirigido varias pel&iacute;culas. Esta es una relaci&oacute;n
  "muchos a muchos" y lo normal es implementar este tipo de relacion con una tabla
  intermedia, al tratarse de un modelo relacional de base de datos.</p>
<p>
<img alt="Tablas pel&iacute;culas y directores con tabla intermedia para la relaci&oacute;n 'muchos a muchos'. Arriba: modelo Entidad-Relaci&oacute;n. Abajo: datos de ejemplo y sus relaciones de clave ajena." content-width="12cm" src="imagenes/dbunit/peliculas.jpg" width="480">
  </p>
<p>En MySQL conviene utilizar el motor InnoDB en lugar del que se asigna
  por defecto a cada tabla, para permitir el uso de claves ajenas. En nuestro caso
  la tabla intermedia estar&aacute; compuesta por dos columnas, ambas formando la clave
  principal (es decir, no se pueden repetir), y a la vez cada una de ellas tendr&aacute;
  una restricci&oacute;n de clave ajena a las tablas de pel&iacute;culas y de directores, respectivamente.
  Esto significa que en la tabla intermedia no puede haber un valor que no est&eacute; asociado
  a un identificador existente en la tabla de pel&iacute;culas o de directores. N&oacute;tese que
  estas restricciones imponen un orden a la hora de insertar en la base de datos, as&iacute; como
  a la hora de borrar.</p>
<p>La base de datos descrita est&aacute; incluida en las plantillas de la sesi&oacute;n, en la carpeta
  <span class="codefrag">db/</span>. Incl&uacute;yase esta carpeta en el proyecto, ya que contiene un script de ANT
  que conecta con la base de datos (en &eacute;l hay que modificar la direcci&oacute;n, el nombre de 
  usuario y la contrase&ntilde;a) y ejecuta el script <span class="codefrag">filmoteca.sql</span> que contiene las
  sentencias de creaci&oacute;n de la base de datos. Si &eacute;sta ya existe, los datos son eliminados
  para introducir los datos de ejemplo de la figura. Ejec&uacute;tese el script Ant para comprobar
  a trav&eacute;s de alg&uacute;n cliente de MySQL que los datos se han creado con &eacute;xito.</p>
<p>Para que el proyecto cuente con las librer&iacute;as del driver JDBC para MySQL, copiamos a su
  carpeta <span class="codefrag">lib</span> el conector proporcionado en las plantillas, 
  <span class="codefrag">mysql-connector-java-5.1.5-bin.jar</span> y lo incluimos en el build path del proyecto.</p>
</div>

<a name="N10035"></a><a name="Conectar+con+la+base+de+de+datos+%280.5+puntos%29"></a>
<h2 class="underlined_10">Conectar con la base de de datos (0.5 puntos)</h2>
<div class="section">
<p>En las plantillas de la sesi&oacute;n est&aacute; incluido un fichero fuente para usarlo como
  esqueleto para la implementaci&oacute;n del DAO JDBC. Se pide implementar en el constructor
  la comprobaci&oacute;n (en tiempo de ejecuci&oacute;n) de que la clase <span class="codefrag">com.mysql.jdbc.Driver</span> 
  existe y de lo contrario, capturar la excepci&oacute;n y relanzarla como nested, dentro de una
  nueva <span class="codefrag">DAOException</span>. Puede que haga falta alguna modificaci&oacute;n en el resto del c&oacute;digo
  fuera del DAO, para manejar la excepci&oacute;n.</p>
<p>Cambiar en el <span class="codefrag">GestorDAO</span> la creaci&oacute;n del DAO, para que se haga uso del 
  <span class="codefrag">JDBCPeliculaDAO</span>. Si ahora ejecutamos el programa, aunque los m&eacute;todos del
  DAO todav&iacute;a no est&eacute;n implementados, el programa deber&aacute; fallar en tiempo de ejecuci&oacute;n
  si no encuentra el Driver de MySQL.</p>
<p>En los tres m&eacute;todos del DAO se pide establecer la conexi&oacute;n a la base de datos y despu&eacute;s
  cerrarla. Dependiendo de la aplicaci&oacute;n puede ser conveniente cerrar las conexiones
  cada vez que se terminen de usar, ya que los servidores admiten un n&uacute;mero limitado de
  conexiones simult&aacute;neas. S&oacute;lo conviene mantenerlas abiertas si se sabe que se van a 
  seguir utilizando. Se pide abrir las conexiones en la primera l&iacute;nea de los <span class="codefrag">try</span>
  de cada uno de los tres m&eacute;todos del DAO. Har&aacute; falta la direcci&oacute;n de la base de datos,
  el usuario y la contrase&ntilde;a, todos ellos vienen como constantes en la clase. 
  Tambi&eacute;n se pide cerrar la conexi&oacute;n en los bloques <span class="codefrag">finally</span> de los m&eacute;todos.</p>
</div>

<a name="N10057"></a><a name="Consulta+sin+par%C3%A1metros+%280.5+puntos%29"></a>
<h2 class="underlined_10">Consulta sin par&aacute;metros (0.5 puntos)</h2>
<div class="section">
<p>Para el m&eacute;todo <span class="codefrag">JDBCPeliculaDAO.getAllPeliculas()</span> 
  se pide crear una sentencia no preparada, <span class="codefrag">Statement</span> y ejecutar
  la query (viene como constante en la clase):</p>
<pre class="code">SELECT * FROM peliculas ORDER BY id;</pre>
<p>A continuaci&oacute;n en el bucle while de la plantilla, recoger los datos
  (<span class="codefrag">id, titulo, duracion, fechaEstreno</span>)
  del <span class="codefrag">ResultSet</span> mientras los haya, introduci&eacute;ndolos en el objeto
  <span class="codefrag">PeliculaTO</span> y a&ntilde;adiendo el resultado a la lista de pel&iacute;culas
  <span class="codefrag">List&lt;PeliculaTO&gt; lista</span>. La consulta de la lista de directores
  se har&aacute; en el apartado siguiente, de momento podemos 
  ejecutar el programa y comprobar que listar las pel&iacute;culas funciona.
  </p>
</div>

<a name="N1007A"></a><a name="Sentencias+preparadas+%280.5+puntos%29"></a>
<h2 class="underlined_10">Sentencias preparadas (0.5 puntos)</h2>
<div class="section">
<p>Las sentencias preparadas deben utilizarse cuando la consulta tiene par&aacute;metros
  para evitar que por error o malintencionadamente se inyecten sentencias no deseadas
  o simplemente ocurra alg&uacute;n error de SQL. En el apartado anterior se consultan
  todas las pel&iacute;culas de la tabla <span class="codefrag">peliculas</span> pero no se carga la lista de
  directores correspondiente a la pel&iacute;cula. Lo podemos hacer mediante la siguiente
  sentencia SQL: </p>
<pre class="code">SELECT nombre FROM directores d, peliculas_directores pd 
  WHERE (d.id = pd.director_id) AND pd.pelicula_id = ?;</pre>
<p>donde el signo de interrogaci&oacute;n <span class="codefrag">"?"</span> es un par&aacute;metro. Introd&uacute;zcase
  en una sentencia preparada la sentencia SQL (viene como constante en la plantilla)
  y el par&aacute;metro <span class="codefrag">id</span> de la pel&iacute;cula. El resultado deber&aacute; recorrerse e introducir
  los nombres de los directores en la lista de directores del objeto <span class="codefrag">PeliculaTO</span>.
  Con esto hemos completado el m&eacute;todo <span class="codefrag">getAllPeliculas()</span> y pero la interfaz
  de usuario proporcionada por la clase <span class="codefrag">Main</span> no nos permite comprobar que funcione
  correctamente. Para comprobar que los directores se cargan correctamente 
  se puede recurrir al debugger, al log, o a la salida est&aacute;ndar.
  </p>
</div>

<a name="N1009D"></a><a name="Sentencias+de+borrado+de+registros+%280.5+puntos%29"></a>
<h2 class="underlined_10">Sentencias de borrado de registros (0.5 puntos)</h2>
<div class="section">
<p>Los m&eacute;todos <span class="codefrag">delPelicula(int)</span> y <span class="codefrag">addPelicula(PeliculaTO)</span>
  ya deber&iacute;an contener el c&oacute;digo de establecer y cerrar la conexi&oacute;n JDBC. Ahora se pide:</p>
<p>En <span class="codefrag">delPelicula(int)</span> preparar y ejecutar las sentencias: </p>
<pre class="code">DELETE FROM peliculas_directores WHERE pelicula_id = ?;
DELETE FROM peliculas WHERE id = ?;</pre>
<p>&iquest;En qu&eacute; orden deber&iacute;an ejecutarse, dada la restricci&oacute;n de clave ajena que hay?</p>
<p>En la sentencia de borrado de pel&iacute;culas se pide comprobar cu&aacute;ntos registros han
  sido afectados y si son cero, lanzar una <span class="codefrag">DAOException</span>.</p>
<p>Sin introducir transaccionalidad todav&iacute;a, se pide comprobar que el borrado funciona
  ejecutando el programa.</p>
<p>N&oacute;tese que no eliminamos el director de la tabla de directores.
  En el supuesto de que hubiera m&aacute;s informaci&oacute;n asociada a cada director, dejarlos almacenados
  podr&iacute;a ser una estrategia adecuada. En caso de querer eliminarlos, la clave ajena de la 
  tabla intermedia nos restringir&iacute;a borrar un director que todav&iacute;a est&eacute; referenciado por
  otras pel&iacute;culas. </p>
</div>

<a name="N100C6"></a><a name="Sentencias+de+inserci%C3%B3n+de+registros+y+valores+autoincrementados+%280.5+puntos%29"></a>
<h2 class="underlined_10">Sentencias de inserci&oacute;n de registros y valores autoincrementados (0.5 puntos)</h2>
<div class="section">
<p>En <span class="codefrag">addPelicula(PeliculaTO)</span> preparar y ejecutar la sentencia: </p>
<pre class="code">INSERT INTO peliculas(id,titulo,fechaEstreno,duracion) VALUES(?,?,?,?)</pre>
<p>Si ha afectado a menos de un registro, lanzar una <span class="codefrag">DAOException</span>.
  Cerrar esta sentencia preparada y antes de continuar con el m&eacute;todo, probar si funciona.</p>
<p>Para insertar la lista de directores en la base de datos habr&aacute; que utilizar varias
  veces las sentencias </p>
<pre class="code">SELECT id FROM directores WHERE nombre = ?;
INSERT INTO directores(nombre) VALUES(?);
INSERT INTO peliculas_directores(pelicula_id,director_id) VALUES(?,?);</pre>
<p>Por tanto las prepararemos antes del bucle que recorre la lista de directores,
  y cada vez que las vayamos a utilizar limpiaremos sus par&aacute;metros con el m&eacute;todo
  <span class="codefrag">.clearParameters()</span>. </p>
<ul>
  
<li>La primera de ellas obtiene el identificador del
  director.</li>
  
<li> La segunda se ejecutar&aacute; s&oacute;lo si el director no exist&iacute;a. N&oacute;tese que la tabla
  de directores tiene dos columnas pero s&oacute;lo insertamos el nombre. El identificador
  de esta tabla est&aacute; marcado como autoincremental y ser&aacute; generado. Necesitamos
  obtener el valor del <span class="codefrag">id</span> generado con el m&eacute;todo <span class="codefrag">.getGeneratedKeys()</span>,
  como est&aacute; hecho en el c&oacute;digo de la plantilla.</li>
  
<li>Finalmente con la id obtenida de una de las dos sentencias anteriores, se ejecuta
  la tercera sentencia que inserta en la tabla intermedia la asociaci&oacute;n entre identificador
  de pel&iacute;cula e identificador de director.</li>
  
</ul>
<p>Una vez finalizado el bucle se pueden cerrar las sentencias preparadas.
  Se pide completar el c&oacute;digo de la plantilla y, sin introducir transaccionalidad,
  probar que funciona. </p>
</div>

<a name="N100FF"></a><a name="Transacciones+%280.5+puntos%29"></a>
<h2 class="underlined_10">Transacciones (0.5 puntos)</h2>
<div class="section">
<p>Las transacciones no ser&iacute;an necesarias en el ejemplo anterior puesto que
  la l&oacute;gica del programa ya se encarga de mantener la coherencia entre tablas.
  La transaccionalidad suele ser necesaria en bases de datos en las que varios
  clientes modifican las tablas de la base de datos y no se debe permitir que
  un insertado funcione con una tabla pero no funcione con la siguiente. En este
  caso se deshace la operaci&oacute;n entera.</p>
<p>Para los m&eacute;todos <span class="codefrag">delPelicula(int)</span> y <span class="codefrag">addPelicula(PeliculaTO)</span>
  se pide:</p>
<ul>
  
<li>Una vez establecida la conexi&oacute;n, desactivarle el <span class="codefrag">autocommit</span>.</li>
  
<li>Una vez finalizado el borrado / inserci&oacute;n, respectivamente, forzar el <span class="codefrag">.commit()</span>.</li>
  
<li>Si algo falla, en el bloque <span class="codefrag">catch</span> deshacer la transacci&oacute;n con <span class="codefrag">.rollback()</span> y
  lanzar la excepcion <span class="codefrag">DAOException</span>.</li>
  
</ul>
</div>




<p class="pageBreakAfter"></p>

</div>
<div class="clearboth">&nbsp;</div>
</div>
<div id="footer">
<div class="lastmodified">
<script type="text/javascript"><!--
document.write("<text>Last Published:</text> " + document.lastModified);
//  --></script>
</div>
<div class="copyright">
        Copyright &copy;
         2012-2013 Dept. Ciencia de la Computaci&oacute;n e IA</div>
</div>
<script type="text/javascript">
     
         SyntaxHighlighter.defaults['toolbar'] = false;
         SyntaxHighlighter.autoloader(
  		     'java                   skin/highlight/shBrushJava.js',
  		     'xml xhtml xslt html    skin/highlight/shBrushXml.js',
  		     'js jscript javascript  skin/highlight/shBrushJScript.js',
  		     'groovy                 skin/highlight/shBrushGroovy.js',
  		     'bash shell             skin/highlight/shBrushBash.js',
  		     'php                    skin/highlight/shBrushPhp.js',
  		     'css                    skin/highlight/shBrushCss.js',
  		     'sql                    skin/highlight/shBrushSql.js',
  		     'objc                   skin/highlight/shBrushObjC.js',
  		     'cpp c                  skin/highlight/shBrushCpp.js',
  		     'text plain             skin/highlight/shBrushPlain.js'
         );
         SyntaxHighlighter.all();
     </script><a href="skin/highlight/shBrushJava.js"></a><a href="skin/highlight/shBrushXml.js"></a><a href="skin/highlight/shBrushJScript.js"></a><a href="skin/highlight/shBrushGroovy.js"></a><a href="skin/highlight/shBrushBash.js"></a><a href="skin/highlight/shBrushPhp.js"></a><a href="skin/highlight/shBrushCss.js"></a><a href="skin/highlight/shBrushSql.js"></a><a href="skin/highlight/shBrushObjC.js"></a><a href="skin/highlight/shBrushCpp.js"></a><a href="skin/highlight/shBrushPlain.js"></a>
</body>
</html>
